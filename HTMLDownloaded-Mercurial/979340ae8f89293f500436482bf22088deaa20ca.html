<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 26564:979340ae8f89293f500436482bf22088deaa20ca</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 979340ae8f89293f500436482bf22088deaa20ca" />
<meta property="og:url" content="/comm-central/rev/979340ae8f89293f500436482bf22088deaa20ca" />
<meta property="og:description" content="Bug 1546364 - Reformat to Google coding style in mailnews/compose (part 1). rs=reformat" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 979340ae8f89293f500436482bf22088deaa20ca 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/979340ae8f89293f500436482bf22088deaa20ca">shortlog</a> |
<a href="/comm-central/log/979340ae8f89293f500436482bf22088deaa20ca">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/979340ae8f89293f500436482bf22088deaa20ca">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/979340ae8f89293f500436482bf22088deaa20ca">files</a> |
changeset |
<a href="/comm-central/raw-rev/979340ae8f89293f500436482bf22088deaa20ca">raw</a>  | <a href="/comm-central/archive/979340ae8f89293f500436482bf22088deaa20ca.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">Bug 1546364</a> - Reformat to Google coding style in mailnews/compose (part 1). rs=reformat
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#114;&#103;&#32;&#75;&#32;&#60;&#106;&#111;&#114;&#103;&#107;&#64;&#106;&#111;&#114;&#103;&#107;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 10 May 2019 00:07:32 +0200</td></tr>

<tr>
 <td>changeset 26564</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/979340ae8f89293f500436482bf22088deaa20ca">979340ae8f89293f500436482bf22088deaa20ca</a></td>
</tr>



<tr>
<td>parent 26563</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/a2639232172060e4a9e5467ed6d7ea1e8a602a7a">a2639232172060e4a9e5467ed6d7ea1e8a602a7a</a>
</td>
</tr>

<tr>
<td>child 26565</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/46fb17116c05ee14f6c5ccb440e77f2fff6f04f2">46fb17116c05ee14f6c5ccb440e77f2fff6f04f2</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=979340ae8f89293f500436482bf22088deaa20ca">15895</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Thu, 09 May 2019 22:14:07 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@979340ae8f89 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=979340ae8f89293f500436482bf22088deaa20ca">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=979340ae8f89293f500436482bf22088deaa20ca&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=979340ae8f89293f500436482bf22088deaa20ca&newProject=comm-central&newRevision=a2639232172060e4a9e5467ed6d7ea1e8a602a7a&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=979340ae8f89293f500436482bf22088deaa20ca&newProject=comm-central&newRevision=a2639232172060e4a9e5467ed6d7ea1e8a602a7a&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=979340ae8f89293f500436482bf22088deaa20ca&newProject=comm-central&newRevision=a2639232172060e4a9e5467ed6d7ea1e8a602a7a&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28reformat%29&revcount=50">reformat</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">1546364</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">Bug 1546364</a> - Reformat to Google coding style in mailnews/compose (part 1). rs=reformat
# ignore-this-changeset</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/public/nsMsgAttachmentData.h">mailnews/compose/public/nsMsgAttachmentData.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/public/nsMsgAttachmentData.h">file</a> |
<a href="/comm-central/annotate/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/public/nsMsgAttachmentData.h">annotate</a> |
<a href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/public/nsMsgAttachmentData.h">diff</a> |
<a href="/comm-central/comparison/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/public/nsMsgAttachmentData.h">comparison</a> |
<a href="/comm-central/log/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/public/nsMsgAttachmentData.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/public/nsMsgCompCID.h">mailnews/compose/public/nsMsgCompCID.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/public/nsMsgCompCID.h">file</a> |
<a href="/comm-central/annotate/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/public/nsMsgCompCID.h">annotate</a> |
<a href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/public/nsMsgCompCID.h">diff</a> |
<a href="/comm-central/comparison/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/public/nsMsgCompCID.h">comparison</a> |
<a href="/comm-central/log/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/public/nsMsgCompCID.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsComposeStrings.cpp">mailnews/compose/src/nsComposeStrings.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsComposeStrings.cpp">file</a> |
<a href="/comm-central/annotate/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsComposeStrings.cpp">annotate</a> |
<a href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsComposeStrings.cpp">diff</a> |
<a href="/comm-central/comparison/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsComposeStrings.cpp">comparison</a> |
<a href="/comm-central/log/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsComposeStrings.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsComposeStrings.h">mailnews/compose/src/nsComposeStrings.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsComposeStrings.h">file</a> |
<a href="/comm-central/annotate/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsComposeStrings.h">annotate</a> |
<a href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsComposeStrings.h">diff</a> |
<a href="/comm-central/comparison/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsComposeStrings.h">comparison</a> |
<a href="/comm-central/log/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsComposeStrings.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAppleCodes.h">mailnews/compose/src/nsMsgAppleCodes.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAppleCodes.h">file</a> |
<a href="/comm-central/annotate/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAppleCodes.h">annotate</a> |
<a href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAppleCodes.h">diff</a> |
<a href="/comm-central/comparison/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAppleCodes.h">comparison</a> |
<a href="/comm-central/log/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAppleCodes.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAppleDouble.h">mailnews/compose/src/nsMsgAppleDouble.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAppleDouble.h">file</a> |
<a href="/comm-central/annotate/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAppleDouble.h">annotate</a> |
<a href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAppleDouble.h">diff</a> |
<a href="/comm-central/comparison/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAppleDouble.h">comparison</a> |
<a href="/comm-central/log/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAppleDouble.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAppleDoubleEncode.cpp">mailnews/compose/src/nsMsgAppleDoubleEncode.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAppleDoubleEncode.cpp">file</a> |
<a href="/comm-central/annotate/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAppleDoubleEncode.cpp">annotate</a> |
<a href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAppleDoubleEncode.cpp">diff</a> |
<a href="/comm-central/comparison/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAppleDoubleEncode.cpp">comparison</a> |
<a href="/comm-central/log/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAppleDoubleEncode.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAppleEncode.cpp">mailnews/compose/src/nsMsgAppleEncode.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAppleEncode.cpp">file</a> |
<a href="/comm-central/annotate/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAppleEncode.cpp">annotate</a> |
<a href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAppleEncode.cpp">diff</a> |
<a href="/comm-central/comparison/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAppleEncode.cpp">comparison</a> |
<a href="/comm-central/log/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAppleEncode.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAttachment.cpp">mailnews/compose/src/nsMsgAttachment.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAttachment.cpp">file</a> |
<a href="/comm-central/annotate/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAttachment.cpp">annotate</a> |
<a href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAttachment.cpp">diff</a> |
<a href="/comm-central/comparison/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAttachment.cpp">comparison</a> |
<a href="/comm-central/log/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAttachment.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAttachment.h">mailnews/compose/src/nsMsgAttachment.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAttachment.h">file</a> |
<a href="/comm-central/annotate/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAttachment.h">annotate</a> |
<a href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAttachment.h">diff</a> |
<a href="/comm-central/comparison/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAttachment.h">comparison</a> |
<a href="/comm-central/log/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAttachment.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAttachmentHandler.cpp">mailnews/compose/src/nsMsgAttachmentHandler.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAttachmentHandler.cpp">file</a> |
<a href="/comm-central/annotate/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAttachmentHandler.cpp">annotate</a> |
<a href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAttachmentHandler.cpp">diff</a> |
<a href="/comm-central/comparison/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAttachmentHandler.cpp">comparison</a> |
<a href="/comm-central/log/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAttachmentHandler.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAttachmentHandler.h">mailnews/compose/src/nsMsgAttachmentHandler.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAttachmentHandler.h">file</a> |
<a href="/comm-central/annotate/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAttachmentHandler.h">annotate</a> |
<a href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAttachmentHandler.h">diff</a> |
<a href="/comm-central/comparison/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAttachmentHandler.h">comparison</a> |
<a href="/comm-central/log/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgAttachmentHandler.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCompFields.cpp">mailnews/compose/src/nsMsgCompFields.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCompFields.cpp">file</a> |
<a href="/comm-central/annotate/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCompFields.cpp">annotate</a> |
<a href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCompFields.cpp">diff</a> |
<a href="/comm-central/comparison/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCompFields.cpp">comparison</a> |
<a href="/comm-central/log/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCompFields.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCompFields.h">mailnews/compose/src/nsMsgCompFields.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCompFields.h">file</a> |
<a href="/comm-central/annotate/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCompFields.h">annotate</a> |
<a href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCompFields.h">diff</a> |
<a href="/comm-central/comparison/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCompFields.h">comparison</a> |
<a href="/comm-central/log/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCompFields.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCompUtils.cpp">mailnews/compose/src/nsMsgCompUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCompUtils.cpp">file</a> |
<a href="/comm-central/annotate/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCompUtils.cpp">annotate</a> |
<a href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCompUtils.cpp">diff</a> |
<a href="/comm-central/comparison/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCompUtils.cpp">comparison</a> |
<a href="/comm-central/log/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCompUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCompUtils.h">mailnews/compose/src/nsMsgCompUtils.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCompUtils.h">file</a> |
<a href="/comm-central/annotate/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCompUtils.h">annotate</a> |
<a href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCompUtils.h">diff</a> |
<a href="/comm-central/comparison/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCompUtils.h">comparison</a> |
<a href="/comm-central/log/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCompUtils.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCompose.cpp">mailnews/compose/src/nsMsgCompose.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCompose.cpp">file</a> |
<a href="/comm-central/annotate/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCompose.cpp">annotate</a> |
<a href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCompose.cpp">diff</a> |
<a href="/comm-central/comparison/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCompose.cpp">comparison</a> |
<a href="/comm-central/log/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCompose.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCompose.h">mailnews/compose/src/nsMsgCompose.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCompose.h">file</a> |
<a href="/comm-central/annotate/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCompose.h">annotate</a> |
<a href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCompose.h">diff</a> |
<a href="/comm-central/comparison/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCompose.h">comparison</a> |
<a href="/comm-central/log/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCompose.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeContentHandler.cpp">mailnews/compose/src/nsMsgComposeContentHandler.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeContentHandler.cpp">file</a> |
<a href="/comm-central/annotate/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeContentHandler.cpp">annotate</a> |
<a href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeContentHandler.cpp">diff</a> |
<a href="/comm-central/comparison/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeContentHandler.cpp">comparison</a> |
<a href="/comm-central/log/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeContentHandler.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeContentHandler.h">mailnews/compose/src/nsMsgComposeContentHandler.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeContentHandler.h">file</a> |
<a href="/comm-central/annotate/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeContentHandler.h">annotate</a> |
<a href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeContentHandler.h">diff</a> |
<a href="/comm-central/comparison/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeContentHandler.h">comparison</a> |
<a href="/comm-central/log/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeContentHandler.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeParams.cpp">mailnews/compose/src/nsMsgComposeParams.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeParams.cpp">file</a> |
<a href="/comm-central/annotate/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeParams.cpp">annotate</a> |
<a href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeParams.cpp">diff</a> |
<a href="/comm-central/comparison/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeParams.cpp">comparison</a> |
<a href="/comm-central/log/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeParams.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeParams.h">mailnews/compose/src/nsMsgComposeParams.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeParams.h">file</a> |
<a href="/comm-central/annotate/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeParams.h">annotate</a> |
<a href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeParams.h">diff</a> |
<a href="/comm-central/comparison/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeParams.h">comparison</a> |
<a href="/comm-central/log/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeParams.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeProgressParams.cpp">mailnews/compose/src/nsMsgComposeProgressParams.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeProgressParams.cpp">file</a> |
<a href="/comm-central/annotate/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeProgressParams.cpp">annotate</a> |
<a href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeProgressParams.cpp">diff</a> |
<a href="/comm-central/comparison/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeProgressParams.cpp">comparison</a> |
<a href="/comm-central/log/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeProgressParams.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeProgressParams.h">mailnews/compose/src/nsMsgComposeProgressParams.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeProgressParams.h">file</a> |
<a href="/comm-central/annotate/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeProgressParams.h">annotate</a> |
<a href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeProgressParams.h">diff</a> |
<a href="/comm-central/comparison/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeProgressParams.h">comparison</a> |
<a href="/comm-central/log/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeProgressParams.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeService.cpp">mailnews/compose/src/nsMsgComposeService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeService.cpp">file</a> |
<a href="/comm-central/annotate/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeService.cpp">annotate</a> |
<a href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeService.cpp">diff</a> |
<a href="/comm-central/comparison/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeService.cpp">comparison</a> |
<a href="/comm-central/log/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeService.h">mailnews/compose/src/nsMsgComposeService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeService.h">file</a> |
<a href="/comm-central/annotate/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeService.h">annotate</a> |
<a href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeService.h">diff</a> |
<a href="/comm-central/comparison/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeService.h">comparison</a> |
<a href="/comm-central/log/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgComposeService.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCopy.cpp">mailnews/compose/src/nsMsgCopy.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCopy.cpp">file</a> |
<a href="/comm-central/annotate/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCopy.cpp">annotate</a> |
<a href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCopy.cpp">diff</a> |
<a href="/comm-central/comparison/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCopy.cpp">comparison</a> |
<a href="/comm-central/log/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCopy.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCopy.h">mailnews/compose/src/nsMsgCopy.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCopy.h">file</a> |
<a href="/comm-central/annotate/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCopy.h">annotate</a> |
<a href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCopy.h">diff</a> |
<a href="/comm-central/comparison/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCopy.h">comparison</a> |
<a href="/comm-central/log/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgCopy.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgPrompts.cpp">mailnews/compose/src/nsMsgPrompts.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgPrompts.cpp">file</a> |
<a href="/comm-central/annotate/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgPrompts.cpp">annotate</a> |
<a href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgPrompts.cpp">diff</a> |
<a href="/comm-central/comparison/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgPrompts.cpp">comparison</a> |
<a href="/comm-central/log/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgPrompts.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgPrompts.h">mailnews/compose/src/nsMsgPrompts.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgPrompts.h">file</a> |
<a href="/comm-central/annotate/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgPrompts.h">annotate</a> |
<a href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgPrompts.h">diff</a> |
<a href="/comm-central/comparison/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgPrompts.h">comparison</a> |
<a href="/comm-central/log/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgPrompts.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgQuote.cpp">mailnews/compose/src/nsMsgQuote.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgQuote.cpp">file</a> |
<a href="/comm-central/annotate/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgQuote.cpp">annotate</a> |
<a href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgQuote.cpp">diff</a> |
<a href="/comm-central/comparison/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgQuote.cpp">comparison</a> |
<a href="/comm-central/log/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgQuote.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgQuote.h">mailnews/compose/src/nsMsgQuote.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgQuote.h">file</a> |
<a href="/comm-central/annotate/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgQuote.h">annotate</a> |
<a href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgQuote.h">diff</a> |
<a href="/comm-central/comparison/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgQuote.h">comparison</a> |
<a href="/comm-central/log/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgQuote.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSend.cpp">mailnews/compose/src/nsMsgSend.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSend.cpp">file</a> |
<a href="/comm-central/annotate/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSend.cpp">annotate</a> |
<a href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSend.cpp">diff</a> |
<a href="/comm-central/comparison/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSend.cpp">comparison</a> |
<a href="/comm-central/log/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSend.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSend.h">mailnews/compose/src/nsMsgSend.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSend.h">file</a> |
<a href="/comm-central/annotate/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSend.h">annotate</a> |
<a href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSend.h">diff</a> |
<a href="/comm-central/comparison/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSend.h">comparison</a> |
<a href="/comm-central/log/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSend.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSendLater.cpp">mailnews/compose/src/nsMsgSendLater.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSendLater.cpp">file</a> |
<a href="/comm-central/annotate/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSendLater.cpp">annotate</a> |
<a href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSendLater.cpp">diff</a> |
<a href="/comm-central/comparison/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSendLater.cpp">comparison</a> |
<a href="/comm-central/log/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSendLater.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSendLater.h">mailnews/compose/src/nsMsgSendLater.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSendLater.h">file</a> |
<a href="/comm-central/annotate/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSendLater.h">annotate</a> |
<a href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSendLater.h">diff</a> |
<a href="/comm-central/comparison/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSendLater.h">comparison</a> |
<a href="/comm-central/log/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSendLater.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSendPart.cpp">mailnews/compose/src/nsMsgSendPart.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSendPart.cpp">file</a> |
<a href="/comm-central/annotate/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSendPart.cpp">annotate</a> |
<a href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSendPart.cpp">diff</a> |
<a href="/comm-central/comparison/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSendPart.cpp">comparison</a> |
<a href="/comm-central/log/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSendPart.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSendPart.h">mailnews/compose/src/nsMsgSendPart.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSendPart.h">file</a> |
<a href="/comm-central/annotate/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSendPart.h">annotate</a> |
<a href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSendPart.h">diff</a> |
<a href="/comm-central/comparison/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSendPart.h">comparison</a> |
<a href="/comm-central/log/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSendPart.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSendReport.cpp">mailnews/compose/src/nsMsgSendReport.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSendReport.cpp">file</a> |
<a href="/comm-central/annotate/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSendReport.cpp">annotate</a> |
<a href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSendReport.cpp">diff</a> |
<a href="/comm-central/comparison/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSendReport.cpp">comparison</a> |
<a href="/comm-central/log/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSendReport.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSendReport.h">mailnews/compose/src/nsMsgSendReport.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSendReport.h">file</a> |
<a href="/comm-central/annotate/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSendReport.h">annotate</a> |
<a href="/comm-central/diff/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSendReport.h">diff</a> |
<a href="/comm-central/comparison/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSendReport.h">comparison</a> |
<a href="/comm-central/log/979340ae8f89293f500436482bf22088deaa20ca/mailnews/compose/src/nsMsgSendReport.h">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/compose/public/nsMsgAttachmentData.h</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/compose/public/nsMsgAttachmentData.h</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -6,110 +6,126 @@</span>
<a href="#l1.4"></a><span id="l1.4"> #ifndef __MSGATTACHMENTDATA_H__</span>
<a href="#l1.5"></a><span id="l1.5"> #define __MSGATTACHMENTDATA_H__</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> #include &quot;nsIURL.h&quot;</span>
<a href="#l1.8"></a><span id="l1.8"> #include &quot;nsString.h&quot;</span>
<a href="#l1.9"></a><span id="l1.9"> #include &quot;nsIMsgSend.h&quot;</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11"> // Attachment file/URL structures - we're letting libmime use this directly</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-class nsMsgAttachmentData final : public nsIMsgAttachmentData</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-{</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-public:</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+class nsMsgAttachmentData final : public nsIMsgAttachmentData {</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+ public:</span>
<a href="#l1.17"></a><span id="l1.17">   NS_DECL_NSIMSGATTACHMENTDATA</span>
<a href="#l1.18"></a><span id="l1.18">   NS_DECL_ISUPPORTS</span>
<a href="#l1.19"></a><span id="l1.19"> </span>
<a href="#l1.20"></a><span id="l1.20">   nsMsgAttachmentData();</span>
<a href="#l1.21"></a><span id="l1.21">   virtual ~nsMsgAttachmentData();</span>
<a href="#l1.22"></a><span id="l1.22"> </span>
<a href="#l1.23"></a><span id="l1.23" class="difflineminus">-  nsCOMPtr&lt;nsIURI&gt; m_url;   // The URL to attach.</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+  nsCOMPtr&lt;nsIURI&gt; m_url;  // The URL to attach.</span>
<a href="#l1.25"></a><span id="l1.25"> </span>
<a href="#l1.26"></a><span id="l1.26">   nsCString m_desiredType;  // The type to which this document should be</span>
<a href="#l1.27"></a><span id="l1.27">                             // converted.  Legal values are NULL, TEXT_PLAIN</span>
<a href="#l1.28"></a><span id="l1.28">                             // and APPLICATION_POSTSCRIPT (which are macros</span>
<a href="#l1.29"></a><span id="l1.29">                             // defined in net.h); other values are ignored.</span>
<a href="#l1.30"></a><span id="l1.30"> </span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-  nsCString m_realType;     // The type of the URL if known, otherwise NULL. For example, if</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-                            // you were attaching a temp file which was known to contain HTML data,</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-                            // you would pass in TEXT_HTML as the real_type, to override whatever type</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-                            // the name of the tmp file might otherwise indicate.</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+  nsCString</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+      m_realType;  // The type of the URL if known, otherwise NULL. For example,</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+                   // if you were attaching a temp file which was known to</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+                   // contain HTML data, you would pass in TEXT_HTML as the</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+                   // real_type, to override whatever type the name of the tmp</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+                   // file might otherwise indicate.</span>
<a href="#l1.41"></a><span id="l1.41"> </span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">-  nsCString m_realEncoding; // Goes along with real_type</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+  nsCString m_realEncoding;  // Goes along with real_type</span>
<a href="#l1.44"></a><span id="l1.44"> </span>
<a href="#l1.45"></a><span id="l1.45" class="difflineminus">-  nsCString m_realName;     // The original name of this document, which will eventually show up in the</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">-                            // Content-Disposition header. For example, if you had copied a document to a</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineminus">-                            // tmp file, this would be the original, human-readable name of the document.</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+  nsCString</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+      m_realName;  // The original name of this document, which will eventually</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+                   // show up in the Content-Disposition header. For example, if</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+                   // you had copied a document to a tmp file, this would be the</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+                   // original, human-readable name of the document.</span>
<a href="#l1.53"></a><span id="l1.53"> </span>
<a href="#l1.54"></a><span id="l1.54" class="difflineminus">-  nsCString m_description;  // If you put a string here, it will show up as the Content-Description header.</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineminus">-                            // This can be any explanatory text; it's not a file name.</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+  nsCString m_description;  // If you put a string here, it will show up as the</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+                            // Content-Description header. This can be any</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+                            // explanatory text; it's not a file name.</span>
<a href="#l1.59"></a><span id="l1.59"> </span>
<a href="#l1.60"></a><span id="l1.60" class="difflineminus">-  nsCString m_disposition;  // The Content-Disposition header (if any). a</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineminus">-                            // nsMsgAttachmentData can very well have</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineminus">-                            // Content-Disposition: inline value, instead of</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineminus">-                            // &quot;attachment&quot;.</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineminus">-  nsCString m_cloudPartInfo; // For X-Mozilla-Cloud-Part header, if any</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+  nsCString m_disposition;    // The Content-Disposition header (if any). a</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+                              // nsMsgAttachmentData can very well have</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+                              // Content-Disposition: inline value, instead of</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+                              // &quot;attachment&quot;.</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+  nsCString m_cloudPartInfo;  // For X-Mozilla-Cloud-Part header, if any</span>
<a href="#l1.70"></a><span id="l1.70"> </span>
<a href="#l1.71"></a><span id="l1.71">   // Mac-specific data that should show up as optional parameters</span>
<a href="#l1.72"></a><span id="l1.72">   // to the content-type header.</span>
<a href="#l1.73"></a><span id="l1.73">   nsCString m_xMacType;</span>
<a href="#l1.74"></a><span id="l1.74">   nsCString m_xMacCreator;</span>
<a href="#l1.75"></a><span id="l1.75"> </span>
<a href="#l1.76"></a><span id="l1.76" class="difflineminus">-  int32_t m_size;                  // The size of the attachment. May be 0.</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineminus">-  nsCString m_sizeExternalStr;     // The reported size of an external attachment. Originally set at &quot;-1&quot; to mean an unknown value.</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineminus">-  bool    m_isExternalAttachment;  // Flag for determining if the attachment is external</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineminus">-  bool    m_isExternalLinkAttachment;  // Flag for determining if the attachment is external and an http link.</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineminus">-  bool    m_isDownloaded;          // Flag for determining if the attachment has already been downloaded</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineminus">-  bool    m_hasFilename;           // Tells whether the name is provided by us or if it's a Part 1.2-like attachment</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineminus">-  bool    m_displayableInline;     // Tells whether the attachment could be displayed inline</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineplus">+  int32_t m_size;  // The size of the attachment. May be 0.</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineplus">+  nsCString</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineplus">+      m_sizeExternalStr;  // The reported size of an external attachment.</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineplus">+                          // Originally set at &quot;-1&quot; to mean an unknown value.</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineplus">+  bool m_isExternalAttachment;      // Flag for determining if the attachment is</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineplus">+                                    // external</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineplus">+  bool m_isExternalLinkAttachment;  // Flag for determining if the attachment is</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineplus">+                                    // external and an http link.</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineplus">+  bool m_isDownloaded;  // Flag for determining if the attachment has already</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineplus">+                        // been downloaded</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineplus">+  bool m_hasFilename;   // Tells whether the name is provided by us or if it's a</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineplus">+                        // Part 1.2-like attachment</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineplus">+  bool m_displayableInline;  // Tells whether the attachment could be displayed</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineplus">+                             // inline</span>
<a href="#l1.97"></a><span id="l1.97"> };</span>
<a href="#l1.98"></a><span id="l1.98"> </span>
<a href="#l1.99"></a><span id="l1.99" class="difflineminus">-class nsMsgAttachedFile final : public nsIMsgAttachedFile</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineminus">-{</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineminus">-public:</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineplus">+class nsMsgAttachedFile final : public nsIMsgAttachedFile {</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineplus">+ public:</span>
<a href="#l1.104"></a><span id="l1.104">   NS_DECL_NSIMSGATTACHEDFILE</span>
<a href="#l1.105"></a><span id="l1.105">   NS_DECL_ISUPPORTS</span>
<a href="#l1.106"></a><span id="l1.106"> </span>
<a href="#l1.107"></a><span id="l1.107">   nsMsgAttachedFile();</span>
<a href="#l1.108"></a><span id="l1.108">   virtual ~nsMsgAttachedFile();</span>
<a href="#l1.109"></a><span id="l1.109"> </span>
<a href="#l1.110"></a><span id="l1.110" class="difflineminus">-  nsCOMPtr&lt;nsIURI&gt; m_origUrl; // Where it came from on the network (or even elsewhere on the local disk.)</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineplus">+  nsCOMPtr&lt;nsIURI&gt; m_origUrl;  // Where it came from on the network (or even</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineplus">+                               // elsewhere on the local disk.)</span>
<a href="#l1.113"></a><span id="l1.113"> </span>
<a href="#l1.114"></a><span id="l1.114" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt;  m_tmpFile;    // The tmp file in which the (possibly converted) data now resides.</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; m_tmpFile;  // The tmp file in which the (possibly</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineplus">+                                // converted) data now resides.</span>
<a href="#l1.117"></a><span id="l1.117"> </span>
<a href="#l1.118"></a><span id="l1.118" class="difflineminus">-  nsCString m_type;        // The type of the data in file_name (not necessarily the same as the type of orig_url.)</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineplus">+  nsCString m_type;  // The type of the data in file_name (not necessarily the</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineplus">+                     // same as the type of orig_url.)</span>
<a href="#l1.121"></a><span id="l1.121"> </span>
<a href="#l1.122"></a><span id="l1.122" class="difflineminus">-  nsCString m_encoding;    // Likewise, the encoding of the tmp file. This will be set only if the original</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineminus">-                            // document had an encoding already; we don't do base64 encoding and so forth until</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineminus">-                            // it's time to assemble a full MIME message of all parts.</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineminus">-</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineplus">+  nsCString</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineplus">+      m_encoding;  // Likewise, the encoding of the tmp file. This will be set</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineplus">+                   // only if the original document had an encoding already; we</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineplus">+                   // don't do base64 encoding and so forth until it's time to</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineplus">+                   // assemble a full MIME message of all parts.</span>
<a href="#l1.131"></a><span id="l1.131"> </span>
<a href="#l1.132"></a><span id="l1.132">   nsCString m_description;    // For Content-Description header</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineminus">-  nsCString m_cloudPartInfo; // For X-Mozilla-Cloud-Part header, if any</span>
<a href="#l1.134"></a><span id="l1.134" class="difflineminus">-  nsCString m_xMacType;    // mac-specific info</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineminus">-  nsCString m_xMacCreator; // mac-specific info</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineminus">-  nsCString m_realName;      // The real name of the file.</span>
<a href="#l1.137"></a><span id="l1.137" class="difflineplus">+  nsCString m_cloudPartInfo;  // For X-Mozilla-Cloud-Part header, if any</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineplus">+  nsCString m_xMacType;       // mac-specific info</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineplus">+  nsCString m_xMacCreator;    // mac-specific info</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineplus">+  nsCString m_realName;       // The real name of the file.</span>
<a href="#l1.141"></a><span id="l1.141"> </span>
<a href="#l1.142"></a><span id="l1.142">   // Some statistics about the data that was written to the file, so that when</span>
<a href="#l1.143"></a><span id="l1.143">   // it comes time to compose a MIME message, we can make an informed decision</span>
<a href="#l1.144"></a><span id="l1.144">   // about what Content-Transfer-Encoding would be best for this attachment.</span>
<a href="#l1.145"></a><span id="l1.145">   // (If it's encoded already, we ignore this information and ship it as-is.)</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineminus">-  uint32_t    m_size;</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineminus">-  uint32_t    m_unprintableCount;</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineminus">-  uint32_t    m_highbitCount;</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineminus">-  uint32_t    m_ctlCount;</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineminus">-  uint32_t    m_nullCount;</span>
<a href="#l1.151"></a><span id="l1.151" class="difflineminus">-  uint32_t    m_maxLineLength;</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineplus">+  uint32_t m_size;</span>
<a href="#l1.153"></a><span id="l1.153" class="difflineplus">+  uint32_t m_unprintableCount;</span>
<a href="#l1.154"></a><span id="l1.154" class="difflineplus">+  uint32_t m_highbitCount;</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineplus">+  uint32_t m_ctlCount;</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineplus">+  uint32_t m_nullCount;</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineplus">+  uint32_t m_maxLineLength;</span>
<a href="#l1.158"></a><span id="l1.158"> };</span>
<a href="#l1.159"></a><span id="l1.159"> </span>
<a href="#l1.160"></a><span id="l1.160"> #undef MOZ_ASSERT_TYPE_OK_FOR_REFCOUNTING</span>
<a href="#l1.161"></a><span id="l1.161"> #ifdef MOZ_IS_DESTRUCTIBLE</span>
<a href="#l1.162"></a><span id="l1.162" class="difflineminus">-#define MOZ_ASSERT_TYPE_OK_FOR_REFCOUNTING(X) \</span>
<a href="#l1.163"></a><span id="l1.163" class="difflineminus">-  static_assert(!MOZ_IS_DESTRUCTIBLE(X) || \</span>
<a href="#l1.164"></a><span id="l1.164" class="difflineminus">-                mozilla::IsSame&lt;X, nsMsgAttachmentData&gt;::value || \</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineminus">-                mozilla::IsSame&lt;X, nsMsgAttachedFile&gt;::value, \</span>
<a href="#l1.166"></a><span id="l1.166" class="difflineminus">-                &quot;Reference-counted class &quot; #X &quot; should not have a public destructor. &quot; \</span>
<a href="#l1.167"></a><span id="l1.167" class="difflineminus">-                &quot;Try to make this class's destructor non-public. If that is really &quot; \</span>
<a href="#l1.168"></a><span id="l1.168" class="difflineminus">-                &quot;not possible, you can whitelist this class by providing a &quot; \</span>
<a href="#l1.169"></a><span id="l1.169" class="difflineminus">-                &quot;HasDangerousPublicDestructor specialization for it.&quot;);</span>
<a href="#l1.170"></a><span id="l1.170" class="difflineplus">+#  define MOZ_ASSERT_TYPE_OK_FOR_REFCOUNTING(X)                              \</span>
<a href="#l1.171"></a><span id="l1.171" class="difflineplus">+    static_assert(                                                           \</span>
<a href="#l1.172"></a><span id="l1.172" class="difflineplus">+        !MOZ_IS_DESTRUCTIBLE(X) ||                                           \</span>
<a href="#l1.173"></a><span id="l1.173" class="difflineplus">+            mozilla::IsSame&lt;X, nsMsgAttachmentData&gt;::value ||                \</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineplus">+            mozilla::IsSame&lt;X, nsMsgAttachedFile&gt;::value,                    \</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineplus">+        &quot;Reference-counted class &quot; #X                                        \</span>
<a href="#l1.176"></a><span id="l1.176" class="difflineplus">+        &quot; should not have a public destructor. &quot;                             \</span>
<a href="#l1.177"></a><span id="l1.177" class="difflineplus">+        &quot;Try to make this class's destructor non-public. If that is really &quot; \</span>
<a href="#l1.178"></a><span id="l1.178" class="difflineplus">+        &quot;not possible, you can whitelist this class by providing a &quot;         \</span>
<a href="#l1.179"></a><span id="l1.179" class="difflineplus">+        &quot;HasDangerousPublicDestructor specialization for it.&quot;);</span>
<a href="#l1.180"></a><span id="l1.180"> #else</span>
<a href="#l1.181"></a><span id="l1.181" class="difflineminus">-#define MOZ_ASSERT_TYPE_OK_FOR_REFCOUNTING(X)</span>
<a href="#l1.182"></a><span id="l1.182" class="difflineplus">+#  define MOZ_ASSERT_TYPE_OK_FOR_REFCOUNTING(X)</span>
<a href="#l1.183"></a><span id="l1.183"> #endif</span>
<a href="#l1.184"></a><span id="l1.184"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/compose/public/nsMsgCompCID.h</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/compose/public/nsMsgCompCID.h</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -8,240 +8,269 @@</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5"> #include &quot;nsISupports.h&quot;</span>
<a href="#l2.6"></a><span id="l2.6"> #include &quot;nsIFactory.h&quot;</span>
<a href="#l2.7"></a><span id="l2.7"> #include &quot;nsIComponentManager.h&quot;</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9"> //</span>
<a href="#l2.10"></a><span id="l2.10"> // nsMsgComposeService</span>
<a href="#l2.11"></a><span id="l2.11"> //</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-#define NS_MSGCOMPOSESERVICE_CID          \</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-{ /* 588595FE-1ADA-11d3-A715-0060B0EB39B5 */      \</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">- 0x588595fe, 0x1ada, 0x11d3,                      \</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">- {0xa7, 0x15, 0x0, 0x60, 0xb0, 0xeb, 0x39, 0xb5}}</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+#define NS_MSGCOMPOSESERVICE_CID                    \</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+  { /* 588595FE-1ADA-11d3-A715-0060B0EB39B5 */      \</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+    0x588595fe, 0x1ada, 0x11d3, {                   \</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+      0xa7, 0x15, 0x0, 0x60, 0xb0, 0xeb, 0x39, 0xb5 \</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+    }                                               \</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+  }</span>
<a href="#l2.22"></a><span id="l2.22"> </span>
<a href="#l2.23"></a><span id="l2.23" class="difflineminus">-#define NS_MSGCOMPOSESERVICE_CONTRACTID     \</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineminus">-  &quot;@mozilla.org/messengercompose;1&quot;</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+#define NS_MSGCOMPOSESERVICE_CONTRACTID &quot;@mozilla.org/messengercompose;1&quot;</span>
<a href="#l2.26"></a><span id="l2.26"> #define NS_MSGCOMPOSESTARTUPHANDLER_CONTRACTID \</span>
<a href="#l2.27"></a><span id="l2.27">   &quot;@mozilla.org/commandlinehandler/general-startup;1?type=compose&quot;</span>
<a href="#l2.28"></a><span id="l2.28"> </span>
<a href="#l2.29"></a><span id="l2.29"> //</span>
<a href="#l2.30"></a><span id="l2.30"> // nsMsgComposeContentHandler</span>
<a href="#l2.31"></a><span id="l2.31"> //</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-#define NS_MSGCOMPOSECONTENTHANDLER_CID         \</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-{ /* 0B63FB80-BBBA-11D4-9DAA-91B657EB313C */    \</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-0x0b63fb80, 0xbbba, 0x11d4,                     \</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">- {0x9d, 0xaa, 0x91, 0xb6, 0x57, 0xeb, 0x31, 0x3c}}</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+#define NS_MSGCOMPOSECONTENTHANDLER_CID              \</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+  { /* 0B63FB80-BBBA-11D4-9DAA-91B657EB313C */       \</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+    0x0b63fb80, 0xbbba, 0x11d4, {                    \</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+      0x9d, 0xaa, 0x91, 0xb6, 0x57, 0xeb, 0x31, 0x3c \</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+    }                                                \</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+  }</span>
<a href="#l2.42"></a><span id="l2.42"> </span>
<a href="#l2.43"></a><span id="l2.43" class="difflineminus">-#define NS_MSGCOMPOSECONTENTHANDLER_CONTRACTID  \</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-  NS_CONTENT_HANDLER_CONTRACTID_PREFIX&quot;application/x-mailto&quot;</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+#define NS_MSGCOMPOSECONTENTHANDLER_CONTRACTID \</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+  NS_CONTENT_HANDLER_CONTRACTID_PREFIX &quot;application/x-mailto&quot;</span>
<a href="#l2.47"></a><span id="l2.47"> </span>
<a href="#l2.48"></a><span id="l2.48"> //</span>
<a href="#l2.49"></a><span id="l2.49"> // nsMsgCompose</span>
<a href="#l2.50"></a><span id="l2.50"> //</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-#define NS_MSGCOMPOSE_CONTRACTID \</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-  &quot;@mozilla.org/messengercompose/compose;1&quot;</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+#define NS_MSGCOMPOSE_CONTRACTID &quot;@mozilla.org/messengercompose/compose;1&quot;</span>
<a href="#l2.54"></a><span id="l2.54"> </span>
<a href="#l2.55"></a><span id="l2.55" class="difflineminus">-#define NS_MSGCOMPOSE_CID             \</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineminus">-{ /* EB5BDAF8-BBC6-11d2-A6EC-0060B0EB39B5 */      \</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineminus">- 0xeb5bdaf8, 0xbbc6, 0x11d2,                      \</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineminus">- {0xa6, 0xec, 0x0, 0x60, 0xb0, 0xeb, 0x39, 0xb5}}</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+#define NS_MSGCOMPOSE_CID                           \</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+  { /* EB5BDAF8-BBC6-11d2-A6EC-0060B0EB39B5 */      \</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+    0xeb5bdaf8, 0xbbc6, 0x11d2, {                   \</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+      0xa6, 0xec, 0x0, 0x60, 0xb0, 0xeb, 0x39, 0xb5 \</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+    }                                               \</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+  }</span>
<a href="#l2.65"></a><span id="l2.65"> </span>
<a href="#l2.66"></a><span id="l2.66"> //</span>
<a href="#l2.67"></a><span id="l2.67"> // nsMsgComposeSecure</span>
<a href="#l2.68"></a><span id="l2.68"> //</span>
<a href="#l2.69"></a><span id="l2.69"> #define NS_MSGCOMPOSESECURE_CONTRACTID \</span>
<a href="#l2.70"></a><span id="l2.70">   &quot;@mozilla.org/messengercompose/composesecure;1&quot;</span>
<a href="#l2.71"></a><span id="l2.71"> </span>
<a href="#l2.72"></a><span id="l2.72"> //</span>
<a href="#l2.73"></a><span id="l2.73"> // nsMsgComposeParams</span>
<a href="#l2.74"></a><span id="l2.74"> //</span>
<a href="#l2.75"></a><span id="l2.75"> #define NS_MSGCOMPOSEPARAMS_CONTRACTID \</span>
<a href="#l2.76"></a><span id="l2.76">   &quot;@mozilla.org/messengercompose/composeparams;1&quot;</span>
<a href="#l2.77"></a><span id="l2.77"> </span>
<a href="#l2.78"></a><span id="l2.78" class="difflineminus">-#define NS_MSGCOMPOSEPARAMS_CID             \</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineminus">-{ /* CB998A00-C079-11D4-9DAA-8DF64BAB2EFC */      \</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineminus">- 0xcb998a00, 0xc079, 0x11d4,                      \</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineminus">- {0x9d, 0xaa, 0x8d, 0xf6, 0x4b, 0xab, 0x2e, 0xfc}}</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineplus">+#define NS_MSGCOMPOSEPARAMS_CID                      \</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineplus">+  { /* CB998A00-C079-11D4-9DAA-8DF64BAB2EFC */       \</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineplus">+    0xcb998a00, 0xc079, 0x11d4, {                    \</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineplus">+      0x9d, 0xaa, 0x8d, 0xf6, 0x4b, 0xab, 0x2e, 0xfc \</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineplus">+    }                                                \</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+  }</span>
<a href="#l2.88"></a><span id="l2.88"> </span>
<a href="#l2.89"></a><span id="l2.89"> //</span>
<a href="#l2.90"></a><span id="l2.90"> // nsMsgComposeSendListener</span>
<a href="#l2.91"></a><span id="l2.91"> //</span>
<a href="#l2.92"></a><span id="l2.92"> #define NS_MSGCOMPOSESENDLISTENER_CONTRACTID \</span>
<a href="#l2.93"></a><span id="l2.93">   &quot;@mozilla.org/messengercompose/composesendlistener;1&quot;</span>
<a href="#l2.94"></a><span id="l2.94"> </span>
<a href="#l2.95"></a><span id="l2.95" class="difflineminus">-#define NS_MSGCOMPOSESENDLISTENER_CID             \</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineminus">-{ /* acc72781-2cea-11d5-9daa-bacdeac1eefc */      \</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineminus">- 0xacc72781, 0x2cea, 0x11d5,                      \</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineminus">- {0x9d, 0xaa, 0xba, 0xcd, 0xea, 0xc1, 0xee, 0xfc}}</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineplus">+#define NS_MSGCOMPOSESENDLISTENER_CID                \</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineplus">+  { /* acc72781-2cea-11d5-9daa-bacdeac1eefc */       \</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineplus">+    0xacc72781, 0x2cea, 0x11d5, {                    \</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineplus">+      0x9d, 0xaa, 0xba, 0xcd, 0xea, 0xc1, 0xee, 0xfc \</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineplus">+    }                                                \</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineplus">+  }</span>
<a href="#l2.105"></a><span id="l2.105"> </span>
<a href="#l2.106"></a><span id="l2.106"> //</span>
<a href="#l2.107"></a><span id="l2.107"> // nsMsgComposeProgressParams</span>
<a href="#l2.108"></a><span id="l2.108"> //</span>
<a href="#l2.109"></a><span id="l2.109"> #define NS_MSGCOMPOSEPROGRESSPARAMS_CONTRACTID \</span>
<a href="#l2.110"></a><span id="l2.110">   &quot;@mozilla.org/messengercompose/composeprogressparameters;1&quot;</span>
<a href="#l2.111"></a><span id="l2.111"> </span>
<a href="#l2.112"></a><span id="l2.112" class="difflineminus">-#define NS_MSGCOMPOSEPROGRESSPARAMS_CID             \</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineminus">-{ /* 1e0e7c01-3e4c-11d5-9daa-f88d288130fc */      \</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineminus">- 0x1e0e7c01, 0x3e4c, 0x11d5,                      \</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineminus">- {0x9d, 0xaa, 0xf8, 0x8d, 0x28, 0x81, 0x30, 0xfc}}</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineplus">+#define NS_MSGCOMPOSEPROGRESSPARAMS_CID              \</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineplus">+  { /* 1e0e7c01-3e4c-11d5-9daa-f88d288130fc */       \</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineplus">+    0x1e0e7c01, 0x3e4c, 0x11d5, {                    \</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineplus">+      0x9d, 0xaa, 0xf8, 0x8d, 0x28, 0x81, 0x30, 0xfc \</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineplus">+    }                                                \</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineplus">+  }</span>
<a href="#l2.122"></a><span id="l2.122"> </span>
<a href="#l2.123"></a><span id="l2.123"> //</span>
<a href="#l2.124"></a><span id="l2.124"> // nsMsgCompFields</span>
<a href="#l2.125"></a><span id="l2.125"> //</span>
<a href="#l2.126"></a><span id="l2.126"> #define NS_MSGCOMPFIELDS_CONTRACTID \</span>
<a href="#l2.127"></a><span id="l2.127">   &quot;@mozilla.org/messengercompose/composefields;1&quot;</span>
<a href="#l2.128"></a><span id="l2.128"> </span>
<a href="#l2.129"></a><span id="l2.129" class="difflineminus">-#define NS_MSGCOMPFIELDS_CID                    \</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineminus">-{ /* e64b0f51-0d7b-4e2f-8c60-3862ee8c174f */      \</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineminus">- 0xe64b0f51, 0x0d7b, 0x4e2f,                      \</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineminus">- {0x8c, 0x60, 0x38, 0x62, 0xee, 0x8c, 0x17, 0x4f}}</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineplus">+#define NS_MSGCOMPFIELDS_CID                         \</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineplus">+  { /* e64b0f51-0d7b-4e2f-8c60-3862ee8c174f */       \</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineplus">+    0xe64b0f51, 0x0d7b, 0x4e2f, {                    \</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineplus">+      0x8c, 0x60, 0x38, 0x62, 0xee, 0x8c, 0x17, 0x4f \</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineplus">+    }                                                \</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineplus">+  }</span>
<a href="#l2.139"></a><span id="l2.139"> </span>
<a href="#l2.140"></a><span id="l2.140"> //</span>
<a href="#l2.141"></a><span id="l2.141"> // nsMsgAttachment</span>
<a href="#l2.142"></a><span id="l2.142"> //</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineminus">-#define NS_MSGATTACHMENT_CONTRACTID \</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineminus">-  &quot;@mozilla.org/messengercompose/attachment;1&quot;</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineplus">+#define NS_MSGATTACHMENT_CONTRACTID &quot;@mozilla.org/messengercompose/attachment;1&quot;</span>
<a href="#l2.146"></a><span id="l2.146"> </span>
<a href="#l2.147"></a><span id="l2.147" class="difflineminus">-#define NS_MSGATTACHMENT_CID                    \</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineminus">-{ /* 27B8D045-8D9F-4fa8-BFB6-8A0F8D09CE89 */    \</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineminus">- 0x27b8d045, 0x8d9f, 0x4fa8,                    \</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineminus">- {0xbf, 0xb6, 0x8a, 0xf, 0x8d, 0x9, 0xce, 0x89}}</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineplus">+#define NS_MSGATTACHMENT_CID                       \</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineplus">+  { /* 27B8D045-8D9F-4fa8-BFB6-8A0F8D09CE89 */     \</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineplus">+    0x27b8d045, 0x8d9f, 0x4fa8, {                  \</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineplus">+      0xbf, 0xb6, 0x8a, 0xf, 0x8d, 0x9, 0xce, 0x89 \</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineplus">+    }                                              \</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineplus">+  }</span>
<a href="#l2.157"></a><span id="l2.157"> </span>
<a href="#l2.158"></a><span id="l2.158"> //</span>
<a href="#l2.159"></a><span id="l2.159"> // nsMsgAttachmentData</span>
<a href="#l2.160"></a><span id="l2.160"> //</span>
<a href="#l2.161"></a><span id="l2.161"> #define NS_MSGATTACHMENTDATA_CONTRACTID \</span>
<a href="#l2.162"></a><span id="l2.162">   &quot;@mozilla.org/messengercompose/attachmentdata;1&quot;</span>
<a href="#l2.163"></a><span id="l2.163"> </span>
<a href="#l2.164"></a><span id="l2.164" class="difflineminus">-#define NS_MSGATTACHMENTDATA_CID                    \</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineminus">-{ /* 9e16958d-d9e9-4cae-b723-a5bccf104998 */ \</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineminus">- 0x9e16958d, 0xd9e9, 0x4cae, \</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineminus">- {0xb7, 0x23, 0xa5, 0xbc, 0xcf, 0x10, 0x49, 0x98}}</span>
<a href="#l2.168"></a><span id="l2.168" class="difflineplus">+#define NS_MSGATTACHMENTDATA_CID                     \</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineplus">+  { /* 9e16958d-d9e9-4cae-b723-a5bccf104998 */       \</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineplus">+    0x9e16958d, 0xd9e9, 0x4cae, {                    \</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineplus">+      0xb7, 0x23, 0xa5, 0xbc, 0xcf, 0x10, 0x49, 0x98 \</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineplus">+    }                                                \</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineplus">+  }</span>
<a href="#l2.174"></a><span id="l2.174"> </span>
<a href="#l2.175"></a><span id="l2.175"> //</span>
<a href="#l2.176"></a><span id="l2.176"> // nsMsgAttachedFile</span>
<a href="#l2.177"></a><span id="l2.177"> //</span>
<a href="#l2.178"></a><span id="l2.178"> #define NS_MSGATTACHEDFILE_CONTRACTID \</span>
<a href="#l2.179"></a><span id="l2.179">   &quot;@mozilla.org/messengercompose/attachedfile;1&quot;</span>
<a href="#l2.180"></a><span id="l2.180"> </span>
<a href="#l2.181"></a><span id="l2.181" class="difflineminus">-#define NS_MSGATTACHEDFILE_CID                    \</span>
<a href="#l2.182"></a><span id="l2.182" class="difflineminus">-{ /* ef173501-4e14-42b9-ae1f-7770de235c29 */ \</span>
<a href="#l2.183"></a><span id="l2.183" class="difflineminus">- 0xef173501, 0x4e14, 0x42b9, \</span>
<a href="#l2.184"></a><span id="l2.184" class="difflineminus">- {0xae, 0x1f, 0x77, 0x70, 0xde, 0x23, 0x5c, 0x29}}</span>
<a href="#l2.185"></a><span id="l2.185" class="difflineplus">+#define NS_MSGATTACHEDFILE_CID                       \</span>
<a href="#l2.186"></a><span id="l2.186" class="difflineplus">+  { /* ef173501-4e14-42b9-ae1f-7770de235c29 */       \</span>
<a href="#l2.187"></a><span id="l2.187" class="difflineplus">+    0xef173501, 0x4e14, 0x42b9, {                    \</span>
<a href="#l2.188"></a><span id="l2.188" class="difflineplus">+      0xae, 0x1f, 0x77, 0x70, 0xde, 0x23, 0x5c, 0x29 \</span>
<a href="#l2.189"></a><span id="l2.189" class="difflineplus">+    }                                                \</span>
<a href="#l2.190"></a><span id="l2.190" class="difflineplus">+  }</span>
<a href="#l2.191"></a><span id="l2.191"> </span>
<a href="#l2.192"></a><span id="l2.192"> //</span>
<a href="#l2.193"></a><span id="l2.193"> // nsMsgSend</span>
<a href="#l2.194"></a><span id="l2.194"> //</span>
<a href="#l2.195"></a><span id="l2.195" class="difflineminus">-#define NS_MSGSEND_CONTRACTID \</span>
<a href="#l2.196"></a><span id="l2.196" class="difflineminus">-  &quot;@mozilla.org/messengercompose/send;1&quot;</span>
<a href="#l2.197"></a><span id="l2.197" class="difflineplus">+#define NS_MSGSEND_CONTRACTID &quot;@mozilla.org/messengercompose/send;1&quot;</span>
<a href="#l2.198"></a><span id="l2.198"> </span>
<a href="#l2.199"></a><span id="l2.199" class="difflineminus">-#define NS_MSGSEND_CID                \</span>
<a href="#l2.200"></a><span id="l2.200" class="difflineminus">-{ /* 935284E0-C5D8-11d2-8297-000000000000 */      \</span>
<a href="#l2.201"></a><span id="l2.201" class="difflineminus">- 0x935284e0, 0xc5d8, 0x11d2,                      \</span>
<a href="#l2.202"></a><span id="l2.202" class="difflineminus">- {0x82, 0x97, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0}}</span>
<a href="#l2.203"></a><span id="l2.203" class="difflineplus">+#define NS_MSGSEND_CID                                                       \</span>
<a href="#l2.204"></a><span id="l2.204" class="difflineplus">+  { /* 935284E0-C5D8-11d2-8297-000000000000 */                               \</span>
<a href="#l2.205"></a><span id="l2.205" class="difflineplus">+    0x935284e0, 0xc5d8, 0x11d2, { 0x82, 0x97, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0 } \</span>
<a href="#l2.206"></a><span id="l2.206" class="difflineplus">+  }</span>
<a href="#l2.207"></a><span id="l2.207"> </span>
<a href="#l2.208"></a><span id="l2.208"> //</span>
<a href="#l2.209"></a><span id="l2.209"> // nsMsgSendLater</span>
<a href="#l2.210"></a><span id="l2.210"> //</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineminus">-#define NS_MSGSENDLATER_CONTRACTID                            \</span>
<a href="#l2.212"></a><span id="l2.212" class="difflineminus">-  &quot;@mozilla.org/messengercompose/sendlater;1&quot;</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineplus">+#define NS_MSGSENDLATER_CONTRACTID &quot;@mozilla.org/messengercompose/sendlater;1&quot;</span>
<a href="#l2.214"></a><span id="l2.214"> </span>
<a href="#l2.215"></a><span id="l2.215" class="difflineminus">-#define NS_MSGSENDLATER_CID                           \</span>
<a href="#l2.216"></a><span id="l2.216" class="difflineminus">-{ /* E15C83F1-1CF4-11d3-8EF0-00A024A7D144 */      \</span>
<a href="#l2.217"></a><span id="l2.217" class="difflineminus">- 0xe15c83f1, 0x1cf4, 0x11d3,                      \</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineminus">- {0x8e, 0xf0, 0x0, 0xa0, 0x24, 0xa7, 0xd1, 0x44 }}</span>
<a href="#l2.219"></a><span id="l2.219" class="difflineplus">+#define NS_MSGSENDLATER_CID                         \</span>
<a href="#l2.220"></a><span id="l2.220" class="difflineplus">+  { /* E15C83F1-1CF4-11d3-8EF0-00A024A7D144 */      \</span>
<a href="#l2.221"></a><span id="l2.221" class="difflineplus">+    0xe15c83f1, 0x1cf4, 0x11d3, {                   \</span>
<a href="#l2.222"></a><span id="l2.222" class="difflineplus">+      0x8e, 0xf0, 0x0, 0xa0, 0x24, 0xa7, 0xd1, 0x44 \</span>
<a href="#l2.223"></a><span id="l2.223" class="difflineplus">+    }                                               \</span>
<a href="#l2.224"></a><span id="l2.224" class="difflineplus">+  }</span>
<a href="#l2.225"></a><span id="l2.225"> </span>
<a href="#l2.226"></a><span id="l2.226"> //</span>
<a href="#l2.227"></a><span id="l2.227"> // nsSmtpUrl</span>
<a href="#l2.228"></a><span id="l2.228"> //</span>
<a href="#l2.229"></a><span id="l2.229" class="difflineminus">-#define NS_SMTPURL_CONTRACTID \</span>
<a href="#l2.230"></a><span id="l2.230" class="difflineminus">-  &quot;@mozilla.org/messengercompose/smtpurl;1&quot;</span>
<a href="#l2.231"></a><span id="l2.231" class="difflineplus">+#define NS_SMTPURL_CONTRACTID &quot;@mozilla.org/messengercompose/smtpurl;1&quot;</span>
<a href="#l2.232"></a><span id="l2.232"> </span>
<a href="#l2.233"></a><span id="l2.233" class="difflineminus">-#define NS_SMTPURL_CID                            \</span>
<a href="#l2.234"></a><span id="l2.234" class="difflineminus">-{ /* BE59DBF0-2812-11d3-80A3-006008128C4E} */      \</span>
<a href="#l2.235"></a><span id="l2.235" class="difflineminus">- 0xbe59dbf0, 0x2812, 0x11d3,                      \</span>
<a href="#l2.236"></a><span id="l2.236" class="difflineminus">- {0x80, 0xa3, 0x0, 0x60, 0x8, 0x12, 0x8c, 0x4e}}</span>
<a href="#l2.237"></a><span id="l2.237" class="difflineplus">+#define NS_SMTPURL_CID                             \</span>
<a href="#l2.238"></a><span id="l2.238" class="difflineplus">+  { /* BE59DBF0-2812-11d3-80A3-006008128C4E} */    \</span>
<a href="#l2.239"></a><span id="l2.239" class="difflineplus">+    0xbe59dbf0, 0x2812, 0x11d3, {                  \</span>
<a href="#l2.240"></a><span id="l2.240" class="difflineplus">+      0x80, 0xa3, 0x0, 0x60, 0x8, 0x12, 0x8c, 0x4e \</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineplus">+    }                                              \</span>
<a href="#l2.242"></a><span id="l2.242" class="difflineplus">+  }</span>
<a href="#l2.243"></a><span id="l2.243"> </span>
<a href="#l2.244"></a><span id="l2.244"> //</span>
<a href="#l2.245"></a><span id="l2.245"> // nsMailtoUrl</span>
<a href="#l2.246"></a><span id="l2.246"> //</span>
<a href="#l2.247"></a><span id="l2.247" class="difflineminus">-#define NS_MAILTOURL_CONTRACTID \</span>
<a href="#l2.248"></a><span id="l2.248" class="difflineminus">-  &quot;@mozilla.org/messengercompose/mailtourl;1&quot;</span>
<a href="#l2.249"></a><span id="l2.249" class="difflineplus">+#define NS_MAILTOURL_CONTRACTID &quot;@mozilla.org/messengercompose/mailtourl;1&quot;</span>
<a href="#l2.250"></a><span id="l2.250"> </span>
<a href="#l2.251"></a><span id="l2.251" class="difflineminus">-#define NS_MAILTOURL_CID                            \</span>
<a href="#l2.252"></a><span id="l2.252" class="difflineminus">-{ /* 05BAB5E7-9C7D-11d3-98A3-001083010E9B} */       \</span>
<a href="#l2.253"></a><span id="l2.253" class="difflineminus">- 0x5bab5e7, 0x9c7d, 0x11d3,                         \</span>
<a href="#l2.254"></a><span id="l2.254" class="difflineminus">- {0x98, 0xa3, 0x0, 0x10, 0x83, 0x1, 0xe, 0x9b}}</span>
<a href="#l2.255"></a><span id="l2.255" class="difflineplus">+#define NS_MAILTOURL_CID                                                       \</span>
<a href="#l2.256"></a><span id="l2.256" class="difflineplus">+  { /* 05BAB5E7-9C7D-11d3-98A3-001083010E9B} */                                \</span>
<a href="#l2.257"></a><span id="l2.257" class="difflineplus">+    0x5bab5e7, 0x9c7d, 0x11d3, { 0x98, 0xa3, 0x0, 0x10, 0x83, 0x1, 0xe, 0x9b } \</span>
<a href="#l2.258"></a><span id="l2.258" class="difflineplus">+  }</span>
<a href="#l2.259"></a><span id="l2.259"> </span>
<a href="#l2.260"></a><span id="l2.260"> //</span>
<a href="#l2.261"></a><span id="l2.261"> // nsSmtpServer</span>
<a href="#l2.262"></a><span id="l2.262"> //</span>
<a href="#l2.263"></a><span id="l2.263" class="difflineminus">-#define NS_SMTPSERVER_CONTRACTID \</span>
<a href="#l2.264"></a><span id="l2.264" class="difflineminus">-  &quot;@mozilla.org/messenger/smtp/server;1&quot;</span>
<a href="#l2.265"></a><span id="l2.265" class="difflineplus">+#define NS_SMTPSERVER_CONTRACTID &quot;@mozilla.org/messenger/smtp/server;1&quot;</span>
<a href="#l2.266"></a><span id="l2.266"> </span>
<a href="#l2.267"></a><span id="l2.267" class="difflineminus">-#define NS_SMTPSERVER_CID                      \</span>
<a href="#l2.268"></a><span id="l2.268" class="difflineminus">-{ /* 60dc861a-56ce-11d3-9118-00a0c900d445 */   \</span>
<a href="#l2.269"></a><span id="l2.269" class="difflineminus">-  0x60dc861a,0x56ce,0x11d3,                   \</span>
<a href="#l2.270"></a><span id="l2.270" class="difflineminus">-  {0x91,0x18, 0x0, 0xa0, 0xc9, 0x0, 0xd4, 0x45 }}</span>
<a href="#l2.271"></a><span id="l2.271" class="difflineplus">+#define NS_SMTPSERVER_CID                          \</span>
<a href="#l2.272"></a><span id="l2.272" class="difflineplus">+  { /* 60dc861a-56ce-11d3-9118-00a0c900d445 */     \</span>
<a href="#l2.273"></a><span id="l2.273" class="difflineplus">+    0x60dc861a, 0x56ce, 0x11d3, {                  \</span>
<a href="#l2.274"></a><span id="l2.274" class="difflineplus">+      0x91, 0x18, 0x0, 0xa0, 0xc9, 0x0, 0xd4, 0x45 \</span>
<a href="#l2.275"></a><span id="l2.275" class="difflineplus">+    }                                              \</span>
<a href="#l2.276"></a><span id="l2.276" class="difflineplus">+  }</span>
<a href="#l2.277"></a><span id="l2.277"> </span>
<a href="#l2.278"></a><span id="l2.278"> //</span>
<a href="#l2.279"></a><span id="l2.279"> // nsSmtpService</span>
<a href="#l2.280"></a><span id="l2.280"> //</span>
<a href="#l2.281"></a><span id="l2.281" class="difflineminus">-#define NS_SMTPSERVICE_CONTRACTID \</span>
<a href="#l2.282"></a><span id="l2.282" class="difflineminus">-  &quot;@mozilla.org/messengercompose/smtp;1&quot;</span>
<a href="#l2.283"></a><span id="l2.283" class="difflineplus">+#define NS_SMTPSERVICE_CONTRACTID &quot;@mozilla.org/messengercompose/smtp;1&quot;</span>
<a href="#l2.284"></a><span id="l2.284"> </span>
<a href="#l2.285"></a><span id="l2.285"> #define NS_MAILTOHANDLER_CONTRACTID \</span>
<a href="#l2.286"></a><span id="l2.286">   NS_NETWORK_PROTOCOL_CONTRACTID_PREFIX &quot;mailto&quot;</span>
<a href="#l2.287"></a><span id="l2.287"> </span>
<a href="#l2.288"></a><span id="l2.288" class="difflineminus">-#define NS_SMTPSERVICE_CID              \</span>
<a href="#l2.289"></a><span id="l2.289" class="difflineminus">-{ /* 5B6419F1-CA9B-11d2-8063-006008128C4E */      \</span>
<a href="#l2.290"></a><span id="l2.290" class="difflineminus">- 0x5b6419f1, 0xca9b, 0x11d2,                      \</span>
<a href="#l2.291"></a><span id="l2.291" class="difflineminus">- {0x80, 0x63, 0x0, 0x60, 0x8, 0x12, 0x8c, 0x4e}}</span>
<a href="#l2.292"></a><span id="l2.292" class="difflineplus">+#define NS_SMTPSERVICE_CID                         \</span>
<a href="#l2.293"></a><span id="l2.293" class="difflineplus">+  { /* 5B6419F1-CA9B-11d2-8063-006008128C4E */     \</span>
<a href="#l2.294"></a><span id="l2.294" class="difflineplus">+    0x5b6419f1, 0xca9b, 0x11d2, {                  \</span>
<a href="#l2.295"></a><span id="l2.295" class="difflineplus">+      0x80, 0x63, 0x0, 0x60, 0x8, 0x12, 0x8c, 0x4e \</span>
<a href="#l2.296"></a><span id="l2.296" class="difflineplus">+    }                                              \</span>
<a href="#l2.297"></a><span id="l2.297" class="difflineplus">+  }</span>
<a href="#l2.298"></a><span id="l2.298"> </span>
<a href="#l2.299"></a><span id="l2.299"> //</span>
<a href="#l2.300"></a><span id="l2.300"> // nsMsgQuote</span>
<a href="#l2.301"></a><span id="l2.301"> //</span>
<a href="#l2.302"></a><span id="l2.302" class="difflineminus">-#define NS_MSGQUOTE_CONTRACTID \</span>
<a href="#l2.303"></a><span id="l2.303" class="difflineminus">-  &quot;@mozilla.org/messengercompose/quoting;1&quot;</span>
<a href="#l2.304"></a><span id="l2.304" class="difflineminus">-#define NS_MSGQUOTE_CID \</span>
<a href="#l2.305"></a><span id="l2.305" class="difflineminus">-  {0x1C7ABF0C, 0x21E5, 0x11d3, \</span>
<a href="#l2.306"></a><span id="l2.306" class="difflineminus">-    { 0x8E, 0xF1, 0x00, 0xA0, 0x24, 0xA7, 0xD1, 0x44 }}</span>
<a href="#l2.307"></a><span id="l2.307" class="difflineplus">+#define NS_MSGQUOTE_CONTRACTID &quot;@mozilla.org/messengercompose/quoting;1&quot;</span>
<a href="#l2.308"></a><span id="l2.308" class="difflineplus">+#define NS_MSGQUOTE_CID                              \</span>
<a href="#l2.309"></a><span id="l2.309" class="difflineplus">+  {                                                  \</span>
<a href="#l2.310"></a><span id="l2.310" class="difflineplus">+    0x1C7ABF0C, 0x21E5, 0x11d3, {                    \</span>
<a href="#l2.311"></a><span id="l2.311" class="difflineplus">+      0x8E, 0xF1, 0x00, 0xA0, 0x24, 0xA7, 0xD1, 0x44 \</span>
<a href="#l2.312"></a><span id="l2.312" class="difflineplus">+    }                                                \</span>
<a href="#l2.313"></a><span id="l2.313" class="difflineplus">+  }</span>
<a href="#l2.314"></a><span id="l2.314"> </span>
<a href="#l2.315"></a><span id="l2.315"> #define NS_MSGQUOTELISTENER_CONTRACTID \</span>
<a href="#l2.316"></a><span id="l2.316">   &quot;@mozilla.org/messengercompose/quotinglistener;1&quot;</span>
<a href="#l2.317"></a><span id="l2.317" class="difflineminus">-#define NS_MSGQUOTELISTENER_CID \</span>
<a href="#l2.318"></a><span id="l2.318" class="difflineminus">-  {0x683728ac, 0x88df, 0x11d3, \</span>
<a href="#l2.319"></a><span id="l2.319" class="difflineminus">-    { 0x98, 0x9d, 0x0, 0x10, 0x83, 0x1, 0xe, 0x9b }}</span>
<a href="#l2.320"></a><span id="l2.320" class="difflineplus">+#define NS_MSGQUOTELISTENER_CID                   \</span>
<a href="#l2.321"></a><span id="l2.321" class="difflineplus">+  {                                               \</span>
<a href="#l2.322"></a><span id="l2.322" class="difflineplus">+    0x683728ac, 0x88df, 0x11d3, {                 \</span>
<a href="#l2.323"></a><span id="l2.323" class="difflineplus">+      0x98, 0x9d, 0x0, 0x10, 0x83, 0x1, 0xe, 0x9b \</span>
<a href="#l2.324"></a><span id="l2.324" class="difflineplus">+    }                                             \</span>
<a href="#l2.325"></a><span id="l2.325" class="difflineplus">+  }</span>
<a href="#l2.326"></a><span id="l2.326"> </span>
<a href="#l2.327"></a><span id="l2.327"> //</span>
<a href="#l2.328"></a><span id="l2.328"> // nsMsgDraft</span>
<a href="#l2.329"></a><span id="l2.329"> //</span>
<a href="#l2.330"></a><span id="l2.330" class="difflineminus">-#define NS_MSGDRAFT_CONTRACTID \</span>
<a href="#l2.331"></a><span id="l2.331" class="difflineminus">-  &quot;@mozilla.org/messengercompose/drafts;1&quot;</span>
<a href="#l2.332"></a><span id="l2.332" class="difflineminus">-#define NS_MSGDRAFT_CID \</span>
<a href="#l2.333"></a><span id="l2.333" class="difflineminus">-  { 0xa623746c, 0x453b, 0x11d3, \</span>
<a href="#l2.334"></a><span id="l2.334" class="difflineminus">-  { 0x8f, 0xf, 0x0, 0xa0, 0x24, 0xa7, 0xd1, 0x44 } }</span>
<a href="#l2.335"></a><span id="l2.335" class="difflineplus">+#define NS_MSGDRAFT_CONTRACTID &quot;@mozilla.org/messengercompose/drafts;1&quot;</span>
<a href="#l2.336"></a><span id="l2.336" class="difflineplus">+#define NS_MSGDRAFT_CID                            \</span>
<a href="#l2.337"></a><span id="l2.337" class="difflineplus">+  {                                                \</span>
<a href="#l2.338"></a><span id="l2.338" class="difflineplus">+    0xa623746c, 0x453b, 0x11d3, {                  \</span>
<a href="#l2.339"></a><span id="l2.339" class="difflineplus">+      0x8f, 0xf, 0x0, 0xa0, 0x24, 0xa7, 0xd1, 0x44 \</span>
<a href="#l2.340"></a><span id="l2.340" class="difflineplus">+    }                                              \</span>
<a href="#l2.341"></a><span id="l2.341" class="difflineplus">+  }</span>
<a href="#l2.342"></a><span id="l2.342"> </span>
<a href="#l2.343"></a><span id="l2.343"> //</span>
<a href="#l2.344"></a><span id="l2.344"> // nsURLFetcher</span>
<a href="#l2.345"></a><span id="l2.345"> //</span>
<a href="#l2.346"></a><span id="l2.346" class="difflineminus">-#define NS_URLFETCHER_CONTRACTID  \</span>
<a href="#l2.347"></a><span id="l2.347" class="difflineminus">-  &quot;@mozilla.org/messengercompose/urlfetcher;1&quot;</span>
<a href="#l2.348"></a><span id="l2.348" class="difflineplus">+#define NS_URLFETCHER_CONTRACTID &quot;@mozilla.org/messengercompose/urlfetcher;1&quot;</span>
<a href="#l2.349"></a><span id="l2.349"> </span>
<a href="#l2.350"></a><span id="l2.350"> // {01B8A701-2F52-11D5-9DAA-F78DA781A1FC}</span>
<a href="#l2.351"></a><span id="l2.351" class="difflineminus">-#define NS_URLFETCHER_CID \</span>
<a href="#l2.352"></a><span id="l2.352" class="difflineminus">-{ 0x01b8a701, 0x2f52, 0x11d5, \</span>
<a href="#l2.353"></a><span id="l2.353" class="difflineminus">- { 0x9d, 0xaa, 0xf7, 0x8d, 0xa7, 0x81, 0xa1, 0xfc } }</span>
<a href="#l2.354"></a><span id="l2.354" class="difflineplus">+#define NS_URLFETCHER_CID                            \</span>
<a href="#l2.355"></a><span id="l2.355" class="difflineplus">+  {                                                  \</span>
<a href="#l2.356"></a><span id="l2.356" class="difflineplus">+    0x01b8a701, 0x2f52, 0x11d5, {                    \</span>
<a href="#l2.357"></a><span id="l2.357" class="difflineplus">+      0x9d, 0xaa, 0xf7, 0x8d, 0xa7, 0x81, 0xa1, 0xfc \</span>
<a href="#l2.358"></a><span id="l2.358" class="difflineplus">+    }                                                \</span>
<a href="#l2.359"></a><span id="l2.359" class="difflineplus">+  }</span>
<a href="#l2.360"></a><span id="l2.360"> </span>
<a href="#l2.361"></a><span id="l2.361"> //</span>
<a href="#l2.362"></a><span id="l2.362"> // nsMsgCompUtils</span>
<a href="#l2.363"></a><span id="l2.363"> //</span>
<a href="#l2.364"></a><span id="l2.364" class="difflineminus">-#define NS_MSGCOMPUTILS_CONTRACTID  \</span>
<a href="#l2.365"></a><span id="l2.365" class="difflineminus">-  &quot;@mozilla.org/messengercompose/computils;1&quot;</span>
<a href="#l2.366"></a><span id="l2.366" class="difflineplus">+#define NS_MSGCOMPUTILS_CONTRACTID &quot;@mozilla.org/messengercompose/computils;1&quot;</span>
<a href="#l2.367"></a><span id="l2.367"> </span>
<a href="#l2.368"></a><span id="l2.368"> // {ceb0dca2-5e7d-4204-94d4-2ab925921fae}</span>
<a href="#l2.369"></a><span id="l2.369" class="difflineminus">-#define NS_MSGCOMPUTILS_CID \</span>
<a href="#l2.370"></a><span id="l2.370" class="difflineminus">-{ 0xceb0dca2, 0x5e7d, 0x4204, \</span>
<a href="#l2.371"></a><span id="l2.371" class="difflineminus">-  { 0x94, 0xd4, 0x2a, 0xb9, 0x25, 0x92, 0x1f, 0xae } }</span>
<a href="#l2.372"></a><span id="l2.372" class="difflineplus">+#define NS_MSGCOMPUTILS_CID                          \</span>
<a href="#l2.373"></a><span id="l2.373" class="difflineplus">+  {                                                  \</span>
<a href="#l2.374"></a><span id="l2.374" class="difflineplus">+    0xceb0dca2, 0x5e7d, 0x4204, {                    \</span>
<a href="#l2.375"></a><span id="l2.375" class="difflineplus">+      0x94, 0xd4, 0x2a, 0xb9, 0x25, 0x92, 0x1f, 0xae \</span>
<a href="#l2.376"></a><span id="l2.376" class="difflineplus">+    }                                                \</span>
<a href="#l2.377"></a><span id="l2.377" class="difflineplus">+  }</span>
<a href="#l2.378"></a><span id="l2.378"> </span>
<a href="#l2.379"></a><span id="l2.379" class="difflineminus">-</span>
<a href="#l2.380"></a><span id="l2.380" class="difflineminus">-#endif // nsMessageCompCID_h__</span>
<a href="#l2.381"></a><span id="l2.381" class="difflineplus">+#endif  // nsMessageCompCID_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/compose/src/nsComposeStrings.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/compose/src/nsComposeStrings.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,23 +1,21 @@</span>
<a href="#l3.4"></a><span id="l3.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.5"></a><span id="l3.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.6"></a><span id="l3.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8"> #include &quot;nsComposeStrings.h&quot;</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10" class="difflineminus">-const char* errorStringNameForErrorCode(nsresult aCode)</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineminus">-{</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+const char* errorStringNameForErrorCode(nsresult aCode) {</span>
<a href="#l3.13"></a><span id="l3.13"> #ifdef __GNUC__</span>
<a href="#l3.14"></a><span id="l3.14"> // Temporary workaround until bug 783526 is fixed.</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-#pragma GCC diagnostic push</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-#pragma GCC diagnostic ignored &quot;-Wswitch&quot;</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+#  pragma GCC diagnostic push</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+#  pragma GCC diagnostic ignored &quot;-Wswitch&quot;</span>
<a href="#l3.19"></a><span id="l3.19"> #endif</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-  switch(aCode)</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-  {</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+  switch (aCode) {</span>
<a href="#l3.23"></a><span id="l3.23">     case NS_MSG_UNABLE_TO_OPEN_FILE:</span>
<a href="#l3.24"></a><span id="l3.24">       return &quot;unableToOpenFile&quot;;</span>
<a href="#l3.25"></a><span id="l3.25">     case NS_MSG_UNABLE_TO_OPEN_TMP_FILE:</span>
<a href="#l3.26"></a><span id="l3.26">       return &quot;unableToOpenTmpFile&quot;;</span>
<a href="#l3.27"></a><span id="l3.27">     case NS_MSG_UNABLE_TO_SAVE_TEMPLATE:</span>
<a href="#l3.28"></a><span id="l3.28">       return &quot;unableToSaveTemplate&quot;;</span>
<a href="#l3.29"></a><span id="l3.29">     case NS_MSG_UNABLE_TO_SAVE_DRAFT:</span>
<a href="#l3.30"></a><span id="l3.30">       return &quot;unableToSaveDraft&quot;;</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineat">@@ -100,11 +98,11 @@ const char* errorStringNameForErrorCode(</span>
<a href="#l3.32"></a><span id="l3.32">     case NS_ERROR_CLIENTID:</span>
<a href="#l3.33"></a><span id="l3.33">       return &quot;smtpClientid&quot;;</span>
<a href="#l3.34"></a><span id="l3.34">     case NS_ERROR_CLIENTID_PERMISSION:</span>
<a href="#l3.35"></a><span id="l3.35">       return &quot;smtpClientidPermission&quot;;</span>
<a href="#l3.36"></a><span id="l3.36">     default:</span>
<a href="#l3.37"></a><span id="l3.37">       return &quot;sendFailed&quot;;</span>
<a href="#l3.38"></a><span id="l3.38">   }</span>
<a href="#l3.39"></a><span id="l3.39"> #ifdef __GNUC__</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">-#pragma GCC diagnostic pop</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+#  pragma GCC diagnostic pop</span>
<a href="#l3.42"></a><span id="l3.42"> #endif</span>
<a href="#l3.43"></a><span id="l3.43"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/compose/src/nsComposeStrings.h</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/compose/src/nsComposeStrings.h</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1,12 +1,13 @@</span>
<a href="#l4.4"></a><span id="l4.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.5"></a><span id="l4.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.6"></a><span id="l4.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8" class="difflineplus">+// clang-format off</span>
<a href="#l4.9"></a><span id="l4.9"> /**</span>
<a href="#l4.10"></a><span id="l4.10">   String Ids used by mailnews\compose</span>
<a href="#l4.11"></a><span id="l4.11">   To Do: Convert the callers to use names instead of ids and then make this file obsolete.</span>
<a href="#l4.12"></a><span id="l4.12">  */</span>
<a href="#l4.13"></a><span id="l4.13"> </span>
<a href="#l4.14"></a><span id="l4.14"> #ifndef _nsComposeStrings_H__</span>
<a href="#l4.15"></a><span id="l4.15"> #define _nsComposeStrings_H__</span>
<a href="#l4.16"></a><span id="l4.16"> </span>
<a href="#l4.17"></a><span id="l4.17" class="difflineat">@@ -67,8 +68,10 @@</span>
<a href="#l4.18"></a><span id="l4.18"> #define NS_ERROR_ILLEGAL_LOCALPART                  NS_MSG_GENERATE_FAILURE(12601)</span>
<a href="#l4.19"></a><span id="l4.19"> </span>
<a href="#l4.20"></a><span id="l4.20"> #define NS_ERROR_CLIENTID                           NS_MSG_GENERATE_FAILURE(12610)</span>
<a href="#l4.21"></a><span id="l4.21"> #define NS_ERROR_CLIENTID_PERMISSION                NS_MSG_GENERATE_FAILURE(12611)</span>
<a href="#l4.22"></a><span id="l4.22"> </span>
<a href="#l4.23"></a><span id="l4.23"> const char* errorStringNameForErrorCode(nsresult aCode);</span>
<a href="#l4.24"></a><span id="l4.24"> </span>
<a href="#l4.25"></a><span id="l4.25"> #endif /* _nsComposeStrings_H__ */</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+// clang-format on</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgAppleCodes.h</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgAppleCodes.h</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -16,91 +16,94 @@</span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5"> #ifndef ad_codes_h</span>
<a href="#l5.6"></a><span id="l5.6"> #define ad_codes_h</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8"> /*</span>
<a href="#l5.9"></a><span id="l5.9"> ** applefile definitions used</span>
<a href="#l5.10"></a><span id="l5.10"> */</span>
<a href="#l5.11"></a><span id="l5.11"> #if PRAGMA_STRUCT_ALIGN</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  #pragma options align=mac68k</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+#  pragma options align = mac68k</span>
<a href="#l5.14"></a><span id="l5.14"> #endif</span>
<a href="#l5.15"></a><span id="l5.15"> </span>
<a href="#l5.16"></a><span id="l5.16"> #define APPLESINGLE_MAGIC 0x00051600L</span>
<a href="#l5.17"></a><span id="l5.17"> #define APPLEDOUBLE_MAGIC 0x00051607L</span>
<a href="#l5.18"></a><span id="l5.18"> #define APPLEDOUBLE_VERSION 0x00020000</span>
<a href="#l5.19"></a><span id="l5.19"> </span>
<a href="#l5.20"></a><span id="l5.20" class="difflineminus">-#define NUM_ENTRIES  6</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+#define NUM_ENTRIES 6</span>
<a href="#l5.22"></a><span id="l5.22"> </span>
<a href="#l5.23"></a><span id="l5.23" class="difflineminus">-#define ENT_DFORK    1L</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineminus">-#define ENT_RFORK    2L</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineminus">-#define ENT_NAME     3L</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineminus">-#define ENT_COMMENT  4L</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineminus">-#define ENT_DATES    8L</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineminus">-#define ENT_FINFO    9L</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+#define ENT_DFORK 1L</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+#define ENT_RFORK 2L</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+#define ENT_NAME 3L</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+#define ENT_COMMENT 4L</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+#define ENT_DATES 8L</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+#define ENT_FINFO 9L</span>
<a href="#l5.35"></a><span id="l5.35"> #define CONVERT_TIME 1265437696L</span>
<a href="#l5.36"></a><span id="l5.36"> </span>
<a href="#l5.37"></a><span id="l5.37"> /*</span>
<a href="#l5.38"></a><span id="l5.38"> ** data type used in the encoder/decoder.</span>
<a href="#l5.39"></a><span id="l5.39"> */</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineminus">-typedef struct ap_header</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineminus">-{</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineminus">-  int32_t   magic;</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-  int32_t   version;</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-  char      fill[16];</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineminus">-  int16_t   entries;</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+typedef struct ap_header {</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+  int32_t magic;</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+  int32_t version;</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+  char fill[16];</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+  int16_t entries;</span>
<a href="#l5.51"></a><span id="l5.51"> </span>
<a href="#l5.52"></a><span id="l5.52"> } ap_header;</span>
<a href="#l5.53"></a><span id="l5.53"> </span>
<a href="#l5.54"></a><span id="l5.54" class="difflineminus">-typedef struct ap_entry</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineminus">-{</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineminus">-  int32_t  id;</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineminus">-  int32_t  offset;</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineminus">-  int32_t  length;</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+typedef struct ap_entry {</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+  int32_t id;</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+  int32_t offset;</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+  int32_t length;</span>
<a href="#l5.63"></a><span id="l5.63"> </span>
<a href="#l5.64"></a><span id="l5.64"> } ap_entry;</span>
<a href="#l5.65"></a><span id="l5.65"> </span>
<a href="#l5.66"></a><span id="l5.66" class="difflineminus">-typedef struct ap_dates</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineminus">-{</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+typedef struct ap_dates {</span>
<a href="#l5.69"></a><span id="l5.69">   int32_t create, modify, backup, access;</span>
<a href="#l5.70"></a><span id="l5.70"> </span>
<a href="#l5.71"></a><span id="l5.71"> } ap_dates;</span>
<a href="#l5.72"></a><span id="l5.72"> </span>
<a href="#l5.73"></a><span id="l5.73" class="difflineminus">-typedef struct myFInfo      /* the mac FInfo structure for the cross platform. */</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineplus">+typedef struct myFInfo /* the mac FInfo structure for the cross platform. */</span>
<a href="#l5.75"></a><span id="l5.75"> {</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineminus">-  int32_t  fdType, fdCreator;</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineminus">-  int16_t  fdFlags;</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineminus">-  int32_t  fdLocation;      /* it really should  be a pointer, but just a place-holder  */</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineminus">-  int16_t  fdFldr;</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineplus">+  int32_t fdType, fdCreator;</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+  int16_t fdFlags;</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineplus">+  int32_t</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineplus">+      fdLocation; /* it really should  be a pointer, but just a place-holder  */</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineplus">+  int16_t fdFldr;</span>
<a href="#l5.85"></a><span id="l5.85"> </span>
<a href="#l5.86"></a><span id="l5.86" class="difflineminus">-}  myFInfo;</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+} myFInfo;</span>
<a href="#l5.88"></a><span id="l5.88"> </span>
<a href="#l5.89"></a><span id="l5.89"> PR_BEGIN_EXTERN_C</span>
<a href="#l5.90"></a><span id="l5.90"> /*</span>
<a href="#l5.91"></a><span id="l5.91"> **  string utils.</span>
<a href="#l5.92"></a><span id="l5.92"> */</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineminus">-int write_stream(appledouble_encode_object *p_ap_encode_obj, const char *s,int len);</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineplus">+int write_stream(appledouble_encode_object* p_ap_encode_obj, const char* s,</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineplus">+                 int len);</span>
<a href="#l5.96"></a><span id="l5.96"> </span>
<a href="#l5.97"></a><span id="l5.97" class="difflineminus">-int fill_apple_mime_header(appledouble_encode_object *p_ap_encode_obj);</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineminus">-int ap_encode_file_infor(appledouble_encode_object *p_ap_encode_obj);</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineminus">-int ap_encode_header(appledouble_encode_object* p_ap_encode_obj, bool firstTime);</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineplus">+int fill_apple_mime_header(appledouble_encode_object* p_ap_encode_obj);</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineplus">+int ap_encode_file_infor(appledouble_encode_object* p_ap_encode_obj);</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineplus">+int ap_encode_header(appledouble_encode_object* p_ap_encode_obj,</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineplus">+                     bool firstTime);</span>
<a href="#l5.104"></a><span id="l5.104"> int ap_encode_data(appledouble_encode_object* p_ap_encode_obj, bool firstTime);</span>
<a href="#l5.105"></a><span id="l5.105"> </span>
<a href="#l5.106"></a><span id="l5.106"> /*</span>
<a href="#l5.107"></a><span id="l5.107"> **  the prototypes for the ap_decoder.</span>
<a href="#l5.108"></a><span id="l5.108"> */</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineminus">-int  fetch_a_line(appledouble_decode_object* p_ap_decode_obj, char *buff);</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineminus">-int  ParseFileHeader(appledouble_decode_object* p_ap_decode_obj);</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineminus">-int  ap_seek_part_start(appledouble_decode_object* p_ap_decode_obj);</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineminus">-void parse_param(char *p, char **param, char**define, char **np);</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineminus">-int  ap_seek_to_boundary(appledouble_decode_object* p_ap_decode_obj, bool firstime);</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineminus">-int  ap_parse_header(appledouble_decode_object* p_ap_decode_obj,bool firstime);</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineminus">-int  ap_decode_file_infor(appledouble_decode_object* p_ap_decode_obj);</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineminus">-int  ap_decode_process_header(appledouble_decode_object* p_ap_decode_obj, bool firstime);</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineminus">-int  ap_decode_process_data(  appledouble_decode_object* p_ap_decode_obj, bool firstime);</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineplus">+int fetch_a_line(appledouble_decode_object* p_ap_decode_obj, char* buff);</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineplus">+int ParseFileHeader(appledouble_decode_object* p_ap_decode_obj);</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineplus">+int ap_seek_part_start(appledouble_decode_object* p_ap_decode_obj);</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineplus">+void parse_param(char* p, char** param, char** define, char** np);</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineplus">+int ap_seek_to_boundary(appledouble_decode_object* p_ap_decode_obj,</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineplus">+                        bool firstime);</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineplus">+int ap_parse_header(appledouble_decode_object* p_ap_decode_obj, bool firstime);</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineplus">+int ap_decode_file_infor(appledouble_decode_object* p_ap_decode_obj);</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineplus">+int ap_decode_process_header(appledouble_decode_object* p_ap_decode_obj,</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineplus">+                             bool firstime);</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineplus">+int ap_decode_process_data(appledouble_decode_object* p_ap_decode_obj,</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineplus">+                           bool firstime);</span>
<a href="#l5.130"></a><span id="l5.130"> </span>
<a href="#l5.131"></a><span id="l5.131"> PR_END_EXTERN_C</span>
<a href="#l5.132"></a><span id="l5.132"> </span>
<a href="#l5.133"></a><span id="l5.133"> #if PRAGMA_STRUCT_ALIGN</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineminus">-  #pragma options align=reset</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineplus">+#  pragma options align = reset</span>
<a href="#l5.136"></a><span id="l5.136"> #endif</span>
<a href="#l5.137"></a><span id="l5.137"> </span>
<a href="#l5.138"></a><span id="l5.138"> #endif /* ad_codes_h */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgAppleDouble.h</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgAppleDouble.h</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -19,182 +19,144 @@</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5"> #include &quot;msgCore.h&quot;</span>
<a href="#l6.6"></a><span id="l6.6"> #include &quot;nsComposeStrings.h&quot;</span>
<a href="#l6.7"></a><span id="l6.7"> #include &quot;nsIOutputStream.h&quot;</span>
<a href="#l6.8"></a><span id="l6.8"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l6.9"></a><span id="l6.9"> </span>
<a href="#l6.10"></a><span id="l6.10"> #include &lt;CoreServices/CoreServices.h&gt;</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-#define NOERR            0</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-#define errDone          1  /* Done with current operation. */</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-#define errEOB           2  /* End of a buffer.             */</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-#define errEOP           3  /* End of a Part.               */</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+#define NOERR 0</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+#define errDone 1 /* Done with current operation. */</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+#define errEOB 2  /* End of a buffer.             */</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+#define errEOP 3  /* End of a Part.               */</span>
<a href="#l6.20"></a><span id="l6.20"> </span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">-</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineminus">-#define errFileOpen    NS_ERROR_GET_CODE(NS_MSG_UNABLE_TO_OPEN_TMP_FILE)</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineminus">-#define errFileWrite   -202  /* Error writing temporary file. */</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">-#define errUsrCancel     -2  /* MK_INTERRUPTED */</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineminus">-#define errDecoding      -1</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineplus">+#define errFileOpen NS_ERROR_GET_CODE(NS_MSG_UNABLE_TO_OPEN_TMP_FILE)</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+#define errFileWrite -202 /* Error writing temporary file. */</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+#define errUsrCancel -2   /* MK_INTERRUPTED */</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineplus">+#define errDecoding -1</span>
<a href="#l6.30"></a><span id="l6.30"> </span>
<a href="#l6.31"></a><span id="l6.31"> /*</span>
<a href="#l6.32"></a><span id="l6.32">  ** The envirment block data type.</span>
<a href="#l6.33"></a><span id="l6.33">  */</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-enum</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">-{</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+enum {</span>
<a href="#l6.37"></a><span id="l6.37">   kInit,</span>
<a href="#l6.38"></a><span id="l6.38">   kDoingHeaderPortion,</span>
<a href="#l6.39"></a><span id="l6.39">   kDoneHeaderPortion,</span>
<a href="#l6.40"></a><span id="l6.40">   kDoingDataPortion,</span>
<a href="#l6.41"></a><span id="l6.41">   kDoneDataPortion</span>
<a href="#l6.42"></a><span id="l6.42"> };</span>
<a href="#l6.43"></a><span id="l6.43"> </span>
<a href="#l6.44"></a><span id="l6.44" class="difflineminus">-typedef struct _appledouble_encode_object</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineminus">-{</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineminus">-  char    fname[256];</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineminus">-  FSIORefNum fileId;         /* the id for the open file (data/resource fork) */</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+typedef struct _appledouble_encode_object {</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineplus">+  char fname[256];</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+  FSIORefNum fileId; /* the id for the open file (data/resource fork) */</span>
<a href="#l6.51"></a><span id="l6.51"> </span>
<a href="#l6.52"></a><span id="l6.52" class="difflineminus">-  int     state;</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineminus">-  int     text_file_type;    /* if the file has a text file type with it.     */</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineminus">-  char    *boundary;         /* the boundary string.                          */</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+  int state;</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineplus">+  int text_file_type; /* if the file has a text file type with it.     */</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+  char* boundary;     /* the boundary string.                          */</span>
<a href="#l6.58"></a><span id="l6.58"> </span>
<a href="#l6.59"></a><span id="l6.59" class="difflineminus">-  int     status;            /* the error code if anyerror happens.           */</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineminus">-  char    b_overflow[200];</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineminus">-  int     s_overflow;</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineplus">+  int status; /* the error code if anyerror happens.           */</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+  char b_overflow[200];</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+  int s_overflow;</span>
<a href="#l6.65"></a><span id="l6.65"> </span>
<a href="#l6.66"></a><span id="l6.66" class="difflineminus">-  int     state64;           /* the left over state of base64 enocding        */</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineminus">-  int     ct;                /* the character count of base64 encoding        */</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineminus">-  int     c1, c2;            /* the left of the last base64 encoding          */</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+  int state64; /* the left over state of base64 enocding        */</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+  int ct;      /* the character count of base64 encoding        */</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineplus">+  int c1, c2;  /* the left of the last base64 encoding          */</span>
<a href="#l6.72"></a><span id="l6.72"> </span>
<a href="#l6.73"></a><span id="l6.73" class="difflineminus">-  char    *outbuff;          /* the outbuff by the caller.                    */</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineminus">-  int     s_outbuff;         /* the size of the buffer.                       */</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineminus">-  int     pos_outbuff;       /* the offset in the current buffer.             */</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineplus">+  char* outbuff;   /* the outbuff by the caller.                    */</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineplus">+  int s_outbuff;   /* the size of the buffer.                       */</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineplus">+  int pos_outbuff; /* the offset in the current buffer.             */</span>
<a href="#l6.79"></a><span id="l6.79"> } appledouble_encode_object;</span>
<a href="#l6.80"></a><span id="l6.80"> </span>
<a href="#l6.81"></a><span id="l6.81"> /* The possible content transfer encodings */</span>
<a href="#l6.82"></a><span id="l6.82"> </span>
<a href="#l6.83"></a><span id="l6.83" class="difflineminus">-enum</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineminus">-{</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineminus">-  kEncodeNone,</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineminus">-  kEncodeQP,</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineminus">-  kEncodeBase64,</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineminus">-  kEncodeUU</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineminus">-};</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineplus">+enum { kEncodeNone, kEncodeQP, kEncodeBase64, kEncodeUU };</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineplus">+</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineplus">+enum { kGeneralMine, kAppleDouble, kAppleSingle };</span>
<a href="#l6.93"></a><span id="l6.93"> </span>
<a href="#l6.94"></a><span id="l6.94" class="difflineminus">-enum</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineminus">-{</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineminus">-  kGeneralMine,</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineminus">-  kAppleDouble,</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineminus">-  kAppleSingle</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineminus">-};</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineplus">+enum { kInline, kDontCare };</span>
<a href="#l6.101"></a><span id="l6.101"> </span>
<a href="#l6.102"></a><span id="l6.102" class="difflineminus">-enum</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineminus">-{</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineminus">-  kInline,</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineminus">-  kDontCare</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineminus">-};</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineminus">-</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineminus">-enum</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineminus">-{</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineminus">-  kHeaderPortion,</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineminus">-  kDataPortion</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineminus">-};</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineplus">+enum { kHeaderPortion, kDataPortion };</span>
<a href="#l6.114"></a><span id="l6.114"> </span>
<a href="#l6.115"></a><span id="l6.115"> /* the decode states. */</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineminus">-enum</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineminus">-{</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineplus">+enum {</span>
<a href="#l6.119"></a><span id="l6.119">   kBeginParseHeader = 3,</span>
<a href="#l6.120"></a><span id="l6.120">   kParsingHeader,</span>
<a href="#l6.121"></a><span id="l6.121">   kBeginSeekBoundary,</span>
<a href="#l6.122"></a><span id="l6.122">   kSeekingBoundary,</span>
<a href="#l6.123"></a><span id="l6.123">   kBeginHeaderPortion,</span>
<a href="#l6.124"></a><span id="l6.124">   kProcessingHeaderPortion,</span>
<a href="#l6.125"></a><span id="l6.125">   kBeginDataPortion,</span>
<a href="#l6.126"></a><span id="l6.126">   kProcessingDataPortion,</span>
<a href="#l6.127"></a><span id="l6.127">   kFinishing</span>
<a href="#l6.128"></a><span id="l6.128"> };</span>
<a href="#l6.129"></a><span id="l6.129"> </span>
<a href="#l6.130"></a><span id="l6.130"> /* uuencode states */</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineminus">-enum</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineminus">-{</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineminus">-  kWaitingForBegin = (int) 0,</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineminus">-  kBegin,</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineminus">-  kMainBody,</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineminus">-  kEnd</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineminus">-};</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineplus">+enum { kWaitingForBegin = (int)0, kBegin, kMainBody, kEnd };</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineplus">+</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineplus">+typedef struct _appledouble_decode_object {</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineplus">+  int is_binary;</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineplus">+  int is_apple_single; /* if the object encoded is in apple single  */</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineplus">+  int write_as_binhex;</span>
<a href="#l6.144"></a><span id="l6.144"> </span>
<a href="#l6.145"></a><span id="l6.145" class="difflineminus">-typedef struct _appledouble_decode_object</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineminus">-{</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineminus">-  int     is_binary;</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineminus">-  int     is_apple_single;    /* if the object encoded is in apple single  */</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineminus">-  int     write_as_binhex;</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineplus">+  int messagetype;</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineplus">+  char* boundary0; /* the boundary for the enclosure.           */</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineplus">+  int deposition;  /* the deposition.                           */</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineplus">+  int encoding;    /* the encoding method.                      */</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineplus">+  int which_part;</span>
<a href="#l6.155"></a><span id="l6.155"> </span>
<a href="#l6.156"></a><span id="l6.156" class="difflineminus">-  int     messagetype;</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineminus">-  char*   boundary0;          /* the boundary for the enclosure.           */</span>
<a href="#l6.158"></a><span id="l6.158" class="difflineminus">-  int     deposition;         /* the deposition.                           */</span>
<a href="#l6.159"></a><span id="l6.159" class="difflineminus">-  int     encoding;           /* the encoding method.                      */</span>
<a href="#l6.160"></a><span id="l6.160" class="difflineminus">-  int     which_part;</span>
<a href="#l6.161"></a><span id="l6.161" class="difflineplus">+  char fname[256];</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineplus">+  // nsIOFileStream *fileSpec;   /* the stream for data fork work.            */</span>
<a href="#l6.163"></a><span id="l6.163"> </span>
<a href="#l6.164"></a><span id="l6.164" class="difflineminus">-  char    fname[256];</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineminus">-// nsIOFileStream *fileSpec;   /* the stream for data fork work.            */</span>
<a href="#l6.166"></a><span id="l6.166" class="difflineplus">+  int state;</span>
<a href="#l6.167"></a><span id="l6.167"> </span>
<a href="#l6.168"></a><span id="l6.168" class="difflineminus">-  int     state;</span>
<a href="#l6.169"></a><span id="l6.169" class="difflineplus">+  int rksize; /* the resource fork size count.             */</span>
<a href="#l6.170"></a><span id="l6.170" class="difflineplus">+  int dksize; /* the data fork size count.                 */</span>
<a href="#l6.171"></a><span id="l6.171"> </span>
<a href="#l6.172"></a><span id="l6.172" class="difflineminus">-  int     rksize;             /* the resource fork size count.             */</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineminus">-  int     dksize;             /* the data fork size count.                 */</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineminus">-</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineminus">-  int      status;            /* the error code if anyerror happens.       */</span>
<a href="#l6.176"></a><span id="l6.176" class="difflineminus">-  char     b_leftover[256];</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineminus">-  int      s_leftover;</span>
<a href="#l6.178"></a><span id="l6.178" class="difflineplus">+  int status; /* the error code if anyerror happens.       */</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineplus">+  char b_leftover[256];</span>
<a href="#l6.180"></a><span id="l6.180" class="difflineplus">+  int s_leftover;</span>
<a href="#l6.181"></a><span id="l6.181"> </span>
<a href="#l6.182"></a><span id="l6.182" class="difflineminus">-  int      encode;            /* the encode type of the message.           */</span>
<a href="#l6.183"></a><span id="l6.183" class="difflineminus">-  int      state64;           /* the left over state of base64 enocding    */</span>
<a href="#l6.184"></a><span id="l6.184" class="difflineminus">-  int      left;              /* the character count of base64 encoding    */</span>
<a href="#l6.185"></a><span id="l6.185" class="difflineminus">-  int      c[4];              /* the left of the last base64 encoding      */</span>
<a href="#l6.186"></a><span id="l6.186" class="difflineminus">-  int      uu_starts_line;    /* is decoder at the start of a line? (uuencode) */</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineminus">-  int      uu_state;          /* state w/r/t the uuencode body */</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineminus">-  int      uu_bytes_written;  /* bytes written from the current tuple (uuencode) */</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineminus">-  int      uu_line_bytes;     /* encoded bytes remaining in the current line (uuencode) */</span>
<a href="#l6.190"></a><span id="l6.190" class="difflineplus">+  int encode;           /* the encode type of the message.           */</span>
<a href="#l6.191"></a><span id="l6.191" class="difflineplus">+  int state64;          /* the left over state of base64 enocding    */</span>
<a href="#l6.192"></a><span id="l6.192" class="difflineplus">+  int left;             /* the character count of base64 encoding    */</span>
<a href="#l6.193"></a><span id="l6.193" class="difflineplus">+  int c[4];             /* the left of the last base64 encoding      */</span>
<a href="#l6.194"></a><span id="l6.194" class="difflineplus">+  int uu_starts_line;   /* is decoder at the start of a line? (uuencode) */</span>
<a href="#l6.195"></a><span id="l6.195" class="difflineplus">+  int uu_state;         /* state w/r/t the uuencode body */</span>
<a href="#l6.196"></a><span id="l6.196" class="difflineplus">+  int uu_bytes_written; /* bytes written from the current tuple (uuencode) */</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineplus">+  int uu_line_bytes; /* encoded bytes remaining in the current line (uuencode)</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineplus">+                      */</span>
<a href="#l6.199"></a><span id="l6.199"> </span>
<a href="#l6.200"></a><span id="l6.200" class="difflineminus">-  char     *inbuff;           /* the outbuff by the caller.                */</span>
<a href="#l6.201"></a><span id="l6.201" class="difflineminus">-  int      s_inbuff;          /* the size of the buffer.                   */</span>
<a href="#l6.202"></a><span id="l6.202" class="difflineminus">-  int      pos_inbuff;        /* the offset in the current buffer.         */</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineplus">+  char* inbuff;   /* the outbuff by the caller.                */</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineplus">+  int s_inbuff;   /* the size of the buffer.                   */</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineplus">+  int pos_inbuff; /* the offset in the current buffer.         */</span>
<a href="#l6.206"></a><span id="l6.206"> </span>
<a href="#l6.207"></a><span id="l6.207" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; tmpFile; /* the temp file to hold the decode data fork */</span>
<a href="#l6.208"></a><span id="l6.208" class="difflineminus">-                              /* when doing the binhex exporting.          */</span>
<a href="#l6.209"></a><span id="l6.209" class="difflineminus">-  nsCOMPtr &lt;nsIOutputStream&gt; tmpFileStream; /* The output File Stream      */</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineminus">-  int32_t  data_size;         /* the size of the data in the tmp file.     */</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; tmpFile; /* the temp file to hold the decode data fork */</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineplus">+                             /* when doing the binhex exporting.          */</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineplus">+  nsCOMPtr&lt;nsIOutputStream&gt; tmpFileStream; /* The output File Stream      */</span>
<a href="#l6.214"></a><span id="l6.214" class="difflineplus">+  int32_t data_size; /* the size of the data in the tmp file.     */</span>
<a href="#l6.215"></a><span id="l6.215"> } appledouble_decode_object;</span>
<a href="#l6.216"></a><span id="l6.216"> </span>
<a href="#l6.217"></a><span id="l6.217" class="difflineminus">-</span>
<a href="#l6.218"></a><span id="l6.218"> /*</span>
<a href="#l6.219"></a><span id="l6.219">  ** The protypes.</span>
<a href="#l6.220"></a><span id="l6.220">  */</span>
<a href="#l6.221"></a><span id="l6.221"> </span>
<a href="#l6.222"></a><span id="l6.222"> PR_BEGIN_EXTERN_C</span>
<a href="#l6.223"></a><span id="l6.223"> </span>
<a href="#l6.224"></a><span id="l6.224" class="difflineminus">-int ap_encode_init(appledouble_encode_object *p_ap_encode_obj,</span>
<a href="#l6.225"></a><span id="l6.225" class="difflineminus">-                   const char* fname,</span>
<a href="#l6.226"></a><span id="l6.226" class="difflineminus">-                   char* separator);</span>
<a href="#l6.227"></a><span id="l6.227" class="difflineplus">+int ap_encode_init(appledouble_encode_object* p_ap_encode_obj,</span>
<a href="#l6.228"></a><span id="l6.228" class="difflineplus">+                   const char* fname, char* separator);</span>
<a href="#l6.229"></a><span id="l6.229"> </span>
<a href="#l6.230"></a><span id="l6.230" class="difflineminus">-int ap_encode_next(appledouble_encode_object* p_ap_encode_obj,</span>
<a href="#l6.231"></a><span id="l6.231" class="difflineminus">-                   char     *to_buff,</span>
<a href="#l6.232"></a><span id="l6.232" class="difflineminus">-                   int32_t  buff_size,</span>
<a href="#l6.233"></a><span id="l6.233" class="difflineminus">-                   int32_t* real_size);</span>
<a href="#l6.234"></a><span id="l6.234" class="difflineplus">+int ap_encode_next(appledouble_encode_object* p_ap_encode_obj, char* to_buff,</span>
<a href="#l6.235"></a><span id="l6.235" class="difflineplus">+                   int32_t buff_size, int32_t* real_size);</span>
<a href="#l6.236"></a><span id="l6.236"> </span>
<a href="#l6.237"></a><span id="l6.237" class="difflineminus">-int ap_encode_end(appledouble_encode_object* p_ap_encode_obj,</span>
<a href="#l6.238"></a><span id="l6.238" class="difflineminus">-                   bool is_aborting);</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineplus">+int ap_encode_end(appledouble_encode_object* p_ap_encode_obj, bool is_aborting);</span>
<a href="#l6.240"></a><span id="l6.240"> </span>
<a href="#l6.241"></a><span id="l6.241"> int ap_decode_init(appledouble_decode_object* p_ap_decode_obj,</span>
<a href="#l6.242"></a><span id="l6.242" class="difflineminus">-                   bool is_apple_single,</span>
<a href="#l6.243"></a><span id="l6.243" class="difflineminus">-                   bool write_as_bin_hex,</span>
<a href="#l6.244"></a><span id="l6.244" class="difflineminus">-                   void *closure);</span>
<a href="#l6.245"></a><span id="l6.245" class="difflineplus">+                   bool is_apple_single, bool write_as_bin_hex, void* closure);</span>
<a href="#l6.246"></a><span id="l6.246"> </span>
<a href="#l6.247"></a><span id="l6.247" class="difflineminus">-int ap_decode_next(appledouble_decode_object* p_ap_decode_obj,</span>
<a href="#l6.248"></a><span id="l6.248" class="difflineminus">-                   char    *in_buff,</span>
<a href="#l6.249"></a><span id="l6.249" class="difflineplus">+int ap_decode_next(appledouble_decode_object* p_ap_decode_obj, char* in_buff,</span>
<a href="#l6.250"></a><span id="l6.250">                    int32_t buff_size);</span>
<a href="#l6.251"></a><span id="l6.251"> </span>
<a href="#l6.252"></a><span id="l6.252" class="difflineminus">-int ap_decode_end(appledouble_decode_object* p_ap_decode_obj,</span>
<a href="#l6.253"></a><span id="l6.253" class="difflineminus">-                  bool is_aborting);</span>
<a href="#l6.254"></a><span id="l6.254" class="difflineplus">+int ap_decode_end(appledouble_decode_object* p_ap_decode_obj, bool is_aborting);</span>
<a href="#l6.255"></a><span id="l6.255"> </span>
<a href="#l6.256"></a><span id="l6.256"> PR_END_EXTERN_C</span>
<a href="#l6.257"></a><span id="l6.257"> </span>
<a href="#l6.258"></a><span id="l6.258"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgAppleDoubleEncode.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgAppleDoubleEncode.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -21,59 +21,51 @@</span>
<a href="#l7.4"></a><span id="l7.4"> #include &quot;nsMsgAppleCodes.h&quot;</span>
<a href="#l7.5"></a><span id="l7.5"> #include &quot;nsMsgCompUtils.h&quot;</span>
<a href="#l7.6"></a><span id="l7.6"> #include &quot;nsCExternalHandlerService.h&quot;</span>
<a href="#l7.7"></a><span id="l7.7"> #include &quot;nsIMIMEService.h&quot;</span>
<a href="#l7.8"></a><span id="l7.8"> #include &quot;nsMimeTypes.h&quot;</span>
<a href="#l7.9"></a><span id="l7.9"> #include &quot;prmem.h&quot;</span>
<a href="#l7.10"></a><span id="l7.10"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-void</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-MacGetFileType(nsIFile *fs,</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-               bool    *useDefault,</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-               char    **fileType,</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-               char    **encoding)</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">-{</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineminus">-  if ((fs == NULL) || (fileType == NULL) || (encoding == NULL))</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">-    return;</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+void MacGetFileType(nsIFile *fs, bool *useDefault, char **fileType,</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+                    char **encoding) {</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+  if ((fs == NULL) || (fileType == NULL) || (encoding == NULL)) return;</span>
<a href="#l7.24"></a><span id="l7.24"> </span>
<a href="#l7.25"></a><span id="l7.25">   bool exists = false;</span>
<a href="#l7.26"></a><span id="l7.26">   fs-&gt;Exists(&amp;exists);</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">-  if (!exists)</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">-    return;</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+  if (!exists) return;</span>
<a href="#l7.30"></a><span id="l7.30"> </span>
<a href="#l7.31"></a><span id="l7.31">   *useDefault = TRUE;</span>
<a href="#l7.32"></a><span id="l7.32">   *fileType = NULL;</span>
<a href="#l7.33"></a><span id="l7.33">   *encoding = NULL;</span>
<a href="#l7.34"></a><span id="l7.34"> </span>
<a href="#l7.35"></a><span id="l7.35">   nsCOMPtr&lt;nsILocalFileMac&gt; macFile = do_QueryInterface(fs);</span>
<a href="#l7.36"></a><span id="l7.36">   FSRef fsRef;</span>
<a href="#l7.37"></a><span id="l7.37">   FSCatalogInfo catalogInfo;</span>
<a href="#l7.38"></a><span id="l7.38">   OSErr err = errFileOpen;</span>
<a href="#l7.39"></a><span id="l7.39">   if (NS_SUCCEEDED(macFile-&gt;GetFSRef(&amp;fsRef)))</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineminus">-    err = ::FSGetCatalogInfo(&amp;fsRef, kFSCatInfoFinderInfo, &amp;catalogInfo, nullptr, nullptr, nullptr);</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+    err = ::FSGetCatalogInfo(&amp;fsRef, kFSCatInfoFinderInfo, &amp;catalogInfo,</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+                             nullptr, nullptr, nullptr);</span>
<a href="#l7.43"></a><span id="l7.43"> </span>
<a href="#l7.44"></a><span id="l7.44" class="difflineminus">-  if ( (err != noErr) || (((FileInfo*)(&amp;catalogInfo.finderInfo))-&gt;fileType == 'TEXT') )</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+  if ((err != noErr) ||</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+      (((FileInfo *)(&amp;catalogInfo.finderInfo))-&gt;fileType == 'TEXT'))</span>
<a href="#l7.47"></a><span id="l7.47">     *fileType = strdup(APPLICATION_OCTET_STREAM);</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineminus">-  else</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-  {</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+  else {</span>
<a href="#l7.51"></a><span id="l7.51">     // At this point, we should call the mime service and</span>
<a href="#l7.52"></a><span id="l7.52">     // see what we can find out?</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-    nsresult      rv;</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">-    nsCOMPtr &lt;nsIURI&gt; tURI;</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineminus">-    if (NS_SUCCEEDED(NS_NewFileURI(getter_AddRefs(tURI), fs)) &amp;&amp; tURI)</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineminus">-    {</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineminus">-      nsCOMPtr&lt;nsIMIMEService&gt; mimeFinder(do_GetService(NS_MIMESERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; mimeFinder)</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineminus">-      {</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+    nsresult rv;</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+    nsCOMPtr&lt;nsIURI&gt; tURI;</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+    if (NS_SUCCEEDED(NS_NewFileURI(getter_AddRefs(tURI), fs)) &amp;&amp; tURI) {</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+      nsCOMPtr&lt;nsIMIMEService&gt; mimeFinder(</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+          do_GetService(NS_MIMESERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; mimeFinder) {</span>
<a href="#l7.66"></a><span id="l7.66">         nsAutoCString mimeType;</span>
<a href="#l7.67"></a><span id="l7.67">         rv = mimeFinder-&gt;GetTypeFromURI(tURI, mimeType);</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineminus">-        {</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+        if (NS_SUCCEEDED(rv)) {</span>
<a href="#l7.71"></a><span id="l7.71">           *fileType = ToNewCString(mimeType);</span>
<a href="#l7.72"></a><span id="l7.72">           return;</span>
<a href="#l7.73"></a><span id="l7.73">         }</span>
<a href="#l7.74"></a><span id="l7.74">       }</span>
<a href="#l7.75"></a><span id="l7.75">     }</span>
<a href="#l7.76"></a><span id="l7.76"> </span>
<a href="#l7.77"></a><span id="l7.77">     // If we hit here, return something...default to this...</span>
<a href="#l7.78"></a><span id="l7.78">     *fileType = strdup(APPLICATION_OCTET_STREAM);</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineat">@@ -85,24 +77,22 @@ MacGetFileType(nsIFile *fs,</span>
<a href="#l7.80"></a><span id="l7.80"> /*</span>
<a href="#l7.81"></a><span id="l7.81">  *  ap_encode_init</span>
<a href="#l7.82"></a><span id="l7.82">  *  --------------</span>
<a href="#l7.83"></a><span id="l7.83">  *</span>
<a href="#l7.84"></a><span id="l7.84">  *  Setup the encode envirment</span>
<a href="#l7.85"></a><span id="l7.85">  */</span>
<a href="#l7.86"></a><span id="l7.86"> </span>
<a href="#l7.87"></a><span id="l7.87"> int ap_encode_init(appledouble_encode_object *p_ap_encode_obj,</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineminus">-                   const char                *fname,</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineminus">-                   char                      *separator)</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineminus">-{</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; myFile;</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineminus">-  NS_NewNativeLocalFile(nsDependentCString(fname), true, getter_AddRefs(myFile));</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+                   const char *fname, char *separator) {</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; myFile;</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+  NS_NewNativeLocalFile(nsDependentCString(fname), true,</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+                        getter_AddRefs(myFile));</span>
<a href="#l7.97"></a><span id="l7.97">   bool exists;</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineminus">-  if (myFile &amp;&amp; NS_SUCCEEDED(myFile-&gt;Exists(&amp;exists)) &amp;&amp; !exists)</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineminus">-    return -1;</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineplus">+  if (myFile &amp;&amp; NS_SUCCEEDED(myFile-&gt;Exists(&amp;exists)) &amp;&amp; !exists) return -1;</span>
<a href="#l7.101"></a><span id="l7.101"> </span>
<a href="#l7.102"></a><span id="l7.102">   nsCOMPtr&lt;nsILocalFileMac&gt; macFile = do_QueryInterface(myFile);</span>
<a href="#l7.103"></a><span id="l7.103">   nsAutoCString path;</span>
<a href="#l7.104"></a><span id="l7.104">   macFile-&gt;GetNativePath(path);</span>
<a href="#l7.105"></a><span id="l7.105"> </span>
<a href="#l7.106"></a><span id="l7.106">   memset(p_ap_encode_obj, 0, sizeof(appledouble_encode_object));</span>
<a href="#l7.107"></a><span id="l7.107"> </span>
<a href="#l7.108"></a><span id="l7.108">   /*</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineat">@@ -119,148 +109,128 @@ int ap_encode_init(appledouble_encode_ob</span>
<a href="#l7.110"></a><span id="l7.110"> **  ap_encode_next</span>
<a href="#l7.111"></a><span id="l7.111"> **  --------------</span>
<a href="#l7.112"></a><span id="l7.112"> **</span>
<a href="#l7.113"></a><span id="l7.113"> **  return :</span>
<a href="#l7.114"></a><span id="l7.114"> **  noErr  :  everything is ok</span>
<a href="#l7.115"></a><span id="l7.115"> **  errDone:  when encoding is done.</span>
<a href="#l7.116"></a><span id="l7.116"> **  errors :  otherwise.</span>
<a href="#l7.117"></a><span id="l7.117"> */</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineminus">-int ap_encode_next(</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineminus">-  appledouble_encode_object* p_ap_encode_obj,</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineminus">-  char     *to_buff,</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineminus">-  int32_t  buff_size,</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineminus">-  int32_t* real_size)</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineminus">-{</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineplus">+int ap_encode_next(appledouble_encode_object *p_ap_encode_obj, char *to_buff,</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineplus">+                   int32_t buff_size, int32_t *real_size) {</span>
<a href="#l7.126"></a><span id="l7.126">   int status;</span>
<a href="#l7.127"></a><span id="l7.127"> </span>
<a href="#l7.128"></a><span id="l7.128">   /*</span>
<a href="#l7.129"></a><span id="l7.129">   **   install the out buff now.</span>
<a href="#l7.130"></a><span id="l7.130">   */</span>
<a href="#l7.131"></a><span id="l7.131">   p_ap_encode_obj-&gt;outbuff = to_buff;</span>
<a href="#l7.132"></a><span id="l7.132">   p_ap_encode_obj-&gt;s_outbuff = buff_size;</span>
<a href="#l7.133"></a><span id="l7.133">   p_ap_encode_obj-&gt;pos_outbuff = 0;</span>
<a href="#l7.134"></a><span id="l7.134"> </span>
<a href="#l7.135"></a><span id="l7.135">   /*</span>
<a href="#l7.136"></a><span id="l7.136">   **  first copy the outstandind data in the overflow buff to the out buffer.</span>
<a href="#l7.137"></a><span id="l7.137">   */</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineminus">-  if (p_ap_encode_obj-&gt;s_overflow)</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineminus">-  {</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineplus">+  if (p_ap_encode_obj-&gt;s_overflow) {</span>
<a href="#l7.141"></a><span id="l7.141">     status = write_stream(p_ap_encode_obj,</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineminus">-                          (const char*)(p_ap_encode_obj-&gt;b_overflow),</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineplus">+                          (const char *)(p_ap_encode_obj-&gt;b_overflow),</span>
<a href="#l7.144"></a><span id="l7.144">                           p_ap_encode_obj-&gt;s_overflow);</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineminus">-    if (status != noErr)</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineminus">-      return status;</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineplus">+    if (status != noErr) return status;</span>
<a href="#l7.148"></a><span id="l7.148"> </span>
<a href="#l7.149"></a><span id="l7.149">     p_ap_encode_obj-&gt;s_overflow = 0;</span>
<a href="#l7.150"></a><span id="l7.150">   }</span>
<a href="#l7.151"></a><span id="l7.151"> </span>
<a href="#l7.152"></a><span id="l7.152">   /*</span>
<a href="#l7.153"></a><span id="l7.153">   ** go the next processing stage based on the current state.</span>
<a href="#l7.154"></a><span id="l7.154">   */</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineminus">-  switch (p_ap_encode_obj-&gt;state)</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineminus">-  {</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineplus">+  switch (p_ap_encode_obj-&gt;state) {</span>
<a href="#l7.158"></a><span id="l7.158">     case kInit:</span>
<a href="#l7.159"></a><span id="l7.159">       /*</span>
<a href="#l7.160"></a><span id="l7.160">       ** We are in the  starting position, fill out the header.</span>
<a href="#l7.161"></a><span id="l7.161">       */</span>
<a href="#l7.162"></a><span id="l7.162">       status = fill_apple_mime_header(p_ap_encode_obj);</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineminus">-      if (status != noErr)</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineminus">-        break;          /* some error happens */</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineplus">+      if (status != noErr) break; /* some error happens */</span>
<a href="#l7.166"></a><span id="l7.166"> </span>
<a href="#l7.167"></a><span id="l7.167">       p_ap_encode_obj-&gt;state = kDoingHeaderPortion;</span>
<a href="#l7.168"></a><span id="l7.168">       status = ap_encode_header(p_ap_encode_obj, true);</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineminus">-                    /* it is the first time to calling     */</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineminus">-      if (status == errDone)</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineminus">-      {</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineplus">+      /* it is the first time to calling     */</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineplus">+      if (status == errDone) {</span>
<a href="#l7.174"></a><span id="l7.174">         p_ap_encode_obj-&gt;state = kDoneHeaderPortion;</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineminus">-      }</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineminus">-      else</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineminus">-      {</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineminus">-        break;          /* we need more work on header portion.  */</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineplus">+      } else {</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineplus">+        break; /* we need more work on header portion.  */</span>
<a href="#l7.181"></a><span id="l7.181">       }</span>
<a href="#l7.182"></a><span id="l7.182"> </span>
<a href="#l7.183"></a><span id="l7.183">       /*</span>
<a href="#l7.184"></a><span id="l7.184">       ** we are done with the header, so let's go to the data port.</span>
<a href="#l7.185"></a><span id="l7.185">       */</span>
<a href="#l7.186"></a><span id="l7.186">       p_ap_encode_obj-&gt;state = kDoingDataPortion;</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineminus">-      status = ap_encode_data(p_ap_encode_obj, true);     </span>
<a href="#l7.188"></a><span id="l7.188" class="difflineminus">-                    /* it is first time call do data portion */</span>
<a href="#l7.189"></a><span id="l7.189" class="difflineplus">+      status = ap_encode_data(p_ap_encode_obj, true);</span>
<a href="#l7.190"></a><span id="l7.190" class="difflineplus">+      /* it is first time call do data portion */</span>
<a href="#l7.191"></a><span id="l7.191"> </span>
<a href="#l7.192"></a><span id="l7.192" class="difflineminus">-      if (status == errDone)</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineminus">-      {</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineminus">-        p_ap_encode_obj-&gt;state  = kDoneDataPortion;</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineplus">+      if (status == errDone) {</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineplus">+        p_ap_encode_obj-&gt;state = kDoneDataPortion;</span>
<a href="#l7.197"></a><span id="l7.197">         status = noErr;</span>
<a href="#l7.198"></a><span id="l7.198">       }</span>
<a href="#l7.199"></a><span id="l7.199">       break;</span>
<a href="#l7.200"></a><span id="l7.200"> </span>
<a href="#l7.201"></a><span id="l7.201">     case kDoingHeaderPortion:</span>
<a href="#l7.202"></a><span id="l7.202"> </span>
<a href="#l7.203"></a><span id="l7.203" class="difflineminus">-      status = ap_encode_header(p_ap_encode_obj, false); </span>
<a href="#l7.204"></a><span id="l7.204" class="difflineminus">-                    /* continue with the header portion.  */</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineminus">-      if (status == errDone)</span>
<a href="#l7.206"></a><span id="l7.206" class="difflineminus">-      {</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineplus">+      status = ap_encode_header(p_ap_encode_obj, false);</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineplus">+      /* continue with the header portion.  */</span>
<a href="#l7.209"></a><span id="l7.209" class="difflineplus">+      if (status == errDone) {</span>
<a href="#l7.210"></a><span id="l7.210">         p_ap_encode_obj-&gt;state = kDoneHeaderPortion;</span>
<a href="#l7.211"></a><span id="l7.211" class="difflineminus">-      }</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineminus">-      else</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineminus">-      {</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineminus">-        break;          /* we need more work on header portion.  */</span>
<a href="#l7.215"></a><span id="l7.215" class="difflineplus">+      } else {</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineplus">+        break; /* we need more work on header portion.  */</span>
<a href="#l7.217"></a><span id="l7.217">       }</span>
<a href="#l7.218"></a><span id="l7.218"> </span>
<a href="#l7.219"></a><span id="l7.219">       /*</span>
<a href="#l7.220"></a><span id="l7.220">       ** start the data portion.</span>
<a href="#l7.221"></a><span id="l7.221">       */</span>
<a href="#l7.222"></a><span id="l7.222">       p_ap_encode_obj-&gt;state = kDoingDataPortion;</span>
<a href="#l7.223"></a><span id="l7.223" class="difflineminus">-      status = ap_encode_data(p_ap_encode_obj, true); </span>
<a href="#l7.224"></a><span id="l7.224" class="difflineminus">-                    /* it is the first time calling     */</span>
<a href="#l7.225"></a><span id="l7.225" class="difflineminus">-      if (status == errDone)</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineminus">-      {</span>
<a href="#l7.227"></a><span id="l7.227" class="difflineminus">-        p_ap_encode_obj-&gt;state  = kDoneDataPortion;</span>
<a href="#l7.228"></a><span id="l7.228" class="difflineplus">+      status = ap_encode_data(p_ap_encode_obj, true);</span>
<a href="#l7.229"></a><span id="l7.229" class="difflineplus">+      /* it is the first time calling     */</span>
<a href="#l7.230"></a><span id="l7.230" class="difflineplus">+      if (status == errDone) {</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineplus">+        p_ap_encode_obj-&gt;state = kDoneDataPortion;</span>
<a href="#l7.232"></a><span id="l7.232">         status = noErr;</span>
<a href="#l7.233"></a><span id="l7.233">       }</span>
<a href="#l7.234"></a><span id="l7.234">       break;</span>
<a href="#l7.235"></a><span id="l7.235"> </span>
<a href="#l7.236"></a><span id="l7.236">     case kDoingDataPortion:</span>
<a href="#l7.237"></a><span id="l7.237"> </span>
<a href="#l7.238"></a><span id="l7.238" class="difflineminus">-      status = ap_encode_data(p_ap_encode_obj, false); </span>
<a href="#l7.239"></a><span id="l7.239" class="difflineminus">-                    /* it is not the first time        */</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineplus">+      status = ap_encode_data(p_ap_encode_obj, false);</span>
<a href="#l7.241"></a><span id="l7.241" class="difflineplus">+      /* it is not the first time        */</span>
<a href="#l7.242"></a><span id="l7.242"> </span>
<a href="#l7.243"></a><span id="l7.243" class="difflineminus">-      if (status == errDone)</span>
<a href="#l7.244"></a><span id="l7.244" class="difflineminus">-      {</span>
<a href="#l7.245"></a><span id="l7.245" class="difflineplus">+      if (status == errDone) {</span>
<a href="#l7.246"></a><span id="l7.246">         p_ap_encode_obj-&gt;state = kDoneDataPortion;</span>
<a href="#l7.247"></a><span id="l7.247">         status = noErr;</span>
<a href="#l7.248"></a><span id="l7.248">       }</span>
<a href="#l7.249"></a><span id="l7.249">       break;</span>
<a href="#l7.250"></a><span id="l7.250"> </span>
<a href="#l7.251"></a><span id="l7.251">     case kDoneDataPortion:</span>
<a href="#l7.252"></a><span id="l7.252" class="difflineminus">-      status = errDone;    /* we are really done.          */</span>
<a href="#l7.253"></a><span id="l7.253" class="difflineplus">+      status = errDone; /* we are really done.          */</span>
<a href="#l7.254"></a><span id="l7.254"> </span>
<a href="#l7.255"></a><span id="l7.255">       break;</span>
<a href="#l7.256"></a><span id="l7.256">   }</span>
<a href="#l7.257"></a><span id="l7.257"> </span>
<a href="#l7.258"></a><span id="l7.258">   *real_size = p_ap_encode_obj-&gt;pos_outbuff;</span>
<a href="#l7.259"></a><span id="l7.259">   return status;</span>
<a href="#l7.260"></a><span id="l7.260"> }</span>
<a href="#l7.261"></a><span id="l7.261"> </span>
<a href="#l7.262"></a><span id="l7.262"> /*</span>
<a href="#l7.263"></a><span id="l7.263"> **  ap_encode_end</span>
<a href="#l7.264"></a><span id="l7.264"> **  -------------</span>
<a href="#l7.265"></a><span id="l7.265"> **</span>
<a href="#l7.266"></a><span id="l7.266"> **  clear the apple encoding.</span>
<a href="#l7.267"></a><span id="l7.267"> */</span>
<a href="#l7.268"></a><span id="l7.268"> </span>
<a href="#l7.269"></a><span id="l7.269" class="difflineminus">-int ap_encode_end(</span>
<a href="#l7.270"></a><span id="l7.270" class="difflineminus">-  appledouble_encode_object *p_ap_encode_obj,</span>
<a href="#l7.271"></a><span id="l7.271" class="difflineminus">-  bool is_aborting)</span>
<a href="#l7.272"></a><span id="l7.272" class="difflineminus">-{</span>
<a href="#l7.273"></a><span id="l7.273" class="difflineplus">+int ap_encode_end(appledouble_encode_object *p_ap_encode_obj,</span>
<a href="#l7.274"></a><span id="l7.274" class="difflineplus">+                  bool is_aborting) {</span>
<a href="#l7.275"></a><span id="l7.275">   /*</span>
<a href="#l7.276"></a><span id="l7.276">   ** clear up the apple doubler.</span>
<a href="#l7.277"></a><span id="l7.277">   */</span>
<a href="#l7.278"></a><span id="l7.278" class="difflineminus">-  if (p_ap_encode_obj == NULL)</span>
<a href="#l7.279"></a><span id="l7.279" class="difflineminus">-    return noErr;</span>
<a href="#l7.280"></a><span id="l7.280" class="difflineplus">+  if (p_ap_encode_obj == NULL) return noErr;</span>
<a href="#l7.281"></a><span id="l7.281"> </span>
<a href="#l7.282"></a><span id="l7.282" class="difflineminus">-  if (p_ap_encode_obj-&gt;fileId)      /* close the file if it is open.  */</span>
<a href="#l7.283"></a><span id="l7.283" class="difflineplus">+  if (p_ap_encode_obj-&gt;fileId) /* close the file if it is open.  */</span>
<a href="#l7.284"></a><span id="l7.284">     ::FSCloseFork(p_ap_encode_obj-&gt;fileId);</span>
<a href="#l7.285"></a><span id="l7.285"> </span>
<a href="#l7.286"></a><span id="l7.286" class="difflineminus">-  PR_FREEIF(p_ap_encode_obj-&gt;boundary);    /* the boundary string.        */</span>
<a href="#l7.287"></a><span id="l7.287" class="difflineplus">+  PR_FREEIF(p_ap_encode_obj-&gt;boundary); /* the boundary string.        */</span>
<a href="#l7.288"></a><span id="l7.288"> </span>
<a href="#l7.289"></a><span id="l7.289">   return noErr;</span>
<a href="#l7.290"></a><span id="l7.290"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgAppleEncode.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgAppleEncode.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -23,66 +23,53 @@</span>
<a href="#l8.4"></a><span id="l8.4"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l8.5"></a><span id="l8.5"> #include &quot;nsMsgAppleDouble.h&quot;</span>
<a href="#l8.6"></a><span id="l8.6"> #include &quot;nsMsgAppleCodes.h&quot;</span>
<a href="#l8.7"></a><span id="l8.7"> #include &quot;nsILocalFileMac.h&quot;</span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9"> /*</span>
<a href="#l8.10"></a><span id="l8.10"> **  Local Functions prototypes.</span>
<a href="#l8.11"></a><span id="l8.11"> */</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-static int output64chunk(appledouble_encode_object* p_ap_encode_obj,</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-                         int c1, int c2, int c3, int pads);</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+static int output64chunk(appledouble_encode_object *p_ap_encode_obj, int c1,</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+                         int c2, int c3, int pads);</span>
<a href="#l8.16"></a><span id="l8.16"> </span>
<a href="#l8.17"></a><span id="l8.17" class="difflineminus">-static int to64(appledouble_encode_object* p_ap_encode_obj,</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineminus">-                char *p,</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineminus">-                int  in_size);</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+static int to64(appledouble_encode_object *p_ap_encode_obj, char *p,</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+                int in_size);</span>
<a href="#l8.22"></a><span id="l8.22"> </span>
<a href="#l8.23"></a><span id="l8.23" class="difflineminus">-static int finish64(appledouble_encode_object* p_ap_encode_obj);</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+static int finish64(appledouble_encode_object *p_ap_encode_obj);</span>
<a href="#l8.25"></a><span id="l8.25"> </span>
<a href="#l8.26"></a><span id="l8.26" class="difflineminus">-</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineminus">-#define BUFF_LEFT(p)  ((p)-&gt;s_outbuff - (p)-&gt;pos_outbuff)</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+#define BUFF_LEFT(p) ((p)-&gt;s_outbuff - (p)-&gt;pos_outbuff)</span>
<a href="#l8.29"></a><span id="l8.29"> </span>
<a href="#l8.30"></a><span id="l8.30"> /*</span>
<a href="#l8.31"></a><span id="l8.31"> **  write_stream.</span>
<a href="#l8.32"></a><span id="l8.32"> */</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-int write_stream(</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineminus">-  appledouble_encode_object *p_ap_encode_obj,</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineminus">-  const char *out_string,</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineminus">-  int len)</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineminus">-{</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineminus">-  if (p_ap_encode_obj-&gt;pos_outbuff + len &lt; p_ap_encode_obj-&gt;s_outbuff)</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineminus">-  {</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineminus">-    memcpy(p_ap_encode_obj-&gt;outbuff + p_ap_encode_obj-&gt;pos_outbuff,</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineminus">-           out_string,</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+int write_stream(appledouble_encode_object *p_ap_encode_obj,</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+                 const char *out_string, int len) {</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+  if (p_ap_encode_obj-&gt;pos_outbuff + len &lt; p_ap_encode_obj-&gt;s_outbuff) {</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+    memcpy(p_ap_encode_obj-&gt;outbuff + p_ap_encode_obj-&gt;pos_outbuff, out_string,</span>
<a href="#l8.46"></a><span id="l8.46">            len);</span>
<a href="#l8.47"></a><span id="l8.47">     p_ap_encode_obj-&gt;pos_outbuff += len;</span>
<a href="#l8.48"></a><span id="l8.48">     return noErr;</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineminus">-  }</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineminus">-  else</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineminus">-  {</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+  } else {</span>
<a href="#l8.53"></a><span id="l8.53">     /*</span>
<a href="#l8.54"></a><span id="l8.54">     **  If the buff doesn't have enough space, use the overflow buffer then.</span>
<a href="#l8.55"></a><span id="l8.55">     */</span>
<a href="#l8.56"></a><span id="l8.56">     int s_len = p_ap_encode_obj-&gt;s_outbuff - p_ap_encode_obj-&gt;pos_outbuff;</span>
<a href="#l8.57"></a><span id="l8.57"> </span>
<a href="#l8.58"></a><span id="l8.58" class="difflineminus">-    memcpy(p_ap_encode_obj-&gt;outbuff + p_ap_encode_obj-&gt;pos_outbuff,</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineminus">-           out_string,</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+    memcpy(p_ap_encode_obj-&gt;outbuff + p_ap_encode_obj-&gt;pos_outbuff, out_string,</span>
<a href="#l8.61"></a><span id="l8.61">            s_len);</span>
<a href="#l8.62"></a><span id="l8.62">     memcpy(p_ap_encode_obj-&gt;b_overflow + p_ap_encode_obj-&gt;s_overflow,</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineminus">-           out_string + s_len,</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineminus">-           p_ap_encode_obj-&gt;s_overflow += (len - s_len));</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+           out_string + s_len, p_ap_encode_obj-&gt;s_overflow += (len - s_len));</span>
<a href="#l8.66"></a><span id="l8.66">     p_ap_encode_obj-&gt;pos_outbuff += s_len;</span>
<a href="#l8.67"></a><span id="l8.67">     return errEOB;</span>
<a href="#l8.68"></a><span id="l8.68">   }</span>
<a href="#l8.69"></a><span id="l8.69"> }</span>
<a href="#l8.70"></a><span id="l8.70"> </span>
<a href="#l8.71"></a><span id="l8.71" class="difflineminus">-int fill_apple_mime_header(</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineminus">-  appledouble_encode_object *p_ap_encode_obj)</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineminus">-{</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineminus">-  int  status;</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+int fill_apple_mime_header(appledouble_encode_object *p_ap_encode_obj) {</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+  int status;</span>
<a href="#l8.77"></a><span id="l8.77"> </span>
<a href="#l8.78"></a><span id="l8.78">   char tmpstr[266];</span>
<a href="#l8.79"></a><span id="l8.79"> </span>
<a href="#l8.80"></a><span id="l8.80"> #if 0</span>
<a href="#l8.81"></a><span id="l8.81"> //  strcpy(tmpstr, &quot;Content-Type: multipart/mixed; boundary=\&quot;-\&quot;\n\n---\n&quot;);</span>
<a href="#l8.82"></a><span id="l8.82"> //  status = write_stream(p_ap_encode_env,</span>
<a href="#l8.83"></a><span id="l8.83"> //            tmpstr,</span>
<a href="#l8.84"></a><span id="l8.84"> //            strlen(tmpstr));</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineat">@@ -101,603 +88,504 @@ int fill_apple_mime_header(</span>
<a href="#l8.86"></a><span id="l8.86">   if (status != noErr)</span>
<a href="#l8.87"></a><span id="l8.87">     return status;</span>
<a href="#l8.88"></a><span id="l8.88"> </span>
<a href="#l8.89"></a><span id="l8.89">   PR_snprintf(tmpstr, sizeof(tmpstr),</span>
<a href="#l8.90"></a><span id="l8.90">               &quot;\&quot;\r\nContent-Disposition: inline; filename=\&quot;%s\&quot;\r\n\r\n\r\n--=\r\n&quot;,</span>
<a href="#l8.91"></a><span id="l8.91">               p_ap_encode_obj-&gt;fname);</span>
<a href="#l8.92"></a><span id="l8.92"> #endif /* 0 */</span>
<a href="#l8.93"></a><span id="l8.93">   PR_snprintf(tmpstr, sizeof(tmpstr), &quot;--%s&quot; CRLF, p_ap_encode_obj-&gt;boundary);</span>
<a href="#l8.94"></a><span id="l8.94" class="difflineminus">-  status = write_stream(p_ap_encode_obj, (const char*)tmpstr, strlen(tmpstr));</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+  status = write_stream(p_ap_encode_obj, (const char *)tmpstr, strlen(tmpstr));</span>
<a href="#l8.96"></a><span id="l8.96">   return status;</span>
<a href="#l8.97"></a><span id="l8.97"> }</span>
<a href="#l8.98"></a><span id="l8.98"> </span>
<a href="#l8.99"></a><span id="l8.99" class="difflineminus">-int ap_encode_file_infor(</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineminus">-  appledouble_encode_object *p_ap_encode_obj)</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineminus">-{</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineminus">-  ap_header  head;</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineminus">-  ap_entry   entries[NUM_ENTRIES];</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineminus">-  ap_dates   dates;</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineminus">-  short      i;</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineminus">-  long       comlen;</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineminus">-  char       comment[256];</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineminus">-  int        status;</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineplus">+int ap_encode_file_infor(appledouble_encode_object *p_ap_encode_obj) {</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineplus">+  ap_header head;</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineplus">+  ap_entry entries[NUM_ENTRIES];</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineplus">+  ap_dates dates;</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineplus">+  short i;</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineplus">+  long comlen;</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineplus">+  char comment[256];</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineplus">+  int status;</span>
<a href="#l8.117"></a><span id="l8.117"> </span>
<a href="#l8.118"></a><span id="l8.118" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; resFile;</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; resFile;</span>
<a href="#l8.120"></a><span id="l8.120">   NS_NewNativeLocalFile(nsDependentCString(p_ap_encode_obj-&gt;fname), true,</span>
<a href="#l8.121"></a><span id="l8.121">                         getter_AddRefs(resFile));</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineminus">-  if (!resFile)</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineminus">-      return errFileOpen;</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineplus">+  if (!resFile) return errFileOpen;</span>
<a href="#l8.125"></a><span id="l8.125"> </span>
<a href="#l8.126"></a><span id="l8.126">   FSRef ref;</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineminus">-  nsCOMPtr &lt;nsILocalFileMac&gt; macFile = do_QueryInterface(resFile);</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineminus">-  if (NS_FAILED(macFile-&gt;GetFSRef(&amp;ref)))</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineminus">-      return errFileOpen;</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineplus">+  nsCOMPtr&lt;nsILocalFileMac&gt; macFile = do_QueryInterface(resFile);</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineplus">+  if (NS_FAILED(macFile-&gt;GetFSRef(&amp;ref))) return errFileOpen;</span>
<a href="#l8.132"></a><span id="l8.132"> </span>
<a href="#l8.133"></a><span id="l8.133">   FSCatalogInfo catalogInfo;</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineminus">-  if (::FSGetCatalogInfo(&amp;ref, kFSCatInfoFinderInfo, &amp;catalogInfo, nullptr, nullptr, nullptr) != noErr)</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineminus">-  {</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineplus">+  if (::FSGetCatalogInfo(&amp;ref, kFSCatInfoFinderInfo, &amp;catalogInfo, nullptr,</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineplus">+                         nullptr, nullptr) != noErr) {</span>
<a href="#l8.138"></a><span id="l8.138">     return errFileOpen;</span>
<a href="#l8.139"></a><span id="l8.139">   }</span>
<a href="#l8.140"></a><span id="l8.140"> </span>
<a href="#l8.141"></a><span id="l8.141">   /* get a file comment, if possible */</span>
<a href="#l8.142"></a><span id="l8.142"> #if 1</span>
<a href="#l8.143"></a><span id="l8.143">   // Carbon doesn't support GetWDInfo(). (Bug 555684)</span>
<a href="#l8.144"></a><span id="l8.144"> </span>
<a href="#l8.145"></a><span id="l8.145">   // not sure why working directories are needed here...</span>
<a href="#l8.146"></a><span id="l8.146">   comlen = 0;</span>
<a href="#l8.147"></a><span id="l8.147"> #else</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineminus">-  long     procID;</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineplus">+  long procID;</span>
<a href="#l8.150"></a><span id="l8.150">   procID = 0;</span>
<a href="#l8.151"></a><span id="l8.151">   GetWDInfo(p_ap_encode_obj-&gt;vRefNum, &amp;fpb-&gt;ioVRefNum, &amp;fpb-&gt;ioDirID, &amp;procID);</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineminus">-  IOParam   vinfo;</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineminus">-  memset((void *) &amp;vinfo, '\0', sizeof (vinfo));</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineplus">+  IOParam vinfo;</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineplus">+  memset((void *)&amp;vinfo, '\0', sizeof(vinfo));</span>
<a href="#l8.156"></a><span id="l8.156">   GetVolParmsInfoBuffer vp;</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineminus">-  vinfo.ioCompletion  = nil;</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineminus">-  vinfo.ioVRefNum   = fpb-&gt;ioVRefNum;</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineminus">-  vinfo.ioBuffer     = (Ptr) &amp;vp;</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineminus">-  vinfo.ioReqCount   = sizeof (vp);</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineplus">+  vinfo.ioCompletion = nil;</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineplus">+  vinfo.ioVRefNum = fpb-&gt;ioVRefNum;</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineplus">+  vinfo.ioBuffer = (Ptr)&amp;vp;</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineplus">+  vinfo.ioReqCount = sizeof(vp);</span>
<a href="#l8.165"></a><span id="l8.165">   comlen = 0;</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineminus">-  if (PBHGetVolParmsSync((HParmBlkPtr) &amp;vinfo) == noErr &amp;&amp;</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineminus">-    ((vp.vMAttrib &gt;&gt; bHasDesktopMgr) &amp; 1))</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineminus">-  {</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineminus">-    DTPBRec   dtp;</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineminus">-    memset((void *) &amp;dtp, '\0', sizeof (dtp));</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineplus">+  if (PBHGetVolParmsSync((HParmBlkPtr)&amp;vinfo) == noErr &amp;&amp;</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineplus">+      ((vp.vMAttrib &gt;&gt; bHasDesktopMgr) &amp; 1)) {</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineplus">+    DTPBRec dtp;</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineplus">+    memset((void *)&amp;dtp, '\0', sizeof(dtp));</span>
<a href="#l8.175"></a><span id="l8.175">     dtp.ioVRefNum = fpb-&gt;ioVRefNum;</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineminus">-    if (PBDTGetPath(&amp;dtp) == noErr)</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineminus">-    {</span>
<a href="#l8.178"></a><span id="l8.178" class="difflineplus">+    if (PBDTGetPath(&amp;dtp) == noErr) {</span>
<a href="#l8.179"></a><span id="l8.179">       dtp.ioCompletion = nil;</span>
<a href="#l8.180"></a><span id="l8.180" class="difflineminus">-      dtp.ioDTBuffer = (Ptr) comment;</span>
<a href="#l8.181"></a><span id="l8.181" class="difflineminus">-      dtp.ioNamePtr  = fpb-&gt;ioNamePtr;</span>
<a href="#l8.182"></a><span id="l8.182" class="difflineminus">-      dtp.ioDirID    = fpb-&gt;ioFlParID;</span>
<a href="#l8.183"></a><span id="l8.183" class="difflineminus">-      if (PBDTGetCommentSync(&amp;dtp) == noErr)</span>
<a href="#l8.184"></a><span id="l8.184" class="difflineminus">-        comlen = dtp.ioDTActCount;</span>
<a href="#l8.185"></a><span id="l8.185" class="difflineplus">+      dtp.ioDTBuffer = (Ptr)comment;</span>
<a href="#l8.186"></a><span id="l8.186" class="difflineplus">+      dtp.ioNamePtr = fpb-&gt;ioNamePtr;</span>
<a href="#l8.187"></a><span id="l8.187" class="difflineplus">+      dtp.ioDirID = fpb-&gt;ioFlParID;</span>
<a href="#l8.188"></a><span id="l8.188" class="difflineplus">+      if (PBDTGetCommentSync(&amp;dtp) == noErr) comlen = dtp.ioDTActCount;</span>
<a href="#l8.189"></a><span id="l8.189">     }</span>
<a href="#l8.190"></a><span id="l8.190">   }</span>
<a href="#l8.191"></a><span id="l8.191"> #endif /* ! 1 */</span>
<a href="#l8.192"></a><span id="l8.192"> </span>
<a href="#l8.193"></a><span id="l8.193">   /* write header */</span>
<a href="#l8.194"></a><span id="l8.194" class="difflineminus">-//  head.magic = dfork ? APPLESINGLE_MAGIC : APPLEDOUBLE_MAGIC;</span>
<a href="#l8.195"></a><span id="l8.195" class="difflineminus">-  head.magic   = APPLEDOUBLE_MAGIC;    /* always do apple double */</span>
<a href="#l8.196"></a><span id="l8.196" class="difflineplus">+  //  head.magic = dfork ? APPLESINGLE_MAGIC : APPLEDOUBLE_MAGIC;</span>
<a href="#l8.197"></a><span id="l8.197" class="difflineplus">+  head.magic = APPLEDOUBLE_MAGIC; /* always do apple double */</span>
<a href="#l8.198"></a><span id="l8.198">   head.version = APPLEDOUBLE_VERSION;</span>
<a href="#l8.199"></a><span id="l8.199" class="difflineminus">-  memset(head.fill, '\0', sizeof (head.fill));</span>
<a href="#l8.200"></a><span id="l8.200" class="difflineplus">+  memset(head.fill, '\0', sizeof(head.fill));</span>
<a href="#l8.201"></a><span id="l8.201">   head.entries = NUM_ENTRIES - 1;</span>
<a href="#l8.202"></a><span id="l8.202" class="difflineminus">-  status = to64(p_ap_encode_obj,</span>
<a href="#l8.203"></a><span id="l8.203" class="difflineminus">-                (char *) &amp;head,</span>
<a href="#l8.204"></a><span id="l8.204" class="difflineminus">-                sizeof (head));</span>
<a href="#l8.205"></a><span id="l8.205" class="difflineminus">-  if (status != noErr)</span>
<a href="#l8.206"></a><span id="l8.206" class="difflineminus">-    return status;</span>
<a href="#l8.207"></a><span id="l8.207" class="difflineplus">+  status = to64(p_ap_encode_obj, (char *)&amp;head, sizeof(head));</span>
<a href="#l8.208"></a><span id="l8.208" class="difflineplus">+  if (status != noErr) return status;</span>
<a href="#l8.209"></a><span id="l8.209"> </span>
<a href="#l8.210"></a><span id="l8.210">   /* write entry descriptors */</span>
<a href="#l8.211"></a><span id="l8.211">   nsAutoCString leafname;</span>
<a href="#l8.212"></a><span id="l8.212">   macFile-&gt;GetNativeLeafName(leafname);</span>
<a href="#l8.213"></a><span id="l8.213" class="difflineminus">-  entries[0].offset = sizeof (head) + sizeof (ap_entry) * head.entries;</span>
<a href="#l8.214"></a><span id="l8.214" class="difflineminus">-  entries[0].id   = ENT_NAME;</span>
<a href="#l8.215"></a><span id="l8.215" class="difflineplus">+  entries[0].offset = sizeof(head) + sizeof(ap_entry) * head.entries;</span>
<a href="#l8.216"></a><span id="l8.216" class="difflineplus">+  entries[0].id = ENT_NAME;</span>
<a href="#l8.217"></a><span id="l8.217">   entries[0].length = leafname.Length();</span>
<a href="#l8.218"></a><span id="l8.218" class="difflineminus">-  entries[1].id   = ENT_FINFO;</span>
<a href="#l8.219"></a><span id="l8.219" class="difflineminus">-  entries[1].length = sizeof (FInfo) + sizeof (FXInfo);</span>
<a href="#l8.220"></a><span id="l8.220" class="difflineminus">-  entries[2].id   = ENT_DATES;</span>
<a href="#l8.221"></a><span id="l8.221" class="difflineminus">-  entries[2].length = sizeof (ap_dates);</span>
<a href="#l8.222"></a><span id="l8.222" class="difflineminus">-  entries[3].id   = ENT_COMMENT;</span>
<a href="#l8.223"></a><span id="l8.223" class="difflineplus">+  entries[1].id = ENT_FINFO;</span>
<a href="#l8.224"></a><span id="l8.224" class="difflineplus">+  entries[1].length = sizeof(FInfo) + sizeof(FXInfo);</span>
<a href="#l8.225"></a><span id="l8.225" class="difflineplus">+  entries[2].id = ENT_DATES;</span>
<a href="#l8.226"></a><span id="l8.226" class="difflineplus">+  entries[2].length = sizeof(ap_dates);</span>
<a href="#l8.227"></a><span id="l8.227" class="difflineplus">+  entries[3].id = ENT_COMMENT;</span>
<a href="#l8.228"></a><span id="l8.228">   entries[3].length = comlen;</span>
<a href="#l8.229"></a><span id="l8.229" class="difflineminus">-  entries[4].id   = ENT_RFORK;</span>
<a href="#l8.230"></a><span id="l8.230" class="difflineplus">+  entries[4].id = ENT_RFORK;</span>
<a href="#l8.231"></a><span id="l8.231">   entries[4].length = catalogInfo.rsrcLogicalSize;</span>
<a href="#l8.232"></a><span id="l8.232" class="difflineminus">-  entries[5].id   = ENT_DFORK;</span>
<a href="#l8.233"></a><span id="l8.233" class="difflineplus">+  entries[5].id = ENT_DFORK;</span>
<a href="#l8.234"></a><span id="l8.234">   entries[5].length = catalogInfo.dataLogicalSize;</span>
<a href="#l8.235"></a><span id="l8.235"> </span>
<a href="#l8.236"></a><span id="l8.236">   /* correct the link in the entries. */</span>
<a href="#l8.237"></a><span id="l8.237" class="difflineminus">-  for (i = 1; i &lt; NUM_ENTRIES; ++i)</span>
<a href="#l8.238"></a><span id="l8.238" class="difflineminus">-  {</span>
<a href="#l8.239"></a><span id="l8.239" class="difflineminus">-    entries[i].offset = entries[i-1].offset + entries[i-1].length;</span>
<a href="#l8.240"></a><span id="l8.240" class="difflineplus">+  for (i = 1; i &lt; NUM_ENTRIES; ++i) {</span>
<a href="#l8.241"></a><span id="l8.241" class="difflineplus">+    entries[i].offset = entries[i - 1].offset + entries[i - 1].length;</span>
<a href="#l8.242"></a><span id="l8.242">   }</span>
<a href="#l8.243"></a><span id="l8.243" class="difflineminus">-  status = to64(p_ap_encode_obj,</span>
<a href="#l8.244"></a><span id="l8.244" class="difflineminus">-                (char *) entries,</span>
<a href="#l8.245"></a><span id="l8.245" class="difflineminus">-                sizeof (ap_entry) * head.entries);</span>
<a href="#l8.246"></a><span id="l8.246" class="difflineminus">-  if (status != noErr)</span>
<a href="#l8.247"></a><span id="l8.247" class="difflineminus">-    return status;</span>
<a href="#l8.248"></a><span id="l8.248" class="difflineplus">+  status =</span>
<a href="#l8.249"></a><span id="l8.249" class="difflineplus">+      to64(p_ap_encode_obj, (char *)entries, sizeof(ap_entry) * head.entries);</span>
<a href="#l8.250"></a><span id="l8.250" class="difflineplus">+  if (status != noErr) return status;</span>
<a href="#l8.251"></a><span id="l8.251"> </span>
<a href="#l8.252"></a><span id="l8.252">   /* write name */</span>
<a href="#l8.253"></a><span id="l8.253" class="difflineminus">-  status = to64(p_ap_encode_obj,</span>
<a href="#l8.254"></a><span id="l8.254" class="difflineminus">-                (char *) leafname.get(),</span>
<a href="#l8.255"></a><span id="l8.255" class="difflineminus">-                leafname.Length());</span>
<a href="#l8.256"></a><span id="l8.256" class="difflineminus">-  if (status != noErr)</span>
<a href="#l8.257"></a><span id="l8.257" class="difflineminus">-    return status;</span>
<a href="#l8.258"></a><span id="l8.258" class="difflineplus">+  status = to64(p_ap_encode_obj, (char *)leafname.get(), leafname.Length());</span>
<a href="#l8.259"></a><span id="l8.259" class="difflineplus">+  if (status != noErr) return status;</span>
<a href="#l8.260"></a><span id="l8.260"> </span>
<a href="#l8.261"></a><span id="l8.261">   /* write finder info */</span>
<a href="#l8.262"></a><span id="l8.262" class="difflineminus">-  status = to64(p_ap_encode_obj,</span>
<a href="#l8.263"></a><span id="l8.263" class="difflineminus">-                (char *) &amp;catalogInfo.finderInfo,</span>
<a href="#l8.264"></a><span id="l8.264" class="difflineminus">-                sizeof (FInfo));</span>
<a href="#l8.265"></a><span id="l8.265" class="difflineminus">-  if (status != noErr)</span>
<a href="#l8.266"></a><span id="l8.266" class="difflineminus">-    return status;</span>
<a href="#l8.267"></a><span id="l8.267" class="difflineplus">+  status =</span>
<a href="#l8.268"></a><span id="l8.268" class="difflineplus">+      to64(p_ap_encode_obj, (char *)&amp;catalogInfo.finderInfo, sizeof(FInfo));</span>
<a href="#l8.269"></a><span id="l8.269" class="difflineplus">+  if (status != noErr) return status;</span>
<a href="#l8.270"></a><span id="l8.270"> </span>
<a href="#l8.271"></a><span id="l8.271" class="difflineminus">-  status = to64(p_ap_encode_obj,</span>
<a href="#l8.272"></a><span id="l8.272" class="difflineminus">-                (char *) &amp;catalogInfo.extFinderInfo,</span>
<a href="#l8.273"></a><span id="l8.273" class="difflineminus">-                sizeof (FXInfo));</span>
<a href="#l8.274"></a><span id="l8.274" class="difflineminus">-  if (status != noErr)</span>
<a href="#l8.275"></a><span id="l8.275" class="difflineminus">-    return status;</span>
<a href="#l8.276"></a><span id="l8.276" class="difflineplus">+  status =</span>
<a href="#l8.277"></a><span id="l8.277" class="difflineplus">+      to64(p_ap_encode_obj, (char *)&amp;catalogInfo.extFinderInfo, sizeof(FXInfo));</span>
<a href="#l8.278"></a><span id="l8.278" class="difflineplus">+  if (status != noErr) return status;</span>
<a href="#l8.279"></a><span id="l8.279"> </span>
<a href="#l8.280"></a><span id="l8.280">   /* write dates */</span>
<a href="#l8.281"></a><span id="l8.281">   dates.create = catalogInfo.createDate.lowSeconds + CONVERT_TIME;</span>
<a href="#l8.282"></a><span id="l8.282">   dates.modify = catalogInfo.contentModDate.lowSeconds + CONVERT_TIME;</span>
<a href="#l8.283"></a><span id="l8.283">   dates.backup = catalogInfo.backupDate.lowSeconds + CONVERT_TIME;</span>
<a href="#l8.284"></a><span id="l8.284">   dates.access = catalogInfo.accessDate.lowSeconds + CONVERT_TIME;</span>
<a href="#l8.285"></a><span id="l8.285" class="difflineminus">-  status = to64(p_ap_encode_obj,</span>
<a href="#l8.286"></a><span id="l8.286" class="difflineminus">-                (char *) &amp;dates,</span>
<a href="#l8.287"></a><span id="l8.287" class="difflineminus">-                sizeof (ap_dates));</span>
<a href="#l8.288"></a><span id="l8.288" class="difflineminus">-  if (status != noErr)</span>
<a href="#l8.289"></a><span id="l8.289" class="difflineminus">-    return status;</span>
<a href="#l8.290"></a><span id="l8.290" class="difflineplus">+  status = to64(p_ap_encode_obj, (char *)&amp;dates, sizeof(ap_dates));</span>
<a href="#l8.291"></a><span id="l8.291" class="difflineplus">+  if (status != noErr) return status;</span>
<a href="#l8.292"></a><span id="l8.292"> </span>
<a href="#l8.293"></a><span id="l8.293">   /* write comment */</span>
<a href="#l8.294"></a><span id="l8.294" class="difflineminus">-  if (comlen)</span>
<a href="#l8.295"></a><span id="l8.295" class="difflineminus">-  {</span>
<a href="#l8.296"></a><span id="l8.296" class="difflineminus">-    status = to64(p_ap_encode_obj,</span>
<a href="#l8.297"></a><span id="l8.297" class="difflineminus">-                  comment,</span>
<a href="#l8.298"></a><span id="l8.298" class="difflineminus">-                  comlen * sizeof(char));</span>
<a href="#l8.299"></a><span id="l8.299" class="difflineplus">+  if (comlen) {</span>
<a href="#l8.300"></a><span id="l8.300" class="difflineplus">+    status = to64(p_ap_encode_obj, comment, comlen * sizeof(char));</span>
<a href="#l8.301"></a><span id="l8.301">   }</span>
<a href="#l8.302"></a><span id="l8.302">   /*</span>
<a href="#l8.303"></a><span id="l8.303">   **  Get some help information on deciding the file type.</span>
<a href="#l8.304"></a><span id="l8.304">   */</span>
<a href="#l8.305"></a><span id="l8.305" class="difflineminus">-  if (((FileInfo*)(&amp;catalogInfo.finderInfo))-&gt;fileType == 'TEXT' ||</span>
<a href="#l8.306"></a><span id="l8.306" class="difflineminus">-      ((FileInfo*)(&amp;catalogInfo.finderInfo))-&gt;fileType == 'text')</span>
<a href="#l8.307"></a><span id="l8.307" class="difflineminus">-  {</span>
<a href="#l8.308"></a><span id="l8.308" class="difflineplus">+  if (((FileInfo *)(&amp;catalogInfo.finderInfo))-&gt;fileType == 'TEXT' ||</span>
<a href="#l8.309"></a><span id="l8.309" class="difflineplus">+      ((FileInfo *)(&amp;catalogInfo.finderInfo))-&gt;fileType == 'text') {</span>
<a href="#l8.310"></a><span id="l8.310">     p_ap_encode_obj-&gt;text_file_type = true;</span>
<a href="#l8.311"></a><span id="l8.311">   }</span>
<a href="#l8.312"></a><span id="l8.312"> </span>
<a href="#l8.313"></a><span id="l8.313">   return status;</span>
<a href="#l8.314"></a><span id="l8.314"> }</span>
<a href="#l8.315"></a><span id="l8.315"> /*</span>
<a href="#l8.316"></a><span id="l8.316"> **  ap_encode_header</span>
<a href="#l8.317"></a><span id="l8.317"> **</span>
<a href="#l8.318"></a><span id="l8.318"> **    encode the file header and the resource fork.</span>
<a href="#l8.319"></a><span id="l8.319"> **</span>
<a href="#l8.320"></a><span id="l8.320"> */</span>
<a href="#l8.321"></a><span id="l8.321" class="difflineminus">-int ap_encode_header(</span>
<a href="#l8.322"></a><span id="l8.322" class="difflineminus">-  appledouble_encode_object* p_ap_encode_obj,</span>
<a href="#l8.323"></a><span id="l8.323" class="difflineminus">-  bool    firstime)</span>
<a href="#l8.324"></a><span id="l8.324" class="difflineminus">-{</span>
<a href="#l8.325"></a><span id="l8.325" class="difflineminus">-  char     rd_buff[256];</span>
<a href="#l8.326"></a><span id="l8.326" class="difflineplus">+int ap_encode_header(appledouble_encode_object *p_ap_encode_obj,</span>
<a href="#l8.327"></a><span id="l8.327" class="difflineplus">+                     bool firstime) {</span>
<a href="#l8.328"></a><span id="l8.328" class="difflineplus">+  char rd_buff[256];</span>
<a href="#l8.329"></a><span id="l8.329">   FSIORefNum fileId;</span>
<a href="#l8.330"></a><span id="l8.330" class="difflineminus">-  OSErr  retval = noErr;</span>
<a href="#l8.331"></a><span id="l8.331" class="difflineminus">-  int      status;</span>
<a href="#l8.332"></a><span id="l8.332" class="difflineplus">+  OSErr retval = noErr;</span>
<a href="#l8.333"></a><span id="l8.333" class="difflineplus">+  int status;</span>
<a href="#l8.334"></a><span id="l8.334">   ByteCount inCount;</span>
<a href="#l8.335"></a><span id="l8.335"> </span>
<a href="#l8.336"></a><span id="l8.336" class="difflineminus">-  if (firstime)</span>
<a href="#l8.337"></a><span id="l8.337" class="difflineminus">-  {</span>
<a href="#l8.338"></a><span id="l8.338" class="difflineminus">-    PL_strcpy(rd_buff,</span>
<a href="#l8.339"></a><span id="l8.339" class="difflineminus">-      &quot;Content-Type: application/applefile\r\nContent-Transfer-Encoding: base64\r\n\r\n&quot;);</span>
<a href="#l8.340"></a><span id="l8.340" class="difflineminus">-    status = write_stream(p_ap_encode_obj, (const char*)rd_buff, strlen(rd_buff));</span>
<a href="#l8.341"></a><span id="l8.341" class="difflineminus">-    if (status != noErr)</span>
<a href="#l8.342"></a><span id="l8.342" class="difflineminus">-      return status;</span>
<a href="#l8.343"></a><span id="l8.343" class="difflineplus">+  if (firstime) {</span>
<a href="#l8.344"></a><span id="l8.344" class="difflineplus">+    PL_strcpy(</span>
<a href="#l8.345"></a><span id="l8.345" class="difflineplus">+        rd_buff,</span>
<a href="#l8.346"></a><span id="l8.346" class="difflineplus">+        &quot;Content-Type: application/applefile\r\nContent-Transfer-Encoding: &quot;</span>
<a href="#l8.347"></a><span id="l8.347" class="difflineplus">+        &quot;base64\r\n\r\n&quot;);</span>
<a href="#l8.348"></a><span id="l8.348" class="difflineplus">+    status =</span>
<a href="#l8.349"></a><span id="l8.349" class="difflineplus">+        write_stream(p_ap_encode_obj, (const char *)rd_buff, strlen(rd_buff));</span>
<a href="#l8.350"></a><span id="l8.350" class="difflineplus">+    if (status != noErr) return status;</span>
<a href="#l8.351"></a><span id="l8.351"> </span>
<a href="#l8.352"></a><span id="l8.352">     status = ap_encode_file_infor(p_ap_encode_obj);</span>
<a href="#l8.353"></a><span id="l8.353" class="difflineminus">-    if (status != noErr)</span>
<a href="#l8.354"></a><span id="l8.354" class="difflineminus">-      return status;</span>
<a href="#l8.355"></a><span id="l8.355" class="difflineplus">+    if (status != noErr) return status;</span>
<a href="#l8.356"></a><span id="l8.356"> </span>
<a href="#l8.357"></a><span id="l8.357">     /*</span>
<a href="#l8.358"></a><span id="l8.358">     ** preparing to encode the resource fork.</span>
<a href="#l8.359"></a><span id="l8.359">     */</span>
<a href="#l8.360"></a><span id="l8.360" class="difflineminus">-    nsCOMPtr &lt;nsIFile&gt; myFile;</span>
<a href="#l8.361"></a><span id="l8.361" class="difflineminus">-    NS_NewNativeLocalFile(nsDependentCString(p_ap_encode_obj-&gt;fname), true, getter_AddRefs(myFile));</span>
<a href="#l8.362"></a><span id="l8.362" class="difflineminus">-    if (!myFile)</span>
<a href="#l8.363"></a><span id="l8.363" class="difflineminus">-      return errFileOpen;</span>
<a href="#l8.364"></a><span id="l8.364" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; myFile;</span>
<a href="#l8.365"></a><span id="l8.365" class="difflineplus">+    NS_NewNativeLocalFile(nsDependentCString(p_ap_encode_obj-&gt;fname), true,</span>
<a href="#l8.366"></a><span id="l8.366" class="difflineplus">+                          getter_AddRefs(myFile));</span>
<a href="#l8.367"></a><span id="l8.367" class="difflineplus">+    if (!myFile) return errFileOpen;</span>
<a href="#l8.368"></a><span id="l8.368"> </span>
<a href="#l8.369"></a><span id="l8.369">     FSRef ref;</span>
<a href="#l8.370"></a><span id="l8.370" class="difflineminus">-    nsCOMPtr &lt;nsILocalFileMac&gt; macFile = do_QueryInterface(myFile);</span>
<a href="#l8.371"></a><span id="l8.371" class="difflineminus">-    if (NS_FAILED(macFile-&gt;GetFSRef(&amp;ref)))</span>
<a href="#l8.372"></a><span id="l8.372" class="difflineminus">-      return errFileOpen;</span>
<a href="#l8.373"></a><span id="l8.373" class="difflineplus">+    nsCOMPtr&lt;nsILocalFileMac&gt; macFile = do_QueryInterface(myFile);</span>
<a href="#l8.374"></a><span id="l8.374" class="difflineplus">+    if (NS_FAILED(macFile-&gt;GetFSRef(&amp;ref))) return errFileOpen;</span>
<a href="#l8.375"></a><span id="l8.375"> </span>
<a href="#l8.376"></a><span id="l8.376">     HFSUniStr255 forkName;</span>
<a href="#l8.377"></a><span id="l8.377">     ::FSGetResourceForkName(&amp;forkName);</span>
<a href="#l8.378"></a><span id="l8.378" class="difflineminus">-    retval = ::FSOpenFork(&amp;ref, forkName.length, forkName.unicode, fsRdPerm, &amp;p_ap_encode_obj-&gt;fileId);</span>
<a href="#l8.379"></a><span id="l8.379" class="difflineminus">-    if (retval != noErr)</span>
<a href="#l8.380"></a><span id="l8.380" class="difflineminus">-      return retval;</span>
<a href="#l8.381"></a><span id="l8.381" class="difflineplus">+    retval = ::FSOpenFork(&amp;ref, forkName.length, forkName.unicode, fsRdPerm,</span>
<a href="#l8.382"></a><span id="l8.382" class="difflineplus">+                          &amp;p_ap_encode_obj-&gt;fileId);</span>
<a href="#l8.383"></a><span id="l8.383" class="difflineplus">+    if (retval != noErr) return retval;</span>
<a href="#l8.384"></a><span id="l8.384">   }</span>
<a href="#l8.385"></a><span id="l8.385"> </span>
<a href="#l8.386"></a><span id="l8.386">   fileId = p_ap_encode_obj-&gt;fileId;</span>
<a href="#l8.387"></a><span id="l8.387" class="difflineminus">-  while (retval == noErr)</span>
<a href="#l8.388"></a><span id="l8.388" class="difflineminus">-  {</span>
<a href="#l8.389"></a><span id="l8.389" class="difflineminus">-    if (BUFF_LEFT(p_ap_encode_obj) &lt; 400)</span>
<a href="#l8.390"></a><span id="l8.390" class="difflineminus">-      break;</span>
<a href="#l8.391"></a><span id="l8.391" class="difflineplus">+  while (retval == noErr) {</span>
<a href="#l8.392"></a><span id="l8.392" class="difflineplus">+    if (BUFF_LEFT(p_ap_encode_obj) &lt; 400) break;</span>
<a href="#l8.393"></a><span id="l8.393"> </span>
<a href="#l8.394"></a><span id="l8.394">     inCount = 0;</span>
<a href="#l8.395"></a><span id="l8.395">     retval = ::FSReadFork(fileId, fsAtMark, 0, 256, rd_buff, &amp;inCount);</span>
<a href="#l8.396"></a><span id="l8.396" class="difflineminus">-    if (inCount)</span>
<a href="#l8.397"></a><span id="l8.397" class="difflineminus">-    {</span>
<a href="#l8.398"></a><span id="l8.398" class="difflineminus">-      status = to64(p_ap_encode_obj,</span>
<a href="#l8.399"></a><span id="l8.399" class="difflineminus">-                    rd_buff,</span>
<a href="#l8.400"></a><span id="l8.400" class="difflineminus">-                    inCount);</span>
<a href="#l8.401"></a><span id="l8.401" class="difflineminus">-      if (status != noErr)</span>
<a href="#l8.402"></a><span id="l8.402" class="difflineminus">-        return status;</span>
<a href="#l8.403"></a><span id="l8.403" class="difflineplus">+    if (inCount) {</span>
<a href="#l8.404"></a><span id="l8.404" class="difflineplus">+      status = to64(p_ap_encode_obj, rd_buff, inCount);</span>
<a href="#l8.405"></a><span id="l8.405" class="difflineplus">+      if (status != noErr) return status;</span>
<a href="#l8.406"></a><span id="l8.406">     }</span>
<a href="#l8.407"></a><span id="l8.407">   }</span>
<a href="#l8.408"></a><span id="l8.408"> </span>
<a href="#l8.409"></a><span id="l8.409" class="difflineminus">-  if (retval == eofErr)</span>
<a href="#l8.410"></a><span id="l8.410" class="difflineminus">-  {</span>
<a href="#l8.411"></a><span id="l8.411" class="difflineplus">+  if (retval == eofErr) {</span>
<a href="#l8.412"></a><span id="l8.412">     ::FSCloseFork(fileId);</span>
<a href="#l8.413"></a><span id="l8.413">     p_ap_encode_obj-&gt;fileId = 0;</span>
<a href="#l8.414"></a><span id="l8.414"> </span>
<a href="#l8.415"></a><span id="l8.415">     status = finish64(p_ap_encode_obj);</span>
<a href="#l8.416"></a><span id="l8.416" class="difflineminus">-    if (status != noErr)</span>
<a href="#l8.417"></a><span id="l8.417" class="difflineminus">-      return status;</span>
<a href="#l8.418"></a><span id="l8.418" class="difflineplus">+    if (status != noErr) return status;</span>
<a href="#l8.419"></a><span id="l8.419"> </span>
<a href="#l8.420"></a><span id="l8.420">     /*</span>
<a href="#l8.421"></a><span id="l8.421">     ** write out the boundary</span>
<a href="#l8.422"></a><span id="l8.422">     */</span>
<a href="#l8.423"></a><span id="l8.423" class="difflineminus">-    PR_snprintf(rd_buff, sizeof(rd_buff),</span>
<a href="#l8.424"></a><span id="l8.424" class="difflineminus">-                CRLF &quot;--%s&quot; CRLF,</span>
<a href="#l8.425"></a><span id="l8.425" class="difflineplus">+    PR_snprintf(rd_buff, sizeof(rd_buff), CRLF &quot;--%s&quot; CRLF,</span>
<a href="#l8.426"></a><span id="l8.426">                 p_ap_encode_obj-&gt;boundary);</span>
<a href="#l8.427"></a><span id="l8.427"> </span>
<a href="#l8.428"></a><span id="l8.428" class="difflineminus">-    status = write_stream(p_ap_encode_obj, (const char*)rd_buff, strlen(rd_buff));</span>
<a href="#l8.429"></a><span id="l8.429" class="difflineminus">-    if (status == noErr)</span>
<a href="#l8.430"></a><span id="l8.430" class="difflineminus">-      status = errDone;</span>
<a href="#l8.431"></a><span id="l8.431" class="difflineplus">+    status =</span>
<a href="#l8.432"></a><span id="l8.432" class="difflineplus">+        write_stream(p_ap_encode_obj, (const char *)rd_buff, strlen(rd_buff));</span>
<a href="#l8.433"></a><span id="l8.433" class="difflineplus">+    if (status == noErr) status = errDone;</span>
<a href="#l8.434"></a><span id="l8.434">   }</span>
<a href="#l8.435"></a><span id="l8.435">   return status;</span>
<a href="#l8.436"></a><span id="l8.436"> }</span>
<a href="#l8.437"></a><span id="l8.437"> </span>
<a href="#l8.438"></a><span id="l8.438"> #if 0</span>
<a href="#l8.439"></a><span id="l8.439"> // This is unused for now and Clang complains about that is it is ifdefed out</span>
<a href="#l8.440"></a><span id="l8.440"> static void replace(char *p, int len, char frm, char to)</span>
<a href="#l8.441"></a><span id="l8.441"> {</span>
<a href="#l8.442"></a><span id="l8.442">   for (; len &gt; 0; len--, p++)</span>
<a href="#l8.443"></a><span id="l8.443">     if (*p == frm)  *p = to;</span>
<a href="#l8.444"></a><span id="l8.444"> }</span>
<a href="#l8.445"></a><span id="l8.445"> #endif</span>
<a href="#l8.446"></a><span id="l8.446"> </span>
<a href="#l8.447"></a><span id="l8.447"> /* Description of the various file formats and their magic numbers     */</span>
<a href="#l8.448"></a><span id="l8.448" class="difflineminus">-struct magic</span>
<a href="#l8.449"></a><span id="l8.449" class="difflineminus">-{</span>
<a href="#l8.450"></a><span id="l8.450" class="difflineminus">-    const char *name;    /* Name of the file format */</span>
<a href="#l8.451"></a><span id="l8.451" class="difflineminus">-    const char *num;     /* The magic number */</span>
<a href="#l8.452"></a><span id="l8.452" class="difflineminus">-    int        len;      /* Length (0 means strlen(magicnum)) */</span>
<a href="#l8.453"></a><span id="l8.453" class="difflineplus">+struct magic {</span>
<a href="#l8.454"></a><span id="l8.454" class="difflineplus">+  const char *name; /* Name of the file format */</span>
<a href="#l8.455"></a><span id="l8.455" class="difflineplus">+  const char *num;  /* The magic number */</span>
<a href="#l8.456"></a><span id="l8.456" class="difflineplus">+  int len;          /* Length (0 means strlen(magicnum)) */</span>
<a href="#l8.457"></a><span id="l8.457"> };</span>
<a href="#l8.458"></a><span id="l8.458"> </span>
<a href="#l8.459"></a><span id="l8.459"> /* The magic numbers of the file formats we know about */</span>
<a href="#l8.460"></a><span id="l8.460" class="difflineminus">-static struct magic magic[] =</span>
<a href="#l8.461"></a><span id="l8.461" class="difflineminus">-{</span>
<a href="#l8.462"></a><span id="l8.462" class="difflineminus">-    { &quot;image/gif&quot;,   &quot;GIF&quot;,         0 },</span>
<a href="#l8.463"></a><span id="l8.463" class="difflineminus">-    { &quot;image/jpeg&quot;, &quot;\377\330\377&quot;,   0 },</span>
<a href="#l8.464"></a><span id="l8.464" class="difflineminus">-    { &quot;video/mpeg&quot;, &quot;\0\0\001\263&quot;,    4 },</span>
<a href="#l8.465"></a><span id="l8.465" class="difflineminus">-    { &quot;application/postscript&quot;, &quot;%!&quot;, 0 },</span>
<a href="#l8.466"></a><span id="l8.466" class="difflineplus">+static struct magic magic[] = {</span>
<a href="#l8.467"></a><span id="l8.467" class="difflineplus">+    {&quot;image/gif&quot;, &quot;GIF&quot;, 0},</span>
<a href="#l8.468"></a><span id="l8.468" class="difflineplus">+    {&quot;image/jpeg&quot;, &quot;\377\330\377&quot;, 0},</span>
<a href="#l8.469"></a><span id="l8.469" class="difflineplus">+    {&quot;video/mpeg&quot;, &quot;\0\0\001\263&quot;, 4},</span>
<a href="#l8.470"></a><span id="l8.470" class="difflineplus">+    {&quot;application/postscript&quot;, &quot;%!&quot;, 0},</span>
<a href="#l8.471"></a><span id="l8.471"> };</span>
<a href="#l8.472"></a><span id="l8.472"> static int num_magic = MOZ_ARRAY_LENGTH(magic);</span>
<a href="#l8.473"></a><span id="l8.473"> </span>
<a href="#l8.474"></a><span id="l8.474" class="difflineminus">-static const char *text_type    = TEXT_PLAIN;          /* the text file type. */</span>
<a href="#l8.475"></a><span id="l8.475" class="difflineplus">+static const char *text_type = TEXT_PLAIN; /* the text file type. */</span>
<a href="#l8.476"></a><span id="l8.476"> static const char *default_type = APPLICATION_OCTET_STREAM;</span>
<a href="#l8.477"></a><span id="l8.477"> </span>
<a href="#l8.478"></a><span id="l8.478" class="difflineminus">-</span>
<a href="#l8.479"></a><span id="l8.479"> /*</span>
<a href="#l8.480"></a><span id="l8.480">  * Determines the format of the file &quot;inputf&quot;.  The name</span>
<a href="#l8.481"></a><span id="l8.481">  * of the file format (or NULL on error) is returned.</span>
<a href="#l8.482"></a><span id="l8.482">  */</span>
<a href="#l8.483"></a><span id="l8.483" class="difflineminus">-static const char *magic_look(char *inbuff, int numread)</span>
<a href="#l8.484"></a><span id="l8.484" class="difflineminus">-{</span>
<a href="#l8.485"></a><span id="l8.485" class="difflineplus">+static const char *magic_look(char *inbuff, int numread) {</span>
<a href="#l8.486"></a><span id="l8.486">   int i, j;</span>
<a href="#l8.487"></a><span id="l8.487"> </span>
<a href="#l8.488"></a><span id="l8.488" class="difflineminus">-  for (i=0; i&lt;num_magic; i++)</span>
<a href="#l8.489"></a><span id="l8.489" class="difflineminus">-  {</span>
<a href="#l8.490"></a><span id="l8.490" class="difflineminus">-    if (magic[i].len == 0)</span>
<a href="#l8.491"></a><span id="l8.491" class="difflineminus">-      magic[i].len = strlen(magic[i].num);</span>
<a href="#l8.492"></a><span id="l8.492" class="difflineplus">+  for (i = 0; i &lt; num_magic; i++) {</span>
<a href="#l8.493"></a><span id="l8.493" class="difflineplus">+    if (magic[i].len == 0) magic[i].len = strlen(magic[i].num);</span>
<a href="#l8.494"></a><span id="l8.494">   }</span>
<a href="#l8.495"></a><span id="l8.495"> </span>
<a href="#l8.496"></a><span id="l8.496" class="difflineminus">-  for (i=0; i&lt;num_magic; i++)</span>
<a href="#l8.497"></a><span id="l8.497" class="difflineminus">-  {</span>
<a href="#l8.498"></a><span id="l8.498" class="difflineminus">-    if (numread &gt;= magic[i].len)</span>
<a href="#l8.499"></a><span id="l8.499" class="difflineminus">-    {</span>
<a href="#l8.500"></a><span id="l8.500" class="difflineminus">-      for (j=0; j&lt;magic[i].len; j++)</span>
<a href="#l8.501"></a><span id="l8.501" class="difflineminus">-      {</span>
<a href="#l8.502"></a><span id="l8.502" class="difflineplus">+  for (i = 0; i &lt; num_magic; i++) {</span>
<a href="#l8.503"></a><span id="l8.503" class="difflineplus">+    if (numread &gt;= magic[i].len) {</span>
<a href="#l8.504"></a><span id="l8.504" class="difflineplus">+      for (j = 0; j &lt; magic[i].len; j++) {</span>
<a href="#l8.505"></a><span id="l8.505">         if (inbuff[j] != magic[i].num[j]) break;</span>
<a href="#l8.506"></a><span id="l8.506">       }</span>
<a href="#l8.507"></a><span id="l8.507" class="difflineminus">-      </span>
<a href="#l8.508"></a><span id="l8.508" class="difflineminus">-      if (j == magic[i].len)</span>
<a href="#l8.509"></a><span id="l8.509" class="difflineminus">-        return magic[i].name;</span>
<a href="#l8.510"></a><span id="l8.510" class="difflineplus">+</span>
<a href="#l8.511"></a><span id="l8.511" class="difflineplus">+      if (j == magic[i].len) return magic[i].name;</span>
<a href="#l8.512"></a><span id="l8.512">     }</span>
<a href="#l8.513"></a><span id="l8.513">   }</span>
<a href="#l8.514"></a><span id="l8.514"> </span>
<a href="#l8.515"></a><span id="l8.515">   return default_type;</span>
<a href="#l8.516"></a><span id="l8.516"> }</span>
<a href="#l8.517"></a><span id="l8.517"> /*</span>
<a href="#l8.518"></a><span id="l8.518"> **  ap_encode_data</span>
<a href="#l8.519"></a><span id="l8.519"> **</span>
<a href="#l8.520"></a><span id="l8.520"> **  ---------------</span>
<a href="#l8.521"></a><span id="l8.521"> **</span>
<a href="#l8.522"></a><span id="l8.522"> **    encode on the data fork.</span>
<a href="#l8.523"></a><span id="l8.523"> **</span>
<a href="#l8.524"></a><span id="l8.524"> */</span>
<a href="#l8.525"></a><span id="l8.525" class="difflineminus">-int ap_encode_data(</span>
<a href="#l8.526"></a><span id="l8.526" class="difflineminus">-  appledouble_encode_object* p_ap_encode_obj,</span>
<a href="#l8.527"></a><span id="l8.527" class="difflineminus">-  bool firstime)</span>
<a href="#l8.528"></a><span id="l8.528" class="difflineminus">-{</span>
<a href="#l8.529"></a><span id="l8.529" class="difflineminus">-  char       rd_buff[256];</span>
<a href="#l8.530"></a><span id="l8.530" class="difflineplus">+int ap_encode_data(appledouble_encode_object *p_ap_encode_obj, bool firstime) {</span>
<a href="#l8.531"></a><span id="l8.531" class="difflineplus">+  char rd_buff[256];</span>
<a href="#l8.532"></a><span id="l8.532">   FSIORefNum fileId;</span>
<a href="#l8.533"></a><span id="l8.533" class="difflineminus">-  OSErr      retval = noErr;</span>
<a href="#l8.534"></a><span id="l8.534" class="difflineminus">-  ByteCount  in_count;</span>
<a href="#l8.535"></a><span id="l8.535" class="difflineminus">-  int        status;</span>
<a href="#l8.536"></a><span id="l8.536" class="difflineplus">+  OSErr retval = noErr;</span>
<a href="#l8.537"></a><span id="l8.537" class="difflineplus">+  ByteCount in_count;</span>
<a href="#l8.538"></a><span id="l8.538" class="difflineplus">+  int status;</span>
<a href="#l8.539"></a><span id="l8.539"> </span>
<a href="#l8.540"></a><span id="l8.540" class="difflineminus">-  if (firstime)</span>
<a href="#l8.541"></a><span id="l8.541" class="difflineminus">-  {</span>
<a href="#l8.542"></a><span id="l8.542" class="difflineminus">-    const char* magic_type;</span>
<a href="#l8.543"></a><span id="l8.543" class="difflineplus">+  if (firstime) {</span>
<a href="#l8.544"></a><span id="l8.544" class="difflineplus">+    const char *magic_type;</span>
<a href="#l8.545"></a><span id="l8.545"> </span>
<a href="#l8.546"></a><span id="l8.546">     /*</span>
<a href="#l8.547"></a><span id="l8.547">     ** preparing to encode the data fork.</span>
<a href="#l8.548"></a><span id="l8.548">     */</span>
<a href="#l8.549"></a><span id="l8.549" class="difflineminus">-    nsCOMPtr &lt;nsIFile&gt; resFile;</span>
<a href="#l8.550"></a><span id="l8.550" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; resFile;</span>
<a href="#l8.551"></a><span id="l8.551">     NS_NewNativeLocalFile(nsDependentCString(p_ap_encode_obj-&gt;fname), true,</span>
<a href="#l8.552"></a><span id="l8.552">                           getter_AddRefs(resFile));</span>
<a href="#l8.553"></a><span id="l8.553" class="difflineminus">-    if (!resFile)</span>
<a href="#l8.554"></a><span id="l8.554" class="difflineminus">-        return errFileOpen;</span>
<a href="#l8.555"></a><span id="l8.555" class="difflineplus">+    if (!resFile) return errFileOpen;</span>
<a href="#l8.556"></a><span id="l8.556"> </span>
<a href="#l8.557"></a><span id="l8.557">     FSRef ref;</span>
<a href="#l8.558"></a><span id="l8.558" class="difflineminus">-    nsCOMPtr &lt;nsILocalFileMac&gt; macFile = do_QueryInterface(resFile);</span>
<a href="#l8.559"></a><span id="l8.559" class="difflineminus">-    if (NS_FAILED(macFile-&gt;GetFSRef(&amp;ref)))</span>
<a href="#l8.560"></a><span id="l8.560" class="difflineminus">-        return errFileOpen;</span>
<a href="#l8.561"></a><span id="l8.561" class="difflineplus">+    nsCOMPtr&lt;nsILocalFileMac&gt; macFile = do_QueryInterface(resFile);</span>
<a href="#l8.562"></a><span id="l8.562" class="difflineplus">+    if (NS_FAILED(macFile-&gt;GetFSRef(&amp;ref))) return errFileOpen;</span>
<a href="#l8.563"></a><span id="l8.563"> </span>
<a href="#l8.564"></a><span id="l8.564">     HFSUniStr255 forkName;</span>
<a href="#l8.565"></a><span id="l8.565">     ::FSGetDataForkName(&amp;forkName);</span>
<a href="#l8.566"></a><span id="l8.566" class="difflineminus">-    retval = ::FSOpenFork(&amp;ref, forkName.length, forkName.unicode, fsRdPerm, &amp;fileId);</span>
<a href="#l8.567"></a><span id="l8.567" class="difflineminus">-    if (retval != noErr)</span>
<a href="#l8.568"></a><span id="l8.568" class="difflineminus">-        return retval;</span>
<a href="#l8.569"></a><span id="l8.569" class="difflineplus">+    retval = ::FSOpenFork(&amp;ref, forkName.length, forkName.unicode, fsRdPerm,</span>
<a href="#l8.570"></a><span id="l8.570" class="difflineplus">+                          &amp;fileId);</span>
<a href="#l8.571"></a><span id="l8.571" class="difflineplus">+    if (retval != noErr) return retval;</span>
<a href="#l8.572"></a><span id="l8.572"> </span>
<a href="#l8.573"></a><span id="l8.573">     p_ap_encode_obj-&gt;fileId = fileId;</span>
<a href="#l8.574"></a><span id="l8.574"> </span>
<a href="#l8.575"></a><span id="l8.575" class="difflineminus">-    if (!p_ap_encode_obj-&gt;text_file_type)</span>
<a href="#l8.576"></a><span id="l8.576" class="difflineminus">-    {</span>
<a href="#l8.577"></a><span id="l8.577" class="difflineplus">+    if (!p_ap_encode_obj-&gt;text_file_type) {</span>
<a href="#l8.578"></a><span id="l8.578">       /*</span>
<a href="#l8.579"></a><span id="l8.579">       **  do a smart check for the file type.</span>
<a href="#l8.580"></a><span id="l8.580">       */</span>
<a href="#l8.581"></a><span id="l8.581">       in_count = 0;</span>
<a href="#l8.582"></a><span id="l8.582">       retval = ::FSReadFork(fileId, fsFromStart, 0, 256, rd_buff, &amp;in_count);</span>
<a href="#l8.583"></a><span id="l8.583">       magic_type = magic_look(rd_buff, in_count);</span>
<a href="#l8.584"></a><span id="l8.584"> </span>
<a href="#l8.585"></a><span id="l8.585">       /* don't forget to rewind the index to start point. */</span>
<a href="#l8.586"></a><span id="l8.586">       ::FSSetForkPosition(fileId, fsFromStart, 0);</span>
<a href="#l8.587"></a><span id="l8.587">       /* and reset retVal just in case... */</span>
<a href="#l8.588"></a><span id="l8.588" class="difflineminus">-      if (retval == eofErr)</span>
<a href="#l8.589"></a><span id="l8.589" class="difflineminus">-        retval = noErr;</span>
<a href="#l8.590"></a><span id="l8.590" class="difflineminus">-    }</span>
<a href="#l8.591"></a><span id="l8.591" class="difflineminus">-    else</span>
<a href="#l8.592"></a><span id="l8.592" class="difflineminus">-    {</span>
<a href="#l8.593"></a><span id="l8.593" class="difflineminus">-      magic_type = text_type;    /* we already know it is a text type.  */</span>
<a href="#l8.594"></a><span id="l8.594" class="difflineplus">+      if (retval == eofErr) retval = noErr;</span>
<a href="#l8.595"></a><span id="l8.595" class="difflineplus">+    } else {</span>
<a href="#l8.596"></a><span id="l8.596" class="difflineplus">+      magic_type = text_type; /* we already know it is a text type.  */</span>
<a href="#l8.597"></a><span id="l8.597">     }</span>
<a href="#l8.598"></a><span id="l8.598"> </span>
<a href="#l8.599"></a><span id="l8.599">     /*</span>
<a href="#l8.600"></a><span id="l8.600">     **  the data portion header information.</span>
<a href="#l8.601"></a><span id="l8.601">     */</span>
<a href="#l8.602"></a><span id="l8.602" class="difflineminus">-        nsAutoCString leafName;</span>
<a href="#l8.603"></a><span id="l8.603" class="difflineminus">-        resFile-&gt;GetNativeLeafName(leafName);</span>
<a href="#l8.604"></a><span id="l8.604" class="difflineplus">+    nsAutoCString leafName;</span>
<a href="#l8.605"></a><span id="l8.605" class="difflineplus">+    resFile-&gt;GetNativeLeafName(leafName);</span>
<a href="#l8.606"></a><span id="l8.606">     PR_snprintf(rd_buff, sizeof(rd_buff),</span>
<a href="#l8.607"></a><span id="l8.607" class="difflineminus">-      &quot;Content-Type: %s; name=\&quot;%s\&quot;&quot; CRLF &quot;Content-Transfer-Encoding: base64&quot; CRLF &quot;Content-Disposition: inline; filename=\&quot;%s\&quot;&quot; CRLF CRLF,</span>
<a href="#l8.608"></a><span id="l8.608" class="difflineminus">-      magic_type,</span>
<a href="#l8.609"></a><span id="l8.609" class="difflineminus">-      leafName.get(),</span>
<a href="#l8.610"></a><span id="l8.610" class="difflineminus">-      leafName.get());</span>
<a href="#l8.611"></a><span id="l8.611" class="difflineplus">+                &quot;Content-Type: %s; name=\&quot;%s\&quot;&quot; CRLF</span>
<a href="#l8.612"></a><span id="l8.612" class="difflineplus">+                &quot;Content-Transfer-Encoding: base64&quot; CRLF</span>
<a href="#l8.613"></a><span id="l8.613" class="difflineplus">+                &quot;Content-Disposition: inline; filename=\&quot;%s\&quot;&quot; CRLF CRLF,</span>
<a href="#l8.614"></a><span id="l8.614" class="difflineplus">+                magic_type, leafName.get(), leafName.get());</span>
<a href="#l8.615"></a><span id="l8.615"> </span>
<a href="#l8.616"></a><span id="l8.616" class="difflineminus">-    status = write_stream(p_ap_encode_obj, (const char*)rd_buff, strlen(rd_buff));</span>
<a href="#l8.617"></a><span id="l8.617" class="difflineminus">-    if (status != noErr)</span>
<a href="#l8.618"></a><span id="l8.618" class="difflineminus">-      return status;</span>
<a href="#l8.619"></a><span id="l8.619" class="difflineplus">+    status =</span>
<a href="#l8.620"></a><span id="l8.620" class="difflineplus">+        write_stream(p_ap_encode_obj, (const char *)rd_buff, strlen(rd_buff));</span>
<a href="#l8.621"></a><span id="l8.621" class="difflineplus">+    if (status != noErr) return status;</span>
<a href="#l8.622"></a><span id="l8.622">   }</span>
<a href="#l8.623"></a><span id="l8.623"> </span>
<a href="#l8.624"></a><span id="l8.624" class="difflineminus">-  while (retval == noErr)</span>
<a href="#l8.625"></a><span id="l8.625" class="difflineminus">-  {</span>
<a href="#l8.626"></a><span id="l8.626" class="difflineminus">-    if (BUFF_LEFT(p_ap_encode_obj) &lt; 400)</span>
<a href="#l8.627"></a><span id="l8.627" class="difflineminus">-      break;</span>
<a href="#l8.628"></a><span id="l8.628" class="difflineplus">+  while (retval == noErr) {</span>
<a href="#l8.629"></a><span id="l8.629" class="difflineplus">+    if (BUFF_LEFT(p_ap_encode_obj) &lt; 400) break;</span>
<a href="#l8.630"></a><span id="l8.630"> </span>
<a href="#l8.631"></a><span id="l8.631">     in_count = 0;</span>
<a href="#l8.632"></a><span id="l8.632" class="difflineminus">-    retval = ::FSReadFork(p_ap_encode_obj-&gt;fileId, fsAtMark, 0, 256, rd_buff, &amp;in_count);</span>
<a href="#l8.633"></a><span id="l8.633" class="difflineminus">-    if (in_count)</span>
<a href="#l8.634"></a><span id="l8.634" class="difflineminus">-    {</span>
<a href="#l8.635"></a><span id="l8.635" class="difflineplus">+    retval = ::FSReadFork(p_ap_encode_obj-&gt;fileId, fsAtMark, 0, 256, rd_buff,</span>
<a href="#l8.636"></a><span id="l8.636" class="difflineplus">+                          &amp;in_count);</span>
<a href="#l8.637"></a><span id="l8.637" class="difflineplus">+    if (in_count) {</span>
<a href="#l8.638"></a><span id="l8.638"> #if 0</span>
<a href="#l8.639"></a><span id="l8.639"> /*      replace(rd_buff, in_count, '\r', '\n');               */</span>
<a href="#l8.640"></a><span id="l8.640"> #endif</span>
<a href="#l8.641"></a><span id="l8.641" class="difflineminus">-/* ** may be need to do character set conversion here for localization.  **  */</span>
<a href="#l8.642"></a><span id="l8.642" class="difflineminus">-      status = to64(p_ap_encode_obj,</span>
<a href="#l8.643"></a><span id="l8.643" class="difflineminus">-                    rd_buff,</span>
<a href="#l8.644"></a><span id="l8.644" class="difflineminus">-                    in_count);</span>
<a href="#l8.645"></a><span id="l8.645" class="difflineminus">-      if (status != noErr)</span>
<a href="#l8.646"></a><span id="l8.646" class="difflineminus">-        return status;</span>
<a href="#l8.647"></a><span id="l8.647" class="difflineplus">+      /* ** may be need to do character set conversion here for localization.</span>
<a href="#l8.648"></a><span id="l8.648" class="difflineplus">+       * **  */</span>
<a href="#l8.649"></a><span id="l8.649" class="difflineplus">+      status = to64(p_ap_encode_obj, rd_buff, in_count);</span>
<a href="#l8.650"></a><span id="l8.650" class="difflineplus">+      if (status != noErr) return status;</span>
<a href="#l8.651"></a><span id="l8.651">     }</span>
<a href="#l8.652"></a><span id="l8.652">   }</span>
<a href="#l8.653"></a><span id="l8.653"> </span>
<a href="#l8.654"></a><span id="l8.654" class="difflineminus">-  if (retval == eofErr)</span>
<a href="#l8.655"></a><span id="l8.655" class="difflineminus">-  {</span>
<a href="#l8.656"></a><span id="l8.656" class="difflineplus">+  if (retval == eofErr) {</span>
<a href="#l8.657"></a><span id="l8.657">     ::FSCloseFork(p_ap_encode_obj-&gt;fileId);</span>
<a href="#l8.658"></a><span id="l8.658">     p_ap_encode_obj-&gt;fileId = 0;</span>
<a href="#l8.659"></a><span id="l8.659"> </span>
<a href="#l8.660"></a><span id="l8.660">     status = finish64(p_ap_encode_obj);</span>
<a href="#l8.661"></a><span id="l8.661" class="difflineminus">-    if (status != noErr)</span>
<a href="#l8.662"></a><span id="l8.662" class="difflineminus">-      return status;</span>
<a href="#l8.663"></a><span id="l8.663" class="difflineplus">+    if (status != noErr) return status;</span>
<a href="#l8.664"></a><span id="l8.664"> </span>
<a href="#l8.665"></a><span id="l8.665">     /* write out the boundary   */</span>
<a href="#l8.666"></a><span id="l8.666"> </span>
<a href="#l8.667"></a><span id="l8.667" class="difflineminus">-    PR_snprintf(rd_buff, sizeof(rd_buff),</span>
<a href="#l8.668"></a><span id="l8.668" class="difflineminus">-                CRLF &quot;--%s--&quot; CRLF CRLF,</span>
<a href="#l8.669"></a><span id="l8.669" class="difflineplus">+    PR_snprintf(rd_buff, sizeof(rd_buff), CRLF &quot;--%s--&quot; CRLF CRLF,</span>
<a href="#l8.670"></a><span id="l8.670">                 p_ap_encode_obj-&gt;boundary);</span>
<a href="#l8.671"></a><span id="l8.671"> </span>
<a href="#l8.672"></a><span id="l8.672" class="difflineminus">-    status = write_stream(p_ap_encode_obj, (const char*)rd_buff, strlen(rd_buff));</span>
<a href="#l8.673"></a><span id="l8.673" class="difflineplus">+    status =</span>
<a href="#l8.674"></a><span id="l8.674" class="difflineplus">+        write_stream(p_ap_encode_obj, (const char *)rd_buff, strlen(rd_buff));</span>
<a href="#l8.675"></a><span id="l8.675"> </span>
<a href="#l8.676"></a><span id="l8.676" class="difflineminus">-    if (status == noErr)</span>
<a href="#l8.677"></a><span id="l8.677" class="difflineminus">-      status = errDone;</span>
<a href="#l8.678"></a><span id="l8.678" class="difflineplus">+    if (status == noErr) status = errDone;</span>
<a href="#l8.679"></a><span id="l8.679">   }</span>
<a href="#l8.680"></a><span id="l8.680">   return status;</span>
<a href="#l8.681"></a><span id="l8.681"> }</span>
<a href="#l8.682"></a><span id="l8.682"> </span>
<a href="#l8.683"></a><span id="l8.683"> static char basis_64[] =</span>
<a href="#l8.684"></a><span id="l8.684" class="difflineminus">-   &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;;</span>
<a href="#l8.685"></a><span id="l8.685" class="difflineplus">+    &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;;</span>
<a href="#l8.686"></a><span id="l8.686"> </span>
<a href="#l8.687"></a><span id="l8.687"> /*</span>
<a href="#l8.688"></a><span id="l8.688"> **  convert the stream in the inbuff to 64 format and put it in the out buff.</span>
<a href="#l8.689"></a><span id="l8.689" class="difflineminus">-**  To make the life easier, the caller will responcable of the checking of the outbuff's bundary.</span>
<a href="#l8.690"></a><span id="l8.690" class="difflineplus">+**  To make the life easier, the caller will responcable of the checking of the</span>
<a href="#l8.691"></a><span id="l8.691" class="difflineplus">+*outbuff's bundary.</span>
<a href="#l8.692"></a><span id="l8.692"> */</span>
<a href="#l8.693"></a><span id="l8.693" class="difflineminus">-static int</span>
<a href="#l8.694"></a><span id="l8.694" class="difflineminus">-to64(appledouble_encode_object* p_ap_encode_obj,</span>
<a href="#l8.695"></a><span id="l8.695" class="difflineminus">-  char  *p,</span>
<a href="#l8.696"></a><span id="l8.696" class="difflineminus">-  int   in_size)</span>
<a href="#l8.697"></a><span id="l8.697" class="difflineminus">-{</span>
<a href="#l8.698"></a><span id="l8.698" class="difflineminus">-  int   status;</span>
<a href="#l8.699"></a><span id="l8.699" class="difflineplus">+static int to64(appledouble_encode_object *p_ap_encode_obj, char *p,</span>
<a href="#l8.700"></a><span id="l8.700" class="difflineplus">+                int in_size) {</span>
<a href="#l8.701"></a><span id="l8.701" class="difflineplus">+  int status;</span>
<a href="#l8.702"></a><span id="l8.702">   int c1, c2, c3, ct;</span>
<a href="#l8.703"></a><span id="l8.703" class="difflineminus">-  unsigned char *inbuff = (unsigned char*)p;</span>
<a href="#l8.704"></a><span id="l8.704" class="difflineplus">+  unsigned char *inbuff = (unsigned char *)p;</span>
<a href="#l8.705"></a><span id="l8.705"> </span>
<a href="#l8.706"></a><span id="l8.706" class="difflineminus">-  ct = p_ap_encode_obj-&gt;ct;      /* the char count left last time. */</span>
<a href="#l8.707"></a><span id="l8.707" class="difflineplus">+  ct = p_ap_encode_obj-&gt;ct; /* the char count left last time. */</span>
<a href="#l8.708"></a><span id="l8.708"> </span>
<a href="#l8.709"></a><span id="l8.709">   /*</span>
<a href="#l8.710"></a><span id="l8.710">   **   resume the left state of the last conversion.</span>
<a href="#l8.711"></a><span id="l8.711">   */</span>
<a href="#l8.712"></a><span id="l8.712" class="difflineminus">-  switch (p_ap_encode_obj-&gt;state64)</span>
<a href="#l8.713"></a><span id="l8.713" class="difflineminus">-  {</span>
<a href="#l8.714"></a><span id="l8.714" class="difflineplus">+  switch (p_ap_encode_obj-&gt;state64) {</span>
<a href="#l8.715"></a><span id="l8.715">     case 0:</span>
<a href="#l8.716"></a><span id="l8.716" class="difflineminus">-      p_ap_encode_obj-&gt;c1 = c1 = *inbuff ++;</span>
<a href="#l8.717"></a><span id="l8.717" class="difflineminus">-      if (--in_size &lt;= 0)</span>
<a href="#l8.718"></a><span id="l8.718" class="difflineminus">-      {</span>
<a href="#l8.719"></a><span id="l8.719" class="difflineplus">+      p_ap_encode_obj-&gt;c1 = c1 = *inbuff++;</span>
<a href="#l8.720"></a><span id="l8.720" class="difflineplus">+      if (--in_size &lt;= 0) {</span>
<a href="#l8.721"></a><span id="l8.721">         p_ap_encode_obj-&gt;state64 = 1;</span>
<a href="#l8.722"></a><span id="l8.722">         return noErr;</span>
<a href="#l8.723"></a><span id="l8.723">       }</span>
<a href="#l8.724"></a><span id="l8.724" class="difflineminus">-      p_ap_encode_obj-&gt;c2 = c2 = *inbuff ++;</span>
<a href="#l8.725"></a><span id="l8.725" class="difflineminus">-      if (--in_size &lt;= 0)</span>
<a href="#l8.726"></a><span id="l8.726" class="difflineminus">-      {</span>
<a href="#l8.727"></a><span id="l8.727" class="difflineplus">+      p_ap_encode_obj-&gt;c2 = c2 = *inbuff++;</span>
<a href="#l8.728"></a><span id="l8.728" class="difflineplus">+      if (--in_size &lt;= 0) {</span>
<a href="#l8.729"></a><span id="l8.729">         p_ap_encode_obj-&gt;state64 = 2;</span>
<a href="#l8.730"></a><span id="l8.730">         return noErr;</span>
<a href="#l8.731"></a><span id="l8.731">       }</span>
<a href="#l8.732"></a><span id="l8.732" class="difflineminus">-      c3 = *inbuff ++;    --in_size;</span>
<a href="#l8.733"></a><span id="l8.733" class="difflineplus">+      c3 = *inbuff++;</span>
<a href="#l8.734"></a><span id="l8.734" class="difflineplus">+      --in_size;</span>
<a href="#l8.735"></a><span id="l8.735">       break;</span>
<a href="#l8.736"></a><span id="l8.736">     case 1:</span>
<a href="#l8.737"></a><span id="l8.737">       c1 = p_ap_encode_obj-&gt;c1;</span>
<a href="#l8.738"></a><span id="l8.738" class="difflineminus">-      p_ap_encode_obj-&gt;c2 = c2 = *inbuff ++;</span>
<a href="#l8.739"></a><span id="l8.739" class="difflineminus">-      if (--in_size &lt;= 0)</span>
<a href="#l8.740"></a><span id="l8.740" class="difflineminus">-      {</span>
<a href="#l8.741"></a><span id="l8.741" class="difflineplus">+      p_ap_encode_obj-&gt;c2 = c2 = *inbuff++;</span>
<a href="#l8.742"></a><span id="l8.742" class="difflineplus">+      if (--in_size &lt;= 0) {</span>
<a href="#l8.743"></a><span id="l8.743">         p_ap_encode_obj-&gt;state64 = 2;</span>
<a href="#l8.744"></a><span id="l8.744">         return noErr;</span>
<a href="#l8.745"></a><span id="l8.745">       }</span>
<a href="#l8.746"></a><span id="l8.746" class="difflineminus">-      c3 = *inbuff ++;    --in_size;</span>
<a href="#l8.747"></a><span id="l8.747" class="difflineplus">+      c3 = *inbuff++;</span>
<a href="#l8.748"></a><span id="l8.748" class="difflineplus">+      --in_size;</span>
<a href="#l8.749"></a><span id="l8.749">       break;</span>
<a href="#l8.750"></a><span id="l8.750">     case 2:</span>
<a href="#l8.751"></a><span id="l8.751">       c1 = p_ap_encode_obj-&gt;c1;</span>
<a href="#l8.752"></a><span id="l8.752">       c2 = p_ap_encode_obj-&gt;c2;</span>
<a href="#l8.753"></a><span id="l8.753" class="difflineminus">-      c3 = *inbuff ++;    --in_size;</span>
<a href="#l8.754"></a><span id="l8.754" class="difflineplus">+      c3 = *inbuff++;</span>
<a href="#l8.755"></a><span id="l8.755" class="difflineplus">+      --in_size;</span>
<a href="#l8.756"></a><span id="l8.756">       break;</span>
<a href="#l8.757"></a><span id="l8.757">   }</span>
<a href="#l8.758"></a><span id="l8.758"> </span>
<a href="#l8.759"></a><span id="l8.759" class="difflineminus">-  while (in_size &gt;= 0)</span>
<a href="#l8.760"></a><span id="l8.760" class="difflineminus">-  {</span>
<a href="#l8.761"></a><span id="l8.761" class="difflineminus">-    status = output64chunk(p_ap_encode_obj,</span>
<a href="#l8.762"></a><span id="l8.762" class="difflineminus">-                           c1,</span>
<a href="#l8.763"></a><span id="l8.763" class="difflineminus">-                           c2,</span>
<a href="#l8.764"></a><span id="l8.764" class="difflineminus">-                           c3,</span>
<a href="#l8.765"></a><span id="l8.765" class="difflineminus">-                           0);</span>
<a href="#l8.766"></a><span id="l8.766" class="difflineminus">-    if (status != noErr)</span>
<a href="#l8.767"></a><span id="l8.767" class="difflineminus">-      return status;</span>
<a href="#l8.768"></a><span id="l8.768" class="difflineminus">-  </span>
<a href="#l8.769"></a><span id="l8.769" class="difflineplus">+  while (in_size &gt;= 0) {</span>
<a href="#l8.770"></a><span id="l8.770" class="difflineplus">+    status = output64chunk(p_ap_encode_obj, c1, c2, c3, 0);</span>
<a href="#l8.771"></a><span id="l8.771" class="difflineplus">+    if (status != noErr) return status;</span>
<a href="#l8.772"></a><span id="l8.772" class="difflineplus">+</span>
<a href="#l8.773"></a><span id="l8.773">     ct += 4;</span>
<a href="#l8.774"></a><span id="l8.774" class="difflineminus">-    if (ct &gt; 71)</span>
<a href="#l8.775"></a><span id="l8.775" class="difflineminus">-    {</span>
<a href="#l8.776"></a><span id="l8.776" class="difflineminus">-      status = write_stream(p_ap_encode_obj,</span>
<a href="#l8.777"></a><span id="l8.777" class="difflineminus">-                CRLF,</span>
<a href="#l8.778"></a><span id="l8.778" class="difflineminus">-                2);</span>
<a href="#l8.779"></a><span id="l8.779" class="difflineminus">-      if (status != noErr)</span>
<a href="#l8.780"></a><span id="l8.780" class="difflineminus">-        return status;</span>
<a href="#l8.781"></a><span id="l8.781" class="difflineminus">-    </span>
<a href="#l8.782"></a><span id="l8.782" class="difflineplus">+    if (ct &gt; 71) {</span>
<a href="#l8.783"></a><span id="l8.783" class="difflineplus">+      status = write_stream(p_ap_encode_obj, CRLF, 2);</span>
<a href="#l8.784"></a><span id="l8.784" class="difflineplus">+      if (status != noErr) return status;</span>
<a href="#l8.785"></a><span id="l8.785" class="difflineplus">+</span>
<a href="#l8.786"></a><span id="l8.786">       ct = 0;</span>
<a href="#l8.787"></a><span id="l8.787">     }</span>
<a href="#l8.788"></a><span id="l8.788"> </span>
<a href="#l8.789"></a><span id="l8.789" class="difflineminus">-    if (in_size &lt;= 0)</span>
<a href="#l8.790"></a><span id="l8.790" class="difflineminus">-    {</span>
<a href="#l8.791"></a><span id="l8.791" class="difflineplus">+    if (in_size &lt;= 0) {</span>
<a href="#l8.792"></a><span id="l8.792">       p_ap_encode_obj-&gt;state64 = 0;</span>
<a href="#l8.793"></a><span id="l8.793">       break;</span>
<a href="#l8.794"></a><span id="l8.794">     }</span>
<a href="#l8.795"></a><span id="l8.795"> </span>
<a href="#l8.796"></a><span id="l8.796">     c1 = (int)*inbuff++;</span>
<a href="#l8.797"></a><span id="l8.797" class="difflineminus">-    if (--in_size &lt;= 0)</span>
<a href="#l8.798"></a><span id="l8.798" class="difflineminus">-    {</span>
<a href="#l8.799"></a><span id="l8.799" class="difflineplus">+    if (--in_size &lt;= 0) {</span>
<a href="#l8.800"></a><span id="l8.800">       p_ap_encode_obj-&gt;c1 = c1;</span>
<a href="#l8.801"></a><span id="l8.801">       p_ap_encode_obj-&gt;state64 = 1;</span>
<a href="#l8.802"></a><span id="l8.802">       break;</span>
<a href="#l8.803"></a><span id="l8.803">     }</span>
<a href="#l8.804"></a><span id="l8.804">     c2 = *inbuff++;</span>
<a href="#l8.805"></a><span id="l8.805" class="difflineminus">-    if (--in_size &lt;= 0)</span>
<a href="#l8.806"></a><span id="l8.806" class="difflineminus">-    {</span>
<a href="#l8.807"></a><span id="l8.807" class="difflineminus">-      p_ap_encode_obj-&gt;c1    = c1;</span>
<a href="#l8.808"></a><span id="l8.808" class="difflineminus">-      p_ap_encode_obj-&gt;c2    = c2;</span>
<a href="#l8.809"></a><span id="l8.809" class="difflineplus">+    if (--in_size &lt;= 0) {</span>
<a href="#l8.810"></a><span id="l8.810" class="difflineplus">+      p_ap_encode_obj-&gt;c1 = c1;</span>
<a href="#l8.811"></a><span id="l8.811" class="difflineplus">+      p_ap_encode_obj-&gt;c2 = c2;</span>
<a href="#l8.812"></a><span id="l8.812">       p_ap_encode_obj-&gt;state64 = 2;</span>
<a href="#l8.813"></a><span id="l8.813">       break;</span>
<a href="#l8.814"></a><span id="l8.814">     }</span>
<a href="#l8.815"></a><span id="l8.815">     c3 = *inbuff++;</span>
<a href="#l8.816"></a><span id="l8.816">     in_size--;</span>
<a href="#l8.817"></a><span id="l8.817">   }</span>
<a href="#l8.818"></a><span id="l8.818">   p_ap_encode_obj-&gt;ct = ct;</span>
<a href="#l8.819"></a><span id="l8.819">   return status;</span>
<a href="#l8.820"></a><span id="l8.820"> }</span>
<a href="#l8.821"></a><span id="l8.821"> </span>
<a href="#l8.822"></a><span id="l8.822"> /*</span>
<a href="#l8.823"></a><span id="l8.823"> ** clear the left base64 encodes.</span>
<a href="#l8.824"></a><span id="l8.824"> */</span>
<a href="#l8.825"></a><span id="l8.825" class="difflineminus">-static int</span>
<a href="#l8.826"></a><span id="l8.826" class="difflineminus">-finish64(appledouble_encode_object* p_ap_encode_obj)</span>
<a href="#l8.827"></a><span id="l8.827" class="difflineminus">-{</span>
<a href="#l8.828"></a><span id="l8.828" class="difflineplus">+static int finish64(appledouble_encode_object *p_ap_encode_obj) {</span>
<a href="#l8.829"></a><span id="l8.829">   int status;</span>
<a href="#l8.830"></a><span id="l8.830"> </span>
<a href="#l8.831"></a><span id="l8.831" class="difflineminus">-  switch (p_ap_encode_obj-&gt;state64)</span>
<a href="#l8.832"></a><span id="l8.832" class="difflineminus">-  {</span>
<a href="#l8.833"></a><span id="l8.833" class="difflineplus">+  switch (p_ap_encode_obj-&gt;state64) {</span>
<a href="#l8.834"></a><span id="l8.834">     case 0:</span>
<a href="#l8.835"></a><span id="l8.835">       break;</span>
<a href="#l8.836"></a><span id="l8.836">     case 1:</span>
<a href="#l8.837"></a><span id="l8.837" class="difflineminus">-      status = output64chunk(p_ap_encode_obj,</span>
<a href="#l8.838"></a><span id="l8.838" class="difflineminus">-                             p_ap_encode_obj-&gt;c1,</span>
<a href="#l8.839"></a><span id="l8.839" class="difflineminus">-                             0,</span>
<a href="#l8.840"></a><span id="l8.840" class="difflineminus">-                             0,</span>
<a href="#l8.841"></a><span id="l8.841" class="difflineminus">-                             2);</span>
<a href="#l8.842"></a><span id="l8.842" class="difflineplus">+      status = output64chunk(p_ap_encode_obj, p_ap_encode_obj-&gt;c1, 0, 0, 2);</span>
<a href="#l8.843"></a><span id="l8.843">       break;</span>
<a href="#l8.844"></a><span id="l8.844">     case 2:</span>
<a href="#l8.845"></a><span id="l8.845" class="difflineminus">-      status = output64chunk(p_ap_encode_obj,</span>
<a href="#l8.846"></a><span id="l8.846" class="difflineminus">-                             p_ap_encode_obj-&gt;c1,</span>
<a href="#l8.847"></a><span id="l8.847" class="difflineminus">-                             p_ap_encode_obj-&gt;c2,</span>
<a href="#l8.848"></a><span id="l8.848" class="difflineminus">-                             0,</span>
<a href="#l8.849"></a><span id="l8.849" class="difflineminus">-                             1);</span>
<a href="#l8.850"></a><span id="l8.850" class="difflineplus">+      status = output64chunk(p_ap_encode_obj, p_ap_encode_obj-&gt;c1,</span>
<a href="#l8.851"></a><span id="l8.851" class="difflineplus">+                             p_ap_encode_obj-&gt;c2, 0, 1);</span>
<a href="#l8.852"></a><span id="l8.852">       break;</span>
<a href="#l8.853"></a><span id="l8.853">   }</span>
<a href="#l8.854"></a><span id="l8.854">   status = write_stream(p_ap_encode_obj, CRLF, 2);</span>
<a href="#l8.855"></a><span id="l8.855">   p_ap_encode_obj-&gt;state64 = 0;</span>
<a href="#l8.856"></a><span id="l8.856" class="difflineminus">-  p_ap_encode_obj-&gt;ct       = 0;</span>
<a href="#l8.857"></a><span id="l8.857" class="difflineplus">+  p_ap_encode_obj-&gt;ct = 0;</span>
<a href="#l8.858"></a><span id="l8.858">   return status;</span>
<a href="#l8.859"></a><span id="l8.859"> }</span>
<a href="#l8.860"></a><span id="l8.860"> </span>
<a href="#l8.861"></a><span id="l8.861" class="difflineminus">-static int output64chunk(</span>
<a href="#l8.862"></a><span id="l8.862" class="difflineminus">-  appledouble_encode_object* p_ap_encode_obj,</span>
<a href="#l8.863"></a><span id="l8.863" class="difflineminus">-  int c1, int c2, int c3, int pads)</span>
<a href="#l8.864"></a><span id="l8.864" class="difflineminus">-{</span>
<a href="#l8.865"></a><span id="l8.865" class="difflineplus">+static int output64chunk(appledouble_encode_object *p_ap_encode_obj, int c1,</span>
<a href="#l8.866"></a><span id="l8.866" class="difflineplus">+                         int c2, int c3, int pads) {</span>
<a href="#l8.867"></a><span id="l8.867">   char tmpstr[32];</span>
<a href="#l8.868"></a><span id="l8.868">   char *p = tmpstr;</span>
<a href="#l8.869"></a><span id="l8.869"> </span>
<a href="#l8.870"></a><span id="l8.870" class="difflineminus">-  *p++ = basis_64[c1&gt;&gt;2];</span>
<a href="#l8.871"></a><span id="l8.871" class="difflineminus">-  *p++ = basis_64[((c1 &amp; 0x3)&lt;&lt; 4) | ((c2 &amp; 0xF0) &gt;&gt; 4)];</span>
<a href="#l8.872"></a><span id="l8.872" class="difflineminus">-  if (pads == 2)</span>
<a href="#l8.873"></a><span id="l8.873" class="difflineminus">-  {</span>
<a href="#l8.874"></a><span id="l8.874" class="difflineminus">-      *p++ = '=';</span>
<a href="#l8.875"></a><span id="l8.875" class="difflineminus">-      *p++ = '=';</span>
<a href="#l8.876"></a><span id="l8.876" class="difflineplus">+  *p++ = basis_64[c1 &gt;&gt; 2];</span>
<a href="#l8.877"></a><span id="l8.877" class="difflineplus">+  *p++ = basis_64[((c1 &amp; 0x3) &lt;&lt; 4) | ((c2 &amp; 0xF0) &gt;&gt; 4)];</span>
<a href="#l8.878"></a><span id="l8.878" class="difflineplus">+  if (pads == 2) {</span>
<a href="#l8.879"></a><span id="l8.879" class="difflineplus">+    *p++ = '=';</span>
<a href="#l8.880"></a><span id="l8.880" class="difflineplus">+    *p++ = '=';</span>
<a href="#l8.881"></a><span id="l8.881" class="difflineplus">+  } else if (pads) {</span>
<a href="#l8.882"></a><span id="l8.882" class="difflineplus">+    *p++ = basis_64[((c2 &amp; 0xF) &lt;&lt; 2) | ((c3 &amp; 0xC0) &gt;&gt; 6)];</span>
<a href="#l8.883"></a><span id="l8.883" class="difflineplus">+    *p++ = '=';</span>
<a href="#l8.884"></a><span id="l8.884" class="difflineplus">+  } else {</span>
<a href="#l8.885"></a><span id="l8.885" class="difflineplus">+    *p++ = basis_64[((c2 &amp; 0xF) &lt;&lt; 2) | ((c3 &amp; 0xC0) &gt;&gt; 6)];</span>
<a href="#l8.886"></a><span id="l8.886" class="difflineplus">+    *p++ = basis_64[c3 &amp; 0x3F];</span>
<a href="#l8.887"></a><span id="l8.887">   }</span>
<a href="#l8.888"></a><span id="l8.888" class="difflineminus">-  else if (pads)</span>
<a href="#l8.889"></a><span id="l8.889" class="difflineminus">-  {</span>
<a href="#l8.890"></a><span id="l8.890" class="difflineminus">-      *p++ = basis_64[((c2 &amp; 0xF) &lt;&lt; 2) | ((c3 &amp; 0xC0) &gt;&gt;6)];</span>
<a href="#l8.891"></a><span id="l8.891" class="difflineminus">-      *p++ = '=';</span>
<a href="#l8.892"></a><span id="l8.892" class="difflineminus">-  }</span>
<a href="#l8.893"></a><span id="l8.893" class="difflineminus">-  else</span>
<a href="#l8.894"></a><span id="l8.894" class="difflineminus">-  {</span>
<a href="#l8.895"></a><span id="l8.895" class="difflineminus">-      *p++ = basis_64[((c2 &amp; 0xF) &lt;&lt; 2) | ((c3 &amp; 0xC0) &gt;&gt;6)];</span>
<a href="#l8.896"></a><span id="l8.896" class="difflineminus">-      *p++ = basis_64[c3 &amp; 0x3F];</span>
<a href="#l8.897"></a><span id="l8.897" class="difflineminus">-  }</span>
<a href="#l8.898"></a><span id="l8.898" class="difflineminus">-  return write_stream(p_ap_encode_obj, (const char*) tmpstr, p-tmpstr);</span>
<a href="#l8.899"></a><span id="l8.899" class="difflineplus">+  return write_stream(p_ap_encode_obj, (const char *)tmpstr, p - tmpstr);</span>
<a href="#l8.900"></a><span id="l8.900"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgAttachment.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgAttachment.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -4,259 +4,226 @@</span>
<a href="#l9.4"></a><span id="l9.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.5"></a><span id="l9.5"> </span>
<a href="#l9.6"></a><span id="l9.6"> #include &quot;nsMsgAttachment.h&quot;</span>
<a href="#l9.7"></a><span id="l9.7"> #include &quot;nsIFile.h&quot;</span>
<a href="#l9.8"></a><span id="l9.8"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l9.9"></a><span id="l9.9"> </span>
<a href="#l9.10"></a><span id="l9.10"> NS_IMPL_ISUPPORTS(nsMsgAttachment, nsIMsgAttachment)</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-nsMsgAttachment::nsMsgAttachment()</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-{</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+nsMsgAttachment::nsMsgAttachment() {</span>
<a href="#l9.15"></a><span id="l9.15">   mTemporary = false;</span>
<a href="#l9.16"></a><span id="l9.16">   mSendViaCloud = false;</span>
<a href="#l9.17"></a><span id="l9.17">   mSize = -1;</span>
<a href="#l9.18"></a><span id="l9.18"> }</span>
<a href="#l9.19"></a><span id="l9.19"> </span>
<a href="#l9.20"></a><span id="l9.20" class="difflineminus">-nsMsgAttachment::~nsMsgAttachment()</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineminus">-{</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">-  if (mTemporary &amp;&amp; !mSendViaCloud)</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineminus">-    (void)DeleteAttachment();</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+nsMsgAttachment::~nsMsgAttachment() {</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+  if (mTemporary &amp;&amp; !mSendViaCloud) (void)DeleteAttachment();</span>
<a href="#l9.26"></a><span id="l9.26"> }</span>
<a href="#l9.27"></a><span id="l9.27"> </span>
<a href="#l9.28"></a><span id="l9.28"> /* attribute wstring name; */</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineminus">-NS_IMETHODIMP nsMsgAttachment::GetName(nsAString &amp; aName)</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-{</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+NS_IMETHODIMP nsMsgAttachment::GetName(nsAString &amp;aName) {</span>
<a href="#l9.32"></a><span id="l9.32">   aName = mName;</span>
<a href="#l9.33"></a><span id="l9.33">   return NS_OK;</span>
<a href="#l9.34"></a><span id="l9.34"> }</span>
<a href="#l9.35"></a><span id="l9.35"> </span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-NS_IMETHODIMP nsMsgAttachment::SetName(const nsAString &amp; aName)</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineminus">-{</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+NS_IMETHODIMP nsMsgAttachment::SetName(const nsAString &amp;aName) {</span>
<a href="#l9.39"></a><span id="l9.39">   mName = aName;</span>
<a href="#l9.40"></a><span id="l9.40">   return NS_OK;</span>
<a href="#l9.41"></a><span id="l9.41"> }</span>
<a href="#l9.42"></a><span id="l9.42"> </span>
<a href="#l9.43"></a><span id="l9.43"> /* attribute string url; */</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineminus">-NS_IMETHODIMP nsMsgAttachment::GetUrl(nsACString &amp; aUrl)</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineminus">-{</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+NS_IMETHODIMP nsMsgAttachment::GetUrl(nsACString &amp;aUrl) {</span>
<a href="#l9.47"></a><span id="l9.47">   aUrl = mUrl;</span>
<a href="#l9.48"></a><span id="l9.48">   return NS_OK;</span>
<a href="#l9.49"></a><span id="l9.49"> }</span>
<a href="#l9.50"></a><span id="l9.50"> </span>
<a href="#l9.51"></a><span id="l9.51" class="difflineminus">-NS_IMETHODIMP nsMsgAttachment::SetUrl(const nsACString &amp; aUrl)</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineminus">-{</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+NS_IMETHODIMP nsMsgAttachment::SetUrl(const nsACString &amp;aUrl) {</span>
<a href="#l9.54"></a><span id="l9.54">   mUrl = aUrl;</span>
<a href="#l9.55"></a><span id="l9.55">   return NS_OK;</span>
<a href="#l9.56"></a><span id="l9.56"> }</span>
<a href="#l9.57"></a><span id="l9.57"> </span>
<a href="#l9.58"></a><span id="l9.58"> /* attribute string urlCharset; */</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineminus">-NS_IMETHODIMP nsMsgAttachment::GetUrlCharset(nsACString &amp; aUrlCharset)</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineminus">-{</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+NS_IMETHODIMP nsMsgAttachment::GetUrlCharset(nsACString &amp;aUrlCharset) {</span>
<a href="#l9.62"></a><span id="l9.62">   aUrlCharset = mUrlCharset;</span>
<a href="#l9.63"></a><span id="l9.63">   return NS_OK;</span>
<a href="#l9.64"></a><span id="l9.64"> }</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineminus">-NS_IMETHODIMP nsMsgAttachment::SetUrlCharset(const nsACString &amp; aUrlCharset)</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineminus">-{</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineplus">+NS_IMETHODIMP nsMsgAttachment::SetUrlCharset(const nsACString &amp;aUrlCharset) {</span>
<a href="#l9.68"></a><span id="l9.68">   mUrlCharset = aUrlCharset;</span>
<a href="#l9.69"></a><span id="l9.69">   return NS_OK;</span>
<a href="#l9.70"></a><span id="l9.70"> }</span>
<a href="#l9.71"></a><span id="l9.71"> </span>
<a href="#l9.72"></a><span id="l9.72"> /* attribute boolean temporary; */</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineminus">-NS_IMETHODIMP nsMsgAttachment::GetTemporary(bool *aTemporary)</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineminus">-{</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineplus">+NS_IMETHODIMP nsMsgAttachment::GetTemporary(bool *aTemporary) {</span>
<a href="#l9.76"></a><span id="l9.76">   NS_ENSURE_ARG_POINTER(aTemporary);</span>
<a href="#l9.77"></a><span id="l9.77"> </span>
<a href="#l9.78"></a><span id="l9.78">   *aTemporary = mTemporary;</span>
<a href="#l9.79"></a><span id="l9.79">   return NS_OK;</span>
<a href="#l9.80"></a><span id="l9.80"> }</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineminus">-NS_IMETHODIMP nsMsgAttachment::SetTemporary(bool aTemporary)</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineminus">-{</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineplus">+NS_IMETHODIMP nsMsgAttachment::SetTemporary(bool aTemporary) {</span>
<a href="#l9.84"></a><span id="l9.84">   mTemporary = aTemporary;</span>
<a href="#l9.85"></a><span id="l9.85">   return NS_OK;</span>
<a href="#l9.86"></a><span id="l9.86"> }</span>
<a href="#l9.87"></a><span id="l9.87"> </span>
<a href="#l9.88"></a><span id="l9.88" class="difflineminus">-NS_IMETHODIMP nsMsgAttachment::GetSendViaCloud(bool *aSendViaCloud)</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineminus">-{</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineplus">+NS_IMETHODIMP nsMsgAttachment::GetSendViaCloud(bool *aSendViaCloud) {</span>
<a href="#l9.91"></a><span id="l9.91">   NS_ENSURE_ARG_POINTER(aSendViaCloud);</span>
<a href="#l9.92"></a><span id="l9.92"> </span>
<a href="#l9.93"></a><span id="l9.93">   *aSendViaCloud = mSendViaCloud;</span>
<a href="#l9.94"></a><span id="l9.94">   return NS_OK;</span>
<a href="#l9.95"></a><span id="l9.95"> }</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineminus">-NS_IMETHODIMP nsMsgAttachment::SetSendViaCloud(bool aSendViaCloud)</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineminus">-{</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineplus">+NS_IMETHODIMP nsMsgAttachment::SetSendViaCloud(bool aSendViaCloud) {</span>
<a href="#l9.99"></a><span id="l9.99">   mSendViaCloud = aSendViaCloud;</span>
<a href="#l9.100"></a><span id="l9.100">   return NS_OK;</span>
<a href="#l9.101"></a><span id="l9.101"> }</span>
<a href="#l9.102"></a><span id="l9.102"> </span>
<a href="#l9.103"></a><span id="l9.103" class="difflineminus">-NS_IMETHODIMP nsMsgAttachment::SetHtmlAnnotation(const nsAString &amp;aAnnotation)</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineminus">-{</span>
<a href="#l9.105"></a><span id="l9.105" class="difflineplus">+NS_IMETHODIMP nsMsgAttachment::SetHtmlAnnotation(const nsAString &amp;aAnnotation) {</span>
<a href="#l9.106"></a><span id="l9.106">   mHtmlAnnotation = aAnnotation;</span>
<a href="#l9.107"></a><span id="l9.107">   return NS_OK;</span>
<a href="#l9.108"></a><span id="l9.108"> }</span>
<a href="#l9.109"></a><span id="l9.109"> </span>
<a href="#l9.110"></a><span id="l9.110" class="difflineminus">-NS_IMETHODIMP nsMsgAttachment::GetHtmlAnnotation(nsAString &amp;aAnnotation)</span>
<a href="#l9.111"></a><span id="l9.111" class="difflineminus">-{</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineplus">+NS_IMETHODIMP nsMsgAttachment::GetHtmlAnnotation(nsAString &amp;aAnnotation) {</span>
<a href="#l9.113"></a><span id="l9.113">   aAnnotation = mHtmlAnnotation;</span>
<a href="#l9.114"></a><span id="l9.114">   return NS_OK;</span>
<a href="#l9.115"></a><span id="l9.115"> }</span>
<a href="#l9.116"></a><span id="l9.116"> </span>
<a href="#l9.117"></a><span id="l9.117"> NS_IMETHODIMP</span>
<a href="#l9.118"></a><span id="l9.118" class="difflineminus">-nsMsgAttachment::SetCloudFileAccountKey(const nsACString &amp;aCloudFileAccountKey)</span>
<a href="#l9.119"></a><span id="l9.119" class="difflineminus">-{</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineplus">+nsMsgAttachment::SetCloudFileAccountKey(</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineplus">+    const nsACString &amp;aCloudFileAccountKey) {</span>
<a href="#l9.122"></a><span id="l9.122">   mCloudFileAccountKey = aCloudFileAccountKey;</span>
<a href="#l9.123"></a><span id="l9.123">   return NS_OK;</span>
<a href="#l9.124"></a><span id="l9.124"> }</span>
<a href="#l9.125"></a><span id="l9.125"> </span>
<a href="#l9.126"></a><span id="l9.126"> NS_IMETHODIMP</span>
<a href="#l9.127"></a><span id="l9.127" class="difflineminus">-nsMsgAttachment::GetCloudFileAccountKey(nsACString &amp;aCloudFileAccountKey)</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineminus">-{</span>
<a href="#l9.129"></a><span id="l9.129" class="difflineplus">+nsMsgAttachment::GetCloudFileAccountKey(nsACString &amp;aCloudFileAccountKey) {</span>
<a href="#l9.130"></a><span id="l9.130">   aCloudFileAccountKey = mCloudFileAccountKey;</span>
<a href="#l9.131"></a><span id="l9.131">   return NS_OK;</span>
<a href="#l9.132"></a><span id="l9.132"> }</span>
<a href="#l9.133"></a><span id="l9.133"> </span>
<a href="#l9.134"></a><span id="l9.134" class="difflineminus">-NS_IMETHODIMP nsMsgAttachment::GetContentLocation(nsACString &amp;aContentLocation)</span>
<a href="#l9.135"></a><span id="l9.135" class="difflineminus">-{</span>
<a href="#l9.136"></a><span id="l9.136" class="difflineplus">+NS_IMETHODIMP nsMsgAttachment::GetContentLocation(</span>
<a href="#l9.137"></a><span id="l9.137" class="difflineplus">+    nsACString &amp;aContentLocation) {</span>
<a href="#l9.138"></a><span id="l9.138">   aContentLocation = mContentLocation;</span>
<a href="#l9.139"></a><span id="l9.139">   return NS_OK;</span>
<a href="#l9.140"></a><span id="l9.140"> }</span>
<a href="#l9.141"></a><span id="l9.141"> </span>
<a href="#l9.142"></a><span id="l9.142" class="difflineminus">-NS_IMETHODIMP nsMsgAttachment::SetContentLocation(const nsACString &amp;aContentLocation)</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineminus">-{</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineplus">+NS_IMETHODIMP nsMsgAttachment::SetContentLocation(</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineplus">+    const nsACString &amp;aContentLocation) {</span>
<a href="#l9.146"></a><span id="l9.146">   mContentLocation = aContentLocation;</span>
<a href="#l9.147"></a><span id="l9.147">   return NS_OK;</span>
<a href="#l9.148"></a><span id="l9.148"> }</span>
<a href="#l9.149"></a><span id="l9.149"> </span>
<a href="#l9.150"></a><span id="l9.150" class="difflineminus">-NS_IMETHODIMP nsMsgAttachment::GetContentType(char * *aContentType)</span>
<a href="#l9.151"></a><span id="l9.151" class="difflineminus">-{</span>
<a href="#l9.152"></a><span id="l9.152" class="difflineplus">+NS_IMETHODIMP nsMsgAttachment::GetContentType(char **aContentType) {</span>
<a href="#l9.153"></a><span id="l9.153">   NS_ENSURE_ARG_POINTER(aContentType);</span>
<a href="#l9.154"></a><span id="l9.154"> </span>
<a href="#l9.155"></a><span id="l9.155">   *aContentType = ToNewCString(mContentType);</span>
<a href="#l9.156"></a><span id="l9.156">   return (*aContentType ? NS_OK : NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l9.157"></a><span id="l9.157"> }</span>
<a href="#l9.158"></a><span id="l9.158"> </span>
<a href="#l9.159"></a><span id="l9.159" class="difflineminus">-NS_IMETHODIMP nsMsgAttachment::SetContentType(const char * aContentType)</span>
<a href="#l9.160"></a><span id="l9.160" class="difflineminus">-{</span>
<a href="#l9.161"></a><span id="l9.161" class="difflineplus">+NS_IMETHODIMP nsMsgAttachment::SetContentType(const char *aContentType) {</span>
<a href="#l9.162"></a><span id="l9.162">   mContentType = aContentType;</span>
<a href="#l9.163"></a><span id="l9.163">   /* a full content type could also contains parameters but we need to</span>
<a href="#l9.164"></a><span id="l9.164">      keep only the content type alone. Therefore we need to cleanup it.</span>
<a href="#l9.165"></a><span id="l9.165">   */</span>
<a href="#l9.166"></a><span id="l9.166">   int32_t offset = mContentType.FindChar(';');</span>
<a href="#l9.167"></a><span id="l9.167" class="difflineminus">-  if (offset &gt;= 0)</span>
<a href="#l9.168"></a><span id="l9.168" class="difflineminus">-    mContentType.SetLength(offset);</span>
<a href="#l9.169"></a><span id="l9.169" class="difflineplus">+  if (offset &gt;= 0) mContentType.SetLength(offset);</span>
<a href="#l9.170"></a><span id="l9.170"> </span>
<a href="#l9.171"></a><span id="l9.171">   return NS_OK;</span>
<a href="#l9.172"></a><span id="l9.172"> }</span>
<a href="#l9.173"></a><span id="l9.173"> </span>
<a href="#l9.174"></a><span id="l9.174" class="difflineminus">-NS_IMETHODIMP nsMsgAttachment::GetContentTypeParam(char * *aContentTypeParam)</span>
<a href="#l9.175"></a><span id="l9.175" class="difflineminus">-{</span>
<a href="#l9.176"></a><span id="l9.176" class="difflineplus">+NS_IMETHODIMP nsMsgAttachment::GetContentTypeParam(char **aContentTypeParam) {</span>
<a href="#l9.177"></a><span id="l9.177">   NS_ENSURE_ARG_POINTER(aContentTypeParam);</span>
<a href="#l9.178"></a><span id="l9.178"> </span>
<a href="#l9.179"></a><span id="l9.179">   *aContentTypeParam = ToNewCString(mContentTypeParam);</span>
<a href="#l9.180"></a><span id="l9.180">   return (*aContentTypeParam ? NS_OK : NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l9.181"></a><span id="l9.181"> }</span>
<a href="#l9.182"></a><span id="l9.182"> </span>
<a href="#l9.183"></a><span id="l9.183" class="difflineminus">-NS_IMETHODIMP nsMsgAttachment::SetContentTypeParam(const char * aContentTypeParam)</span>
<a href="#l9.184"></a><span id="l9.184" class="difflineminus">-{</span>
<a href="#l9.185"></a><span id="l9.185" class="difflineplus">+NS_IMETHODIMP nsMsgAttachment::SetContentTypeParam(</span>
<a href="#l9.186"></a><span id="l9.186" class="difflineplus">+    const char *aContentTypeParam) {</span>
<a href="#l9.187"></a><span id="l9.187">   if (aContentTypeParam)</span>
<a href="#l9.188"></a><span id="l9.188">     while (*aContentTypeParam == ';' || *aContentTypeParam == ' ')</span>
<a href="#l9.189"></a><span id="l9.189" class="difflineminus">-      aContentTypeParam ++;</span>
<a href="#l9.190"></a><span id="l9.190" class="difflineplus">+      aContentTypeParam++;</span>
<a href="#l9.191"></a><span id="l9.191">   mContentTypeParam = aContentTypeParam;</span>
<a href="#l9.192"></a><span id="l9.192"> </span>
<a href="#l9.193"></a><span id="l9.193">   return NS_OK;</span>
<a href="#l9.194"></a><span id="l9.194"> }</span>
<a href="#l9.195"></a><span id="l9.195"> </span>
<a href="#l9.196"></a><span id="l9.196"> /* attribute string charset; */</span>
<a href="#l9.197"></a><span id="l9.197" class="difflineminus">-NS_IMETHODIMP nsMsgAttachment::GetCharset(char * *aCharset)</span>
<a href="#l9.198"></a><span id="l9.198" class="difflineminus">-{</span>
<a href="#l9.199"></a><span id="l9.199" class="difflineplus">+NS_IMETHODIMP nsMsgAttachment::GetCharset(char **aCharset) {</span>
<a href="#l9.200"></a><span id="l9.200">   NS_ENSURE_ARG_POINTER(aCharset);</span>
<a href="#l9.201"></a><span id="l9.201"> </span>
<a href="#l9.202"></a><span id="l9.202">   *aCharset = ToNewCString(mCharset);</span>
<a href="#l9.203"></a><span id="l9.203">   return (*aCharset ? NS_OK : NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l9.204"></a><span id="l9.204"> }</span>
<a href="#l9.205"></a><span id="l9.205" class="difflineminus">-NS_IMETHODIMP nsMsgAttachment::SetCharset(const char * aCharset)</span>
<a href="#l9.206"></a><span id="l9.206" class="difflineminus">-{</span>
<a href="#l9.207"></a><span id="l9.207" class="difflineplus">+NS_IMETHODIMP nsMsgAttachment::SetCharset(const char *aCharset) {</span>
<a href="#l9.208"></a><span id="l9.208">   mCharset = aCharset;</span>
<a href="#l9.209"></a><span id="l9.209">   return NS_OK;</span>
<a href="#l9.210"></a><span id="l9.210"> }</span>
<a href="#l9.211"></a><span id="l9.211"> </span>
<a href="#l9.212"></a><span id="l9.212"> /* attribute string macType; */</span>
<a href="#l9.213"></a><span id="l9.213" class="difflineminus">-NS_IMETHODIMP nsMsgAttachment::GetMacType(char * *aMacType)</span>
<a href="#l9.214"></a><span id="l9.214" class="difflineminus">-{</span>
<a href="#l9.215"></a><span id="l9.215" class="difflineplus">+NS_IMETHODIMP nsMsgAttachment::GetMacType(char **aMacType) {</span>
<a href="#l9.216"></a><span id="l9.216">   NS_ENSURE_ARG_POINTER(aMacType);</span>
<a href="#l9.217"></a><span id="l9.217"> </span>
<a href="#l9.218"></a><span id="l9.218">   *aMacType = ToNewCString(mMacType);</span>
<a href="#l9.219"></a><span id="l9.219">   return (*aMacType ? NS_OK : NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l9.220"></a><span id="l9.220"> }</span>
<a href="#l9.221"></a><span id="l9.221" class="difflineminus">-NS_IMETHODIMP nsMsgAttachment::SetMacType(const char * aMacType)</span>
<a href="#l9.222"></a><span id="l9.222" class="difflineminus">-{</span>
<a href="#l9.223"></a><span id="l9.223" class="difflineplus">+NS_IMETHODIMP nsMsgAttachment::SetMacType(const char *aMacType) {</span>
<a href="#l9.224"></a><span id="l9.224">   mMacType = aMacType;</span>
<a href="#l9.225"></a><span id="l9.225">   return NS_OK;</span>
<a href="#l9.226"></a><span id="l9.226"> }</span>
<a href="#l9.227"></a><span id="l9.227"> </span>
<a href="#l9.228"></a><span id="l9.228"> /* attribute string macCreator; */</span>
<a href="#l9.229"></a><span id="l9.229" class="difflineminus">-NS_IMETHODIMP nsMsgAttachment::GetMacCreator(char * *aMacCreator)</span>
<a href="#l9.230"></a><span id="l9.230" class="difflineminus">-{</span>
<a href="#l9.231"></a><span id="l9.231" class="difflineplus">+NS_IMETHODIMP nsMsgAttachment::GetMacCreator(char **aMacCreator) {</span>
<a href="#l9.232"></a><span id="l9.232">   NS_ENSURE_ARG_POINTER(aMacCreator);</span>
<a href="#l9.233"></a><span id="l9.233"> </span>
<a href="#l9.234"></a><span id="l9.234">   *aMacCreator = ToNewCString(mMacCreator);</span>
<a href="#l9.235"></a><span id="l9.235">   return (*aMacCreator ? NS_OK : NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l9.236"></a><span id="l9.236"> }</span>
<a href="#l9.237"></a><span id="l9.237" class="difflineminus">-NS_IMETHODIMP nsMsgAttachment::SetMacCreator(const char * aMacCreator)</span>
<a href="#l9.238"></a><span id="l9.238" class="difflineminus">-{</span>
<a href="#l9.239"></a><span id="l9.239" class="difflineplus">+NS_IMETHODIMP nsMsgAttachment::SetMacCreator(const char *aMacCreator) {</span>
<a href="#l9.240"></a><span id="l9.240">   mMacCreator = aMacCreator;</span>
<a href="#l9.241"></a><span id="l9.241">   return NS_OK;</span>
<a href="#l9.242"></a><span id="l9.242"> }</span>
<a href="#l9.243"></a><span id="l9.243"> </span>
<a href="#l9.244"></a><span id="l9.244"> /* attribute int64_t size; */</span>
<a href="#l9.245"></a><span id="l9.245" class="difflineminus">-NS_IMETHODIMP nsMsgAttachment::GetSize(int64_t *aSize)</span>
<a href="#l9.246"></a><span id="l9.246" class="difflineminus">-{</span>
<a href="#l9.247"></a><span id="l9.247" class="difflineplus">+NS_IMETHODIMP nsMsgAttachment::GetSize(int64_t *aSize) {</span>
<a href="#l9.248"></a><span id="l9.248">   NS_ENSURE_ARG_POINTER(aSize);</span>
<a href="#l9.249"></a><span id="l9.249"> </span>
<a href="#l9.250"></a><span id="l9.250">   *aSize = mSize;</span>
<a href="#l9.251"></a><span id="l9.251">   return NS_OK;</span>
<a href="#l9.252"></a><span id="l9.252"> }</span>
<a href="#l9.253"></a><span id="l9.253" class="difflineminus">-NS_IMETHODIMP nsMsgAttachment::SetSize(int64_t aSize)</span>
<a href="#l9.254"></a><span id="l9.254" class="difflineminus">-{</span>
<a href="#l9.255"></a><span id="l9.255" class="difflineplus">+NS_IMETHODIMP nsMsgAttachment::SetSize(int64_t aSize) {</span>
<a href="#l9.256"></a><span id="l9.256">   mSize = aSize;</span>
<a href="#l9.257"></a><span id="l9.257">   return NS_OK;</span>
<a href="#l9.258"></a><span id="l9.258"> }</span>
<a href="#l9.259"></a><span id="l9.259"> </span>
<a href="#l9.260"></a><span id="l9.260"> /* boolean equalsUrl (in nsIMsgAttachment attachment); */</span>
<a href="#l9.261"></a><span id="l9.261" class="difflineminus">-NS_IMETHODIMP nsMsgAttachment::EqualsUrl(nsIMsgAttachment *attachment, bool *_retval)</span>
<a href="#l9.262"></a><span id="l9.262" class="difflineminus">-{</span>
<a href="#l9.263"></a><span id="l9.263" class="difflineplus">+NS_IMETHODIMP nsMsgAttachment::EqualsUrl(nsIMsgAttachment *attachment,</span>
<a href="#l9.264"></a><span id="l9.264" class="difflineplus">+                                         bool *_retval) {</span>
<a href="#l9.265"></a><span id="l9.265">   NS_ENSURE_ARG_POINTER(attachment);</span>
<a href="#l9.266"></a><span id="l9.266">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l9.267"></a><span id="l9.267"> </span>
<a href="#l9.268"></a><span id="l9.268">   nsAutoCString url;</span>
<a href="#l9.269"></a><span id="l9.269">   attachment-&gt;GetUrl(url);</span>
<a href="#l9.270"></a><span id="l9.270"> </span>
<a href="#l9.271"></a><span id="l9.271">   *_retval = mUrl.Equals(url);</span>
<a href="#l9.272"></a><span id="l9.272">   return NS_OK;</span>
<a href="#l9.273"></a><span id="l9.273"> }</span>
<a href="#l9.274"></a><span id="l9.274"> </span>
<a href="#l9.275"></a><span id="l9.275" class="difflineminus">-</span>
<a href="#l9.276"></a><span id="l9.276" class="difflineminus">-nsresult nsMsgAttachment::DeleteAttachment()</span>
<a href="#l9.277"></a><span id="l9.277" class="difflineminus">-{</span>
<a href="#l9.278"></a><span id="l9.278" class="difflineplus">+nsresult nsMsgAttachment::DeleteAttachment() {</span>
<a href="#l9.279"></a><span id="l9.279">   nsresult rv;</span>
<a href="#l9.280"></a><span id="l9.280">   bool isAFile = false;</span>
<a href="#l9.281"></a><span id="l9.281"> </span>
<a href="#l9.282"></a><span id="l9.282">   nsCOMPtr&lt;nsIFile&gt; urlFile;</span>
<a href="#l9.283"></a><span id="l9.283">   rv = NS_GetFileFromURLSpec(mUrl, getter_AddRefs(urlFile));</span>
<a href="#l9.284"></a><span id="l9.284">   NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Can't nsIFile from URL string&quot;);</span>
<a href="#l9.285"></a><span id="l9.285" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l9.286"></a><span id="l9.286" class="difflineminus">-  {</span>
<a href="#l9.287"></a><span id="l9.287" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l9.288"></a><span id="l9.288">     bool bExists = false;</span>
<a href="#l9.289"></a><span id="l9.289">     rv = urlFile-&gt;Exists(&amp;bExists);</span>
<a href="#l9.290"></a><span id="l9.290">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Exists() call failed!&quot;);</span>
<a href="#l9.291"></a><span id="l9.291" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; bExists)</span>
<a href="#l9.292"></a><span id="l9.292" class="difflineminus">-    {</span>
<a href="#l9.293"></a><span id="l9.293" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; bExists) {</span>
<a href="#l9.294"></a><span id="l9.294">       rv = urlFile-&gt;IsFile(&amp;isAFile);</span>
<a href="#l9.295"></a><span id="l9.295">       NS_ASSERTION(NS_SUCCEEDED(rv), &quot;IsFile() call failed!&quot;);</span>
<a href="#l9.296"></a><span id="l9.296">     }</span>
<a href="#l9.297"></a><span id="l9.297">   }</span>
<a href="#l9.298"></a><span id="l9.298"> </span>
<a href="#l9.299"></a><span id="l9.299">   // remove it if it's a valid file</span>
<a href="#l9.300"></a><span id="l9.300" class="difflineminus">-  if (isAFile)</span>
<a href="#l9.301"></a><span id="l9.301" class="difflineminus">-    rv = urlFile-&gt;Remove(false);</span>
<a href="#l9.302"></a><span id="l9.302" class="difflineplus">+  if (isAFile) rv = urlFile-&gt;Remove(false);</span>
<a href="#l9.303"></a><span id="l9.303"> </span>
<a href="#l9.304"></a><span id="l9.304">   return rv;</span>
<a href="#l9.305"></a><span id="l9.305"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgAttachment.h</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgAttachment.h</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -4,38 +4,36 @@</span>
<a href="#l10.4"></a><span id="l10.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l10.5"></a><span id="l10.5"> </span>
<a href="#l10.6"></a><span id="l10.6"> #ifndef _nsMsgAttachment_H_</span>
<a href="#l10.7"></a><span id="l10.7"> #define _nsMsgAttachment_H_</span>
<a href="#l10.8"></a><span id="l10.8"> </span>
<a href="#l10.9"></a><span id="l10.9"> #include &quot;nsIMsgAttachment.h&quot;</span>
<a href="#l10.10"></a><span id="l10.10"> #include &quot;nsString.h&quot;</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-class nsMsgAttachment : public nsIMsgAttachment</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-{</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-public:</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+class nsMsgAttachment : public nsIMsgAttachment {</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+ public:</span>
<a href="#l10.17"></a><span id="l10.17">   NS_DECL_ISUPPORTS</span>
<a href="#l10.18"></a><span id="l10.18">   NS_DECL_NSIMSGATTACHMENT</span>
<a href="#l10.19"></a><span id="l10.19"> </span>
<a href="#l10.20"></a><span id="l10.20">   nsMsgAttachment();</span>
<a href="#l10.21"></a><span id="l10.21"> </span>
<a href="#l10.22"></a><span id="l10.22" class="difflineminus">-private:</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+ private:</span>
<a href="#l10.24"></a><span id="l10.24">   virtual ~nsMsgAttachment();</span>
<a href="#l10.25"></a><span id="l10.25">   nsresult DeleteAttachment();</span>
<a href="#l10.26"></a><span id="l10.26"> </span>
<a href="#l10.27"></a><span id="l10.27" class="difflineminus">-  nsString    mName;</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineminus">-  nsCString   mUrl;</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineminus">-  nsCString   mUrlCharset;</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineminus">-  bool        mTemporary;</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-  bool        mSendViaCloud;</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-  nsCString   mCloudFileAccountKey;</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineminus">-  nsCString   mContentLocation;</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineminus">-  nsCString   mContentType;</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineminus">-  nsCString   mContentTypeParam;</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineminus">-  nsCString   mCharset;</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-  nsCString   mMacType;</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineminus">-  nsCString   mMacCreator;</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineminus">-  nsString    mHtmlAnnotation;</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineminus">-  int64_t     mSize;</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+  nsString mName;</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+  nsCString mUrl;</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+  nsCString mUrlCharset;</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+  bool mTemporary;</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+  bool mSendViaCloud;</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineplus">+  nsCString mCloudFileAccountKey;</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineplus">+  nsCString mContentLocation;</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineplus">+  nsCString mContentType;</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+  nsCString mContentTypeParam;</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+  nsCString mCharset;</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+  nsCString mMacType;</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+  nsCString mMacCreator;</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+  nsString mHtmlAnnotation;</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineplus">+  int64_t mSize;</span>
<a href="#l10.55"></a><span id="l10.55"> };</span>
<a href="#l10.56"></a><span id="l10.56"> </span>
<a href="#l10.57"></a><span id="l10.57" class="difflineminus">-</span>
<a href="#l10.58"></a><span id="l10.58"> #endif /* _nsMsgAttachment_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgAttachmentHandler.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgAttachmentHandler.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -38,367 +38,314 @@</span>
<a href="#l11.4"></a><span id="l11.4"> #include &quot;nsIPrincipal.h&quot;</span>
<a href="#l11.5"></a><span id="l11.5"> #include &quot;nsIURIMutator.h&quot;</span>
<a href="#l11.6"></a><span id="l11.6"> </span>
<a href="#l11.7"></a><span id="l11.7"> ///////////////////////////////////////////////////////////////////////////</span>
<a href="#l11.8"></a><span id="l11.8"> // Mac Specific Attachment Handling for AppleDouble Encoded Files</span>
<a href="#l11.9"></a><span id="l11.9"> ///////////////////////////////////////////////////////////////////////////</span>
<a href="#l11.10"></a><span id="l11.10"> #ifdef XP_MACOSX</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-#define AD_WORKING_BUFF_SIZE FILE_IO_BUFFER_SIZE</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+#  define AD_WORKING_BUFF_SIZE FILE_IO_BUFFER_SIZE</span>
<a href="#l11.14"></a><span id="l11.14"> </span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-extern void         MacGetFileType(nsIFile *fs, bool *useDefault, char **type, char **encoding);</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+extern void MacGetFileType(nsIFile *fs, bool *useDefault, char **type,</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+                           char **encoding);</span>
<a href="#l11.18"></a><span id="l11.18"> </span>
<a href="#l11.19"></a><span id="l11.19" class="difflineminus">-#include &quot;nsILocalFileMac.h&quot;</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+#  include &quot;nsILocalFileMac.h&quot;</span>
<a href="#l11.21"></a><span id="l11.21"> </span>
<a href="#l11.22"></a><span id="l11.22"> /* static */</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">-nsresult nsSimpleZipper::Zip(nsIFile *aInputFile, nsIFile *aOutputFile)</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineminus">-{</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+nsresult nsSimpleZipper::Zip(nsIFile *aInputFile, nsIFile *aOutputFile) {</span>
<a href="#l11.26"></a><span id="l11.26">   // create zipwriter object</span>
<a href="#l11.27"></a><span id="l11.27">   nsresult rv;</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineminus">-  nsCOMPtr&lt;nsIZipWriter&gt; zipWriter = do_CreateInstance(&quot;@mozilla.org/zipwriter;1&quot;, &amp;rv);</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineplus">+  nsCOMPtr&lt;nsIZipWriter&gt; zipWriter =</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+      do_CreateInstance(&quot;@mozilla.org/zipwriter;1&quot;, &amp;rv);</span>
<a href="#l11.31"></a><span id="l11.31">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.32"></a><span id="l11.32"> </span>
<a href="#l11.33"></a><span id="l11.33">   rv = zipWriter-&gt;Open(aOutputFile, PR_RDWR | PR_CREATE_FILE | PR_TRUNCATE);</span>
<a href="#l11.34"></a><span id="l11.34">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.35"></a><span id="l11.35"> </span>
<a href="#l11.36"></a><span id="l11.36">   rv = AddToZip(zipWriter, aInputFile, EmptyCString());</span>
<a href="#l11.37"></a><span id="l11.37">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.38"></a><span id="l11.38"> </span>
<a href="#l11.39"></a><span id="l11.39">   // we're done.</span>
<a href="#l11.40"></a><span id="l11.40">   zipWriter-&gt;Close();</span>
<a href="#l11.41"></a><span id="l11.41">   return rv;</span>
<a href="#l11.42"></a><span id="l11.42"> }</span>
<a href="#l11.43"></a><span id="l11.43"> </span>
<a href="#l11.44"></a><span id="l11.44"> /* static */</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineminus">-nsresult nsSimpleZipper::AddToZip(nsIZipWriter *aZipWriter,</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineminus">-                                  nsIFile *aFile,</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineminus">-                                  const nsACString &amp;aPath)</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineminus">-{</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineplus">+nsresult nsSimpleZipper::AddToZip(nsIZipWriter *aZipWriter, nsIFile *aFile,</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineplus">+                                  const nsACString &amp;aPath) {</span>
<a href="#l11.51"></a><span id="l11.51">   // find out the path this file/dir should have in the zip</span>
<a href="#l11.52"></a><span id="l11.52">   nsCString leafName;</span>
<a href="#l11.53"></a><span id="l11.53">   aFile-&gt;GetNativeLeafName(leafName);</span>
<a href="#l11.54"></a><span id="l11.54">   nsCString currentPath(aPath);</span>
<a href="#l11.55"></a><span id="l11.55">   currentPath += leafName;</span>
<a href="#l11.56"></a><span id="l11.56"> </span>
<a href="#l11.57"></a><span id="l11.57">   bool isDirectory;</span>
<a href="#l11.58"></a><span id="l11.58">   aFile-&gt;IsDirectory(&amp;isDirectory);</span>
<a href="#l11.59"></a><span id="l11.59">   // append slash for a directory entry</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineminus">-  if (isDirectory)</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineminus">-    currentPath.Append('/');</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineplus">+  if (isDirectory) currentPath.Append('/');</span>
<a href="#l11.63"></a><span id="l11.63"> </span>
<a href="#l11.64"></a><span id="l11.64">   // add the file or directory entry to the zip</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineminus">-  nsresult rv = aZipWriter-&gt;AddEntryFile(currentPath, nsIZipWriter::COMPRESSION_DEFAULT, aFile, false);</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineplus">+  nsresult rv = aZipWriter-&gt;AddEntryFile(</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineplus">+      currentPath, nsIZipWriter::COMPRESSION_DEFAULT, aFile, false);</span>
<a href="#l11.68"></a><span id="l11.68">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.69"></a><span id="l11.69"> </span>
<a href="#l11.70"></a><span id="l11.70">   // if it's a directory, add all its contents too</span>
<a href="#l11.71"></a><span id="l11.71">   if (isDirectory) {</span>
<a href="#l11.72"></a><span id="l11.72">     nsCOMPtr&lt;nsIDirectoryEnumerator&gt; dirEnumerator;</span>
<a href="#l11.73"></a><span id="l11.73">     nsresult rv = aFile-&gt;GetDirectoryEntries(getter_AddRefs(dirEnumerator));</span>
<a href="#l11.74"></a><span id="l11.74">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.75"></a><span id="l11.75"> </span>
<a href="#l11.76"></a><span id="l11.76">     nsCOMPtr&lt;nsIFile&gt; currentFile;</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineminus">-    while (NS_SUCCEEDED(dirEnumerator-&gt;GetNextFile(getter_AddRefs(currentFile))) &amp;&amp; currentFile) {</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineplus">+    while (</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineplus">+        NS_SUCCEEDED(dirEnumerator-&gt;GetNextFile(getter_AddRefs(currentFile))) &amp;&amp;</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineplus">+        currentFile) {</span>
<a href="#l11.81"></a><span id="l11.81">       rv = AddToZip(aZipWriter, currentFile, currentPath);</span>
<a href="#l11.82"></a><span id="l11.82">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.83"></a><span id="l11.83">     }</span>
<a href="#l11.84"></a><span id="l11.84">   }</span>
<a href="#l11.85"></a><span id="l11.85"> </span>
<a href="#l11.86"></a><span id="l11.86">   return NS_OK;</span>
<a href="#l11.87"></a><span id="l11.87"> }</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineminus">-#endif // XP_MACOSX</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineplus">+#endif  // XP_MACOSX</span>
<a href="#l11.90"></a><span id="l11.90"> </span>
<a href="#l11.91"></a><span id="l11.91"> //</span>
<a href="#l11.92"></a><span id="l11.92"> // Class implementation...</span>
<a href="#l11.93"></a><span id="l11.93"> //</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineminus">-nsMsgAttachmentHandler::nsMsgAttachmentHandler() :</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineminus">-  mRequest(nullptr),</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineminus">-  mCompFields(nullptr),   // Message composition fields for the sender</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineminus">-  m_bogus_attachment(false),</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineminus">-  m_done(false),</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineminus">-  m_already_encoded_p(false),</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineminus">-  m_decrypted_p(false),</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineminus">-  mDeleteFile(false),</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineminus">-  mMHTMLPart(false),</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineminus">-  mPartUserOmissionOverride(false),</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineminus">-  mMainBody(false),</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineminus">-  mSendViaCloud(false),</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineminus">-  mNodeIndex(-1),</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineminus">-  // For analyzing the attachment file...</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineminus">-  m_size(0),</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineminus">-  m_unprintable_count(0),</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineminus">-  m_highbit_count(0),</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineminus">-  m_ctl_count(0),</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineminus">-  m_null_count(0),</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineminus">-  m_have_cr(0),</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineminus">-  m_have_lf(0),</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineminus">-  m_have_crlf(0),</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineminus">-  m_prev_char_was_cr(false),</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineminus">-  m_current_column(0),</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineminus">-  m_max_column(0),</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineminus">-  m_lines(0),</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineminus">-  m_file_analyzed(false),</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineplus">+nsMsgAttachmentHandler::nsMsgAttachmentHandler()</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineplus">+    : mRequest(nullptr),</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineplus">+      mCompFields(nullptr),  // Message composition fields for the sender</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineplus">+      m_bogus_attachment(false),</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineplus">+      m_done(false),</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineplus">+      m_already_encoded_p(false),</span>
<a href="#l11.127"></a><span id="l11.127" class="difflineplus">+      m_decrypted_p(false),</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineplus">+      mDeleteFile(false),</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineplus">+      mMHTMLPart(false),</span>
<a href="#l11.130"></a><span id="l11.130" class="difflineplus">+      mPartUserOmissionOverride(false),</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineplus">+      mMainBody(false),</span>
<a href="#l11.132"></a><span id="l11.132" class="difflineplus">+      mSendViaCloud(false),</span>
<a href="#l11.133"></a><span id="l11.133" class="difflineplus">+      mNodeIndex(-1),</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineplus">+      // For analyzing the attachment file...</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineplus">+      m_size(0),</span>
<a href="#l11.136"></a><span id="l11.136" class="difflineplus">+      m_unprintable_count(0),</span>
<a href="#l11.137"></a><span id="l11.137" class="difflineplus">+      m_highbit_count(0),</span>
<a href="#l11.138"></a><span id="l11.138" class="difflineplus">+      m_ctl_count(0),</span>
<a href="#l11.139"></a><span id="l11.139" class="difflineplus">+      m_null_count(0),</span>
<a href="#l11.140"></a><span id="l11.140" class="difflineplus">+      m_have_cr(0),</span>
<a href="#l11.141"></a><span id="l11.141" class="difflineplus">+      m_have_lf(0),</span>
<a href="#l11.142"></a><span id="l11.142" class="difflineplus">+      m_have_crlf(0),</span>
<a href="#l11.143"></a><span id="l11.143" class="difflineplus">+      m_prev_char_was_cr(false),</span>
<a href="#l11.144"></a><span id="l11.144" class="difflineplus">+      m_current_column(0),</span>
<a href="#l11.145"></a><span id="l11.145" class="difflineplus">+      m_max_column(0),</span>
<a href="#l11.146"></a><span id="l11.146" class="difflineplus">+      m_lines(0),</span>
<a href="#l11.147"></a><span id="l11.147" class="difflineplus">+      m_file_analyzed(false),</span>
<a href="#l11.148"></a><span id="l11.148"> </span>
<a href="#l11.149"></a><span id="l11.149" class="difflineminus">-  // Mime</span>
<a href="#l11.150"></a><span id="l11.150" class="difflineminus">-  m_encoder(nullptr)</span>
<a href="#l11.151"></a><span id="l11.151" class="difflineminus">-{</span>
<a href="#l11.152"></a><span id="l11.152" class="difflineminus">-}</span>
<a href="#l11.153"></a><span id="l11.153" class="difflineplus">+      // Mime</span>
<a href="#l11.154"></a><span id="l11.154" class="difflineplus">+      m_encoder(nullptr) {}</span>
<a href="#l11.155"></a><span id="l11.155"> </span>
<a href="#l11.156"></a><span id="l11.156" class="difflineminus">-nsMsgAttachmentHandler::~nsMsgAttachmentHandler()</span>
<a href="#l11.157"></a><span id="l11.157" class="difflineminus">-{</span>
<a href="#l11.158"></a><span id="l11.158" class="difflineminus">-  if (mTmpFile &amp;&amp; mDeleteFile)</span>
<a href="#l11.159"></a><span id="l11.159" class="difflineminus">-    mTmpFile-&gt;Remove(false);</span>
<a href="#l11.160"></a><span id="l11.160" class="difflineplus">+nsMsgAttachmentHandler::~nsMsgAttachmentHandler() {</span>
<a href="#l11.161"></a><span id="l11.161" class="difflineplus">+  if (mTmpFile &amp;&amp; mDeleteFile) mTmpFile-&gt;Remove(false);</span>
<a href="#l11.162"></a><span id="l11.162"> </span>
<a href="#l11.163"></a><span id="l11.163" class="difflineminus">-  if (mOutFile)</span>
<a href="#l11.164"></a><span id="l11.164" class="difflineminus">-    mOutFile-&gt;Close();</span>
<a href="#l11.165"></a><span id="l11.165" class="difflineplus">+  if (mOutFile) mOutFile-&gt;Close();</span>
<a href="#l11.166"></a><span id="l11.166"> </span>
<a href="#l11.167"></a><span id="l11.167">   CleanupTempFile();</span>
<a href="#l11.168"></a><span id="l11.168"> }</span>
<a href="#l11.169"></a><span id="l11.169"> </span>
<a href="#l11.170"></a><span id="l11.170"> NS_IMPL_ISUPPORTS(nsMsgAttachmentHandler, nsIMsgAttachmentHandler)</span>
<a href="#l11.171"></a><span id="l11.171"> </span>
<a href="#l11.172"></a><span id="l11.172"> // nsIMsgAttachmentHandler implementation.</span>
<a href="#l11.173"></a><span id="l11.173"> </span>
<a href="#l11.174"></a><span id="l11.174" class="difflineminus">-NS_IMETHODIMP nsMsgAttachmentHandler::GetType(nsACString&amp; aType)</span>
<a href="#l11.175"></a><span id="l11.175" class="difflineminus">-{</span>
<a href="#l11.176"></a><span id="l11.176" class="difflineplus">+NS_IMETHODIMP nsMsgAttachmentHandler::GetType(nsACString &amp;aType) {</span>
<a href="#l11.177"></a><span id="l11.177">   aType.Assign(m_type);</span>
<a href="#l11.178"></a><span id="l11.178">   return NS_OK;</span>
<a href="#l11.179"></a><span id="l11.179"> }</span>
<a href="#l11.180"></a><span id="l11.180"> </span>
<a href="#l11.181"></a><span id="l11.181" class="difflineminus">-NS_IMETHODIMP nsMsgAttachmentHandler::GetUri(nsACString&amp; aUri)</span>
<a href="#l11.182"></a><span id="l11.182" class="difflineminus">-{</span>
<a href="#l11.183"></a><span id="l11.183" class="difflineplus">+NS_IMETHODIMP nsMsgAttachmentHandler::GetUri(nsACString &amp;aUri) {</span>
<a href="#l11.184"></a><span id="l11.184">   nsAutoCString turl;</span>
<a href="#l11.185"></a><span id="l11.185" class="difflineminus">-  if (!mURL)</span>
<a href="#l11.186"></a><span id="l11.186" class="difflineminus">-  {</span>
<a href="#l11.187"></a><span id="l11.187" class="difflineminus">-    if (!m_uri.IsEmpty())</span>
<a href="#l11.188"></a><span id="l11.188" class="difflineminus">-      turl = m_uri;</span>
<a href="#l11.189"></a><span id="l11.189" class="difflineminus">-  }</span>
<a href="#l11.190"></a><span id="l11.190" class="difflineminus">-  else</span>
<a href="#l11.191"></a><span id="l11.191" class="difflineminus">-  {</span>
<a href="#l11.192"></a><span id="l11.192" class="difflineplus">+  if (!mURL) {</span>
<a href="#l11.193"></a><span id="l11.193" class="difflineplus">+    if (!m_uri.IsEmpty()) turl = m_uri;</span>
<a href="#l11.194"></a><span id="l11.194" class="difflineplus">+  } else {</span>
<a href="#l11.195"></a><span id="l11.195">     nsresult rv = mURL-&gt;GetSpec(turl);</span>
<a href="#l11.196"></a><span id="l11.196">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.197"></a><span id="l11.197">   }</span>
<a href="#l11.198"></a><span id="l11.198">   aUri.Assign(turl);</span>
<a href="#l11.199"></a><span id="l11.199">   return NS_OK;</span>
<a href="#l11.200"></a><span id="l11.200"> }</span>
<a href="#l11.201"></a><span id="l11.201"> </span>
<a href="#l11.202"></a><span id="l11.202" class="difflineminus">-NS_IMETHODIMP nsMsgAttachmentHandler::GetTmpFile(nsIFile **aTmpFile)</span>
<a href="#l11.203"></a><span id="l11.203" class="difflineminus">-{</span>
<a href="#l11.204"></a><span id="l11.204" class="difflineplus">+NS_IMETHODIMP nsMsgAttachmentHandler::GetTmpFile(nsIFile **aTmpFile) {</span>
<a href="#l11.205"></a><span id="l11.205">   NS_ENSURE_ARG_POINTER(aTmpFile);</span>
<a href="#l11.206"></a><span id="l11.206" class="difflineminus">-  if (!mTmpFile)</span>
<a href="#l11.207"></a><span id="l11.207" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l11.208"></a><span id="l11.208" class="difflineplus">+  if (!mTmpFile) return NS_ERROR_FAILURE;</span>
<a href="#l11.209"></a><span id="l11.209">   NS_ADDREF(*aTmpFile = mTmpFile);</span>
<a href="#l11.210"></a><span id="l11.210">   return NS_OK;</span>
<a href="#l11.211"></a><span id="l11.211"> }</span>
<a href="#l11.212"></a><span id="l11.212"> </span>
<a href="#l11.213"></a><span id="l11.213" class="difflineminus">-NS_IMETHODIMP nsMsgAttachmentHandler::GetName(nsACString&amp; aName)</span>
<a href="#l11.214"></a><span id="l11.214" class="difflineminus">-{</span>
<a href="#l11.215"></a><span id="l11.215" class="difflineplus">+NS_IMETHODIMP nsMsgAttachmentHandler::GetName(nsACString &amp;aName) {</span>
<a href="#l11.216"></a><span id="l11.216">   aName.Assign(m_realName);</span>
<a href="#l11.217"></a><span id="l11.217">   return NS_OK;</span>
<a href="#l11.218"></a><span id="l11.218"> }</span>
<a href="#l11.219"></a><span id="l11.219"> </span>
<a href="#l11.220"></a><span id="l11.220" class="difflineminus">-NS_IMETHODIMP nsMsgAttachmentHandler::GetSize(uint32_t *aSize)</span>
<a href="#l11.221"></a><span id="l11.221" class="difflineminus">-{</span>
<a href="#l11.222"></a><span id="l11.222" class="difflineplus">+NS_IMETHODIMP nsMsgAttachmentHandler::GetSize(uint32_t *aSize) {</span>
<a href="#l11.223"></a><span id="l11.223">   NS_ENSURE_ARG_POINTER(aSize);</span>
<a href="#l11.224"></a><span id="l11.224">   *aSize = m_size;</span>
<a href="#l11.225"></a><span id="l11.225">   return NS_OK;</span>
<a href="#l11.226"></a><span id="l11.226"> }</span>
<a href="#l11.227"></a><span id="l11.227"> </span>
<a href="#l11.228"></a><span id="l11.228" class="difflineminus">-NS_IMETHODIMP nsMsgAttachmentHandler::GetContentId(nsACString&amp; aContentId)</span>
<a href="#l11.229"></a><span id="l11.229" class="difflineminus">-{</span>
<a href="#l11.230"></a><span id="l11.230" class="difflineplus">+NS_IMETHODIMP nsMsgAttachmentHandler::GetContentId(nsACString &amp;aContentId) {</span>
<a href="#l11.231"></a><span id="l11.231">   aContentId.Assign(m_contentId);</span>
<a href="#l11.232"></a><span id="l11.232">   return NS_OK;</span>
<a href="#l11.233"></a><span id="l11.233"> }</span>
<a href="#l11.234"></a><span id="l11.234"> </span>
<a href="#l11.235"></a><span id="l11.235" class="difflineminus">-NS_IMETHODIMP nsMsgAttachmentHandler::GetSendViaCloud(bool* aSendViaCloud)</span>
<a href="#l11.236"></a><span id="l11.236" class="difflineminus">-{</span>
<a href="#l11.237"></a><span id="l11.237" class="difflineplus">+NS_IMETHODIMP nsMsgAttachmentHandler::GetSendViaCloud(bool *aSendViaCloud) {</span>
<a href="#l11.238"></a><span id="l11.238">   NS_ENSURE_ARG_POINTER(aSendViaCloud);</span>
<a href="#l11.239"></a><span id="l11.239">   *aSendViaCloud = mSendViaCloud;</span>
<a href="#l11.240"></a><span id="l11.240">   return NS_OK;</span>
<a href="#l11.241"></a><span id="l11.241"> }</span>
<a href="#l11.242"></a><span id="l11.242"> </span>
<a href="#l11.243"></a><span id="l11.243" class="difflineminus">-NS_IMETHODIMP nsMsgAttachmentHandler::GetCharset(nsACString&amp; aCharset)</span>
<a href="#l11.244"></a><span id="l11.244" class="difflineminus">-{</span>
<a href="#l11.245"></a><span id="l11.245" class="difflineplus">+NS_IMETHODIMP nsMsgAttachmentHandler::GetCharset(nsACString &amp;aCharset) {</span>
<a href="#l11.246"></a><span id="l11.246">   aCharset.Assign(m_charset);</span>
<a href="#l11.247"></a><span id="l11.247">   return NS_OK;</span>
<a href="#l11.248"></a><span id="l11.248"> }</span>
<a href="#l11.249"></a><span id="l11.249"> </span>
<a href="#l11.250"></a><span id="l11.250" class="difflineminus">-NS_IMETHODIMP nsMsgAttachmentHandler::GetEncoding(nsACString&amp; aEncoding)</span>
<a href="#l11.251"></a><span id="l11.251" class="difflineminus">-{</span>
<a href="#l11.252"></a><span id="l11.252" class="difflineplus">+NS_IMETHODIMP nsMsgAttachmentHandler::GetEncoding(nsACString &amp;aEncoding) {</span>
<a href="#l11.253"></a><span id="l11.253">   aEncoding.Assign(m_encoding);</span>
<a href="#l11.254"></a><span id="l11.254">   return NS_OK;</span>
<a href="#l11.255"></a><span id="l11.255"> }</span>
<a href="#l11.256"></a><span id="l11.256"> </span>
<a href="#l11.257"></a><span id="l11.257" class="difflineminus">-NS_IMETHODIMP nsMsgAttachmentHandler::GetAlreadyEncoded(bool* aAlreadyEncoded)</span>
<a href="#l11.258"></a><span id="l11.258" class="difflineminus">-{</span>
<a href="#l11.259"></a><span id="l11.259" class="difflineplus">+NS_IMETHODIMP nsMsgAttachmentHandler::GetAlreadyEncoded(bool *aAlreadyEncoded) {</span>
<a href="#l11.260"></a><span id="l11.260">   NS_ENSURE_ARG_POINTER(aAlreadyEncoded);</span>
<a href="#l11.261"></a><span id="l11.261">   *aAlreadyEncoded = m_already_encoded_p;</span>
<a href="#l11.262"></a><span id="l11.262">   return NS_OK;</span>
<a href="#l11.263"></a><span id="l11.263"> }</span>
<a href="#l11.264"></a><span id="l11.264"> </span>
<a href="#l11.265"></a><span id="l11.265"> // Local methods.</span>
<a href="#l11.266"></a><span id="l11.266"> </span>
<a href="#l11.267"></a><span id="l11.267" class="difflineminus">-void</span>
<a href="#l11.268"></a><span id="l11.268" class="difflineminus">-nsMsgAttachmentHandler::CleanupTempFile()</span>
<a href="#l11.269"></a><span id="l11.269" class="difflineminus">-{</span>
<a href="#l11.270"></a><span id="l11.270" class="difflineplus">+void nsMsgAttachmentHandler::CleanupTempFile() {</span>
<a href="#l11.271"></a><span id="l11.271"> #ifdef XP_MACOSX</span>
<a href="#l11.272"></a><span id="l11.272">   if (mEncodedWorkingFile) {</span>
<a href="#l11.273"></a><span id="l11.273">     mEncodedWorkingFile-&gt;Remove(false);</span>
<a href="#l11.274"></a><span id="l11.274">     mEncodedWorkingFile = nullptr;</span>
<a href="#l11.275"></a><span id="l11.275">   }</span>
<a href="#l11.276"></a><span id="l11.276" class="difflineminus">-#endif // XP_MACOSX</span>
<a href="#l11.277"></a><span id="l11.277" class="difflineplus">+#endif  // XP_MACOSX</span>
<a href="#l11.278"></a><span id="l11.278"> }</span>
<a href="#l11.279"></a><span id="l11.279"> </span>
<a href="#l11.280"></a><span id="l11.280" class="difflineminus">-void</span>
<a href="#l11.281"></a><span id="l11.281" class="difflineminus">-nsMsgAttachmentHandler::AnalyzeDataChunk(const char *chunk, int32_t length)</span>
<a href="#l11.282"></a><span id="l11.282" class="difflineminus">-{</span>
<a href="#l11.283"></a><span id="l11.283" class="difflineminus">-  unsigned char *s = (unsigned char *) chunk;</span>
<a href="#l11.284"></a><span id="l11.284" class="difflineplus">+void nsMsgAttachmentHandler::AnalyzeDataChunk(const char *chunk,</span>
<a href="#l11.285"></a><span id="l11.285" class="difflineplus">+                                              int32_t length) {</span>
<a href="#l11.286"></a><span id="l11.286" class="difflineplus">+  unsigned char *s = (unsigned char *)chunk;</span>
<a href="#l11.287"></a><span id="l11.287">   unsigned char *end = s + length;</span>
<a href="#l11.288"></a><span id="l11.288" class="difflineminus">-  for (; s &lt; end; s++)</span>
<a href="#l11.289"></a><span id="l11.289" class="difflineminus">-  {</span>
<a href="#l11.290"></a><span id="l11.290" class="difflineminus">-    if (*s &gt; 126)</span>
<a href="#l11.291"></a><span id="l11.291" class="difflineminus">-    {</span>
<a href="#l11.292"></a><span id="l11.292" class="difflineplus">+  for (; s &lt; end; s++) {</span>
<a href="#l11.293"></a><span id="l11.293" class="difflineplus">+    if (*s &gt; 126) {</span>
<a href="#l11.294"></a><span id="l11.294">       m_highbit_count++;</span>
<a href="#l11.295"></a><span id="l11.295">       m_unprintable_count++;</span>
<a href="#l11.296"></a><span id="l11.296" class="difflineminus">-    }</span>
<a href="#l11.297"></a><span id="l11.297" class="difflineminus">-    else if (*s &lt; ' ' &amp;&amp; *s != '\t' &amp;&amp; *s != '\r' &amp;&amp; *s != '\n')</span>
<a href="#l11.298"></a><span id="l11.298" class="difflineminus">-    {</span>
<a href="#l11.299"></a><span id="l11.299" class="difflineplus">+    } else if (*s &lt; ' ' &amp;&amp; *s != '\t' &amp;&amp; *s != '\r' &amp;&amp; *s != '\n') {</span>
<a href="#l11.300"></a><span id="l11.300">       m_unprintable_count++;</span>
<a href="#l11.301"></a><span id="l11.301">       m_ctl_count++;</span>
<a href="#l11.302"></a><span id="l11.302" class="difflineminus">-      if (*s == 0)</span>
<a href="#l11.303"></a><span id="l11.303" class="difflineminus">-        m_null_count++;</span>
<a href="#l11.304"></a><span id="l11.304" class="difflineplus">+      if (*s == 0) m_null_count++;</span>
<a href="#l11.305"></a><span id="l11.305">     }</span>
<a href="#l11.306"></a><span id="l11.306"> </span>
<a href="#l11.307"></a><span id="l11.307" class="difflineminus">-    if (*s == '\r' || *s == '\n')</span>
<a href="#l11.308"></a><span id="l11.308" class="difflineminus">-    {</span>
<a href="#l11.309"></a><span id="l11.309" class="difflineminus">-      if (*s == '\r')</span>
<a href="#l11.310"></a><span id="l11.310" class="difflineminus">-      {</span>
<a href="#l11.311"></a><span id="l11.311" class="difflineplus">+    if (*s == '\r' || *s == '\n') {</span>
<a href="#l11.312"></a><span id="l11.312" class="difflineplus">+      if (*s == '\r') {</span>
<a href="#l11.313"></a><span id="l11.313">         if (m_prev_char_was_cr)</span>
<a href="#l11.314"></a><span id="l11.314">           m_have_cr = 1;</span>
<a href="#l11.315"></a><span id="l11.315">         else</span>
<a href="#l11.316"></a><span id="l11.316">           m_prev_char_was_cr = true;</span>
<a href="#l11.317"></a><span id="l11.317" class="difflineminus">-      }</span>
<a href="#l11.318"></a><span id="l11.318" class="difflineminus">-      else</span>
<a href="#l11.319"></a><span id="l11.319" class="difflineminus">-      {</span>
<a href="#l11.320"></a><span id="l11.320" class="difflineminus">-        if (m_prev_char_was_cr)</span>
<a href="#l11.321"></a><span id="l11.321" class="difflineminus">-        {</span>
<a href="#l11.322"></a><span id="l11.322" class="difflineminus">-          if (m_current_column == 0)</span>
<a href="#l11.323"></a><span id="l11.323" class="difflineminus">-          {</span>
<a href="#l11.324"></a><span id="l11.324" class="difflineplus">+      } else {</span>
<a href="#l11.325"></a><span id="l11.325" class="difflineplus">+        if (m_prev_char_was_cr) {</span>
<a href="#l11.326"></a><span id="l11.326" class="difflineplus">+          if (m_current_column == 0) {</span>
<a href="#l11.327"></a><span id="l11.327">             m_have_crlf = 1;</span>
<a href="#l11.328"></a><span id="l11.328">             m_lines--;</span>
<a href="#l11.329"></a><span id="l11.329" class="difflineminus">-          }</span>
<a href="#l11.330"></a><span id="l11.330" class="difflineminus">-          else</span>
<a href="#l11.331"></a><span id="l11.331" class="difflineplus">+          } else</span>
<a href="#l11.332"></a><span id="l11.332">             m_have_cr = m_have_lf = 1;</span>
<a href="#l11.333"></a><span id="l11.333">           m_prev_char_was_cr = false;</span>
<a href="#l11.334"></a><span id="l11.334" class="difflineminus">-        }</span>
<a href="#l11.335"></a><span id="l11.335" class="difflineminus">-        else</span>
<a href="#l11.336"></a><span id="l11.336" class="difflineplus">+        } else</span>
<a href="#l11.337"></a><span id="l11.337">           m_have_lf = 1;</span>
<a href="#l11.338"></a><span id="l11.338">       }</span>
<a href="#l11.339"></a><span id="l11.339" class="difflineminus">-      if (m_max_column &lt; m_current_column)</span>
<a href="#l11.340"></a><span id="l11.340" class="difflineminus">-        m_max_column = m_current_column;</span>
<a href="#l11.341"></a><span id="l11.341" class="difflineplus">+      if (m_max_column &lt; m_current_column) m_max_column = m_current_column;</span>
<a href="#l11.342"></a><span id="l11.342">       m_current_column = 0;</span>
<a href="#l11.343"></a><span id="l11.343">       m_lines++;</span>
<a href="#l11.344"></a><span id="l11.344" class="difflineminus">-    }</span>
<a href="#l11.345"></a><span id="l11.345" class="difflineminus">-    else</span>
<a href="#l11.346"></a><span id="l11.346" class="difflineminus">-    {</span>
<a href="#l11.347"></a><span id="l11.347" class="difflineplus">+    } else {</span>
<a href="#l11.348"></a><span id="l11.348">       m_current_column++;</span>
<a href="#l11.349"></a><span id="l11.349">     }</span>
<a href="#l11.350"></a><span id="l11.350">   }</span>
<a href="#l11.351"></a><span id="l11.351">   // Check one last time for the last line. This is also important if there</span>
<a href="#l11.352"></a><span id="l11.352">   // is only one line that doesn't terminate in \n.</span>
<a href="#l11.353"></a><span id="l11.353" class="difflineminus">-  if (m_max_column &lt; m_current_column)</span>
<a href="#l11.354"></a><span id="l11.354" class="difflineminus">-    m_max_column = m_current_column;</span>
<a href="#l11.355"></a><span id="l11.355" class="difflineplus">+  if (m_max_column &lt; m_current_column) m_max_column = m_current_column;</span>
<a href="#l11.356"></a><span id="l11.356"> }</span>
<a href="#l11.357"></a><span id="l11.357"> </span>
<a href="#l11.358"></a><span id="l11.358" class="difflineminus">-void</span>
<a href="#l11.359"></a><span id="l11.359" class="difflineminus">-nsMsgAttachmentHandler::AnalyzeSnarfedFile(void)</span>
<a href="#l11.360"></a><span id="l11.360" class="difflineminus">-{</span>
<a href="#l11.361"></a><span id="l11.361" class="difflineplus">+void nsMsgAttachmentHandler::AnalyzeSnarfedFile(void) {</span>
<a href="#l11.362"></a><span id="l11.362">   char chunk[1024];</span>
<a href="#l11.363"></a><span id="l11.363">   uint32_t numRead = 0;</span>
<a href="#l11.364"></a><span id="l11.364"> </span>
<a href="#l11.365"></a><span id="l11.365" class="difflineminus">-  if (m_file_analyzed)</span>
<a href="#l11.366"></a><span id="l11.366" class="difflineminus">-    return;</span>
<a href="#l11.367"></a><span id="l11.367" class="difflineplus">+  if (m_file_analyzed) return;</span>
<a href="#l11.368"></a><span id="l11.368"> </span>
<a href="#l11.369"></a><span id="l11.369" class="difflineminus">-  if (mTmpFile)</span>
<a href="#l11.370"></a><span id="l11.370" class="difflineminus">-  {</span>
<a href="#l11.371"></a><span id="l11.371" class="difflineplus">+  if (mTmpFile) {</span>
<a href="#l11.372"></a><span id="l11.372">     int64_t fileSize;</span>
<a href="#l11.373"></a><span id="l11.373">     mTmpFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l11.374"></a><span id="l11.374" class="difflineminus">-    m_size = (uint32_t) fileSize;</span>
<a href="#l11.375"></a><span id="l11.375" class="difflineminus">-    nsCOMPtr &lt;nsIInputStream&gt; inputFile;</span>
<a href="#l11.376"></a><span id="l11.376" class="difflineminus">-    nsresult rv = NS_NewLocalFileInputStream(getter_AddRefs(inputFile), mTmpFile);</span>
<a href="#l11.377"></a><span id="l11.377" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l11.378"></a><span id="l11.378" class="difflineminus">-      return;</span>
<a href="#l11.379"></a><span id="l11.379" class="difflineplus">+    m_size = (uint32_t)fileSize;</span>
<a href="#l11.380"></a><span id="l11.380" class="difflineplus">+    nsCOMPtr&lt;nsIInputStream&gt; inputFile;</span>
<a href="#l11.381"></a><span id="l11.381" class="difflineplus">+    nsresult rv =</span>
<a href="#l11.382"></a><span id="l11.382" class="difflineplus">+        NS_NewLocalFileInputStream(getter_AddRefs(inputFile), mTmpFile);</span>
<a href="#l11.383"></a><span id="l11.383" class="difflineplus">+    if (NS_FAILED(rv)) return;</span>
<a href="#l11.384"></a><span id="l11.384">     {</span>
<a href="#l11.385"></a><span id="l11.385" class="difflineminus">-      do</span>
<a href="#l11.386"></a><span id="l11.386" class="difflineminus">-      {</span>
<a href="#l11.387"></a><span id="l11.387" class="difflineplus">+      do {</span>
<a href="#l11.388"></a><span id="l11.388">         rv = inputFile-&gt;Read(chunk, sizeof(chunk), &amp;numRead);</span>
<a href="#l11.389"></a><span id="l11.389" class="difflineminus">-        if (numRead)</span>
<a href="#l11.390"></a><span id="l11.390" class="difflineminus">-          AnalyzeDataChunk(chunk, numRead);</span>
<a href="#l11.391"></a><span id="l11.391" class="difflineminus">-      }</span>
<a href="#l11.392"></a><span id="l11.392" class="difflineminus">-      while (numRead &amp;&amp; NS_SUCCEEDED(rv));</span>
<a href="#l11.393"></a><span id="l11.393" class="difflineminus">-      if (m_prev_char_was_cr)</span>
<a href="#l11.394"></a><span id="l11.394" class="difflineminus">-        m_have_cr = 1;</span>
<a href="#l11.395"></a><span id="l11.395" class="difflineplus">+        if (numRead) AnalyzeDataChunk(chunk, numRead);</span>
<a href="#l11.396"></a><span id="l11.396" class="difflineplus">+      } while (numRead &amp;&amp; NS_SUCCEEDED(rv));</span>
<a href="#l11.397"></a><span id="l11.397" class="difflineplus">+      if (m_prev_char_was_cr) m_have_cr = 1;</span>
<a href="#l11.398"></a><span id="l11.398"> </span>
<a href="#l11.399"></a><span id="l11.399">       inputFile-&gt;Close();</span>
<a href="#l11.400"></a><span id="l11.400">       m_file_analyzed = true;</span>
<a href="#l11.401"></a><span id="l11.401">     }</span>
<a href="#l11.402"></a><span id="l11.402">   }</span>
<a href="#l11.403"></a><span id="l11.403"> }</span>
<a href="#l11.404"></a><span id="l11.404"> </span>
<a href="#l11.405"></a><span id="l11.405"> //</span>
<a href="#l11.406"></a><span id="l11.406"> // Given a content-type and some info about the contents of the document,</span>
<a href="#l11.407"></a><span id="l11.407"> // decide what encoding it should have.</span>
<a href="#l11.408"></a><span id="l11.408"> //</span>
<a href="#l11.409"></a><span id="l11.409" class="difflineminus">-nsresult</span>
<a href="#l11.410"></a><span id="l11.410" class="difflineminus">-nsMsgAttachmentHandler::PickEncoding(const char *charset, nsIMsgSend *mime_delivery_state)</span>
<a href="#l11.411"></a><span id="l11.411" class="difflineminus">-{</span>
<a href="#l11.412"></a><span id="l11.412" class="difflineplus">+nsresult nsMsgAttachmentHandler::PickEncoding(const char *charset,</span>
<a href="#l11.413"></a><span id="l11.413" class="difflineplus">+                                              nsIMsgSend *mime_delivery_state) {</span>
<a href="#l11.414"></a><span id="l11.414">   nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l11.415"></a><span id="l11.415"> </span>
<a href="#l11.416"></a><span id="l11.416">   bool needsB64 = false;</span>
<a href="#l11.417"></a><span id="l11.417">   bool forceB64 = false;</span>
<a href="#l11.418"></a><span id="l11.418">   bool isUsingQP = false;</span>
<a href="#l11.419"></a><span id="l11.419"> </span>
<a href="#l11.420"></a><span id="l11.420" class="difflineminus">-  if (mSendViaCloud)</span>
<a href="#l11.421"></a><span id="l11.421" class="difflineminus">-  {</span>
<a href="#l11.422"></a><span id="l11.422" class="difflineplus">+  if (mSendViaCloud) {</span>
<a href="#l11.423"></a><span id="l11.423">     m_encoding = ENCODING_7BIT;</span>
<a href="#l11.424"></a><span id="l11.424">     return NS_OK;</span>
<a href="#l11.425"></a><span id="l11.425">   }</span>
<a href="#l11.426"></a><span id="l11.426" class="difflineminus">-  if (m_already_encoded_p)</span>
<a href="#l11.427"></a><span id="l11.427" class="difflineminus">-    goto DONE;</span>
<a href="#l11.428"></a><span id="l11.428" class="difflineplus">+  if (m_already_encoded_p) goto DONE;</span>
<a href="#l11.429"></a><span id="l11.429"> </span>
<a href="#l11.430"></a><span id="l11.430">   AnalyzeSnarfedFile();</span>
<a href="#l11.431"></a><span id="l11.431"> </span>
<a href="#l11.432"></a><span id="l11.432">   // Allow users to override our percentage-wise guess on whether</span>
<a href="#l11.433"></a><span id="l11.433">   // the file is text or binary.</span>
<a href="#l11.434"></a><span id="l11.434">   if (pPrefBranch)</span>
<a href="#l11.435"></a><span id="l11.435" class="difflineminus">-    pPrefBranch-&gt;GetBoolPref (&quot;mail.file_attach_binary&quot;, &amp;forceB64);</span>
<a href="#l11.436"></a><span id="l11.436" class="difflineplus">+    pPrefBranch-&gt;GetBoolPref(&quot;mail.file_attach_binary&quot;, &amp;forceB64);</span>
<a href="#l11.437"></a><span id="l11.437"> </span>
<a href="#l11.438"></a><span id="l11.438">   // If the content-type is &quot;image/&quot; or something else known to be binary or</span>
<a href="#l11.439"></a><span id="l11.439">   // several flavors of newlines are present, use base64 unless we're attaching</span>
<a href="#l11.440"></a><span id="l11.440">   // a message (so that we don't get confused by newline conversions).</span>
<a href="#l11.441"></a><span id="l11.441">   if (!mMainBody &amp;&amp;</span>
<a href="#l11.442"></a><span id="l11.442">       (forceB64 || mime_type_requires_b64_p(m_type.get()) ||</span>
<a href="#l11.443"></a><span id="l11.443" class="difflineminus">-                   m_have_cr + m_have_lf + m_have_crlf != 1) &amp;&amp;</span>
<a href="#l11.444"></a><span id="l11.444" class="difflineminus">-      !m_type.LowerCaseEqualsLiteral(MESSAGE_RFC822))</span>
<a href="#l11.445"></a><span id="l11.445" class="difflineminus">-  {</span>
<a href="#l11.446"></a><span id="l11.446" class="difflineplus">+       m_have_cr + m_have_lf + m_have_crlf != 1) &amp;&amp;</span>
<a href="#l11.447"></a><span id="l11.447" class="difflineplus">+      !m_type.LowerCaseEqualsLiteral(MESSAGE_RFC822)) {</span>
<a href="#l11.448"></a><span id="l11.448">     needsB64 = true;</span>
<a href="#l11.449"></a><span id="l11.449" class="difflineminus">-  }</span>
<a href="#l11.450"></a><span id="l11.450" class="difflineminus">-  else</span>
<a href="#l11.451"></a><span id="l11.451" class="difflineminus">-  {</span>
<a href="#l11.452"></a><span id="l11.452" class="difflineplus">+  } else {</span>
<a href="#l11.453"></a><span id="l11.453">     // Otherwise, we need to pick an encoding based on the contents of the</span>
<a href="#l11.454"></a><span id="l11.454">     // document.</span>
<a href="#l11.455"></a><span id="l11.455">     bool encode_p;</span>
<a href="#l11.456"></a><span id="l11.456">     bool force_p = false;</span>
<a href="#l11.457"></a><span id="l11.457"> </span>
<a href="#l11.458"></a><span id="l11.458">     // Force quoted-printable if the sender does not allow conversion to 7bit.</span>
<a href="#l11.459"></a><span id="l11.459">     if (mCompFields) {</span>
<a href="#l11.460"></a><span id="l11.460" class="difflineminus">-      if (mCompFields-&gt;GetForceMsgEncoding())</span>
<a href="#l11.461"></a><span id="l11.461" class="difflineminus">-        force_p = true;</span>
<a href="#l11.462"></a><span id="l11.462" class="difflineplus">+      if (mCompFields-&gt;GetForceMsgEncoding()) force_p = true;</span>
<a href="#l11.463"></a><span id="l11.463">     } else if (mime_delivery_state) {</span>
<a href="#l11.464"></a><span id="l11.464" class="difflineminus">-      if (((nsMsgComposeAndSend *)mime_delivery_state)-&gt;mCompFields-&gt;GetForceMsgEncoding()) {</span>
<a href="#l11.465"></a><span id="l11.465" class="difflineplus">+      if (((nsMsgComposeAndSend *)mime_delivery_state)</span>
<a href="#l11.466"></a><span id="l11.466" class="difflineplus">+              -&gt;mCompFields-&gt;GetForceMsgEncoding()) {</span>
<a href="#l11.467"></a><span id="l11.467">         force_p = true;</span>
<a href="#l11.468"></a><span id="l11.468">       }</span>
<a href="#l11.469"></a><span id="l11.469">     }</span>
<a href="#l11.470"></a><span id="l11.470"> </span>
<a href="#l11.471"></a><span id="l11.471">     if (force_p || (m_max_column &gt; LINELENGTH_ENCODING_THRESHOLD)) {</span>
<a href="#l11.472"></a><span id="l11.472">       encode_p = true;</span>
<a href="#l11.473"></a><span id="l11.473">     } else if (UseQuotedPrintable() &amp;&amp; m_unprintable_count) {</span>
<a href="#l11.474"></a><span id="l11.474">       encode_p = true;</span>
<a href="#l11.475"></a><span id="l11.475" class="difflineat">@@ -409,83 +356,77 @@ nsMsgAttachmentHandler::PickEncoding(con</span>
<a href="#l11.476"></a><span id="l11.476">     } else {</span>
<a href="#l11.477"></a><span id="l11.477">       encode_p = false;</span>
<a href="#l11.478"></a><span id="l11.478">     }</span>
<a href="#l11.479"></a><span id="l11.479"> </span>
<a href="#l11.480"></a><span id="l11.480">     // MIME requires a special case that these types never be encoded.</span>
<a href="#l11.481"></a><span id="l11.481">     if (StringBeginsWith(m_type, NS_LITERAL_CSTRING(&quot;message&quot;),</span>
<a href="#l11.482"></a><span id="l11.482">                          nsCaseInsensitiveCStringComparator()) ||</span>
<a href="#l11.483"></a><span id="l11.483">         StringBeginsWith(m_type, NS_LITERAL_CSTRING(&quot;multipart&quot;),</span>
<a href="#l11.484"></a><span id="l11.484" class="difflineminus">-                         nsCaseInsensitiveCStringComparator()))</span>
<a href="#l11.485"></a><span id="l11.485" class="difflineminus">-    {</span>
<a href="#l11.486"></a><span id="l11.486" class="difflineplus">+                         nsCaseInsensitiveCStringComparator())) {</span>
<a href="#l11.487"></a><span id="l11.487">       encode_p = false;</span>
<a href="#l11.488"></a><span id="l11.488">       if (m_desiredType.LowerCaseEqualsLiteral(TEXT_PLAIN))</span>
<a href="#l11.489"></a><span id="l11.489">         m_desiredType.Truncate();</span>
<a href="#l11.490"></a><span id="l11.490">     }</span>
<a href="#l11.491"></a><span id="l11.491"> </span>
<a href="#l11.492"></a><span id="l11.492" class="difflineminus">-    // If the Mail charset is multibyte, we force it to use Base64 for attachments.</span>
<a href="#l11.493"></a><span id="l11.493" class="difflineplus">+    // If the Mail charset is multibyte, we force it to use Base64 for</span>
<a href="#l11.494"></a><span id="l11.494" class="difflineplus">+    // attachments.</span>
<a href="#l11.495"></a><span id="l11.495">     if ((!mMainBody &amp;&amp; charset &amp;&amp; nsMsgI18Nmultibyte_charset(charset)) &amp;&amp;</span>
<a href="#l11.496"></a><span id="l11.496">         (m_type.LowerCaseEqualsLiteral(TEXT_HTML) ||</span>
<a href="#l11.497"></a><span id="l11.497">          m_type.LowerCaseEqualsLiteral(TEXT_MDL) ||</span>
<a href="#l11.498"></a><span id="l11.498">          m_type.LowerCaseEqualsLiteral(TEXT_PLAIN) ||</span>
<a href="#l11.499"></a><span id="l11.499">          m_type.LowerCaseEqualsLiteral(TEXT_RICHTEXT) ||</span>
<a href="#l11.500"></a><span id="l11.500">          m_type.LowerCaseEqualsLiteral(TEXT_ENRICHED) ||</span>
<a href="#l11.501"></a><span id="l11.501">          m_type.LowerCaseEqualsLiteral(TEXT_VCARD) ||</span>
<a href="#l11.502"></a><span id="l11.502" class="difflineminus">-         m_type.LowerCaseEqualsLiteral(APPLICATION_DIRECTORY) || /* text/x-vcard synonym */</span>
<a href="#l11.503"></a><span id="l11.503" class="difflineplus">+         m_type.LowerCaseEqualsLiteral(</span>
<a href="#l11.504"></a><span id="l11.504" class="difflineplus">+             APPLICATION_DIRECTORY) || /* text/x-vcard synonym */</span>
<a href="#l11.505"></a><span id="l11.505">          m_type.LowerCaseEqualsLiteral(TEXT_CSS) ||</span>
<a href="#l11.506"></a><span id="l11.506">          m_type.LowerCaseEqualsLiteral(TEXT_JSSS))) {</span>
<a href="#l11.507"></a><span id="l11.507">       needsB64 = true;</span>
<a href="#l11.508"></a><span id="l11.508">     } else if (charset &amp;&amp; nsMsgI18Nstateful_charset(charset)) {</span>
<a href="#l11.509"></a><span id="l11.509">       m_encoding = ENCODING_7BIT;</span>
<a href="#l11.510"></a><span id="l11.510" class="difflineminus">-    } else if (encode_p &amp;&amp;</span>
<a href="#l11.511"></a><span id="l11.511" class="difflineminus">-      m_unprintable_count &gt; (m_size / 10)) {</span>
<a href="#l11.512"></a><span id="l11.512" class="difflineplus">+    } else if (encode_p &amp;&amp; m_unprintable_count &gt; (m_size / 10)) {</span>
<a href="#l11.513"></a><span id="l11.513">       // If the document contains more than 10% unprintable characters,</span>
<a href="#l11.514"></a><span id="l11.514">       // then that seems like a good candidate for base64 instead of</span>
<a href="#l11.515"></a><span id="l11.515">       // quoted-printable.</span>
<a href="#l11.516"></a><span id="l11.516">       needsB64 = true;</span>
<a href="#l11.517"></a><span id="l11.517">     } else if (encode_p) {</span>
<a href="#l11.518"></a><span id="l11.518">       m_encoding = ENCODING_QUOTED_PRINTABLE;</span>
<a href="#l11.519"></a><span id="l11.519">       isUsingQP = true;</span>
<a href="#l11.520"></a><span id="l11.520">     } else if (m_highbit_count &gt; 0) {</span>
<a href="#l11.521"></a><span id="l11.521">       m_encoding = ENCODING_8BIT;</span>
<a href="#l11.522"></a><span id="l11.522">     } else {</span>
<a href="#l11.523"></a><span id="l11.523">       m_encoding = ENCODING_7BIT;</span>
<a href="#l11.524"></a><span id="l11.524">     }</span>
<a href="#l11.525"></a><span id="l11.525">   }</span>
<a href="#l11.526"></a><span id="l11.526"> </span>
<a href="#l11.527"></a><span id="l11.527">   // Always base64 binary data.</span>
<a href="#l11.528"></a><span id="l11.528" class="difflineminus">-  if (needsB64)</span>
<a href="#l11.529"></a><span id="l11.529" class="difflineminus">-    m_encoding = ENCODING_BASE64;</span>
<a href="#l11.530"></a><span id="l11.530" class="difflineplus">+  if (needsB64) m_encoding = ENCODING_BASE64;</span>
<a href="#l11.531"></a><span id="l11.531"> </span>
<a href="#l11.532"></a><span id="l11.532">   // According to RFC 821 we must always have lines shorter than 998 bytes.</span>
<a href="#l11.533"></a><span id="l11.533">   // To encode &quot;long lines&quot; use a CTE that will transmit shorter lines.</span>
<a href="#l11.534"></a><span id="l11.534">   // Switch to base64 if we are not already using &quot;quoted printable&quot;.</span>
<a href="#l11.535"></a><span id="l11.535"> </span>
<a href="#l11.536"></a><span id="l11.536">   // We don't do this for message/rfc822 attachments, since we can't</span>
<a href="#l11.537"></a><span id="l11.537">   // change the original Content-Transfer-Encoding of the message we're</span>
<a href="#l11.538"></a><span id="l11.538">   // attaching. We rely on the original message complying with RFC 821,</span>
<a href="#l11.539"></a><span id="l11.539">   // if it doesn't we won't either. Not ideal.</span>
<a href="#l11.540"></a><span id="l11.540">   if (!m_type.LowerCaseEqualsLiteral(MESSAGE_RFC822) &amp;&amp;</span>
<a href="#l11.541"></a><span id="l11.541">       m_max_column &gt; LINELENGTH_ENCODING_THRESHOLD &amp;&amp; !isUsingQP)</span>
<a href="#l11.542"></a><span id="l11.542">     m_encoding = ENCODING_BASE64;</span>
<a href="#l11.543"></a><span id="l11.543"> </span>
<a href="#l11.544"></a><span id="l11.544">   // Now that we've picked an encoding, initialize the filter.</span>
<a href="#l11.545"></a><span id="l11.545">   NS_ASSERTION(!m_encoder, &quot;not-null m_encoder&quot;);</span>
<a href="#l11.546"></a><span id="l11.546" class="difflineminus">-  if (m_encoding.LowerCaseEqualsLiteral(ENCODING_BASE64))</span>
<a href="#l11.547"></a><span id="l11.547" class="difflineminus">-  {</span>
<a href="#l11.548"></a><span id="l11.548" class="difflineplus">+  if (m_encoding.LowerCaseEqualsLiteral(ENCODING_BASE64)) {</span>
<a href="#l11.549"></a><span id="l11.549">     m_encoder = MimeEncoder::GetBase64Encoder(mime_encoder_output_fn,</span>
<a href="#l11.550"></a><span id="l11.550" class="difflineminus">-      mime_delivery_state);</span>
<a href="#l11.551"></a><span id="l11.551" class="difflineminus">-  }</span>
<a href="#l11.552"></a><span id="l11.552" class="difflineminus">-  else if (m_encoding.LowerCaseEqualsLiteral(ENCODING_QUOTED_PRINTABLE))</span>
<a href="#l11.553"></a><span id="l11.553" class="difflineminus">-  {</span>
<a href="#l11.554"></a><span id="l11.554" class="difflineminus">-    m_encoder = MimeEncoder::GetQPEncoder(mime_encoder_output_fn,</span>
<a href="#l11.555"></a><span id="l11.555" class="difflineminus">-      mime_delivery_state);</span>
<a href="#l11.556"></a><span id="l11.556" class="difflineminus">-  }</span>
<a href="#l11.557"></a><span id="l11.557" class="difflineminus">-  else</span>
<a href="#l11.558"></a><span id="l11.558" class="difflineminus">-  {</span>
<a href="#l11.559"></a><span id="l11.559" class="difflineplus">+                                              mime_delivery_state);</span>
<a href="#l11.560"></a><span id="l11.560" class="difflineplus">+  } else if (m_encoding.LowerCaseEqualsLiteral(ENCODING_QUOTED_PRINTABLE)) {</span>
<a href="#l11.561"></a><span id="l11.561" class="difflineplus">+    m_encoder =</span>
<a href="#l11.562"></a><span id="l11.562" class="difflineplus">+        MimeEncoder::GetQPEncoder(mime_encoder_output_fn, mime_delivery_state);</span>
<a href="#l11.563"></a><span id="l11.563" class="difflineplus">+  } else {</span>
<a href="#l11.564"></a><span id="l11.564">     m_encoder = nullptr;</span>
<a href="#l11.565"></a><span id="l11.565">   }</span>
<a href="#l11.566"></a><span id="l11.566"> </span>
<a href="#l11.567"></a><span id="l11.567">   /*</span>
<a href="#l11.568"></a><span id="l11.568">     Do some cleanup for documents with unknown content type.</span>
<a href="#l11.569"></a><span id="l11.569">     There are two issues: how they look to MIME users, and how they look to</span>
<a href="#l11.570"></a><span id="l11.570">     non-MIME users.</span>
<a href="#l11.571"></a><span id="l11.571"> </span>
<a href="#l11.572"></a><span id="l11.572" class="difflineat">@@ -501,262 +442,234 @@ nsMsgAttachmentHandler::PickEncoding(con</span>
<a href="#l11.573"></a><span id="l11.573">     bad charset things happen as well.</span>
<a href="#l11.574"></a><span id="l11.574"> </span>
<a href="#l11.575"></a><span id="l11.575">     So, the heuristic we use is, if the type is unknown, then the type is</span>
<a href="#l11.576"></a><span id="l11.576">     set to application/octet-stream for data which needs base64 (binary data)</span>
<a href="#l11.577"></a><span id="l11.577">     and is set to text/plain for data which didn't need base64 (unencoded or</span>
<a href="#l11.578"></a><span id="l11.578">     lightly encoded data.)</span>
<a href="#l11.579"></a><span id="l11.579">   */</span>
<a href="#l11.580"></a><span id="l11.580"> DONE:</span>
<a href="#l11.581"></a><span id="l11.581" class="difflineminus">-  if (m_type.IsEmpty() || m_type.LowerCaseEqualsLiteral(UNKNOWN_CONTENT_TYPE))</span>
<a href="#l11.582"></a><span id="l11.582" class="difflineminus">-  {</span>
<a href="#l11.583"></a><span id="l11.583" class="difflineplus">+  if (m_type.IsEmpty() || m_type.LowerCaseEqualsLiteral(UNKNOWN_CONTENT_TYPE)) {</span>
<a href="#l11.584"></a><span id="l11.584">     if (m_already_encoded_p)</span>
<a href="#l11.585"></a><span id="l11.585">       m_type = APPLICATION_OCTET_STREAM;</span>
<a href="#l11.586"></a><span id="l11.586">     else if (m_encoding.LowerCaseEqualsLiteral(ENCODING_BASE64) ||</span>
<a href="#l11.587"></a><span id="l11.587">              m_encoding.LowerCaseEqualsLiteral(ENCODING_UUENCODE))</span>
<a href="#l11.588"></a><span id="l11.588">       m_type = APPLICATION_OCTET_STREAM;</span>
<a href="#l11.589"></a><span id="l11.589">     else</span>
<a href="#l11.590"></a><span id="l11.590">       m_type = TEXT_PLAIN;</span>
<a href="#l11.591"></a><span id="l11.591">   }</span>
<a href="#l11.592"></a><span id="l11.592">   return NS_OK;</span>
<a href="#l11.593"></a><span id="l11.593"> }</span>
<a href="#l11.594"></a><span id="l11.594"> </span>
<a href="#l11.595"></a><span id="l11.595" class="difflineminus">-nsresult</span>
<a href="#l11.596"></a><span id="l11.596" class="difflineminus">-nsMsgAttachmentHandler::PickCharset()</span>
<a href="#l11.597"></a><span id="l11.597" class="difflineminus">-{</span>
<a href="#l11.598"></a><span id="l11.598" class="difflineplus">+nsresult nsMsgAttachmentHandler::PickCharset() {</span>
<a href="#l11.599"></a><span id="l11.599">   if (!m_charset.IsEmpty() || !m_type.LowerCaseEqualsLiteral(TEXT_PLAIN))</span>
<a href="#l11.600"></a><span id="l11.600">     return NS_OK;</span>
<a href="#l11.601"></a><span id="l11.601"> </span>
<a href="#l11.602"></a><span id="l11.602" class="difflineminus">-  if (!mTmpFile)</span>
<a href="#l11.603"></a><span id="l11.603" class="difflineminus">-    return NS_OK;</span>
<a href="#l11.604"></a><span id="l11.604" class="difflineplus">+  if (!mTmpFile) return NS_OK;</span>
<a href="#l11.605"></a><span id="l11.605"> </span>
<a href="#l11.606"></a><span id="l11.606">   return MsgDetectCharsetFromFile(mTmpFile, m_charset);</span>
<a href="#l11.607"></a><span id="l11.607"> }</span>
<a href="#l11.608"></a><span id="l11.608"> </span>
<a href="#l11.609"></a><span id="l11.609" class="difflineminus">-static nsresult</span>
<a href="#l11.610"></a><span id="l11.610" class="difflineminus">-FetcherURLDoneCallback(nsresult aStatus,</span>
<a href="#l11.611"></a><span id="l11.611" class="difflineminus">-                       const nsACString &amp;aContentType,</span>
<a href="#l11.612"></a><span id="l11.612" class="difflineminus">-                       const nsACString &amp;aCharset,</span>
<a href="#l11.613"></a><span id="l11.613" class="difflineminus">-                       int32_t totalSize,</span>
<a href="#l11.614"></a><span id="l11.614" class="difflineminus">-                       const char16_t* aMsg, void *tagData)</span>
<a href="#l11.615"></a><span id="l11.615" class="difflineminus">-{</span>
<a href="#l11.616"></a><span id="l11.616" class="difflineminus">-  nsMsgAttachmentHandler *ma = (nsMsgAttachmentHandler *) tagData;</span>
<a href="#l11.617"></a><span id="l11.617" class="difflineplus">+static nsresult FetcherURLDoneCallback(nsresult aStatus,</span>
<a href="#l11.618"></a><span id="l11.618" class="difflineplus">+                                       const nsACString &amp;aContentType,</span>
<a href="#l11.619"></a><span id="l11.619" class="difflineplus">+                                       const nsACString &amp;aCharset,</span>
<a href="#l11.620"></a><span id="l11.620" class="difflineplus">+                                       int32_t totalSize, const char16_t *aMsg,</span>
<a href="#l11.621"></a><span id="l11.621" class="difflineplus">+                                       void *tagData) {</span>
<a href="#l11.622"></a><span id="l11.622" class="difflineplus">+  nsMsgAttachmentHandler *ma = (nsMsgAttachmentHandler *)tagData;</span>
<a href="#l11.623"></a><span id="l11.623">   NS_ASSERTION(ma != nullptr, &quot;not-null mime attachment&quot;);</span>
<a href="#l11.624"></a><span id="l11.624"> </span>
<a href="#l11.625"></a><span id="l11.625" class="difflineminus">-  if (ma != nullptr)</span>
<a href="#l11.626"></a><span id="l11.626" class="difflineminus">-  {</span>
<a href="#l11.627"></a><span id="l11.627" class="difflineplus">+  if (ma != nullptr) {</span>
<a href="#l11.628"></a><span id="l11.628">     ma-&gt;m_size = totalSize;</span>
<a href="#l11.629"></a><span id="l11.629" class="difflineminus">-    if (!aContentType.IsEmpty())</span>
<a href="#l11.630"></a><span id="l11.630" class="difflineminus">-    {</span>
<a href="#l11.631"></a><span id="l11.631" class="difflineplus">+    if (!aContentType.IsEmpty()) {</span>
<a href="#l11.632"></a><span id="l11.632"> #ifdef XP_MACOSX</span>
<a href="#l11.633"></a><span id="l11.633" class="difflineminus">-      //Do not change the type if we are dealing with an encoded (e.g., appledouble or zip) file</span>
<a href="#l11.634"></a><span id="l11.634" class="difflineplus">+      // Do not change the type if we are dealing with an encoded (e.g.,</span>
<a href="#l11.635"></a><span id="l11.635" class="difflineplus">+      // appledouble or zip) file</span>
<a href="#l11.636"></a><span id="l11.636">       if (!ma-&gt;mEncodedWorkingFile)</span>
<a href="#l11.637"></a><span id="l11.637"> #else</span>
<a href="#l11.638"></a><span id="l11.638" class="difflineminus">-        // can't send appledouble on non-macs</span>
<a href="#l11.639"></a><span id="l11.639" class="difflineplus">+      // can't send appledouble on non-macs</span>
<a href="#l11.640"></a><span id="l11.640">       if (!aContentType.EqualsLiteral(&quot;multipart/appledouble&quot;))</span>
<a href="#l11.641"></a><span id="l11.641"> #endif</span>
<a href="#l11.642"></a><span id="l11.642">         ma-&gt;m_type = aContentType;</span>
<a href="#l11.643"></a><span id="l11.643">     }</span>
<a href="#l11.644"></a><span id="l11.644"> </span>
<a href="#l11.645"></a><span id="l11.645" class="difflineminus">-    if (!aCharset.IsEmpty())</span>
<a href="#l11.646"></a><span id="l11.646" class="difflineminus">-      ma-&gt;m_charset = aCharset;</span>
<a href="#l11.647"></a><span id="l11.647" class="difflineplus">+    if (!aCharset.IsEmpty()) ma-&gt;m_charset = aCharset;</span>
<a href="#l11.648"></a><span id="l11.648"> </span>
<a href="#l11.649"></a><span id="l11.649">     return ma-&gt;UrlExit(aStatus, aMsg);</span>
<a href="#l11.650"></a><span id="l11.650" class="difflineminus">-  }</span>
<a href="#l11.651"></a><span id="l11.651" class="difflineminus">-  else</span>
<a href="#l11.652"></a><span id="l11.652" class="difflineplus">+  } else</span>
<a href="#l11.653"></a><span id="l11.653">     return NS_OK;</span>
<a href="#l11.654"></a><span id="l11.654"> }</span>
<a href="#l11.655"></a><span id="l11.655"> </span>
<a href="#l11.656"></a><span id="l11.656" class="difflineminus">-nsresult</span>
<a href="#l11.657"></a><span id="l11.657" class="difflineminus">-nsMsgAttachmentHandler::SnarfMsgAttachment(nsMsgCompFields *compFields)</span>
<a href="#l11.658"></a><span id="l11.658" class="difflineminus">-{</span>
<a href="#l11.659"></a><span id="l11.659" class="difflineplus">+nsresult nsMsgAttachmentHandler::SnarfMsgAttachment(</span>
<a href="#l11.660"></a><span id="l11.660" class="difflineplus">+    nsMsgCompFields *compFields) {</span>
<a href="#l11.661"></a><span id="l11.661">   nsresult rv = NS_ERROR_INVALID_ARG;</span>
<a href="#l11.662"></a><span id="l11.662" class="difflineminus">-  nsCOMPtr &lt;nsIMsgMessageService&gt; messageService;</span>
<a href="#l11.663"></a><span id="l11.663" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMessageService&gt; messageService;</span>
<a href="#l11.664"></a><span id="l11.664"> </span>
<a href="#l11.665"></a><span id="l11.665" class="difflineminus">-  if (m_uri.Find(&quot;-message:&quot;, /* ignoreCase = */ true) != -1)</span>
<a href="#l11.666"></a><span id="l11.666" class="difflineminus">-  {</span>
<a href="#l11.667"></a><span id="l11.667" class="difflineminus">-    nsCOMPtr &lt;nsIFile&gt; tmpFile;</span>
<a href="#l11.668"></a><span id="l11.668" class="difflineplus">+  if (m_uri.Find(&quot;-message:&quot;, /* ignoreCase = */ true) != -1) {</span>
<a href="#l11.669"></a><span id="l11.669" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; tmpFile;</span>
<a href="#l11.670"></a><span id="l11.670">     rv = nsMsgCreateTempFile(&quot;nsmail.tmp&quot;, getter_AddRefs(tmpFile));</span>
<a href="#l11.671"></a><span id="l11.671">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.672"></a><span id="l11.672">     mTmpFile = tmpFile;</span>
<a href="#l11.673"></a><span id="l11.673">     mDeleteFile = true;</span>
<a href="#l11.674"></a><span id="l11.674">     mCompFields = compFields;</span>
<a href="#l11.675"></a><span id="l11.675">     m_type = MESSAGE_RFC822;</span>
<a href="#l11.676"></a><span id="l11.676">     m_overrideType = MESSAGE_RFC822;</span>
<a href="#l11.677"></a><span id="l11.677" class="difflineminus">-    if (!mTmpFile)</span>
<a href="#l11.678"></a><span id="l11.678" class="difflineminus">-    {</span>
<a href="#l11.679"></a><span id="l11.679" class="difflineplus">+    if (!mTmpFile) {</span>
<a href="#l11.680"></a><span id="l11.680">       rv = NS_ERROR_FAILURE;</span>
<a href="#l11.681"></a><span id="l11.681">       goto done;</span>
<a href="#l11.682"></a><span id="l11.682">     }</span>
<a href="#l11.683"></a><span id="l11.683"> </span>
<a href="#l11.684"></a><span id="l11.684" class="difflineminus">-    rv = MsgNewBufferedFileOutputStream(getter_AddRefs(mOutFile), mTmpFile, -1, 00600);</span>
<a href="#l11.685"></a><span id="l11.685" class="difflineminus">-    if (NS_FAILED(rv) || !mOutFile)</span>
<a href="#l11.686"></a><span id="l11.686" class="difflineminus">-    {</span>
<a href="#l11.687"></a><span id="l11.687" class="difflineminus">-      if (m_mime_delivery_state)</span>
<a href="#l11.688"></a><span id="l11.688" class="difflineminus">-      {</span>
<a href="#l11.689"></a><span id="l11.689" class="difflineplus">+    rv = MsgNewBufferedFileOutputStream(getter_AddRefs(mOutFile), mTmpFile, -1,</span>
<a href="#l11.690"></a><span id="l11.690" class="difflineplus">+                                        00600);</span>
<a href="#l11.691"></a><span id="l11.691" class="difflineplus">+    if (NS_FAILED(rv) || !mOutFile) {</span>
<a href="#l11.692"></a><span id="l11.692" class="difflineplus">+      if (m_mime_delivery_state) {</span>
<a href="#l11.693"></a><span id="l11.693">         nsCOMPtr&lt;nsIMsgSendReport&gt; sendReport;</span>
<a href="#l11.694"></a><span id="l11.694">         m_mime_delivery_state-&gt;GetSendReport(getter_AddRefs(sendReport));</span>
<a href="#l11.695"></a><span id="l11.695" class="difflineminus">-        if (sendReport)</span>
<a href="#l11.696"></a><span id="l11.696" class="difflineminus">-        {</span>
<a href="#l11.697"></a><span id="l11.697" class="difflineplus">+        if (sendReport) {</span>
<a href="#l11.698"></a><span id="l11.698">           nsAutoString error_msg;</span>
<a href="#l11.699"></a><span id="l11.699">           nsMsgBuildMessageWithTmpFile(mTmpFile, error_msg);</span>
<a href="#l11.700"></a><span id="l11.700" class="difflineminus">-          sendReport-&gt;SetMessage(nsIMsgSendReport::process_Current, error_msg.get(), false);</span>
<a href="#l11.701"></a><span id="l11.701" class="difflineplus">+          sendReport-&gt;SetMessage(nsIMsgSendReport::process_Current,</span>
<a href="#l11.702"></a><span id="l11.702" class="difflineplus">+                                 error_msg.get(), false);</span>
<a href="#l11.703"></a><span id="l11.703">         }</span>
<a href="#l11.704"></a><span id="l11.704">       }</span>
<a href="#l11.705"></a><span id="l11.705" class="difflineminus">-      rv =  NS_MSG_UNABLE_TO_OPEN_TMP_FILE;</span>
<a href="#l11.706"></a><span id="l11.706" class="difflineplus">+      rv = NS_MSG_UNABLE_TO_OPEN_TMP_FILE;</span>
<a href="#l11.707"></a><span id="l11.707">       goto done;</span>
<a href="#l11.708"></a><span id="l11.708">     }</span>
<a href="#l11.709"></a><span id="l11.709"> </span>
<a href="#l11.710"></a><span id="l11.710" class="difflineminus">-    nsCOMPtr&lt;nsIURLFetcher&gt; fetcher = do_CreateInstance(NS_URLFETCHER_CONTRACTID, &amp;rv);</span>
<a href="#l11.711"></a><span id="l11.711" class="difflineminus">-    if (NS_FAILED(rv) || !fetcher)</span>
<a href="#l11.712"></a><span id="l11.712" class="difflineminus">-    {</span>
<a href="#l11.713"></a><span id="l11.713" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l11.714"></a><span id="l11.714" class="difflineminus">-        rv =  NS_ERROR_UNEXPECTED;</span>
<a href="#l11.715"></a><span id="l11.715" class="difflineplus">+    nsCOMPtr&lt;nsIURLFetcher&gt; fetcher =</span>
<a href="#l11.716"></a><span id="l11.716" class="difflineplus">+        do_CreateInstance(NS_URLFETCHER_CONTRACTID, &amp;rv);</span>
<a href="#l11.717"></a><span id="l11.717" class="difflineplus">+    if (NS_FAILED(rv) || !fetcher) {</span>
<a href="#l11.718"></a><span id="l11.718" class="difflineplus">+      if (NS_SUCCEEDED(rv)) rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l11.719"></a><span id="l11.719">       goto done;</span>
<a href="#l11.720"></a><span id="l11.720">     }</span>
<a href="#l11.721"></a><span id="l11.721"> </span>
<a href="#l11.722"></a><span id="l11.722">     rv = fetcher-&gt;Initialize(mTmpFile, mOutFile, FetcherURLDoneCallback, this);</span>
<a href="#l11.723"></a><span id="l11.723">     rv = GetMessageServiceFromURI(m_uri, getter_AddRefs(messageService));</span>
<a href="#l11.724"></a><span id="l11.724" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; messageService)</span>
<a href="#l11.725"></a><span id="l11.725" class="difflineminus">-    {</span>
<a href="#l11.726"></a><span id="l11.726" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; messageService) {</span>
<a href="#l11.727"></a><span id="l11.727">       nsAutoCString uri(m_uri);</span>
<a href="#l11.728"></a><span id="l11.728">       uri += (uri.FindChar('?') == kNotFound) ? '?' : '&amp;';</span>
<a href="#l11.729"></a><span id="l11.729">       uri.AppendLiteral(&quot;fetchCompleteMessage=true&quot;);</span>
<a href="#l11.730"></a><span id="l11.730">       nsCOMPtr&lt;nsIStreamListener&gt; strListener = do_QueryInterface(fetcher);</span>
<a href="#l11.731"></a><span id="l11.731"> </span>
<a href="#l11.732"></a><span id="l11.732" class="difflineminus">-      // initialize a new stream converter, that uses the strListener as its input</span>
<a href="#l11.733"></a><span id="l11.733" class="difflineminus">-      // obtain the input stream listener from the new converter,</span>
<a href="#l11.734"></a><span id="l11.734" class="difflineminus">-      // and pass the converter's input stream listener to DisplayMessage</span>
<a href="#l11.735"></a><span id="l11.735" class="difflineplus">+      // initialize a new stream converter, that uses the strListener as its</span>
<a href="#l11.736"></a><span id="l11.736" class="difflineplus">+      // input obtain the input stream listener from the new converter, and pass</span>
<a href="#l11.737"></a><span id="l11.737" class="difflineplus">+      // the converter's input stream listener to DisplayMessage</span>
<a href="#l11.738"></a><span id="l11.738"> </span>
<a href="#l11.739"></a><span id="l11.739" class="difflineminus">-      m_mime_parser = do_CreateInstance(NS_MAILNEWS_MIME_STREAM_CONVERTER_CONTRACTID, &amp;rv);</span>
<a href="#l11.740"></a><span id="l11.740" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l11.741"></a><span id="l11.741" class="difflineminus">-        goto done;</span>
<a href="#l11.742"></a><span id="l11.742" class="difflineplus">+      m_mime_parser =</span>
<a href="#l11.743"></a><span id="l11.743" class="difflineplus">+          do_CreateInstance(NS_MAILNEWS_MIME_STREAM_CONVERTER_CONTRACTID, &amp;rv);</span>
<a href="#l11.744"></a><span id="l11.744" class="difflineplus">+      if (NS_FAILED(rv)) goto done;</span>
<a href="#l11.745"></a><span id="l11.745"> </span>
<a href="#l11.746"></a><span id="l11.746">       // Set us as the output stream for HTML data from libmime...</span>
<a href="#l11.747"></a><span id="l11.747" class="difflineminus">-      nsCOMPtr&lt;nsIMimeStreamConverter&gt; mimeConverter = do_QueryInterface(m_mime_parser);</span>
<a href="#l11.748"></a><span id="l11.748" class="difflineminus">-      if (mimeConverter)</span>
<a href="#l11.749"></a><span id="l11.749" class="difflineminus">-      {</span>
<a href="#l11.750"></a><span id="l11.750" class="difflineplus">+      nsCOMPtr&lt;nsIMimeStreamConverter&gt; mimeConverter =</span>
<a href="#l11.751"></a><span id="l11.751" class="difflineplus">+          do_QueryInterface(m_mime_parser);</span>
<a href="#l11.752"></a><span id="l11.752" class="difflineplus">+      if (mimeConverter) {</span>
<a href="#l11.753"></a><span id="l11.753">         mimeConverter-&gt;SetMimeOutputType(nsMimeOutput::nsMimeMessageDecrypt);</span>
<a href="#l11.754"></a><span id="l11.754">         mimeConverter-&gt;SetForwardInline(false);</span>
<a href="#l11.755"></a><span id="l11.755">         mimeConverter-&gt;SetIdentity(nullptr);</span>
<a href="#l11.756"></a><span id="l11.756">         mimeConverter-&gt;SetOriginalMsgURI(nullptr);</span>
<a href="#l11.757"></a><span id="l11.757">       }</span>
<a href="#l11.758"></a><span id="l11.758"> </span>
<a href="#l11.759"></a><span id="l11.759">       nsCOMPtr&lt;nsIURI&gt; aURL;</span>
<a href="#l11.760"></a><span id="l11.760" class="difflineminus">-      rv = messageService-&gt;GetUrlForUri(uri.get(), getter_AddRefs(aURL), nullptr);</span>
<a href="#l11.761"></a><span id="l11.761" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l11.762"></a><span id="l11.762" class="difflineminus">-        goto done;</span>
<a href="#l11.763"></a><span id="l11.763" class="difflineminus">-</span>
<a href="#l11.764"></a><span id="l11.764" class="difflineplus">+      rv = messageService-&gt;GetUrlForUri(uri.get(), getter_AddRefs(aURL),</span>
<a href="#l11.765"></a><span id="l11.765" class="difflineplus">+                                        nullptr);</span>
<a href="#l11.766"></a><span id="l11.766" class="difflineplus">+      if (NS_FAILED(rv)) goto done;</span>
<a href="#l11.767"></a><span id="l11.767"> </span>
<a href="#l11.768"></a><span id="l11.768">       nsCOMPtr&lt;nsIPrincipal&gt; nullPrincipal =</span>
<a href="#l11.769"></a><span id="l11.769" class="difflineminus">-        do_CreateInstance(&quot;@mozilla.org/nullprincipal;1&quot;, &amp;rv);</span>
<a href="#l11.770"></a><span id="l11.770" class="difflineplus">+          do_CreateInstance(&quot;@mozilla.org/nullprincipal;1&quot;, &amp;rv);</span>
<a href="#l11.771"></a><span id="l11.771">       NS_ASSERTION(NS_SUCCEEDED(rv), &quot;CreateInstance of nullprincipal failed.&quot;);</span>
<a href="#l11.772"></a><span id="l11.772" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l11.773"></a><span id="l11.773" class="difflineminus">-        goto done;</span>
<a href="#l11.774"></a><span id="l11.774" class="difflineplus">+      if (NS_FAILED(rv)) goto done;</span>
<a href="#l11.775"></a><span id="l11.775"> </span>
<a href="#l11.776"></a><span id="l11.776" class="difflineminus">-      rv = NS_NewInputStreamChannel(getter_AddRefs(m_converter_channel),</span>
<a href="#l11.777"></a><span id="l11.777" class="difflineminus">-                                    aURL,</span>
<a href="#l11.778"></a><span id="l11.778" class="difflineminus">-                                    nullptr,</span>
<a href="#l11.779"></a><span id="l11.779" class="difflineminus">-                                    nullPrincipal,</span>
<a href="#l11.780"></a><span id="l11.780" class="difflineminus">-                                    nsILoadInfo::SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l11.781"></a><span id="l11.781" class="difflineminus">-                                    nsIContentPolicy::TYPE_OTHER);</span>
<a href="#l11.782"></a><span id="l11.782" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l11.783"></a><span id="l11.783" class="difflineminus">-        goto done;</span>
<a href="#l11.784"></a><span id="l11.784" class="difflineplus">+      rv = NS_NewInputStreamChannel(</span>
<a href="#l11.785"></a><span id="l11.785" class="difflineplus">+          getter_AddRefs(m_converter_channel), aURL, nullptr, nullPrincipal,</span>
<a href="#l11.786"></a><span id="l11.786" class="difflineplus">+          nsILoadInfo::SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l11.787"></a><span id="l11.787" class="difflineplus">+          nsIContentPolicy::TYPE_OTHER);</span>
<a href="#l11.788"></a><span id="l11.788" class="difflineplus">+      if (NS_FAILED(rv)) goto done;</span>
<a href="#l11.789"></a><span id="l11.789"> </span>
<a href="#l11.790"></a><span id="l11.790">       rv = m_mime_parser-&gt;AsyncConvertData(&quot;message/rfc822&quot;, &quot;message/rfc822&quot;,</span>
<a href="#l11.791"></a><span id="l11.791">                                            strListener, m_converter_channel);</span>
<a href="#l11.792"></a><span id="l11.792" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l11.793"></a><span id="l11.793" class="difflineminus">-        goto done;</span>
<a href="#l11.794"></a><span id="l11.794" class="difflineplus">+      if (NS_FAILED(rv)) goto done;</span>
<a href="#l11.795"></a><span id="l11.795"> </span>
<a href="#l11.796"></a><span id="l11.796">       nsCOMPtr&lt;nsIURI&gt; dummyNull;</span>
<a href="#l11.797"></a><span id="l11.797" class="difflineminus">-      rv = messageService-&gt;DisplayMessage(uri.get(), m_mime_parser, nullptr, nullptr, nullptr,</span>
<a href="#l11.798"></a><span id="l11.798" class="difflineplus">+      rv = messageService-&gt;DisplayMessage(uri.get(), m_mime_parser, nullptr,</span>
<a href="#l11.799"></a><span id="l11.799" class="difflineplus">+                                          nullptr, nullptr,</span>
<a href="#l11.800"></a><span id="l11.800">                                           getter_AddRefs(dummyNull));</span>
<a href="#l11.801"></a><span id="l11.801">     }</span>
<a href="#l11.802"></a><span id="l11.802">   }</span>
<a href="#l11.803"></a><span id="l11.803"> done:</span>
<a href="#l11.804"></a><span id="l11.804" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l11.805"></a><span id="l11.805" class="difflineminus">-  {</span>
<a href="#l11.806"></a><span id="l11.806" class="difflineminus">-      if (mOutFile)</span>
<a href="#l11.807"></a><span id="l11.807" class="difflineminus">-      {</span>
<a href="#l11.808"></a><span id="l11.808" class="difflineminus">-        mOutFile-&gt;Close();</span>
<a href="#l11.809"></a><span id="l11.809" class="difflineminus">-        mOutFile = nullptr;</span>
<a href="#l11.810"></a><span id="l11.810" class="difflineminus">-      }</span>
<a href="#l11.811"></a><span id="l11.811" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l11.812"></a><span id="l11.812" class="difflineplus">+    if (mOutFile) {</span>
<a href="#l11.813"></a><span id="l11.813" class="difflineplus">+      mOutFile-&gt;Close();</span>
<a href="#l11.814"></a><span id="l11.814" class="difflineplus">+      mOutFile = nullptr;</span>
<a href="#l11.815"></a><span id="l11.815" class="difflineplus">+    }</span>
<a href="#l11.816"></a><span id="l11.816"> </span>
<a href="#l11.817"></a><span id="l11.817" class="difflineminus">-      if (mTmpFile)</span>
<a href="#l11.818"></a><span id="l11.818" class="difflineminus">-      {</span>
<a href="#l11.819"></a><span id="l11.819" class="difflineminus">-        mTmpFile-&gt;Remove(false);</span>
<a href="#l11.820"></a><span id="l11.820" class="difflineminus">-        mTmpFile = nullptr;</span>
<a href="#l11.821"></a><span id="l11.821" class="difflineminus">-      }</span>
<a href="#l11.822"></a><span id="l11.822" class="difflineplus">+    if (mTmpFile) {</span>
<a href="#l11.823"></a><span id="l11.823" class="difflineplus">+      mTmpFile-&gt;Remove(false);</span>
<a href="#l11.824"></a><span id="l11.824" class="difflineplus">+      mTmpFile = nullptr;</span>
<a href="#l11.825"></a><span id="l11.825" class="difflineplus">+    }</span>
<a href="#l11.826"></a><span id="l11.826">   }</span>
<a href="#l11.827"></a><span id="l11.827"> </span>
<a href="#l11.828"></a><span id="l11.828">   return rv;</span>
<a href="#l11.829"></a><span id="l11.829"> }</span>
<a href="#l11.830"></a><span id="l11.830"> </span>
<a href="#l11.831"></a><span id="l11.831"> #ifdef XP_MACOSX</span>
<a href="#l11.832"></a><span id="l11.832" class="difflineminus">-bool nsMsgAttachmentHandler::HasResourceFork(FSRef *fsRef)</span>
<a href="#l11.833"></a><span id="l11.833" class="difflineminus">-{</span>
<a href="#l11.834"></a><span id="l11.834" class="difflineplus">+bool nsMsgAttachmentHandler::HasResourceFork(FSRef *fsRef) {</span>
<a href="#l11.835"></a><span id="l11.835">   FSCatalogInfo catalogInfo;</span>
<a href="#l11.836"></a><span id="l11.836" class="difflineminus">-  OSErr err = FSGetCatalogInfo(fsRef, kFSCatInfoDataSizes + kFSCatInfoRsrcSizes, &amp;catalogInfo, nullptr, nullptr, nullptr);</span>
<a href="#l11.837"></a><span id="l11.837" class="difflineplus">+  OSErr err = FSGetCatalogInfo(fsRef, kFSCatInfoDataSizes + kFSCatInfoRsrcSizes,</span>
<a href="#l11.838"></a><span id="l11.838" class="difflineplus">+                               &amp;catalogInfo, nullptr, nullptr, nullptr);</span>
<a href="#l11.839"></a><span id="l11.839">   return (err == noErr &amp;&amp; catalogInfo.rsrcLogicalSize != 0);</span>
<a href="#l11.840"></a><span id="l11.840"> }</span>
<a href="#l11.841"></a><span id="l11.841"> #endif</span>
<a href="#l11.842"></a><span id="l11.842"> </span>
<a href="#l11.843"></a><span id="l11.843" class="difflineminus">-nsresult</span>
<a href="#l11.844"></a><span id="l11.844" class="difflineminus">-nsMsgAttachmentHandler::SnarfAttachment(nsMsgCompFields *compFields)</span>
<a href="#l11.845"></a><span id="l11.845" class="difflineminus">-{</span>
<a href="#l11.846"></a><span id="l11.846" class="difflineminus">-  NS_ASSERTION (! m_done, &quot;Already done&quot;);</span>
<a href="#l11.847"></a><span id="l11.847" class="difflineplus">+nsresult nsMsgAttachmentHandler::SnarfAttachment(nsMsgCompFields *compFields) {</span>
<a href="#l11.848"></a><span id="l11.848" class="difflineplus">+  NS_ASSERTION(!m_done, &quot;Already done&quot;);</span>
<a href="#l11.849"></a><span id="l11.849"> </span>
<a href="#l11.850"></a><span id="l11.850" class="difflineminus">-  if (!mURL)</span>
<a href="#l11.851"></a><span id="l11.851" class="difflineminus">-    return SnarfMsgAttachment(compFields);</span>
<a href="#l11.852"></a><span id="l11.852" class="difflineplus">+  if (!mURL) return SnarfMsgAttachment(compFields);</span>
<a href="#l11.853"></a><span id="l11.853"> </span>
<a href="#l11.854"></a><span id="l11.854">   mCompFields = compFields;</span>
<a href="#l11.855"></a><span id="l11.855"> </span>
<a href="#l11.856"></a><span id="l11.856">   // First, get as file spec and create the stream for the</span>
<a href="#l11.857"></a><span id="l11.857">   // temp file where we will save this data</span>
<a href="#l11.858"></a><span id="l11.858" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; tmpFile;</span>
<a href="#l11.859"></a><span id="l11.859" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; tmpFile;</span>
<a href="#l11.860"></a><span id="l11.860">   nsresult rv = nsMsgCreateTempFile(&quot;nsmail.tmp&quot;, getter_AddRefs(tmpFile));</span>
<a href="#l11.861"></a><span id="l11.861">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.862"></a><span id="l11.862">   mTmpFile = tmpFile;</span>
<a href="#l11.863"></a><span id="l11.863">   mDeleteFile = true;</span>
<a href="#l11.864"></a><span id="l11.864"> </span>
<a href="#l11.865"></a><span id="l11.865" class="difflineminus">-  rv = MsgNewBufferedFileOutputStream(getter_AddRefs(mOutFile), mTmpFile, -1, 00600);</span>
<a href="#l11.866"></a><span id="l11.866" class="difflineminus">-  if (NS_FAILED(rv) || !mOutFile)</span>
<a href="#l11.867"></a><span id="l11.867" class="difflineminus">-  {</span>
<a href="#l11.868"></a><span id="l11.868" class="difflineminus">-    if (m_mime_delivery_state)</span>
<a href="#l11.869"></a><span id="l11.869" class="difflineminus">-    {</span>
<a href="#l11.870"></a><span id="l11.870" class="difflineplus">+  rv = MsgNewBufferedFileOutputStream(getter_AddRefs(mOutFile), mTmpFile, -1,</span>
<a href="#l11.871"></a><span id="l11.871" class="difflineplus">+                                      00600);</span>
<a href="#l11.872"></a><span id="l11.872" class="difflineplus">+  if (NS_FAILED(rv) || !mOutFile) {</span>
<a href="#l11.873"></a><span id="l11.873" class="difflineplus">+    if (m_mime_delivery_state) {</span>
<a href="#l11.874"></a><span id="l11.874">       nsCOMPtr&lt;nsIMsgSendReport&gt; sendReport;</span>
<a href="#l11.875"></a><span id="l11.875">       m_mime_delivery_state-&gt;GetSendReport(getter_AddRefs(sendReport));</span>
<a href="#l11.876"></a><span id="l11.876" class="difflineminus">-      if (sendReport)</span>
<a href="#l11.877"></a><span id="l11.877" class="difflineminus">-      {</span>
<a href="#l11.878"></a><span id="l11.878" class="difflineplus">+      if (sendReport) {</span>
<a href="#l11.879"></a><span id="l11.879">         nsAutoString error_msg;</span>
<a href="#l11.880"></a><span id="l11.880">         nsMsgBuildMessageWithTmpFile(mTmpFile, error_msg);</span>
<a href="#l11.881"></a><span id="l11.881" class="difflineminus">-        sendReport-&gt;SetMessage(nsIMsgSendReport::process_Current, error_msg.get(), false);</span>
<a href="#l11.882"></a><span id="l11.882" class="difflineplus">+        sendReport-&gt;SetMessage(nsIMsgSendReport::process_Current,</span>
<a href="#l11.883"></a><span id="l11.883" class="difflineplus">+                               error_msg.get(), false);</span>
<a href="#l11.884"></a><span id="l11.884">       }</span>
<a href="#l11.885"></a><span id="l11.885">     }</span>
<a href="#l11.886"></a><span id="l11.886">     mTmpFile-&gt;Remove(false);</span>
<a href="#l11.887"></a><span id="l11.887">     mTmpFile = nullptr;</span>
<a href="#l11.888"></a><span id="l11.888">     return NS_MSG_UNABLE_TO_OPEN_TMP_FILE;</span>
<a href="#l11.889"></a><span id="l11.889">   }</span>
<a href="#l11.890"></a><span id="l11.890"> </span>
<a href="#l11.891"></a><span id="l11.891">   nsCString sourceURISpec;</span>
<a href="#l11.892"></a><span id="l11.892">   rv = mURL-&gt;GetSpec(sourceURISpec);</span>
<a href="#l11.893"></a><span id="l11.893">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.894"></a><span id="l11.894"> #ifdef XP_MACOSX</span>
<a href="#l11.895"></a><span id="l11.895" class="difflineminus">-  if (!m_bogus_attachment &amp;&amp; StringBeginsWith(sourceURISpec, NS_LITERAL_CSTRING(&quot;file://&quot;)))</span>
<a href="#l11.896"></a><span id="l11.896" class="difflineminus">-  {</span>
<a href="#l11.897"></a><span id="l11.897" class="difflineplus">+  if (!m_bogus_attachment &amp;&amp;</span>
<a href="#l11.898"></a><span id="l11.898" class="difflineplus">+      StringBeginsWith(sourceURISpec, NS_LITERAL_CSTRING(&quot;file://&quot;))) {</span>
<a href="#l11.899"></a><span id="l11.899">     // Unescape the path (i.e. un-URLify it) before making a FSSpec</span>
<a href="#l11.900"></a><span id="l11.900">     nsAutoCString filePath;</span>
<a href="#l11.901"></a><span id="l11.901">     filePath.Adopt(nsMsgGetLocalFileFromURL(sourceURISpec.get()));</span>
<a href="#l11.902"></a><span id="l11.902">     nsAutoCString unescapedFilePath;</span>
<a href="#l11.903"></a><span id="l11.903">     MsgUnescapeString(filePath, 0, unescapedFilePath);</span>
<a href="#l11.904"></a><span id="l11.904"> </span>
<a href="#l11.905"></a><span id="l11.905">     nsCOMPtr&lt;nsIFile&gt; sourceFile;</span>
<a href="#l11.906"></a><span id="l11.906">     NS_NewNativeLocalFile(unescapedFilePath, true, getter_AddRefs(sourceFile));</span>
<a href="#l11.907"></a><span id="l11.907" class="difflineminus">-    if (!sourceFile)</span>
<a href="#l11.908"></a><span id="l11.908" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l11.909"></a><span id="l11.909" class="difflineplus">+    if (!sourceFile) return NS_ERROR_FAILURE;</span>
<a href="#l11.910"></a><span id="l11.910"> </span>
<a href="#l11.911"></a><span id="l11.911">     // check if it is a bundle. if it is, we'll zip it.</span>
<a href="#l11.912"></a><span id="l11.912">     // if not, we'll apple encode it (applesingle or appledouble)</span>
<a href="#l11.913"></a><span id="l11.913">     nsCOMPtr&lt;nsILocalFileMac&gt; macFile(do_QueryInterface(sourceFile));</span>
<a href="#l11.914"></a><span id="l11.914">     bool isPackage;</span>
<a href="#l11.915"></a><span id="l11.915">     macFile-&gt;IsPackage(&amp;isPackage);</span>
<a href="#l11.916"></a><span id="l11.916">     if (isPackage)</span>
<a href="#l11.917"></a><span id="l11.917">       rv = ConvertToZipFile(macFile);</span>
<a href="#l11.918"></a><span id="l11.918" class="difflineat">@@ -768,40 +681,40 @@ nsMsgAttachmentHandler::SnarfAttachment(</span>
<a href="#l11.919"></a><span id="l11.919"> #endif /* XP_MACOSX */</span>
<a href="#l11.920"></a><span id="l11.920"> </span>
<a href="#l11.921"></a><span id="l11.921">   //</span>
<a href="#l11.922"></a><span id="l11.922">   // Ok, here we are, we need to fire the URL off and get the data</span>
<a href="#l11.923"></a><span id="l11.923">   // in the temp file</span>
<a href="#l11.924"></a><span id="l11.924">   //</span>
<a href="#l11.925"></a><span id="l11.925">   // Create a fetcher for the URL attachment...</span>
<a href="#l11.926"></a><span id="l11.926"> </span>
<a href="#l11.927"></a><span id="l11.927" class="difflineminus">-  nsCOMPtr&lt;nsIURLFetcher&gt; fetcher = do_CreateInstance(NS_URLFETCHER_CONTRACTID, &amp;rv);</span>
<a href="#l11.928"></a><span id="l11.928" class="difflineminus">-  if (NS_FAILED(rv) || !fetcher)</span>
<a href="#l11.929"></a><span id="l11.929" class="difflineminus">-  {</span>
<a href="#l11.930"></a><span id="l11.930" class="difflineplus">+  nsCOMPtr&lt;nsIURLFetcher&gt; fetcher =</span>
<a href="#l11.931"></a><span id="l11.931" class="difflineplus">+      do_CreateInstance(NS_URLFETCHER_CONTRACTID, &amp;rv);</span>
<a href="#l11.932"></a><span id="l11.932" class="difflineplus">+  if (NS_FAILED(rv) || !fetcher) {</span>
<a href="#l11.933"></a><span id="l11.933">     if (NS_SUCCEEDED(rv))</span>
<a href="#l11.934"></a><span id="l11.934">       return NS_ERROR_UNEXPECTED;</span>
<a href="#l11.935"></a><span id="l11.935">     else</span>
<a href="#l11.936"></a><span id="l11.936">       return rv;</span>
<a href="#l11.937"></a><span id="l11.937">   }</span>
<a href="#l11.938"></a><span id="l11.938"> </span>
<a href="#l11.939"></a><span id="l11.939" class="difflineminus">-  return fetcher-&gt;FireURLRequest(mURL, mTmpFile, mOutFile, FetcherURLDoneCallback, this);</span>
<a href="#l11.940"></a><span id="l11.940" class="difflineplus">+  return fetcher-&gt;FireURLRequest(mURL, mTmpFile, mOutFile,</span>
<a href="#l11.941"></a><span id="l11.941" class="difflineplus">+                                 FetcherURLDoneCallback, this);</span>
<a href="#l11.942"></a><span id="l11.942"> }</span>
<a href="#l11.943"></a><span id="l11.943"> </span>
<a href="#l11.944"></a><span id="l11.944"> #ifdef XP_MACOSX</span>
<a href="#l11.945"></a><span id="l11.945" class="difflineminus">-nsresult</span>
<a href="#l11.946"></a><span id="l11.946" class="difflineminus">-nsMsgAttachmentHandler::ConvertToZipFile(nsILocalFileMac *aSourceFile)</span>
<a href="#l11.947"></a><span id="l11.947" class="difflineminus">-{</span>
<a href="#l11.948"></a><span id="l11.948" class="difflineplus">+nsresult nsMsgAttachmentHandler::ConvertToZipFile(</span>
<a href="#l11.949"></a><span id="l11.949" class="difflineplus">+    nsILocalFileMac *aSourceFile) {</span>
<a href="#l11.950"></a><span id="l11.950">   // append &quot;.zip&quot; to the real file name</span>
<a href="#l11.951"></a><span id="l11.951">   nsAutoCString zippedName;</span>
<a href="#l11.952"></a><span id="l11.952">   nsresult rv = aSourceFile-&gt;GetNativeLeafName(zippedName);</span>
<a href="#l11.953"></a><span id="l11.953">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.954"></a><span id="l11.954">   zippedName.AppendLiteral(&quot;.zip&quot;);</span>
<a href="#l11.955"></a><span id="l11.955"> </span>
<a href="#l11.956"></a><span id="l11.956">   // create a temporary file that we'll work on</span>
<a href="#l11.957"></a><span id="l11.957" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; tmpFile;</span>
<a href="#l11.958"></a><span id="l11.958" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; tmpFile;</span>
<a href="#l11.959"></a><span id="l11.959">   rv = nsMsgCreateTempFile(zippedName.get(), getter_AddRefs(tmpFile));</span>
<a href="#l11.960"></a><span id="l11.960">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.961"></a><span id="l11.961">   mEncodedWorkingFile = tmpFile;</span>
<a href="#l11.962"></a><span id="l11.962"> </span>
<a href="#l11.963"></a><span id="l11.963">   // point our URL at the zipped temp file</span>
<a href="#l11.964"></a><span id="l11.964">   NS_NewFileURI(getter_AddRefs(mURL), mEncodedWorkingFile);</span>
<a href="#l11.965"></a><span id="l11.965"> </span>
<a href="#l11.966"></a><span id="l11.966">   // zip it!</span>
<a href="#l11.967"></a><span id="l11.967" class="difflineat">@@ -810,111 +723,105 @@ nsMsgAttachmentHandler::ConvertToZipFile</span>
<a href="#l11.968"></a><span id="l11.968"> </span>
<a href="#l11.969"></a><span id="l11.969">   // set some metadata for this attachment, that will affect the MIME headers.</span>
<a href="#l11.970"></a><span id="l11.970">   m_type = APPLICATION_ZIP;</span>
<a href="#l11.971"></a><span id="l11.971">   m_realName = zippedName.get();</span>
<a href="#l11.972"></a><span id="l11.972"> </span>
<a href="#l11.973"></a><span id="l11.973">   return NS_OK;</span>
<a href="#l11.974"></a><span id="l11.974"> }</span>
<a href="#l11.975"></a><span id="l11.975"> </span>
<a href="#l11.976"></a><span id="l11.976" class="difflineminus">-nsresult</span>
<a href="#l11.977"></a><span id="l11.977" class="difflineminus">-nsMsgAttachmentHandler::ConvertToAppleEncoding(const nsCString &amp;aFileURI,</span>
<a href="#l11.978"></a><span id="l11.978" class="difflineminus">-                                               const nsCString &amp;aFilePath,</span>
<a href="#l11.979"></a><span id="l11.979" class="difflineminus">-                                               nsILocalFileMac *aSourceFile)</span>
<a href="#l11.980"></a><span id="l11.980" class="difflineminus">-{</span>
<a href="#l11.981"></a><span id="l11.981" class="difflineplus">+nsresult nsMsgAttachmentHandler::ConvertToAppleEncoding(</span>
<a href="#l11.982"></a><span id="l11.982" class="difflineplus">+    const nsCString &amp;aFileURI, const nsCString &amp;aFilePath,</span>
<a href="#l11.983"></a><span id="l11.983" class="difflineplus">+    nsILocalFileMac *aSourceFile) {</span>
<a href="#l11.984"></a><span id="l11.984">   // convert the apple file to AppleDouble first, and then patch the</span>
<a href="#l11.985"></a><span id="l11.985">   // address in the url.</span>
<a href="#l11.986"></a><span id="l11.986"> </span>
<a href="#l11.987"></a><span id="l11.987" class="difflineminus">-  //We need to retrieve the file type and creator...</span>
<a href="#l11.988"></a><span id="l11.988" class="difflineplus">+  // We need to retrieve the file type and creator...</span>
<a href="#l11.989"></a><span id="l11.989"> </span>
<a href="#l11.990"></a><span id="l11.990">   char fileInfo[32];</span>
<a href="#l11.991"></a><span id="l11.991">   OSType type, creator;</span>
<a href="#l11.992"></a><span id="l11.992"> </span>
<a href="#l11.993"></a><span id="l11.993">   nsresult rv = aSourceFile-&gt;GetFileType(&amp;type);</span>
<a href="#l11.994"></a><span id="l11.994" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l11.995"></a><span id="l11.995" class="difflineminus">-    return rv;</span>
<a href="#l11.996"></a><span id="l11.996" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l11.997"></a><span id="l11.997">   PR_snprintf(fileInfo, sizeof(fileInfo), &quot;%X&quot;, type);</span>
<a href="#l11.998"></a><span id="l11.998">   m_xMacType = fileInfo;</span>
<a href="#l11.999"></a><span id="l11.999"> </span>
<a href="#l11.1000"></a><span id="l11.1000">   rv = aSourceFile-&gt;GetFileCreator(&amp;creator);</span>
<a href="#l11.1001"></a><span id="l11.1001" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l11.1002"></a><span id="l11.1002" class="difflineminus">-    return rv;</span>
<a href="#l11.1003"></a><span id="l11.1003" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l11.1004"></a><span id="l11.1004">   PR_snprintf(fileInfo, sizeof(fileInfo), &quot;%X&quot;, creator);</span>
<a href="#l11.1005"></a><span id="l11.1005">   m_xMacCreator = fileInfo;</span>
<a href="#l11.1006"></a><span id="l11.1006"> </span>
<a href="#l11.1007"></a><span id="l11.1007">   FSRef fsRef;</span>
<a href="#l11.1008"></a><span id="l11.1008">   aSourceFile-&gt;GetFSRef(&amp;fsRef);</span>
<a href="#l11.1009"></a><span id="l11.1009">   bool sendResourceFork = HasResourceFork(&amp;fsRef);</span>
<a href="#l11.1010"></a><span id="l11.1010"> </span>
<a href="#l11.1011"></a><span id="l11.1011" class="difflineminus">-  // if we have a resource fork, check the filename extension, maybe we don't need the resource fork!</span>
<a href="#l11.1012"></a><span id="l11.1012" class="difflineminus">-  if (sendResourceFork)</span>
<a href="#l11.1013"></a><span id="l11.1013" class="difflineminus">-  {</span>
<a href="#l11.1014"></a><span id="l11.1014" class="difflineplus">+  // if we have a resource fork, check the filename extension, maybe we don't</span>
<a href="#l11.1015"></a><span id="l11.1015" class="difflineplus">+  // need the resource fork!</span>
<a href="#l11.1016"></a><span id="l11.1016" class="difflineplus">+  if (sendResourceFork) {</span>
<a href="#l11.1017"></a><span id="l11.1017">     nsCOMPtr&lt;nsIURL&gt; fileUrl;</span>
<a href="#l11.1018"></a><span id="l11.1018" class="difflineminus">-    rv = NS_MutateURI(NS_STANDARDURLMUTATOR_CONTRACTID).SetSpec(aFileURI).Finalize(fileUrl);</span>
<a href="#l11.1019"></a><span id="l11.1019" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l11.1020"></a><span id="l11.1020" class="difflineminus">-    {</span>
<a href="#l11.1021"></a><span id="l11.1021" class="difflineplus">+    rv = NS_MutateURI(NS_STANDARDURLMUTATOR_CONTRACTID)</span>
<a href="#l11.1022"></a><span id="l11.1022" class="difflineplus">+             .SetSpec(aFileURI)</span>
<a href="#l11.1023"></a><span id="l11.1023" class="difflineplus">+             .Finalize(fileUrl);</span>
<a href="#l11.1024"></a><span id="l11.1024" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l11.1025"></a><span id="l11.1025">       nsAutoCString ext;</span>
<a href="#l11.1026"></a><span id="l11.1026">       rv = fileUrl-&gt;GetFileExtension(ext);</span>
<a href="#l11.1027"></a><span id="l11.1027">       if (NS_SUCCEEDED(rv) &amp;&amp; !ext.IsEmpty()) {</span>
<a href="#l11.1028"></a><span id="l11.1028" class="difflineminus">-        // Check the preference to see whether AppleDouble was requested for this extension.</span>
<a href="#l11.1029"></a><span id="l11.1029" class="difflineplus">+        // Check the preference to see whether AppleDouble was requested for</span>
<a href="#l11.1030"></a><span id="l11.1030" class="difflineplus">+        // this extension.</span>
<a href="#l11.1031"></a><span id="l11.1031">         nsAutoCString extensionWhitelist;</span>
<a href="#l11.1032"></a><span id="l11.1032" class="difflineminus">-        mozilla::Preferences::GetCString(&quot;mailnews.extensions_using_appledouble&quot;, extensionWhitelist);</span>
<a href="#l11.1033"></a><span id="l11.1033" class="difflineplus">+        mozilla::Preferences::GetCString(</span>
<a href="#l11.1034"></a><span id="l11.1034" class="difflineplus">+            &quot;mailnews.extensions_using_appledouble&quot;, extensionWhitelist);</span>
<a href="#l11.1035"></a><span id="l11.1035">         if (extensionWhitelist.IsEmpty() ||</span>
<a href="#l11.1036"></a><span id="l11.1036">             (!extensionWhitelist.Equals(&quot;*&quot;) &amp;&amp;</span>
<a href="#l11.1037"></a><span id="l11.1037" class="difflineminus">-             extensionWhitelist.Find(ext, /* ignoreCase = */ true) == kNotFound))</span>
<a href="#l11.1038"></a><span id="l11.1038" class="difflineminus">-          sendResourceFork = false;  // Ignore resource fork and don't use AppleDouble.</span>
<a href="#l11.1039"></a><span id="l11.1039" class="difflineplus">+             extensionWhitelist.Find(ext, /* ignoreCase = */ true) ==</span>
<a href="#l11.1040"></a><span id="l11.1040" class="difflineplus">+                 kNotFound))</span>
<a href="#l11.1041"></a><span id="l11.1041" class="difflineplus">+          sendResourceFork =</span>
<a href="#l11.1042"></a><span id="l11.1042" class="difflineplus">+              false;  // Ignore resource fork and don't use AppleDouble.</span>
<a href="#l11.1043"></a><span id="l11.1043">       }</span>
<a href="#l11.1044"></a><span id="l11.1044">     }</span>
<a href="#l11.1045"></a><span id="l11.1045">   }</span>
<a href="#l11.1046"></a><span id="l11.1046"> </span>
<a href="#l11.1047"></a><span id="l11.1047">   // Only use appledouble if we aren't uuencoding.</span>
<a href="#l11.1048"></a><span id="l11.1048" class="difflineminus">-  if( sendResourceFork )</span>
<a href="#l11.1049"></a><span id="l11.1049" class="difflineminus">-  {</span>
<a href="#l11.1050"></a><span id="l11.1050" class="difflineplus">+  if (sendResourceFork) {</span>
<a href="#l11.1051"></a><span id="l11.1051">     char *separator;</span>
<a href="#l11.1052"></a><span id="l11.1052"> </span>
<a href="#l11.1053"></a><span id="l11.1053">     separator = mime_make_separator(&quot;ad&quot;);</span>
<a href="#l11.1054"></a><span id="l11.1054" class="difflineminus">-    if (!separator)</span>
<a href="#l11.1055"></a><span id="l11.1055" class="difflineminus">-      return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l11.1056"></a><span id="l11.1056" class="difflineplus">+    if (!separator) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l11.1057"></a><span id="l11.1057"> </span>
<a href="#l11.1058"></a><span id="l11.1058" class="difflineminus">-    nsCOMPtr &lt;nsIFile&gt; tmpFile;</span>
<a href="#l11.1059"></a><span id="l11.1059" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; tmpFile;</span>
<a href="#l11.1060"></a><span id="l11.1060">     nsresult rv = nsMsgCreateTempFile(&quot;appledouble&quot;, getter_AddRefs(tmpFile));</span>
<a href="#l11.1061"></a><span id="l11.1061" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l11.1062"></a><span id="l11.1062" class="difflineminus">-      mEncodedWorkingFile = tmpFile;</span>
<a href="#l11.1063"></a><span id="l11.1063" class="difflineminus">-    if (!mEncodedWorkingFile)</span>
<a href="#l11.1064"></a><span id="l11.1064" class="difflineminus">-    {</span>
<a href="#l11.1065"></a><span id="l11.1065" class="difflineplus">+    if (NS_SUCCEEDED(rv)) mEncodedWorkingFile = tmpFile;</span>
<a href="#l11.1066"></a><span id="l11.1066" class="difflineplus">+    if (!mEncodedWorkingFile) {</span>
<a href="#l11.1067"></a><span id="l11.1067">       PR_FREEIF(separator);</span>
<a href="#l11.1068"></a><span id="l11.1068">       return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l11.1069"></a><span id="l11.1069">     }</span>
<a href="#l11.1070"></a><span id="l11.1070"> </span>
<a href="#l11.1071"></a><span id="l11.1071">     //</span>
<a href="#l11.1072"></a><span id="l11.1072">     // RICHIE_MAC - ok, here's the deal, we have a file that we need</span>
<a href="#l11.1073"></a><span id="l11.1073">     // to encode in appledouble encoding for the resource fork and put that</span>
<a href="#l11.1074"></a><span id="l11.1074" class="difflineminus">-    // into the mEncodedWorkingFile location. Then, we need to patch the new file</span>
<a href="#l11.1075"></a><span id="l11.1075" class="difflineminus">-    // spec into the array and send this as part of the 2 part appledouble/mime</span>
<a href="#l11.1076"></a><span id="l11.1076" class="difflineminus">-    // encoded mime part.</span>
<a href="#l11.1077"></a><span id="l11.1077" class="difflineplus">+    // into the mEncodedWorkingFile location. Then, we need to patch the new</span>
<a href="#l11.1078"></a><span id="l11.1078" class="difflineplus">+    // file spec into the array and send this as part of the 2 part</span>
<a href="#l11.1079"></a><span id="l11.1079" class="difflineplus">+    // appledouble/mime encoded mime part.</span>
<a href="#l11.1080"></a><span id="l11.1080">     //</span>
<a href="#l11.1081"></a><span id="l11.1081" class="difflineminus">-    AppleDoubleEncodeObject     *obj = new (AppleDoubleEncodeObject);</span>
<a href="#l11.1082"></a><span id="l11.1082" class="difflineminus">-    if (obj == NULL)</span>
<a href="#l11.1083"></a><span id="l11.1083" class="difflineminus">-    {</span>
<a href="#l11.1084"></a><span id="l11.1084" class="difflineplus">+    AppleDoubleEncodeObject *obj = new (AppleDoubleEncodeObject);</span>
<a href="#l11.1085"></a><span id="l11.1085" class="difflineplus">+    if (obj == NULL) {</span>
<a href="#l11.1086"></a><span id="l11.1086">       mEncodedWorkingFile = nullptr;</span>
<a href="#l11.1087"></a><span id="l11.1087">       PR_FREEIF(separator);</span>
<a href="#l11.1088"></a><span id="l11.1088">       return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l11.1089"></a><span id="l11.1089">     }</span>
<a href="#l11.1090"></a><span id="l11.1090"> </span>
<a href="#l11.1091"></a><span id="l11.1091">     rv = MsgGetFileStream(mEncodedWorkingFile, getter_AddRefs(obj-&gt;fileStream));</span>
<a href="#l11.1092"></a><span id="l11.1092" class="difflineminus">-    if (NS_FAILED(rv) || !obj-&gt;fileStream)</span>
<a href="#l11.1093"></a><span id="l11.1093" class="difflineminus">-    {</span>
<a href="#l11.1094"></a><span id="l11.1094" class="difflineplus">+    if (NS_FAILED(rv) || !obj-&gt;fileStream) {</span>
<a href="#l11.1095"></a><span id="l11.1095">       PR_FREEIF(separator);</span>
<a href="#l11.1096"></a><span id="l11.1096">       delete obj;</span>
<a href="#l11.1097"></a><span id="l11.1097">       return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l11.1098"></a><span id="l11.1098">     }</span>
<a href="#l11.1099"></a><span id="l11.1099"> </span>
<a href="#l11.1100"></a><span id="l11.1100" class="difflineminus">-    char *working_buff = (char *) PR_Malloc(AD_WORKING_BUFF_SIZE);</span>
<a href="#l11.1101"></a><span id="l11.1101" class="difflineminus">-    if (!working_buff)</span>
<a href="#l11.1102"></a><span id="l11.1102" class="difflineminus">-    {</span>
<a href="#l11.1103"></a><span id="l11.1103" class="difflineplus">+    char *working_buff = (char *)PR_Malloc(AD_WORKING_BUFF_SIZE);</span>
<a href="#l11.1104"></a><span id="l11.1104" class="difflineplus">+    if (!working_buff) {</span>
<a href="#l11.1105"></a><span id="l11.1105">       PR_FREEIF(separator);</span>
<a href="#l11.1106"></a><span id="l11.1106">       delete obj;</span>
<a href="#l11.1107"></a><span id="l11.1107">       return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l11.1108"></a><span id="l11.1108">     }</span>
<a href="#l11.1109"></a><span id="l11.1109"> </span>
<a href="#l11.1110"></a><span id="l11.1110">     obj-&gt;buff = working_buff;</span>
<a href="#l11.1111"></a><span id="l11.1111">     obj-&gt;s_buff = AD_WORKING_BUFF_SIZE;</span>
<a href="#l11.1112"></a><span id="l11.1112"> </span>
<a href="#l11.1113"></a><span id="l11.1113" class="difflineat">@@ -922,172 +829,155 @@ nsMsgAttachmentHandler::ConvertToAppleEn</span>
<a href="#l11.1114"></a><span id="l11.1114">     //  Setup all the need information on the apple double encoder.</span>
<a href="#l11.1115"></a><span id="l11.1115">     //</span>
<a href="#l11.1116"></a><span id="l11.1116">     ap_encode_init(&amp;(obj-&gt;ap_encode_obj), aFilePath.get(), separator);</span>
<a href="#l11.1117"></a><span id="l11.1117"> </span>
<a href="#l11.1118"></a><span id="l11.1118">     int32_t count;</span>
<a href="#l11.1119"></a><span id="l11.1119"> </span>
<a href="#l11.1120"></a><span id="l11.1120">     OSErr status = noErr;</span>
<a href="#l11.1121"></a><span id="l11.1121">     m_size = 0;</span>
<a href="#l11.1122"></a><span id="l11.1122" class="difflineminus">-    while (status == noErr)</span>
<a href="#l11.1123"></a><span id="l11.1123" class="difflineminus">-    {</span>
<a href="#l11.1124"></a><span id="l11.1124" class="difflineminus">-      status = ap_encode_next(&amp;(obj-&gt;ap_encode_obj), obj-&gt;buff, obj-&gt;s_buff, &amp;count);</span>
<a href="#l11.1125"></a><span id="l11.1125" class="difflineminus">-      if (status == noErr || status == errDone)</span>
<a href="#l11.1126"></a><span id="l11.1126" class="difflineminus">-      {</span>
<a href="#l11.1127"></a><span id="l11.1127" class="difflineplus">+    while (status == noErr) {</span>
<a href="#l11.1128"></a><span id="l11.1128" class="difflineplus">+      status =</span>
<a href="#l11.1129"></a><span id="l11.1129" class="difflineplus">+          ap_encode_next(&amp;(obj-&gt;ap_encode_obj), obj-&gt;buff, obj-&gt;s_buff, &amp;count);</span>
<a href="#l11.1130"></a><span id="l11.1130" class="difflineplus">+      if (status == noErr || status == errDone) {</span>
<a href="#l11.1131"></a><span id="l11.1131">         //</span>
<a href="#l11.1132"></a><span id="l11.1132" class="difflineminus">-        // we got the encode data, so call the next stream to write it to the disk.</span>
<a href="#l11.1133"></a><span id="l11.1133" class="difflineplus">+        // we got the encode data, so call the next stream to write it to the</span>
<a href="#l11.1134"></a><span id="l11.1134" class="difflineplus">+        // disk.</span>
<a href="#l11.1135"></a><span id="l11.1135">         //</span>
<a href="#l11.1136"></a><span id="l11.1136">         uint32_t bytesWritten;</span>
<a href="#l11.1137"></a><span id="l11.1137">         obj-&gt;fileStream-&gt;Write(obj-&gt;buff, count, &amp;bytesWritten);</span>
<a href="#l11.1138"></a><span id="l11.1138" class="difflineminus">-        if (bytesWritten != (uint32_t) count)</span>
<a href="#l11.1139"></a><span id="l11.1139" class="difflineminus">-          status = errFileWrite;</span>
<a href="#l11.1140"></a><span id="l11.1140" class="difflineplus">+        if (bytesWritten != (uint32_t)count) status = errFileWrite;</span>
<a href="#l11.1141"></a><span id="l11.1141">       }</span>
<a href="#l11.1142"></a><span id="l11.1142">     }</span>
<a href="#l11.1143"></a><span id="l11.1143"> </span>
<a href="#l11.1144"></a><span id="l11.1144" class="difflineminus">-    ap_encode_end(&amp;(obj-&gt;ap_encode_obj), (status &gt;= 0)); // if this is true, ok, false abort</span>
<a href="#l11.1145"></a><span id="l11.1145" class="difflineminus">-    if (obj-&gt;fileStream)</span>
<a href="#l11.1146"></a><span id="l11.1146" class="difflineminus">-      obj-&gt;fileStream-&gt;Close();</span>
<a href="#l11.1147"></a><span id="l11.1147" class="difflineplus">+    ap_encode_end(&amp;(obj-&gt;ap_encode_obj),</span>
<a href="#l11.1148"></a><span id="l11.1148" class="difflineplus">+                  (status &gt;= 0));  // if this is true, ok, false abort</span>
<a href="#l11.1149"></a><span id="l11.1149" class="difflineplus">+    if (obj-&gt;fileStream) obj-&gt;fileStream-&gt;Close();</span>
<a href="#l11.1150"></a><span id="l11.1150"> </span>
<a href="#l11.1151"></a><span id="l11.1151" class="difflineminus">-    PR_FREEIF(obj-&gt;buff);               /* free the working buff.   */</span>
<a href="#l11.1152"></a><span id="l11.1152" class="difflineplus">+    PR_FREEIF(obj-&gt;buff); /* free the working buff.   */</span>
<a href="#l11.1153"></a><span id="l11.1153">     PR_FREEIF(obj);</span>
<a href="#l11.1154"></a><span id="l11.1154"> </span>
<a href="#l11.1155"></a><span id="l11.1155" class="difflineminus">-    nsCOMPtr &lt;nsIURI&gt; fileURI;</span>
<a href="#l11.1156"></a><span id="l11.1156" class="difflineplus">+    nsCOMPtr&lt;nsIURI&gt; fileURI;</span>
<a href="#l11.1157"></a><span id="l11.1157">     NS_NewFileURI(getter_AddRefs(fileURI), mEncodedWorkingFile);</span>
<a href="#l11.1158"></a><span id="l11.1158"> </span>
<a href="#l11.1159"></a><span id="l11.1159">     nsCOMPtr&lt;nsIFileURL&gt; theFileURL = do_QueryInterface(fileURI, &amp;rv);</span>
<a href="#l11.1160"></a><span id="l11.1160" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l11.1161"></a><span id="l11.1161" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.1162"></a><span id="l11.1162"> </span>
<a href="#l11.1163"></a><span id="l11.1163">     nsCString newURLSpec;</span>
<a href="#l11.1164"></a><span id="l11.1164">     rv = fileURI-&gt;GetSpec(newURLSpec);</span>
<a href="#l11.1165"></a><span id="l11.1165">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.1166"></a><span id="l11.1166"> </span>
<a href="#l11.1167"></a><span id="l11.1167" class="difflineminus">-    if (newURLSpec.IsEmpty())</span>
<a href="#l11.1168"></a><span id="l11.1168" class="difflineminus">-    {</span>
<a href="#l11.1169"></a><span id="l11.1169" class="difflineplus">+    if (newURLSpec.IsEmpty()) {</span>
<a href="#l11.1170"></a><span id="l11.1170">       PR_FREEIF(separator);</span>
<a href="#l11.1171"></a><span id="l11.1171">       return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l11.1172"></a><span id="l11.1172">     }</span>
<a href="#l11.1173"></a><span id="l11.1173"> </span>
<a href="#l11.1174"></a><span id="l11.1174" class="difflineminus">-    if (NS_FAILED(nsMsgNewURL(getter_AddRefs(mURL), newURLSpec)))</span>
<a href="#l11.1175"></a><span id="l11.1175" class="difflineminus">-    {</span>
<a href="#l11.1176"></a><span id="l11.1176" class="difflineplus">+    if (NS_FAILED(nsMsgNewURL(getter_AddRefs(mURL), newURLSpec))) {</span>
<a href="#l11.1177"></a><span id="l11.1177">       PR_FREEIF(separator);</span>
<a href="#l11.1178"></a><span id="l11.1178">       return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l11.1179"></a><span id="l11.1179">     }</span>
<a href="#l11.1180"></a><span id="l11.1180"> </span>
<a href="#l11.1181"></a><span id="l11.1181">     // Now after conversion, also patch the types.</span>
<a href="#l11.1182"></a><span id="l11.1182" class="difflineminus">-    char        tmp[128];</span>
<a href="#l11.1183"></a><span id="l11.1183" class="difflineminus">-    PR_snprintf(tmp, sizeof(tmp), MULTIPART_APPLEDOUBLE &quot;;\r\n boundary=\&quot;%s\&quot;&quot;, separator);</span>
<a href="#l11.1184"></a><span id="l11.1184" class="difflineplus">+    char tmp[128];</span>
<a href="#l11.1185"></a><span id="l11.1185" class="difflineplus">+    PR_snprintf(tmp, sizeof(tmp), MULTIPART_APPLEDOUBLE &quot;;\r\n boundary=\&quot;%s\&quot;&quot;,</span>
<a href="#l11.1186"></a><span id="l11.1186" class="difflineplus">+                separator);</span>
<a href="#l11.1187"></a><span id="l11.1187">     PR_FREEIF(separator);</span>
<a href="#l11.1188"></a><span id="l11.1188">     m_type = tmp;</span>
<a href="#l11.1189"></a><span id="l11.1189" class="difflineminus">-  }</span>
<a href="#l11.1190"></a><span id="l11.1190" class="difflineminus">-  else</span>
<a href="#l11.1191"></a><span id="l11.1191" class="difflineminus">-  {</span>
<a href="#l11.1192"></a><span id="l11.1192" class="difflineminus">-    bool      useDefault;</span>
<a href="#l11.1193"></a><span id="l11.1193" class="difflineminus">-    char      *macType, *macEncoding;</span>
<a href="#l11.1194"></a><span id="l11.1194" class="difflineminus">-    if (m_type.IsEmpty() || m_type.LowerCaseEqualsLiteral(TEXT_PLAIN))</span>
<a href="#l11.1195"></a><span id="l11.1195" class="difflineminus">-    {</span>
<a href="#l11.1196"></a><span id="l11.1196" class="difflineminus">-# define TEXT_TYPE  0x54455854  /* the characters 'T' 'E' 'X' 'T' */</span>
<a href="#l11.1197"></a><span id="l11.1197" class="difflineminus">-# define text_TYPE  0x74657874  /* the characters 't' 'e' 'x' 't' */</span>
<a href="#l11.1198"></a><span id="l11.1198" class="difflineplus">+  } else {</span>
<a href="#l11.1199"></a><span id="l11.1199" class="difflineplus">+    bool useDefault;</span>
<a href="#l11.1200"></a><span id="l11.1200" class="difflineplus">+    char *macType, *macEncoding;</span>
<a href="#l11.1201"></a><span id="l11.1201" class="difflineplus">+    if (m_type.IsEmpty() || m_type.LowerCaseEqualsLiteral(TEXT_PLAIN)) {</span>
<a href="#l11.1202"></a><span id="l11.1202" class="difflineplus">+#  define TEXT_TYPE 0x54455854 /* the characters 'T' 'E' 'X' 'T' */</span>
<a href="#l11.1203"></a><span id="l11.1203" class="difflineplus">+#  define text_TYPE 0x74657874 /* the characters 't' 'e' 'x' 't' */</span>
<a href="#l11.1204"></a><span id="l11.1204"> </span>
<a href="#l11.1205"></a><span id="l11.1205" class="difflineminus">-      if (type != TEXT_TYPE &amp;&amp; type != text_TYPE)</span>
<a href="#l11.1206"></a><span id="l11.1206" class="difflineminus">-      {</span>
<a href="#l11.1207"></a><span id="l11.1207" class="difflineplus">+      if (type != TEXT_TYPE &amp;&amp; type != text_TYPE) {</span>
<a href="#l11.1208"></a><span id="l11.1208">         MacGetFileType(aSourceFile, &amp;useDefault, &amp;macType, &amp;macEncoding);</span>
<a href="#l11.1209"></a><span id="l11.1209">         m_type = macType;</span>
<a href="#l11.1210"></a><span id="l11.1210">       }</span>
<a href="#l11.1211"></a><span id="l11.1211">     }</span>
<a href="#l11.1212"></a><span id="l11.1212">     // don't bother to set the types if we failed in getting the file info.</span>
<a href="#l11.1213"></a><span id="l11.1213">   }</span>
<a href="#l11.1214"></a><span id="l11.1214"> </span>
<a href="#l11.1215"></a><span id="l11.1215">   return NS_OK;</span>
<a href="#l11.1216"></a><span id="l11.1216"> }</span>
<a href="#l11.1217"></a><span id="l11.1217" class="difflineminus">-#endif // XP_MACOSX</span>
<a href="#l11.1218"></a><span id="l11.1218" class="difflineplus">+#endif  // XP_MACOSX</span>
<a href="#l11.1219"></a><span id="l11.1219"> </span>
<a href="#l11.1220"></a><span id="l11.1220" class="difflineminus">-nsresult</span>
<a href="#l11.1221"></a><span id="l11.1221" class="difflineminus">-nsMsgAttachmentHandler::LoadDataFromFile(nsIFile *file, nsString &amp;sigData, bool charsetConversion)</span>
<a href="#l11.1222"></a><span id="l11.1222" class="difflineminus">-{</span>
<a href="#l11.1223"></a><span id="l11.1223" class="difflineminus">-  int32_t       readSize;</span>
<a href="#l11.1224"></a><span id="l11.1224" class="difflineminus">-  char          *readBuf;</span>
<a href="#l11.1225"></a><span id="l11.1225" class="difflineplus">+nsresult nsMsgAttachmentHandler::LoadDataFromFile(nsIFile *file,</span>
<a href="#l11.1226"></a><span id="l11.1226" class="difflineplus">+                                                  nsString &amp;sigData,</span>
<a href="#l11.1227"></a><span id="l11.1227" class="difflineplus">+                                                  bool charsetConversion) {</span>
<a href="#l11.1228"></a><span id="l11.1228" class="difflineplus">+  int32_t readSize;</span>
<a href="#l11.1229"></a><span id="l11.1229" class="difflineplus">+  char *readBuf;</span>
<a href="#l11.1230"></a><span id="l11.1230"> </span>
<a href="#l11.1231"></a><span id="l11.1231" class="difflineminus">-  nsCOMPtr &lt;nsIInputStream&gt; inputFile;</span>
<a href="#l11.1232"></a><span id="l11.1232" class="difflineplus">+  nsCOMPtr&lt;nsIInputStream&gt; inputFile;</span>
<a href="#l11.1233"></a><span id="l11.1233">   nsresult rv = NS_NewLocalFileInputStream(getter_AddRefs(inputFile), file);</span>
<a href="#l11.1234"></a><span id="l11.1234" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l11.1235"></a><span id="l11.1235" class="difflineminus">-    return NS_MSG_ERROR_WRITING_FILE;</span>
<a href="#l11.1236"></a><span id="l11.1236" class="difflineplus">+  if (NS_FAILED(rv)) return NS_MSG_ERROR_WRITING_FILE;</span>
<a href="#l11.1237"></a><span id="l11.1237"> </span>
<a href="#l11.1238"></a><span id="l11.1238">   int64_t fileSize;</span>
<a href="#l11.1239"></a><span id="l11.1239">   file-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l11.1240"></a><span id="l11.1240" class="difflineminus">-  readSize = (uint32_t) fileSize;</span>
<a href="#l11.1241"></a><span id="l11.1241" class="difflineplus">+  readSize = (uint32_t)fileSize;</span>
<a href="#l11.1242"></a><span id="l11.1242"> </span>
<a href="#l11.1243"></a><span id="l11.1243">   readBuf = (char *)PR_Malloc(readSize + 1);</span>
<a href="#l11.1244"></a><span id="l11.1244" class="difflineminus">-  if (!readBuf)</span>
<a href="#l11.1245"></a><span id="l11.1245" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l11.1246"></a><span id="l11.1246" class="difflineplus">+  if (!readBuf) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l11.1247"></a><span id="l11.1247">   memset(readBuf, 0, readSize + 1);</span>
<a href="#l11.1248"></a><span id="l11.1248"> </span>
<a href="#l11.1249"></a><span id="l11.1249">   uint32_t bytesRead;</span>
<a href="#l11.1250"></a><span id="l11.1250">   inputFile-&gt;Read(readBuf, readSize, &amp;bytesRead);</span>
<a href="#l11.1251"></a><span id="l11.1251">   inputFile-&gt;Close();</span>
<a href="#l11.1252"></a><span id="l11.1252"> </span>
<a href="#l11.1253"></a><span id="l11.1253">   nsDependentCString cstringReadBuf(readBuf, bytesRead);</span>
<a href="#l11.1254"></a><span id="l11.1254" class="difflineminus">-  if (charsetConversion)</span>
<a href="#l11.1255"></a><span id="l11.1255" class="difflineminus">-  {</span>
<a href="#l11.1256"></a><span id="l11.1256" class="difflineminus">-    if (NS_FAILED(nsMsgI18NConvertToUnicode(m_charset, cstringReadBuf, sigData)))</span>
<a href="#l11.1257"></a><span id="l11.1257" class="difflineplus">+  if (charsetConversion) {</span>
<a href="#l11.1258"></a><span id="l11.1258" class="difflineplus">+    if (NS_FAILED(</span>
<a href="#l11.1259"></a><span id="l11.1259" class="difflineplus">+            nsMsgI18NConvertToUnicode(m_charset, cstringReadBuf, sigData)))</span>
<a href="#l11.1260"></a><span id="l11.1260">       CopyASCIItoUTF16(cstringReadBuf, sigData);</span>
<a href="#l11.1261"></a><span id="l11.1261" class="difflineminus">-  }</span>
<a href="#l11.1262"></a><span id="l11.1262" class="difflineminus">-  else</span>
<a href="#l11.1263"></a><span id="l11.1263" class="difflineplus">+  } else</span>
<a href="#l11.1264"></a><span id="l11.1264">     CopyASCIItoUTF16(cstringReadBuf, sigData);</span>
<a href="#l11.1265"></a><span id="l11.1265"> </span>
<a href="#l11.1266"></a><span id="l11.1266">   PR_FREEIF(readBuf);</span>
<a href="#l11.1267"></a><span id="l11.1267">   return NS_OK;</span>
<a href="#l11.1268"></a><span id="l11.1268"> }</span>
<a href="#l11.1269"></a><span id="l11.1269"> </span>
<a href="#l11.1270"></a><span id="l11.1270" class="difflineminus">-nsresult</span>
<a href="#l11.1271"></a><span id="l11.1271" class="difflineminus">-nsMsgAttachmentHandler::Abort()</span>
<a href="#l11.1272"></a><span id="l11.1272" class="difflineminus">-{</span>
<a href="#l11.1273"></a><span id="l11.1273" class="difflineplus">+nsresult nsMsgAttachmentHandler::Abort() {</span>
<a href="#l11.1274"></a><span id="l11.1274">   nsCOMPtr&lt;nsIRequest&gt; saveRequest;</span>
<a href="#l11.1275"></a><span id="l11.1275">   saveRequest.swap(mRequest);</span>
<a href="#l11.1276"></a><span id="l11.1276"> </span>
<a href="#l11.1277"></a><span id="l11.1277" class="difflineminus">-  if (mTmpFile)</span>
<a href="#l11.1278"></a><span id="l11.1278" class="difflineminus">-  {</span>
<a href="#l11.1279"></a><span id="l11.1279" class="difflineminus">-    if (mDeleteFile)</span>
<a href="#l11.1280"></a><span id="l11.1280" class="difflineminus">-      mTmpFile-&gt;Remove(false);</span>
<a href="#l11.1281"></a><span id="l11.1281" class="difflineplus">+  if (mTmpFile) {</span>
<a href="#l11.1282"></a><span id="l11.1282" class="difflineplus">+    if (mDeleteFile) mTmpFile-&gt;Remove(false);</span>
<a href="#l11.1283"></a><span id="l11.1283">     mTmpFile = nullptr;</span>
<a href="#l11.1284"></a><span id="l11.1284">   }</span>
<a href="#l11.1285"></a><span id="l11.1285"> </span>
<a href="#l11.1286"></a><span id="l11.1286" class="difflineminus">-  NS_ASSERTION(m_mime_delivery_state != nullptr, &quot;not-null m_mime_delivery_state&quot;);</span>
<a href="#l11.1287"></a><span id="l11.1287" class="difflineplus">+  NS_ASSERTION(m_mime_delivery_state != nullptr,</span>
<a href="#l11.1288"></a><span id="l11.1288" class="difflineplus">+               &quot;not-null m_mime_delivery_state&quot;);</span>
<a href="#l11.1289"></a><span id="l11.1289"> </span>
<a href="#l11.1290"></a><span id="l11.1290" class="difflineminus">-  if (m_done)</span>
<a href="#l11.1291"></a><span id="l11.1291" class="difflineminus">-    return NS_OK;</span>
<a href="#l11.1292"></a><span id="l11.1292" class="difflineplus">+  if (m_done) return NS_OK;</span>
<a href="#l11.1293"></a><span id="l11.1293"> </span>
<a href="#l11.1294"></a><span id="l11.1294">   if (saveRequest)</span>
<a href="#l11.1295"></a><span id="l11.1295">     return saveRequest-&gt;Cancel(NS_ERROR_ABORT);</span>
<a href="#l11.1296"></a><span id="l11.1296" class="difflineminus">-  else</span>
<a href="#l11.1297"></a><span id="l11.1297" class="difflineminus">-    if (m_mime_delivery_state)</span>
<a href="#l11.1298"></a><span id="l11.1298" class="difflineminus">-    {</span>
<a href="#l11.1299"></a><span id="l11.1299" class="difflineminus">-      m_mime_delivery_state-&gt;SetStatus(NS_ERROR_ABORT);</span>
<a href="#l11.1300"></a><span id="l11.1300" class="difflineminus">-      m_mime_delivery_state-&gt;NotifyListenerOnStopSending(nullptr, NS_ERROR_ABORT, 0, nullptr);</span>
<a href="#l11.1301"></a><span id="l11.1301" class="difflineminus">-    }</span>
<a href="#l11.1302"></a><span id="l11.1302" class="difflineplus">+  else if (m_mime_delivery_state) {</span>
<a href="#l11.1303"></a><span id="l11.1303" class="difflineplus">+    m_mime_delivery_state-&gt;SetStatus(NS_ERROR_ABORT);</span>
<a href="#l11.1304"></a><span id="l11.1304" class="difflineplus">+    m_mime_delivery_state-&gt;NotifyListenerOnStopSending(nullptr, NS_ERROR_ABORT,</span>
<a href="#l11.1305"></a><span id="l11.1305" class="difflineplus">+                                                       0, nullptr);</span>
<a href="#l11.1306"></a><span id="l11.1306" class="difflineplus">+  }</span>
<a href="#l11.1307"></a><span id="l11.1307">   return NS_OK;</span>
<a href="#l11.1308"></a><span id="l11.1308" class="difflineminus">-</span>
<a href="#l11.1309"></a><span id="l11.1309"> }</span>
<a href="#l11.1310"></a><span id="l11.1310"> </span>
<a href="#l11.1311"></a><span id="l11.1311" class="difflineminus">-nsresult</span>
<a href="#l11.1312"></a><span id="l11.1312" class="difflineminus">-nsMsgAttachmentHandler::UrlExit(nsresult status, const char16_t* aMsg)</span>
<a href="#l11.1313"></a><span id="l11.1313" class="difflineminus">-{</span>
<a href="#l11.1314"></a><span id="l11.1314" class="difflineminus">-  NS_ASSERTION(m_mime_delivery_state != nullptr, &quot;not-null m_mime_delivery_state&quot;);</span>
<a href="#l11.1315"></a><span id="l11.1315" class="difflineplus">+nsresult nsMsgAttachmentHandler::UrlExit(nsresult status,</span>
<a href="#l11.1316"></a><span id="l11.1316" class="difflineplus">+                                         const char16_t *aMsg) {</span>
<a href="#l11.1317"></a><span id="l11.1317" class="difflineplus">+  NS_ASSERTION(m_mime_delivery_state != nullptr,</span>
<a href="#l11.1318"></a><span id="l11.1318" class="difflineplus">+               &quot;not-null m_mime_delivery_state&quot;);</span>
<a href="#l11.1319"></a><span id="l11.1319"> </span>
<a href="#l11.1320"></a><span id="l11.1320">   // Close the file, but don't delete the disk file (or the file spec.)</span>
<a href="#l11.1321"></a><span id="l11.1321" class="difflineminus">-  if (mOutFile)</span>
<a href="#l11.1322"></a><span id="l11.1322" class="difflineminus">-  {</span>
<a href="#l11.1323"></a><span id="l11.1323" class="difflineplus">+  if (mOutFile) {</span>
<a href="#l11.1324"></a><span id="l11.1324">     mOutFile-&gt;Close();</span>
<a href="#l11.1325"></a><span id="l11.1325">     mOutFile = nullptr;</span>
<a href="#l11.1326"></a><span id="l11.1326">   }</span>
<a href="#l11.1327"></a><span id="l11.1327">   // this silliness is because Windows nsIFile caches its file size</span>
<a href="#l11.1328"></a><span id="l11.1328">   // so if an output stream writes to it, it will still return the original</span>
<a href="#l11.1329"></a><span id="l11.1329">   // cached size.</span>
<a href="#l11.1330"></a><span id="l11.1330" class="difflineminus">-  if (mTmpFile)</span>
<a href="#l11.1331"></a><span id="l11.1331" class="difflineminus">-  {</span>
<a href="#l11.1332"></a><span id="l11.1332" class="difflineminus">-    nsCOMPtr &lt;nsIFile&gt; tmpFile;</span>
<a href="#l11.1333"></a><span id="l11.1333" class="difflineplus">+  if (mTmpFile) {</span>
<a href="#l11.1334"></a><span id="l11.1334" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; tmpFile;</span>
<a href="#l11.1335"></a><span id="l11.1335">     mTmpFile-&gt;Clone(getter_AddRefs(tmpFile));</span>
<a href="#l11.1336"></a><span id="l11.1336">     mTmpFile = tmpFile;</span>
<a href="#l11.1337"></a><span id="l11.1337">   }</span>
<a href="#l11.1338"></a><span id="l11.1338">   mRequest = nullptr;</span>
<a href="#l11.1339"></a><span id="l11.1339"> </span>
<a href="#l11.1340"></a><span id="l11.1340">   // First things first, we are now going to see if this is an HTML</span>
<a href="#l11.1341"></a><span id="l11.1341">   // Doc and if it is, we need to see if we can determine the charset</span>
<a href="#l11.1342"></a><span id="l11.1342">   // for this part by sniffing the HTML file.</span>
<a href="#l11.1343"></a><span id="l11.1343" class="difflineat">@@ -1096,255 +986,237 @@ nsMsgAttachmentHandler::UrlExit(nsresult</span>
<a href="#l11.1344"></a><span id="l11.1344">   //</span>
<a href="#l11.1345"></a><span id="l11.1345">   if (!m_type.IsEmpty() &amp;&amp; m_charset.IsEmpty() &amp;&amp;</span>
<a href="#l11.1346"></a><span id="l11.1346">       m_type.LowerCaseEqualsLiteral(TEXT_HTML))</span>
<a href="#l11.1347"></a><span id="l11.1347">     m_charset = nsMsgI18NParseMetaCharset(mTmpFile);</span>
<a href="#l11.1348"></a><span id="l11.1348"> </span>
<a href="#l11.1349"></a><span id="l11.1349">   nsresult mimeDeliveryStatus;</span>
<a href="#l11.1350"></a><span id="l11.1350">   m_mime_delivery_state-&gt;GetStatus(&amp;mimeDeliveryStatus);</span>
<a href="#l11.1351"></a><span id="l11.1351"> </span>
<a href="#l11.1352"></a><span id="l11.1352" class="difflineminus">-  if (mimeDeliveryStatus == NS_ERROR_ABORT)</span>
<a href="#l11.1353"></a><span id="l11.1353" class="difflineminus">-    status = NS_ERROR_ABORT;</span>
<a href="#l11.1354"></a><span id="l11.1354" class="difflineplus">+  if (mimeDeliveryStatus == NS_ERROR_ABORT) status = NS_ERROR_ABORT;</span>
<a href="#l11.1355"></a><span id="l11.1355"> </span>
<a href="#l11.1356"></a><span id="l11.1356">   // If the attachment is empty, let's call that a failure.</span>
<a href="#l11.1357"></a><span id="l11.1357" class="difflineminus">-  if (!m_size)</span>
<a href="#l11.1358"></a><span id="l11.1358" class="difflineminus">-    status = NS_ERROR_FAILURE;</span>
<a href="#l11.1359"></a><span id="l11.1359" class="difflineplus">+  if (!m_size) status = NS_ERROR_FAILURE;</span>
<a href="#l11.1360"></a><span id="l11.1360"> </span>
<a href="#l11.1361"></a><span id="l11.1361" class="difflineminus">-  if (NS_FAILED(status) &amp;&amp; status != NS_ERROR_ABORT &amp;&amp; NS_SUCCEEDED(mimeDeliveryStatus))</span>
<a href="#l11.1362"></a><span id="l11.1362" class="difflineminus">-  {</span>
<a href="#l11.1363"></a><span id="l11.1363" class="difflineplus">+  if (NS_FAILED(status) &amp;&amp; status != NS_ERROR_ABORT &amp;&amp;</span>
<a href="#l11.1364"></a><span id="l11.1364" class="difflineplus">+      NS_SUCCEEDED(mimeDeliveryStatus)) {</span>
<a href="#l11.1365"></a><span id="l11.1365">     // At this point, we should probably ask a question to the user</span>
<a href="#l11.1366"></a><span id="l11.1366">     // if we should continue without this attachment.</span>
<a href="#l11.1367"></a><span id="l11.1367">     //</span>
<a href="#l11.1368"></a><span id="l11.1368" class="difflineminus">-    bool              keepOnGoing = true;</span>
<a href="#l11.1369"></a><span id="l11.1369" class="difflineminus">-    nsCString    turl;</span>
<a href="#l11.1370"></a><span id="l11.1370" class="difflineminus">-    nsString     msg;</span>
<a href="#l11.1371"></a><span id="l11.1371" class="difflineplus">+    bool keepOnGoing = true;</span>
<a href="#l11.1372"></a><span id="l11.1372" class="difflineplus">+    nsCString turl;</span>
<a href="#l11.1373"></a><span id="l11.1373" class="difflineplus">+    nsString msg;</span>
<a href="#l11.1374"></a><span id="l11.1374">     nsresult rv;</span>
<a href="#l11.1375"></a><span id="l11.1375">     nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l11.1376"></a><span id="l11.1376" class="difflineminus">-      mozilla::services::GetStringBundleService();</span>
<a href="#l11.1377"></a><span id="l11.1377" class="difflineplus">+        mozilla::services::GetStringBundleService();</span>
<a href="#l11.1378"></a><span id="l11.1378">     NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l11.1379"></a><span id="l11.1379">     nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l11.1380"></a><span id="l11.1380" class="difflineminus">-    rv = bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/messengercompose/composeMsgs.properties&quot;, getter_AddRefs(bundle));</span>
<a href="#l11.1381"></a><span id="l11.1381" class="difflineplus">+    rv = bundleService-&gt;CreateBundle(</span>
<a href="#l11.1382"></a><span id="l11.1382" class="difflineplus">+        &quot;chrome://messenger/locale/messengercompose/composeMsgs.properties&quot;,</span>
<a href="#l11.1383"></a><span id="l11.1383" class="difflineplus">+        getter_AddRefs(bundle));</span>
<a href="#l11.1384"></a><span id="l11.1384">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.1385"></a><span id="l11.1385">     nsMsgDeliverMode mode = nsIMsgSend::nsMsgDeliverNow;</span>
<a href="#l11.1386"></a><span id="l11.1386">     m_mime_delivery_state-&gt;GetDeliveryMode(&amp;mode);</span>
<a href="#l11.1387"></a><span id="l11.1387">     nsCString params;</span>
<a href="#l11.1388"></a><span id="l11.1388">     if (!m_realName.IsEmpty())</span>
<a href="#l11.1389"></a><span id="l11.1389">       params = m_realName;</span>
<a href="#l11.1390"></a><span id="l11.1390" class="difflineminus">-    else if (NS_SUCCEEDED(mURL-&gt;GetSpec(turl)) &amp;&amp; !turl.IsEmpty())</span>
<a href="#l11.1391"></a><span id="l11.1391" class="difflineminus">-    {</span>
<a href="#l11.1392"></a><span id="l11.1392" class="difflineplus">+    else if (NS_SUCCEEDED(mURL-&gt;GetSpec(turl)) &amp;&amp; !turl.IsEmpty()) {</span>
<a href="#l11.1393"></a><span id="l11.1393">       nsAutoCString unescapedUrl;</span>
<a href="#l11.1394"></a><span id="l11.1394">       MsgUnescapeString(turl, 0, unescapedUrl);</span>
<a href="#l11.1395"></a><span id="l11.1395">       if (unescapedUrl.IsEmpty())</span>
<a href="#l11.1396"></a><span id="l11.1396">         params = turl;</span>
<a href="#l11.1397"></a><span id="l11.1397">       else</span>
<a href="#l11.1398"></a><span id="l11.1398">         params = unescapedUrl;</span>
<a href="#l11.1399"></a><span id="l11.1399" class="difflineminus">-    }</span>
<a href="#l11.1400"></a><span id="l11.1400" class="difflineminus">-    else</span>
<a href="#l11.1401"></a><span id="l11.1401" class="difflineplus">+    } else</span>
<a href="#l11.1402"></a><span id="l11.1402">       params.Assign('?');</span>
<a href="#l11.1403"></a><span id="l11.1403"> </span>
<a href="#l11.1404"></a><span id="l11.1404">     NS_ConvertUTF8toUTF16 UTF16params(params);</span>
<a href="#l11.1405"></a><span id="l11.1405" class="difflineminus">-    const char16_t* formatParams[] = { UTF16params.get() };</span>
<a href="#l11.1406"></a><span id="l11.1406" class="difflineminus">-    if (mode == nsIMsgSend::nsMsgSaveAsDraft || mode == nsIMsgSend::nsMsgSaveAsTemplate)</span>
<a href="#l11.1407"></a><span id="l11.1407" class="difflineplus">+    const char16_t *formatParams[] = {UTF16params.get()};</span>
<a href="#l11.1408"></a><span id="l11.1408" class="difflineplus">+    if (mode == nsIMsgSend::nsMsgSaveAsDraft ||</span>
<a href="#l11.1409"></a><span id="l11.1409" class="difflineplus">+        mode == nsIMsgSend::nsMsgSaveAsTemplate)</span>
<a href="#l11.1410"></a><span id="l11.1410">       bundle-&gt;FormatStringFromName(&quot;failureOnObjectEmbeddingWhileSaving&quot;,</span>
<a href="#l11.1411"></a><span id="l11.1411">                                    formatParams, 1, msg);</span>
<a href="#l11.1412"></a><span id="l11.1412">     else</span>
<a href="#l11.1413"></a><span id="l11.1413">       bundle-&gt;FormatStringFromName(&quot;failureOnObjectEmbeddingWhileSending&quot;,</span>
<a href="#l11.1414"></a><span id="l11.1414">                                    formatParams, 1, msg);</span>
<a href="#l11.1415"></a><span id="l11.1415"> </span>
<a href="#l11.1416"></a><span id="l11.1416">     nsCOMPtr&lt;nsIPrompt&gt; aPrompt;</span>
<a href="#l11.1417"></a><span id="l11.1417">     if (m_mime_delivery_state)</span>
<a href="#l11.1418"></a><span id="l11.1418">       m_mime_delivery_state-&gt;GetDefaultPrompt(getter_AddRefs(aPrompt));</span>
<a href="#l11.1419"></a><span id="l11.1419">     nsMsgAskBooleanQuestionByString(aPrompt, msg.get(), &amp;keepOnGoing);</span>
<a href="#l11.1420"></a><span id="l11.1420"> </span>
<a href="#l11.1421"></a><span id="l11.1421" class="difflineminus">-    if (keepOnGoing)</span>
<a href="#l11.1422"></a><span id="l11.1422" class="difflineminus">-    {</span>
<a href="#l11.1423"></a><span id="l11.1423" class="difflineplus">+    if (keepOnGoing) {</span>
<a href="#l11.1424"></a><span id="l11.1424">       status = NS_OK;</span>
<a href="#l11.1425"></a><span id="l11.1425" class="difflineminus">-      m_bogus_attachment = true; //That will cause this attachment to be ignored.</span>
<a href="#l11.1426"></a><span id="l11.1426" class="difflineminus">-    }</span>
<a href="#l11.1427"></a><span id="l11.1427" class="difflineminus">-    else</span>
<a href="#l11.1428"></a><span id="l11.1428" class="difflineminus">-    {</span>
<a href="#l11.1429"></a><span id="l11.1429" class="difflineplus">+      m_bogus_attachment =</span>
<a href="#l11.1430"></a><span id="l11.1430" class="difflineplus">+          true;  // That will cause this attachment to be ignored.</span>
<a href="#l11.1431"></a><span id="l11.1431" class="difflineplus">+    } else {</span>
<a href="#l11.1432"></a><span id="l11.1432">       status = NS_ERROR_ABORT;</span>
<a href="#l11.1433"></a><span id="l11.1433">       m_mime_delivery_state-&gt;SetStatus(status);</span>
<a href="#l11.1434"></a><span id="l11.1434">       nsresult ignoreMe;</span>
<a href="#l11.1435"></a><span id="l11.1435">       m_mime_delivery_state-&gt;Fail(status, nullptr, &amp;ignoreMe);</span>
<a href="#l11.1436"></a><span id="l11.1436" class="difflineminus">-      m_mime_delivery_state-&gt;NotifyListenerOnStopSending(nullptr, status, 0, nullptr);</span>
<a href="#l11.1437"></a><span id="l11.1437" class="difflineplus">+      m_mime_delivery_state-&gt;NotifyListenerOnStopSending(nullptr, status, 0,</span>
<a href="#l11.1438"></a><span id="l11.1438" class="difflineplus">+                                                         nullptr);</span>
<a href="#l11.1439"></a><span id="l11.1439">       SetMimeDeliveryState(nullptr);</span>
<a href="#l11.1440"></a><span id="l11.1440">       return status;</span>
<a href="#l11.1441"></a><span id="l11.1441">     }</span>
<a href="#l11.1442"></a><span id="l11.1442">   }</span>
<a href="#l11.1443"></a><span id="l11.1443"> </span>
<a href="#l11.1444"></a><span id="l11.1444">   m_done = true;</span>
<a href="#l11.1445"></a><span id="l11.1445"> </span>
<a href="#l11.1446"></a><span id="l11.1446">   //</span>
<a href="#l11.1447"></a><span id="l11.1447">   // Ok, now that we have the file here on disk, we need to see if there was</span>
<a href="#l11.1448"></a><span id="l11.1448">   // a need to do conversion to plain text...if so, the magic happens here,</span>
<a href="#l11.1449"></a><span id="l11.1449">   // otherwise, just move on to other attachments...</span>
<a href="#l11.1450"></a><span id="l11.1450">   //</span>
<a href="#l11.1451"></a><span id="l11.1451">   if (NS_SUCCEEDED(status) &amp;&amp; !m_type.LowerCaseEqualsLiteral(TEXT_PLAIN) &amp;&amp;</span>
<a href="#l11.1452"></a><span id="l11.1452" class="difflineminus">-      m_desiredType.LowerCaseEqualsLiteral(TEXT_PLAIN))</span>
<a href="#l11.1453"></a><span id="l11.1453" class="difflineminus">-  {</span>
<a href="#l11.1454"></a><span id="l11.1454" class="difflineplus">+      m_desiredType.LowerCaseEqualsLiteral(TEXT_PLAIN)) {</span>
<a href="#l11.1455"></a><span id="l11.1455">     //</span>
<a href="#l11.1456"></a><span id="l11.1456">     // Conversion to plain text desired.</span>
<a href="#l11.1457"></a><span id="l11.1457">     // Now use the converter service here to do the right</span>
<a href="#l11.1458"></a><span id="l11.1458">     // thing and convert this data to plain text for us!</span>
<a href="#l11.1459"></a><span id="l11.1459">     //</span>
<a href="#l11.1460"></a><span id="l11.1460" class="difflineminus">-    nsAutoString      conData;</span>
<a href="#l11.1461"></a><span id="l11.1461" class="difflineplus">+    nsAutoString conData;</span>
<a href="#l11.1462"></a><span id="l11.1462"> </span>
<a href="#l11.1463"></a><span id="l11.1463" class="difflineminus">-    if (NS_SUCCEEDED(LoadDataFromFile(mTmpFile, conData, true)))</span>
<a href="#l11.1464"></a><span id="l11.1464" class="difflineminus">-    {</span>
<a href="#l11.1465"></a><span id="l11.1465" class="difflineplus">+    if (NS_SUCCEEDED(LoadDataFromFile(mTmpFile, conData, true))) {</span>
<a href="#l11.1466"></a><span id="l11.1466">       bool flowed, delsp, formatted, disallowBreaks;</span>
<a href="#l11.1467"></a><span id="l11.1467" class="difflineminus">-      GetSerialiserFlags(m_charset.get(), &amp;flowed, &amp;delsp, &amp;formatted, &amp;disallowBreaks);</span>
<a href="#l11.1468"></a><span id="l11.1468" class="difflineplus">+      GetSerialiserFlags(m_charset.get(), &amp;flowed, &amp;delsp, &amp;formatted,</span>
<a href="#l11.1469"></a><span id="l11.1469" class="difflineplus">+                         &amp;disallowBreaks);</span>
<a href="#l11.1470"></a><span id="l11.1470"> </span>
<a href="#l11.1471"></a><span id="l11.1471" class="difflineminus">-      if (NS_SUCCEEDED(ConvertBufToPlainText(conData, flowed, delsp, formatted, disallowBreaks)))</span>
<a href="#l11.1472"></a><span id="l11.1472" class="difflineminus">-      {</span>
<a href="#l11.1473"></a><span id="l11.1473" class="difflineminus">-        if (mDeleteFile)</span>
<a href="#l11.1474"></a><span id="l11.1474" class="difflineminus">-          mTmpFile-&gt;Remove(false);</span>
<a href="#l11.1475"></a><span id="l11.1475" class="difflineplus">+      if (NS_SUCCEEDED(ConvertBufToPlainText(conData, flowed, delsp, formatted,</span>
<a href="#l11.1476"></a><span id="l11.1476" class="difflineplus">+                                             disallowBreaks))) {</span>
<a href="#l11.1477"></a><span id="l11.1477" class="difflineplus">+        if (mDeleteFile) mTmpFile-&gt;Remove(false);</span>
<a href="#l11.1478"></a><span id="l11.1478"> </span>
<a href="#l11.1479"></a><span id="l11.1479">         nsCOMPtr&lt;nsIOutputStream&gt; outputStream;</span>
<a href="#l11.1480"></a><span id="l11.1480" class="difflineminus">-        nsresult rv = MsgNewBufferedFileOutputStream(getter_AddRefs(outputStream), mTmpFile,</span>
<a href="#l11.1481"></a><span id="l11.1481" class="difflineminus">-                                                     PR_WRONLY | PR_CREATE_FILE, 00600);</span>
<a href="#l11.1482"></a><span id="l11.1482" class="difflineplus">+        nsresult rv = MsgNewBufferedFileOutputStream(</span>
<a href="#l11.1483"></a><span id="l11.1483" class="difflineplus">+            getter_AddRefs(outputStream), mTmpFile, PR_WRONLY | PR_CREATE_FILE,</span>
<a href="#l11.1484"></a><span id="l11.1484" class="difflineplus">+            00600);</span>
<a href="#l11.1485"></a><span id="l11.1485"> </span>
<a href="#l11.1486"></a><span id="l11.1486" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l11.1487"></a><span id="l11.1487" class="difflineminus">-        {</span>
<a href="#l11.1488"></a><span id="l11.1488" class="difflineplus">+        if (NS_SUCCEEDED(rv)) {</span>
<a href="#l11.1489"></a><span id="l11.1489">           nsAutoCString tData;</span>
<a href="#l11.1490"></a><span id="l11.1490">           if (NS_FAILED(nsMsgI18NConvertFromUnicode(m_charset, conData, tData)))</span>
<a href="#l11.1491"></a><span id="l11.1491">             LossyCopyUTF16toASCII(conData, tData);</span>
<a href="#l11.1492"></a><span id="l11.1492" class="difflineminus">-          if (!tData.IsEmpty())</span>
<a href="#l11.1493"></a><span id="l11.1493" class="difflineminus">-          {</span>
<a href="#l11.1494"></a><span id="l11.1494" class="difflineplus">+          if (!tData.IsEmpty()) {</span>
<a href="#l11.1495"></a><span id="l11.1495">             uint32_t bytesWritten;</span>
<a href="#l11.1496"></a><span id="l11.1496" class="difflineminus">-            (void) outputStream-&gt;Write(tData.get(), tData.Length(), &amp;bytesWritten);</span>
<a href="#l11.1497"></a><span id="l11.1497" class="difflineplus">+            (void)outputStream-&gt;Write(tData.get(), tData.Length(),</span>
<a href="#l11.1498"></a><span id="l11.1498" class="difflineplus">+                                      &amp;bytesWritten);</span>
<a href="#l11.1499"></a><span id="l11.1499">           }</span>
<a href="#l11.1500"></a><span id="l11.1500">           outputStream-&gt;Close();</span>
<a href="#l11.1501"></a><span id="l11.1501">           // this silliness is because Windows nsIFile caches its file size</span>
<a href="#l11.1502"></a><span id="l11.1502" class="difflineminus">-          // so if an output stream writes to it, it will still return the original</span>
<a href="#l11.1503"></a><span id="l11.1503" class="difflineminus">-          // cached size.</span>
<a href="#l11.1504"></a><span id="l11.1504" class="difflineminus">-          if (mTmpFile)</span>
<a href="#l11.1505"></a><span id="l11.1505" class="difflineminus">-          {</span>
<a href="#l11.1506"></a><span id="l11.1506" class="difflineminus">-            nsCOMPtr &lt;nsIFile&gt; tmpFile;</span>
<a href="#l11.1507"></a><span id="l11.1507" class="difflineplus">+          // so if an output stream writes to it, it will still return the</span>
<a href="#l11.1508"></a><span id="l11.1508" class="difflineplus">+          // original cached size.</span>
<a href="#l11.1509"></a><span id="l11.1509" class="difflineplus">+          if (mTmpFile) {</span>
<a href="#l11.1510"></a><span id="l11.1510" class="difflineplus">+            nsCOMPtr&lt;nsIFile&gt; tmpFile;</span>
<a href="#l11.1511"></a><span id="l11.1511">             mTmpFile-&gt;Clone(getter_AddRefs(tmpFile));</span>
<a href="#l11.1512"></a><span id="l11.1512">             mTmpFile = tmpFile;</span>
<a href="#l11.1513"></a><span id="l11.1513">           }</span>
<a href="#l11.1514"></a><span id="l11.1514" class="difflineminus">-</span>
<a href="#l11.1515"></a><span id="l11.1515">         }</span>
<a href="#l11.1516"></a><span id="l11.1516">       }</span>
<a href="#l11.1517"></a><span id="l11.1517">     }</span>
<a href="#l11.1518"></a><span id="l11.1518"> </span>
<a href="#l11.1519"></a><span id="l11.1519">     m_type = m_desiredType;</span>
<a href="#l11.1520"></a><span id="l11.1520">     m_desiredType.Truncate();</span>
<a href="#l11.1521"></a><span id="l11.1521">     m_encoding.Truncate();</span>
<a href="#l11.1522"></a><span id="l11.1522">   }</span>
<a href="#l11.1523"></a><span id="l11.1523"> </span>
<a href="#l11.1524"></a><span id="l11.1524">   uint32_t pendingAttachmentCount = 0;</span>
<a href="#l11.1525"></a><span id="l11.1525">   m_mime_delivery_state-&gt;GetPendingAttachmentCount(&amp;pendingAttachmentCount);</span>
<a href="#l11.1526"></a><span id="l11.1526" class="difflineminus">-  NS_ASSERTION (pendingAttachmentCount &gt; 0, &quot;no more pending attachment&quot;);</span>
<a href="#l11.1527"></a><span id="l11.1527" class="difflineplus">+  NS_ASSERTION(pendingAttachmentCount &gt; 0, &quot;no more pending attachment&quot;);</span>
<a href="#l11.1528"></a><span id="l11.1528"> </span>
<a href="#l11.1529"></a><span id="l11.1529">   m_mime_delivery_state-&gt;SetPendingAttachmentCount(pendingAttachmentCount - 1);</span>
<a href="#l11.1530"></a><span id="l11.1530"> </span>
<a href="#l11.1531"></a><span id="l11.1531">   bool processAttachmentsSynchronously = false;</span>
<a href="#l11.1532"></a><span id="l11.1532" class="difflineminus">-  m_mime_delivery_state-&gt;GetProcessAttachmentsSynchronously(&amp;processAttachmentsSynchronously);</span>
<a href="#l11.1533"></a><span id="l11.1533" class="difflineminus">-  if (NS_SUCCEEDED(status) &amp;&amp; processAttachmentsSynchronously)</span>
<a href="#l11.1534"></a><span id="l11.1534" class="difflineminus">-  {</span>
<a href="#l11.1535"></a><span id="l11.1535" class="difflineplus">+  m_mime_delivery_state-&gt;GetProcessAttachmentsSynchronously(</span>
<a href="#l11.1536"></a><span id="l11.1536" class="difflineplus">+      &amp;processAttachmentsSynchronously);</span>
<a href="#l11.1537"></a><span id="l11.1537" class="difflineplus">+  if (NS_SUCCEEDED(status) &amp;&amp; processAttachmentsSynchronously) {</span>
<a href="#l11.1538"></a><span id="l11.1538">     /* Find the next attachment which has not yet been loaded,</span>
<a href="#l11.1539"></a><span id="l11.1539">      if any, and start it going.</span>
<a href="#l11.1540"></a><span id="l11.1540">      */</span>
<a href="#l11.1541"></a><span id="l11.1541">     uint32_t i;</span>
<a href="#l11.1542"></a><span id="l11.1542">     nsMsgAttachmentHandler *next = 0;</span>
<a href="#l11.1543"></a><span id="l11.1543">     nsTArray&lt;RefPtr&lt;nsMsgAttachmentHandler&gt;&gt; *attachments;</span>
<a href="#l11.1544"></a><span id="l11.1544"> </span>
<a href="#l11.1545"></a><span id="l11.1545">     m_mime_delivery_state-&gt;GetAttachmentHandlers(&amp;attachments);</span>
<a href="#l11.1546"></a><span id="l11.1546"> </span>
<a href="#l11.1547"></a><span id="l11.1547" class="difflineminus">-    for (i = 0; i &lt; attachments-&gt;Length(); i++)</span>
<a href="#l11.1548"></a><span id="l11.1548" class="difflineminus">-    {</span>
<a href="#l11.1549"></a><span id="l11.1549" class="difflineminus">-      if (!(*attachments)[i]-&gt;m_done)</span>
<a href="#l11.1550"></a><span id="l11.1550" class="difflineminus">-      {</span>
<a href="#l11.1551"></a><span id="l11.1551" class="difflineplus">+    for (i = 0; i &lt; attachments-&gt;Length(); i++) {</span>
<a href="#l11.1552"></a><span id="l11.1552" class="difflineplus">+      if (!(*attachments)[i]-&gt;m_done) {</span>
<a href="#l11.1553"></a><span id="l11.1553">         next = (*attachments)[i];</span>
<a href="#l11.1554"></a><span id="l11.1554">         //</span>
<a href="#l11.1555"></a><span id="l11.1555">         // rhp: We need to get a little more understanding to failed URL</span>
<a href="#l11.1556"></a><span id="l11.1556">         // requests. So, at this point if most of next is NULL, then we</span>
<a href="#l11.1557"></a><span id="l11.1557">         // should just mark it fetched and move on! We probably ignored</span>
<a href="#l11.1558"></a><span id="l11.1558">         // this earlier on in the send process.</span>
<a href="#l11.1559"></a><span id="l11.1559">         //</span>
<a href="#l11.1560"></a><span id="l11.1560" class="difflineminus">-        if ( (!next-&gt;mURL) &amp;&amp; (next-&gt;m_uri.IsEmpty()) )</span>
<a href="#l11.1561"></a><span id="l11.1561" class="difflineminus">-        {</span>
<a href="#l11.1562"></a><span id="l11.1562" class="difflineplus">+        if ((!next-&gt;mURL) &amp;&amp; (next-&gt;m_uri.IsEmpty())) {</span>
<a href="#l11.1563"></a><span id="l11.1563">           (*attachments)[i]-&gt;m_done = true;</span>
<a href="#l11.1564"></a><span id="l11.1564">           (*attachments)[i]-&gt;SetMimeDeliveryState(nullptr);</span>
<a href="#l11.1565"></a><span id="l11.1565" class="difflineminus">-          m_mime_delivery_state-&gt;GetPendingAttachmentCount(&amp;pendingAttachmentCount);</span>
<a href="#l11.1566"></a><span id="l11.1566" class="difflineminus">-          m_mime_delivery_state-&gt;SetPendingAttachmentCount(pendingAttachmentCount - 1);</span>
<a href="#l11.1567"></a><span id="l11.1567" class="difflineplus">+          m_mime_delivery_state-&gt;GetPendingAttachmentCount(</span>
<a href="#l11.1568"></a><span id="l11.1568" class="difflineplus">+              &amp;pendingAttachmentCount);</span>
<a href="#l11.1569"></a><span id="l11.1569" class="difflineplus">+          m_mime_delivery_state-&gt;SetPendingAttachmentCount(</span>
<a href="#l11.1570"></a><span id="l11.1570" class="difflineplus">+              pendingAttachmentCount - 1);</span>
<a href="#l11.1571"></a><span id="l11.1571">           next-&gt;mPartUserOmissionOverride = true;</span>
<a href="#l11.1572"></a><span id="l11.1572">           next = nullptr;</span>
<a href="#l11.1573"></a><span id="l11.1573">           continue;</span>
<a href="#l11.1574"></a><span id="l11.1574">         }</span>
<a href="#l11.1575"></a><span id="l11.1575"> </span>
<a href="#l11.1576"></a><span id="l11.1576">         break;</span>
<a href="#l11.1577"></a><span id="l11.1577">       }</span>
<a href="#l11.1578"></a><span id="l11.1578">     }</span>
<a href="#l11.1579"></a><span id="l11.1579"> </span>
<a href="#l11.1580"></a><span id="l11.1580" class="difflineminus">-    if (next)</span>
<a href="#l11.1581"></a><span id="l11.1581" class="difflineminus">-    {</span>
<a href="#l11.1582"></a><span id="l11.1582" class="difflineplus">+    if (next) {</span>
<a href="#l11.1583"></a><span id="l11.1583">       nsresult status = next-&gt;SnarfAttachment(mCompFields);</span>
<a href="#l11.1584"></a><span id="l11.1584" class="difflineminus">-      if (NS_FAILED(status))</span>
<a href="#l11.1585"></a><span id="l11.1585" class="difflineminus">-      {</span>
<a href="#l11.1586"></a><span id="l11.1586" class="difflineplus">+      if (NS_FAILED(status)) {</span>
<a href="#l11.1587"></a><span id="l11.1587">         nsresult ignoreMe;</span>
<a href="#l11.1588"></a><span id="l11.1588">         m_mime_delivery_state-&gt;Fail(status, nullptr, &amp;ignoreMe);</span>
<a href="#l11.1589"></a><span id="l11.1589" class="difflineminus">-        m_mime_delivery_state-&gt;NotifyListenerOnStopSending(nullptr, status, 0, nullptr);</span>
<a href="#l11.1590"></a><span id="l11.1590" class="difflineplus">+        m_mime_delivery_state-&gt;NotifyListenerOnStopSending(nullptr, status, 0,</span>
<a href="#l11.1591"></a><span id="l11.1591" class="difflineplus">+                                                           nullptr);</span>
<a href="#l11.1592"></a><span id="l11.1592">         SetMimeDeliveryState(nullptr);</span>
<a href="#l11.1593"></a><span id="l11.1593">         return NS_ERROR_UNEXPECTED;</span>
<a href="#l11.1594"></a><span id="l11.1594">       }</span>
<a href="#l11.1595"></a><span id="l11.1595">     }</span>
<a href="#l11.1596"></a><span id="l11.1596">   }</span>
<a href="#l11.1597"></a><span id="l11.1597"> </span>
<a href="#l11.1598"></a><span id="l11.1598">   m_mime_delivery_state-&gt;GetPendingAttachmentCount(&amp;pendingAttachmentCount);</span>
<a href="#l11.1599"></a><span id="l11.1599" class="difflineminus">-  if (pendingAttachmentCount == 0)</span>
<a href="#l11.1600"></a><span id="l11.1600" class="difflineminus">-  {</span>
<a href="#l11.1601"></a><span id="l11.1601" class="difflineplus">+  if (pendingAttachmentCount == 0) {</span>
<a href="#l11.1602"></a><span id="l11.1602">     // If this is the last attachment, then either complete the</span>
<a href="#l11.1603"></a><span id="l11.1603">     // delivery (if successful) or report the error by calling</span>
<a href="#l11.1604"></a><span id="l11.1604">     // the exit routine and terminating the delivery.</span>
<a href="#l11.1605"></a><span id="l11.1605" class="difflineminus">-    if (NS_FAILED(status))</span>
<a href="#l11.1606"></a><span id="l11.1606" class="difflineminus">-    {</span>
<a href="#l11.1607"></a><span id="l11.1607" class="difflineplus">+    if (NS_FAILED(status)) {</span>
<a href="#l11.1608"></a><span id="l11.1608">       nsresult ignoreMe;</span>
<a href="#l11.1609"></a><span id="l11.1609">       m_mime_delivery_state-&gt;Fail(status, aMsg, &amp;ignoreMe);</span>
<a href="#l11.1610"></a><span id="l11.1610" class="difflineminus">-      m_mime_delivery_state-&gt;NotifyListenerOnStopSending(nullptr, status, aMsg, nullptr);</span>
<a href="#l11.1611"></a><span id="l11.1611" class="difflineplus">+      m_mime_delivery_state-&gt;NotifyListenerOnStopSending(nullptr, status, aMsg,</span>
<a href="#l11.1612"></a><span id="l11.1612" class="difflineplus">+                                                         nullptr);</span>
<a href="#l11.1613"></a><span id="l11.1613">       SetMimeDeliveryState(nullptr);</span>
<a href="#l11.1614"></a><span id="l11.1614">       return NS_ERROR_UNEXPECTED;</span>
<a href="#l11.1615"></a><span id="l11.1615" class="difflineminus">-    }</span>
<a href="#l11.1616"></a><span id="l11.1616" class="difflineminus">-    else</span>
<a href="#l11.1617"></a><span id="l11.1617" class="difflineminus">-    {</span>
<a href="#l11.1618"></a><span id="l11.1618" class="difflineminus">-      status = m_mime_delivery_state-&gt;GatherMimeAttachments ();</span>
<a href="#l11.1619"></a><span id="l11.1619" class="difflineminus">-      if (NS_FAILED(status))</span>
<a href="#l11.1620"></a><span id="l11.1620" class="difflineminus">-      {</span>
<a href="#l11.1621"></a><span id="l11.1621" class="difflineplus">+    } else {</span>
<a href="#l11.1622"></a><span id="l11.1622" class="difflineplus">+      status = m_mime_delivery_state-&gt;GatherMimeAttachments();</span>
<a href="#l11.1623"></a><span id="l11.1623" class="difflineplus">+      if (NS_FAILED(status)) {</span>
<a href="#l11.1624"></a><span id="l11.1624">         nsresult ignoreMe;</span>
<a href="#l11.1625"></a><span id="l11.1625">         m_mime_delivery_state-&gt;Fail(status, aMsg, &amp;ignoreMe);</span>
<a href="#l11.1626"></a><span id="l11.1626" class="difflineminus">-        m_mime_delivery_state-&gt;NotifyListenerOnStopSending(nullptr, status, aMsg, nullptr);</span>
<a href="#l11.1627"></a><span id="l11.1627" class="difflineplus">+        m_mime_delivery_state-&gt;NotifyListenerOnStopSending(nullptr, status,</span>
<a href="#l11.1628"></a><span id="l11.1628" class="difflineplus">+                                                           aMsg, nullptr);</span>
<a href="#l11.1629"></a><span id="l11.1629">         SetMimeDeliveryState(nullptr);</span>
<a href="#l11.1630"></a><span id="l11.1630">         return NS_ERROR_UNEXPECTED;</span>
<a href="#l11.1631"></a><span id="l11.1631">       }</span>
<a href="#l11.1632"></a><span id="l11.1632">     }</span>
<a href="#l11.1633"></a><span id="l11.1633" class="difflineminus">-  }</span>
<a href="#l11.1634"></a><span id="l11.1634" class="difflineminus">-  else</span>
<a href="#l11.1635"></a><span id="l11.1635" class="difflineminus">-  {</span>
<a href="#l11.1636"></a><span id="l11.1636" class="difflineplus">+  } else {</span>
<a href="#l11.1637"></a><span id="l11.1637">     // If this is not the last attachment, but it got an error,</span>
<a href="#l11.1638"></a><span id="l11.1638">     // then report that error and continue</span>
<a href="#l11.1639"></a><span id="l11.1639" class="difflineminus">-    if (NS_FAILED(status))</span>
<a href="#l11.1640"></a><span id="l11.1640" class="difflineminus">-    {</span>
<a href="#l11.1641"></a><span id="l11.1641" class="difflineplus">+    if (NS_FAILED(status)) {</span>
<a href="#l11.1642"></a><span id="l11.1642">       nsresult ignoreMe;</span>
<a href="#l11.1643"></a><span id="l11.1643">       m_mime_delivery_state-&gt;Fail(status, aMsg, &amp;ignoreMe);</span>
<a href="#l11.1644"></a><span id="l11.1644">     }</span>
<a href="#l11.1645"></a><span id="l11.1645">   }</span>
<a href="#l11.1646"></a><span id="l11.1646"> </span>
<a href="#l11.1647"></a><span id="l11.1647">   SetMimeDeliveryState(nullptr);</span>
<a href="#l11.1648"></a><span id="l11.1648">   return NS_OK;</span>
<a href="#l11.1649"></a><span id="l11.1649"> }</span>
<a href="#l11.1650"></a><span id="l11.1650"> </span>
<a href="#l11.1651"></a><span id="l11.1651" class="difflineminus">-</span>
<a href="#l11.1652"></a><span id="l11.1652" class="difflineminus">-nsresult</span>
<a href="#l11.1653"></a><span id="l11.1653" class="difflineminus">-nsMsgAttachmentHandler::GetMimeDeliveryState(nsIMsgSend** _retval)</span>
<a href="#l11.1654"></a><span id="l11.1654" class="difflineminus">-{</span>
<a href="#l11.1655"></a><span id="l11.1655" class="difflineplus">+nsresult nsMsgAttachmentHandler::GetMimeDeliveryState(nsIMsgSend **_retval) {</span>
<a href="#l11.1656"></a><span id="l11.1656">   NS_ENSURE_ARG(_retval);</span>
<a href="#l11.1657"></a><span id="l11.1657">   NS_IF_ADDREF(*_retval = m_mime_delivery_state);</span>
<a href="#l11.1658"></a><span id="l11.1658">   return NS_OK;</span>
<a href="#l11.1659"></a><span id="l11.1659"> }</span>
<a href="#l11.1660"></a><span id="l11.1660"> </span>
<a href="#l11.1661"></a><span id="l11.1661" class="difflineminus">-nsresult</span>
<a href="#l11.1662"></a><span id="l11.1662" class="difflineminus">-nsMsgAttachmentHandler::SetMimeDeliveryState(nsIMsgSend* mime_delivery_state)</span>
<a href="#l11.1663"></a><span id="l11.1663" class="difflineminus">-{</span>
<a href="#l11.1664"></a><span id="l11.1664" class="difflineplus">+nsresult nsMsgAttachmentHandler::SetMimeDeliveryState(</span>
<a href="#l11.1665"></a><span id="l11.1665" class="difflineplus">+    nsIMsgSend *mime_delivery_state) {</span>
<a href="#l11.1666"></a><span id="l11.1666">   m_mime_delivery_state = mime_delivery_state;</span>
<a href="#l11.1667"></a><span id="l11.1667">   return NS_OK;</span>
<a href="#l11.1668"></a><span id="l11.1668"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgAttachmentHandler.h</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgAttachmentHandler.h</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -13,182 +13,186 @@</span>
<a href="#l12.4"></a><span id="l12.4"> #include &quot;nsIMsgSend.h&quot;</span>
<a href="#l12.5"></a><span id="l12.5"> #include &quot;nsIFileStreams.h&quot;</span>
<a href="#l12.6"></a><span id="l12.6"> #include &quot;nsIStreamConverter.h&quot;</span>
<a href="#l12.7"></a><span id="l12.7"> #include &quot;nsAutoPtr.h&quot;</span>
<a href="#l12.8"></a><span id="l12.8"> #include &quot;nsIMsgAttachmentHandler.h&quot;</span>
<a href="#l12.9"></a><span id="l12.9"> </span>
<a href="#l12.10"></a><span id="l12.10"> #ifdef XP_MACOSX</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-#include &quot;nsMsgAppleDouble.h&quot;</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-#include &quot;nsILocalFileMac.h&quot;</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+#  include &quot;nsMsgAppleDouble.h&quot;</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+#  include &quot;nsILocalFileMac.h&quot;</span>
<a href="#l12.16"></a><span id="l12.16"> </span>
<a href="#l12.17"></a><span id="l12.17" class="difflineminus">-class AppleDoubleEncodeObject</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineminus">-{</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineminus">-public:</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineminus">-  appledouble_encode_object   ap_encode_obj;</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineminus">-  char                        *buff;          // the working buff</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineminus">-  int32_t                     s_buff;         // the working buff size</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineminus">-  nsCOMPtr &lt;nsIOutputStream&gt;  fileStream;    // file to hold the encoding</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineplus">+class AppleDoubleEncodeObject {</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineplus">+ public:</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+  appledouble_encode_object ap_encode_obj;</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineplus">+  char *buff;                            // the working buff</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineplus">+  int32_t s_buff;                        // the working buff size</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineplus">+  nsCOMPtr&lt;nsIOutputStream&gt; fileStream;  // file to hold the encoding</span>
<a href="#l12.30"></a><span id="l12.30"> };</span>
<a href="#l12.31"></a><span id="l12.31"> </span>
<a href="#l12.32"></a><span id="l12.32"> class nsILocalFileMac;</span>
<a href="#l12.33"></a><span id="l12.33"> class nsIZipWriter;</span>
<a href="#l12.34"></a><span id="l12.34"> </span>
<a href="#l12.35"></a><span id="l12.35"> /* Simple utility class that will synchronously zip any file</span>
<a href="#l12.36"></a><span id="l12.36">    (or folder hierarchy) you give it. */</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineminus">-class nsSimpleZipper</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineminus">-{</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineminus">-  public:</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineplus">+class nsSimpleZipper {</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineplus">+ public:</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineplus">+  // Synchronously zips the input file/folder and writes all</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineplus">+  // data to the output file.</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+  static nsresult Zip(nsIFile *aInputFile, nsIFile *aOutputFile);</span>
<a href="#l12.45"></a><span id="l12.45"> </span>
<a href="#l12.46"></a><span id="l12.46" class="difflineminus">-    // Synchronously zips the input file/folder and writes all</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineminus">-    // data to the output file.</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineminus">-    static nsresult Zip(nsIFile *aInputFile, nsIFile *aOutputFile);</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineminus">-</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineminus">-  private:</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineminus">-</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineminus">-    // Recursively adds the file or folder to aZipWriter.</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineminus">-    static nsresult AddToZip(nsIZipWriter *aZipWriter,</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineminus">-                             nsIFile *aFile,</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineminus">-                             const nsACString &amp;aPath);</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineplus">+ private:</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineplus">+  // Recursively adds the file or folder to aZipWriter.</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineplus">+  static nsresult AddToZip(nsIZipWriter *aZipWriter, nsIFile *aFile,</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineplus">+                           const nsACString &amp;aPath);</span>
<a href="#l12.60"></a><span id="l12.60"> };</span>
<a href="#l12.61"></a><span id="l12.61"> #endif  // XP_MACOSX</span>
<a href="#l12.62"></a><span id="l12.62"> </span>
<a href="#l12.63"></a><span id="l12.63"> namespace mozilla {</span>
<a href="#l12.64"></a><span id="l12.64"> namespace mailnews {</span>
<a href="#l12.65"></a><span id="l12.65"> class MimeEncoder;</span>
<a href="#l12.66"></a><span id="l12.66"> }</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineminus">-}</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineplus">+}  // namespace mozilla</span>
<a href="#l12.69"></a><span id="l12.69"> </span>
<a href="#l12.70"></a><span id="l12.70"> //</span>
<a href="#l12.71"></a><span id="l12.71"> // This is a class that deals with processing remote attachments. It implements</span>
<a href="#l12.72"></a><span id="l12.72"> // an nsIStreamListener interface to deal with incoming data</span>
<a href="#l12.73"></a><span id="l12.73"> //</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineminus">-class nsMsgAttachmentHandler : public nsIMsgAttachmentHandler</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineminus">-{</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineplus">+class nsMsgAttachmentHandler : public nsIMsgAttachmentHandler {</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineplus">+  typedef mozilla::mailnews::MimeEncoder MimeEncoder;</span>
<a href="#l12.78"></a><span id="l12.78"> </span>
<a href="#l12.79"></a><span id="l12.79" class="difflineminus">-  typedef mozilla::mailnews::MimeEncoder MimeEncoder;</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineminus">-public:</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineplus">+ public:</span>
<a href="#l12.82"></a><span id="l12.82">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l12.83"></a><span id="l12.83">   NS_DECL_NSIMSGATTACHMENTHANDLER</span>
<a href="#l12.84"></a><span id="l12.84"> </span>
<a href="#l12.85"></a><span id="l12.85">   nsMsgAttachmentHandler();</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineminus">-public:</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineminus">-  nsresult              SnarfAttachment(nsMsgCompFields *compFields);</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineminus">-  nsresult              PickEncoding(const char *charset, nsIMsgSend* mime_delivery_state);</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineminus">-  nsresult              PickCharset();</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineminus">-  void                  AnalyzeSnarfedFile ();      // Analyze a previously-snarfed file.</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineminus">-                                                    // (Currently only used for plaintext</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineminus">-                                                    // converted from HTML.)</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineminus">-  nsresult              Abort();</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineminus">-  nsresult              UrlExit(nsresult status, const char16_t* aMsg);</span>
<a href="#l12.95"></a><span id="l12.95"> </span>
<a href="#l12.96"></a><span id="l12.96" class="difflineminus">-  // if there's an intermediate temp file left, takes care to remove it from disk.</span>
<a href="#l12.97"></a><span id="l12.97" class="difflineplus">+ public:</span>
<a href="#l12.98"></a><span id="l12.98" class="difflineplus">+  nsresult SnarfAttachment(nsMsgCompFields *compFields);</span>
<a href="#l12.99"></a><span id="l12.99" class="difflineplus">+  nsresult PickEncoding(const char *charset, nsIMsgSend *mime_delivery_state);</span>
<a href="#l12.100"></a><span id="l12.100" class="difflineplus">+  nsresult PickCharset();</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineplus">+  void AnalyzeSnarfedFile();  // Analyze a previously-snarfed file.</span>
<a href="#l12.102"></a><span id="l12.102" class="difflineplus">+                              // (Currently only used for plaintext</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineplus">+                              // converted from HTML.)</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineplus">+  nsresult Abort();</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineplus">+  nsresult UrlExit(nsresult status, const char16_t *aMsg);</span>
<a href="#l12.106"></a><span id="l12.106" class="difflineplus">+</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineplus">+  // if there's an intermediate temp file left, takes care to remove it from</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineplus">+  // disk.</span>
<a href="#l12.109"></a><span id="l12.109">   //</span>
<a href="#l12.110"></a><span id="l12.110" class="difflineminus">-  // NOTE: this takes care of the mEncodedWorkingFile temp file, but not mTmpFile which seems</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineminus">-  // to be used by lots of other classes at the moment.</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineminus">-  void                  CleanupTempFile();</span>
<a href="#l12.113"></a><span id="l12.113" class="difflineplus">+  // NOTE: this takes care of the mEncodedWorkingFile temp file, but not</span>
<a href="#l12.114"></a><span id="l12.114" class="difflineplus">+  // mTmpFile which seems to be used by lots of other classes at the moment.</span>
<a href="#l12.115"></a><span id="l12.115" class="difflineplus">+  void CleanupTempFile();</span>
<a href="#l12.116"></a><span id="l12.116"> </span>
<a href="#l12.117"></a><span id="l12.117" class="difflineminus">-private:</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineplus">+ private:</span>
<a href="#l12.119"></a><span id="l12.119">   virtual ~nsMsgAttachmentHandler();</span>
<a href="#l12.120"></a><span id="l12.120"> </span>
<a href="#l12.121"></a><span id="l12.121" class="difflineminus">-  // use when a message (e.g. original message in a reply) is attached as a rfc822 attachment.</span>
<a href="#l12.122"></a><span id="l12.122" class="difflineminus">-  nsresult              SnarfMsgAttachment(nsMsgCompFields *compFields);</span>
<a href="#l12.123"></a><span id="l12.123" class="difflineminus">-  bool                  UseUUEncode_p(void);</span>
<a href="#l12.124"></a><span id="l12.124" class="difflineminus">-  void                  AnalyzeDataChunk (const char *chunk, int32_t chunkSize);</span>
<a href="#l12.125"></a><span id="l12.125" class="difflineminus">-  nsresult              LoadDataFromFile(nsIFile *file, nsString &amp;sigData, bool charsetConversion); //A similar function already exist in nsMsgCompose!</span>
<a href="#l12.126"></a><span id="l12.126" class="difflineplus">+  // use when a message (e.g. original message in a reply) is attached as a</span>
<a href="#l12.127"></a><span id="l12.127" class="difflineplus">+  // rfc822 attachment.</span>
<a href="#l12.128"></a><span id="l12.128" class="difflineplus">+  nsresult SnarfMsgAttachment(nsMsgCompFields *compFields);</span>
<a href="#l12.129"></a><span id="l12.129" class="difflineplus">+  bool UseUUEncode_p(void);</span>
<a href="#l12.130"></a><span id="l12.130" class="difflineplus">+  void AnalyzeDataChunk(const char *chunk, int32_t chunkSize);</span>
<a href="#l12.131"></a><span id="l12.131" class="difflineplus">+  nsresult LoadDataFromFile(</span>
<a href="#l12.132"></a><span id="l12.132" class="difflineplus">+      nsIFile *file, nsString &amp;sigData,</span>
<a href="#l12.133"></a><span id="l12.133" class="difflineplus">+      bool charsetConversion);  // A similar function already exist in</span>
<a href="#l12.134"></a><span id="l12.134" class="difflineplus">+                                // nsMsgCompose!</span>
<a href="#l12.135"></a><span id="l12.135"> #ifdef XP_MACOSX</span>
<a href="#l12.136"></a><span id="l12.136" class="difflineminus">-  nsresult              ConvertToAppleEncoding(const nsCString &amp;aFileSpecURI,</span>
<a href="#l12.137"></a><span id="l12.137" class="difflineminus">-                                               const nsCString &amp;aFilePath,</span>
<a href="#l12.138"></a><span id="l12.138" class="difflineminus">-                                               nsILocalFileMac *aSourceFile);</span>
<a href="#l12.139"></a><span id="l12.139" class="difflineminus">-  // zips this attachment and does the work to make this attachment handler handle it properly.</span>
<a href="#l12.140"></a><span id="l12.140" class="difflineplus">+  nsresult ConvertToAppleEncoding(const nsCString &amp;aFileSpecURI,</span>
<a href="#l12.141"></a><span id="l12.141" class="difflineplus">+                                  const nsCString &amp;aFilePath,</span>
<a href="#l12.142"></a><span id="l12.142" class="difflineplus">+                                  nsILocalFileMac *aSourceFile);</span>
<a href="#l12.143"></a><span id="l12.143" class="difflineplus">+  // zips this attachment and does the work to make this attachment handler</span>
<a href="#l12.144"></a><span id="l12.144" class="difflineplus">+  // handle it properly.</span>
<a href="#l12.145"></a><span id="l12.145">   nsresult ConvertToZipFile(nsILocalFileMac *aSourceFile);</span>
<a href="#l12.146"></a><span id="l12.146">   bool HasResourceFork(FSRef *fsRef);</span>
<a href="#l12.147"></a><span id="l12.147"> #endif</span>
<a href="#l12.148"></a><span id="l12.148"> </span>
<a href="#l12.149"></a><span id="l12.149">   //</span>
<a href="#l12.150"></a><span id="l12.150" class="difflineminus">-public:</span>
<a href="#l12.151"></a><span id="l12.151" class="difflineplus">+ public:</span>
<a href="#l12.152"></a><span id="l12.152">   nsCOMPtr&lt;nsIURI&gt; mURL;</span>
<a href="#l12.153"></a><span id="l12.153" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt;        mTmpFile;         // The temp file to which we save it</span>
<a href="#l12.154"></a><span id="l12.154" class="difflineminus">-  nsCOMPtr&lt;nsIOutputStream&gt;  mOutFile;</span>
<a href="#l12.155"></a><span id="l12.155" class="difflineminus">-  nsCOMPtr&lt;nsIRequest&gt; mRequest; // The live request used while fetching an attachment</span>
<a href="#l12.156"></a><span id="l12.156" class="difflineminus">-  nsMsgCompFields       *mCompFields;       // Message composition fields for the sender</span>
<a href="#l12.157"></a><span id="l12.157" class="difflineminus">-  bool                  m_bogus_attachment; // This is to catch problem children...</span>
<a href="#l12.158"></a><span id="l12.158" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; mTmpFile;  // The temp file to which we save it</span>
<a href="#l12.159"></a><span id="l12.159" class="difflineplus">+  nsCOMPtr&lt;nsIOutputStream&gt; mOutFile;</span>
<a href="#l12.160"></a><span id="l12.160" class="difflineplus">+  nsCOMPtr&lt;nsIRequest&gt;</span>
<a href="#l12.161"></a><span id="l12.161" class="difflineplus">+      mRequest;  // The live request used while fetching an attachment</span>
<a href="#l12.162"></a><span id="l12.162" class="difflineplus">+  nsMsgCompFields *mCompFields;  // Message composition fields for the sender</span>
<a href="#l12.163"></a><span id="l12.163" class="difflineplus">+  bool m_bogus_attachment;       // This is to catch problem children...</span>
<a href="#l12.164"></a><span id="l12.164"> </span>
<a href="#l12.165"></a><span id="l12.165"> #ifdef XP_MACOSX</span>
<a href="#l12.166"></a><span id="l12.166" class="difflineminus">-  // if we need to encode this file into for example an appledouble, or zip file,</span>
<a href="#l12.167"></a><span id="l12.167" class="difflineminus">-  // this file is our working file. currently only needed on mac.</span>
<a href="#l12.168"></a><span id="l12.168" class="difflineplus">+  // if we need to encode this file into for example an appledouble, or zip</span>
<a href="#l12.169"></a><span id="l12.169" class="difflineplus">+  // file, this file is our working file. currently only needed on mac.</span>
<a href="#l12.170"></a><span id="l12.170">   nsCOMPtr&lt;nsIFile&gt; mEncodedWorkingFile;</span>
<a href="#l12.171"></a><span id="l12.171"> #endif</span>
<a href="#l12.172"></a><span id="l12.172"> </span>
<a href="#l12.173"></a><span id="l12.173" class="difflineminus">-  nsCString m_xMacType;      // Mac file type</span>
<a href="#l12.174"></a><span id="l12.174" class="difflineminus">-  nsCString m_xMacCreator;   // Mac file creator</span>
<a href="#l12.175"></a><span id="l12.175" class="difflineplus">+  nsCString m_xMacType;     // Mac file type</span>
<a href="#l12.176"></a><span id="l12.176" class="difflineplus">+  nsCString m_xMacCreator;  // Mac file creator</span>
<a href="#l12.177"></a><span id="l12.177"> </span>
<a href="#l12.178"></a><span id="l12.178">   bool m_done;</span>
<a href="#l12.179"></a><span id="l12.179" class="difflineminus">-  nsCString m_charset;         // charset name</span>
<a href="#l12.180"></a><span id="l12.180" class="difflineminus">-  nsCString m_contentId;      // This is for mutipart/related Content-ID's</span>
<a href="#l12.181"></a><span id="l12.181" class="difflineminus">-  nsCString m_type;            // The real type, once we know it.</span>
<a href="#l12.182"></a><span id="l12.182" class="difflineminus">-  nsCString m_typeParam;      // Any addition parameters to add to the content-type (other than charset, macType and maccreator)</span>
<a href="#l12.183"></a><span id="l12.183" class="difflineminus">-  nsCString m_overrideType;   // The type we should assume it to be</span>
<a href="#l12.184"></a><span id="l12.184" class="difflineminus">-                                            // or 0, if we should get it from the</span>
<a href="#l12.185"></a><span id="l12.185" class="difflineminus">-                                            // server)</span>
<a href="#l12.186"></a><span id="l12.186" class="difflineminus">-  nsCString m_overrideEncoding; // Goes along with override_type</span>
<a href="#l12.187"></a><span id="l12.187" class="difflineplus">+  nsCString m_charset;    // charset name</span>
<a href="#l12.188"></a><span id="l12.188" class="difflineplus">+  nsCString m_contentId;  // This is for mutipart/related Content-ID's</span>
<a href="#l12.189"></a><span id="l12.189" class="difflineplus">+  nsCString m_type;       // The real type, once we know it.</span>
<a href="#l12.190"></a><span id="l12.190" class="difflineplus">+  nsCString m_typeParam;  // Any addition parameters to add to the content-type</span>
<a href="#l12.191"></a><span id="l12.191" class="difflineplus">+                          // (other than charset, macType and maccreator)</span>
<a href="#l12.192"></a><span id="l12.192" class="difflineplus">+  nsCString m_overrideType;      // The type we should assume it to be</span>
<a href="#l12.193"></a><span id="l12.193" class="difflineplus">+                                 // or 0, if we should get it from the</span>
<a href="#l12.194"></a><span id="l12.194" class="difflineplus">+                                 // server)</span>
<a href="#l12.195"></a><span id="l12.195" class="difflineplus">+  nsCString m_overrideEncoding;  // Goes along with override_type</span>
<a href="#l12.196"></a><span id="l12.196"> </span>
<a href="#l12.197"></a><span id="l12.197" class="difflineminus">-  nsCString m_desiredType;    // The type it should be converted to.</span>
<a href="#l12.198"></a><span id="l12.198" class="difflineminus">-  nsCString m_description;     // For Content-Description header</span>
<a href="#l12.199"></a><span id="l12.199" class="difflineminus">-  nsCString m_realName;       // The name for the headers, if different</span>
<a href="#l12.200"></a><span id="l12.200" class="difflineminus">-                                            // from the URL.</span>
<a href="#l12.201"></a><span id="l12.201" class="difflineminus">-  nsCString m_encoding;        // The encoding, once we've decided. */</span>
<a href="#l12.202"></a><span id="l12.202" class="difflineminus">-  bool                  m_already_encoded_p; // If we attach a document that is already</span>
<a href="#l12.203"></a><span id="l12.203" class="difflineminus">-                                             // encoded, we just pass it through.</span>
<a href="#l12.204"></a><span id="l12.204" class="difflineplus">+  nsCString m_desiredType;   // The type it should be converted to.</span>
<a href="#l12.205"></a><span id="l12.205" class="difflineplus">+  nsCString m_description;   // For Content-Description header</span>
<a href="#l12.206"></a><span id="l12.206" class="difflineplus">+  nsCString m_realName;      // The name for the headers, if different</span>
<a href="#l12.207"></a><span id="l12.207" class="difflineplus">+                             // from the URL.</span>
<a href="#l12.208"></a><span id="l12.208" class="difflineplus">+  nsCString m_encoding;      // The encoding, once we've decided. */</span>
<a href="#l12.209"></a><span id="l12.209" class="difflineplus">+  bool m_already_encoded_p;  // If we attach a document that is already</span>
<a href="#l12.210"></a><span id="l12.210" class="difflineplus">+                             // encoded, we just pass it through.</span>
<a href="#l12.211"></a><span id="l12.211"> </span>
<a href="#l12.212"></a><span id="l12.212" class="difflineminus">-  bool                  m_decrypted_p;  /* S/MIME -- when attaching a message that was</span>
<a href="#l12.213"></a><span id="l12.213" class="difflineminus">-                                           encrypted, it's necessary to decrypt it first</span>
<a href="#l12.214"></a><span id="l12.214" class="difflineminus">-                                           (since nobody but the original recipient can</span>
<a href="#l12.215"></a><span id="l12.215" class="difflineminus">-                                           read it -- if you forward it to someone in the</span>
<a href="#l12.216"></a><span id="l12.216" class="difflineminus">-                                           raw, it will be useless to them.)  This flag</span>
<a href="#l12.217"></a><span id="l12.217" class="difflineminus">-                                           indicates whether decryption occurred, so that</span>
<a href="#l12.218"></a><span id="l12.218" class="difflineminus">-                                           libmsg can issue appropriate warnings about</span>
<a href="#l12.219"></a><span id="l12.219" class="difflineminus">-                                           doing a cleartext forward of a message that was</span>
<a href="#l12.220"></a><span id="l12.220" class="difflineminus">-                                           originally encrypted. */</span>
<a href="#l12.221"></a><span id="l12.221" class="difflineplus">+  bool m_decrypted_p; /* S/MIME -- when attaching a message that was</span>
<a href="#l12.222"></a><span id="l12.222" class="difflineplus">+                         encrypted, it's necessary to decrypt it first</span>
<a href="#l12.223"></a><span id="l12.223" class="difflineplus">+                         (since nobody but the original recipient can</span>
<a href="#l12.224"></a><span id="l12.224" class="difflineplus">+                         read it -- if you forward it to someone in the</span>
<a href="#l12.225"></a><span id="l12.225" class="difflineplus">+                         raw, it will be useless to them.)  This flag</span>
<a href="#l12.226"></a><span id="l12.226" class="difflineplus">+                         indicates whether decryption occurred, so that</span>
<a href="#l12.227"></a><span id="l12.227" class="difflineplus">+                         libmsg can issue appropriate warnings about</span>
<a href="#l12.228"></a><span id="l12.228" class="difflineplus">+                         doing a cleartext forward of a message that was</span>
<a href="#l12.229"></a><span id="l12.229" class="difflineplus">+                         originally encrypted. */</span>
<a href="#l12.230"></a><span id="l12.230" class="difflineplus">+</span>
<a href="#l12.231"></a><span id="l12.231" class="difflineplus">+  bool mDeleteFile;  // If this is true, Delete the file...its</span>
<a href="#l12.232"></a><span id="l12.232" class="difflineplus">+                     // NOT the original file!</span>
<a href="#l12.233"></a><span id="l12.233"> </span>
<a href="#l12.234"></a><span id="l12.234" class="difflineminus">-  bool                  mDeleteFile;      // If this is true, Delete the file...its</span>
<a href="#l12.235"></a><span id="l12.235" class="difflineminus">-                                          // NOT the original file!</span>
<a href="#l12.236"></a><span id="l12.236" class="difflineminus">-</span>
<a href="#l12.237"></a><span id="l12.237" class="difflineminus">-  bool                  mMHTMLPart;           // This is true if its an MHTML part, otherwise, false</span>
<a href="#l12.238"></a><span id="l12.238" class="difflineminus">-  bool                  mPartUserOmissionOverride;  // This is true if the user send send the email without this part</span>
<a href="#l12.239"></a><span id="l12.239" class="difflineminus">-  bool                  mMainBody;            // True if this is a main body.</span>
<a href="#l12.240"></a><span id="l12.240" class="difflineminus">-   // true if this should be sent as a link to a file.</span>
<a href="#l12.241"></a><span id="l12.241" class="difflineminus">-  bool                  mSendViaCloud;</span>
<a href="#l12.242"></a><span id="l12.242" class="difflineminus">-  nsString              mHtmlAnnotation;</span>
<a href="#l12.243"></a><span id="l12.243" class="difflineminus">-  nsCString             mCloudFileAccountKey;</span>
<a href="#l12.244"></a><span id="l12.244" class="difflineminus">-  nsCString             mCloudUrl;</span>
<a href="#l12.245"></a><span id="l12.245" class="difflineminus">-  int32_t mNodeIndex; //If this is an embedded image, this is the index of the</span>
<a href="#l12.246"></a><span id="l12.246" class="difflineminus">-                      // corresponding domNode in the editor's</span>
<a href="#l12.247"></a><span id="l12.247" class="difflineminus">-                      //GetEmbeddedObjects. Otherwise, it will be -1.</span>
<a href="#l12.248"></a><span id="l12.248" class="difflineplus">+  bool mMHTMLPart;  // This is true if its an MHTML part, otherwise, false</span>
<a href="#l12.249"></a><span id="l12.249" class="difflineplus">+  bool mPartUserOmissionOverride;  // This is true if the user send send the</span>
<a href="#l12.250"></a><span id="l12.250" class="difflineplus">+                                   // email without this part</span>
<a href="#l12.251"></a><span id="l12.251" class="difflineplus">+  bool mMainBody;                  // True if this is a main body.</span>
<a href="#l12.252"></a><span id="l12.252" class="difflineplus">+                   // true if this should be sent as a link to a file.</span>
<a href="#l12.253"></a><span id="l12.253" class="difflineplus">+  bool mSendViaCloud;</span>
<a href="#l12.254"></a><span id="l12.254" class="difflineplus">+  nsString mHtmlAnnotation;</span>
<a href="#l12.255"></a><span id="l12.255" class="difflineplus">+  nsCString mCloudFileAccountKey;</span>
<a href="#l12.256"></a><span id="l12.256" class="difflineplus">+  nsCString mCloudUrl;</span>
<a href="#l12.257"></a><span id="l12.257" class="difflineplus">+  int32_t mNodeIndex;  // If this is an embedded image, this is the index of the</span>
<a href="#l12.258"></a><span id="l12.258" class="difflineplus">+                       // corresponding domNode in the editor's</span>
<a href="#l12.259"></a><span id="l12.259" class="difflineplus">+                       // GetEmbeddedObjects. Otherwise, it will be -1.</span>
<a href="#l12.260"></a><span id="l12.260">   //</span>
<a href="#l12.261"></a><span id="l12.261">   // Vars for analyzing file data...</span>
<a href="#l12.262"></a><span id="l12.262">   //</span>
<a href="#l12.263"></a><span id="l12.263" class="difflineminus">-  uint32_t              m_size;         /* Some state used while filtering it */</span>
<a href="#l12.264"></a><span id="l12.264" class="difflineminus">-  uint32_t              m_unprintable_count;</span>
<a href="#l12.265"></a><span id="l12.265" class="difflineminus">-  uint32_t              m_highbit_count;</span>
<a href="#l12.266"></a><span id="l12.266" class="difflineminus">-  uint32_t              m_ctl_count;</span>
<a href="#l12.267"></a><span id="l12.267" class="difflineminus">-  uint32_t              m_null_count;</span>
<a href="#l12.268"></a><span id="l12.268" class="difflineminus">-  uint8_t               m_have_cr, m_have_lf, m_have_crlf;</span>
<a href="#l12.269"></a><span id="l12.269" class="difflineminus">-  bool                  m_prev_char_was_cr;</span>
<a href="#l12.270"></a><span id="l12.270" class="difflineminus">-  uint32_t              m_current_column;</span>
<a href="#l12.271"></a><span id="l12.271" class="difflineminus">-  uint32_t              m_max_column;</span>
<a href="#l12.272"></a><span id="l12.272" class="difflineminus">-  uint32_t              m_lines;</span>
<a href="#l12.273"></a><span id="l12.273" class="difflineminus">-  bool                  m_file_analyzed;</span>
<a href="#l12.274"></a><span id="l12.274" class="difflineplus">+  uint32_t m_size; /* Some state used while filtering it */</span>
<a href="#l12.275"></a><span id="l12.275" class="difflineplus">+  uint32_t m_unprintable_count;</span>
<a href="#l12.276"></a><span id="l12.276" class="difflineplus">+  uint32_t m_highbit_count;</span>
<a href="#l12.277"></a><span id="l12.277" class="difflineplus">+  uint32_t m_ctl_count;</span>
<a href="#l12.278"></a><span id="l12.278" class="difflineplus">+  uint32_t m_null_count;</span>
<a href="#l12.279"></a><span id="l12.279" class="difflineplus">+  uint8_t m_have_cr, m_have_lf, m_have_crlf;</span>
<a href="#l12.280"></a><span id="l12.280" class="difflineplus">+  bool m_prev_char_was_cr;</span>
<a href="#l12.281"></a><span id="l12.281" class="difflineplus">+  uint32_t m_current_column;</span>
<a href="#l12.282"></a><span id="l12.282" class="difflineplus">+  uint32_t m_max_column;</span>
<a href="#l12.283"></a><span id="l12.283" class="difflineplus">+  uint32_t m_lines;</span>
<a href="#l12.284"></a><span id="l12.284" class="difflineplus">+  bool m_file_analyzed;</span>
<a href="#l12.285"></a><span id="l12.285"> </span>
<a href="#l12.286"></a><span id="l12.286">   nsAutoPtr&lt;MimeEncoder&gt; m_encoder;</span>
<a href="#l12.287"></a><span id="l12.287" class="difflineminus">-  nsCString             m_uri; // original uri string</span>
<a href="#l12.288"></a><span id="l12.288" class="difflineplus">+  nsCString m_uri;  // original uri string</span>
<a href="#l12.289"></a><span id="l12.289" class="difflineplus">+</span>
<a href="#l12.290"></a><span id="l12.290" class="difflineplus">+  nsresult GetMimeDeliveryState(nsIMsgSend **_retval);</span>
<a href="#l12.291"></a><span id="l12.291" class="difflineplus">+  nsresult SetMimeDeliveryState(nsIMsgSend *mime_delivery_state);</span>
<a href="#l12.292"></a><span id="l12.292"> </span>
<a href="#l12.293"></a><span id="l12.293" class="difflineminus">-  nsresult              GetMimeDeliveryState(nsIMsgSend** _retval);</span>
<a href="#l12.294"></a><span id="l12.294" class="difflineminus">-  nsresult              SetMimeDeliveryState(nsIMsgSend* mime_delivery_state);</span>
<a href="#l12.295"></a><span id="l12.295" class="difflineminus">-private:</span>
<a href="#l12.296"></a><span id="l12.296" class="difflineminus">-  nsCOMPtr&lt;nsIMsgSend&gt;  m_mime_delivery_state;</span>
<a href="#l12.297"></a><span id="l12.297" class="difflineplus">+ private:</span>
<a href="#l12.298"></a><span id="l12.298" class="difflineplus">+  nsCOMPtr&lt;nsIMsgSend&gt; m_mime_delivery_state;</span>
<a href="#l12.299"></a><span id="l12.299">   nsCOMPtr&lt;nsIStreamConverter&gt; m_mime_parser;</span>
<a href="#l12.300"></a><span id="l12.300" class="difflineminus">-  nsCOMPtr&lt;nsIChannel&gt;  m_converter_channel;</span>
<a href="#l12.301"></a><span id="l12.301" class="difflineplus">+  nsCOMPtr&lt;nsIChannel&gt; m_converter_channel;</span>
<a href="#l12.302"></a><span id="l12.302"> };</span>
<a href="#l12.303"></a><span id="l12.303"> </span>
<a href="#l12.304"></a><span id="l12.304" class="difflineminus">-</span>
<a href="#l12.305"></a><span id="l12.305"> #endif /* _nsMsgAttachmentHandler_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompFields.cpp</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompFields.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -27,677 +27,585 @@ struct HeaderInfo {</span>
<a href="#l13.4"></a><span id="l13.4">   /// If true, nsMsgCompFields should reflect the raw header value instead of</span>
<a href="#l13.5"></a><span id="l13.5">   /// the unstructured header value.</span>
<a href="#l13.6"></a><span id="l13.6">   bool mStructured;</span>
<a href="#l13.7"></a><span id="l13.7"> };</span>
<a href="#l13.8"></a><span id="l13.8"> </span>
<a href="#l13.9"></a><span id="l13.9"> // This is a mapping of the m_headers local set to the actual header name we</span>
<a href="#l13.10"></a><span id="l13.10"> // store on the structured header object.</span>
<a href="#l13.11"></a><span id="l13.11"> static HeaderInfo kHeaders[] = {</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-  { &quot;From&quot;, true },</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-  { &quot;Reply-To&quot;, true },</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-  { &quot;To&quot;, true },</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineminus">-  { &quot;Cc&quot;, true },</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineminus">-  { &quot;Bcc&quot;, true },</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineminus">-  { nullptr, false }, // FCC</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineminus">-  { nullptr, false }, // FCC2</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineminus">-  { &quot;Newsgroups&quot;, true },</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineminus">-  { &quot;Followup-To&quot;, true },</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineminus">-  { &quot;Subject&quot;, false },</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineminus">-  { &quot;Organization&quot;, false },</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineminus">-  { &quot;References&quot;, true },</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineminus">-  { &quot;X-Mozilla-News-Host&quot;, false },</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineminus">-  { &quot;X-Priority&quot;, false },</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineminus">-  { nullptr, false }, // CHARACTER_SET</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineminus">-  { &quot;Message-Id&quot;, true },</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineminus">-  { &quot;X-Template&quot;, true },</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineminus">-  { nullptr, false }, // DRAFT_ID</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineminus">-  { nullptr, false }, // TEMPLATE_ID</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-  { &quot;Content-Language&quot;, true },</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineminus">-  { nullptr, false } // CREATOR IDENTITY KEY</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+    {&quot;From&quot;, true},</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+    {&quot;Reply-To&quot;, true},</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+    {&quot;To&quot;, true},</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+    {&quot;Cc&quot;, true},</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+    {&quot;Bcc&quot;, true},</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+    {nullptr, false},  // FCC</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+    {nullptr, false},  // FCC2</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineplus">+    {&quot;Newsgroups&quot;, true},</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineplus">+    {&quot;Followup-To&quot;, true},</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineplus">+    {&quot;Subject&quot;, false},</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+    {&quot;Organization&quot;, false},</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineplus">+    {&quot;References&quot;, true},</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineplus">+    {&quot;X-Mozilla-News-Host&quot;, false},</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineplus">+    {&quot;X-Priority&quot;, false},</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+    {nullptr, false},  // CHARACTER_SET</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+    {&quot;Message-Id&quot;, true},</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+    {&quot;X-Template&quot;, true},</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+    {nullptr, false},  // DRAFT_ID</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+    {nullptr, false},  // TEMPLATE_ID</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineplus">+    {&quot;Content-Language&quot;, true},</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+    {nullptr, false}  // CREATOR IDENTITY KEY</span>
<a href="#l13.54"></a><span id="l13.54"> };</span>
<a href="#l13.55"></a><span id="l13.55"> </span>
<a href="#l13.56"></a><span id="l13.56" class="difflineminus">-static_assert(MOZ_ARRAY_LENGTH(kHeaders) ==</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineminus">-    nsMsgCompFields::MSG_MAX_HEADERS,</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineminus">-  &quot;These two arrays need to be kept in sync or bad things will happen!&quot;);</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineplus">+static_assert(</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineplus">+    MOZ_ARRAY_LENGTH(kHeaders) == nsMsgCompFields::MSG_MAX_HEADERS,</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineplus">+    &quot;These two arrays need to be kept in sync or bad things will happen!&quot;);</span>
<a href="#l13.62"></a><span id="l13.62"> </span>
<a href="#l13.63"></a><span id="l13.63"> NS_IMPL_ISUPPORTS(nsMsgCompFields, nsIMsgCompFields, msgIStructuredHeaders,</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineminus">-  msgIWritableStructuredHeaders)</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineplus">+                  msgIWritableStructuredHeaders)</span>
<a href="#l13.66"></a><span id="l13.66"> </span>
<a href="#l13.67"></a><span id="l13.67"> nsMsgCompFields::nsMsgCompFields()</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineminus">-: mStructuredHeaders(do_CreateInstance(NS_ISTRUCTUREDHEADERS_CONTRACTID))</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineminus">-{</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineplus">+    : mStructuredHeaders(do_CreateInstance(NS_ISTRUCTUREDHEADERS_CONTRACTID)) {</span>
<a href="#l13.71"></a><span id="l13.71">   m_body.Truncate();</span>
<a href="#l13.72"></a><span id="l13.72"> </span>
<a href="#l13.73"></a><span id="l13.73">   m_attachVCard = false;</span>
<a href="#l13.74"></a><span id="l13.74">   m_forcePlainText = false;</span>
<a href="#l13.75"></a><span id="l13.75">   m_useMultipartAlternative = false;</span>
<a href="#l13.76"></a><span id="l13.76">   m_returnReceipt = false;</span>
<a href="#l13.77"></a><span id="l13.77">   m_receiptHeaderType = nsIMsgMdnGenerator::eDntType;</span>
<a href="#l13.78"></a><span id="l13.78">   m_DSN = false;</span>
<a href="#l13.79"></a><span id="l13.79">   m_bodyIsAsciiOnly = false;</span>
<a href="#l13.80"></a><span id="l13.80">   m_forceMsgEncoding = false;</span>
<a href="#l13.81"></a><span id="l13.81">   m_needToCheckCharset = true;</span>
<a href="#l13.82"></a><span id="l13.82">   m_attachmentReminder = false;</span>
<a href="#l13.83"></a><span id="l13.83">   m_deliveryFormat = nsIMsgCompSendFormat::AskUser;</span>
<a href="#l13.84"></a><span id="l13.84"> </span>
<a href="#l13.85"></a><span id="l13.85">   // Get the default charset from pref, use this as a mail charset.</span>
<a href="#l13.86"></a><span id="l13.86">   nsString charset;</span>
<a href="#l13.87"></a><span id="l13.87" class="difflineminus">-  NS_GetLocalizedUnicharPreferenceWithDefault(nullptr, &quot;mailnews.send_default_charset&quot;,</span>
<a href="#l13.88"></a><span id="l13.88" class="difflineminus">-                                              NS_LITERAL_STRING(&quot;UTF-8&quot;), charset);</span>
<a href="#l13.89"></a><span id="l13.89" class="difflineplus">+  NS_GetLocalizedUnicharPreferenceWithDefault(</span>
<a href="#l13.90"></a><span id="l13.90" class="difflineplus">+      nullptr, &quot;mailnews.send_default_charset&quot;, NS_LITERAL_STRING(&quot;UTF-8&quot;),</span>
<a href="#l13.91"></a><span id="l13.91" class="difflineplus">+      charset);</span>
<a href="#l13.92"></a><span id="l13.92"> </span>
<a href="#l13.93"></a><span id="l13.93" class="difflineminus">-  LossyCopyUTF16toASCII(charset, m_DefaultCharacterSet); // Charsets better be ASCII</span>
<a href="#l13.94"></a><span id="l13.94" class="difflineplus">+  LossyCopyUTF16toASCII(charset,</span>
<a href="#l13.95"></a><span id="l13.95" class="difflineplus">+                        m_DefaultCharacterSet);  // Charsets better be ASCII</span>
<a href="#l13.96"></a><span id="l13.96">   SetCharacterSet(m_DefaultCharacterSet.get());</span>
<a href="#l13.97"></a><span id="l13.97"> }</span>
<a href="#l13.98"></a><span id="l13.98"> </span>
<a href="#l13.99"></a><span id="l13.99" class="difflineminus">-nsMsgCompFields::~nsMsgCompFields()</span>
<a href="#l13.100"></a><span id="l13.100" class="difflineminus">-{</span>
<a href="#l13.101"></a><span id="l13.101" class="difflineminus">-}</span>
<a href="#l13.102"></a><span id="l13.102" class="difflineplus">+nsMsgCompFields::~nsMsgCompFields() {}</span>
<a href="#l13.103"></a><span id="l13.103"> </span>
<a href="#l13.104"></a><span id="l13.104" class="difflineminus">-nsresult nsMsgCompFields::SetAsciiHeader(MsgHeaderID header, const char *value)</span>
<a href="#l13.105"></a><span id="l13.105" class="difflineminus">-{</span>
<a href="#l13.106"></a><span id="l13.106" class="difflineplus">+nsresult nsMsgCompFields::SetAsciiHeader(MsgHeaderID header,</span>
<a href="#l13.107"></a><span id="l13.107" class="difflineplus">+                                         const char *value) {</span>
<a href="#l13.108"></a><span id="l13.108">   NS_ASSERTION(header &gt;= 0 &amp;&amp; header &lt; MSG_MAX_HEADERS,</span>
<a href="#l13.109"></a><span id="l13.109">                &quot;Invalid message header index!&quot;);</span>
<a href="#l13.110"></a><span id="l13.110"> </span>
<a href="#l13.111"></a><span id="l13.111">   // If we are storing this on the structured header object, we need to set the</span>
<a href="#l13.112"></a><span id="l13.112">   // value on that object as well. Note that the value may be null, which we'll</span>
<a href="#l13.113"></a><span id="l13.113">   // take as an attempt to delete the header.</span>
<a href="#l13.114"></a><span id="l13.114">   const char *headerName = kHeaders[header].mName;</span>
<a href="#l13.115"></a><span id="l13.115" class="difflineminus">-  if (headerName)</span>
<a href="#l13.116"></a><span id="l13.116" class="difflineminus">-  {</span>
<a href="#l13.117"></a><span id="l13.117" class="difflineminus">-    if (!value || !*value)</span>
<a href="#l13.118"></a><span id="l13.118" class="difflineminus">-      return mStructuredHeaders-&gt;DeleteHeader(headerName);</span>
<a href="#l13.119"></a><span id="l13.119" class="difflineplus">+  if (headerName) {</span>
<a href="#l13.120"></a><span id="l13.120" class="difflineplus">+    if (!value || !*value) return mStructuredHeaders-&gt;DeleteHeader(headerName);</span>
<a href="#l13.121"></a><span id="l13.121"> </span>
<a href="#l13.122"></a><span id="l13.122">     return mStructuredHeaders-&gt;SetRawHeader(headerName,</span>
<a href="#l13.123"></a><span id="l13.123" class="difflineminus">-      nsDependentCString(value), &quot;UTF-8&quot;);</span>
<a href="#l13.124"></a><span id="l13.124" class="difflineplus">+                                            nsDependentCString(value), &quot;UTF-8&quot;);</span>
<a href="#l13.125"></a><span id="l13.125">   }</span>
<a href="#l13.126"></a><span id="l13.126"> </span>
<a href="#l13.127"></a><span id="l13.127">   // Not on the structurd header object, so save it locally.</span>
<a href="#l13.128"></a><span id="l13.128">   m_headers[header] = value;</span>
<a href="#l13.129"></a><span id="l13.129"> </span>
<a href="#l13.130"></a><span id="l13.130">   return NS_OK;</span>
<a href="#l13.131"></a><span id="l13.131"> }</span>
<a href="#l13.132"></a><span id="l13.132"> </span>
<a href="#l13.133"></a><span id="l13.133" class="difflineminus">-const char* nsMsgCompFields::GetAsciiHeader(MsgHeaderID header)</span>
<a href="#l13.134"></a><span id="l13.134" class="difflineminus">-{</span>
<a href="#l13.135"></a><span id="l13.135" class="difflineplus">+const char *nsMsgCompFields::GetAsciiHeader(MsgHeaderID header) {</span>
<a href="#l13.136"></a><span id="l13.136">   NS_ASSERTION(header &gt;= 0 &amp;&amp; header &lt; MSG_MAX_HEADERS,</span>
<a href="#l13.137"></a><span id="l13.137">                &quot;Invalid message header index!&quot;);</span>
<a href="#l13.138"></a><span id="l13.138"> </span>
<a href="#l13.139"></a><span id="l13.139">   const char *headerName = kHeaders[header].mName;</span>
<a href="#l13.140"></a><span id="l13.140" class="difflineminus">-  if (headerName)</span>
<a href="#l13.141"></a><span id="l13.141" class="difflineminus">-  {</span>
<a href="#l13.142"></a><span id="l13.142" class="difflineplus">+  if (headerName) {</span>
<a href="#l13.143"></a><span id="l13.143">     // We may be out of sync with the structured header object. Retrieve the</span>
<a href="#l13.144"></a><span id="l13.144">     // header value.</span>
<a href="#l13.145"></a><span id="l13.145" class="difflineminus">-    if (kHeaders[header].mStructured)</span>
<a href="#l13.146"></a><span id="l13.146" class="difflineminus">-    {</span>
<a href="#l13.147"></a><span id="l13.147" class="difflineplus">+    if (kHeaders[header].mStructured) {</span>
<a href="#l13.148"></a><span id="l13.148">       mStructuredHeaders-&gt;GetRawHeader(headerName, m_headers[header]);</span>
<a href="#l13.149"></a><span id="l13.149" class="difflineminus">-    }</span>
<a href="#l13.150"></a><span id="l13.150" class="difflineminus">-    else</span>
<a href="#l13.151"></a><span id="l13.151" class="difflineminus">-    {</span>
<a href="#l13.152"></a><span id="l13.152" class="difflineplus">+    } else {</span>
<a href="#l13.153"></a><span id="l13.153">       nsString value;</span>
<a href="#l13.154"></a><span id="l13.154">       mStructuredHeaders-&gt;GetUnstructuredHeader(headerName, value);</span>
<a href="#l13.155"></a><span id="l13.155">       CopyUTF16toUTF8(value, m_headers[header]);</span>
<a href="#l13.156"></a><span id="l13.156">     }</span>
<a href="#l13.157"></a><span id="l13.157">   }</span>
<a href="#l13.158"></a><span id="l13.158"> </span>
<a href="#l13.159"></a><span id="l13.159">   return m_headers[header].get();</span>
<a href="#l13.160"></a><span id="l13.160"> }</span>
<a href="#l13.161"></a><span id="l13.161"> </span>
<a href="#l13.162"></a><span id="l13.162" class="difflineminus">-nsresult nsMsgCompFields::SetUnicodeHeader(MsgHeaderID header, const nsAString&amp; value)</span>
<a href="#l13.163"></a><span id="l13.163" class="difflineminus">-{</span>
<a href="#l13.164"></a><span id="l13.164" class="difflineplus">+nsresult nsMsgCompFields::SetUnicodeHeader(MsgHeaderID header,</span>
<a href="#l13.165"></a><span id="l13.165" class="difflineplus">+                                           const nsAString &amp;value) {</span>
<a href="#l13.166"></a><span id="l13.166">   return SetAsciiHeader(header, NS_ConvertUTF16toUTF8(value).get());</span>
<a href="#l13.167"></a><span id="l13.167"> }</span>
<a href="#l13.168"></a><span id="l13.168"> </span>
<a href="#l13.169"></a><span id="l13.169" class="difflineminus">-nsresult nsMsgCompFields::GetUnicodeHeader(MsgHeaderID header, nsAString&amp; aResult)</span>
<a href="#l13.170"></a><span id="l13.170" class="difflineminus">-{</span>
<a href="#l13.171"></a><span id="l13.171" class="difflineplus">+nsresult nsMsgCompFields::GetUnicodeHeader(MsgHeaderID header,</span>
<a href="#l13.172"></a><span id="l13.172" class="difflineplus">+                                           nsAString &amp;aResult) {</span>
<a href="#l13.173"></a><span id="l13.173">   CopyUTF8toUTF16(nsDependentCString(GetAsciiHeader(header)), aResult);</span>
<a href="#l13.174"></a><span id="l13.174">   return NS_OK;</span>
<a href="#l13.175"></a><span id="l13.175"> }</span>
<a href="#l13.176"></a><span id="l13.176"> </span>
<a href="#l13.177"></a><span id="l13.177" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::SetFrom(const nsAString &amp;value)</span>
<a href="#l13.178"></a><span id="l13.178" class="difflineminus">-{</span>
<a href="#l13.179"></a><span id="l13.179" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::SetFrom(const nsAString &amp;value) {</span>
<a href="#l13.180"></a><span id="l13.180">   return SetUnicodeHeader(MSG_FROM_HEADER_ID, value);</span>
<a href="#l13.181"></a><span id="l13.181"> }</span>
<a href="#l13.182"></a><span id="l13.182"> </span>
<a href="#l13.183"></a><span id="l13.183" class="difflineminus">-</span>
<a href="#l13.184"></a><span id="l13.184" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::GetFrom(nsAString &amp;_retval)</span>
<a href="#l13.185"></a><span id="l13.185" class="difflineminus">-{</span>
<a href="#l13.186"></a><span id="l13.186" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::GetFrom(nsAString &amp;_retval) {</span>
<a href="#l13.187"></a><span id="l13.187">   return GetUnicodeHeader(MSG_FROM_HEADER_ID, _retval);</span>
<a href="#l13.188"></a><span id="l13.188"> }</span>
<a href="#l13.189"></a><span id="l13.189"> </span>
<a href="#l13.190"></a><span id="l13.190" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::SetReplyTo(const nsAString &amp;value)</span>
<a href="#l13.191"></a><span id="l13.191" class="difflineminus">-{</span>
<a href="#l13.192"></a><span id="l13.192" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::SetReplyTo(const nsAString &amp;value) {</span>
<a href="#l13.193"></a><span id="l13.193">   return SetUnicodeHeader(MSG_REPLY_TO_HEADER_ID, value);</span>
<a href="#l13.194"></a><span id="l13.194"> }</span>
<a href="#l13.195"></a><span id="l13.195"> </span>
<a href="#l13.196"></a><span id="l13.196" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::GetReplyTo(nsAString &amp;_retval)</span>
<a href="#l13.197"></a><span id="l13.197" class="difflineminus">-{</span>
<a href="#l13.198"></a><span id="l13.198" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::GetReplyTo(nsAString &amp;_retval) {</span>
<a href="#l13.199"></a><span id="l13.199">   return GetUnicodeHeader(MSG_REPLY_TO_HEADER_ID, _retval);</span>
<a href="#l13.200"></a><span id="l13.200"> }</span>
<a href="#l13.201"></a><span id="l13.201"> </span>
<a href="#l13.202"></a><span id="l13.202" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::SetTo(const nsAString &amp;value)</span>
<a href="#l13.203"></a><span id="l13.203" class="difflineminus">-{</span>
<a href="#l13.204"></a><span id="l13.204" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::SetTo(const nsAString &amp;value) {</span>
<a href="#l13.205"></a><span id="l13.205">   return SetUnicodeHeader(MSG_TO_HEADER_ID, value);</span>
<a href="#l13.206"></a><span id="l13.206"> }</span>
<a href="#l13.207"></a><span id="l13.207"> </span>
<a href="#l13.208"></a><span id="l13.208" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::GetTo(nsAString &amp;_retval)</span>
<a href="#l13.209"></a><span id="l13.209" class="difflineminus">-{</span>
<a href="#l13.210"></a><span id="l13.210" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::GetTo(nsAString &amp;_retval) {</span>
<a href="#l13.211"></a><span id="l13.211">   return GetUnicodeHeader(MSG_TO_HEADER_ID, _retval);</span>
<a href="#l13.212"></a><span id="l13.212"> }</span>
<a href="#l13.213"></a><span id="l13.213"> </span>
<a href="#l13.214"></a><span id="l13.214" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::SetCc(const nsAString &amp;value)</span>
<a href="#l13.215"></a><span id="l13.215" class="difflineminus">-{</span>
<a href="#l13.216"></a><span id="l13.216" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::SetCc(const nsAString &amp;value) {</span>
<a href="#l13.217"></a><span id="l13.217">   return SetUnicodeHeader(MSG_CC_HEADER_ID, value);</span>
<a href="#l13.218"></a><span id="l13.218"> }</span>
<a href="#l13.219"></a><span id="l13.219"> </span>
<a href="#l13.220"></a><span id="l13.220" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::GetCc(nsAString &amp;_retval)</span>
<a href="#l13.221"></a><span id="l13.221" class="difflineminus">-{</span>
<a href="#l13.222"></a><span id="l13.222" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::GetCc(nsAString &amp;_retval) {</span>
<a href="#l13.223"></a><span id="l13.223">   return GetUnicodeHeader(MSG_CC_HEADER_ID, _retval);</span>
<a href="#l13.224"></a><span id="l13.224"> }</span>
<a href="#l13.225"></a><span id="l13.225"> </span>
<a href="#l13.226"></a><span id="l13.226" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::SetBcc(const nsAString &amp;value)</span>
<a href="#l13.227"></a><span id="l13.227" class="difflineminus">-{</span>
<a href="#l13.228"></a><span id="l13.228" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::SetBcc(const nsAString &amp;value) {</span>
<a href="#l13.229"></a><span id="l13.229">   return SetUnicodeHeader(MSG_BCC_HEADER_ID, value);</span>
<a href="#l13.230"></a><span id="l13.230"> }</span>
<a href="#l13.231"></a><span id="l13.231"> </span>
<a href="#l13.232"></a><span id="l13.232" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::GetBcc(nsAString &amp;_retval)</span>
<a href="#l13.233"></a><span id="l13.233" class="difflineminus">-{</span>
<a href="#l13.234"></a><span id="l13.234" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::GetBcc(nsAString &amp;_retval) {</span>
<a href="#l13.235"></a><span id="l13.235">   return GetUnicodeHeader(MSG_BCC_HEADER_ID, _retval);</span>
<a href="#l13.236"></a><span id="l13.236"> }</span>
<a href="#l13.237"></a><span id="l13.237"> </span>
<a href="#l13.238"></a><span id="l13.238" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::SetFcc(const nsAString &amp;value)</span>
<a href="#l13.239"></a><span id="l13.239" class="difflineminus">-{</span>
<a href="#l13.240"></a><span id="l13.240" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::SetFcc(const nsAString &amp;value) {</span>
<a href="#l13.241"></a><span id="l13.241">   return SetUnicodeHeader(MSG_FCC_HEADER_ID, value);</span>
<a href="#l13.242"></a><span id="l13.242"> }</span>
<a href="#l13.243"></a><span id="l13.243"> </span>
<a href="#l13.244"></a><span id="l13.244" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::GetFcc(nsAString &amp;_retval)</span>
<a href="#l13.245"></a><span id="l13.245" class="difflineminus">-{</span>
<a href="#l13.246"></a><span id="l13.246" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::GetFcc(nsAString &amp;_retval) {</span>
<a href="#l13.247"></a><span id="l13.247">   return GetUnicodeHeader(MSG_FCC_HEADER_ID, _retval);</span>
<a href="#l13.248"></a><span id="l13.248"> }</span>
<a href="#l13.249"></a><span id="l13.249"> </span>
<a href="#l13.250"></a><span id="l13.250" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::SetFcc2(const nsAString &amp;value)</span>
<a href="#l13.251"></a><span id="l13.251" class="difflineminus">-{</span>
<a href="#l13.252"></a><span id="l13.252" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::SetFcc2(const nsAString &amp;value) {</span>
<a href="#l13.253"></a><span id="l13.253">   return SetUnicodeHeader(MSG_FCC2_HEADER_ID, value);</span>
<a href="#l13.254"></a><span id="l13.254"> }</span>
<a href="#l13.255"></a><span id="l13.255"> </span>
<a href="#l13.256"></a><span id="l13.256" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::GetFcc2(nsAString &amp;_retval)</span>
<a href="#l13.257"></a><span id="l13.257" class="difflineminus">-{</span>
<a href="#l13.258"></a><span id="l13.258" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::GetFcc2(nsAString &amp;_retval) {</span>
<a href="#l13.259"></a><span id="l13.259">   return GetUnicodeHeader(MSG_FCC2_HEADER_ID, _retval);</span>
<a href="#l13.260"></a><span id="l13.260"> }</span>
<a href="#l13.261"></a><span id="l13.261"> </span>
<a href="#l13.262"></a><span id="l13.262" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::SetNewsgroups(const nsAString &amp;aValue)</span>
<a href="#l13.263"></a><span id="l13.263" class="difflineminus">-{</span>
<a href="#l13.264"></a><span id="l13.264" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::SetNewsgroups(const nsAString &amp;aValue) {</span>
<a href="#l13.265"></a><span id="l13.265">   return SetUnicodeHeader(MSG_NEWSGROUPS_HEADER_ID, aValue);</span>
<a href="#l13.266"></a><span id="l13.266"> }</span>
<a href="#l13.267"></a><span id="l13.267"> </span>
<a href="#l13.268"></a><span id="l13.268" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::GetNewsgroups(nsAString &amp;aGroup)</span>
<a href="#l13.269"></a><span id="l13.269" class="difflineminus">-{</span>
<a href="#l13.270"></a><span id="l13.270" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::GetNewsgroups(nsAString &amp;aGroup) {</span>
<a href="#l13.271"></a><span id="l13.271">   return GetUnicodeHeader(MSG_NEWSGROUPS_HEADER_ID, aGroup);</span>
<a href="#l13.272"></a><span id="l13.272"> }</span>
<a href="#l13.273"></a><span id="l13.273"> </span>
<a href="#l13.274"></a><span id="l13.274" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::SetFollowupTo(const nsAString &amp;aValue)</span>
<a href="#l13.275"></a><span id="l13.275" class="difflineminus">-{</span>
<a href="#l13.276"></a><span id="l13.276" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::SetFollowupTo(const nsAString &amp;aValue) {</span>
<a href="#l13.277"></a><span id="l13.277">   return SetUnicodeHeader(MSG_FOLLOWUP_TO_HEADER_ID, aValue);</span>
<a href="#l13.278"></a><span id="l13.278"> }</span>
<a href="#l13.279"></a><span id="l13.279"> </span>
<a href="#l13.280"></a><span id="l13.280" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::GetFollowupTo(nsAString &amp;_retval)</span>
<a href="#l13.281"></a><span id="l13.281" class="difflineminus">-{</span>
<a href="#l13.282"></a><span id="l13.282" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::GetFollowupTo(nsAString &amp;_retval) {</span>
<a href="#l13.283"></a><span id="l13.283">   return GetUnicodeHeader(MSG_FOLLOWUP_TO_HEADER_ID, _retval);</span>
<a href="#l13.284"></a><span id="l13.284"> }</span>
<a href="#l13.285"></a><span id="l13.285"> </span>
<a href="#l13.286"></a><span id="l13.286" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::GetHasRecipients(bool *_retval)</span>
<a href="#l13.287"></a><span id="l13.287" class="difflineminus">-{</span>
<a href="#l13.288"></a><span id="l13.288" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::GetHasRecipients(bool *_retval) {</span>
<a href="#l13.289"></a><span id="l13.289">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l13.290"></a><span id="l13.290"> </span>
<a href="#l13.291"></a><span id="l13.291">   *_retval = NS_SUCCEEDED(mime_sanity_check_fields_recipients(</span>
<a href="#l13.292"></a><span id="l13.292" class="difflineminus">-    GetTo(), GetCc(), GetBcc(), GetNewsgroups()));</span>
<a href="#l13.293"></a><span id="l13.293" class="difflineplus">+      GetTo(), GetCc(), GetBcc(), GetNewsgroups()));</span>
<a href="#l13.294"></a><span id="l13.294"> </span>
<a href="#l13.295"></a><span id="l13.295">   return NS_OK;</span>
<a href="#l13.296"></a><span id="l13.296"> }</span>
<a href="#l13.297"></a><span id="l13.297"> </span>
<a href="#l13.298"></a><span id="l13.298" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::SetCreatorIdentityKey(const char *value)</span>
<a href="#l13.299"></a><span id="l13.299" class="difflineminus">-{</span>
<a href="#l13.300"></a><span id="l13.300" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::SetCreatorIdentityKey(const char *value) {</span>
<a href="#l13.301"></a><span id="l13.301">   return SetAsciiHeader(MSG_CREATOR_IDENTITY_KEY_ID, value);</span>
<a href="#l13.302"></a><span id="l13.302"> }</span>
<a href="#l13.303"></a><span id="l13.303"> </span>
<a href="#l13.304"></a><span id="l13.304" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::GetCreatorIdentityKey(char **_retval)</span>
<a href="#l13.305"></a><span id="l13.305" class="difflineminus">-{</span>
<a href="#l13.306"></a><span id="l13.306" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::GetCreatorIdentityKey(char **_retval) {</span>
<a href="#l13.307"></a><span id="l13.307">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l13.308"></a><span id="l13.308">   *_retval = strdup(GetAsciiHeader(MSG_CREATOR_IDENTITY_KEY_ID));</span>
<a href="#l13.309"></a><span id="l13.309">   return *_retval ? NS_OK : NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l13.310"></a><span id="l13.310"> }</span>
<a href="#l13.311"></a><span id="l13.311"> </span>
<a href="#l13.312"></a><span id="l13.312" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::SetSubject(const nsAString &amp;value)</span>
<a href="#l13.313"></a><span id="l13.313" class="difflineminus">-{</span>
<a href="#l13.314"></a><span id="l13.314" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::SetSubject(const nsAString &amp;value) {</span>
<a href="#l13.315"></a><span id="l13.315">   return SetUnicodeHeader(MSG_SUBJECT_HEADER_ID, value);</span>
<a href="#l13.316"></a><span id="l13.316"> }</span>
<a href="#l13.317"></a><span id="l13.317"> </span>
<a href="#l13.318"></a><span id="l13.318" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::GetSubject(nsAString &amp;_retval)</span>
<a href="#l13.319"></a><span id="l13.319" class="difflineminus">-{</span>
<a href="#l13.320"></a><span id="l13.320" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::GetSubject(nsAString &amp;_retval) {</span>
<a href="#l13.321"></a><span id="l13.321">   return GetUnicodeHeader(MSG_SUBJECT_HEADER_ID, _retval);</span>
<a href="#l13.322"></a><span id="l13.322"> }</span>
<a href="#l13.323"></a><span id="l13.323"> </span>
<a href="#l13.324"></a><span id="l13.324" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::SetOrganization(const nsAString &amp;value)</span>
<a href="#l13.325"></a><span id="l13.325" class="difflineminus">-{</span>
<a href="#l13.326"></a><span id="l13.326" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::SetOrganization(const nsAString &amp;value) {</span>
<a href="#l13.327"></a><span id="l13.327">   return SetUnicodeHeader(MSG_ORGANIZATION_HEADER_ID, value);</span>
<a href="#l13.328"></a><span id="l13.328"> }</span>
<a href="#l13.329"></a><span id="l13.329"> </span>
<a href="#l13.330"></a><span id="l13.330" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::GetOrganization(nsAString &amp;_retval)</span>
<a href="#l13.331"></a><span id="l13.331" class="difflineminus">-{</span>
<a href="#l13.332"></a><span id="l13.332" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::GetOrganization(nsAString &amp;_retval) {</span>
<a href="#l13.333"></a><span id="l13.333">   return GetUnicodeHeader(MSG_ORGANIZATION_HEADER_ID, _retval);</span>
<a href="#l13.334"></a><span id="l13.334"> }</span>
<a href="#l13.335"></a><span id="l13.335"> </span>
<a href="#l13.336"></a><span id="l13.336" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::SetReferences(const char *value)</span>
<a href="#l13.337"></a><span id="l13.337" class="difflineminus">-{</span>
<a href="#l13.338"></a><span id="l13.338" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::SetReferences(const char *value) {</span>
<a href="#l13.339"></a><span id="l13.339">   return SetAsciiHeader(MSG_REFERENCES_HEADER_ID, value);</span>
<a href="#l13.340"></a><span id="l13.340"> }</span>
<a href="#l13.341"></a><span id="l13.341"> </span>
<a href="#l13.342"></a><span id="l13.342" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::GetReferences(char **_retval)</span>
<a href="#l13.343"></a><span id="l13.343" class="difflineminus">-{</span>
<a href="#l13.344"></a><span id="l13.344" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::GetReferences(char **_retval) {</span>
<a href="#l13.345"></a><span id="l13.345">   *_retval = strdup(GetAsciiHeader(MSG_REFERENCES_HEADER_ID));</span>
<a href="#l13.346"></a><span id="l13.346">   return *_retval ? NS_OK : NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l13.347"></a><span id="l13.347"> }</span>
<a href="#l13.348"></a><span id="l13.348"> </span>
<a href="#l13.349"></a><span id="l13.349" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::SetNewspostUrl(const char *value)</span>
<a href="#l13.350"></a><span id="l13.350" class="difflineminus">-{</span>
<a href="#l13.351"></a><span id="l13.351" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::SetNewspostUrl(const char *value) {</span>
<a href="#l13.352"></a><span id="l13.352">   return SetAsciiHeader(MSG_NEWSPOSTURL_HEADER_ID, value);</span>
<a href="#l13.353"></a><span id="l13.353"> }</span>
<a href="#l13.354"></a><span id="l13.354"> </span>
<a href="#l13.355"></a><span id="l13.355" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::GetNewspostUrl(char **_retval)</span>
<a href="#l13.356"></a><span id="l13.356" class="difflineminus">-{</span>
<a href="#l13.357"></a><span id="l13.357" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::GetNewspostUrl(char **_retval) {</span>
<a href="#l13.358"></a><span id="l13.358">   *_retval = strdup(GetAsciiHeader(MSG_NEWSPOSTURL_HEADER_ID));</span>
<a href="#l13.359"></a><span id="l13.359">   return *_retval ? NS_OK : NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l13.360"></a><span id="l13.360"> }</span>
<a href="#l13.361"></a><span id="l13.361"> </span>
<a href="#l13.362"></a><span id="l13.362" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::SetPriority(const char *value)</span>
<a href="#l13.363"></a><span id="l13.363" class="difflineminus">-{</span>
<a href="#l13.364"></a><span id="l13.364" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::SetPriority(const char *value) {</span>
<a href="#l13.365"></a><span id="l13.365">   return SetAsciiHeader(MSG_PRIORITY_HEADER_ID, value);</span>
<a href="#l13.366"></a><span id="l13.366"> }</span>
<a href="#l13.367"></a><span id="l13.367"> </span>
<a href="#l13.368"></a><span id="l13.368" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::GetPriority(char **_retval)</span>
<a href="#l13.369"></a><span id="l13.369" class="difflineminus">-{</span>
<a href="#l13.370"></a><span id="l13.370" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::GetPriority(char **_retval) {</span>
<a href="#l13.371"></a><span id="l13.371">   *_retval = strdup(GetAsciiHeader(MSG_PRIORITY_HEADER_ID));</span>
<a href="#l13.372"></a><span id="l13.372">   return *_retval ? NS_OK : NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l13.373"></a><span id="l13.373"> }</span>
<a href="#l13.374"></a><span id="l13.374"> </span>
<a href="#l13.375"></a><span id="l13.375" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::SetCharacterSet(const char *value)</span>
<a href="#l13.376"></a><span id="l13.376" class="difflineminus">-{</span>
<a href="#l13.377"></a><span id="l13.377" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::SetCharacterSet(const char *value) {</span>
<a href="#l13.378"></a><span id="l13.378">   return SetAsciiHeader(MSG_CHARACTER_SET_HEADER_ID, value);</span>
<a href="#l13.379"></a><span id="l13.379"> }</span>
<a href="#l13.380"></a><span id="l13.380"> </span>
<a href="#l13.381"></a><span id="l13.381" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::GetCharacterSet(char **_retval)</span>
<a href="#l13.382"></a><span id="l13.382" class="difflineminus">-{</span>
<a href="#l13.383"></a><span id="l13.383" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::GetCharacterSet(char **_retval) {</span>
<a href="#l13.384"></a><span id="l13.384">   *_retval = strdup(GetAsciiHeader(MSG_CHARACTER_SET_HEADER_ID));</span>
<a href="#l13.385"></a><span id="l13.385">   return *_retval ? NS_OK : NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l13.386"></a><span id="l13.386"> }</span>
<a href="#l13.387"></a><span id="l13.387"> </span>
<a href="#l13.388"></a><span id="l13.388" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::SetMessageId(const char *value)</span>
<a href="#l13.389"></a><span id="l13.389" class="difflineminus">-{</span>
<a href="#l13.390"></a><span id="l13.390" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::SetMessageId(const char *value) {</span>
<a href="#l13.391"></a><span id="l13.391">   return SetAsciiHeader(MSG_MESSAGE_ID_HEADER_ID, value);</span>
<a href="#l13.392"></a><span id="l13.392"> }</span>
<a href="#l13.393"></a><span id="l13.393"> </span>
<a href="#l13.394"></a><span id="l13.394" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::GetMessageId(char **_retval)</span>
<a href="#l13.395"></a><span id="l13.395" class="difflineminus">-{</span>
<a href="#l13.396"></a><span id="l13.396" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::GetMessageId(char **_retval) {</span>
<a href="#l13.397"></a><span id="l13.397">   *_retval = strdup(GetAsciiHeader(MSG_MESSAGE_ID_HEADER_ID));</span>
<a href="#l13.398"></a><span id="l13.398">   return *_retval ? NS_OK : NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l13.399"></a><span id="l13.399"> }</span>
<a href="#l13.400"></a><span id="l13.400"> </span>
<a href="#l13.401"></a><span id="l13.401" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::SetTemplateName(const nsAString &amp;value)</span>
<a href="#l13.402"></a><span id="l13.402" class="difflineminus">-{</span>
<a href="#l13.403"></a><span id="l13.403" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::SetTemplateName(const nsAString &amp;value) {</span>
<a href="#l13.404"></a><span id="l13.404">   return SetUnicodeHeader(MSG_X_TEMPLATE_HEADER_ID, value);</span>
<a href="#l13.405"></a><span id="l13.405"> }</span>
<a href="#l13.406"></a><span id="l13.406"> </span>
<a href="#l13.407"></a><span id="l13.407" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::GetTemplateName(nsAString &amp;_retval)</span>
<a href="#l13.408"></a><span id="l13.408" class="difflineminus">-{</span>
<a href="#l13.409"></a><span id="l13.409" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::GetTemplateName(nsAString &amp;_retval) {</span>
<a href="#l13.410"></a><span id="l13.410">   return GetUnicodeHeader(MSG_X_TEMPLATE_HEADER_ID, _retval);</span>
<a href="#l13.411"></a><span id="l13.411"> }</span>
<a href="#l13.412"></a><span id="l13.412"> </span>
<a href="#l13.413"></a><span id="l13.413" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::SetDraftId(const char *value)</span>
<a href="#l13.414"></a><span id="l13.414" class="difflineminus">-{</span>
<a href="#l13.415"></a><span id="l13.415" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::SetDraftId(const char *value) {</span>
<a href="#l13.416"></a><span id="l13.416">   return SetAsciiHeader(MSG_DRAFT_ID_HEADER_ID, value);</span>
<a href="#l13.417"></a><span id="l13.417"> }</span>
<a href="#l13.418"></a><span id="l13.418"> </span>
<a href="#l13.419"></a><span id="l13.419" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::GetDraftId(char **_retval)</span>
<a href="#l13.420"></a><span id="l13.420" class="difflineminus">-{</span>
<a href="#l13.421"></a><span id="l13.421" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::GetDraftId(char **_retval) {</span>
<a href="#l13.422"></a><span id="l13.422">   *_retval = strdup(GetAsciiHeader(MSG_DRAFT_ID_HEADER_ID));</span>
<a href="#l13.423"></a><span id="l13.423">   return *_retval ? NS_OK : NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l13.424"></a><span id="l13.424"> }</span>
<a href="#l13.425"></a><span id="l13.425"> </span>
<a href="#l13.426"></a><span id="l13.426" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::SetTemplateId(const char *value)</span>
<a href="#l13.427"></a><span id="l13.427" class="difflineminus">-{</span>
<a href="#l13.428"></a><span id="l13.428" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::SetTemplateId(const char *value) {</span>
<a href="#l13.429"></a><span id="l13.429">   return SetAsciiHeader(MSG_TEMPLATE_ID_HEADER_ID, value);</span>
<a href="#l13.430"></a><span id="l13.430"> }</span>
<a href="#l13.431"></a><span id="l13.431"> </span>
<a href="#l13.432"></a><span id="l13.432" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::GetTemplateId(char **_retval)</span>
<a href="#l13.433"></a><span id="l13.433" class="difflineminus">-{</span>
<a href="#l13.434"></a><span id="l13.434" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::GetTemplateId(char **_retval) {</span>
<a href="#l13.435"></a><span id="l13.435">   *_retval = strdup(GetAsciiHeader(MSG_TEMPLATE_ID_HEADER_ID));</span>
<a href="#l13.436"></a><span id="l13.436">   return *_retval ? NS_OK : NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l13.437"></a><span id="l13.437"> }</span>
<a href="#l13.438"></a><span id="l13.438"> </span>
<a href="#l13.439"></a><span id="l13.439" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::SetReturnReceipt(bool value)</span>
<a href="#l13.440"></a><span id="l13.440" class="difflineminus">-{</span>
<a href="#l13.441"></a><span id="l13.441" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::SetReturnReceipt(bool value) {</span>
<a href="#l13.442"></a><span id="l13.442">   m_returnReceipt = value;</span>
<a href="#l13.443"></a><span id="l13.443">   return NS_OK;</span>
<a href="#l13.444"></a><span id="l13.444"> }</span>
<a href="#l13.445"></a><span id="l13.445"> </span>
<a href="#l13.446"></a><span id="l13.446" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::GetReturnReceipt(bool *_retval)</span>
<a href="#l13.447"></a><span id="l13.447" class="difflineminus">-{</span>
<a href="#l13.448"></a><span id="l13.448" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::GetReturnReceipt(bool *_retval) {</span>
<a href="#l13.449"></a><span id="l13.449">   *_retval = m_returnReceipt;</span>
<a href="#l13.450"></a><span id="l13.450">   return NS_OK;</span>
<a href="#l13.451"></a><span id="l13.451"> }</span>
<a href="#l13.452"></a><span id="l13.452"> </span>
<a href="#l13.453"></a><span id="l13.453" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::SetReceiptHeaderType(int32_t value)</span>
<a href="#l13.454"></a><span id="l13.454" class="difflineminus">-{</span>
<a href="#l13.455"></a><span id="l13.455" class="difflineminus">-    m_receiptHeaderType = value;</span>
<a href="#l13.456"></a><span id="l13.456" class="difflineminus">-    return NS_OK;</span>
<a href="#l13.457"></a><span id="l13.457" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::SetReceiptHeaderType(int32_t value) {</span>
<a href="#l13.458"></a><span id="l13.458" class="difflineplus">+  m_receiptHeaderType = value;</span>
<a href="#l13.459"></a><span id="l13.459" class="difflineplus">+  return NS_OK;</span>
<a href="#l13.460"></a><span id="l13.460"> }</span>
<a href="#l13.461"></a><span id="l13.461"> </span>
<a href="#l13.462"></a><span id="l13.462" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::GetReceiptHeaderType(int32_t *_retval)</span>
<a href="#l13.463"></a><span id="l13.463" class="difflineminus">-{</span>
<a href="#l13.464"></a><span id="l13.464" class="difflineminus">-    *_retval = m_receiptHeaderType;</span>
<a href="#l13.465"></a><span id="l13.465" class="difflineminus">-    return NS_OK;</span>
<a href="#l13.466"></a><span id="l13.466" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::GetReceiptHeaderType(int32_t *_retval) {</span>
<a href="#l13.467"></a><span id="l13.467" class="difflineplus">+  *_retval = m_receiptHeaderType;</span>
<a href="#l13.468"></a><span id="l13.468" class="difflineplus">+  return NS_OK;</span>
<a href="#l13.469"></a><span id="l13.469"> }</span>
<a href="#l13.470"></a><span id="l13.470"> </span>
<a href="#l13.471"></a><span id="l13.471" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::SetDSN(bool value)</span>
<a href="#l13.472"></a><span id="l13.472" class="difflineminus">-{</span>
<a href="#l13.473"></a><span id="l13.473" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::SetDSN(bool value) {</span>
<a href="#l13.474"></a><span id="l13.474">   m_DSN = value;</span>
<a href="#l13.475"></a><span id="l13.475">   return NS_OK;</span>
<a href="#l13.476"></a><span id="l13.476"> }</span>
<a href="#l13.477"></a><span id="l13.477"> </span>
<a href="#l13.478"></a><span id="l13.478" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::GetDSN(bool *_retval)</span>
<a href="#l13.479"></a><span id="l13.479" class="difflineminus">-{</span>
<a href="#l13.480"></a><span id="l13.480" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::GetDSN(bool *_retval) {</span>
<a href="#l13.481"></a><span id="l13.481">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l13.482"></a><span id="l13.482">   *_retval = m_DSN;</span>
<a href="#l13.483"></a><span id="l13.483">   return NS_OK;</span>
<a href="#l13.484"></a><span id="l13.484"> }</span>
<a href="#l13.485"></a><span id="l13.485"> </span>
<a href="#l13.486"></a><span id="l13.486" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::SetAttachVCard(bool value)</span>
<a href="#l13.487"></a><span id="l13.487" class="difflineminus">-{</span>
<a href="#l13.488"></a><span id="l13.488" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::SetAttachVCard(bool value) {</span>
<a href="#l13.489"></a><span id="l13.489">   m_attachVCard = value;</span>
<a href="#l13.490"></a><span id="l13.490">   return NS_OK;</span>
<a href="#l13.491"></a><span id="l13.491"> }</span>
<a href="#l13.492"></a><span id="l13.492"> </span>
<a href="#l13.493"></a><span id="l13.493" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::GetAttachVCard(bool *_retval)</span>
<a href="#l13.494"></a><span id="l13.494" class="difflineminus">-{</span>
<a href="#l13.495"></a><span id="l13.495" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::GetAttachVCard(bool *_retval) {</span>
<a href="#l13.496"></a><span id="l13.496">   *_retval = m_attachVCard;</span>
<a href="#l13.497"></a><span id="l13.497">   return NS_OK;</span>
<a href="#l13.498"></a><span id="l13.498"> }</span>
<a href="#l13.499"></a><span id="l13.499"> </span>
<a href="#l13.500"></a><span id="l13.500" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::GetAttachmentReminder(bool *_retval)</span>
<a href="#l13.501"></a><span id="l13.501" class="difflineminus">-{</span>
<a href="#l13.502"></a><span id="l13.502" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::GetAttachmentReminder(bool *_retval) {</span>
<a href="#l13.503"></a><span id="l13.503">   *_retval = m_attachmentReminder;</span>
<a href="#l13.504"></a><span id="l13.504">   return NS_OK;</span>
<a href="#l13.505"></a><span id="l13.505"> }</span>
<a href="#l13.506"></a><span id="l13.506"> </span>
<a href="#l13.507"></a><span id="l13.507" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::SetAttachmentReminder(bool value)</span>
<a href="#l13.508"></a><span id="l13.508" class="difflineminus">-{</span>
<a href="#l13.509"></a><span id="l13.509" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::SetAttachmentReminder(bool value) {</span>
<a href="#l13.510"></a><span id="l13.510">   m_attachmentReminder = value;</span>
<a href="#l13.511"></a><span id="l13.511">   return NS_OK;</span>
<a href="#l13.512"></a><span id="l13.512"> }</span>
<a href="#l13.513"></a><span id="l13.513"> </span>
<a href="#l13.514"></a><span id="l13.514" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::SetDeliveryFormat(int32_t value)</span>
<a href="#l13.515"></a><span id="l13.515" class="difflineminus">-{</span>
<a href="#l13.516"></a><span id="l13.516" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::SetDeliveryFormat(int32_t value) {</span>
<a href="#l13.517"></a><span id="l13.517">   switch (value) {</span>
<a href="#l13.518"></a><span id="l13.518">     case nsIMsgCompSendFormat::AskUser:</span>
<a href="#l13.519"></a><span id="l13.519">     case nsIMsgCompSendFormat::PlainText:</span>
<a href="#l13.520"></a><span id="l13.520">     case nsIMsgCompSendFormat::HTML:</span>
<a href="#l13.521"></a><span id="l13.521">     case nsIMsgCompSendFormat::Both:</span>
<a href="#l13.522"></a><span id="l13.522">       m_deliveryFormat = value;</span>
<a href="#l13.523"></a><span id="l13.523">       break;</span>
<a href="#l13.524"></a><span id="l13.524">     default:</span>
<a href="#l13.525"></a><span id="l13.525">       m_deliveryFormat = nsIMsgCompSendFormat::AskUser;</span>
<a href="#l13.526"></a><span id="l13.526">   }</span>
<a href="#l13.527"></a><span id="l13.527"> </span>
<a href="#l13.528"></a><span id="l13.528">   return NS_OK;</span>
<a href="#l13.529"></a><span id="l13.529"> }</span>
<a href="#l13.530"></a><span id="l13.530"> </span>
<a href="#l13.531"></a><span id="l13.531" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::GetDeliveryFormat(int32_t *_retval)</span>
<a href="#l13.532"></a><span id="l13.532" class="difflineminus">-{</span>
<a href="#l13.533"></a><span id="l13.533" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::GetDeliveryFormat(int32_t *_retval) {</span>
<a href="#l13.534"></a><span id="l13.534">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l13.535"></a><span id="l13.535">   *_retval = m_deliveryFormat;</span>
<a href="#l13.536"></a><span id="l13.536">   return NS_OK;</span>
<a href="#l13.537"></a><span id="l13.537"> }</span>
<a href="#l13.538"></a><span id="l13.538"> </span>
<a href="#l13.539"></a><span id="l13.539" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::SetContentLanguage(const char *value)</span>
<a href="#l13.540"></a><span id="l13.540" class="difflineminus">-{</span>
<a href="#l13.541"></a><span id="l13.541" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::SetContentLanguage(const char *value) {</span>
<a href="#l13.542"></a><span id="l13.542">   return SetAsciiHeader(MSG_CONTENT_LANGUAGE_ID, value);</span>
<a href="#l13.543"></a><span id="l13.543"> }</span>
<a href="#l13.544"></a><span id="l13.544"> </span>
<a href="#l13.545"></a><span id="l13.545" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::GetContentLanguage(char **_retval)</span>
<a href="#l13.546"></a><span id="l13.546" class="difflineminus">-{</span>
<a href="#l13.547"></a><span id="l13.547" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::GetContentLanguage(char **_retval) {</span>
<a href="#l13.548"></a><span id="l13.548">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l13.549"></a><span id="l13.549">   *_retval = strdup(GetAsciiHeader(MSG_CONTENT_LANGUAGE_ID));</span>
<a href="#l13.550"></a><span id="l13.550">   return *_retval ? NS_OK : NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l13.551"></a><span id="l13.551"> }</span>
<a href="#l13.552"></a><span id="l13.552"> </span>
<a href="#l13.553"></a><span id="l13.553" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::SetForcePlainText(bool value)</span>
<a href="#l13.554"></a><span id="l13.554" class="difflineminus">-{</span>
<a href="#l13.555"></a><span id="l13.555" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::SetForcePlainText(bool value) {</span>
<a href="#l13.556"></a><span id="l13.556">   m_forcePlainText = value;</span>
<a href="#l13.557"></a><span id="l13.557">   return NS_OK;</span>
<a href="#l13.558"></a><span id="l13.558"> }</span>
<a href="#l13.559"></a><span id="l13.559"> </span>
<a href="#l13.560"></a><span id="l13.560" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::GetForcePlainText(bool *_retval)</span>
<a href="#l13.561"></a><span id="l13.561" class="difflineminus">-{</span>
<a href="#l13.562"></a><span id="l13.562" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::GetForcePlainText(bool *_retval) {</span>
<a href="#l13.563"></a><span id="l13.563">   *_retval = m_forcePlainText;</span>
<a href="#l13.564"></a><span id="l13.564">   return NS_OK;</span>
<a href="#l13.565"></a><span id="l13.565"> }</span>
<a href="#l13.566"></a><span id="l13.566"> </span>
<a href="#l13.567"></a><span id="l13.567" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::SetForceMsgEncoding(bool value)</span>
<a href="#l13.568"></a><span id="l13.568" class="difflineminus">-{</span>
<a href="#l13.569"></a><span id="l13.569" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::SetForceMsgEncoding(bool value) {</span>
<a href="#l13.570"></a><span id="l13.570">   m_forceMsgEncoding = value;</span>
<a href="#l13.571"></a><span id="l13.571">   return NS_OK;</span>
<a href="#l13.572"></a><span id="l13.572"> }</span>
<a href="#l13.573"></a><span id="l13.573"> </span>
<a href="#l13.574"></a><span id="l13.574" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::GetForceMsgEncoding(bool *_retval)</span>
<a href="#l13.575"></a><span id="l13.575" class="difflineminus">-{</span>
<a href="#l13.576"></a><span id="l13.576" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::GetForceMsgEncoding(bool *_retval) {</span>
<a href="#l13.577"></a><span id="l13.577">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l13.578"></a><span id="l13.578">   *_retval = m_forceMsgEncoding;</span>
<a href="#l13.579"></a><span id="l13.579">   return NS_OK;</span>
<a href="#l13.580"></a><span id="l13.580"> }</span>
<a href="#l13.581"></a><span id="l13.581"> </span>
<a href="#l13.582"></a><span id="l13.582" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::SetUseMultipartAlternative(bool value)</span>
<a href="#l13.583"></a><span id="l13.583" class="difflineminus">-{</span>
<a href="#l13.584"></a><span id="l13.584" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::SetUseMultipartAlternative(bool value) {</span>
<a href="#l13.585"></a><span id="l13.585">   m_useMultipartAlternative = value;</span>
<a href="#l13.586"></a><span id="l13.586">   return NS_OK;</span>
<a href="#l13.587"></a><span id="l13.587"> }</span>
<a href="#l13.588"></a><span id="l13.588"> </span>
<a href="#l13.589"></a><span id="l13.589" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::GetUseMultipartAlternative(bool *_retval)</span>
<a href="#l13.590"></a><span id="l13.590" class="difflineminus">-{</span>
<a href="#l13.591"></a><span id="l13.591" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::GetUseMultipartAlternative(bool *_retval) {</span>
<a href="#l13.592"></a><span id="l13.592">   *_retval = m_useMultipartAlternative;</span>
<a href="#l13.593"></a><span id="l13.593">   return NS_OK;</span>
<a href="#l13.594"></a><span id="l13.594"> }</span>
<a href="#l13.595"></a><span id="l13.595"> </span>
<a href="#l13.596"></a><span id="l13.596" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::SetBodyIsAsciiOnly(bool value)</span>
<a href="#l13.597"></a><span id="l13.597" class="difflineminus">-{</span>
<a href="#l13.598"></a><span id="l13.598" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::SetBodyIsAsciiOnly(bool value) {</span>
<a href="#l13.599"></a><span id="l13.599">   m_bodyIsAsciiOnly = value;</span>
<a href="#l13.600"></a><span id="l13.600">   return NS_OK;</span>
<a href="#l13.601"></a><span id="l13.601"> }</span>
<a href="#l13.602"></a><span id="l13.602"> </span>
<a href="#l13.603"></a><span id="l13.603" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::GetBodyIsAsciiOnly(bool *_retval)</span>
<a href="#l13.604"></a><span id="l13.604" class="difflineminus">-{</span>
<a href="#l13.605"></a><span id="l13.605" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::GetBodyIsAsciiOnly(bool *_retval) {</span>
<a href="#l13.606"></a><span id="l13.606">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l13.607"></a><span id="l13.607"> </span>
<a href="#l13.608"></a><span id="l13.608">   *_retval = m_bodyIsAsciiOnly;</span>
<a href="#l13.609"></a><span id="l13.609">   return NS_OK;</span>
<a href="#l13.610"></a><span id="l13.610"> }</span>
<a href="#l13.611"></a><span id="l13.611"> </span>
<a href="#l13.612"></a><span id="l13.612" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::SetBody(const nsAString &amp;value)</span>
<a href="#l13.613"></a><span id="l13.613" class="difflineminus">-{</span>
<a href="#l13.614"></a><span id="l13.614" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::SetBody(const nsAString &amp;value) {</span>
<a href="#l13.615"></a><span id="l13.615">   CopyUTF16toUTF8(value, m_body);</span>
<a href="#l13.616"></a><span id="l13.616">   return NS_OK;</span>
<a href="#l13.617"></a><span id="l13.617"> }</span>
<a href="#l13.618"></a><span id="l13.618"> </span>
<a href="#l13.619"></a><span id="l13.619" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::GetBody(nsAString &amp;_retval)</span>
<a href="#l13.620"></a><span id="l13.620" class="difflineminus">-{</span>
<a href="#l13.621"></a><span id="l13.621" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::GetBody(nsAString &amp;_retval) {</span>
<a href="#l13.622"></a><span id="l13.622">   CopyUTF8toUTF16(m_body, _retval);</span>
<a href="#l13.623"></a><span id="l13.623">   return NS_OK;</span>
<a href="#l13.624"></a><span id="l13.624"> }</span>
<a href="#l13.625"></a><span id="l13.625"> </span>
<a href="#l13.626"></a><span id="l13.626" class="difflineminus">-nsresult nsMsgCompFields::SetBody(const char *value)</span>
<a href="#l13.627"></a><span id="l13.627" class="difflineminus">-{</span>
<a href="#l13.628"></a><span id="l13.628" class="difflineplus">+nsresult nsMsgCompFields::SetBody(const char *value) {</span>
<a href="#l13.629"></a><span id="l13.629">   if (value)</span>
<a href="#l13.630"></a><span id="l13.630">     m_body = value;</span>
<a href="#l13.631"></a><span id="l13.631">   else</span>
<a href="#l13.632"></a><span id="l13.632">     m_body.Truncate();</span>
<a href="#l13.633"></a><span id="l13.633">   return NS_OK;</span>
<a href="#l13.634"></a><span id="l13.634"> }</span>
<a href="#l13.635"></a><span id="l13.635"> </span>
<a href="#l13.636"></a><span id="l13.636" class="difflineminus">-const char* nsMsgCompFields::GetBody()</span>
<a href="#l13.637"></a><span id="l13.637" class="difflineminus">-{</span>
<a href="#l13.638"></a><span id="l13.638" class="difflineminus">-    return m_body.get();</span>
<a href="#l13.639"></a><span id="l13.639" class="difflineminus">-}</span>
<a href="#l13.640"></a><span id="l13.640" class="difflineplus">+const char *nsMsgCompFields::GetBody() { return m_body.get(); }</span>
<a href="#l13.641"></a><span id="l13.641"> </span>
<a href="#l13.642"></a><span id="l13.642"> /* readonly attribute nsISimpleEnumerator attachmentsArray; */</span>
<a href="#l13.643"></a><span id="l13.643" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::GetAttachments(nsISimpleEnumerator * *aAttachmentsEnum)</span>
<a href="#l13.644"></a><span id="l13.644" class="difflineminus">-{</span>
<a href="#l13.645"></a><span id="l13.645" class="difflineminus">-  return aAttachmentsEnum ? NS_NewArrayEnumerator(aAttachmentsEnum, m_attachments, NS_GET_IID(nsIMsgAttachment)) : NS_ERROR_NULL_POINTER;</span>
<a href="#l13.646"></a><span id="l13.646" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::GetAttachments(</span>
<a href="#l13.647"></a><span id="l13.647" class="difflineplus">+    nsISimpleEnumerator **aAttachmentsEnum) {</span>
<a href="#l13.648"></a><span id="l13.648" class="difflineplus">+  return aAttachmentsEnum</span>
<a href="#l13.649"></a><span id="l13.649" class="difflineplus">+             ? NS_NewArrayEnumerator(aAttachmentsEnum, m_attachments,</span>
<a href="#l13.650"></a><span id="l13.650" class="difflineplus">+                                     NS_GET_IID(nsIMsgAttachment))</span>
<a href="#l13.651"></a><span id="l13.651" class="difflineplus">+             : NS_ERROR_NULL_POINTER;</span>
<a href="#l13.652"></a><span id="l13.652"> }</span>
<a href="#l13.653"></a><span id="l13.653"> </span>
<a href="#l13.654"></a><span id="l13.654"> /* void addAttachment (in nsIMsgAttachment attachment); */</span>
<a href="#l13.655"></a><span id="l13.655" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::AddAttachment(nsIMsgAttachment *attachment)</span>
<a href="#l13.656"></a><span id="l13.656" class="difflineminus">-{</span>
<a href="#l13.657"></a><span id="l13.657" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::AddAttachment(nsIMsgAttachment *attachment) {</span>
<a href="#l13.658"></a><span id="l13.658">   int32_t attachmentCount = m_attachments.Count();</span>
<a href="#l13.659"></a><span id="l13.659"> </span>
<a href="#l13.660"></a><span id="l13.660" class="difflineminus">-  //Don't add twice the same attachment.</span>
<a href="#l13.661"></a><span id="l13.661" class="difflineplus">+  // Don't add twice the same attachment.</span>
<a href="#l13.662"></a><span id="l13.662">   nsCOMPtr&lt;nsIMsgAttachment&gt; element;</span>
<a href="#l13.663"></a><span id="l13.663">   bool sameUrl;</span>
<a href="#l13.664"></a><span id="l13.664" class="difflineminus">-  for (int32_t i = 0; i &lt; attachmentCount; i ++)</span>
<a href="#l13.665"></a><span id="l13.665" class="difflineminus">-  {</span>
<a href="#l13.666"></a><span id="l13.666" class="difflineplus">+  for (int32_t i = 0; i &lt; attachmentCount; i++) {</span>
<a href="#l13.667"></a><span id="l13.667">     m_attachments[i]-&gt;EqualsUrl(attachment, &amp;sameUrl);</span>
<a href="#l13.668"></a><span id="l13.668" class="difflineminus">-    if (sameUrl)</span>
<a href="#l13.669"></a><span id="l13.669" class="difflineminus">-      return NS_OK;</span>
<a href="#l13.670"></a><span id="l13.670" class="difflineplus">+    if (sameUrl) return NS_OK;</span>
<a href="#l13.671"></a><span id="l13.671">   }</span>
<a href="#l13.672"></a><span id="l13.672">   m_attachments.AppendObject(attachment);</span>
<a href="#l13.673"></a><span id="l13.673"> </span>
<a href="#l13.674"></a><span id="l13.674">   return NS_OK;</span>
<a href="#l13.675"></a><span id="l13.675"> }</span>
<a href="#l13.676"></a><span id="l13.676"> </span>
<a href="#l13.677"></a><span id="l13.677"> /* void removeAttachment (in nsIMsgAttachment attachment); */</span>
<a href="#l13.678"></a><span id="l13.678" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::RemoveAttachment(nsIMsgAttachment *attachment)</span>
<a href="#l13.679"></a><span id="l13.679" class="difflineminus">-{</span>
<a href="#l13.680"></a><span id="l13.680" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::RemoveAttachment(nsIMsgAttachment *attachment) {</span>
<a href="#l13.681"></a><span id="l13.681">   int32_t attachmentCount = m_attachments.Count();</span>
<a href="#l13.682"></a><span id="l13.682"> </span>
<a href="#l13.683"></a><span id="l13.683">   nsCOMPtr&lt;nsIMsgAttachment&gt; element;</span>
<a href="#l13.684"></a><span id="l13.684">   bool sameUrl;</span>
<a href="#l13.685"></a><span id="l13.685" class="difflineminus">-  for (int32_t i = 0; i &lt; attachmentCount; i ++)</span>
<a href="#l13.686"></a><span id="l13.686" class="difflineminus">-  {</span>
<a href="#l13.687"></a><span id="l13.687" class="difflineplus">+  for (int32_t i = 0; i &lt; attachmentCount; i++) {</span>
<a href="#l13.688"></a><span id="l13.688">     m_attachments[i]-&gt;EqualsUrl(attachment, &amp;sameUrl);</span>
<a href="#l13.689"></a><span id="l13.689" class="difflineminus">-    if (sameUrl)</span>
<a href="#l13.690"></a><span id="l13.690" class="difflineminus">-    {</span>
<a href="#l13.691"></a><span id="l13.691" class="difflineplus">+    if (sameUrl) {</span>
<a href="#l13.692"></a><span id="l13.692">       m_attachments.RemoveObjectAt(i);</span>
<a href="#l13.693"></a><span id="l13.693">       break;</span>
<a href="#l13.694"></a><span id="l13.694">     }</span>
<a href="#l13.695"></a><span id="l13.695">   }</span>
<a href="#l13.696"></a><span id="l13.696"> </span>
<a href="#l13.697"></a><span id="l13.697">   return NS_OK;</span>
<a href="#l13.698"></a><span id="l13.698"> }</span>
<a href="#l13.699"></a><span id="l13.699"> </span>
<a href="#l13.700"></a><span id="l13.700"> /* void removeAttachments (); */</span>
<a href="#l13.701"></a><span id="l13.701" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::RemoveAttachments()</span>
<a href="#l13.702"></a><span id="l13.702" class="difflineminus">-{</span>
<a href="#l13.703"></a><span id="l13.703" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::RemoveAttachments() {</span>
<a href="#l13.704"></a><span id="l13.704">   m_attachments.Clear();</span>
<a href="#l13.705"></a><span id="l13.705"> </span>
<a href="#l13.706"></a><span id="l13.706">   return NS_OK;</span>
<a href="#l13.707"></a><span id="l13.707"> }</span>
<a href="#l13.708"></a><span id="l13.708"> </span>
<a href="#l13.709"></a><span id="l13.709" class="difflineminus">-</span>
<a href="#l13.710"></a><span id="l13.710"> // This method is called during the creation of a new window.</span>
<a href="#l13.711"></a><span id="l13.711"> NS_IMETHODIMP</span>
<a href="#l13.712"></a><span id="l13.712"> nsMsgCompFields::SplitRecipients(const nsAString &amp;aRecipients,</span>
<a href="#l13.713"></a><span id="l13.713" class="difflineminus">-                                 bool aEmailAddressOnly,</span>
<a href="#l13.714"></a><span id="l13.714" class="difflineminus">-                                 uint32_t *aLength,</span>
<a href="#l13.715"></a><span id="l13.715" class="difflineminus">-                                 char16_t*** aResult)</span>
<a href="#l13.716"></a><span id="l13.716" class="difflineminus">-{</span>
<a href="#l13.717"></a><span id="l13.717" class="difflineplus">+                                 bool aEmailAddressOnly, uint32_t *aLength,</span>
<a href="#l13.718"></a><span id="l13.718" class="difflineplus">+                                 char16_t ***aResult) {</span>
<a href="#l13.719"></a><span id="l13.719">   NS_ENSURE_ARG_POINTER(aLength);</span>
<a href="#l13.720"></a><span id="l13.720">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l13.721"></a><span id="l13.721"> </span>
<a href="#l13.722"></a><span id="l13.722">   *aLength = 0;</span>
<a href="#l13.723"></a><span id="l13.723">   *aResult = nullptr;</span>
<a href="#l13.724"></a><span id="l13.724"> </span>
<a href="#l13.725"></a><span id="l13.725">   nsCOMArray&lt;msgIAddressObject&gt; header(EncodedHeaderW(aRecipients));</span>
<a href="#l13.726"></a><span id="l13.726">   nsTArray&lt;nsString&gt; results;</span>
<a href="#l13.727"></a><span id="l13.727">   if (aEmailAddressOnly)</span>
<a href="#l13.728"></a><span id="l13.728">     ExtractEmails(header, results);</span>
<a href="#l13.729"></a><span id="l13.729">   else</span>
<a href="#l13.730"></a><span id="l13.730">     ExtractDisplayAddresses(header, results);</span>
<a href="#l13.731"></a><span id="l13.731"> </span>
<a href="#l13.732"></a><span id="l13.732">   uint32_t count = results.Length();</span>
<a href="#l13.733"></a><span id="l13.733">   char16_t **result = (char16_t **)moz_xmalloc(sizeof(char16_t *) * count);</span>
<a href="#l13.734"></a><span id="l13.734" class="difflineminus">-  for (uint32_t i = 0; i &lt; count; ++i)</span>
<a href="#l13.735"></a><span id="l13.735" class="difflineminus">-    result[i] = ToNewUnicode(results[i]);</span>
<a href="#l13.736"></a><span id="l13.736" class="difflineplus">+  for (uint32_t i = 0; i &lt; count; ++i) result[i] = ToNewUnicode(results[i]);</span>
<a href="#l13.737"></a><span id="l13.737"> </span>
<a href="#l13.738"></a><span id="l13.738">   *aResult = result;</span>
<a href="#l13.739"></a><span id="l13.739">   *aLength = count;</span>
<a href="#l13.740"></a><span id="l13.740">   return NS_OK;</span>
<a href="#l13.741"></a><span id="l13.741"> }</span>
<a href="#l13.742"></a><span id="l13.742"> </span>
<a href="#l13.743"></a><span id="l13.743" class="difflineminus">-</span>
<a href="#l13.744"></a><span id="l13.744" class="difflineminus">-// This method is called during the sending of message from nsMsgCompose::CheckAndPopulateRecipients()</span>
<a href="#l13.745"></a><span id="l13.745" class="difflineplus">+// This method is called during the sending of message from</span>
<a href="#l13.746"></a><span id="l13.746" class="difflineplus">+// nsMsgCompose::CheckAndPopulateRecipients()</span>
<a href="#l13.747"></a><span id="l13.747"> nsresult nsMsgCompFields::SplitRecipientsEx(const nsAString &amp;recipients,</span>
<a href="#l13.748"></a><span id="l13.748" class="difflineminus">-                                            nsTArray&lt;nsMsgRecipient&gt; &amp;aResult)</span>
<a href="#l13.749"></a><span id="l13.749" class="difflineminus">-{</span>
<a href="#l13.750"></a><span id="l13.750" class="difflineplus">+                                            nsTArray&lt;nsMsgRecipient&gt; &amp;aResult) {</span>
<a href="#l13.751"></a><span id="l13.751">   nsTArray&lt;nsString&gt; names, addresses;</span>
<a href="#l13.752"></a><span id="l13.752">   ExtractAllAddresses(EncodedHeaderW(recipients), names, addresses);</span>
<a href="#l13.753"></a><span id="l13.753"> </span>
<a href="#l13.754"></a><span id="l13.754">   uint32_t numAddresses = names.Length();</span>
<a href="#l13.755"></a><span id="l13.755" class="difflineminus">-  for (uint32_t i = 0; i &lt; numAddresses; ++i)</span>
<a href="#l13.756"></a><span id="l13.756" class="difflineminus">-  {</span>
<a href="#l13.757"></a><span id="l13.757" class="difflineplus">+  for (uint32_t i = 0; i &lt; numAddresses; ++i) {</span>
<a href="#l13.758"></a><span id="l13.758">     nsMsgRecipient msgRecipient;</span>
<a href="#l13.759"></a><span id="l13.759">     msgRecipient.mEmail = addresses[i];</span>
<a href="#l13.760"></a><span id="l13.760">     msgRecipient.mName = names[i];</span>
<a href="#l13.761"></a><span id="l13.761">     aResult.AppendElement(msgRecipient);</span>
<a href="#l13.762"></a><span id="l13.762">   }</span>
<a href="#l13.763"></a><span id="l13.763"> </span>
<a href="#l13.764"></a><span id="l13.764">   return NS_OK;</span>
<a href="#l13.765"></a><span id="l13.765"> }</span>
<a href="#l13.766"></a><span id="l13.766"> </span>
<a href="#l13.767"></a><span id="l13.767" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::ConvertBodyToPlainText()</span>
<a href="#l13.768"></a><span id="l13.768" class="difflineminus">-{</span>
<a href="#l13.769"></a><span id="l13.769" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::ConvertBodyToPlainText() {</span>
<a href="#l13.770"></a><span id="l13.770">   nsresult rv = NS_OK;</span>
<a href="#l13.771"></a><span id="l13.771"> </span>
<a href="#l13.772"></a><span id="l13.772" class="difflineminus">-  if (!m_body.IsEmpty())</span>
<a href="#l13.773"></a><span id="l13.773" class="difflineminus">-  {</span>
<a href="#l13.774"></a><span id="l13.774" class="difflineplus">+  if (!m_body.IsEmpty()) {</span>
<a href="#l13.775"></a><span id="l13.775">     nsAutoString body;</span>
<a href="#l13.776"></a><span id="l13.776">     rv = GetBody(body);</span>
<a href="#l13.777"></a><span id="l13.777" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l13.778"></a><span id="l13.778" class="difflineminus">-    {</span>
<a href="#l13.779"></a><span id="l13.779" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l13.780"></a><span id="l13.780">       bool flowed, delsp, formatted, disallowBreaks;</span>
<a href="#l13.781"></a><span id="l13.781" class="difflineminus">-      GetSerialiserFlags(GetCharacterSet(), &amp;flowed, &amp;delsp, &amp;formatted, &amp;disallowBreaks);</span>
<a href="#l13.782"></a><span id="l13.782" class="difflineminus">-      rv = ConvertBufToPlainText(body, flowed, delsp, formatted, disallowBreaks);</span>
<a href="#l13.783"></a><span id="l13.783" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l13.784"></a><span id="l13.784" class="difflineminus">-        rv = SetBody(body);</span>
<a href="#l13.785"></a><span id="l13.785" class="difflineplus">+      GetSerialiserFlags(GetCharacterSet(), &amp;flowed, &amp;delsp, &amp;formatted,</span>
<a href="#l13.786"></a><span id="l13.786" class="difflineplus">+                         &amp;disallowBreaks);</span>
<a href="#l13.787"></a><span id="l13.787" class="difflineplus">+      rv =</span>
<a href="#l13.788"></a><span id="l13.788" class="difflineplus">+          ConvertBufToPlainText(body, flowed, delsp, formatted, disallowBreaks);</span>
<a href="#l13.789"></a><span id="l13.789" class="difflineplus">+      if (NS_SUCCEEDED(rv)) rv = SetBody(body);</span>
<a href="#l13.790"></a><span id="l13.790">     }</span>
<a href="#l13.791"></a><span id="l13.791">   }</span>
<a href="#l13.792"></a><span id="l13.792">   return rv;</span>
<a href="#l13.793"></a><span id="l13.793"> }</span>
<a href="#l13.794"></a><span id="l13.794"> </span>
<a href="#l13.795"></a><span id="l13.795" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::GetComposeSecure(nsIMsgComposeSecure ** aComposeSecure)</span>
<a href="#l13.796"></a><span id="l13.796" class="difflineminus">-{</span>
<a href="#l13.797"></a><span id="l13.797" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::GetComposeSecure(</span>
<a href="#l13.798"></a><span id="l13.798" class="difflineplus">+    nsIMsgComposeSecure **aComposeSecure) {</span>
<a href="#l13.799"></a><span id="l13.799">   NS_ENSURE_ARG_POINTER(aComposeSecure);</span>
<a href="#l13.800"></a><span id="l13.800">   NS_IF_ADDREF(*aComposeSecure = mSecureCompFields);</span>
<a href="#l13.801"></a><span id="l13.801">   return NS_OK;</span>
<a href="#l13.802"></a><span id="l13.802"> }</span>
<a href="#l13.803"></a><span id="l13.803"> </span>
<a href="#l13.804"></a><span id="l13.804" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::SetComposeSecure(nsIMsgComposeSecure * aComposeSecure)</span>
<a href="#l13.805"></a><span id="l13.805" class="difflineminus">-{</span>
<a href="#l13.806"></a><span id="l13.806" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::SetComposeSecure(</span>
<a href="#l13.807"></a><span id="l13.807" class="difflineplus">+    nsIMsgComposeSecure *aComposeSecure) {</span>
<a href="#l13.808"></a><span id="l13.808">   mSecureCompFields = aComposeSecure;</span>
<a href="#l13.809"></a><span id="l13.809">   return NS_OK;</span>
<a href="#l13.810"></a><span id="l13.810"> }</span>
<a href="#l13.811"></a><span id="l13.811"> </span>
<a href="#l13.812"></a><span id="l13.812" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::GetDefaultCharacterSet(char * *aDefaultCharacterSet)</span>
<a href="#l13.813"></a><span id="l13.813" class="difflineminus">-{</span>
<a href="#l13.814"></a><span id="l13.814" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::GetDefaultCharacterSet(</span>
<a href="#l13.815"></a><span id="l13.815" class="difflineplus">+    char **aDefaultCharacterSet) {</span>
<a href="#l13.816"></a><span id="l13.816">   NS_ENSURE_ARG_POINTER(aDefaultCharacterSet);</span>
<a href="#l13.817"></a><span id="l13.817">   *aDefaultCharacterSet = ToNewCString(m_DefaultCharacterSet);</span>
<a href="#l13.818"></a><span id="l13.818">   return *aDefaultCharacterSet ? NS_OK : NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l13.819"></a><span id="l13.819"> }</span>
<a href="#l13.820"></a><span id="l13.820"> </span>
<a href="#l13.821"></a><span id="l13.821" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::GetNeedToCheckCharset(bool *_retval)</span>
<a href="#l13.822"></a><span id="l13.822" class="difflineminus">-{</span>
<a href="#l13.823"></a><span id="l13.823" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::GetNeedToCheckCharset(bool *_retval) {</span>
<a href="#l13.824"></a><span id="l13.824">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l13.825"></a><span id="l13.825">   *_retval = m_needToCheckCharset;</span>
<a href="#l13.826"></a><span id="l13.826">   return NS_OK;</span>
<a href="#l13.827"></a><span id="l13.827"> }</span>
<a href="#l13.828"></a><span id="l13.828"> </span>
<a href="#l13.829"></a><span id="l13.829" class="difflineminus">-NS_IMETHODIMP nsMsgCompFields::SetNeedToCheckCharset(bool aCheck)</span>
<a href="#l13.830"></a><span id="l13.830" class="difflineminus">-{</span>
<a href="#l13.831"></a><span id="l13.831" class="difflineplus">+NS_IMETHODIMP nsMsgCompFields::SetNeedToCheckCharset(bool aCheck) {</span>
<a href="#l13.832"></a><span id="l13.832">   m_needToCheckCharset = aCheck;</span>
<a href="#l13.833"></a><span id="l13.833">   return NS_OK;</span>
<a href="#l13.834"></a><span id="l13.834"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompFields.h</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompFields.h</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -11,46 +11,44 @@</span>
<a href="#l14.4"></a><span id="l14.4"> #include &quot;nsIAbCard.h&quot;</span>
<a href="#l14.5"></a><span id="l14.5"> #include &quot;nsIAbDirectory.h&quot;</span>
<a href="#l14.6"></a><span id="l14.6"> #include &quot;nsTArray.h&quot;</span>
<a href="#l14.7"></a><span id="l14.7"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l14.8"></a><span id="l14.8"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l14.9"></a><span id="l14.9"> #include &quot;nsString.h&quot;</span>
<a href="#l14.10"></a><span id="l14.10"> #include &quot;nsIMsgComposeSecure.h&quot;</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-struct nsMsgRecipient</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-{</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+struct nsMsgRecipient {</span>
<a href="#l14.15"></a><span id="l14.15">   nsString mName;</span>
<a href="#l14.16"></a><span id="l14.16">   nsString mEmail;</span>
<a href="#l14.17"></a><span id="l14.17">   nsCOMPtr&lt;nsIAbCard&gt; mCard;</span>
<a href="#l14.18"></a><span id="l14.18">   nsCOMPtr&lt;nsIAbDirectory&gt; mDirectory;</span>
<a href="#l14.19"></a><span id="l14.19"> };</span>
<a href="#l14.20"></a><span id="l14.20"> </span>
<a href="#l14.21"></a><span id="l14.21"> /* Note that all the &quot;Get&quot; methods never return NULL (except in case of serious</span>
<a href="#l14.22"></a><span id="l14.22">    error, like an illegal parameter); rather, they return &quot;&quot; if things were set</span>
<a href="#l14.23"></a><span id="l14.23">    to NULL.  This makes it real handy for the callers. */</span>
<a href="#l14.24"></a><span id="l14.24"> </span>
<a href="#l14.25"></a><span id="l14.25"> class nsMsgCompFields : public nsIMsgCompFields {</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineminus">-public:</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+ public:</span>
<a href="#l14.28"></a><span id="l14.28">   nsMsgCompFields();</span>
<a href="#l14.29"></a><span id="l14.29"> </span>
<a href="#l14.30"></a><span id="l14.30">   /* this macro defines QueryInterface, AddRef and Release for this class */</span>
<a href="#l14.31"></a><span id="l14.31">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l14.32"></a><span id="l14.32">   NS_FORWARD_MSGISTRUCTUREDHEADERS(mStructuredHeaders-&gt;)</span>
<a href="#l14.33"></a><span id="l14.33">   NS_FORWARD_MSGIWRITABLESTRUCTUREDHEADERS(mStructuredHeaders-&gt;)</span>
<a href="#l14.34"></a><span id="l14.34">   NS_DECL_NSIMSGCOMPFIELDS</span>
<a href="#l14.35"></a><span id="l14.35"> </span>
<a href="#l14.36"></a><span id="l14.36">   // Allow the C++ utility methods for people who use a concrete class instead</span>
<a href="#l14.37"></a><span id="l14.37">   // of the interfaces.</span>
<a href="#l14.38"></a><span id="l14.38">   using msgIStructuredHeaders::GetAddressingHeader;</span>
<a href="#l14.39"></a><span id="l14.39">   using msgIWritableStructuredHeaders::SetAddressingHeader;</span>
<a href="#l14.40"></a><span id="l14.40"> </span>
<a href="#l14.41"></a><span id="l14.41" class="difflineminus">-  typedef enum MsgHeaderID</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineminus">-  {</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineminus">-    MSG_FROM_HEADER_ID        = 0,</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineplus">+  typedef enum MsgHeaderID {</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+    MSG_FROM_HEADER_ID = 0,</span>
<a href="#l14.46"></a><span id="l14.46">     MSG_REPLY_TO_HEADER_ID,</span>
<a href="#l14.47"></a><span id="l14.47">     MSG_TO_HEADER_ID,</span>
<a href="#l14.48"></a><span id="l14.48">     MSG_CC_HEADER_ID,</span>
<a href="#l14.49"></a><span id="l14.49">     MSG_BCC_HEADER_ID,</span>
<a href="#l14.50"></a><span id="l14.50">     MSG_FCC_HEADER_ID,</span>
<a href="#l14.51"></a><span id="l14.51">     MSG_FCC2_HEADER_ID,</span>
<a href="#l14.52"></a><span id="l14.52">     MSG_NEWSGROUPS_HEADER_ID,</span>
<a href="#l14.53"></a><span id="l14.53">     MSG_FOLLOWUP_TO_HEADER_ID,</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineat">@@ -62,114 +60,160 @@ public:</span>
<a href="#l14.55"></a><span id="l14.55">     MSG_CHARACTER_SET_HEADER_ID,</span>
<a href="#l14.56"></a><span id="l14.56">     MSG_MESSAGE_ID_HEADER_ID,</span>
<a href="#l14.57"></a><span id="l14.57">     MSG_X_TEMPLATE_HEADER_ID,</span>
<a href="#l14.58"></a><span id="l14.58">     MSG_DRAFT_ID_HEADER_ID,</span>
<a href="#l14.59"></a><span id="l14.59">     MSG_TEMPLATE_ID_HEADER_ID,</span>
<a href="#l14.60"></a><span id="l14.60">     MSG_CONTENT_LANGUAGE_ID,</span>
<a href="#l14.61"></a><span id="l14.61">     MSG_CREATOR_IDENTITY_KEY_ID,</span>
<a href="#l14.62"></a><span id="l14.62"> </span>
<a href="#l14.63"></a><span id="l14.63" class="difflineminus">-    MSG_MAX_HEADERS   //Must be the last one.</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineplus">+    MSG_MAX_HEADERS  // Must be the last one.</span>
<a href="#l14.65"></a><span id="l14.65">   } MsgHeaderID;</span>
<a href="#l14.66"></a><span id="l14.66"> </span>
<a href="#l14.67"></a><span id="l14.67" class="difflineminus">-  nsresult SetAsciiHeader(MsgHeaderID header, const char *value);</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineminus">-  const char* GetAsciiHeader(MsgHeaderID header); //just return the address of the internal header variable, don't dispose it</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineplus">+  nsresult SetAsciiHeader(MsgHeaderID header, const char* value);</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+  const char* GetAsciiHeader(</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+      MsgHeaderID header);  // just return the address of the internal header</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineplus">+                            // variable, don't dispose it</span>
<a href="#l14.73"></a><span id="l14.73"> </span>
<a href="#l14.74"></a><span id="l14.74" class="difflineminus">-  nsresult SetUnicodeHeader(MsgHeaderID header, const nsAString &amp;value);</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineminus">-  nsresult GetUnicodeHeader(MsgHeaderID header, nsAString &amp;_retval);</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineplus">+  nsresult SetUnicodeHeader(MsgHeaderID header, const nsAString&amp; value);</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineplus">+  nsresult GetUnicodeHeader(MsgHeaderID header, nsAString&amp; _retval);</span>
<a href="#l14.78"></a><span id="l14.78"> </span>
<a href="#l14.79"></a><span id="l14.79">   /* Convenience routines to get and set header's value...</span>
<a href="#l14.80"></a><span id="l14.80"> </span>
<a href="#l14.81"></a><span id="l14.81">     IMPORTANT:</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineminus">-    all routines const char* GetXxx(void) will return a pointer to the header, please don't free it.</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineplus">+    all routines const char* GetXxx(void) will return a pointer to the header,</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineplus">+    please don't free it.</span>
<a href="#l14.85"></a><span id="l14.85">   */</span>
<a href="#l14.86"></a><span id="l14.86"> </span>
<a href="#l14.87"></a><span id="l14.87" class="difflineminus">-  nsresult SetFrom(const char *value) {return SetAsciiHeader(MSG_FROM_HEADER_ID, value);}</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineminus">-  const char* GetFrom(void) {return GetAsciiHeader(MSG_FROM_HEADER_ID);}</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineplus">+  nsresult SetFrom(const char* value) {</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineplus">+    return SetAsciiHeader(MSG_FROM_HEADER_ID, value);</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineplus">+  }</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineplus">+  const char* GetFrom(void) { return GetAsciiHeader(MSG_FROM_HEADER_ID); }</span>
<a href="#l14.93"></a><span id="l14.93"> </span>
<a href="#l14.94"></a><span id="l14.94" class="difflineminus">-  nsresult SetReplyTo(const char *value) {return SetAsciiHeader(MSG_REPLY_TO_HEADER_ID, value);}</span>
<a href="#l14.95"></a><span id="l14.95" class="difflineminus">-  const char* GetReplyTo() {return GetAsciiHeader(MSG_REPLY_TO_HEADER_ID);}</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineplus">+  nsresult SetReplyTo(const char* value) {</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineplus">+    return SetAsciiHeader(MSG_REPLY_TO_HEADER_ID, value);</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineplus">+  }</span>
<a href="#l14.99"></a><span id="l14.99" class="difflineplus">+  const char* GetReplyTo() { return GetAsciiHeader(MSG_REPLY_TO_HEADER_ID); }</span>
<a href="#l14.100"></a><span id="l14.100"> </span>
<a href="#l14.101"></a><span id="l14.101" class="difflineminus">-  nsresult SetTo(const char *value) {return SetAsciiHeader(MSG_TO_HEADER_ID, value);}</span>
<a href="#l14.102"></a><span id="l14.102" class="difflineminus">-  const char* GetTo() {return GetAsciiHeader(MSG_TO_HEADER_ID);}</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineplus">+  nsresult SetTo(const char* value) {</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineplus">+    return SetAsciiHeader(MSG_TO_HEADER_ID, value);</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineplus">+  }</span>
<a href="#l14.106"></a><span id="l14.106" class="difflineplus">+  const char* GetTo() { return GetAsciiHeader(MSG_TO_HEADER_ID); }</span>
<a href="#l14.107"></a><span id="l14.107"> </span>
<a href="#l14.108"></a><span id="l14.108" class="difflineminus">-  nsresult SetCc(const char *value) {return SetAsciiHeader(MSG_CC_HEADER_ID, value);}</span>
<a href="#l14.109"></a><span id="l14.109" class="difflineminus">-  const char* GetCc() {return GetAsciiHeader(MSG_CC_HEADER_ID);}</span>
<a href="#l14.110"></a><span id="l14.110" class="difflineminus">-</span>
<a href="#l14.111"></a><span id="l14.111" class="difflineminus">-  nsresult SetBcc(const char *value) {return SetAsciiHeader(MSG_BCC_HEADER_ID, value);}</span>
<a href="#l14.112"></a><span id="l14.112" class="difflineminus">-  const char* GetBcc() {return GetAsciiHeader(MSG_BCC_HEADER_ID);}</span>
<a href="#l14.113"></a><span id="l14.113" class="difflineplus">+  nsresult SetCc(const char* value) {</span>
<a href="#l14.114"></a><span id="l14.114" class="difflineplus">+    return SetAsciiHeader(MSG_CC_HEADER_ID, value);</span>
<a href="#l14.115"></a><span id="l14.115" class="difflineplus">+  }</span>
<a href="#l14.116"></a><span id="l14.116" class="difflineplus">+  const char* GetCc() { return GetAsciiHeader(MSG_CC_HEADER_ID); }</span>
<a href="#l14.117"></a><span id="l14.117"> </span>
<a href="#l14.118"></a><span id="l14.118" class="difflineminus">-  nsresult SetFcc(const char *value) {return SetAsciiHeader(MSG_FCC_HEADER_ID, value);}</span>
<a href="#l14.119"></a><span id="l14.119" class="difflineminus">-  const char* GetFcc() {return GetAsciiHeader(MSG_FCC_HEADER_ID);}</span>
<a href="#l14.120"></a><span id="l14.120" class="difflineplus">+  nsresult SetBcc(const char* value) {</span>
<a href="#l14.121"></a><span id="l14.121" class="difflineplus">+    return SetAsciiHeader(MSG_BCC_HEADER_ID, value);</span>
<a href="#l14.122"></a><span id="l14.122" class="difflineplus">+  }</span>
<a href="#l14.123"></a><span id="l14.123" class="difflineplus">+  const char* GetBcc() { return GetAsciiHeader(MSG_BCC_HEADER_ID); }</span>
<a href="#l14.124"></a><span id="l14.124"> </span>
<a href="#l14.125"></a><span id="l14.125" class="difflineminus">-  nsresult SetFcc2(const char *value) {return SetAsciiHeader(MSG_FCC2_HEADER_ID, value);}</span>
<a href="#l14.126"></a><span id="l14.126" class="difflineminus">-  const char* GetFcc2() {return GetAsciiHeader(MSG_FCC2_HEADER_ID);}</span>
<a href="#l14.127"></a><span id="l14.127" class="difflineplus">+  nsresult SetFcc(const char* value) {</span>
<a href="#l14.128"></a><span id="l14.128" class="difflineplus">+    return SetAsciiHeader(MSG_FCC_HEADER_ID, value);</span>
<a href="#l14.129"></a><span id="l14.129" class="difflineplus">+  }</span>
<a href="#l14.130"></a><span id="l14.130" class="difflineplus">+  const char* GetFcc() { return GetAsciiHeader(MSG_FCC_HEADER_ID); }</span>
<a href="#l14.131"></a><span id="l14.131"> </span>
<a href="#l14.132"></a><span id="l14.132" class="difflineminus">-  nsresult SetNewsgroups(const char *aValue) {return SetAsciiHeader(MSG_NEWSGROUPS_HEADER_ID, aValue);}</span>
<a href="#l14.133"></a><span id="l14.133" class="difflineminus">-  const char* GetNewsgroups() {return GetAsciiHeader(MSG_NEWSGROUPS_HEADER_ID);}</span>
<a href="#l14.134"></a><span id="l14.134" class="difflineplus">+  nsresult SetFcc2(const char* value) {</span>
<a href="#l14.135"></a><span id="l14.135" class="difflineplus">+    return SetAsciiHeader(MSG_FCC2_HEADER_ID, value);</span>
<a href="#l14.136"></a><span id="l14.136" class="difflineplus">+  }</span>
<a href="#l14.137"></a><span id="l14.137" class="difflineplus">+  const char* GetFcc2() { return GetAsciiHeader(MSG_FCC2_HEADER_ID); }</span>
<a href="#l14.138"></a><span id="l14.138"> </span>
<a href="#l14.139"></a><span id="l14.139" class="difflineminus">-  nsresult SetFollowupTo(const char *aValue) {return SetAsciiHeader(MSG_FOLLOWUP_TO_HEADER_ID, aValue);}</span>
<a href="#l14.140"></a><span id="l14.140" class="difflineminus">-  const char* GetFollowupTo() {return GetAsciiHeader(MSG_FOLLOWUP_TO_HEADER_ID);}</span>
<a href="#l14.141"></a><span id="l14.141" class="difflineplus">+  nsresult SetNewsgroups(const char* aValue) {</span>
<a href="#l14.142"></a><span id="l14.142" class="difflineplus">+    return SetAsciiHeader(MSG_NEWSGROUPS_HEADER_ID, aValue);</span>
<a href="#l14.143"></a><span id="l14.143" class="difflineplus">+  }</span>
<a href="#l14.144"></a><span id="l14.144" class="difflineplus">+  const char* GetNewsgroups() {</span>
<a href="#l14.145"></a><span id="l14.145" class="difflineplus">+    return GetAsciiHeader(MSG_NEWSGROUPS_HEADER_ID);</span>
<a href="#l14.146"></a><span id="l14.146" class="difflineplus">+  }</span>
<a href="#l14.147"></a><span id="l14.147"> </span>
<a href="#l14.148"></a><span id="l14.148" class="difflineminus">-  nsresult SetSubject(const char *value) {return SetAsciiHeader(MSG_SUBJECT_HEADER_ID, value);}</span>
<a href="#l14.149"></a><span id="l14.149" class="difflineminus">-  const char* GetSubject() {return GetAsciiHeader(MSG_SUBJECT_HEADER_ID);}</span>
<a href="#l14.150"></a><span id="l14.150" class="difflineplus">+  nsresult SetFollowupTo(const char* aValue) {</span>
<a href="#l14.151"></a><span id="l14.151" class="difflineplus">+    return SetAsciiHeader(MSG_FOLLOWUP_TO_HEADER_ID, aValue);</span>
<a href="#l14.152"></a><span id="l14.152" class="difflineplus">+  }</span>
<a href="#l14.153"></a><span id="l14.153" class="difflineplus">+  const char* GetFollowupTo() {</span>
<a href="#l14.154"></a><span id="l14.154" class="difflineplus">+    return GetAsciiHeader(MSG_FOLLOWUP_TO_HEADER_ID);</span>
<a href="#l14.155"></a><span id="l14.155" class="difflineplus">+  }</span>
<a href="#l14.156"></a><span id="l14.156"> </span>
<a href="#l14.157"></a><span id="l14.157" class="difflineminus">-  nsresult SetOrganization(const char *value) {return SetAsciiHeader(MSG_ORGANIZATION_HEADER_ID, value);}</span>
<a href="#l14.158"></a><span id="l14.158" class="difflineminus">-  const char* GetOrganization() {return GetAsciiHeader(MSG_ORGANIZATION_HEADER_ID);}</span>
<a href="#l14.159"></a><span id="l14.159" class="difflineplus">+  nsresult SetSubject(const char* value) {</span>
<a href="#l14.160"></a><span id="l14.160" class="difflineplus">+    return SetAsciiHeader(MSG_SUBJECT_HEADER_ID, value);</span>
<a href="#l14.161"></a><span id="l14.161" class="difflineplus">+  }</span>
<a href="#l14.162"></a><span id="l14.162" class="difflineplus">+  const char* GetSubject() { return GetAsciiHeader(MSG_SUBJECT_HEADER_ID); }</span>
<a href="#l14.163"></a><span id="l14.163"> </span>
<a href="#l14.164"></a><span id="l14.164" class="difflineminus">-  const char* GetReferences() {return GetAsciiHeader(MSG_REFERENCES_HEADER_ID);}</span>
<a href="#l14.165"></a><span id="l14.165" class="difflineminus">-</span>
<a href="#l14.166"></a><span id="l14.166" class="difflineminus">-  const char* GetNewspostUrl() {return GetAsciiHeader(MSG_NEWSPOSTURL_HEADER_ID);}</span>
<a href="#l14.167"></a><span id="l14.167" class="difflineplus">+  nsresult SetOrganization(const char* value) {</span>
<a href="#l14.168"></a><span id="l14.168" class="difflineplus">+    return SetAsciiHeader(MSG_ORGANIZATION_HEADER_ID, value);</span>
<a href="#l14.169"></a><span id="l14.169" class="difflineplus">+  }</span>
<a href="#l14.170"></a><span id="l14.170" class="difflineplus">+  const char* GetOrganization() {</span>
<a href="#l14.171"></a><span id="l14.171" class="difflineplus">+    return GetAsciiHeader(MSG_ORGANIZATION_HEADER_ID);</span>
<a href="#l14.172"></a><span id="l14.172" class="difflineplus">+  }</span>
<a href="#l14.173"></a><span id="l14.173"> </span>
<a href="#l14.174"></a><span id="l14.174" class="difflineminus">-  const char* GetPriority() {return GetAsciiHeader(MSG_PRIORITY_HEADER_ID);}</span>
<a href="#l14.175"></a><span id="l14.175" class="difflineminus">-</span>
<a href="#l14.176"></a><span id="l14.176" class="difflineminus">-  const char* GetCharacterSet() {return GetAsciiHeader(MSG_CHARACTER_SET_HEADER_ID);}</span>
<a href="#l14.177"></a><span id="l14.177" class="difflineplus">+  const char* GetReferences() {</span>
<a href="#l14.178"></a><span id="l14.178" class="difflineplus">+    return GetAsciiHeader(MSG_REFERENCES_HEADER_ID);</span>
<a href="#l14.179"></a><span id="l14.179" class="difflineplus">+  }</span>
<a href="#l14.180"></a><span id="l14.180"> </span>
<a href="#l14.181"></a><span id="l14.181" class="difflineminus">-  const char* GetMessageId() {return GetAsciiHeader(MSG_MESSAGE_ID_HEADER_ID);}</span>
<a href="#l14.182"></a><span id="l14.182" class="difflineplus">+  const char* GetNewspostUrl() {</span>
<a href="#l14.183"></a><span id="l14.183" class="difflineplus">+    return GetAsciiHeader(MSG_NEWSPOSTURL_HEADER_ID);</span>
<a href="#l14.184"></a><span id="l14.184" class="difflineplus">+  }</span>
<a href="#l14.185"></a><span id="l14.185"> </span>
<a href="#l14.186"></a><span id="l14.186" class="difflineminus">-  nsresult SetTemplateName(const char *value) {return SetAsciiHeader(MSG_X_TEMPLATE_HEADER_ID, value);}</span>
<a href="#l14.187"></a><span id="l14.187" class="difflineminus">-  const char* GetTemplateName() {return GetAsciiHeader(MSG_X_TEMPLATE_HEADER_ID);}</span>
<a href="#l14.188"></a><span id="l14.188" class="difflineplus">+  const char* GetPriority() { return GetAsciiHeader(MSG_PRIORITY_HEADER_ID); }</span>
<a href="#l14.189"></a><span id="l14.189" class="difflineplus">+</span>
<a href="#l14.190"></a><span id="l14.190" class="difflineplus">+  const char* GetCharacterSet() {</span>
<a href="#l14.191"></a><span id="l14.191" class="difflineplus">+    return GetAsciiHeader(MSG_CHARACTER_SET_HEADER_ID);</span>
<a href="#l14.192"></a><span id="l14.192" class="difflineplus">+  }</span>
<a href="#l14.193"></a><span id="l14.193"> </span>
<a href="#l14.194"></a><span id="l14.194" class="difflineminus">-  const char* GetDraftId() {return GetAsciiHeader(MSG_DRAFT_ID_HEADER_ID);}</span>
<a href="#l14.195"></a><span id="l14.195" class="difflineminus">-  const char* GetTemplateId() {return GetAsciiHeader(MSG_TEMPLATE_ID_HEADER_ID);}</span>
<a href="#l14.196"></a><span id="l14.196" class="difflineplus">+  const char* GetMessageId() {</span>
<a href="#l14.197"></a><span id="l14.197" class="difflineplus">+    return GetAsciiHeader(MSG_MESSAGE_ID_HEADER_ID);</span>
<a href="#l14.198"></a><span id="l14.198" class="difflineplus">+  }</span>
<a href="#l14.199"></a><span id="l14.199"> </span>
<a href="#l14.200"></a><span id="l14.200" class="difflineminus">-  const char* GetContentLanguage() {return GetAsciiHeader(MSG_CONTENT_LANGUAGE_ID);}</span>
<a href="#l14.201"></a><span id="l14.201" class="difflineplus">+  nsresult SetTemplateName(const char* value) {</span>
<a href="#l14.202"></a><span id="l14.202" class="difflineplus">+    return SetAsciiHeader(MSG_X_TEMPLATE_HEADER_ID, value);</span>
<a href="#l14.203"></a><span id="l14.203" class="difflineplus">+  }</span>
<a href="#l14.204"></a><span id="l14.204" class="difflineplus">+  const char* GetTemplateName() {</span>
<a href="#l14.205"></a><span id="l14.205" class="difflineplus">+    return GetAsciiHeader(MSG_X_TEMPLATE_HEADER_ID);</span>
<a href="#l14.206"></a><span id="l14.206" class="difflineplus">+  }</span>
<a href="#l14.207"></a><span id="l14.207" class="difflineplus">+</span>
<a href="#l14.208"></a><span id="l14.208" class="difflineplus">+  const char* GetDraftId() { return GetAsciiHeader(MSG_DRAFT_ID_HEADER_ID); }</span>
<a href="#l14.209"></a><span id="l14.209" class="difflineplus">+  const char* GetTemplateId() {</span>
<a href="#l14.210"></a><span id="l14.210" class="difflineplus">+    return GetAsciiHeader(MSG_TEMPLATE_ID_HEADER_ID);</span>
<a href="#l14.211"></a><span id="l14.211" class="difflineplus">+  }</span>
<a href="#l14.212"></a><span id="l14.212"> </span>
<a href="#l14.213"></a><span id="l14.213" class="difflineminus">-  bool GetReturnReceipt() {return m_returnReceipt;}</span>
<a href="#l14.214"></a><span id="l14.214" class="difflineminus">-  bool GetDSN() {return m_DSN;}</span>
<a href="#l14.215"></a><span id="l14.215" class="difflineminus">-  bool GetAttachVCard() {return m_attachVCard;}</span>
<a href="#l14.216"></a><span id="l14.216" class="difflineminus">-  bool GetAttachmentReminder() {return m_attachmentReminder;}</span>
<a href="#l14.217"></a><span id="l14.217" class="difflineminus">-  int32_t GetDeliveryFormat() {return m_deliveryFormat;}</span>
<a href="#l14.218"></a><span id="l14.218" class="difflineminus">-  bool GetForcePlainText() {return m_forcePlainText;}</span>
<a href="#l14.219"></a><span id="l14.219" class="difflineminus">-  bool GetUseMultipartAlternative() {return m_useMultipartAlternative;}</span>
<a href="#l14.220"></a><span id="l14.220" class="difflineminus">-  bool GetBodyIsAsciiOnly() {return m_bodyIsAsciiOnly;}</span>
<a href="#l14.221"></a><span id="l14.221" class="difflineminus">-  bool GetForceMsgEncoding() {return m_forceMsgEncoding;}</span>
<a href="#l14.222"></a><span id="l14.222" class="difflineplus">+  const char* GetContentLanguage() {</span>
<a href="#l14.223"></a><span id="l14.223" class="difflineplus">+    return GetAsciiHeader(MSG_CONTENT_LANGUAGE_ID);</span>
<a href="#l14.224"></a><span id="l14.224" class="difflineplus">+  }</span>
<a href="#l14.225"></a><span id="l14.225"> </span>
<a href="#l14.226"></a><span id="l14.226" class="difflineminus">-  nsresult SetBody(const char *value);</span>
<a href="#l14.227"></a><span id="l14.227" class="difflineplus">+  bool GetReturnReceipt() { return m_returnReceipt; }</span>
<a href="#l14.228"></a><span id="l14.228" class="difflineplus">+  bool GetDSN() { return m_DSN; }</span>
<a href="#l14.229"></a><span id="l14.229" class="difflineplus">+  bool GetAttachVCard() { return m_attachVCard; }</span>
<a href="#l14.230"></a><span id="l14.230" class="difflineplus">+  bool GetAttachmentReminder() { return m_attachmentReminder; }</span>
<a href="#l14.231"></a><span id="l14.231" class="difflineplus">+  int32_t GetDeliveryFormat() { return m_deliveryFormat; }</span>
<a href="#l14.232"></a><span id="l14.232" class="difflineplus">+  bool GetForcePlainText() { return m_forcePlainText; }</span>
<a href="#l14.233"></a><span id="l14.233" class="difflineplus">+  bool GetUseMultipartAlternative() { return m_useMultipartAlternative; }</span>
<a href="#l14.234"></a><span id="l14.234" class="difflineplus">+  bool GetBodyIsAsciiOnly() { return m_bodyIsAsciiOnly; }</span>
<a href="#l14.235"></a><span id="l14.235" class="difflineplus">+  bool GetForceMsgEncoding() { return m_forceMsgEncoding; }</span>
<a href="#l14.236"></a><span id="l14.236" class="difflineplus">+</span>
<a href="#l14.237"></a><span id="l14.237" class="difflineplus">+  nsresult SetBody(const char* value);</span>
<a href="#l14.238"></a><span id="l14.238">   const char* GetBody();</span>
<a href="#l14.239"></a><span id="l14.239"> </span>
<a href="#l14.240"></a><span id="l14.240" class="difflineminus">-  nsresult SplitRecipientsEx(const nsAString &amp;recipients,</span>
<a href="#l14.241"></a><span id="l14.241" class="difflineminus">-                             nsTArray&lt;nsMsgRecipient&gt; &amp;aResult);</span>
<a href="#l14.242"></a><span id="l14.242" class="difflineplus">+  nsresult SplitRecipientsEx(const nsAString&amp; recipients,</span>
<a href="#l14.243"></a><span id="l14.243" class="difflineplus">+                             nsTArray&lt;nsMsgRecipient&gt;&amp; aResult);</span>
<a href="#l14.244"></a><span id="l14.244"> </span>
<a href="#l14.245"></a><span id="l14.245" class="difflineminus">-protected:</span>
<a href="#l14.246"></a><span id="l14.246" class="difflineplus">+ protected:</span>
<a href="#l14.247"></a><span id="l14.247">   virtual ~nsMsgCompFields();</span>
<a href="#l14.248"></a><span id="l14.248">   nsCString m_headers[MSG_MAX_HEADERS];</span>
<a href="#l14.249"></a><span id="l14.249" class="difflineminus">-  nsCString   m_body;</span>
<a href="#l14.250"></a><span id="l14.250" class="difflineplus">+  nsCString m_body;</span>
<a href="#l14.251"></a><span id="l14.251">   nsCOMArray&lt;nsIMsgAttachment&gt; m_attachments;</span>
<a href="#l14.252"></a><span id="l14.252" class="difflineminus">-  bool        m_attachVCard;</span>
<a href="#l14.253"></a><span id="l14.253" class="difflineminus">-  bool        m_attachmentReminder;</span>
<a href="#l14.254"></a><span id="l14.254" class="difflineminus">-  int32_t     m_deliveryFormat;</span>
<a href="#l14.255"></a><span id="l14.255" class="difflineminus">-  bool        m_forcePlainText;</span>
<a href="#l14.256"></a><span id="l14.256" class="difflineminus">-  bool        m_useMultipartAlternative;</span>
<a href="#l14.257"></a><span id="l14.257" class="difflineminus">-  bool        m_returnReceipt;</span>
<a href="#l14.258"></a><span id="l14.258" class="difflineminus">-  bool        m_DSN;</span>
<a href="#l14.259"></a><span id="l14.259" class="difflineminus">-  bool        m_bodyIsAsciiOnly;</span>
<a href="#l14.260"></a><span id="l14.260" class="difflineminus">-  bool        m_forceMsgEncoding;</span>
<a href="#l14.261"></a><span id="l14.261" class="difflineminus">-  int32_t     m_receiptHeaderType;        /* receipt header type */</span>
<a href="#l14.262"></a><span id="l14.262" class="difflineminus">-  nsCString   m_DefaultCharacterSet;</span>
<a href="#l14.263"></a><span id="l14.263" class="difflineminus">-  bool        m_needToCheckCharset;</span>
<a href="#l14.264"></a><span id="l14.264" class="difflineplus">+  bool m_attachVCard;</span>
<a href="#l14.265"></a><span id="l14.265" class="difflineplus">+  bool m_attachmentReminder;</span>
<a href="#l14.266"></a><span id="l14.266" class="difflineplus">+  int32_t m_deliveryFormat;</span>
<a href="#l14.267"></a><span id="l14.267" class="difflineplus">+  bool m_forcePlainText;</span>
<a href="#l14.268"></a><span id="l14.268" class="difflineplus">+  bool m_useMultipartAlternative;</span>
<a href="#l14.269"></a><span id="l14.269" class="difflineplus">+  bool m_returnReceipt;</span>
<a href="#l14.270"></a><span id="l14.270" class="difflineplus">+  bool m_DSN;</span>
<a href="#l14.271"></a><span id="l14.271" class="difflineplus">+  bool m_bodyIsAsciiOnly;</span>
<a href="#l14.272"></a><span id="l14.272" class="difflineplus">+  bool m_forceMsgEncoding;</span>
<a href="#l14.273"></a><span id="l14.273" class="difflineplus">+  int32_t m_receiptHeaderType; /* receipt header type */</span>
<a href="#l14.274"></a><span id="l14.274" class="difflineplus">+  nsCString m_DefaultCharacterSet;</span>
<a href="#l14.275"></a><span id="l14.275" class="difflineplus">+  bool m_needToCheckCharset;</span>
<a href="#l14.276"></a><span id="l14.276"> </span>
<a href="#l14.277"></a><span id="l14.277">   nsCOMPtr&lt;nsIMsgComposeSecure&gt; mSecureCompFields;</span>
<a href="#l14.278"></a><span id="l14.278">   nsCOMPtr&lt;msgIWritableStructuredHeaders&gt; mStructuredHeaders;</span>
<a href="#l14.279"></a><span id="l14.279"> };</span>
<a href="#l14.280"></a><span id="l14.280"> </span>
<a href="#l14.281"></a><span id="l14.281" class="difflineminus">-</span>
<a href="#l14.282"></a><span id="l14.282"> #endif /* _MsgCompFields_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompUtils.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompUtils.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -38,408 +38,364 @@</span>
<a href="#l15.4"></a><span id="l15.4"> #include &quot;nsIMIMEInfo.h&quot;</span>
<a href="#l15.5"></a><span id="l15.5"> #include &quot;nsIMsgHeaderParser.h&quot;</span>
<a href="#l15.6"></a><span id="l15.6"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l15.7"></a><span id="l15.7"> #include &quot;nsIRandomGenerator.h&quot;</span>
<a href="#l15.8"></a><span id="l15.8"> #include &quot;nsID.h&quot;</span>
<a href="#l15.9"></a><span id="l15.9"> </span>
<a href="#l15.10"></a><span id="l15.10"> NS_IMPL_ISUPPORTS(nsMsgCompUtils, nsIMsgCompUtils)</span>
<a href="#l15.11"></a><span id="l15.11"> </span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-nsMsgCompUtils::nsMsgCompUtils()</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-{</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineminus">-}</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+nsMsgCompUtils::nsMsgCompUtils() {}</span>
<a href="#l15.16"></a><span id="l15.16"> </span>
<a href="#l15.17"></a><span id="l15.17" class="difflineminus">-nsMsgCompUtils::~nsMsgCompUtils()</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineminus">-{</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineminus">-}</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineplus">+nsMsgCompUtils::~nsMsgCompUtils() {}</span>
<a href="#l15.21"></a><span id="l15.21"> </span>
<a href="#l15.22"></a><span id="l15.22"> NS_IMETHODIMP nsMsgCompUtils::MimeMakeSeparator(const char *prefix,</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineminus">-                                                char **_retval)</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineminus">-{</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineplus">+                                                char **_retval) {</span>
<a href="#l15.26"></a><span id="l15.26">   NS_ENSURE_ARG_POINTER(prefix);</span>
<a href="#l15.27"></a><span id="l15.27">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l15.28"></a><span id="l15.28">   *_retval = mime_make_separator(prefix);</span>
<a href="#l15.29"></a><span id="l15.29">   return NS_OK;</span>
<a href="#l15.30"></a><span id="l15.30"> }</span>
<a href="#l15.31"></a><span id="l15.31"> </span>
<a href="#l15.32"></a><span id="l15.32"> NS_IMETHODIMP nsMsgCompUtils::MsgGenerateMessageId(nsIMsgIdentity *identity,</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineminus">-                                                    char **_retval)</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineminus">-{</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineplus">+                                                   char **_retval) {</span>
<a href="#l15.36"></a><span id="l15.36">   NS_ENSURE_ARG_POINTER(identity);</span>
<a href="#l15.37"></a><span id="l15.37">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l15.38"></a><span id="l15.38">   *_retval = msg_generate_message_id(identity);</span>
<a href="#l15.39"></a><span id="l15.39">   return NS_OK;</span>
<a href="#l15.40"></a><span id="l15.40"> }</span>
<a href="#l15.41"></a><span id="l15.41"> </span>
<a href="#l15.42"></a><span id="l15.42" class="difflineminus">-NS_IMETHODIMP nsMsgCompUtils::GetMsgMimeConformToStandard(bool *_retval)</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineminus">-{</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineplus">+NS_IMETHODIMP nsMsgCompUtils::GetMsgMimeConformToStandard(bool *_retval) {</span>
<a href="#l15.45"></a><span id="l15.45">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l15.46"></a><span id="l15.46">   *_retval = nsMsgMIMEGetConformToStandard();</span>
<a href="#l15.47"></a><span id="l15.47">   return NS_OK;</span>
<a href="#l15.48"></a><span id="l15.48"> }</span>
<a href="#l15.49"></a><span id="l15.49"> </span>
<a href="#l15.50"></a><span id="l15.50"> //</span>
<a href="#l15.51"></a><span id="l15.51"> // Create a file for the a unique temp file</span>
<a href="#l15.52"></a><span id="l15.52"> // on the local machine. Caller must free memory</span>
<a href="#l15.53"></a><span id="l15.53"> //</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineminus">-nsresult</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineminus">-nsMsgCreateTempFile(const char *tFileName, nsIFile **tFile)</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineminus">-{</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineminus">-  if ((!tFileName) || (!*tFileName))</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineminus">-    tFileName = &quot;nsmail.tmp&quot;;</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineplus">+nsresult nsMsgCreateTempFile(const char *tFileName, nsIFile **tFile) {</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineplus">+  if ((!tFileName) || (!*tFileName)) tFileName = &quot;nsmail.tmp&quot;;</span>
<a href="#l15.61"></a><span id="l15.61"> </span>
<a href="#l15.62"></a><span id="l15.62" class="difflineminus">-  nsresult rv = GetSpecialDirectoryWithFileName(NS_OS_TEMP_DIR,</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineminus">-                                                tFileName,</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineminus">-                                                tFile);</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineplus">+  nsresult rv =</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineplus">+      GetSpecialDirectoryWithFileName(NS_OS_TEMP_DIR, tFileName, tFile);</span>
<a href="#l15.67"></a><span id="l15.67"> </span>
<a href="#l15.68"></a><span id="l15.68">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.69"></a><span id="l15.69"> </span>
<a href="#l15.70"></a><span id="l15.70">   rv = (*tFile)-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 00600);</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineminus">-    NS_RELEASE(*tFile);</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineplus">+  if (NS_FAILED(rv)) NS_RELEASE(*tFile);</span>
<a href="#l15.74"></a><span id="l15.74"> </span>
<a href="#l15.75"></a><span id="l15.75">   return rv;</span>
<a href="#l15.76"></a><span id="l15.76"> }</span>
<a href="#l15.77"></a><span id="l15.77"> </span>
<a href="#l15.78"></a><span id="l15.78"> // This is the value a caller will Get if they don't Set first (like MDN</span>
<a href="#l15.79"></a><span id="l15.79"> // sending a return receipt), so init to the default value of the</span>
<a href="#l15.80"></a><span id="l15.80"> // mail.strictly_mime_headers preference.</span>
<a href="#l15.81"></a><span id="l15.81"> static bool mime_headers_use_quoted_printable_p = true;</span>
<a href="#l15.82"></a><span id="l15.82"> </span>
<a href="#l15.83"></a><span id="l15.83" class="difflineminus">-bool</span>
<a href="#l15.84"></a><span id="l15.84" class="difflineminus">-nsMsgMIMEGetConformToStandard (void)</span>
<a href="#l15.85"></a><span id="l15.85" class="difflineminus">-{</span>
<a href="#l15.86"></a><span id="l15.86" class="difflineplus">+bool nsMsgMIMEGetConformToStandard(void) {</span>
<a href="#l15.87"></a><span id="l15.87">   return mime_headers_use_quoted_printable_p;</span>
<a href="#l15.88"></a><span id="l15.88"> }</span>
<a href="#l15.89"></a><span id="l15.89"> </span>
<a href="#l15.90"></a><span id="l15.90" class="difflineminus">-void</span>
<a href="#l15.91"></a><span id="l15.91" class="difflineminus">-nsMsgMIMESetConformToStandard (bool conform_p)</span>
<a href="#l15.92"></a><span id="l15.92" class="difflineminus">-{</span>
<a href="#l15.93"></a><span id="l15.93" class="difflineplus">+void nsMsgMIMESetConformToStandard(bool conform_p) {</span>
<a href="#l15.94"></a><span id="l15.94">   /*</span>
<a href="#l15.95"></a><span id="l15.95" class="difflineminus">-  * If we are conforming to mime standard no matter what we set</span>
<a href="#l15.96"></a><span id="l15.96" class="difflineminus">-  * for the headers preference when generating mime headers we should</span>
<a href="#l15.97"></a><span id="l15.97" class="difflineminus">-  * also conform to the standard. Otherwise, depends the preference</span>
<a href="#l15.98"></a><span id="l15.98" class="difflineminus">-  * we set. For now, the headers preference is not accessible from UI.</span>
<a href="#l15.99"></a><span id="l15.99" class="difflineminus">-  */</span>
<a href="#l15.100"></a><span id="l15.100" class="difflineplus">+   * If we are conforming to mime standard no matter what we set</span>
<a href="#l15.101"></a><span id="l15.101" class="difflineplus">+   * for the headers preference when generating mime headers we should</span>
<a href="#l15.102"></a><span id="l15.102" class="difflineplus">+   * also conform to the standard. Otherwise, depends the preference</span>
<a href="#l15.103"></a><span id="l15.103" class="difflineplus">+   * we set. For now, the headers preference is not accessible from UI.</span>
<a href="#l15.104"></a><span id="l15.104" class="difflineplus">+   */</span>
<a href="#l15.105"></a><span id="l15.105">   if (conform_p)</span>
<a href="#l15.106"></a><span id="l15.106">     mime_headers_use_quoted_printable_p = true;</span>
<a href="#l15.107"></a><span id="l15.107">   else {</span>
<a href="#l15.108"></a><span id="l15.108">     nsresult rv;</span>
<a href="#l15.109"></a><span id="l15.109" class="difflineminus">-    nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l15.110"></a><span id="l15.110" class="difflineplus">+    nsCOMPtr&lt;nsIPrefBranch&gt; prefs(</span>
<a href="#l15.111"></a><span id="l15.111" class="difflineplus">+        do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l15.112"></a><span id="l15.112">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l15.113"></a><span id="l15.113" class="difflineminus">-      prefs-&gt;GetBoolPref(&quot;mail.strictly_mime_headers&quot;, &amp;mime_headers_use_quoted_printable_p);</span>
<a href="#l15.114"></a><span id="l15.114" class="difflineplus">+      prefs-&gt;GetBoolPref(&quot;mail.strictly_mime_headers&quot;,</span>
<a href="#l15.115"></a><span id="l15.115" class="difflineplus">+                         &amp;mime_headers_use_quoted_printable_p);</span>
<a href="#l15.116"></a><span id="l15.116">     }</span>
<a href="#l15.117"></a><span id="l15.117">   }</span>
<a href="#l15.118"></a><span id="l15.118"> }</span>
<a href="#l15.119"></a><span id="l15.119"> </span>
<a href="#l15.120"></a><span id="l15.120"> /**</span>
<a href="#l15.121"></a><span id="l15.121">  * Checks if the recipient fields have sane values for message send.</span>
<a href="#l15.122"></a><span id="l15.122">  */</span>
<a href="#l15.123"></a><span id="l15.123" class="difflineminus">-nsresult mime_sanity_check_fields_recipients (</span>
<a href="#l15.124"></a><span id="l15.124" class="difflineminus">-          const char *to,</span>
<a href="#l15.125"></a><span id="l15.125" class="difflineminus">-          const char *cc,</span>
<a href="#l15.126"></a><span id="l15.126" class="difflineminus">-          const char *bcc,</span>
<a href="#l15.127"></a><span id="l15.127" class="difflineminus">-          const char *newsgroups)</span>
<a href="#l15.128"></a><span id="l15.128" class="difflineminus">-{</span>
<a href="#l15.129"></a><span id="l15.129" class="difflineplus">+nsresult mime_sanity_check_fields_recipients(const char *to, const char *cc,</span>
<a href="#l15.130"></a><span id="l15.130" class="difflineplus">+                                             const char *bcc,</span>
<a href="#l15.131"></a><span id="l15.131" class="difflineplus">+                                             const char *newsgroups) {</span>
<a href="#l15.132"></a><span id="l15.132">   if (to)</span>
<a href="#l15.133"></a><span id="l15.133" class="difflineminus">-    while (IS_SPACE(*to))</span>
<a href="#l15.134"></a><span id="l15.134" class="difflineminus">-      to++;</span>
<a href="#l15.135"></a><span id="l15.135" class="difflineplus">+    while (IS_SPACE(*to)) to++;</span>
<a href="#l15.136"></a><span id="l15.136">   if (cc)</span>
<a href="#l15.137"></a><span id="l15.137" class="difflineminus">-    while (IS_SPACE(*cc))</span>
<a href="#l15.138"></a><span id="l15.138" class="difflineminus">-      cc++;</span>
<a href="#l15.139"></a><span id="l15.139" class="difflineplus">+    while (IS_SPACE(*cc)) cc++;</span>
<a href="#l15.140"></a><span id="l15.140">   if (bcc)</span>
<a href="#l15.141"></a><span id="l15.141" class="difflineminus">-    while (IS_SPACE(*bcc))</span>
<a href="#l15.142"></a><span id="l15.142" class="difflineminus">-      bcc++;</span>
<a href="#l15.143"></a><span id="l15.143" class="difflineplus">+    while (IS_SPACE(*bcc)) bcc++;</span>
<a href="#l15.144"></a><span id="l15.144">   if (newsgroups)</span>
<a href="#l15.145"></a><span id="l15.145" class="difflineminus">-    while (IS_SPACE(*newsgroups))</span>
<a href="#l15.146"></a><span id="l15.146" class="difflineminus">-      newsgroups++;</span>
<a href="#l15.147"></a><span id="l15.147" class="difflineplus">+    while (IS_SPACE(*newsgroups)) newsgroups++;</span>
<a href="#l15.148"></a><span id="l15.148"> </span>
<a href="#l15.149"></a><span id="l15.149" class="difflineminus">-  if ((!to || !*to) &amp;&amp; (!cc || !*cc) &amp;&amp;</span>
<a href="#l15.150"></a><span id="l15.150" class="difflineminus">-      (!bcc || !*bcc) &amp;&amp; (!newsgroups || !*newsgroups))</span>
<a href="#l15.151"></a><span id="l15.151" class="difflineplus">+  if ((!to || !*to) &amp;&amp; (!cc || !*cc) &amp;&amp; (!bcc || !*bcc) &amp;&amp;</span>
<a href="#l15.152"></a><span id="l15.152" class="difflineplus">+      (!newsgroups || !*newsgroups))</span>
<a href="#l15.153"></a><span id="l15.153">     return NS_MSG_NO_RECIPIENTS;</span>
<a href="#l15.154"></a><span id="l15.154"> </span>
<a href="#l15.155"></a><span id="l15.155">   return NS_OK;</span>
<a href="#l15.156"></a><span id="l15.156"> }</span>
<a href="#l15.157"></a><span id="l15.157"> </span>
<a href="#l15.158"></a><span id="l15.158"> /**</span>
<a href="#l15.159"></a><span id="l15.159">  * Checks if the compose fields have sane values for message send.</span>
<a href="#l15.160"></a><span id="l15.160">  */</span>
<a href="#l15.161"></a><span id="l15.161" class="difflineminus">-nsresult mime_sanity_check_fields (</span>
<a href="#l15.162"></a><span id="l15.162" class="difflineminus">-          const char *from,</span>
<a href="#l15.163"></a><span id="l15.163" class="difflineminus">-          const char *reply_to,</span>
<a href="#l15.164"></a><span id="l15.164" class="difflineminus">-          const char *to,</span>
<a href="#l15.165"></a><span id="l15.165" class="difflineminus">-          const char *cc,</span>
<a href="#l15.166"></a><span id="l15.166" class="difflineminus">-          const char *bcc,</span>
<a href="#l15.167"></a><span id="l15.167" class="difflineminus">-          const char *fcc,</span>
<a href="#l15.168"></a><span id="l15.168" class="difflineminus">-          const char *newsgroups,</span>
<a href="#l15.169"></a><span id="l15.169" class="difflineminus">-          const char *followup_to,</span>
<a href="#l15.170"></a><span id="l15.170" class="difflineminus">-          const char * /*subject*/,</span>
<a href="#l15.171"></a><span id="l15.171" class="difflineminus">-          const char * /*references*/,</span>
<a href="#l15.172"></a><span id="l15.172" class="difflineminus">-          const char * /*organization*/,</span>
<a href="#l15.173"></a><span id="l15.173" class="difflineminus">-          const char * /*other_random_headers*/)</span>
<a href="#l15.174"></a><span id="l15.174" class="difflineminus">-{</span>
<a href="#l15.175"></a><span id="l15.175" class="difflineplus">+nsresult mime_sanity_check_fields(</span>
<a href="#l15.176"></a><span id="l15.176" class="difflineplus">+    const char *from, const char *reply_to, const char *to, const char *cc,</span>
<a href="#l15.177"></a><span id="l15.177" class="difflineplus">+    const char *bcc, const char *fcc, const char *newsgroups,</span>
<a href="#l15.178"></a><span id="l15.178" class="difflineplus">+    const char *followup_to, const char * /*subject*/,</span>
<a href="#l15.179"></a><span id="l15.179" class="difflineplus">+    const char * /*references*/, const char * /*organization*/,</span>
<a href="#l15.180"></a><span id="l15.180" class="difflineplus">+    const char * /*other_random_headers*/) {</span>
<a href="#l15.181"></a><span id="l15.181">   if (from)</span>
<a href="#l15.182"></a><span id="l15.182" class="difflineminus">-    while (IS_SPACE(*from))</span>
<a href="#l15.183"></a><span id="l15.183" class="difflineminus">-      from++;</span>
<a href="#l15.184"></a><span id="l15.184" class="difflineplus">+    while (IS_SPACE(*from)) from++;</span>
<a href="#l15.185"></a><span id="l15.185">   if (reply_to)</span>
<a href="#l15.186"></a><span id="l15.186" class="difflineminus">-    while (IS_SPACE(*reply_to))</span>
<a href="#l15.187"></a><span id="l15.187" class="difflineminus">-      reply_to++;</span>
<a href="#l15.188"></a><span id="l15.188" class="difflineplus">+    while (IS_SPACE(*reply_to)) reply_to++;</span>
<a href="#l15.189"></a><span id="l15.189">   if (fcc)</span>
<a href="#l15.190"></a><span id="l15.190" class="difflineminus">-    while (IS_SPACE(*fcc))</span>
<a href="#l15.191"></a><span id="l15.191" class="difflineminus">-      fcc++;</span>
<a href="#l15.192"></a><span id="l15.192" class="difflineplus">+    while (IS_SPACE(*fcc)) fcc++;</span>
<a href="#l15.193"></a><span id="l15.193">   if (followup_to)</span>
<a href="#l15.194"></a><span id="l15.194" class="difflineminus">-    while (IS_SPACE(*followup_to))</span>
<a href="#l15.195"></a><span id="l15.195" class="difflineminus">-      followup_to++;</span>
<a href="#l15.196"></a><span id="l15.196" class="difflineplus">+    while (IS_SPACE(*followup_to)) followup_to++;</span>
<a href="#l15.197"></a><span id="l15.197"> </span>
<a href="#l15.198"></a><span id="l15.198">   // TODO: sanity check other_random_headers for newline conventions</span>
<a href="#l15.199"></a><span id="l15.199" class="difflineminus">-  if (!from || !*from)</span>
<a href="#l15.200"></a><span id="l15.200" class="difflineminus">-    return NS_MSG_NO_SENDER;</span>
<a href="#l15.201"></a><span id="l15.201" class="difflineplus">+  if (!from || !*from) return NS_MSG_NO_SENDER;</span>
<a href="#l15.202"></a><span id="l15.202"> </span>
<a href="#l15.203"></a><span id="l15.203">   return mime_sanity_check_fields_recipients(to, cc, bcc, newsgroups);</span>
<a href="#l15.204"></a><span id="l15.204"> }</span>
<a href="#l15.205"></a><span id="l15.205"> </span>
<a href="#l15.206"></a><span id="l15.206"> //</span>
<a href="#l15.207"></a><span id="l15.207"> // Generate the message headers for the new RFC822 message</span>
<a href="#l15.208"></a><span id="l15.208"> //</span>
<a href="#l15.209"></a><span id="l15.209"> #define UA_PREF_PREFIX &quot;general.useragent.&quot;</span>
<a href="#l15.210"></a><span id="l15.210"> </span>
<a href="#l15.211"></a><span id="l15.211"> // Helper macro for generating the X-Mozilla-Draft-Info header.</span>
<a href="#l15.212"></a><span id="l15.212" class="difflineminus">-#define APPEND_BOOL(method, param) \</span>
<a href="#l15.213"></a><span id="l15.213" class="difflineminus">-    do { \</span>
<a href="#l15.214"></a><span id="l15.214" class="difflineminus">-      bool val = false; \</span>
<a href="#l15.215"></a><span id="l15.215" class="difflineminus">-      fields-&gt;Get##method(&amp;val); \</span>
<a href="#l15.216"></a><span id="l15.216" class="difflineminus">-      if (val) \</span>
<a href="#l15.217"></a><span id="l15.217" class="difflineminus">-        draftInfo.AppendLiteral(param &quot;=1&quot;); \</span>
<a href="#l15.218"></a><span id="l15.218" class="difflineminus">-      else \</span>
<a href="#l15.219"></a><span id="l15.219" class="difflineminus">-        draftInfo.AppendLiteral(param &quot;=0&quot;); \</span>
<a href="#l15.220"></a><span id="l15.220" class="difflineminus">-    } while (false)</span>
<a href="#l15.221"></a><span id="l15.221" class="difflineplus">+#define APPEND_BOOL(method, param)         \</span>
<a href="#l15.222"></a><span id="l15.222" class="difflineplus">+  do {                                     \</span>
<a href="#l15.223"></a><span id="l15.223" class="difflineplus">+    bool val = false;                      \</span>
<a href="#l15.224"></a><span id="l15.224" class="difflineplus">+    fields-&gt;Get##method(&amp;val);             \</span>
<a href="#l15.225"></a><span id="l15.225" class="difflineplus">+    if (val)                               \</span>
<a href="#l15.226"></a><span id="l15.226" class="difflineplus">+      draftInfo.AppendLiteral(param &quot;=1&quot;); \</span>
<a href="#l15.227"></a><span id="l15.227" class="difflineplus">+    else                                   \</span>
<a href="#l15.228"></a><span id="l15.228" class="difflineplus">+      draftInfo.AppendLiteral(param &quot;=0&quot;); \</span>
<a href="#l15.229"></a><span id="l15.229" class="difflineplus">+  } while (false)</span>
<a href="#l15.230"></a><span id="l15.230"> </span>
<a href="#l15.231"></a><span id="l15.231"> nsresult mime_generate_headers(nsIMsgCompFields *fields,</span>
<a href="#l15.232"></a><span id="l15.232">                                nsMsgDeliverMode deliver_mode,</span>
<a href="#l15.233"></a><span id="l15.233" class="difflineminus">-                               msgIWritableStructuredHeaders *finalHeaders)</span>
<a href="#l15.234"></a><span id="l15.234" class="difflineminus">-{</span>
<a href="#l15.235"></a><span id="l15.235" class="difflineplus">+                               msgIWritableStructuredHeaders *finalHeaders) {</span>
<a href="#l15.236"></a><span id="l15.236">   nsresult rv = NS_OK;</span>
<a href="#l15.237"></a><span id="l15.237"> </span>
<a href="#l15.238"></a><span id="l15.238">   nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l15.239"></a><span id="l15.239">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.240"></a><span id="l15.240"> </span>
<a href="#l15.241"></a><span id="l15.241" class="difflineminus">-  bool isDraft =</span>
<a href="#l15.242"></a><span id="l15.242" class="difflineminus">-    deliver_mode == nsIMsgSend::nsMsgSaveAsDraft ||</span>
<a href="#l15.243"></a><span id="l15.243" class="difflineminus">-    deliver_mode == nsIMsgSend::nsMsgSaveAsTemplate ||</span>
<a href="#l15.244"></a><span id="l15.244" class="difflineminus">-    deliver_mode == nsIMsgSend::nsMsgQueueForLater ||</span>
<a href="#l15.245"></a><span id="l15.245" class="difflineminus">-    deliver_mode == nsIMsgSend::nsMsgDeliverBackground;</span>
<a href="#l15.246"></a><span id="l15.246" class="difflineplus">+  bool isDraft = deliver_mode == nsIMsgSend::nsMsgSaveAsDraft ||</span>
<a href="#l15.247"></a><span id="l15.247" class="difflineplus">+                 deliver_mode == nsIMsgSend::nsMsgSaveAsTemplate ||</span>
<a href="#l15.248"></a><span id="l15.248" class="difflineplus">+                 deliver_mode == nsIMsgSend::nsMsgQueueForLater ||</span>
<a href="#l15.249"></a><span id="l15.249" class="difflineplus">+                 deliver_mode == nsIMsgSend::nsMsgDeliverBackground;</span>
<a href="#l15.250"></a><span id="l15.250"> </span>
<a href="#l15.251"></a><span id="l15.251">   bool hasDisclosedRecipient = false;</span>
<a href="#l15.252"></a><span id="l15.252"> </span>
<a href="#l15.253"></a><span id="l15.253">   MOZ_ASSERT(fields, &quot;null fields&quot;);</span>
<a href="#l15.254"></a><span id="l15.254">   NS_ENSURE_ARG_POINTER(fields);</span>
<a href="#l15.255"></a><span id="l15.255"> </span>
<a href="#l15.256"></a><span id="l15.256">   nsCOMArray&lt;msgIAddressObject&gt; from;</span>
<a href="#l15.257"></a><span id="l15.257">   fields-&gt;GetAddressingHeader(&quot;From&quot;, from, true);</span>
<a href="#l15.258"></a><span id="l15.258"> </span>
<a href="#l15.259"></a><span id="l15.259">   // Copy all headers from the original compose field.</span>
<a href="#l15.260"></a><span id="l15.260">   rv = finalHeaders-&gt;AddAllHeaders(fields);</span>
<a href="#l15.261"></a><span id="l15.261">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.262"></a><span id="l15.262"> </span>
<a href="#l15.263"></a><span id="l15.263">   bool hasMessageId = false;</span>
<a href="#l15.264"></a><span id="l15.264">   if (NS_SUCCEEDED(fields-&gt;HasHeader(&quot;Message-ID&quot;, &amp;hasMessageId)) &amp;&amp;</span>
<a href="#l15.265"></a><span id="l15.265" class="difflineminus">-      hasMessageId)</span>
<a href="#l15.266"></a><span id="l15.266" class="difflineminus">-  {</span>
<a href="#l15.267"></a><span id="l15.267" class="difflineplus">+      hasMessageId) {</span>
<a href="#l15.268"></a><span id="l15.268">     /* MDN request header requires to have MessageID header presented</span>
<a href="#l15.269"></a><span id="l15.269" class="difflineminus">-    * in the message in order to</span>
<a href="#l15.270"></a><span id="l15.270" class="difflineminus">-    * coorelate the MDN reports to the original message. Here will be</span>
<a href="#l15.271"></a><span id="l15.271" class="difflineminus">-    * the right place</span>
<a href="#l15.272"></a><span id="l15.272" class="difflineminus">-    */</span>
<a href="#l15.273"></a><span id="l15.273" class="difflineplus">+     * in the message in order to</span>
<a href="#l15.274"></a><span id="l15.274" class="difflineplus">+     * coorelate the MDN reports to the original message. Here will be</span>
<a href="#l15.275"></a><span id="l15.275" class="difflineplus">+     * the right place</span>
<a href="#l15.276"></a><span id="l15.276" class="difflineplus">+     */</span>
<a href="#l15.277"></a><span id="l15.277"> </span>
<a href="#l15.278"></a><span id="l15.278">     bool returnReceipt = false;</span>
<a href="#l15.279"></a><span id="l15.279">     fields-&gt;GetReturnReceipt(&amp;returnReceipt);</span>
<a href="#l15.280"></a><span id="l15.280" class="difflineminus">-    if (returnReceipt &amp;&amp;</span>
<a href="#l15.281"></a><span id="l15.281" class="difflineminus">-      (deliver_mode != nsIMsgSend::nsMsgSaveAsDraft &amp;&amp;</span>
<a href="#l15.282"></a><span id="l15.282" class="difflineminus">-      deliver_mode != nsIMsgSend::nsMsgSaveAsTemplate))</span>
<a href="#l15.283"></a><span id="l15.283" class="difflineminus">-    {</span>
<a href="#l15.284"></a><span id="l15.284" class="difflineplus">+    if (returnReceipt &amp;&amp; (deliver_mode != nsIMsgSend::nsMsgSaveAsDraft &amp;&amp;</span>
<a href="#l15.285"></a><span id="l15.285" class="difflineplus">+                          deliver_mode != nsIMsgSend::nsMsgSaveAsTemplate)) {</span>
<a href="#l15.286"></a><span id="l15.286">       int32_t receipt_header_type = nsIMsgMdnGenerator::eDntType;</span>
<a href="#l15.287"></a><span id="l15.287">       fields-&gt;GetReceiptHeaderType(&amp;receipt_header_type);</span>
<a href="#l15.288"></a><span id="l15.288"> </span>
<a href="#l15.289"></a><span id="l15.289">       // nsIMsgMdnGenerator::eDntType = MDN Disposition-Notification-To: ;</span>
<a href="#l15.290"></a><span id="l15.290">       // nsIMsgMdnGenerator::eRrtType = Return-Receipt-To: ;</span>
<a href="#l15.291"></a><span id="l15.291">       // nsIMsgMdnGenerator::eDntRrtType = both MDN DNT and RRT headers .</span>
<a href="#l15.292"></a><span id="l15.292">       if (receipt_header_type != nsIMsgMdnGenerator::eRrtType)</span>
<a href="#l15.293"></a><span id="l15.293">         finalHeaders-&gt;SetAddressingHeader(&quot;Disposition-Notification-To&quot;, from);</span>
<a href="#l15.294"></a><span id="l15.294">       if (receipt_header_type != nsIMsgMdnGenerator::eDntType)</span>
<a href="#l15.295"></a><span id="l15.295">         finalHeaders-&gt;SetAddressingHeader(&quot;Return-Receipt-To&quot;, from);</span>
<a href="#l15.296"></a><span id="l15.296">     }</span>
<a href="#l15.297"></a><span id="l15.297">   }</span>
<a href="#l15.298"></a><span id="l15.298"> </span>
<a href="#l15.299"></a><span id="l15.299">   PRExplodedTime now;</span>
<a href="#l15.300"></a><span id="l15.300">   PR_ExplodeTime(PR_Now(), PR_LocalTimeParameters, &amp;now);</span>
<a href="#l15.301"></a><span id="l15.301" class="difflineminus">-  int gmtoffset = (now.tm_params.tp_gmt_offset + now.tm_params.tp_dst_offset) / 60;</span>
<a href="#l15.302"></a><span id="l15.302" class="difflineplus">+  int gmtoffset =</span>
<a href="#l15.303"></a><span id="l15.303" class="difflineplus">+      (now.tm_params.tp_gmt_offset + now.tm_params.tp_dst_offset) / 60;</span>
<a href="#l15.304"></a><span id="l15.304"> </span>
<a href="#l15.305"></a><span id="l15.305">   /* Use PR_FormatTimeUSEnglish() to format the date in US English format,</span>
<a href="#l15.306"></a><span id="l15.306">      then figure out what our local GMT offset is, and append it (since</span>
<a href="#l15.307"></a><span id="l15.307">      PR_FormatTimeUSEnglish() can't do that.) Generate four digit years as</span>
<a href="#l15.308"></a><span id="l15.308">      per RFC 1123 (superseding RFC 822.)</span>
<a href="#l15.309"></a><span id="l15.309">    */</span>
<a href="#l15.310"></a><span id="l15.310">   char dateString[130];</span>
<a href="#l15.311"></a><span id="l15.311">   PR_FormatTimeUSEnglish(dateString, sizeof(dateString),</span>
<a href="#l15.312"></a><span id="l15.312" class="difflineminus">-               &quot;%a, %d %b %Y %H:%M:%S &quot;,</span>
<a href="#l15.313"></a><span id="l15.313" class="difflineminus">-               &amp;now);</span>
<a href="#l15.314"></a><span id="l15.314" class="difflineplus">+                         &quot;%a, %d %b %Y %H:%M:%S &quot;, &amp;now);</span>
<a href="#l15.315"></a><span id="l15.315"> </span>
<a href="#l15.316"></a><span id="l15.316">   char *entryPoint = dateString + strlen(dateString);</span>
<a href="#l15.317"></a><span id="l15.317">   PR_snprintf(entryPoint, sizeof(dateString) - (entryPoint - dateString),</span>
<a href="#l15.318"></a><span id="l15.318" class="difflineminus">-        &quot;%c%02d%02d&quot; CRLF,</span>
<a href="#l15.319"></a><span id="l15.319" class="difflineminus">-        (gmtoffset &gt;= 0 ? '+' : '-'),</span>
<a href="#l15.320"></a><span id="l15.320" class="difflineminus">-        ((gmtoffset &gt;= 0 ? gmtoffset : -gmtoffset) / 60),</span>
<a href="#l15.321"></a><span id="l15.321" class="difflineminus">-        ((gmtoffset &gt;= 0 ? gmtoffset : -gmtoffset) % 60));</span>
<a href="#l15.322"></a><span id="l15.322" class="difflineplus">+              &quot;%c%02d%02d&quot; CRLF, (gmtoffset &gt;= 0 ? '+' : '-'),</span>
<a href="#l15.323"></a><span id="l15.323" class="difflineplus">+              ((gmtoffset &gt;= 0 ? gmtoffset : -gmtoffset) / 60),</span>
<a href="#l15.324"></a><span id="l15.324" class="difflineplus">+              ((gmtoffset &gt;= 0 ? gmtoffset : -gmtoffset) % 60));</span>
<a href="#l15.325"></a><span id="l15.325">   finalHeaders-&gt;SetRawHeader(&quot;Date&quot;, nsDependentCString(dateString), nullptr);</span>
<a href="#l15.326"></a><span id="l15.326"> </span>
<a href="#l15.327"></a><span id="l15.327">   // X-Mozilla-Draft-Info</span>
<a href="#l15.328"></a><span id="l15.328" class="difflineminus">-  if (isDraft)</span>
<a href="#l15.329"></a><span id="l15.329" class="difflineminus">-  {</span>
<a href="#l15.330"></a><span id="l15.330" class="difflineplus">+  if (isDraft) {</span>
<a href="#l15.331"></a><span id="l15.331">     nsAutoCString draftInfo;</span>
<a href="#l15.332"></a><span id="l15.332">     draftInfo.AppendLiteral(&quot;internal/draft; &quot;);</span>
<a href="#l15.333"></a><span id="l15.333">     APPEND_BOOL(AttachVCard, &quot;vcard&quot;);</span>
<a href="#l15.334"></a><span id="l15.334">     draftInfo.AppendLiteral(&quot;; &quot;);</span>
<a href="#l15.335"></a><span id="l15.335">     bool hasReturnReceipt = false;</span>
<a href="#l15.336"></a><span id="l15.336">     fields-&gt;GetReturnReceipt(&amp;hasReturnReceipt);</span>
<a href="#l15.337"></a><span id="l15.337" class="difflineminus">-    if (hasReturnReceipt)</span>
<a href="#l15.338"></a><span id="l15.338" class="difflineminus">-    {</span>
<a href="#l15.339"></a><span id="l15.339" class="difflineplus">+    if (hasReturnReceipt) {</span>
<a href="#l15.340"></a><span id="l15.340">       // slight change compared to 4.x; we used to use receipt= to tell</span>
<a href="#l15.341"></a><span id="l15.341">       // whether the draft/template has request for either MDN or DNS or both</span>
<a href="#l15.342"></a><span id="l15.342">       // return receipt; since the DNS is out of the picture we now use the</span>
<a href="#l15.343"></a><span id="l15.343">       // header type + 1 to tell whether user has requested the return receipt</span>
<a href="#l15.344"></a><span id="l15.344">       int32_t headerType = 0;</span>
<a href="#l15.345"></a><span id="l15.345">       fields-&gt;GetReceiptHeaderType(&amp;headerType);</span>
<a href="#l15.346"></a><span id="l15.346">       draftInfo.AppendLiteral(&quot;receipt=&quot;);</span>
<a href="#l15.347"></a><span id="l15.347">       draftInfo.AppendInt(headerType + 1);</span>
<a href="#l15.348"></a><span id="l15.348" class="difflineminus">-    }</span>
<a href="#l15.349"></a><span id="l15.349" class="difflineminus">-    else</span>
<a href="#l15.350"></a><span id="l15.350" class="difflineplus">+    } else</span>
<a href="#l15.351"></a><span id="l15.351">       draftInfo.AppendLiteral(&quot;receipt=0&quot;);</span>
<a href="#l15.352"></a><span id="l15.352">     draftInfo.AppendLiteral(&quot;; &quot;);</span>
<a href="#l15.353"></a><span id="l15.353">     APPEND_BOOL(DSN, &quot;DSN&quot;);</span>
<a href="#l15.354"></a><span id="l15.354">     draftInfo.AppendLiteral(&quot;; &quot;);</span>
<a href="#l15.355"></a><span id="l15.355">     draftInfo.AppendLiteral(&quot;uuencode=0&quot;);</span>
<a href="#l15.356"></a><span id="l15.356">     draftInfo.AppendLiteral(&quot;; &quot;);</span>
<a href="#l15.357"></a><span id="l15.357">     APPEND_BOOL(AttachmentReminder, &quot;attachmentreminder&quot;);</span>
<a href="#l15.358"></a><span id="l15.358">     draftInfo.AppendLiteral(&quot;; &quot;);</span>
<a href="#l15.359"></a><span id="l15.359">     int32_t deliveryFormat;</span>
<a href="#l15.360"></a><span id="l15.360">     fields-&gt;GetDeliveryFormat(&amp;deliveryFormat);</span>
<a href="#l15.361"></a><span id="l15.361">     draftInfo.AppendLiteral(&quot;deliveryformat=&quot;);</span>
<a href="#l15.362"></a><span id="l15.362">     draftInfo.AppendInt(deliveryFormat);</span>
<a href="#l15.363"></a><span id="l15.363"> </span>
<a href="#l15.364"></a><span id="l15.364">     finalHeaders-&gt;SetRawHeader(HEADER_X_MOZILLA_DRAFT_INFO, draftInfo, nullptr);</span>
<a href="#l15.365"></a><span id="l15.365">   }</span>
<a href="#l15.366"></a><span id="l15.366"> </span>
<a href="#l15.367"></a><span id="l15.367" class="difflineminus">-  nsCOMPtr&lt;nsIHttpProtocolHandler&gt; pHTTPHandler = do_GetService(NS_NETWORK_PROTOCOL_CONTRACTID_PREFIX &quot;http&quot;, &amp;rv);</span>
<a href="#l15.368"></a><span id="l15.368" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; pHTTPHandler)</span>
<a href="#l15.369"></a><span id="l15.369" class="difflineminus">-  {</span>
<a href="#l15.370"></a><span id="l15.370" class="difflineplus">+  nsCOMPtr&lt;nsIHttpProtocolHandler&gt; pHTTPHandler =</span>
<a href="#l15.371"></a><span id="l15.371" class="difflineplus">+      do_GetService(NS_NETWORK_PROTOCOL_CONTRACTID_PREFIX &quot;http&quot;, &amp;rv);</span>
<a href="#l15.372"></a><span id="l15.372" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; pHTTPHandler) {</span>
<a href="#l15.373"></a><span id="l15.373">     nsAutoCString userAgentString;</span>
<a href="#l15.374"></a><span id="l15.374">     // Ignore error since we're testing the return value.</span>
<a href="#l15.375"></a><span id="l15.375">     mozilla::Unused &lt;&lt; pHTTPHandler-&gt;GetUserAgent(userAgentString);</span>
<a href="#l15.376"></a><span id="l15.376"> </span>
<a href="#l15.377"></a><span id="l15.377">     if (!userAgentString.IsEmpty())</span>
<a href="#l15.378"></a><span id="l15.378" class="difflineminus">-      finalHeaders-&gt;SetUnstructuredHeader(&quot;User-Agent&quot;,</span>
<a href="#l15.379"></a><span id="l15.379" class="difflineminus">-        NS_ConvertUTF8toUTF16(userAgentString));</span>
<a href="#l15.380"></a><span id="l15.380" class="difflineplus">+      finalHeaders-&gt;SetUnstructuredHeader(</span>
<a href="#l15.381"></a><span id="l15.381" class="difflineplus">+          &quot;User-Agent&quot;, NS_ConvertUTF8toUTF16(userAgentString));</span>
<a href="#l15.382"></a><span id="l15.382">   }</span>
<a href="#l15.383"></a><span id="l15.383"> </span>
<a href="#l15.384"></a><span id="l15.384">   finalHeaders-&gt;SetUnstructuredHeader(&quot;MIME-Version&quot;, NS_LITERAL_STRING(&quot;1.0&quot;));</span>
<a href="#l15.385"></a><span id="l15.385"> </span>
<a href="#l15.386"></a><span id="l15.386">   nsAutoCString newsgroups;</span>
<a href="#l15.387"></a><span id="l15.387">   finalHeaders-&gt;GetRawHeader(&quot;Newsgroups&quot;, newsgroups);</span>
<a href="#l15.388"></a><span id="l15.388" class="difflineminus">-  if (!newsgroups.IsEmpty())</span>
<a href="#l15.389"></a><span id="l15.389" class="difflineminus">-  {</span>
<a href="#l15.390"></a><span id="l15.390" class="difflineplus">+  if (!newsgroups.IsEmpty()) {</span>
<a href="#l15.391"></a><span id="l15.391">     // Since the newsgroup header can contain data in the form of:</span>
<a href="#l15.392"></a><span id="l15.392">     // &quot;news://news.mozilla.org/netscape.test,news://news.mozilla.org/netscape.junk&quot;</span>
<a href="#l15.393"></a><span id="l15.393">     // we need to turn that into: &quot;netscape.test,netscape.junk&quot;</span>
<a href="#l15.394"></a><span id="l15.394">     // (XXX: can it really?)</span>
<a href="#l15.395"></a><span id="l15.395">     nsCOMPtr&lt;nsINntpService&gt; nntpService =</span>
<a href="#l15.396"></a><span id="l15.396" class="difflineminus">-      do_GetService(&quot;@mozilla.org/messenger/nntpservice;1&quot;, &amp;rv);</span>
<a href="#l15.397"></a><span id="l15.397" class="difflineplus">+        do_GetService(&quot;@mozilla.org/messenger/nntpservice;1&quot;, &amp;rv);</span>
<a href="#l15.398"></a><span id="l15.398">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.399"></a><span id="l15.399"> </span>
<a href="#l15.400"></a><span id="l15.400">     nsCString newsgroupsHeaderVal;</span>
<a href="#l15.401"></a><span id="l15.401">     nsCString newshostHeaderVal;</span>
<a href="#l15.402"></a><span id="l15.402" class="difflineminus">-    rv = nntpService-&gt;GenerateNewsHeaderValsForPosting(newsgroups,</span>
<a href="#l15.403"></a><span id="l15.403" class="difflineminus">-      getter_Copies(newsgroupsHeaderVal), getter_Copies(newshostHeaderVal));</span>
<a href="#l15.404"></a><span id="l15.404" class="difflineplus">+    rv = nntpService-&gt;GenerateNewsHeaderValsForPosting(</span>
<a href="#l15.405"></a><span id="l15.405" class="difflineplus">+        newsgroups, getter_Copies(newsgroupsHeaderVal),</span>
<a href="#l15.406"></a><span id="l15.406" class="difflineplus">+        getter_Copies(newshostHeaderVal));</span>
<a href="#l15.407"></a><span id="l15.407">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.408"></a><span id="l15.408">     finalHeaders-&gt;SetRawHeader(&quot;Newsgroups&quot;, newsgroupsHeaderVal, nullptr);</span>
<a href="#l15.409"></a><span id="l15.409"> </span>
<a href="#l15.410"></a><span id="l15.410">     // If we are here, we are NOT going to send this now. (i.e. it is a Draft,</span>
<a href="#l15.411"></a><span id="l15.411">     // Send Later file, etc...). Because of that, we need to store what the user</span>
<a href="#l15.412"></a><span id="l15.412">     // typed in on the original composition window for use later when rebuilding</span>
<a href="#l15.413"></a><span id="l15.413">     // the headers</span>
<a href="#l15.414"></a><span id="l15.414">     if (deliver_mode != nsIMsgSend::nsMsgDeliverNow &amp;&amp;</span>
<a href="#l15.415"></a><span id="l15.415" class="difflineminus">-        deliver_mode != nsIMsgSend::nsMsgSendUnsent)</span>
<a href="#l15.416"></a><span id="l15.416" class="difflineminus">-    {</span>
<a href="#l15.417"></a><span id="l15.417" class="difflineplus">+        deliver_mode != nsIMsgSend::nsMsgSendUnsent) {</span>
<a href="#l15.418"></a><span id="l15.418">       // This is going to be saved for later, that means we should just store</span>
<a href="#l15.419"></a><span id="l15.419" class="difflineminus">-      // what the user typed into the &quot;Newsgroup&quot; line in the HEADER_X_MOZILLA_NEWSHOST</span>
<a href="#l15.420"></a><span id="l15.420" class="difflineminus">-      // header for later use by &quot;Send Unsent Messages&quot;, &quot;Drafts&quot; or &quot;Templates&quot;</span>
<a href="#l15.421"></a><span id="l15.421" class="difflineplus">+      // what the user typed into the &quot;Newsgroup&quot; line in the</span>
<a href="#l15.422"></a><span id="l15.422" class="difflineplus">+      // HEADER_X_MOZILLA_NEWSHOST header for later use by &quot;Send Unsent</span>
<a href="#l15.423"></a><span id="l15.423" class="difflineplus">+      // Messages&quot;, &quot;Drafts&quot; or &quot;Templates&quot;</span>
<a href="#l15.424"></a><span id="l15.424">       finalHeaders-&gt;SetRawHeader(HEADER_X_MOZILLA_NEWSHOST, newshostHeaderVal,</span>
<a href="#l15.425"></a><span id="l15.425" class="difflineminus">-        nullptr);</span>
<a href="#l15.426"></a><span id="l15.426" class="difflineplus">+                                 nullptr);</span>
<a href="#l15.427"></a><span id="l15.427">     }</span>
<a href="#l15.428"></a><span id="l15.428"> </span>
<a href="#l15.429"></a><span id="l15.429">     // Newsgroups are a recipient...</span>
<a href="#l15.430"></a><span id="l15.430">     hasDisclosedRecipient = true;</span>
<a href="#l15.431"></a><span id="l15.431">   }</span>
<a href="#l15.432"></a><span id="l15.432"> </span>
<a href="#l15.433"></a><span id="l15.433">   nsCOMArray&lt;msgIAddressObject&gt; recipients;</span>
<a href="#l15.434"></a><span id="l15.434">   finalHeaders-&gt;GetAddressingHeader(&quot;To&quot;, recipients);</span>
<a href="#l15.435"></a><span id="l15.435">   hasDisclosedRecipient |= !recipients.IsEmpty();</span>
<a href="#l15.436"></a><span id="l15.436">   finalHeaders-&gt;GetAddressingHeader(&quot;Cc&quot;, recipients);</span>
<a href="#l15.437"></a><span id="l15.437">   hasDisclosedRecipient |= !recipients.IsEmpty();</span>
<a href="#l15.438"></a><span id="l15.438"> </span>
<a href="#l15.439"></a><span id="l15.439">   // If we don't have disclosed recipient (only Bcc), address the message to</span>
<a href="#l15.440"></a><span id="l15.440">   // undisclosed-recipients to prevent problem with some servers</span>
<a href="#l15.441"></a><span id="l15.441"> </span>
<a href="#l15.442"></a><span id="l15.442" class="difflineminus">-  // If we are saving the message as a draft, don't bother inserting the undisclosed recipients field. We'll take care of that when we</span>
<a href="#l15.443"></a><span id="l15.443" class="difflineminus">-  // really send the message.</span>
<a href="#l15.444"></a><span id="l15.444" class="difflineminus">-  if (!hasDisclosedRecipient &amp;&amp; (!isDraft || deliver_mode == nsIMsgSend::nsMsgQueueForLater))</span>
<a href="#l15.445"></a><span id="l15.445" class="difflineminus">-  {</span>
<a href="#l15.446"></a><span id="l15.446" class="difflineplus">+  // If we are saving the message as a draft, don't bother inserting the</span>
<a href="#l15.447"></a><span id="l15.447" class="difflineplus">+  // undisclosed recipients field. We'll take care of that when we really send</span>
<a href="#l15.448"></a><span id="l15.448" class="difflineplus">+  // the message.</span>
<a href="#l15.449"></a><span id="l15.449" class="difflineplus">+  if (!hasDisclosedRecipient &amp;&amp;</span>
<a href="#l15.450"></a><span id="l15.450" class="difflineplus">+      (!isDraft || deliver_mode == nsIMsgSend::nsMsgQueueForLater)) {</span>
<a href="#l15.451"></a><span id="l15.451">     bool bAddUndisclosedRecipients = true;</span>
<a href="#l15.452"></a><span id="l15.452" class="difflineminus">-    prefs-&gt;GetBoolPref(&quot;mail.compose.add_undisclosed_recipients&quot;, &amp;bAddUndisclosedRecipients);</span>
<a href="#l15.453"></a><span id="l15.453" class="difflineminus">-    if (bAddUndisclosedRecipients)</span>
<a href="#l15.454"></a><span id="l15.454" class="difflineminus">-    {</span>
<a href="#l15.455"></a><span id="l15.455" class="difflineplus">+    prefs-&gt;GetBoolPref(&quot;mail.compose.add_undisclosed_recipients&quot;,</span>
<a href="#l15.456"></a><span id="l15.456" class="difflineplus">+                       &amp;bAddUndisclosedRecipients);</span>
<a href="#l15.457"></a><span id="l15.457" class="difflineplus">+    if (bAddUndisclosedRecipients) {</span>
<a href="#l15.458"></a><span id="l15.458">       bool hasBcc = false;</span>
<a href="#l15.459"></a><span id="l15.459">       fields-&gt;HasHeader(&quot;Bcc&quot;, &amp;hasBcc);</span>
<a href="#l15.460"></a><span id="l15.460" class="difflineminus">-      if (hasBcc)</span>
<a href="#l15.461"></a><span id="l15.461" class="difflineminus">-      {</span>
<a href="#l15.462"></a><span id="l15.462" class="difflineplus">+      if (hasBcc) {</span>
<a href="#l15.463"></a><span id="l15.463">         nsCOMPtr&lt;nsIStringBundleService&gt; stringService =</span>
<a href="#l15.464"></a><span id="l15.464" class="difflineminus">-          mozilla::services::GetStringBundleService();</span>
<a href="#l15.465"></a><span id="l15.465" class="difflineminus">-        if (stringService)</span>
<a href="#l15.466"></a><span id="l15.466" class="difflineminus">-        {</span>
<a href="#l15.467"></a><span id="l15.467" class="difflineplus">+            mozilla::services::GetStringBundleService();</span>
<a href="#l15.468"></a><span id="l15.468" class="difflineplus">+        if (stringService) {</span>
<a href="#l15.469"></a><span id="l15.469">           nsCOMPtr&lt;nsIStringBundle&gt; composeStringBundle;</span>
<a href="#l15.470"></a><span id="l15.470" class="difflineminus">-          rv = stringService-&gt;CreateBundle(&quot;chrome://messenger/locale/messengercompose/composeMsgs.properties&quot;, getter_AddRefs(composeStringBundle));</span>
<a href="#l15.471"></a><span id="l15.471" class="difflineminus">-          if (NS_SUCCEEDED(rv))</span>
<a href="#l15.472"></a><span id="l15.472" class="difflineminus">-          {</span>
<a href="#l15.473"></a><span id="l15.473" class="difflineplus">+          rv = stringService-&gt;CreateBundle(</span>
<a href="#l15.474"></a><span id="l15.474" class="difflineplus">+              &quot;chrome://messenger/locale/messengercompose/&quot;</span>
<a href="#l15.475"></a><span id="l15.475" class="difflineplus">+              &quot;composeMsgs.properties&quot;,</span>
<a href="#l15.476"></a><span id="l15.476" class="difflineplus">+              getter_AddRefs(composeStringBundle));</span>
<a href="#l15.477"></a><span id="l15.477" class="difflineplus">+          if (NS_SUCCEEDED(rv)) {</span>
<a href="#l15.478"></a><span id="l15.478">             nsString undisclosedRecipients;</span>
<a href="#l15.479"></a><span id="l15.479">             rv = composeStringBundle-&gt;GetStringFromName(&quot;undisclosedRecipients&quot;,</span>
<a href="#l15.480"></a><span id="l15.480">                                                         undisclosedRecipients);</span>
<a href="#l15.481"></a><span id="l15.481" class="difflineminus">-            if (NS_SUCCEEDED(rv) &amp;&amp; !undisclosedRecipients.IsEmpty())</span>
<a href="#l15.482"></a><span id="l15.482" class="difflineminus">-            {</span>
<a href="#l15.483"></a><span id="l15.483" class="difflineplus">+            if (NS_SUCCEEDED(rv) &amp;&amp; !undisclosedRecipients.IsEmpty()) {</span>
<a href="#l15.484"></a><span id="l15.484">               nsCOMPtr&lt;nsIMsgHeaderParser&gt; headerParser(</span>
<a href="#l15.485"></a><span id="l15.485" class="difflineminus">-                mozilla::services::GetHeaderParser());</span>
<a href="#l15.486"></a><span id="l15.486" class="difflineplus">+                  mozilla::services::GetHeaderParser());</span>
<a href="#l15.487"></a><span id="l15.487">               nsCOMPtr&lt;msgIAddressObject&gt; group;</span>
<a href="#l15.488"></a><span id="l15.488" class="difflineminus">-              headerParser-&gt;MakeGroupObject(undisclosedRecipients,</span>
<a href="#l15.489"></a><span id="l15.489" class="difflineminus">-                nullptr, 0, getter_AddRefs(group));</span>
<a href="#l15.490"></a><span id="l15.490" class="difflineplus">+              headerParser-&gt;MakeGroupObject(undisclosedRecipients, nullptr, 0,</span>
<a href="#l15.491"></a><span id="l15.491" class="difflineplus">+                                            getter_AddRefs(group));</span>
<a href="#l15.492"></a><span id="l15.492">               recipients.AppendElement(group);</span>
<a href="#l15.493"></a><span id="l15.493">               finalHeaders-&gt;SetAddressingHeader(&quot;To&quot;, recipients);</span>
<a href="#l15.494"></a><span id="l15.494">             }</span>
<a href="#l15.495"></a><span id="l15.495">           }</span>
<a href="#l15.496"></a><span id="l15.496">         }</span>
<a href="#l15.497"></a><span id="l15.497">       }</span>
<a href="#l15.498"></a><span id="l15.498">     }</span>
<a href="#l15.499"></a><span id="l15.499">   }</span>
<a href="#l15.500"></a><span id="l15.500"> </span>
<a href="#l15.501"></a><span id="l15.501">   // We don't want to emit a Bcc header to the output. If we are saving this to</span>
<a href="#l15.502"></a><span id="l15.502">   // Drafts/Sent, this is re-added later in nsMsgSend.cpp.</span>
<a href="#l15.503"></a><span id="l15.503">   finalHeaders-&gt;DeleteHeader(&quot;bcc&quot;);</span>
<a href="#l15.504"></a><span id="l15.504"> </span>
<a href="#l15.505"></a><span id="l15.505">   // Skip no or empty priority.</span>
<a href="#l15.506"></a><span id="l15.506">   nsAutoCString priority;</span>
<a href="#l15.507"></a><span id="l15.507">   rv = fields-&gt;GetRawHeader(&quot;X-Priority&quot;, priority);</span>
<a href="#l15.508"></a><span id="l15.508" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; !priority.IsEmpty())</span>
<a href="#l15.509"></a><span id="l15.509" class="difflineminus">-  {</span>
<a href="#l15.510"></a><span id="l15.510" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !priority.IsEmpty()) {</span>
<a href="#l15.511"></a><span id="l15.511">     nsMsgPriorityValue priorityValue;</span>
<a href="#l15.512"></a><span id="l15.512"> </span>
<a href="#l15.513"></a><span id="l15.513">     NS_MsgGetPriorityFromString(priority.get(), priorityValue);</span>
<a href="#l15.514"></a><span id="l15.514"> </span>
<a href="#l15.515"></a><span id="l15.515">     // Skip default priority.</span>
<a href="#l15.516"></a><span id="l15.516">     if (priorityValue != nsMsgPriority::Default) {</span>
<a href="#l15.517"></a><span id="l15.517">       nsAutoCString priorityName;</span>
<a href="#l15.518"></a><span id="l15.518">       nsAutoCString priorityValueString;</span>
<a href="#l15.519"></a><span id="l15.519" class="difflineat">@@ -452,209 +408,181 @@ nsresult mime_generate_headers(nsIMsgCom</span>
<a href="#l15.520"></a><span id="l15.520">       priorityValueString += priorityName;</span>
<a href="#l15.521"></a><span id="l15.521">       priorityValueString.Append(')');</span>
<a href="#l15.522"></a><span id="l15.522">       finalHeaders-&gt;SetRawHeader(&quot;X-Priority&quot;, priorityValueString, nullptr);</span>
<a href="#l15.523"></a><span id="l15.523">     }</span>
<a href="#l15.524"></a><span id="l15.524">   }</span>
<a href="#l15.525"></a><span id="l15.525"> </span>
<a href="#l15.526"></a><span id="l15.526">   nsAutoCString references;</span>
<a href="#l15.527"></a><span id="l15.527">   finalHeaders-&gt;GetRawHeader(&quot;References&quot;, references);</span>
<a href="#l15.528"></a><span id="l15.528" class="difflineminus">-  if (!references.IsEmpty())</span>
<a href="#l15.529"></a><span id="l15.529" class="difflineminus">-  {</span>
<a href="#l15.530"></a><span id="l15.530" class="difflineplus">+  if (!references.IsEmpty()) {</span>
<a href="#l15.531"></a><span id="l15.531">     // The References header should be kept under 998 characters: if it's too</span>
<a href="#l15.532"></a><span id="l15.532">     // long, trim out the earliest references to make it smaller.</span>
<a href="#l15.533"></a><span id="l15.533" class="difflineminus">-    if (references.Length() &gt; 986)</span>
<a href="#l15.534"></a><span id="l15.534" class="difflineminus">-    {</span>
<a href="#l15.535"></a><span id="l15.535" class="difflineplus">+    if (references.Length() &gt; 986) {</span>
<a href="#l15.536"></a><span id="l15.536">       int32_t firstRef = references.FindChar('&lt;');</span>
<a href="#l15.537"></a><span id="l15.537">       int32_t secondRef = references.FindChar('&lt;', firstRef + 1);</span>
<a href="#l15.538"></a><span id="l15.538" class="difflineminus">-      if (secondRef &gt; 0)</span>
<a href="#l15.539"></a><span id="l15.539" class="difflineminus">-      {</span>
<a href="#l15.540"></a><span id="l15.540" class="difflineplus">+      if (secondRef &gt; 0) {</span>
<a href="#l15.541"></a><span id="l15.541">         nsAutoCString newReferences(StringHead(references, secondRef));</span>
<a href="#l15.542"></a><span id="l15.542" class="difflineminus">-        int32_t bracket = references.FindChar('&lt;',</span>
<a href="#l15.543"></a><span id="l15.543" class="difflineminus">-          references.Length() + newReferences.Length() - 986);</span>
<a href="#l15.544"></a><span id="l15.544" class="difflineminus">-        if (bracket &gt; 0)</span>
<a href="#l15.545"></a><span id="l15.545" class="difflineminus">-        {</span>
<a href="#l15.546"></a><span id="l15.546" class="difflineplus">+        int32_t bracket = references.FindChar(</span>
<a href="#l15.547"></a><span id="l15.547" class="difflineplus">+            '&lt;', references.Length() + newReferences.Length() - 986);</span>
<a href="#l15.548"></a><span id="l15.548" class="difflineplus">+        if (bracket &gt; 0) {</span>
<a href="#l15.549"></a><span id="l15.549">           newReferences.Append(Substring(references, bracket));</span>
<a href="#l15.550"></a><span id="l15.550">           finalHeaders-&gt;SetRawHeader(&quot;References&quot;, newReferences, nullptr);</span>
<a href="#l15.551"></a><span id="l15.551">         }</span>
<a href="#l15.552"></a><span id="l15.552">       }</span>
<a href="#l15.553"></a><span id="l15.553">     }</span>
<a href="#l15.554"></a><span id="l15.554">     // The In-Reply-To header is the last entry in the references header...</span>
<a href="#l15.555"></a><span id="l15.555">     int32_t bracket = references.RFind(&quot;&lt;&quot;);</span>
<a href="#l15.556"></a><span id="l15.556">     if (bracket &gt;= 0)</span>
<a href="#l15.557"></a><span id="l15.557">       finalHeaders-&gt;SetRawHeader(&quot;In-Reply-To&quot;, Substring(references, bracket),</span>
<a href="#l15.558"></a><span id="l15.558" class="difflineminus">-        nullptr);</span>
<a href="#l15.559"></a><span id="l15.559" class="difflineplus">+                                 nullptr);</span>
<a href="#l15.560"></a><span id="l15.560">   }</span>
<a href="#l15.561"></a><span id="l15.561"> </span>
<a href="#l15.562"></a><span id="l15.562">   return NS_OK;</span>
<a href="#l15.563"></a><span id="l15.563"> }</span>
<a href="#l15.564"></a><span id="l15.564"> </span>
<a href="#l15.565"></a><span id="l15.565" class="difflineminus">-#undef APPEND_BOOL // X-Mozilla-Draft-Info helper macro</span>
<a href="#l15.566"></a><span id="l15.566" class="difflineplus">+#undef APPEND_BOOL  // X-Mozilla-Draft-Info helper macro</span>
<a href="#l15.567"></a><span id="l15.567"> </span>
<a href="#l15.568"></a><span id="l15.568" class="difflineminus">-static void</span>
<a href="#l15.569"></a><span id="l15.569" class="difflineminus">-GenerateGlobalRandomBytes(unsigned char *buf, int32_t len)</span>
<a href="#l15.570"></a><span id="l15.570" class="difflineminus">-{</span>
<a href="#l15.571"></a><span id="l15.571" class="difflineplus">+static void GenerateGlobalRandomBytes(unsigned char *buf, int32_t len) {</span>
<a href="#l15.572"></a><span id="l15.572">   // Attempt to generate bytes from system entropy-based RNG.</span>
<a href="#l15.573"></a><span id="l15.573" class="difflineminus">-  nsCOMPtr&lt;nsIRandomGenerator&gt; randomGenerator(do_GetService(&quot;@mozilla.org/security/random-generator;1&quot;));</span>
<a href="#l15.574"></a><span id="l15.574" class="difflineplus">+  nsCOMPtr&lt;nsIRandomGenerator&gt; randomGenerator(</span>
<a href="#l15.575"></a><span id="l15.575" class="difflineplus">+      do_GetService(&quot;@mozilla.org/security/random-generator;1&quot;));</span>
<a href="#l15.576"></a><span id="l15.576">   MOZ_ASSERT(randomGenerator, &quot;nsIRandomGenerator service not retrievable&quot;);</span>
<a href="#l15.577"></a><span id="l15.577">   uint8_t *tempBuffer;</span>
<a href="#l15.578"></a><span id="l15.578">   nsresult rv = randomGenerator-&gt;GenerateRandomBytes(len, &amp;tempBuffer);</span>
<a href="#l15.579"></a><span id="l15.579" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l15.580"></a><span id="l15.580" class="difflineminus">-  {</span>
<a href="#l15.581"></a><span id="l15.581" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l15.582"></a><span id="l15.582">     memcpy(buf, tempBuffer, len);</span>
<a href="#l15.583"></a><span id="l15.583">     free(tempBuffer);</span>
<a href="#l15.584"></a><span id="l15.584">     return;</span>
<a href="#l15.585"></a><span id="l15.585">   }</span>
<a href="#l15.586"></a><span id="l15.586">   // nsIRandomGenerator failed -- fall back to low entropy PRNG.</span>
<a href="#l15.587"></a><span id="l15.587">   static bool firstTime = true;</span>
<a href="#l15.588"></a><span id="l15.588" class="difflineminus">-  if (firstTime)</span>
<a href="#l15.589"></a><span id="l15.589" class="difflineminus">-  {</span>
<a href="#l15.590"></a><span id="l15.590" class="difflineplus">+  if (firstTime) {</span>
<a href="#l15.591"></a><span id="l15.591">     // Seed the random-number generator with current time so that</span>
<a href="#l15.592"></a><span id="l15.592">     // the numbers will be different every time we run.</span>
<a href="#l15.593"></a><span id="l15.593" class="difflineminus">-    srand( (unsigned)PR_Now() );</span>
<a href="#l15.594"></a><span id="l15.594" class="difflineplus">+    srand((unsigned)PR_Now());</span>
<a href="#l15.595"></a><span id="l15.595">     firstTime = false;</span>
<a href="#l15.596"></a><span id="l15.596">   }</span>
<a href="#l15.597"></a><span id="l15.597"> </span>
<a href="#l15.598"></a><span id="l15.598" class="difflineminus">-  for( int32_t i = 0; i &lt; len; i++ )</span>
<a href="#l15.599"></a><span id="l15.599" class="difflineminus">-    buf[i] = rand() % 256;</span>
<a href="#l15.600"></a><span id="l15.600" class="difflineplus">+  for (int32_t i = 0; i &lt; len; i++) buf[i] = rand() % 256;</span>
<a href="#l15.601"></a><span id="l15.601"> }</span>
<a href="#l15.602"></a><span id="l15.602"> </span>
<a href="#l15.603"></a><span id="l15.603" class="difflineminus">-char</span>
<a href="#l15.604"></a><span id="l15.604" class="difflineminus">-*mime_make_separator(const char *prefix)</span>
<a href="#l15.605"></a><span id="l15.605" class="difflineminus">-{</span>
<a href="#l15.606"></a><span id="l15.606" class="difflineplus">+char *mime_make_separator(const char *prefix) {</span>
<a href="#l15.607"></a><span id="l15.607">   unsigned char rand_buf[13];</span>
<a href="#l15.608"></a><span id="l15.608">   GenerateGlobalRandomBytes(rand_buf, 12);</span>
<a href="#l15.609"></a><span id="l15.609"> </span>
<a href="#l15.610"></a><span id="l15.610" class="difflineminus">-  return PR_smprintf(&quot;------------%s&quot;</span>
<a href="#l15.611"></a><span id="l15.611" class="difflineminus">-           &quot;%02X%02X%02X%02X&quot;</span>
<a href="#l15.612"></a><span id="l15.612" class="difflineminus">-           &quot;%02X%02X%02X%02X&quot;</span>
<a href="#l15.613"></a><span id="l15.613" class="difflineminus">-           &quot;%02X%02X%02X%02X&quot;,</span>
<a href="#l15.614"></a><span id="l15.614" class="difflineminus">-           prefix,</span>
<a href="#l15.615"></a><span id="l15.615" class="difflineminus">-           rand_buf[0], rand_buf[1], rand_buf[2], rand_buf[3],</span>
<a href="#l15.616"></a><span id="l15.616" class="difflineminus">-           rand_buf[4], rand_buf[5], rand_buf[6], rand_buf[7],</span>
<a href="#l15.617"></a><span id="l15.617" class="difflineminus">-           rand_buf[8], rand_buf[9], rand_buf[10], rand_buf[11]);</span>
<a href="#l15.618"></a><span id="l15.618" class="difflineplus">+  return PR_smprintf(</span>
<a href="#l15.619"></a><span id="l15.619" class="difflineplus">+      &quot;------------%s&quot;</span>
<a href="#l15.620"></a><span id="l15.620" class="difflineplus">+      &quot;%02X%02X%02X%02X&quot;</span>
<a href="#l15.621"></a><span id="l15.621" class="difflineplus">+      &quot;%02X%02X%02X%02X&quot;</span>
<a href="#l15.622"></a><span id="l15.622" class="difflineplus">+      &quot;%02X%02X%02X%02X&quot;,</span>
<a href="#l15.623"></a><span id="l15.623" class="difflineplus">+      prefix, rand_buf[0], rand_buf[1], rand_buf[2], rand_buf[3], rand_buf[4],</span>
<a href="#l15.624"></a><span id="l15.624" class="difflineplus">+      rand_buf[5], rand_buf[6], rand_buf[7], rand_buf[8], rand_buf[9],</span>
<a href="#l15.625"></a><span id="l15.625" class="difflineplus">+      rand_buf[10], rand_buf[11]);</span>
<a href="#l15.626"></a><span id="l15.626"> }</span>
<a href="#l15.627"></a><span id="l15.627"> </span>
<a href="#l15.628"></a><span id="l15.628" class="difflineminus">-static char *</span>
<a href="#l15.629"></a><span id="l15.629" class="difflineminus">-RFC2231ParmFolding(const char *parmName, const char *parmValue);</span>
<a href="#l15.630"></a><span id="l15.630" class="difflineplus">+static char *RFC2231ParmFolding(const char *parmName, const char *parmValue);</span>
<a href="#l15.631"></a><span id="l15.631"> </span>
<a href="#l15.632"></a><span id="l15.632" class="difflineminus">-static char *</span>
<a href="#l15.633"></a><span id="l15.633" class="difflineminus">-LegacyParmFolding(const nsCString&amp; aCharset,</span>
<a href="#l15.634"></a><span id="l15.634" class="difflineminus">-                  const nsCString&amp; aFileName, int32_t aParmFolding);</span>
<a href="#l15.635"></a><span id="l15.635" class="difflineplus">+static char *LegacyParmFolding(const nsCString &amp;aCharset,</span>
<a href="#l15.636"></a><span id="l15.636" class="difflineplus">+                               const nsCString &amp;aFileName,</span>
<a href="#l15.637"></a><span id="l15.637" class="difflineplus">+                               int32_t aParmFolding);</span>
<a href="#l15.638"></a><span id="l15.638"> </span>
<a href="#l15.639"></a><span id="l15.639" class="difflineminus">-char *</span>
<a href="#l15.640"></a><span id="l15.640" class="difflineminus">-mime_generate_attachment_headers (const char *type,</span>
<a href="#l15.641"></a><span id="l15.641" class="difflineminus">-                  const char *type_param,</span>
<a href="#l15.642"></a><span id="l15.642" class="difflineminus">-                  const char *encoding,</span>
<a href="#l15.643"></a><span id="l15.643" class="difflineminus">-                  const char *description,</span>
<a href="#l15.644"></a><span id="l15.644" class="difflineminus">-                  const char *x_mac_type,</span>
<a href="#l15.645"></a><span id="l15.645" class="difflineminus">-                  const char *x_mac_creator,</span>
<a href="#l15.646"></a><span id="l15.646" class="difflineminus">-                  const char *real_name,</span>
<a href="#l15.647"></a><span id="l15.647" class="difflineminus">-                  const char *base_url,</span>
<a href="#l15.648"></a><span id="l15.648" class="difflineminus">-                  bool /*digest_p*/,</span>
<a href="#l15.649"></a><span id="l15.649" class="difflineminus">-                  nsMsgAttachmentHandler * /*ma*/,</span>
<a href="#l15.650"></a><span id="l15.650" class="difflineminus">-                  const char *attachmentCharset,</span>
<a href="#l15.651"></a><span id="l15.651" class="difflineminus">-                  const char *bodyCharset,</span>
<a href="#l15.652"></a><span id="l15.652" class="difflineminus">-                  bool bodyIsAsciiOnly,</span>
<a href="#l15.653"></a><span id="l15.653" class="difflineminus">-                  const char *content_id,</span>
<a href="#l15.654"></a><span id="l15.654" class="difflineminus">-                  bool        aBodyDocument)</span>
<a href="#l15.655"></a><span id="l15.655" class="difflineminus">-{</span>
<a href="#l15.656"></a><span id="l15.656" class="difflineminus">-  NS_ASSERTION (encoding, &quot;null encoding&quot;);</span>
<a href="#l15.657"></a><span id="l15.657" class="difflineplus">+char *mime_generate_attachment_headers(</span>
<a href="#l15.658"></a><span id="l15.658" class="difflineplus">+    const char *type, const char *type_param, const char *encoding,</span>
<a href="#l15.659"></a><span id="l15.659" class="difflineplus">+    const char *description, const char *x_mac_type, const char *x_mac_creator,</span>
<a href="#l15.660"></a><span id="l15.660" class="difflineplus">+    const char *real_name, const char *base_url, bool /*digest_p*/,</span>
<a href="#l15.661"></a><span id="l15.661" class="difflineplus">+    nsMsgAttachmentHandler * /*ma*/, const char *attachmentCharset,</span>
<a href="#l15.662"></a><span id="l15.662" class="difflineplus">+    const char *bodyCharset, bool bodyIsAsciiOnly, const char *content_id,</span>
<a href="#l15.663"></a><span id="l15.663" class="difflineplus">+    bool aBodyDocument) {</span>
<a href="#l15.664"></a><span id="l15.664" class="difflineplus">+  NS_ASSERTION(encoding, &quot;null encoding&quot;);</span>
<a href="#l15.665"></a><span id="l15.665"> </span>
<a href="#l15.666"></a><span id="l15.666" class="difflineminus">-  int32_t parmFolding = 2; // RFC 2231-compliant</span>
<a href="#l15.667"></a><span id="l15.667" class="difflineplus">+  int32_t parmFolding = 2;  // RFC 2231-compliant</span>
<a href="#l15.668"></a><span id="l15.668">   nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l15.669"></a><span id="l15.669" class="difflineminus">-  if (prefs)</span>
<a href="#l15.670"></a><span id="l15.670" class="difflineminus">-    prefs-&gt;GetIntPref(&quot;mail.strictly_mime.parm_folding&quot;, &amp;parmFolding);</span>
<a href="#l15.671"></a><span id="l15.671" class="difflineplus">+  if (prefs) prefs-&gt;GetIntPref(&quot;mail.strictly_mime.parm_folding&quot;, &amp;parmFolding);</span>
<a href="#l15.672"></a><span id="l15.672"> </span>
<a href="#l15.673"></a><span id="l15.673">   /* Let's encode the real name */</span>
<a href="#l15.674"></a><span id="l15.674">   char *encodedRealName = nullptr;</span>
<a href="#l15.675"></a><span id="l15.675">   nsAutoString realName;</span>
<a href="#l15.676"></a><span id="l15.676" class="difflineminus">-  if (real_name)</span>
<a href="#l15.677"></a><span id="l15.677" class="difflineminus">-  {</span>
<a href="#l15.678"></a><span id="l15.678" class="difflineplus">+  if (real_name) {</span>
<a href="#l15.679"></a><span id="l15.679">     encodedRealName = RFC2231ParmFolding(&quot;filename&quot;, real_name);</span>
<a href="#l15.680"></a><span id="l15.680">     // somehow RFC2231ParamFolding failed. fall back to legacy method</span>
<a href="#l15.681"></a><span id="l15.681">     if (!encodedRealName || !*encodedRealName) {</span>
<a href="#l15.682"></a><span id="l15.682">       PR_FREEIF(encodedRealName);</span>
<a href="#l15.683"></a><span id="l15.683">       parmFolding = 0;</span>
<a href="#l15.684"></a><span id="l15.684">       // Not RFC 2231 style encoding (it's not standard-compliant)</span>
<a href="#l15.685"></a><span id="l15.685" class="difflineminus">-      encodedRealName = LegacyParmFolding(NS_LITERAL_CSTRING(&quot;UTF-8&quot;),</span>
<a href="#l15.686"></a><span id="l15.686" class="difflineminus">-        nsDependentCString(real_name), parmFolding);</span>
<a href="#l15.687"></a><span id="l15.687" class="difflineplus">+      encodedRealName =</span>
<a href="#l15.688"></a><span id="l15.688" class="difflineplus">+          LegacyParmFolding(NS_LITERAL_CSTRING(&quot;UTF-8&quot;),</span>
<a href="#l15.689"></a><span id="l15.689" class="difflineplus">+                            nsDependentCString(real_name), parmFolding);</span>
<a href="#l15.690"></a><span id="l15.690">     }</span>
<a href="#l15.691"></a><span id="l15.691">   }</span>
<a href="#l15.692"></a><span id="l15.692"> </span>
<a href="#l15.693"></a><span id="l15.693">   nsCString buf;  // very likely to be longer than 64 characters</span>
<a href="#l15.694"></a><span id="l15.694">   buf.AppendLiteral(&quot;Content-Type: &quot;);</span>
<a href="#l15.695"></a><span id="l15.695">   buf.Append(type);</span>
<a href="#l15.696"></a><span id="l15.696" class="difflineminus">-  if (type_param &amp;&amp; *type_param)</span>
<a href="#l15.697"></a><span id="l15.697" class="difflineminus">-  {</span>
<a href="#l15.698"></a><span id="l15.698" class="difflineminus">-    if (*type_param != ';')</span>
<a href="#l15.699"></a><span id="l15.699" class="difflineminus">-      buf.AppendLiteral(&quot;; &quot;);</span>
<a href="#l15.700"></a><span id="l15.700" class="difflineplus">+  if (type_param &amp;&amp; *type_param) {</span>
<a href="#l15.701"></a><span id="l15.701" class="difflineplus">+    if (*type_param != ';') buf.AppendLiteral(&quot;; &quot;);</span>
<a href="#l15.702"></a><span id="l15.702">     buf.Append(type_param);</span>
<a href="#l15.703"></a><span id="l15.703">   }</span>
<a href="#l15.704"></a><span id="l15.704"> </span>
<a href="#l15.705"></a><span id="l15.705" class="difflineminus">-  if (mime_type_needs_charset (type))</span>
<a href="#l15.706"></a><span id="l15.706" class="difflineminus">-  {</span>
<a href="#l15.707"></a><span id="l15.707" class="difflineminus">-</span>
<a href="#l15.708"></a><span id="l15.708" class="difflineminus">-    char charset_label[65] = &quot;&quot;;   // Content-Type: charset</span>
<a href="#l15.709"></a><span id="l15.709" class="difflineminus">-    if (attachmentCharset)</span>
<a href="#l15.710"></a><span id="l15.710" class="difflineminus">-    {</span>
<a href="#l15.711"></a><span id="l15.711" class="difflineminus">-      PL_strncpy(charset_label, attachmentCharset, sizeof(charset_label)-1);</span>
<a href="#l15.712"></a><span id="l15.712" class="difflineminus">-      charset_label[sizeof(charset_label)-1] = '\0';</span>
<a href="#l15.713"></a><span id="l15.713" class="difflineplus">+  if (mime_type_needs_charset(type)) {</span>
<a href="#l15.714"></a><span id="l15.714" class="difflineplus">+    char charset_label[65] = &quot;&quot;;  // Content-Type: charset</span>
<a href="#l15.715"></a><span id="l15.715" class="difflineplus">+    if (attachmentCharset) {</span>
<a href="#l15.716"></a><span id="l15.716" class="difflineplus">+      PL_strncpy(charset_label, attachmentCharset, sizeof(charset_label) - 1);</span>
<a href="#l15.717"></a><span id="l15.717" class="difflineplus">+      charset_label[sizeof(charset_label) - 1] = '\0';</span>
<a href="#l15.718"></a><span id="l15.718">     }</span>
<a href="#l15.719"></a><span id="l15.719"> </span>
<a href="#l15.720"></a><span id="l15.720">     /* If the characters are all 7bit, arguably it's better to</span>
<a href="#l15.721"></a><span id="l15.721">     claim the charset to be US-ASCII. However, it causes</span>
<a href="#l15.722"></a><span id="l15.722">     a major 'interoperability problem' with MS OE, which makes it hard</span>
<a href="#l15.723"></a><span id="l15.723">     to sell Mozilla/TB to people most of whose correspondents use</span>
<a href="#l15.724"></a><span id="l15.724">     MS OE. MS OE turns all non-ASCII characters to question marks</span>
<a href="#l15.725"></a><span id="l15.725">     in replies to messages labeled as US-ASCII if users select 'send as is'</span>
<a href="#l15.726"></a><span id="l15.726">     with MIME turned on. (with MIME turned off, this happens without</span>
<a href="#l15.727"></a><span id="l15.727">     any warning.) To avoid this, we use the label 'US-ASCII' only when</span>
<a href="#l15.728"></a><span id="l15.728">     it's explicitly requested by setting the hidden pref.</span>
<a href="#l15.729"></a><span id="l15.729">     'mail.label_ascii_only_mail_as_us_ascii'. (bug 247958) */</span>
<a href="#l15.730"></a><span id="l15.730">     bool labelAsciiAsAscii = false;</span>
<a href="#l15.731"></a><span id="l15.731">     if (prefs)</span>
<a href="#l15.732"></a><span id="l15.732">       prefs-&gt;GetBoolPref(&quot;mail.label_ascii_only_mail_as_us_ascii&quot;,</span>
<a href="#l15.733"></a><span id="l15.733">                          &amp;labelAsciiAsAscii);</span>
<a href="#l15.734"></a><span id="l15.734" class="difflineminus">-    if (labelAsciiAsAscii &amp;&amp; encoding &amp;&amp;</span>
<a href="#l15.735"></a><span id="l15.735" class="difflineminus">-        !PL_strcasecmp (encoding, &quot;7bit&quot;) &amp;&amp; bodyIsAsciiOnly)</span>
<a href="#l15.736"></a><span id="l15.736" class="difflineminus">-      PL_strcpy (charset_label, &quot;us-ascii&quot;);</span>
<a href="#l15.737"></a><span id="l15.737" class="difflineplus">+    if (labelAsciiAsAscii &amp;&amp; encoding &amp;&amp; !PL_strcasecmp(encoding, &quot;7bit&quot;) &amp;&amp;</span>
<a href="#l15.738"></a><span id="l15.738" class="difflineplus">+        bodyIsAsciiOnly)</span>
<a href="#l15.739"></a><span id="l15.739" class="difflineplus">+      PL_strcpy(charset_label, &quot;us-ascii&quot;);</span>
<a href="#l15.740"></a><span id="l15.740"> </span>
<a href="#l15.741"></a><span id="l15.741" class="difflineminus">-    // If charset is multibyte then no charset to be specified (apply base64 instead).</span>
<a href="#l15.742"></a><span id="l15.742" class="difflineminus">-    // The list of file types match with PickEncoding() where we put base64 label.</span>
<a href="#l15.743"></a><span id="l15.743" class="difflineminus">-    if ( ((attachmentCharset &amp;&amp; !nsMsgI18Nmultibyte_charset(attachmentCharset)) ||</span>
<a href="#l15.744"></a><span id="l15.744" class="difflineplus">+    // If charset is multibyte then no charset to be specified (apply base64</span>
<a href="#l15.745"></a><span id="l15.745" class="difflineplus">+    // instead). The list of file types match with PickEncoding() where we put</span>
<a href="#l15.746"></a><span id="l15.746" class="difflineplus">+    // base64 label.</span>
<a href="#l15.747"></a><span id="l15.747" class="difflineplus">+    if (((attachmentCharset &amp;&amp;</span>
<a href="#l15.748"></a><span id="l15.748" class="difflineplus">+          !nsMsgI18Nmultibyte_charset(attachmentCharset)) ||</span>
<a href="#l15.749"></a><span id="l15.749">          ((PL_strcasecmp(type, TEXT_HTML) == 0) ||</span>
<a href="#l15.750"></a><span id="l15.750" class="difflineminus">-         (PL_strcasecmp(type, TEXT_MDL) == 0) ||</span>
<a href="#l15.751"></a><span id="l15.751" class="difflineminus">-         (PL_strcasecmp(type, TEXT_PLAIN) == 0) ||</span>
<a href="#l15.752"></a><span id="l15.752" class="difflineminus">-         (PL_strcasecmp(type, TEXT_RICHTEXT) == 0) ||</span>
<a href="#l15.753"></a><span id="l15.753" class="difflineminus">-         (PL_strcasecmp(type, TEXT_ENRICHED) == 0) ||</span>
<a href="#l15.754"></a><span id="l15.754" class="difflineminus">-         (PL_strcasecmp(type, TEXT_VCARD) == 0) ||</span>
<a href="#l15.755"></a><span id="l15.755" class="difflineminus">-         (PL_strcasecmp(type, APPLICATION_DIRECTORY) == 0) || /* text/x-vcard synonym */</span>
<a href="#l15.756"></a><span id="l15.756" class="difflineminus">-         (PL_strcasecmp(type, TEXT_CSS) == 0) ||</span>
<a href="#l15.757"></a><span id="l15.757" class="difflineminus">-         (PL_strcasecmp(type, TEXT_JSSS) == 0)) ||</span>
<a href="#l15.758"></a><span id="l15.758" class="difflineplus">+          (PL_strcasecmp(type, TEXT_MDL) == 0) ||</span>
<a href="#l15.759"></a><span id="l15.759" class="difflineplus">+          (PL_strcasecmp(type, TEXT_PLAIN) == 0) ||</span>
<a href="#l15.760"></a><span id="l15.760" class="difflineplus">+          (PL_strcasecmp(type, TEXT_RICHTEXT) == 0) ||</span>
<a href="#l15.761"></a><span id="l15.761" class="difflineplus">+          (PL_strcasecmp(type, TEXT_ENRICHED) == 0) ||</span>
<a href="#l15.762"></a><span id="l15.762" class="difflineplus">+          (PL_strcasecmp(type, TEXT_VCARD) == 0) ||</span>
<a href="#l15.763"></a><span id="l15.763" class="difflineplus">+          (PL_strcasecmp(type, APPLICATION_DIRECTORY) ==</span>
<a href="#l15.764"></a><span id="l15.764" class="difflineplus">+           0) || /* text/x-vcard synonym */</span>
<a href="#l15.765"></a><span id="l15.765" class="difflineplus">+          (PL_strcasecmp(type, TEXT_CSS) == 0) ||</span>
<a href="#l15.766"></a><span id="l15.766" class="difflineplus">+          (PL_strcasecmp(type, TEXT_JSSS) == 0)) ||</span>
<a href="#l15.767"></a><span id="l15.767">          (PL_strcasecmp(encoding, ENCODING_BASE64) != 0)) &amp;&amp;</span>
<a href="#l15.768"></a><span id="l15.768" class="difflineminus">-         (*charset_label))</span>
<a href="#l15.769"></a><span id="l15.769" class="difflineminus">-    {</span>
<a href="#l15.770"></a><span id="l15.770" class="difflineplus">+        (*charset_label)) {</span>
<a href="#l15.771"></a><span id="l15.771">       buf.AppendLiteral(&quot;; charset=&quot;);</span>
<a href="#l15.772"></a><span id="l15.772">       buf.Append(charset_label);</span>
<a href="#l15.773"></a><span id="l15.773">     }</span>
<a href="#l15.774"></a><span id="l15.774">   }</span>
<a href="#l15.775"></a><span id="l15.775"> </span>
<a href="#l15.776"></a><span id="l15.776">   // Only do this if we are in the body of a message</span>
<a href="#l15.777"></a><span id="l15.777" class="difflineminus">-  if (aBodyDocument)</span>
<a href="#l15.778"></a><span id="l15.778" class="difflineminus">-  {</span>
<a href="#l15.779"></a><span id="l15.779" class="difflineplus">+  if (aBodyDocument) {</span>
<a href="#l15.780"></a><span id="l15.780">     // Add format=flowed as in RFC 2646 if we are using that</span>
<a href="#l15.781"></a><span id="l15.781" class="difflineminus">-    if(type &amp;&amp; !PL_strcasecmp(type, &quot;text/plain&quot;))</span>
<a href="#l15.782"></a><span id="l15.782" class="difflineminus">-    {</span>
<a href="#l15.783"></a><span id="l15.783" class="difflineplus">+    if (type &amp;&amp; !PL_strcasecmp(type, &quot;text/plain&quot;)) {</span>
<a href="#l15.784"></a><span id="l15.784">       bool flowed, delsp, formatted, disallowBreaks;</span>
<a href="#l15.785"></a><span id="l15.785" class="difflineminus">-      GetSerialiserFlags(bodyCharset, &amp;flowed, &amp;delsp, &amp;formatted, &amp;disallowBreaks);</span>
<a href="#l15.786"></a><span id="l15.786" class="difflineminus">-      if(flowed)</span>
<a href="#l15.787"></a><span id="l15.787" class="difflineminus">-        buf.AppendLiteral(&quot;; format=flowed&quot;);</span>
<a href="#l15.788"></a><span id="l15.788" class="difflineminus">-      if (delsp)</span>
<a href="#l15.789"></a><span id="l15.789" class="difflineminus">-        buf.AppendLiteral(&quot;; delsp=yes&quot;);</span>
<a href="#l15.790"></a><span id="l15.790" class="difflineplus">+      GetSerialiserFlags(bodyCharset, &amp;flowed, &amp;delsp, &amp;formatted,</span>
<a href="#l15.791"></a><span id="l15.791" class="difflineplus">+                         &amp;disallowBreaks);</span>
<a href="#l15.792"></a><span id="l15.792" class="difflineplus">+      if (flowed) buf.AppendLiteral(&quot;; format=flowed&quot;);</span>
<a href="#l15.793"></a><span id="l15.793" class="difflineplus">+      if (delsp) buf.AppendLiteral(&quot;; delsp=yes&quot;);</span>
<a href="#l15.794"></a><span id="l15.794">       // else</span>
<a href="#l15.795"></a><span id="l15.795">       // {</span>
<a href="#l15.796"></a><span id="l15.796">       // Don't add a markup. Could use</span>
<a href="#l15.797"></a><span id="l15.797">       //        PUSH_STRING (&quot;; format=fixed&quot;);</span>
<a href="#l15.798"></a><span id="l15.798">       // but it is equivalent to nothing at all and we do want</span>
<a href="#l15.799"></a><span id="l15.799">       // to save bandwidth. Don't we?</span>
<a href="#l15.800"></a><span id="l15.800">       // }</span>
<a href="#l15.801"></a><span id="l15.801">     }</span>
<a href="#l15.802"></a><span id="l15.802" class="difflineat">@@ -673,518 +601,453 @@ mime_generate_attachment_headers (const </span>
<a href="#l15.803"></a><span id="l15.803">   }</span>
<a href="#l15.804"></a><span id="l15.804"> </span>
<a href="#l15.805"></a><span id="l15.805"> #ifdef EMIT_NAME_IN_CONTENT_TYPE</span>
<a href="#l15.806"></a><span id="l15.806">   if (encodedRealName &amp;&amp; *encodedRealName) {</span>
<a href="#l15.807"></a><span id="l15.807">     // Note that we don't need to output the name field if the name encoding is</span>
<a href="#l15.808"></a><span id="l15.808">     // RFC 2231. If the MUA knows the RFC 2231, it should know the RFC 2183 too.</span>
<a href="#l15.809"></a><span id="l15.809">     if (parmFolding != 2) {</span>
<a href="#l15.810"></a><span id="l15.810">       // The underlying JS MIME code will only handle UTF-8 here.</span>
<a href="#l15.811"></a><span id="l15.811" class="difflineminus">-      char *nameValue = LegacyParmFolding(NS_LITERAL_CSTRING(&quot;UTF-8&quot;),</span>
<a href="#l15.812"></a><span id="l15.812" class="difflineminus">-                                          nsDependentCString(real_name),</span>
<a href="#l15.813"></a><span id="l15.813" class="difflineminus">-                                          parmFolding);</span>
<a href="#l15.814"></a><span id="l15.814" class="difflineplus">+      char *nameValue =</span>
<a href="#l15.815"></a><span id="l15.815" class="difflineplus">+          LegacyParmFolding(NS_LITERAL_CSTRING(&quot;UTF-8&quot;),</span>
<a href="#l15.816"></a><span id="l15.816" class="difflineplus">+                            nsDependentCString(real_name), parmFolding);</span>
<a href="#l15.817"></a><span id="l15.817">       if (!nameValue || !*nameValue) {</span>
<a href="#l15.818"></a><span id="l15.818">         PR_FREEIF(nameValue);</span>
<a href="#l15.819"></a><span id="l15.819">         nameValue = encodedRealName;</span>
<a href="#l15.820"></a><span id="l15.820">       }</span>
<a href="#l15.821"></a><span id="l15.821">       buf.AppendLiteral(&quot;;\r\n name=\&quot;&quot;);</span>
<a href="#l15.822"></a><span id="l15.822">       buf.Append(nameValue);</span>
<a href="#l15.823"></a><span id="l15.823">       buf.Append('&quot;');</span>
<a href="#l15.824"></a><span id="l15.824" class="difflineminus">-      if (nameValue != encodedRealName)</span>
<a href="#l15.825"></a><span id="l15.825" class="difflineminus">-        PR_FREEIF(nameValue);</span>
<a href="#l15.826"></a><span id="l15.826" class="difflineplus">+      if (nameValue != encodedRealName) PR_FREEIF(nameValue);</span>
<a href="#l15.827"></a><span id="l15.827">     }</span>
<a href="#l15.828"></a><span id="l15.828">   }</span>
<a href="#l15.829"></a><span id="l15.829"> #endif /* EMIT_NAME_IN_CONTENT_TYPE */</span>
<a href="#l15.830"></a><span id="l15.830">   buf.Append(CRLF);</span>
<a href="#l15.831"></a><span id="l15.831"> </span>
<a href="#l15.832"></a><span id="l15.832">   buf.AppendLiteral(&quot;Content-Transfer-Encoding: &quot;);</span>
<a href="#l15.833"></a><span id="l15.833">   buf.Append(encoding);</span>
<a href="#l15.834"></a><span id="l15.834">   buf.Append(CRLF);</span>
<a href="#l15.835"></a><span id="l15.835"> </span>
<a href="#l15.836"></a><span id="l15.836">   if (description &amp;&amp; *description) {</span>
<a href="#l15.837"></a><span id="l15.837" class="difflineminus">-    char *s = mime_fix_header (description);</span>
<a href="#l15.838"></a><span id="l15.838" class="difflineplus">+    char *s = mime_fix_header(description);</span>
<a href="#l15.839"></a><span id="l15.839">     if (s) {</span>
<a href="#l15.840"></a><span id="l15.840">       buf.AppendLiteral(&quot;Content-Description: &quot;);</span>
<a href="#l15.841"></a><span id="l15.841">       buf.Append(s);</span>
<a href="#l15.842"></a><span id="l15.842">       buf.Append(CRLF);</span>
<a href="#l15.843"></a><span id="l15.843">       PR_Free(s);</span>
<a href="#l15.844"></a><span id="l15.844">     }</span>
<a href="#l15.845"></a><span id="l15.845">   }</span>
<a href="#l15.846"></a><span id="l15.846"> </span>
<a href="#l15.847"></a><span id="l15.847" class="difflineminus">-  if ( (content_id) &amp;&amp; (*content_id) )</span>
<a href="#l15.848"></a><span id="l15.848" class="difflineminus">-  {</span>
<a href="#l15.849"></a><span id="l15.849" class="difflineplus">+  if ((content_id) &amp;&amp; (*content_id)) {</span>
<a href="#l15.850"></a><span id="l15.850">     buf.AppendLiteral(&quot;Content-ID: &lt;&quot;);</span>
<a href="#l15.851"></a><span id="l15.851">     buf.Append(content_id);</span>
<a href="#l15.852"></a><span id="l15.852">     buf.Append('&gt;');</span>
<a href="#l15.853"></a><span id="l15.853">     buf.Append(CRLF);</span>
<a href="#l15.854"></a><span id="l15.854">   }</span>
<a href="#l15.855"></a><span id="l15.855"> </span>
<a href="#l15.856"></a><span id="l15.856">   if (encodedRealName &amp;&amp; *encodedRealName) {</span>
<a href="#l15.857"></a><span id="l15.857">     char *period = PL_strrchr(encodedRealName, '.');</span>
<a href="#l15.858"></a><span id="l15.858">     int32_t pref_content_disposition = 0;</span>
<a href="#l15.859"></a><span id="l15.859"> </span>
<a href="#l15.860"></a><span id="l15.860">     if (prefs) {</span>
<a href="#l15.861"></a><span id="l15.861" class="difflineminus">-      mozilla::DebugOnly&lt;nsresult&gt; rv = prefs-&gt;GetIntPref(&quot;mail.content_disposition_type&quot;,</span>
<a href="#l15.862"></a><span id="l15.862" class="difflineminus">-                                                          &amp;pref_content_disposition);</span>
<a href="#l15.863"></a><span id="l15.863" class="difflineminus">-      NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to get mail.content_disposition_type&quot;);</span>
<a href="#l15.864"></a><span id="l15.864" class="difflineplus">+      mozilla::DebugOnly&lt;nsresult&gt; rv = prefs-&gt;GetIntPref(</span>
<a href="#l15.865"></a><span id="l15.865" class="difflineplus">+          &quot;mail.content_disposition_type&quot;, &amp;pref_content_disposition);</span>
<a href="#l15.866"></a><span id="l15.866" class="difflineplus">+      NS_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l15.867"></a><span id="l15.867" class="difflineplus">+                   &quot;failed to get mail.content_disposition_type&quot;);</span>
<a href="#l15.868"></a><span id="l15.868">     }</span>
<a href="#l15.869"></a><span id="l15.869"> </span>
<a href="#l15.870"></a><span id="l15.870">     buf.AppendLiteral(&quot;Content-Disposition: &quot;);</span>
<a href="#l15.871"></a><span id="l15.871"> </span>
<a href="#l15.872"></a><span id="l15.872" class="difflineminus">-    // If this is an attachment which is part of the message body and therefore has a</span>
<a href="#l15.873"></a><span id="l15.873" class="difflineminus">-    // Content-ID (e.g, image in HTML msg), then Content-Disposition has to be inline</span>
<a href="#l15.874"></a><span id="l15.874" class="difflineplus">+    // If this is an attachment which is part of the message body and therefore</span>
<a href="#l15.875"></a><span id="l15.875" class="difflineplus">+    // has a Content-ID (e.g, image in HTML msg), then Content-Disposition has</span>
<a href="#l15.876"></a><span id="l15.876" class="difflineplus">+    // to be inline</span>
<a href="#l15.877"></a><span id="l15.877">     if (content_id &amp;&amp; *content_id)</span>
<a href="#l15.878"></a><span id="l15.878">       buf.AppendLiteral(&quot;inline&quot;);</span>
<a href="#l15.879"></a><span id="l15.879">     else if (pref_content_disposition == 1)</span>
<a href="#l15.880"></a><span id="l15.880">       buf.AppendLiteral(&quot;attachment&quot;);</span>
<a href="#l15.881"></a><span id="l15.881" class="difflineminus">-    else</span>
<a href="#l15.882"></a><span id="l15.882" class="difflineminus">-      if (pref_content_disposition == 2 &amp;&amp;</span>
<a href="#l15.883"></a><span id="l15.883" class="difflineminus">-          (!PL_strcasecmp(type, TEXT_PLAIN) ||</span>
<a href="#l15.884"></a><span id="l15.884" class="difflineminus">-          (period &amp;&amp; !PL_strcasecmp(period, &quot;.txt&quot;))))</span>
<a href="#l15.885"></a><span id="l15.885" class="difflineminus">-        buf.AppendLiteral(&quot;attachment&quot;);</span>
<a href="#l15.886"></a><span id="l15.886" class="difflineplus">+    else if (pref_content_disposition == 2 &amp;&amp;</span>
<a href="#l15.887"></a><span id="l15.887" class="difflineplus">+             (!PL_strcasecmp(type, TEXT_PLAIN) ||</span>
<a href="#l15.888"></a><span id="l15.888" class="difflineplus">+              (period &amp;&amp; !PL_strcasecmp(period, &quot;.txt&quot;))))</span>
<a href="#l15.889"></a><span id="l15.889" class="difflineplus">+      buf.AppendLiteral(&quot;attachment&quot;);</span>
<a href="#l15.890"></a><span id="l15.890"> </span>
<a href="#l15.891"></a><span id="l15.891" class="difflineminus">-      /* If this document is an anonymous binary file or a vcard,</span>
<a href="#l15.892"></a><span id="l15.892" class="difflineminus">-      then always show it as an attachment, never inline. */</span>
<a href="#l15.893"></a><span id="l15.893" class="difflineminus">-      else</span>
<a href="#l15.894"></a><span id="l15.894" class="difflineminus">-        if (!PL_strcasecmp(type, APPLICATION_OCTET_STREAM) ||</span>
<a href="#l15.895"></a><span id="l15.895" class="difflineminus">-            !PL_strcasecmp(type, TEXT_VCARD) ||</span>
<a href="#l15.896"></a><span id="l15.896" class="difflineminus">-            !PL_strcasecmp(type, APPLICATION_DIRECTORY)) /* text/x-vcard synonym */</span>
<a href="#l15.897"></a><span id="l15.897" class="difflineminus">-          buf.AppendLiteral(&quot;attachment&quot;);</span>
<a href="#l15.898"></a><span id="l15.898" class="difflineminus">-        else</span>
<a href="#l15.899"></a><span id="l15.899" class="difflineminus">-          buf.AppendLiteral(&quot;inline&quot;);</span>
<a href="#l15.900"></a><span id="l15.900" class="difflineplus">+    /* If this document is an anonymous binary file or a vcard,</span>
<a href="#l15.901"></a><span id="l15.901" class="difflineplus">+    then always show it as an attachment, never inline. */</span>
<a href="#l15.902"></a><span id="l15.902" class="difflineplus">+    else if (!PL_strcasecmp(type, APPLICATION_OCTET_STREAM) ||</span>
<a href="#l15.903"></a><span id="l15.903" class="difflineplus">+             !PL_strcasecmp(type, TEXT_VCARD) ||</span>
<a href="#l15.904"></a><span id="l15.904" class="difflineplus">+             !PL_strcasecmp(type,</span>
<a href="#l15.905"></a><span id="l15.905" class="difflineplus">+                            APPLICATION_DIRECTORY)) /* text/x-vcard synonym */</span>
<a href="#l15.906"></a><span id="l15.906" class="difflineplus">+      buf.AppendLiteral(&quot;attachment&quot;);</span>
<a href="#l15.907"></a><span id="l15.907" class="difflineplus">+    else</span>
<a href="#l15.908"></a><span id="l15.908" class="difflineplus">+      buf.AppendLiteral(&quot;inline&quot;);</span>
<a href="#l15.909"></a><span id="l15.909"> </span>
<a href="#l15.910"></a><span id="l15.910">     buf.AppendLiteral(&quot;;\r\n &quot;);</span>
<a href="#l15.911"></a><span id="l15.911">     buf.Append(encodedRealName);</span>
<a href="#l15.912"></a><span id="l15.912">     buf.Append(CRLF);</span>
<a href="#l15.913"></a><span id="l15.913" class="difflineminus">-  }</span>
<a href="#l15.914"></a><span id="l15.914" class="difflineminus">-  else</span>
<a href="#l15.915"></a><span id="l15.915" class="difflineminus">-    if (type &amp;&amp;</span>
<a href="#l15.916"></a><span id="l15.916" class="difflineminus">-        (!PL_strcasecmp (type, MESSAGE_RFC822) ||</span>
<a href="#l15.917"></a><span id="l15.917" class="difflineminus">-        !PL_strcasecmp (type, MESSAGE_NEWS)))</span>
<a href="#l15.918"></a><span id="l15.918" class="difflineminus">-      buf.AppendLiteral(&quot;Content-Disposition: inline&quot; CRLF);</span>
<a href="#l15.919"></a><span id="l15.919" class="difflineplus">+  } else if (type &amp;&amp; (!PL_strcasecmp(type, MESSAGE_RFC822) ||</span>
<a href="#l15.920"></a><span id="l15.920" class="difflineplus">+                      !PL_strcasecmp(type, MESSAGE_NEWS)))</span>
<a href="#l15.921"></a><span id="l15.921" class="difflineplus">+    buf.AppendLiteral(&quot;Content-Disposition: inline&quot; CRLF);</span>
<a href="#l15.922"></a><span id="l15.922"> </span>
<a href="#l15.923"></a><span id="l15.923"> #ifdef GENERATE_CONTENT_BASE</span>
<a href="#l15.924"></a><span id="l15.924">   /* If this is an HTML document, and we know the URL it originally</span>
<a href="#l15.925"></a><span id="l15.925">      came from, write out a Content-Base header. */</span>
<a href="#l15.926"></a><span id="l15.926">   if (type &amp;&amp;</span>
<a href="#l15.927"></a><span id="l15.927" class="difflineminus">-      (!PL_strcasecmp (type, TEXT_HTML) ||</span>
<a href="#l15.928"></a><span id="l15.928" class="difflineminus">-      !PL_strcasecmp (type, TEXT_MDL)) &amp;&amp;</span>
<a href="#l15.929"></a><span id="l15.929" class="difflineminus">-      base_url &amp;&amp; *base_url)</span>
<a href="#l15.930"></a><span id="l15.930" class="difflineminus">-  {</span>
<a href="#l15.931"></a><span id="l15.931" class="difflineplus">+      (!PL_strcasecmp(type, TEXT_HTML) || !PL_strcasecmp(type, TEXT_MDL)) &amp;&amp;</span>
<a href="#l15.932"></a><span id="l15.932" class="difflineplus">+      base_url &amp;&amp; *base_url) {</span>
<a href="#l15.933"></a><span id="l15.933">     int32_t col = 0;</span>
<a href="#l15.934"></a><span id="l15.934">     const char *s = base_url;</span>
<a href="#l15.935"></a><span id="l15.935" class="difflineminus">-    const char *colon = PL_strchr (s, ':');</span>
<a href="#l15.936"></a><span id="l15.936" class="difflineminus">-    bool useContentLocation = false;   /* rhp - add this  */</span>
<a href="#l15.937"></a><span id="l15.937" class="difflineplus">+    const char *colon = PL_strchr(s, ':');</span>
<a href="#l15.938"></a><span id="l15.938" class="difflineplus">+    bool useContentLocation = false; /* rhp - add this  */</span>
<a href="#l15.939"></a><span id="l15.939"> </span>
<a href="#l15.940"></a><span id="l15.940" class="difflineminus">-    if (!colon)</span>
<a href="#l15.941"></a><span id="l15.941" class="difflineminus">-      goto GIVE_UP_ON_CONTENT_BASE;  /* malformed URL? */</span>
<a href="#l15.942"></a><span id="l15.942" class="difflineplus">+    if (!colon) goto GIVE_UP_ON_CONTENT_BASE; /* malformed URL? */</span>
<a href="#l15.943"></a><span id="l15.943"> </span>
<a href="#l15.944"></a><span id="l15.944">     /* Don't emit a content-base that points to (or into) a news or</span>
<a href="#l15.945"></a><span id="l15.945">        mail message. */</span>
<a href="#l15.946"></a><span id="l15.946" class="difflineminus">-    if (!PL_strncasecmp (s, &quot;news:&quot;, 5) ||</span>
<a href="#l15.947"></a><span id="l15.947" class="difflineminus">-        !PL_strncasecmp (s, &quot;snews:&quot;, 6) ||</span>
<a href="#l15.948"></a><span id="l15.948" class="difflineminus">-        !PL_strncasecmp (s, &quot;IMAP:&quot;, 5) ||</span>
<a href="#l15.949"></a><span id="l15.949" class="difflineminus">-        !PL_strncasecmp (s, &quot;file:&quot;, 5) ||    /* rhp: fix targets from included HTML files */</span>
<a href="#l15.950"></a><span id="l15.950" class="difflineminus">-        !PL_strncasecmp (s, &quot;mailbox:&quot;, 8))</span>
<a href="#l15.951"></a><span id="l15.951" class="difflineplus">+    if (!PL_strncasecmp(s, &quot;news:&quot;, 5) || !PL_strncasecmp(s, &quot;snews:&quot;, 6) ||</span>
<a href="#l15.952"></a><span id="l15.952" class="difflineplus">+        !PL_strncasecmp(s, &quot;IMAP:&quot;, 5) ||</span>
<a href="#l15.953"></a><span id="l15.953" class="difflineplus">+        !PL_strncasecmp(</span>
<a href="#l15.954"></a><span id="l15.954" class="difflineplus">+            s, &quot;file:&quot;, 5) || /* rhp: fix targets from included HTML files */</span>
<a href="#l15.955"></a><span id="l15.955" class="difflineplus">+        !PL_strncasecmp(s, &quot;mailbox:&quot;, 8))</span>
<a href="#l15.956"></a><span id="l15.956">       goto GIVE_UP_ON_CONTENT_BASE;</span>
<a href="#l15.957"></a><span id="l15.957"> </span>
<a href="#l15.958"></a><span id="l15.958">     /* rhp - Put in a pref for using Content-Location instead of Content-Base.</span>
<a href="#l15.959"></a><span id="l15.959">            This will get tweaked to default to true in 5.0</span>
<a href="#l15.960"></a><span id="l15.960">     */</span>
<a href="#l15.961"></a><span id="l15.961">     if (prefs)</span>
<a href="#l15.962"></a><span id="l15.962" class="difflineminus">-      prefs-&gt;GetBoolPref(&quot;mail.use_content_location_on_send&quot;, &amp;useContentLocation);</span>
<a href="#l15.963"></a><span id="l15.963" class="difflineplus">+      prefs-&gt;GetBoolPref(&quot;mail.use_content_location_on_send&quot;,</span>
<a href="#l15.964"></a><span id="l15.964" class="difflineplus">+                         &amp;useContentLocation);</span>
<a href="#l15.965"></a><span id="l15.965"> </span>
<a href="#l15.966"></a><span id="l15.966">     if (useContentLocation)</span>
<a href="#l15.967"></a><span id="l15.967">       buf.AppendLiteral(&quot;Content-Location: \&quot;&quot;);</span>
<a href="#l15.968"></a><span id="l15.968">     else</span>
<a href="#l15.969"></a><span id="l15.969">       buf.AppendLiteral(&quot;Content-Base: \&quot;&quot;);</span>
<a href="#l15.970"></a><span id="l15.970">     /* rhp - Pref for Content-Location usage */</span>
<a href="#l15.971"></a><span id="l15.971"> </span>
<a href="#l15.972"></a><span id="l15.972" class="difflineminus">-/* rhp: this is to work with the Content-Location stuff */</span>
<a href="#l15.973"></a><span id="l15.973" class="difflineminus">-CONTENT_LOC_HACK:</span>
<a href="#l15.974"></a><span id="l15.974" class="difflineplus">+  /* rhp: this is to work with the Content-Location stuff */</span>
<a href="#l15.975"></a><span id="l15.975" class="difflineplus">+  CONTENT_LOC_HACK:</span>
<a href="#l15.976"></a><span id="l15.976"> </span>
<a href="#l15.977"></a><span id="l15.977" class="difflineminus">-    while (*s != 0 &amp;&amp; *s != '#')</span>
<a href="#l15.978"></a><span id="l15.978" class="difflineminus">-    {</span>
<a href="#l15.979"></a><span id="l15.979" class="difflineminus">-      uint32_t ot=buf.Length();</span>
<a href="#l15.980"></a><span id="l15.980" class="difflineminus">-      char tmp[]=&quot;\x00\x00&quot;;</span>
<a href="#l15.981"></a><span id="l15.981" class="difflineplus">+    while (*s != 0 &amp;&amp; *s != '#') {</span>
<a href="#l15.982"></a><span id="l15.982" class="difflineplus">+      uint32_t ot = buf.Length();</span>
<a href="#l15.983"></a><span id="l15.983" class="difflineplus">+      char tmp[] = &quot;\x00\x00&quot;;</span>
<a href="#l15.984"></a><span id="l15.984">       /* URLs must be wrapped at 40 characters or less. */</span>
<a href="#l15.985"></a><span id="l15.985">       if (col &gt;= 38) {</span>
<a href="#l15.986"></a><span id="l15.986">         buf.Append(CRLF &quot;\t&quot;);</span>
<a href="#l15.987"></a><span id="l15.987">         col = 0;</span>
<a href="#l15.988"></a><span id="l15.988">       }</span>
<a href="#l15.989"></a><span id="l15.989"> </span>
<a href="#l15.990"></a><span id="l15.990">       if (*s == ' ')</span>
<a href="#l15.991"></a><span id="l15.991">         buf.AppendLiteral(&quot;%20&quot;);</span>
<a href="#l15.992"></a><span id="l15.992">       else if (*s == '\t')</span>
<a href="#l15.993"></a><span id="l15.993">         buf.AppendLiteral(&quot;%09&quot;);</span>
<a href="#l15.994"></a><span id="l15.994">       else if (*s == '\n')</span>
<a href="#l15.995"></a><span id="l15.995">         buf.AppendLiteral(&quot;%0A&quot;);</span>
<a href="#l15.996"></a><span id="l15.996">       else if (*s == '\r')</span>
<a href="#l15.997"></a><span id="l15.997">         buf.AppendLiteral(&quot;%0D&quot;);</span>
<a href="#l15.998"></a><span id="l15.998">       else {</span>
<a href="#l15.999"></a><span id="l15.999" class="difflineminus">-        tmp[0]=*s;</span>
<a href="#l15.1000"></a><span id="l15.1000" class="difflineplus">+        tmp[0] = *s;</span>
<a href="#l15.1001"></a><span id="l15.1001">         buf.Append(tmp);</span>
<a href="#l15.1002"></a><span id="l15.1002">       }</span>
<a href="#l15.1003"></a><span id="l15.1003">       s++;</span>
<a href="#l15.1004"></a><span id="l15.1004">       col += (buf.Length() - ot);</span>
<a href="#l15.1005"></a><span id="l15.1005">     }</span>
<a href="#l15.1006"></a><span id="l15.1006">     buf.AppendLiteral(&quot;\&quot;&quot; CRLF);</span>
<a href="#l15.1007"></a><span id="l15.1007"> </span>
<a href="#l15.1008"></a><span id="l15.1008" class="difflineminus">-    /* rhp: this is to try to get around this fun problem with Content-Location */</span>
<a href="#l15.1009"></a><span id="l15.1009" class="difflineplus">+    /* rhp: this is to try to get around this fun problem with Content-Location</span>
<a href="#l15.1010"></a><span id="l15.1010" class="difflineplus">+     */</span>
<a href="#l15.1011"></a><span id="l15.1011">     if (!useContentLocation) {</span>
<a href="#l15.1012"></a><span id="l15.1012">       buf.AppendLiteral(&quot;Content-Location: \&quot;&quot;);</span>
<a href="#l15.1013"></a><span id="l15.1013">       s = base_url;</span>
<a href="#l15.1014"></a><span id="l15.1014">       col = 0;</span>
<a href="#l15.1015"></a><span id="l15.1015">       useContentLocation = true;</span>
<a href="#l15.1016"></a><span id="l15.1016">       goto CONTENT_LOC_HACK;</span>
<a href="#l15.1017"></a><span id="l15.1017">     }</span>
<a href="#l15.1018"></a><span id="l15.1018" class="difflineminus">-    /* rhp: this is to try to get around this fun problem with Content-Location */</span>
<a href="#l15.1019"></a><span id="l15.1019" class="difflineplus">+    /* rhp: this is to try to get around this fun problem with Content-Location</span>
<a href="#l15.1020"></a><span id="l15.1020" class="difflineplus">+     */</span>
<a href="#l15.1021"></a><span id="l15.1021"> </span>
<a href="#l15.1022"></a><span id="l15.1022" class="difflineminus">-GIVE_UP_ON_CONTENT_BASE:</span>
<a href="#l15.1023"></a><span id="l15.1023" class="difflineminus">-    ;</span>
<a href="#l15.1024"></a><span id="l15.1024" class="difflineplus">+  GIVE_UP_ON_CONTENT_BASE:;</span>
<a href="#l15.1025"></a><span id="l15.1025">   }</span>
<a href="#l15.1026"></a><span id="l15.1026"> #endif /* GENERATE_CONTENT_BASE */</span>
<a href="#l15.1027"></a><span id="l15.1027"> </span>
<a href="#l15.1028"></a><span id="l15.1028">   /* realloc it smaller... */</span>
<a href="#l15.1029"></a><span id="l15.1029"> </span>
<a href="#l15.1030"></a><span id="l15.1030"> #ifdef DEBUG_jungshik</span>
<a href="#l15.1031"></a><span id="l15.1031" class="difflineminus">-  printf (&quot;header=%s\n&quot;, buf.get());</span>
<a href="#l15.1032"></a><span id="l15.1032" class="difflineplus">+  printf(&quot;header=%s\n&quot;, buf.get());</span>
<a href="#l15.1033"></a><span id="l15.1033"> #endif</span>
<a href="#l15.1034"></a><span id="l15.1034">   PR_Free(encodedRealName);</span>
<a href="#l15.1035"></a><span id="l15.1035">   return PL_strdup(buf.get());</span>
<a href="#l15.1036"></a><span id="l15.1036"> }</span>
<a href="#l15.1037"></a><span id="l15.1037"> </span>
<a href="#l15.1038"></a><span id="l15.1038" class="difflineminus">-static bool isValidHost( const char* host )</span>
<a href="#l15.1039"></a><span id="l15.1039" class="difflineminus">-{</span>
<a href="#l15.1040"></a><span id="l15.1040" class="difflineminus">-  if ( host )</span>
<a href="#l15.1041"></a><span id="l15.1041" class="difflineplus">+static bool isValidHost(const char *host) {</span>
<a href="#l15.1042"></a><span id="l15.1042" class="difflineplus">+  if (host)</span>
<a href="#l15.1043"></a><span id="l15.1043">     for (const char *s = host; *s; ++s)</span>
<a href="#l15.1044"></a><span id="l15.1044" class="difflineminus">-      if  (  !isalpha(*s)</span>
<a href="#l15.1045"></a><span id="l15.1045" class="difflineminus">-         &amp;&amp; !isdigit(*s)</span>
<a href="#l15.1046"></a><span id="l15.1046" class="difflineminus">-         &amp;&amp; *s != '-'</span>
<a href="#l15.1047"></a><span id="l15.1047" class="difflineminus">-         &amp;&amp; *s != '_'</span>
<a href="#l15.1048"></a><span id="l15.1048" class="difflineminus">-         &amp;&amp; *s != '.'</span>
<a href="#l15.1049"></a><span id="l15.1049" class="difflineminus">-         )</span>
<a href="#l15.1050"></a><span id="l15.1050" class="difflineminus">-      {</span>
<a href="#l15.1051"></a><span id="l15.1051" class="difflineminus">-       host = nullptr;</span>
<a href="#l15.1052"></a><span id="l15.1052" class="difflineminus">-       break;</span>
<a href="#l15.1053"></a><span id="l15.1053" class="difflineplus">+      if (!isalpha(*s) &amp;&amp; !isdigit(*s) &amp;&amp; *s != '-' &amp;&amp; *s != '_' &amp;&amp; *s != '.') {</span>
<a href="#l15.1054"></a><span id="l15.1054" class="difflineplus">+        host = nullptr;</span>
<a href="#l15.1055"></a><span id="l15.1055" class="difflineplus">+        break;</span>
<a href="#l15.1056"></a><span id="l15.1056">       }</span>
<a href="#l15.1057"></a><span id="l15.1057"> </span>
<a href="#l15.1058"></a><span id="l15.1058">   return nullptr != host;</span>
<a href="#l15.1059"></a><span id="l15.1059"> }</span>
<a href="#l15.1060"></a><span id="l15.1060"> </span>
<a href="#l15.1061"></a><span id="l15.1061" class="difflineminus">-char *</span>
<a href="#l15.1062"></a><span id="l15.1062" class="difflineminus">-msg_generate_message_id (nsIMsgIdentity *identity)</span>
<a href="#l15.1063"></a><span id="l15.1063" class="difflineminus">-{</span>
<a href="#l15.1064"></a><span id="l15.1064" class="difflineplus">+char *msg_generate_message_id(nsIMsgIdentity *identity) {</span>
<a href="#l15.1065"></a><span id="l15.1065">   const char *host = 0;</span>
<a href="#l15.1066"></a><span id="l15.1066"> </span>
<a href="#l15.1067"></a><span id="l15.1067">   nsCString forcedFQDN;</span>
<a href="#l15.1068"></a><span id="l15.1068">   nsCString from;</span>
<a href="#l15.1069"></a><span id="l15.1069">   nsresult rv = NS_OK;</span>
<a href="#l15.1070"></a><span id="l15.1070"> </span>
<a href="#l15.1071"></a><span id="l15.1071">   rv = identity-&gt;GetCharAttribute(&quot;FQDN&quot;, forcedFQDN);</span>
<a href="#l15.1072"></a><span id="l15.1072"> </span>
<a href="#l15.1073"></a><span id="l15.1073" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; !forcedFQDN.IsEmpty())</span>
<a href="#l15.1074"></a><span id="l15.1074" class="difflineminus">-    host = forcedFQDN.get();</span>
<a href="#l15.1075"></a><span id="l15.1075" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !forcedFQDN.IsEmpty()) host = forcedFQDN.get();</span>
<a href="#l15.1076"></a><span id="l15.1076"> </span>
<a href="#l15.1077"></a><span id="l15.1077" class="difflineminus">-  if (!isValidHost(host))</span>
<a href="#l15.1078"></a><span id="l15.1078" class="difflineminus">-  {</span>
<a href="#l15.1079"></a><span id="l15.1079" class="difflineplus">+  if (!isValidHost(host)) {</span>
<a href="#l15.1080"></a><span id="l15.1080">     nsresult rv = identity-&gt;GetEmail(from);</span>
<a href="#l15.1081"></a><span id="l15.1081" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; !from.IsEmpty())</span>
<a href="#l15.1082"></a><span id="l15.1082" class="difflineminus">-      host = strchr(from.get(),'@');</span>
<a href="#l15.1083"></a><span id="l15.1083" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; !from.IsEmpty()) host = strchr(from.get(), '@');</span>
<a href="#l15.1084"></a><span id="l15.1084"> </span>
<a href="#l15.1085"></a><span id="l15.1085">     // No '@'? Munged address, anti-spam?</span>
<a href="#l15.1086"></a><span id="l15.1086">     // see bug #197203</span>
<a href="#l15.1087"></a><span id="l15.1087" class="difflineminus">-    if (host)</span>
<a href="#l15.1088"></a><span id="l15.1088" class="difflineminus">-      ++host;</span>
<a href="#l15.1089"></a><span id="l15.1089" class="difflineplus">+    if (host) ++host;</span>
<a href="#l15.1090"></a><span id="l15.1090">   }</span>
<a href="#l15.1091"></a><span id="l15.1091"> </span>
<a href="#l15.1092"></a><span id="l15.1092">   if (!isValidHost(host))</span>
<a href="#l15.1093"></a><span id="l15.1093" class="difflineminus">-  /* If we couldn't find a valid host name to use, we can't generate a</span>
<a href="#l15.1094"></a><span id="l15.1094" class="difflineminus">-     valid message ID, so bail, and let NNTP and SMTP generate them. */</span>
<a href="#l15.1095"></a><span id="l15.1095" class="difflineplus">+    /* If we couldn't find a valid host name to use, we can't generate a</span>
<a href="#l15.1096"></a><span id="l15.1096" class="difflineplus">+       valid message ID, so bail, and let NNTP and SMTP generate them. */</span>
<a href="#l15.1097"></a><span id="l15.1097">     return 0;</span>
<a href="#l15.1098"></a><span id="l15.1098"> </span>
<a href="#l15.1099"></a><span id="l15.1099">   // Generate 128-bit UUID for the local part. We use the high-entropy</span>
<a href="#l15.1100"></a><span id="l15.1100">   // GenerateGlobalRandomBytes to make tracking more difficult.</span>
<a href="#l15.1101"></a><span id="l15.1101">   nsID uuid;</span>
<a href="#l15.1102"></a><span id="l15.1102" class="difflineminus">-  GenerateGlobalRandomBytes((unsigned char*) &amp;uuid, sizeof(nsID));</span>
<a href="#l15.1103"></a><span id="l15.1103" class="difflineplus">+  GenerateGlobalRandomBytes((unsigned char *)&amp;uuid, sizeof(nsID));</span>
<a href="#l15.1104"></a><span id="l15.1104">   char uuidString[NSID_LENGTH];</span>
<a href="#l15.1105"></a><span id="l15.1105">   uuid.ToProvidedString(uuidString);</span>
<a href="#l15.1106"></a><span id="l15.1106">   // Drop first and last characters (curly braces).</span>
<a href="#l15.1107"></a><span id="l15.1107">   uuidString[NSID_LENGTH - 2] = 0;</span>
<a href="#l15.1108"></a><span id="l15.1108">   return PR_smprintf(&quot;&lt;%s@%s&gt;&quot;, uuidString + 1, host);</span>
<a href="#l15.1109"></a><span id="l15.1109"> }</span>
<a href="#l15.1110"></a><span id="l15.1110"> </span>
<a href="#l15.1111"></a><span id="l15.1111" class="difflineminus">-#define PR_MAX_FOLDING_LEN 75     // this is to guarantee the folded line will</span>
<a href="#l15.1112"></a><span id="l15.1112" class="difflineminus">-                                  // never be greater than 78 = 75 + CRLFLWSP</span>
<a href="#l15.1113"></a><span id="l15.1113" class="difflineminus">-/*static */ char *</span>
<a href="#l15.1114"></a><span id="l15.1114" class="difflineminus">-RFC2231ParmFolding(const char *parmName, const char *parmValue)</span>
<a href="#l15.1115"></a><span id="l15.1115" class="difflineminus">-{</span>
<a href="#l15.1116"></a><span id="l15.1116" class="difflineplus">+// this is to guarantee the folded line will never be greater</span>
<a href="#l15.1117"></a><span id="l15.1117" class="difflineplus">+// than 78 = 75 + CRLFLWSP</span>
<a href="#l15.1118"></a><span id="l15.1118" class="difflineplus">+#define PR_MAX_FOLDING_LEN 75</span>
<a href="#l15.1119"></a><span id="l15.1119" class="difflineplus">+</span>
<a href="#l15.1120"></a><span id="l15.1120" class="difflineplus">+/*static */ char *RFC2231ParmFolding(const char *parmName,</span>
<a href="#l15.1121"></a><span id="l15.1121" class="difflineplus">+                                     const char *parmValue) {</span>
<a href="#l15.1122"></a><span id="l15.1122">   NS_ENSURE_TRUE(parmName &amp;&amp; *parmName &amp;&amp; parmValue &amp;&amp; *parmValue, nullptr);</span>
<a href="#l15.1123"></a><span id="l15.1123"> </span>
<a href="#l15.1124"></a><span id="l15.1124">   bool needEscape;</span>
<a href="#l15.1125"></a><span id="l15.1125">   nsCString dupParm;</span>
<a href="#l15.1126"></a><span id="l15.1126">   nsCString charset(&quot;UTF-8&quot;);</span>
<a href="#l15.1127"></a><span id="l15.1127"> </span>
<a href="#l15.1128"></a><span id="l15.1128">   if (!mozilla::IsAsciiNullTerminated(parmValue)) {</span>
<a href="#l15.1129"></a><span id="l15.1129">     needEscape = true;</span>
<a href="#l15.1130"></a><span id="l15.1130">     dupParm.Assign(parmValue);</span>
<a href="#l15.1131"></a><span id="l15.1131">     MsgEscapeString(dupParm, nsINetUtil::ESCAPE_ALL, dupParm);</span>
<a href="#l15.1132"></a><span id="l15.1132" class="difflineminus">-  }</span>
<a href="#l15.1133"></a><span id="l15.1133" class="difflineminus">-  else {</span>
<a href="#l15.1134"></a><span id="l15.1134" class="difflineplus">+  } else {</span>
<a href="#l15.1135"></a><span id="l15.1135">     needEscape = false;</span>
<a href="#l15.1136"></a><span id="l15.1136">     dupParm.Adopt(msg_make_filename_qtext(parmValue, true));</span>
<a href="#l15.1137"></a><span id="l15.1137">   }</span>
<a href="#l15.1138"></a><span id="l15.1138"> </span>
<a href="#l15.1139"></a><span id="l15.1139">   int32_t parmNameLen = PL_strlen(parmName);</span>
<a href="#l15.1140"></a><span id="l15.1140">   int32_t parmValueLen = dupParm.Length();</span>
<a href="#l15.1141"></a><span id="l15.1141"> </span>
<a href="#l15.1142"></a><span id="l15.1142">   parmNameLen += 5;  // *=__'__'___ or *[0]*=__'__'__ or *[1]*=___ or *[0]=&quot;___&quot;</span>
<a href="#l15.1143"></a><span id="l15.1143"> </span>
<a href="#l15.1144"></a><span id="l15.1144">   char *foldedParm = nullptr;</span>
<a href="#l15.1145"></a><span id="l15.1145"> </span>
<a href="#l15.1146"></a><span id="l15.1146" class="difflineminus">-  if ((parmValueLen + parmNameLen + strlen(&quot;UTF-8&quot;)) &lt; PR_MAX_FOLDING_LEN)</span>
<a href="#l15.1147"></a><span id="l15.1147" class="difflineminus">-  {</span>
<a href="#l15.1148"></a><span id="l15.1148" class="difflineplus">+  if ((parmValueLen + parmNameLen + strlen(&quot;UTF-8&quot;)) &lt; PR_MAX_FOLDING_LEN) {</span>
<a href="#l15.1149"></a><span id="l15.1149">     foldedParm = PL_strdup(parmName);</span>
<a href="#l15.1150"></a><span id="l15.1150" class="difflineminus">-    if (needEscape)</span>
<a href="#l15.1151"></a><span id="l15.1151" class="difflineminus">-    {</span>
<a href="#l15.1152"></a><span id="l15.1152" class="difflineplus">+    if (needEscape) {</span>
<a href="#l15.1153"></a><span id="l15.1153">       NS_MsgSACat(&amp;foldedParm, &quot;*=&quot;);</span>
<a href="#l15.1154"></a><span id="l15.1154">       NS_MsgSACat(&amp;foldedParm, &quot;UTF-8&quot;);</span>
<a href="#l15.1155"></a><span id="l15.1155" class="difflineminus">-      NS_MsgSACat(&amp;foldedParm, &quot;''&quot;); // We don't support language.</span>
<a href="#l15.1156"></a><span id="l15.1156" class="difflineminus">-    }</span>
<a href="#l15.1157"></a><span id="l15.1157" class="difflineminus">-    else</span>
<a href="#l15.1158"></a><span id="l15.1158" class="difflineplus">+      NS_MsgSACat(&amp;foldedParm, &quot;''&quot;);  // We don't support language.</span>
<a href="#l15.1159"></a><span id="l15.1159" class="difflineplus">+    } else</span>
<a href="#l15.1160"></a><span id="l15.1160">       NS_MsgSACat(&amp;foldedParm, &quot;=\&quot;&quot;);</span>
<a href="#l15.1161"></a><span id="l15.1161">     NS_MsgSACat(&amp;foldedParm, dupParm.get());</span>
<a href="#l15.1162"></a><span id="l15.1162" class="difflineminus">-    if (!needEscape)</span>
<a href="#l15.1163"></a><span id="l15.1163" class="difflineminus">-      NS_MsgSACat(&amp;foldedParm, &quot;\&quot;&quot;);</span>
<a href="#l15.1164"></a><span id="l15.1164" class="difflineminus">-  }</span>
<a href="#l15.1165"></a><span id="l15.1165" class="difflineminus">-  else</span>
<a href="#l15.1166"></a><span id="l15.1166" class="difflineminus">-  {</span>
<a href="#l15.1167"></a><span id="l15.1167" class="difflineplus">+    if (!needEscape) NS_MsgSACat(&amp;foldedParm, &quot;\&quot;&quot;);</span>
<a href="#l15.1168"></a><span id="l15.1168" class="difflineplus">+  } else {</span>
<a href="#l15.1169"></a><span id="l15.1169">     int curLineLen = 0;</span>
<a href="#l15.1170"></a><span id="l15.1170">     int counter = 0;</span>
<a href="#l15.1171"></a><span id="l15.1171">     char digits[32];</span>
<a href="#l15.1172"></a><span id="l15.1172">     char *start = dupParm.BeginWriting();</span>
<a href="#l15.1173"></a><span id="l15.1173">     char *end = NULL;</span>
<a href="#l15.1174"></a><span id="l15.1174">     char tmp = 0;</span>
<a href="#l15.1175"></a><span id="l15.1175"> </span>
<a href="#l15.1176"></a><span id="l15.1176" class="difflineminus">-    while (parmValueLen &gt; 0)</span>
<a href="#l15.1177"></a><span id="l15.1177" class="difflineminus">-    {</span>
<a href="#l15.1178"></a><span id="l15.1178" class="difflineplus">+    while (parmValueLen &gt; 0) {</span>
<a href="#l15.1179"></a><span id="l15.1179">       curLineLen = 0;</span>
<a href="#l15.1180"></a><span id="l15.1180">       if (counter == 0) {</span>
<a href="#l15.1181"></a><span id="l15.1181">         PR_FREEIF(foldedParm)</span>
<a href="#l15.1182"></a><span id="l15.1182">         foldedParm = PL_strdup(parmName);</span>
<a href="#l15.1183"></a><span id="l15.1183" class="difflineminus">-      }</span>
<a href="#l15.1184"></a><span id="l15.1184" class="difflineminus">-      else {</span>
<a href="#l15.1185"></a><span id="l15.1185" class="difflineplus">+      } else {</span>
<a href="#l15.1186"></a><span id="l15.1186">         NS_MsgSACat(&amp;foldedParm, &quot;;\r\n &quot;);</span>
<a href="#l15.1187"></a><span id="l15.1187">         NS_MsgSACat(&amp;foldedParm, parmName);</span>
<a href="#l15.1188"></a><span id="l15.1188">       }</span>
<a href="#l15.1189"></a><span id="l15.1189">       PR_snprintf(digits, sizeof(digits), &quot;*%d&quot;, counter);</span>
<a href="#l15.1190"></a><span id="l15.1190">       NS_MsgSACat(&amp;foldedParm, digits);</span>
<a href="#l15.1191"></a><span id="l15.1191">       curLineLen += PL_strlen(digits);</span>
<a href="#l15.1192"></a><span id="l15.1192" class="difflineminus">-      if (needEscape)</span>
<a href="#l15.1193"></a><span id="l15.1193" class="difflineminus">-      {</span>
<a href="#l15.1194"></a><span id="l15.1194" class="difflineplus">+      if (needEscape) {</span>
<a href="#l15.1195"></a><span id="l15.1195">         NS_MsgSACat(&amp;foldedParm, &quot;*=&quot;);</span>
<a href="#l15.1196"></a><span id="l15.1196" class="difflineminus">-        if (counter == 0)</span>
<a href="#l15.1197"></a><span id="l15.1197" class="difflineminus">-        {</span>
<a href="#l15.1198"></a><span id="l15.1198" class="difflineplus">+        if (counter == 0) {</span>
<a href="#l15.1199"></a><span id="l15.1199">           NS_MsgSACat(&amp;foldedParm, &quot;UTF-8&quot;);</span>
<a href="#l15.1200"></a><span id="l15.1200" class="difflineminus">-          NS_MsgSACat(&amp;foldedParm, &quot;''&quot;); // We don't support language.</span>
<a href="#l15.1201"></a><span id="l15.1201" class="difflineplus">+          NS_MsgSACat(&amp;foldedParm, &quot;''&quot;);  // We don't support language.</span>
<a href="#l15.1202"></a><span id="l15.1202">           curLineLen += strlen(&quot;UTF-8&quot;);</span>
<a href="#l15.1203"></a><span id="l15.1203">         }</span>
<a href="#l15.1204"></a><span id="l15.1204" class="difflineminus">-      }</span>
<a href="#l15.1205"></a><span id="l15.1205" class="difflineminus">-      else</span>
<a href="#l15.1206"></a><span id="l15.1206" class="difflineminus">-      {</span>
<a href="#l15.1207"></a><span id="l15.1207" class="difflineplus">+      } else {</span>
<a href="#l15.1208"></a><span id="l15.1208">         NS_MsgSACat(&amp;foldedParm, &quot;=\&quot;&quot;);</span>
<a href="#l15.1209"></a><span id="l15.1209">       }</span>
<a href="#l15.1210"></a><span id="l15.1210">       counter++;</span>
<a href="#l15.1211"></a><span id="l15.1211">       curLineLen += parmNameLen;</span>
<a href="#l15.1212"></a><span id="l15.1212">       if (parmValueLen &lt;= PR_MAX_FOLDING_LEN - curLineLen)</span>
<a href="#l15.1213"></a><span id="l15.1213">         end = start + parmValueLen;</span>
<a href="#l15.1214"></a><span id="l15.1214">       else</span>
<a href="#l15.1215"></a><span id="l15.1215">         end = start + (PR_MAX_FOLDING_LEN - curLineLen);</span>
<a href="#l15.1216"></a><span id="l15.1216"> </span>
<a href="#l15.1217"></a><span id="l15.1217">       tmp = 0;</span>
<a href="#l15.1218"></a><span id="l15.1218" class="difflineminus">-      if (*end &amp;&amp; needEscape)</span>
<a href="#l15.1219"></a><span id="l15.1219" class="difflineminus">-      {</span>
<a href="#l15.1220"></a><span id="l15.1220" class="difflineplus">+      if (*end &amp;&amp; needEscape) {</span>
<a href="#l15.1221"></a><span id="l15.1221">         // Check to see if we are in the middle of escaped char.</span>
<a href="#l15.1222"></a><span id="l15.1222">         // We use ESCAPE_ALL, so every third character is a '%'.</span>
<a href="#l15.1223"></a><span id="l15.1223">         if (end - 1 &gt; start &amp;&amp; *(end - 1) == '%') {</span>
<a href="#l15.1224"></a><span id="l15.1224">           end -= 1;</span>
<a href="#l15.1225"></a><span id="l15.1225">         } else if (end - 2 &gt; start &amp;&amp; *(end - 2) == '%') {</span>
<a href="#l15.1226"></a><span id="l15.1226">           end -= 2;</span>
<a href="#l15.1227"></a><span id="l15.1227">         }</span>
<a href="#l15.1228"></a><span id="l15.1228">         // *end is now a '%'.</span>
<a href="#l15.1229"></a><span id="l15.1229">         // Check if the following UTF-8 octet is a continuation.</span>
<a href="#l15.1230"></a><span id="l15.1230" class="difflineminus">-        while (end - 3 &gt; start &amp;&amp;</span>
<a href="#l15.1231"></a><span id="l15.1231" class="difflineminus">-               (*(end + 1) == '8' || *(end + 1) == '9' ||</span>
<a href="#l15.1232"></a><span id="l15.1232" class="difflineminus">-                *(end + 1) == 'A' || *(end + 1) == 'B')) {</span>
<a href="#l15.1233"></a><span id="l15.1233" class="difflineplus">+        while (end - 3 &gt; start &amp;&amp; (*(end + 1) == '8' || *(end + 1) == '9' ||</span>
<a href="#l15.1234"></a><span id="l15.1234" class="difflineplus">+                                   *(end + 1) == 'A' || *(end + 1) == 'B')) {</span>
<a href="#l15.1235"></a><span id="l15.1235">           end -= 3;</span>
<a href="#l15.1236"></a><span id="l15.1236">         }</span>
<a href="#l15.1237"></a><span id="l15.1237" class="difflineminus">-        tmp = *end; *end = 0;</span>
<a href="#l15.1238"></a><span id="l15.1238" class="difflineminus">-      }</span>
<a href="#l15.1239"></a><span id="l15.1239" class="difflineminus">-      else</span>
<a href="#l15.1240"></a><span id="l15.1240" class="difflineminus">-      {</span>
<a href="#l15.1241"></a><span id="l15.1241" class="difflineminus">-        tmp = *end; *end = 0;</span>
<a href="#l15.1242"></a><span id="l15.1242" class="difflineplus">+        tmp = *end;</span>
<a href="#l15.1243"></a><span id="l15.1243" class="difflineplus">+        *end = 0;</span>
<a href="#l15.1244"></a><span id="l15.1244" class="difflineplus">+      } else {</span>
<a href="#l15.1245"></a><span id="l15.1245" class="difflineplus">+        tmp = *end;</span>
<a href="#l15.1246"></a><span id="l15.1246" class="difflineplus">+        *end = 0;</span>
<a href="#l15.1247"></a><span id="l15.1247">       }</span>
<a href="#l15.1248"></a><span id="l15.1248">       NS_MsgSACat(&amp;foldedParm, start);</span>
<a href="#l15.1249"></a><span id="l15.1249" class="difflineminus">-      if (!needEscape)</span>
<a href="#l15.1250"></a><span id="l15.1250" class="difflineminus">-        NS_MsgSACat(&amp;foldedParm, &quot;\&quot;&quot;);</span>
<a href="#l15.1251"></a><span id="l15.1251" class="difflineplus">+      if (!needEscape) NS_MsgSACat(&amp;foldedParm, &quot;\&quot;&quot;);</span>
<a href="#l15.1252"></a><span id="l15.1252"> </span>
<a href="#l15.1253"></a><span id="l15.1253" class="difflineminus">-      parmValueLen -= (end-start);</span>
<a href="#l15.1254"></a><span id="l15.1254" class="difflineminus">-      if (tmp)</span>
<a href="#l15.1255"></a><span id="l15.1255" class="difflineminus">-        *end = tmp;</span>
<a href="#l15.1256"></a><span id="l15.1256" class="difflineplus">+      parmValueLen -= (end - start);</span>
<a href="#l15.1257"></a><span id="l15.1257" class="difflineplus">+      if (tmp) *end = tmp;</span>
<a href="#l15.1258"></a><span id="l15.1258">       start = end;</span>
<a href="#l15.1259"></a><span id="l15.1259">     }</span>
<a href="#l15.1260"></a><span id="l15.1260">   }</span>
<a href="#l15.1261"></a><span id="l15.1261"> </span>
<a href="#l15.1262"></a><span id="l15.1262">   return foldedParm;</span>
<a href="#l15.1263"></a><span id="l15.1263"> }</span>
<a href="#l15.1264"></a><span id="l15.1264"> </span>
<a href="#l15.1265"></a><span id="l15.1265" class="difflineminus">-/*static */ char *</span>
<a href="#l15.1266"></a><span id="l15.1266" class="difflineminus">-LegacyParmFolding(const nsCString&amp; aCharset,</span>
<a href="#l15.1267"></a><span id="l15.1267" class="difflineminus">-                  const nsCString&amp; aFileName, int32_t aParmFolding)</span>
<a href="#l15.1268"></a><span id="l15.1268" class="difflineminus">-{</span>
<a href="#l15.1269"></a><span id="l15.1269" class="difflineplus">+/*static */ char *LegacyParmFolding(const nsCString &amp;aCharset,</span>
<a href="#l15.1270"></a><span id="l15.1270" class="difflineplus">+                                    const nsCString &amp;aFileName,</span>
<a href="#l15.1271"></a><span id="l15.1271" class="difflineplus">+                                    int32_t aParmFolding) {</span>
<a href="#l15.1272"></a><span id="l15.1272">   bool usemime = nsMsgMIMEGetConformToStandard();</span>
<a href="#l15.1273"></a><span id="l15.1273" class="difflineminus">-  char *encodedRealName =</span>
<a href="#l15.1274"></a><span id="l15.1274" class="difflineminus">-    nsMsgI18NEncodeMimePartIIStr(aFileName.get(), false, aCharset.get(),</span>
<a href="#l15.1275"></a><span id="l15.1275" class="difflineminus">-                                 0, usemime);</span>
<a href="#l15.1276"></a><span id="l15.1276" class="difflineplus">+  char *encodedRealName = nsMsgI18NEncodeMimePartIIStr(</span>
<a href="#l15.1277"></a><span id="l15.1277" class="difflineplus">+      aFileName.get(), false, aCharset.get(), 0, usemime);</span>
<a href="#l15.1278"></a><span id="l15.1278"> </span>
<a href="#l15.1279"></a><span id="l15.1279">   if (!encodedRealName || !*encodedRealName) {</span>
<a href="#l15.1280"></a><span id="l15.1280">     PR_FREEIF(encodedRealName);</span>
<a href="#l15.1281"></a><span id="l15.1281" class="difflineminus">-    encodedRealName = (char *) PR_Malloc(aFileName.Length() + 1);</span>
<a href="#l15.1282"></a><span id="l15.1282" class="difflineminus">-    if (encodedRealName)</span>
<a href="#l15.1283"></a><span id="l15.1283" class="difflineminus">-      PL_strcpy(encodedRealName, aFileName.get());</span>
<a href="#l15.1284"></a><span id="l15.1284" class="difflineplus">+    encodedRealName = (char *)PR_Malloc(aFileName.Length() + 1);</span>
<a href="#l15.1285"></a><span id="l15.1285" class="difflineplus">+    if (encodedRealName) PL_strcpy(encodedRealName, aFileName.get());</span>
<a href="#l15.1286"></a><span id="l15.1286">   }</span>
<a href="#l15.1287"></a><span id="l15.1287"> </span>
<a href="#l15.1288"></a><span id="l15.1288">   // Now put backslashes before special characters per RFC 822</span>
<a href="#l15.1289"></a><span id="l15.1289" class="difflineminus">-  char *qtextName =</span>
<a href="#l15.1290"></a><span id="l15.1290" class="difflineminus">-    msg_make_filename_qtext(encodedRealName, aParmFolding == 0);</span>
<a href="#l15.1291"></a><span id="l15.1291" class="difflineplus">+  char *qtextName = msg_make_filename_qtext(encodedRealName, aParmFolding == 0);</span>
<a href="#l15.1292"></a><span id="l15.1292">   if (qtextName) {</span>
<a href="#l15.1293"></a><span id="l15.1293">     PR_FREEIF(encodedRealName);</span>
<a href="#l15.1294"></a><span id="l15.1294">     encodedRealName = qtextName;</span>
<a href="#l15.1295"></a><span id="l15.1295">   }</span>
<a href="#l15.1296"></a><span id="l15.1296">   return encodedRealName;</span>
<a href="#l15.1297"></a><span id="l15.1297"> }</span>
<a href="#l15.1298"></a><span id="l15.1298"> </span>
<a href="#l15.1299"></a><span id="l15.1299" class="difflineminus">-bool</span>
<a href="#l15.1300"></a><span id="l15.1300" class="difflineminus">-mime_7bit_data_p (const char *string, uint32_t size)</span>
<a href="#l15.1301"></a><span id="l15.1301" class="difflineminus">-{</span>
<a href="#l15.1302"></a><span id="l15.1302" class="difflineminus">-  if ((!string) || (!*string))</span>
<a href="#l15.1303"></a><span id="l15.1303" class="difflineminus">-    return true;</span>
<a href="#l15.1304"></a><span id="l15.1304" class="difflineplus">+bool mime_7bit_data_p(const char *string, uint32_t size) {</span>
<a href="#l15.1305"></a><span id="l15.1305" class="difflineplus">+  if ((!string) || (!*string)) return true;</span>
<a href="#l15.1306"></a><span id="l15.1306"> </span>
<a href="#l15.1307"></a><span id="l15.1307">   char *ptr = (char *)string;</span>
<a href="#l15.1308"></a><span id="l15.1308" class="difflineminus">-  for (uint32_t i=0; i&lt;size; i++)</span>
<a href="#l15.1309"></a><span id="l15.1309" class="difflineminus">-  {</span>
<a href="#l15.1310"></a><span id="l15.1310" class="difflineminus">-    if ((unsigned char) ptr[i] &gt; 0x7F)</span>
<a href="#l15.1311"></a><span id="l15.1311" class="difflineminus">-      return false;</span>
<a href="#l15.1312"></a><span id="l15.1312" class="difflineplus">+  for (uint32_t i = 0; i &lt; size; i++) {</span>
<a href="#l15.1313"></a><span id="l15.1313" class="difflineplus">+    if ((unsigned char)ptr[i] &gt; 0x7F) return false;</span>
<a href="#l15.1314"></a><span id="l15.1314">   }</span>
<a href="#l15.1315"></a><span id="l15.1315">   return true;</span>
<a href="#l15.1316"></a><span id="l15.1316"> }</span>
<a href="#l15.1317"></a><span id="l15.1317"> </span>
<a href="#l15.1318"></a><span id="l15.1318"> /* Strips whitespace, and expands newlines into newline-tab for use in</span>
<a href="#l15.1319"></a><span id="l15.1319">    mail headers.  Returns a new string or 0 (if it would have been empty.)</span>
<a href="#l15.1320"></a><span id="l15.1320">    If addr_p is true, the addresses will be parsed and reemitted as</span>
<a href="#l15.1321"></a><span id="l15.1321">    rfc822 mailboxes.</span>
<a href="#l15.1322"></a><span id="l15.1322">  */</span>
<a href="#l15.1323"></a><span id="l15.1323" class="difflineminus">-char *</span>
<a href="#l15.1324"></a><span id="l15.1324" class="difflineminus">-mime_fix_header_1 (const char *string, bool addr_p, bool news_p)</span>
<a href="#l15.1325"></a><span id="l15.1325" class="difflineminus">-{</span>
<a href="#l15.1326"></a><span id="l15.1326" class="difflineplus">+char *mime_fix_header_1(const char *string, bool addr_p, bool news_p) {</span>
<a href="#l15.1327"></a><span id="l15.1327">   char *new_string;</span>
<a href="#l15.1328"></a><span id="l15.1328">   const char *in;</span>
<a href="#l15.1329"></a><span id="l15.1329">   char *out;</span>
<a href="#l15.1330"></a><span id="l15.1330">   int32_t i, old_size, new_size;</span>
<a href="#l15.1331"></a><span id="l15.1331"> </span>
<a href="#l15.1332"></a><span id="l15.1332" class="difflineminus">-  if (!string || !*string)</span>
<a href="#l15.1333"></a><span id="l15.1333" class="difflineminus">-    return 0;</span>
<a href="#l15.1334"></a><span id="l15.1334" class="difflineplus">+  if (!string || !*string) return 0;</span>
<a href="#l15.1335"></a><span id="l15.1335"> </span>
<a href="#l15.1336"></a><span id="l15.1336">   if (addr_p) {</span>
<a href="#l15.1337"></a><span id="l15.1337">     return strdup(string);</span>
<a href="#l15.1338"></a><span id="l15.1338">   }</span>
<a href="#l15.1339"></a><span id="l15.1339"> </span>
<a href="#l15.1340"></a><span id="l15.1340" class="difflineminus">-  old_size = PL_strlen (string);</span>
<a href="#l15.1341"></a><span id="l15.1341" class="difflineplus">+  old_size = PL_strlen(string);</span>
<a href="#l15.1342"></a><span id="l15.1342">   new_size = old_size;</span>
<a href="#l15.1343"></a><span id="l15.1343">   for (i = 0; i &lt; old_size; i++)</span>
<a href="#l15.1344"></a><span id="l15.1344" class="difflineminus">-    if (string[i] == '\r' || string[i] == '\n')</span>
<a href="#l15.1345"></a><span id="l15.1345" class="difflineminus">-      new_size += 2;</span>
<a href="#l15.1346"></a><span id="l15.1346" class="difflineplus">+    if (string[i] == '\r' || string[i] == '\n') new_size += 2;</span>
<a href="#l15.1347"></a><span id="l15.1347"> </span>
<a href="#l15.1348"></a><span id="l15.1348" class="difflineminus">-  new_string = (char *) PR_Malloc (new_size + 1);</span>
<a href="#l15.1349"></a><span id="l15.1349" class="difflineminus">-  if (! new_string)</span>
<a href="#l15.1350"></a><span id="l15.1350" class="difflineminus">-    return 0;</span>
<a href="#l15.1351"></a><span id="l15.1351" class="difflineplus">+  new_string = (char *)PR_Malloc(new_size + 1);</span>
<a href="#l15.1352"></a><span id="l15.1352" class="difflineplus">+  if (!new_string) return 0;</span>
<a href="#l15.1353"></a><span id="l15.1353"> </span>
<a href="#l15.1354"></a><span id="l15.1354" class="difflineminus">-  in  = string;</span>
<a href="#l15.1355"></a><span id="l15.1355" class="difflineplus">+  in = string;</span>
<a href="#l15.1356"></a><span id="l15.1356">   out = new_string;</span>
<a href="#l15.1357"></a><span id="l15.1357"> </span>
<a href="#l15.1358"></a><span id="l15.1358">   /* strip leading whitespace. */</span>
<a href="#l15.1359"></a><span id="l15.1359" class="difflineminus">-  while (IS_SPACE (*in))</span>
<a href="#l15.1360"></a><span id="l15.1360" class="difflineminus">-    in++;</span>
<a href="#l15.1361"></a><span id="l15.1361" class="difflineplus">+  while (IS_SPACE(*in)) in++;</span>
<a href="#l15.1362"></a><span id="l15.1362"> </span>
<a href="#l15.1363"></a><span id="l15.1363">   /* replace CR, LF, or CRLF with CRLF-TAB. */</span>
<a href="#l15.1364"></a><span id="l15.1364">   while (*in) {</span>
<a href="#l15.1365"></a><span id="l15.1365">     if (*in == '\r' || *in == '\n') {</span>
<a href="#l15.1366"></a><span id="l15.1366" class="difflineminus">-      if (*in == '\r' &amp;&amp; in[1] == '\n')</span>
<a href="#l15.1367"></a><span id="l15.1367" class="difflineminus">-        in++;</span>
<a href="#l15.1368"></a><span id="l15.1368" class="difflineplus">+      if (*in == '\r' &amp;&amp; in[1] == '\n') in++;</span>
<a href="#l15.1369"></a><span id="l15.1369">       in++;</span>
<a href="#l15.1370"></a><span id="l15.1370">       *out++ = '\r';</span>
<a href="#l15.1371"></a><span id="l15.1371">       *out++ = '\n';</span>
<a href="#l15.1372"></a><span id="l15.1372">       *out++ = '\t';</span>
<a href="#l15.1373"></a><span id="l15.1373" class="difflineminus">-    }</span>
<a href="#l15.1374"></a><span id="l15.1374" class="difflineminus">-    else</span>
<a href="#l15.1375"></a><span id="l15.1375" class="difflineminus">-      if (news_p &amp;&amp; *in == ',') {</span>
<a href="#l15.1376"></a><span id="l15.1376" class="difflineminus">-        *out++ = *in++;</span>
<a href="#l15.1377"></a><span id="l15.1377" class="difflineminus">-        /* skip over all whitespace after a comma. */</span>
<a href="#l15.1378"></a><span id="l15.1378" class="difflineminus">-        while (IS_SPACE (*in))</span>
<a href="#l15.1379"></a><span id="l15.1379" class="difflineminus">-          in++;</span>
<a href="#l15.1380"></a><span id="l15.1380" class="difflineminus">-      }</span>
<a href="#l15.1381"></a><span id="l15.1381" class="difflineminus">-      else</span>
<a href="#l15.1382"></a><span id="l15.1382" class="difflineminus">-        *out++ = *in++;</span>
<a href="#l15.1383"></a><span id="l15.1383" class="difflineplus">+    } else if (news_p &amp;&amp; *in == ',') {</span>
<a href="#l15.1384"></a><span id="l15.1384" class="difflineplus">+      *out++ = *in++;</span>
<a href="#l15.1385"></a><span id="l15.1385" class="difflineplus">+      /* skip over all whitespace after a comma. */</span>
<a href="#l15.1386"></a><span id="l15.1386" class="difflineplus">+      while (IS_SPACE(*in)) in++;</span>
<a href="#l15.1387"></a><span id="l15.1387" class="difflineplus">+    } else</span>
<a href="#l15.1388"></a><span id="l15.1388" class="difflineplus">+      *out++ = *in++;</span>
<a href="#l15.1389"></a><span id="l15.1389">   }</span>
<a href="#l15.1390"></a><span id="l15.1390">   *out = 0;</span>
<a href="#l15.1391"></a><span id="l15.1391"> </span>
<a href="#l15.1392"></a><span id="l15.1392">   /* strip trailing whitespace. */</span>
<a href="#l15.1393"></a><span id="l15.1393" class="difflineminus">-  while (out &gt; in &amp;&amp; IS_SPACE (out[-1]))</span>
<a href="#l15.1394"></a><span id="l15.1394" class="difflineminus">-    *out-- = 0;</span>
<a href="#l15.1395"></a><span id="l15.1395" class="difflineplus">+  while (out &gt; in &amp;&amp; IS_SPACE(out[-1])) *out-- = 0;</span>
<a href="#l15.1396"></a><span id="l15.1396"> </span>
<a href="#l15.1397"></a><span id="l15.1397">   /* If we ended up throwing it all away, use 0 instead of &quot;&quot;. */</span>
<a href="#l15.1398"></a><span id="l15.1398">   if (!*new_string) {</span>
<a href="#l15.1399"></a><span id="l15.1399" class="difflineminus">-    PR_Free (new_string);</span>
<a href="#l15.1400"></a><span id="l15.1400" class="difflineplus">+    PR_Free(new_string);</span>
<a href="#l15.1401"></a><span id="l15.1401">     new_string = 0;</span>
<a href="#l15.1402"></a><span id="l15.1402">   }</span>
<a href="#l15.1403"></a><span id="l15.1403"> </span>
<a href="#l15.1404"></a><span id="l15.1404">   return new_string;</span>
<a href="#l15.1405"></a><span id="l15.1405"> }</span>
<a href="#l15.1406"></a><span id="l15.1406"> </span>
<a href="#l15.1407"></a><span id="l15.1407" class="difflineminus">-char *</span>
<a href="#l15.1408"></a><span id="l15.1408" class="difflineminus">-mime_fix_header (const char *string)</span>
<a href="#l15.1409"></a><span id="l15.1409" class="difflineminus">-{</span>
<a href="#l15.1410"></a><span id="l15.1410" class="difflineminus">-  return mime_fix_header_1 (string, false, false);</span>
<a href="#l15.1411"></a><span id="l15.1411" class="difflineplus">+char *mime_fix_header(const char *string) {</span>
<a href="#l15.1412"></a><span id="l15.1412" class="difflineplus">+  return mime_fix_header_1(string, false, false);</span>
<a href="#l15.1413"></a><span id="l15.1413"> }</span>
<a href="#l15.1414"></a><span id="l15.1414"> </span>
<a href="#l15.1415"></a><span id="l15.1415" class="difflineminus">-char *</span>
<a href="#l15.1416"></a><span id="l15.1416" class="difflineminus">-mime_fix_addr_header (const char *string)</span>
<a href="#l15.1417"></a><span id="l15.1417" class="difflineminus">-{</span>
<a href="#l15.1418"></a><span id="l15.1418" class="difflineminus">-  return mime_fix_header_1 (string, true, false);</span>
<a href="#l15.1419"></a><span id="l15.1419" class="difflineplus">+char *mime_fix_addr_header(const char *string) {</span>
<a href="#l15.1420"></a><span id="l15.1420" class="difflineplus">+  return mime_fix_header_1(string, true, false);</span>
<a href="#l15.1421"></a><span id="l15.1421"> }</span>
<a href="#l15.1422"></a><span id="l15.1422"> </span>
<a href="#l15.1423"></a><span id="l15.1423" class="difflineminus">-char *</span>
<a href="#l15.1424"></a><span id="l15.1424" class="difflineminus">-mime_fix_news_header (const char *string)</span>
<a href="#l15.1425"></a><span id="l15.1425" class="difflineminus">-{</span>
<a href="#l15.1426"></a><span id="l15.1426" class="difflineminus">-  return mime_fix_header_1 (string, false, true);</span>
<a href="#l15.1427"></a><span id="l15.1427" class="difflineplus">+char *mime_fix_news_header(const char *string) {</span>
<a href="#l15.1428"></a><span id="l15.1428" class="difflineplus">+  return mime_fix_header_1(string, false, true);</span>
<a href="#l15.1429"></a><span id="l15.1429"> }</span>
<a href="#l15.1430"></a><span id="l15.1430"> </span>
<a href="#l15.1431"></a><span id="l15.1431" class="difflineminus">-bool</span>
<a href="#l15.1432"></a><span id="l15.1432" class="difflineminus">-mime_type_requires_b64_p (const char *type)</span>
<a href="#l15.1433"></a><span id="l15.1433" class="difflineminus">-{</span>
<a href="#l15.1434"></a><span id="l15.1434" class="difflineminus">-  if (!type || !PL_strcasecmp (type, UNKNOWN_CONTENT_TYPE))</span>
<a href="#l15.1435"></a><span id="l15.1435" class="difflineminus">-  /* Unknown types don't necessarily require encoding.  (Note that</span>
<a href="#l15.1436"></a><span id="l15.1436" class="difflineminus">-     &quot;unknown&quot; and &quot;application/octet-stream&quot; aren't the same.) */</span>
<a href="#l15.1437"></a><span id="l15.1437" class="difflineminus">-  return false;</span>
<a href="#l15.1438"></a><span id="l15.1438" class="difflineplus">+bool mime_type_requires_b64_p(const char *type) {</span>
<a href="#l15.1439"></a><span id="l15.1439" class="difflineplus">+  if (!type || !PL_strcasecmp(type, UNKNOWN_CONTENT_TYPE))</span>
<a href="#l15.1440"></a><span id="l15.1440" class="difflineplus">+    /* Unknown types don't necessarily require encoding.  (Note that</span>
<a href="#l15.1441"></a><span id="l15.1441" class="difflineplus">+       &quot;unknown&quot; and &quot;application/octet-stream&quot; aren't the same.) */</span>
<a href="#l15.1442"></a><span id="l15.1442" class="difflineplus">+    return false;</span>
<a href="#l15.1443"></a><span id="l15.1443"> </span>
<a href="#l15.1444"></a><span id="l15.1444" class="difflineminus">-  else if (!PL_strncasecmp (type, &quot;image/&quot;, 6) ||</span>
<a href="#l15.1445"></a><span id="l15.1445" class="difflineminus">-       !PL_strncasecmp (type, &quot;audio/&quot;, 6) ||</span>
<a href="#l15.1446"></a><span id="l15.1446" class="difflineminus">-       !PL_strncasecmp (type, &quot;video/&quot;, 6) ||</span>
<a href="#l15.1447"></a><span id="l15.1447" class="difflineminus">-       !PL_strncasecmp (type, &quot;application/&quot;, 12))</span>
<a href="#l15.1448"></a><span id="l15.1448" class="difflineminus">-  {</span>
<a href="#l15.1449"></a><span id="l15.1449" class="difflineplus">+  else if (!PL_strncasecmp(type, &quot;image/&quot;, 6) ||</span>
<a href="#l15.1450"></a><span id="l15.1450" class="difflineplus">+           !PL_strncasecmp(type, &quot;audio/&quot;, 6) ||</span>
<a href="#l15.1451"></a><span id="l15.1451" class="difflineplus">+           !PL_strncasecmp(type, &quot;video/&quot;, 6) ||</span>
<a href="#l15.1452"></a><span id="l15.1452" class="difflineplus">+           !PL_strncasecmp(type, &quot;application/&quot;, 12)) {</span>
<a href="#l15.1453"></a><span id="l15.1453">     /* The following types are application/ or image/ types that are actually</span>
<a href="#l15.1454"></a><span id="l15.1454">      known to contain textual data (meaning line-based, not binary, where</span>
<a href="#l15.1455"></a><span id="l15.1455">      CRLF conversion is desired rather than disastrous.)  So, if the type</span>
<a href="#l15.1456"></a><span id="l15.1456">      is any of these, it does not *require* base64, and if we do need to</span>
<a href="#l15.1457"></a><span id="l15.1457">      encode it for other reasons, we'll probably use quoted-printable.</span>
<a href="#l15.1458"></a><span id="l15.1458">      But, if it's not one of these types, then we assume that any subtypes</span>
<a href="#l15.1459"></a><span id="l15.1459">      of the non-&quot;text/&quot; types are binary data, where CRLF conversion would</span>
<a href="#l15.1460"></a><span id="l15.1460">      corrupt it, so we use base64 right off the bat.</span>
<a href="#l15.1461"></a><span id="l15.1461" class="difflineat">@@ -1193,227 +1056,207 @@ mime_type_requires_b64_p (const char *ty</span>
<a href="#l15.1462"></a><span id="l15.1462">      base64 all the time is mainly to preserve the readability of them for</span>
<a href="#l15.1463"></a><span id="l15.1463">      non-MIME users: if I mail a /bin/sh script to someone, it might not</span>
<a href="#l15.1464"></a><span id="l15.1464">      need to be encoded at all, so we should leave it readable if we can.</span>
<a href="#l15.1465"></a><span id="l15.1465"> </span>
<a href="#l15.1466"></a><span id="l15.1466">      This list of types was derived from the comp.mail.mime FAQ, section</span>
<a href="#l15.1467"></a><span id="l15.1467">      10.2.2, &quot;List of known unregistered MIME types&quot; on 2-Feb-96.</span>
<a href="#l15.1468"></a><span id="l15.1468">      */</span>
<a href="#l15.1469"></a><span id="l15.1469">     static const char *app_and_image_types_which_are_really_text[] = {</span>
<a href="#l15.1470"></a><span id="l15.1470" class="difflineminus">-    &quot;application/mac-binhex40&quot;,   /* APPLICATION_BINHEX */</span>
<a href="#l15.1471"></a><span id="l15.1471" class="difflineminus">-    &quot;application/pgp&quot;,        /* APPLICATION_PGP */</span>
<a href="#l15.1472"></a><span id="l15.1472" class="difflineminus">-    &quot;application/pgp-keys&quot;,</span>
<a href="#l15.1473"></a><span id="l15.1473" class="difflineminus">-    &quot;application/x-pgp-message&quot;,  /* APPLICATION_PGP2 */</span>
<a href="#l15.1474"></a><span id="l15.1474" class="difflineminus">-    &quot;application/postscript&quot;,   /* APPLICATION_POSTSCRIPT */</span>
<a href="#l15.1475"></a><span id="l15.1475" class="difflineminus">-    &quot;application/x-uuencode&quot;,   /* APPLICATION_UUENCODE */</span>
<a href="#l15.1476"></a><span id="l15.1476" class="difflineminus">-    &quot;application/x-uue&quot;,      /* APPLICATION_UUENCODE2 */</span>
<a href="#l15.1477"></a><span id="l15.1477" class="difflineminus">-    &quot;application/uue&quot;,        /* APPLICATION_UUENCODE4 */</span>
<a href="#l15.1478"></a><span id="l15.1478" class="difflineminus">-    &quot;application/uuencode&quot;,     /* APPLICATION_UUENCODE3 */</span>
<a href="#l15.1479"></a><span id="l15.1479" class="difflineminus">-    &quot;application/sgml&quot;,</span>
<a href="#l15.1480"></a><span id="l15.1480" class="difflineminus">-    &quot;application/x-csh&quot;,</span>
<a href="#l15.1481"></a><span id="l15.1481" class="difflineminus">-    &quot;application/javascript&quot;,</span>
<a href="#l15.1482"></a><span id="l15.1482" class="difflineminus">-    &quot;application/ecmascript&quot;,</span>
<a href="#l15.1483"></a><span id="l15.1483" class="difflineminus">-    &quot;application/x-javascript&quot;,</span>
<a href="#l15.1484"></a><span id="l15.1484" class="difflineminus">-    &quot;application/x-latex&quot;,</span>
<a href="#l15.1485"></a><span id="l15.1485" class="difflineminus">-    &quot;application/x-macbinhex40&quot;,</span>
<a href="#l15.1486"></a><span id="l15.1486" class="difflineminus">-    &quot;application/x-ns-proxy-autoconfig&quot;,</span>
<a href="#l15.1487"></a><span id="l15.1487" class="difflineminus">-    &quot;application/x-www-form-urlencoded&quot;,</span>
<a href="#l15.1488"></a><span id="l15.1488" class="difflineminus">-    &quot;application/x-perl&quot;,</span>
<a href="#l15.1489"></a><span id="l15.1489" class="difflineminus">-    &quot;application/x-sh&quot;,</span>
<a href="#l15.1490"></a><span id="l15.1490" class="difflineminus">-    &quot;application/x-shar&quot;,</span>
<a href="#l15.1491"></a><span id="l15.1491" class="difflineminus">-    &quot;application/x-tcl&quot;,</span>
<a href="#l15.1492"></a><span id="l15.1492" class="difflineminus">-    &quot;application/x-tex&quot;,</span>
<a href="#l15.1493"></a><span id="l15.1493" class="difflineminus">-    &quot;application/x-texinfo&quot;,</span>
<a href="#l15.1494"></a><span id="l15.1494" class="difflineminus">-    &quot;application/x-troff&quot;,</span>
<a href="#l15.1495"></a><span id="l15.1495" class="difflineminus">-    &quot;application/x-troff-man&quot;,</span>
<a href="#l15.1496"></a><span id="l15.1496" class="difflineminus">-    &quot;application/x-troff-me&quot;,</span>
<a href="#l15.1497"></a><span id="l15.1497" class="difflineminus">-    &quot;application/x-troff-ms&quot;,</span>
<a href="#l15.1498"></a><span id="l15.1498" class="difflineminus">-    &quot;application/x-troff-ms&quot;,</span>
<a href="#l15.1499"></a><span id="l15.1499" class="difflineminus">-    &quot;application/x-wais-source&quot;,</span>
<a href="#l15.1500"></a><span id="l15.1500" class="difflineminus">-    &quot;image/x-bitmap&quot;,</span>
<a href="#l15.1501"></a><span id="l15.1501" class="difflineminus">-    &quot;image/x-pbm&quot;,</span>
<a href="#l15.1502"></a><span id="l15.1502" class="difflineminus">-    &quot;image/x-pgm&quot;,</span>
<a href="#l15.1503"></a><span id="l15.1503" class="difflineminus">-    &quot;image/x-portable-anymap&quot;,</span>
<a href="#l15.1504"></a><span id="l15.1504" class="difflineminus">-    &quot;image/x-portable-bitmap&quot;,</span>
<a href="#l15.1505"></a><span id="l15.1505" class="difflineminus">-    &quot;image/x-portable-graymap&quot;,</span>
<a href="#l15.1506"></a><span id="l15.1506" class="difflineminus">-    &quot;image/x-portable-pixmap&quot;,    /* IMAGE_PPM */</span>
<a href="#l15.1507"></a><span id="l15.1507" class="difflineminus">-    &quot;image/x-ppm&quot;,</span>
<a href="#l15.1508"></a><span id="l15.1508" class="difflineminus">-    &quot;image/x-xbitmap&quot;,        /* IMAGE_XBM */</span>
<a href="#l15.1509"></a><span id="l15.1509" class="difflineminus">-    &quot;image/x-xbm&quot;,          /* IMAGE_XBM2 */</span>
<a href="#l15.1510"></a><span id="l15.1510" class="difflineminus">-    &quot;image/xbm&quot;,          /* IMAGE_XBM3 */</span>
<a href="#l15.1511"></a><span id="l15.1511" class="difflineminus">-    &quot;image/x-xpixmap&quot;,</span>
<a href="#l15.1512"></a><span id="l15.1512" class="difflineminus">-    &quot;image/x-xpm&quot;,</span>
<a href="#l15.1513"></a><span id="l15.1513" class="difflineminus">-    0 };</span>
<a href="#l15.1514"></a><span id="l15.1514" class="difflineplus">+        &quot;application/mac-binhex40&quot;, /* APPLICATION_BINHEX */</span>
<a href="#l15.1515"></a><span id="l15.1515" class="difflineplus">+        &quot;application/pgp&quot;,          /* APPLICATION_PGP */</span>
<a href="#l15.1516"></a><span id="l15.1516" class="difflineplus">+        &quot;application/pgp-keys&quot;,</span>
<a href="#l15.1517"></a><span id="l15.1517" class="difflineplus">+        &quot;application/x-pgp-message&quot;, /* APPLICATION_PGP2 */</span>
<a href="#l15.1518"></a><span id="l15.1518" class="difflineplus">+        &quot;application/postscript&quot;,    /* APPLICATION_POSTSCRIPT */</span>
<a href="#l15.1519"></a><span id="l15.1519" class="difflineplus">+        &quot;application/x-uuencode&quot;,    /* APPLICATION_UUENCODE */</span>
<a href="#l15.1520"></a><span id="l15.1520" class="difflineplus">+        &quot;application/x-uue&quot;,         /* APPLICATION_UUENCODE2 */</span>
<a href="#l15.1521"></a><span id="l15.1521" class="difflineplus">+        &quot;application/uue&quot;,           /* APPLICATION_UUENCODE4 */</span>
<a href="#l15.1522"></a><span id="l15.1522" class="difflineplus">+        &quot;application/uuencode&quot;,      /* APPLICATION_UUENCODE3 */</span>
<a href="#l15.1523"></a><span id="l15.1523" class="difflineplus">+        &quot;application/sgml&quot;,</span>
<a href="#l15.1524"></a><span id="l15.1524" class="difflineplus">+        &quot;application/x-csh&quot;,</span>
<a href="#l15.1525"></a><span id="l15.1525" class="difflineplus">+        &quot;application/javascript&quot;,</span>
<a href="#l15.1526"></a><span id="l15.1526" class="difflineplus">+        &quot;application/ecmascript&quot;,</span>
<a href="#l15.1527"></a><span id="l15.1527" class="difflineplus">+        &quot;application/x-javascript&quot;,</span>
<a href="#l15.1528"></a><span id="l15.1528" class="difflineplus">+        &quot;application/x-latex&quot;,</span>
<a href="#l15.1529"></a><span id="l15.1529" class="difflineplus">+        &quot;application/x-macbinhex40&quot;,</span>
<a href="#l15.1530"></a><span id="l15.1530" class="difflineplus">+        &quot;application/x-ns-proxy-autoconfig&quot;,</span>
<a href="#l15.1531"></a><span id="l15.1531" class="difflineplus">+        &quot;application/x-www-form-urlencoded&quot;,</span>
<a href="#l15.1532"></a><span id="l15.1532" class="difflineplus">+        &quot;application/x-perl&quot;,</span>
<a href="#l15.1533"></a><span id="l15.1533" class="difflineplus">+        &quot;application/x-sh&quot;,</span>
<a href="#l15.1534"></a><span id="l15.1534" class="difflineplus">+        &quot;application/x-shar&quot;,</span>
<a href="#l15.1535"></a><span id="l15.1535" class="difflineplus">+        &quot;application/x-tcl&quot;,</span>
<a href="#l15.1536"></a><span id="l15.1536" class="difflineplus">+        &quot;application/x-tex&quot;,</span>
<a href="#l15.1537"></a><span id="l15.1537" class="difflineplus">+        &quot;application/x-texinfo&quot;,</span>
<a href="#l15.1538"></a><span id="l15.1538" class="difflineplus">+        &quot;application/x-troff&quot;,</span>
<a href="#l15.1539"></a><span id="l15.1539" class="difflineplus">+        &quot;application/x-troff-man&quot;,</span>
<a href="#l15.1540"></a><span id="l15.1540" class="difflineplus">+        &quot;application/x-troff-me&quot;,</span>
<a href="#l15.1541"></a><span id="l15.1541" class="difflineplus">+        &quot;application/x-troff-ms&quot;,</span>
<a href="#l15.1542"></a><span id="l15.1542" class="difflineplus">+        &quot;application/x-troff-ms&quot;,</span>
<a href="#l15.1543"></a><span id="l15.1543" class="difflineplus">+        &quot;application/x-wais-source&quot;,</span>
<a href="#l15.1544"></a><span id="l15.1544" class="difflineplus">+        &quot;image/x-bitmap&quot;,</span>
<a href="#l15.1545"></a><span id="l15.1545" class="difflineplus">+        &quot;image/x-pbm&quot;,</span>
<a href="#l15.1546"></a><span id="l15.1546" class="difflineplus">+        &quot;image/x-pgm&quot;,</span>
<a href="#l15.1547"></a><span id="l15.1547" class="difflineplus">+        &quot;image/x-portable-anymap&quot;,</span>
<a href="#l15.1548"></a><span id="l15.1548" class="difflineplus">+        &quot;image/x-portable-bitmap&quot;,</span>
<a href="#l15.1549"></a><span id="l15.1549" class="difflineplus">+        &quot;image/x-portable-graymap&quot;,</span>
<a href="#l15.1550"></a><span id="l15.1550" class="difflineplus">+        &quot;image/x-portable-pixmap&quot;, /* IMAGE_PPM */</span>
<a href="#l15.1551"></a><span id="l15.1551" class="difflineplus">+        &quot;image/x-ppm&quot;,</span>
<a href="#l15.1552"></a><span id="l15.1552" class="difflineplus">+        &quot;image/x-xbitmap&quot;, /* IMAGE_XBM */</span>
<a href="#l15.1553"></a><span id="l15.1553" class="difflineplus">+        &quot;image/x-xbm&quot;,     /* IMAGE_XBM2 */</span>
<a href="#l15.1554"></a><span id="l15.1554" class="difflineplus">+        &quot;image/xbm&quot;,       /* IMAGE_XBM3 */</span>
<a href="#l15.1555"></a><span id="l15.1555" class="difflineplus">+        &quot;image/x-xpixmap&quot;,</span>
<a href="#l15.1556"></a><span id="l15.1556" class="difflineplus">+        &quot;image/x-xpm&quot;,</span>
<a href="#l15.1557"></a><span id="l15.1557" class="difflineplus">+        0};</span>
<a href="#l15.1558"></a><span id="l15.1558">     const char **s;</span>
<a href="#l15.1559"></a><span id="l15.1559">     for (s = app_and_image_types_which_are_really_text; *s; s++)</span>
<a href="#l15.1560"></a><span id="l15.1560" class="difflineminus">-    if (!PL_strcasecmp (type, *s))</span>
<a href="#l15.1561"></a><span id="l15.1561" class="difflineminus">-      return false;</span>
<a href="#l15.1562"></a><span id="l15.1562" class="difflineplus">+      if (!PL_strcasecmp(type, *s)) return false;</span>
<a href="#l15.1563"></a><span id="l15.1563"> </span>
<a href="#l15.1564"></a><span id="l15.1564">     /* All others must be assumed to be binary formats, and need Base64. */</span>
<a href="#l15.1565"></a><span id="l15.1565">     return true;</span>
<a href="#l15.1566"></a><span id="l15.1566">   }</span>
<a href="#l15.1567"></a><span id="l15.1567"> </span>
<a href="#l15.1568"></a><span id="l15.1568">   else</span>
<a href="#l15.1569"></a><span id="l15.1569" class="difflineminus">-  return false;</span>
<a href="#l15.1570"></a><span id="l15.1570" class="difflineplus">+    return false;</span>
<a href="#l15.1571"></a><span id="l15.1571"> }</span>
<a href="#l15.1572"></a><span id="l15.1572"> </span>
<a href="#l15.1573"></a><span id="l15.1573"> //</span>
<a href="#l15.1574"></a><span id="l15.1574"> // Some types should have a &quot;charset=&quot; parameter, and some shouldn't.</span>
<a href="#l15.1575"></a><span id="l15.1575"> // This is what decides.</span>
<a href="#l15.1576"></a><span id="l15.1576"> //</span>
<a href="#l15.1577"></a><span id="l15.1577" class="difflineminus">-bool</span>
<a href="#l15.1578"></a><span id="l15.1578" class="difflineminus">-mime_type_needs_charset (const char *type)</span>
<a href="#l15.1579"></a><span id="l15.1579" class="difflineminus">-{</span>
<a href="#l15.1580"></a><span id="l15.1580" class="difflineplus">+bool mime_type_needs_charset(const char *type) {</span>
<a href="#l15.1581"></a><span id="l15.1581">   /* Only text types should have charset. */</span>
<a href="#l15.1582"></a><span id="l15.1582">   if (!type || !*type)</span>
<a href="#l15.1583"></a><span id="l15.1583">     return false;</span>
<a href="#l15.1584"></a><span id="l15.1584" class="difflineplus">+  else if (!PL_strncasecmp(type, &quot;text&quot;, 4))</span>
<a href="#l15.1585"></a><span id="l15.1585" class="difflineplus">+    return true;</span>
<a href="#l15.1586"></a><span id="l15.1586">   else</span>
<a href="#l15.1587"></a><span id="l15.1587" class="difflineminus">-    if (!PL_strncasecmp (type, &quot;text&quot;, 4))</span>
<a href="#l15.1588"></a><span id="l15.1588" class="difflineminus">-      return true;</span>
<a href="#l15.1589"></a><span id="l15.1589" class="difflineminus">-    else</span>
<a href="#l15.1590"></a><span id="l15.1590" class="difflineminus">-      return false;</span>
<a href="#l15.1591"></a><span id="l15.1591" class="difflineplus">+    return false;</span>
<a href="#l15.1592"></a><span id="l15.1592"> }</span>
<a href="#l15.1593"></a><span id="l15.1593"> </span>
<a href="#l15.1594"></a><span id="l15.1594" class="difflineminus">-/* Given a string, convert it to 'qtext' (quoted text) for RFC822 header purposes. */</span>
<a href="#l15.1595"></a><span id="l15.1595" class="difflineminus">-char *</span>
<a href="#l15.1596"></a><span id="l15.1596" class="difflineminus">-msg_make_filename_qtext(const char *srcText, bool stripCRLFs)</span>
<a href="#l15.1597"></a><span id="l15.1597" class="difflineminus">-{</span>
<a href="#l15.1598"></a><span id="l15.1598" class="difflineplus">+/* Given a string, convert it to 'qtext' (quoted text) for RFC822 header</span>
<a href="#l15.1599"></a><span id="l15.1599" class="difflineplus">+ * purposes. */</span>
<a href="#l15.1600"></a><span id="l15.1600" class="difflineplus">+char *msg_make_filename_qtext(const char *srcText, bool stripCRLFs) {</span>
<a href="#l15.1601"></a><span id="l15.1601">   /* newString can be at most twice the original string (every char quoted). */</span>
<a href="#l15.1602"></a><span id="l15.1602" class="difflineminus">-  char *newString = (char *) PR_Malloc(PL_strlen(srcText)*2 + 1);</span>
<a href="#l15.1603"></a><span id="l15.1603" class="difflineplus">+  char *newString = (char *)PR_Malloc(PL_strlen(srcText) * 2 + 1);</span>
<a href="#l15.1604"></a><span id="l15.1604">   if (!newString) return NULL;</span>
<a href="#l15.1605"></a><span id="l15.1605"> </span>
<a href="#l15.1606"></a><span id="l15.1606">   const char *s = srcText;</span>
<a href="#l15.1607"></a><span id="l15.1607">   const char *end = srcText + PL_strlen(srcText);</span>
<a href="#l15.1608"></a><span id="l15.1608">   char *d = newString;</span>
<a href="#l15.1609"></a><span id="l15.1609"> </span>
<a href="#l15.1610"></a><span id="l15.1610" class="difflineminus">-  while(*s)</span>
<a href="#l15.1611"></a><span id="l15.1611" class="difflineminus">-  {</span>
<a href="#l15.1612"></a><span id="l15.1612" class="difflineplus">+  while (*s) {</span>
<a href="#l15.1613"></a><span id="l15.1613">     /*  Put backslashes in front of existing backslashes, or double quote</span>
<a href="#l15.1614"></a><span id="l15.1614">       characters.</span>
<a href="#l15.1615"></a><span id="l15.1615">       If stripCRLFs is true, don't write out CRs or LFs. Otherwise,</span>
<a href="#l15.1616"></a><span id="l15.1616">       write out a backslash followed by the CR but not</span>
<a href="#l15.1617"></a><span id="l15.1617">       linear-white-space.</span>
<a href="#l15.1618"></a><span id="l15.1618">       We might already have quoted pair of &quot;\ &quot; or &quot;\\t&quot; skip it.</span>
<a href="#l15.1619"></a><span id="l15.1619">       */</span>
<a href="#l15.1620"></a><span id="l15.1620">     if (*s == '\\' || *s == '&quot;' ||</span>
<a href="#l15.1621"></a><span id="l15.1621" class="difflineminus">-      (!stripCRLFs &amp;&amp;</span>
<a href="#l15.1622"></a><span id="l15.1622" class="difflineminus">-       (*s == '\r' &amp;&amp; (s[1] != '\n' ||</span>
<a href="#l15.1623"></a><span id="l15.1623" class="difflineminus">-               (s[1] == '\n' &amp;&amp; (s+2) &lt; end &amp;&amp; !IS_SPACE(s[2]))))))</span>
<a href="#l15.1624"></a><span id="l15.1624" class="difflineplus">+        (!stripCRLFs &amp;&amp;</span>
<a href="#l15.1625"></a><span id="l15.1625" class="difflineplus">+         (*s == '\r' &amp;&amp; (s[1] != '\n' ||</span>
<a href="#l15.1626"></a><span id="l15.1626" class="difflineplus">+                         (s[1] == '\n' &amp;&amp; (s + 2) &lt; end &amp;&amp; !IS_SPACE(s[2]))))))</span>
<a href="#l15.1627"></a><span id="l15.1627">       *d++ = '\\';</span>
<a href="#l15.1628"></a><span id="l15.1628"> </span>
<a href="#l15.1629"></a><span id="l15.1629" class="difflineminus">-    if (stripCRLFs &amp;&amp; *s == '\r' &amp;&amp; s[1] == '\n' &amp;&amp; (s+2) &lt; end &amp;&amp; IS_SPACE(s[2]))</span>
<a href="#l15.1630"></a><span id="l15.1630" class="difflineminus">-    {</span>
<a href="#l15.1631"></a><span id="l15.1631" class="difflineminus">-        s += 3;     // skip CRLFLWSP</span>
<a href="#l15.1632"></a><span id="l15.1632" class="difflineminus">-    }</span>
<a href="#l15.1633"></a><span id="l15.1633" class="difflineminus">-    else</span>
<a href="#l15.1634"></a><span id="l15.1634" class="difflineminus">-    {</span>
<a href="#l15.1635"></a><span id="l15.1635" class="difflineplus">+    if (stripCRLFs &amp;&amp; *s == '\r' &amp;&amp; s[1] == '\n' &amp;&amp; (s + 2) &lt; end &amp;&amp;</span>
<a href="#l15.1636"></a><span id="l15.1636" class="difflineplus">+        IS_SPACE(s[2])) {</span>
<a href="#l15.1637"></a><span id="l15.1637" class="difflineplus">+      s += 3;  // skip CRLFLWSP</span>
<a href="#l15.1638"></a><span id="l15.1638" class="difflineplus">+    } else {</span>
<a href="#l15.1639"></a><span id="l15.1639">       *d++ = *s++;</span>
<a href="#l15.1640"></a><span id="l15.1640">     }</span>
<a href="#l15.1641"></a><span id="l15.1641">   }</span>
<a href="#l15.1642"></a><span id="l15.1642">   *d = 0;</span>
<a href="#l15.1643"></a><span id="l15.1643"> </span>
<a href="#l15.1644"></a><span id="l15.1644">   return newString;</span>
<a href="#l15.1645"></a><span id="l15.1645"> }</span>
<a href="#l15.1646"></a><span id="l15.1646"> </span>
<a href="#l15.1647"></a><span id="l15.1647"> /* Rip apart the URL and extract a reasonable value for the `real_name' slot.</span>
<a href="#l15.1648"></a><span id="l15.1648">  */</span>
<a href="#l15.1649"></a><span id="l15.1649" class="difflineminus">-void</span>
<a href="#l15.1650"></a><span id="l15.1650" class="difflineminus">-msg_pick_real_name (nsMsgAttachmentHandler *attachment, const char16_t *proposedName, const char *charset)</span>
<a href="#l15.1651"></a><span id="l15.1651" class="difflineminus">-{</span>
<a href="#l15.1652"></a><span id="l15.1652" class="difflineplus">+void msg_pick_real_name(nsMsgAttachmentHandler *attachment,</span>
<a href="#l15.1653"></a><span id="l15.1653" class="difflineplus">+                        const char16_t *proposedName, const char *charset) {</span>
<a href="#l15.1654"></a><span id="l15.1654">   const char *s, *s2;</span>
<a href="#l15.1655"></a><span id="l15.1655"> </span>
<a href="#l15.1656"></a><span id="l15.1656" class="difflineminus">-  if (!attachment-&gt;m_realName.IsEmpty())</span>
<a href="#l15.1657"></a><span id="l15.1657" class="difflineminus">-    return;</span>
<a href="#l15.1658"></a><span id="l15.1658" class="difflineplus">+  if (!attachment-&gt;m_realName.IsEmpty()) return;</span>
<a href="#l15.1659"></a><span id="l15.1659"> </span>
<a href="#l15.1660"></a><span id="l15.1660" class="difflineminus">-  if (proposedName &amp;&amp; *proposedName)</span>
<a href="#l15.1661"></a><span id="l15.1661" class="difflineminus">-  {</span>
<a href="#l15.1662"></a><span id="l15.1662" class="difflineplus">+  if (proposedName &amp;&amp; *proposedName) {</span>
<a href="#l15.1663"></a><span id="l15.1663">     attachment-&gt;m_realName.Adopt(ToNewUTF8String(nsAutoString(proposedName)));</span>
<a href="#l15.1664"></a><span id="l15.1664" class="difflineminus">-  }</span>
<a href="#l15.1665"></a><span id="l15.1665" class="difflineminus">-  else //Let's extract the name from the URL</span>
<a href="#l15.1666"></a><span id="l15.1666" class="difflineplus">+  } else  // Let's extract the name from the URL</span>
<a href="#l15.1667"></a><span id="l15.1667">   {</span>
<a href="#l15.1668"></a><span id="l15.1668">     nsCString url;</span>
<a href="#l15.1669"></a><span id="l15.1669">     nsresult rv = attachment-&gt;mURL-&gt;GetSpec(url);</span>
<a href="#l15.1670"></a><span id="l15.1670" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l15.1671"></a><span id="l15.1671" class="difflineminus">-      return;</span>
<a href="#l15.1672"></a><span id="l15.1672" class="difflineplus">+    if (NS_FAILED(rv)) return;</span>
<a href="#l15.1673"></a><span id="l15.1673"> </span>
<a href="#l15.1674"></a><span id="l15.1674">     s = url.get();</span>
<a href="#l15.1675"></a><span id="l15.1675" class="difflineminus">-    s2 = PL_strchr (s, ':');</span>
<a href="#l15.1676"></a><span id="l15.1676" class="difflineminus">-    if (s2)</span>
<a href="#l15.1677"></a><span id="l15.1677" class="difflineminus">-      s = s2 + 1;</span>
<a href="#l15.1678"></a><span id="l15.1678" class="difflineplus">+    s2 = PL_strchr(s, ':');</span>
<a href="#l15.1679"></a><span id="l15.1679" class="difflineplus">+    if (s2) s = s2 + 1;</span>
<a href="#l15.1680"></a><span id="l15.1680">     /* If we know the URL doesn't have a sensible file name in it,</span>
<a href="#l15.1681"></a><span id="l15.1681">      don't bother emitting a content-disposition. */</span>
<a href="#l15.1682"></a><span id="l15.1682" class="difflineminus">-    if (StringBeginsWith (url, NS_LITERAL_CSTRING(&quot;news:&quot;), nsCaseInsensitiveCStringComparator()) ||</span>
<a href="#l15.1683"></a><span id="l15.1683" class="difflineminus">-        StringBeginsWith (url, NS_LITERAL_CSTRING(&quot;snews:&quot;), nsCaseInsensitiveCStringComparator()) ||</span>
<a href="#l15.1684"></a><span id="l15.1684" class="difflineminus">-        StringBeginsWith (url, NS_LITERAL_CSTRING(&quot;IMAP:&quot;), nsCaseInsensitiveCStringComparator()) ||</span>
<a href="#l15.1685"></a><span id="l15.1685" class="difflineminus">-        StringBeginsWith (url, NS_LITERAL_CSTRING(&quot;mailbox:&quot;), nsCaseInsensitiveCStringComparator()))</span>
<a href="#l15.1686"></a><span id="l15.1686" class="difflineplus">+    if (StringBeginsWith(url, NS_LITERAL_CSTRING(&quot;news:&quot;),</span>
<a href="#l15.1687"></a><span id="l15.1687" class="difflineplus">+                         nsCaseInsensitiveCStringComparator()) ||</span>
<a href="#l15.1688"></a><span id="l15.1688" class="difflineplus">+        StringBeginsWith(url, NS_LITERAL_CSTRING(&quot;snews:&quot;),</span>
<a href="#l15.1689"></a><span id="l15.1689" class="difflineplus">+                         nsCaseInsensitiveCStringComparator()) ||</span>
<a href="#l15.1690"></a><span id="l15.1690" class="difflineplus">+        StringBeginsWith(url, NS_LITERAL_CSTRING(&quot;IMAP:&quot;),</span>
<a href="#l15.1691"></a><span id="l15.1691" class="difflineplus">+                         nsCaseInsensitiveCStringComparator()) ||</span>
<a href="#l15.1692"></a><span id="l15.1692" class="difflineplus">+        StringBeginsWith(url, NS_LITERAL_CSTRING(&quot;mailbox:&quot;),</span>
<a href="#l15.1693"></a><span id="l15.1693" class="difflineplus">+                         nsCaseInsensitiveCStringComparator()))</span>
<a href="#l15.1694"></a><span id="l15.1694">       return;</span>
<a href="#l15.1695"></a><span id="l15.1695"> </span>
<a href="#l15.1696"></a><span id="l15.1696">     if (StringBeginsWith(url, NS_LITERAL_CSTRING(&quot;data:&quot;),</span>
<a href="#l15.1697"></a><span id="l15.1697" class="difflineminus">-                         nsCaseInsensitiveCStringComparator()))</span>
<a href="#l15.1698"></a><span id="l15.1698" class="difflineminus">-    {</span>
<a href="#l15.1699"></a><span id="l15.1699" class="difflineplus">+                         nsCaseInsensitiveCStringComparator())) {</span>
<a href="#l15.1700"></a><span id="l15.1700">       int32_t endNonData = url.FindChar(',');</span>
<a href="#l15.1701"></a><span id="l15.1701" class="difflineminus">-      if (endNonData == -1)</span>
<a href="#l15.1702"></a><span id="l15.1702" class="difflineminus">-        return;</span>
<a href="#l15.1703"></a><span id="l15.1703" class="difflineplus">+      if (endNonData == -1) return;</span>
<a href="#l15.1704"></a><span id="l15.1704">       nsCString nonDataPart(Substring(url, 5, endNonData - 5));</span>
<a href="#l15.1705"></a><span id="l15.1705">       int32_t filenamePos = nonDataPart.Find(&quot;filename=&quot;);</span>
<a href="#l15.1706"></a><span id="l15.1706" class="difflineminus">-      if (filenamePos != -1)</span>
<a href="#l15.1707"></a><span id="l15.1707" class="difflineminus">-      {</span>
<a href="#l15.1708"></a><span id="l15.1708" class="difflineplus">+      if (filenamePos != -1) {</span>
<a href="#l15.1709"></a><span id="l15.1709">         filenamePos += 9;</span>
<a href="#l15.1710"></a><span id="l15.1710">         int32_t endFilename = nonDataPart.FindChar(';', filenamePos);</span>
<a href="#l15.1711"></a><span id="l15.1711" class="difflineminus">-        if (endFilename == -1)</span>
<a href="#l15.1712"></a><span id="l15.1712" class="difflineminus">-          endFilename = endNonData;</span>
<a href="#l15.1713"></a><span id="l15.1713" class="difflineminus">-        attachment-&gt;m_realName = Substring(nonDataPart, filenamePos,</span>
<a href="#l15.1714"></a><span id="l15.1714" class="difflineminus">-                                           endFilename - filenamePos);</span>
<a href="#l15.1715"></a><span id="l15.1715" class="difflineminus">-      }</span>
<a href="#l15.1716"></a><span id="l15.1716" class="difflineminus">-      else</span>
<a href="#l15.1717"></a><span id="l15.1717" class="difflineminus">-      {</span>
<a href="#l15.1718"></a><span id="l15.1718" class="difflineplus">+        if (endFilename == -1) endFilename = endNonData;</span>
<a href="#l15.1719"></a><span id="l15.1719" class="difflineplus">+        attachment-&gt;m_realName =</span>
<a href="#l15.1720"></a><span id="l15.1720" class="difflineplus">+            Substring(nonDataPart, filenamePos, endFilename - filenamePos);</span>
<a href="#l15.1721"></a><span id="l15.1721" class="difflineplus">+      } else {</span>
<a href="#l15.1722"></a><span id="l15.1722">         // no filename; need to construct one based on the content type.</span>
<a href="#l15.1723"></a><span id="l15.1723" class="difflineminus">-        nsCOMPtr&lt;nsIMIMEService&gt; mimeService(do_GetService(NS_MIMESERVICE_CONTRACTID));</span>
<a href="#l15.1724"></a><span id="l15.1724" class="difflineminus">-        if (!mimeService)</span>
<a href="#l15.1725"></a><span id="l15.1725" class="difflineminus">-          return;</span>
<a href="#l15.1726"></a><span id="l15.1726" class="difflineplus">+        nsCOMPtr&lt;nsIMIMEService&gt; mimeService(</span>
<a href="#l15.1727"></a><span id="l15.1727" class="difflineplus">+            do_GetService(NS_MIMESERVICE_CONTRACTID));</span>
<a href="#l15.1728"></a><span id="l15.1728" class="difflineplus">+        if (!mimeService) return;</span>
<a href="#l15.1729"></a><span id="l15.1729">         nsCOMPtr&lt;nsIMIMEInfo&gt; mimeInfo;</span>
<a href="#l15.1730"></a><span id="l15.1730" class="difflineminus">-        nsCString mediaType(Substring(nonDataPart, 0, nonDataPart.FindChar(';')));</span>
<a href="#l15.1731"></a><span id="l15.1731" class="difflineminus">-        mimeService-&gt;GetFromTypeAndExtension(mediaType, EmptyCString(), getter_AddRefs(mimeInfo));</span>
<a href="#l15.1732"></a><span id="l15.1732" class="difflineminus">-        if (!mimeInfo)</span>
<a href="#l15.1733"></a><span id="l15.1733" class="difflineminus">-          return;</span>
<a href="#l15.1734"></a><span id="l15.1734" class="difflineplus">+        nsCString mediaType(</span>
<a href="#l15.1735"></a><span id="l15.1735" class="difflineplus">+            Substring(nonDataPart, 0, nonDataPart.FindChar(';')));</span>
<a href="#l15.1736"></a><span id="l15.1736" class="difflineplus">+        mimeService-&gt;GetFromTypeAndExtension(mediaType, EmptyCString(),</span>
<a href="#l15.1737"></a><span id="l15.1737" class="difflineplus">+                                             getter_AddRefs(mimeInfo));</span>
<a href="#l15.1738"></a><span id="l15.1738" class="difflineplus">+        if (!mimeInfo) return;</span>
<a href="#l15.1739"></a><span id="l15.1739">         nsCString filename;</span>
<a href="#l15.1740"></a><span id="l15.1740">         nsCString extension;</span>
<a href="#l15.1741"></a><span id="l15.1741">         mimeInfo-&gt;GetPrimaryExtension(extension);</span>
<a href="#l15.1742"></a><span id="l15.1742">         unsigned char filePrefixBytes[8];</span>
<a href="#l15.1743"></a><span id="l15.1743">         GenerateGlobalRandomBytes(filePrefixBytes, 8);</span>
<a href="#l15.1744"></a><span id="l15.1744">         // Create a filename prefix with 16 lowercase letters,</span>
<a href="#l15.1745"></a><span id="l15.1745">         // representing 8 bytes.</span>
<a href="#l15.1746"></a><span id="l15.1746" class="difflineminus">-        for (int32_t i = 0; i &lt; 8; i++)</span>
<a href="#l15.1747"></a><span id="l15.1747" class="difflineminus">-        {</span>
<a href="#l15.1748"></a><span id="l15.1748" class="difflineplus">+        for (int32_t i = 0; i &lt; 8; i++) {</span>
<a href="#l15.1749"></a><span id="l15.1749">           // A pair of letters, each any of (a-p).</span>
<a href="#l15.1750"></a><span id="l15.1750">           filename.Append((filePrefixBytes[i] &amp; 0xF) + 'a');</span>
<a href="#l15.1751"></a><span id="l15.1751">           filename.Append((filePrefixBytes[i] &gt;&gt; 4) + 'a');</span>
<a href="#l15.1752"></a><span id="l15.1752">         }</span>
<a href="#l15.1753"></a><span id="l15.1753">         filename.Append('.');</span>
<a href="#l15.1754"></a><span id="l15.1754">         filename.Append(extension);</span>
<a href="#l15.1755"></a><span id="l15.1755">         attachment-&gt;m_realName = filename;</span>
<a href="#l15.1756"></a><span id="l15.1756">       }</span>
<a href="#l15.1757"></a><span id="l15.1757" class="difflineminus">-    }</span>
<a href="#l15.1758"></a><span id="l15.1758" class="difflineminus">-    else</span>
<a href="#l15.1759"></a><span id="l15.1759" class="difflineminus">-    {</span>
<a href="#l15.1760"></a><span id="l15.1760" class="difflineplus">+    } else {</span>
<a href="#l15.1761"></a><span id="l15.1761">       /* Take the part of the file name after the last / or \ */</span>
<a href="#l15.1762"></a><span id="l15.1762" class="difflineminus">-      s2 = PL_strrchr (s, '/');</span>
<a href="#l15.1763"></a><span id="l15.1763" class="difflineminus">-      if (s2) s = s2+1;</span>
<a href="#l15.1764"></a><span id="l15.1764" class="difflineminus">-      s2 = PL_strrchr (s, '\\');</span>
<a href="#l15.1765"></a><span id="l15.1765" class="difflineplus">+      s2 = PL_strrchr(s, '/');</span>
<a href="#l15.1766"></a><span id="l15.1766" class="difflineplus">+      if (s2) s = s2 + 1;</span>
<a href="#l15.1767"></a><span id="l15.1767" class="difflineplus">+      s2 = PL_strrchr(s, '\\');</span>
<a href="#l15.1768"></a><span id="l15.1768"> </span>
<a href="#l15.1769"></a><span id="l15.1769" class="difflineminus">-      if (s2) s = s2+1;</span>
<a href="#l15.1770"></a><span id="l15.1770" class="difflineplus">+      if (s2) s = s2 + 1;</span>
<a href="#l15.1771"></a><span id="l15.1771">       /* Copy it into the attachment struct. */</span>
<a href="#l15.1772"></a><span id="l15.1772">       attachment-&gt;m_realName = s;</span>
<a href="#l15.1773"></a><span id="l15.1773">       int32_t charPos = attachment-&gt;m_realName.FindChar('?');</span>
<a href="#l15.1774"></a><span id="l15.1774" class="difflineminus">-      if (charPos != -1)</span>
<a href="#l15.1775"></a><span id="l15.1775" class="difflineminus">-        attachment-&gt;m_realName.SetLength(charPos);</span>
<a href="#l15.1776"></a><span id="l15.1776" class="difflineplus">+      if (charPos != -1) attachment-&gt;m_realName.SetLength(charPos);</span>
<a href="#l15.1777"></a><span id="l15.1777">       /* Now trim off any named anchors or search data. */</span>
<a href="#l15.1778"></a><span id="l15.1778">       charPos = attachment-&gt;m_realName.FindChar('#');</span>
<a href="#l15.1779"></a><span id="l15.1779" class="difflineminus">-      if (charPos != -1)</span>
<a href="#l15.1780"></a><span id="l15.1780" class="difflineminus">-        attachment-&gt;m_realName.SetLength(charPos);</span>
<a href="#l15.1781"></a><span id="l15.1781" class="difflineplus">+      if (charPos != -1) attachment-&gt;m_realName.SetLength(charPos);</span>
<a href="#l15.1782"></a><span id="l15.1782">     }</span>
<a href="#l15.1783"></a><span id="l15.1783">     /* Now lose the %XX crap. */</span>
<a href="#l15.1784"></a><span id="l15.1784">     nsCString unescaped_real_name;</span>
<a href="#l15.1785"></a><span id="l15.1785">     MsgUnescapeString(attachment-&gt;m_realName, 0, unescaped_real_name);</span>
<a href="#l15.1786"></a><span id="l15.1786">     attachment-&gt;m_realName = unescaped_real_name;</span>
<a href="#l15.1787"></a><span id="l15.1787">   }</span>
<a href="#l15.1788"></a><span id="l15.1788"> </span>
<a href="#l15.1789"></a><span id="l15.1789">   /* Now a special case for attaching uuencoded files...</span>
<a href="#l15.1790"></a><span id="l15.1790" class="difflineat">@@ -1426,185 +1269,153 @@ msg_pick_real_name (nsMsgAttachmentHandl</span>
<a href="#l15.1791"></a><span id="l15.1791">    will presumably make the file name in the Content-Disposition header be</span>
<a href="#l15.1792"></a><span id="l15.1792">    the same as the file name in the &quot;begin&quot; line of the uuencoded data.)</span>
<a href="#l15.1793"></a><span id="l15.1793"> </span>
<a href="#l15.1794"></a><span id="l15.1794">    However, since there are mailers out there (including earlier versions of</span>
<a href="#l15.1795"></a><span id="l15.1795">    Mozilla) that will use &quot;foo.txt.uu&quot; as the file name, we still need to</span>
<a href="#l15.1796"></a><span id="l15.1796">    cope with that; the code which copes with that is in the MIME parser, in</span>
<a href="#l15.1797"></a><span id="l15.1797">    libmime/mimei.c.</span>
<a href="#l15.1798"></a><span id="l15.1798">    */</span>
<a href="#l15.1799"></a><span id="l15.1799" class="difflineminus">-  if (attachment-&gt;m_already_encoded_p &amp;&amp; !attachment-&gt;m_encoding.IsEmpty())</span>
<a href="#l15.1800"></a><span id="l15.1800" class="difflineminus">-  {</span>
<a href="#l15.1801"></a><span id="l15.1801" class="difflineplus">+  if (attachment-&gt;m_already_encoded_p &amp;&amp; !attachment-&gt;m_encoding.IsEmpty()) {</span>
<a href="#l15.1802"></a><span id="l15.1802">     /* #### TOTAL KLUDGE.</span>
<a href="#l15.1803"></a><span id="l15.1803">      I'd like to ask the mime.types file, &quot;what extensions correspond</span>
<a href="#l15.1804"></a><span id="l15.1804">      to obj-&gt;encoding (which happens to be &quot;x-uuencode&quot;) but doing that</span>
<a href="#l15.1805"></a><span id="l15.1805">      in a non-sphagetti way would require brain surgery.  So, since</span>
<a href="#l15.1806"></a><span id="l15.1806">      currently uuencode is the only content-transfer-encoding which we</span>
<a href="#l15.1807"></a><span id="l15.1807">      understand which traditionally has an extension, we just special-</span>
<a href="#l15.1808"></a><span id="l15.1808">      case it here!</span>
<a href="#l15.1809"></a><span id="l15.1809"> </span>
<a href="#l15.1810"></a><span id="l15.1810">      Note that it's special-cased in a similar way in libmime/mimei.c.</span>
<a href="#l15.1811"></a><span id="l15.1811">      */</span>
<a href="#l15.1812"></a><span id="l15.1812">     if (attachment-&gt;m_encoding.LowerCaseEqualsLiteral(ENCODING_UUENCODE) ||</span>
<a href="#l15.1813"></a><span id="l15.1813">         attachment-&gt;m_encoding.LowerCaseEqualsLiteral(ENCODING_UUENCODE2) ||</span>
<a href="#l15.1814"></a><span id="l15.1814">         attachment-&gt;m_encoding.LowerCaseEqualsLiteral(ENCODING_UUENCODE3) ||</span>
<a href="#l15.1815"></a><span id="l15.1815" class="difflineminus">-        attachment-&gt;m_encoding.LowerCaseEqualsLiteral(ENCODING_UUENCODE4))</span>
<a href="#l15.1816"></a><span id="l15.1816" class="difflineminus">-    {</span>
<a href="#l15.1817"></a><span id="l15.1817" class="difflineplus">+        attachment-&gt;m_encoding.LowerCaseEqualsLiteral(ENCODING_UUENCODE4)) {</span>
<a href="#l15.1818"></a><span id="l15.1818">       if (StringEndsWith(attachment-&gt;m_realName, NS_LITERAL_CSTRING(&quot;.uu&quot;)))</span>
<a href="#l15.1819"></a><span id="l15.1819">         attachment-&gt;m_realName.Cut(attachment-&gt;m_realName.Length() - 3, 3);</span>
<a href="#l15.1820"></a><span id="l15.1820" class="difflineminus">-      else if (StringEndsWith(attachment-&gt;m_realName, NS_LITERAL_CSTRING(&quot;.uue&quot;)))</span>
<a href="#l15.1821"></a><span id="l15.1821" class="difflineplus">+      else if (StringEndsWith(attachment-&gt;m_realName,</span>
<a href="#l15.1822"></a><span id="l15.1822" class="difflineplus">+                              NS_LITERAL_CSTRING(&quot;.uue&quot;)))</span>
<a href="#l15.1823"></a><span id="l15.1823">         attachment-&gt;m_realName.Cut(attachment-&gt;m_realName.Length() - 4, 4);</span>
<a href="#l15.1824"></a><span id="l15.1824">     }</span>
<a href="#l15.1825"></a><span id="l15.1825">   }</span>
<a href="#l15.1826"></a><span id="l15.1826"> }</span>
<a href="#l15.1827"></a><span id="l15.1827"> </span>
<a href="#l15.1828"></a><span id="l15.1828"> // Utility to create a nsIURI object...</span>
<a href="#l15.1829"></a><span id="l15.1829" class="difflineminus">-nsresult</span>
<a href="#l15.1830"></a><span id="l15.1830" class="difflineminus">-nsMsgNewURL(nsIURI** aInstancePtrResult, const nsCString&amp; aSpec)</span>
<a href="#l15.1831"></a><span id="l15.1831" class="difflineminus">-{</span>
<a href="#l15.1832"></a><span id="l15.1832" class="difflineplus">+nsresult nsMsgNewURL(nsIURI **aInstancePtrResult, const nsCString &amp;aSpec) {</span>
<a href="#l15.1833"></a><span id="l15.1833">   nsresult rv = NS_OK;</span>
<a href="#l15.1834"></a><span id="l15.1834" class="difflineminus">-  if (nullptr == aInstancePtrResult)</span>
<a href="#l15.1835"></a><span id="l15.1835" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l15.1836"></a><span id="l15.1836" class="difflineminus">-  nsCOMPtr&lt;nsIIOService&gt; pNetService =</span>
<a href="#l15.1837"></a><span id="l15.1837" class="difflineminus">-    mozilla::services::GetIOService();</span>
<a href="#l15.1838"></a><span id="l15.1838" class="difflineplus">+  if (nullptr == aInstancePtrResult) return NS_ERROR_NULL_POINTER;</span>
<a href="#l15.1839"></a><span id="l15.1839" class="difflineplus">+  nsCOMPtr&lt;nsIIOService&gt; pNetService = mozilla::services::GetIOService();</span>
<a href="#l15.1840"></a><span id="l15.1840">   NS_ENSURE_TRUE(pNetService, NS_ERROR_UNEXPECTED);</span>
<a href="#l15.1841"></a><span id="l15.1841" class="difflineminus">-  if (aSpec.Find(&quot;://&quot;) == kNotFound &amp;&amp; !StringBeginsWith(aSpec, NS_LITERAL_CSTRING(&quot;data:&quot;)))</span>
<a href="#l15.1842"></a><span id="l15.1842" class="difflineminus">-  {</span>
<a href="#l15.1843"></a><span id="l15.1843" class="difflineminus">-    //XXXjag Temporary fix for bug 139362 until the real problem(bug 70083) get fixed</span>
<a href="#l15.1844"></a><span id="l15.1844" class="difflineplus">+  if (aSpec.Find(&quot;://&quot;) == kNotFound &amp;&amp;</span>
<a href="#l15.1845"></a><span id="l15.1845" class="difflineplus">+      !StringBeginsWith(aSpec, NS_LITERAL_CSTRING(&quot;data:&quot;))) {</span>
<a href="#l15.1846"></a><span id="l15.1846" class="difflineplus">+    // XXXjag Temporary fix for bug 139362 until the real problem(bug 70083) get</span>
<a href="#l15.1847"></a><span id="l15.1847" class="difflineplus">+    // fixed</span>
<a href="#l15.1848"></a><span id="l15.1848">     nsAutoCString uri(NS_LITERAL_CSTRING(&quot;http://&quot;));</span>
<a href="#l15.1849"></a><span id="l15.1849">     uri.Append(aSpec);</span>
<a href="#l15.1850"></a><span id="l15.1850">     rv = pNetService-&gt;NewURI(uri, nullptr, nullptr, aInstancePtrResult);</span>
<a href="#l15.1851"></a><span id="l15.1851" class="difflineminus">-  }</span>
<a href="#l15.1852"></a><span id="l15.1852" class="difflineminus">-  else</span>
<a href="#l15.1853"></a><span id="l15.1853" class="difflineplus">+  } else</span>
<a href="#l15.1854"></a><span id="l15.1854">     rv = pNetService-&gt;NewURI(aSpec, nullptr, nullptr, aInstancePtrResult);</span>
<a href="#l15.1855"></a><span id="l15.1855">   return rv;</span>
<a href="#l15.1856"></a><span id="l15.1856"> }</span>
<a href="#l15.1857"></a><span id="l15.1857"> </span>
<a href="#l15.1858"></a><span id="l15.1858" class="difflineminus">-bool</span>
<a href="#l15.1859"></a><span id="l15.1859" class="difflineminus">-nsMsgIsLocalFile(const char *url)</span>
<a href="#l15.1860"></a><span id="l15.1860" class="difflineminus">-{</span>
<a href="#l15.1861"></a><span id="l15.1861" class="difflineplus">+bool nsMsgIsLocalFile(const char *url) {</span>
<a href="#l15.1862"></a><span id="l15.1862">   /*</span>
<a href="#l15.1863"></a><span id="l15.1863">     A url is considered as a local file if it's start with file://</span>
<a href="#l15.1864"></a><span id="l15.1864">     But on Window, we need to filter UNC file url because there</span>
<a href="#l15.1865"></a><span id="l15.1865">     are not really local file. Those start with file:////</span>
<a href="#l15.1866"></a><span id="l15.1866">   */</span>
<a href="#l15.1867"></a><span id="l15.1867" class="difflineminus">-  if (PL_strncasecmp(url, &quot;file://&quot;, 7) == 0)</span>
<a href="#l15.1868"></a><span id="l15.1868" class="difflineminus">-  {</span>
<a href="#l15.1869"></a><span id="l15.1869" class="difflineplus">+  if (PL_strncasecmp(url, &quot;file://&quot;, 7) == 0) {</span>
<a href="#l15.1870"></a><span id="l15.1870"> #ifdef XP_WIN</span>
<a href="#l15.1871"></a><span id="l15.1871" class="difflineminus">-    if (PL_strncasecmp(url, &quot;file:////&quot;, 9) == 0)</span>
<a href="#l15.1872"></a><span id="l15.1872" class="difflineminus">-      return false;</span>
<a href="#l15.1873"></a><span id="l15.1873" class="difflineplus">+    if (PL_strncasecmp(url, &quot;file:////&quot;, 9) == 0) return false;</span>
<a href="#l15.1874"></a><span id="l15.1874"> #endif</span>
<a href="#l15.1875"></a><span id="l15.1875">     return true;</span>
<a href="#l15.1876"></a><span id="l15.1876" class="difflineminus">-  }</span>
<a href="#l15.1877"></a><span id="l15.1877" class="difflineminus">-  else</span>
<a href="#l15.1878"></a><span id="l15.1878" class="difflineplus">+  } else</span>
<a href="#l15.1879"></a><span id="l15.1879">     return false;</span>
<a href="#l15.1880"></a><span id="l15.1880"> }</span>
<a href="#l15.1881"></a><span id="l15.1881"> </span>
<a href="#l15.1882"></a><span id="l15.1882" class="difflineminus">-char</span>
<a href="#l15.1883"></a><span id="l15.1883" class="difflineminus">-*nsMsgGetLocalFileFromURL(const char *url)</span>
<a href="#l15.1884"></a><span id="l15.1884" class="difflineminus">-{</span>
<a href="#l15.1885"></a><span id="l15.1885" class="difflineminus">-  char * finalPath;</span>
<a href="#l15.1886"></a><span id="l15.1886" class="difflineplus">+char *nsMsgGetLocalFileFromURL(const char *url) {</span>
<a href="#l15.1887"></a><span id="l15.1887" class="difflineplus">+  char *finalPath;</span>
<a href="#l15.1888"></a><span id="l15.1888">   NS_ASSERTION(PL_strncasecmp(url, &quot;file://&quot;, 7) == 0, &quot;invalid url&quot;);</span>
<a href="#l15.1889"></a><span id="l15.1889" class="difflineminus">-  finalPath = (char*)PR_Malloc(strlen(url));</span>
<a href="#l15.1890"></a><span id="l15.1890" class="difflineminus">-  if (finalPath == NULL)</span>
<a href="#l15.1891"></a><span id="l15.1891" class="difflineminus">-    return NULL;</span>
<a href="#l15.1892"></a><span id="l15.1892" class="difflineminus">-  strcpy(finalPath, url+6+1);</span>
<a href="#l15.1893"></a><span id="l15.1893" class="difflineplus">+  finalPath = (char *)PR_Malloc(strlen(url));</span>
<a href="#l15.1894"></a><span id="l15.1894" class="difflineplus">+  if (finalPath == NULL) return NULL;</span>
<a href="#l15.1895"></a><span id="l15.1895" class="difflineplus">+  strcpy(finalPath, url + 6 + 1);</span>
<a href="#l15.1896"></a><span id="l15.1896">   return finalPath;</span>
<a href="#l15.1897"></a><span id="l15.1897"> }</span>
<a href="#l15.1898"></a><span id="l15.1898"> </span>
<a href="#l15.1899"></a><span id="l15.1899" class="difflineminus">-char *</span>
<a href="#l15.1900"></a><span id="l15.1900" class="difflineminus">-nsMsgParseURLHost(const char *url)</span>
<a href="#l15.1901"></a><span id="l15.1901" class="difflineminus">-{</span>
<a href="#l15.1902"></a><span id="l15.1902" class="difflineminus">-  nsIURI        *workURI = nullptr;</span>
<a href="#l15.1903"></a><span id="l15.1903" class="difflineminus">-  nsresult      rv;</span>
<a href="#l15.1904"></a><span id="l15.1904" class="difflineplus">+char *nsMsgParseURLHost(const char *url) {</span>
<a href="#l15.1905"></a><span id="l15.1905" class="difflineplus">+  nsIURI *workURI = nullptr;</span>
<a href="#l15.1906"></a><span id="l15.1906" class="difflineplus">+  nsresult rv;</span>
<a href="#l15.1907"></a><span id="l15.1907"> </span>
<a href="#l15.1908"></a><span id="l15.1908">   rv = nsMsgNewURL(&amp;workURI, nsDependentCString(url));</span>
<a href="#l15.1909"></a><span id="l15.1909" class="difflineminus">-  if (NS_FAILED(rv) || !workURI)</span>
<a href="#l15.1910"></a><span id="l15.1910" class="difflineminus">-    return nullptr;</span>
<a href="#l15.1911"></a><span id="l15.1911" class="difflineplus">+  if (NS_FAILED(rv) || !workURI) return nullptr;</span>
<a href="#l15.1912"></a><span id="l15.1912"> </span>
<a href="#l15.1913"></a><span id="l15.1913">   nsAutoCString host;</span>
<a href="#l15.1914"></a><span id="l15.1914">   rv = workURI-&gt;GetHost(host);</span>
<a href="#l15.1915"></a><span id="l15.1915">   NS_IF_RELEASE(workURI);</span>
<a href="#l15.1916"></a><span id="l15.1916" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l15.1917"></a><span id="l15.1917" class="difflineminus">-    return nullptr;</span>
<a href="#l15.1918"></a><span id="l15.1918" class="difflineplus">+  if (NS_FAILED(rv)) return nullptr;</span>
<a href="#l15.1919"></a><span id="l15.1919"> </span>
<a href="#l15.1920"></a><span id="l15.1920">   return ToNewCString(host);</span>
<a href="#l15.1921"></a><span id="l15.1921"> }</span>
<a href="#l15.1922"></a><span id="l15.1922"> </span>
<a href="#l15.1923"></a><span id="l15.1923" class="difflineminus">-char *</span>
<a href="#l15.1924"></a><span id="l15.1924" class="difflineminus">-GenerateFileNameFromURI(nsIURI *aURL)</span>
<a href="#l15.1925"></a><span id="l15.1925" class="difflineminus">-{</span>
<a href="#l15.1926"></a><span id="l15.1926" class="difflineminus">-  nsresult    rv;</span>
<a href="#l15.1927"></a><span id="l15.1927" class="difflineplus">+char *GenerateFileNameFromURI(nsIURI *aURL) {</span>
<a href="#l15.1928"></a><span id="l15.1928" class="difflineplus">+  nsresult rv;</span>
<a href="#l15.1929"></a><span id="l15.1929">   nsCString file;</span>
<a href="#l15.1930"></a><span id="l15.1930">   nsCString spec;</span>
<a href="#l15.1931"></a><span id="l15.1931" class="difflineminus">-  char        *returnString;</span>
<a href="#l15.1932"></a><span id="l15.1932" class="difflineminus">-  char        *cp = nullptr;</span>
<a href="#l15.1933"></a><span id="l15.1933" class="difflineminus">-  char        *cp1 = nullptr;</span>
<a href="#l15.1934"></a><span id="l15.1934" class="difflineplus">+  char *returnString;</span>
<a href="#l15.1935"></a><span id="l15.1935" class="difflineplus">+  char *cp = nullptr;</span>
<a href="#l15.1936"></a><span id="l15.1936" class="difflineplus">+  char *cp1 = nullptr;</span>
<a href="#l15.1937"></a><span id="l15.1937"> </span>
<a href="#l15.1938"></a><span id="l15.1938">   rv = aURL-&gt;GetPathQueryRef(file);</span>
<a href="#l15.1939"></a><span id="l15.1939" class="difflineminus">-  if ( NS_SUCCEEDED(rv) &amp;&amp; !file.IsEmpty())</span>
<a href="#l15.1940"></a><span id="l15.1940" class="difflineminus">-  {</span>
<a href="#l15.1941"></a><span id="l15.1941" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !file.IsEmpty()) {</span>
<a href="#l15.1942"></a><span id="l15.1942">     char *newFile = ToNewCString(file);</span>
<a href="#l15.1943"></a><span id="l15.1943" class="difflineminus">-    if (!newFile)</span>
<a href="#l15.1944"></a><span id="l15.1944" class="difflineminus">-      return nullptr;</span>
<a href="#l15.1945"></a><span id="l15.1945" class="difflineplus">+    if (!newFile) return nullptr;</span>
<a href="#l15.1946"></a><span id="l15.1946"> </span>
<a href="#l15.1947"></a><span id="l15.1947">     // strip '/'</span>
<a href="#l15.1948"></a><span id="l15.1948">     cp = PL_strrchr(newFile, '/');</span>
<a href="#l15.1949"></a><span id="l15.1949">     if (cp)</span>
<a href="#l15.1950"></a><span id="l15.1950">       ++cp;</span>
<a href="#l15.1951"></a><span id="l15.1951">     else</span>
<a href="#l15.1952"></a><span id="l15.1952">       cp = newFile;</span>
<a href="#l15.1953"></a><span id="l15.1953"> </span>
<a href="#l15.1954"></a><span id="l15.1954" class="difflineminus">-    if (*cp)</span>
<a href="#l15.1955"></a><span id="l15.1955" class="difflineminus">-    {</span>
<a href="#l15.1956"></a><span id="l15.1956" class="difflineplus">+    if (*cp) {</span>
<a href="#l15.1957"></a><span id="l15.1957">       if ((cp1 = PL_strchr(cp, '/'))) *cp1 = 0;</span>
<a href="#l15.1958"></a><span id="l15.1958">       if ((cp1 = PL_strchr(cp, '?'))) *cp1 = 0;</span>
<a href="#l15.1959"></a><span id="l15.1959">       if ((cp1 = PL_strchr(cp, '&gt;'))) *cp1 = 0;</span>
<a href="#l15.1960"></a><span id="l15.1960" class="difflineminus">-      if (*cp != '\0')</span>
<a href="#l15.1961"></a><span id="l15.1961" class="difflineminus">-      {</span>
<a href="#l15.1962"></a><span id="l15.1962" class="difflineplus">+      if (*cp != '\0') {</span>
<a href="#l15.1963"></a><span id="l15.1963">         returnString = PL_strdup(cp);</span>
<a href="#l15.1964"></a><span id="l15.1964">         PR_FREEIF(newFile);</span>
<a href="#l15.1965"></a><span id="l15.1965">         return returnString;</span>
<a href="#l15.1966"></a><span id="l15.1966">       }</span>
<a href="#l15.1967"></a><span id="l15.1967" class="difflineminus">-    }</span>
<a href="#l15.1968"></a><span id="l15.1968" class="difflineminus">-    else</span>
<a href="#l15.1969"></a><span id="l15.1969" class="difflineplus">+    } else</span>
<a href="#l15.1970"></a><span id="l15.1970">       return nullptr;</span>
<a href="#l15.1971"></a><span id="l15.1971">   }</span>
<a href="#l15.1972"></a><span id="l15.1972"> </span>
<a href="#l15.1973"></a><span id="l15.1973">   cp = nullptr;</span>
<a href="#l15.1974"></a><span id="l15.1974">   cp1 = nullptr;</span>
<a href="#l15.1975"></a><span id="l15.1975"> </span>
<a href="#l15.1976"></a><span id="l15.1976" class="difflineminus">-</span>
<a href="#l15.1977"></a><span id="l15.1977">   rv = aURL-&gt;GetSpec(spec);</span>
<a href="#l15.1978"></a><span id="l15.1978" class="difflineminus">-  if ( NS_SUCCEEDED(rv) &amp;&amp; !spec.IsEmpty())</span>
<a href="#l15.1979"></a><span id="l15.1979" class="difflineminus">-  {</span>
<a href="#l15.1980"></a><span id="l15.1980" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !spec.IsEmpty()) {</span>
<a href="#l15.1981"></a><span id="l15.1981">     char *newSpec = ToNewCString(spec);</span>
<a href="#l15.1982"></a><span id="l15.1982" class="difflineminus">-    if (!newSpec)</span>
<a href="#l15.1983"></a><span id="l15.1983" class="difflineminus">-      return nullptr;</span>
<a href="#l15.1984"></a><span id="l15.1984" class="difflineplus">+    if (!newSpec) return nullptr;</span>
<a href="#l15.1985"></a><span id="l15.1985"> </span>
<a href="#l15.1986"></a><span id="l15.1986" class="difflineminus">-    char *cp2 = NULL, *cp3=NULL ;</span>
<a href="#l15.1987"></a><span id="l15.1987" class="difflineplus">+    char *cp2 = NULL, *cp3 = NULL;</span>
<a href="#l15.1988"></a><span id="l15.1988"> </span>
<a href="#l15.1989"></a><span id="l15.1989">     // strip '&quot;'</span>
<a href="#l15.1990"></a><span id="l15.1990">     cp2 = newSpec;</span>
<a href="#l15.1991"></a><span id="l15.1991" class="difflineminus">-    while (*cp2 == '&quot;')</span>
<a href="#l15.1992"></a><span id="l15.1992" class="difflineminus">-      cp2++;</span>
<a href="#l15.1993"></a><span id="l15.1993" class="difflineminus">-    if ((cp3 = PL_strchr(cp2, '&quot;')))</span>
<a href="#l15.1994"></a><span id="l15.1994" class="difflineminus">-      *cp3 = 0;</span>
<a href="#l15.1995"></a><span id="l15.1995" class="difflineplus">+    while (*cp2 == '&quot;') cp2++;</span>
<a href="#l15.1996"></a><span id="l15.1996" class="difflineplus">+    if ((cp3 = PL_strchr(cp2, '&quot;'))) *cp3 = 0;</span>
<a href="#l15.1997"></a><span id="l15.1997"> </span>
<a href="#l15.1998"></a><span id="l15.1998">     char *hostStr = nsMsgParseURLHost(cp2);</span>
<a href="#l15.1999"></a><span id="l15.1999" class="difflineminus">-    if (!hostStr)</span>
<a href="#l15.2000"></a><span id="l15.2000" class="difflineminus">-      hostStr = PL_strdup(cp2);</span>
<a href="#l15.2001"></a><span id="l15.2001" class="difflineplus">+    if (!hostStr) hostStr = PL_strdup(cp2);</span>
<a href="#l15.2002"></a><span id="l15.2002"> </span>
<a href="#l15.2003"></a><span id="l15.2003">     bool isHTTP = false;</span>
<a href="#l15.2004"></a><span id="l15.2004" class="difflineminus">-    if (NS_SUCCEEDED(aURL-&gt;SchemeIs(&quot;http&quot;, &amp;isHTTP)) &amp;&amp; isHTTP)</span>
<a href="#l15.2005"></a><span id="l15.2005" class="difflineminus">-    {</span>
<a href="#l15.2006"></a><span id="l15.2006" class="difflineminus">-        returnString = PR_smprintf(&quot;%s.html&quot;, hostStr);</span>
<a href="#l15.2007"></a><span id="l15.2007" class="difflineminus">-        PR_FREEIF(hostStr);</span>
<a href="#l15.2008"></a><span id="l15.2008" class="difflineminus">-    }</span>
<a href="#l15.2009"></a><span id="l15.2009" class="difflineminus">-    else</span>
<a href="#l15.2010"></a><span id="l15.2010" class="difflineplus">+    if (NS_SUCCEEDED(aURL-&gt;SchemeIs(&quot;http&quot;, &amp;isHTTP)) &amp;&amp; isHTTP) {</span>
<a href="#l15.2011"></a><span id="l15.2011" class="difflineplus">+      returnString = PR_smprintf(&quot;%s.html&quot;, hostStr);</span>
<a href="#l15.2012"></a><span id="l15.2012" class="difflineplus">+      PR_FREEIF(hostStr);</span>
<a href="#l15.2013"></a><span id="l15.2013" class="difflineplus">+    } else</span>
<a href="#l15.2014"></a><span id="l15.2014">       returnString = hostStr;</span>
<a href="#l15.2015"></a><span id="l15.2015"> </span>
<a href="#l15.2016"></a><span id="l15.2016">     PR_FREEIF(newSpec);</span>
<a href="#l15.2017"></a><span id="l15.2017">     return returnString;</span>
<a href="#l15.2018"></a><span id="l15.2018">   }</span>
<a href="#l15.2019"></a><span id="l15.2019"> </span>
<a href="#l15.2020"></a><span id="l15.2020">   return nullptr;</span>
<a href="#l15.2021"></a><span id="l15.2021"> }</span>
<a href="#l15.2022"></a><span id="l15.2022" class="difflineat">@@ -1613,104 +1424,94 @@ GenerateFileNameFromURI(nsIURI *aURL)</span>
<a href="#l15.2023"></a><span id="l15.2023"> // This routine will generate a content id for use in a mail part.</span>
<a href="#l15.2024"></a><span id="l15.2024"> // It will take the part number passed in as well as the email</span>
<a href="#l15.2025"></a><span id="l15.2025"> // address. If the email address is null or invalid, we will simply</span>
<a href="#l15.2026"></a><span id="l15.2026"> // use netscape.com for the interesting part. The content ID's will</span>
<a href="#l15.2027"></a><span id="l15.2027"> // look like the following:</span>
<a href="#l15.2028"></a><span id="l15.2028"> //</span>
<a href="#l15.2029"></a><span id="l15.2029"> //      Content-ID: &lt;part1.36DF1DCE.73B5A330@netscape.com&gt;</span>
<a href="#l15.2030"></a><span id="l15.2030"> //</span>
<a href="#l15.2031"></a><span id="l15.2031" class="difflineminus">-char *</span>
<a href="#l15.2032"></a><span id="l15.2032" class="difflineminus">-mime_gen_content_id(uint32_t aPartNum, const char *aEmailAddress)</span>
<a href="#l15.2033"></a><span id="l15.2033" class="difflineminus">-{</span>
<a href="#l15.2034"></a><span id="l15.2034" class="difflineminus">-  int32_t           randLen = 5;</span>
<a href="#l15.2035"></a><span id="l15.2035" class="difflineminus">-  unsigned char     rand_buf1[5];</span>
<a href="#l15.2036"></a><span id="l15.2036" class="difflineminus">-  unsigned char     rand_buf2[5];</span>
<a href="#l15.2037"></a><span id="l15.2037" class="difflineminus">-  const char        *domain = nullptr;</span>
<a href="#l15.2038"></a><span id="l15.2038" class="difflineminus">-  const char        *defaultDomain = &quot;@netscape.com&quot;;</span>
<a href="#l15.2039"></a><span id="l15.2039" class="difflineplus">+char *mime_gen_content_id(uint32_t aPartNum, const char *aEmailAddress) {</span>
<a href="#l15.2040"></a><span id="l15.2040" class="difflineplus">+  int32_t randLen = 5;</span>
<a href="#l15.2041"></a><span id="l15.2041" class="difflineplus">+  unsigned char rand_buf1[5];</span>
<a href="#l15.2042"></a><span id="l15.2042" class="difflineplus">+  unsigned char rand_buf2[5];</span>
<a href="#l15.2043"></a><span id="l15.2043" class="difflineplus">+  const char *domain = nullptr;</span>
<a href="#l15.2044"></a><span id="l15.2044" class="difflineplus">+  const char *defaultDomain = &quot;@netscape.com&quot;;</span>
<a href="#l15.2045"></a><span id="l15.2045"> </span>
<a href="#l15.2046"></a><span id="l15.2046" class="difflineminus">-  memset(rand_buf1, 0, randLen-1);</span>
<a href="#l15.2047"></a><span id="l15.2047" class="difflineminus">-  memset(rand_buf2, 0, randLen-1);</span>
<a href="#l15.2048"></a><span id="l15.2048" class="difflineplus">+  memset(rand_buf1, 0, randLen - 1);</span>
<a href="#l15.2049"></a><span id="l15.2049" class="difflineplus">+  memset(rand_buf2, 0, randLen - 1);</span>
<a href="#l15.2050"></a><span id="l15.2050"> </span>
<a href="#l15.2051"></a><span id="l15.2051">   GenerateGlobalRandomBytes(rand_buf1, randLen);</span>
<a href="#l15.2052"></a><span id="l15.2052">   GenerateGlobalRandomBytes(rand_buf2, randLen);</span>
<a href="#l15.2053"></a><span id="l15.2053"> </span>
<a href="#l15.2054"></a><span id="l15.2054">   // Find the @domain.com string...</span>
<a href="#l15.2055"></a><span id="l15.2055">   if (aEmailAddress &amp;&amp; *aEmailAddress)</span>
<a href="#l15.2056"></a><span id="l15.2056" class="difflineminus">-    domain = const_cast&lt;const char*&gt;(PL_strchr(aEmailAddress, '@'));</span>
<a href="#l15.2057"></a><span id="l15.2057" class="difflineplus">+    domain = const_cast&lt;const char *&gt;(PL_strchr(aEmailAddress, '@'));</span>
<a href="#l15.2058"></a><span id="l15.2058"> </span>
<a href="#l15.2059"></a><span id="l15.2059" class="difflineminus">-  if (!domain)</span>
<a href="#l15.2060"></a><span id="l15.2060" class="difflineminus">-    domain = defaultDomain;</span>
<a href="#l15.2061"></a><span id="l15.2061" class="difflineplus">+  if (!domain) domain = defaultDomain;</span>
<a href="#l15.2062"></a><span id="l15.2062"> </span>
<a href="#l15.2063"></a><span id="l15.2063" class="difflineminus">-  char *retVal = PR_smprintf(&quot;part%d.&quot;</span>
<a href="#l15.2064"></a><span id="l15.2064" class="difflineminus">-                              &quot;%02X%02X%02X%02X&quot;</span>
<a href="#l15.2065"></a><span id="l15.2065" class="difflineminus">-                              &quot;.&quot;</span>
<a href="#l15.2066"></a><span id="l15.2066" class="difflineminus">-                              &quot;%02X%02X%02X%02X&quot;</span>
<a href="#l15.2067"></a><span id="l15.2067" class="difflineminus">-                              &quot;%s&quot;,</span>
<a href="#l15.2068"></a><span id="l15.2068" class="difflineminus">-                              aPartNum,</span>
<a href="#l15.2069"></a><span id="l15.2069" class="difflineminus">-                              rand_buf1[0], rand_buf1[1], rand_buf1[2], rand_buf1[3],</span>
<a href="#l15.2070"></a><span id="l15.2070" class="difflineminus">-                              rand_buf2[0], rand_buf2[1], rand_buf2[2], rand_buf2[3],</span>
<a href="#l15.2071"></a><span id="l15.2071" class="difflineminus">-                              domain);</span>
<a href="#l15.2072"></a><span id="l15.2072" class="difflineplus">+  char *retVal = PR_smprintf(</span>
<a href="#l15.2073"></a><span id="l15.2073" class="difflineplus">+      &quot;part%d.&quot;</span>
<a href="#l15.2074"></a><span id="l15.2074" class="difflineplus">+      &quot;%02X%02X%02X%02X&quot;</span>
<a href="#l15.2075"></a><span id="l15.2075" class="difflineplus">+      &quot;.&quot;</span>
<a href="#l15.2076"></a><span id="l15.2076" class="difflineplus">+      &quot;%02X%02X%02X%02X&quot;</span>
<a href="#l15.2077"></a><span id="l15.2077" class="difflineplus">+      &quot;%s&quot;,</span>
<a href="#l15.2078"></a><span id="l15.2078" class="difflineplus">+      aPartNum, rand_buf1[0], rand_buf1[1], rand_buf1[2], rand_buf1[3],</span>
<a href="#l15.2079"></a><span id="l15.2079" class="difflineplus">+      rand_buf2[0], rand_buf2[1], rand_buf2[2], rand_buf2[3], domain);</span>
<a href="#l15.2080"></a><span id="l15.2080"> </span>
<a href="#l15.2081"></a><span id="l15.2081">   return retVal;</span>
<a href="#l15.2082"></a><span id="l15.2082"> }</span>
<a href="#l15.2083"></a><span id="l15.2083"> </span>
<a href="#l15.2084"></a><span id="l15.2084" class="difflineminus">-void</span>
<a href="#l15.2085"></a><span id="l15.2085" class="difflineminus">-GetFolderURIFromUserPrefs(nsMsgDeliverMode aMode, nsIMsgIdentity* identity, nsCString&amp; uri)</span>
<a href="#l15.2086"></a><span id="l15.2086" class="difflineminus">-{</span>
<a href="#l15.2087"></a><span id="l15.2087" class="difflineplus">+void GetFolderURIFromUserPrefs(nsMsgDeliverMode aMode, nsIMsgIdentity *identity,</span>
<a href="#l15.2088"></a><span id="l15.2088" class="difflineplus">+                               nsCString &amp;uri) {</span>
<a href="#l15.2089"></a><span id="l15.2089">   nsresult rv;</span>
<a href="#l15.2090"></a><span id="l15.2090">   uri.Truncate();</span>
<a href="#l15.2091"></a><span id="l15.2091"> </span>
<a href="#l15.2092"></a><span id="l15.2092">   // QueueForLater (Outbox)</span>
<a href="#l15.2093"></a><span id="l15.2093">   if (aMode == nsIMsgSend::nsMsgQueueForLater ||</span>
<a href="#l15.2094"></a><span id="l15.2094" class="difflineminus">-      aMode == nsIMsgSend::nsMsgDeliverBackground)</span>
<a href="#l15.2095"></a><span id="l15.2095" class="difflineminus">-  {</span>
<a href="#l15.2096"></a><span id="l15.2096" class="difflineminus">-    nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l15.2097"></a><span id="l15.2097" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l15.2098"></a><span id="l15.2098" class="difflineminus">-      return;</span>
<a href="#l15.2099"></a><span id="l15.2099" class="difflineplus">+      aMode == nsIMsgSend::nsMsgDeliverBackground) {</span>
<a href="#l15.2100"></a><span id="l15.2100" class="difflineplus">+    nsCOMPtr&lt;nsIPrefBranch&gt; prefs(</span>
<a href="#l15.2101"></a><span id="l15.2101" class="difflineplus">+        do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l15.2102"></a><span id="l15.2102" class="difflineplus">+    if (NS_FAILED(rv)) return;</span>
<a href="#l15.2103"></a><span id="l15.2103">     rv = prefs-&gt;GetCharPref(&quot;mail.default_sendlater_uri&quot;, uri);</span>
<a href="#l15.2104"></a><span id="l15.2104">     if (NS_FAILED(rv) || uri.IsEmpty())</span>
<a href="#l15.2105"></a><span id="l15.2105">       uri.AssignLiteral(ANY_SERVER);</span>
<a href="#l15.2106"></a><span id="l15.2106" class="difflineminus">-    else</span>
<a href="#l15.2107"></a><span id="l15.2107" class="difflineminus">-    {</span>
<a href="#l15.2108"></a><span id="l15.2108" class="difflineplus">+    else {</span>
<a href="#l15.2109"></a><span id="l15.2109">       // check if uri is unescaped, and if so, escape it and reset the pef.</span>
<a href="#l15.2110"></a><span id="l15.2110" class="difflineminus">-      if (uri.FindChar(' ') != kNotFound)</span>
<a href="#l15.2111"></a><span id="l15.2111" class="difflineminus">-      {</span>
<a href="#l15.2112"></a><span id="l15.2112" class="difflineplus">+      if (uri.FindChar(' ') != kNotFound) {</span>
<a href="#l15.2113"></a><span id="l15.2113">         MsgReplaceSubstring(uri, &quot; &quot;, &quot;%20&quot;);</span>
<a href="#l15.2114"></a><span id="l15.2114">         prefs-&gt;SetCharPref(&quot;mail.default_sendlater_uri&quot;, uri);</span>
<a href="#l15.2115"></a><span id="l15.2115">       }</span>
<a href="#l15.2116"></a><span id="l15.2116">     }</span>
<a href="#l15.2117"></a><span id="l15.2117">     return;</span>
<a href="#l15.2118"></a><span id="l15.2118">   }</span>
<a href="#l15.2119"></a><span id="l15.2119"> </span>
<a href="#l15.2120"></a><span id="l15.2120" class="difflineminus">-  if (!identity)</span>
<a href="#l15.2121"></a><span id="l15.2121" class="difflineminus">-    return;</span>
<a href="#l15.2122"></a><span id="l15.2122" class="difflineplus">+  if (!identity) return;</span>
<a href="#l15.2123"></a><span id="l15.2123"> </span>
<a href="#l15.2124"></a><span id="l15.2124" class="difflineminus">-  if (aMode == nsIMsgSend::nsMsgSaveAsDraft)    // SaveAsDraft (Drafts)</span>
<a href="#l15.2125"></a><span id="l15.2125" class="difflineplus">+  if (aMode == nsIMsgSend::nsMsgSaveAsDraft)  // SaveAsDraft (Drafts)</span>
<a href="#l15.2126"></a><span id="l15.2126">     rv = identity-&gt;GetDraftFolder(uri);</span>
<a href="#l15.2127"></a><span id="l15.2127" class="difflineminus">-  else if (aMode == nsIMsgSend::nsMsgSaveAsTemplate) // SaveAsTemplate (Templates)</span>
<a href="#l15.2128"></a><span id="l15.2128" class="difflineplus">+  else if (aMode ==</span>
<a href="#l15.2129"></a><span id="l15.2129" class="difflineplus">+           nsIMsgSend::nsMsgSaveAsTemplate)  // SaveAsTemplate (Templates)</span>
<a href="#l15.2130"></a><span id="l15.2130">     rv = identity-&gt;GetStationeryFolder(uri);</span>
<a href="#l15.2131"></a><span id="l15.2131" class="difflineminus">-  else</span>
<a href="#l15.2132"></a><span id="l15.2132" class="difflineminus">-  {</span>
<a href="#l15.2133"></a><span id="l15.2133" class="difflineplus">+  else {</span>
<a href="#l15.2134"></a><span id="l15.2134">     bool doFcc = false;</span>
<a href="#l15.2135"></a><span id="l15.2135">     rv = identity-&gt;GetDoFcc(&amp;doFcc);</span>
<a href="#l15.2136"></a><span id="l15.2136" class="difflineminus">-    if (doFcc)</span>
<a href="#l15.2137"></a><span id="l15.2137" class="difflineminus">-      rv = identity-&gt;GetFccFolder(uri);</span>
<a href="#l15.2138"></a><span id="l15.2138" class="difflineplus">+    if (doFcc) rv = identity-&gt;GetFccFolder(uri);</span>
<a href="#l15.2139"></a><span id="l15.2139">   }</span>
<a href="#l15.2140"></a><span id="l15.2140">   return;</span>
<a href="#l15.2141"></a><span id="l15.2141"> }</span>
<a href="#l15.2142"></a><span id="l15.2142"> </span>
<a href="#l15.2143"></a><span id="l15.2143"> /**</span>
<a href="#l15.2144"></a><span id="l15.2144">  * Check if we should use format=flowed (RFC 2646) for a mail.</span>
<a href="#l15.2145"></a><span id="l15.2145">  * We will use format=flowed unless the preference tells us not to do so.</span>
<a href="#l15.2146"></a><span id="l15.2146">  * In this function we set all the serialiser flags.</span>
<a href="#l15.2147"></a><span id="l15.2147">  * 'formatted' is always 'true'.</span>
<a href="#l15.2148"></a><span id="l15.2148">  */</span>
<a href="#l15.2149"></a><span id="l15.2149" class="difflineminus">-void GetSerialiserFlags(const char* charset, bool* flowed, bool* delsp, bool* formatted, bool* disallowBreaks)</span>
<a href="#l15.2150"></a><span id="l15.2150" class="difflineminus">-{</span>
<a href="#l15.2151"></a><span id="l15.2151" class="difflineplus">+void GetSerialiserFlags(const char *charset, bool *flowed, bool *delsp,</span>
<a href="#l15.2152"></a><span id="l15.2152" class="difflineplus">+                        bool *formatted, bool *disallowBreaks) {</span>
<a href="#l15.2153"></a><span id="l15.2153">   *flowed = false;</span>
<a href="#l15.2154"></a><span id="l15.2154">   *delsp = false;</span>
<a href="#l15.2155"></a><span id="l15.2155">   *formatted = true;</span>
<a href="#l15.2156"></a><span id="l15.2156">   *disallowBreaks = true;</span>
<a href="#l15.2157"></a><span id="l15.2157"> </span>
<a href="#l15.2158"></a><span id="l15.2158">   // Set format=flowed as in RFC 2646 according to the preference.</span>
<a href="#l15.2159"></a><span id="l15.2159">   nsresult rv;</span>
<a href="#l15.2160"></a><span id="l15.2160">   nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l15.2161"></a><span id="l15.2161" class="difflineat">@@ -1719,40 +1520,38 @@ void GetSerialiserFlags(const char* char</span>
<a href="#l15.2162"></a><span id="l15.2162">   }</span>
<a href="#l15.2163"></a><span id="l15.2163"> </span>
<a href="#l15.2164"></a><span id="l15.2164">   // We could test statefulCharset(charset) here, but since ISO-2022-JP is the</span>
<a href="#l15.2165"></a><span id="l15.2165">   // only one left we support, we might as well check for it directly.</span>
<a href="#l15.2166"></a><span id="l15.2166">   if (PL_strcasecmp(charset, &quot;ISO-2022-JP&quot;) == 0) {</span>
<a href="#l15.2167"></a><span id="l15.2167">     // Make sure we honour RFC 1468. For encoding in ISO-2022-JP we need to</span>
<a href="#l15.2168"></a><span id="l15.2168">     // send short lines to allow 7bit transfer encoding.</span>
<a href="#l15.2169"></a><span id="l15.2169">     *disallowBreaks = false;</span>
<a href="#l15.2170"></a><span id="l15.2170" class="difflineminus">-    if (*flowed)</span>
<a href="#l15.2171"></a><span id="l15.2171" class="difflineminus">-      *delsp = true;</span>
<a href="#l15.2172"></a><span id="l15.2172" class="difflineplus">+    if (*flowed) *delsp = true;</span>
<a href="#l15.2173"></a><span id="l15.2173">   }</span>
<a href="#l15.2174"></a><span id="l15.2174"> }</span>
<a href="#l15.2175"></a><span id="l15.2175"> </span>
<a href="#l15.2176"></a><span id="l15.2176" class="difflineminus">-already_AddRefed&lt;nsIArray&gt;</span>
<a href="#l15.2177"></a><span id="l15.2177" class="difflineminus">-GetEmbeddedObjects(mozilla::dom::Document* aDocument)</span>
<a href="#l15.2178"></a><span id="l15.2178" class="difflineminus">-{</span>
<a href="#l15.2179"></a><span id="l15.2179" class="difflineplus">+already_AddRefed&lt;nsIArray&gt; GetEmbeddedObjects(</span>
<a href="#l15.2180"></a><span id="l15.2180" class="difflineplus">+    mozilla::dom::Document *aDocument) {</span>
<a href="#l15.2181"></a><span id="l15.2181">   nsCOMPtr&lt;nsIMutableArray&gt; nodes = do_CreateInstance(NS_ARRAY_CONTRACTID);</span>
<a href="#l15.2182"></a><span id="l15.2182">   if (NS_WARN_IF(!nodes)) {</span>
<a href="#l15.2183"></a><span id="l15.2183">     return nullptr;</span>
<a href="#l15.2184"></a><span id="l15.2184">   }</span>
<a href="#l15.2185"></a><span id="l15.2185"> </span>
<a href="#l15.2186"></a><span id="l15.2186">   mozilla::PostContentIterator iter;</span>
<a href="#l15.2187"></a><span id="l15.2187">   nsresult rv = iter.Init(aDocument-&gt;GetRootElement());</span>
<a href="#l15.2188"></a><span id="l15.2188">   if (NS_WARN_IF(NS_FAILED(rv))) {</span>
<a href="#l15.2189"></a><span id="l15.2189">     return nullptr;</span>
<a href="#l15.2190"></a><span id="l15.2190">   }</span>
<a href="#l15.2191"></a><span id="l15.2191"> </span>
<a href="#l15.2192"></a><span id="l15.2192">   // Loop through the content iterator for each content node.</span>
<a href="#l15.2193"></a><span id="l15.2193">   while (!iter.IsDone()) {</span>
<a href="#l15.2194"></a><span id="l15.2194" class="difflineminus">-    nsINode* node = iter.GetCurrentNode();</span>
<a href="#l15.2195"></a><span id="l15.2195" class="difflineplus">+    nsINode *node = iter.GetCurrentNode();</span>
<a href="#l15.2196"></a><span id="l15.2196">     if (node-&gt;IsElement()) {</span>
<a href="#l15.2197"></a><span id="l15.2197" class="difflineminus">-      mozilla::dom::Element* element = node-&gt;AsElement();</span>
<a href="#l15.2198"></a><span id="l15.2198" class="difflineplus">+      mozilla::dom::Element *element = node-&gt;AsElement();</span>
<a href="#l15.2199"></a><span id="l15.2199"> </span>
<a href="#l15.2200"></a><span id="l15.2200">       // See if it's an image or also include all links.</span>
<a href="#l15.2201"></a><span id="l15.2201">       // Let mail decide which link to send or not</span>
<a href="#l15.2202"></a><span id="l15.2202">       if (element-&gt;IsAnyOfHTMLElements(nsGkAtoms::img, nsGkAtoms::a) ||</span>
<a href="#l15.2203"></a><span id="l15.2203">           (element-&gt;IsHTMLElement(nsGkAtoms::body) &amp;&amp;</span>
<a href="#l15.2204"></a><span id="l15.2204">            element-&gt;HasAttr(kNameSpaceID_None, nsGkAtoms::background))) {</span>
<a href="#l15.2205"></a><span id="l15.2205">         nodes-&gt;AppendElement(node);</span>
<a href="#l15.2206"></a><span id="l15.2206">       }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompUtils.h</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompUtils.h</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -19,128 +19,111 @@ class nsIPrompt;</span>
<a href="#l16.4"></a><span id="l16.4"> #define ANY_SERVER &quot;anyfolder://&quot;</span>
<a href="#l16.5"></a><span id="l16.5"> </span>
<a href="#l16.6"></a><span id="l16.6"> // these are msg hdr property names for storing the original</span>
<a href="#l16.7"></a><span id="l16.7"> // msg uri's and disposition(replied/forwarded) when queuing</span>
<a href="#l16.8"></a><span id="l16.8"> // messages to send later.</span>
<a href="#l16.9"></a><span id="l16.9"> #define ORIG_URI_PROPERTY &quot;origURIs&quot;</span>
<a href="#l16.10"></a><span id="l16.10"> #define QUEUED_DISPOSITION_PROPERTY &quot;queuedDisposition&quot;</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-class nsMsgCompUtils : public nsIMsgCompUtils</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-{</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">-public:</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+class nsMsgCompUtils : public nsIMsgCompUtils {</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+ public:</span>
<a href="#l16.17"></a><span id="l16.17">   NS_DECL_ISUPPORTS</span>
<a href="#l16.18"></a><span id="l16.18">   NS_DECL_NSIMSGCOMPUTILS</span>
<a href="#l16.19"></a><span id="l16.19"> </span>
<a href="#l16.20"></a><span id="l16.20">   nsMsgCompUtils();</span>
<a href="#l16.21"></a><span id="l16.21"> </span>
<a href="#l16.22"></a><span id="l16.22" class="difflineminus">-private:</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineplus">+ private:</span>
<a href="#l16.24"></a><span id="l16.24">   virtual ~nsMsgCompUtils();</span>
<a href="#l16.25"></a><span id="l16.25"> };</span>
<a href="#l16.26"></a><span id="l16.26"> </span>
<a href="#l16.27"></a><span id="l16.27" class="difflineminus">-already_AddRefed&lt;nsIArray&gt; GetEmbeddedObjects(mozilla::dom::Document* aDocument);</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineplus">+already_AddRefed&lt;nsIArray&gt; GetEmbeddedObjects(</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineplus">+    mozilla::dom::Document *aDocument);</span>
<a href="#l16.30"></a><span id="l16.30"> </span>
<a href="#l16.31"></a><span id="l16.31"> PR_BEGIN_EXTERN_C</span>
<a href="#l16.32"></a><span id="l16.32"> </span>
<a href="#l16.33"></a><span id="l16.33"> //</span>
<a href="#l16.34"></a><span id="l16.34"> // Create a file spec or file name using the name passed</span>
<a href="#l16.35"></a><span id="l16.35"> // in as a template</span>
<a href="#l16.36"></a><span id="l16.36"> //</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineminus">-nsresult    nsMsgCreateTempFile(const char *tFileName, nsIFile **tFile);</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineminus">-char        *nsMsgCreateTempFileName(const char *tFileName);</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineminus">-</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineplus">+nsresult nsMsgCreateTempFile(const char *tFileName, nsIFile **tFile);</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineplus">+char *nsMsgCreateTempFileName(const char *tFileName);</span>
<a href="#l16.42"></a><span id="l16.42"> </span>
<a href="#l16.43"></a><span id="l16.43"> //</span>
<a href="#l16.44"></a><span id="l16.44"> // Various utilities for building parts of MIME encoded</span>
<a href="#l16.45"></a><span id="l16.45"> // messages during message composition</span>
<a href="#l16.46"></a><span id="l16.46"> //</span>
<a href="#l16.47"></a><span id="l16.47"> </span>
<a href="#l16.48"></a><span id="l16.48" class="difflineminus">-nsresult    mime_sanity_check_fields_recipients (</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineminus">-                            const char *to,</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineminus">-                            const char *cc,</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineminus">-                            const char *bcc,</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineminus">-                            const char *newsgroups);</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineplus">+nsresult mime_sanity_check_fields_recipients(const char *to, const char *cc,</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineplus">+                                             const char *bcc,</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineplus">+                                             const char *newsgroups);</span>
<a href="#l16.56"></a><span id="l16.56"> </span>
<a href="#l16.57"></a><span id="l16.57" class="difflineminus">-nsresult    mime_sanity_check_fields (</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineminus">-                            const char *from,</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineminus">-                            const char *reply_to,</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineminus">-                            const char *to,</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineminus">-                            const char *cc,</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineminus">-                            const char *bcc,</span>
<a href="#l16.63"></a><span id="l16.63" class="difflineminus">-                            const char *fcc,</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineminus">-                            const char *newsgroups,</span>
<a href="#l16.65"></a><span id="l16.65" class="difflineminus">-                            const char *followup_to,</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineminus">-                            const char * /*subject*/,</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineminus">-                            const char * /*references*/,</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineminus">-                            const char * /*organization*/,</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineminus">-                            const char * /*other_random_headers*/);</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineplus">+nsresult mime_sanity_check_fields(</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineplus">+    const char *from, const char *reply_to, const char *to, const char *cc,</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineplus">+    const char *bcc, const char *fcc, const char *newsgroups,</span>
<a href="#l16.73"></a><span id="l16.73" class="difflineplus">+    const char *followup_to, const char * /*subject*/,</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineplus">+    const char * /*references*/, const char * /*organization*/,</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineplus">+    const char * /*other_random_headers*/);</span>
<a href="#l16.76"></a><span id="l16.76"> </span>
<a href="#l16.77"></a><span id="l16.77"> nsresult mime_generate_headers(nsIMsgCompFields *fields,</span>
<a href="#l16.78"></a><span id="l16.78">                                nsMsgDeliverMode deliver_mode,</span>
<a href="#l16.79"></a><span id="l16.79">                                msgIWritableStructuredHeaders *headers);</span>
<a href="#l16.80"></a><span id="l16.80"> </span>
<a href="#l16.81"></a><span id="l16.81" class="difflineminus">-char        *mime_make_separator(const char *prefix);</span>
<a href="#l16.82"></a><span id="l16.82" class="difflineminus">-char        *mime_gen_content_id(uint32_t aPartNum, const char *aEmailAddress);</span>
<a href="#l16.83"></a><span id="l16.83" class="difflineplus">+char *mime_make_separator(const char *prefix);</span>
<a href="#l16.84"></a><span id="l16.84" class="difflineplus">+char *mime_gen_content_id(uint32_t aPartNum, const char *aEmailAddress);</span>
<a href="#l16.85"></a><span id="l16.85" class="difflineplus">+</span>
<a href="#l16.86"></a><span id="l16.86" class="difflineplus">+char *mime_generate_attachment_headers(</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineplus">+    const char *type, const char *type_param, const char *encoding,</span>
<a href="#l16.88"></a><span id="l16.88" class="difflineplus">+    const char *description, const char *x_mac_type, const char *x_mac_creator,</span>
<a href="#l16.89"></a><span id="l16.89" class="difflineplus">+    const char *real_name, const char *base_url, bool digest_p,</span>
<a href="#l16.90"></a><span id="l16.90" class="difflineplus">+    nsMsgAttachmentHandler *ma,</span>
<a href="#l16.91"></a><span id="l16.91" class="difflineplus">+    const char *attachmentCharset,  // charset of the attachment (can be null)</span>
<a href="#l16.92"></a><span id="l16.92" class="difflineplus">+    const char *bodyCharset,        // charset of the main body</span>
<a href="#l16.93"></a><span id="l16.93" class="difflineplus">+    bool bodyIsAsciiOnly, const char *content_id, bool aBodyDocument);</span>
<a href="#l16.94"></a><span id="l16.94"> </span>
<a href="#l16.95"></a><span id="l16.95" class="difflineminus">-char        *mime_generate_attachment_headers (</span>
<a href="#l16.96"></a><span id="l16.96" class="difflineminus">-                           const char *type,</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineminus">-                           const char *type_param,</span>
<a href="#l16.98"></a><span id="l16.98" class="difflineminus">-                           const char *encoding,</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineminus">-                           const char *description,</span>
<a href="#l16.100"></a><span id="l16.100" class="difflineminus">-                           const char *x_mac_type,</span>
<a href="#l16.101"></a><span id="l16.101" class="difflineminus">-                           const char *x_mac_creator,</span>
<a href="#l16.102"></a><span id="l16.102" class="difflineminus">-                           const char *real_name,</span>
<a href="#l16.103"></a><span id="l16.103" class="difflineminus">-                           const char *base_url,</span>
<a href="#l16.104"></a><span id="l16.104" class="difflineminus">-                           bool digest_p,</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineminus">-                           nsMsgAttachmentHandler *ma,</span>
<a href="#l16.106"></a><span id="l16.106" class="difflineminus">-                           const char *attachmentCharset, // charset of the attachment (can be null)</span>
<a href="#l16.107"></a><span id="l16.107" class="difflineminus">-                           const char *bodyCharset,       // charset of the main body</span>
<a href="#l16.108"></a><span id="l16.108" class="difflineminus">-                           bool bodyIsAsciiOnly,</span>
<a href="#l16.109"></a><span id="l16.109" class="difflineminus">-                           const char *content_id,</span>
<a href="#l16.110"></a><span id="l16.110" class="difflineminus">-                           bool       aBodyDocument);</span>
<a href="#l16.111"></a><span id="l16.111" class="difflineplus">+char *msg_generate_message_id(nsIMsgIdentity *);</span>
<a href="#l16.112"></a><span id="l16.112" class="difflineplus">+</span>
<a href="#l16.113"></a><span id="l16.113" class="difflineplus">+bool mime_7bit_data_p(const char *string, uint32_t size);</span>
<a href="#l16.114"></a><span id="l16.114"> </span>
<a href="#l16.115"></a><span id="l16.115" class="difflineminus">-char        *msg_generate_message_id (nsIMsgIdentity*);</span>
<a href="#l16.116"></a><span id="l16.116" class="difflineminus">-</span>
<a href="#l16.117"></a><span id="l16.117" class="difflineminus">-bool        mime_7bit_data_p (const char *string, uint32_t size);</span>
<a href="#l16.118"></a><span id="l16.118" class="difflineplus">+char *mime_fix_header_1(const char *string, bool addr_p, bool news_p);</span>
<a href="#l16.119"></a><span id="l16.119" class="difflineplus">+char *mime_fix_header(const char *string);</span>
<a href="#l16.120"></a><span id="l16.120" class="difflineplus">+char *mime_fix_addr_header(const char *string);</span>
<a href="#l16.121"></a><span id="l16.121" class="difflineplus">+char *mime_fix_news_header(const char *string);</span>
<a href="#l16.122"></a><span id="l16.122"> </span>
<a href="#l16.123"></a><span id="l16.123" class="difflineminus">-char        *mime_fix_header_1 (const char *string, bool addr_p, bool news_p);</span>
<a href="#l16.124"></a><span id="l16.124" class="difflineminus">-char        *mime_fix_header (const char *string);</span>
<a href="#l16.125"></a><span id="l16.125" class="difflineminus">-char        *mime_fix_addr_header (const char *string);</span>
<a href="#l16.126"></a><span id="l16.126" class="difflineminus">-char        *mime_fix_news_header (const char *string);</span>
<a href="#l16.127"></a><span id="l16.127" class="difflineplus">+bool mime_type_requires_b64_p(const char *type);</span>
<a href="#l16.128"></a><span id="l16.128" class="difflineplus">+bool mime_type_needs_charset(const char *type);</span>
<a href="#l16.129"></a><span id="l16.129"> </span>
<a href="#l16.130"></a><span id="l16.130" class="difflineminus">-bool        mime_type_requires_b64_p (const char *type);</span>
<a href="#l16.131"></a><span id="l16.131" class="difflineminus">-bool        mime_type_needs_charset (const char *type);</span>
<a href="#l16.132"></a><span id="l16.132" class="difflineminus">-</span>
<a href="#l16.133"></a><span id="l16.133" class="difflineminus">-char        *msg_make_filename_qtext(const char *srcText, bool stripCRLFs);</span>
<a href="#l16.134"></a><span id="l16.134" class="difflineplus">+char *msg_make_filename_qtext(const char *srcText, bool stripCRLFs);</span>
<a href="#l16.135"></a><span id="l16.135"> </span>
<a href="#l16.136"></a><span id="l16.136"> // Rip apart the URL and extract a reasonable value for the `real_name' slot.</span>
<a href="#l16.137"></a><span id="l16.137" class="difflineminus">-void        msg_pick_real_name (nsMsgAttachmentHandler *attachment, const char16_t *proposedName, const char *charset);</span>
<a href="#l16.138"></a><span id="l16.138" class="difflineplus">+void msg_pick_real_name(nsMsgAttachmentHandler *attachment,</span>
<a href="#l16.139"></a><span id="l16.139" class="difflineplus">+                        const char16_t *proposedName, const char *charset);</span>
<a href="#l16.140"></a><span id="l16.140"> </span>
<a href="#l16.141"></a><span id="l16.141"> //</span>
<a href="#l16.142"></a><span id="l16.142"> // Informational calls...</span>
<a href="#l16.143"></a><span id="l16.143"> //</span>
<a href="#l16.144"></a><span id="l16.144" class="difflineminus">-void        nsMsgMIMESetConformToStandard (bool conform_p);</span>
<a href="#l16.145"></a><span id="l16.145" class="difflineminus">-bool        nsMsgMIMEGetConformToStandard (void);</span>
<a href="#l16.146"></a><span id="l16.146" class="difflineplus">+void nsMsgMIMESetConformToStandard(bool conform_p);</span>
<a href="#l16.147"></a><span id="l16.147" class="difflineplus">+bool nsMsgMIMEGetConformToStandard(void);</span>
<a href="#l16.148"></a><span id="l16.148"> </span>
<a href="#l16.149"></a><span id="l16.149"> //</span>
<a href="#l16.150"></a><span id="l16.150"> // network service type calls...</span>
<a href="#l16.151"></a><span id="l16.151"> //</span>
<a href="#l16.152"></a><span id="l16.152" class="difflineminus">-nsresult    nsMsgNewURL(nsIURI** aInstancePtrResult, const nsCString&amp; aSpec);</span>
<a href="#l16.153"></a><span id="l16.153" class="difflineminus">-bool        nsMsgIsLocalFile(const char *url);</span>
<a href="#l16.154"></a><span id="l16.154" class="difflineminus">-char        *nsMsgGetLocalFileFromURL(const char *url);</span>
<a href="#l16.155"></a><span id="l16.155" class="difflineplus">+nsresult nsMsgNewURL(nsIURI **aInstancePtrResult, const nsCString &amp;aSpec);</span>
<a href="#l16.156"></a><span id="l16.156" class="difflineplus">+bool nsMsgIsLocalFile(const char *url);</span>
<a href="#l16.157"></a><span id="l16.157" class="difflineplus">+char *nsMsgGetLocalFileFromURL(const char *url);</span>
<a href="#l16.158"></a><span id="l16.158"> </span>
<a href="#l16.159"></a><span id="l16.159" class="difflineminus">-char        *nsMsgParseURLHost(const char *url);</span>
<a href="#l16.160"></a><span id="l16.160" class="difflineplus">+char *nsMsgParseURLHost(const char *url);</span>
<a href="#l16.161"></a><span id="l16.161"> </span>
<a href="#l16.162"></a><span id="l16.162" class="difflineminus">-char        *GenerateFileNameFromURI(nsIURI *aURL);</span>
<a href="#l16.163"></a><span id="l16.163" class="difflineplus">+char *GenerateFileNameFromURI(nsIURI *aURL);</span>
<a href="#l16.164"></a><span id="l16.164"> </span>
<a href="#l16.165"></a><span id="l16.165"> //</span>
<a href="#l16.166"></a><span id="l16.166"> // Folder calls...</span>
<a href="#l16.167"></a><span id="l16.167"> //</span>
<a href="#l16.168"></a><span id="l16.168" class="difflineminus">-void GetFolderURIFromUserPrefs(nsMsgDeliverMode   aMode, nsIMsgIdentity *identity, nsCString&amp; uri);</span>
<a href="#l16.169"></a><span id="l16.169" class="difflineplus">+void GetFolderURIFromUserPrefs(nsMsgDeliverMode aMode, nsIMsgIdentity *identity,</span>
<a href="#l16.170"></a><span id="l16.170" class="difflineplus">+                               nsCString &amp;uri);</span>
<a href="#l16.171"></a><span id="l16.171"> </span>
<a href="#l16.172"></a><span id="l16.172"> // Check if we should use format=flowed</span>
<a href="#l16.173"></a><span id="l16.173" class="difflineminus">-void GetSerialiserFlags(const char *charset, bool *flowed, bool *delsp, bool *formatted, bool *disallowBreaks);</span>
<a href="#l16.174"></a><span id="l16.174" class="difflineplus">+void GetSerialiserFlags(const char *charset, bool *flowed, bool *delsp,</span>
<a href="#l16.175"></a><span id="l16.175" class="difflineplus">+                        bool *formatted, bool *disallowBreaks);</span>
<a href="#l16.176"></a><span id="l16.176"> </span>
<a href="#l16.177"></a><span id="l16.177"> PR_END_EXTERN_C</span>
<a href="#l16.178"></a><span id="l16.178"> </span>
<a href="#l16.179"></a><span id="l16.179" class="difflineminus">-</span>
<a href="#l16.180"></a><span id="l16.180"> #endif /* _nsMsgCompUtils_H_ */</span>
<a href="#l16.181"></a><span id="l16.181" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -8,17 +8,17 @@</span>
<a href="#l17.4"></a><span id="l17.4"> #include &quot;nsPIDOMWindow.h&quot;</span>
<a href="#l17.5"></a><span id="l17.5"> #include &quot;mozIDOMWindow.h&quot;</span>
<a href="#l17.6"></a><span id="l17.6"> #include &quot;nsISelectionController.h&quot;</span>
<a href="#l17.7"></a><span id="l17.7"> #include &quot;nsMsgI18N.h&quot;</span>
<a href="#l17.8"></a><span id="l17.8"> #include &quot;nsMsgCompCID.h&quot;</span>
<a href="#l17.9"></a><span id="l17.9"> #include &quot;nsMsgQuote.h&quot;</span>
<a href="#l17.10"></a><span id="l17.10"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l17.11"></a><span id="l17.11"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-#include &quot;nsIDocumentEncoder.h&quot;    // for editor output flags</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+#include &quot;nsIDocumentEncoder.h&quot;  // for editor output flags</span>
<a href="#l17.14"></a><span id="l17.14"> #include &quot;nsMsgCompUtils.h&quot;</span>
<a href="#l17.15"></a><span id="l17.15"> #include &quot;nsComposeStrings.h&quot;</span>
<a href="#l17.16"></a><span id="l17.16"> #include &quot;nsIMsgSend.h&quot;</span>
<a href="#l17.17"></a><span id="l17.17"> #include &quot;nsMailHeaders.h&quot;</span>
<a href="#l17.18"></a><span id="l17.18"> #include &quot;nsMsgPrompts.h&quot;</span>
<a href="#l17.19"></a><span id="l17.19"> #include &quot;nsMimeTypes.h&quot;</span>
<a href="#l17.20"></a><span id="l17.20"> #include &quot;nsICharsetConverterManager.h&quot;</span>
<a href="#l17.21"></a><span id="l17.21"> #include &quot;nsTextFormatter.h&quot;</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineat">@@ -71,345 +71,326 @@</span>
<a href="#l17.23"></a><span id="l17.23"> #include &quot;mozilla/dom/HTMLAnchorElement.h&quot;</span>
<a href="#l17.24"></a><span id="l17.24"> #include &quot;mozilla/dom/HTMLImageElement.h&quot;</span>
<a href="#l17.25"></a><span id="l17.25"> #include &quot;mozilla/dom/Selection.h&quot;</span>
<a href="#l17.26"></a><span id="l17.26"> #include &quot;nsStreamConverter.h&quot;</span>
<a href="#l17.27"></a><span id="l17.27"> #include &quot;nsIObserverService.h&quot;</span>
<a href="#l17.28"></a><span id="l17.28"> #include &quot;nsIProtocolHandler.h&quot;</span>
<a href="#l17.29"></a><span id="l17.29"> #include &quot;nsContentUtils.h&quot;</span>
<a href="#l17.30"></a><span id="l17.30"> #include &quot;nsIFileURL.h&quot;</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineminus">-#include &quot;nsTextNode.h&quot; // from dom/base</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+#include &quot;nsTextNode.h&quot;  // from dom/base</span>
<a href="#l17.33"></a><span id="l17.33"> </span>
<a href="#l17.34"></a><span id="l17.34"> using namespace mozilla;</span>
<a href="#l17.35"></a><span id="l17.35"> using namespace mozilla::dom;</span>
<a href="#l17.36"></a><span id="l17.36"> using namespace mozilla::mailnews;</span>
<a href="#l17.37"></a><span id="l17.37"> </span>
<a href="#l17.38"></a><span id="l17.38" class="difflineminus">-static nsresult GetReplyHeaderInfo(int32_t* reply_header_type,</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineminus">-                                   nsString&amp; reply_header_authorwrote,</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineminus">-                                   nsString&amp; reply_header_ondateauthorwrote,</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineminus">-                                   nsString&amp; reply_header_authorwroteondate,</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineminus">-                                   nsString&amp; reply_header_originalmessage)</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineminus">-{</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineplus">+static nsresult GetReplyHeaderInfo(int32_t *reply_header_type,</span>
<a href="#l17.45"></a><span id="l17.45" class="difflineplus">+                                   nsString &amp;reply_header_authorwrote,</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineplus">+                                   nsString &amp;reply_header_ondateauthorwrote,</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineplus">+                                   nsString &amp;reply_header_authorwroteondate,</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineplus">+                                   nsString &amp;reply_header_originalmessage) {</span>
<a href="#l17.49"></a><span id="l17.49">   nsresult rv;</span>
<a href="#l17.50"></a><span id="l17.50">   *reply_header_type = 0;</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(</span>
<a href="#l17.53"></a><span id="l17.53" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l17.54"></a><span id="l17.54">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.55"></a><span id="l17.55"> </span>
<a href="#l17.56"></a><span id="l17.56">   // If fetching any of the preferences fails,</span>
<a href="#l17.57"></a><span id="l17.57">   // we return early with header_type = 0 meaning &quot;no header&quot;.</span>
<a href="#l17.58"></a><span id="l17.58" class="difflineminus">-  rv = NS_GetLocalizedUnicharPreference(prefBranch, &quot;mailnews.reply_header_authorwrotesingle&quot;,</span>
<a href="#l17.59"></a><span id="l17.59" class="difflineminus">-                                        reply_header_authorwrote);</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineplus">+  rv = NS_GetLocalizedUnicharPreference(</span>
<a href="#l17.61"></a><span id="l17.61" class="difflineplus">+      prefBranch, &quot;mailnews.reply_header_authorwrotesingle&quot;,</span>
<a href="#l17.62"></a><span id="l17.62" class="difflineplus">+      reply_header_authorwrote);</span>
<a href="#l17.63"></a><span id="l17.63">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.64"></a><span id="l17.64"> </span>
<a href="#l17.65"></a><span id="l17.65" class="difflineminus">-  rv = NS_GetLocalizedUnicharPreference(prefBranch, &quot;mailnews.reply_header_ondateauthorwrote&quot;,</span>
<a href="#l17.66"></a><span id="l17.66" class="difflineminus">-                                        reply_header_ondateauthorwrote);</span>
<a href="#l17.67"></a><span id="l17.67" class="difflineplus">+  rv = NS_GetLocalizedUnicharPreference(</span>
<a href="#l17.68"></a><span id="l17.68" class="difflineplus">+      prefBranch, &quot;mailnews.reply_header_ondateauthorwrote&quot;,</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineplus">+      reply_header_ondateauthorwrote);</span>
<a href="#l17.70"></a><span id="l17.70">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.71"></a><span id="l17.71"> </span>
<a href="#l17.72"></a><span id="l17.72" class="difflineminus">-  rv = NS_GetLocalizedUnicharPreference(prefBranch, &quot;mailnews.reply_header_authorwroteondate&quot;,</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineminus">-                                        reply_header_authorwroteondate);</span>
<a href="#l17.74"></a><span id="l17.74" class="difflineplus">+  rv = NS_GetLocalizedUnicharPreference(</span>
<a href="#l17.75"></a><span id="l17.75" class="difflineplus">+      prefBranch, &quot;mailnews.reply_header_authorwroteondate&quot;,</span>
<a href="#l17.76"></a><span id="l17.76" class="difflineplus">+      reply_header_authorwroteondate);</span>
<a href="#l17.77"></a><span id="l17.77">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.78"></a><span id="l17.78"> </span>
<a href="#l17.79"></a><span id="l17.79" class="difflineminus">-  rv = NS_GetLocalizedUnicharPreference(prefBranch, &quot;mailnews.reply_header_originalmessage&quot;,</span>
<a href="#l17.80"></a><span id="l17.80" class="difflineplus">+  rv = NS_GetLocalizedUnicharPreference(prefBranch,</span>
<a href="#l17.81"></a><span id="l17.81" class="difflineplus">+                                        &quot;mailnews.reply_header_originalmessage&quot;,</span>
<a href="#l17.82"></a><span id="l17.82">                                         reply_header_originalmessage);</span>
<a href="#l17.83"></a><span id="l17.83">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.84"></a><span id="l17.84"> </span>
<a href="#l17.85"></a><span id="l17.85" class="difflineminus">-  return prefBranch-&gt;GetIntPref(&quot;mailnews.reply_header_type&quot;, reply_header_type);</span>
<a href="#l17.86"></a><span id="l17.86" class="difflineplus">+  return prefBranch-&gt;GetIntPref(&quot;mailnews.reply_header_type&quot;,</span>
<a href="#l17.87"></a><span id="l17.87" class="difflineplus">+                                reply_header_type);</span>
<a href="#l17.88"></a><span id="l17.88"> }</span>
<a href="#l17.89"></a><span id="l17.89"> </span>
<a href="#l17.90"></a><span id="l17.90" class="difflineminus">-static void TranslateLineEnding(nsString&amp; data)</span>
<a href="#l17.91"></a><span id="l17.91" class="difflineminus">-{</span>
<a href="#l17.92"></a><span id="l17.92" class="difflineminus">-  char16_t* rPtr;   //Read pointer</span>
<a href="#l17.93"></a><span id="l17.93" class="difflineminus">-  char16_t* wPtr;   //Write pointer</span>
<a href="#l17.94"></a><span id="l17.94" class="difflineminus">-  char16_t* sPtr;   //Start data pointer</span>
<a href="#l17.95"></a><span id="l17.95" class="difflineminus">-  char16_t* ePtr;   //End data pointer</span>
<a href="#l17.96"></a><span id="l17.96" class="difflineplus">+static void TranslateLineEnding(nsString &amp;data) {</span>
<a href="#l17.97"></a><span id="l17.97" class="difflineplus">+  char16_t *rPtr;  // Read pointer</span>
<a href="#l17.98"></a><span id="l17.98" class="difflineplus">+  char16_t *wPtr;  // Write pointer</span>
<a href="#l17.99"></a><span id="l17.99" class="difflineplus">+  char16_t *sPtr;  // Start data pointer</span>
<a href="#l17.100"></a><span id="l17.100" class="difflineplus">+  char16_t *ePtr;  // End data pointer</span>
<a href="#l17.101"></a><span id="l17.101"> </span>
<a href="#l17.102"></a><span id="l17.102">   rPtr = wPtr = sPtr = data.BeginWriting();</span>
<a href="#l17.103"></a><span id="l17.103">   ePtr = rPtr + data.Length();</span>
<a href="#l17.104"></a><span id="l17.104"> </span>
<a href="#l17.105"></a><span id="l17.105" class="difflineminus">-  while (rPtr &lt; ePtr)</span>
<a href="#l17.106"></a><span id="l17.106" class="difflineminus">-  {</span>
<a href="#l17.107"></a><span id="l17.107" class="difflineplus">+  while (rPtr &lt; ePtr) {</span>
<a href="#l17.108"></a><span id="l17.108">     if (*rPtr == nsCRT::CR) {</span>
<a href="#l17.109"></a><span id="l17.109">       *wPtr = nsCRT::LF;</span>
<a href="#l17.110"></a><span id="l17.110" class="difflineminus">-      if (rPtr + 1 &lt; ePtr &amp;&amp; *(rPtr + 1) == nsCRT::LF)</span>
<a href="#l17.111"></a><span id="l17.111" class="difflineminus">-        rPtr ++;</span>
<a href="#l17.112"></a><span id="l17.112" class="difflineminus">-    }</span>
<a href="#l17.113"></a><span id="l17.113" class="difflineminus">-    else</span>
<a href="#l17.114"></a><span id="l17.114" class="difflineplus">+      if (rPtr + 1 &lt; ePtr &amp;&amp; *(rPtr + 1) == nsCRT::LF) rPtr++;</span>
<a href="#l17.115"></a><span id="l17.115" class="difflineplus">+    } else</span>
<a href="#l17.116"></a><span id="l17.116">       *wPtr = *rPtr;</span>
<a href="#l17.117"></a><span id="l17.117"> </span>
<a href="#l17.118"></a><span id="l17.118" class="difflineminus">-    rPtr ++;</span>
<a href="#l17.119"></a><span id="l17.119" class="difflineminus">-    wPtr ++;</span>
<a href="#l17.120"></a><span id="l17.120" class="difflineplus">+    rPtr++;</span>
<a href="#l17.121"></a><span id="l17.121" class="difflineplus">+    wPtr++;</span>
<a href="#l17.122"></a><span id="l17.122">   }</span>
<a href="#l17.123"></a><span id="l17.123"> </span>
<a href="#l17.124"></a><span id="l17.124">   data.SetLength(wPtr - sPtr);</span>
<a href="#l17.125"></a><span id="l17.125"> }</span>
<a href="#l17.126"></a><span id="l17.126"> </span>
<a href="#l17.127"></a><span id="l17.127" class="difflineminus">-static void GetTopmostMsgWindowCharacterSet(nsCString&amp; charset, bool* charsetOverride)</span>
<a href="#l17.128"></a><span id="l17.128" class="difflineminus">-{</span>
<a href="#l17.129"></a><span id="l17.129" class="difflineminus">-  // HACK: if we are replying to a message and that message used a charset over ride</span>
<a href="#l17.130"></a><span id="l17.130" class="difflineminus">-  // (as specified in the top most window (assuming the reply originated from that window)</span>
<a href="#l17.131"></a><span id="l17.131" class="difflineminus">-  // then use that over ride charset instead of the charset specified in the message</span>
<a href="#l17.132"></a><span id="l17.132" class="difflineminus">-  nsCOMPtr &lt;nsIMsgMailSession&gt; mailSession (do_GetService(NS_MSGMAILSESSION_CONTRACTID));</span>
<a href="#l17.133"></a><span id="l17.133" class="difflineminus">-  if (mailSession)</span>
<a href="#l17.134"></a><span id="l17.134" class="difflineminus">-  {</span>
<a href="#l17.135"></a><span id="l17.135" class="difflineminus">-    nsCOMPtr&lt;nsIMsgWindow&gt;    msgWindow;</span>
<a href="#l17.136"></a><span id="l17.136" class="difflineplus">+static void GetTopmostMsgWindowCharacterSet(nsCString &amp;charset,</span>
<a href="#l17.137"></a><span id="l17.137" class="difflineplus">+                                            bool *charsetOverride) {</span>
<a href="#l17.138"></a><span id="l17.138" class="difflineplus">+  // HACK: if we are replying to a message and that message used a charset over</span>
<a href="#l17.139"></a><span id="l17.139" class="difflineplus">+  // ride (as specified in the top most window (assuming the reply originated</span>
<a href="#l17.140"></a><span id="l17.140" class="difflineplus">+  // from that window) then use that over ride charset instead of the charset</span>
<a href="#l17.141"></a><span id="l17.141" class="difflineplus">+  // specified in the message</span>
<a href="#l17.142"></a><span id="l17.142" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession(</span>
<a href="#l17.143"></a><span id="l17.143" class="difflineplus">+      do_GetService(NS_MSGMAILSESSION_CONTRACTID));</span>
<a href="#l17.144"></a><span id="l17.144" class="difflineplus">+  if (mailSession) {</span>
<a href="#l17.145"></a><span id="l17.145" class="difflineplus">+    nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l17.146"></a><span id="l17.146">     mailSession-&gt;GetTopmostMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l17.147"></a><span id="l17.147" class="difflineminus">-    if (msgWindow)</span>
<a href="#l17.148"></a><span id="l17.148" class="difflineminus">-    {</span>
<a href="#l17.149"></a><span id="l17.149" class="difflineplus">+    if (msgWindow) {</span>
<a href="#l17.150"></a><span id="l17.150">       msgWindow-&gt;GetMailCharacterSet(charset);</span>
<a href="#l17.151"></a><span id="l17.151">       msgWindow-&gt;GetCharsetOverride(charsetOverride);</span>
<a href="#l17.152"></a><span id="l17.152">     }</span>
<a href="#l17.153"></a><span id="l17.153">   }</span>
<a href="#l17.154"></a><span id="l17.154"> }</span>
<a href="#l17.155"></a><span id="l17.155"> </span>
<a href="#l17.156"></a><span id="l17.156" class="difflineminus">-nsMsgCompose::nsMsgCompose()</span>
<a href="#l17.157"></a><span id="l17.157" class="difflineminus">-{</span>
<a href="#l17.158"></a><span id="l17.158" class="difflineminus">-</span>
<a href="#l17.159"></a><span id="l17.159" class="difflineplus">+nsMsgCompose::nsMsgCompose() {</span>
<a href="#l17.160"></a><span id="l17.160">   mQuotingToFollow = false;</span>
<a href="#l17.161"></a><span id="l17.161">   mInsertingQuotedContent = false;</span>
<a href="#l17.162"></a><span id="l17.162">   mWhatHolder = 1;</span>
<a href="#l17.163"></a><span id="l17.163">   m_window = nullptr;</span>
<a href="#l17.164"></a><span id="l17.164">   m_editor = nullptr;</span>
<a href="#l17.165"></a><span id="l17.165" class="difflineminus">-  mQuoteStreamListener=nullptr;</span>
<a href="#l17.166"></a><span id="l17.166" class="difflineplus">+  mQuoteStreamListener = nullptr;</span>
<a href="#l17.167"></a><span id="l17.167">   mCharsetOverride = false;</span>
<a href="#l17.168"></a><span id="l17.168">   mAnswerDefaultCharset = false;</span>
<a href="#l17.169"></a><span id="l17.169">   mDeleteDraft = false;</span>
<a href="#l17.170"></a><span id="l17.170" class="difflineminus">-  m_compFields = nullptr;    //m_compFields will be set during nsMsgCompose::Initialize</span>
<a href="#l17.171"></a><span id="l17.171" class="difflineplus">+  m_compFields =</span>
<a href="#l17.172"></a><span id="l17.172" class="difflineplus">+      nullptr;  // m_compFields will be set during nsMsgCompose::Initialize</span>
<a href="#l17.173"></a><span id="l17.173">   mType = nsIMsgCompType::New;</span>
<a href="#l17.174"></a><span id="l17.174"> </span>
<a href="#l17.175"></a><span id="l17.175">   // For TagConvertible</span>
<a href="#l17.176"></a><span id="l17.176">   // Read and cache pref</span>
<a href="#l17.177"></a><span id="l17.177">   mConvertStructs = false;</span>
<a href="#l17.178"></a><span id="l17.178" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch (do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l17.179"></a><span id="l17.179" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l17.180"></a><span id="l17.180">   if (prefBranch)</span>
<a href="#l17.181"></a><span id="l17.181">     prefBranch-&gt;GetBoolPref(&quot;converter.html2txt.structs&quot;, &amp;mConvertStructs);</span>
<a href="#l17.182"></a><span id="l17.182"> </span>
<a href="#l17.183"></a><span id="l17.183">   m_composeHTML = false;</span>
<a href="#l17.184"></a><span id="l17.184"> }</span>
<a href="#l17.185"></a><span id="l17.185"> </span>
<a href="#l17.186"></a><span id="l17.186" class="difflineminus">-</span>
<a href="#l17.187"></a><span id="l17.187" class="difflineminus">-nsMsgCompose::~nsMsgCompose()</span>
<a href="#l17.188"></a><span id="l17.188" class="difflineminus">-{</span>
<a href="#l17.189"></a><span id="l17.189" class="difflineminus">-}</span>
<a href="#l17.190"></a><span id="l17.190" class="difflineminus">-</span>
<a href="#l17.191"></a><span id="l17.191" class="difflineminus">-/* the following macro actually implement addref, release and query interface for our component. */</span>
<a href="#l17.192"></a><span id="l17.192" class="difflineplus">+nsMsgCompose::~nsMsgCompose() {}</span>
<a href="#l17.193"></a><span id="l17.193" class="difflineplus">+</span>
<a href="#l17.194"></a><span id="l17.194" class="difflineplus">+/* the following macro actually implement addref, release and query interface</span>
<a href="#l17.195"></a><span id="l17.195" class="difflineplus">+ * for our component. */</span>
<a href="#l17.196"></a><span id="l17.196"> NS_IMPL_ISUPPORTS(nsMsgCompose, nsIMsgCompose, nsIMsgSendListener,</span>
<a href="#l17.197"></a><span id="l17.197" class="difflineminus">-  nsISupportsWeakReference)</span>
<a href="#l17.198"></a><span id="l17.198" class="difflineplus">+                  nsISupportsWeakReference)</span>
<a href="#l17.199"></a><span id="l17.199"> </span>
<a href="#l17.200"></a><span id="l17.200"> //</span>
<a href="#l17.201"></a><span id="l17.201"> // Once we are here, convert the data which we know to be UTF-8 to UTF-16</span>
<a href="#l17.202"></a><span id="l17.202"> // for insertion into the editor</span>
<a href="#l17.203"></a><span id="l17.203"> //</span>
<a href="#l17.204"></a><span id="l17.204" class="difflineminus">-nsresult</span>
<a href="#l17.205"></a><span id="l17.205" class="difflineminus">-GetChildOffset(nsINode *aChild, nsINode *aParent, int32_t &amp;aOffset)</span>
<a href="#l17.206"></a><span id="l17.206" class="difflineminus">-{</span>
<a href="#l17.207"></a><span id="l17.207" class="difflineplus">+nsresult GetChildOffset(nsINode *aChild, nsINode *aParent, int32_t &amp;aOffset) {</span>
<a href="#l17.208"></a><span id="l17.208">   NS_ASSERTION((aChild &amp;&amp; aParent), &quot;bad args&quot;);</span>
<a href="#l17.209"></a><span id="l17.209"> </span>
<a href="#l17.210"></a><span id="l17.210" class="difflineminus">-  if (!aChild || !aParent)</span>
<a href="#l17.211"></a><span id="l17.211" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l17.212"></a><span id="l17.212" class="difflineminus">-</span>
<a href="#l17.213"></a><span id="l17.213" class="difflineminus">-  nsINodeList* childNodes = aParent-&gt;ChildNodes();</span>
<a href="#l17.214"></a><span id="l17.214" class="difflineminus">-  for (uint32_t i = 0; i &lt; childNodes-&gt;Length(); i++)</span>
<a href="#l17.215"></a><span id="l17.215" class="difflineminus">-  {</span>
<a href="#l17.216"></a><span id="l17.216" class="difflineminus">-    nsINode* childNode = childNodes-&gt;Item(i);</span>
<a href="#l17.217"></a><span id="l17.217" class="difflineminus">-    if (childNode == aChild)</span>
<a href="#l17.218"></a><span id="l17.218" class="difflineminus">-    {</span>
<a href="#l17.219"></a><span id="l17.219" class="difflineplus">+  if (!aChild || !aParent) return NS_ERROR_NULL_POINTER;</span>
<a href="#l17.220"></a><span id="l17.220" class="difflineplus">+</span>
<a href="#l17.221"></a><span id="l17.221" class="difflineplus">+  nsINodeList *childNodes = aParent-&gt;ChildNodes();</span>
<a href="#l17.222"></a><span id="l17.222" class="difflineplus">+  for (uint32_t i = 0; i &lt; childNodes-&gt;Length(); i++) {</span>
<a href="#l17.223"></a><span id="l17.223" class="difflineplus">+    nsINode *childNode = childNodes-&gt;Item(i);</span>
<a href="#l17.224"></a><span id="l17.224" class="difflineplus">+    if (childNode == aChild) {</span>
<a href="#l17.225"></a><span id="l17.225">       aOffset = i;</span>
<a href="#l17.226"></a><span id="l17.226">       return NS_OK;</span>
<a href="#l17.227"></a><span id="l17.227">     }</span>
<a href="#l17.228"></a><span id="l17.228">   }</span>
<a href="#l17.229"></a><span id="l17.229"> </span>
<a href="#l17.230"></a><span id="l17.230">   return NS_ERROR_NULL_POINTER;</span>
<a href="#l17.231"></a><span id="l17.231"> }</span>
<a href="#l17.232"></a><span id="l17.232"> </span>
<a href="#l17.233"></a><span id="l17.233" class="difflineminus">-nsresult</span>
<a href="#l17.234"></a><span id="l17.234" class="difflineminus">-GetNodeLocation(nsINode *inChild, nsCOMPtr&lt;nsINode&gt; *outParent, int32_t *outOffset)</span>
<a href="#l17.235"></a><span id="l17.235" class="difflineminus">-{</span>
<a href="#l17.236"></a><span id="l17.236" class="difflineplus">+nsresult GetNodeLocation(nsINode *inChild, nsCOMPtr&lt;nsINode&gt; *outParent,</span>
<a href="#l17.237"></a><span id="l17.237" class="difflineplus">+                         int32_t *outOffset) {</span>
<a href="#l17.238"></a><span id="l17.238">   NS_ASSERTION((outParent &amp;&amp; outOffset), &quot;bad args&quot;);</span>
<a href="#l17.239"></a><span id="l17.239">   nsresult result = NS_ERROR_NULL_POINTER;</span>
<a href="#l17.240"></a><span id="l17.240" class="difflineminus">-  if (inChild &amp;&amp; outParent &amp;&amp; outOffset)</span>
<a href="#l17.241"></a><span id="l17.241" class="difflineminus">-  {</span>
<a href="#l17.242"></a><span id="l17.242" class="difflineplus">+  if (inChild &amp;&amp; outParent &amp;&amp; outOffset) {</span>
<a href="#l17.243"></a><span id="l17.243">     nsCOMPtr&lt;nsINode&gt; inChild2 = inChild;</span>
<a href="#l17.244"></a><span id="l17.244">     *outParent = inChild2-&gt;GetParentNode();</span>
<a href="#l17.245"></a><span id="l17.245" class="difflineminus">-    if (*outParent)</span>
<a href="#l17.246"></a><span id="l17.246" class="difflineminus">-    {</span>
<a href="#l17.247"></a><span id="l17.247" class="difflineplus">+    if (*outParent) {</span>
<a href="#l17.248"></a><span id="l17.248">       result = GetChildOffset(inChild2, *outParent, *outOffset);</span>
<a href="#l17.249"></a><span id="l17.249">     }</span>
<a href="#l17.250"></a><span id="l17.250">   }</span>
<a href="#l17.251"></a><span id="l17.251"> </span>
<a href="#l17.252"></a><span id="l17.252">   return result;</span>
<a href="#l17.253"></a><span id="l17.253"> }</span>
<a href="#l17.254"></a><span id="l17.254"> </span>
<a href="#l17.255"></a><span id="l17.255" class="difflineminus">-bool nsMsgCompose::IsEmbeddedObjectSafe(const char * originalScheme,</span>
<a href="#l17.256"></a><span id="l17.256" class="difflineminus">-                                        const char * originalHost,</span>
<a href="#l17.257"></a><span id="l17.257" class="difflineminus">-                                        const char * originalPath,</span>
<a href="#l17.258"></a><span id="l17.258" class="difflineminus">-                                        Element * element)</span>
<a href="#l17.259"></a><span id="l17.259" class="difflineminus">-{</span>
<a href="#l17.260"></a><span id="l17.260" class="difflineplus">+bool nsMsgCompose::IsEmbeddedObjectSafe(const char *originalScheme,</span>
<a href="#l17.261"></a><span id="l17.261" class="difflineplus">+                                        const char *originalHost,</span>
<a href="#l17.262"></a><span id="l17.262" class="difflineplus">+                                        const char *originalPath,</span>
<a href="#l17.263"></a><span id="l17.263" class="difflineplus">+                                        Element *element) {</span>
<a href="#l17.264"></a><span id="l17.264">   nsresult rv;</span>
<a href="#l17.265"></a><span id="l17.265"> </span>
<a href="#l17.266"></a><span id="l17.266">   nsAutoString objURL;</span>
<a href="#l17.267"></a><span id="l17.267"> </span>
<a href="#l17.268"></a><span id="l17.268" class="difflineminus">-  if (!originalScheme || !originalPath) // Having a null host is OK.</span>
<a href="#l17.269"></a><span id="l17.269" class="difflineplus">+  if (!originalScheme || !originalPath)  // Having a null host is OK.</span>
<a href="#l17.270"></a><span id="l17.270">     return false;</span>
<a href="#l17.271"></a><span id="l17.271"> </span>
<a href="#l17.272"></a><span id="l17.272" class="difflineminus">-  RefPtr&lt;HTMLImageElement&gt;  image  = HTMLImageElement::FromNode(element);</span>
<a href="#l17.273"></a><span id="l17.273" class="difflineplus">+  RefPtr&lt;HTMLImageElement&gt; image = HTMLImageElement::FromNode(element);</span>
<a href="#l17.274"></a><span id="l17.274">   RefPtr&lt;HTMLAnchorElement&gt; anchor = HTMLAnchorElement::FromNode(element);</span>
<a href="#l17.275"></a><span id="l17.275"> </span>
<a href="#l17.276"></a><span id="l17.276">   if (image)</span>
<a href="#l17.277"></a><span id="l17.277">     image-&gt;GetSrc(objURL);</span>
<a href="#l17.278"></a><span id="l17.278">   else if (anchor)</span>
<a href="#l17.279"></a><span id="l17.279">     anchor-&gt;GetHref(objURL);</span>
<a href="#l17.280"></a><span id="l17.280">   else</span>
<a href="#l17.281"></a><span id="l17.281">     return false;</span>
<a href="#l17.282"></a><span id="l17.282"> </span>
<a href="#l17.283"></a><span id="l17.283" class="difflineminus">-  if (!objURL.IsEmpty())</span>
<a href="#l17.284"></a><span id="l17.284" class="difflineminus">-  {</span>
<a href="#l17.285"></a><span id="l17.285" class="difflineplus">+  if (!objURL.IsEmpty()) {</span>
<a href="#l17.286"></a><span id="l17.286">     nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l17.287"></a><span id="l17.287">     rv = NS_NewURI(getter_AddRefs(uri), objURL);</span>
<a href="#l17.288"></a><span id="l17.288" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; uri)</span>
<a href="#l17.289"></a><span id="l17.289" class="difflineminus">-    {</span>
<a href="#l17.290"></a><span id="l17.290" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; uri) {</span>
<a href="#l17.291"></a><span id="l17.291">       nsAutoCString scheme;</span>
<a href="#l17.292"></a><span id="l17.292">       rv = uri-&gt;GetScheme(scheme);</span>
<a href="#l17.293"></a><span id="l17.293" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; scheme.Equals(originalScheme, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l17.294"></a><span id="l17.294" class="difflineminus">-      {</span>
<a href="#l17.295"></a><span id="l17.295" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp;</span>
<a href="#l17.296"></a><span id="l17.296" class="difflineplus">+          scheme.Equals(originalScheme, nsCaseInsensitiveCStringComparator())) {</span>
<a href="#l17.297"></a><span id="l17.297">         nsAutoCString host;</span>
<a href="#l17.298"></a><span id="l17.298">         rv = uri-&gt;GetAsciiHost(host);</span>
<a href="#l17.299"></a><span id="l17.299">         // mailbox url don't have a host therefore don't be too strict.</span>
<a href="#l17.300"></a><span id="l17.300" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; (host.IsEmpty() || originalHost || host.Equals(originalHost, nsCaseInsensitiveCStringComparator())))</span>
<a href="#l17.301"></a><span id="l17.301" class="difflineminus">-        {</span>
<a href="#l17.302"></a><span id="l17.302" class="difflineplus">+        if (NS_SUCCEEDED(rv) &amp;&amp;</span>
<a href="#l17.303"></a><span id="l17.303" class="difflineplus">+            (host.IsEmpty() || originalHost ||</span>
<a href="#l17.304"></a><span id="l17.304" class="difflineplus">+             host.Equals(originalHost, nsCaseInsensitiveCStringComparator()))) {</span>
<a href="#l17.305"></a><span id="l17.305">           nsAutoCString path;</span>
<a href="#l17.306"></a><span id="l17.306">           rv = uri-&gt;GetPathQueryRef(path);</span>
<a href="#l17.307"></a><span id="l17.307" class="difflineminus">-          if (NS_SUCCEEDED(rv))</span>
<a href="#l17.308"></a><span id="l17.308" class="difflineminus">-          {</span>
<a href="#l17.309"></a><span id="l17.309" class="difflineminus">-            const char * query = strrchr(path.get(), '?');</span>
<a href="#l17.310"></a><span id="l17.310" class="difflineminus">-            if (query &amp;&amp; PL_strncasecmp(path.get(), originalPath, query - path.get()) == 0)</span>
<a href="#l17.311"></a><span id="l17.311" class="difflineminus">-              return true; // This object is a part of the original message, we can send it safely.</span>
<a href="#l17.312"></a><span id="l17.312" class="difflineplus">+          if (NS_SUCCEEDED(rv)) {</span>
<a href="#l17.313"></a><span id="l17.313" class="difflineplus">+            const char *query = strrchr(path.get(), '?');</span>
<a href="#l17.314"></a><span id="l17.314" class="difflineplus">+            if (query &amp;&amp; PL_strncasecmp(path.get(), originalPath,</span>
<a href="#l17.315"></a><span id="l17.315" class="difflineplus">+                                        query - path.get()) == 0)</span>
<a href="#l17.316"></a><span id="l17.316" class="difflineplus">+              return true;  // This object is a part of the original message, we</span>
<a href="#l17.317"></a><span id="l17.317" class="difflineplus">+                            // can send it safely.</span>
<a href="#l17.318"></a><span id="l17.318">           }</span>
<a href="#l17.319"></a><span id="l17.319">         }</span>
<a href="#l17.320"></a><span id="l17.320">       }</span>
<a href="#l17.321"></a><span id="l17.321">     }</span>
<a href="#l17.322"></a><span id="l17.322">   }</span>
<a href="#l17.323"></a><span id="l17.323"> </span>
<a href="#l17.324"></a><span id="l17.324">   return false;</span>
<a href="#l17.325"></a><span id="l17.325"> }</span>
<a href="#l17.326"></a><span id="l17.326"> </span>
<a href="#l17.327"></a><span id="l17.327" class="difflineminus">-/* Reset the uri's of embedded objects because we've saved the draft message, and the</span>
<a href="#l17.328"></a><span id="l17.328" class="difflineminus">-   original message doesn't exist anymore.</span>
<a href="#l17.329"></a><span id="l17.329" class="difflineplus">+/* Reset the uri's of embedded objects because we've saved the draft message,</span>
<a href="#l17.330"></a><span id="l17.330" class="difflineplus">+   and the original message doesn't exist anymore.</span>
<a href="#l17.331"></a><span id="l17.331">  */</span>
<a href="#l17.332"></a><span id="l17.332" class="difflineminus">-nsresult nsMsgCompose::ResetUrisForEmbeddedObjects()</span>
<a href="#l17.333"></a><span id="l17.333" class="difflineminus">-{</span>
<a href="#l17.334"></a><span id="l17.334" class="difflineplus">+nsresult nsMsgCompose::ResetUrisForEmbeddedObjects() {</span>
<a href="#l17.335"></a><span id="l17.335">   uint32_t numNodes;</span>
<a href="#l17.336"></a><span id="l17.336">   uint32_t i;</span>
<a href="#l17.337"></a><span id="l17.337"> </span>
<a href="#l17.338"></a><span id="l17.338" class="difflineminus">-  if (!m_editor)</span>
<a href="#l17.339"></a><span id="l17.339" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l17.340"></a><span id="l17.340" class="difflineplus">+  if (!m_editor) return NS_ERROR_FAILURE;</span>
<a href="#l17.341"></a><span id="l17.341"> </span>
<a href="#l17.342"></a><span id="l17.342">   nsCOMPtr&lt;Document&gt; document;</span>
<a href="#l17.343"></a><span id="l17.343">   m_editor-&gt;GetDocument(getter_AddRefs(document));</span>
<a href="#l17.344"></a><span id="l17.344" class="difflineminus">-  if (!document)</span>
<a href="#l17.345"></a><span id="l17.345" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l17.346"></a><span id="l17.346" class="difflineplus">+  if (!document) return NS_ERROR_FAILURE;</span>
<a href="#l17.347"></a><span id="l17.347">   nsCOMPtr&lt;nsIArray&gt; aNodeList = GetEmbeddedObjects(document);</span>
<a href="#l17.348"></a><span id="l17.348" class="difflineminus">-  if (!aNodeList)</span>
<a href="#l17.349"></a><span id="l17.349" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l17.350"></a><span id="l17.350" class="difflineminus">-</span>
<a href="#l17.351"></a><span id="l17.351" class="difflineminus">-  if (NS_FAILED(aNodeList-&gt;GetLength(&amp;numNodes)))</span>
<a href="#l17.352"></a><span id="l17.352" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l17.353"></a><span id="l17.353" class="difflineplus">+  if (!aNodeList) return NS_ERROR_FAILURE;</span>
<a href="#l17.354"></a><span id="l17.354" class="difflineplus">+</span>
<a href="#l17.355"></a><span id="l17.355" class="difflineplus">+  if (NS_FAILED(aNodeList-&gt;GetLength(&amp;numNodes))) return NS_ERROR_FAILURE;</span>
<a href="#l17.356"></a><span id="l17.356"> </span>
<a href="#l17.357"></a><span id="l17.357">   nsCString curDraftIdURL;</span>
<a href="#l17.358"></a><span id="l17.358"> </span>
<a href="#l17.359"></a><span id="l17.359">   nsresult rv = m_compFields-&gt;GetDraftId(getter_Copies(curDraftIdURL));</span>
<a href="#l17.360"></a><span id="l17.360"> </span>
<a href="#l17.361"></a><span id="l17.361">   // Skip if no draft id (probably a new draft msg).</span>
<a href="#l17.362"></a><span id="l17.362" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; mMsgSend &amp;&amp; !curDraftIdURL.IsEmpty())</span>
<a href="#l17.363"></a><span id="l17.363" class="difflineminus">-  {</span>
<a href="#l17.364"></a><span id="l17.364" class="difflineminus">-    nsCOMPtr &lt;nsIMsgDBHdr&gt; msgDBHdr;</span>
<a href="#l17.365"></a><span id="l17.365" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; mMsgSend &amp;&amp; !curDraftIdURL.IsEmpty()) {</span>
<a href="#l17.366"></a><span id="l17.366" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt; msgDBHdr;</span>
<a href="#l17.367"></a><span id="l17.367">     rv = GetMsgDBHdrFromURI(curDraftIdURL.get(), getter_AddRefs(msgDBHdr));</span>
<a href="#l17.368"></a><span id="l17.368" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(rv), &quot;RemoveCurrentDraftMessage can't get msg header DB interface pointer.&quot;);</span>
<a href="#l17.369"></a><span id="l17.369" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; msgDBHdr)</span>
<a href="#l17.370"></a><span id="l17.370" class="difflineminus">-    {</span>
<a href="#l17.371"></a><span id="l17.371" class="difflineplus">+    NS_ASSERTION(</span>
<a href="#l17.372"></a><span id="l17.372" class="difflineplus">+        NS_SUCCEEDED(rv),</span>
<a href="#l17.373"></a><span id="l17.373" class="difflineplus">+        &quot;RemoveCurrentDraftMessage can't get msg header DB interface pointer.&quot;);</span>
<a href="#l17.374"></a><span id="l17.374" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; msgDBHdr) {</span>
<a href="#l17.375"></a><span id="l17.375">       // build up the old and new ?number= parts. This code assumes it is</span>
<a href="#l17.376"></a><span id="l17.376">       // called *before* RemoveCurrentDraftMessage, so that curDraftIdURL</span>
<a href="#l17.377"></a><span id="l17.377">       // is the previous draft.</span>
<a href="#l17.378"></a><span id="l17.378">       // This code works for both imap and local messages.</span>
<a href="#l17.379"></a><span id="l17.379">       nsMsgKey newMsgKey;</span>
<a href="#l17.380"></a><span id="l17.380">       nsCString folderUri;</span>
<a href="#l17.381"></a><span id="l17.381">       nsCString baseMsgUri;</span>
<a href="#l17.382"></a><span id="l17.382">       mMsgSend-&gt;GetMessageKey(&amp;newMsgKey);</span>
<a href="#l17.383"></a><span id="l17.383">       mMsgSend-&gt;GetFolderUri(folderUri);</span>
<a href="#l17.384"></a><span id="l17.384">       nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l17.385"></a><span id="l17.385">       rv = GetExistingFolder(folderUri, getter_AddRefs(folder));</span>
<a href="#l17.386"></a><span id="l17.386">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.387"></a><span id="l17.387">       folder-&gt;GetBaseMessageURI(baseMsgUri);</span>
<a href="#l17.388"></a><span id="l17.388">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.389"></a><span id="l17.389"> </span>
<a href="#l17.390"></a><span id="l17.390">       RefPtr&lt;Element&gt; domElement;</span>
<a href="#l17.391"></a><span id="l17.391" class="difflineminus">-      for (i = 0; i &lt; numNodes; i ++)</span>
<a href="#l17.392"></a><span id="l17.392" class="difflineminus">-      {</span>
<a href="#l17.393"></a><span id="l17.393" class="difflineplus">+      for (i = 0; i &lt; numNodes; i++) {</span>
<a href="#l17.394"></a><span id="l17.394">         domElement = do_QueryElementAt(aNodeList, i);</span>
<a href="#l17.395"></a><span id="l17.395" class="difflineminus">-        if (!domElement)</span>
<a href="#l17.396"></a><span id="l17.396" class="difflineminus">-          continue;</span>
<a href="#l17.397"></a><span id="l17.397" class="difflineplus">+        if (!domElement) continue;</span>
<a href="#l17.398"></a><span id="l17.398"> </span>
<a href="#l17.399"></a><span id="l17.399">         RefPtr&lt;HTMLImageElement&gt; image = HTMLImageElement::FromNode(domElement);</span>
<a href="#l17.400"></a><span id="l17.400" class="difflineminus">-        if (!image)</span>
<a href="#l17.401"></a><span id="l17.401" class="difflineminus">-          continue;</span>
<a href="#l17.402"></a><span id="l17.402" class="difflineplus">+        if (!image) continue;</span>
<a href="#l17.403"></a><span id="l17.403">         nsCString partNum;</span>
<a href="#l17.404"></a><span id="l17.404">         mMsgSend-&gt;GetPartForDomIndex(i, partNum);</span>
<a href="#l17.405"></a><span id="l17.405">         // do we care about anything besides images?</span>
<a href="#l17.406"></a><span id="l17.406">         nsAutoString objURL;</span>
<a href="#l17.407"></a><span id="l17.407">         image-&gt;GetSrc(objURL);</span>
<a href="#l17.408"></a><span id="l17.408"> </span>
<a href="#l17.409"></a><span id="l17.409">         // First we need to make sure that the URL is associated with a message</span>
<a href="#l17.410"></a><span id="l17.410">         // protocol so we don't accidentally manipulate a URL like:</span>
<a href="#l17.411"></a><span id="l17.411">         // http://www.site.com/retrieve.html?C=image.jpg.</span>
<a href="#l17.412"></a><span id="l17.412" class="difflineminus">-        nsCOMPtr&lt;nsIIOService&gt; ioService = do_GetService(NS_IOSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l17.413"></a><span id="l17.413" class="difflineplus">+        nsCOMPtr&lt;nsIIOService&gt; ioService =</span>
<a href="#l17.414"></a><span id="l17.414" class="difflineplus">+            do_GetService(NS_IOSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l17.415"></a><span id="l17.415">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.416"></a><span id="l17.416">         nsAutoCString scheme;</span>
<a href="#l17.417"></a><span id="l17.417">         ioService-&gt;ExtractScheme(NS_ConvertUTF16toUTF8(objURL), scheme);</span>
<a href="#l17.418"></a><span id="l17.418"> </span>
<a href="#l17.419"></a><span id="l17.419">         // Detect message protocols where attachments can occur.</span>
<a href="#l17.420"></a><span id="l17.420">         nsCOMPtr&lt;nsIProtocolHandler&gt; handler;</span>
<a href="#l17.421"></a><span id="l17.421">         ioService-&gt;GetProtocolHandler(scheme.get(), getter_AddRefs(handler));</span>
<a href="#l17.422"></a><span id="l17.422" class="difflineminus">-        if (!handler)</span>
<a href="#l17.423"></a><span id="l17.423" class="difflineminus">-          continue;</span>
<a href="#l17.424"></a><span id="l17.424" class="difflineminus">-        nsCOMPtr&lt;nsIMsgMessageFetchPartService&gt; mailHandler = do_QueryInterface(handler);</span>
<a href="#l17.425"></a><span id="l17.425" class="difflineminus">-        if (!mailHandler)</span>
<a href="#l17.426"></a><span id="l17.426" class="difflineminus">-          continue;</span>
<a href="#l17.427"></a><span id="l17.427" class="difflineplus">+        if (!handler) continue;</span>
<a href="#l17.428"></a><span id="l17.428" class="difflineplus">+        nsCOMPtr&lt;nsIMsgMessageFetchPartService&gt; mailHandler =</span>
<a href="#l17.429"></a><span id="l17.429" class="difflineplus">+            do_QueryInterface(handler);</span>
<a href="#l17.430"></a><span id="l17.430" class="difflineplus">+        if (!mailHandler) continue;</span>
<a href="#l17.431"></a><span id="l17.431"> </span>
<a href="#l17.432"></a><span id="l17.432">         // the objURL is the full path to the embedded content. We need</span>
<a href="#l17.433"></a><span id="l17.433">         // to update it with uri for the folder we just saved to, and the new</span>
<a href="#l17.434"></a><span id="l17.434">         // msg key.</span>
<a href="#l17.435"></a><span id="l17.435">         int32_t restOfUrlIndex = objURL.Find(&quot;?number=&quot;);</span>
<a href="#l17.436"></a><span id="l17.436">         if (restOfUrlIndex == kNotFound)</span>
<a href="#l17.437"></a><span id="l17.437">           restOfUrlIndex = objURL.FindChar('?');</span>
<a href="#l17.438"></a><span id="l17.438">         else</span>
<a href="#l17.439"></a><span id="l17.439">           restOfUrlIndex = objURL.FindChar('&amp;', restOfUrlIndex);</span>
<a href="#l17.440"></a><span id="l17.440"> </span>
<a href="#l17.441"></a><span id="l17.441" class="difflineminus">-        if (restOfUrlIndex == kNotFound)</span>
<a href="#l17.442"></a><span id="l17.442" class="difflineminus">-          continue;</span>
<a href="#l17.443"></a><span id="l17.443" class="difflineplus">+        if (restOfUrlIndex == kNotFound) continue;</span>
<a href="#l17.444"></a><span id="l17.444"> </span>
<a href="#l17.445"></a><span id="l17.445">         nsCString newURI(baseMsgUri);</span>
<a href="#l17.446"></a><span id="l17.446">         newURI.Append('#');</span>
<a href="#l17.447"></a><span id="l17.447">         newURI.AppendInt(newMsgKey);</span>
<a href="#l17.448"></a><span id="l17.448" class="difflineminus">-        nsString restOfUrl(Substring(objURL, restOfUrlIndex, objURL.Length() - restOfUrlIndex));</span>
<a href="#l17.449"></a><span id="l17.449" class="difflineplus">+        nsString restOfUrl(Substring(objURL, restOfUrlIndex,</span>
<a href="#l17.450"></a><span id="l17.450" class="difflineplus">+                                     objURL.Length() - restOfUrlIndex));</span>
<a href="#l17.451"></a><span id="l17.451">         int32_t partIndex = restOfUrl.Find(&quot;part=&quot;);</span>
<a href="#l17.452"></a><span id="l17.452" class="difflineminus">-        if (partIndex != kNotFound)</span>
<a href="#l17.453"></a><span id="l17.453" class="difflineminus">-        {</span>
<a href="#l17.454"></a><span id="l17.454" class="difflineplus">+        if (partIndex != kNotFound) {</span>
<a href="#l17.455"></a><span id="l17.455">           partIndex += 5;</span>
<a href="#l17.456"></a><span id="l17.456">           int32_t endPart = restOfUrl.FindChar('&amp;', partIndex);</span>
<a href="#l17.457"></a><span id="l17.457" class="difflineminus">-          int32_t existingPartLen = (endPart == kNotFound) ? -1 : endPart - partIndex;</span>
<a href="#l17.458"></a><span id="l17.458" class="difflineminus">-          restOfUrl.Replace(partIndex, existingPartLen, NS_ConvertASCIItoUTF16(partNum));</span>
<a href="#l17.459"></a><span id="l17.459" class="difflineplus">+          int32_t existingPartLen =</span>
<a href="#l17.460"></a><span id="l17.460" class="difflineplus">+              (endPart == kNotFound) ? -1 : endPart - partIndex;</span>
<a href="#l17.461"></a><span id="l17.461" class="difflineplus">+          restOfUrl.Replace(partIndex, existingPartLen,</span>
<a href="#l17.462"></a><span id="l17.462" class="difflineplus">+                            NS_ConvertASCIItoUTF16(partNum));</span>
<a href="#l17.463"></a><span id="l17.463">         }</span>
<a href="#l17.464"></a><span id="l17.464"> </span>
<a href="#l17.465"></a><span id="l17.465">         nsCOMPtr&lt;nsIMsgMessageService&gt; msgService;</span>
<a href="#l17.466"></a><span id="l17.466">         rv = GetMessageServiceFromURI(newURI, getter_AddRefs(msgService));</span>
<a href="#l17.467"></a><span id="l17.467" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l17.468"></a><span id="l17.468" class="difflineminus">-          continue;</span>
<a href="#l17.469"></a><span id="l17.469" class="difflineplus">+        if (NS_FAILED(rv)) continue;</span>
<a href="#l17.470"></a><span id="l17.470">         nsCOMPtr&lt;nsIURI&gt; newUrl;</span>
<a href="#l17.471"></a><span id="l17.471" class="difflineminus">-        rv = msgService-&gt;GetUrlForUri(newURI.get(), getter_AddRefs(newUrl), nullptr);</span>
<a href="#l17.472"></a><span id="l17.472" class="difflineminus">-        if (!newUrl)</span>
<a href="#l17.473"></a><span id="l17.473" class="difflineminus">-          continue;</span>
<a href="#l17.474"></a><span id="l17.474" class="difflineplus">+        rv = msgService-&gt;GetUrlForUri(newURI.get(), getter_AddRefs(newUrl),</span>
<a href="#l17.475"></a><span id="l17.475" class="difflineplus">+                                      nullptr);</span>
<a href="#l17.476"></a><span id="l17.476" class="difflineplus">+        if (!newUrl) continue;</span>
<a href="#l17.477"></a><span id="l17.477">         nsCString spec;</span>
<a href="#l17.478"></a><span id="l17.478">         rv = newUrl-&gt;GetSpec(spec);</span>
<a href="#l17.479"></a><span id="l17.479">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.480"></a><span id="l17.480">         nsString newSrc;</span>
<a href="#l17.481"></a><span id="l17.481">         // mailbox urls will have ?number=xxx; imap urls won't. We need to</span>
<a href="#l17.482"></a><span id="l17.482">         // handle both cases because we may be going from a mailbox url to</span>
<a href="#l17.483"></a><span id="l17.483">         // and imap url, or vice versa, depending on the original folder,</span>
<a href="#l17.484"></a><span id="l17.484">         // and the destination drafts folder.</span>
<a href="#l17.485"></a><span id="l17.485" class="difflineat">@@ -424,105 +405,92 @@ nsresult nsMsgCompose::ResetUrisForEmbed</span>
<a href="#l17.486"></a><span id="l17.486">         image-&gt;SetSrc(newSrc, rv2);</span>
<a href="#l17.487"></a><span id="l17.487">       }</span>
<a href="#l17.488"></a><span id="l17.488">     }</span>
<a href="#l17.489"></a><span id="l17.489">   }</span>
<a href="#l17.490"></a><span id="l17.490"> </span>
<a href="#l17.491"></a><span id="l17.491">   return NS_OK;</span>
<a href="#l17.492"></a><span id="l17.492"> }</span>
<a href="#l17.493"></a><span id="l17.493"> </span>
<a href="#l17.494"></a><span id="l17.494" class="difflineminus">-</span>
<a href="#l17.495"></a><span id="l17.495" class="difflineminus">-/* The purpose of this function is to mark any embedded object that wasn't a RFC822 part</span>
<a href="#l17.496"></a><span id="l17.496" class="difflineminus">-   of the original message as moz-do-not-send.</span>
<a href="#l17.497"></a><span id="l17.497" class="difflineminus">-   That will prevent us to attach data not specified by the user or not present in the</span>
<a href="#l17.498"></a><span id="l17.498" class="difflineminus">-   original message.</span>
<a href="#l17.499"></a><span id="l17.499" class="difflineplus">+/* The purpose of this function is to mark any embedded object that wasn't a</span>
<a href="#l17.500"></a><span id="l17.500" class="difflineplus">+   RFC822 part of the original message as moz-do-not-send. That will prevent us</span>
<a href="#l17.501"></a><span id="l17.501" class="difflineplus">+   to attach data not specified by the user or not present in the original</span>
<a href="#l17.502"></a><span id="l17.502" class="difflineplus">+   message.</span>
<a href="#l17.503"></a><span id="l17.503"> */</span>
<a href="#l17.504"></a><span id="l17.504" class="difflineminus">-nsresult nsMsgCompose::TagEmbeddedObjects(nsIEditor *aEditor)</span>
<a href="#l17.505"></a><span id="l17.505" class="difflineminus">-{</span>
<a href="#l17.506"></a><span id="l17.506" class="difflineplus">+nsresult nsMsgCompose::TagEmbeddedObjects(nsIEditor *aEditor) {</span>
<a href="#l17.507"></a><span id="l17.507">   nsresult rv = NS_OK;</span>
<a href="#l17.508"></a><span id="l17.508">   uint32_t count;</span>
<a href="#l17.509"></a><span id="l17.509">   uint32_t i;</span>
<a href="#l17.510"></a><span id="l17.510"> </span>
<a href="#l17.511"></a><span id="l17.511" class="difflineminus">-  if (!aEditor)</span>
<a href="#l17.512"></a><span id="l17.512" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l17.513"></a><span id="l17.513" class="difflineplus">+  if (!aEditor) return NS_ERROR_FAILURE;</span>
<a href="#l17.514"></a><span id="l17.514"> </span>
<a href="#l17.515"></a><span id="l17.515">   nsCOMPtr&lt;Document&gt; document;</span>
<a href="#l17.516"></a><span id="l17.516">   aEditor-&gt;GetDocument(getter_AddRefs(document));</span>
<a href="#l17.517"></a><span id="l17.517" class="difflineminus">-  if (!document)</span>
<a href="#l17.518"></a><span id="l17.518" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l17.519"></a><span id="l17.519" class="difflineplus">+  if (!document) return NS_ERROR_FAILURE;</span>
<a href="#l17.520"></a><span id="l17.520">   nsCOMPtr&lt;nsIArray&gt; aNodeList = GetEmbeddedObjects(document);</span>
<a href="#l17.521"></a><span id="l17.521" class="difflineminus">-  if (!aNodeList)</span>
<a href="#l17.522"></a><span id="l17.522" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l17.523"></a><span id="l17.523" class="difflineminus">-</span>
<a href="#l17.524"></a><span id="l17.524" class="difflineminus">-  if (NS_FAILED(aNodeList-&gt;GetLength(&amp;count)))</span>
<a href="#l17.525"></a><span id="l17.525" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l17.526"></a><span id="l17.526" class="difflineplus">+  if (!aNodeList) return NS_ERROR_FAILURE;</span>
<a href="#l17.527"></a><span id="l17.527" class="difflineplus">+</span>
<a href="#l17.528"></a><span id="l17.528" class="difflineplus">+  if (NS_FAILED(aNodeList-&gt;GetLength(&amp;count))) return NS_ERROR_FAILURE;</span>
<a href="#l17.529"></a><span id="l17.529"> </span>
<a href="#l17.530"></a><span id="l17.530">   nsCOMPtr&lt;nsIURI&gt; originalUrl;</span>
<a href="#l17.531"></a><span id="l17.531">   nsCString originalScheme;</span>
<a href="#l17.532"></a><span id="l17.532">   nsCString originalHost;</span>
<a href="#l17.533"></a><span id="l17.533">   nsCString originalPath;</span>
<a href="#l17.534"></a><span id="l17.534"> </span>
<a href="#l17.535"></a><span id="l17.535" class="difflineminus">-  // first, convert the rdf original msg uri into a url that represents the message...</span>
<a href="#l17.536"></a><span id="l17.536" class="difflineminus">-  nsCOMPtr &lt;nsIMsgMessageService&gt; msgService;</span>
<a href="#l17.537"></a><span id="l17.537" class="difflineplus">+  // first, convert the rdf original msg uri into a url that represents the</span>
<a href="#l17.538"></a><span id="l17.538" class="difflineplus">+  // message...</span>
<a href="#l17.539"></a><span id="l17.539" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMessageService&gt; msgService;</span>
<a href="#l17.540"></a><span id="l17.540">   rv = GetMessageServiceFromURI(mOriginalMsgURI, getter_AddRefs(msgService));</span>
<a href="#l17.541"></a><span id="l17.541" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l17.542"></a><span id="l17.542" class="difflineminus">-  {</span>
<a href="#l17.543"></a><span id="l17.543" class="difflineminus">-    rv = msgService-&gt;GetUrlForUri(mOriginalMsgURI.get(), getter_AddRefs(originalUrl), nullptr);</span>
<a href="#l17.544"></a><span id="l17.544" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; originalUrl)</span>
<a href="#l17.545"></a><span id="l17.545" class="difflineminus">-    {</span>
<a href="#l17.546"></a><span id="l17.546" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l17.547"></a><span id="l17.547" class="difflineplus">+    rv = msgService-&gt;GetUrlForUri(mOriginalMsgURI.get(),</span>
<a href="#l17.548"></a><span id="l17.548" class="difflineplus">+                                  getter_AddRefs(originalUrl), nullptr);</span>
<a href="#l17.549"></a><span id="l17.549" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; originalUrl) {</span>
<a href="#l17.550"></a><span id="l17.550">       originalUrl-&gt;GetScheme(originalScheme);</span>
<a href="#l17.551"></a><span id="l17.551">       originalUrl-&gt;GetAsciiHost(originalHost);</span>
<a href="#l17.552"></a><span id="l17.552">       originalUrl-&gt;GetPathQueryRef(originalPath);</span>
<a href="#l17.553"></a><span id="l17.553">     }</span>
<a href="#l17.554"></a><span id="l17.554">   }</span>
<a href="#l17.555"></a><span id="l17.555"> </span>
<a href="#l17.556"></a><span id="l17.556">   // Then compare the url of each embedded objects with the original message.</span>
<a href="#l17.557"></a><span id="l17.557">   // If they a not coming from the original message, they should not be sent</span>
<a href="#l17.558"></a><span id="l17.558">   // with the message.</span>
<a href="#l17.559"></a><span id="l17.559" class="difflineminus">-  for (i = 0; i &lt; count; i ++)</span>
<a href="#l17.560"></a><span id="l17.560" class="difflineminus">-  {</span>
<a href="#l17.561"></a><span id="l17.561" class="difflineplus">+  for (i = 0; i &lt; count; i++) {</span>
<a href="#l17.562"></a><span id="l17.562">     nsCOMPtr&lt;Element&gt; domElement = do_QueryElementAt(aNodeList, i);</span>
<a href="#l17.563"></a><span id="l17.563" class="difflineminus">-    if (!domElement)</span>
<a href="#l17.564"></a><span id="l17.564" class="difflineminus">-      continue;</span>
<a href="#l17.565"></a><span id="l17.565" class="difflineplus">+    if (!domElement) continue;</span>
<a href="#l17.566"></a><span id="l17.566">     if (IsEmbeddedObjectSafe(originalScheme.get(), originalHost.get(),</span>
<a href="#l17.567"></a><span id="l17.567">                              originalPath.get(), domElement))</span>
<a href="#l17.568"></a><span id="l17.568" class="difflineminus">-      continue; // Don't need to tag this object, it's safe to send it.</span>
<a href="#l17.569"></a><span id="l17.569" class="difflineplus">+      continue;  // Don't need to tag this object, it's safe to send it.</span>
<a href="#l17.570"></a><span id="l17.570"> </span>
<a href="#l17.571"></a><span id="l17.571">     // The source of this object should not be sent with the message.</span>
<a href="#l17.572"></a><span id="l17.572">     IgnoredErrorResult rv2;</span>
<a href="#l17.573"></a><span id="l17.573">     domElement-&gt;SetAttribute(NS_LITERAL_STRING(&quot;moz-do-not-send&quot;),</span>
<a href="#l17.574"></a><span id="l17.574" class="difflineminus">-                             NS_LITERAL_STRING(&quot;true&quot;),</span>
<a href="#l17.575"></a><span id="l17.575" class="difflineminus">-                             rv2);</span>
<a href="#l17.576"></a><span id="l17.576" class="difflineplus">+                             NS_LITERAL_STRING(&quot;true&quot;), rv2);</span>
<a href="#l17.577"></a><span id="l17.577">   }</span>
<a href="#l17.578"></a><span id="l17.578"> </span>
<a href="#l17.579"></a><span id="l17.579">   return NS_OK;</span>
<a href="#l17.580"></a><span id="l17.580"> }</span>
<a href="#l17.581"></a><span id="l17.581"> </span>
<a href="#l17.582"></a><span id="l17.582"> NS_IMETHODIMP</span>
<a href="#l17.583"></a><span id="l17.583" class="difflineminus">-nsMsgCompose::GetInsertingQuotedContent(bool * aInsertingQuotedText)</span>
<a href="#l17.584"></a><span id="l17.584" class="difflineminus">-{</span>
<a href="#l17.585"></a><span id="l17.585" class="difflineplus">+nsMsgCompose::GetInsertingQuotedContent(bool *aInsertingQuotedText) {</span>
<a href="#l17.586"></a><span id="l17.586">   NS_ENSURE_ARG_POINTER(aInsertingQuotedText);</span>
<a href="#l17.587"></a><span id="l17.587">   *aInsertingQuotedText = mInsertingQuotedContent;</span>
<a href="#l17.588"></a><span id="l17.588">   return NS_OK;</span>
<a href="#l17.589"></a><span id="l17.589"> }</span>
<a href="#l17.590"></a><span id="l17.590"> </span>
<a href="#l17.591"></a><span id="l17.591"> NS_IMETHODIMP</span>
<a href="#l17.592"></a><span id="l17.592" class="difflineminus">-nsMsgCompose::SetInsertingQuotedContent(bool aInsertingQuotedText)</span>
<a href="#l17.593"></a><span id="l17.593" class="difflineminus">-{</span>
<a href="#l17.594"></a><span id="l17.594" class="difflineplus">+nsMsgCompose::SetInsertingQuotedContent(bool aInsertingQuotedText) {</span>
<a href="#l17.595"></a><span id="l17.595">   mInsertingQuotedContent = aInsertingQuotedText;</span>
<a href="#l17.596"></a><span id="l17.596">   return NS_OK;</span>
<a href="#l17.597"></a><span id="l17.597"> }</span>
<a href="#l17.598"></a><span id="l17.598"> </span>
<a href="#l17.599"></a><span id="l17.599" class="difflineminus">-MOZ_CAN_RUN_SCRIPT void</span>
<a href="#l17.600"></a><span id="l17.600" class="difflineminus">-nsMsgCompose::InsertDivWrappedTextAtSelection(const nsAString &amp;aText,</span>
<a href="#l17.601"></a><span id="l17.601" class="difflineminus">-                                              const nsAString &amp;classStr)</span>
<a href="#l17.602"></a><span id="l17.602" class="difflineminus">-{</span>
<a href="#l17.603"></a><span id="l17.603" class="difflineminus">-  NS_ASSERTION(m_editor, &quot;InsertDivWrappedTextAtSelection called, but no editor exists&quot;);</span>
<a href="#l17.604"></a><span id="l17.604" class="difflineminus">-  if (!m_editor)</span>
<a href="#l17.605"></a><span id="l17.605" class="difflineminus">-    return;</span>
<a href="#l17.606"></a><span id="l17.606" class="difflineplus">+MOZ_CAN_RUN_SCRIPT void nsMsgCompose::InsertDivWrappedTextAtSelection(</span>
<a href="#l17.607"></a><span id="l17.607" class="difflineplus">+    const nsAString &amp;aText, const nsAString &amp;classStr) {</span>
<a href="#l17.608"></a><span id="l17.608" class="difflineplus">+  NS_ASSERTION(m_editor,</span>
<a href="#l17.609"></a><span id="l17.609" class="difflineplus">+               &quot;InsertDivWrappedTextAtSelection called, but no editor exists&quot;);</span>
<a href="#l17.610"></a><span id="l17.610" class="difflineplus">+  if (!m_editor) return;</span>
<a href="#l17.611"></a><span id="l17.611"> </span>
<a href="#l17.612"></a><span id="l17.612">   RefPtr&lt;Element&gt; divElem;</span>
<a href="#l17.613"></a><span id="l17.613">   nsCOMPtr&lt;nsIHTMLEditor&gt; htmlEditor(do_QueryInterface(m_editor));</span>
<a href="#l17.614"></a><span id="l17.614"> </span>
<a href="#l17.615"></a><span id="l17.615">   nsresult rv = htmlEditor-&gt;CreateElementWithDefaults(NS_LITERAL_STRING(&quot;div&quot;),</span>
<a href="#l17.616"></a><span id="l17.616">                                                       getter_AddRefs(divElem));</span>
<a href="#l17.617"></a><span id="l17.617"> </span>
<a href="#l17.618"></a><span id="l17.618">   NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l17.619"></a><span id="l17.619" class="difflineat">@@ -532,24 +500,22 @@ nsMsgCompose::InsertDivWrappedTextAtSele</span>
<a href="#l17.620"></a><span id="l17.620">   rv = m_editor-&gt;GetDocument(getter_AddRefs(doc));</span>
<a href="#l17.621"></a><span id="l17.621">   NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l17.622"></a><span id="l17.622"> </span>
<a href="#l17.623"></a><span id="l17.623">   // Break up the text by newlines, and then insert text nodes followed</span>
<a href="#l17.624"></a><span id="l17.624">   // by &lt;br&gt; nodes.</span>
<a href="#l17.625"></a><span id="l17.625">   int32_t start = 0;</span>
<a href="#l17.626"></a><span id="l17.626">   int32_t end = aText.Length();</span>
<a href="#l17.627"></a><span id="l17.627"> </span>
<a href="#l17.628"></a><span id="l17.628" class="difflineminus">-  for (;;)</span>
<a href="#l17.629"></a><span id="l17.629" class="difflineminus">-  {</span>
<a href="#l17.630"></a><span id="l17.630" class="difflineplus">+  for (;;) {</span>
<a href="#l17.631"></a><span id="l17.631">     int32_t delimiter = aText.FindChar('\n', start);</span>
<a href="#l17.632"></a><span id="l17.632" class="difflineminus">-    if (delimiter == kNotFound)</span>
<a href="#l17.633"></a><span id="l17.633" class="difflineminus">-      delimiter = end;</span>
<a href="#l17.634"></a><span id="l17.634" class="difflineplus">+    if (delimiter == kNotFound) delimiter = end;</span>
<a href="#l17.635"></a><span id="l17.635"> </span>
<a href="#l17.636"></a><span id="l17.636">     RefPtr&lt;nsTextNode&gt; textNode =</span>
<a href="#l17.637"></a><span id="l17.637" class="difflineminus">-      doc-&gt;CreateTextNode(Substring(aText, start, delimiter - start));</span>
<a href="#l17.638"></a><span id="l17.638" class="difflineplus">+        doc-&gt;CreateTextNode(Substring(aText, start, delimiter - start));</span>
<a href="#l17.639"></a><span id="l17.639"> </span>
<a href="#l17.640"></a><span id="l17.640">     IgnoredErrorResult rv2;</span>
<a href="#l17.641"></a><span id="l17.641">     divElem-&gt;AppendChild(*textNode, rv2);</span>
<a href="#l17.642"></a><span id="l17.642">     if (rv2.Failed()) {</span>
<a href="#l17.643"></a><span id="l17.643">       return;</span>
<a href="#l17.644"></a><span id="l17.644">     }</span>
<a href="#l17.645"></a><span id="l17.645"> </span>
<a href="#l17.646"></a><span id="l17.646">     // Now create and insert a BR</span>
<a href="#l17.647"></a><span id="l17.647" class="difflineat">@@ -557,123 +523,112 @@ nsMsgCompose::InsertDivWrappedTextAtSele</span>
<a href="#l17.648"></a><span id="l17.648">     rv = htmlEditor-&gt;CreateElementWithDefaults(NS_LITERAL_STRING(&quot;br&quot;),</span>
<a href="#l17.649"></a><span id="l17.649">                                                getter_AddRefs(brElem));</span>
<a href="#l17.650"></a><span id="l17.650">     NS_ENSURE_SUCCESS_VOID(rv);</span>
<a href="#l17.651"></a><span id="l17.651">     divElem-&gt;AppendChild(*brElem, rv2);</span>
<a href="#l17.652"></a><span id="l17.652">     if (rv2.Failed()) {</span>
<a href="#l17.653"></a><span id="l17.653">       return;</span>
<a href="#l17.654"></a><span id="l17.654">     }</span>
<a href="#l17.655"></a><span id="l17.655"> </span>
<a href="#l17.656"></a><span id="l17.656" class="difflineminus">-    if (delimiter == end)</span>
<a href="#l17.657"></a><span id="l17.657" class="difflineminus">-      break;</span>
<a href="#l17.658"></a><span id="l17.658" class="difflineplus">+    if (delimiter == end) break;</span>
<a href="#l17.659"></a><span id="l17.659">     start = ++delimiter;</span>
<a href="#l17.660"></a><span id="l17.660" class="difflineminus">-    if (start == end)</span>
<a href="#l17.661"></a><span id="l17.661" class="difflineminus">-      break;</span>
<a href="#l17.662"></a><span id="l17.662" class="difflineplus">+    if (start == end) break;</span>
<a href="#l17.663"></a><span id="l17.663">   }</span>
<a href="#l17.664"></a><span id="l17.664"> </span>
<a href="#l17.665"></a><span id="l17.665">   htmlEditor-&gt;InsertElementAtSelection(divElem, true);</span>
<a href="#l17.666"></a><span id="l17.666">   nsCOMPtr&lt;nsINode&gt; parent;</span>
<a href="#l17.667"></a><span id="l17.667">   int32_t offset;</span>
<a href="#l17.668"></a><span id="l17.668"> </span>
<a href="#l17.669"></a><span id="l17.669">   rv = GetNodeLocation(divElem, address_of(parent), &amp;offset);</span>
<a href="#l17.670"></a><span id="l17.670" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l17.671"></a><span id="l17.671" class="difflineminus">-  {</span>
<a href="#l17.672"></a><span id="l17.672" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l17.673"></a><span id="l17.673">     RefPtr&lt;Selection&gt; selection;</span>
<a href="#l17.674"></a><span id="l17.674">     m_editor-&gt;GetSelection(getter_AddRefs(selection));</span>
<a href="#l17.675"></a><span id="l17.675"> </span>
<a href="#l17.676"></a><span id="l17.676" class="difflineminus">-    if (selection)</span>
<a href="#l17.677"></a><span id="l17.677" class="difflineminus">-      selection-&gt;Collapse(parent, offset + 1);</span>
<a href="#l17.678"></a><span id="l17.678" class="difflineplus">+    if (selection) selection-&gt;Collapse(parent, offset + 1);</span>
<a href="#l17.679"></a><span id="l17.679">   }</span>
<a href="#l17.680"></a><span id="l17.680">   if (divElem) {</span>
<a href="#l17.681"></a><span id="l17.681">     RefPtr&lt;Element&gt; divElem2 = divElem;</span>
<a href="#l17.682"></a><span id="l17.682">     IgnoredErrorResult rv2;</span>
<a href="#l17.683"></a><span id="l17.683">     divElem2-&gt;SetAttribute(NS_LITERAL_STRING(&quot;class&quot;), classStr, rv2);</span>
<a href="#l17.684"></a><span id="l17.684">   }</span>
<a href="#l17.685"></a><span id="l17.685"> }</span>
<a href="#l17.686"></a><span id="l17.686"> </span>
<a href="#l17.687"></a><span id="l17.687"> /*</span>
<a href="#l17.688"></a><span id="l17.688">  * The following function replaces &lt;plaintext&gt; tags with &lt;x-plaintext&gt;.</span>
<a href="#l17.689"></a><span id="l17.689">  * &lt;plaintext&gt; is a funny beast: It leads to everything following it</span>
<a href="#l17.690"></a><span id="l17.690">  * being displayed verbatim, even a &lt;/plaintext&gt; tag is ignored.</span>
<a href="#l17.691"></a><span id="l17.691">  */</span>
<a href="#l17.692"></a><span id="l17.692" class="difflineminus">-static void</span>
<a href="#l17.693"></a><span id="l17.693" class="difflineminus">-remove_plaintext_tag(nsString &amp;body)</span>
<a href="#l17.694"></a><span id="l17.694" class="difflineminus">-{</span>
<a href="#l17.695"></a><span id="l17.695" class="difflineplus">+static void remove_plaintext_tag(nsString &amp;body) {</span>
<a href="#l17.696"></a><span id="l17.696">   // Replace all &lt;plaintext&gt; and &lt;/plaintext&gt; tags.</span>
<a href="#l17.697"></a><span id="l17.697">   int32_t index = 0;</span>
<a href="#l17.698"></a><span id="l17.698">   bool replaced = false;</span>
<a href="#l17.699"></a><span id="l17.699" class="difflineminus">-  while ((index = body.Find(&quot;&lt;plaintext&quot;, /* ignoreCase = */ true, index)) != kNotFound) {</span>
<a href="#l17.700"></a><span id="l17.700" class="difflineminus">-    body.Insert(u&quot;x-&quot;, index+1);</span>
<a href="#l17.701"></a><span id="l17.701" class="difflineplus">+  while ((index = body.Find(&quot;&lt;plaintext&quot;, /* ignoreCase = */ true, index)) !=</span>
<a href="#l17.702"></a><span id="l17.702" class="difflineplus">+         kNotFound) {</span>
<a href="#l17.703"></a><span id="l17.703" class="difflineplus">+    body.Insert(u&quot;x-&quot;, index + 1);</span>
<a href="#l17.704"></a><span id="l17.704">     index += 12;</span>
<a href="#l17.705"></a><span id="l17.705">     replaced = true;</span>
<a href="#l17.706"></a><span id="l17.706">   }</span>
<a href="#l17.707"></a><span id="l17.707">   if (replaced) {</span>
<a href="#l17.708"></a><span id="l17.708">     index = 0;</span>
<a href="#l17.709"></a><span id="l17.709" class="difflineminus">-    while ((index = body.Find(&quot;&lt;/plaintext&quot;, /* ignoreCase = */ true, index)) != kNotFound) {</span>
<a href="#l17.710"></a><span id="l17.710" class="difflineminus">-      body.Insert(u&quot;x-&quot;, index+2);</span>
<a href="#l17.711"></a><span id="l17.711" class="difflineplus">+    while ((index = body.Find(&quot;&lt;/plaintext&quot;, /* ignoreCase = */ true, index)) !=</span>
<a href="#l17.712"></a><span id="l17.712" class="difflineplus">+           kNotFound) {</span>
<a href="#l17.713"></a><span id="l17.713" class="difflineplus">+      body.Insert(u&quot;x-&quot;, index + 2);</span>
<a href="#l17.714"></a><span id="l17.714">       index += 13;</span>
<a href="#l17.715"></a><span id="l17.715">     }</span>
<a href="#l17.716"></a><span id="l17.716">   }</span>
<a href="#l17.717"></a><span id="l17.717"> }</span>
<a href="#l17.718"></a><span id="l17.718"> </span>
<a href="#l17.719"></a><span id="l17.719"> MOZ_CAN_RUN_SCRIPT_BOUNDARY NS_IMETHODIMP</span>
<a href="#l17.720"></a><span id="l17.720" class="difflineminus">-nsMsgCompose::ConvertAndLoadComposeWindow(nsString&amp; aPrefix,</span>
<a href="#l17.721"></a><span id="l17.721" class="difflineminus">-                                          nsString&amp; aBuf,</span>
<a href="#l17.722"></a><span id="l17.722" class="difflineminus">-                                          nsString&amp; aSignature,</span>
<a href="#l17.723"></a><span id="l17.723" class="difflineminus">-                                          bool aQuoted,</span>
<a href="#l17.724"></a><span id="l17.724" class="difflineminus">-                                          bool aHTMLEditor)</span>
<a href="#l17.725"></a><span id="l17.725" class="difflineminus">-{</span>
<a href="#l17.726"></a><span id="l17.726" class="difflineplus">+nsMsgCompose::ConvertAndLoadComposeWindow(nsString &amp;aPrefix, nsString &amp;aBuf,</span>
<a href="#l17.727"></a><span id="l17.727" class="difflineplus">+                                          nsString &amp;aSignature, bool aQuoted,</span>
<a href="#l17.728"></a><span id="l17.728" class="difflineplus">+                                          bool aHTMLEditor) {</span>
<a href="#l17.729"></a><span id="l17.729">   NS_ASSERTION(m_editor, &quot;ConvertAndLoadComposeWindow but no editor&quot;);</span>
<a href="#l17.730"></a><span id="l17.730">   NS_ENSURE_TRUE(m_editor &amp;&amp; m_identity, NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l17.731"></a><span id="l17.731"> </span>
<a href="#l17.732"></a><span id="l17.732">   // First, get the nsIEditor interface for future use</span>
<a href="#l17.733"></a><span id="l17.733">   nsCOMPtr&lt;nsINode&gt; nodeInserted;</span>
<a href="#l17.734"></a><span id="l17.734"> </span>
<a href="#l17.735"></a><span id="l17.735">   TranslateLineEnding(aPrefix);</span>
<a href="#l17.736"></a><span id="l17.736">   TranslateLineEnding(aBuf);</span>
<a href="#l17.737"></a><span id="l17.737">   TranslateLineEnding(aSignature);</span>
<a href="#l17.738"></a><span id="l17.738"> </span>
<a href="#l17.739"></a><span id="l17.739">   m_editor-&gt;EnableUndo(false);</span>
<a href="#l17.740"></a><span id="l17.740"> </span>
<a href="#l17.741"></a><span id="l17.741">   // Ok - now we need to figure out the charset of the aBuf we are going to send</span>
<a href="#l17.742"></a><span id="l17.742" class="difflineminus">-  // into the editor shell. There are I18N calls to sniff the data and then we need</span>
<a href="#l17.743"></a><span id="l17.743" class="difflineminus">-  // to call the new routine in the editor that will allow us to send in the charset</span>
<a href="#l17.744"></a><span id="l17.744" class="difflineplus">+  // into the editor shell. There are I18N calls to sniff the data and then we</span>
<a href="#l17.745"></a><span id="l17.745" class="difflineplus">+  // need to call the new routine in the editor that will allow us to send in</span>
<a href="#l17.746"></a><span id="l17.746" class="difflineplus">+  // the charset</span>
<a href="#l17.747"></a><span id="l17.747">   //</span>
<a href="#l17.748"></a><span id="l17.748"> </span>
<a href="#l17.749"></a><span id="l17.749">   // Now, insert it into the editor...</span>
<a href="#l17.750"></a><span id="l17.750">   RefPtr&lt;HTMLEditor&gt; htmlEditor = m_editor-&gt;AsHTMLEditor();</span>
<a href="#l17.751"></a><span id="l17.751" class="difflineminus">-  nsCOMPtr&lt;nsIPlaintextEditor&gt; textEditor (do_QueryInterface(m_editor));</span>
<a href="#l17.752"></a><span id="l17.752" class="difflineplus">+  nsCOMPtr&lt;nsIPlaintextEditor&gt; textEditor(do_QueryInterface(m_editor));</span>
<a href="#l17.753"></a><span id="l17.753">   int32_t reply_on_top = 0;</span>
<a href="#l17.754"></a><span id="l17.754">   bool sig_bottom = true;</span>
<a href="#l17.755"></a><span id="l17.755">   m_identity-&gt;GetReplyOnTop(&amp;reply_on_top);</span>
<a href="#l17.756"></a><span id="l17.756">   m_identity-&gt;GetSigBottom(&amp;sig_bottom);</span>
<a href="#l17.757"></a><span id="l17.757">   bool sigOnTop = (reply_on_top == 1 &amp;&amp; !sig_bottom);</span>
<a href="#l17.758"></a><span id="l17.758">   bool isForwarded = (mType == nsIMsgCompType::ForwardInline);</span>
<a href="#l17.759"></a><span id="l17.759"> </span>
<a href="#l17.760"></a><span id="l17.760">   // When in paragraph mode, don't call InsertLineBreak() since that inserts</span>
<a href="#l17.761"></a><span id="l17.761">   // a full paragraph instead of just a line break since we switched</span>
<a href="#l17.762"></a><span id="l17.762">   // the default paragraph separator to &quot;p&quot;.</span>
<a href="#l17.763"></a><span id="l17.763">   bool paragraphMode =</span>
<a href="#l17.764"></a><span id="l17.764" class="difflineminus">-    mozilla::Preferences::GetBool(&quot;mail.compose.default_to_paragraph&quot;, false);</span>
<a href="#l17.765"></a><span id="l17.765" class="difflineminus">-</span>
<a href="#l17.766"></a><span id="l17.766" class="difflineminus">-  if (aQuoted)</span>
<a href="#l17.767"></a><span id="l17.767" class="difflineminus">-  {</span>
<a href="#l17.768"></a><span id="l17.768" class="difflineplus">+      mozilla::Preferences::GetBool(&quot;mail.compose.default_to_paragraph&quot;, false);</span>
<a href="#l17.769"></a><span id="l17.769" class="difflineplus">+</span>
<a href="#l17.770"></a><span id="l17.770" class="difflineplus">+  if (aQuoted) {</span>
<a href="#l17.771"></a><span id="l17.771">     mInsertingQuotedContent = true;</span>
<a href="#l17.772"></a><span id="l17.772" class="difflineminus">-    if (!aPrefix.IsEmpty())</span>
<a href="#l17.773"></a><span id="l17.773" class="difflineminus">-    {</span>
<a href="#l17.774"></a><span id="l17.774" class="difflineminus">-      if (!aHTMLEditor)</span>
<a href="#l17.775"></a><span id="l17.775" class="difflineminus">-        aPrefix.AppendLiteral(&quot;\n&quot;);</span>
<a href="#l17.776"></a><span id="l17.776" class="difflineplus">+    if (!aPrefix.IsEmpty()) {</span>
<a href="#l17.777"></a><span id="l17.777" class="difflineplus">+      if (!aHTMLEditor) aPrefix.AppendLiteral(&quot;\n&quot;);</span>
<a href="#l17.778"></a><span id="l17.778"> </span>
<a href="#l17.779"></a><span id="l17.779">       int32_t reply_on_top = 0;</span>
<a href="#l17.780"></a><span id="l17.780">       m_identity-&gt;GetReplyOnTop(&amp;reply_on_top);</span>
<a href="#l17.781"></a><span id="l17.781" class="difflineminus">-      if (reply_on_top == 1)</span>
<a href="#l17.782"></a><span id="l17.782" class="difflineminus">-      {</span>
<a href="#l17.783"></a><span id="l17.783" class="difflineplus">+      if (reply_on_top == 1) {</span>
<a href="#l17.784"></a><span id="l17.784">         // HTML editor eats one line break but not a whole paragraph.</span>
<a href="#l17.785"></a><span id="l17.785" class="difflineminus">-        if (aHTMLEditor &amp;&amp; !paragraphMode)</span>
<a href="#l17.786"></a><span id="l17.786" class="difflineminus">-          textEditor-&gt;InsertLineBreak();</span>
<a href="#l17.787"></a><span id="l17.787" class="difflineplus">+        if (aHTMLEditor &amp;&amp; !paragraphMode) textEditor-&gt;InsertLineBreak();</span>
<a href="#l17.788"></a><span id="l17.788"> </span>
<a href="#l17.789"></a><span id="l17.789">         // add one newline if a signature comes before the quote, two otherwise</span>
<a href="#l17.790"></a><span id="l17.790">         bool includeSignature = true;</span>
<a href="#l17.791"></a><span id="l17.791">         bool sig_bottom = true;</span>
<a href="#l17.792"></a><span id="l17.792">         bool attachFile = false;</span>
<a href="#l17.793"></a><span id="l17.793">         nsString prefSigText;</span>
<a href="#l17.794"></a><span id="l17.794"> </span>
<a href="#l17.795"></a><span id="l17.795">         m_identity-&gt;GetSigOnReply(&amp;includeSignature);</span>
<a href="#l17.796"></a><span id="l17.796" class="difflineat">@@ -690,118 +645,103 @@ nsMsgCompose::ConvertAndLoadComposeWindo</span>
<a href="#l17.797"></a><span id="l17.797">           }</span>
<a href="#l17.798"></a><span id="l17.798">         }</span>
<a href="#l17.799"></a><span id="l17.799">       }</span>
<a href="#l17.800"></a><span id="l17.800"> </span>
<a href="#l17.801"></a><span id="l17.801">       InsertDivWrappedTextAtSelection(aPrefix,</span>
<a href="#l17.802"></a><span id="l17.802">                                       NS_LITERAL_STRING(&quot;moz-cite-prefix&quot;));</span>
<a href="#l17.803"></a><span id="l17.803">     }</span>
<a href="#l17.804"></a><span id="l17.804"> </span>
<a href="#l17.805"></a><span id="l17.805" class="difflineminus">-    if (!aBuf.IsEmpty())</span>
<a href="#l17.806"></a><span id="l17.806" class="difflineminus">-    {</span>
<a href="#l17.807"></a><span id="l17.807" class="difflineplus">+    if (!aBuf.IsEmpty()) {</span>
<a href="#l17.808"></a><span id="l17.808">       // This leaves the caret at the right place to insert a bottom signature.</span>
<a href="#l17.809"></a><span id="l17.809">       if (aHTMLEditor) {</span>
<a href="#l17.810"></a><span id="l17.810">         nsAutoString body(aBuf);</span>
<a href="#l17.811"></a><span id="l17.811">         remove_plaintext_tag(body);</span>
<a href="#l17.812"></a><span id="l17.812" class="difflineminus">-        htmlEditor-&gt;InsertAsCitedQuotation(body,</span>
<a href="#l17.813"></a><span id="l17.813" class="difflineminus">-                                           mCiteReference,</span>
<a href="#l17.814"></a><span id="l17.814" class="difflineminus">-                                           true,</span>
<a href="#l17.815"></a><span id="l17.815" class="difflineplus">+        htmlEditor-&gt;InsertAsCitedQuotation(body, mCiteReference, true,</span>
<a href="#l17.816"></a><span id="l17.816">                                            getter_AddRefs(nodeInserted));</span>
<a href="#l17.817"></a><span id="l17.817">       } else {</span>
<a href="#l17.818"></a><span id="l17.818" class="difflineminus">-        htmlEditor-&gt;InsertAsQuotation(aBuf,</span>
<a href="#l17.819"></a><span id="l17.819" class="difflineminus">-                                      getter_AddRefs(nodeInserted));</span>
<a href="#l17.820"></a><span id="l17.820" class="difflineplus">+        htmlEditor-&gt;InsertAsQuotation(aBuf, getter_AddRefs(nodeInserted));</span>
<a href="#l17.821"></a><span id="l17.821">       }</span>
<a href="#l17.822"></a><span id="l17.822">     }</span>
<a href="#l17.823"></a><span id="l17.823"> </span>
<a href="#l17.824"></a><span id="l17.824">     mInsertingQuotedContent = false;</span>
<a href="#l17.825"></a><span id="l17.825"> </span>
<a href="#l17.826"></a><span id="l17.826">     (void)TagEmbeddedObjects(m_editor);</span>
<a href="#l17.827"></a><span id="l17.827"> </span>
<a href="#l17.828"></a><span id="l17.828" class="difflineminus">-    if (!aSignature.IsEmpty())</span>
<a href="#l17.829"></a><span id="l17.829" class="difflineminus">-    {</span>
<a href="#l17.830"></a><span id="l17.830" class="difflineminus">-      //we cannot add it on top earlier, because TagEmbeddedObjects will mark all images in the signature as &quot;moz-do-not-send&quot;</span>
<a href="#l17.831"></a><span id="l17.831" class="difflineminus">-      if( sigOnTop )</span>
<a href="#l17.832"></a><span id="l17.832" class="difflineminus">-        MoveToBeginningOfDocument();</span>
<a href="#l17.833"></a><span id="l17.833" class="difflineplus">+    if (!aSignature.IsEmpty()) {</span>
<a href="#l17.834"></a><span id="l17.834" class="difflineplus">+      // we cannot add it on top earlier, because TagEmbeddedObjects will mark</span>
<a href="#l17.835"></a><span id="l17.835" class="difflineplus">+      // all images in the signature as &quot;moz-do-not-send&quot;</span>
<a href="#l17.836"></a><span id="l17.836" class="difflineplus">+      if (sigOnTop) MoveToBeginningOfDocument();</span>
<a href="#l17.837"></a><span id="l17.837"> </span>
<a href="#l17.838"></a><span id="l17.838">       if (aHTMLEditor)</span>
<a href="#l17.839"></a><span id="l17.839">         htmlEditor-&gt;InsertHTML(aSignature);</span>
<a href="#l17.840"></a><span id="l17.840" class="difflineminus">-      else</span>
<a href="#l17.841"></a><span id="l17.841" class="difflineminus">-      {</span>
<a href="#l17.842"></a><span id="l17.842" class="difflineplus">+      else {</span>
<a href="#l17.843"></a><span id="l17.843">         textEditor-&gt;InsertLineBreak();</span>
<a href="#l17.844"></a><span id="l17.844">         InsertDivWrappedTextAtSelection(aSignature,</span>
<a href="#l17.845"></a><span id="l17.845">                                         NS_LITERAL_STRING(&quot;moz-signature&quot;));</span>
<a href="#l17.846"></a><span id="l17.846">       }</span>
<a href="#l17.847"></a><span id="l17.847"> </span>
<a href="#l17.848"></a><span id="l17.848" class="difflineminus">-      if( sigOnTop )</span>
<a href="#l17.849"></a><span id="l17.849" class="difflineminus">-        m_editor-&gt;EndOfDocument();</span>
<a href="#l17.850"></a><span id="l17.850" class="difflineplus">+      if (sigOnTop) m_editor-&gt;EndOfDocument();</span>
<a href="#l17.851"></a><span id="l17.851">     }</span>
<a href="#l17.852"></a><span id="l17.852" class="difflineminus">-  }</span>
<a href="#l17.853"></a><span id="l17.853" class="difflineminus">-  else</span>
<a href="#l17.854"></a><span id="l17.854" class="difflineminus">-  {</span>
<a href="#l17.855"></a><span id="l17.855" class="difflineminus">-    if (aHTMLEditor)</span>
<a href="#l17.856"></a><span id="l17.856" class="difflineminus">-    {</span>
<a href="#l17.857"></a><span id="l17.857" class="difflineplus">+  } else {</span>
<a href="#l17.858"></a><span id="l17.858" class="difflineplus">+    if (aHTMLEditor) {</span>
<a href="#l17.859"></a><span id="l17.859">       mInsertingQuotedContent = true;</span>
<a href="#l17.860"></a><span id="l17.860" class="difflineminus">-      if (isForwarded &amp;&amp; Substring(aBuf, 0, sizeof(MIME_FORWARD_HTML_PREFIX)-1)</span>
<a href="#l17.861"></a><span id="l17.861" class="difflineminus">-                         .EqualsLiteral(MIME_FORWARD_HTML_PREFIX)) {</span>
<a href="#l17.862"></a><span id="l17.862" class="difflineplus">+      if (isForwarded &amp;&amp;</span>
<a href="#l17.863"></a><span id="l17.863" class="difflineplus">+          Substring(aBuf, 0, sizeof(MIME_FORWARD_HTML_PREFIX) - 1)</span>
<a href="#l17.864"></a><span id="l17.864" class="difflineplus">+              .EqualsLiteral(MIME_FORWARD_HTML_PREFIX)) {</span>
<a href="#l17.865"></a><span id="l17.865">         // We assign the opening tag inside &quot;&lt;HTML&gt;&lt;BODY&gt;&lt;BR&gt;&lt;BR&gt;&quot; before the</span>
<a href="#l17.866"></a><span id="l17.866">         // two &lt;br&gt; elements.</span>
<a href="#l17.867"></a><span id="l17.867">         // This is a bit hacky but we know that the MIME code prepares the</span>
<a href="#l17.868"></a><span id="l17.868">         // forwarded content like this:</span>
<a href="#l17.869"></a><span id="l17.869">         // &lt;HTML&gt;&lt;BODY&gt;&lt;BR&gt;&lt;BR&gt; + forwarded header + header table.</span>
<a href="#l17.870"></a><span id="l17.870">         // Note: We only do this when we prepare the message to be forwarded,</span>
<a href="#l17.871"></a><span id="l17.871">         // a re-opened saved draft of a forwarded message does not repeat this.</span>
<a href="#l17.872"></a><span id="l17.872">         nsString newBody(aBuf);</span>
<a href="#l17.873"></a><span id="l17.873">         nsString divTag;</span>
<a href="#l17.874"></a><span id="l17.874">         divTag.AssignLiteral(&quot;&lt;div class=\&quot;moz-forward-container\&quot;&gt;&quot;);</span>
<a href="#l17.875"></a><span id="l17.875" class="difflineminus">-        newBody.Insert(divTag, sizeof(MIME_FORWARD_HTML_PREFIX)-1-8);</span>
<a href="#l17.876"></a><span id="l17.876" class="difflineplus">+        newBody.Insert(divTag, sizeof(MIME_FORWARD_HTML_PREFIX) - 1 - 8);</span>
<a href="#l17.877"></a><span id="l17.877">         remove_plaintext_tag(newBody);</span>
<a href="#l17.878"></a><span id="l17.878">         htmlEditor-&gt;RebuildDocumentFromSource(newBody);</span>
<a href="#l17.879"></a><span id="l17.879">       } else {</span>
<a href="#l17.880"></a><span id="l17.880">         htmlEditor-&gt;RebuildDocumentFromSource(aBuf);</span>
<a href="#l17.881"></a><span id="l17.881">       }</span>
<a href="#l17.882"></a><span id="l17.882">       mInsertingQuotedContent = false;</span>
<a href="#l17.883"></a><span id="l17.883"> </span>
<a href="#l17.884"></a><span id="l17.884">       // When forwarding a message as inline, or editing as new (which could</span>
<a href="#l17.885"></a><span id="l17.885">       // contain unsanitized remote content), tag any embedded objects</span>
<a href="#l17.886"></a><span id="l17.886">       // with moz-do-not-send=true so they don't get attached upon send.</span>
<a href="#l17.887"></a><span id="l17.887">       if (isForwarded || mType == nsIMsgCompType::EditAsNew)</span>
<a href="#l17.888"></a><span id="l17.888">         (void)TagEmbeddedObjects(m_editor);</span>
<a href="#l17.889"></a><span id="l17.889"> </span>
<a href="#l17.890"></a><span id="l17.890" class="difflineminus">-      if (!aSignature.IsEmpty())</span>
<a href="#l17.891"></a><span id="l17.891" class="difflineminus">-      {</span>
<a href="#l17.892"></a><span id="l17.892" class="difflineplus">+      if (!aSignature.IsEmpty()) {</span>
<a href="#l17.893"></a><span id="l17.893">         if (isForwarded &amp;&amp; sigOnTop) {</span>
<a href="#l17.894"></a><span id="l17.894" class="difflineminus">-          // Use our own function, nsEditor::BeginningOfDocument() would position</span>
<a href="#l17.895"></a><span id="l17.895" class="difflineminus">-          // into the &lt;div class=&quot;moz-forward-container&quot;&gt; we've just created.</span>
<a href="#l17.896"></a><span id="l17.896" class="difflineplus">+          // Use our own function, nsEditor::BeginningOfDocument() would</span>
<a href="#l17.897"></a><span id="l17.897" class="difflineplus">+          // position into the &lt;div class=&quot;moz-forward-container&quot;&gt; we've just</span>
<a href="#l17.898"></a><span id="l17.898" class="difflineplus">+          // created.</span>
<a href="#l17.899"></a><span id="l17.899">           MoveToBeginningOfDocument();</span>
<a href="#l17.900"></a><span id="l17.900">         } else {</span>
<a href="#l17.901"></a><span id="l17.901">           // Use our own function, nsEditor::EndOfDocument() would position</span>
<a href="#l17.902"></a><span id="l17.902">           // into the &lt;div class=&quot;moz-forward-container&quot;&gt; we've just created.</span>
<a href="#l17.903"></a><span id="l17.903">           MoveToEndOfDocument();</span>
<a href="#l17.904"></a><span id="l17.904">         }</span>
<a href="#l17.905"></a><span id="l17.905">         htmlEditor-&gt;InsertHTML(aSignature);</span>
<a href="#l17.906"></a><span id="l17.906" class="difflineminus">-        if (isForwarded &amp;&amp; sigOnTop)</span>
<a href="#l17.907"></a><span id="l17.907" class="difflineminus">-          m_editor-&gt;EndOfDocument();</span>
<a href="#l17.908"></a><span id="l17.908" class="difflineminus">-      }</span>
<a href="#l17.909"></a><span id="l17.909" class="difflineminus">-      else</span>
<a href="#l17.910"></a><span id="l17.910" class="difflineplus">+        if (isForwarded &amp;&amp; sigOnTop) m_editor-&gt;EndOfDocument();</span>
<a href="#l17.911"></a><span id="l17.911" class="difflineplus">+      } else</span>
<a href="#l17.912"></a><span id="l17.912">         m_editor-&gt;EndOfDocument();</span>
<a href="#l17.913"></a><span id="l17.913" class="difflineminus">-    }</span>
<a href="#l17.914"></a><span id="l17.914" class="difflineminus">-    else</span>
<a href="#l17.915"></a><span id="l17.915" class="difflineminus">-    {</span>
<a href="#l17.916"></a><span id="l17.916" class="difflineplus">+    } else {</span>
<a href="#l17.917"></a><span id="l17.917">       bool sigOnTopInserted = false;</span>
<a href="#l17.918"></a><span id="l17.918" class="difflineminus">-      if (isForwarded &amp;&amp; sigOnTop &amp;&amp; !aSignature.IsEmpty())</span>
<a href="#l17.919"></a><span id="l17.919" class="difflineminus">-      {</span>
<a href="#l17.920"></a><span id="l17.920" class="difflineplus">+      if (isForwarded &amp;&amp; sigOnTop &amp;&amp; !aSignature.IsEmpty()) {</span>
<a href="#l17.921"></a><span id="l17.921">         textEditor-&gt;InsertLineBreak();</span>
<a href="#l17.922"></a><span id="l17.922">         InsertDivWrappedTextAtSelection(aSignature,</span>
<a href="#l17.923"></a><span id="l17.923">                                         NS_LITERAL_STRING(&quot;moz-signature&quot;));</span>
<a href="#l17.924"></a><span id="l17.924">         m_editor-&gt;EndOfDocument();</span>
<a href="#l17.925"></a><span id="l17.925">         sigOnTopInserted = true;</span>
<a href="#l17.926"></a><span id="l17.926">       }</span>
<a href="#l17.927"></a><span id="l17.927"> </span>
<a href="#l17.928"></a><span id="l17.928" class="difflineminus">-      if (!aBuf.IsEmpty())</span>
<a href="#l17.929"></a><span id="l17.929" class="difflineminus">-      {</span>
<a href="#l17.930"></a><span id="l17.930" class="difflineplus">+      if (!aBuf.IsEmpty()) {</span>
<a href="#l17.931"></a><span id="l17.931">         nsresult rv;</span>
<a href="#l17.932"></a><span id="l17.932">         RefPtr&lt;Element&gt; divElem;</span>
<a href="#l17.933"></a><span id="l17.933">         RefPtr&lt;Element&gt; extraBr;</span>
<a href="#l17.934"></a><span id="l17.934"> </span>
<a href="#l17.935"></a><span id="l17.935">         if (isForwarded) {</span>
<a href="#l17.936"></a><span id="l17.936">           // Special treatment for forwarded messages: Part 1.</span>
<a href="#l17.937"></a><span id="l17.937">           // Create a &lt;div&gt; of the required class.</span>
<a href="#l17.938"></a><span id="l17.938">           rv = htmlEditor-&gt;CreateElementWithDefaults(NS_LITERAL_STRING(&quot;div&quot;),</span>
<a href="#l17.939"></a><span id="l17.939" class="difflineat">@@ -839,18 +779,18 @@ nsMsgCompose::ConvertAndLoadComposeWindo</span>
<a href="#l17.940"></a><span id="l17.940"> </span>
<a href="#l17.941"></a><span id="l17.941">         rv = htmlEditor-&gt;InsertTextWithQuotations(aBuf);</span>
<a href="#l17.942"></a><span id="l17.942">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.943"></a><span id="l17.943"> </span>
<a href="#l17.944"></a><span id="l17.944">         if (isForwarded) {</span>
<a href="#l17.945"></a><span id="l17.945">           nsCOMPtr&lt;nsIEditor&gt; editor(m_editor);  // Strong reference.</span>
<a href="#l17.946"></a><span id="l17.946">           // Special treatment for forwarded messages: Part 2.</span>
<a href="#l17.947"></a><span id="l17.947">           if (sigOnTopInserted) {</span>
<a href="#l17.948"></a><span id="l17.948" class="difflineminus">-            // Sadly the M-C editor inserts a &lt;br&gt; between the &lt;div&gt; for the signature</span>
<a href="#l17.949"></a><span id="l17.949" class="difflineminus">-            // and this &lt;div&gt;, so remove the &lt;br&gt; we don't want.</span>
<a href="#l17.950"></a><span id="l17.950" class="difflineplus">+            // Sadly the M-C editor inserts a &lt;br&gt; between the &lt;div&gt; for the</span>
<a href="#l17.951"></a><span id="l17.951" class="difflineplus">+            // signature and this &lt;div&gt;, so remove the &lt;br&gt; we don't want.</span>
<a href="#l17.952"></a><span id="l17.952">             nsCOMPtr&lt;nsINode&gt; brBeforeDiv;</span>
<a href="#l17.953"></a><span id="l17.953">             nsAutoString tagLocalName;</span>
<a href="#l17.954"></a><span id="l17.954">             brBeforeDiv = divElem-&gt;GetPreviousSibling();</span>
<a href="#l17.955"></a><span id="l17.955">             if (brBeforeDiv) {</span>
<a href="#l17.956"></a><span id="l17.956">               tagLocalName = brBeforeDiv-&gt;LocalName();</span>
<a href="#l17.957"></a><span id="l17.957">               if (tagLocalName.EqualsLiteral(&quot;br&quot;)) {</span>
<a href="#l17.958"></a><span id="l17.958">                 rv = editor-&gt;DeleteNode(brBeforeDiv);</span>
<a href="#l17.959"></a><span id="l17.959">                 NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.960"></a><span id="l17.960" class="difflineat">@@ -876,147 +816,135 @@ nsMsgCompose::ConvertAndLoadComposeWindo</span>
<a href="#l17.961"></a><span id="l17.961">         InsertDivWrappedTextAtSelection(aSignature,</span>
<a href="#l17.962"></a><span id="l17.962">                                         NS_LITERAL_STRING(&quot;moz-signature&quot;));</span>
<a href="#l17.963"></a><span id="l17.963">       }</span>
<a href="#l17.964"></a><span id="l17.964">     }</span>
<a href="#l17.965"></a><span id="l17.965">   }</span>
<a href="#l17.966"></a><span id="l17.966"> </span>
<a href="#l17.967"></a><span id="l17.967">   if (aBuf.IsEmpty())</span>
<a href="#l17.968"></a><span id="l17.968">     m_editor-&gt;BeginningOfDocument();</span>
<a href="#l17.969"></a><span id="l17.969" class="difflineminus">-  else</span>
<a href="#l17.970"></a><span id="l17.970" class="difflineminus">-  {</span>
<a href="#l17.971"></a><span id="l17.971" class="difflineminus">-    switch (reply_on_top)</span>
<a href="#l17.972"></a><span id="l17.972" class="difflineminus">-    {</span>
<a href="#l17.973"></a><span id="l17.973" class="difflineplus">+  else {</span>
<a href="#l17.974"></a><span id="l17.974" class="difflineplus">+    switch (reply_on_top) {</span>
<a href="#l17.975"></a><span id="l17.975">       // This should set the cursor after the body but before the sig</span>
<a href="#l17.976"></a><span id="l17.976" class="difflineminus">-      case 0:</span>
<a href="#l17.977"></a><span id="l17.977" class="difflineminus">-      {</span>
<a href="#l17.978"></a><span id="l17.978" class="difflineminus">-        if (!textEditor)</span>
<a href="#l17.979"></a><span id="l17.979" class="difflineminus">-        {</span>
<a href="#l17.980"></a><span id="l17.980" class="difflineplus">+      case 0: {</span>
<a href="#l17.981"></a><span id="l17.981" class="difflineplus">+        if (!textEditor) {</span>
<a href="#l17.982"></a><span id="l17.982">           m_editor-&gt;BeginningOfDocument();</span>
<a href="#l17.983"></a><span id="l17.983">           break;</span>
<a href="#l17.984"></a><span id="l17.984">         }</span>
<a href="#l17.985"></a><span id="l17.985"> </span>
<a href="#l17.986"></a><span id="l17.986">         RefPtr&lt;Selection&gt; selection;</span>
<a href="#l17.987"></a><span id="l17.987">         nsCOMPtr&lt;nsINode&gt; parent;</span>
<a href="#l17.988"></a><span id="l17.988">         int32_t offset;</span>
<a href="#l17.989"></a><span id="l17.989">         nsresult rv;</span>
<a href="#l17.990"></a><span id="l17.990"> </span>
<a href="#l17.991"></a><span id="l17.991">         // get parent and offset of mailcite</span>
<a href="#l17.992"></a><span id="l17.992">         rv = GetNodeLocation(nodeInserted, address_of(parent), &amp;offset);</span>
<a href="#l17.993"></a><span id="l17.993" class="difflineminus">-        if (NS_FAILED(rv) || (!parent))</span>
<a href="#l17.994"></a><span id="l17.994" class="difflineminus">-        {</span>
<a href="#l17.995"></a><span id="l17.995" class="difflineplus">+        if (NS_FAILED(rv) || (!parent)) {</span>
<a href="#l17.996"></a><span id="l17.996">           m_editor-&gt;BeginningOfDocument();</span>
<a href="#l17.997"></a><span id="l17.997">           break;</span>
<a href="#l17.998"></a><span id="l17.998">         }</span>
<a href="#l17.999"></a><span id="l17.999"> </span>
<a href="#l17.1000"></a><span id="l17.1000">         // get selection</span>
<a href="#l17.1001"></a><span id="l17.1001">         m_editor-&gt;GetSelection(getter_AddRefs(selection));</span>
<a href="#l17.1002"></a><span id="l17.1002" class="difflineminus">-        if (!selection)</span>
<a href="#l17.1003"></a><span id="l17.1003" class="difflineminus">-        {</span>
<a href="#l17.1004"></a><span id="l17.1004" class="difflineplus">+        if (!selection) {</span>
<a href="#l17.1005"></a><span id="l17.1005">           m_editor-&gt;BeginningOfDocument();</span>
<a href="#l17.1006"></a><span id="l17.1006">           break;</span>
<a href="#l17.1007"></a><span id="l17.1007">         }</span>
<a href="#l17.1008"></a><span id="l17.1008"> </span>
<a href="#l17.1009"></a><span id="l17.1009">         // place selection after mailcite</span>
<a href="#l17.1010"></a><span id="l17.1010" class="difflineminus">-        selection-&gt;Collapse(parent, offset+1);</span>
<a href="#l17.1011"></a><span id="l17.1011" class="difflineplus">+        selection-&gt;Collapse(parent, offset + 1);</span>
<a href="#l17.1012"></a><span id="l17.1012"> </span>
<a href="#l17.1013"></a><span id="l17.1013">         // insert a break at current selection</span>
<a href="#l17.1014"></a><span id="l17.1014" class="difflineminus">-        if (!paragraphMode || !aHTMLEditor)</span>
<a href="#l17.1015"></a><span id="l17.1015" class="difflineminus">-          textEditor-&gt;InsertLineBreak();</span>
<a href="#l17.1016"></a><span id="l17.1016" class="difflineplus">+        if (!paragraphMode || !aHTMLEditor) textEditor-&gt;InsertLineBreak();</span>
<a href="#l17.1017"></a><span id="l17.1017"> </span>
<a href="#l17.1018"></a><span id="l17.1018">         // i'm not sure if you need to move the selection back to before the</span>
<a href="#l17.1019"></a><span id="l17.1019">         // break. expirement.</span>
<a href="#l17.1020"></a><span id="l17.1020" class="difflineminus">-        selection-&gt;Collapse(parent, offset+1);</span>
<a href="#l17.1021"></a><span id="l17.1021" class="difflineplus">+        selection-&gt;Collapse(parent, offset + 1);</span>
<a href="#l17.1022"></a><span id="l17.1022"> </span>
<a href="#l17.1023"></a><span id="l17.1023">         break;</span>
<a href="#l17.1024"></a><span id="l17.1024">       }</span>
<a href="#l17.1025"></a><span id="l17.1025"> </span>
<a href="#l17.1026"></a><span id="l17.1026" class="difflineminus">-      case 2:</span>
<a href="#l17.1027"></a><span id="l17.1027" class="difflineminus">-      {</span>
<a href="#l17.1028"></a><span id="l17.1028" class="difflineplus">+      case 2: {</span>
<a href="#l17.1029"></a><span id="l17.1029">         nsCOMPtr&lt;nsIEditor&gt; editor(m_editor);  // Strong reference.</span>
<a href="#l17.1030"></a><span id="l17.1030">         editor-&gt;SelectAll();</span>
<a href="#l17.1031"></a><span id="l17.1031">         break;</span>
<a href="#l17.1032"></a><span id="l17.1032">       }</span>
<a href="#l17.1033"></a><span id="l17.1033"> </span>
<a href="#l17.1034"></a><span id="l17.1034">       // This should set the cursor to the top!</span>
<a href="#l17.1035"></a><span id="l17.1035" class="difflineminus">-      default:</span>
<a href="#l17.1036"></a><span id="l17.1036" class="difflineminus">-      {</span>
<a href="#l17.1037"></a><span id="l17.1037" class="difflineplus">+      default: {</span>
<a href="#l17.1038"></a><span id="l17.1038">         MoveToBeginningOfDocument();</span>
<a href="#l17.1039"></a><span id="l17.1039">         break;</span>
<a href="#l17.1040"></a><span id="l17.1040">       }</span>
<a href="#l17.1041"></a><span id="l17.1041">     }</span>
<a href="#l17.1042"></a><span id="l17.1042">   }</span>
<a href="#l17.1043"></a><span id="l17.1043"> </span>
<a href="#l17.1044"></a><span id="l17.1044">   nsCOMPtr&lt;nsISelectionController&gt; selCon;</span>
<a href="#l17.1045"></a><span id="l17.1045">   m_editor-&gt;GetSelectionController(getter_AddRefs(selCon));</span>
<a href="#l17.1046"></a><span id="l17.1046"> </span>
<a href="#l17.1047"></a><span id="l17.1047">   if (selCon)</span>
<a href="#l17.1048"></a><span id="l17.1048" class="difflineminus">-    selCon-&gt;ScrollSelectionIntoView(nsISelectionController::SELECTION_NORMAL, nsISelectionController::SELECTION_ANCHOR_REGION, true);</span>
<a href="#l17.1049"></a><span id="l17.1049" class="difflineplus">+    selCon-&gt;ScrollSelectionIntoView(</span>
<a href="#l17.1050"></a><span id="l17.1050" class="difflineplus">+        nsISelectionController::SELECTION_NORMAL,</span>
<a href="#l17.1051"></a><span id="l17.1051" class="difflineplus">+        nsISelectionController::SELECTION_ANCHOR_REGION, true);</span>
<a href="#l17.1052"></a><span id="l17.1052"> </span>
<a href="#l17.1053"></a><span id="l17.1053">   m_editor-&gt;EnableUndo(true);</span>
<a href="#l17.1054"></a><span id="l17.1054">   SetBodyModified(false);</span>
<a href="#l17.1055"></a><span id="l17.1055"> </span>
<a href="#l17.1056"></a><span id="l17.1056"> #ifdef MSGCOMP_TRACE_PERFORMANCE</span>
<a href="#l17.1057"></a><span id="l17.1057" class="difflineminus">-  nsCOMPtr&lt;nsIMsgComposeService&gt; composeService (do_GetService(NS_MSGCOMPOSESERVICE_CONTRACTID));</span>
<a href="#l17.1058"></a><span id="l17.1058" class="difflineminus">-  composeService-&gt;TimeStamp(&quot;Finished inserting data into the editor. The window is finally ready!&quot;, false);</span>
<a href="#l17.1059"></a><span id="l17.1059" class="difflineplus">+  nsCOMPtr&lt;nsIMsgComposeService&gt; composeService(</span>
<a href="#l17.1060"></a><span id="l17.1060" class="difflineplus">+      do_GetService(NS_MSGCOMPOSESERVICE_CONTRACTID));</span>
<a href="#l17.1061"></a><span id="l17.1061" class="difflineplus">+  composeService-&gt;TimeStamp(</span>
<a href="#l17.1062"></a><span id="l17.1062" class="difflineplus">+      &quot;Finished inserting data into the editor. The window is finally ready!&quot;,</span>
<a href="#l17.1063"></a><span id="l17.1063" class="difflineplus">+      false);</span>
<a href="#l17.1064"></a><span id="l17.1064"> #endif</span>
<a href="#l17.1065"></a><span id="l17.1065">   return NS_OK;</span>
<a href="#l17.1066"></a><span id="l17.1066"> }</span>
<a href="#l17.1067"></a><span id="l17.1067"> </span>
<a href="#l17.1068"></a><span id="l17.1068"> /**</span>
<a href="#l17.1069"></a><span id="l17.1069">  * Check the identity pref to include signature on replies and forwards.</span>
<a href="#l17.1070"></a><span id="l17.1070">  */</span>
<a href="#l17.1071"></a><span id="l17.1071" class="difflineminus">-bool nsMsgCompose::CheckIncludeSignaturePrefs(nsIMsgIdentity *identity)</span>
<a href="#l17.1072"></a><span id="l17.1072" class="difflineminus">-{</span>
<a href="#l17.1073"></a><span id="l17.1073" class="difflineplus">+bool nsMsgCompose::CheckIncludeSignaturePrefs(nsIMsgIdentity *identity) {</span>
<a href="#l17.1074"></a><span id="l17.1074">   bool includeSignature = true;</span>
<a href="#l17.1075"></a><span id="l17.1075" class="difflineminus">-  switch (mType)</span>
<a href="#l17.1076"></a><span id="l17.1076" class="difflineminus">-  {</span>
<a href="#l17.1077"></a><span id="l17.1077" class="difflineplus">+  switch (mType) {</span>
<a href="#l17.1078"></a><span id="l17.1078">     case nsIMsgCompType::ForwardInline:</span>
<a href="#l17.1079"></a><span id="l17.1079">     case nsIMsgCompType::ForwardAsAttachment:</span>
<a href="#l17.1080"></a><span id="l17.1080">       identity-&gt;GetSigOnForward(&amp;includeSignature);</span>
<a href="#l17.1081"></a><span id="l17.1081">       break;</span>
<a href="#l17.1082"></a><span id="l17.1082">     case nsIMsgCompType::Reply:</span>
<a href="#l17.1083"></a><span id="l17.1083">     case nsIMsgCompType::ReplyAll:</span>
<a href="#l17.1084"></a><span id="l17.1084">     case nsIMsgCompType::ReplyToList:</span>
<a href="#l17.1085"></a><span id="l17.1085">     case nsIMsgCompType::ReplyToGroup:</span>
<a href="#l17.1086"></a><span id="l17.1086">     case nsIMsgCompType::ReplyToSender:</span>
<a href="#l17.1087"></a><span id="l17.1087">     case nsIMsgCompType::ReplyToSenderAndGroup:</span>
<a href="#l17.1088"></a><span id="l17.1088">       identity-&gt;GetSigOnReply(&amp;includeSignature);</span>
<a href="#l17.1089"></a><span id="l17.1089">       break;</span>
<a href="#l17.1090"></a><span id="l17.1090">   }</span>
<a href="#l17.1091"></a><span id="l17.1091">   return includeSignature;</span>
<a href="#l17.1092"></a><span id="l17.1092"> }</span>
<a href="#l17.1093"></a><span id="l17.1093"> </span>
<a href="#l17.1094"></a><span id="l17.1094" class="difflineminus">-nsresult</span>
<a href="#l17.1095"></a><span id="l17.1095" class="difflineminus">-nsMsgCompose::SetQuotingToFollow(bool aVal)</span>
<a href="#l17.1096"></a><span id="l17.1096" class="difflineminus">-{</span>
<a href="#l17.1097"></a><span id="l17.1097" class="difflineplus">+nsresult nsMsgCompose::SetQuotingToFollow(bool aVal) {</span>
<a href="#l17.1098"></a><span id="l17.1098">   mQuotingToFollow = aVal;</span>
<a href="#l17.1099"></a><span id="l17.1099">   return NS_OK;</span>
<a href="#l17.1100"></a><span id="l17.1100"> }</span>
<a href="#l17.1101"></a><span id="l17.1101"> </span>
<a href="#l17.1102"></a><span id="l17.1102"> NS_IMETHODIMP</span>
<a href="#l17.1103"></a><span id="l17.1103" class="difflineminus">-nsMsgCompose::GetQuotingToFollow(bool* quotingToFollow)</span>
<a href="#l17.1104"></a><span id="l17.1104" class="difflineminus">-{</span>
<a href="#l17.1105"></a><span id="l17.1105" class="difflineplus">+nsMsgCompose::GetQuotingToFollow(bool *quotingToFollow) {</span>
<a href="#l17.1106"></a><span id="l17.1106">   NS_ENSURE_ARG(quotingToFollow);</span>
<a href="#l17.1107"></a><span id="l17.1107">   *quotingToFollow = mQuotingToFollow;</span>
<a href="#l17.1108"></a><span id="l17.1108">   return NS_OK;</span>
<a href="#l17.1109"></a><span id="l17.1109"> }</span>
<a href="#l17.1110"></a><span id="l17.1110"> </span>
<a href="#l17.1111"></a><span id="l17.1111"> NS_IMETHODIMP</span>
<a href="#l17.1112"></a><span id="l17.1112"> nsMsgCompose::Initialize(nsIMsgComposeParams *aParams,</span>
<a href="#l17.1113"></a><span id="l17.1113" class="difflineminus">-                         mozIDOMWindowProxy *aWindow,</span>
<a href="#l17.1114"></a><span id="l17.1114" class="difflineminus">-                         nsIDocShell *aDocShell)</span>
<a href="#l17.1115"></a><span id="l17.1115" class="difflineminus">-{</span>
<a href="#l17.1116"></a><span id="l17.1116" class="difflineplus">+                         mozIDOMWindowProxy *aWindow, nsIDocShell *aDocShell) {</span>
<a href="#l17.1117"></a><span id="l17.1117">   NS_ENSURE_ARG_POINTER(aParams);</span>
<a href="#l17.1118"></a><span id="l17.1118">   nsresult rv;</span>
<a href="#l17.1119"></a><span id="l17.1119"> </span>
<a href="#l17.1120"></a><span id="l17.1120">   aParams-&gt;GetIdentity(getter_AddRefs(m_identity));</span>
<a href="#l17.1121"></a><span id="l17.1121"> </span>
<a href="#l17.1122"></a><span id="l17.1122" class="difflineminus">-  if (aWindow)</span>
<a href="#l17.1123"></a><span id="l17.1123" class="difflineminus">-  {</span>
<a href="#l17.1124"></a><span id="l17.1124" class="difflineplus">+  if (aWindow) {</span>
<a href="#l17.1125"></a><span id="l17.1125">     m_window = aWindow;</span>
<a href="#l17.1126"></a><span id="l17.1126">     nsCOMPtr&lt;nsPIDOMWindowOuter&gt; window = nsPIDOMWindowOuter::From(aWindow);</span>
<a href="#l17.1127"></a><span id="l17.1127">     NS_ENSURE_TRUE(window, NS_ERROR_FAILURE);</span>
<a href="#l17.1128"></a><span id="l17.1128"> </span>
<a href="#l17.1129"></a><span id="l17.1129">     nsCOMPtr&lt;nsIDocShellTreeItem&gt; treeItem = window-&gt;GetDocShell();</span>
<a href="#l17.1130"></a><span id="l17.1130">     nsCOMPtr&lt;nsIDocShellTreeOwner&gt; treeOwner;</span>
<a href="#l17.1131"></a><span id="l17.1131">     rv = treeItem-&gt;GetTreeOwner(getter_AddRefs(treeOwner));</span>
<a href="#l17.1132"></a><span id="l17.1132">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l17.1133"></a><span id="l17.1133" class="difflineat">@@ -1032,35 +960,34 @@ nsMsgCompose::Initialize(nsIMsgComposePa</span>
<a href="#l17.1134"></a><span id="l17.1134"> </span>
<a href="#l17.1135"></a><span id="l17.1135">   nsCString originalMsgURI;</span>
<a href="#l17.1136"></a><span id="l17.1136">   aParams-&gt;GetOriginalMsgURI(getter_Copies(originalMsgURI));</span>
<a href="#l17.1137"></a><span id="l17.1137">   aParams-&gt;GetOrigMsgHdr(getter_AddRefs(mOrigMsgHdr));</span>
<a href="#l17.1138"></a><span id="l17.1138"> </span>
<a href="#l17.1139"></a><span id="l17.1139">   nsCOMPtr&lt;nsIMsgCompFields&gt; composeFields;</span>
<a href="#l17.1140"></a><span id="l17.1140">   aParams-&gt;GetComposeFields(getter_AddRefs(composeFields));</span>
<a href="#l17.1141"></a><span id="l17.1141"> </span>
<a href="#l17.1142"></a><span id="l17.1142" class="difflineminus">-  nsCOMPtr&lt;nsIMsgComposeService&gt; composeService = do_GetService(NS_MSGCOMPOSESERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l17.1143"></a><span id="l17.1143" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.1144"></a><span id="l17.1144" class="difflineplus">+  nsCOMPtr&lt;nsIMsgComposeService&gt; composeService =</span>
<a href="#l17.1145"></a><span id="l17.1145" class="difflineplus">+      do_GetService(NS_MSGCOMPOSESERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l17.1146"></a><span id="l17.1146" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.1147"></a><span id="l17.1147"> </span>
<a href="#l17.1148"></a><span id="l17.1148">   rv = composeService-&gt;DetermineComposeHTML(m_identity, format, &amp;m_composeHTML);</span>
<a href="#l17.1149"></a><span id="l17.1149" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.1150"></a><span id="l17.1150" class="difflineminus">-</span>
<a href="#l17.1151"></a><span id="l17.1151" class="difflineminus">-  if (composeFields)</span>
<a href="#l17.1152"></a><span id="l17.1152" class="difflineminus">-  {</span>
<a href="#l17.1153"></a><span id="l17.1153" class="difflineminus">-    nsAutoCString draftId; // will get set for drafts and templates</span>
<a href="#l17.1154"></a><span id="l17.1154" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.1155"></a><span id="l17.1155" class="difflineplus">+</span>
<a href="#l17.1156"></a><span id="l17.1156" class="difflineplus">+  if (composeFields) {</span>
<a href="#l17.1157"></a><span id="l17.1157" class="difflineplus">+    nsAutoCString draftId;  // will get set for drafts and templates</span>
<a href="#l17.1158"></a><span id="l17.1158">     rv = composeFields-&gt;GetDraftId(getter_Copies(draftId));</span>
<a href="#l17.1159"></a><span id="l17.1159" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.1160"></a><span id="l17.1160" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.1161"></a><span id="l17.1161"> </span>
<a href="#l17.1162"></a><span id="l17.1162">     // Set return receipt flag and type, and if we should attach a vCard</span>
<a href="#l17.1163"></a><span id="l17.1163">     // by checking the identity prefs - but don't clobber the values for</span>
<a href="#l17.1164"></a><span id="l17.1164">     // drafts and templates as they were set up already by mime when</span>
<a href="#l17.1165"></a><span id="l17.1165">     // initializing the message.</span>
<a href="#l17.1166"></a><span id="l17.1166" class="difflineminus">-    if (m_identity &amp;&amp; draftId.IsEmpty() &amp;&amp; type != nsIMsgCompType::Template</span>
<a href="#l17.1167"></a><span id="l17.1167" class="difflineminus">-        &amp;&amp; type != nsIMsgCompType::EditAsNew)</span>
<a href="#l17.1168"></a><span id="l17.1168" class="difflineminus">-    {</span>
<a href="#l17.1169"></a><span id="l17.1169" class="difflineplus">+    if (m_identity &amp;&amp; draftId.IsEmpty() &amp;&amp; type != nsIMsgCompType::Template &amp;&amp;</span>
<a href="#l17.1170"></a><span id="l17.1170" class="difflineplus">+        type != nsIMsgCompType::EditAsNew) {</span>
<a href="#l17.1171"></a><span id="l17.1171">       bool requestReturnReceipt = false;</span>
<a href="#l17.1172"></a><span id="l17.1172">       rv = m_identity-&gt;GetRequestReturnReceipt(&amp;requestReturnReceipt);</span>
<a href="#l17.1173"></a><span id="l17.1173">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.1174"></a><span id="l17.1174">       rv = composeFields-&gt;SetReturnReceipt(requestReturnReceipt);</span>
<a href="#l17.1175"></a><span id="l17.1175">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.1176"></a><span id="l17.1176"> </span>
<a href="#l17.1177"></a><span id="l17.1177">       int32_t receiptType = nsIMsgMdnGenerator::eDntType;</span>
<a href="#l17.1178"></a><span id="l17.1178">       rv = m_identity-&gt;GetReceiptHeaderType(&amp;receiptType);</span>
<a href="#l17.1179"></a><span id="l17.1179" class="difflineat">@@ -1079,125 +1006,123 @@ nsMsgCompose::Initialize(nsIMsgComposePa</span>
<a href="#l17.1180"></a><span id="l17.1180">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.1181"></a><span id="l17.1181">       rv = composeFields-&gt;SetAttachVCard(attachVCard);</span>
<a href="#l17.1182"></a><span id="l17.1182">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.1183"></a><span id="l17.1183">     }</span>
<a href="#l17.1184"></a><span id="l17.1184">   }</span>
<a href="#l17.1185"></a><span id="l17.1185"> </span>
<a href="#l17.1186"></a><span id="l17.1186">   nsCOMPtr&lt;nsIMsgSendListener&gt; externalSendListener;</span>
<a href="#l17.1187"></a><span id="l17.1187">   aParams-&gt;GetSendListener(getter_AddRefs(externalSendListener));</span>
<a href="#l17.1188"></a><span id="l17.1188" class="difflineminus">-  if(externalSendListener)</span>
<a href="#l17.1189"></a><span id="l17.1189" class="difflineminus">-    AddMsgSendListener( externalSendListener );</span>
<a href="#l17.1190"></a><span id="l17.1190" class="difflineplus">+  if (externalSendListener) AddMsgSendListener(externalSendListener);</span>
<a href="#l17.1191"></a><span id="l17.1191"> </span>
<a href="#l17.1192"></a><span id="l17.1192">   nsString smtpPassword;</span>
<a href="#l17.1193"></a><span id="l17.1193">   aParams-&gt;GetSmtpPassword(smtpPassword);</span>
<a href="#l17.1194"></a><span id="l17.1194">   mSmtpPassword = smtpPassword;</span>
<a href="#l17.1195"></a><span id="l17.1195"> </span>
<a href="#l17.1196"></a><span id="l17.1196">   aParams-&gt;GetHtmlToQuote(mHtmlToQuote);</span>
<a href="#l17.1197"></a><span id="l17.1197"> </span>
<a href="#l17.1198"></a><span id="l17.1198" class="difflineminus">-  if (aDocShell)</span>
<a href="#l17.1199"></a><span id="l17.1199" class="difflineminus">-  {</span>
<a href="#l17.1200"></a><span id="l17.1200" class="difflineplus">+  if (aDocShell) {</span>
<a href="#l17.1201"></a><span id="l17.1201">     mDocShell = aDocShell;</span>
<a href="#l17.1202"></a><span id="l17.1202">     // register the compose object with the compose service</span>
<a href="#l17.1203"></a><span id="l17.1203">     rv = composeService-&gt;RegisterComposeDocShell(aDocShell, this);</span>
<a href="#l17.1204"></a><span id="l17.1204">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.1205"></a><span id="l17.1205">   }</span>
<a href="#l17.1206"></a><span id="l17.1206">   return CreateMessage(originalMsgURI.get(), type, composeFields);</span>
<a href="#l17.1207"></a><span id="l17.1207"> }</span>
<a href="#l17.1208"></a><span id="l17.1208"> </span>
<a href="#l17.1209"></a><span id="l17.1209"> MOZ_CAN_RUN_SCRIPT_BOUNDARY nsresult</span>
<a href="#l17.1210"></a><span id="l17.1210" class="difflineminus">-nsMsgCompose::SetDocumentCharset(const char *aCharset)</span>
<a href="#l17.1211"></a><span id="l17.1211" class="difflineminus">-{</span>
<a href="#l17.1212"></a><span id="l17.1212" class="difflineplus">+nsMsgCompose::SetDocumentCharset(const char *aCharset) {</span>
<a href="#l17.1213"></a><span id="l17.1213">   NS_ENSURE_TRUE(m_compFields &amp;&amp; m_editor, NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l17.1214"></a><span id="l17.1214"> </span>
<a href="#l17.1215"></a><span id="l17.1215">   // Set charset, this will be used for the MIME charset labeling.</span>
<a href="#l17.1216"></a><span id="l17.1216">   m_compFields-&gt;SetCharacterSet(aCharset);</span>
<a href="#l17.1217"></a><span id="l17.1217"> </span>
<a href="#l17.1218"></a><span id="l17.1218">   // notify the change to editor</span>
<a href="#l17.1219"></a><span id="l17.1219">   nsCString charset;</span>
<a href="#l17.1220"></a><span id="l17.1220" class="difflineminus">-  if (aCharset)</span>
<a href="#l17.1221"></a><span id="l17.1221" class="difflineminus">-    charset = nsDependentCString(aCharset);</span>
<a href="#l17.1222"></a><span id="l17.1222" class="difflineplus">+  if (aCharset) charset = nsDependentCString(aCharset);</span>
<a href="#l17.1223"></a><span id="l17.1223">   if (m_editor) {</span>
<a href="#l17.1224"></a><span id="l17.1224">     nsCOMPtr&lt;nsIEditor&gt; editor(m_editor);  // Strong reference.</span>
<a href="#l17.1225"></a><span id="l17.1225">     editor-&gt;SetDocumentCharacterSet(charset);</span>
<a href="#l17.1226"></a><span id="l17.1226">   }</span>
<a href="#l17.1227"></a><span id="l17.1227"> </span>
<a href="#l17.1228"></a><span id="l17.1228">   return NS_OK;</span>
<a href="#l17.1229"></a><span id="l17.1229"> }</span>
<a href="#l17.1230"></a><span id="l17.1230"> </span>
<a href="#l17.1231"></a><span id="l17.1231"> NS_IMETHODIMP</span>
<a href="#l17.1232"></a><span id="l17.1232" class="difflineminus">-nsMsgCompose::RegisterStateListener(nsIMsgComposeStateListener *aStateListener)</span>
<a href="#l17.1233"></a><span id="l17.1233" class="difflineminus">-{</span>
<a href="#l17.1234"></a><span id="l17.1234" class="difflineplus">+nsMsgCompose::RegisterStateListener(</span>
<a href="#l17.1235"></a><span id="l17.1235" class="difflineplus">+    nsIMsgComposeStateListener *aStateListener) {</span>
<a href="#l17.1236"></a><span id="l17.1236">   NS_ENSURE_ARG_POINTER(aStateListener);</span>
<a href="#l17.1237"></a><span id="l17.1237">   mStateListeners.AppendElement(aStateListener);</span>
<a href="#l17.1238"></a><span id="l17.1238">   return NS_OK;</span>
<a href="#l17.1239"></a><span id="l17.1239"> }</span>
<a href="#l17.1240"></a><span id="l17.1240"> </span>
<a href="#l17.1241"></a><span id="l17.1241"> NS_IMETHODIMP</span>
<a href="#l17.1242"></a><span id="l17.1242" class="difflineminus">-nsMsgCompose::UnregisterStateListener(nsIMsgComposeStateListener *aStateListener)</span>
<a href="#l17.1243"></a><span id="l17.1243" class="difflineminus">-{</span>
<a href="#l17.1244"></a><span id="l17.1244" class="difflineplus">+nsMsgCompose::UnregisterStateListener(</span>
<a href="#l17.1245"></a><span id="l17.1245" class="difflineplus">+    nsIMsgComposeStateListener *aStateListener) {</span>
<a href="#l17.1246"></a><span id="l17.1246">   NS_ENSURE_ARG_POINTER(aStateListener);</span>
<a href="#l17.1247"></a><span id="l17.1247" class="difflineminus">-  return mStateListeners.RemoveElement(aStateListener) ? NS_OK : NS_ERROR_FAILURE;</span>
<a href="#l17.1248"></a><span id="l17.1248" class="difflineplus">+  return mStateListeners.RemoveElement(aStateListener) ? NS_OK</span>
<a href="#l17.1249"></a><span id="l17.1249" class="difflineplus">+                                                       : NS_ERROR_FAILURE;</span>
<a href="#l17.1250"></a><span id="l17.1250"> }</span>
<a href="#l17.1251"></a><span id="l17.1251"> </span>
<a href="#l17.1252"></a><span id="l17.1252"> // Added to allow easier use of the nsIMsgSendListener</span>
<a href="#l17.1253"></a><span id="l17.1253" class="difflineminus">-NS_IMETHODIMP nsMsgCompose::AddMsgSendListener( nsIMsgSendListener *aMsgSendListener )</span>
<a href="#l17.1254"></a><span id="l17.1254" class="difflineminus">-{</span>
<a href="#l17.1255"></a><span id="l17.1255" class="difflineplus">+NS_IMETHODIMP nsMsgCompose::AddMsgSendListener(</span>
<a href="#l17.1256"></a><span id="l17.1256" class="difflineplus">+    nsIMsgSendListener *aMsgSendListener) {</span>
<a href="#l17.1257"></a><span id="l17.1257">   NS_ENSURE_ARG_POINTER(aMsgSendListener);</span>
<a href="#l17.1258"></a><span id="l17.1258">   mExternalSendListeners.AppendElement(aMsgSendListener);</span>
<a href="#l17.1259"></a><span id="l17.1259">   return NS_OK;</span>
<a href="#l17.1260"></a><span id="l17.1260"> }</span>
<a href="#l17.1261"></a><span id="l17.1261"> </span>
<a href="#l17.1262"></a><span id="l17.1262" class="difflineminus">-NS_IMETHODIMP nsMsgCompose::RemoveMsgSendListener( nsIMsgSendListener *aMsgSendListener )</span>
<a href="#l17.1263"></a><span id="l17.1263" class="difflineminus">-{</span>
<a href="#l17.1264"></a><span id="l17.1264" class="difflineplus">+NS_IMETHODIMP nsMsgCompose::RemoveMsgSendListener(</span>
<a href="#l17.1265"></a><span id="l17.1265" class="difflineplus">+    nsIMsgSendListener *aMsgSendListener) {</span>
<a href="#l17.1266"></a><span id="l17.1266">   NS_ENSURE_ARG_POINTER(aMsgSendListener);</span>
<a href="#l17.1267"></a><span id="l17.1267" class="difflineminus">-  return mExternalSendListeners.RemoveElement(aMsgSendListener) ? NS_OK : NS_ERROR_FAILURE;</span>
<a href="#l17.1268"></a><span id="l17.1268" class="difflineplus">+  return mExternalSendListeners.RemoveElement(aMsgSendListener)</span>
<a href="#l17.1269"></a><span id="l17.1269" class="difflineplus">+             ? NS_OK</span>
<a href="#l17.1270"></a><span id="l17.1270" class="difflineplus">+             : NS_ERROR_FAILURE;</span>
<a href="#l17.1271"></a><span id="l17.1271"> }</span>
<a href="#l17.1272"></a><span id="l17.1272"> </span>
<a href="#l17.1273"></a><span id="l17.1273"> NS_IMETHODIMP</span>
<a href="#l17.1274"></a><span id="l17.1274" class="difflineminus">-nsMsgCompose::SendMsgToServer(MSG_DeliverMode deliverMode, nsIMsgIdentity *identity,</span>
<a href="#l17.1275"></a><span id="l17.1275" class="difflineminus">-                              const char *accountKey)</span>
<a href="#l17.1276"></a><span id="l17.1276" class="difflineminus">-{</span>
<a href="#l17.1277"></a><span id="l17.1277" class="difflineplus">+nsMsgCompose::SendMsgToServer(MSG_DeliverMode deliverMode,</span>
<a href="#l17.1278"></a><span id="l17.1278" class="difflineplus">+                              nsIMsgIdentity *identity,</span>
<a href="#l17.1279"></a><span id="l17.1279" class="difflineplus">+                              const char *accountKey) {</span>
<a href="#l17.1280"></a><span id="l17.1280">   nsresult rv = NS_OK;</span>
<a href="#l17.1281"></a><span id="l17.1281"> </span>
<a href="#l17.1282"></a><span id="l17.1282" class="difflineminus">-  // clear saved message id if sending, so we don't send out the same message-id.</span>
<a href="#l17.1283"></a><span id="l17.1283" class="difflineplus">+  // clear saved message id if sending, so we don't send out the same</span>
<a href="#l17.1284"></a><span id="l17.1284" class="difflineplus">+  // message-id.</span>
<a href="#l17.1285"></a><span id="l17.1285">   if (deliverMode == nsIMsgCompDeliverMode::Now ||</span>
<a href="#l17.1286"></a><span id="l17.1286">       deliverMode == nsIMsgCompDeliverMode::Later ||</span>
<a href="#l17.1287"></a><span id="l17.1287">       deliverMode == nsIMsgCompDeliverMode::Background)</span>
<a href="#l17.1288"></a><span id="l17.1288">     m_compFields-&gt;SetMessageId(&quot;&quot;);</span>
<a href="#l17.1289"></a><span id="l17.1289"> </span>
<a href="#l17.1290"></a><span id="l17.1290" class="difflineminus">-  if (m_compFields &amp;&amp; identity)</span>
<a href="#l17.1291"></a><span id="l17.1291" class="difflineminus">-  {</span>
<a href="#l17.1292"></a><span id="l17.1292" class="difflineplus">+  if (m_compFields &amp;&amp; identity) {</span>
<a href="#l17.1293"></a><span id="l17.1293">     // Pref values are supposed to be stored as UTF-8, so no conversion</span>
<a href="#l17.1294"></a><span id="l17.1294">     nsCString email;</span>
<a href="#l17.1295"></a><span id="l17.1295">     nsString fullName;</span>
<a href="#l17.1296"></a><span id="l17.1296">     nsString organization;</span>
<a href="#l17.1297"></a><span id="l17.1297"> </span>
<a href="#l17.1298"></a><span id="l17.1298">     identity-&gt;GetEmail(email);</span>
<a href="#l17.1299"></a><span id="l17.1299">     identity-&gt;GetFullName(fullName);</span>
<a href="#l17.1300"></a><span id="l17.1300">     identity-&gt;GetOrganization(organization);</span>
<a href="#l17.1301"></a><span id="l17.1301"> </span>
<a href="#l17.1302"></a><span id="l17.1302" class="difflineminus">-    const char* pFrom = m_compFields-&gt;GetFrom();</span>
<a href="#l17.1303"></a><span id="l17.1303" class="difflineminus">-    if (!pFrom || !*pFrom)</span>
<a href="#l17.1304"></a><span id="l17.1304" class="difflineminus">-    {</span>
<a href="#l17.1305"></a><span id="l17.1305" class="difflineplus">+    const char *pFrom = m_compFields-&gt;GetFrom();</span>
<a href="#l17.1306"></a><span id="l17.1306" class="difflineplus">+    if (!pFrom || !*pFrom) {</span>
<a href="#l17.1307"></a><span id="l17.1307">       nsCString sender;</span>
<a href="#l17.1308"></a><span id="l17.1308">       MakeMimeAddress(NS_ConvertUTF16toUTF8(fullName), email, sender);</span>
<a href="#l17.1309"></a><span id="l17.1309">       m_compFields-&gt;SetFrom(sender.IsEmpty() ? email.get() : sender.get());</span>
<a href="#l17.1310"></a><span id="l17.1310">     }</span>
<a href="#l17.1311"></a><span id="l17.1311"> </span>
<a href="#l17.1312"></a><span id="l17.1312">     m_compFields-&gt;SetOrganization(organization);</span>
<a href="#l17.1313"></a><span id="l17.1313"> </span>
<a href="#l17.1314"></a><span id="l17.1314">     // We need an nsIMsgSend instance to send the message. Allow extensions</span>
<a href="#l17.1315"></a><span id="l17.1315">     // to override the default SMTP sender by observing mail-set-sender.</span>
<a href="#l17.1316"></a><span id="l17.1316">     mMsgSend = nullptr;</span>
<a href="#l17.1317"></a><span id="l17.1317">     mDeliverMode = deliverMode;  // save for possible access by observer.</span>
<a href="#l17.1318"></a><span id="l17.1318"> </span>
<a href="#l17.1319"></a><span id="l17.1319">     // Allow extensions to specify an outgoing server.</span>
<a href="#l17.1320"></a><span id="l17.1320">     nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l17.1321"></a><span id="l17.1321" class="difflineminus">-      mozilla::services::GetObserverService();</span>
<a href="#l17.1322"></a><span id="l17.1322" class="difflineplus">+        mozilla::services::GetObserverService();</span>
<a href="#l17.1323"></a><span id="l17.1323">     NS_ENSURE_STATE(observerService);</span>
<a href="#l17.1324"></a><span id="l17.1324"> </span>
<a href="#l17.1325"></a><span id="l17.1325">     // Assemble a string with sending parameters.</span>
<a href="#l17.1326"></a><span id="l17.1326">     nsAutoString sendParms;</span>
<a href="#l17.1327"></a><span id="l17.1327"> </span>
<a href="#l17.1328"></a><span id="l17.1328">     // First parameter: account key. This may be null.</span>
<a href="#l17.1329"></a><span id="l17.1329">     sendParms.AppendASCII(accountKey &amp;&amp; *accountKey ? accountKey : &quot;&quot;);</span>
<a href="#l17.1330"></a><span id="l17.1330">     sendParms.Append(',');</span>
<a href="#l17.1331"></a><span id="l17.1331" class="difflineat">@@ -1206,292 +1131,256 @@ nsMsgCompose::SendMsgToServer(MSG_Delive</span>
<a href="#l17.1332"></a><span id="l17.1332">     sendParms.AppendInt(deliverMode);</span>
<a href="#l17.1333"></a><span id="l17.1333">     sendParms.Append(',');</span>
<a href="#l17.1334"></a><span id="l17.1334"> </span>
<a href="#l17.1335"></a><span id="l17.1335">     // Third parameter: identity (as identity key).</span>
<a href="#l17.1336"></a><span id="l17.1336">     nsAutoCString identityKey;</span>
<a href="#l17.1337"></a><span id="l17.1337">     identity-&gt;GetKey(identityKey);</span>
<a href="#l17.1338"></a><span id="l17.1338">     sendParms.AppendASCII(identityKey.get());</span>
<a href="#l17.1339"></a><span id="l17.1339"> </span>
<a href="#l17.1340"></a><span id="l17.1340" class="difflineminus">-    observerService-&gt;NotifyObservers(</span>
<a href="#l17.1341"></a><span id="l17.1341" class="difflineminus">-      NS_ISUPPORTS_CAST(nsIMsgCompose*, this),</span>
<a href="#l17.1342"></a><span id="l17.1342" class="difflineminus">-      &quot;mail-set-sender&quot;,</span>
<a href="#l17.1343"></a><span id="l17.1343" class="difflineminus">-      sendParms.get());</span>
<a href="#l17.1344"></a><span id="l17.1344" class="difflineminus">-</span>
<a href="#l17.1345"></a><span id="l17.1345" class="difflineminus">-    if (!mMsgSend)</span>
<a href="#l17.1346"></a><span id="l17.1346" class="difflineminus">-      mMsgSend = do_CreateInstance(NS_MSGSEND_CONTRACTID);</span>
<a href="#l17.1347"></a><span id="l17.1347" class="difflineminus">-</span>
<a href="#l17.1348"></a><span id="l17.1348" class="difflineminus">-    if (mMsgSend)</span>
<a href="#l17.1349"></a><span id="l17.1349" class="difflineminus">-    {</span>
<a href="#l17.1350"></a><span id="l17.1350" class="difflineplus">+    observerService-&gt;NotifyObservers(NS_ISUPPORTS_CAST(nsIMsgCompose *, this),</span>
<a href="#l17.1351"></a><span id="l17.1351" class="difflineplus">+                                     &quot;mail-set-sender&quot;, sendParms.get());</span>
<a href="#l17.1352"></a><span id="l17.1352" class="difflineplus">+</span>
<a href="#l17.1353"></a><span id="l17.1353" class="difflineplus">+    if (!mMsgSend) mMsgSend = do_CreateInstance(NS_MSGSEND_CONTRACTID);</span>
<a href="#l17.1354"></a><span id="l17.1354" class="difflineplus">+</span>
<a href="#l17.1355"></a><span id="l17.1355" class="difflineplus">+    if (mMsgSend) {</span>
<a href="#l17.1356"></a><span id="l17.1356">       nsCString bodyString(m_compFields-&gt;GetBody());</span>
<a href="#l17.1357"></a><span id="l17.1357"> </span>
<a href="#l17.1358"></a><span id="l17.1358">       // Create the listener for the send operation...</span>
<a href="#l17.1359"></a><span id="l17.1359" class="difflineminus">-      nsCOMPtr&lt;nsIMsgComposeSendListener&gt; composeSendListener = do_CreateInstance(NS_MSGCOMPOSESENDLISTENER_CONTRACTID);</span>
<a href="#l17.1360"></a><span id="l17.1360" class="difflineminus">-      if (!composeSendListener)</span>
<a href="#l17.1361"></a><span id="l17.1361" class="difflineminus">-        return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l17.1362"></a><span id="l17.1362" class="difflineplus">+      nsCOMPtr&lt;nsIMsgComposeSendListener&gt; composeSendListener =</span>
<a href="#l17.1363"></a><span id="l17.1363" class="difflineplus">+          do_CreateInstance(NS_MSGCOMPOSESENDLISTENER_CONTRACTID);</span>
<a href="#l17.1364"></a><span id="l17.1364" class="difflineplus">+      if (!composeSendListener) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l17.1365"></a><span id="l17.1365"> </span>
<a href="#l17.1366"></a><span id="l17.1366">       // right now, AutoSaveAsDraft is identical to SaveAsDraft as</span>
<a href="#l17.1367"></a><span id="l17.1367">       // far as the msg send code is concerned. This way, we don't have</span>
<a href="#l17.1368"></a><span id="l17.1368">       // to add an nsMsgDeliverMode for autosaveasdraft, and add cases for</span>
<a href="#l17.1369"></a><span id="l17.1369">       // it in the msg send code.</span>
<a href="#l17.1370"></a><span id="l17.1370">       if (deliverMode == nsIMsgCompDeliverMode::AutoSaveAsDraft)</span>
<a href="#l17.1371"></a><span id="l17.1371">         deliverMode = nsIMsgCompDeliverMode::SaveAsDraft;</span>
<a href="#l17.1372"></a><span id="l17.1372"> </span>
<a href="#l17.1373"></a><span id="l17.1373">       RefPtr&lt;nsIMsgCompose&gt; msgCompose(this);</span>
<a href="#l17.1374"></a><span id="l17.1374">       composeSendListener-&gt;SetMsgCompose(msgCompose);</span>
<a href="#l17.1375"></a><span id="l17.1375">       composeSendListener-&gt;SetDeliverMode(deliverMode);</span>
<a href="#l17.1376"></a><span id="l17.1376"> </span>
<a href="#l17.1377"></a><span id="l17.1377" class="difflineminus">-      if (mProgress)</span>
<a href="#l17.1378"></a><span id="l17.1378" class="difflineminus">-      {</span>
<a href="#l17.1379"></a><span id="l17.1379" class="difflineminus">-        nsCOMPtr&lt;nsIWebProgressListener&gt; progressListener = do_QueryInterface(composeSendListener);</span>
<a href="#l17.1380"></a><span id="l17.1380" class="difflineplus">+      if (mProgress) {</span>
<a href="#l17.1381"></a><span id="l17.1381" class="difflineplus">+        nsCOMPtr&lt;nsIWebProgressListener&gt; progressListener =</span>
<a href="#l17.1382"></a><span id="l17.1382" class="difflineplus">+            do_QueryInterface(composeSendListener);</span>
<a href="#l17.1383"></a><span id="l17.1383">         mProgress-&gt;RegisterListener(progressListener);</span>
<a href="#l17.1384"></a><span id="l17.1384">       }</span>
<a href="#l17.1385"></a><span id="l17.1385"> </span>
<a href="#l17.1386"></a><span id="l17.1386">       // If we are composing HTML, then this should be sent as</span>
<a href="#l17.1387"></a><span id="l17.1387">       // multipart/related which means we pass the editor into the</span>
<a href="#l17.1388"></a><span id="l17.1388">       // backend...if not, just pass nullptr</span>
<a href="#l17.1389"></a><span id="l17.1389">       //</span>
<a href="#l17.1390"></a><span id="l17.1390" class="difflineminus">-      nsCOMPtr&lt;nsIMsgSendListener&gt; sendListener = do_QueryInterface(composeSendListener);</span>
<a href="#l17.1391"></a><span id="l17.1391" class="difflineplus">+      nsCOMPtr&lt;nsIMsgSendListener&gt; sendListener =</span>
<a href="#l17.1392"></a><span id="l17.1392" class="difflineplus">+          do_QueryInterface(composeSendListener);</span>
<a href="#l17.1393"></a><span id="l17.1393">       rv = mMsgSend-&gt;CreateAndSendMessage(</span>
<a href="#l17.1394"></a><span id="l17.1394" class="difflineminus">-                    m_composeHTML ? m_editor.get() : nullptr,</span>
<a href="#l17.1395"></a><span id="l17.1395" class="difflineminus">-                    identity,</span>
<a href="#l17.1396"></a><span id="l17.1396" class="difflineminus">-                    accountKey,</span>
<a href="#l17.1397"></a><span id="l17.1397" class="difflineminus">-                    m_compFields,</span>
<a href="#l17.1398"></a><span id="l17.1398" class="difflineminus">-                    false,</span>
<a href="#l17.1399"></a><span id="l17.1399" class="difflineminus">-                    false,</span>
<a href="#l17.1400"></a><span id="l17.1400" class="difflineminus">-                    (nsMsgDeliverMode)deliverMode,</span>
<a href="#l17.1401"></a><span id="l17.1401" class="difflineminus">-                    nullptr,</span>
<a href="#l17.1402"></a><span id="l17.1402" class="difflineminus">-                    m_composeHTML ? TEXT_HTML : TEXT_PLAIN,</span>
<a href="#l17.1403"></a><span id="l17.1403" class="difflineminus">-                    bodyString,</span>
<a href="#l17.1404"></a><span id="l17.1404" class="difflineminus">-                    nullptr,</span>
<a href="#l17.1405"></a><span id="l17.1405" class="difflineminus">-                    nullptr,</span>
<a href="#l17.1406"></a><span id="l17.1406" class="difflineminus">-                    m_window,</span>
<a href="#l17.1407"></a><span id="l17.1407" class="difflineminus">-                    mProgress,</span>
<a href="#l17.1408"></a><span id="l17.1408" class="difflineminus">-                    sendListener,</span>
<a href="#l17.1409"></a><span id="l17.1409" class="difflineminus">-                    mSmtpPassword,</span>
<a href="#l17.1410"></a><span id="l17.1410" class="difflineminus">-                    mOriginalMsgURI,</span>
<a href="#l17.1411"></a><span id="l17.1411" class="difflineminus">-                    mType);</span>
<a href="#l17.1412"></a><span id="l17.1412" class="difflineminus">-    }</span>
<a href="#l17.1413"></a><span id="l17.1413" class="difflineminus">-    else</span>
<a href="#l17.1414"></a><span id="l17.1414" class="difflineminus">-        rv = NS_ERROR_FAILURE;</span>
<a href="#l17.1415"></a><span id="l17.1415" class="difflineminus">-  }</span>
<a href="#l17.1416"></a><span id="l17.1416" class="difflineminus">-  else</span>
<a href="#l17.1417"></a><span id="l17.1417" class="difflineplus">+          m_composeHTML ? m_editor.get() : nullptr, identity, accountKey,</span>
<a href="#l17.1418"></a><span id="l17.1418" class="difflineplus">+          m_compFields, false, false, (nsMsgDeliverMode)deliverMode, nullptr,</span>
<a href="#l17.1419"></a><span id="l17.1419" class="difflineplus">+          m_composeHTML ? TEXT_HTML : TEXT_PLAIN, bodyString, nullptr, nullptr,</span>
<a href="#l17.1420"></a><span id="l17.1420" class="difflineplus">+          m_window, mProgress, sendListener, mSmtpPassword, mOriginalMsgURI,</span>
<a href="#l17.1421"></a><span id="l17.1421" class="difflineplus">+          mType);</span>
<a href="#l17.1422"></a><span id="l17.1422" class="difflineplus">+    } else</span>
<a href="#l17.1423"></a><span id="l17.1423" class="difflineplus">+      rv = NS_ERROR_FAILURE;</span>
<a href="#l17.1424"></a><span id="l17.1424" class="difflineplus">+  } else</span>
<a href="#l17.1425"></a><span id="l17.1425">     rv = NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l17.1426"></a><span id="l17.1426"> </span>
<a href="#l17.1427"></a><span id="l17.1427">   if (NS_FAILED(rv))</span>
<a href="#l17.1428"></a><span id="l17.1428">     NotifyStateListeners(nsIMsgComposeNotificationType::ComposeProcessDone, rv);</span>
<a href="#l17.1429"></a><span id="l17.1429"> </span>
<a href="#l17.1430"></a><span id="l17.1430">   return rv;</span>
<a href="#l17.1431"></a><span id="l17.1431"> }</span>
<a href="#l17.1432"></a><span id="l17.1432"> </span>
<a href="#l17.1433"></a><span id="l17.1433" class="difflineminus">-NS_IMETHODIMP nsMsgCompose::SendMsg(MSG_DeliverMode deliverMode, nsIMsgIdentity *identity, const char *accountKey, nsIMsgWindow *aMsgWindow, nsIMsgProgress *progress)</span>
<a href="#l17.1434"></a><span id="l17.1434" class="difflineminus">-{</span>
<a href="#l17.1435"></a><span id="l17.1435" class="difflineplus">+NS_IMETHODIMP nsMsgCompose::SendMsg(MSG_DeliverMode deliverMode,</span>
<a href="#l17.1436"></a><span id="l17.1436" class="difflineplus">+                                    nsIMsgIdentity *identity,</span>
<a href="#l17.1437"></a><span id="l17.1437" class="difflineplus">+                                    const char *accountKey,</span>
<a href="#l17.1438"></a><span id="l17.1438" class="difflineplus">+                                    nsIMsgWindow *aMsgWindow,</span>
<a href="#l17.1439"></a><span id="l17.1439" class="difflineplus">+                                    nsIMsgProgress *progress) {</span>
<a href="#l17.1440"></a><span id="l17.1440">   NS_ENSURE_TRUE(m_compFields, NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l17.1441"></a><span id="l17.1441">   nsresult rv = NS_OK;</span>
<a href="#l17.1442"></a><span id="l17.1442">   nsCOMPtr&lt;nsIPrompt&gt; prompt;</span>
<a href="#l17.1443"></a><span id="l17.1443"> </span>
<a href="#l17.1444"></a><span id="l17.1444">   // i'm assuming the compose window is still up at this point...</span>
<a href="#l17.1445"></a><span id="l17.1445">   if (m_window) {</span>
<a href="#l17.1446"></a><span id="l17.1446">     nsCOMPtr&lt;nsPIDOMWindowOuter&gt; window = nsPIDOMWindowOuter::From(m_window);</span>
<a href="#l17.1447"></a><span id="l17.1447">     window-&gt;GetPrompter(getter_AddRefs(prompt));</span>
<a href="#l17.1448"></a><span id="l17.1448">   }</span>
<a href="#l17.1449"></a><span id="l17.1449"> </span>
<a href="#l17.1450"></a><span id="l17.1450">   // Set content type based on which type of compose window we had.</span>
<a href="#l17.1451"></a><span id="l17.1451" class="difflineminus">-  nsString contentType = (m_composeHTML) ? NS_LITERAL_STRING(&quot;text/html&quot;):</span>
<a href="#l17.1452"></a><span id="l17.1452" class="difflineminus">-                                           NS_LITERAL_STRING(&quot;text/plain&quot;);</span>
<a href="#l17.1453"></a><span id="l17.1453" class="difflineplus">+  nsString contentType = (m_composeHTML) ? NS_LITERAL_STRING(&quot;text/html&quot;)</span>
<a href="#l17.1454"></a><span id="l17.1454" class="difflineplus">+                                         : NS_LITERAL_STRING(&quot;text/plain&quot;);</span>
<a href="#l17.1455"></a><span id="l17.1455">   nsString msgBody;</span>
<a href="#l17.1456"></a><span id="l17.1456">   const char *charset = m_compFields-&gt;GetCharacterSet();</span>
<a href="#l17.1457"></a><span id="l17.1457" class="difflineminus">-  if (m_editor)</span>
<a href="#l17.1458"></a><span id="l17.1458" class="difflineminus">-  {</span>
<a href="#l17.1459"></a><span id="l17.1459" class="difflineplus">+  if (m_editor) {</span>
<a href="#l17.1460"></a><span id="l17.1460">     // Reset message body previously stored in the compose fields</span>
<a href="#l17.1461"></a><span id="l17.1461" class="difflineminus">-    // There is 2 nsIMsgCompFields::SetBody() functions using a pointer as argument,</span>
<a href="#l17.1462"></a><span id="l17.1462" class="difflineminus">-    // therefore a casting is required.</span>
<a href="#l17.1463"></a><span id="l17.1463" class="difflineplus">+    // There is 2 nsIMsgCompFields::SetBody() functions using a pointer as</span>
<a href="#l17.1464"></a><span id="l17.1464" class="difflineplus">+    // argument, therefore a casting is required.</span>
<a href="#l17.1465"></a><span id="l17.1465">     m_compFields-&gt;SetBody((const char *)nullptr);</span>
<a href="#l17.1466"></a><span id="l17.1466"> </span>
<a href="#l17.1467"></a><span id="l17.1467">     uint32_t flags = nsIDocumentEncoder::OutputCRLineBreak |</span>
<a href="#l17.1468"></a><span id="l17.1468">                      nsIDocumentEncoder::OutputLFLineBreak;</span>
<a href="#l17.1469"></a><span id="l17.1469"> </span>
<a href="#l17.1470"></a><span id="l17.1470">     if (m_composeHTML) {</span>
<a href="#l17.1471"></a><span id="l17.1471">       flags |= nsIDocumentEncoder::OutputFormatted |</span>
<a href="#l17.1472"></a><span id="l17.1472">                nsIDocumentEncoder::OutputDisallowLineBreaking;</span>
<a href="#l17.1473"></a><span id="l17.1473">     } else {</span>
<a href="#l17.1474"></a><span id="l17.1474">       bool flowed, delsp, formatted, disallowBreaks;</span>
<a href="#l17.1475"></a><span id="l17.1475">       GetSerialiserFlags(charset, &amp;flowed, &amp;delsp, &amp;formatted, &amp;disallowBreaks);</span>
<a href="#l17.1476"></a><span id="l17.1476" class="difflineminus">-      if (flowed)</span>
<a href="#l17.1477"></a><span id="l17.1477" class="difflineminus">-        flags |= nsIDocumentEncoder::OutputFormatFlowed;</span>
<a href="#l17.1478"></a><span id="l17.1478" class="difflineminus">-      if (delsp)</span>
<a href="#l17.1479"></a><span id="l17.1479" class="difflineminus">-        flags |= nsIDocumentEncoder::OutputFormatDelSp;</span>
<a href="#l17.1480"></a><span id="l17.1480" class="difflineminus">-      if (formatted)</span>
<a href="#l17.1481"></a><span id="l17.1481" class="difflineminus">-        flags |= nsIDocumentEncoder::OutputFormatted;</span>
<a href="#l17.1482"></a><span id="l17.1482" class="difflineplus">+      if (flowed) flags |= nsIDocumentEncoder::OutputFormatFlowed;</span>
<a href="#l17.1483"></a><span id="l17.1483" class="difflineplus">+      if (delsp) flags |= nsIDocumentEncoder::OutputFormatDelSp;</span>
<a href="#l17.1484"></a><span id="l17.1484" class="difflineplus">+      if (formatted) flags |= nsIDocumentEncoder::OutputFormatted;</span>
<a href="#l17.1485"></a><span id="l17.1485">       if (disallowBreaks)</span>
<a href="#l17.1486"></a><span id="l17.1486">         flags |= nsIDocumentEncoder::OutputDisallowLineBreaking;</span>
<a href="#l17.1487"></a><span id="l17.1487">       // Don't lose NBSP in the plain text encoder.</span>
<a href="#l17.1488"></a><span id="l17.1488">       flags |= nsIDocumentEncoder::OutputPersistNBSP;</span>
<a href="#l17.1489"></a><span id="l17.1489">     }</span>
<a href="#l17.1490"></a><span id="l17.1490">     rv = m_editor-&gt;OutputToString(contentType, flags, msgBody);</span>
<a href="#l17.1491"></a><span id="l17.1491">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.1492"></a><span id="l17.1492" class="difflineminus">-  }</span>
<a href="#l17.1493"></a><span id="l17.1493" class="difflineminus">-  else</span>
<a href="#l17.1494"></a><span id="l17.1494" class="difflineminus">-  {</span>
<a href="#l17.1495"></a><span id="l17.1495" class="difflineplus">+  } else {</span>
<a href="#l17.1496"></a><span id="l17.1496">     m_compFields-&gt;GetBody(msgBody);</span>
<a href="#l17.1497"></a><span id="l17.1497">   }</span>
<a href="#l17.1498"></a><span id="l17.1498" class="difflineminus">-  if (!msgBody.IsEmpty())</span>
<a href="#l17.1499"></a><span id="l17.1499" class="difflineminus">-  {</span>
<a href="#l17.1500"></a><span id="l17.1500" class="difflineminus">-    bool isAsciiOnly = mozilla::IsAsciiNullTerminated(static_cast&lt;const char16_t*&gt;(msgBody.get()));</span>
<a href="#l17.1501"></a><span id="l17.1501" class="difflineplus">+  if (!msgBody.IsEmpty()) {</span>
<a href="#l17.1502"></a><span id="l17.1502" class="difflineplus">+    bool isAsciiOnly = mozilla::IsAsciiNullTerminated(</span>
<a href="#l17.1503"></a><span id="l17.1503" class="difflineplus">+        static_cast&lt;const char16_t *&gt;(msgBody.get()));</span>
<a href="#l17.1504"></a><span id="l17.1504">     // Convert body to mail charset</span>
<a href="#l17.1505"></a><span id="l17.1505">     nsCString outCString;</span>
<a href="#l17.1506"></a><span id="l17.1506" class="difflineminus">-    rv = nsMsgI18NConvertFromUnicode(charset ? nsDependentCString(charset) : EmptyCString(),</span>
<a href="#l17.1507"></a><span id="l17.1507" class="difflineminus">-                                     msgBody, outCString, true);</span>
<a href="#l17.1508"></a><span id="l17.1508" class="difflineminus">-    if (m_compFields-&gt;GetForceMsgEncoding())</span>
<a href="#l17.1509"></a><span id="l17.1509" class="difflineminus">-      isAsciiOnly = false;</span>
<a href="#l17.1510"></a><span id="l17.1510" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; !outCString.IsEmpty())</span>
<a href="#l17.1511"></a><span id="l17.1511" class="difflineminus">-    {</span>
<a href="#l17.1512"></a><span id="l17.1512" class="difflineplus">+    rv = nsMsgI18NConvertFromUnicode(</span>
<a href="#l17.1513"></a><span id="l17.1513" class="difflineplus">+        charset ? nsDependentCString(charset) : EmptyCString(), msgBody,</span>
<a href="#l17.1514"></a><span id="l17.1514" class="difflineplus">+        outCString, true);</span>
<a href="#l17.1515"></a><span id="l17.1515" class="difflineplus">+    if (m_compFields-&gt;GetForceMsgEncoding()) isAsciiOnly = false;</span>
<a href="#l17.1516"></a><span id="l17.1516" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; !outCString.IsEmpty()) {</span>
<a href="#l17.1517"></a><span id="l17.1517">       // If the body contains characters outside the repertoire of the current</span>
<a href="#l17.1518"></a><span id="l17.1518">       // charset, just convert to UTF-8 and be done with it</span>
<a href="#l17.1519"></a><span id="l17.1519">       // unless disable_fallback_to_utf8 is set for this charset.</span>
<a href="#l17.1520"></a><span id="l17.1520" class="difflineminus">-      if (NS_ERROR_UENC_NOMAPPING == rv)</span>
<a href="#l17.1521"></a><span id="l17.1521" class="difflineminus">-      {</span>
<a href="#l17.1522"></a><span id="l17.1522" class="difflineplus">+      if (NS_ERROR_UENC_NOMAPPING == rv) {</span>
<a href="#l17.1523"></a><span id="l17.1523">         bool needToCheckCharset;</span>
<a href="#l17.1524"></a><span id="l17.1524">         m_compFields-&gt;GetNeedToCheckCharset(&amp;needToCheckCharset);</span>
<a href="#l17.1525"></a><span id="l17.1525" class="difflineminus">-        if (needToCheckCharset)</span>
<a href="#l17.1526"></a><span id="l17.1526" class="difflineminus">-        {</span>
<a href="#l17.1527"></a><span id="l17.1527" class="difflineplus">+        if (needToCheckCharset) {</span>
<a href="#l17.1528"></a><span id="l17.1528">           bool disableFallback = false;</span>
<a href="#l17.1529"></a><span id="l17.1529" class="difflineminus">-          nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch (do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l17.1530"></a><span id="l17.1530" class="difflineminus">-          if (prefBranch &amp;&amp; charset)</span>
<a href="#l17.1531"></a><span id="l17.1531" class="difflineminus">-          {</span>
<a href="#l17.1532"></a><span id="l17.1532" class="difflineplus">+          nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(</span>
<a href="#l17.1533"></a><span id="l17.1533" class="difflineplus">+              do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l17.1534"></a><span id="l17.1534" class="difflineplus">+          if (prefBranch &amp;&amp; charset) {</span>
<a href="#l17.1535"></a><span id="l17.1535">             nsCString prefName(&quot;mailnews.disable_fallback_to_utf8.&quot;);</span>
<a href="#l17.1536"></a><span id="l17.1536">             prefName.Append(charset);</span>
<a href="#l17.1537"></a><span id="l17.1537">             prefBranch-&gt;GetBoolPref(prefName.get(), &amp;disableFallback);</span>
<a href="#l17.1538"></a><span id="l17.1538">           }</span>
<a href="#l17.1539"></a><span id="l17.1539" class="difflineminus">-          if (!disableFallback)</span>
<a href="#l17.1540"></a><span id="l17.1540" class="difflineminus">-          {</span>
<a href="#l17.1541"></a><span id="l17.1541" class="difflineplus">+          if (!disableFallback) {</span>
<a href="#l17.1542"></a><span id="l17.1542">             CopyUTF16toUTF8(msgBody, outCString);</span>
<a href="#l17.1543"></a><span id="l17.1543">             m_compFields-&gt;SetCharacterSet(&quot;UTF-8&quot;);</span>
<a href="#l17.1544"></a><span id="l17.1544">             SetDocumentCharset(&quot;UTF-8&quot;);</span>
<a href="#l17.1545"></a><span id="l17.1545">           }</span>
<a href="#l17.1546"></a><span id="l17.1546">         }</span>
<a href="#l17.1547"></a><span id="l17.1547">       }</span>
<a href="#l17.1548"></a><span id="l17.1548">       m_compFields-&gt;SetBodyIsAsciiOnly(isAsciiOnly);</span>
<a href="#l17.1549"></a><span id="l17.1549">       m_compFields-&gt;SetBody(outCString.get());</span>
<a href="#l17.1550"></a><span id="l17.1550" class="difflineminus">-    }</span>
<a href="#l17.1551"></a><span id="l17.1551" class="difflineminus">-    else</span>
<a href="#l17.1552"></a><span id="l17.1552" class="difflineminus">-    {</span>
<a href="#l17.1553"></a><span id="l17.1553" class="difflineplus">+    } else {</span>
<a href="#l17.1554"></a><span id="l17.1554">       m_compFields-&gt;SetBody(NS_ConvertUTF16toUTF8(msgBody).get());</span>
<a href="#l17.1555"></a><span id="l17.1555">       m_compFields-&gt;SetCharacterSet(&quot;UTF-8&quot;);</span>
<a href="#l17.1556"></a><span id="l17.1556">       SetDocumentCharset(&quot;UTF-8&quot;);</span>
<a href="#l17.1557"></a><span id="l17.1557">     }</span>
<a href="#l17.1558"></a><span id="l17.1558">   }</span>
<a href="#l17.1559"></a><span id="l17.1559"> </span>
<a href="#l17.1560"></a><span id="l17.1560">   // Let's open the progress dialog</span>
<a href="#l17.1561"></a><span id="l17.1561" class="difflineminus">-  if (progress)</span>
<a href="#l17.1562"></a><span id="l17.1562" class="difflineminus">-  {</span>
<a href="#l17.1563"></a><span id="l17.1563" class="difflineplus">+  if (progress) {</span>
<a href="#l17.1564"></a><span id="l17.1564">     mProgress = progress;</span>
<a href="#l17.1565"></a><span id="l17.1565"> </span>
<a href="#l17.1566"></a><span id="l17.1566" class="difflineminus">-    if (deliverMode != nsIMsgCompDeliverMode::AutoSaveAsDraft)</span>
<a href="#l17.1567"></a><span id="l17.1567" class="difflineminus">-    {</span>
<a href="#l17.1568"></a><span id="l17.1568" class="difflineplus">+    if (deliverMode != nsIMsgCompDeliverMode::AutoSaveAsDraft) {</span>
<a href="#l17.1569"></a><span id="l17.1569">       nsAutoString msgSubject;</span>
<a href="#l17.1570"></a><span id="l17.1570">       m_compFields-&gt;GetSubject(msgSubject);</span>
<a href="#l17.1571"></a><span id="l17.1571"> </span>
<a href="#l17.1572"></a><span id="l17.1572">       bool showProgress = false;</span>
<a href="#l17.1573"></a><span id="l17.1573" class="difflineminus">-      nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch (do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l17.1574"></a><span id="l17.1574" class="difflineminus">-      if (prefBranch)</span>
<a href="#l17.1575"></a><span id="l17.1575" class="difflineminus">-      {</span>
<a href="#l17.1576"></a><span id="l17.1576" class="difflineplus">+      nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(</span>
<a href="#l17.1577"></a><span id="l17.1577" class="difflineplus">+          do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l17.1578"></a><span id="l17.1578" class="difflineplus">+      if (prefBranch) {</span>
<a href="#l17.1579"></a><span id="l17.1579">         prefBranch-&gt;GetBoolPref(&quot;mailnews.show_send_progress&quot;, &amp;showProgress);</span>
<a href="#l17.1580"></a><span id="l17.1580" class="difflineminus">-        if (showProgress)</span>
<a href="#l17.1581"></a><span id="l17.1581" class="difflineminus">-        {</span>
<a href="#l17.1582"></a><span id="l17.1582" class="difflineminus">-          nsCOMPtr&lt;nsIMsgComposeProgressParams&gt; params = do_CreateInstance(NS_MSGCOMPOSEPROGRESSPARAMS_CONTRACTID, &amp;rv);</span>
<a href="#l17.1583"></a><span id="l17.1583" class="difflineminus">-          if (NS_FAILED(rv) || !params)</span>
<a href="#l17.1584"></a><span id="l17.1584" class="difflineminus">-            return NS_ERROR_FAILURE;</span>
<a href="#l17.1585"></a><span id="l17.1585" class="difflineplus">+        if (showProgress) {</span>
<a href="#l17.1586"></a><span id="l17.1586" class="difflineplus">+          nsCOMPtr&lt;nsIMsgComposeProgressParams&gt; params =</span>
<a href="#l17.1587"></a><span id="l17.1587" class="difflineplus">+              do_CreateInstance(NS_MSGCOMPOSEPROGRESSPARAMS_CONTRACTID, &amp;rv);</span>
<a href="#l17.1588"></a><span id="l17.1588" class="difflineplus">+          if (NS_FAILED(rv) || !params) return NS_ERROR_FAILURE;</span>
<a href="#l17.1589"></a><span id="l17.1589"> </span>
<a href="#l17.1590"></a><span id="l17.1590">           params-&gt;SetSubject(msgSubject.get());</span>
<a href="#l17.1591"></a><span id="l17.1591">           params-&gt;SetDeliveryMode(deliverMode);</span>
<a href="#l17.1592"></a><span id="l17.1592"> </span>
<a href="#l17.1593"></a><span id="l17.1593" class="difflineminus">-          mProgress-&gt;OpenProgressDialog(m_window, aMsgWindow,</span>
<a href="#l17.1594"></a><span id="l17.1594" class="difflineminus">-                                        &quot;chrome://messenger/content/messengercompose/sendProgress.xul&quot;,</span>
<a href="#l17.1595"></a><span id="l17.1595" class="difflineminus">-                                        false, params);</span>
<a href="#l17.1596"></a><span id="l17.1596" class="difflineplus">+          mProgress-&gt;OpenProgressDialog(</span>
<a href="#l17.1597"></a><span id="l17.1597" class="difflineplus">+              m_window, aMsgWindow,</span>
<a href="#l17.1598"></a><span id="l17.1598" class="difflineplus">+              &quot;chrome://messenger/content/messengercompose/sendProgress.xul&quot;,</span>
<a href="#l17.1599"></a><span id="l17.1599" class="difflineplus">+              false, params);</span>
<a href="#l17.1600"></a><span id="l17.1600">         }</span>
<a href="#l17.1601"></a><span id="l17.1601">       }</span>
<a href="#l17.1602"></a><span id="l17.1602">     }</span>
<a href="#l17.1603"></a><span id="l17.1603"> </span>
<a href="#l17.1604"></a><span id="l17.1604" class="difflineminus">-    mProgress-&gt;OnStateChange(nullptr, nullptr, nsIWebProgressListener::STATE_START, NS_OK);</span>
<a href="#l17.1605"></a><span id="l17.1605" class="difflineplus">+    mProgress-&gt;OnStateChange(nullptr, nullptr,</span>
<a href="#l17.1606"></a><span id="l17.1606" class="difflineplus">+                             nsIWebProgressListener::STATE_START, NS_OK);</span>
<a href="#l17.1607"></a><span id="l17.1607">   }</span>
<a href="#l17.1608"></a><span id="l17.1608"> </span>
<a href="#l17.1609"></a><span id="l17.1609">   bool attachVCard = false;</span>
<a href="#l17.1610"></a><span id="l17.1610">   m_compFields-&gt;GetAttachVCard(&amp;attachVCard);</span>
<a href="#l17.1611"></a><span id="l17.1611"> </span>
<a href="#l17.1612"></a><span id="l17.1612">   if (attachVCard &amp;&amp; identity &amp;&amp;</span>
<a href="#l17.1613"></a><span id="l17.1613">       (deliverMode == nsIMsgCompDeliverMode::Now ||</span>
<a href="#l17.1614"></a><span id="l17.1614">        deliverMode == nsIMsgCompDeliverMode::Later ||</span>
<a href="#l17.1615"></a><span id="l17.1615" class="difflineminus">-       deliverMode == nsIMsgCompDeliverMode::Background))</span>
<a href="#l17.1616"></a><span id="l17.1616" class="difflineminus">-  {</span>
<a href="#l17.1617"></a><span id="l17.1617" class="difflineminus">-      nsCString escapedVCard;</span>
<a href="#l17.1618"></a><span id="l17.1618" class="difflineminus">-      // make sure, if there is no card, this returns an empty string, or NS_ERROR_FAILURE</span>
<a href="#l17.1619"></a><span id="l17.1619" class="difflineminus">-      rv = identity-&gt;GetEscapedVCard(escapedVCard);</span>
<a href="#l17.1620"></a><span id="l17.1620" class="difflineminus">-</span>
<a href="#l17.1621"></a><span id="l17.1621" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; !escapedVCard.IsEmpty())</span>
<a href="#l17.1622"></a><span id="l17.1622" class="difflineminus">-      {</span>
<a href="#l17.1623"></a><span id="l17.1623" class="difflineminus">-          nsCString vCardUrl;</span>
<a href="#l17.1624"></a><span id="l17.1624" class="difflineminus">-          vCardUrl = &quot;data:text/x-vcard;charset=utf-8;base64,&quot;;</span>
<a href="#l17.1625"></a><span id="l17.1625" class="difflineminus">-          nsCString unescapedData;</span>
<a href="#l17.1626"></a><span id="l17.1626" class="difflineminus">-          MsgUnescapeString(escapedVCard, 0, unescapedData);</span>
<a href="#l17.1627"></a><span id="l17.1627" class="difflineminus">-          char *result = PL_Base64Encode(unescapedData.get(), 0, nullptr);</span>
<a href="#l17.1628"></a><span id="l17.1628" class="difflineminus">-          vCardUrl += result;</span>
<a href="#l17.1629"></a><span id="l17.1629" class="difflineminus">-          PR_Free(result);</span>
<a href="#l17.1630"></a><span id="l17.1630" class="difflineminus">-</span>
<a href="#l17.1631"></a><span id="l17.1631" class="difflineminus">-          nsCOMPtr&lt;nsIMsgAttachment&gt; attachment = do_CreateInstance(NS_MSGATTACHMENT_CONTRACTID, &amp;rv);</span>
<a href="#l17.1632"></a><span id="l17.1632" class="difflineminus">-          if (NS_SUCCEEDED(rv) &amp;&amp; attachment)</span>
<a href="#l17.1633"></a><span id="l17.1633" class="difflineminus">-          {</span>
<a href="#l17.1634"></a><span id="l17.1634" class="difflineminus">-              // [comment from 4.x]</span>
<a href="#l17.1635"></a><span id="l17.1635" class="difflineminus">-              // Send the vCard out with a filename which distinguishes this user. e.g. jsmith.vcf</span>
<a href="#l17.1636"></a><span id="l17.1636" class="difflineminus">-              // The main reason to do this is for interop with Eudora, which saves off</span>
<a href="#l17.1637"></a><span id="l17.1637" class="difflineminus">-              // the attachments separately from the message body</span>
<a href="#l17.1638"></a><span id="l17.1638" class="difflineminus">-              nsCString userid;</span>
<a href="#l17.1639"></a><span id="l17.1639" class="difflineminus">-              (void)identity-&gt;GetEmail(userid);</span>
<a href="#l17.1640"></a><span id="l17.1640" class="difflineminus">-              int32_t index = userid.FindChar('@');</span>
<a href="#l17.1641"></a><span id="l17.1641" class="difflineminus">-              if (index != kNotFound)</span>
<a href="#l17.1642"></a><span id="l17.1642" class="difflineminus">-                  userid.SetLength(index);</span>
<a href="#l17.1643"></a><span id="l17.1643" class="difflineminus">-</span>
<a href="#l17.1644"></a><span id="l17.1644" class="difflineminus">-              if (userid.IsEmpty())</span>
<a href="#l17.1645"></a><span id="l17.1645" class="difflineminus">-                  attachment-&gt;SetName(NS_LITERAL_STRING(&quot;vcard.vcf&quot;));</span>
<a href="#l17.1646"></a><span id="l17.1646" class="difflineminus">-              else</span>
<a href="#l17.1647"></a><span id="l17.1647" class="difflineminus">-              {</span>
<a href="#l17.1648"></a><span id="l17.1648" class="difflineminus">-                  // Replace any dot with underscore to stop vCards</span>
<a href="#l17.1649"></a><span id="l17.1649" class="difflineminus">-                  // generating false positives with some heuristic scanners</span>
<a href="#l17.1650"></a><span id="l17.1650" class="difflineminus">-                  MsgReplaceChar(userid, '.', '_');</span>
<a href="#l17.1651"></a><span id="l17.1651" class="difflineminus">-                  userid.AppendLiteral(&quot;.vcf&quot;);</span>
<a href="#l17.1652"></a><span id="l17.1652" class="difflineminus">-                  attachment-&gt;SetName(NS_ConvertASCIItoUTF16(userid));</span>
<a href="#l17.1653"></a><span id="l17.1653" class="difflineminus">-              }</span>
<a href="#l17.1654"></a><span id="l17.1654" class="difflineminus">-</span>
<a href="#l17.1655"></a><span id="l17.1655" class="difflineminus">-              attachment-&gt;SetUrl(vCardUrl);</span>
<a href="#l17.1656"></a><span id="l17.1656" class="difflineminus">-              m_compFields-&gt;AddAttachment(attachment);</span>
<a href="#l17.1657"></a><span id="l17.1657" class="difflineminus">-          }</span>
<a href="#l17.1658"></a><span id="l17.1658" class="difflineplus">+       deliverMode == nsIMsgCompDeliverMode::Background)) {</span>
<a href="#l17.1659"></a><span id="l17.1659" class="difflineplus">+    nsCString escapedVCard;</span>
<a href="#l17.1660"></a><span id="l17.1660" class="difflineplus">+    // make sure, if there is no card, this returns an empty string, or</span>
<a href="#l17.1661"></a><span id="l17.1661" class="difflineplus">+    // NS_ERROR_FAILURE</span>
<a href="#l17.1662"></a><span id="l17.1662" class="difflineplus">+    rv = identity-&gt;GetEscapedVCard(escapedVCard);</span>
<a href="#l17.1663"></a><span id="l17.1663" class="difflineplus">+</span>
<a href="#l17.1664"></a><span id="l17.1664" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; !escapedVCard.IsEmpty()) {</span>
<a href="#l17.1665"></a><span id="l17.1665" class="difflineplus">+      nsCString vCardUrl;</span>
<a href="#l17.1666"></a><span id="l17.1666" class="difflineplus">+      vCardUrl = &quot;data:text/x-vcard;charset=utf-8;base64,&quot;;</span>
<a href="#l17.1667"></a><span id="l17.1667" class="difflineplus">+      nsCString unescapedData;</span>
<a href="#l17.1668"></a><span id="l17.1668" class="difflineplus">+      MsgUnescapeString(escapedVCard, 0, unescapedData);</span>
<a href="#l17.1669"></a><span id="l17.1669" class="difflineplus">+      char *result = PL_Base64Encode(unescapedData.get(), 0, nullptr);</span>
<a href="#l17.1670"></a><span id="l17.1670" class="difflineplus">+      vCardUrl += result;</span>
<a href="#l17.1671"></a><span id="l17.1671" class="difflineplus">+      PR_Free(result);</span>
<a href="#l17.1672"></a><span id="l17.1672" class="difflineplus">+</span>
<a href="#l17.1673"></a><span id="l17.1673" class="difflineplus">+      nsCOMPtr&lt;nsIMsgAttachment&gt; attachment =</span>
<a href="#l17.1674"></a><span id="l17.1674" class="difflineplus">+          do_CreateInstance(NS_MSGATTACHMENT_CONTRACTID, &amp;rv);</span>
<a href="#l17.1675"></a><span id="l17.1675" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; attachment) {</span>
<a href="#l17.1676"></a><span id="l17.1676" class="difflineplus">+        // [comment from 4.x]</span>
<a href="#l17.1677"></a><span id="l17.1677" class="difflineplus">+        // Send the vCard out with a filename which distinguishes this user.</span>
<a href="#l17.1678"></a><span id="l17.1678" class="difflineplus">+        // e.g. jsmith.vcf The main reason to do this is for interop with</span>
<a href="#l17.1679"></a><span id="l17.1679" class="difflineplus">+        // Eudora, which saves off the attachments separately from the message</span>
<a href="#l17.1680"></a><span id="l17.1680" class="difflineplus">+        // body</span>
<a href="#l17.1681"></a><span id="l17.1681" class="difflineplus">+        nsCString userid;</span>
<a href="#l17.1682"></a><span id="l17.1682" class="difflineplus">+        (void)identity-&gt;GetEmail(userid);</span>
<a href="#l17.1683"></a><span id="l17.1683" class="difflineplus">+        int32_t index = userid.FindChar('@');</span>
<a href="#l17.1684"></a><span id="l17.1684" class="difflineplus">+        if (index != kNotFound) userid.SetLength(index);</span>
<a href="#l17.1685"></a><span id="l17.1685" class="difflineplus">+</span>
<a href="#l17.1686"></a><span id="l17.1686" class="difflineplus">+        if (userid.IsEmpty())</span>
<a href="#l17.1687"></a><span id="l17.1687" class="difflineplus">+          attachment-&gt;SetName(NS_LITERAL_STRING(&quot;vcard.vcf&quot;));</span>
<a href="#l17.1688"></a><span id="l17.1688" class="difflineplus">+        else {</span>
<a href="#l17.1689"></a><span id="l17.1689" class="difflineplus">+          // Replace any dot with underscore to stop vCards</span>
<a href="#l17.1690"></a><span id="l17.1690" class="difflineplus">+          // generating false positives with some heuristic scanners</span>
<a href="#l17.1691"></a><span id="l17.1691" class="difflineplus">+          MsgReplaceChar(userid, '.', '_');</span>
<a href="#l17.1692"></a><span id="l17.1692" class="difflineplus">+          userid.AppendLiteral(&quot;.vcf&quot;);</span>
<a href="#l17.1693"></a><span id="l17.1693" class="difflineplus">+          attachment-&gt;SetName(NS_ConvertASCIItoUTF16(userid));</span>
<a href="#l17.1694"></a><span id="l17.1694" class="difflineplus">+        }</span>
<a href="#l17.1695"></a><span id="l17.1695" class="difflineplus">+</span>
<a href="#l17.1696"></a><span id="l17.1696" class="difflineplus">+        attachment-&gt;SetUrl(vCardUrl);</span>
<a href="#l17.1697"></a><span id="l17.1697" class="difflineplus">+        m_compFields-&gt;AddAttachment(attachment);</span>
<a href="#l17.1698"></a><span id="l17.1698">       }</span>
<a href="#l17.1699"></a><span id="l17.1699" class="difflineplus">+    }</span>
<a href="#l17.1700"></a><span id="l17.1700">   }</span>
<a href="#l17.1701"></a><span id="l17.1701"> </span>
<a href="#l17.1702"></a><span id="l17.1702">   // Save the identity being sent for later use.</span>
<a href="#l17.1703"></a><span id="l17.1703">   m_identity = identity;</span>
<a href="#l17.1704"></a><span id="l17.1704"> </span>
<a href="#l17.1705"></a><span id="l17.1705">   rv = SendMsgToServer(deliverMode, identity, accountKey);</span>
<a href="#l17.1706"></a><span id="l17.1706" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l17.1707"></a><span id="l17.1707" class="difflineminus">-  {</span>
<a href="#l17.1708"></a><span id="l17.1708" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l17.1709"></a><span id="l17.1709">     nsCOMPtr&lt;nsIMsgSendReport&gt; sendReport;</span>
<a href="#l17.1710"></a><span id="l17.1710" class="difflineminus">-    if (mMsgSend)</span>
<a href="#l17.1711"></a><span id="l17.1711" class="difflineminus">-      mMsgSend-&gt;GetSendReport(getter_AddRefs(sendReport));</span>
<a href="#l17.1712"></a><span id="l17.1712" class="difflineminus">-    if (sendReport)</span>
<a href="#l17.1713"></a><span id="l17.1713" class="difflineminus">-    {</span>
<a href="#l17.1714"></a><span id="l17.1714" class="difflineplus">+    if (mMsgSend) mMsgSend-&gt;GetSendReport(getter_AddRefs(sendReport));</span>
<a href="#l17.1715"></a><span id="l17.1715" class="difflineplus">+    if (sendReport) {</span>
<a href="#l17.1716"></a><span id="l17.1716">       nsresult theError;</span>
<a href="#l17.1717"></a><span id="l17.1717">       sendReport-&gt;DisplayReport(prompt, true, true, &amp;theError);</span>
<a href="#l17.1718"></a><span id="l17.1718" class="difflineminus">-    }</span>
<a href="#l17.1719"></a><span id="l17.1719" class="difflineminus">-    else</span>
<a href="#l17.1720"></a><span id="l17.1720" class="difflineminus">-    {</span>
<a href="#l17.1721"></a><span id="l17.1721" class="difflineminus">-      /* If we come here it's because we got an error before we could initialize a</span>
<a href="#l17.1722"></a><span id="l17.1722" class="difflineminus">-         send report! Let's try our best...</span>
<a href="#l17.1723"></a><span id="l17.1723" class="difflineplus">+    } else {</span>
<a href="#l17.1724"></a><span id="l17.1724" class="difflineplus">+      /* If we come here it's because we got an error before we could initialize</span>
<a href="#l17.1725"></a><span id="l17.1725" class="difflineplus">+         a send report! Let's try our best...</span>
<a href="#l17.1726"></a><span id="l17.1726">       */</span>
<a href="#l17.1727"></a><span id="l17.1727" class="difflineminus">-      switch (deliverMode)</span>
<a href="#l17.1728"></a><span id="l17.1728" class="difflineminus">-      {</span>
<a href="#l17.1729"></a><span id="l17.1729" class="difflineplus">+      switch (deliverMode) {</span>
<a href="#l17.1730"></a><span id="l17.1730">         case nsIMsgCompDeliverMode::Later:</span>
<a href="#l17.1731"></a><span id="l17.1731">           nsMsgDisplayMessageByName(prompt, &quot;unableToSendLater&quot;);</span>
<a href="#l17.1732"></a><span id="l17.1732">           break;</span>
<a href="#l17.1733"></a><span id="l17.1733">         case nsIMsgCompDeliverMode::AutoSaveAsDraft:</span>
<a href="#l17.1734"></a><span id="l17.1734">         case nsIMsgCompDeliverMode::SaveAsDraft:</span>
<a href="#l17.1735"></a><span id="l17.1735">           nsMsgDisplayMessageByName(prompt, &quot;unableToSaveDraft&quot;);</span>
<a href="#l17.1736"></a><span id="l17.1736">           break;</span>
<a href="#l17.1737"></a><span id="l17.1737">         case nsIMsgCompDeliverMode::SaveAsTemplate:</span>
<a href="#l17.1738"></a><span id="l17.1738" class="difflineat">@@ -1499,135 +1388,123 @@ NS_IMETHODIMP nsMsgCompose::SendMsg(MSG_</span>
<a href="#l17.1739"></a><span id="l17.1739">           break;</span>
<a href="#l17.1740"></a><span id="l17.1740"> </span>
<a href="#l17.1741"></a><span id="l17.1741">         default:</span>
<a href="#l17.1742"></a><span id="l17.1742">           nsMsgDisplayMessageByName(prompt, &quot;sendFailed&quot;);</span>
<a href="#l17.1743"></a><span id="l17.1743">           break;</span>
<a href="#l17.1744"></a><span id="l17.1744">       }</span>
<a href="#l17.1745"></a><span id="l17.1745">     }</span>
<a href="#l17.1746"></a><span id="l17.1746"> </span>
<a href="#l17.1747"></a><span id="l17.1747" class="difflineminus">-    if (progress)</span>
<a href="#l17.1748"></a><span id="l17.1748" class="difflineminus">-      progress-&gt;CloseProgressDialog(true);</span>
<a href="#l17.1749"></a><span id="l17.1749" class="difflineplus">+    if (progress) progress-&gt;CloseProgressDialog(true);</span>
<a href="#l17.1750"></a><span id="l17.1750">   }</span>
<a href="#l17.1751"></a><span id="l17.1751"> </span>
<a href="#l17.1752"></a><span id="l17.1752">   return rv;</span>
<a href="#l17.1753"></a><span id="l17.1753"> }</span>
<a href="#l17.1754"></a><span id="l17.1754"> </span>
<a href="#l17.1755"></a><span id="l17.1755"> /* attribute boolean deleteDraft */</span>
<a href="#l17.1756"></a><span id="l17.1756" class="difflineminus">-NS_IMETHODIMP nsMsgCompose::GetDeleteDraft(bool *aDeleteDraft)</span>
<a href="#l17.1757"></a><span id="l17.1757" class="difflineminus">-{</span>
<a href="#l17.1758"></a><span id="l17.1758" class="difflineplus">+NS_IMETHODIMP nsMsgCompose::GetDeleteDraft(bool *aDeleteDraft) {</span>
<a href="#l17.1759"></a><span id="l17.1759">   NS_ENSURE_ARG_POINTER(aDeleteDraft);</span>
<a href="#l17.1760"></a><span id="l17.1760">   *aDeleteDraft = mDeleteDraft;</span>
<a href="#l17.1761"></a><span id="l17.1761">   return NS_OK;</span>
<a href="#l17.1762"></a><span id="l17.1762"> }</span>
<a href="#l17.1763"></a><span id="l17.1763"> </span>
<a href="#l17.1764"></a><span id="l17.1764" class="difflineminus">-NS_IMETHODIMP nsMsgCompose::SetDeleteDraft(bool aDeleteDraft)</span>
<a href="#l17.1765"></a><span id="l17.1765" class="difflineminus">-{</span>
<a href="#l17.1766"></a><span id="l17.1766" class="difflineplus">+NS_IMETHODIMP nsMsgCompose::SetDeleteDraft(bool aDeleteDraft) {</span>
<a href="#l17.1767"></a><span id="l17.1767">   mDeleteDraft = aDeleteDraft;</span>
<a href="#l17.1768"></a><span id="l17.1768">   return NS_OK;</span>
<a href="#l17.1769"></a><span id="l17.1769"> }</span>
<a href="#l17.1770"></a><span id="l17.1770"> </span>
<a href="#l17.1771"></a><span id="l17.1771" class="difflineminus">-bool nsMsgCompose::IsLastWindow()</span>
<a href="#l17.1772"></a><span id="l17.1772" class="difflineminus">-{</span>
<a href="#l17.1773"></a><span id="l17.1773" class="difflineplus">+bool nsMsgCompose::IsLastWindow() {</span>
<a href="#l17.1774"></a><span id="l17.1774">   nsresult rv;</span>
<a href="#l17.1775"></a><span id="l17.1775">   bool more;</span>
<a href="#l17.1776"></a><span id="l17.1776">   nsCOMPtr&lt;nsIWindowMediator&gt; windowMediator =</span>
<a href="#l17.1777"></a><span id="l17.1777" class="difflineminus">-              do_GetService(NS_WINDOWMEDIATOR_CONTRACTID, &amp;rv);</span>
<a href="#l17.1778"></a><span id="l17.1778" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l17.1779"></a><span id="l17.1779" class="difflineminus">-  {</span>
<a href="#l17.1780"></a><span id="l17.1780" class="difflineplus">+      do_GetService(NS_WINDOWMEDIATOR_CONTRACTID, &amp;rv);</span>
<a href="#l17.1781"></a><span id="l17.1781" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l17.1782"></a><span id="l17.1782">     nsCOMPtr&lt;nsISimpleEnumerator&gt; windowEnumerator;</span>
<a href="#l17.1783"></a><span id="l17.1783">     rv = windowMediator-&gt;GetEnumerator(nullptr,</span>
<a href="#l17.1784"></a><span id="l17.1784" class="difflineminus">-               getter_AddRefs(windowEnumerator));</span>
<a href="#l17.1785"></a><span id="l17.1785" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l17.1786"></a><span id="l17.1786" class="difflineminus">-    {</span>
<a href="#l17.1787"></a><span id="l17.1787" class="difflineplus">+                                       getter_AddRefs(windowEnumerator));</span>
<a href="#l17.1788"></a><span id="l17.1788" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l17.1789"></a><span id="l17.1789">       nsCOMPtr&lt;nsISupports&gt; isupports;</span>
<a href="#l17.1790"></a><span id="l17.1790"> </span>
<a href="#l17.1791"></a><span id="l17.1791">       if (NS_SUCCEEDED(windowEnumerator-&gt;GetNext(getter_AddRefs(isupports))))</span>
<a href="#l17.1792"></a><span id="l17.1792">         if (NS_SUCCEEDED(windowEnumerator-&gt;HasMoreElements(&amp;more)))</span>
<a href="#l17.1793"></a><span id="l17.1793">           return !more;</span>
<a href="#l17.1794"></a><span id="l17.1794">     }</span>
<a href="#l17.1795"></a><span id="l17.1795">   }</span>
<a href="#l17.1796"></a><span id="l17.1796">   return true;</span>
<a href="#l17.1797"></a><span id="l17.1797"> }</span>
<a href="#l17.1798"></a><span id="l17.1798"> </span>
<a href="#l17.1799"></a><span id="l17.1799" class="difflineminus">-NS_IMETHODIMP nsMsgCompose::CloseWindow(void)</span>
<a href="#l17.1800"></a><span id="l17.1800" class="difflineminus">-{</span>
<a href="#l17.1801"></a><span id="l17.1801" class="difflineplus">+NS_IMETHODIMP nsMsgCompose::CloseWindow(void) {</span>
<a href="#l17.1802"></a><span id="l17.1802">   nsresult rv;</span>
<a href="#l17.1803"></a><span id="l17.1803"> </span>
<a href="#l17.1804"></a><span id="l17.1804" class="difflineminus">-  nsCOMPtr&lt;nsIMsgComposeService&gt; composeService = do_GetService(NS_MSGCOMPOSESERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l17.1805"></a><span id="l17.1805" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.1806"></a><span id="l17.1806" class="difflineplus">+  nsCOMPtr&lt;nsIMsgComposeService&gt; composeService =</span>
<a href="#l17.1807"></a><span id="l17.1807" class="difflineplus">+      do_GetService(NS_MSGCOMPOSESERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l17.1808"></a><span id="l17.1808" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.1809"></a><span id="l17.1809"> </span>
<a href="#l17.1810"></a><span id="l17.1810">   // unregister the compose object with the compose service</span>
<a href="#l17.1811"></a><span id="l17.1811">   rv = composeService-&gt;UnregisterComposeDocShell(mDocShell);</span>
<a href="#l17.1812"></a><span id="l17.1812">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.1813"></a><span id="l17.1813">   mDocShell = nullptr;</span>
<a href="#l17.1814"></a><span id="l17.1814"> </span>
<a href="#l17.1815"></a><span id="l17.1815">   // ensure that the destructor of nsMsgSend is invoked to remove</span>
<a href="#l17.1816"></a><span id="l17.1816">   // temporary files.</span>
<a href="#l17.1817"></a><span id="l17.1817">   mMsgSend = nullptr;</span>
<a href="#l17.1818"></a><span id="l17.1818"> </span>
<a href="#l17.1819"></a><span id="l17.1819" class="difflineminus">-  //We are going away for real, we need to do some clean up first</span>
<a href="#l17.1820"></a><span id="l17.1820" class="difflineminus">-  if (m_baseWindow)</span>
<a href="#l17.1821"></a><span id="l17.1821" class="difflineminus">-  {</span>
<a href="#l17.1822"></a><span id="l17.1822" class="difflineminus">-    if (m_editor)</span>
<a href="#l17.1823"></a><span id="l17.1823" class="difflineminus">-    {</span>
<a href="#l17.1824"></a><span id="l17.1824" class="difflineplus">+  // We are going away for real, we need to do some clean up first</span>
<a href="#l17.1825"></a><span id="l17.1825" class="difflineplus">+  if (m_baseWindow) {</span>
<a href="#l17.1826"></a><span id="l17.1826" class="difflineplus">+    if (m_editor) {</span>
<a href="#l17.1827"></a><span id="l17.1827">       // The editor will be destroyed during the close window.</span>
<a href="#l17.1828"></a><span id="l17.1828">       // Set it to null to be sure we won't use it anymore.</span>
<a href="#l17.1829"></a><span id="l17.1829">       m_editor = nullptr;</span>
<a href="#l17.1830"></a><span id="l17.1830">     }</span>
<a href="#l17.1831"></a><span id="l17.1831" class="difflineminus">-    nsIBaseWindow * window = m_baseWindow;</span>
<a href="#l17.1832"></a><span id="l17.1832" class="difflineplus">+    nsIBaseWindow *window = m_baseWindow;</span>
<a href="#l17.1833"></a><span id="l17.1833">     m_baseWindow = nullptr;</span>
<a href="#l17.1834"></a><span id="l17.1834">     rv = window-&gt;Destroy();</span>
<a href="#l17.1835"></a><span id="l17.1835">   }</span>
<a href="#l17.1836"></a><span id="l17.1836"> </span>
<a href="#l17.1837"></a><span id="l17.1837">   m_window = nullptr;</span>
<a href="#l17.1838"></a><span id="l17.1838">   return rv;</span>
<a href="#l17.1839"></a><span id="l17.1839"> }</span>
<a href="#l17.1840"></a><span id="l17.1840"> </span>
<a href="#l17.1841"></a><span id="l17.1841" class="difflineminus">-nsresult nsMsgCompose::Abort()</span>
<a href="#l17.1842"></a><span id="l17.1842" class="difflineminus">-{</span>
<a href="#l17.1843"></a><span id="l17.1843" class="difflineminus">-  if (mMsgSend)</span>
<a href="#l17.1844"></a><span id="l17.1844" class="difflineminus">-    mMsgSend-&gt;Abort();</span>
<a href="#l17.1845"></a><span id="l17.1845" class="difflineminus">-</span>
<a href="#l17.1846"></a><span id="l17.1846" class="difflineminus">-  if (mProgress)</span>
<a href="#l17.1847"></a><span id="l17.1847" class="difflineminus">-    mProgress-&gt;CloseProgressDialog(true);</span>
<a href="#l17.1848"></a><span id="l17.1848" class="difflineplus">+nsresult nsMsgCompose::Abort() {</span>
<a href="#l17.1849"></a><span id="l17.1849" class="difflineplus">+  if (mMsgSend) mMsgSend-&gt;Abort();</span>
<a href="#l17.1850"></a><span id="l17.1850" class="difflineplus">+</span>
<a href="#l17.1851"></a><span id="l17.1851" class="difflineplus">+  if (mProgress) mProgress-&gt;CloseProgressDialog(true);</span>
<a href="#l17.1852"></a><span id="l17.1852"> </span>
<a href="#l17.1853"></a><span id="l17.1853">   return NS_OK;</span>
<a href="#l17.1854"></a><span id="l17.1854"> }</span>
<a href="#l17.1855"></a><span id="l17.1855"> </span>
<a href="#l17.1856"></a><span id="l17.1856" class="difflineminus">-NS_IMETHODIMP nsMsgCompose::GetEditor(nsIEditor * *aEditor)</span>
<a href="#l17.1857"></a><span id="l17.1857" class="difflineminus">-{</span>
<a href="#l17.1858"></a><span id="l17.1858" class="difflineplus">+NS_IMETHODIMP nsMsgCompose::GetEditor(nsIEditor **aEditor) {</span>
<a href="#l17.1859"></a><span id="l17.1859">   NS_IF_ADDREF(*aEditor = m_editor);</span>
<a href="#l17.1860"></a><span id="l17.1860">   return NS_OK;</span>
<a href="#l17.1861"></a><span id="l17.1861"> }</span>
<a href="#l17.1862"></a><span id="l17.1862"> </span>
<a href="#l17.1863"></a><span id="l17.1863" class="difflineminus">-NS_IMETHODIMP nsMsgCompose::SetEditor(nsIEditor *aEditor)</span>
<a href="#l17.1864"></a><span id="l17.1864" class="difflineminus">-{</span>
<a href="#l17.1865"></a><span id="l17.1865" class="difflineplus">+NS_IMETHODIMP nsMsgCompose::SetEditor(nsIEditor *aEditor) {</span>
<a href="#l17.1866"></a><span id="l17.1866">   m_editor = aEditor;</span>
<a href="#l17.1867"></a><span id="l17.1867">   return NS_OK;</span>
<a href="#l17.1868"></a><span id="l17.1868"> }</span>
<a href="#l17.1869"></a><span id="l17.1869"> </span>
<a href="#l17.1870"></a><span id="l17.1870" class="difflineminus">-static nsresult fixCharset(nsCString &amp;aCharset)</span>
<a href="#l17.1871"></a><span id="l17.1871" class="difflineminus">-{</span>
<a href="#l17.1872"></a><span id="l17.1872" class="difflineplus">+static nsresult fixCharset(nsCString &amp;aCharset) {</span>
<a href="#l17.1873"></a><span id="l17.1873">   // Convert to a canonical charset name.</span>
<a href="#l17.1874"></a><span id="l17.1874">   nsresult rv;</span>
<a href="#l17.1875"></a><span id="l17.1875">   nsCOMPtr&lt;nsICharsetConverterManager&gt; ccm =</span>
<a href="#l17.1876"></a><span id="l17.1876" class="difflineminus">-    do_GetService(NS_CHARSETCONVERTERMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l17.1877"></a><span id="l17.1877" class="difflineplus">+      do_GetService(NS_CHARSETCONVERTERMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l17.1878"></a><span id="l17.1878">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.1879"></a><span id="l17.1879"> </span>
<a href="#l17.1880"></a><span id="l17.1880">   nsCString charset(aCharset);</span>
<a href="#l17.1881"></a><span id="l17.1881">   rv = ccm-&gt;GetCharsetAlias(charset.get(), aCharset);</span>
<a href="#l17.1882"></a><span id="l17.1882"> </span>
<a href="#l17.1883"></a><span id="l17.1883">   // Replace an unrecognized charset with the default.</span>
<a href="#l17.1884"></a><span id="l17.1884">   if (NS_FAILED(rv)) {</span>
<a href="#l17.1885"></a><span id="l17.1885" class="difflineminus">-    nsCOMPtr&lt;nsIPrefBranch&gt; prefs (do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l17.1886"></a><span id="l17.1886" class="difflineplus">+    nsCOMPtr&lt;nsIPrefBranch&gt; prefs(</span>
<a href="#l17.1887"></a><span id="l17.1887" class="difflineplus">+        do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l17.1888"></a><span id="l17.1888">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.1889"></a><span id="l17.1889">     nsString defaultCharset;</span>
<a href="#l17.1890"></a><span id="l17.1890" class="difflineminus">-    NS_GetLocalizedUnicharPreferenceWithDefault(prefs, &quot;mailnews.send_default_charset&quot;,</span>
<a href="#l17.1891"></a><span id="l17.1891" class="difflineminus">-                                                NS_LITERAL_STRING(&quot;UTF-8&quot;), defaultCharset);</span>
<a href="#l17.1892"></a><span id="l17.1892" class="difflineplus">+    NS_GetLocalizedUnicharPreferenceWithDefault(</span>
<a href="#l17.1893"></a><span id="l17.1893" class="difflineplus">+        prefs, &quot;mailnews.send_default_charset&quot;, NS_LITERAL_STRING(&quot;UTF-8&quot;),</span>
<a href="#l17.1894"></a><span id="l17.1894" class="difflineplus">+        defaultCharset);</span>
<a href="#l17.1895"></a><span id="l17.1895">     LossyCopyUTF16toASCII(defaultCharset, aCharset);</span>
<a href="#l17.1896"></a><span id="l17.1896">     return NS_OK;</span>
<a href="#l17.1897"></a><span id="l17.1897">   }</span>
<a href="#l17.1898"></a><span id="l17.1898"> </span>
<a href="#l17.1899"></a><span id="l17.1899">   // Don't accept UTF-16 ever. UTF-16 should never be selected as an</span>
<a href="#l17.1900"></a><span id="l17.1900">   // outgoing encoding for e-mail. MIME can't handle those messages</span>
<a href="#l17.1901"></a><span id="l17.1901">   // encoded in ASCII-incompatible encodings.</span>
<a href="#l17.1902"></a><span id="l17.1902">   if (StringBeginsWith(aCharset, NS_LITERAL_CSTRING(&quot;UTF-16&quot;))) {</span>
<a href="#l17.1903"></a><span id="l17.1903" class="difflineat">@@ -1635,328 +1512,294 @@ static nsresult fixCharset(nsCString &amp;aC</span>
<a href="#l17.1904"></a><span id="l17.1904">   }</span>
<a href="#l17.1905"></a><span id="l17.1905">   return NS_OK;</span>
<a href="#l17.1906"></a><span id="l17.1906"> }</span>
<a href="#l17.1907"></a><span id="l17.1907"> </span>
<a href="#l17.1908"></a><span id="l17.1908"> // This used to be called BEFORE editor was created</span>
<a href="#l17.1909"></a><span id="l17.1909"> //  (it did the loadURI that triggered editor creation)</span>
<a href="#l17.1910"></a><span id="l17.1910"> // It is called from JS after editor creation</span>
<a href="#l17.1911"></a><span id="l17.1911"> //  (loadURI is done in JS)</span>
<a href="#l17.1912"></a><span id="l17.1912" class="difflineminus">-MOZ_CAN_RUN_SCRIPT_BOUNDARY NS_IMETHODIMP</span>
<a href="#l17.1913"></a><span id="l17.1913" class="difflineminus">-nsMsgCompose::InitEditor(nsIEditor* aEditor, mozIDOMWindowProxy* aContentWindow)</span>
<a href="#l17.1914"></a><span id="l17.1914" class="difflineminus">-{</span>
<a href="#l17.1915"></a><span id="l17.1915" class="difflineplus">+MOZ_CAN_RUN_SCRIPT_BOUNDARY NS_IMETHODIMP nsMsgCompose::InitEditor(</span>
<a href="#l17.1916"></a><span id="l17.1916" class="difflineplus">+    nsIEditor *aEditor, mozIDOMWindowProxy *aContentWindow) {</span>
<a href="#l17.1917"></a><span id="l17.1917">   NS_ENSURE_ARG_POINTER(aEditor);</span>
<a href="#l17.1918"></a><span id="l17.1918">   NS_ENSURE_ARG_POINTER(aContentWindow);</span>
<a href="#l17.1919"></a><span id="l17.1919">   nsresult rv;</span>
<a href="#l17.1920"></a><span id="l17.1920"> </span>
<a href="#l17.1921"></a><span id="l17.1921">   m_editor = aEditor;</span>
<a href="#l17.1922"></a><span id="l17.1922"> </span>
<a href="#l17.1923"></a><span id="l17.1923">   nsAutoCString msgCharSet(m_compFields-&gt;GetCharacterSet());</span>
<a href="#l17.1924"></a><span id="l17.1924">   rv = fixCharset(msgCharSet);</span>
<a href="#l17.1925"></a><span id="l17.1925">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.1926"></a><span id="l17.1926">   m_compFields-&gt;SetCharacterSet(msgCharSet.get());</span>
<a href="#l17.1927"></a><span id="l17.1927">   aEditor-&gt;SetDocumentCharacterSet(msgCharSet);</span>
<a href="#l17.1928"></a><span id="l17.1928"> </span>
<a href="#l17.1929"></a><span id="l17.1929" class="difflineminus">-  nsCOMPtr&lt;nsPIDOMWindowOuter&gt; window = nsPIDOMWindowOuter::From(aContentWindow);</span>
<a href="#l17.1930"></a><span id="l17.1930" class="difflineplus">+  nsCOMPtr&lt;nsPIDOMWindowOuter&gt; window =</span>
<a href="#l17.1931"></a><span id="l17.1931" class="difflineplus">+      nsPIDOMWindowOuter::From(aContentWindow);</span>
<a href="#l17.1932"></a><span id="l17.1932"> </span>
<a href="#l17.1933"></a><span id="l17.1933">   nsIDocShell *docShell = window-&gt;GetDocShell();</span>
<a href="#l17.1934"></a><span id="l17.1934">   NS_ENSURE_TRUE(docShell, NS_ERROR_UNEXPECTED);</span>
<a href="#l17.1935"></a><span id="l17.1935"> </span>
<a href="#l17.1936"></a><span id="l17.1936">   nsCOMPtr&lt;nsIContentViewer&gt; childCV;</span>
<a href="#l17.1937"></a><span id="l17.1937" class="difflineminus">-  NS_ENSURE_SUCCESS(docShell-&gt;GetContentViewer(getter_AddRefs(childCV)), NS_ERROR_FAILURE);</span>
<a href="#l17.1938"></a><span id="l17.1938" class="difflineminus">-  if (childCV)</span>
<a href="#l17.1939"></a><span id="l17.1939" class="difflineminus">-  {</span>
<a href="#l17.1940"></a><span id="l17.1940" class="difflineplus">+  NS_ENSURE_SUCCESS(docShell-&gt;GetContentViewer(getter_AddRefs(childCV)),</span>
<a href="#l17.1941"></a><span id="l17.1941" class="difflineplus">+                    NS_ERROR_FAILURE);</span>
<a href="#l17.1942"></a><span id="l17.1942" class="difflineplus">+  if (childCV) {</span>
<a href="#l17.1943"></a><span id="l17.1943">     // SetForceCharacterSet will complain about &quot;UTF-7&quot; or &quot;x-mac-croatian&quot;</span>
<a href="#l17.1944"></a><span id="l17.1944">     // (see test-charset-edit.js), but we deal with this elsewhere.</span>
<a href="#l17.1945"></a><span id="l17.1945">     rv = childCV-&gt;SetForceCharacterSet(msgCharSet);</span>
<a href="#l17.1946"></a><span id="l17.1946">     NS_WARNING_ASSERTION(NS_SUCCEEDED(rv), &quot;SetForceCharacterSet() failed&quot;);</span>
<a href="#l17.1947"></a><span id="l17.1947">   }</span>
<a href="#l17.1948"></a><span id="l17.1948"> </span>
<a href="#l17.1949"></a><span id="l17.1949">   // This is what used to be done in mDocumentListener,</span>
<a href="#l17.1950"></a><span id="l17.1950">   //   nsMsgDocumentStateListener::NotifyDocumentCreated()</span>
<a href="#l17.1951"></a><span id="l17.1951">   bool quotingToFollow = false;</span>
<a href="#l17.1952"></a><span id="l17.1952">   GetQuotingToFollow(&amp;quotingToFollow);</span>
<a href="#l17.1953"></a><span id="l17.1953">   if (quotingToFollow)</span>
<a href="#l17.1954"></a><span id="l17.1954">     return BuildQuotedMessageAndSignature();</span>
<a href="#l17.1955"></a><span id="l17.1955" class="difflineminus">-  else</span>
<a href="#l17.1956"></a><span id="l17.1956" class="difflineminus">-  {</span>
<a href="#l17.1957"></a><span id="l17.1957" class="difflineminus">-    NotifyStateListeners(nsIMsgComposeNotificationType::ComposeFieldsReady, NS_OK);</span>
<a href="#l17.1958"></a><span id="l17.1958" class="difflineplus">+  else {</span>
<a href="#l17.1959"></a><span id="l17.1959" class="difflineplus">+    NotifyStateListeners(nsIMsgComposeNotificationType::ComposeFieldsReady,</span>
<a href="#l17.1960"></a><span id="l17.1960" class="difflineplus">+                         NS_OK);</span>
<a href="#l17.1961"></a><span id="l17.1961">     rv = BuildBodyMessageAndSignature();</span>
<a href="#l17.1962"></a><span id="l17.1962" class="difflineminus">-    NotifyStateListeners(nsIMsgComposeNotificationType::ComposeBodyReady, NS_OK);</span>
<a href="#l17.1963"></a><span id="l17.1963" class="difflineplus">+    NotifyStateListeners(nsIMsgComposeNotificationType::ComposeBodyReady,</span>
<a href="#l17.1964"></a><span id="l17.1964" class="difflineplus">+                         NS_OK);</span>
<a href="#l17.1965"></a><span id="l17.1965">     return rv;</span>
<a href="#l17.1966"></a><span id="l17.1966">   }</span>
<a href="#l17.1967"></a><span id="l17.1967"> }</span>
<a href="#l17.1968"></a><span id="l17.1968"> </span>
<a href="#l17.1969"></a><span id="l17.1969" class="difflineminus">-NS_IMETHODIMP nsMsgCompose::GetBodyRaw(nsACString&amp; aBodyRaw)</span>
<a href="#l17.1970"></a><span id="l17.1970" class="difflineminus">-{</span>
<a href="#l17.1971"></a><span id="l17.1971" class="difflineplus">+NS_IMETHODIMP nsMsgCompose::GetBodyRaw(nsACString &amp;aBodyRaw) {</span>
<a href="#l17.1972"></a><span id="l17.1972">   aBodyRaw.Assign((char *)m_compFields-&gt;GetBody());</span>
<a href="#l17.1973"></a><span id="l17.1973">   return NS_OK;</span>
<a href="#l17.1974"></a><span id="l17.1974"> }</span>
<a href="#l17.1975"></a><span id="l17.1975"> </span>
<a href="#l17.1976"></a><span id="l17.1976" class="difflineminus">-nsresult nsMsgCompose::GetBodyModified(bool * modified)</span>
<a href="#l17.1977"></a><span id="l17.1977" class="difflineminus">-{</span>
<a href="#l17.1978"></a><span id="l17.1978" class="difflineplus">+nsresult nsMsgCompose::GetBodyModified(bool *modified) {</span>
<a href="#l17.1979"></a><span id="l17.1979">   nsresult rv;</span>
<a href="#l17.1980"></a><span id="l17.1980"> </span>
<a href="#l17.1981"></a><span id="l17.1981" class="difflineminus">-  if (! modified)</span>
<a href="#l17.1982"></a><span id="l17.1982" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l17.1983"></a><span id="l17.1983" class="difflineplus">+  if (!modified) return NS_ERROR_NULL_POINTER;</span>
<a href="#l17.1984"></a><span id="l17.1984"> </span>
<a href="#l17.1985"></a><span id="l17.1985">   *modified = true;</span>
<a href="#l17.1986"></a><span id="l17.1986"> </span>
<a href="#l17.1987"></a><span id="l17.1987" class="difflineminus">-  if (m_editor)</span>
<a href="#l17.1988"></a><span id="l17.1988" class="difflineminus">-  {</span>
<a href="#l17.1989"></a><span id="l17.1989" class="difflineplus">+  if (m_editor) {</span>
<a href="#l17.1990"></a><span id="l17.1990">     rv = m_editor-&gt;GetDocumentModified(modified);</span>
<a href="#l17.1991"></a><span id="l17.1991" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l17.1992"></a><span id="l17.1992" class="difflineminus">-      *modified = true;</span>
<a href="#l17.1993"></a><span id="l17.1993" class="difflineplus">+    if (NS_FAILED(rv)) *modified = true;</span>
<a href="#l17.1994"></a><span id="l17.1994">   }</span>
<a href="#l17.1995"></a><span id="l17.1995"> </span>
<a href="#l17.1996"></a><span id="l17.1996">   return NS_OK;</span>
<a href="#l17.1997"></a><span id="l17.1997"> }</span>
<a href="#l17.1998"></a><span id="l17.1998"> </span>
<a href="#l17.1999"></a><span id="l17.1999"> MOZ_CAN_RUN_SCRIPT_BOUNDARY nsresult</span>
<a href="#l17.2000"></a><span id="l17.2000" class="difflineminus">-nsMsgCompose::SetBodyModified(bool modified)</span>
<a href="#l17.2001"></a><span id="l17.2001" class="difflineminus">-{</span>
<a href="#l17.2002"></a><span id="l17.2002" class="difflineminus">-  nsresult  rv = NS_OK;</span>
<a href="#l17.2003"></a><span id="l17.2003" class="difflineminus">-</span>
<a href="#l17.2004"></a><span id="l17.2004" class="difflineminus">-  if (m_editor)</span>
<a href="#l17.2005"></a><span id="l17.2005" class="difflineminus">-  {</span>
<a href="#l17.2006"></a><span id="l17.2006" class="difflineplus">+nsMsgCompose::SetBodyModified(bool modified) {</span>
<a href="#l17.2007"></a><span id="l17.2007" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l17.2008"></a><span id="l17.2008" class="difflineplus">+</span>
<a href="#l17.2009"></a><span id="l17.2009" class="difflineplus">+  if (m_editor) {</span>
<a href="#l17.2010"></a><span id="l17.2010">     nsCOMPtr&lt;nsIEditor&gt; editor(m_editor);  // Strong reference.</span>
<a href="#l17.2011"></a><span id="l17.2011" class="difflineminus">-    if (modified)</span>
<a href="#l17.2012"></a><span id="l17.2012" class="difflineminus">-    {</span>
<a href="#l17.2013"></a><span id="l17.2013" class="difflineplus">+    if (modified) {</span>
<a href="#l17.2014"></a><span id="l17.2014">       int32_t modCount = 0;</span>
<a href="#l17.2015"></a><span id="l17.2015">       editor-&gt;GetModificationCount(&amp;modCount);</span>
<a href="#l17.2016"></a><span id="l17.2016" class="difflineminus">-      if (modCount == 0)</span>
<a href="#l17.2017"></a><span id="l17.2017" class="difflineminus">-        editor-&gt;IncrementModificationCount(1);</span>
<a href="#l17.2018"></a><span id="l17.2018" class="difflineminus">-    }</span>
<a href="#l17.2019"></a><span id="l17.2019" class="difflineminus">-    else</span>
<a href="#l17.2020"></a><span id="l17.2020" class="difflineplus">+      if (modCount == 0) editor-&gt;IncrementModificationCount(1);</span>
<a href="#l17.2021"></a><span id="l17.2021" class="difflineplus">+    } else</span>
<a href="#l17.2022"></a><span id="l17.2022">       editor-&gt;ResetModificationCount();</span>
<a href="#l17.2023"></a><span id="l17.2023">   }</span>
<a href="#l17.2024"></a><span id="l17.2024"> </span>
<a href="#l17.2025"></a><span id="l17.2025">   return rv;</span>
<a href="#l17.2026"></a><span id="l17.2026"> }</span>
<a href="#l17.2027"></a><span id="l17.2027"> </span>
<a href="#l17.2028"></a><span id="l17.2028"> NS_IMETHODIMP</span>
<a href="#l17.2029"></a><span id="l17.2029" class="difflineminus">-nsMsgCompose::GetDomWindow(mozIDOMWindowProxy * *aDomWindow)</span>
<a href="#l17.2030"></a><span id="l17.2030" class="difflineminus">-{</span>
<a href="#l17.2031"></a><span id="l17.2031" class="difflineplus">+nsMsgCompose::GetDomWindow(mozIDOMWindowProxy **aDomWindow) {</span>
<a href="#l17.2032"></a><span id="l17.2032">   NS_IF_ADDREF(*aDomWindow = m_window);</span>
<a href="#l17.2033"></a><span id="l17.2033">   return NS_OK;</span>
<a href="#l17.2034"></a><span id="l17.2034"> }</span>
<a href="#l17.2035"></a><span id="l17.2035"> </span>
<a href="#l17.2036"></a><span id="l17.2036" class="difflineminus">-nsresult nsMsgCompose::GetCompFields(nsIMsgCompFields * *aCompFields)</span>
<a href="#l17.2037"></a><span id="l17.2037" class="difflineminus">-{</span>
<a href="#l17.2038"></a><span id="l17.2038" class="difflineminus">-  NS_IF_ADDREF(*aCompFields = (nsIMsgCompFields*)m_compFields);</span>
<a href="#l17.2039"></a><span id="l17.2039" class="difflineplus">+nsresult nsMsgCompose::GetCompFields(nsIMsgCompFields **aCompFields) {</span>
<a href="#l17.2040"></a><span id="l17.2040" class="difflineplus">+  NS_IF_ADDREF(*aCompFields = (nsIMsgCompFields *)m_compFields);</span>
<a href="#l17.2041"></a><span id="l17.2041">   return NS_OK;</span>
<a href="#l17.2042"></a><span id="l17.2042"> }</span>
<a href="#l17.2043"></a><span id="l17.2043"> </span>
<a href="#l17.2044"></a><span id="l17.2044" class="difflineminus">-NS_IMETHODIMP nsMsgCompose::GetComposeHTML(bool *aComposeHTML)</span>
<a href="#l17.2045"></a><span id="l17.2045" class="difflineminus">-{</span>
<a href="#l17.2046"></a><span id="l17.2046" class="difflineplus">+NS_IMETHODIMP nsMsgCompose::GetComposeHTML(bool *aComposeHTML) {</span>
<a href="#l17.2047"></a><span id="l17.2047">   *aComposeHTML = m_composeHTML;</span>
<a href="#l17.2048"></a><span id="l17.2048">   return NS_OK;</span>
<a href="#l17.2049"></a><span id="l17.2049"> }</span>
<a href="#l17.2050"></a><span id="l17.2050"> </span>
<a href="#l17.2051"></a><span id="l17.2051" class="difflineminus">-nsresult nsMsgCompose::GetWrapLength(int32_t *aWrapLength)</span>
<a href="#l17.2052"></a><span id="l17.2052" class="difflineminus">-{</span>
<a href="#l17.2053"></a><span id="l17.2053" class="difflineplus">+nsresult nsMsgCompose::GetWrapLength(int32_t *aWrapLength) {</span>
<a href="#l17.2054"></a><span id="l17.2054">   nsresult rv;</span>
<a href="#l17.2055"></a><span id="l17.2055" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch (do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l17.2056"></a><span id="l17.2056" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(</span>
<a href="#l17.2057"></a><span id="l17.2057" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l17.2058"></a><span id="l17.2058">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l17.2059"></a><span id="l17.2059"> </span>
<a href="#l17.2060"></a><span id="l17.2060">   return prefBranch-&gt;GetIntPref(&quot;mailnews.wraplength&quot;, aWrapLength);</span>
<a href="#l17.2061"></a><span id="l17.2061"> }</span>
<a href="#l17.2062"></a><span id="l17.2062"> </span>
<a href="#l17.2063"></a><span id="l17.2063" class="difflineminus">-nsresult nsMsgCompose::CreateMessage(const char * originalMsgURI,</span>
<a href="#l17.2064"></a><span id="l17.2064" class="difflineplus">+nsresult nsMsgCompose::CreateMessage(const char *originalMsgURI,</span>
<a href="#l17.2065"></a><span id="l17.2065">                                      MSG_ComposeType type,</span>
<a href="#l17.2066"></a><span id="l17.2066" class="difflineminus">-                                     nsIMsgCompFields * compFields)</span>
<a href="#l17.2067"></a><span id="l17.2067" class="difflineminus">-{</span>
<a href="#l17.2068"></a><span id="l17.2068" class="difflineplus">+                                     nsIMsgCompFields *compFields) {</span>
<a href="#l17.2069"></a><span id="l17.2069">   nsresult rv = NS_OK;</span>
<a href="#l17.2070"></a><span id="l17.2070">   mType = type;</span>
<a href="#l17.2071"></a><span id="l17.2071">   mDraftDisposition = nsIMsgFolder::nsMsgDispositionState_None;</span>
<a href="#l17.2072"></a><span id="l17.2072"> </span>
<a href="#l17.2073"></a><span id="l17.2073">   mDeleteDraft = (type == nsIMsgCompType::Draft);</span>
<a href="#l17.2074"></a><span id="l17.2074">   nsAutoCString msgUri(originalMsgURI);</span>
<a href="#l17.2075"></a><span id="l17.2075">   bool fileUrl = StringBeginsWith(msgUri, NS_LITERAL_CSTRING(&quot;file:&quot;));</span>
<a href="#l17.2076"></a><span id="l17.2076">   int32_t typeIndex = msgUri.Find(&quot;type=application/x-message-display&quot;);</span>
<a href="#l17.2077"></a><span id="l17.2077" class="difflineminus">-  if (typeIndex != kNotFound &amp;&amp; typeIndex &gt; 0)</span>
<a href="#l17.2078"></a><span id="l17.2078" class="difflineminus">-  {</span>
<a href="#l17.2079"></a><span id="l17.2079" class="difflineplus">+  if (typeIndex != kNotFound &amp;&amp; typeIndex &gt; 0) {</span>
<a href="#l17.2080"></a><span id="l17.2080">     // Strip out type=application/x-message-display because it confuses libmime.</span>
<a href="#l17.2081"></a><span id="l17.2081">     msgUri.Cut(typeIndex, sizeof(&quot;type=application/x-message-display&quot;));</span>
<a href="#l17.2082"></a><span id="l17.2082" class="difflineminus">-    if (fileUrl) // we're dealing with an .eml file msg</span>
<a href="#l17.2083"></a><span id="l17.2083" class="difflineplus">+    if (fileUrl)  // we're dealing with an .eml file msg</span>
<a href="#l17.2084"></a><span id="l17.2084">     {</span>
<a href="#l17.2085"></a><span id="l17.2085">       // We have now removed the type from the uri. Make sure we don't have</span>
<a href="#l17.2086"></a><span id="l17.2086">       // an uri with &quot;&amp;&amp;&quot; now. If we do, remove the second '&amp;'.</span>
<a href="#l17.2087"></a><span id="l17.2087" class="difflineminus">-      if (msgUri.CharAt(typeIndex) == '&amp;')</span>
<a href="#l17.2088"></a><span id="l17.2088" class="difflineminus">-        msgUri.Cut(typeIndex, 1);</span>
<a href="#l17.2089"></a><span id="l17.2089" class="difflineplus">+      if (msgUri.CharAt(typeIndex) == '&amp;') msgUri.Cut(typeIndex, 1);</span>
<a href="#l17.2090"></a><span id="l17.2090">       // Remove possible trailing '?'.</span>
<a href="#l17.2091"></a><span id="l17.2091">       if (msgUri.CharAt(msgUri.Length() - 1) == '?')</span>
<a href="#l17.2092"></a><span id="l17.2092">         msgUri.Cut(msgUri.Length() - 1, 1);</span>
<a href="#l17.2093"></a><span id="l17.2093" class="difflineminus">-    }</span>
<a href="#l17.2094"></a><span id="l17.2094" class="difflineminus">-    else // we're dealing with a message/rfc822 attachment</span>
<a href="#l17.2095"></a><span id="l17.2095" class="difflineplus">+    } else  // we're dealing with a message/rfc822 attachment</span>
<a href="#l17.2096"></a><span id="l17.2096">     {</span>
<a href="#l17.2097"></a><span id="l17.2097">       // nsURLFetcher will check for &quot;realtype=message/rfc822&quot; and will set the</span>
<a href="#l17.2098"></a><span id="l17.2098">       // content type to message/rfc822 in the forwarded message.</span>
<a href="#l17.2099"></a><span id="l17.2099">       msgUri.AppendLiteral(&quot;&amp;realtype=message/rfc822&quot;);</span>
<a href="#l17.2100"></a><span id="l17.2100">     }</span>
<a href="#l17.2101"></a><span id="l17.2101">     originalMsgURI = msgUri.get();</span>
<a href="#l17.2102"></a><span id="l17.2102">   }</span>
<a href="#l17.2103"></a><span id="l17.2103"> </span>
<a href="#l17.2104"></a><span id="l17.2104" class="difflineminus">-  if (compFields)</span>
<a href="#l17.2105"></a><span id="l17.2105" class="difflineminus">-  {</span>
<a href="#l17.2106"></a><span id="l17.2106" class="difflineminus">-    m_compFields = reinterpret_cast&lt;nsMsgCompFields*&gt;(compFields);</span>
<a href="#l17.2107"></a><span id="l17.2107" class="difflineminus">-  }</span>
<a href="#l17.2108"></a><span id="l17.2108" class="difflineminus">-  else</span>
<a href="#l17.2109"></a><span id="l17.2109" class="difflineminus">-  {</span>
<a href="#l17.2110"></a><span id="l17.2110" class="difflineplus">+  if (compFields) {</span>
<a href="#l17.2111"></a><span id="l17.2111" class="difflineplus">+    m_compFields = reinterpret_cast&lt;nsMsgCompFields *&gt;(compFields);</span>
<a href="#l17.2112"></a><span id="l17.2112" class="difflineplus">+  } else {</span>
<a href="#l17.2113"></a><span id="l17.2113">     m_compFields = new nsMsgCompFields();</span>
<a href="#l17.2114"></a><span id="l17.2114">   }</span>
<a href="#l17.2115"></a><span id="l17.2115"> </span>
<a href="#l17.2116"></a><span id="l17.2116" class="difflineminus">-  if (m_identity &amp;&amp; mType != nsIMsgCompType::Draft)</span>
<a href="#l17.2117"></a><span id="l17.2117" class="difflineminus">-  {</span>
<a href="#l17.2118"></a><span id="l17.2118" class="difflineplus">+  if (m_identity &amp;&amp; mType != nsIMsgCompType::Draft) {</span>
<a href="#l17.2119"></a><span id="l17.2119">     // Setup reply-to field.</span>
<a href="#l17.2120"></a><span id="l17.2120">     nsCString replyTo;</span>
<a href="#l17.2121"></a><span id="l17.2121">     m_identity-&gt;GetReplyTo(replyTo);</span>
<a href="#l17.2122"></a><span id="l17.2122" class="difflineminus">-    if (!replyTo.IsEmpty())</span>
<a href="#l17.2123"></a><span id="l17.2123" class="difflineminus">-    {</span>
<a href="#l17.2124"></a><span id="l17.2124" class="difflineplus">+    if (!replyTo.IsEmpty()) {</span>
<a href="#l17.2125"></a><span id="l17.2125">       nsCString resultStr;</span>
<a href="#l17.2126"></a><span id="l17.2126">       RemoveDuplicateAddresses(nsDependentCString(m_compFields-&gt;GetReplyTo()),</span>
<a href="#l17.2127"></a><span id="l17.2127">                                replyTo, resultStr);</span>
<a href="#l17.2128"></a><span id="l17.2128" class="difflineminus">-      if (!resultStr.IsEmpty())</span>
<a href="#l17.2129"></a><span id="l17.2129" class="difflineminus">-      {</span>
<a href="#l17.2130"></a><span id="l17.2130" class="difflineplus">+      if (!resultStr.IsEmpty()) {</span>
<a href="#l17.2131"></a><span id="l17.2131">         replyTo.Append(',');</span>
<a href="#l17.2132"></a><span id="l17.2132">         replyTo.Append(resultStr);</span>
<a href="#l17.2133"></a><span id="l17.2133">       }</span>
<a href="#l17.2134"></a><span id="l17.2134">       m_compFields-&gt;SetReplyTo(replyTo.get());</span>
<a href="#l17.2135"></a><span id="l17.2135">     }</span>
<a href="#l17.2136"></a><span id="l17.2136"> </span>
<a href="#l17.2137"></a><span id="l17.2137">     // Setup auto-Cc field.</span>
<a href="#l17.2138"></a><span id="l17.2138">     bool doCc;</span>
<a href="#l17.2139"></a><span id="l17.2139">     m_identity-&gt;GetDoCc(&amp;doCc);</span>
<a href="#l17.2140"></a><span id="l17.2140" class="difflineminus">-    if (doCc)</span>
<a href="#l17.2141"></a><span id="l17.2141" class="difflineminus">-    {</span>
<a href="#l17.2142"></a><span id="l17.2142" class="difflineplus">+    if (doCc) {</span>
<a href="#l17.2143"></a><span id="l17.2143">       nsCString ccList;</span>
<a href="#l17.2144"></a><span id="l17.2144">       m_identity-&gt;GetDoCcList(ccList);</span>
<a href="#l17.2145"></a><span id="l17.2145"> </span>
<a href="#l17.2146"></a><span id="l17.2146">       nsCString resultStr;</span>
<a href="#l17.2147"></a><span id="l17.2147">       RemoveDuplicateAddresses(nsDependentCString(m_compFields-&gt;GetCc()),</span>
<a href="#l17.2148"></a><span id="l17.2148">                                ccList, resultStr);</span>
<a href="#l17.2149"></a><span id="l17.2149" class="difflineminus">-      if (!resultStr.IsEmpty())</span>
<a href="#l17.2150"></a><span id="l17.2150" class="difflineminus">-      {</span>
<a href="#l17.2151"></a><span id="l17.2151" class="difflineplus">+      if (!resultStr.IsEmpty()) {</span>
<a href="#l17.2152"></a><span id="l17.2152">         ccList.Append(',');</span>
<a href="#l17.2153"></a><span id="l17.2153">         ccList.Append(resultStr);</span>
<a href="#l17.2154"></a><span id="l17.2154">       }</span>
<a href="#l17.2155"></a><span id="l17.2155">       m_compFields-&gt;SetCc(ccList.get());</span>
<a href="#l17.2156"></a><span id="l17.2156">     }</span>
<a href="#l17.2157"></a><span id="l17.2157"> </span>
<a href="#l17.2158"></a><span id="l17.2158">     // Setup auto-Bcc field.</span>
<a href="#l17.2159"></a><span id="l17.2159">     bool doBcc;</span>
<a href="#l17.2160"></a><span id="l17.2160">     m_identity-&gt;GetDoBcc(&amp;doBcc);</span>
<a href="#l17.2161"></a><span id="l17.2161" class="difflineminus">-    if (doBcc)</span>
<a href="#l17.2162"></a><span id="l17.2162" class="difflineminus">-    {</span>
<a href="#l17.2163"></a><span id="l17.2163" class="difflineplus">+    if (doBcc) {</span>
<a href="#l17.2164"></a><span id="l17.2164">       nsCString bccList;</span>
<a href="#l17.2165"></a><span id="l17.2165">       m_identity-&gt;GetDoBccList(bccList);</span>
<a href="#l17.2166"></a><span id="l17.2166"> </span>
<a href="#l17.2167"></a><span id="l17.2167">       nsCString resultStr;</span>
<a href="#l17.2168"></a><span id="l17.2168">       RemoveDuplicateAddresses(nsDependentCString(m_compFields-&gt;GetBcc()),</span>
<a href="#l17.2169"></a><span id="l17.2169">                                bccList, resultStr);</span>
<a href="#l17.2170"></a><span id="l17.2170" class="difflineminus">-      if (!resultStr.IsEmpty())</span>
<a href="#l17.2171"></a><span id="l17.2171" class="difflineminus">-      {</span>
<a href="#l17.2172"></a><span id="l17.2172" class="difflineplus">+      if (!resultStr.IsEmpty()) {</span>
<a href="#l17.2173"></a><span id="l17.2173">         bccList.Append(',');</span>
<a href="#l17.2174"></a><span id="l17.2174">         bccList.Append(resultStr);</span>
<a href="#l17.2175"></a><span id="l17.2175">       }</span>
<a href="#l17.2176"></a><span id="l17.2176">       m_compFields-&gt;SetBcc(bccList.get());</span>
<a href="#l17.2177"></a><span id="l17.2177">     }</span>
<a href="#l17.2178"></a><span id="l17.2178">   }</span>
<a href="#l17.2179"></a><span id="l17.2179"> </span>
<a href="#l17.2180"></a><span id="l17.2180" class="difflineminus">-  if (mType == nsIMsgCompType::Draft)</span>
<a href="#l17.2181"></a><span id="l17.2181" class="difflineminus">-  {</span>
<a href="#l17.2182"></a><span id="l17.2182" class="difflineplus">+  if (mType == nsIMsgCompType::Draft) {</span>
<a href="#l17.2183"></a><span id="l17.2183">     nsCString curDraftIdURL;</span>
<a href="#l17.2184"></a><span id="l17.2184">     rv = m_compFields-&gt;GetDraftId(getter_Copies(curDraftIdURL));</span>
<a href="#l17.2185"></a><span id="l17.2185" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(rv) &amp;&amp; !curDraftIdURL.IsEmpty(), &quot;CreateMessage can't get draft id&quot;);</span>
<a href="#l17.2186"></a><span id="l17.2186" class="difflineplus">+    NS_ASSERTION(NS_SUCCEEDED(rv) &amp;&amp; !curDraftIdURL.IsEmpty(),</span>
<a href="#l17.2187"></a><span id="l17.2187" class="difflineplus">+                 &quot;CreateMessage can't get draft id&quot;);</span>
<a href="#l17.2188"></a><span id="l17.2188"> </span>
<a href="#l17.2189"></a><span id="l17.2189">     // Skip if no draft id (probably a new draft msg).</span>
<a href="#l17.2190"></a><span id="l17.2190" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; !curDraftIdURL.IsEmpty())</span>
<a href="#l17.2191"></a><span id="l17.2191" class="difflineminus">-    {</span>
<a href="#l17.2192"></a><span id="l17.2192" class="difflineminus">-      nsCOMPtr &lt;nsIMsgDBHdr&gt; msgDBHdr;</span>
<a href="#l17.2193"></a><span id="l17.2193" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; !curDraftIdURL.IsEmpty()) {</span>
<a href="#l17.2194"></a><span id="l17.2194" class="difflineplus">+      nsCOMPtr&lt;nsIMsgDBHdr&gt; msgDBHdr;</span>
<a href="#l17.2195"></a><span id="l17.2195">       rv = GetMsgDBHdrFromURI(curDraftIdURL.get(), getter_AddRefs(msgDBHdr));</span>
<a href="#l17.2196"></a><span id="l17.2196" class="difflineminus">-      NS_ASSERTION(NS_SUCCEEDED(rv), &quot;CreateMessage can't get msg header DB interface pointer.&quot;);</span>
<a href="#l17.2197"></a><span id="l17.2197" class="difflineminus">-      if (msgDBHdr)</span>
<a href="#l17.2198"></a><span id="l17.2198" class="difflineminus">-      {</span>
<a href="#l17.2199"></a><span id="l17.2199" class="difflineplus">+      NS_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l17.2200"></a><span id="l17.2200" class="difflineplus">+                   &quot;CreateMessage can't get msg header DB interface pointer.&quot;);</span>
<a href="#l17.2201"></a><span id="l17.2201" class="difflineplus">+      if (msgDBHdr) {</span>
<a href="#l17.2202"></a><span id="l17.2202">         nsCString queuedDisposition;</span>
<a href="#l17.2203"></a><span id="l17.2203" class="difflineminus">-        msgDBHdr-&gt;GetStringProperty(QUEUED_DISPOSITION_PROPERTY, getter_Copies(queuedDisposition));</span>
<a href="#l17.2204"></a><span id="l17.2204" class="difflineplus">+        msgDBHdr-&gt;GetStringProperty(QUEUED_DISPOSITION_PROPERTY,</span>
<a href="#l17.2205"></a><span id="l17.2205" class="difflineplus">+                                    getter_Copies(queuedDisposition));</span>
<a href="#l17.2206"></a><span id="l17.2206">         // We need to retrieve the original URI from the database so we can</span>
<a href="#l17.2207"></a><span id="l17.2207" class="difflineminus">-        // set the disposition flags correctly if the draft is a reply or forwarded message.</span>
<a href="#l17.2208"></a><span id="l17.2208" class="difflineplus">+        // set the disposition flags correctly if the draft is a reply or</span>
<a href="#l17.2209"></a><span id="l17.2209" class="difflineplus">+        // forwarded message.</span>
<a href="#l17.2210"></a><span id="l17.2210">         nsCString originalMsgURIfromDB;</span>
<a href="#l17.2211"></a><span id="l17.2211" class="difflineminus">-        msgDBHdr-&gt;GetStringProperty(ORIG_URI_PROPERTY, getter_Copies(originalMsgURIfromDB));</span>
<a href="#l17.2212"></a><span id="l17.2212" class="difflineplus">+        msgDBHdr-&gt;GetStringProperty(ORIG_URI_PROPERTY,</span>
<a href="#l17.2213"></a><span id="l17.2213" class="difflineplus">+                                    getter_Copies(originalMsgURIfromDB));</span>
<a href="#l17.2214"></a><span id="l17.2214">         mOriginalMsgURI = originalMsgURIfromDB;</span>
<a href="#l17.2215"></a><span id="l17.2215" class="difflineminus">-        if (!queuedDisposition.IsEmpty())</span>
<a href="#l17.2216"></a><span id="l17.2216" class="difflineminus">-        {</span>
<a href="#l17.2217"></a><span id="l17.2217" class="difflineplus">+        if (!queuedDisposition.IsEmpty()) {</span>
<a href="#l17.2218"></a><span id="l17.2218">           if (queuedDisposition.EqualsLiteral(&quot;replied&quot;))</span>
<a href="#l17.2219"></a><span id="l17.2219" class="difflineminus">-             mDraftDisposition = nsIMsgFolder::nsMsgDispositionState_Replied;</span>
<a href="#l17.2220"></a><span id="l17.2220" class="difflineplus">+            mDraftDisposition = nsIMsgFolder::nsMsgDispositionState_Replied;</span>
<a href="#l17.2221"></a><span id="l17.2221">           else if (queuedDisposition.EqualsLiteral(&quot;forward&quot;))</span>
<a href="#l17.2222"></a><span id="l17.2222" class="difflineminus">-             mDraftDisposition = nsIMsgFolder::nsMsgDispositionState_Forwarded;</span>
<a href="#l17.2223"></a><span id="l17.2223" class="difflineplus">+            mDraftDisposition = nsIMsgFolder::nsMsgDispositionState_Forwarded;</span>
<a href="#l17.2224"></a><span id="l17.2224">         }</span>
<a href="#l17.2225"></a><span id="l17.2225">       }</span>
<a href="#l17.2226"></a><span id="l17.2226">     }</span>
<a href="#l17.2227"></a><span id="l17.2227">   }</span>
<a href="#l17.2228"></a><span id="l17.2228"> </span>
<a href="#l17.2229"></a><span id="l17.2229">   // If we don't have an original message URI, nothing else to do...</span>
<a href="#l17.2230"></a><span id="l17.2230" class="difflineminus">-  if (!originalMsgURI || *originalMsgURI == 0)</span>
<a href="#l17.2231"></a><span id="l17.2231" class="difflineminus">-    return NS_OK;</span>
<a href="#l17.2232"></a><span id="l17.2232" class="difflineminus">-</span>
<a href="#l17.2233"></a><span id="l17.2233" class="difflineminus">-  // store the original message URI so we can extract it after we send the message to properly</span>
<a href="#l17.2234"></a><span id="l17.2234" class="difflineminus">-  // mark any disposition flags like replied or forwarded on the message.</span>
<a href="#l17.2235"></a><span id="l17.2235" class="difflineminus">-  if (mOriginalMsgURI.IsEmpty())</span>
<a href="#l17.2236"></a><span id="l17.2236" class="difflineminus">-    mOriginalMsgURI = originalMsgURI;</span>
<a href="#l17.2237"></a><span id="l17.2237" class="difflineminus">-</span>
<a href="#l17.2238"></a><span id="l17.2238" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefs (do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l17.2239"></a><span id="l17.2239" class="difflineplus">+  if (!originalMsgURI || *originalMsgURI == 0) return NS_OK;</span>
<a href="#l17.2240"></a><span id="l17.2240" class="difflineplus">+</span>
<a href="#l17.2241"></a><span id="l17.2241" class="difflineplus">+  // store the original message URI so we can extract it after we send the</span>
<a href="#l17.2242"></a><span id="l17.2242" class="difflineplus">+  // message to properly mark any disposition flags like replied or forwarded on</span>
<a href="#l17.2243"></a><span id="l17.2243" class="difflineplus">+  // the message.</span>
<a href="#l17.2244"></a><span id="l17.2244" class="difflineplus">+  if (mOriginalMsgURI.IsEmpty()) mOriginalMsgURI = originalMsgURI;</span>
<a href="#l17.2245"></a><span id="l17.2245" class="difflineplus">+</span>
<a href="#l17.2246"></a><span id="l17.2246" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l17.2247"></a><span id="l17.2247">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.2248"></a><span id="l17.2248"> </span>
<a href="#l17.2249"></a><span id="l17.2249">   // &quot;Forward inline&quot; and &quot;Reply with template&quot; processing.</span>
<a href="#l17.2250"></a><span id="l17.2250">   // Note the early return at the end of the block.</span>
<a href="#l17.2251"></a><span id="l17.2251">   if (type == nsIMsgCompType::ForwardInline ||</span>
<a href="#l17.2252"></a><span id="l17.2252" class="difflineminus">-      type == nsIMsgCompType::ReplyWithTemplate)</span>
<a href="#l17.2253"></a><span id="l17.2253" class="difflineminus">-  {</span>
<a href="#l17.2254"></a><span id="l17.2254" class="difflineplus">+      type == nsIMsgCompType::ReplyWithTemplate) {</span>
<a href="#l17.2255"></a><span id="l17.2255">     // Use charset set up in the compose fields by MIME unless we should</span>
<a href="#l17.2256"></a><span id="l17.2256">     // use the default charset.</span>
<a href="#l17.2257"></a><span id="l17.2257">     bool replyInDefault = false;</span>
<a href="#l17.2258"></a><span id="l17.2258" class="difflineminus">-    prefs-&gt;GetBoolPref(&quot;mailnews.reply_in_default_charset&quot;,</span>
<a href="#l17.2259"></a><span id="l17.2259" class="difflineminus">-                        &amp;replyInDefault);</span>
<a href="#l17.2260"></a><span id="l17.2260" class="difflineplus">+    prefs-&gt;GetBoolPref(&quot;mailnews.reply_in_default_charset&quot;, &amp;replyInDefault);</span>
<a href="#l17.2261"></a><span id="l17.2261">     // Use send_default_charset if reply_in_default_charset is on.</span>
<a href="#l17.2262"></a><span id="l17.2262" class="difflineminus">-    if (replyInDefault)</span>
<a href="#l17.2263"></a><span id="l17.2263" class="difflineminus">-    {</span>
<a href="#l17.2264"></a><span id="l17.2264" class="difflineplus">+    if (replyInDefault) {</span>
<a href="#l17.2265"></a><span id="l17.2265">       nsString str;</span>
<a href="#l17.2266"></a><span id="l17.2266">       nsCString charset;</span>
<a href="#l17.2267"></a><span id="l17.2267" class="difflineminus">-      NS_GetLocalizedUnicharPreferenceWithDefault(prefs, &quot;mailnews.send_default_charset&quot;,</span>
<a href="#l17.2268"></a><span id="l17.2268" class="difflineminus">-                                                  EmptyString(), str);</span>
<a href="#l17.2269"></a><span id="l17.2269" class="difflineminus">-      if (!str.IsEmpty())</span>
<a href="#l17.2270"></a><span id="l17.2270" class="difflineminus">-      {</span>
<a href="#l17.2271"></a><span id="l17.2271" class="difflineplus">+      NS_GetLocalizedUnicharPreferenceWithDefault(</span>
<a href="#l17.2272"></a><span id="l17.2272" class="difflineplus">+          prefs, &quot;mailnews.send_default_charset&quot;, EmptyString(), str);</span>
<a href="#l17.2273"></a><span id="l17.2273" class="difflineplus">+      if (!str.IsEmpty()) {</span>
<a href="#l17.2274"></a><span id="l17.2274">         LossyCopyUTF16toASCII(str, charset);</span>
<a href="#l17.2275"></a><span id="l17.2275">         m_compFields-&gt;SetCharacterSet(charset.get());</span>
<a href="#l17.2276"></a><span id="l17.2276">         mAnswerDefaultCharset = true;</span>
<a href="#l17.2277"></a><span id="l17.2277">       }</span>
<a href="#l17.2278"></a><span id="l17.2278">     }</span>
<a href="#l17.2279"></a><span id="l17.2279"> </span>
<a href="#l17.2280"></a><span id="l17.2280">     // We want to treat this message as a reference too</span>
<a href="#l17.2281"></a><span id="l17.2281">     nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l17.2282"></a><span id="l17.2282">     rv = GetMsgDBHdrFromURI(originalMsgURI, getter_AddRefs(msgHdr));</span>
<a href="#l17.2283"></a><span id="l17.2283" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l17.2284"></a><span id="l17.2284" class="difflineminus">-    {</span>
<a href="#l17.2285"></a><span id="l17.2285" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l17.2286"></a><span id="l17.2286">       nsAutoCString messageId;</span>
<a href="#l17.2287"></a><span id="l17.2287">       msgHdr-&gt;GetMessageId(getter_Copies(messageId));</span>
<a href="#l17.2288"></a><span id="l17.2288"> </span>
<a href="#l17.2289"></a><span id="l17.2289">       nsAutoCString reference;</span>
<a href="#l17.2290"></a><span id="l17.2290">       // When forwarding we only use the original message for &quot;References:&quot; -</span>
<a href="#l17.2291"></a><span id="l17.2291">       // recipients don't have the other messages anyway.</span>
<a href="#l17.2292"></a><span id="l17.2292">       // For reply with template we want to preserve all the references.</span>
<a href="#l17.2293"></a><span id="l17.2293" class="difflineminus">-      if (type == nsIMsgCompType::ReplyWithTemplate)</span>
<a href="#l17.2294"></a><span id="l17.2294" class="difflineminus">-      {</span>
<a href="#l17.2295"></a><span id="l17.2295" class="difflineplus">+      if (type == nsIMsgCompType::ReplyWithTemplate) {</span>
<a href="#l17.2296"></a><span id="l17.2296">         uint16_t numReferences = 0;</span>
<a href="#l17.2297"></a><span id="l17.2297">         msgHdr-&gt;GetNumReferences(&amp;numReferences);</span>
<a href="#l17.2298"></a><span id="l17.2298" class="difflineminus">-        for (int32_t i = 0; i &lt; numReferences; i++)</span>
<a href="#l17.2299"></a><span id="l17.2299" class="difflineminus">-        {</span>
<a href="#l17.2300"></a><span id="l17.2300" class="difflineplus">+        for (int32_t i = 0; i &lt; numReferences; i++) {</span>
<a href="#l17.2301"></a><span id="l17.2301">           nsAutoCString ref;</span>
<a href="#l17.2302"></a><span id="l17.2302">           msgHdr-&gt;GetStringReference(i, ref);</span>
<a href="#l17.2303"></a><span id="l17.2303" class="difflineminus">-          if (!ref.IsEmpty())</span>
<a href="#l17.2304"></a><span id="l17.2304" class="difflineminus">-          {</span>
<a href="#l17.2305"></a><span id="l17.2305" class="difflineplus">+          if (!ref.IsEmpty()) {</span>
<a href="#l17.2306"></a><span id="l17.2306">             reference.Append('&lt;');</span>
<a href="#l17.2307"></a><span id="l17.2307">             reference.Append(ref);</span>
<a href="#l17.2308"></a><span id="l17.2308">             reference.AppendLiteral(&quot;&gt; &quot;);</span>
<a href="#l17.2309"></a><span id="l17.2309">           }</span>
<a href="#l17.2310"></a><span id="l17.2310">         }</span>
<a href="#l17.2311"></a><span id="l17.2311">         reference.Trim(&quot; &quot;, false, true);</span>
<a href="#l17.2312"></a><span id="l17.2312">       }</span>
<a href="#l17.2313"></a><span id="l17.2313">       msgHdr-&gt;GetMessageId(getter_Copies(messageId));</span>
<a href="#l17.2314"></a><span id="l17.2314" class="difflineat">@@ -1967,18 +1810,17 @@ nsresult nsMsgCompose::CreateMessage(con</span>
<a href="#l17.2315"></a><span id="l17.2315">     }</span>
<a href="#l17.2316"></a><span id="l17.2316"> </span>
<a href="#l17.2317"></a><span id="l17.2317">     // Early return for &quot;Forward inline&quot; and &quot;Reply with template&quot; processing.</span>
<a href="#l17.2318"></a><span id="l17.2318">     return NS_OK;</span>
<a href="#l17.2319"></a><span id="l17.2319">   }</span>
<a href="#l17.2320"></a><span id="l17.2320"> </span>
<a href="#l17.2321"></a><span id="l17.2321">   // All other processing.</span>
<a href="#l17.2322"></a><span id="l17.2322">   char *uriList = PL_strdup(originalMsgURI);</span>
<a href="#l17.2323"></a><span id="l17.2323" class="difflineminus">-  if (!uriList)</span>
<a href="#l17.2324"></a><span id="l17.2324" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l17.2325"></a><span id="l17.2325" class="difflineplus">+  if (!uriList) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l17.2326"></a><span id="l17.2326"> </span>
<a href="#l17.2327"></a><span id="l17.2327">   // Resulting charset for this message.</span>
<a href="#l17.2328"></a><span id="l17.2328">   nsCString charset;</span>
<a href="#l17.2329"></a><span id="l17.2329"> </span>
<a href="#l17.2330"></a><span id="l17.2330">   // Check for the charset of the last displayed message, it</span>
<a href="#l17.2331"></a><span id="l17.2331">   // will be used for quoting and as override.</span>
<a href="#l17.2332"></a><span id="l17.2332">   nsCString windowCharset;</span>
<a href="#l17.2333"></a><span id="l17.2333">   mCharsetOverride = false;</span>
<a href="#l17.2334"></a><span id="l17.2334" class="difflineat">@@ -2001,55 +1843,47 @@ nsresult nsMsgCompose::CreateMessage(con</span>
<a href="#l17.2335"></a><span id="l17.2335">   // for five compose types: ForwardInline, ReplyWithTemplate (both covered</span>
<a href="#l17.2336"></a><span id="l17.2336">   // in the code block above) and Draft, Template and Redirect. For these</span>
<a href="#l17.2337"></a><span id="l17.2337">   // compose types, the charset is already correct (incl. MIME-applied override)</span>
<a href="#l17.2338"></a><span id="l17.2338">   // unless the default charset should be used.</span>
<a href="#l17.2339"></a><span id="l17.2339"> </span>
<a href="#l17.2340"></a><span id="l17.2340">   bool isFirstPass = true;</span>
<a href="#l17.2341"></a><span id="l17.2341">   char *uri = uriList;</span>
<a href="#l17.2342"></a><span id="l17.2342">   char *nextUri;</span>
<a href="#l17.2343"></a><span id="l17.2343" class="difflineminus">-  do</span>
<a href="#l17.2344"></a><span id="l17.2344" class="difflineminus">-  {</span>
<a href="#l17.2345"></a><span id="l17.2345" class="difflineplus">+  do {</span>
<a href="#l17.2346"></a><span id="l17.2346">     nextUri = strstr(uri, &quot;://&quot;);</span>
<a href="#l17.2347"></a><span id="l17.2347" class="difflineminus">-    if (nextUri)</span>
<a href="#l17.2348"></a><span id="l17.2348" class="difflineminus">-    {</span>
<a href="#l17.2349"></a><span id="l17.2349" class="difflineplus">+    if (nextUri) {</span>
<a href="#l17.2350"></a><span id="l17.2350">       // look for next ://, and then back up to previous ','</span>
<a href="#l17.2351"></a><span id="l17.2351">       nextUri = strstr(nextUri + 1, &quot;://&quot;);</span>
<a href="#l17.2352"></a><span id="l17.2352" class="difflineminus">-      if (nextUri)</span>
<a href="#l17.2353"></a><span id="l17.2353" class="difflineminus">-      {</span>
<a href="#l17.2354"></a><span id="l17.2354" class="difflineplus">+      if (nextUri) {</span>
<a href="#l17.2355"></a><span id="l17.2355">         *nextUri = '\0';</span>
<a href="#l17.2356"></a><span id="l17.2356">         char *saveNextUri = nextUri;</span>
<a href="#l17.2357"></a><span id="l17.2357">         nextUri = strrchr(uri, ',');</span>
<a href="#l17.2358"></a><span id="l17.2358" class="difflineminus">-        if (nextUri)</span>
<a href="#l17.2359"></a><span id="l17.2359" class="difflineminus">-          *nextUri = '\0';</span>
<a href="#l17.2360"></a><span id="l17.2360" class="difflineplus">+        if (nextUri) *nextUri = '\0';</span>
<a href="#l17.2361"></a><span id="l17.2361">         *saveNextUri = ':';</span>
<a href="#l17.2362"></a><span id="l17.2362">       }</span>
<a href="#l17.2363"></a><span id="l17.2363">     }</span>
<a href="#l17.2364"></a><span id="l17.2364"> </span>
<a href="#l17.2365"></a><span id="l17.2365" class="difflineminus">-    nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l17.2366"></a><span id="l17.2366" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l17.2367"></a><span id="l17.2367">     if (mOrigMsgHdr)</span>
<a href="#l17.2368"></a><span id="l17.2368">       msgHdr = mOrigMsgHdr;</span>
<a href="#l17.2369"></a><span id="l17.2369" class="difflineminus">-    else</span>
<a href="#l17.2370"></a><span id="l17.2370" class="difflineminus">-    {</span>
<a href="#l17.2371"></a><span id="l17.2371" class="difflineplus">+    else {</span>
<a href="#l17.2372"></a><span id="l17.2372">       rv = GetMsgDBHdrFromURI(uri, getter_AddRefs(msgHdr));</span>
<a href="#l17.2373"></a><span id="l17.2373" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.2374"></a><span id="l17.2374" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.2375"></a><span id="l17.2375">     }</span>
<a href="#l17.2376"></a><span id="l17.2376" class="difflineminus">-    if (msgHdr)</span>
<a href="#l17.2377"></a><span id="l17.2377" class="difflineminus">-    {</span>
<a href="#l17.2378"></a><span id="l17.2378" class="difflineplus">+    if (msgHdr) {</span>
<a href="#l17.2379"></a><span id="l17.2379">       nsCString decodedCString;</span>
<a href="#l17.2380"></a><span id="l17.2380"> </span>
<a href="#l17.2381"></a><span id="l17.2381">       bool replyInDefault = false;</span>
<a href="#l17.2382"></a><span id="l17.2382" class="difflineminus">-      prefs-&gt;GetBoolPref(&quot;mailnews.reply_in_default_charset&quot;,</span>
<a href="#l17.2383"></a><span id="l17.2383" class="difflineminus">-                          &amp;replyInDefault);</span>
<a href="#l17.2384"></a><span id="l17.2384" class="difflineplus">+      prefs-&gt;GetBoolPref(&quot;mailnews.reply_in_default_charset&quot;, &amp;replyInDefault);</span>
<a href="#l17.2385"></a><span id="l17.2385">       // Use send_default_charset if reply_in_default_charset is on.</span>
<a href="#l17.2386"></a><span id="l17.2386" class="difflineminus">-      if (replyInDefault)</span>
<a href="#l17.2387"></a><span id="l17.2387" class="difflineminus">-      {</span>
<a href="#l17.2388"></a><span id="l17.2388" class="difflineplus">+      if (replyInDefault) {</span>
<a href="#l17.2389"></a><span id="l17.2389">         nsString str;</span>
<a href="#l17.2390"></a><span id="l17.2390" class="difflineminus">-        NS_GetLocalizedUnicharPreferenceWithDefault(prefs, &quot;mailnews.send_default_charset&quot;,</span>
<a href="#l17.2391"></a><span id="l17.2391" class="difflineminus">-                                                    EmptyString(), str);</span>
<a href="#l17.2392"></a><span id="l17.2392" class="difflineplus">+        NS_GetLocalizedUnicharPreferenceWithDefault(</span>
<a href="#l17.2393"></a><span id="l17.2393" class="difflineplus">+            prefs, &quot;mailnews.send_default_charset&quot;, EmptyString(), str);</span>
<a href="#l17.2394"></a><span id="l17.2394">         if (!str.IsEmpty()) {</span>
<a href="#l17.2395"></a><span id="l17.2395">           LossyCopyUTF16toASCII(str, charset);</span>
<a href="#l17.2396"></a><span id="l17.2396">           mAnswerDefaultCharset = true;</span>
<a href="#l17.2397"></a><span id="l17.2397">         }</span>
<a href="#l17.2398"></a><span id="l17.2398">       }</span>
<a href="#l17.2399"></a><span id="l17.2399"> </span>
<a href="#l17.2400"></a><span id="l17.2400">       // Set the charset we determined, if any, in the comp fields.</span>
<a href="#l17.2401"></a><span id="l17.2401">       // For replies, the charset will be set after processing the message</span>
<a href="#l17.2402"></a><span id="l17.2402" class="difflineat">@@ -2080,461 +1914,412 @@ nsresult nsMsgCompose::CreateMessage(con</span>
<a href="#l17.2403"></a><span id="l17.2403">             nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l17.2404"></a><span id="l17.2404">             folder-&gt;GetMsgDatabase(getter_AddRefs(db));</span>
<a href="#l17.2405"></a><span id="l17.2405"> </span>
<a href="#l17.2406"></a><span id="l17.2406">             if (db) {</span>
<a href="#l17.2407"></a><span id="l17.2407">               nsAutoCString reference;</span>
<a href="#l17.2408"></a><span id="l17.2408">               msgHdr-&gt;GetStringReference(0, reference);</span>
<a href="#l17.2409"></a><span id="l17.2409"> </span>
<a href="#l17.2410"></a><span id="l17.2410">               nsCOMPtr&lt;nsIMsgDBHdr&gt; refHdr;</span>
<a href="#l17.2411"></a><span id="l17.2411" class="difflineminus">-              db-&gt;GetMsgHdrForMessageID(reference.get(), getter_AddRefs(refHdr));</span>
<a href="#l17.2412"></a><span id="l17.2412" class="difflineplus">+              db-&gt;GetMsgHdrForMessageID(reference.get(),</span>
<a href="#l17.2413"></a><span id="l17.2413" class="difflineplus">+                                        getter_AddRefs(refHdr));</span>
<a href="#l17.2414"></a><span id="l17.2414"> </span>
<a href="#l17.2415"></a><span id="l17.2415">               if (refHdr) {</span>
<a href="#l17.2416"></a><span id="l17.2416">                 nsCString refSubject;</span>
<a href="#l17.2417"></a><span id="l17.2417">                 rv = refHdr-&gt;GetSubject(getter_Copies(refSubject));</span>
<a href="#l17.2418"></a><span id="l17.2418">                 if (NS_SUCCEEDED(rv)) {</span>
<a href="#l17.2419"></a><span id="l17.2419" class="difflineminus">-                  if (refSubject.Find(&quot; (was:&quot;) &gt;= 0)</span>
<a href="#l17.2420"></a><span id="l17.2420" class="difflineminus">-                    strip = false;</span>
<a href="#l17.2421"></a><span id="l17.2421" class="difflineplus">+                  if (refSubject.Find(&quot; (was:&quot;) &gt;= 0) strip = false;</span>
<a href="#l17.2422"></a><span id="l17.2422">                 }</span>
<a href="#l17.2423"></a><span id="l17.2423">               }</span>
<a href="#l17.2424"></a><span id="l17.2424">             }</span>
<a href="#l17.2425"></a><span id="l17.2425">           }</span>
<a href="#l17.2426"></a><span id="l17.2426" class="difflineminus">-        }</span>
<a href="#l17.2427"></a><span id="l17.2427" class="difflineminus">-        else</span>
<a href="#l17.2428"></a><span id="l17.2428" class="difflineplus">+        } else</span>
<a href="#l17.2429"></a><span id="l17.2429">           strip = false;</span>
<a href="#l17.2430"></a><span id="l17.2430">       }</span>
<a href="#l17.2431"></a><span id="l17.2431"> </span>
<a href="#l17.2432"></a><span id="l17.2432">       if (strip &amp;&amp; wasOffset &gt;= 0) {</span>
<a href="#l17.2433"></a><span id="l17.2433">         // Strip off the &quot;(was: old subject)&quot; part</span>
<a href="#l17.2434"></a><span id="l17.2434">         subject.Assign(Substring(subject, 0, wasOffset));</span>
<a href="#l17.2435"></a><span id="l17.2435">       }</span>
<a href="#l17.2436"></a><span id="l17.2436"> </span>
<a href="#l17.2437"></a><span id="l17.2437" class="difflineminus">-      switch (type)</span>
<a href="#l17.2438"></a><span id="l17.2438" class="difflineminus">-      {</span>
<a href="#l17.2439"></a><span id="l17.2439" class="difflineminus">-        default: break;</span>
<a href="#l17.2440"></a><span id="l17.2440" class="difflineminus">-        case nsIMsgCompType::Reply :</span>
<a href="#l17.2441"></a><span id="l17.2441" class="difflineplus">+      switch (type) {</span>
<a href="#l17.2442"></a><span id="l17.2442" class="difflineplus">+        default:</span>
<a href="#l17.2443"></a><span id="l17.2443" class="difflineplus">+          break;</span>
<a href="#l17.2444"></a><span id="l17.2444" class="difflineplus">+        case nsIMsgCompType::Reply:</span>
<a href="#l17.2445"></a><span id="l17.2445">         case nsIMsgCompType::ReplyAll:</span>
<a href="#l17.2446"></a><span id="l17.2446">         case nsIMsgCompType::ReplyToList:</span>
<a href="#l17.2447"></a><span id="l17.2447">         case nsIMsgCompType::ReplyToGroup:</span>
<a href="#l17.2448"></a><span id="l17.2448">         case nsIMsgCompType::ReplyToSender:</span>
<a href="#l17.2449"></a><span id="l17.2449" class="difflineminus">-        case nsIMsgCompType::ReplyToSenderAndGroup:</span>
<a href="#l17.2450"></a><span id="l17.2450" class="difflineminus">-          {</span>
<a href="#l17.2451"></a><span id="l17.2451" class="difflineminus">-            if (!isFirstPass)       // safeguard, just in case...</span>
<a href="#l17.2452"></a><span id="l17.2452" class="difflineminus">-            {</span>
<a href="#l17.2453"></a><span id="l17.2453" class="difflineminus">-              PR_Free(uriList);</span>
<a href="#l17.2454"></a><span id="l17.2454" class="difflineminus">-              return rv;</span>
<a href="#l17.2455"></a><span id="l17.2455" class="difflineminus">-            }</span>
<a href="#l17.2456"></a><span id="l17.2456" class="difflineminus">-            mQuotingToFollow = true;</span>
<a href="#l17.2457"></a><span id="l17.2457" class="difflineminus">-</span>
<a href="#l17.2458"></a><span id="l17.2458" class="difflineminus">-            subject.InsertLiteral(u&quot;Re: &quot;, 0);</span>
<a href="#l17.2459"></a><span id="l17.2459" class="difflineminus">-            m_compFields-&gt;SetSubject(subject);</span>
<a href="#l17.2460"></a><span id="l17.2460" class="difflineminus">-</span>
<a href="#l17.2461"></a><span id="l17.2461" class="difflineminus">-            // Setup quoting callbacks for later...</span>
<a href="#l17.2462"></a><span id="l17.2462" class="difflineminus">-            mWhatHolder = 1;</span>
<a href="#l17.2463"></a><span id="l17.2463" class="difflineminus">-            break;</span>
<a href="#l17.2464"></a><span id="l17.2464" class="difflineminus">-          }</span>
<a href="#l17.2465"></a><span id="l17.2465" class="difflineminus">-        case nsIMsgCompType::ForwardAsAttachment:</span>
<a href="#l17.2466"></a><span id="l17.2466" class="difflineplus">+        case nsIMsgCompType::ReplyToSenderAndGroup: {</span>
<a href="#l17.2467"></a><span id="l17.2467" class="difflineplus">+          if (!isFirstPass)  // safeguard, just in case...</span>
<a href="#l17.2468"></a><span id="l17.2468">           {</span>
<a href="#l17.2469"></a><span id="l17.2469" class="difflineminus">-            // Add the forwarded message in the references, first</span>
<a href="#l17.2470"></a><span id="l17.2470" class="difflineminus">-            nsAutoCString messageId;</span>
<a href="#l17.2471"></a><span id="l17.2471" class="difflineminus">-            msgHdr-&gt;GetMessageId(getter_Copies(messageId));</span>
<a href="#l17.2472"></a><span id="l17.2472" class="difflineminus">-            if (isFirstPass)</span>
<a href="#l17.2473"></a><span id="l17.2473" class="difflineminus">-            {</span>
<a href="#l17.2474"></a><span id="l17.2474" class="difflineminus">-              nsAutoCString reference;</span>
<a href="#l17.2475"></a><span id="l17.2475" class="difflineminus">-              reference.Append('&lt;');</span>
<a href="#l17.2476"></a><span id="l17.2476" class="difflineminus">-              reference.Append(messageId);</span>
<a href="#l17.2477"></a><span id="l17.2477" class="difflineminus">-              reference.Append('&gt;');</span>
<a href="#l17.2478"></a><span id="l17.2478" class="difflineminus">-              m_compFields-&gt;SetReferences(reference.get());</span>
<a href="#l17.2479"></a><span id="l17.2479" class="difflineminus">-            }</span>
<a href="#l17.2480"></a><span id="l17.2480" class="difflineminus">-            else</span>
<a href="#l17.2481"></a><span id="l17.2481" class="difflineminus">-            {</span>
<a href="#l17.2482"></a><span id="l17.2482" class="difflineminus">-              nsAutoCString references;</span>
<a href="#l17.2483"></a><span id="l17.2483" class="difflineminus">-              m_compFields-&gt;GetReferences(getter_Copies(references));</span>
<a href="#l17.2484"></a><span id="l17.2484" class="difflineminus">-              references.AppendLiteral(&quot; &lt;&quot;);</span>
<a href="#l17.2485"></a><span id="l17.2485" class="difflineminus">-              references.Append(messageId);</span>
<a href="#l17.2486"></a><span id="l17.2486" class="difflineminus">-              references.Append('&gt;');</span>
<a href="#l17.2487"></a><span id="l17.2487" class="difflineminus">-              m_compFields-&gt;SetReferences(references.get());</span>
<a href="#l17.2488"></a><span id="l17.2488" class="difflineminus">-            }</span>
<a href="#l17.2489"></a><span id="l17.2489" class="difflineminus">-</span>
<a href="#l17.2490"></a><span id="l17.2490" class="difflineminus">-            uint32_t flags;</span>
<a href="#l17.2491"></a><span id="l17.2491" class="difflineminus">-</span>
<a href="#l17.2492"></a><span id="l17.2492" class="difflineminus">-            msgHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l17.2493"></a><span id="l17.2493" class="difflineminus">-            if (flags &amp; nsMsgMessageFlags::HasRe)</span>
<a href="#l17.2494"></a><span id="l17.2494" class="difflineminus">-              subject.InsertLiteral(u&quot;Re: &quot;, 0);</span>
<a href="#l17.2495"></a><span id="l17.2495" class="difflineminus">-</span>
<a href="#l17.2496"></a><span id="l17.2496" class="difflineminus">-            // Setup quoting callbacks for later...</span>
<a href="#l17.2497"></a><span id="l17.2497" class="difflineminus">-            mQuotingToFollow = false;  //We don't need to quote the original message.</span>
<a href="#l17.2498"></a><span id="l17.2498" class="difflineminus">-            nsCOMPtr&lt;nsIMsgAttachment&gt; attachment = do_CreateInstance(NS_MSGATTACHMENT_CONTRACTID, &amp;rv);</span>
<a href="#l17.2499"></a><span id="l17.2499" class="difflineminus">-            if (NS_SUCCEEDED(rv) &amp;&amp; attachment)</span>
<a href="#l17.2500"></a><span id="l17.2500" class="difflineminus">-            {</span>
<a href="#l17.2501"></a><span id="l17.2501" class="difflineminus">-              bool addExtension = true;</span>
<a href="#l17.2502"></a><span id="l17.2502" class="difflineminus">-              nsString sanitizedSubj;</span>
<a href="#l17.2503"></a><span id="l17.2503" class="difflineminus">-              prefs-&gt;GetBoolPref(&quot;mail.forward_add_extension&quot;, &amp;addExtension);</span>
<a href="#l17.2504"></a><span id="l17.2504" class="difflineminus">-</span>
<a href="#l17.2505"></a><span id="l17.2505" class="difflineminus">-              // copy subject string to sanitizedSubj, use default if empty</span>
<a href="#l17.2506"></a><span id="l17.2506" class="difflineminus">-              if (subject.IsEmpty())</span>
<a href="#l17.2507"></a><span id="l17.2507" class="difflineminus">-              {</span>
<a href="#l17.2508"></a><span id="l17.2508" class="difflineminus">-                nsresult rv;</span>
<a href="#l17.2509"></a><span id="l17.2509" class="difflineminus">-                nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l17.2510"></a><span id="l17.2510" class="difflineplus">+            PR_Free(uriList);</span>
<a href="#l17.2511"></a><span id="l17.2511" class="difflineplus">+            return rv;</span>
<a href="#l17.2512"></a><span id="l17.2512" class="difflineplus">+          }</span>
<a href="#l17.2513"></a><span id="l17.2513" class="difflineplus">+          mQuotingToFollow = true;</span>
<a href="#l17.2514"></a><span id="l17.2514" class="difflineplus">+</span>
<a href="#l17.2515"></a><span id="l17.2515" class="difflineplus">+          subject.InsertLiteral(u&quot;Re: &quot;, 0);</span>
<a href="#l17.2516"></a><span id="l17.2516" class="difflineplus">+          m_compFields-&gt;SetSubject(subject);</span>
<a href="#l17.2517"></a><span id="l17.2517" class="difflineplus">+</span>
<a href="#l17.2518"></a><span id="l17.2518" class="difflineplus">+          // Setup quoting callbacks for later...</span>
<a href="#l17.2519"></a><span id="l17.2519" class="difflineplus">+          mWhatHolder = 1;</span>
<a href="#l17.2520"></a><span id="l17.2520" class="difflineplus">+          break;</span>
<a href="#l17.2521"></a><span id="l17.2521" class="difflineplus">+        }</span>
<a href="#l17.2522"></a><span id="l17.2522" class="difflineplus">+        case nsIMsgCompType::ForwardAsAttachment: {</span>
<a href="#l17.2523"></a><span id="l17.2523" class="difflineplus">+          // Add the forwarded message in the references, first</span>
<a href="#l17.2524"></a><span id="l17.2524" class="difflineplus">+          nsAutoCString messageId;</span>
<a href="#l17.2525"></a><span id="l17.2525" class="difflineplus">+          msgHdr-&gt;GetMessageId(getter_Copies(messageId));</span>
<a href="#l17.2526"></a><span id="l17.2526" class="difflineplus">+          if (isFirstPass) {</span>
<a href="#l17.2527"></a><span id="l17.2527" class="difflineplus">+            nsAutoCString reference;</span>
<a href="#l17.2528"></a><span id="l17.2528" class="difflineplus">+            reference.Append('&lt;');</span>
<a href="#l17.2529"></a><span id="l17.2529" class="difflineplus">+            reference.Append(messageId);</span>
<a href="#l17.2530"></a><span id="l17.2530" class="difflineplus">+            reference.Append('&gt;');</span>
<a href="#l17.2531"></a><span id="l17.2531" class="difflineplus">+            m_compFields-&gt;SetReferences(reference.get());</span>
<a href="#l17.2532"></a><span id="l17.2532" class="difflineplus">+          } else {</span>
<a href="#l17.2533"></a><span id="l17.2533" class="difflineplus">+            nsAutoCString references;</span>
<a href="#l17.2534"></a><span id="l17.2534" class="difflineplus">+            m_compFields-&gt;GetReferences(getter_Copies(references));</span>
<a href="#l17.2535"></a><span id="l17.2535" class="difflineplus">+            references.AppendLiteral(&quot; &lt;&quot;);</span>
<a href="#l17.2536"></a><span id="l17.2536" class="difflineplus">+            references.Append(messageId);</span>
<a href="#l17.2537"></a><span id="l17.2537" class="difflineplus">+            references.Append('&gt;');</span>
<a href="#l17.2538"></a><span id="l17.2538" class="difflineplus">+            m_compFields-&gt;SetReferences(references.get());</span>
<a href="#l17.2539"></a><span id="l17.2539" class="difflineplus">+          }</span>
<a href="#l17.2540"></a><span id="l17.2540" class="difflineplus">+</span>
<a href="#l17.2541"></a><span id="l17.2541" class="difflineplus">+          uint32_t flags;</span>
<a href="#l17.2542"></a><span id="l17.2542" class="difflineplus">+</span>
<a href="#l17.2543"></a><span id="l17.2543" class="difflineplus">+          msgHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l17.2544"></a><span id="l17.2544" class="difflineplus">+          if (flags &amp; nsMsgMessageFlags::HasRe)</span>
<a href="#l17.2545"></a><span id="l17.2545" class="difflineplus">+            subject.InsertLiteral(u&quot;Re: &quot;, 0);</span>
<a href="#l17.2546"></a><span id="l17.2546" class="difflineplus">+</span>
<a href="#l17.2547"></a><span id="l17.2547" class="difflineplus">+          // Setup quoting callbacks for later...</span>
<a href="#l17.2548"></a><span id="l17.2548" class="difflineplus">+          mQuotingToFollow =</span>
<a href="#l17.2549"></a><span id="l17.2549" class="difflineplus">+              false;  // We don't need to quote the original message.</span>
<a href="#l17.2550"></a><span id="l17.2550" class="difflineplus">+          nsCOMPtr&lt;nsIMsgAttachment&gt; attachment =</span>
<a href="#l17.2551"></a><span id="l17.2551" class="difflineplus">+              do_CreateInstance(NS_MSGATTACHMENT_CONTRACTID, &amp;rv);</span>
<a href="#l17.2552"></a><span id="l17.2552" class="difflineplus">+          if (NS_SUCCEEDED(rv) &amp;&amp; attachment) {</span>
<a href="#l17.2553"></a><span id="l17.2553" class="difflineplus">+            bool addExtension = true;</span>
<a href="#l17.2554"></a><span id="l17.2554" class="difflineplus">+            nsString sanitizedSubj;</span>
<a href="#l17.2555"></a><span id="l17.2555" class="difflineplus">+            prefs-&gt;GetBoolPref(&quot;mail.forward_add_extension&quot;, &amp;addExtension);</span>
<a href="#l17.2556"></a><span id="l17.2556" class="difflineplus">+</span>
<a href="#l17.2557"></a><span id="l17.2557" class="difflineplus">+            // copy subject string to sanitizedSubj, use default if empty</span>
<a href="#l17.2558"></a><span id="l17.2558" class="difflineplus">+            if (subject.IsEmpty()) {</span>
<a href="#l17.2559"></a><span id="l17.2559" class="difflineplus">+              nsresult rv;</span>
<a href="#l17.2560"></a><span id="l17.2560" class="difflineplus">+              nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l17.2561"></a><span id="l17.2561">                   mozilla::services::GetStringBundleService();</span>
<a href="#l17.2562"></a><span id="l17.2562" class="difflineminus">-                NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l17.2563"></a><span id="l17.2563" class="difflineminus">-                nsCOMPtr&lt;nsIStringBundle&gt; composeBundle;</span>
<a href="#l17.2564"></a><span id="l17.2564" class="difflineminus">-                rv = bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/messengercompose/composeMsgs.properties&quot;,</span>
<a href="#l17.2565"></a><span id="l17.2565" class="difflineminus">-                                                 getter_AddRefs(composeBundle));</span>
<a href="#l17.2566"></a><span id="l17.2566" class="difflineminus">-                NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.2567"></a><span id="l17.2567" class="difflineminus">-                composeBundle-&gt;GetStringFromName(&quot;messageAttachmentSafeName&quot;,</span>
<a href="#l17.2568"></a><span id="l17.2568" class="difflineminus">-                                                 sanitizedSubj);</span>
<a href="#l17.2569"></a><span id="l17.2569" class="difflineminus">-              }</span>
<a href="#l17.2570"></a><span id="l17.2570" class="difflineminus">-              else</span>
<a href="#l17.2571"></a><span id="l17.2571" class="difflineminus">-                sanitizedSubj.Assign(subject);</span>
<a href="#l17.2572"></a><span id="l17.2572" class="difflineminus">-</span>
<a href="#l17.2573"></a><span id="l17.2573" class="difflineminus">-              // set the file size</span>
<a href="#l17.2574"></a><span id="l17.2574" class="difflineminus">-              uint32_t messageSize;</span>
<a href="#l17.2575"></a><span id="l17.2575" class="difflineminus">-              msgHdr-&gt;GetMessageSize(&amp;messageSize);</span>
<a href="#l17.2576"></a><span id="l17.2576" class="difflineminus">-              attachment-&gt;SetSize(messageSize);</span>
<a href="#l17.2577"></a><span id="l17.2577" class="difflineminus">-</span>
<a href="#l17.2578"></a><span id="l17.2578" class="difflineminus">-              // change all '.' to '_'  see bug #271211</span>
<a href="#l17.2579"></a><span id="l17.2579" class="difflineminus">-              MsgReplaceChar(sanitizedSubj, &quot;.&quot;, '_');</span>
<a href="#l17.2580"></a><span id="l17.2580" class="difflineminus">-              if (addExtension)</span>
<a href="#l17.2581"></a><span id="l17.2581" class="difflineminus">-                sanitizedSubj.AppendLiteral(&quot;.eml&quot;);</span>
<a href="#l17.2582"></a><span id="l17.2582" class="difflineminus">-              attachment-&gt;SetName(sanitizedSubj);</span>
<a href="#l17.2583"></a><span id="l17.2583" class="difflineminus">-              attachment-&gt;SetUrl(nsDependentCString(uri));</span>
<a href="#l17.2584"></a><span id="l17.2584" class="difflineminus">-              m_compFields-&gt;AddAttachment(attachment);</span>
<a href="#l17.2585"></a><span id="l17.2585" class="difflineplus">+              NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l17.2586"></a><span id="l17.2586" class="difflineplus">+              nsCOMPtr&lt;nsIStringBundle&gt; composeBundle;</span>
<a href="#l17.2587"></a><span id="l17.2587" class="difflineplus">+              rv = bundleService-&gt;CreateBundle(</span>
<a href="#l17.2588"></a><span id="l17.2588" class="difflineplus">+                  &quot;chrome://messenger/locale/messengercompose/&quot;</span>
<a href="#l17.2589"></a><span id="l17.2589" class="difflineplus">+                  &quot;composeMsgs.properties&quot;,</span>
<a href="#l17.2590"></a><span id="l17.2590" class="difflineplus">+                  getter_AddRefs(composeBundle));</span>
<a href="#l17.2591"></a><span id="l17.2591" class="difflineplus">+              NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.2592"></a><span id="l17.2592" class="difflineplus">+              composeBundle-&gt;GetStringFromName(&quot;messageAttachmentSafeName&quot;,</span>
<a href="#l17.2593"></a><span id="l17.2593" class="difflineplus">+                                               sanitizedSubj);</span>
<a href="#l17.2594"></a><span id="l17.2594" class="difflineplus">+            } else</span>
<a href="#l17.2595"></a><span id="l17.2595" class="difflineplus">+              sanitizedSubj.Assign(subject);</span>
<a href="#l17.2596"></a><span id="l17.2596" class="difflineplus">+</span>
<a href="#l17.2597"></a><span id="l17.2597" class="difflineplus">+            // set the file size</span>
<a href="#l17.2598"></a><span id="l17.2598" class="difflineplus">+            uint32_t messageSize;</span>
<a href="#l17.2599"></a><span id="l17.2599" class="difflineplus">+            msgHdr-&gt;GetMessageSize(&amp;messageSize);</span>
<a href="#l17.2600"></a><span id="l17.2600" class="difflineplus">+            attachment-&gt;SetSize(messageSize);</span>
<a href="#l17.2601"></a><span id="l17.2601" class="difflineplus">+</span>
<a href="#l17.2602"></a><span id="l17.2602" class="difflineplus">+            // change all '.' to '_'  see bug #271211</span>
<a href="#l17.2603"></a><span id="l17.2603" class="difflineplus">+            MsgReplaceChar(sanitizedSubj, &quot;.&quot;, '_');</span>
<a href="#l17.2604"></a><span id="l17.2604" class="difflineplus">+            if (addExtension) sanitizedSubj.AppendLiteral(&quot;.eml&quot;);</span>
<a href="#l17.2605"></a><span id="l17.2605" class="difflineplus">+            attachment-&gt;SetName(sanitizedSubj);</span>
<a href="#l17.2606"></a><span id="l17.2606" class="difflineplus">+            attachment-&gt;SetUrl(nsDependentCString(uri));</span>
<a href="#l17.2607"></a><span id="l17.2607" class="difflineplus">+            m_compFields-&gt;AddAttachment(attachment);</span>
<a href="#l17.2608"></a><span id="l17.2608" class="difflineplus">+          }</span>
<a href="#l17.2609"></a><span id="l17.2609" class="difflineplus">+</span>
<a href="#l17.2610"></a><span id="l17.2610" class="difflineplus">+          if (isFirstPass) {</span>
<a href="#l17.2611"></a><span id="l17.2611" class="difflineplus">+            nsCString fwdPrefix;</span>
<a href="#l17.2612"></a><span id="l17.2612" class="difflineplus">+            prefs-&gt;GetCharPref(&quot;mail.forward_subject_prefix&quot;, fwdPrefix);</span>
<a href="#l17.2613"></a><span id="l17.2613" class="difflineplus">+            if (!fwdPrefix.IsEmpty()) {</span>
<a href="#l17.2614"></a><span id="l17.2614" class="difflineplus">+              nsString unicodeFwdPrefix;</span>
<a href="#l17.2615"></a><span id="l17.2615" class="difflineplus">+              CopyUTF8toUTF16(fwdPrefix, unicodeFwdPrefix);</span>
<a href="#l17.2616"></a><span id="l17.2616" class="difflineplus">+              unicodeFwdPrefix.AppendLiteral(&quot;: &quot;);</span>
<a href="#l17.2617"></a><span id="l17.2617" class="difflineplus">+              subject.Insert(unicodeFwdPrefix, 0);</span>
<a href="#l17.2618"></a><span id="l17.2618" class="difflineplus">+            } else {</span>
<a href="#l17.2619"></a><span id="l17.2619" class="difflineplus">+              subject.InsertLiteral(u&quot;Fwd: &quot;, 0);</span>
<a href="#l17.2620"></a><span id="l17.2620">             }</span>
<a href="#l17.2621"></a><span id="l17.2621" class="difflineminus">-</span>
<a href="#l17.2622"></a><span id="l17.2622" class="difflineminus">-            if (isFirstPass)</span>
<a href="#l17.2623"></a><span id="l17.2623" class="difflineminus">-            {</span>
<a href="#l17.2624"></a><span id="l17.2624" class="difflineminus">-              nsCString fwdPrefix;</span>
<a href="#l17.2625"></a><span id="l17.2625" class="difflineminus">-              prefs-&gt;GetCharPref(&quot;mail.forward_subject_prefix&quot;, fwdPrefix);</span>
<a href="#l17.2626"></a><span id="l17.2626" class="difflineminus">-              if (!fwdPrefix.IsEmpty())</span>
<a href="#l17.2627"></a><span id="l17.2627" class="difflineminus">-              {</span>
<a href="#l17.2628"></a><span id="l17.2628" class="difflineminus">-                nsString unicodeFwdPrefix;</span>
<a href="#l17.2629"></a><span id="l17.2629" class="difflineminus">-                CopyUTF8toUTF16(fwdPrefix, unicodeFwdPrefix);</span>
<a href="#l17.2630"></a><span id="l17.2630" class="difflineminus">-                unicodeFwdPrefix.AppendLiteral(&quot;: &quot;);</span>
<a href="#l17.2631"></a><span id="l17.2631" class="difflineminus">-                subject.Insert(unicodeFwdPrefix, 0);</span>
<a href="#l17.2632"></a><span id="l17.2632" class="difflineminus">-              }</span>
<a href="#l17.2633"></a><span id="l17.2633" class="difflineminus">-              else</span>
<a href="#l17.2634"></a><span id="l17.2634" class="difflineminus">-              {</span>
<a href="#l17.2635"></a><span id="l17.2635" class="difflineminus">-                subject.InsertLiteral(u&quot;Fwd: &quot;, 0);</span>
<a href="#l17.2636"></a><span id="l17.2636" class="difflineminus">-              }</span>
<a href="#l17.2637"></a><span id="l17.2637" class="difflineminus">-              m_compFields-&gt;SetSubject(subject);</span>
<a href="#l17.2638"></a><span id="l17.2638" class="difflineminus">-            }</span>
<a href="#l17.2639"></a><span id="l17.2639" class="difflineminus">-            break;</span>
<a href="#l17.2640"></a><span id="l17.2640" class="difflineplus">+            m_compFields-&gt;SetSubject(subject);</span>
<a href="#l17.2641"></a><span id="l17.2641">           }</span>
<a href="#l17.2642"></a><span id="l17.2642" class="difflineminus">-        case nsIMsgCompType::Redirect:</span>
<a href="#l17.2643"></a><span id="l17.2643" class="difflineminus">-          {</span>
<a href="#l17.2644"></a><span id="l17.2644" class="difflineminus">-            // For a redirect, set the Reply-To: header to what was in the original From: header...</span>
<a href="#l17.2645"></a><span id="l17.2645" class="difflineminus">-            nsAutoCString author;</span>
<a href="#l17.2646"></a><span id="l17.2646" class="difflineminus">-            msgHdr-&gt;GetAuthor(getter_Copies(author));</span>
<a href="#l17.2647"></a><span id="l17.2647" class="difflineminus">-            m_compFields-&gt;SetReplyTo(author.get());</span>
<a href="#l17.2648"></a><span id="l17.2648" class="difflineminus">-</span>
<a href="#l17.2649"></a><span id="l17.2649" class="difflineminus">-            // ... and empty out the various recipient headers</span>
<a href="#l17.2650"></a><span id="l17.2650" class="difflineminus">-            nsAutoString empty;</span>
<a href="#l17.2651"></a><span id="l17.2651" class="difflineminus">-            m_compFields-&gt;SetTo(empty);</span>
<a href="#l17.2652"></a><span id="l17.2652" class="difflineminus">-            m_compFields-&gt;SetCc(empty);</span>
<a href="#l17.2653"></a><span id="l17.2653" class="difflineminus">-            m_compFields-&gt;SetBcc(empty);</span>
<a href="#l17.2654"></a><span id="l17.2654" class="difflineminus">-            m_compFields-&gt;SetNewsgroups(empty);</span>
<a href="#l17.2655"></a><span id="l17.2655" class="difflineminus">-            m_compFields-&gt;SetFollowupTo(empty);</span>
<a href="#l17.2656"></a><span id="l17.2656" class="difflineminus">-            break;</span>
<a href="#l17.2657"></a><span id="l17.2657" class="difflineminus">-          }</span>
<a href="#l17.2658"></a><span id="l17.2658" class="difflineplus">+          break;</span>
<a href="#l17.2659"></a><span id="l17.2659" class="difflineplus">+        }</span>
<a href="#l17.2660"></a><span id="l17.2660" class="difflineplus">+        case nsIMsgCompType::Redirect: {</span>
<a href="#l17.2661"></a><span id="l17.2661" class="difflineplus">+          // For a redirect, set the Reply-To: header to what was in the</span>
<a href="#l17.2662"></a><span id="l17.2662" class="difflineplus">+          // original From: header...</span>
<a href="#l17.2663"></a><span id="l17.2663" class="difflineplus">+          nsAutoCString author;</span>
<a href="#l17.2664"></a><span id="l17.2664" class="difflineplus">+          msgHdr-&gt;GetAuthor(getter_Copies(author));</span>
<a href="#l17.2665"></a><span id="l17.2665" class="difflineplus">+          m_compFields-&gt;SetReplyTo(author.get());</span>
<a href="#l17.2666"></a><span id="l17.2666" class="difflineplus">+</span>
<a href="#l17.2667"></a><span id="l17.2667" class="difflineplus">+          // ... and empty out the various recipient headers</span>
<a href="#l17.2668"></a><span id="l17.2668" class="difflineplus">+          nsAutoString empty;</span>
<a href="#l17.2669"></a><span id="l17.2669" class="difflineplus">+          m_compFields-&gt;SetTo(empty);</span>
<a href="#l17.2670"></a><span id="l17.2670" class="difflineplus">+          m_compFields-&gt;SetCc(empty);</span>
<a href="#l17.2671"></a><span id="l17.2671" class="difflineplus">+          m_compFields-&gt;SetBcc(empty);</span>
<a href="#l17.2672"></a><span id="l17.2672" class="difflineplus">+          m_compFields-&gt;SetNewsgroups(empty);</span>
<a href="#l17.2673"></a><span id="l17.2673" class="difflineplus">+          m_compFields-&gt;SetFollowupTo(empty);</span>
<a href="#l17.2674"></a><span id="l17.2674" class="difflineplus">+          break;</span>
<a href="#l17.2675"></a><span id="l17.2675" class="difflineplus">+        }</span>
<a href="#l17.2676"></a><span id="l17.2676">       }</span>
<a href="#l17.2677"></a><span id="l17.2677">     }</span>
<a href="#l17.2678"></a><span id="l17.2678">     isFirstPass = false;</span>
<a href="#l17.2679"></a><span id="l17.2679">     uri = nextUri + 1;</span>
<a href="#l17.2680"></a><span id="l17.2680" class="difflineminus">-  }</span>
<a href="#l17.2681"></a><span id="l17.2681" class="difflineminus">-  while (nextUri);</span>
<a href="#l17.2682"></a><span id="l17.2682" class="difflineplus">+  } while (nextUri);</span>
<a href="#l17.2683"></a><span id="l17.2683">   PR_Free(uriList);</span>
<a href="#l17.2684"></a><span id="l17.2684">   return rv;</span>
<a href="#l17.2685"></a><span id="l17.2685"> }</span>
<a href="#l17.2686"></a><span id="l17.2686"> </span>
<a href="#l17.2687"></a><span id="l17.2687" class="difflineminus">-NS_IMETHODIMP nsMsgCompose::GetProgress(nsIMsgProgress **_retval)</span>
<a href="#l17.2688"></a><span id="l17.2688" class="difflineminus">-{</span>
<a href="#l17.2689"></a><span id="l17.2689" class="difflineplus">+NS_IMETHODIMP nsMsgCompose::GetProgress(nsIMsgProgress **_retval) {</span>
<a href="#l17.2690"></a><span id="l17.2690">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l17.2691"></a><span id="l17.2691">   NS_IF_ADDREF(*_retval = mProgress);</span>
<a href="#l17.2692"></a><span id="l17.2692">   return NS_OK;</span>
<a href="#l17.2693"></a><span id="l17.2693"> }</span>
<a href="#l17.2694"></a><span id="l17.2694"> </span>
<a href="#l17.2695"></a><span id="l17.2695" class="difflineminus">-NS_IMETHODIMP nsMsgCompose::GetMessageSend(nsIMsgSend **_retval)</span>
<a href="#l17.2696"></a><span id="l17.2696" class="difflineminus">-{</span>
<a href="#l17.2697"></a><span id="l17.2697" class="difflineplus">+NS_IMETHODIMP nsMsgCompose::GetMessageSend(nsIMsgSend **_retval) {</span>
<a href="#l17.2698"></a><span id="l17.2698">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l17.2699"></a><span id="l17.2699">   NS_IF_ADDREF(*_retval = mMsgSend);</span>
<a href="#l17.2700"></a><span id="l17.2700">   return NS_OK;</span>
<a href="#l17.2701"></a><span id="l17.2701"> }</span>
<a href="#l17.2702"></a><span id="l17.2702"> </span>
<a href="#l17.2703"></a><span id="l17.2703" class="difflineminus">-NS_IMETHODIMP nsMsgCompose::SetMessageSend(nsIMsgSend* aMsgSend)</span>
<a href="#l17.2704"></a><span id="l17.2704" class="difflineminus">-{</span>
<a href="#l17.2705"></a><span id="l17.2705" class="difflineplus">+NS_IMETHODIMP nsMsgCompose::SetMessageSend(nsIMsgSend *aMsgSend) {</span>
<a href="#l17.2706"></a><span id="l17.2706">   mMsgSend = aMsgSend;</span>
<a href="#l17.2707"></a><span id="l17.2707">   return NS_OK;</span>
<a href="#l17.2708"></a><span id="l17.2708"> }</span>
<a href="#l17.2709"></a><span id="l17.2709"> </span>
<a href="#l17.2710"></a><span id="l17.2710" class="difflineminus">-NS_IMETHODIMP nsMsgCompose::ClearMessageSend()</span>
<a href="#l17.2711"></a><span id="l17.2711" class="difflineminus">-{</span>
<a href="#l17.2712"></a><span id="l17.2712" class="difflineplus">+NS_IMETHODIMP nsMsgCompose::ClearMessageSend() {</span>
<a href="#l17.2713"></a><span id="l17.2713">   mMsgSend = nullptr;</span>
<a href="#l17.2714"></a><span id="l17.2714">   return NS_OK;</span>
<a href="#l17.2715"></a><span id="l17.2715"> }</span>
<a href="#l17.2716"></a><span id="l17.2716"> </span>
<a href="#l17.2717"></a><span id="l17.2717" class="difflineminus">-NS_IMETHODIMP nsMsgCompose::SetCiteReference(nsString citeReference)</span>
<a href="#l17.2718"></a><span id="l17.2718" class="difflineminus">-{</span>
<a href="#l17.2719"></a><span id="l17.2719" class="difflineplus">+NS_IMETHODIMP nsMsgCompose::SetCiteReference(nsString citeReference) {</span>
<a href="#l17.2720"></a><span id="l17.2720">   mCiteReference = citeReference;</span>
<a href="#l17.2721"></a><span id="l17.2721">   return NS_OK;</span>
<a href="#l17.2722"></a><span id="l17.2722"> }</span>
<a href="#l17.2723"></a><span id="l17.2723"> </span>
<a href="#l17.2724"></a><span id="l17.2724" class="difflineminus">-NS_IMETHODIMP nsMsgCompose::SetSavedFolderURI(const char *folderURI)</span>
<a href="#l17.2725"></a><span id="l17.2725" class="difflineminus">-{</span>
<a href="#l17.2726"></a><span id="l17.2726" class="difflineplus">+NS_IMETHODIMP nsMsgCompose::SetSavedFolderURI(const char *folderURI) {</span>
<a href="#l17.2727"></a><span id="l17.2727">   m_folderName = folderURI;</span>
<a href="#l17.2728"></a><span id="l17.2728">   return NS_OK;</span>
<a href="#l17.2729"></a><span id="l17.2729"> }</span>
<a href="#l17.2730"></a><span id="l17.2730"> </span>
<a href="#l17.2731"></a><span id="l17.2731" class="difflineminus">-NS_IMETHODIMP nsMsgCompose::GetSavedFolderURI(char ** folderURI)</span>
<a href="#l17.2732"></a><span id="l17.2732" class="difflineminus">-{</span>
<a href="#l17.2733"></a><span id="l17.2733" class="difflineplus">+NS_IMETHODIMP nsMsgCompose::GetSavedFolderURI(char **folderURI) {</span>
<a href="#l17.2734"></a><span id="l17.2734">   NS_ENSURE_ARG_POINTER(folderURI);</span>
<a href="#l17.2735"></a><span id="l17.2735">   *folderURI = ToNewCString(m_folderName);</span>
<a href="#l17.2736"></a><span id="l17.2736">   return (*folderURI) ? NS_OK : NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l17.2737"></a><span id="l17.2737"> }</span>
<a href="#l17.2738"></a><span id="l17.2738"> </span>
<a href="#l17.2739"></a><span id="l17.2739" class="difflineminus">-NS_IMETHODIMP nsMsgCompose::GetOriginalMsgURI(char ** originalMsgURI)</span>
<a href="#l17.2740"></a><span id="l17.2740" class="difflineminus">-{</span>
<a href="#l17.2741"></a><span id="l17.2741" class="difflineplus">+NS_IMETHODIMP nsMsgCompose::GetOriginalMsgURI(char **originalMsgURI) {</span>
<a href="#l17.2742"></a><span id="l17.2742">   NS_ENSURE_ARG_POINTER(originalMsgURI);</span>
<a href="#l17.2743"></a><span id="l17.2743">   *originalMsgURI = ToNewCString(mOriginalMsgURI);</span>
<a href="#l17.2744"></a><span id="l17.2744">   return (*originalMsgURI) ? NS_OK : NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l17.2745"></a><span id="l17.2745"> }</span>
<a href="#l17.2746"></a><span id="l17.2746"> </span>
<a href="#l17.2747"></a><span id="l17.2747"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l17.2748"></a><span id="l17.2748"> // THIS IS THE CLASS THAT IS THE STREAM CONSUMER OF THE HTML OUTPUT</span>
<a href="#l17.2749"></a><span id="l17.2749"> // FROM LIBMIME. THIS IS FOR QUOTING</span>
<a href="#l17.2750"></a><span id="l17.2750"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l17.2751"></a><span id="l17.2751" class="difflineminus">-QuotingOutputStreamListener::~QuotingOutputStreamListener()</span>
<a href="#l17.2752"></a><span id="l17.2752" class="difflineminus">-{</span>
<a href="#l17.2753"></a><span id="l17.2753" class="difflineminus">-}</span>
<a href="#l17.2754"></a><span id="l17.2754" class="difflineminus">-</span>
<a href="#l17.2755"></a><span id="l17.2755" class="difflineminus">-QuotingOutputStreamListener::QuotingOutputStreamListener(const char * originalMsgURI,</span>
<a href="#l17.2756"></a><span id="l17.2756" class="difflineminus">-                                                         nsIMsgDBHdr *originalMsgHdr,</span>
<a href="#l17.2757"></a><span id="l17.2757" class="difflineminus">-                                                         bool quoteHeaders,</span>
<a href="#l17.2758"></a><span id="l17.2758" class="difflineminus">-                                                         bool headersOnly,</span>
<a href="#l17.2759"></a><span id="l17.2759" class="difflineminus">-                                                         nsIMsgIdentity *identity,</span>
<a href="#l17.2760"></a><span id="l17.2760" class="difflineminus">-                                                         nsIMsgQuote* msgQuote,</span>
<a href="#l17.2761"></a><span id="l17.2761" class="difflineminus">-                                                         bool charsetFixed,</span>
<a href="#l17.2762"></a><span id="l17.2762" class="difflineminus">-                                                         bool quoteOriginal,</span>
<a href="#l17.2763"></a><span id="l17.2763" class="difflineminus">-                                                         const nsACString&amp; htmlToQuote)</span>
<a href="#l17.2764"></a><span id="l17.2764" class="difflineminus">-{</span>
<a href="#l17.2765"></a><span id="l17.2765" class="difflineplus">+QuotingOutputStreamListener::~QuotingOutputStreamListener() {}</span>
<a href="#l17.2766"></a><span id="l17.2766" class="difflineplus">+</span>
<a href="#l17.2767"></a><span id="l17.2767" class="difflineplus">+QuotingOutputStreamListener::QuotingOutputStreamListener(</span>
<a href="#l17.2768"></a><span id="l17.2768" class="difflineplus">+    const char *originalMsgURI, nsIMsgDBHdr *originalMsgHdr, bool quoteHeaders,</span>
<a href="#l17.2769"></a><span id="l17.2769" class="difflineplus">+    bool headersOnly, nsIMsgIdentity *identity, nsIMsgQuote *msgQuote,</span>
<a href="#l17.2770"></a><span id="l17.2770" class="difflineplus">+    bool charsetFixed, bool quoteOriginal, const nsACString &amp;htmlToQuote) {</span>
<a href="#l17.2771"></a><span id="l17.2771">   nsresult rv;</span>
<a href="#l17.2772"></a><span id="l17.2772">   mQuoteHeaders = quoteHeaders;</span>
<a href="#l17.2773"></a><span id="l17.2773">   mHeadersOnly = headersOnly;</span>
<a href="#l17.2774"></a><span id="l17.2774">   mIdentity = identity;</span>
<a href="#l17.2775"></a><span id="l17.2775">   mOrigMsgHdr = originalMsgHdr;</span>
<a href="#l17.2776"></a><span id="l17.2776">   mUnicodeBufferCharacterLength = 0;</span>
<a href="#l17.2777"></a><span id="l17.2777">   mQuoteOriginal = quoteOriginal;</span>
<a href="#l17.2778"></a><span id="l17.2778">   mHtmlToQuote = htmlToQuote;</span>
<a href="#l17.2779"></a><span id="l17.2779">   mQuote = msgQuote;</span>
<a href="#l17.2780"></a><span id="l17.2780">   mCharsetFixed = charsetFixed;</span>
<a href="#l17.2781"></a><span id="l17.2781"> </span>
<a href="#l17.2782"></a><span id="l17.2782" class="difflineminus">-  if (!mHeadersOnly || !mHtmlToQuote.IsEmpty())</span>
<a href="#l17.2783"></a><span id="l17.2783" class="difflineminus">-  {</span>
<a href="#l17.2784"></a><span id="l17.2784" class="difflineplus">+  if (!mHeadersOnly || !mHtmlToQuote.IsEmpty()) {</span>
<a href="#l17.2785"></a><span id="l17.2785">     // Get header type, locale and strings from pref.</span>
<a href="#l17.2786"></a><span id="l17.2786">     int32_t replyHeaderType;</span>
<a href="#l17.2787"></a><span id="l17.2787">     nsString replyHeaderAuthorWrote;</span>
<a href="#l17.2788"></a><span id="l17.2788">     nsString replyHeaderOnDateAuthorWrote;</span>
<a href="#l17.2789"></a><span id="l17.2789">     nsString replyHeaderAuthorWroteOnDate;</span>
<a href="#l17.2790"></a><span id="l17.2790">     nsString replyHeaderOriginalmessage;</span>
<a href="#l17.2791"></a><span id="l17.2791" class="difflineminus">-    GetReplyHeaderInfo(&amp;replyHeaderType,</span>
<a href="#l17.2792"></a><span id="l17.2792" class="difflineminus">-                       replyHeaderAuthorWrote,</span>
<a href="#l17.2793"></a><span id="l17.2793" class="difflineminus">-                       replyHeaderOnDateAuthorWrote,</span>
<a href="#l17.2794"></a><span id="l17.2794" class="difflineminus">-                       replyHeaderAuthorWroteOnDate,</span>
<a href="#l17.2795"></a><span id="l17.2795" class="difflineminus">-                       replyHeaderOriginalmessage);</span>
<a href="#l17.2796"></a><span id="l17.2796" class="difflineplus">+    GetReplyHeaderInfo(</span>
<a href="#l17.2797"></a><span id="l17.2797" class="difflineplus">+        &amp;replyHeaderType, replyHeaderAuthorWrote, replyHeaderOnDateAuthorWrote,</span>
<a href="#l17.2798"></a><span id="l17.2798" class="difflineplus">+        replyHeaderAuthorWroteOnDate, replyHeaderOriginalmessage);</span>
<a href="#l17.2799"></a><span id="l17.2799"> </span>
<a href="#l17.2800"></a><span id="l17.2800">     // For the built message body...</span>
<a href="#l17.2801"></a><span id="l17.2801" class="difflineminus">-    if (originalMsgHdr &amp;&amp; !quoteHeaders)</span>
<a href="#l17.2802"></a><span id="l17.2802" class="difflineminus">-    {</span>
<a href="#l17.2803"></a><span id="l17.2803" class="difflineplus">+    if (originalMsgHdr &amp;&amp; !quoteHeaders) {</span>
<a href="#l17.2804"></a><span id="l17.2804">       // Setup the cite information....</span>
<a href="#l17.2805"></a><span id="l17.2805">       nsCString myGetter;</span>
<a href="#l17.2806"></a><span id="l17.2806" class="difflineminus">-      if (NS_SUCCEEDED(originalMsgHdr-&gt;GetMessageId(getter_Copies(myGetter))))</span>
<a href="#l17.2807"></a><span id="l17.2807" class="difflineminus">-      {</span>
<a href="#l17.2808"></a><span id="l17.2808" class="difflineminus">-        if (!myGetter.IsEmpty())</span>
<a href="#l17.2809"></a><span id="l17.2809" class="difflineminus">-        {</span>
<a href="#l17.2810"></a><span id="l17.2810" class="difflineplus">+      if (NS_SUCCEEDED(originalMsgHdr-&gt;GetMessageId(getter_Copies(myGetter)))) {</span>
<a href="#l17.2811"></a><span id="l17.2811" class="difflineplus">+        if (!myGetter.IsEmpty()) {</span>
<a href="#l17.2812"></a><span id="l17.2812">           nsAutoCString buf;</span>
<a href="#l17.2813"></a><span id="l17.2813">           mCiteReference.AssignLiteral(&quot;mid:&quot;);</span>
<a href="#l17.2814"></a><span id="l17.2814">           MsgEscapeURL(myGetter,</span>
<a href="#l17.2815"></a><span id="l17.2815" class="difflineminus">-                       nsINetUtil::ESCAPE_URL_FILE_BASENAME | nsINetUtil::ESCAPE_URL_FORCED,</span>
<a href="#l17.2816"></a><span id="l17.2816" class="difflineplus">+                       nsINetUtil::ESCAPE_URL_FILE_BASENAME |</span>
<a href="#l17.2817"></a><span id="l17.2817" class="difflineplus">+                           nsINetUtil::ESCAPE_URL_FORCED,</span>
<a href="#l17.2818"></a><span id="l17.2818">                        buf);</span>
<a href="#l17.2819"></a><span id="l17.2819">           mCiteReference.Append(NS_ConvertASCIItoUTF16(buf));</span>
<a href="#l17.2820"></a><span id="l17.2820">         }</span>
<a href="#l17.2821"></a><span id="l17.2821">       }</span>
<a href="#l17.2822"></a><span id="l17.2822"> </span>
<a href="#l17.2823"></a><span id="l17.2823" class="difflineminus">-      bool citingHeader; //Do we have a header needing to cite any info from original message?</span>
<a href="#l17.2824"></a><span id="l17.2824" class="difflineminus">-      bool headerDate;   //Do we have a header needing to cite date/time from original message?</span>
<a href="#l17.2825"></a><span id="l17.2825" class="difflineminus">-      switch (replyHeaderType)</span>
<a href="#l17.2826"></a><span id="l17.2826" class="difflineminus">-      {</span>
<a href="#l17.2827"></a><span id="l17.2827" class="difflineminus">-        case 0: // No reply header at all (actually the &quot;---- original message ----&quot; string,</span>
<a href="#l17.2828"></a><span id="l17.2828" class="difflineminus">-                // which is kinda misleading. TODO: Should there be a &quot;really no header&quot; option?</span>
<a href="#l17.2829"></a><span id="l17.2829" class="difflineplus">+      bool citingHeader;  // Do we have a header needing to cite any info from</span>
<a href="#l17.2830"></a><span id="l17.2830" class="difflineplus">+                          // original message?</span>
<a href="#l17.2831"></a><span id="l17.2831" class="difflineplus">+      bool headerDate;    // Do we have a header needing to cite date/time from</span>
<a href="#l17.2832"></a><span id="l17.2832" class="difflineplus">+                          // original message?</span>
<a href="#l17.2833"></a><span id="l17.2833" class="difflineplus">+      switch (replyHeaderType) {</span>
<a href="#l17.2834"></a><span id="l17.2834" class="difflineplus">+        case 0:  // No reply header at all (actually the &quot;---- original message</span>
<a href="#l17.2835"></a><span id="l17.2835" class="difflineplus">+                 // ----&quot; string, which is kinda misleading. TODO: Should there</span>
<a href="#l17.2836"></a><span id="l17.2836" class="difflineplus">+                 // be a &quot;really no header&quot; option?</span>
<a href="#l17.2837"></a><span id="l17.2837">           mCitePrefix.Assign(replyHeaderOriginalmessage);</span>
<a href="#l17.2838"></a><span id="l17.2838">           citingHeader = false;</span>
<a href="#l17.2839"></a><span id="l17.2839">           headerDate = false;</span>
<a href="#l17.2840"></a><span id="l17.2840">           break;</span>
<a href="#l17.2841"></a><span id="l17.2841"> </span>
<a href="#l17.2842"></a><span id="l17.2842" class="difflineminus">-        case 2: // Insert both the original author and date in the reply header (date followed by author)</span>
<a href="#l17.2843"></a><span id="l17.2843" class="difflineplus">+        case 2:  // Insert both the original author and date in the reply header</span>
<a href="#l17.2844"></a><span id="l17.2844" class="difflineplus">+                 // (date followed by author)</span>
<a href="#l17.2845"></a><span id="l17.2845">           mCitePrefix.Assign(replyHeaderOnDateAuthorWrote);</span>
<a href="#l17.2846"></a><span id="l17.2846">           citingHeader = true;</span>
<a href="#l17.2847"></a><span id="l17.2847">           headerDate = true;</span>
<a href="#l17.2848"></a><span id="l17.2848">           break;</span>
<a href="#l17.2849"></a><span id="l17.2849"> </span>
<a href="#l17.2850"></a><span id="l17.2850" class="difflineminus">-        case 3: // Insert both the original author and date in the reply header (author followed by date)</span>
<a href="#l17.2851"></a><span id="l17.2851" class="difflineplus">+        case 3:  // Insert both the original author and date in the reply header</span>
<a href="#l17.2852"></a><span id="l17.2852" class="difflineplus">+                 // (author followed by date)</span>
<a href="#l17.2853"></a><span id="l17.2853">           mCitePrefix.Assign(replyHeaderAuthorWroteOnDate);</span>
<a href="#l17.2854"></a><span id="l17.2854">           citingHeader = true;</span>
<a href="#l17.2855"></a><span id="l17.2855">           headerDate = true;</span>
<a href="#l17.2856"></a><span id="l17.2856">           break;</span>
<a href="#l17.2857"></a><span id="l17.2857"> </span>
<a href="#l17.2858"></a><span id="l17.2858" class="difflineminus">-        case 4: // TODO bug 107884: implement a more featureful user specified header</span>
<a href="#l17.2859"></a><span id="l17.2859" class="difflineplus">+        case 4:  // TODO bug 107884: implement a more featureful user specified</span>
<a href="#l17.2860"></a><span id="l17.2860" class="difflineplus">+                 // header</span>
<a href="#l17.2861"></a><span id="l17.2861">         case 1:</span>
<a href="#l17.2862"></a><span id="l17.2862" class="difflineminus">-        default: // Default is to only show the author.</span>
<a href="#l17.2863"></a><span id="l17.2863" class="difflineplus">+        default:  // Default is to only show the author.</span>
<a href="#l17.2864"></a><span id="l17.2864">           mCitePrefix.Assign(replyHeaderAuthorWrote);</span>
<a href="#l17.2865"></a><span id="l17.2865">           citingHeader = true;</span>
<a href="#l17.2866"></a><span id="l17.2866">           headerDate = false;</span>
<a href="#l17.2867"></a><span id="l17.2867">           break;</span>
<a href="#l17.2868"></a><span id="l17.2868">       }</span>
<a href="#l17.2869"></a><span id="l17.2869"> </span>
<a href="#l17.2870"></a><span id="l17.2870" class="difflineminus">-      if (citingHeader)</span>
<a href="#l17.2871"></a><span id="l17.2871" class="difflineminus">-      {</span>
<a href="#l17.2872"></a><span id="l17.2872" class="difflineplus">+      if (citingHeader) {</span>
<a href="#l17.2873"></a><span id="l17.2873">         int32_t placeholderIndex = kNotFound;</span>
<a href="#l17.2874"></a><span id="l17.2874"> </span>
<a href="#l17.2875"></a><span id="l17.2875" class="difflineminus">-        if (headerDate)</span>
<a href="#l17.2876"></a><span id="l17.2876" class="difflineminus">-        {</span>
<a href="#l17.2877"></a><span id="l17.2877" class="difflineplus">+        if (headerDate) {</span>
<a href="#l17.2878"></a><span id="l17.2878">           PRTime originalMsgDate;</span>
<a href="#l17.2879"></a><span id="l17.2879">           rv = originalMsgHdr-&gt;GetDate(&amp;originalMsgDate);</span>
<a href="#l17.2880"></a><span id="l17.2880" class="difflineminus">-          if (NS_SUCCEEDED(rv))</span>
<a href="#l17.2881"></a><span id="l17.2881" class="difflineminus">-          {</span>
<a href="#l17.2882"></a><span id="l17.2882" class="difflineplus">+          if (NS_SUCCEEDED(rv)) {</span>
<a href="#l17.2883"></a><span id="l17.2883">             nsAutoString citeDatePart;</span>
<a href="#l17.2884"></a><span id="l17.2884" class="difflineminus">-            if ((placeholderIndex = mCitePrefix.Find(&quot;#2&quot;)) != kNotFound)</span>
<a href="#l17.2885"></a><span id="l17.2885" class="difflineminus">-            {</span>
<a href="#l17.2886"></a><span id="l17.2886" class="difflineminus">-              rv = mozilla::DateTimeFormat::FormatPRTime(kDateFormatShort,</span>
<a href="#l17.2887"></a><span id="l17.2887" class="difflineminus">-                                                         kTimeFormatNone,</span>
<a href="#l17.2888"></a><span id="l17.2888" class="difflineminus">-                                                         originalMsgDate,</span>
<a href="#l17.2889"></a><span id="l17.2889" class="difflineminus">-                                                         citeDatePart);</span>
<a href="#l17.2890"></a><span id="l17.2890" class="difflineplus">+            if ((placeholderIndex = mCitePrefix.Find(&quot;#2&quot;)) != kNotFound) {</span>
<a href="#l17.2891"></a><span id="l17.2891" class="difflineplus">+              rv = mozilla::DateTimeFormat::FormatPRTime(</span>
<a href="#l17.2892"></a><span id="l17.2892" class="difflineplus">+                  kDateFormatShort, kTimeFormatNone, originalMsgDate,</span>
<a href="#l17.2893"></a><span id="l17.2893" class="difflineplus">+                  citeDatePart);</span>
<a href="#l17.2894"></a><span id="l17.2894">               if (NS_SUCCEEDED(rv))</span>
<a href="#l17.2895"></a><span id="l17.2895">                 mCitePrefix.Replace(placeholderIndex, 2, citeDatePart);</span>
<a href="#l17.2896"></a><span id="l17.2896">             }</span>
<a href="#l17.2897"></a><span id="l17.2897" class="difflineminus">-            if ((placeholderIndex = mCitePrefix.Find(&quot;#3&quot;)) != kNotFound)</span>
<a href="#l17.2898"></a><span id="l17.2898" class="difflineminus">-            {</span>
<a href="#l17.2899"></a><span id="l17.2899" class="difflineminus">-              rv = mozilla::DateTimeFormat::FormatPRTime(kDateFormatNone,</span>
<a href="#l17.2900"></a><span id="l17.2900" class="difflineminus">-                                                         kTimeFormatNoSeconds,</span>
<a href="#l17.2901"></a><span id="l17.2901" class="difflineminus">-                                                         originalMsgDate,</span>
<a href="#l17.2902"></a><span id="l17.2902" class="difflineminus">-                                                         citeDatePart);</span>
<a href="#l17.2903"></a><span id="l17.2903" class="difflineplus">+            if ((placeholderIndex = mCitePrefix.Find(&quot;#3&quot;)) != kNotFound) {</span>
<a href="#l17.2904"></a><span id="l17.2904" class="difflineplus">+              rv = mozilla::DateTimeFormat::FormatPRTime(</span>
<a href="#l17.2905"></a><span id="l17.2905" class="difflineplus">+                  kDateFormatNone, kTimeFormatNoSeconds, originalMsgDate,</span>
<a href="#l17.2906"></a><span id="l17.2906" class="difflineplus">+                  citeDatePart);</span>
<a href="#l17.2907"></a><span id="l17.2907">               if (NS_SUCCEEDED(rv))</span>
<a href="#l17.2908"></a><span id="l17.2908">                 mCitePrefix.Replace(placeholderIndex, 2, citeDatePart);</span>
<a href="#l17.2909"></a><span id="l17.2909">             }</span>
<a href="#l17.2910"></a><span id="l17.2910">           }</span>
<a href="#l17.2911"></a><span id="l17.2911">         }</span>
<a href="#l17.2912"></a><span id="l17.2912"> </span>
<a href="#l17.2913"></a><span id="l17.2913" class="difflineminus">-        if ((placeholderIndex = mCitePrefix.Find(&quot;#1&quot;)) != kNotFound)</span>
<a href="#l17.2914"></a><span id="l17.2914" class="difflineminus">-        {</span>
<a href="#l17.2915"></a><span id="l17.2915" class="difflineplus">+        if ((placeholderIndex = mCitePrefix.Find(&quot;#1&quot;)) != kNotFound) {</span>
<a href="#l17.2916"></a><span id="l17.2916">           nsAutoCString author;</span>
<a href="#l17.2917"></a><span id="l17.2917">           rv = originalMsgHdr-&gt;GetAuthor(getter_Copies(author));</span>
<a href="#l17.2918"></a><span id="l17.2918" class="difflineminus">-          if (NS_SUCCEEDED(rv))</span>
<a href="#l17.2919"></a><span id="l17.2919" class="difflineminus">-          {</span>
<a href="#l17.2920"></a><span id="l17.2920" class="difflineplus">+          if (NS_SUCCEEDED(rv)) {</span>
<a href="#l17.2921"></a><span id="l17.2921">             nsAutoString citeAuthor;</span>
<a href="#l17.2922"></a><span id="l17.2922">             ExtractName(EncodedHeader(author), citeAuthor);</span>
<a href="#l17.2923"></a><span id="l17.2923">             mCitePrefix.Replace(placeholderIndex, 2, citeAuthor);</span>
<a href="#l17.2924"></a><span id="l17.2924">           }</span>
<a href="#l17.2925"></a><span id="l17.2925">         }</span>
<a href="#l17.2926"></a><span id="l17.2926">       }</span>
<a href="#l17.2927"></a><span id="l17.2927">     }</span>
<a href="#l17.2928"></a><span id="l17.2928"> </span>
<a href="#l17.2929"></a><span id="l17.2929">     // This should not happen, but just in case.</span>
<a href="#l17.2930"></a><span id="l17.2930" class="difflineminus">-    if (mCitePrefix.IsEmpty())</span>
<a href="#l17.2931"></a><span id="l17.2931" class="difflineminus">-    {</span>
<a href="#l17.2932"></a><span id="l17.2932" class="difflineplus">+    if (mCitePrefix.IsEmpty()) {</span>
<a href="#l17.2933"></a><span id="l17.2933">       mCitePrefix.AppendLiteral(&quot;\n\n&quot;);</span>
<a href="#l17.2934"></a><span id="l17.2934">       mCitePrefix.Append(replyHeaderOriginalmessage);</span>
<a href="#l17.2935"></a><span id="l17.2935">       mCitePrefix.AppendLiteral(&quot;\n&quot;);</span>
<a href="#l17.2936"></a><span id="l17.2936">     }</span>
<a href="#l17.2937"></a><span id="l17.2937">   }</span>
<a href="#l17.2938"></a><span id="l17.2938"> }</span>
<a href="#l17.2939"></a><span id="l17.2939"> </span>
<a href="#l17.2940"></a><span id="l17.2940"> /**</span>
<a href="#l17.2941"></a><span id="l17.2941" class="difflineminus">- * The formatflowed parameter directs if formatflowed should be used in the conversion.</span>
<a href="#l17.2942"></a><span id="l17.2942" class="difflineminus">- * format=flowed (RFC 2646) is a way to represent flow in a plain text mail, without</span>
<a href="#l17.2943"></a><span id="l17.2943" class="difflineminus">- * disturbing the plain text.</span>
<a href="#l17.2944"></a><span id="l17.2944" class="difflineplus">+ * The formatflowed parameter directs if formatflowed should be used in the</span>
<a href="#l17.2945"></a><span id="l17.2945" class="difflineplus">+ * conversion. format=flowed (RFC 2646) is a way to represent flow in a plain</span>
<a href="#l17.2946"></a><span id="l17.2946" class="difflineplus">+ * text mail, without disturbing the plain text.</span>
<a href="#l17.2947"></a><span id="l17.2947">  */</span>
<a href="#l17.2948"></a><span id="l17.2948" class="difflineminus">-nsresult</span>
<a href="#l17.2949"></a><span id="l17.2949" class="difflineminus">-QuotingOutputStreamListener::ConvertToPlainText(bool formatflowed,</span>
<a href="#l17.2950"></a><span id="l17.2950" class="difflineminus">-                                                bool delsp,</span>
<a href="#l17.2951"></a><span id="l17.2951" class="difflineminus">-                                                bool formatted,</span>
<a href="#l17.2952"></a><span id="l17.2952" class="difflineminus">-                                                bool disallowBreaks)</span>
<a href="#l17.2953"></a><span id="l17.2953" class="difflineminus">-{</span>
<a href="#l17.2954"></a><span id="l17.2954" class="difflineminus">-  nsresult rv = ConvertBufToPlainText(mMsgBody, formatflowed,</span>
<a href="#l17.2955"></a><span id="l17.2955" class="difflineminus">-                                                delsp,</span>
<a href="#l17.2956"></a><span id="l17.2956" class="difflineminus">-                                                formatted,</span>
<a href="#l17.2957"></a><span id="l17.2957" class="difflineminus">-                                                disallowBreaks);</span>
<a href="#l17.2958"></a><span id="l17.2958" class="difflineminus">-  NS_ENSURE_SUCCESS (rv, rv);</span>
<a href="#l17.2959"></a><span id="l17.2959" class="difflineminus">-  return ConvertBufToPlainText(mSignature, formatflowed,</span>
<a href="#l17.2960"></a><span id="l17.2960" class="difflineminus">-                                           delsp,</span>
<a href="#l17.2961"></a><span id="l17.2961" class="difflineminus">-                                           formatted,</span>
<a href="#l17.2962"></a><span id="l17.2962" class="difflineminus">-                                           disallowBreaks);</span>
<a href="#l17.2963"></a><span id="l17.2963" class="difflineplus">+nsresult QuotingOutputStreamListener::ConvertToPlainText(bool formatflowed,</span>
<a href="#l17.2964"></a><span id="l17.2964" class="difflineplus">+                                                         bool delsp,</span>
<a href="#l17.2965"></a><span id="l17.2965" class="difflineplus">+                                                         bool formatted,</span>
<a href="#l17.2966"></a><span id="l17.2966" class="difflineplus">+                                                         bool disallowBreaks) {</span>
<a href="#l17.2967"></a><span id="l17.2967" class="difflineplus">+  nsresult rv = ConvertBufToPlainText(mMsgBody, formatflowed, delsp, formatted,</span>
<a href="#l17.2968"></a><span id="l17.2968" class="difflineplus">+                                      disallowBreaks);</span>
<a href="#l17.2969"></a><span id="l17.2969" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.2970"></a><span id="l17.2970" class="difflineplus">+  return ConvertBufToPlainText(mSignature, formatflowed, delsp, formatted,</span>
<a href="#l17.2971"></a><span id="l17.2971" class="difflineplus">+                               disallowBreaks);</span>
<a href="#l17.2972"></a><span id="l17.2972"> }</span>
<a href="#l17.2973"></a><span id="l17.2973"> </span>
<a href="#l17.2974"></a><span id="l17.2974" class="difflineminus">-NS_IMETHODIMP QuotingOutputStreamListener::OnStartRequest(nsIRequest *request)</span>
<a href="#l17.2975"></a><span id="l17.2975" class="difflineminus">-{</span>
<a href="#l17.2976"></a><span id="l17.2976" class="difflineplus">+NS_IMETHODIMP QuotingOutputStreamListener::OnStartRequest(nsIRequest *request) {</span>
<a href="#l17.2977"></a><span id="l17.2977">   return NS_OK;</span>
<a href="#l17.2978"></a><span id="l17.2978"> }</span>
<a href="#l17.2979"></a><span id="l17.2979"> </span>
<a href="#l17.2980"></a><span id="l17.2980"> NS_IMETHODIMP</span>
<a href="#l17.2981"></a><span id="l17.2981" class="difflineminus">-QuotingOutputStreamListener::OnStopRequest(nsIRequest *request, nsresult status)</span>
<a href="#l17.2982"></a><span id="l17.2982" class="difflineminus">-{</span>
<a href="#l17.2983"></a><span id="l17.2983" class="difflineplus">+QuotingOutputStreamListener::OnStopRequest(nsIRequest *request,</span>
<a href="#l17.2984"></a><span id="l17.2984" class="difflineplus">+                                           nsresult status) {</span>
<a href="#l17.2985"></a><span id="l17.2985">   nsresult rv = NS_OK;</span>
<a href="#l17.2986"></a><span id="l17.2986"> </span>
<a href="#l17.2987"></a><span id="l17.2987" class="difflineminus">-  if (!mHtmlToQuote.IsEmpty())</span>
<a href="#l17.2988"></a><span id="l17.2988" class="difflineminus">-  {</span>
<a href="#l17.2989"></a><span id="l17.2989" class="difflineplus">+  if (!mHtmlToQuote.IsEmpty()) {</span>
<a href="#l17.2990"></a><span id="l17.2990">     // If we had a selection in the original message to quote, we can add</span>
<a href="#l17.2991"></a><span id="l17.2991">     // it now that we are done ignoring the original body of the message</span>
<a href="#l17.2992"></a><span id="l17.2992">     mHeadersOnly = false;</span>
<a href="#l17.2993"></a><span id="l17.2993">     rv = AppendToMsgBody(mHtmlToQuote);</span>
<a href="#l17.2994"></a><span id="l17.2994">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.2995"></a><span id="l17.2995">   }</span>
<a href="#l17.2996"></a><span id="l17.2996"> </span>
<a href="#l17.2997"></a><span id="l17.2997">   nsCOMPtr&lt;nsIMsgCompose&gt; compose = do_QueryReferent(mWeakComposeObj);</span>
<a href="#l17.2998"></a><span id="l17.2998">   NS_ENSURE_TRUE(compose, NS_ERROR_NULL_POINTER);</span>
<a href="#l17.2999"></a><span id="l17.2999"> </span>
<a href="#l17.3000"></a><span id="l17.3000">   MSG_ComposeType type;</span>
<a href="#l17.3001"></a><span id="l17.3001">   compose-&gt;GetType(&amp;type);</span>
<a href="#l17.3002"></a><span id="l17.3002"> </span>
<a href="#l17.3003"></a><span id="l17.3003">   // Assign cite information if available...</span>
<a href="#l17.3004"></a><span id="l17.3004" class="difflineminus">-  if (!mCiteReference.IsEmpty())</span>
<a href="#l17.3005"></a><span id="l17.3005" class="difflineminus">-    compose-&gt;SetCiteReference(mCiteReference);</span>
<a href="#l17.3006"></a><span id="l17.3006" class="difflineplus">+  if (!mCiteReference.IsEmpty()) compose-&gt;SetCiteReference(mCiteReference);</span>
<a href="#l17.3007"></a><span id="l17.3007"> </span>
<a href="#l17.3008"></a><span id="l17.3008">   bool overrideReplyTo =</span>
<a href="#l17.3009"></a><span id="l17.3009" class="difflineminus">-    mozilla::Preferences::GetBool(&quot;mail.override_list_reply_to&quot;, true);</span>
<a href="#l17.3010"></a><span id="l17.3010" class="difflineminus">-</span>
<a href="#l17.3011"></a><span id="l17.3011" class="difflineminus">-  if (mHeaders &amp;&amp; (type == nsIMsgCompType::Reply ||</span>
<a href="#l17.3012"></a><span id="l17.3012" class="difflineminus">-                   type == nsIMsgCompType::ReplyAll ||</span>
<a href="#l17.3013"></a><span id="l17.3013" class="difflineminus">-                   type == nsIMsgCompType::ReplyToList ||</span>
<a href="#l17.3014"></a><span id="l17.3014" class="difflineminus">-                   type == nsIMsgCompType::ReplyToSender ||</span>
<a href="#l17.3015"></a><span id="l17.3015" class="difflineminus">-                   type == nsIMsgCompType::ReplyToGroup ||</span>
<a href="#l17.3016"></a><span id="l17.3016" class="difflineminus">-                   type == nsIMsgCompType::ReplyToSenderAndGroup) &amp;&amp;</span>
<a href="#l17.3017"></a><span id="l17.3017" class="difflineminus">-      mQuoteOriginal)</span>
<a href="#l17.3018"></a><span id="l17.3018" class="difflineminus">-  {</span>
<a href="#l17.3019"></a><span id="l17.3019" class="difflineplus">+      mozilla::Preferences::GetBool(&quot;mail.override_list_reply_to&quot;, true);</span>
<a href="#l17.3020"></a><span id="l17.3020" class="difflineplus">+</span>
<a href="#l17.3021"></a><span id="l17.3021" class="difflineplus">+  if (mHeaders &amp;&amp;</span>
<a href="#l17.3022"></a><span id="l17.3022" class="difflineplus">+      (type == nsIMsgCompType::Reply || type == nsIMsgCompType::ReplyAll ||</span>
<a href="#l17.3023"></a><span id="l17.3023" class="difflineplus">+       type == nsIMsgCompType::ReplyToList ||</span>
<a href="#l17.3024"></a><span id="l17.3024" class="difflineplus">+       type == nsIMsgCompType::ReplyToSender ||</span>
<a href="#l17.3025"></a><span id="l17.3025" class="difflineplus">+       type == nsIMsgCompType::ReplyToGroup ||</span>
<a href="#l17.3026"></a><span id="l17.3026" class="difflineplus">+       type == nsIMsgCompType::ReplyToSenderAndGroup) &amp;&amp;</span>
<a href="#l17.3027"></a><span id="l17.3027" class="difflineplus">+      mQuoteOriginal) {</span>
<a href="#l17.3028"></a><span id="l17.3028">     nsCOMPtr&lt;nsIMsgCompFields&gt; compFields;</span>
<a href="#l17.3029"></a><span id="l17.3029">     compose-&gt;GetCompFields(getter_AddRefs(compFields));</span>
<a href="#l17.3030"></a><span id="l17.3030" class="difflineminus">-    if (compFields)</span>
<a href="#l17.3031"></a><span id="l17.3031" class="difflineminus">-    {</span>
<a href="#l17.3032"></a><span id="l17.3032" class="difflineplus">+    if (compFields) {</span>
<a href="#l17.3033"></a><span id="l17.3033">       nsAutoString from;</span>
<a href="#l17.3034"></a><span id="l17.3034">       nsAutoString to;</span>
<a href="#l17.3035"></a><span id="l17.3035">       nsAutoString cc;</span>
<a href="#l17.3036"></a><span id="l17.3036">       nsAutoString bcc;</span>
<a href="#l17.3037"></a><span id="l17.3037">       nsAutoString replyTo;</span>
<a href="#l17.3038"></a><span id="l17.3038">       nsAutoString mailReplyTo;</span>
<a href="#l17.3039"></a><span id="l17.3039">       nsAutoString mailFollowupTo;</span>
<a href="#l17.3040"></a><span id="l17.3040">       nsAutoString newgroups;</span>
<a href="#l17.3041"></a><span id="l17.3041">       nsAutoString followUpTo;</span>
<a href="#l17.3042"></a><span id="l17.3042">       nsAutoString messageId;</span>
<a href="#l17.3043"></a><span id="l17.3043">       nsAutoString references;</span>
<a href="#l17.3044"></a><span id="l17.3044">       nsAutoString listPost;</span>
<a href="#l17.3045"></a><span id="l17.3045"> </span>
<a href="#l17.3046"></a><span id="l17.3046" class="difflineminus">-      nsCString outCString; // Temp helper string.</span>
<a href="#l17.3047"></a><span id="l17.3047" class="difflineplus">+      nsCString outCString;  // Temp helper string.</span>
<a href="#l17.3048"></a><span id="l17.3048"> </span>
<a href="#l17.3049"></a><span id="l17.3049">       bool needToRemoveDup = false;</span>
<a href="#l17.3050"></a><span id="l17.3050" class="difflineminus">-      if (!mMimeConverter)</span>
<a href="#l17.3051"></a><span id="l17.3051" class="difflineminus">-      {</span>
<a href="#l17.3052"></a><span id="l17.3052" class="difflineplus">+      if (!mMimeConverter) {</span>
<a href="#l17.3053"></a><span id="l17.3053">         mMimeConverter = do_GetService(NS_MIME_CONVERTER_CONTRACTID, &amp;rv);</span>
<a href="#l17.3054"></a><span id="l17.3054">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.3055"></a><span id="l17.3055">       }</span>
<a href="#l17.3056"></a><span id="l17.3056">       nsCString charset;</span>
<a href="#l17.3057"></a><span id="l17.3057">       compFields-&gt;GetCharacterSet(getter_Copies(charset));</span>
<a href="#l17.3058"></a><span id="l17.3058"> </span>
<a href="#l17.3059"></a><span id="l17.3059">       if (!mCharsetFixed) {</span>
<a href="#l17.3060"></a><span id="l17.3060">         // Get the charset from the channel where MIME left it.</span>
<a href="#l17.3061"></a><span id="l17.3061" class="difflineat">@@ -2570,339 +2355,294 @@ QuotingOutputStreamListener::OnStopReque</span>
<a href="#l17.3062"></a><span id="l17.3062">       mHeaders-&gt;ExtractHeader(HEADER_REPLY_TO, false, outCString);</span>
<a href="#l17.3063"></a><span id="l17.3063">       nsMsgI18NConvertRawBytesToUTF16(outCString, charset, replyTo);</span>
<a href="#l17.3064"></a><span id="l17.3064"> </span>
<a href="#l17.3065"></a><span id="l17.3065">       mHeaders-&gt;ExtractHeader(HEADER_MAIL_REPLY_TO, true, outCString);</span>
<a href="#l17.3066"></a><span id="l17.3066">       nsMsgI18NConvertRawBytesToUTF16(outCString, charset, mailReplyTo);</span>
<a href="#l17.3067"></a><span id="l17.3067"> </span>
<a href="#l17.3068"></a><span id="l17.3068">       mHeaders-&gt;ExtractHeader(HEADER_NEWSGROUPS, false, outCString);</span>
<a href="#l17.3069"></a><span id="l17.3069">       if (!outCString.IsEmpty())</span>
<a href="#l17.3070"></a><span id="l17.3070" class="difflineminus">-        mMimeConverter-&gt;DecodeMimeHeader(outCString.get(), charset.get(),</span>
<a href="#l17.3071"></a><span id="l17.3071" class="difflineminus">-                                         false, true, newgroups);</span>
<a href="#l17.3072"></a><span id="l17.3072" class="difflineplus">+        mMimeConverter-&gt;DecodeMimeHeader(outCString.get(), charset.get(), false,</span>
<a href="#l17.3073"></a><span id="l17.3073" class="difflineplus">+                                         true, newgroups);</span>
<a href="#l17.3074"></a><span id="l17.3074"> </span>
<a href="#l17.3075"></a><span id="l17.3075">       mHeaders-&gt;ExtractHeader(HEADER_FOLLOWUP_TO, false, outCString);</span>
<a href="#l17.3076"></a><span id="l17.3076">       if (!outCString.IsEmpty())</span>
<a href="#l17.3077"></a><span id="l17.3077" class="difflineminus">-        mMimeConverter-&gt;DecodeMimeHeader(outCString.get(), charset.get(),</span>
<a href="#l17.3078"></a><span id="l17.3078" class="difflineminus">-                                         false, true, followUpTo);</span>
<a href="#l17.3079"></a><span id="l17.3079" class="difflineplus">+        mMimeConverter-&gt;DecodeMimeHeader(outCString.get(), charset.get(), false,</span>
<a href="#l17.3080"></a><span id="l17.3080" class="difflineplus">+                                         true, followUpTo);</span>
<a href="#l17.3081"></a><span id="l17.3081"> </span>
<a href="#l17.3082"></a><span id="l17.3082">       mHeaders-&gt;ExtractHeader(HEADER_MESSAGE_ID, false, outCString);</span>
<a href="#l17.3083"></a><span id="l17.3083">       if (!outCString.IsEmpty())</span>
<a href="#l17.3084"></a><span id="l17.3084" class="difflineminus">-        mMimeConverter-&gt;DecodeMimeHeader(outCString.get(), charset.get(),</span>
<a href="#l17.3085"></a><span id="l17.3085" class="difflineminus">-                                         false, true, messageId);</span>
<a href="#l17.3086"></a><span id="l17.3086" class="difflineplus">+        mMimeConverter-&gt;DecodeMimeHeader(outCString.get(), charset.get(), false,</span>
<a href="#l17.3087"></a><span id="l17.3087" class="difflineplus">+                                         true, messageId);</span>
<a href="#l17.3088"></a><span id="l17.3088"> </span>
<a href="#l17.3089"></a><span id="l17.3089">       mHeaders-&gt;ExtractHeader(HEADER_REFERENCES, false, outCString);</span>
<a href="#l17.3090"></a><span id="l17.3090">       if (!outCString.IsEmpty())</span>
<a href="#l17.3091"></a><span id="l17.3091" class="difflineminus">-        mMimeConverter-&gt;DecodeMimeHeader(outCString.get(), charset.get(),</span>
<a href="#l17.3092"></a><span id="l17.3092" class="difflineminus">-                                         false, true, references);</span>
<a href="#l17.3093"></a><span id="l17.3093" class="difflineplus">+        mMimeConverter-&gt;DecodeMimeHeader(outCString.get(), charset.get(), false,</span>
<a href="#l17.3094"></a><span id="l17.3094" class="difflineplus">+                                         true, references);</span>
<a href="#l17.3095"></a><span id="l17.3095"> </span>
<a href="#l17.3096"></a><span id="l17.3096">       mHeaders-&gt;ExtractHeader(HEADER_LIST_POST, true, outCString);</span>
<a href="#l17.3097"></a><span id="l17.3097">       if (!outCString.IsEmpty())</span>
<a href="#l17.3098"></a><span id="l17.3098" class="difflineminus">-        mMimeConverter-&gt;DecodeMimeHeader(outCString.get(), charset.get(),</span>
<a href="#l17.3099"></a><span id="l17.3099" class="difflineminus">-                                         false, true, listPost);</span>
<a href="#l17.3100"></a><span id="l17.3100" class="difflineminus">-      if (!listPost.IsEmpty())</span>
<a href="#l17.3101"></a><span id="l17.3101" class="difflineminus">-      {</span>
<a href="#l17.3102"></a><span id="l17.3102" class="difflineplus">+        mMimeConverter-&gt;DecodeMimeHeader(outCString.get(), charset.get(), false,</span>
<a href="#l17.3103"></a><span id="l17.3103" class="difflineplus">+                                         true, listPost);</span>
<a href="#l17.3104"></a><span id="l17.3104" class="difflineplus">+      if (!listPost.IsEmpty()) {</span>
<a href="#l17.3105"></a><span id="l17.3105">         int32_t startPos = listPost.Find(&quot;&lt;mailto:&quot;);</span>
<a href="#l17.3106"></a><span id="l17.3106">         int32_t endPos = listPost.FindChar('&gt;', startPos);</span>
<a href="#l17.3107"></a><span id="l17.3107">         // Extract the e-mail address.</span>
<a href="#l17.3108"></a><span id="l17.3108" class="difflineminus">-        if (endPos &gt; startPos)</span>
<a href="#l17.3109"></a><span id="l17.3109" class="difflineminus">-        {</span>
<a href="#l17.3110"></a><span id="l17.3110" class="difflineplus">+        if (endPos &gt; startPos) {</span>
<a href="#l17.3111"></a><span id="l17.3111">           const uint32_t mailtoLen = strlen(&quot;&lt;mailto:&quot;);</span>
<a href="#l17.3112"></a><span id="l17.3112" class="difflineminus">-          listPost = Substring(listPost, startPos + mailtoLen, endPos - (startPos + mailtoLen));</span>
<a href="#l17.3113"></a><span id="l17.3113" class="difflineplus">+          listPost = Substring(listPost, startPos + mailtoLen,</span>
<a href="#l17.3114"></a><span id="l17.3114" class="difflineplus">+                               endPos - (startPos + mailtoLen));</span>
<a href="#l17.3115"></a><span id="l17.3115">         }</span>
<a href="#l17.3116"></a><span id="l17.3116">       }</span>
<a href="#l17.3117"></a><span id="l17.3117"> </span>
<a href="#l17.3118"></a><span id="l17.3118">       nsCString fromEmailAddress;</span>
<a href="#l17.3119"></a><span id="l17.3119">       ExtractEmail(EncodedHeaderW(from), fromEmailAddress);</span>
<a href="#l17.3120"></a><span id="l17.3120"> </span>
<a href="#l17.3121"></a><span id="l17.3121">       nsTArray&lt;nsCString&gt; toEmailAddresses;</span>
<a href="#l17.3122"></a><span id="l17.3122">       ExtractEmails(EncodedHeaderW(to), UTF16ArrayAdapter&lt;&gt;(toEmailAddresses));</span>
<a href="#l17.3123"></a><span id="l17.3123"> </span>
<a href="#l17.3124"></a><span id="l17.3124">       nsTArray&lt;nsCString&gt; ccEmailAddresses;</span>
<a href="#l17.3125"></a><span id="l17.3125">       ExtractEmails(EncodedHeaderW(cc), UTF16ArrayAdapter&lt;&gt;(ccEmailAddresses));</span>
<a href="#l17.3126"></a><span id="l17.3126"> </span>
<a href="#l17.3127"></a><span id="l17.3127" class="difflineminus">-      nsCOMPtr&lt;nsIPrefBranch&gt; prefs (do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l17.3128"></a><span id="l17.3128" class="difflineplus">+      nsCOMPtr&lt;nsIPrefBranch&gt; prefs(</span>
<a href="#l17.3129"></a><span id="l17.3129" class="difflineplus">+          do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l17.3130"></a><span id="l17.3130">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.3131"></a><span id="l17.3131">       bool replyToSelfCheckAll = false;</span>
<a href="#l17.3132"></a><span id="l17.3132">       prefs-&gt;GetBoolPref(&quot;mailnews.reply_to_self_check_all_ident&quot;,</span>
<a href="#l17.3133"></a><span id="l17.3133">                          &amp;replyToSelfCheckAll);</span>
<a href="#l17.3134"></a><span id="l17.3134"> </span>
<a href="#l17.3135"></a><span id="l17.3135">       nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l17.3136"></a><span id="l17.3136" class="difflineminus">-        do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l17.3137"></a><span id="l17.3137" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.3138"></a><span id="l17.3138" class="difflineplus">+          do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l17.3139"></a><span id="l17.3139" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.3140"></a><span id="l17.3140"> </span>
<a href="#l17.3141"></a><span id="l17.3141">       nsCOMPtr&lt;nsIArray&gt; identities;</span>
<a href="#l17.3142"></a><span id="l17.3142">       nsCString accountKey;</span>
<a href="#l17.3143"></a><span id="l17.3143">       mOrigMsgHdr-&gt;GetAccountKey(getter_Copies(accountKey));</span>
<a href="#l17.3144"></a><span id="l17.3144" class="difflineminus">-      if (replyToSelfCheckAll)</span>
<a href="#l17.3145"></a><span id="l17.3145" class="difflineminus">-      {</span>
<a href="#l17.3146"></a><span id="l17.3146" class="difflineplus">+      if (replyToSelfCheckAll) {</span>
<a href="#l17.3147"></a><span id="l17.3147">         // Check all available identities if the pref was set.</span>
<a href="#l17.3148"></a><span id="l17.3148">         accountManager-&gt;GetAllIdentities(getter_AddRefs(identities));</span>
<a href="#l17.3149"></a><span id="l17.3149" class="difflineminus">-      }</span>
<a href="#l17.3150"></a><span id="l17.3150" class="difflineminus">-      else if (!accountKey.IsEmpty())</span>
<a href="#l17.3151"></a><span id="l17.3151" class="difflineminus">-      {</span>
<a href="#l17.3152"></a><span id="l17.3152" class="difflineminus">-         // Check headers to see which account the message came in from</span>
<a href="#l17.3153"></a><span id="l17.3153" class="difflineminus">-         // (only works for pop3).</span>
<a href="#l17.3154"></a><span id="l17.3154" class="difflineplus">+      } else if (!accountKey.IsEmpty()) {</span>
<a href="#l17.3155"></a><span id="l17.3155" class="difflineplus">+        // Check headers to see which account the message came in from</span>
<a href="#l17.3156"></a><span id="l17.3156" class="difflineplus">+        // (only works for pop3).</span>
<a href="#l17.3157"></a><span id="l17.3157">         nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l17.3158"></a><span id="l17.3158">         accountManager-&gt;GetAccount(accountKey, getter_AddRefs(account));</span>
<a href="#l17.3159"></a><span id="l17.3159"> </span>
<a href="#l17.3160"></a><span id="l17.3160" class="difflineminus">-        if (account)</span>
<a href="#l17.3161"></a><span id="l17.3161" class="difflineminus">-          account-&gt;GetIdentities(getter_AddRefs(identities));</span>
<a href="#l17.3162"></a><span id="l17.3162" class="difflineminus">-      }</span>
<a href="#l17.3163"></a><span id="l17.3163" class="difflineminus">-      else</span>
<a href="#l17.3164"></a><span id="l17.3164" class="difflineminus">-      {</span>
<a href="#l17.3165"></a><span id="l17.3165" class="difflineplus">+        if (account) account-&gt;GetIdentities(getter_AddRefs(identities));</span>
<a href="#l17.3166"></a><span id="l17.3166" class="difflineplus">+      } else {</span>
<a href="#l17.3167"></a><span id="l17.3167">         // Check identities only for the server of the folder that the message</span>
<a href="#l17.3168"></a><span id="l17.3168">         // is in.</span>
<a href="#l17.3169"></a><span id="l17.3169" class="difflineminus">-        nsCOMPtr &lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l17.3170"></a><span id="l17.3170" class="difflineplus">+        nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l17.3171"></a><span id="l17.3171">         rv = mOrigMsgHdr-&gt;GetFolder(getter_AddRefs(msgFolder));</span>
<a href="#l17.3172"></a><span id="l17.3172"> </span>
<a href="#l17.3173"></a><span id="l17.3173" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; msgFolder){</span>
<a href="#l17.3174"></a><span id="l17.3174" class="difflineplus">+        if (NS_SUCCEEDED(rv) &amp;&amp; msgFolder) {</span>
<a href="#l17.3175"></a><span id="l17.3175">           nsCOMPtr&lt;nsIMsgIncomingServer&gt; nsIMsgIncomingServer;</span>
<a href="#l17.3176"></a><span id="l17.3176">           rv = msgFolder-&gt;GetServer(getter_AddRefs(nsIMsgIncomingServer));</span>
<a href="#l17.3177"></a><span id="l17.3177"> </span>
<a href="#l17.3178"></a><span id="l17.3178">           if (NS_SUCCEEDED(rv) &amp;&amp; nsIMsgIncomingServer)</span>
<a href="#l17.3179"></a><span id="l17.3179" class="difflineminus">-            accountManager-&gt;GetIdentitiesForServer(nsIMsgIncomingServer, getter_AddRefs(identities));</span>
<a href="#l17.3180"></a><span id="l17.3180" class="difflineplus">+            accountManager-&gt;GetIdentitiesForServer(nsIMsgIncomingServer,</span>
<a href="#l17.3181"></a><span id="l17.3181" class="difflineplus">+                                                   getter_AddRefs(identities));</span>
<a href="#l17.3182"></a><span id="l17.3182">         }</span>
<a href="#l17.3183"></a><span id="l17.3183">       }</span>
<a href="#l17.3184"></a><span id="l17.3184"> </span>
<a href="#l17.3185"></a><span id="l17.3185">       bool isReplyToSelf = false;</span>
<a href="#l17.3186"></a><span id="l17.3186">       nsCOMPtr&lt;nsIMsgIdentity&gt; selfIdentity;</span>
<a href="#l17.3187"></a><span id="l17.3187" class="difflineminus">-      if (identities)</span>
<a href="#l17.3188"></a><span id="l17.3188" class="difflineminus">-      {</span>
<a href="#l17.3189"></a><span id="l17.3189" class="difflineplus">+      if (identities) {</span>
<a href="#l17.3190"></a><span id="l17.3190">         // Go through the identities to see if any of them is the author of</span>
<a href="#l17.3191"></a><span id="l17.3191">         // the email.</span>
<a href="#l17.3192"></a><span id="l17.3192">         nsCOMPtr&lt;nsIMsgIdentity&gt; lookupIdentity;</span>
<a href="#l17.3193"></a><span id="l17.3193"> </span>
<a href="#l17.3194"></a><span id="l17.3194">         uint32_t count = 0;</span>
<a href="#l17.3195"></a><span id="l17.3195">         identities-&gt;GetLength(&amp;count);</span>
<a href="#l17.3196"></a><span id="l17.3196"> </span>
<a href="#l17.3197"></a><span id="l17.3197" class="difflineminus">-        for (uint32_t i = 0; i &lt; count; i++)</span>
<a href="#l17.3198"></a><span id="l17.3198" class="difflineminus">-        {</span>
<a href="#l17.3199"></a><span id="l17.3199" class="difflineplus">+        for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l17.3200"></a><span id="l17.3200">           lookupIdentity = do_QueryElementAt(identities, i, &amp;rv);</span>
<a href="#l17.3201"></a><span id="l17.3201" class="difflineminus">-          if (NS_FAILED(rv))</span>
<a href="#l17.3202"></a><span id="l17.3202" class="difflineminus">-            continue;</span>
<a href="#l17.3203"></a><span id="l17.3203" class="difflineplus">+          if (NS_FAILED(rv)) continue;</span>
<a href="#l17.3204"></a><span id="l17.3204"> </span>
<a href="#l17.3205"></a><span id="l17.3205">           selfIdentity = lookupIdentity;</span>
<a href="#l17.3206"></a><span id="l17.3206"> </span>
<a href="#l17.3207"></a><span id="l17.3207">           nsCString curIdentityEmail;</span>
<a href="#l17.3208"></a><span id="l17.3208">           lookupIdentity-&gt;GetEmail(curIdentityEmail);</span>
<a href="#l17.3209"></a><span id="l17.3209"> </span>
<a href="#l17.3210"></a><span id="l17.3210" class="difflineminus">-          // See if it's a reply to own message, but not a reply between identities.</span>
<a href="#l17.3211"></a><span id="l17.3211" class="difflineminus">-          if (curIdentityEmail.Equals(fromEmailAddress))</span>
<a href="#l17.3212"></a><span id="l17.3212" class="difflineminus">-          {</span>
<a href="#l17.3213"></a><span id="l17.3213" class="difflineplus">+          // See if it's a reply to own message, but not a reply between</span>
<a href="#l17.3214"></a><span id="l17.3214" class="difflineplus">+          // identities.</span>
<a href="#l17.3215"></a><span id="l17.3215" class="difflineplus">+          if (curIdentityEmail.Equals(fromEmailAddress)) {</span>
<a href="#l17.3216"></a><span id="l17.3216">             isReplyToSelf = true;</span>
<a href="#l17.3217"></a><span id="l17.3217">             // For a true reply-to-self, none of your identities are normally in</span>
<a href="#l17.3218"></a><span id="l17.3218">             // To or Cc. We need to avoid doing a reply-to-self for people that</span>
<a href="#l17.3219"></a><span id="l17.3219">             // have multiple identities set and sometimes *uses* the other</span>
<a href="#l17.3220"></a><span id="l17.3220">             // identity and sometimes *mails* the other identity.</span>
<a href="#l17.3221"></a><span id="l17.3221">             // E.g. husband+wife or own-email+company-role-mail.</span>
<a href="#l17.3222"></a><span id="l17.3222" class="difflineminus">-            for (uint32_t j = 0; j &lt; count; j++)</span>
<a href="#l17.3223"></a><span id="l17.3223" class="difflineminus">-            {</span>
<a href="#l17.3224"></a><span id="l17.3224" class="difflineminus">-              nsCOMPtr&lt;nsIMsgIdentity&gt; lookupIdentity2 = do_QueryElementAt(identities, j, &amp;rv);</span>
<a href="#l17.3225"></a><span id="l17.3225" class="difflineminus">-              if (NS_FAILED(rv))</span>
<a href="#l17.3226"></a><span id="l17.3226" class="difflineminus">-                continue;</span>
<a href="#l17.3227"></a><span id="l17.3227" class="difflineplus">+            for (uint32_t j = 0; j &lt; count; j++) {</span>
<a href="#l17.3228"></a><span id="l17.3228" class="difflineplus">+              nsCOMPtr&lt;nsIMsgIdentity&gt; lookupIdentity2 =</span>
<a href="#l17.3229"></a><span id="l17.3229" class="difflineplus">+                  do_QueryElementAt(identities, j, &amp;rv);</span>
<a href="#l17.3230"></a><span id="l17.3230" class="difflineplus">+              if (NS_FAILED(rv)) continue;</span>
<a href="#l17.3231"></a><span id="l17.3231"> </span>
<a href="#l17.3232"></a><span id="l17.3232">               nsCString curIdentityEmail2;</span>
<a href="#l17.3233"></a><span id="l17.3233">               lookupIdentity2-&gt;GetEmail(curIdentityEmail2);</span>
<a href="#l17.3234"></a><span id="l17.3234" class="difflineminus">-              if (toEmailAddresses.Contains(curIdentityEmail2))</span>
<a href="#l17.3235"></a><span id="l17.3235" class="difflineminus">-              {</span>
<a href="#l17.3236"></a><span id="l17.3236" class="difflineplus">+              if (toEmailAddresses.Contains(curIdentityEmail2)) {</span>
<a href="#l17.3237"></a><span id="l17.3237">                 // However, &quot;From:me To:me&quot; should be treated as</span>
<a href="#l17.3238"></a><span id="l17.3238">                 // reply-to-self if we have a Bcc. If we don't have a Bcc we</span>
<a href="#l17.3239"></a><span id="l17.3239">                 // might have the case of a generated mail of the style</span>
<a href="#l17.3240"></a><span id="l17.3240">                 // &quot;From:me To:me Reply-To:customer&quot;. Then we need to to do a</span>
<a href="#l17.3241"></a><span id="l17.3241">                 // normal reply to the customer.</span>
<a href="#l17.3242"></a><span id="l17.3242" class="difflineminus">-                isReplyToSelf = !bcc.IsEmpty(); // true if bcc is set</span>
<a href="#l17.3243"></a><span id="l17.3243" class="difflineplus">+                isReplyToSelf = !bcc.IsEmpty();  // true if bcc is set</span>
<a href="#l17.3244"></a><span id="l17.3244">                 break;</span>
<a href="#l17.3245"></a><span id="l17.3245" class="difflineminus">-              }</span>
<a href="#l17.3246"></a><span id="l17.3246" class="difflineminus">-              else if (ccEmailAddresses.Contains(curIdentityEmail2))</span>
<a href="#l17.3247"></a><span id="l17.3247" class="difflineminus">-              {</span>
<a href="#l17.3248"></a><span id="l17.3248" class="difflineplus">+              } else if (ccEmailAddresses.Contains(curIdentityEmail2)) {</span>
<a href="#l17.3249"></a><span id="l17.3249">                 // If you auto-Cc yourself your email would be in Cc - but we</span>
<a href="#l17.3250"></a><span id="l17.3250">                 // can't detect why it is in Cc so lets just treat it like a</span>
<a href="#l17.3251"></a><span id="l17.3251">                 // normal reply.</span>
<a href="#l17.3252"></a><span id="l17.3252">                 isReplyToSelf = false;</span>
<a href="#l17.3253"></a><span id="l17.3253">                 break;</span>
<a href="#l17.3254"></a><span id="l17.3254">               }</span>
<a href="#l17.3255"></a><span id="l17.3255">             }</span>
<a href="#l17.3256"></a><span id="l17.3256">             break;</span>
<a href="#l17.3257"></a><span id="l17.3257">           }</span>
<a href="#l17.3258"></a><span id="l17.3258">         }</span>
<a href="#l17.3259"></a><span id="l17.3259">       }</span>
<a href="#l17.3260"></a><span id="l17.3260" class="difflineminus">-      if (type == nsIMsgCompType::ReplyToSender || type == nsIMsgCompType::Reply)</span>
<a href="#l17.3261"></a><span id="l17.3261" class="difflineminus">-      {</span>
<a href="#l17.3262"></a><span id="l17.3262" class="difflineminus">-        if (isReplyToSelf)</span>
<a href="#l17.3263"></a><span id="l17.3263" class="difflineminus">-        {</span>
<a href="#l17.3264"></a><span id="l17.3264" class="difflineplus">+      if (type == nsIMsgCompType::ReplyToSender ||</span>
<a href="#l17.3265"></a><span id="l17.3265" class="difflineplus">+          type == nsIMsgCompType::Reply) {</span>
<a href="#l17.3266"></a><span id="l17.3266" class="difflineplus">+        if (isReplyToSelf) {</span>
<a href="#l17.3267"></a><span id="l17.3267">           // Cast to concrete class. We *only* what to change m_identity, not</span>
<a href="#l17.3268"></a><span id="l17.3268">           // all the things compose-&gt;SetIdentity would do.</span>
<a href="#l17.3269"></a><span id="l17.3269" class="difflineminus">-          nsMsgCompose* _compose = static_cast&lt;nsMsgCompose*&gt;(compose.get());</span>
<a href="#l17.3270"></a><span id="l17.3270" class="difflineplus">+          nsMsgCompose *_compose = static_cast&lt;nsMsgCompose *&gt;(compose.get());</span>
<a href="#l17.3271"></a><span id="l17.3271">           _compose-&gt;m_identity = selfIdentity;</span>
<a href="#l17.3272"></a><span id="l17.3272">           compFields-&gt;SetFrom(from);</span>
<a href="#l17.3273"></a><span id="l17.3273">           compFields-&gt;SetTo(to);</span>
<a href="#l17.3274"></a><span id="l17.3274">           compFields-&gt;SetReplyTo(replyTo);</span>
<a href="#l17.3275"></a><span id="l17.3275" class="difflineminus">-        }</span>
<a href="#l17.3276"></a><span id="l17.3276" class="difflineminus">-        else if (!mailReplyTo.IsEmpty())</span>
<a href="#l17.3277"></a><span id="l17.3277" class="difflineminus">-        {</span>
<a href="#l17.3278"></a><span id="l17.3278" class="difflineplus">+        } else if (!mailReplyTo.IsEmpty()) {</span>
<a href="#l17.3279"></a><span id="l17.3279">           // handle Mail-Reply-To (http://cr.yp.to/proto/replyto.html)</span>
<a href="#l17.3280"></a><span id="l17.3280">           compFields-&gt;SetTo(mailReplyTo);</span>
<a href="#l17.3281"></a><span id="l17.3281">           needToRemoveDup = true;</span>
<a href="#l17.3282"></a><span id="l17.3282" class="difflineminus">-        }</span>
<a href="#l17.3283"></a><span id="l17.3283" class="difflineminus">-        else if (!replyTo.IsEmpty())</span>
<a href="#l17.3284"></a><span id="l17.3284" class="difflineminus">-        {</span>
<a href="#l17.3285"></a><span id="l17.3285" class="difflineplus">+        } else if (!replyTo.IsEmpty()) {</span>
<a href="#l17.3286"></a><span id="l17.3286">           // default reply behaviour then</span>
<a href="#l17.3287"></a><span id="l17.3287"> </span>
<a href="#l17.3288"></a><span id="l17.3288" class="difflineminus">-          if (overrideReplyTo &amp;&amp;</span>
<a href="#l17.3289"></a><span id="l17.3289" class="difflineminus">-              !listPost.IsEmpty() &amp;&amp; replyTo.Find(listPost) != kNotFound)</span>
<a href="#l17.3290"></a><span id="l17.3290" class="difflineminus">-          {</span>
<a href="#l17.3291"></a><span id="l17.3291" class="difflineplus">+          if (overrideReplyTo &amp;&amp; !listPost.IsEmpty() &amp;&amp;</span>
<a href="#l17.3292"></a><span id="l17.3292" class="difflineplus">+              replyTo.Find(listPost) != kNotFound) {</span>
<a href="#l17.3293"></a><span id="l17.3293">             // Reply-To munging in this list post. Reply to From instead,</span>
<a href="#l17.3294"></a><span id="l17.3294">             // as the user can choose Reply List if that's what he wants.</span>
<a href="#l17.3295"></a><span id="l17.3295">             compFields-&gt;SetTo(from);</span>
<a href="#l17.3296"></a><span id="l17.3296" class="difflineminus">-          }</span>
<a href="#l17.3297"></a><span id="l17.3297" class="difflineminus">-          else</span>
<a href="#l17.3298"></a><span id="l17.3298" class="difflineminus">-          {</span>
<a href="#l17.3299"></a><span id="l17.3299" class="difflineplus">+          } else {</span>
<a href="#l17.3300"></a><span id="l17.3300">             compFields-&gt;SetTo(replyTo);</span>
<a href="#l17.3301"></a><span id="l17.3301">           }</span>
<a href="#l17.3302"></a><span id="l17.3302">           needToRemoveDup = true;</span>
<a href="#l17.3303"></a><span id="l17.3303" class="difflineminus">-        }</span>
<a href="#l17.3304"></a><span id="l17.3304" class="difflineminus">-        else {</span>
<a href="#l17.3305"></a><span id="l17.3305" class="difflineplus">+        } else {</span>
<a href="#l17.3306"></a><span id="l17.3306">           compFields-&gt;SetTo(from);</span>
<a href="#l17.3307"></a><span id="l17.3307">         }</span>
<a href="#l17.3308"></a><span id="l17.3308" class="difflineminus">-      }</span>
<a href="#l17.3309"></a><span id="l17.3309" class="difflineminus">-      else if (type == nsIMsgCompType::ReplyAll)</span>
<a href="#l17.3310"></a><span id="l17.3310" class="difflineminus">-      {</span>
<a href="#l17.3311"></a><span id="l17.3311" class="difflineminus">-        if (isReplyToSelf)</span>
<a href="#l17.3312"></a><span id="l17.3312" class="difflineminus">-        {</span>
<a href="#l17.3313"></a><span id="l17.3313" class="difflineplus">+      } else if (type == nsIMsgCompType::ReplyAll) {</span>
<a href="#l17.3314"></a><span id="l17.3314" class="difflineplus">+        if (isReplyToSelf) {</span>
<a href="#l17.3315"></a><span id="l17.3315">           // Cast to concrete class. We *only* what to change m_identity, not</span>
<a href="#l17.3316"></a><span id="l17.3316">           // all the things compose-&gt;SetIdentity would do.</span>
<a href="#l17.3317"></a><span id="l17.3317" class="difflineminus">-          nsMsgCompose* _compose = static_cast&lt;nsMsgCompose*&gt;(compose.get());</span>
<a href="#l17.3318"></a><span id="l17.3318" class="difflineplus">+          nsMsgCompose *_compose = static_cast&lt;nsMsgCompose *&gt;(compose.get());</span>
<a href="#l17.3319"></a><span id="l17.3319">           _compose-&gt;m_identity = selfIdentity;</span>
<a href="#l17.3320"></a><span id="l17.3320">           compFields-&gt;SetFrom(from);</span>
<a href="#l17.3321"></a><span id="l17.3321">           compFields-&gt;SetTo(to);</span>
<a href="#l17.3322"></a><span id="l17.3322">           compFields-&gt;SetCc(cc);</span>
<a href="#l17.3323"></a><span id="l17.3323">           // In case it's a reply to self, but it's not the actual source of the</span>
<a href="#l17.3324"></a><span id="l17.3324">           // sent message, then we won't know the Bcc header. So set it only if</span>
<a href="#l17.3325"></a><span id="l17.3325">           // it's not empty. If you have auto-bcc and removed the auto-bcc for</span>
<a href="#l17.3326"></a><span id="l17.3326">           // the original mail, you will have to do it manually for this reply</span>
<a href="#l17.3327"></a><span id="l17.3327">           // too.</span>
<a href="#l17.3328"></a><span id="l17.3328" class="difflineminus">-          if (!bcc.IsEmpty())</span>
<a href="#l17.3329"></a><span id="l17.3329" class="difflineminus">-            compFields-&gt;SetBcc(bcc);</span>
<a href="#l17.3330"></a><span id="l17.3330" class="difflineplus">+          if (!bcc.IsEmpty()) compFields-&gt;SetBcc(bcc);</span>
<a href="#l17.3331"></a><span id="l17.3331">           compFields-&gt;SetReplyTo(replyTo);</span>
<a href="#l17.3332"></a><span id="l17.3332">           needToRemoveDup = true;</span>
<a href="#l17.3333"></a><span id="l17.3333" class="difflineminus">-        }</span>
<a href="#l17.3334"></a><span id="l17.3334" class="difflineminus">-        else if (mailFollowupTo.IsEmpty()) {</span>
<a href="#l17.3335"></a><span id="l17.3335" class="difflineplus">+        } else if (mailFollowupTo.IsEmpty()) {</span>
<a href="#l17.3336"></a><span id="l17.3336">           // default reply-all behaviour then</span>
<a href="#l17.3337"></a><span id="l17.3337"> </span>
<a href="#l17.3338"></a><span id="l17.3338">           nsAutoString allTo;</span>
<a href="#l17.3339"></a><span id="l17.3339" class="difflineminus">-          if (!replyTo.IsEmpty())</span>
<a href="#l17.3340"></a><span id="l17.3340" class="difflineminus">-          {</span>
<a href="#l17.3341"></a><span id="l17.3341" class="difflineplus">+          if (!replyTo.IsEmpty()) {</span>
<a href="#l17.3342"></a><span id="l17.3342">             allTo.Assign(replyTo);</span>
<a href="#l17.3343"></a><span id="l17.3343">             needToRemoveDup = true;</span>
<a href="#l17.3344"></a><span id="l17.3344" class="difflineminus">-            if (overrideReplyTo &amp;&amp;</span>
<a href="#l17.3345"></a><span id="l17.3345" class="difflineminus">-                !listPost.IsEmpty() &amp;&amp; replyTo.Find(listPost) != kNotFound)</span>
<a href="#l17.3346"></a><span id="l17.3346" class="difflineminus">-            {</span>
<a href="#l17.3347"></a><span id="l17.3347" class="difflineplus">+            if (overrideReplyTo &amp;&amp; !listPost.IsEmpty() &amp;&amp;</span>
<a href="#l17.3348"></a><span id="l17.3348" class="difflineplus">+                replyTo.Find(listPost) != kNotFound) {</span>
<a href="#l17.3349"></a><span id="l17.3349">               // Reply-To munging in this list. Add From to recipients, it's the</span>
<a href="#l17.3350"></a><span id="l17.3350">               // lesser evil...</span>
<a href="#l17.3351"></a><span id="l17.3351">               allTo.AppendLiteral(&quot;, &quot;);</span>
<a href="#l17.3352"></a><span id="l17.3352">               allTo.Append(from);</span>
<a href="#l17.3353"></a><span id="l17.3353">             }</span>
<a href="#l17.3354"></a><span id="l17.3354" class="difflineminus">-          }</span>
<a href="#l17.3355"></a><span id="l17.3355" class="difflineminus">-          else</span>
<a href="#l17.3356"></a><span id="l17.3356" class="difflineminus">-          {</span>
<a href="#l17.3357"></a><span id="l17.3357" class="difflineplus">+          } else {</span>
<a href="#l17.3358"></a><span id="l17.3358">             allTo.Assign(from);</span>
<a href="#l17.3359"></a><span id="l17.3359">           }</span>
<a href="#l17.3360"></a><span id="l17.3360"> </span>
<a href="#l17.3361"></a><span id="l17.3361">           allTo.AppendLiteral(&quot;, &quot;);</span>
<a href="#l17.3362"></a><span id="l17.3362">           allTo.Append(to);</span>
<a href="#l17.3363"></a><span id="l17.3363">           compFields-&gt;SetTo(allTo);</span>
<a href="#l17.3364"></a><span id="l17.3364"> </span>
<a href="#l17.3365"></a><span id="l17.3365">           nsAutoString allCc;</span>
<a href="#l17.3366"></a><span id="l17.3366" class="difflineminus">-          compFields-&gt;GetCc(allCc); // auto-cc</span>
<a href="#l17.3367"></a><span id="l17.3367" class="difflineminus">-          if (!allCc.IsEmpty())</span>
<a href="#l17.3368"></a><span id="l17.3368" class="difflineminus">-            allCc.AppendLiteral(&quot;, &quot;);</span>
<a href="#l17.3369"></a><span id="l17.3369" class="difflineplus">+          compFields-&gt;GetCc(allCc);  // auto-cc</span>
<a href="#l17.3370"></a><span id="l17.3370" class="difflineplus">+          if (!allCc.IsEmpty()) allCc.AppendLiteral(&quot;, &quot;);</span>
<a href="#l17.3371"></a><span id="l17.3371">           allCc.Append(cc);</span>
<a href="#l17.3372"></a><span id="l17.3372">           compFields-&gt;SetCc(allCc);</span>
<a href="#l17.3373"></a><span id="l17.3373"> </span>
<a href="#l17.3374"></a><span id="l17.3374">           needToRemoveDup = true;</span>
<a href="#l17.3375"></a><span id="l17.3375" class="difflineminus">-        }</span>
<a href="#l17.3376"></a><span id="l17.3376" class="difflineminus">-        else</span>
<a href="#l17.3377"></a><span id="l17.3377" class="difflineminus">-        {</span>
<a href="#l17.3378"></a><span id="l17.3378" class="difflineplus">+        } else {</span>
<a href="#l17.3379"></a><span id="l17.3379">           // Handle Mail-Followup-To (http://cr.yp.to/proto/replyto.html)</span>
<a href="#l17.3380"></a><span id="l17.3380">           compFields-&gt;SetTo(mailFollowupTo);</span>
<a href="#l17.3381"></a><span id="l17.3381" class="difflineminus">-          needToRemoveDup = true; // To remove possible self from To.</span>
<a href="#l17.3382"></a><span id="l17.3382" class="difflineplus">+          needToRemoveDup = true;  // To remove possible self from To.</span>
<a href="#l17.3383"></a><span id="l17.3383"> </span>
<a href="#l17.3384"></a><span id="l17.3384">           // If Cc is set a this point it's auto-Ccs, so we'll just keep those.</span>
<a href="#l17.3385"></a><span id="l17.3385">         }</span>
<a href="#l17.3386"></a><span id="l17.3386" class="difflineminus">-      }</span>
<a href="#l17.3387"></a><span id="l17.3387" class="difflineminus">-      else if (type == nsIMsgCompType::ReplyToList)</span>
<a href="#l17.3388"></a><span id="l17.3388" class="difflineminus">-      {</span>
<a href="#l17.3389"></a><span id="l17.3389" class="difflineplus">+      } else if (type == nsIMsgCompType::ReplyToList) {</span>
<a href="#l17.3390"></a><span id="l17.3390">         compFields-&gt;SetTo(listPost);</span>
<a href="#l17.3391"></a><span id="l17.3391">       }</span>
<a href="#l17.3392"></a><span id="l17.3392"> </span>
<a href="#l17.3393"></a><span id="l17.3393" class="difflineminus">-      if (!newgroups.IsEmpty())</span>
<a href="#l17.3394"></a><span id="l17.3394" class="difflineminus">-      {</span>
<a href="#l17.3395"></a><span id="l17.3395" class="difflineminus">-        if ((type != nsIMsgCompType::Reply) &amp;&amp; (type != nsIMsgCompType::ReplyToSender))</span>
<a href="#l17.3396"></a><span id="l17.3396" class="difflineplus">+      if (!newgroups.IsEmpty()) {</span>
<a href="#l17.3397"></a><span id="l17.3397" class="difflineplus">+        if ((type != nsIMsgCompType::Reply) &amp;&amp;</span>
<a href="#l17.3398"></a><span id="l17.3398" class="difflineplus">+            (type != nsIMsgCompType::ReplyToSender))</span>
<a href="#l17.3399"></a><span id="l17.3399">           compFields-&gt;SetNewsgroups(newgroups);</span>
<a href="#l17.3400"></a><span id="l17.3400">         if (type == nsIMsgCompType::ReplyToGroup)</span>
<a href="#l17.3401"></a><span id="l17.3401">           compFields-&gt;SetTo(EmptyString());</span>
<a href="#l17.3402"></a><span id="l17.3402">       }</span>
<a href="#l17.3403"></a><span id="l17.3403"> </span>
<a href="#l17.3404"></a><span id="l17.3404" class="difflineminus">-      if (!followUpTo.IsEmpty())</span>
<a href="#l17.3405"></a><span id="l17.3405" class="difflineminus">-      {</span>
<a href="#l17.3406"></a><span id="l17.3406" class="difflineplus">+      if (!followUpTo.IsEmpty()) {</span>
<a href="#l17.3407"></a><span id="l17.3407">         // Handle &quot;followup-to: poster&quot; magic keyword here</span>
<a href="#l17.3408"></a><span id="l17.3408" class="difflineminus">-        if (followUpTo.EqualsLiteral(&quot;poster&quot;))</span>
<a href="#l17.3409"></a><span id="l17.3409" class="difflineminus">-        {</span>
<a href="#l17.3410"></a><span id="l17.3410" class="difflineplus">+        if (followUpTo.EqualsLiteral(&quot;poster&quot;)) {</span>
<a href="#l17.3411"></a><span id="l17.3411">           nsCOMPtr&lt;mozIDOMWindowProxy&gt; domWindow;</span>
<a href="#l17.3412"></a><span id="l17.3412">           nsCOMPtr&lt;nsIPrompt&gt; prompt;</span>
<a href="#l17.3413"></a><span id="l17.3413">           compose-&gt;GetDomWindow(getter_AddRefs(domWindow));</span>
<a href="#l17.3414"></a><span id="l17.3414">           NS_ENSURE_TRUE(domWindow, NS_ERROR_FAILURE);</span>
<a href="#l17.3415"></a><span id="l17.3415" class="difflineminus">-          nsCOMPtr&lt;nsPIDOMWindowOuter&gt; composeWindow = nsPIDOMWindowOuter::From(domWindow);</span>
<a href="#l17.3416"></a><span id="l17.3416" class="difflineminus">-          if (composeWindow)</span>
<a href="#l17.3417"></a><span id="l17.3417" class="difflineminus">-            composeWindow-&gt;GetPrompter(getter_AddRefs(prompt));</span>
<a href="#l17.3418"></a><span id="l17.3418" class="difflineplus">+          nsCOMPtr&lt;nsPIDOMWindowOuter&gt; composeWindow =</span>
<a href="#l17.3419"></a><span id="l17.3419" class="difflineplus">+              nsPIDOMWindowOuter::From(domWindow);</span>
<a href="#l17.3420"></a><span id="l17.3420" class="difflineplus">+          if (composeWindow) composeWindow-&gt;GetPrompter(getter_AddRefs(prompt));</span>
<a href="#l17.3421"></a><span id="l17.3421">           nsMsgDisplayMessageByName(prompt, &quot;followupToSenderMessage&quot;);</span>
<a href="#l17.3422"></a><span id="l17.3422"> </span>
<a href="#l17.3423"></a><span id="l17.3423" class="difflineminus">-          if (!replyTo.IsEmpty())</span>
<a href="#l17.3424"></a><span id="l17.3424" class="difflineminus">-          {</span>
<a href="#l17.3425"></a><span id="l17.3425" class="difflineplus">+          if (!replyTo.IsEmpty()) {</span>
<a href="#l17.3426"></a><span id="l17.3426">             compFields-&gt;SetTo(replyTo);</span>
<a href="#l17.3427"></a><span id="l17.3427" class="difflineminus">-          }</span>
<a href="#l17.3428"></a><span id="l17.3428" class="difflineminus">-          else</span>
<a href="#l17.3429"></a><span id="l17.3429" class="difflineminus">-          {</span>
<a href="#l17.3430"></a><span id="l17.3430" class="difflineplus">+          } else {</span>
<a href="#l17.3431"></a><span id="l17.3431">             // If reply-to is empty, use the From header to fetch the original</span>
<a href="#l17.3432"></a><span id="l17.3432">             // sender's email.</span>
<a href="#l17.3433"></a><span id="l17.3433">             compFields-&gt;SetTo(from);</span>
<a href="#l17.3434"></a><span id="l17.3434">           }</span>
<a href="#l17.3435"></a><span id="l17.3435"> </span>
<a href="#l17.3436"></a><span id="l17.3436">           // Clear the newsgroup: header field, because followup-to: poster</span>
<a href="#l17.3437"></a><span id="l17.3437">           // only follows up to the original sender</span>
<a href="#l17.3438"></a><span id="l17.3438" class="difflineminus">-          if (!newgroups.IsEmpty())</span>
<a href="#l17.3439"></a><span id="l17.3439" class="difflineminus">-            compFields-&gt;SetNewsgroups(EmptyString());</span>
<a href="#l17.3440"></a><span id="l17.3440" class="difflineminus">-        }</span>
<a href="#l17.3441"></a><span id="l17.3441" class="difflineminus">-        else // Process &quot;followup-to: newsgroup-content&quot; here</span>
<a href="#l17.3442"></a><span id="l17.3442" class="difflineplus">+          if (!newgroups.IsEmpty()) compFields-&gt;SetNewsgroups(EmptyString());</span>
<a href="#l17.3443"></a><span id="l17.3443" class="difflineplus">+        } else  // Process &quot;followup-to: newsgroup-content&quot; here</span>
<a href="#l17.3444"></a><span id="l17.3444">         {</span>
<a href="#l17.3445"></a><span id="l17.3445">           if (type != nsIMsgCompType::ReplyToSender)</span>
<a href="#l17.3446"></a><span id="l17.3446">             compFields-&gt;SetNewsgroups(followUpTo);</span>
<a href="#l17.3447"></a><span id="l17.3447" class="difflineminus">-          if (type == nsIMsgCompType::Reply)</span>
<a href="#l17.3448"></a><span id="l17.3448" class="difflineminus">-          {</span>
<a href="#l17.3449"></a><span id="l17.3449" class="difflineplus">+          if (type == nsIMsgCompType::Reply) {</span>
<a href="#l17.3450"></a><span id="l17.3450">             compFields-&gt;SetTo(EmptyString());</span>
<a href="#l17.3451"></a><span id="l17.3451">           }</span>
<a href="#l17.3452"></a><span id="l17.3452">         }</span>
<a href="#l17.3453"></a><span id="l17.3453">       }</span>
<a href="#l17.3454"></a><span id="l17.3454"> </span>
<a href="#l17.3455"></a><span id="l17.3455" class="difflineminus">-      if (!references.IsEmpty())</span>
<a href="#l17.3456"></a><span id="l17.3456" class="difflineminus">-        references.Append(char16_t(' '));</span>
<a href="#l17.3457"></a><span id="l17.3457" class="difflineplus">+      if (!references.IsEmpty()) references.Append(char16_t(' '));</span>
<a href="#l17.3458"></a><span id="l17.3458">       references += messageId;</span>
<a href="#l17.3459"></a><span id="l17.3459">       compFields-&gt;SetReferences(NS_LossyConvertUTF16toASCII(references).get());</span>
<a href="#l17.3460"></a><span id="l17.3460"> </span>
<a href="#l17.3461"></a><span id="l17.3461">       nsAutoCString resultStr;</span>
<a href="#l17.3462"></a><span id="l17.3462"> </span>
<a href="#l17.3463"></a><span id="l17.3463">       // Cast interface to concrete class that has direct field getters etc.</span>
<a href="#l17.3464"></a><span id="l17.3464" class="difflineminus">-      nsMsgCompFields* _compFields = static_cast&lt;nsMsgCompFields*&gt;(compFields.get());</span>
<a href="#l17.3465"></a><span id="l17.3465" class="difflineplus">+      nsMsgCompFields *_compFields =</span>
<a href="#l17.3466"></a><span id="l17.3466" class="difflineplus">+          static_cast&lt;nsMsgCompFields *&gt;(compFields.get());</span>
<a href="#l17.3467"></a><span id="l17.3467"> </span>
<a href="#l17.3468"></a><span id="l17.3468">       // Remove duplicate addresses between To &amp;&amp; Cc.</span>
<a href="#l17.3469"></a><span id="l17.3469" class="difflineminus">-      if (needToRemoveDup)</span>
<a href="#l17.3470"></a><span id="l17.3470" class="difflineminus">-      {</span>
<a href="#l17.3471"></a><span id="l17.3471" class="difflineplus">+      if (needToRemoveDup) {</span>
<a href="#l17.3472"></a><span id="l17.3472">         nsCString addressesToRemoveFromCc;</span>
<a href="#l17.3473"></a><span id="l17.3473" class="difflineminus">-        if (mIdentity)</span>
<a href="#l17.3474"></a><span id="l17.3474" class="difflineminus">-        {</span>
<a href="#l17.3475"></a><span id="l17.3475" class="difflineplus">+        if (mIdentity) {</span>
<a href="#l17.3476"></a><span id="l17.3476">           bool removeMyEmailInCc = true;</span>
<a href="#l17.3477"></a><span id="l17.3477">           nsCString myEmail;</span>
<a href="#l17.3478"></a><span id="l17.3478">           mIdentity-&gt;GetEmail(myEmail);</span>
<a href="#l17.3479"></a><span id="l17.3479"> </span>
<a href="#l17.3480"></a><span id="l17.3480">           // Remove my own address from To, unless it's a reply to self.</span>
<a href="#l17.3481"></a><span id="l17.3481">           if (!isReplyToSelf) {</span>
<a href="#l17.3482"></a><span id="l17.3482">             RemoveDuplicateAddresses(nsDependentCString(_compFields-&gt;GetTo()),</span>
<a href="#l17.3483"></a><span id="l17.3483">                                      myEmail, resultStr);</span>
<a href="#l17.3484"></a><span id="l17.3484" class="difflineat">@@ -2915,276 +2655,249 @@ QuotingOutputStreamListener::OnStopReque</span>
<a href="#l17.3485"></a><span id="l17.3485">           // three cases:</span>
<a href="#l17.3486"></a><span id="l17.3486">           // - user has no automatic CC</span>
<a href="#l17.3487"></a><span id="l17.3487">           // - user has automatic CC but own email is not in it</span>
<a href="#l17.3488"></a><span id="l17.3488">           // - user has automatic CC and own email in it</span>
<a href="#l17.3489"></a><span id="l17.3489">           // Only in the last case do we want our own email address to stay</span>
<a href="#l17.3490"></a><span id="l17.3490">           // in the CC list.</span>
<a href="#l17.3491"></a><span id="l17.3491">           bool automaticCc;</span>
<a href="#l17.3492"></a><span id="l17.3492">           mIdentity-&gt;GetDoCc(&amp;automaticCc);</span>
<a href="#l17.3493"></a><span id="l17.3493" class="difflineminus">-          if (automaticCc)</span>
<a href="#l17.3494"></a><span id="l17.3494" class="difflineminus">-          {</span>
<a href="#l17.3495"></a><span id="l17.3495" class="difflineplus">+          if (automaticCc) {</span>
<a href="#l17.3496"></a><span id="l17.3496">             nsCString autoCcList;</span>
<a href="#l17.3497"></a><span id="l17.3497">             mIdentity-&gt;GetDoCcList(autoCcList);</span>
<a href="#l17.3498"></a><span id="l17.3498">             nsTArray&lt;nsCString&gt; autoCcEmailAddresses;</span>
<a href="#l17.3499"></a><span id="l17.3499">             ExtractEmails(EncodedHeader(autoCcList),</span>
<a href="#l17.3500"></a><span id="l17.3500" class="difflineminus">-              UTF16ArrayAdapter&lt;&gt;(autoCcEmailAddresses));</span>
<a href="#l17.3501"></a><span id="l17.3501" class="difflineminus">-            if (autoCcEmailAddresses.Contains(myEmail))</span>
<a href="#l17.3502"></a><span id="l17.3502" class="difflineminus">-            {</span>
<a href="#l17.3503"></a><span id="l17.3503" class="difflineplus">+                          UTF16ArrayAdapter&lt;&gt;(autoCcEmailAddresses));</span>
<a href="#l17.3504"></a><span id="l17.3504" class="difflineplus">+            if (autoCcEmailAddresses.Contains(myEmail)) {</span>
<a href="#l17.3505"></a><span id="l17.3505">               removeMyEmailInCc = false;</span>
<a href="#l17.3506"></a><span id="l17.3506">             }</span>
<a href="#l17.3507"></a><span id="l17.3507">           }</span>
<a href="#l17.3508"></a><span id="l17.3508"> </span>
<a href="#l17.3509"></a><span id="l17.3509" class="difflineminus">-          if (removeMyEmailInCc)</span>
<a href="#l17.3510"></a><span id="l17.3510" class="difflineminus">-          {</span>
<a href="#l17.3511"></a><span id="l17.3511" class="difflineplus">+          if (removeMyEmailInCc) {</span>
<a href="#l17.3512"></a><span id="l17.3512">             addressesToRemoveFromCc.AppendLiteral(&quot;, &quot;);</span>
<a href="#l17.3513"></a><span id="l17.3513">             addressesToRemoveFromCc.Append(myEmail);</span>
<a href="#l17.3514"></a><span id="l17.3514">           }</span>
<a href="#l17.3515"></a><span id="l17.3515">         }</span>
<a href="#l17.3516"></a><span id="l17.3516">         RemoveDuplicateAddresses(nsDependentCString(_compFields-&gt;GetCc()),</span>
<a href="#l17.3517"></a><span id="l17.3517">                                  addressesToRemoveFromCc, resultStr);</span>
<a href="#l17.3518"></a><span id="l17.3518">         _compFields-&gt;SetCc(resultStr.get());</span>
<a href="#l17.3519"></a><span id="l17.3519" class="difflineminus">-        if (_compFields-&gt;GetBcc())</span>
<a href="#l17.3520"></a><span id="l17.3520" class="difflineminus">-        {</span>
<a href="#l17.3521"></a><span id="l17.3521" class="difflineplus">+        if (_compFields-&gt;GetBcc()) {</span>
<a href="#l17.3522"></a><span id="l17.3522">           // Remove addresses already in Cc from Bcc.</span>
<a href="#l17.3523"></a><span id="l17.3523">           RemoveDuplicateAddresses(nsDependentCString(_compFields-&gt;GetBcc()),</span>
<a href="#l17.3524"></a><span id="l17.3524">                                    nsDependentCString(_compFields-&gt;GetCc()),</span>
<a href="#l17.3525"></a><span id="l17.3525">                                    resultStr);</span>
<a href="#l17.3526"></a><span id="l17.3526" class="difflineminus">-          if (!resultStr.IsEmpty())</span>
<a href="#l17.3527"></a><span id="l17.3527" class="difflineminus">-          {</span>
<a href="#l17.3528"></a><span id="l17.3528" class="difflineplus">+          if (!resultStr.IsEmpty()) {</span>
<a href="#l17.3529"></a><span id="l17.3529">             // Remove addresses already in To from Bcc.</span>
<a href="#l17.3530"></a><span id="l17.3530" class="difflineminus">-            RemoveDuplicateAddresses(resultStr,</span>
<a href="#l17.3531"></a><span id="l17.3531" class="difflineminus">-                                     nsDependentCString(_compFields-&gt;GetTo()),</span>
<a href="#l17.3532"></a><span id="l17.3532" class="difflineminus">-                                     resultStr);</span>
<a href="#l17.3533"></a><span id="l17.3533" class="difflineplus">+            RemoveDuplicateAddresses(</span>
<a href="#l17.3534"></a><span id="l17.3534" class="difflineplus">+                resultStr, nsDependentCString(_compFields-&gt;GetTo()), resultStr);</span>
<a href="#l17.3535"></a><span id="l17.3535">           }</span>
<a href="#l17.3536"></a><span id="l17.3536">           _compFields-&gt;SetBcc(resultStr.get());</span>
<a href="#l17.3537"></a><span id="l17.3537">         }</span>
<a href="#l17.3538"></a><span id="l17.3538">       }</span>
<a href="#l17.3539"></a><span id="l17.3539">     }</span>
<a href="#l17.3540"></a><span id="l17.3540">   }</span>
<a href="#l17.3541"></a><span id="l17.3541"> </span>
<a href="#l17.3542"></a><span id="l17.3542"> #ifdef MSGCOMP_TRACE_PERFORMANCE</span>
<a href="#l17.3543"></a><span id="l17.3543" class="difflineminus">-  nsCOMPtr&lt;nsIMsgComposeService&gt; composeService (do_GetService(NS_MSGCOMPOSESERVICE_CONTRACTID));</span>
<a href="#l17.3544"></a><span id="l17.3544" class="difflineminus">-  composeService-&gt;TimeStamp(&quot;Done with MIME. Now we're updating the UI elements&quot;, false);</span>
<a href="#l17.3545"></a><span id="l17.3545" class="difflineplus">+  nsCOMPtr&lt;nsIMsgComposeService&gt; composeService(</span>
<a href="#l17.3546"></a><span id="l17.3546" class="difflineplus">+      do_GetService(NS_MSGCOMPOSESERVICE_CONTRACTID));</span>
<a href="#l17.3547"></a><span id="l17.3547" class="difflineplus">+  composeService-&gt;TimeStamp(</span>
<a href="#l17.3548"></a><span id="l17.3548" class="difflineplus">+      &quot;Done with MIME. Now we're updating the UI elements&quot;, false);</span>
<a href="#l17.3549"></a><span id="l17.3549"> #endif</span>
<a href="#l17.3550"></a><span id="l17.3550"> </span>
<a href="#l17.3551"></a><span id="l17.3551">   if (mQuoteOriginal)</span>
<a href="#l17.3552"></a><span id="l17.3552" class="difflineminus">-    compose-&gt;NotifyStateListeners(nsIMsgComposeNotificationType::ComposeFieldsReady, NS_OK);</span>
<a href="#l17.3553"></a><span id="l17.3553" class="difflineplus">+    compose-&gt;NotifyStateListeners(</span>
<a href="#l17.3554"></a><span id="l17.3554" class="difflineplus">+        nsIMsgComposeNotificationType::ComposeFieldsReady, NS_OK);</span>
<a href="#l17.3555"></a><span id="l17.3555"> </span>
<a href="#l17.3556"></a><span id="l17.3556"> #ifdef MSGCOMP_TRACE_PERFORMANCE</span>
<a href="#l17.3557"></a><span id="l17.3557" class="difflineminus">-  composeService-&gt;TimeStamp(&quot;Addressing widget, window title and focus are now set, time to insert the body&quot;, false);</span>
<a href="#l17.3558"></a><span id="l17.3558" class="difflineplus">+  composeService-&gt;TimeStamp(</span>
<a href="#l17.3559"></a><span id="l17.3559" class="difflineplus">+      &quot;Addressing widget, window title and focus are now set, time to insert &quot;</span>
<a href="#l17.3560"></a><span id="l17.3560" class="difflineplus">+      &quot;the body&quot;,</span>
<a href="#l17.3561"></a><span id="l17.3561" class="difflineplus">+      false);</span>
<a href="#l17.3562"></a><span id="l17.3562"> #endif</span>
<a href="#l17.3563"></a><span id="l17.3563"> </span>
<a href="#l17.3564"></a><span id="l17.3564" class="difflineminus">-  if (! mHeadersOnly)</span>
<a href="#l17.3565"></a><span id="l17.3565" class="difflineminus">-    mMsgBody.AppendLiteral(&quot;&lt;/html&gt;&quot;);</span>
<a href="#l17.3566"></a><span id="l17.3566" class="difflineplus">+  if (!mHeadersOnly) mMsgBody.AppendLiteral(&quot;&lt;/html&gt;&quot;);</span>
<a href="#l17.3567"></a><span id="l17.3567"> </span>
<a href="#l17.3568"></a><span id="l17.3568">   // Now we have an HTML representation of the quoted message.</span>
<a href="#l17.3569"></a><span id="l17.3569">   // If we are in plain text mode, we need to convert this to plain</span>
<a href="#l17.3570"></a><span id="l17.3570">   // text before we try to insert it into the editor. If we don't, we</span>
<a href="#l17.3571"></a><span id="l17.3571">   // just get lots of HTML text in the message...not good.</span>
<a href="#l17.3572"></a><span id="l17.3572">   //</span>
<a href="#l17.3573"></a><span id="l17.3573">   // XXX not m_composeHTML? /BenB</span>
<a href="#l17.3574"></a><span id="l17.3574">   bool composeHTML = true;</span>
<a href="#l17.3575"></a><span id="l17.3575">   compose-&gt;GetComposeHTML(&amp;composeHTML);</span>
<a href="#l17.3576"></a><span id="l17.3576" class="difflineminus">-  if (!composeHTML)</span>
<a href="#l17.3577"></a><span id="l17.3577" class="difflineminus">-  {</span>
<a href="#l17.3578"></a><span id="l17.3578" class="difflineplus">+  if (!composeHTML) {</span>
<a href="#l17.3579"></a><span id="l17.3579">     // Downsampling.</span>
<a href="#l17.3580"></a><span id="l17.3580"> </span>
<a href="#l17.3581"></a><span id="l17.3581">     // In plain text quotes we always allow line breaking to not end up with</span>
<a href="#l17.3582"></a><span id="l17.3582">     // long lines. The quote is inserted into a span with style</span>
<a href="#l17.3583"></a><span id="l17.3583">     // &quot;white-space: pre;&quot; which isn't be wrapped.</span>
<a href="#l17.3584"></a><span id="l17.3584">     // Update: Bug 387687 changed this to &quot;white-space: pre-wrap;&quot;.</span>
<a href="#l17.3585"></a><span id="l17.3585">     // Note that the body of the plain text message is wrapped since it uses</span>
<a href="#l17.3586"></a><span id="l17.3586">     // &quot;white-space: pre-wrap; width: 72ch;&quot;.</span>
<a href="#l17.3587"></a><span id="l17.3587">     // Look at it in the DOM Inspector to see it.</span>
<a href="#l17.3588"></a><span id="l17.3588">     //</span>
<a href="#l17.3589"></a><span id="l17.3589">     // If we're using format flowed, we need to pass it so the encoder</span>
<a href="#l17.3590"></a><span id="l17.3590">     // can add a space at the end.</span>
<a href="#l17.3591"></a><span id="l17.3591" class="difflineminus">-    nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l17.3592"></a><span id="l17.3592" class="difflineplus">+    nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranch(</span>
<a href="#l17.3593"></a><span id="l17.3593" class="difflineplus">+        do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l17.3594"></a><span id="l17.3594">     bool flowed = false;</span>
<a href="#l17.3595"></a><span id="l17.3595">     if (pPrefBranch) {</span>
<a href="#l17.3596"></a><span id="l17.3596">       pPrefBranch-&gt;GetBoolPref(&quot;mailnews.send_plaintext_flowed&quot;, &amp;flowed);</span>
<a href="#l17.3597"></a><span id="l17.3597">     }</span>
<a href="#l17.3598"></a><span id="l17.3598"> </span>
<a href="#l17.3599"></a><span id="l17.3599">     rv = ConvertToPlainText(flowed,</span>
<a href="#l17.3600"></a><span id="l17.3600" class="difflineminus">-                            false,  // delsp makes no sense in this context</span>
<a href="#l17.3601"></a><span id="l17.3601" class="difflineminus">-                            true,   // formatted</span>
<a href="#l17.3602"></a><span id="l17.3602" class="difflineminus">-                            false); // allow line breaks</span>
<a href="#l17.3603"></a><span id="l17.3603" class="difflineplus">+                            false,   // delsp makes no sense in this context</span>
<a href="#l17.3604"></a><span id="l17.3604" class="difflineplus">+                            true,    // formatted</span>
<a href="#l17.3605"></a><span id="l17.3605" class="difflineplus">+                            false);  // allow line breaks</span>
<a href="#l17.3606"></a><span id="l17.3606">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.3607"></a><span id="l17.3607">   }</span>
<a href="#l17.3608"></a><span id="l17.3608"> </span>
<a href="#l17.3609"></a><span id="l17.3609">   compose-&gt;ProcessSignature(mIdentity, true, &amp;mSignature);</span>
<a href="#l17.3610"></a><span id="l17.3610"> </span>
<a href="#l17.3611"></a><span id="l17.3611">   nsCOMPtr&lt;nsIEditor&gt; editor;</span>
<a href="#l17.3612"></a><span id="l17.3612" class="difflineminus">-  if (NS_SUCCEEDED(compose-&gt;GetEditor(getter_AddRefs(editor))) &amp;&amp; editor)</span>
<a href="#l17.3613"></a><span id="l17.3613" class="difflineminus">-  {</span>
<a href="#l17.3614"></a><span id="l17.3614" class="difflineplus">+  if (NS_SUCCEEDED(compose-&gt;GetEditor(getter_AddRefs(editor))) &amp;&amp; editor) {</span>
<a href="#l17.3615"></a><span id="l17.3615">     if (mQuoteOriginal)</span>
<a href="#l17.3616"></a><span id="l17.3616" class="difflineminus">-      compose-&gt;ConvertAndLoadComposeWindow(mCitePrefix,</span>
<a href="#l17.3617"></a><span id="l17.3617" class="difflineminus">-                                           mMsgBody, mSignature,</span>
<a href="#l17.3618"></a><span id="l17.3618" class="difflineplus">+      compose-&gt;ConvertAndLoadComposeWindow(mCitePrefix, mMsgBody, mSignature,</span>
<a href="#l17.3619"></a><span id="l17.3619">                                            true, composeHTML);</span>
<a href="#l17.3620"></a><span id="l17.3620">     else</span>
<a href="#l17.3621"></a><span id="l17.3621">       InsertToCompose(editor, composeHTML);</span>
<a href="#l17.3622"></a><span id="l17.3622">   }</span>
<a href="#l17.3623"></a><span id="l17.3623"> </span>
<a href="#l17.3624"></a><span id="l17.3624">   if (mQuoteOriginal)</span>
<a href="#l17.3625"></a><span id="l17.3625" class="difflineminus">-    compose-&gt;NotifyStateListeners(nsIMsgComposeNotificationType::ComposeBodyReady, NS_OK);</span>
<a href="#l17.3626"></a><span id="l17.3626" class="difflineplus">+    compose-&gt;NotifyStateListeners(</span>
<a href="#l17.3627"></a><span id="l17.3627" class="difflineplus">+        nsIMsgComposeNotificationType::ComposeBodyReady, NS_OK);</span>
<a href="#l17.3628"></a><span id="l17.3628">   return rv;</span>
<a href="#l17.3629"></a><span id="l17.3629"> }</span>
<a href="#l17.3630"></a><span id="l17.3630"> </span>
<a href="#l17.3631"></a><span id="l17.3631" class="difflineminus">-NS_IMETHODIMP QuotingOutputStreamListener::OnDataAvailable(nsIRequest *request,</span>
<a href="#l17.3632"></a><span id="l17.3632" class="difflineminus">-                              nsIInputStream *inStr,</span>
<a href="#l17.3633"></a><span id="l17.3633" class="difflineminus">-                              uint64_t sourceOffset, uint32_t count)</span>
<a href="#l17.3634"></a><span id="l17.3634" class="difflineminus">-{</span>
<a href="#l17.3635"></a><span id="l17.3635" class="difflineplus">+NS_IMETHODIMP QuotingOutputStreamListener::OnDataAvailable(</span>
<a href="#l17.3636"></a><span id="l17.3636" class="difflineplus">+    nsIRequest *request, nsIInputStream *inStr, uint64_t sourceOffset,</span>
<a href="#l17.3637"></a><span id="l17.3637" class="difflineplus">+    uint32_t count) {</span>
<a href="#l17.3638"></a><span id="l17.3638">   nsresult rv = NS_OK;</span>
<a href="#l17.3639"></a><span id="l17.3639">   NS_ENSURE_ARG(inStr);</span>
<a href="#l17.3640"></a><span id="l17.3640"> </span>
<a href="#l17.3641"></a><span id="l17.3641" class="difflineminus">-  if (mHeadersOnly)</span>
<a href="#l17.3642"></a><span id="l17.3642" class="difflineminus">-    return rv;</span>
<a href="#l17.3643"></a><span id="l17.3643" class="difflineplus">+  if (mHeadersOnly) return rv;</span>
<a href="#l17.3644"></a><span id="l17.3644"> </span>
<a href="#l17.3645"></a><span id="l17.3645">   char *newBuf = (char *)PR_Malloc(count + 1);</span>
<a href="#l17.3646"></a><span id="l17.3646" class="difflineminus">-  if (!newBuf)</span>
<a href="#l17.3647"></a><span id="l17.3647" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l17.3648"></a><span id="l17.3648" class="difflineplus">+  if (!newBuf) return NS_ERROR_FAILURE;</span>
<a href="#l17.3649"></a><span id="l17.3649"> </span>
<a href="#l17.3650"></a><span id="l17.3650">   uint32_t numWritten = 0;</span>
<a href="#l17.3651"></a><span id="l17.3651">   rv = inStr-&gt;Read(newBuf, count, &amp;numWritten);</span>
<a href="#l17.3652"></a><span id="l17.3652" class="difflineminus">-  if (rv == NS_BASE_STREAM_WOULD_BLOCK)</span>
<a href="#l17.3653"></a><span id="l17.3653" class="difflineminus">-    rv = NS_OK;</span>
<a href="#l17.3654"></a><span id="l17.3654" class="difflineplus">+  if (rv == NS_BASE_STREAM_WOULD_BLOCK) rv = NS_OK;</span>
<a href="#l17.3655"></a><span id="l17.3655">   newBuf[numWritten] = '\0';</span>
<a href="#l17.3656"></a><span id="l17.3656" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; numWritten &gt; 0)</span>
<a href="#l17.3657"></a><span id="l17.3657" class="difflineminus">-  {</span>
<a href="#l17.3658"></a><span id="l17.3658" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; numWritten &gt; 0) {</span>
<a href="#l17.3659"></a><span id="l17.3659">     rv = AppendToMsgBody(nsDependentCString(newBuf, numWritten));</span>
<a href="#l17.3660"></a><span id="l17.3660">   }</span>
<a href="#l17.3661"></a><span id="l17.3661"> </span>
<a href="#l17.3662"></a><span id="l17.3662">   PR_FREEIF(newBuf);</span>
<a href="#l17.3663"></a><span id="l17.3663">   return rv;</span>
<a href="#l17.3664"></a><span id="l17.3664"> }</span>
<a href="#l17.3665"></a><span id="l17.3665"> </span>
<a href="#l17.3666"></a><span id="l17.3666" class="difflineminus">-nsresult QuotingOutputStreamListener::AppendToMsgBody(const nsCString &amp;inStr)</span>
<a href="#l17.3667"></a><span id="l17.3667" class="difflineminus">-{</span>
<a href="#l17.3668"></a><span id="l17.3668" class="difflineplus">+nsresult QuotingOutputStreamListener::AppendToMsgBody(const nsCString &amp;inStr) {</span>
<a href="#l17.3669"></a><span id="l17.3669">   nsresult rv = NS_OK;</span>
<a href="#l17.3670"></a><span id="l17.3670">   if (!inStr.IsEmpty()) {</span>
<a href="#l17.3671"></a><span id="l17.3671">     nsAutoString tmp;</span>
<a href="#l17.3672"></a><span id="l17.3672">     rv = UTF_8_ENCODING-&gt;DecodeWithoutBOMHandling(inStr, tmp);</span>
<a href="#l17.3673"></a><span id="l17.3673" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l17.3674"></a><span id="l17.3674" class="difflineminus">-      mMsgBody.Append(tmp);</span>
<a href="#l17.3675"></a><span id="l17.3675" class="difflineplus">+    if (NS_SUCCEEDED(rv)) mMsgBody.Append(tmp);</span>
<a href="#l17.3676"></a><span id="l17.3676">   }</span>
<a href="#l17.3677"></a><span id="l17.3677">   return rv;</span>
<a href="#l17.3678"></a><span id="l17.3678"> }</span>
<a href="#l17.3679"></a><span id="l17.3679"> </span>
<a href="#l17.3680"></a><span id="l17.3680" class="difflineminus">-nsresult</span>
<a href="#l17.3681"></a><span id="l17.3681" class="difflineminus">-QuotingOutputStreamListener::SetComposeObj(nsIMsgCompose *obj)</span>
<a href="#l17.3682"></a><span id="l17.3682" class="difflineminus">-{</span>
<a href="#l17.3683"></a><span id="l17.3683" class="difflineplus">+nsresult QuotingOutputStreamListener::SetComposeObj(nsIMsgCompose *obj) {</span>
<a href="#l17.3684"></a><span id="l17.3684">   mWeakComposeObj = do_GetWeakReference(obj);</span>
<a href="#l17.3685"></a><span id="l17.3685">   return NS_OK;</span>
<a href="#l17.3686"></a><span id="l17.3686"> }</span>
<a href="#l17.3687"></a><span id="l17.3687"> </span>
<a href="#l17.3688"></a><span id="l17.3688"> NS_IMETHODIMP</span>
<a href="#l17.3689"></a><span id="l17.3689" class="difflineminus">-QuotingOutputStreamListener::SetMimeHeaders(nsIMimeHeaders * headers)</span>
<a href="#l17.3690"></a><span id="l17.3690" class="difflineminus">-{</span>
<a href="#l17.3691"></a><span id="l17.3691" class="difflineplus">+QuotingOutputStreamListener::SetMimeHeaders(nsIMimeHeaders *headers) {</span>
<a href="#l17.3692"></a><span id="l17.3692">   mHeaders = headers;</span>
<a href="#l17.3693"></a><span id="l17.3693">   return NS_OK;</span>
<a href="#l17.3694"></a><span id="l17.3694"> }</span>
<a href="#l17.3695"></a><span id="l17.3695"> </span>
<a href="#l17.3696"></a><span id="l17.3696" class="difflineminus">-MOZ_CAN_RUN_SCRIPT nsresult</span>
<a href="#l17.3697"></a><span id="l17.3697" class="difflineminus">-QuotingOutputStreamListener::InsertToCompose(nsIEditor *aEditor,</span>
<a href="#l17.3698"></a><span id="l17.3698" class="difflineminus">-                                             bool aHTMLEditor)</span>
<a href="#l17.3699"></a><span id="l17.3699" class="difflineminus">-{</span>
<a href="#l17.3700"></a><span id="l17.3700" class="difflineplus">+MOZ_CAN_RUN_SCRIPT nsresult QuotingOutputStreamListener::InsertToCompose(</span>
<a href="#l17.3701"></a><span id="l17.3701" class="difflineplus">+    nsIEditor *aEditor, bool aHTMLEditor) {</span>
<a href="#l17.3702"></a><span id="l17.3702">   // First, get the nsIEditor interface for future use</span>
<a href="#l17.3703"></a><span id="l17.3703">   nsCOMPtr&lt;nsINode&gt; nodeInserted;</span>
<a href="#l17.3704"></a><span id="l17.3704"> </span>
<a href="#l17.3705"></a><span id="l17.3705">   TranslateLineEnding(mMsgBody);</span>
<a href="#l17.3706"></a><span id="l17.3706"> </span>
<a href="#l17.3707"></a><span id="l17.3707">   // Now, insert it into the editor...</span>
<a href="#l17.3708"></a><span id="l17.3708" class="difflineminus">-  if (aEditor)</span>
<a href="#l17.3709"></a><span id="l17.3709" class="difflineminus">-    aEditor-&gt;EnableUndo(true);</span>
<a href="#l17.3710"></a><span id="l17.3710" class="difflineplus">+  if (aEditor) aEditor-&gt;EnableUndo(true);</span>
<a href="#l17.3711"></a><span id="l17.3711"> </span>
<a href="#l17.3712"></a><span id="l17.3712">   nsCOMPtr&lt;nsIMsgCompose&gt; compose = do_QueryReferent(mWeakComposeObj);</span>
<a href="#l17.3713"></a><span id="l17.3713" class="difflineminus">-  if (!mMsgBody.IsEmpty() &amp;&amp; compose)</span>
<a href="#l17.3714"></a><span id="l17.3714" class="difflineminus">-  {</span>
<a href="#l17.3715"></a><span id="l17.3715" class="difflineplus">+  if (!mMsgBody.IsEmpty() &amp;&amp; compose) {</span>
<a href="#l17.3716"></a><span id="l17.3716">     compose-&gt;SetInsertingQuotedContent(true);</span>
<a href="#l17.3717"></a><span id="l17.3717" class="difflineminus">-    if (!mCitePrefix.IsEmpty())</span>
<a href="#l17.3718"></a><span id="l17.3718" class="difflineminus">-    {</span>
<a href="#l17.3719"></a><span id="l17.3719" class="difflineminus">-      if (!aHTMLEditor)</span>
<a href="#l17.3720"></a><span id="l17.3720" class="difflineminus">-        mCitePrefix.AppendLiteral(&quot;\n&quot;);</span>
<a href="#l17.3721"></a><span id="l17.3721" class="difflineminus">-      nsCOMPtr&lt;nsIPlaintextEditor&gt; textEditor (do_QueryInterface(aEditor));</span>
<a href="#l17.3722"></a><span id="l17.3722" class="difflineminus">-      if (textEditor)</span>
<a href="#l17.3723"></a><span id="l17.3723" class="difflineminus">-        textEditor-&gt;InsertText(mCitePrefix);</span>
<a href="#l17.3724"></a><span id="l17.3724" class="difflineplus">+    if (!mCitePrefix.IsEmpty()) {</span>
<a href="#l17.3725"></a><span id="l17.3725" class="difflineplus">+      if (!aHTMLEditor) mCitePrefix.AppendLiteral(&quot;\n&quot;);</span>
<a href="#l17.3726"></a><span id="l17.3726" class="difflineplus">+      nsCOMPtr&lt;nsIPlaintextEditor&gt; textEditor(do_QueryInterface(aEditor));</span>
<a href="#l17.3727"></a><span id="l17.3727" class="difflineplus">+      if (textEditor) textEditor-&gt;InsertText(mCitePrefix);</span>
<a href="#l17.3728"></a><span id="l17.3728">     }</span>
<a href="#l17.3729"></a><span id="l17.3729"> </span>
<a href="#l17.3730"></a><span id="l17.3730">     RefPtr&lt;mozilla::HTMLEditor&gt; htmlEditor = aEditor-&gt;AsHTMLEditor();</span>
<a href="#l17.3731"></a><span id="l17.3731">     if (aHTMLEditor) {</span>
<a href="#l17.3732"></a><span id="l17.3732">       nsAutoString body(mMsgBody);</span>
<a href="#l17.3733"></a><span id="l17.3733">       remove_plaintext_tag(body);</span>
<a href="#l17.3734"></a><span id="l17.3734">       htmlEditor-&gt;InsertAsCitedQuotation(body, EmptyString(), true,</span>
<a href="#l17.3735"></a><span id="l17.3735">                                          getter_AddRefs(nodeInserted));</span>
<a href="#l17.3736"></a><span id="l17.3736">     } else {</span>
<a href="#l17.3737"></a><span id="l17.3737">       htmlEditor-&gt;InsertAsQuotation(mMsgBody, getter_AddRefs(nodeInserted));</span>
<a href="#l17.3738"></a><span id="l17.3738">     }</span>
<a href="#l17.3739"></a><span id="l17.3739">     compose-&gt;SetInsertingQuotedContent(false);</span>
<a href="#l17.3740"></a><span id="l17.3740">   }</span>
<a href="#l17.3741"></a><span id="l17.3741"> </span>
<a href="#l17.3742"></a><span id="l17.3742" class="difflineminus">-  if (aEditor)</span>
<a href="#l17.3743"></a><span id="l17.3743" class="difflineminus">-  {</span>
<a href="#l17.3744"></a><span id="l17.3744" class="difflineplus">+  if (aEditor) {</span>
<a href="#l17.3745"></a><span id="l17.3745">     nsCOMPtr&lt;nsIPlaintextEditor&gt; textEditor = do_QueryInterface(aEditor);</span>
<a href="#l17.3746"></a><span id="l17.3746" class="difflineminus">-    if (textEditor)</span>
<a href="#l17.3747"></a><span id="l17.3747" class="difflineminus">-    {</span>
<a href="#l17.3748"></a><span id="l17.3748" class="difflineplus">+    if (textEditor) {</span>
<a href="#l17.3749"></a><span id="l17.3749">       RefPtr&lt;Selection&gt; selection;</span>
<a href="#l17.3750"></a><span id="l17.3750">       nsCOMPtr&lt;nsINode&gt; parent;</span>
<a href="#l17.3751"></a><span id="l17.3751">       int32_t offset;</span>
<a href="#l17.3752"></a><span id="l17.3752">       nsresult rv;</span>
<a href="#l17.3753"></a><span id="l17.3753"> </span>
<a href="#l17.3754"></a><span id="l17.3754">       // get parent and offset of mailcite</span>
<a href="#l17.3755"></a><span id="l17.3755">       rv = GetNodeLocation(nodeInserted, address_of(parent), &amp;offset);</span>
<a href="#l17.3756"></a><span id="l17.3756">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.3757"></a><span id="l17.3757"> </span>
<a href="#l17.3758"></a><span id="l17.3758">       // get selection</span>
<a href="#l17.3759"></a><span id="l17.3759">       aEditor-&gt;GetSelection(getter_AddRefs(selection));</span>
<a href="#l17.3760"></a><span id="l17.3760" class="difflineminus">-      if (selection)</span>
<a href="#l17.3761"></a><span id="l17.3761" class="difflineminus">-      {</span>
<a href="#l17.3762"></a><span id="l17.3762" class="difflineplus">+      if (selection) {</span>
<a href="#l17.3763"></a><span id="l17.3763">         // place selection after mailcite</span>
<a href="#l17.3764"></a><span id="l17.3764" class="difflineminus">-        selection-&gt;Collapse(parent, offset+1);</span>
<a href="#l17.3765"></a><span id="l17.3765" class="difflineplus">+        selection-&gt;Collapse(parent, offset + 1);</span>
<a href="#l17.3766"></a><span id="l17.3766">         // insert a break at current selection</span>
<a href="#l17.3767"></a><span id="l17.3767">         textEditor-&gt;InsertLineBreak();</span>
<a href="#l17.3768"></a><span id="l17.3768" class="difflineminus">-        selection-&gt;Collapse(parent, offset+1);</span>
<a href="#l17.3769"></a><span id="l17.3769" class="difflineplus">+        selection-&gt;Collapse(parent, offset + 1);</span>
<a href="#l17.3770"></a><span id="l17.3770">       }</span>
<a href="#l17.3771"></a><span id="l17.3771">       nsCOMPtr&lt;nsISelectionController&gt; selCon;</span>
<a href="#l17.3772"></a><span id="l17.3772">       aEditor-&gt;GetSelectionController(getter_AddRefs(selCon));</span>
<a href="#l17.3773"></a><span id="l17.3773"> </span>
<a href="#l17.3774"></a><span id="l17.3774">       if (selCon)</span>
<a href="#l17.3775"></a><span id="l17.3775">         // After ScrollSelectionIntoView(), the pending notifications might be</span>
<a href="#l17.3776"></a><span id="l17.3776">         // flushed and PresShell/PresContext/Frames may be dead. See bug 418470.</span>
<a href="#l17.3777"></a><span id="l17.3777">         selCon-&gt;ScrollSelectionIntoView(</span>
<a href="#l17.3778"></a><span id="l17.3778" class="difflineminus">-                  nsISelectionController::SELECTION_NORMAL,</span>
<a href="#l17.3779"></a><span id="l17.3779" class="difflineminus">-                  nsISelectionController::SELECTION_ANCHOR_REGION,</span>
<a href="#l17.3780"></a><span id="l17.3780" class="difflineminus">-                  true);</span>
<a href="#l17.3781"></a><span id="l17.3781" class="difflineplus">+            nsISelectionController::SELECTION_NORMAL,</span>
<a href="#l17.3782"></a><span id="l17.3782" class="difflineplus">+            nsISelectionController::SELECTION_ANCHOR_REGION, true);</span>
<a href="#l17.3783"></a><span id="l17.3783">     }</span>
<a href="#l17.3784"></a><span id="l17.3784">   }</span>
<a href="#l17.3785"></a><span id="l17.3785"> </span>
<a href="#l17.3786"></a><span id="l17.3786">   return NS_OK;</span>
<a href="#l17.3787"></a><span id="l17.3787"> }</span>
<a href="#l17.3788"></a><span id="l17.3788"> </span>
<a href="#l17.3789"></a><span id="l17.3789"> /**</span>
<a href="#l17.3790"></a><span id="l17.3790">  * Returns true if the domain is a match for the given the domain list.</span>
<a href="#l17.3791"></a><span id="l17.3791">  * Subdomains are also considered to match.</span>
<a href="#l17.3792"></a><span id="l17.3792">  * @param aDomain - the domain name to check</span>
<a href="#l17.3793"></a><span id="l17.3793">  * @param aDomainList - a comma separated string of domain names</span>
<a href="#l17.3794"></a><span id="l17.3794">  */</span>
<a href="#l17.3795"></a><span id="l17.3795" class="difflineminus">-bool IsInDomainList(const nsAString &amp;aDomain, const nsAString &amp;aDomainList)</span>
<a href="#l17.3796"></a><span id="l17.3796" class="difflineminus">-{</span>
<a href="#l17.3797"></a><span id="l17.3797" class="difflineminus">-  if (aDomain.IsEmpty() || aDomainList.IsEmpty())</span>
<a href="#l17.3798"></a><span id="l17.3798" class="difflineminus">-    return false;</span>
<a href="#l17.3799"></a><span id="l17.3799" class="difflineplus">+bool IsInDomainList(const nsAString &amp;aDomain, const nsAString &amp;aDomainList) {</span>
<a href="#l17.3800"></a><span id="l17.3800" class="difflineplus">+  if (aDomain.IsEmpty() || aDomainList.IsEmpty()) return false;</span>
<a href="#l17.3801"></a><span id="l17.3801"> </span>
<a href="#l17.3802"></a><span id="l17.3802">   // Check plain text domains.</span>
<a href="#l17.3803"></a><span id="l17.3803">   int32_t left = 0;</span>
<a href="#l17.3804"></a><span id="l17.3804">   int32_t right = 0;</span>
<a href="#l17.3805"></a><span id="l17.3805" class="difflineminus">-  while (right != (int32_t)aDomainList.Length())</span>
<a href="#l17.3806"></a><span id="l17.3806" class="difflineminus">-  {</span>
<a href="#l17.3807"></a><span id="l17.3807" class="difflineplus">+  while (right != (int32_t)aDomainList.Length()) {</span>
<a href="#l17.3808"></a><span id="l17.3808">     right = aDomainList.FindChar(',', left);</span>
<a href="#l17.3809"></a><span id="l17.3809" class="difflineminus">-    if (right == kNotFound)</span>
<a href="#l17.3810"></a><span id="l17.3810" class="difflineminus">-      right = aDomainList.Length();</span>
<a href="#l17.3811"></a><span id="l17.3811" class="difflineplus">+    if (right == kNotFound) right = aDomainList.Length();</span>
<a href="#l17.3812"></a><span id="l17.3812">     nsDependentSubstring domain = Substring(aDomainList, left, right);</span>
<a href="#l17.3813"></a><span id="l17.3813"> </span>
<a href="#l17.3814"></a><span id="l17.3814">     if (aDomain.Equals(domain, nsCaseInsensitiveStringComparator()))</span>
<a href="#l17.3815"></a><span id="l17.3815">       return true;</span>
<a href="#l17.3816"></a><span id="l17.3816"> </span>
<a href="#l17.3817"></a><span id="l17.3817">     nsAutoString dotDomain;</span>
<a href="#l17.3818"></a><span id="l17.3818">     dotDomain.Assign(u'.');</span>
<a href="#l17.3819"></a><span id="l17.3819">     dotDomain.Append(domain);</span>
<a href="#l17.3820"></a><span id="l17.3820" class="difflineat">@@ -3192,397 +2905,361 @@ bool IsInDomainList(const nsAString &amp;aDo</span>
<a href="#l17.3821"></a><span id="l17.3821">       return true;</span>
<a href="#l17.3822"></a><span id="l17.3822"> </span>
<a href="#l17.3823"></a><span id="l17.3823">     left = right + 1;</span>
<a href="#l17.3824"></a><span id="l17.3824">   }</span>
<a href="#l17.3825"></a><span id="l17.3825">   return false;</span>
<a href="#l17.3826"></a><span id="l17.3826"> }</span>
<a href="#l17.3827"></a><span id="l17.3827"> </span>
<a href="#l17.3828"></a><span id="l17.3828"> NS_IMPL_ISUPPORTS(QuotingOutputStreamListener,</span>
<a href="#l17.3829"></a><span id="l17.3829" class="difflineminus">-                   nsIMsgQuotingOutputStreamListener,</span>
<a href="#l17.3830"></a><span id="l17.3830" class="difflineminus">-                   nsIRequestObserver,</span>
<a href="#l17.3831"></a><span id="l17.3831" class="difflineminus">-                   nsIStreamListener)</span>
<a href="#l17.3832"></a><span id="l17.3832" class="difflineplus">+                  nsIMsgQuotingOutputStreamListener, nsIRequestObserver,</span>
<a href="#l17.3833"></a><span id="l17.3833" class="difflineplus">+                  nsIStreamListener)</span>
<a href="#l17.3834"></a><span id="l17.3834"> </span>
<a href="#l17.3835"></a><span id="l17.3835"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l17.3836"></a><span id="l17.3836"> // END OF QUOTING LISTENER</span>
<a href="#l17.3837"></a><span id="l17.3837"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l17.3838"></a><span id="l17.3838"> </span>
<a href="#l17.3839"></a><span id="l17.3839"> /* attribute MSG_ComposeType type; */</span>
<a href="#l17.3840"></a><span id="l17.3840" class="difflineminus">-NS_IMETHODIMP nsMsgCompose::SetType(MSG_ComposeType aType)</span>
<a href="#l17.3841"></a><span id="l17.3841" class="difflineminus">-{</span>
<a href="#l17.3842"></a><span id="l17.3842" class="difflineminus">-</span>
<a href="#l17.3843"></a><span id="l17.3843" class="difflineplus">+NS_IMETHODIMP nsMsgCompose::SetType(MSG_ComposeType aType) {</span>
<a href="#l17.3844"></a><span id="l17.3844">   mType = aType;</span>
<a href="#l17.3845"></a><span id="l17.3845">   return NS_OK;</span>
<a href="#l17.3846"></a><span id="l17.3846"> }</span>
<a href="#l17.3847"></a><span id="l17.3847"> </span>
<a href="#l17.3848"></a><span id="l17.3848" class="difflineminus">-NS_IMETHODIMP nsMsgCompose::GetType(MSG_ComposeType *aType)</span>
<a href="#l17.3849"></a><span id="l17.3849" class="difflineminus">-{</span>
<a href="#l17.3850"></a><span id="l17.3850" class="difflineplus">+NS_IMETHODIMP nsMsgCompose::GetType(MSG_ComposeType *aType) {</span>
<a href="#l17.3851"></a><span id="l17.3851">   NS_ENSURE_ARG_POINTER(aType);</span>
<a href="#l17.3852"></a><span id="l17.3852"> </span>
<a href="#l17.3853"></a><span id="l17.3853">   *aType = mType;</span>
<a href="#l17.3854"></a><span id="l17.3854">   return NS_OK;</span>
<a href="#l17.3855"></a><span id="l17.3855"> }</span>
<a href="#l17.3856"></a><span id="l17.3856"> </span>
<a href="#l17.3857"></a><span id="l17.3857"> NS_IMETHODIMP</span>
<a href="#l17.3858"></a><span id="l17.3858" class="difflineminus">-nsMsgCompose::QuoteMessage(const char *msgURI)</span>
<a href="#l17.3859"></a><span id="l17.3859" class="difflineminus">-{</span>
<a href="#l17.3860"></a><span id="l17.3860" class="difflineplus">+nsMsgCompose::QuoteMessage(const char *msgURI) {</span>
<a href="#l17.3861"></a><span id="l17.3861">   NS_ENSURE_ARG_POINTER(msgURI);</span>
<a href="#l17.3862"></a><span id="l17.3862"> </span>
<a href="#l17.3863"></a><span id="l17.3863">   nsresult rv;</span>
<a href="#l17.3864"></a><span id="l17.3864">   mQuotingToFollow = false;</span>
<a href="#l17.3865"></a><span id="l17.3865"> </span>
<a href="#l17.3866"></a><span id="l17.3866">   // Create a mime parser (nsIStreamConverter)!</span>
<a href="#l17.3867"></a><span id="l17.3867">   mQuote = do_CreateInstance(NS_MSGQUOTE_CONTRACTID, &amp;rv);</span>
<a href="#l17.3868"></a><span id="l17.3868">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.3869"></a><span id="l17.3869"> </span>
<a href="#l17.3870"></a><span id="l17.3870" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l17.3871"></a><span id="l17.3871" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l17.3872"></a><span id="l17.3872">   rv = GetMsgDBHdrFromURI(msgURI, getter_AddRefs(msgHdr));</span>
<a href="#l17.3873"></a><span id="l17.3873"> </span>
<a href="#l17.3874"></a><span id="l17.3874" class="difflineminus">-  // Create the consumer output stream.. this will receive all the HTML from libmime</span>
<a href="#l17.3875"></a><span id="l17.3875" class="difflineminus">-  mQuoteStreamListener =</span>
<a href="#l17.3876"></a><span id="l17.3876" class="difflineminus">-    new QuotingOutputStreamListener(msgURI,</span>
<a href="#l17.3877"></a><span id="l17.3877" class="difflineminus">-                                    msgHdr,</span>
<a href="#l17.3878"></a><span id="l17.3878" class="difflineminus">-                                    false,</span>
<a href="#l17.3879"></a><span id="l17.3879" class="difflineminus">-                                    !mHtmlToQuote.IsEmpty(),</span>
<a href="#l17.3880"></a><span id="l17.3880" class="difflineminus">-                                    m_identity,</span>
<a href="#l17.3881"></a><span id="l17.3881" class="difflineminus">-                                    mQuote,</span>
<a href="#l17.3882"></a><span id="l17.3882" class="difflineminus">-                                    mCharsetOverride || mAnswerDefaultCharset,</span>
<a href="#l17.3883"></a><span id="l17.3883" class="difflineminus">-                                    false,</span>
<a href="#l17.3884"></a><span id="l17.3884" class="difflineminus">-                                    mHtmlToQuote);</span>
<a href="#l17.3885"></a><span id="l17.3885" class="difflineplus">+  // Create the consumer output stream.. this will receive all the HTML from</span>
<a href="#l17.3886"></a><span id="l17.3886" class="difflineplus">+  // libmime</span>
<a href="#l17.3887"></a><span id="l17.3887" class="difflineplus">+  mQuoteStreamListener = new QuotingOutputStreamListener(</span>
<a href="#l17.3888"></a><span id="l17.3888" class="difflineplus">+      msgURI, msgHdr, false, !mHtmlToQuote.IsEmpty(), m_identity, mQuote,</span>
<a href="#l17.3889"></a><span id="l17.3889" class="difflineplus">+      mCharsetOverride || mAnswerDefaultCharset, false, mHtmlToQuote);</span>
<a href="#l17.3890"></a><span id="l17.3890"> </span>
<a href="#l17.3891"></a><span id="l17.3891">   mQuoteStreamListener-&gt;SetComposeObj(this);</span>
<a href="#l17.3892"></a><span id="l17.3892"> </span>
<a href="#l17.3893"></a><span id="l17.3893" class="difflineminus">-  rv = mQuote-&gt;QuoteMessage(msgURI, false, mQuoteStreamListener,</span>
<a href="#l17.3894"></a><span id="l17.3894" class="difflineminus">-                            mCharsetOverride ? m_compFields-&gt;GetCharacterSet() : &quot;&quot;,</span>
<a href="#l17.3895"></a><span id="l17.3895" class="difflineminus">-                            false, msgHdr);</span>
<a href="#l17.3896"></a><span id="l17.3896" class="difflineplus">+  rv = mQuote-&gt;QuoteMessage(</span>
<a href="#l17.3897"></a><span id="l17.3897" class="difflineplus">+      msgURI, false, mQuoteStreamListener,</span>
<a href="#l17.3898"></a><span id="l17.3898" class="difflineplus">+      mCharsetOverride ? m_compFields-&gt;GetCharacterSet() : &quot;&quot;, false, msgHdr);</span>
<a href="#l17.3899"></a><span id="l17.3899">   return rv;</span>
<a href="#l17.3900"></a><span id="l17.3900"> }</span>
<a href="#l17.3901"></a><span id="l17.3901"> </span>
<a href="#l17.3902"></a><span id="l17.3902" class="difflineminus">-nsresult</span>
<a href="#l17.3903"></a><span id="l17.3903" class="difflineminus">-nsMsgCompose::QuoteOriginalMessage() // New template</span>
<a href="#l17.3904"></a><span id="l17.3904" class="difflineplus">+nsresult nsMsgCompose::QuoteOriginalMessage()  // New template</span>
<a href="#l17.3905"></a><span id="l17.3905"> {</span>
<a href="#l17.3906"></a><span id="l17.3906" class="difflineminus">-  nsresult    rv;</span>
<a href="#l17.3907"></a><span id="l17.3907" class="difflineplus">+  nsresult rv;</span>
<a href="#l17.3908"></a><span id="l17.3908"> </span>
<a href="#l17.3909"></a><span id="l17.3909">   mQuotingToFollow = false;</span>
<a href="#l17.3910"></a><span id="l17.3910"> </span>
<a href="#l17.3911"></a><span id="l17.3911">   // Create a mime parser (nsIStreamConverter)!</span>
<a href="#l17.3912"></a><span id="l17.3912">   mQuote = do_CreateInstance(NS_MSGQUOTE_CONTRACTID, &amp;rv);</span>
<a href="#l17.3913"></a><span id="l17.3913" class="difflineminus">-  if (NS_FAILED(rv) || !mQuote)</span>
<a href="#l17.3914"></a><span id="l17.3914" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l17.3915"></a><span id="l17.3915" class="difflineplus">+  if (NS_FAILED(rv) || !mQuote) return NS_ERROR_FAILURE;</span>
<a href="#l17.3916"></a><span id="l17.3916"> </span>
<a href="#l17.3917"></a><span id="l17.3917">   bool bAutoQuote = true;</span>
<a href="#l17.3918"></a><span id="l17.3918">   m_identity-&gt;GetAutoQuote(&amp;bAutoQuote);</span>
<a href="#l17.3919"></a><span id="l17.3919"> </span>
<a href="#l17.3920"></a><span id="l17.3920" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; originalMsgHdr = mOrigMsgHdr;</span>
<a href="#l17.3921"></a><span id="l17.3921" class="difflineminus">-  if (!originalMsgHdr)</span>
<a href="#l17.3922"></a><span id="l17.3922" class="difflineminus">-  {</span>
<a href="#l17.3923"></a><span id="l17.3923" class="difflineminus">-    rv = GetMsgDBHdrFromURI(mOriginalMsgURI.get(), getter_AddRefs(originalMsgHdr));</span>
<a href="#l17.3924"></a><span id="l17.3924" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; originalMsgHdr = mOrigMsgHdr;</span>
<a href="#l17.3925"></a><span id="l17.3925" class="difflineplus">+  if (!originalMsgHdr) {</span>
<a href="#l17.3926"></a><span id="l17.3926" class="difflineplus">+    rv = GetMsgDBHdrFromURI(mOriginalMsgURI.get(),</span>
<a href="#l17.3927"></a><span id="l17.3927" class="difflineplus">+                            getter_AddRefs(originalMsgHdr));</span>
<a href="#l17.3928"></a><span id="l17.3928">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.3929"></a><span id="l17.3929">   }</span>
<a href="#l17.3930"></a><span id="l17.3930"> </span>
<a href="#l17.3931"></a><span id="l17.3931">   bool fileUrl = StringBeginsWith(mOriginalMsgURI, NS_LITERAL_CSTRING(&quot;file:&quot;));</span>
<a href="#l17.3932"></a><span id="l17.3932" class="difflineminus">-  if (fileUrl)</span>
<a href="#l17.3933"></a><span id="l17.3933" class="difflineminus">-  {</span>
<a href="#l17.3934"></a><span id="l17.3934" class="difflineplus">+  if (fileUrl) {</span>
<a href="#l17.3935"></a><span id="l17.3935">     mOriginalMsgURI.Replace(0, 5, NS_LITERAL_CSTRING(&quot;mailbox:&quot;));</span>
<a href="#l17.3936"></a><span id="l17.3936">     mOriginalMsgURI.AppendLiteral(&quot;?number=0&quot;);</span>
<a href="#l17.3937"></a><span id="l17.3937">   }</span>
<a href="#l17.3938"></a><span id="l17.3938"> </span>
<a href="#l17.3939"></a><span id="l17.3939" class="difflineminus">-  // Create the consumer output stream.. this will receive all the HTML from libmime</span>
<a href="#l17.3940"></a><span id="l17.3940" class="difflineminus">-  mQuoteStreamListener =</span>
<a href="#l17.3941"></a><span id="l17.3941" class="difflineminus">-    new QuotingOutputStreamListener(mOriginalMsgURI.get(),</span>
<a href="#l17.3942"></a><span id="l17.3942" class="difflineminus">-                                    originalMsgHdr,</span>
<a href="#l17.3943"></a><span id="l17.3943" class="difflineminus">-                                    mWhatHolder != 1,</span>
<a href="#l17.3944"></a><span id="l17.3944" class="difflineminus">-                                    !bAutoQuote || !mHtmlToQuote.IsEmpty(),</span>
<a href="#l17.3945"></a><span id="l17.3945" class="difflineminus">-                                    m_identity,</span>
<a href="#l17.3946"></a><span id="l17.3946" class="difflineminus">-                                    mQuote,</span>
<a href="#l17.3947"></a><span id="l17.3947" class="difflineminus">-                                    mCharsetOverride || mAnswerDefaultCharset,</span>
<a href="#l17.3948"></a><span id="l17.3948" class="difflineminus">-                                    true,</span>
<a href="#l17.3949"></a><span id="l17.3949" class="difflineminus">-                                    mHtmlToQuote);</span>
<a href="#l17.3950"></a><span id="l17.3950" class="difflineplus">+  // Create the consumer output stream.. this will receive all the HTML from</span>
<a href="#l17.3951"></a><span id="l17.3951" class="difflineplus">+  // libmime</span>
<a href="#l17.3952"></a><span id="l17.3952" class="difflineplus">+  mQuoteStreamListener = new QuotingOutputStreamListener(</span>
<a href="#l17.3953"></a><span id="l17.3953" class="difflineplus">+      mOriginalMsgURI.get(), originalMsgHdr, mWhatHolder != 1,</span>
<a href="#l17.3954"></a><span id="l17.3954" class="difflineplus">+      !bAutoQuote || !mHtmlToQuote.IsEmpty(), m_identity, mQuote,</span>
<a href="#l17.3955"></a><span id="l17.3955" class="difflineplus">+      mCharsetOverride || mAnswerDefaultCharset, true, mHtmlToQuote);</span>
<a href="#l17.3956"></a><span id="l17.3956"> </span>
<a href="#l17.3957"></a><span id="l17.3957">   mQuoteStreamListener-&gt;SetComposeObj(this);</span>
<a href="#l17.3958"></a><span id="l17.3958"> </span>
<a href="#l17.3959"></a><span id="l17.3959" class="difflineminus">-  rv = mQuote-&gt;QuoteMessage(mOriginalMsgURI.get(), mWhatHolder != 1, mQuoteStreamListener,</span>
<a href="#l17.3960"></a><span id="l17.3960" class="difflineminus">-                            mCharsetOverride ? mQuoteCharset.get() : &quot;&quot;,</span>
<a href="#l17.3961"></a><span id="l17.3961" class="difflineminus">-                            !bAutoQuote, originalMsgHdr);</span>
<a href="#l17.3962"></a><span id="l17.3962" class="difflineplus">+  rv = mQuote-&gt;QuoteMessage(</span>
<a href="#l17.3963"></a><span id="l17.3963" class="difflineplus">+      mOriginalMsgURI.get(), mWhatHolder != 1, mQuoteStreamListener,</span>
<a href="#l17.3964"></a><span id="l17.3964" class="difflineplus">+      mCharsetOverride ? mQuoteCharset.get() : &quot;&quot;, !bAutoQuote, originalMsgHdr);</span>
<a href="#l17.3965"></a><span id="l17.3965">   return rv;</span>
<a href="#l17.3966"></a><span id="l17.3966"> }</span>
<a href="#l17.3967"></a><span id="l17.3967"> </span>
<a href="#l17.3968"></a><span id="l17.3968" class="difflineminus">-//CleanUpRecipient will remove un-necessary &quot;&lt;&gt;&quot; when a recipient as an address without name</span>
<a href="#l17.3969"></a><span id="l17.3969" class="difflineminus">-void nsMsgCompose::CleanUpRecipients(nsString&amp; recipients)</span>
<a href="#l17.3970"></a><span id="l17.3970" class="difflineminus">-{</span>
<a href="#l17.3971"></a><span id="l17.3971" class="difflineplus">+// CleanUpRecipient will remove un-necessary &quot;&lt;&gt;&quot; when a recipient as an address</span>
<a href="#l17.3972"></a><span id="l17.3972" class="difflineplus">+// without name</span>
<a href="#l17.3973"></a><span id="l17.3973" class="difflineplus">+void nsMsgCompose::CleanUpRecipients(nsString &amp;recipients) {</span>
<a href="#l17.3974"></a><span id="l17.3974">   uint16_t i;</span>
<a href="#l17.3975"></a><span id="l17.3975">   bool startANewRecipient = true;</span>
<a href="#l17.3976"></a><span id="l17.3976">   bool removeBracket = false;</span>
<a href="#l17.3977"></a><span id="l17.3977">   nsAutoString newRecipient;</span>
<a href="#l17.3978"></a><span id="l17.3978">   char16_t aChar;</span>
<a href="#l17.3979"></a><span id="l17.3979"> </span>
<a href="#l17.3980"></a><span id="l17.3980" class="difflineminus">-  for (i = 0; i &lt; recipients.Length(); i ++)</span>
<a href="#l17.3981"></a><span id="l17.3981" class="difflineminus">-  {</span>
<a href="#l17.3982"></a><span id="l17.3982" class="difflineplus">+  for (i = 0; i &lt; recipients.Length(); i++) {</span>
<a href="#l17.3983"></a><span id="l17.3983">     aChar = recipients[i];</span>
<a href="#l17.3984"></a><span id="l17.3984" class="difflineminus">-    switch (aChar)</span>
<a href="#l17.3985"></a><span id="l17.3985" class="difflineminus">-    {</span>
<a href="#l17.3986"></a><span id="l17.3986" class="difflineminus">-      case '&lt;'  :</span>
<a href="#l17.3987"></a><span id="l17.3987" class="difflineplus">+    switch (aChar) {</span>
<a href="#l17.3988"></a><span id="l17.3988" class="difflineplus">+      case '&lt;':</span>
<a href="#l17.3989"></a><span id="l17.3989">         if (startANewRecipient)</span>
<a href="#l17.3990"></a><span id="l17.3990">           removeBracket = true;</span>
<a href="#l17.3991"></a><span id="l17.3991">         else</span>
<a href="#l17.3992"></a><span id="l17.3992">           newRecipient += aChar;</span>
<a href="#l17.3993"></a><span id="l17.3993">         startANewRecipient = false;</span>
<a href="#l17.3994"></a><span id="l17.3994">         break;</span>
<a href="#l17.3995"></a><span id="l17.3995"> </span>
<a href="#l17.3996"></a><span id="l17.3996" class="difflineminus">-      case '&gt;'  :</span>
<a href="#l17.3997"></a><span id="l17.3997" class="difflineplus">+      case '&gt;':</span>
<a href="#l17.3998"></a><span id="l17.3998">         if (removeBracket)</span>
<a href="#l17.3999"></a><span id="l17.3999">           removeBracket = false;</span>
<a href="#l17.4000"></a><span id="l17.4000">         else</span>
<a href="#l17.4001"></a><span id="l17.4001">           newRecipient += aChar;</span>
<a href="#l17.4002"></a><span id="l17.4002">         break;</span>
<a href="#l17.4003"></a><span id="l17.4003"> </span>
<a href="#l17.4004"></a><span id="l17.4004" class="difflineminus">-      case ' '  :</span>
<a href="#l17.4005"></a><span id="l17.4005" class="difflineplus">+      case ' ':</span>
<a href="#l17.4006"></a><span id="l17.4006">         newRecipient += aChar;</span>
<a href="#l17.4007"></a><span id="l17.4007">         break;</span>
<a href="#l17.4008"></a><span id="l17.4008"> </span>
<a href="#l17.4009"></a><span id="l17.4009" class="difflineminus">-      case ','  :</span>
<a href="#l17.4010"></a><span id="l17.4010" class="difflineplus">+      case ',':</span>
<a href="#l17.4011"></a><span id="l17.4011">         newRecipient += aChar;</span>
<a href="#l17.4012"></a><span id="l17.4012">         startANewRecipient = true;</span>
<a href="#l17.4013"></a><span id="l17.4013">         removeBracket = false;</span>
<a href="#l17.4014"></a><span id="l17.4014">         break;</span>
<a href="#l17.4015"></a><span id="l17.4015"> </span>
<a href="#l17.4016"></a><span id="l17.4016" class="difflineminus">-      default   :</span>
<a href="#l17.4017"></a><span id="l17.4017" class="difflineplus">+      default:</span>
<a href="#l17.4018"></a><span id="l17.4018">         newRecipient += aChar;</span>
<a href="#l17.4019"></a><span id="l17.4019">         startANewRecipient = false;</span>
<a href="#l17.4020"></a><span id="l17.4020">         break;</span>
<a href="#l17.4021"></a><span id="l17.4021">     }</span>
<a href="#l17.4022"></a><span id="l17.4022">   }</span>
<a href="#l17.4023"></a><span id="l17.4023">   recipients = newRecipient;</span>
<a href="#l17.4024"></a><span id="l17.4024"> }</span>
<a href="#l17.4025"></a><span id="l17.4025"> </span>
<a href="#l17.4026"></a><span id="l17.4026" class="difflineminus">-NS_IMETHODIMP nsMsgCompose::RememberQueuedDisposition()</span>
<a href="#l17.4027"></a><span id="l17.4027" class="difflineminus">-{</span>
<a href="#l17.4028"></a><span id="l17.4028" class="difflineplus">+NS_IMETHODIMP nsMsgCompose::RememberQueuedDisposition() {</span>
<a href="#l17.4029"></a><span id="l17.4029">   // need to find the msg hdr in the saved folder and then set a property on</span>
<a href="#l17.4030"></a><span id="l17.4030">   // the header that we then look at when we actually send the message.</span>
<a href="#l17.4031"></a><span id="l17.4031">   nsresult rv;</span>
<a href="#l17.4032"></a><span id="l17.4032">   nsAutoCString dispositionSetting;</span>
<a href="#l17.4033"></a><span id="l17.4033"> </span>
<a href="#l17.4034"></a><span id="l17.4034" class="difflineminus">-  if (mType == nsIMsgCompType::Reply ||</span>
<a href="#l17.4035"></a><span id="l17.4035" class="difflineminus">-      mType == nsIMsgCompType::ReplyAll ||</span>
<a href="#l17.4036"></a><span id="l17.4036" class="difflineplus">+  if (mType == nsIMsgCompType::Reply || mType == nsIMsgCompType::ReplyAll ||</span>
<a href="#l17.4037"></a><span id="l17.4037">       mType == nsIMsgCompType::ReplyToList ||</span>
<a href="#l17.4038"></a><span id="l17.4038">       mType == nsIMsgCompType::ReplyToGroup ||</span>
<a href="#l17.4039"></a><span id="l17.4039">       mType == nsIMsgCompType::ReplyToSender ||</span>
<a href="#l17.4040"></a><span id="l17.4040" class="difflineminus">-      mType == nsIMsgCompType::ReplyToSenderAndGroup)</span>
<a href="#l17.4041"></a><span id="l17.4041" class="difflineminus">-  {</span>
<a href="#l17.4042"></a><span id="l17.4042" class="difflineplus">+      mType == nsIMsgCompType::ReplyToSenderAndGroup) {</span>
<a href="#l17.4043"></a><span id="l17.4043">     dispositionSetting.AssignLiteral(&quot;replied&quot;);</span>
<a href="#l17.4044"></a><span id="l17.4044" class="difflineminus">-  }</span>
<a href="#l17.4045"></a><span id="l17.4045" class="difflineminus">-  else if (mType == nsIMsgCompType::ForwardAsAttachment ||</span>
<a href="#l17.4046"></a><span id="l17.4046" class="difflineminus">-           mType == nsIMsgCompType::ForwardInline)</span>
<a href="#l17.4047"></a><span id="l17.4047" class="difflineminus">-  {</span>
<a href="#l17.4048"></a><span id="l17.4048" class="difflineplus">+  } else if (mType == nsIMsgCompType::ForwardAsAttachment ||</span>
<a href="#l17.4049"></a><span id="l17.4049" class="difflineplus">+             mType == nsIMsgCompType::ForwardInline) {</span>
<a href="#l17.4050"></a><span id="l17.4050">     dispositionSetting.AssignLiteral(&quot;forwarded&quot;);</span>
<a href="#l17.4051"></a><span id="l17.4051" class="difflineminus">-  }</span>
<a href="#l17.4052"></a><span id="l17.4052" class="difflineminus">-  else if (mType == nsIMsgCompType::Draft)</span>
<a href="#l17.4053"></a><span id="l17.4053" class="difflineminus">-  {</span>
<a href="#l17.4054"></a><span id="l17.4054" class="difflineplus">+  } else if (mType == nsIMsgCompType::Draft) {</span>
<a href="#l17.4055"></a><span id="l17.4055">     nsAutoCString curDraftIdURL;</span>
<a href="#l17.4056"></a><span id="l17.4056">     rv = m_compFields-&gt;GetDraftId(getter_Copies(curDraftIdURL));</span>
<a href="#l17.4057"></a><span id="l17.4057">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.4058"></a><span id="l17.4058">     if (!curDraftIdURL.IsEmpty()) {</span>
<a href="#l17.4059"></a><span id="l17.4059" class="difflineminus">-      nsCOMPtr &lt;nsIMsgDBHdr&gt; draftHdr;</span>
<a href="#l17.4060"></a><span id="l17.4060" class="difflineplus">+      nsCOMPtr&lt;nsIMsgDBHdr&gt; draftHdr;</span>
<a href="#l17.4061"></a><span id="l17.4061">       rv = GetMsgDBHdrFromURI(curDraftIdURL.get(), getter_AddRefs(draftHdr));</span>
<a href="#l17.4062"></a><span id="l17.4062">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.4063"></a><span id="l17.4063" class="difflineminus">-      draftHdr-&gt;GetStringProperty(QUEUED_DISPOSITION_PROPERTY, getter_Copies(dispositionSetting));</span>
<a href="#l17.4064"></a><span id="l17.4064" class="difflineplus">+      draftHdr-&gt;GetStringProperty(QUEUED_DISPOSITION_PROPERTY,</span>
<a href="#l17.4065"></a><span id="l17.4065" class="difflineplus">+                                  getter_Copies(dispositionSetting));</span>
<a href="#l17.4066"></a><span id="l17.4066">     }</span>
<a href="#l17.4067"></a><span id="l17.4067">   }</span>
<a href="#l17.4068"></a><span id="l17.4068"> </span>
<a href="#l17.4069"></a><span id="l17.4069">   nsMsgKey msgKey;</span>
<a href="#l17.4070"></a><span id="l17.4070" class="difflineminus">-  if (mMsgSend)</span>
<a href="#l17.4071"></a><span id="l17.4071" class="difflineminus">-  {</span>
<a href="#l17.4072"></a><span id="l17.4072" class="difflineplus">+  if (mMsgSend) {</span>
<a href="#l17.4073"></a><span id="l17.4073">     mMsgSend-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l17.4074"></a><span id="l17.4074">     nsCString identityKey;</span>
<a href="#l17.4075"></a><span id="l17.4075"> </span>
<a href="#l17.4076"></a><span id="l17.4076">     m_identity-&gt;GetKey(identityKey);</span>
<a href="#l17.4077"></a><span id="l17.4077"> </span>
<a href="#l17.4078"></a><span id="l17.4078">     nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l17.4079"></a><span id="l17.4079">     rv = GetOrCreateFolder(m_folderName, getter_AddRefs(folder));</span>
<a href="#l17.4080"></a><span id="l17.4080">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.4081"></a><span id="l17.4081"> </span>
<a href="#l17.4082"></a><span id="l17.4082" class="difflineminus">-    nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l17.4083"></a><span id="l17.4083" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l17.4084"></a><span id="l17.4084">     rv = folder-&gt;GetMessageHeader(msgKey, getter_AddRefs(msgHdr));</span>
<a href="#l17.4085"></a><span id="l17.4085">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.4086"></a><span id="l17.4086"> </span>
<a href="#l17.4087"></a><span id="l17.4087">     uint32_t pseudoHdrProp = 0;</span>
<a href="#l17.4088"></a><span id="l17.4088">     msgHdr-&gt;GetUint32Property(&quot;pseudoHdr&quot;, &amp;pseudoHdrProp);</span>
<a href="#l17.4089"></a><span id="l17.4089" class="difflineminus">-    if (pseudoHdrProp)</span>
<a href="#l17.4090"></a><span id="l17.4090" class="difflineminus">-    {</span>
<a href="#l17.4091"></a><span id="l17.4091" class="difflineplus">+    if (pseudoHdrProp) {</span>
<a href="#l17.4092"></a><span id="l17.4092">       // Use SetAttributeOnPendingHdr for IMAP pseudo headers, as those</span>
<a href="#l17.4093"></a><span id="l17.4093">       // will get deleted (and properties set using SetStringProperty lost.)</span>
<a href="#l17.4094"></a><span id="l17.4094">       nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l17.4095"></a><span id="l17.4095">       rv = msgHdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l17.4096"></a><span id="l17.4096" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.4097"></a><span id="l17.4097" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.4098"></a><span id="l17.4098">       nsCOMPtr&lt;nsIMsgDatabase&gt; msgDB;</span>
<a href="#l17.4099"></a><span id="l17.4099">       rv = folder-&gt;GetMsgDatabase(getter_AddRefs(msgDB));</span>
<a href="#l17.4100"></a><span id="l17.4100" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.4101"></a><span id="l17.4101" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.4102"></a><span id="l17.4102"> </span>
<a href="#l17.4103"></a><span id="l17.4103">       nsCString messageId;</span>
<a href="#l17.4104"></a><span id="l17.4104">       mMsgSend-&gt;GetMessageId(messageId);</span>
<a href="#l17.4105"></a><span id="l17.4105">       msgHdr-&gt;SetMessageId(messageId.get());</span>
<a href="#l17.4106"></a><span id="l17.4106" class="difflineminus">-      if (!mOriginalMsgURI.IsEmpty())</span>
<a href="#l17.4107"></a><span id="l17.4107" class="difflineminus">-      {</span>
<a href="#l17.4108"></a><span id="l17.4108" class="difflineminus">-        msgDB-&gt;SetAttributeOnPendingHdr(msgHdr, ORIG_URI_PROPERTY, mOriginalMsgURI.get());</span>
<a href="#l17.4109"></a><span id="l17.4109" class="difflineplus">+      if (!mOriginalMsgURI.IsEmpty()) {</span>
<a href="#l17.4110"></a><span id="l17.4110" class="difflineplus">+        msgDB-&gt;SetAttributeOnPendingHdr(msgHdr, ORIG_URI_PROPERTY,</span>
<a href="#l17.4111"></a><span id="l17.4111" class="difflineplus">+                                        mOriginalMsgURI.get());</span>
<a href="#l17.4112"></a><span id="l17.4112">         if (!dispositionSetting.IsEmpty())</span>
<a href="#l17.4113"></a><span id="l17.4113">           msgDB-&gt;SetAttributeOnPendingHdr(msgHdr, QUEUED_DISPOSITION_PROPERTY,</span>
<a href="#l17.4114"></a><span id="l17.4114">                                           dispositionSetting.get());</span>
<a href="#l17.4115"></a><span id="l17.4115">       }</span>
<a href="#l17.4116"></a><span id="l17.4116" class="difflineminus">-      msgDB-&gt;SetAttributeOnPendingHdr(msgHdr, HEADER_X_MOZILLA_IDENTITY_KEY, identityKey.get());</span>
<a href="#l17.4117"></a><span id="l17.4117" class="difflineminus">-    }</span>
<a href="#l17.4118"></a><span id="l17.4118" class="difflineminus">-    else if (msgHdr)</span>
<a href="#l17.4119"></a><span id="l17.4119" class="difflineminus">-    {</span>
<a href="#l17.4120"></a><span id="l17.4120" class="difflineminus">-      if (!mOriginalMsgURI.IsEmpty())</span>
<a href="#l17.4121"></a><span id="l17.4121" class="difflineminus">-      {</span>
<a href="#l17.4122"></a><span id="l17.4122" class="difflineplus">+      msgDB-&gt;SetAttributeOnPendingHdr(msgHdr, HEADER_X_MOZILLA_IDENTITY_KEY,</span>
<a href="#l17.4123"></a><span id="l17.4123" class="difflineplus">+                                      identityKey.get());</span>
<a href="#l17.4124"></a><span id="l17.4124" class="difflineplus">+    } else if (msgHdr) {</span>
<a href="#l17.4125"></a><span id="l17.4125" class="difflineplus">+      if (!mOriginalMsgURI.IsEmpty()) {</span>
<a href="#l17.4126"></a><span id="l17.4126">         msgHdr-&gt;SetStringProperty(ORIG_URI_PROPERTY, mOriginalMsgURI.get());</span>
<a href="#l17.4127"></a><span id="l17.4127">         if (!dispositionSetting.IsEmpty())</span>
<a href="#l17.4128"></a><span id="l17.4128" class="difflineminus">-          msgHdr-&gt;SetStringProperty(QUEUED_DISPOSITION_PROPERTY, dispositionSetting.get());</span>
<a href="#l17.4129"></a><span id="l17.4129" class="difflineplus">+          msgHdr-&gt;SetStringProperty(QUEUED_DISPOSITION_PROPERTY,</span>
<a href="#l17.4130"></a><span id="l17.4130" class="difflineplus">+                                    dispositionSetting.get());</span>
<a href="#l17.4131"></a><span id="l17.4131">       }</span>
<a href="#l17.4132"></a><span id="l17.4132" class="difflineminus">-      msgHdr-&gt;SetStringProperty(HEADER_X_MOZILLA_IDENTITY_KEY, identityKey.get());</span>
<a href="#l17.4133"></a><span id="l17.4133" class="difflineplus">+      msgHdr-&gt;SetStringProperty(HEADER_X_MOZILLA_IDENTITY_KEY,</span>
<a href="#l17.4134"></a><span id="l17.4134" class="difflineplus">+                                identityKey.get());</span>
<a href="#l17.4135"></a><span id="l17.4135">     }</span>
<a href="#l17.4136"></a><span id="l17.4136">   }</span>
<a href="#l17.4137"></a><span id="l17.4137">   return NS_OK;</span>
<a href="#l17.4138"></a><span id="l17.4138"> }</span>
<a href="#l17.4139"></a><span id="l17.4139"> </span>
<a href="#l17.4140"></a><span id="l17.4140" class="difflineminus">-nsresult nsMsgCompose::ProcessReplyFlags()</span>
<a href="#l17.4141"></a><span id="l17.4141" class="difflineminus">-{</span>
<a href="#l17.4142"></a><span id="l17.4142" class="difflineplus">+nsresult nsMsgCompose::ProcessReplyFlags() {</span>
<a href="#l17.4143"></a><span id="l17.4143">   nsresult rv;</span>
<a href="#l17.4144"></a><span id="l17.4144" class="difflineminus">-  // check to see if we were doing a reply or a forward, if we were, set the answered field flag on the message folder</span>
<a href="#l17.4145"></a><span id="l17.4145" class="difflineminus">-  // for this URI.</span>
<a href="#l17.4146"></a><span id="l17.4146" class="difflineminus">-  if (mType == nsIMsgCompType::Reply ||</span>
<a href="#l17.4147"></a><span id="l17.4147" class="difflineminus">-      mType == nsIMsgCompType::ReplyAll ||</span>
<a href="#l17.4148"></a><span id="l17.4148" class="difflineplus">+  // check to see if we were doing a reply or a forward, if we were, set the</span>
<a href="#l17.4149"></a><span id="l17.4149" class="difflineplus">+  // answered field flag on the message folder for this URI.</span>
<a href="#l17.4150"></a><span id="l17.4150" class="difflineplus">+  if (mType == nsIMsgCompType::Reply || mType == nsIMsgCompType::ReplyAll ||</span>
<a href="#l17.4151"></a><span id="l17.4151">       mType == nsIMsgCompType::ReplyToList ||</span>
<a href="#l17.4152"></a><span id="l17.4152">       mType == nsIMsgCompType::ReplyToGroup ||</span>
<a href="#l17.4153"></a><span id="l17.4153">       mType == nsIMsgCompType::ReplyToSender ||</span>
<a href="#l17.4154"></a><span id="l17.4154">       mType == nsIMsgCompType::ReplyToSenderAndGroup ||</span>
<a href="#l17.4155"></a><span id="l17.4155">       mType == nsIMsgCompType::ForwardAsAttachment ||</span>
<a href="#l17.4156"></a><span id="l17.4156">       mType == nsIMsgCompType::ForwardInline ||</span>
<a href="#l17.4157"></a><span id="l17.4157" class="difflineminus">-      mDraftDisposition != nsIMsgFolder::nsMsgDispositionState_None)</span>
<a href="#l17.4158"></a><span id="l17.4158" class="difflineminus">-  {</span>
<a href="#l17.4159"></a><span id="l17.4159" class="difflineminus">-    if (!mOriginalMsgURI.IsEmpty())</span>
<a href="#l17.4160"></a><span id="l17.4160" class="difflineminus">-    {</span>
<a href="#l17.4161"></a><span id="l17.4161" class="difflineminus">-      nsCString msgUri (mOriginalMsgURI);</span>
<a href="#l17.4162"></a><span id="l17.4162" class="difflineplus">+      mDraftDisposition != nsIMsgFolder::nsMsgDispositionState_None) {</span>
<a href="#l17.4163"></a><span id="l17.4163" class="difflineplus">+    if (!mOriginalMsgURI.IsEmpty()) {</span>
<a href="#l17.4164"></a><span id="l17.4164" class="difflineplus">+      nsCString msgUri(mOriginalMsgURI);</span>
<a href="#l17.4165"></a><span id="l17.4165">       char *newStr = msgUri.BeginWriting();</span>
<a href="#l17.4166"></a><span id="l17.4166">       char *uri;</span>
<a href="#l17.4167"></a><span id="l17.4167" class="difflineminus">-      while (nullptr != (uri = NS_strtok(&quot;,&quot;, &amp;newStr)))</span>
<a href="#l17.4168"></a><span id="l17.4168" class="difflineminus">-      {</span>
<a href="#l17.4169"></a><span id="l17.4169" class="difflineminus">-        nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l17.4170"></a><span id="l17.4170" class="difflineplus">+      while (nullptr != (uri = NS_strtok(&quot;,&quot;, &amp;newStr))) {</span>
<a href="#l17.4171"></a><span id="l17.4171" class="difflineplus">+        nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l17.4172"></a><span id="l17.4172">         rv = GetMsgDBHdrFromURI(uri, getter_AddRefs(msgHdr));</span>
<a href="#l17.4173"></a><span id="l17.4173" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l17.4174"></a><span id="l17.4174" class="difflineminus">-        if (msgHdr)</span>
<a href="#l17.4175"></a><span id="l17.4175" class="difflineminus">-        {</span>
<a href="#l17.4176"></a><span id="l17.4176" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.4177"></a><span id="l17.4177" class="difflineplus">+        if (msgHdr) {</span>
<a href="#l17.4178"></a><span id="l17.4178">           // get the folder for the message resource</span>
<a href="#l17.4179"></a><span id="l17.4179">           nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l17.4180"></a><span id="l17.4180">           msgHdr-&gt;GetFolder(getter_AddRefs(msgFolder));</span>
<a href="#l17.4181"></a><span id="l17.4181" class="difflineminus">-          if (msgFolder)</span>
<a href="#l17.4182"></a><span id="l17.4182" class="difflineminus">-          {</span>
<a href="#l17.4183"></a><span id="l17.4183" class="difflineplus">+          if (msgFolder) {</span>
<a href="#l17.4184"></a><span id="l17.4184">             // If it's a draft with disposition, default to replied, otherwise,</span>
<a href="#l17.4185"></a><span id="l17.4185">             // check if it's a forward.</span>
<a href="#l17.4186"></a><span id="l17.4186" class="difflineminus">-            nsMsgDispositionState dispositionSetting = nsIMsgFolder::nsMsgDispositionState_Replied;</span>
<a href="#l17.4187"></a><span id="l17.4187" class="difflineplus">+            nsMsgDispositionState dispositionSetting =</span>
<a href="#l17.4188"></a><span id="l17.4188" class="difflineplus">+                nsIMsgFolder::nsMsgDispositionState_Replied;</span>
<a href="#l17.4189"></a><span id="l17.4189">             if (mDraftDisposition != nsIMsgFolder::nsMsgDispositionState_None)</span>
<a href="#l17.4190"></a><span id="l17.4190">               dispositionSetting = mDraftDisposition;</span>
<a href="#l17.4191"></a><span id="l17.4191">             else if (mType == nsIMsgCompType::ForwardAsAttachment ||</span>
<a href="#l17.4192"></a><span id="l17.4192" class="difflineminus">-                mType == nsIMsgCompType::ForwardInline)</span>
<a href="#l17.4193"></a><span id="l17.4193" class="difflineminus">-              dispositionSetting = nsIMsgFolder::nsMsgDispositionState_Forwarded;</span>
<a href="#l17.4194"></a><span id="l17.4194" class="difflineplus">+                     mType == nsIMsgCompType::ForwardInline)</span>
<a href="#l17.4195"></a><span id="l17.4195" class="difflineplus">+              dispositionSetting =</span>
<a href="#l17.4196"></a><span id="l17.4196" class="difflineplus">+                  nsIMsgFolder::nsMsgDispositionState_Forwarded;</span>
<a href="#l17.4197"></a><span id="l17.4197"> </span>
<a href="#l17.4198"></a><span id="l17.4198">             msgFolder-&gt;AddMessageDispositionState(msgHdr, dispositionSetting);</span>
<a href="#l17.4199"></a><span id="l17.4199">             if (mType != nsIMsgCompType::ForwardAsAttachment)</span>
<a href="#l17.4200"></a><span id="l17.4200" class="difflineminus">-              break;         // just safeguard</span>
<a href="#l17.4201"></a><span id="l17.4201" class="difflineplus">+              break;  // just safeguard</span>
<a href="#l17.4202"></a><span id="l17.4202">           }</span>
<a href="#l17.4203"></a><span id="l17.4203">         }</span>
<a href="#l17.4204"></a><span id="l17.4204">       }</span>
<a href="#l17.4205"></a><span id="l17.4205">     }</span>
<a href="#l17.4206"></a><span id="l17.4206">   }</span>
<a href="#l17.4207"></a><span id="l17.4207"> </span>
<a href="#l17.4208"></a><span id="l17.4208">   return NS_OK;</span>
<a href="#l17.4209"></a><span id="l17.4209"> }</span>
<a href="#l17.4210"></a><span id="l17.4210" class="difflineminus">-NS_IMETHODIMP nsMsgCompose::OnStartSending(const char *aMsgID, uint32_t aMsgSize)</span>
<a href="#l17.4211"></a><span id="l17.4211" class="difflineminus">-{</span>
<a href="#l17.4212"></a><span id="l17.4212" class="difflineminus">-  nsTObserverArray&lt;nsCOMPtr&lt;nsIMsgSendListener&gt; &gt;::ForwardIterator iter(mExternalSendListeners);</span>
<a href="#l17.4213"></a><span id="l17.4213" class="difflineplus">+NS_IMETHODIMP nsMsgCompose::OnStartSending(const char *aMsgID,</span>
<a href="#l17.4214"></a><span id="l17.4214" class="difflineplus">+                                           uint32_t aMsgSize) {</span>
<a href="#l17.4215"></a><span id="l17.4215" class="difflineplus">+  nsTObserverArray&lt;nsCOMPtr&lt;nsIMsgSendListener&gt; &gt;::ForwardIterator iter(</span>
<a href="#l17.4216"></a><span id="l17.4216" class="difflineplus">+      mExternalSendListeners);</span>
<a href="#l17.4217"></a><span id="l17.4217">   nsCOMPtr&lt;nsIMsgSendListener&gt; externalSendListener;</span>
<a href="#l17.4218"></a><span id="l17.4218"> </span>
<a href="#l17.4219"></a><span id="l17.4219" class="difflineminus">-  while (iter.HasMore())</span>
<a href="#l17.4220"></a><span id="l17.4220" class="difflineminus">-  {</span>
<a href="#l17.4221"></a><span id="l17.4221" class="difflineplus">+  while (iter.HasMore()) {</span>
<a href="#l17.4222"></a><span id="l17.4222">     externalSendListener = iter.GetNext();</span>
<a href="#l17.4223"></a><span id="l17.4223">     externalSendListener-&gt;OnStartSending(aMsgID, aMsgSize);</span>
<a href="#l17.4224"></a><span id="l17.4224">   }</span>
<a href="#l17.4225"></a><span id="l17.4225">   return NS_OK;</span>
<a href="#l17.4226"></a><span id="l17.4226"> }</span>
<a href="#l17.4227"></a><span id="l17.4227"> </span>
<a href="#l17.4228"></a><span id="l17.4228" class="difflineminus">-NS_IMETHODIMP nsMsgCompose::OnProgress(const char *aMsgID, uint32_t aProgress, uint32_t aProgressMax)</span>
<a href="#l17.4229"></a><span id="l17.4229" class="difflineminus">-{</span>
<a href="#l17.4230"></a><span id="l17.4230" class="difflineminus">-  nsTObserverArray&lt;nsCOMPtr&lt;nsIMsgSendListener&gt; &gt;::ForwardIterator iter(mExternalSendListeners);</span>
<a href="#l17.4231"></a><span id="l17.4231" class="difflineplus">+NS_IMETHODIMP nsMsgCompose::OnProgress(const char *aMsgID, uint32_t aProgress,</span>
<a href="#l17.4232"></a><span id="l17.4232" class="difflineplus">+                                       uint32_t aProgressMax) {</span>
<a href="#l17.4233"></a><span id="l17.4233" class="difflineplus">+  nsTObserverArray&lt;nsCOMPtr&lt;nsIMsgSendListener&gt; &gt;::ForwardIterator iter(</span>
<a href="#l17.4234"></a><span id="l17.4234" class="difflineplus">+      mExternalSendListeners);</span>
<a href="#l17.4235"></a><span id="l17.4235">   nsCOMPtr&lt;nsIMsgSendListener&gt; externalSendListener;</span>
<a href="#l17.4236"></a><span id="l17.4236"> </span>
<a href="#l17.4237"></a><span id="l17.4237" class="difflineminus">-  while (iter.HasMore())</span>
<a href="#l17.4238"></a><span id="l17.4238" class="difflineminus">-  {</span>
<a href="#l17.4239"></a><span id="l17.4239" class="difflineplus">+  while (iter.HasMore()) {</span>
<a href="#l17.4240"></a><span id="l17.4240">     externalSendListener = iter.GetNext();</span>
<a href="#l17.4241"></a><span id="l17.4241">     externalSendListener-&gt;OnProgress(aMsgID, aProgress, aProgressMax);</span>
<a href="#l17.4242"></a><span id="l17.4242">   }</span>
<a href="#l17.4243"></a><span id="l17.4243">   return NS_OK;</span>
<a href="#l17.4244"></a><span id="l17.4244"> }</span>
<a href="#l17.4245"></a><span id="l17.4245"> </span>
<a href="#l17.4246"></a><span id="l17.4246" class="difflineminus">-NS_IMETHODIMP nsMsgCompose::OnStatus(const char *aMsgID, const char16_t *aMsg)</span>
<a href="#l17.4247"></a><span id="l17.4247" class="difflineminus">-{</span>
<a href="#l17.4248"></a><span id="l17.4248" class="difflineminus">-  nsTObserverArray&lt;nsCOMPtr&lt;nsIMsgSendListener&gt; &gt;::ForwardIterator iter(mExternalSendListeners);</span>
<a href="#l17.4249"></a><span id="l17.4249" class="difflineplus">+NS_IMETHODIMP nsMsgCompose::OnStatus(const char *aMsgID, const char16_t *aMsg) {</span>
<a href="#l17.4250"></a><span id="l17.4250" class="difflineplus">+  nsTObserverArray&lt;nsCOMPtr&lt;nsIMsgSendListener&gt; &gt;::ForwardIterator iter(</span>
<a href="#l17.4251"></a><span id="l17.4251" class="difflineplus">+      mExternalSendListeners);</span>
<a href="#l17.4252"></a><span id="l17.4252">   nsCOMPtr&lt;nsIMsgSendListener&gt; externalSendListener;</span>
<a href="#l17.4253"></a><span id="l17.4253"> </span>
<a href="#l17.4254"></a><span id="l17.4254" class="difflineminus">-  while (iter.HasMore())</span>
<a href="#l17.4255"></a><span id="l17.4255" class="difflineminus">-  {</span>
<a href="#l17.4256"></a><span id="l17.4256" class="difflineplus">+  while (iter.HasMore()) {</span>
<a href="#l17.4257"></a><span id="l17.4257">     externalSendListener = iter.GetNext();</span>
<a href="#l17.4258"></a><span id="l17.4258">     externalSendListener-&gt;OnStatus(aMsgID, aMsg);</span>
<a href="#l17.4259"></a><span id="l17.4259">   }</span>
<a href="#l17.4260"></a><span id="l17.4260">   return NS_OK;</span>
<a href="#l17.4261"></a><span id="l17.4261"> }</span>
<a href="#l17.4262"></a><span id="l17.4262"> </span>
<a href="#l17.4263"></a><span id="l17.4263" class="difflineminus">-NS_IMETHODIMP nsMsgCompose::OnStopSending(const char *aMsgID, nsresult aStatus, const char16_t *aMsg,</span>
<a href="#l17.4264"></a><span id="l17.4264" class="difflineminus">-                                      nsIFile *returnFile)</span>
<a href="#l17.4265"></a><span id="l17.4265" class="difflineminus">-{</span>
<a href="#l17.4266"></a><span id="l17.4266" class="difflineminus">-  nsTObserverArray&lt;nsCOMPtr&lt;nsIMsgSendListener&gt; &gt;::ForwardIterator iter(mExternalSendListeners);</span>
<a href="#l17.4267"></a><span id="l17.4267" class="difflineplus">+NS_IMETHODIMP nsMsgCompose::OnStopSending(const char *aMsgID, nsresult aStatus,</span>
<a href="#l17.4268"></a><span id="l17.4268" class="difflineplus">+                                          const char16_t *aMsg,</span>
<a href="#l17.4269"></a><span id="l17.4269" class="difflineplus">+                                          nsIFile *returnFile) {</span>
<a href="#l17.4270"></a><span id="l17.4270" class="difflineplus">+  nsTObserverArray&lt;nsCOMPtr&lt;nsIMsgSendListener&gt; &gt;::ForwardIterator iter(</span>
<a href="#l17.4271"></a><span id="l17.4271" class="difflineplus">+      mExternalSendListeners);</span>
<a href="#l17.4272"></a><span id="l17.4272">   nsCOMPtr&lt;nsIMsgSendListener&gt; externalSendListener;</span>
<a href="#l17.4273"></a><span id="l17.4273"> </span>
<a href="#l17.4274"></a><span id="l17.4274" class="difflineminus">-  while (iter.HasMore())</span>
<a href="#l17.4275"></a><span id="l17.4275" class="difflineminus">-  {</span>
<a href="#l17.4276"></a><span id="l17.4276" class="difflineplus">+  while (iter.HasMore()) {</span>
<a href="#l17.4277"></a><span id="l17.4277">     externalSendListener = iter.GetNext();</span>
<a href="#l17.4278"></a><span id="l17.4278">     externalSendListener-&gt;OnStopSending(aMsgID, aStatus, aMsg, returnFile);</span>
<a href="#l17.4279"></a><span id="l17.4279">   }</span>
<a href="#l17.4280"></a><span id="l17.4280">   return NS_OK;</span>
<a href="#l17.4281"></a><span id="l17.4281"> }</span>
<a href="#l17.4282"></a><span id="l17.4282"> </span>
<a href="#l17.4283"></a><span id="l17.4283" class="difflineminus">-NS_IMETHODIMP nsMsgCompose::OnSendNotPerformed(const char *aMsgID, nsresult aStatus)</span>
<a href="#l17.4284"></a><span id="l17.4284" class="difflineminus">-{</span>
<a href="#l17.4285"></a><span id="l17.4285" class="difflineminus">-  nsTObserverArray&lt;nsCOMPtr&lt;nsIMsgSendListener&gt; &gt;::ForwardIterator iter(mExternalSendListeners);</span>
<a href="#l17.4286"></a><span id="l17.4286" class="difflineplus">+NS_IMETHODIMP nsMsgCompose::OnSendNotPerformed(const char *aMsgID,</span>
<a href="#l17.4287"></a><span id="l17.4287" class="difflineplus">+                                               nsresult aStatus) {</span>
<a href="#l17.4288"></a><span id="l17.4288" class="difflineplus">+  nsTObserverArray&lt;nsCOMPtr&lt;nsIMsgSendListener&gt; &gt;::ForwardIterator iter(</span>
<a href="#l17.4289"></a><span id="l17.4289" class="difflineplus">+      mExternalSendListeners);</span>
<a href="#l17.4290"></a><span id="l17.4290">   nsCOMPtr&lt;nsIMsgSendListener&gt; externalSendListener;</span>
<a href="#l17.4291"></a><span id="l17.4291"> </span>
<a href="#l17.4292"></a><span id="l17.4292" class="difflineminus">-  while (iter.HasMore())</span>
<a href="#l17.4293"></a><span id="l17.4293" class="difflineminus">-  {</span>
<a href="#l17.4294"></a><span id="l17.4294" class="difflineplus">+  while (iter.HasMore()) {</span>
<a href="#l17.4295"></a><span id="l17.4295">     externalSendListener = iter.GetNext();</span>
<a href="#l17.4296"></a><span id="l17.4296">     externalSendListener-&gt;OnSendNotPerformed(aMsgID, aStatus);</span>
<a href="#l17.4297"></a><span id="l17.4297">   }</span>
<a href="#l17.4298"></a><span id="l17.4298">   return NS_OK;</span>
<a href="#l17.4299"></a><span id="l17.4299"> }</span>
<a href="#l17.4300"></a><span id="l17.4300"> </span>
<a href="#l17.4301"></a><span id="l17.4301" class="difflineminus">-NS_IMETHODIMP nsMsgCompose::OnGetDraftFolderURI(const char *aFolderURI)</span>
<a href="#l17.4302"></a><span id="l17.4302" class="difflineminus">-{</span>
<a href="#l17.4303"></a><span id="l17.4303" class="difflineplus">+NS_IMETHODIMP nsMsgCompose::OnGetDraftFolderURI(const char *aFolderURI) {</span>
<a href="#l17.4304"></a><span id="l17.4304">   m_folderName = aFolderURI;</span>
<a href="#l17.4305"></a><span id="l17.4305" class="difflineminus">-  nsTObserverArray&lt;nsCOMPtr&lt;nsIMsgSendListener&gt; &gt;::ForwardIterator iter(mExternalSendListeners);</span>
<a href="#l17.4306"></a><span id="l17.4306" class="difflineplus">+  nsTObserverArray&lt;nsCOMPtr&lt;nsIMsgSendListener&gt; &gt;::ForwardIterator iter(</span>
<a href="#l17.4307"></a><span id="l17.4307" class="difflineplus">+      mExternalSendListeners);</span>
<a href="#l17.4308"></a><span id="l17.4308">   nsCOMPtr&lt;nsIMsgSendListener&gt; externalSendListener;</span>
<a href="#l17.4309"></a><span id="l17.4309"> </span>
<a href="#l17.4310"></a><span id="l17.4310" class="difflineminus">-  while (iter.HasMore())</span>
<a href="#l17.4311"></a><span id="l17.4311" class="difflineminus">-  {</span>
<a href="#l17.4312"></a><span id="l17.4312" class="difflineplus">+  while (iter.HasMore()) {</span>
<a href="#l17.4313"></a><span id="l17.4313">     externalSendListener = iter.GetNext();</span>
<a href="#l17.4314"></a><span id="l17.4314">     externalSendListener-&gt;OnGetDraftFolderURI(aFolderURI);</span>
<a href="#l17.4315"></a><span id="l17.4315">   }</span>
<a href="#l17.4316"></a><span id="l17.4316">   return NS_OK;</span>
<a href="#l17.4317"></a><span id="l17.4317"> }</span>
<a href="#l17.4318"></a><span id="l17.4318"> </span>
<a href="#l17.4319"></a><span id="l17.4319"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l17.4320"></a><span id="l17.4320" class="difflineminus">-// This is the listener class for both the send operation and the copy operation.</span>
<a href="#l17.4321"></a><span id="l17.4321" class="difflineminus">-// We have to create this class to listen for message send completion and deal with</span>
<a href="#l17.4322"></a><span id="l17.4322" class="difflineminus">-// failures in both send and copy operations</span>
<a href="#l17.4323"></a><span id="l17.4323" class="difflineplus">+// This is the listener class for both the send operation and the copy</span>
<a href="#l17.4324"></a><span id="l17.4324" class="difflineplus">+// operation. We have to create this class to listen for message send completion</span>
<a href="#l17.4325"></a><span id="l17.4325" class="difflineplus">+// and deal with failures in both send and copy operations</span>
<a href="#l17.4326"></a><span id="l17.4326"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l17.4327"></a><span id="l17.4327"> NS_IMPL_ADDREF(nsMsgComposeSendListener)</span>
<a href="#l17.4328"></a><span id="l17.4328"> NS_IMPL_RELEASE(nsMsgComposeSendListener)</span>
<a href="#l17.4329"></a><span id="l17.4329"> </span>
<a href="#l17.4330"></a><span id="l17.4330"> /*</span>
<a href="#l17.4331"></a><span id="l17.4331"> NS_IMPL_QUERY_INTERFACE(nsMsgComposeSendListener,</span>
<a href="#l17.4332"></a><span id="l17.4332">                          nsIMsgComposeSendListener,</span>
<a href="#l17.4333"></a><span id="l17.4333">                          nsIMsgSendListener,</span>
<a href="#l17.4334"></a><span id="l17.4334" class="difflineat">@@ -3592,721 +3269,672 @@ NS_IMPL_QUERY_INTERFACE(nsMsgComposeSend</span>
<a href="#l17.4335"></a><span id="l17.4335"> NS_INTERFACE_MAP_BEGIN(nsMsgComposeSendListener)</span>
<a href="#l17.4336"></a><span id="l17.4336">   NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, nsIMsgComposeSendListener)</span>
<a href="#l17.4337"></a><span id="l17.4337">   NS_INTERFACE_MAP_ENTRY(nsIMsgComposeSendListener)</span>
<a href="#l17.4338"></a><span id="l17.4338">   NS_INTERFACE_MAP_ENTRY(nsIMsgSendListener)</span>
<a href="#l17.4339"></a><span id="l17.4339">   NS_INTERFACE_MAP_ENTRY(nsIMsgCopyServiceListener)</span>
<a href="#l17.4340"></a><span id="l17.4340">   NS_INTERFACE_MAP_ENTRY(nsIWebProgressListener)</span>
<a href="#l17.4341"></a><span id="l17.4341"> NS_INTERFACE_MAP_END</span>
<a href="#l17.4342"></a><span id="l17.4342"> </span>
<a href="#l17.4343"></a><span id="l17.4343" class="difflineminus">-</span>
<a href="#l17.4344"></a><span id="l17.4344" class="difflineminus">-nsMsgComposeSendListener::nsMsgComposeSendListener(void)</span>
<a href="#l17.4345"></a><span id="l17.4345" class="difflineminus">-{</span>
<a href="#l17.4346"></a><span id="l17.4346" class="difflineminus">-  mDeliverMode = 0;</span>
<a href="#l17.4347"></a><span id="l17.4347" class="difflineminus">-}</span>
<a href="#l17.4348"></a><span id="l17.4348" class="difflineminus">-</span>
<a href="#l17.4349"></a><span id="l17.4349" class="difflineminus">-nsMsgComposeSendListener::~nsMsgComposeSendListener(void)</span>
<a href="#l17.4350"></a><span id="l17.4350" class="difflineminus">-{</span>
<a href="#l17.4351"></a><span id="l17.4351" class="difflineminus">-}</span>
<a href="#l17.4352"></a><span id="l17.4352" class="difflineminus">-</span>
<a href="#l17.4353"></a><span id="l17.4353" class="difflineminus">-NS_IMETHODIMP nsMsgComposeSendListener::SetMsgCompose(nsIMsgCompose *obj)</span>
<a href="#l17.4354"></a><span id="l17.4354" class="difflineminus">-{</span>
<a href="#l17.4355"></a><span id="l17.4355" class="difflineplus">+nsMsgComposeSendListener::nsMsgComposeSendListener(void) { mDeliverMode = 0; }</span>
<a href="#l17.4356"></a><span id="l17.4356" class="difflineplus">+</span>
<a href="#l17.4357"></a><span id="l17.4357" class="difflineplus">+nsMsgComposeSendListener::~nsMsgComposeSendListener(void) {}</span>
<a href="#l17.4358"></a><span id="l17.4358" class="difflineplus">+</span>
<a href="#l17.4359"></a><span id="l17.4359" class="difflineplus">+NS_IMETHODIMP nsMsgComposeSendListener::SetMsgCompose(nsIMsgCompose *obj) {</span>
<a href="#l17.4360"></a><span id="l17.4360">   mWeakComposeObj = do_GetWeakReference(obj);</span>
<a href="#l17.4361"></a><span id="l17.4361">   return NS_OK;</span>
<a href="#l17.4362"></a><span id="l17.4362"> }</span>
<a href="#l17.4363"></a><span id="l17.4363"> </span>
<a href="#l17.4364"></a><span id="l17.4364" class="difflineminus">-NS_IMETHODIMP nsMsgComposeSendListener::SetDeliverMode(MSG_DeliverMode deliverMode)</span>
<a href="#l17.4365"></a><span id="l17.4365" class="difflineminus">-{</span>
<a href="#l17.4366"></a><span id="l17.4366" class="difflineplus">+NS_IMETHODIMP nsMsgComposeSendListener::SetDeliverMode(</span>
<a href="#l17.4367"></a><span id="l17.4367" class="difflineplus">+    MSG_DeliverMode deliverMode) {</span>
<a href="#l17.4368"></a><span id="l17.4368">   mDeliverMode = deliverMode;</span>
<a href="#l17.4369"></a><span id="l17.4369">   return NS_OK;</span>
<a href="#l17.4370"></a><span id="l17.4370"> }</span>
<a href="#l17.4371"></a><span id="l17.4371"> </span>
<a href="#l17.4372"></a><span id="l17.4372" class="difflineminus">-nsresult</span>
<a href="#l17.4373"></a><span id="l17.4373" class="difflineminus">-nsMsgComposeSendListener::OnStartSending(const char *aMsgID, uint32_t aMsgSize)</span>
<a href="#l17.4374"></a><span id="l17.4374" class="difflineminus">-{</span>
<a href="#l17.4375"></a><span id="l17.4375" class="difflineplus">+nsresult nsMsgComposeSendListener::OnStartSending(const char *aMsgID,</span>
<a href="#l17.4376"></a><span id="l17.4376" class="difflineplus">+                                                  uint32_t aMsgSize) {</span>
<a href="#l17.4377"></a><span id="l17.4377">   nsresult rv;</span>
<a href="#l17.4378"></a><span id="l17.4378" class="difflineminus">-  nsCOMPtr&lt;nsIMsgSendListener&gt; composeSendListener = do_QueryReferent(mWeakComposeObj, &amp;rv);</span>
<a href="#l17.4379"></a><span id="l17.4379" class="difflineplus">+  nsCOMPtr&lt;nsIMsgSendListener&gt; composeSendListener =</span>
<a href="#l17.4380"></a><span id="l17.4380" class="difflineplus">+      do_QueryReferent(mWeakComposeObj, &amp;rv);</span>
<a href="#l17.4381"></a><span id="l17.4381">   if (NS_SUCCEEDED(rv) &amp;&amp; composeSendListener)</span>
<a href="#l17.4382"></a><span id="l17.4382">     composeSendListener-&gt;OnStartSending(aMsgID, aMsgSize);</span>
<a href="#l17.4383"></a><span id="l17.4383"> </span>
<a href="#l17.4384"></a><span id="l17.4384">   return NS_OK;</span>
<a href="#l17.4385"></a><span id="l17.4385"> }</span>
<a href="#l17.4386"></a><span id="l17.4386"> </span>
<a href="#l17.4387"></a><span id="l17.4387" class="difflineminus">-nsresult</span>
<a href="#l17.4388"></a><span id="l17.4388" class="difflineminus">-nsMsgComposeSendListener::OnProgress(const char *aMsgID, uint32_t aProgress, uint32_t aProgressMax)</span>
<a href="#l17.4389"></a><span id="l17.4389" class="difflineminus">-{</span>
<a href="#l17.4390"></a><span id="l17.4390" class="difflineplus">+nsresult nsMsgComposeSendListener::OnProgress(const char *aMsgID,</span>
<a href="#l17.4391"></a><span id="l17.4391" class="difflineplus">+                                              uint32_t aProgress,</span>
<a href="#l17.4392"></a><span id="l17.4392" class="difflineplus">+                                              uint32_t aProgressMax) {</span>
<a href="#l17.4393"></a><span id="l17.4393">   nsresult rv;</span>
<a href="#l17.4394"></a><span id="l17.4394" class="difflineminus">-  nsCOMPtr&lt;nsIMsgSendListener&gt; composeSendListener = do_QueryReferent(mWeakComposeObj, &amp;rv);</span>
<a href="#l17.4395"></a><span id="l17.4395" class="difflineplus">+  nsCOMPtr&lt;nsIMsgSendListener&gt; composeSendListener =</span>
<a href="#l17.4396"></a><span id="l17.4396" class="difflineplus">+      do_QueryReferent(mWeakComposeObj, &amp;rv);</span>
<a href="#l17.4397"></a><span id="l17.4397">   if (NS_SUCCEEDED(rv) &amp;&amp; composeSendListener)</span>
<a href="#l17.4398"></a><span id="l17.4398">     composeSendListener-&gt;OnProgress(aMsgID, aProgress, aProgressMax);</span>
<a href="#l17.4399"></a><span id="l17.4399">   return NS_OK;</span>
<a href="#l17.4400"></a><span id="l17.4400"> }</span>
<a href="#l17.4401"></a><span id="l17.4401"> </span>
<a href="#l17.4402"></a><span id="l17.4402" class="difflineminus">-nsresult</span>
<a href="#l17.4403"></a><span id="l17.4403" class="difflineminus">-nsMsgComposeSendListener::OnStatus(const char *aMsgID, const char16_t *aMsg)</span>
<a href="#l17.4404"></a><span id="l17.4404" class="difflineminus">-{</span>
<a href="#l17.4405"></a><span id="l17.4405" class="difflineplus">+nsresult nsMsgComposeSendListener::OnStatus(const char *aMsgID,</span>
<a href="#l17.4406"></a><span id="l17.4406" class="difflineplus">+                                            const char16_t *aMsg) {</span>
<a href="#l17.4407"></a><span id="l17.4407">   nsresult rv;</span>
<a href="#l17.4408"></a><span id="l17.4408" class="difflineminus">-  nsCOMPtr&lt;nsIMsgSendListener&gt; composeSendListener = do_QueryReferent(mWeakComposeObj, &amp;rv);</span>
<a href="#l17.4409"></a><span id="l17.4409" class="difflineplus">+  nsCOMPtr&lt;nsIMsgSendListener&gt; composeSendListener =</span>
<a href="#l17.4410"></a><span id="l17.4410" class="difflineplus">+      do_QueryReferent(mWeakComposeObj, &amp;rv);</span>
<a href="#l17.4411"></a><span id="l17.4411">   if (NS_SUCCEEDED(rv) &amp;&amp; composeSendListener)</span>
<a href="#l17.4412"></a><span id="l17.4412">     composeSendListener-&gt;OnStatus(aMsgID, aMsg);</span>
<a href="#l17.4413"></a><span id="l17.4413">   return NS_OK;</span>
<a href="#l17.4414"></a><span id="l17.4414"> }</span>
<a href="#l17.4415"></a><span id="l17.4415"> </span>
<a href="#l17.4416"></a><span id="l17.4416" class="difflineminus">-nsresult nsMsgComposeSendListener::OnSendNotPerformed(const char *aMsgID, nsresult aStatus)</span>
<a href="#l17.4417"></a><span id="l17.4417" class="difflineminus">-{</span>
<a href="#l17.4418"></a><span id="l17.4418" class="difflineminus">- // since OnSendNotPerformed is called in the case where the user aborts the operation</span>
<a href="#l17.4419"></a><span id="l17.4419" class="difflineminus">- // by closing the compose window, we need not do the stuff required</span>
<a href="#l17.4420"></a><span id="l17.4420" class="difflineminus">- // for closing the windows. However we would need to do the other operations as below.</span>
<a href="#l17.4421"></a><span id="l17.4421" class="difflineplus">+nsresult nsMsgComposeSendListener::OnSendNotPerformed(const char *aMsgID,</span>
<a href="#l17.4422"></a><span id="l17.4422" class="difflineplus">+                                                      nsresult aStatus) {</span>
<a href="#l17.4423"></a><span id="l17.4423" class="difflineplus">+  // since OnSendNotPerformed is called in the case where the user aborts the</span>
<a href="#l17.4424"></a><span id="l17.4424" class="difflineplus">+  // operation by closing the compose window, we need not do the stuff required</span>
<a href="#l17.4425"></a><span id="l17.4425" class="difflineplus">+  // for closing the windows. However we would need to do the other operations</span>
<a href="#l17.4426"></a><span id="l17.4426" class="difflineplus">+  // as below.</span>
<a href="#l17.4427"></a><span id="l17.4427"> </span>
<a href="#l17.4428"></a><span id="l17.4428">   nsresult rv = NS_OK;</span>
<a href="#l17.4429"></a><span id="l17.4429">   nsCOMPtr&lt;nsIMsgCompose&gt; msgCompose = do_QueryReferent(mWeakComposeObj, &amp;rv);</span>
<a href="#l17.4430"></a><span id="l17.4430">   if (msgCompose)</span>
<a href="#l17.4431"></a><span id="l17.4431" class="difflineminus">-    msgCompose-&gt;NotifyStateListeners(nsIMsgComposeNotificationType::ComposeProcessDone, aStatus);</span>
<a href="#l17.4432"></a><span id="l17.4432" class="difflineminus">-</span>
<a href="#l17.4433"></a><span id="l17.4433" class="difflineminus">-  nsCOMPtr&lt;nsIMsgSendListener&gt; composeSendListener = do_QueryReferent(mWeakComposeObj, &amp;rv);</span>
<a href="#l17.4434"></a><span id="l17.4434" class="difflineplus">+    msgCompose-&gt;NotifyStateListeners(</span>
<a href="#l17.4435"></a><span id="l17.4435" class="difflineplus">+        nsIMsgComposeNotificationType::ComposeProcessDone, aStatus);</span>
<a href="#l17.4436"></a><span id="l17.4436" class="difflineplus">+</span>
<a href="#l17.4437"></a><span id="l17.4437" class="difflineplus">+  nsCOMPtr&lt;nsIMsgSendListener&gt; composeSendListener =</span>
<a href="#l17.4438"></a><span id="l17.4438" class="difflineplus">+      do_QueryReferent(mWeakComposeObj, &amp;rv);</span>
<a href="#l17.4439"></a><span id="l17.4439">   if (NS_SUCCEEDED(rv) &amp;&amp; composeSendListener)</span>
<a href="#l17.4440"></a><span id="l17.4440">     composeSendListener-&gt;OnSendNotPerformed(aMsgID, aStatus);</span>
<a href="#l17.4441"></a><span id="l17.4441"> </span>
<a href="#l17.4442"></a><span id="l17.4442">   return rv;</span>
<a href="#l17.4443"></a><span id="l17.4443"> }</span>
<a href="#l17.4444"></a><span id="l17.4444"> </span>
<a href="#l17.4445"></a><span id="l17.4445" class="difflineminus">-nsresult nsMsgComposeSendListener::OnStopSending(const char *aMsgID, nsresult aStatus,</span>
<a href="#l17.4446"></a><span id="l17.4446" class="difflineminus">-                                                 const char16_t *aMsg, nsIFile *returnFile)</span>
<a href="#l17.4447"></a><span id="l17.4447" class="difflineminus">-{</span>
<a href="#l17.4448"></a><span id="l17.4448" class="difflineplus">+nsresult nsMsgComposeSendListener::OnStopSending(const char *aMsgID,</span>
<a href="#l17.4449"></a><span id="l17.4449" class="difflineplus">+                                                 nsresult aStatus,</span>
<a href="#l17.4450"></a><span id="l17.4450" class="difflineplus">+                                                 const char16_t *aMsg,</span>
<a href="#l17.4451"></a><span id="l17.4451" class="difflineplus">+                                                 nsIFile *returnFile) {</span>
<a href="#l17.4452"></a><span id="l17.4452">   nsresult rv = NS_OK;</span>
<a href="#l17.4453"></a><span id="l17.4453"> </span>
<a href="#l17.4454"></a><span id="l17.4454">   nsCOMPtr&lt;nsIMsgCompose&gt; msgCompose = do_QueryReferent(mWeakComposeObj, &amp;rv);</span>
<a href="#l17.4455"></a><span id="l17.4455" class="difflineminus">-  if (msgCompose)</span>
<a href="#l17.4456"></a><span id="l17.4456" class="difflineminus">-  {</span>
<a href="#l17.4457"></a><span id="l17.4457" class="difflineplus">+  if (msgCompose) {</span>
<a href="#l17.4458"></a><span id="l17.4458">     nsCOMPtr&lt;nsIMsgProgress&gt; progress;</span>
<a href="#l17.4459"></a><span id="l17.4459">     msgCompose-&gt;GetProgress(getter_AddRefs(progress));</span>
<a href="#l17.4460"></a><span id="l17.4460"> </span>
<a href="#l17.4461"></a><span id="l17.4461" class="difflineminus">-    if (NS_SUCCEEDED(aStatus))</span>
<a href="#l17.4462"></a><span id="l17.4462" class="difflineminus">-    {</span>
<a href="#l17.4463"></a><span id="l17.4463" class="difflineplus">+    if (NS_SUCCEEDED(aStatus)) {</span>
<a href="#l17.4464"></a><span id="l17.4464">       nsCOMPtr&lt;nsIMsgCompFields&gt; compFields;</span>
<a href="#l17.4465"></a><span id="l17.4465">       msgCompose-&gt;GetCompFields(getter_AddRefs(compFields));</span>
<a href="#l17.4466"></a><span id="l17.4466"> </span>
<a href="#l17.4467"></a><span id="l17.4467">       // only process the reply flags if we successfully sent the message</span>
<a href="#l17.4468"></a><span id="l17.4468">       msgCompose-&gt;ProcessReplyFlags();</span>
<a href="#l17.4469"></a><span id="l17.4469"> </span>
<a href="#l17.4470"></a><span id="l17.4470">       // See if there is a composer window</span>
<a href="#l17.4471"></a><span id="l17.4471">       bool hasDomWindow = true;</span>
<a href="#l17.4472"></a><span id="l17.4472">       nsCOMPtr&lt;mozIDOMWindowProxy&gt; domWindow;</span>
<a href="#l17.4473"></a><span id="l17.4473">       rv = msgCompose-&gt;GetDomWindow(getter_AddRefs(domWindow));</span>
<a href="#l17.4474"></a><span id="l17.4474" class="difflineminus">-      if (NS_FAILED(rv) || !domWindow)</span>
<a href="#l17.4475"></a><span id="l17.4475" class="difflineminus">-        hasDomWindow = false;</span>
<a href="#l17.4476"></a><span id="l17.4476" class="difflineplus">+      if (NS_FAILED(rv) || !domWindow) hasDomWindow = false;</span>
<a href="#l17.4477"></a><span id="l17.4477"> </span>
<a href="#l17.4478"></a><span id="l17.4478">       // Close the window ONLY if we are not going to do a save operation</span>
<a href="#l17.4479"></a><span id="l17.4479">       nsAutoString fieldsFCC;</span>
<a href="#l17.4480"></a><span id="l17.4480" class="difflineminus">-      if (NS_SUCCEEDED(compFields-&gt;GetFcc(fieldsFCC)))</span>
<a href="#l17.4481"></a><span id="l17.4481" class="difflineminus">-      {</span>
<a href="#l17.4482"></a><span id="l17.4482" class="difflineminus">-        if (!fieldsFCC.IsEmpty())</span>
<a href="#l17.4483"></a><span id="l17.4483" class="difflineminus">-        {</span>
<a href="#l17.4484"></a><span id="l17.4484" class="difflineminus">-          if (fieldsFCC.LowerCaseEqualsLiteral(&quot;nocopy://&quot;))</span>
<a href="#l17.4485"></a><span id="l17.4485" class="difflineminus">-          {</span>
<a href="#l17.4486"></a><span id="l17.4486" class="difflineminus">-            msgCompose-&gt;NotifyStateListeners(nsIMsgComposeNotificationType::ComposeProcessDone, NS_OK);</span>
<a href="#l17.4487"></a><span id="l17.4487" class="difflineminus">-            if (progress)</span>
<a href="#l17.4488"></a><span id="l17.4488" class="difflineminus">-            {</span>
<a href="#l17.4489"></a><span id="l17.4489" class="difflineplus">+      if (NS_SUCCEEDED(compFields-&gt;GetFcc(fieldsFCC))) {</span>
<a href="#l17.4490"></a><span id="l17.4490" class="difflineplus">+        if (!fieldsFCC.IsEmpty()) {</span>
<a href="#l17.4491"></a><span id="l17.4491" class="difflineplus">+          if (fieldsFCC.LowerCaseEqualsLiteral(&quot;nocopy://&quot;)) {</span>
<a href="#l17.4492"></a><span id="l17.4492" class="difflineplus">+            msgCompose-&gt;NotifyStateListeners(</span>
<a href="#l17.4493"></a><span id="l17.4493" class="difflineplus">+                nsIMsgComposeNotificationType::ComposeProcessDone, NS_OK);</span>
<a href="#l17.4494"></a><span id="l17.4494" class="difflineplus">+            if (progress) {</span>
<a href="#l17.4495"></a><span id="l17.4495">               progress-&gt;UnregisterListener(this);</span>
<a href="#l17.4496"></a><span id="l17.4496">               progress-&gt;CloseProgressDialog(false);</span>
<a href="#l17.4497"></a><span id="l17.4497">             }</span>
<a href="#l17.4498"></a><span id="l17.4498" class="difflineminus">-            if (hasDomWindow)</span>
<a href="#l17.4499"></a><span id="l17.4499" class="difflineminus">-              msgCompose-&gt;CloseWindow();</span>
<a href="#l17.4500"></a><span id="l17.4500" class="difflineplus">+            if (hasDomWindow) msgCompose-&gt;CloseWindow();</span>
<a href="#l17.4501"></a><span id="l17.4501">           }</span>
<a href="#l17.4502"></a><span id="l17.4502">         }</span>
<a href="#l17.4503"></a><span id="l17.4503" class="difflineminus">-      }</span>
<a href="#l17.4504"></a><span id="l17.4504" class="difflineminus">-      else</span>
<a href="#l17.4505"></a><span id="l17.4505" class="difflineminus">-      {</span>
<a href="#l17.4506"></a><span id="l17.4506" class="difflineminus">-        msgCompose-&gt;NotifyStateListeners(nsIMsgComposeNotificationType::ComposeProcessDone, NS_OK);</span>
<a href="#l17.4507"></a><span id="l17.4507" class="difflineminus">-        if (progress)</span>
<a href="#l17.4508"></a><span id="l17.4508" class="difflineminus">-        {</span>
<a href="#l17.4509"></a><span id="l17.4509" class="difflineplus">+      } else {</span>
<a href="#l17.4510"></a><span id="l17.4510" class="difflineplus">+        msgCompose-&gt;NotifyStateListeners(</span>
<a href="#l17.4511"></a><span id="l17.4511" class="difflineplus">+            nsIMsgComposeNotificationType::ComposeProcessDone, NS_OK);</span>
<a href="#l17.4512"></a><span id="l17.4512" class="difflineplus">+        if (progress) {</span>
<a href="#l17.4513"></a><span id="l17.4513">           progress-&gt;UnregisterListener(this);</span>
<a href="#l17.4514"></a><span id="l17.4514">           progress-&gt;CloseProgressDialog(false);</span>
<a href="#l17.4515"></a><span id="l17.4515">         }</span>
<a href="#l17.4516"></a><span id="l17.4516">         if (hasDomWindow)</span>
<a href="#l17.4517"></a><span id="l17.4517" class="difflineminus">-          msgCompose-&gt;CloseWindow();  // if we fail on the simple GetFcc call, close the window to be safe and avoid</span>
<a href="#l17.4518"></a><span id="l17.4518" class="difflineminus">-                                      // windows hanging around to prevent the app from exiting.</span>
<a href="#l17.4519"></a><span id="l17.4519" class="difflineplus">+          msgCompose-&gt;CloseWindow();  // if we fail on the simple GetFcc call,</span>
<a href="#l17.4520"></a><span id="l17.4520" class="difflineplus">+                                      // close the window to be safe and avoid</span>
<a href="#l17.4521"></a><span id="l17.4521" class="difflineplus">+                                      // windows hanging around to prevent the</span>
<a href="#l17.4522"></a><span id="l17.4522" class="difflineplus">+                                      // app from exiting.</span>
<a href="#l17.4523"></a><span id="l17.4523">       }</span>
<a href="#l17.4524"></a><span id="l17.4524"> </span>
<a href="#l17.4525"></a><span id="l17.4525">       // Remove the current draft msg when sending draft is done.</span>
<a href="#l17.4526"></a><span id="l17.4526">       bool deleteDraft;</span>
<a href="#l17.4527"></a><span id="l17.4527">       msgCompose-&gt;GetDeleteDraft(&amp;deleteDraft);</span>
<a href="#l17.4528"></a><span id="l17.4528" class="difflineminus">-      if (deleteDraft)</span>
<a href="#l17.4529"></a><span id="l17.4529" class="difflineminus">-        RemoveCurrentDraftMessage(msgCompose, false, false);</span>
<a href="#l17.4530"></a><span id="l17.4530" class="difflineminus">-    }</span>
<a href="#l17.4531"></a><span id="l17.4531" class="difflineminus">-    else</span>
<a href="#l17.4532"></a><span id="l17.4532" class="difflineminus">-    {</span>
<a href="#l17.4533"></a><span id="l17.4533" class="difflineminus">-      msgCompose-&gt;NotifyStateListeners(nsIMsgComposeNotificationType::ComposeProcessDone, aStatus);</span>
<a href="#l17.4534"></a><span id="l17.4534" class="difflineminus">-      if (progress)</span>
<a href="#l17.4535"></a><span id="l17.4535" class="difflineminus">-      {</span>
<a href="#l17.4536"></a><span id="l17.4536" class="difflineplus">+      if (deleteDraft) RemoveCurrentDraftMessage(msgCompose, false, false);</span>
<a href="#l17.4537"></a><span id="l17.4537" class="difflineplus">+    } else {</span>
<a href="#l17.4538"></a><span id="l17.4538" class="difflineplus">+      msgCompose-&gt;NotifyStateListeners(</span>
<a href="#l17.4539"></a><span id="l17.4539" class="difflineplus">+          nsIMsgComposeNotificationType::ComposeProcessDone, aStatus);</span>
<a href="#l17.4540"></a><span id="l17.4540" class="difflineplus">+      if (progress) {</span>
<a href="#l17.4541"></a><span id="l17.4541">         progress-&gt;CloseProgressDialog(true);</span>
<a href="#l17.4542"></a><span id="l17.4542">         progress-&gt;UnregisterListener(this);</span>
<a href="#l17.4543"></a><span id="l17.4543">       }</span>
<a href="#l17.4544"></a><span id="l17.4544">     }</span>
<a href="#l17.4545"></a><span id="l17.4545" class="difflineminus">-</span>
<a href="#l17.4546"></a><span id="l17.4546">   }</span>
<a href="#l17.4547"></a><span id="l17.4547"> </span>
<a href="#l17.4548"></a><span id="l17.4548" class="difflineminus">-  nsCOMPtr&lt;nsIMsgSendListener&gt; composeSendListener = do_QueryReferent(mWeakComposeObj, &amp;rv);</span>
<a href="#l17.4549"></a><span id="l17.4549" class="difflineplus">+  nsCOMPtr&lt;nsIMsgSendListener&gt; composeSendListener =</span>
<a href="#l17.4550"></a><span id="l17.4550" class="difflineplus">+      do_QueryReferent(mWeakComposeObj, &amp;rv);</span>
<a href="#l17.4551"></a><span id="l17.4551">   if (NS_SUCCEEDED(rv) &amp;&amp; composeSendListener)</span>
<a href="#l17.4552"></a><span id="l17.4552">     composeSendListener-&gt;OnStopSending(aMsgID, aStatus, aMsg, returnFile);</span>
<a href="#l17.4553"></a><span id="l17.4553"> </span>
<a href="#l17.4554"></a><span id="l17.4554">   return rv;</span>
<a href="#l17.4555"></a><span id="l17.4555"> }</span>
<a href="#l17.4556"></a><span id="l17.4556"> </span>
<a href="#l17.4557"></a><span id="l17.4557" class="difflineminus">-nsresult</span>
<a href="#l17.4558"></a><span id="l17.4558" class="difflineminus">-nsMsgComposeSendListener::OnGetDraftFolderURI(const char *aFolderURI)</span>
<a href="#l17.4559"></a><span id="l17.4559" class="difflineminus">-{</span>
<a href="#l17.4560"></a><span id="l17.4560" class="difflineplus">+nsresult nsMsgComposeSendListener::OnGetDraftFolderURI(const char *aFolderURI) {</span>
<a href="#l17.4561"></a><span id="l17.4561">   nsresult rv;</span>
<a href="#l17.4562"></a><span id="l17.4562" class="difflineminus">-  nsCOMPtr&lt;nsIMsgSendListener&gt; composeSendListener = do_QueryReferent(mWeakComposeObj, &amp;rv);</span>
<a href="#l17.4563"></a><span id="l17.4563" class="difflineplus">+  nsCOMPtr&lt;nsIMsgSendListener&gt; composeSendListener =</span>
<a href="#l17.4564"></a><span id="l17.4564" class="difflineplus">+      do_QueryReferent(mWeakComposeObj, &amp;rv);</span>
<a href="#l17.4565"></a><span id="l17.4565">   if (NS_SUCCEEDED(rv) &amp;&amp; composeSendListener)</span>
<a href="#l17.4566"></a><span id="l17.4566">     composeSendListener-&gt;OnGetDraftFolderURI(aFolderURI);</span>
<a href="#l17.4567"></a><span id="l17.4567"> </span>
<a href="#l17.4568"></a><span id="l17.4568">   return NS_OK;</span>
<a href="#l17.4569"></a><span id="l17.4569"> }</span>
<a href="#l17.4570"></a><span id="l17.4570"> </span>
<a href="#l17.4571"></a><span id="l17.4571" class="difflineminus">-</span>
<a href="#l17.4572"></a><span id="l17.4572" class="difflineminus">-nsresult</span>
<a href="#l17.4573"></a><span id="l17.4573" class="difflineminus">-nsMsgComposeSendListener::OnStartCopy()</span>
<a href="#l17.4574"></a><span id="l17.4574" class="difflineminus">-{</span>
<a href="#l17.4575"></a><span id="l17.4575" class="difflineminus">-  return NS_OK;</span>
<a href="#l17.4576"></a><span id="l17.4576" class="difflineminus">-}</span>
<a href="#l17.4577"></a><span id="l17.4577" class="difflineminus">-</span>
<a href="#l17.4578"></a><span id="l17.4578" class="difflineminus">-nsresult</span>
<a href="#l17.4579"></a><span id="l17.4579" class="difflineminus">-nsMsgComposeSendListener::OnProgress(uint32_t aProgress, uint32_t aProgressMax)</span>
<a href="#l17.4580"></a><span id="l17.4580" class="difflineminus">-{</span>
<a href="#l17.4581"></a><span id="l17.4581" class="difflineplus">+nsresult nsMsgComposeSendListener::OnStartCopy() { return NS_OK; }</span>
<a href="#l17.4582"></a><span id="l17.4582" class="difflineplus">+</span>
<a href="#l17.4583"></a><span id="l17.4583" class="difflineplus">+nsresult nsMsgComposeSendListener::OnProgress(uint32_t aProgress,</span>
<a href="#l17.4584"></a><span id="l17.4584" class="difflineplus">+                                              uint32_t aProgressMax) {</span>
<a href="#l17.4585"></a><span id="l17.4585">   return NS_OK;</span>
<a href="#l17.4586"></a><span id="l17.4586"> }</span>
<a href="#l17.4587"></a><span id="l17.4587"> </span>
<a href="#l17.4588"></a><span id="l17.4588" class="difflineminus">-nsresult</span>
<a href="#l17.4589"></a><span id="l17.4589" class="difflineminus">-nsMsgComposeSendListener::OnStopCopy(nsresult aStatus)</span>
<a href="#l17.4590"></a><span id="l17.4590" class="difflineminus">-{</span>
<a href="#l17.4591"></a><span id="l17.4591" class="difflineplus">+nsresult nsMsgComposeSendListener::OnStopCopy(nsresult aStatus) {</span>
<a href="#l17.4592"></a><span id="l17.4592">   nsresult rv = NS_OK;</span>
<a href="#l17.4593"></a><span id="l17.4593">   nsCOMPtr&lt;nsIMsgCompose&gt; msgCompose = do_QueryReferent(mWeakComposeObj, &amp;rv);</span>
<a href="#l17.4594"></a><span id="l17.4594" class="difflineminus">-  if (msgCompose)</span>
<a href="#l17.4595"></a><span id="l17.4595" class="difflineminus">-  {</span>
<a href="#l17.4596"></a><span id="l17.4596" class="difflineplus">+  if (msgCompose) {</span>
<a href="#l17.4597"></a><span id="l17.4597">     if (mDeliverMode == nsIMsgSend::nsMsgQueueForLater ||</span>
<a href="#l17.4598"></a><span id="l17.4598">         mDeliverMode == nsIMsgSend::nsMsgDeliverBackground ||</span>
<a href="#l17.4599"></a><span id="l17.4599" class="difflineminus">-        mDeliverMode == nsIMsgSend::nsMsgSaveAsDraft)</span>
<a href="#l17.4600"></a><span id="l17.4600" class="difflineminus">-    {</span>
<a href="#l17.4601"></a><span id="l17.4601" class="difflineplus">+        mDeliverMode == nsIMsgSend::nsMsgSaveAsDraft) {</span>
<a href="#l17.4602"></a><span id="l17.4602">       msgCompose-&gt;RememberQueuedDisposition();</span>
<a href="#l17.4603"></a><span id="l17.4603">     }</span>
<a href="#l17.4604"></a><span id="l17.4604"> </span>
<a href="#l17.4605"></a><span id="l17.4605">     // Ok, if we are here, we are done with the send/copy operation so</span>
<a href="#l17.4606"></a><span id="l17.4606">     // we have to do something with the window....SHOW if failed, Close</span>
<a href="#l17.4607"></a><span id="l17.4607">     // if succeeded</span>
<a href="#l17.4608"></a><span id="l17.4608"> </span>
<a href="#l17.4609"></a><span id="l17.4609">     nsCOMPtr&lt;nsIMsgProgress&gt; progress;</span>
<a href="#l17.4610"></a><span id="l17.4610">     msgCompose-&gt;GetProgress(getter_AddRefs(progress));</span>
<a href="#l17.4611"></a><span id="l17.4611" class="difflineminus">-    if (progress)</span>
<a href="#l17.4612"></a><span id="l17.4612" class="difflineminus">-    {</span>
<a href="#l17.4613"></a><span id="l17.4613" class="difflineplus">+    if (progress) {</span>
<a href="#l17.4614"></a><span id="l17.4614">       // Unregister ourself from msg compose progress</span>
<a href="#l17.4615"></a><span id="l17.4615">       progress-&gt;UnregisterListener(this);</span>
<a href="#l17.4616"></a><span id="l17.4616">       progress-&gt;CloseProgressDialog(NS_FAILED(aStatus));</span>
<a href="#l17.4617"></a><span id="l17.4617">     }</span>
<a href="#l17.4618"></a><span id="l17.4618"> </span>
<a href="#l17.4619"></a><span id="l17.4619" class="difflineminus">-    msgCompose-&gt;NotifyStateListeners(nsIMsgComposeNotificationType::ComposeProcessDone, aStatus);</span>
<a href="#l17.4620"></a><span id="l17.4620" class="difflineminus">-</span>
<a href="#l17.4621"></a><span id="l17.4621" class="difflineminus">-    if (NS_SUCCEEDED(aStatus))</span>
<a href="#l17.4622"></a><span id="l17.4622" class="difflineminus">-    {</span>
<a href="#l17.4623"></a><span id="l17.4623" class="difflineplus">+    msgCompose-&gt;NotifyStateListeners(</span>
<a href="#l17.4624"></a><span id="l17.4624" class="difflineplus">+        nsIMsgComposeNotificationType::ComposeProcessDone, aStatus);</span>
<a href="#l17.4625"></a><span id="l17.4625" class="difflineplus">+</span>
<a href="#l17.4626"></a><span id="l17.4626" class="difflineplus">+    if (NS_SUCCEEDED(aStatus)) {</span>
<a href="#l17.4627"></a><span id="l17.4627">       // We should only close the window if we are done. Things like templates</span>
<a href="#l17.4628"></a><span id="l17.4628">       // and drafts aren't done so their windows should stay open</span>
<a href="#l17.4629"></a><span id="l17.4629">       if (mDeliverMode == nsIMsgSend::nsMsgSaveAsDraft ||</span>
<a href="#l17.4630"></a><span id="l17.4630" class="difflineminus">-          mDeliverMode == nsIMsgSend::nsMsgSaveAsTemplate)</span>
<a href="#l17.4631"></a><span id="l17.4631" class="difflineminus">-      {</span>
<a href="#l17.4632"></a><span id="l17.4632" class="difflineminus">-        msgCompose-&gt;NotifyStateListeners(nsIMsgComposeNotificationType::SaveInFolderDone, aStatus);</span>
<a href="#l17.4633"></a><span id="l17.4633" class="difflineplus">+          mDeliverMode == nsIMsgSend::nsMsgSaveAsTemplate) {</span>
<a href="#l17.4634"></a><span id="l17.4634" class="difflineplus">+        msgCompose-&gt;NotifyStateListeners(</span>
<a href="#l17.4635"></a><span id="l17.4635" class="difflineplus">+            nsIMsgComposeNotificationType::SaveInFolderDone, aStatus);</span>
<a href="#l17.4636"></a><span id="l17.4636">         // Remove the current draft msg when saving as draft/template is done.</span>
<a href="#l17.4637"></a><span id="l17.4637">         msgCompose-&gt;SetDeleteDraft(true);</span>
<a href="#l17.4638"></a><span id="l17.4638" class="difflineminus">-        RemoveCurrentDraftMessage(msgCompose, true, mDeliverMode == nsIMsgSend::nsMsgSaveAsTemplate);</span>
<a href="#l17.4639"></a><span id="l17.4639" class="difflineminus">-      }</span>
<a href="#l17.4640"></a><span id="l17.4640" class="difflineminus">-      else</span>
<a href="#l17.4641"></a><span id="l17.4641" class="difflineminus">-      {</span>
<a href="#l17.4642"></a><span id="l17.4642" class="difflineplus">+        RemoveCurrentDraftMessage(</span>
<a href="#l17.4643"></a><span id="l17.4643" class="difflineplus">+            msgCompose, true, mDeliverMode == nsIMsgSend::nsMsgSaveAsTemplate);</span>
<a href="#l17.4644"></a><span id="l17.4644" class="difflineplus">+      } else {</span>
<a href="#l17.4645"></a><span id="l17.4645">         // Remove (possible) draft if we're in send later mode</span>
<a href="#l17.4646"></a><span id="l17.4646">         if (mDeliverMode == nsIMsgSend::nsMsgQueueForLater ||</span>
<a href="#l17.4647"></a><span id="l17.4647" class="difflineminus">-            mDeliverMode == nsIMsgSend::nsMsgDeliverBackground)</span>
<a href="#l17.4648"></a><span id="l17.4648" class="difflineminus">-        {</span>
<a href="#l17.4649"></a><span id="l17.4649" class="difflineplus">+            mDeliverMode == nsIMsgSend::nsMsgDeliverBackground) {</span>
<a href="#l17.4650"></a><span id="l17.4650">           msgCompose-&gt;SetDeleteDraft(true);</span>
<a href="#l17.4651"></a><span id="l17.4651">           RemoveCurrentDraftMessage(msgCompose, true, false);</span>
<a href="#l17.4652"></a><span id="l17.4652">         }</span>
<a href="#l17.4653"></a><span id="l17.4653">         msgCompose-&gt;CloseWindow();</span>
<a href="#l17.4654"></a><span id="l17.4654">       }</span>
<a href="#l17.4655"></a><span id="l17.4655">     }</span>
<a href="#l17.4656"></a><span id="l17.4656">     msgCompose-&gt;ClearMessageSend();</span>
<a href="#l17.4657"></a><span id="l17.4657">   }</span>
<a href="#l17.4658"></a><span id="l17.4658"> </span>
<a href="#l17.4659"></a><span id="l17.4659">   return rv;</span>
<a href="#l17.4660"></a><span id="l17.4660"> }</span>
<a href="#l17.4661"></a><span id="l17.4661"> </span>
<a href="#l17.4662"></a><span id="l17.4662" class="difflineminus">-nsresult</span>
<a href="#l17.4663"></a><span id="l17.4663" class="difflineminus">-nsMsgComposeSendListener::GetMsgFolder(nsIMsgCompose *compObj, nsIMsgFolder **msgFolder)</span>
<a href="#l17.4664"></a><span id="l17.4664" class="difflineminus">-{</span>
<a href="#l17.4665"></a><span id="l17.4665" class="difflineplus">+nsresult nsMsgComposeSendListener::GetMsgFolder(nsIMsgCompose *compObj,</span>
<a href="#l17.4666"></a><span id="l17.4666" class="difflineplus">+                                                nsIMsgFolder **msgFolder) {</span>
<a href="#l17.4667"></a><span id="l17.4667">   nsCString folderUri;</span>
<a href="#l17.4668"></a><span id="l17.4668"> </span>
<a href="#l17.4669"></a><span id="l17.4669">   nsresult rv = compObj-&gt;GetSavedFolderURI(getter_Copies(folderUri));</span>
<a href="#l17.4670"></a><span id="l17.4670">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.4671"></a><span id="l17.4671"> </span>
<a href="#l17.4672"></a><span id="l17.4672">   return GetOrCreateFolder(folderUri, msgFolder);</span>
<a href="#l17.4673"></a><span id="l17.4673"> }</span>
<a href="#l17.4674"></a><span id="l17.4674"> </span>
<a href="#l17.4675"></a><span id="l17.4675" class="difflineminus">-nsresult</span>
<a href="#l17.4676"></a><span id="l17.4676" class="difflineminus">-nsMsgComposeSendListener::RemoveDraftOrTemplate(nsIMsgCompose *compObj, nsCString msgURI, bool isSaveTemplate)</span>
<a href="#l17.4677"></a><span id="l17.4677" class="difflineminus">-{</span>
<a href="#l17.4678"></a><span id="l17.4678" class="difflineplus">+nsresult nsMsgComposeSendListener::RemoveDraftOrTemplate(nsIMsgCompose *compObj,</span>
<a href="#l17.4679"></a><span id="l17.4679" class="difflineplus">+                                                         nsCString msgURI,</span>
<a href="#l17.4680"></a><span id="l17.4680" class="difflineplus">+                                                         bool isSaveTemplate) {</span>
<a href="#l17.4681"></a><span id="l17.4681">   nsresult rv;</span>
<a href="#l17.4682"></a><span id="l17.4682">   nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l17.4683"></a><span id="l17.4683">   nsCOMPtr&lt;nsIMsgDBHdr&gt; msgDBHdr;</span>
<a href="#l17.4684"></a><span id="l17.4684">   rv = GetMsgDBHdrFromURI(msgURI.get(), getter_AddRefs(msgDBHdr));</span>
<a href="#l17.4685"></a><span id="l17.4685" class="difflineminus">-  NS_ASSERTION(NS_SUCCEEDED(rv), &quot;RemoveDraftOrTemplate can't get msg header DB interface pointer&quot;);</span>
<a href="#l17.4686"></a><span id="l17.4686" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; msgDBHdr)</span>
<a href="#l17.4687"></a><span id="l17.4687" class="difflineminus">-  {</span>
<a href="#l17.4688"></a><span id="l17.4688" class="difflineminus">-    do { // Break on failure or removal not needed.</span>
<a href="#l17.4689"></a><span id="l17.4689" class="difflineplus">+  NS_ASSERTION(</span>
<a href="#l17.4690"></a><span id="l17.4690" class="difflineplus">+      NS_SUCCEEDED(rv),</span>
<a href="#l17.4691"></a><span id="l17.4691" class="difflineplus">+      &quot;RemoveDraftOrTemplate can't get msg header DB interface pointer&quot;);</span>
<a href="#l17.4692"></a><span id="l17.4692" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; msgDBHdr) {</span>
<a href="#l17.4693"></a><span id="l17.4693" class="difflineplus">+    do {  // Break on failure or removal not needed.</span>
<a href="#l17.4694"></a><span id="l17.4694">       // Get the folder for the message resource.</span>
<a href="#l17.4695"></a><span id="l17.4695">       rv = msgDBHdr-&gt;GetFolder(getter_AddRefs(msgFolder));</span>
<a href="#l17.4696"></a><span id="l17.4696" class="difflineminus">-      NS_ASSERTION(NS_SUCCEEDED(rv), &quot;RemoveDraftOrTemplate can't get msg folder interface pointer&quot;);</span>
<a href="#l17.4697"></a><span id="l17.4697" class="difflineminus">-      if (NS_FAILED(rv) || !msgFolder)</span>
<a href="#l17.4698"></a><span id="l17.4698" class="difflineminus">-        break;</span>
<a href="#l17.4699"></a><span id="l17.4699" class="difflineplus">+      NS_ASSERTION(</span>
<a href="#l17.4700"></a><span id="l17.4700" class="difflineplus">+          NS_SUCCEEDED(rv),</span>
<a href="#l17.4701"></a><span id="l17.4701" class="difflineplus">+          &quot;RemoveDraftOrTemplate can't get msg folder interface pointer&quot;);</span>
<a href="#l17.4702"></a><span id="l17.4702" class="difflineplus">+      if (NS_FAILED(rv) || !msgFolder) break;</span>
<a href="#l17.4703"></a><span id="l17.4703"> </span>
<a href="#l17.4704"></a><span id="l17.4704">       // Only do this if it's a drafts or templates folder.</span>
<a href="#l17.4705"></a><span id="l17.4705">       uint32_t flags;</span>
<a href="#l17.4706"></a><span id="l17.4706">       msgFolder-&gt;GetFlags(&amp;flags);</span>
<a href="#l17.4707"></a><span id="l17.4707">       if (!(flags &amp; (nsMsgFolderFlags::Drafts | nsMsgFolderFlags::Templates)))</span>
<a href="#l17.4708"></a><span id="l17.4708">         break;</span>
<a href="#l17.4709"></a><span id="l17.4709" class="difflineminus">-      // Only delete a template when saving a new one, never delete a template when sending.</span>
<a href="#l17.4710"></a><span id="l17.4710" class="difflineminus">-      if (!isSaveTemplate &amp;&amp; (flags &amp; nsMsgFolderFlags::Templates))</span>
<a href="#l17.4711"></a><span id="l17.4711" class="difflineminus">-        break;</span>
<a href="#l17.4712"></a><span id="l17.4712" class="difflineplus">+      // Only delete a template when saving a new one, never delete a template</span>
<a href="#l17.4713"></a><span id="l17.4713" class="difflineplus">+      // when sending.</span>
<a href="#l17.4714"></a><span id="l17.4714" class="difflineplus">+      if (!isSaveTemplate &amp;&amp; (flags &amp; nsMsgFolderFlags::Templates)) break;</span>
<a href="#l17.4715"></a><span id="l17.4715"> </span>
<a href="#l17.4716"></a><span id="l17.4716">       // Only remove if the message is actually in the db. It might have only</span>
<a href="#l17.4717"></a><span id="l17.4717">       // been in the use cache.</span>
<a href="#l17.4718"></a><span id="l17.4718">       nsMsgKey key;</span>
<a href="#l17.4719"></a><span id="l17.4719">       rv = msgDBHdr-&gt;GetMessageKey(&amp;key);</span>
<a href="#l17.4720"></a><span id="l17.4720" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l17.4721"></a><span id="l17.4721" class="difflineminus">-        break;</span>
<a href="#l17.4722"></a><span id="l17.4722" class="difflineplus">+      if (NS_FAILED(rv)) break;</span>
<a href="#l17.4723"></a><span id="l17.4723">       nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l17.4724"></a><span id="l17.4724">       msgFolder-&gt;GetMsgDatabase(getter_AddRefs(db));</span>
<a href="#l17.4725"></a><span id="l17.4725" class="difflineminus">-      if (!db)</span>
<a href="#l17.4726"></a><span id="l17.4726" class="difflineminus">-        break;</span>
<a href="#l17.4727"></a><span id="l17.4727" class="difflineplus">+      if (!db) break;</span>
<a href="#l17.4728"></a><span id="l17.4728">       bool containsKey = false;</span>
<a href="#l17.4729"></a><span id="l17.4729">       db-&gt;ContainsKey(key, &amp;containsKey);</span>
<a href="#l17.4730"></a><span id="l17.4730" class="difflineminus">-      if (!containsKey)</span>
<a href="#l17.4731"></a><span id="l17.4731" class="difflineminus">-        break;</span>
<a href="#l17.4732"></a><span id="l17.4732" class="difflineplus">+      if (!containsKey) break;</span>
<a href="#l17.4733"></a><span id="l17.4733"> </span>
<a href="#l17.4734"></a><span id="l17.4734">       // Build the msg array.</span>
<a href="#l17.4735"></a><span id="l17.4735" class="difflineminus">-      nsCOMPtr&lt;nsIMutableArray&gt; messageArray(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l17.4736"></a><span id="l17.4736" class="difflineminus">-      NS_ASSERTION(NS_SUCCEEDED(rv), &quot;RemoveDraftOrTemplate can't allocate array&quot;);</span>
<a href="#l17.4737"></a><span id="l17.4737" class="difflineminus">-      if (NS_FAILED(rv) || !messageArray)</span>
<a href="#l17.4738"></a><span id="l17.4738" class="difflineminus">-        break;</span>
<a href="#l17.4739"></a><span id="l17.4739" class="difflineplus">+      nsCOMPtr&lt;nsIMutableArray&gt; messageArray(</span>
<a href="#l17.4740"></a><span id="l17.4740" class="difflineplus">+          do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l17.4741"></a><span id="l17.4741" class="difflineplus">+      NS_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l17.4742"></a><span id="l17.4742" class="difflineplus">+                   &quot;RemoveDraftOrTemplate can't allocate array&quot;);</span>
<a href="#l17.4743"></a><span id="l17.4743" class="difflineplus">+      if (NS_FAILED(rv) || !messageArray) break;</span>
<a href="#l17.4744"></a><span id="l17.4744">       rv = messageArray-&gt;AppendElement(msgDBHdr);</span>
<a href="#l17.4745"></a><span id="l17.4745" class="difflineminus">-      NS_ASSERTION(NS_SUCCEEDED(rv), &quot;RemoveDraftOrTemplate can't append msg header to array&quot;);</span>
<a href="#l17.4746"></a><span id="l17.4746" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l17.4747"></a><span id="l17.4747" class="difflineminus">-        break;</span>
<a href="#l17.4748"></a><span id="l17.4748" class="difflineplus">+      NS_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l17.4749"></a><span id="l17.4749" class="difflineplus">+                   &quot;RemoveDraftOrTemplate can't append msg header to array&quot;);</span>
<a href="#l17.4750"></a><span id="l17.4750" class="difflineplus">+      if (NS_FAILED(rv)) break;</span>
<a href="#l17.4751"></a><span id="l17.4751"> </span>
<a href="#l17.4752"></a><span id="l17.4752">       // Ready to delete the msg.</span>
<a href="#l17.4753"></a><span id="l17.4753" class="difflineminus">-      rv = msgFolder-&gt;DeleteMessages(messageArray, nullptr, true, false, nullptr, false /*allowUndo*/);</span>
<a href="#l17.4754"></a><span id="l17.4754" class="difflineminus">-      NS_ASSERTION(NS_SUCCEEDED(rv), &quot;RemoveDraftOrTemplate can't delete message&quot;);</span>
<a href="#l17.4755"></a><span id="l17.4755" class="difflineminus">-    } while(false);</span>
<a href="#l17.4756"></a><span id="l17.4756" class="difflineminus">-  }</span>
<a href="#l17.4757"></a><span id="l17.4757" class="difflineminus">-  else</span>
<a href="#l17.4758"></a><span id="l17.4758" class="difflineminus">-  {</span>
<a href="#l17.4759"></a><span id="l17.4759" class="difflineminus">-    // If we get here we have the case where the draft folder is on the server and</span>
<a href="#l17.4760"></a><span id="l17.4760" class="difflineminus">-    // it's not currently open (in thread pane), so draft msgs are saved to the server</span>
<a href="#l17.4761"></a><span id="l17.4761" class="difflineminus">-    // but they're not in our local DB. In this case, GetMsgDBHdrFromURI() will never</span>
<a href="#l17.4762"></a><span id="l17.4762" class="difflineminus">-    // find the msg. If the draft folder is a local one then we'll not get here because</span>
<a href="#l17.4763"></a><span id="l17.4763" class="difflineminus">-    // the draft msgs are saved to the local folder and are in local DB. Make sure the</span>
<a href="#l17.4764"></a><span id="l17.4764" class="difflineminus">-    // msg folder is imap.  Even if we get here due to DB errors (worst case), we should</span>
<a href="#l17.4765"></a><span id="l17.4765" class="difflineminus">-    // still try to delete msg on the server because that's where the master copy of the</span>
<a href="#l17.4766"></a><span id="l17.4766" class="difflineminus">-    // msgs are stored, if draft folder is on the server.</span>
<a href="#l17.4767"></a><span id="l17.4767" class="difflineminus">-    // For local case, since DB is bad we can't do anything with it anyway so it'll be</span>
<a href="#l17.4768"></a><span id="l17.4768" class="difflineminus">-    // noop in this case.</span>
<a href="#l17.4769"></a><span id="l17.4769" class="difflineplus">+      rv = msgFolder-&gt;DeleteMessages(messageArray, nullptr, true, false,</span>
<a href="#l17.4770"></a><span id="l17.4770" class="difflineplus">+                                     nullptr, false /*allowUndo*/);</span>
<a href="#l17.4771"></a><span id="l17.4771" class="difflineplus">+      NS_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l17.4772"></a><span id="l17.4772" class="difflineplus">+                   &quot;RemoveDraftOrTemplate can't delete message&quot;);</span>
<a href="#l17.4773"></a><span id="l17.4773" class="difflineplus">+    } while (false);</span>
<a href="#l17.4774"></a><span id="l17.4774" class="difflineplus">+  } else {</span>
<a href="#l17.4775"></a><span id="l17.4775" class="difflineplus">+    // If we get here we have the case where the draft folder is on the server</span>
<a href="#l17.4776"></a><span id="l17.4776" class="difflineplus">+    // and it's not currently open (in thread pane), so draft msgs are saved to</span>
<a href="#l17.4777"></a><span id="l17.4777" class="difflineplus">+    // the server but they're not in our local DB. In this case,</span>
<a href="#l17.4778"></a><span id="l17.4778" class="difflineplus">+    // GetMsgDBHdrFromURI() will never find the msg. If the draft folder is a</span>
<a href="#l17.4779"></a><span id="l17.4779" class="difflineplus">+    // local one then we'll not get here because the draft msgs are saved to the</span>
<a href="#l17.4780"></a><span id="l17.4780" class="difflineplus">+    // local folder and are in local DB. Make sure the msg folder is imap.  Even</span>
<a href="#l17.4781"></a><span id="l17.4781" class="difflineplus">+    // if we get here due to DB errors (worst case), we should still try to</span>
<a href="#l17.4782"></a><span id="l17.4782" class="difflineplus">+    // delete msg on the server because that's where the master copy of the msgs</span>
<a href="#l17.4783"></a><span id="l17.4783" class="difflineplus">+    // are stored, if draft folder is on the server. For local case, since DB is</span>
<a href="#l17.4784"></a><span id="l17.4784" class="difflineplus">+    // bad we can't do anything with it anyway so it'll be noop in this case.</span>
<a href="#l17.4785"></a><span id="l17.4785">     rv = GetMsgFolder(compObj, getter_AddRefs(msgFolder));</span>
<a href="#l17.4786"></a><span id="l17.4786" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; msgFolder)</span>
<a href="#l17.4787"></a><span id="l17.4787" class="difflineminus">-    {</span>
<a href="#l17.4788"></a><span id="l17.4788" class="difflineminus">-      nsCOMPtr &lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(msgFolder);</span>
<a href="#l17.4789"></a><span id="l17.4789" class="difflineminus">-      NS_ASSERTION(imapFolder, &quot;The draft folder MUST be an imap folder in order to mark the msg delete!&quot;);</span>
<a href="#l17.4790"></a><span id="l17.4790" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; imapFolder)</span>
<a href="#l17.4791"></a><span id="l17.4791" class="difflineminus">-      {</span>
<a href="#l17.4792"></a><span id="l17.4792" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; msgFolder) {</span>
<a href="#l17.4793"></a><span id="l17.4793" class="difflineplus">+      nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(msgFolder);</span>
<a href="#l17.4794"></a><span id="l17.4794" class="difflineplus">+      NS_ASSERTION(imapFolder,</span>
<a href="#l17.4795"></a><span id="l17.4795" class="difflineplus">+                   &quot;The draft folder MUST be an imap folder in order to mark &quot;</span>
<a href="#l17.4796"></a><span id="l17.4796" class="difflineplus">+                   &quot;the msg delete!&quot;);</span>
<a href="#l17.4797"></a><span id="l17.4797" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; imapFolder) {</span>
<a href="#l17.4798"></a><span id="l17.4798">         // Only do this if it's a drafts or templates folder.</span>
<a href="#l17.4799"></a><span id="l17.4799">         uint32_t flags;</span>
<a href="#l17.4800"></a><span id="l17.4800">         msgFolder-&gt;GetFlags(&amp;flags);</span>
<a href="#l17.4801"></a><span id="l17.4801">         if (!(flags &amp; (nsMsgFolderFlags::Drafts | nsMsgFolderFlags::Templates)))</span>
<a href="#l17.4802"></a><span id="l17.4802">           return NS_OK;</span>
<a href="#l17.4803"></a><span id="l17.4803" class="difflineminus">-        // Only delete a template when saving a new one, never delete a template when sending.</span>
<a href="#l17.4804"></a><span id="l17.4804" class="difflineplus">+        // Only delete a template when saving a new one, never delete a template</span>
<a href="#l17.4805"></a><span id="l17.4805" class="difflineplus">+        // when sending.</span>
<a href="#l17.4806"></a><span id="l17.4806">         if (!isSaveTemplate &amp;&amp; (flags &amp; nsMsgFolderFlags::Templates))</span>
<a href="#l17.4807"></a><span id="l17.4807">           return NS_OK;</span>
<a href="#l17.4808"></a><span id="l17.4808"> </span>
<a href="#l17.4809"></a><span id="l17.4809" class="difflineminus">-        const char * str = PL_strchr(msgURI.get(), '#');</span>
<a href="#l17.4810"></a><span id="l17.4810" class="difflineplus">+        const char *str = PL_strchr(msgURI.get(), '#');</span>
<a href="#l17.4811"></a><span id="l17.4811">         NS_ASSERTION(str, &quot;Failed to get current draft id url&quot;);</span>
<a href="#l17.4812"></a><span id="l17.4812" class="difflineminus">-        if (str)</span>
<a href="#l17.4813"></a><span id="l17.4813" class="difflineminus">-        {</span>
<a href="#l17.4814"></a><span id="l17.4814" class="difflineminus">-          nsAutoCString srcStr(str+1);</span>
<a href="#l17.4815"></a><span id="l17.4815" class="difflineplus">+        if (str) {</span>
<a href="#l17.4816"></a><span id="l17.4816" class="difflineplus">+          nsAutoCString srcStr(str + 1);</span>
<a href="#l17.4817"></a><span id="l17.4817">           nsresult err;</span>
<a href="#l17.4818"></a><span id="l17.4818">           nsMsgKey messageID = srcStr.ToInteger(&amp;err);</span>
<a href="#l17.4819"></a><span id="l17.4819" class="difflineminus">-          if (messageID != nsMsgKey_None)</span>
<a href="#l17.4820"></a><span id="l17.4820" class="difflineminus">-          {</span>
<a href="#l17.4821"></a><span id="l17.4821" class="difflineplus">+          if (messageID != nsMsgKey_None) {</span>
<a href="#l17.4822"></a><span id="l17.4822">             rv = imapFolder-&gt;StoreImapFlags(kImapMsgDeletedFlag, true,</span>
<a href="#l17.4823"></a><span id="l17.4823">                                             &amp;messageID, 1, nullptr);</span>
<a href="#l17.4824"></a><span id="l17.4824">           }</span>
<a href="#l17.4825"></a><span id="l17.4825">         }</span>
<a href="#l17.4826"></a><span id="l17.4826">       }</span>
<a href="#l17.4827"></a><span id="l17.4827">     }</span>
<a href="#l17.4828"></a><span id="l17.4828">   }</span>
<a href="#l17.4829"></a><span id="l17.4829"> </span>
<a href="#l17.4830"></a><span id="l17.4830">   return rv;</span>
<a href="#l17.4831"></a><span id="l17.4831"> }</span>
<a href="#l17.4832"></a><span id="l17.4832"> </span>
<a href="#l17.4833"></a><span id="l17.4833"> /**</span>
<a href="#l17.4834"></a><span id="l17.4834">  * Remove the current draft message since a new one will be saved.</span>
<a href="#l17.4835"></a><span id="l17.4835">  * When we're coming to save a template, also delete the original template.</span>
<a href="#l17.4836"></a><span id="l17.4836">  * This is necessary since auto-save doesn't delete the original template.</span>
<a href="#l17.4837"></a><span id="l17.4837">  */</span>
<a href="#l17.4838"></a><span id="l17.4838" class="difflineminus">-nsresult</span>
<a href="#l17.4839"></a><span id="l17.4839" class="difflineminus">-nsMsgComposeSendListener::RemoveCurrentDraftMessage(nsIMsgCompose *compObj, bool calledByCopy, bool isSaveTemplate)</span>
<a href="#l17.4840"></a><span id="l17.4840" class="difflineminus">-{</span>
<a href="#l17.4841"></a><span id="l17.4841" class="difflineplus">+nsresult nsMsgComposeSendListener::RemoveCurrentDraftMessage(</span>
<a href="#l17.4842"></a><span id="l17.4842" class="difflineplus">+    nsIMsgCompose *compObj, bool calledByCopy, bool isSaveTemplate) {</span>
<a href="#l17.4843"></a><span id="l17.4843">   nsresult rv;</span>
<a href="#l17.4844"></a><span id="l17.4844" class="difflineminus">-  nsCOMPtr &lt;nsIMsgCompFields&gt; compFields = nullptr;</span>
<a href="#l17.4845"></a><span id="l17.4845" class="difflineplus">+  nsCOMPtr&lt;nsIMsgCompFields&gt; compFields = nullptr;</span>
<a href="#l17.4846"></a><span id="l17.4846"> </span>
<a href="#l17.4847"></a><span id="l17.4847">   rv = compObj-&gt;GetCompFields(getter_AddRefs(compFields));</span>
<a href="#l17.4848"></a><span id="l17.4848" class="difflineminus">-  NS_ASSERTION(NS_SUCCEEDED(rv), &quot;RemoveCurrentDraftMessage can't get compose fields&quot;);</span>
<a href="#l17.4849"></a><span id="l17.4849" class="difflineminus">-  if (NS_FAILED(rv) || !compFields)</span>
<a href="#l17.4850"></a><span id="l17.4850" class="difflineminus">-    return rv;</span>
<a href="#l17.4851"></a><span id="l17.4851" class="difflineplus">+  NS_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l17.4852"></a><span id="l17.4852" class="difflineplus">+               &quot;RemoveCurrentDraftMessage can't get compose fields&quot;);</span>
<a href="#l17.4853"></a><span id="l17.4853" class="difflineplus">+  if (NS_FAILED(rv) || !compFields) return rv;</span>
<a href="#l17.4854"></a><span id="l17.4854"> </span>
<a href="#l17.4855"></a><span id="l17.4855">   nsCString curDraftIdURL;</span>
<a href="#l17.4856"></a><span id="l17.4856">   rv = compFields-&gt;GetDraftId(getter_Copies(curDraftIdURL));</span>
<a href="#l17.4857"></a><span id="l17.4857" class="difflineminus">-  NS_ASSERTION(NS_SUCCEEDED(rv), &quot;RemoveCurrentDraftMessage can't get draft id&quot;);</span>
<a href="#l17.4858"></a><span id="l17.4858" class="difflineplus">+  NS_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l17.4859"></a><span id="l17.4859" class="difflineplus">+               &quot;RemoveCurrentDraftMessage can't get draft id&quot;);</span>
<a href="#l17.4860"></a><span id="l17.4860"> </span>
<a href="#l17.4861"></a><span id="l17.4861">   // Skip if no draft id (probably a new draft msg).</span>
<a href="#l17.4862"></a><span id="l17.4862">   if (NS_SUCCEEDED(rv) &amp;&amp; !curDraftIdURL.IsEmpty()) {</span>
<a href="#l17.4863"></a><span id="l17.4863">     rv = RemoveDraftOrTemplate(compObj, curDraftIdURL, isSaveTemplate);</span>
<a href="#l17.4864"></a><span id="l17.4864" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l17.4865"></a><span id="l17.4865" class="difflineminus">-      NS_WARNING(&quot;Removing current draft failed&quot;);</span>
<a href="#l17.4866"></a><span id="l17.4866" class="difflineplus">+    if (NS_FAILED(rv)) NS_WARNING(&quot;Removing current draft failed&quot;);</span>
<a href="#l17.4867"></a><span id="l17.4867">   }</span>
<a href="#l17.4868"></a><span id="l17.4868"> </span>
<a href="#l17.4869"></a><span id="l17.4869">   if (isSaveTemplate) {</span>
<a href="#l17.4870"></a><span id="l17.4870">     nsCString templateIdURL;</span>
<a href="#l17.4871"></a><span id="l17.4871">     rv = compFields-&gt;GetTemplateId(getter_Copies(templateIdURL));</span>
<a href="#l17.4872"></a><span id="l17.4872">     if (NS_SUCCEEDED(rv) &amp;&amp; !templateIdURL.Equals(curDraftIdURL)) {</span>
<a href="#l17.4873"></a><span id="l17.4873">       // Above we deleted an auto-saved draft, so here we need to delete</span>
<a href="#l17.4874"></a><span id="l17.4874">       // the original template.</span>
<a href="#l17.4875"></a><span id="l17.4875">       rv = RemoveDraftOrTemplate(compObj, templateIdURL, isSaveTemplate);</span>
<a href="#l17.4876"></a><span id="l17.4876" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l17.4877"></a><span id="l17.4877" class="difflineminus">-        NS_WARNING(&quot;Removing original template failed&quot;);</span>
<a href="#l17.4878"></a><span id="l17.4878" class="difflineplus">+      if (NS_FAILED(rv)) NS_WARNING(&quot;Removing original template failed&quot;);</span>
<a href="#l17.4879"></a><span id="l17.4879">     }</span>
<a href="#l17.4880"></a><span id="l17.4880">   }</span>
<a href="#l17.4881"></a><span id="l17.4881"> </span>
<a href="#l17.4882"></a><span id="l17.4882">   // Now get the new uid so that next save will remove the right msg</span>
<a href="#l17.4883"></a><span id="l17.4883">   // regardless whether or not the exiting msg can be deleted.</span>
<a href="#l17.4884"></a><span id="l17.4884" class="difflineminus">-  if (calledByCopy)</span>
<a href="#l17.4885"></a><span id="l17.4885" class="difflineminus">-  {</span>
<a href="#l17.4886"></a><span id="l17.4886" class="difflineplus">+  if (calledByCopy) {</span>
<a href="#l17.4887"></a><span id="l17.4887">     nsMsgKey newUid = 0;</span>
<a href="#l17.4888"></a><span id="l17.4888">     nsCOMPtr&lt;nsIMsgFolder&gt; savedToFolder;</span>
<a href="#l17.4889"></a><span id="l17.4889">     nsCOMPtr&lt;nsIMsgSend&gt; msgSend;</span>
<a href="#l17.4890"></a><span id="l17.4890">     rv = compObj-&gt;GetMessageSend(getter_AddRefs(msgSend));</span>
<a href="#l17.4891"></a><span id="l17.4891">     NS_ASSERTION(msgSend, &quot;RemoveCurrentDraftMessage msgSend is null.&quot;);</span>
<a href="#l17.4892"></a><span id="l17.4892" class="difflineminus">-    if (NS_FAILED(rv) || !msgSend)</span>
<a href="#l17.4893"></a><span id="l17.4893" class="difflineminus">-      return rv;</span>
<a href="#l17.4894"></a><span id="l17.4894" class="difflineplus">+    if (NS_FAILED(rv) || !msgSend) return rv;</span>
<a href="#l17.4895"></a><span id="l17.4895"> </span>
<a href="#l17.4896"></a><span id="l17.4896">     rv = msgSend-&gt;GetMessageKey(&amp;newUid);</span>
<a href="#l17.4897"></a><span id="l17.4897">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.4898"></a><span id="l17.4898"> </span>
<a href="#l17.4899"></a><span id="l17.4899">     // Make sure we have a folder interface pointer</span>
<a href="#l17.4900"></a><span id="l17.4900">     rv = GetMsgFolder(compObj, getter_AddRefs(savedToFolder));</span>
<a href="#l17.4901"></a><span id="l17.4901"> </span>
<a href="#l17.4902"></a><span id="l17.4902">     // Reset draft (uid) url with the new uid.</span>
<a href="#l17.4903"></a><span id="l17.4903" class="difflineminus">-    if (savedToFolder &amp;&amp; newUid != nsMsgKey_None)</span>
<a href="#l17.4904"></a><span id="l17.4904" class="difflineminus">-    {</span>
<a href="#l17.4905"></a><span id="l17.4905" class="difflineplus">+    if (savedToFolder &amp;&amp; newUid != nsMsgKey_None) {</span>
<a href="#l17.4906"></a><span id="l17.4906">       uint32_t folderFlags;</span>
<a href="#l17.4907"></a><span id="l17.4907">       savedToFolder-&gt;GetFlags(&amp;folderFlags);</span>
<a href="#l17.4908"></a><span id="l17.4908" class="difflineminus">-      if (folderFlags &amp; (nsMsgFolderFlags::Drafts | nsMsgFolderFlags::Templates))</span>
<a href="#l17.4909"></a><span id="l17.4909" class="difflineminus">-      {</span>
<a href="#l17.4910"></a><span id="l17.4910" class="difflineplus">+      if (folderFlags &amp;</span>
<a href="#l17.4911"></a><span id="l17.4911" class="difflineplus">+          (nsMsgFolderFlags::Drafts | nsMsgFolderFlags::Templates)) {</span>
<a href="#l17.4912"></a><span id="l17.4912">         nsCString newDraftIdURL;</span>
<a href="#l17.4913"></a><span id="l17.4913">         rv = savedToFolder-&gt;GenerateMessageURI(newUid, newDraftIdURL);</span>
<a href="#l17.4914"></a><span id="l17.4914">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.4915"></a><span id="l17.4915">         compFields-&gt;SetDraftId(newDraftIdURL.get());</span>
<a href="#l17.4916"></a><span id="l17.4916" class="difflineminus">-        if (isSaveTemplate)</span>
<a href="#l17.4917"></a><span id="l17.4917" class="difflineminus">-          compFields-&gt;SetTemplateId(newDraftIdURL.get());</span>
<a href="#l17.4918"></a><span id="l17.4918" class="difflineplus">+        if (isSaveTemplate) compFields-&gt;SetTemplateId(newDraftIdURL.get());</span>
<a href="#l17.4919"></a><span id="l17.4919">       }</span>
<a href="#l17.4920"></a><span id="l17.4920">     }</span>
<a href="#l17.4921"></a><span id="l17.4921">   }</span>
<a href="#l17.4922"></a><span id="l17.4922">   return rv;</span>
<a href="#l17.4923"></a><span id="l17.4923"> }</span>
<a href="#l17.4924"></a><span id="l17.4924"> </span>
<a href="#l17.4925"></a><span id="l17.4925" class="difflineminus">-nsresult</span>
<a href="#l17.4926"></a><span id="l17.4926" class="difflineminus">-nsMsgComposeSendListener::SetMessageKey(nsMsgKey aMessageKey)</span>
<a href="#l17.4927"></a><span id="l17.4927" class="difflineminus">-{</span>
<a href="#l17.4928"></a><span id="l17.4928" class="difflineplus">+nsresult nsMsgComposeSendListener::SetMessageKey(nsMsgKey aMessageKey) {</span>
<a href="#l17.4929"></a><span id="l17.4929" class="difflineplus">+  return NS_OK;</span>
<a href="#l17.4930"></a><span id="l17.4930" class="difflineplus">+}</span>
<a href="#l17.4931"></a><span id="l17.4931" class="difflineplus">+</span>
<a href="#l17.4932"></a><span id="l17.4932" class="difflineplus">+nsresult nsMsgComposeSendListener::GetMessageId(nsACString &amp;messageId) {</span>
<a href="#l17.4933"></a><span id="l17.4933">   return NS_OK;</span>
<a href="#l17.4934"></a><span id="l17.4934"> }</span>
<a href="#l17.4935"></a><span id="l17.4935"> </span>
<a href="#l17.4936"></a><span id="l17.4936" class="difflineminus">-nsresult</span>
<a href="#l17.4937"></a><span id="l17.4937" class="difflineminus">-nsMsgComposeSendListener::GetMessageId(nsACString&amp; messageId)</span>
<a href="#l17.4938"></a><span id="l17.4938" class="difflineminus">-{</span>
<a href="#l17.4939"></a><span id="l17.4939" class="difflineminus">-  return NS_OK;</span>
<a href="#l17.4940"></a><span id="l17.4940" class="difflineminus">-}</span>
<a href="#l17.4941"></a><span id="l17.4941" class="difflineminus">-</span>
<a href="#l17.4942"></a><span id="l17.4942" class="difflineminus">-/* void onStateChange (in nsIWebProgress aWebProgress, in nsIRequest aRequest, in unsigned long aStateFlags, in nsresult aStatus); */</span>
<a href="#l17.4943"></a><span id="l17.4943" class="difflineminus">-NS_IMETHODIMP nsMsgComposeSendListener::OnStateChange(nsIWebProgress *aWebProgress, nsIRequest *aRequest, uint32_t aStateFlags, nsresult aStatus)</span>
<a href="#l17.4944"></a><span id="l17.4944" class="difflineminus">-{</span>
<a href="#l17.4945"></a><span id="l17.4945" class="difflineminus">-  if (aStateFlags == nsIWebProgressListener::STATE_STOP)</span>
<a href="#l17.4946"></a><span id="l17.4946" class="difflineminus">-  {</span>
<a href="#l17.4947"></a><span id="l17.4947" class="difflineplus">+/* void onStateChange (in nsIWebProgress aWebProgress, in nsIRequest aRequest,</span>
<a href="#l17.4948"></a><span id="l17.4948" class="difflineplus">+ * in unsigned long aStateFlags, in nsresult aStatus); */</span>
<a href="#l17.4949"></a><span id="l17.4949" class="difflineplus">+NS_IMETHODIMP nsMsgComposeSendListener::OnStateChange(</span>
<a href="#l17.4950"></a><span id="l17.4950" class="difflineplus">+    nsIWebProgress *aWebProgress, nsIRequest *aRequest, uint32_t aStateFlags,</span>
<a href="#l17.4951"></a><span id="l17.4951" class="difflineplus">+    nsresult aStatus) {</span>
<a href="#l17.4952"></a><span id="l17.4952" class="difflineplus">+  if (aStateFlags == nsIWebProgressListener::STATE_STOP) {</span>
<a href="#l17.4953"></a><span id="l17.4953">     nsCOMPtr&lt;nsIMsgCompose&gt; msgCompose = do_QueryReferent(mWeakComposeObj);</span>
<a href="#l17.4954"></a><span id="l17.4954" class="difflineminus">-    if (msgCompose)</span>
<a href="#l17.4955"></a><span id="l17.4955" class="difflineminus">-    {</span>
<a href="#l17.4956"></a><span id="l17.4956" class="difflineplus">+    if (msgCompose) {</span>
<a href="#l17.4957"></a><span id="l17.4957">       nsCOMPtr&lt;nsIMsgProgress&gt; progress;</span>
<a href="#l17.4958"></a><span id="l17.4958">       msgCompose-&gt;GetProgress(getter_AddRefs(progress));</span>
<a href="#l17.4959"></a><span id="l17.4959"> </span>
<a href="#l17.4960"></a><span id="l17.4960">       // Time to stop any pending operation...</span>
<a href="#l17.4961"></a><span id="l17.4961" class="difflineminus">-      if (progress)</span>
<a href="#l17.4962"></a><span id="l17.4962" class="difflineminus">-      {</span>
<a href="#l17.4963"></a><span id="l17.4963" class="difflineplus">+      if (progress) {</span>
<a href="#l17.4964"></a><span id="l17.4964">         // Unregister ourself from msg compose progress</span>
<a href="#l17.4965"></a><span id="l17.4965">         progress-&gt;UnregisterListener(this);</span>
<a href="#l17.4966"></a><span id="l17.4966"> </span>
<a href="#l17.4967"></a><span id="l17.4967">         bool bCanceled = false;</span>
<a href="#l17.4968"></a><span id="l17.4968">         progress-&gt;GetProcessCanceledByUser(&amp;bCanceled);</span>
<a href="#l17.4969"></a><span id="l17.4969" class="difflineminus">-        if (bCanceled)</span>
<a href="#l17.4970"></a><span id="l17.4970" class="difflineminus">-        {</span>
<a href="#l17.4971"></a><span id="l17.4971" class="difflineplus">+        if (bCanceled) {</span>
<a href="#l17.4972"></a><span id="l17.4972">           nsresult rv;</span>
<a href="#l17.4973"></a><span id="l17.4973">           nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l17.4974"></a><span id="l17.4974" class="difflineminus">-            mozilla::services::GetStringBundleService();</span>
<a href="#l17.4975"></a><span id="l17.4975" class="difflineplus">+              mozilla::services::GetStringBundleService();</span>
<a href="#l17.4976"></a><span id="l17.4976">           NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l17.4977"></a><span id="l17.4977">           nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l17.4978"></a><span id="l17.4978">           rv = bundleService-&gt;CreateBundle(</span>
<a href="#l17.4979"></a><span id="l17.4979" class="difflineminus">-            &quot;chrome://messenger/locale/messengercompose/composeMsgs.properties&quot;,</span>
<a href="#l17.4980"></a><span id="l17.4980" class="difflineminus">-            getter_AddRefs(bundle));</span>
<a href="#l17.4981"></a><span id="l17.4981" class="difflineplus">+              &quot;chrome://messenger/locale/messengercompose/&quot;</span>
<a href="#l17.4982"></a><span id="l17.4982" class="difflineplus">+              &quot;composeMsgs.properties&quot;,</span>
<a href="#l17.4983"></a><span id="l17.4983" class="difflineplus">+              getter_AddRefs(bundle));</span>
<a href="#l17.4984"></a><span id="l17.4984">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.4985"></a><span id="l17.4985">           nsString msg;</span>
<a href="#l17.4986"></a><span id="l17.4986">           bundle-&gt;GetStringFromName(&quot;msgCancelling&quot;, msg);</span>
<a href="#l17.4987"></a><span id="l17.4987">           progress-&gt;OnStatusChange(nullptr, nullptr, NS_OK, msg.get());</span>
<a href="#l17.4988"></a><span id="l17.4988">         }</span>
<a href="#l17.4989"></a><span id="l17.4989">       }</span>
<a href="#l17.4990"></a><span id="l17.4990"> </span>
<a href="#l17.4991"></a><span id="l17.4991">       nsCOMPtr&lt;nsIMsgSend&gt; msgSend;</span>
<a href="#l17.4992"></a><span id="l17.4992">       msgCompose-&gt;GetMessageSend(getter_AddRefs(msgSend));</span>
<a href="#l17.4993"></a><span id="l17.4993" class="difflineminus">-      if (msgSend)</span>
<a href="#l17.4994"></a><span id="l17.4994" class="difflineminus">-        msgSend-&gt;Abort();</span>
<a href="#l17.4995"></a><span id="l17.4995" class="difflineplus">+      if (msgSend) msgSend-&gt;Abort();</span>
<a href="#l17.4996"></a><span id="l17.4996">     }</span>
<a href="#l17.4997"></a><span id="l17.4997">   }</span>
<a href="#l17.4998"></a><span id="l17.4998">   return NS_OK;</span>
<a href="#l17.4999"></a><span id="l17.4999"> }</span>
<a href="#l17.5000"></a><span id="l17.5000"> </span>
<a href="#l17.5001"></a><span id="l17.5001" class="difflineminus">-/* void onProgressChange (in nsIWebProgress aWebProgress, in nsIRequest aRequest, in long aCurSelfProgress, in long aMaxSelfProgress, in long aCurTotalProgress, in long aMaxTotalProgress); */</span>
<a href="#l17.5002"></a><span id="l17.5002" class="difflineminus">-NS_IMETHODIMP nsMsgComposeSendListener::OnProgressChange(nsIWebProgress *aWebProgress, nsIRequest *aRequest, int32_t aCurSelfProgress, int32_t aMaxSelfProgress, int32_t aCurTotalProgress, int32_t aMaxTotalProgress)</span>
<a href="#l17.5003"></a><span id="l17.5003" class="difflineminus">-{</span>
<a href="#l17.5004"></a><span id="l17.5004" class="difflineplus">+/* void onProgressChange (in nsIWebProgress aWebProgress, in nsIRequest</span>
<a href="#l17.5005"></a><span id="l17.5005" class="difflineplus">+ * aRequest, in long aCurSelfProgress, in long aMaxSelfProgress, in long</span>
<a href="#l17.5006"></a><span id="l17.5006" class="difflineplus">+ * aCurTotalProgress, in long aMaxTotalProgress); */</span>
<a href="#l17.5007"></a><span id="l17.5007" class="difflineplus">+NS_IMETHODIMP nsMsgComposeSendListener::OnProgressChange(</span>
<a href="#l17.5008"></a><span id="l17.5008" class="difflineplus">+    nsIWebProgress *aWebProgress, nsIRequest *aRequest,</span>
<a href="#l17.5009"></a><span id="l17.5009" class="difflineplus">+    int32_t aCurSelfProgress, int32_t aMaxSelfProgress,</span>
<a href="#l17.5010"></a><span id="l17.5010" class="difflineplus">+    int32_t aCurTotalProgress, int32_t aMaxTotalProgress) {</span>
<a href="#l17.5011"></a><span id="l17.5011">   /* Ignore this call */</span>
<a href="#l17.5012"></a><span id="l17.5012">   return NS_OK;</span>
<a href="#l17.5013"></a><span id="l17.5013"> }</span>
<a href="#l17.5014"></a><span id="l17.5014"> </span>
<a href="#l17.5015"></a><span id="l17.5015" class="difflineminus">-/* void onLocationChange (in nsIWebProgress aWebProgress, in nsIRequest aRequest, in nsIURI location, in unsigned long aFlags); */</span>
<a href="#l17.5016"></a><span id="l17.5016" class="difflineminus">-NS_IMETHODIMP nsMsgComposeSendListener::OnLocationChange(nsIWebProgress *aWebProgress, nsIRequest *aRequest, nsIURI *location, uint32_t aFlags)</span>
<a href="#l17.5017"></a><span id="l17.5017" class="difflineminus">-{</span>
<a href="#l17.5018"></a><span id="l17.5018" class="difflineplus">+/* void onLocationChange (in nsIWebProgress aWebProgress, in nsIRequest</span>
<a href="#l17.5019"></a><span id="l17.5019" class="difflineplus">+ * aRequest, in nsIURI location, in unsigned long aFlags); */</span>
<a href="#l17.5020"></a><span id="l17.5020" class="difflineplus">+NS_IMETHODIMP nsMsgComposeSendListener::OnLocationChange(</span>
<a href="#l17.5021"></a><span id="l17.5021" class="difflineplus">+    nsIWebProgress *aWebProgress, nsIRequest *aRequest, nsIURI *location,</span>
<a href="#l17.5022"></a><span id="l17.5022" class="difflineplus">+    uint32_t aFlags) {</span>
<a href="#l17.5023"></a><span id="l17.5023">   /* Ignore this call */</span>
<a href="#l17.5024"></a><span id="l17.5024">   return NS_OK;</span>
<a href="#l17.5025"></a><span id="l17.5025"> }</span>
<a href="#l17.5026"></a><span id="l17.5026"> </span>
<a href="#l17.5027"></a><span id="l17.5027" class="difflineminus">-/* void onStatusChange (in nsIWebProgress aWebProgress, in nsIRequest aRequest, in nsresult aStatus, in wstring aMessage); */</span>
<a href="#l17.5028"></a><span id="l17.5028" class="difflineminus">-NS_IMETHODIMP nsMsgComposeSendListener::OnStatusChange(nsIWebProgress *aWebProgress, nsIRequest *aRequest, nsresult aStatus, const char16_t *aMessage)</span>
<a href="#l17.5029"></a><span id="l17.5029" class="difflineminus">-{</span>
<a href="#l17.5030"></a><span id="l17.5030" class="difflineplus">+/* void onStatusChange (in nsIWebProgress aWebProgress, in nsIRequest aRequest,</span>
<a href="#l17.5031"></a><span id="l17.5031" class="difflineplus">+ * in nsresult aStatus, in wstring aMessage); */</span>
<a href="#l17.5032"></a><span id="l17.5032" class="difflineplus">+NS_IMETHODIMP nsMsgComposeSendListener::OnStatusChange(</span>
<a href="#l17.5033"></a><span id="l17.5033" class="difflineplus">+    nsIWebProgress *aWebProgress, nsIRequest *aRequest, nsresult aStatus,</span>
<a href="#l17.5034"></a><span id="l17.5034" class="difflineplus">+    const char16_t *aMessage) {</span>
<a href="#l17.5035"></a><span id="l17.5035">   /* Ignore this call */</span>
<a href="#l17.5036"></a><span id="l17.5036">   return NS_OK;</span>
<a href="#l17.5037"></a><span id="l17.5037"> }</span>
<a href="#l17.5038"></a><span id="l17.5038"> </span>
<a href="#l17.5039"></a><span id="l17.5039" class="difflineminus">-/* void onSecurityChange (in nsIWebProgress aWebProgress, in nsIRequest aRequest, in unsigned long state); */</span>
<a href="#l17.5040"></a><span id="l17.5040" class="difflineminus">-NS_IMETHODIMP nsMsgComposeSendListener::OnSecurityChange(nsIWebProgress *aWebProgress, nsIRequest *aRequest, uint32_t state)</span>
<a href="#l17.5041"></a><span id="l17.5041" class="difflineminus">-{</span>
<a href="#l17.5042"></a><span id="l17.5042" class="difflineplus">+/* void onSecurityChange (in nsIWebProgress aWebProgress, in nsIRequest</span>
<a href="#l17.5043"></a><span id="l17.5043" class="difflineplus">+ * aRequest, in unsigned long state); */</span>
<a href="#l17.5044"></a><span id="l17.5044" class="difflineplus">+NS_IMETHODIMP nsMsgComposeSendListener::OnSecurityChange(</span>
<a href="#l17.5045"></a><span id="l17.5045" class="difflineplus">+    nsIWebProgress *aWebProgress, nsIRequest *aRequest, uint32_t state) {</span>
<a href="#l17.5046"></a><span id="l17.5046">   /* Ignore this call */</span>
<a href="#l17.5047"></a><span id="l17.5047">   return NS_OK;</span>
<a href="#l17.5048"></a><span id="l17.5048"> }</span>
<a href="#l17.5049"></a><span id="l17.5049"> </span>
<a href="#l17.5050"></a><span id="l17.5050"> NS_IMETHODIMP</span>
<a href="#l17.5051"></a><span id="l17.5051"> nsMsgComposeSendListener::OnContentBlockingEvent(nsIWebProgress *aWebProgress,</span>
<a href="#l17.5052"></a><span id="l17.5052" class="difflineminus">-                                                 nsIRequest *aRequest, uint32_t aEvent)</span>
<a href="#l17.5053"></a><span id="l17.5053" class="difflineminus">-{</span>
<a href="#l17.5054"></a><span id="l17.5054" class="difflineplus">+                                                 nsIRequest *aRequest,</span>
<a href="#l17.5055"></a><span id="l17.5055" class="difflineplus">+                                                 uint32_t aEvent) {</span>
<a href="#l17.5056"></a><span id="l17.5056">   /* Ignore this call */</span>
<a href="#l17.5057"></a><span id="l17.5057">   return NS_OK;</span>
<a href="#l17.5058"></a><span id="l17.5058"> }</span>
<a href="#l17.5059"></a><span id="l17.5059"> </span>
<a href="#l17.5060"></a><span id="l17.5060" class="difflineminus">-nsresult</span>
<a href="#l17.5061"></a><span id="l17.5061" class="difflineminus">-nsMsgCompose::ConvertHTMLToText(nsIFile *aSigFile, nsString &amp;aSigData)</span>
<a href="#l17.5062"></a><span id="l17.5062" class="difflineminus">-{</span>
<a href="#l17.5063"></a><span id="l17.5063" class="difflineplus">+nsresult nsMsgCompose::ConvertHTMLToText(nsIFile *aSigFile,</span>
<a href="#l17.5064"></a><span id="l17.5064" class="difflineplus">+                                         nsString &amp;aSigData) {</span>
<a href="#l17.5065"></a><span id="l17.5065">   nsAutoString origBuf;</span>
<a href="#l17.5066"></a><span id="l17.5066"> </span>
<a href="#l17.5067"></a><span id="l17.5067">   nsresult rv = LoadDataFromFile(aSigFile, origBuf);</span>
<a href="#l17.5068"></a><span id="l17.5068" class="difflineminus">-  NS_ENSURE_SUCCESS (rv, rv);</span>
<a href="#l17.5069"></a><span id="l17.5069" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.5070"></a><span id="l17.5070"> </span>
<a href="#l17.5071"></a><span id="l17.5071">   ConvertBufToPlainText(origBuf, false, false, true, true);</span>
<a href="#l17.5072"></a><span id="l17.5072">   aSigData = origBuf;</span>
<a href="#l17.5073"></a><span id="l17.5073">   return NS_OK;</span>
<a href="#l17.5074"></a><span id="l17.5074"> }</span>
<a href="#l17.5075"></a><span id="l17.5075"> </span>
<a href="#l17.5076"></a><span id="l17.5076" class="difflineminus">-nsresult</span>
<a href="#l17.5077"></a><span id="l17.5077" class="difflineminus">-nsMsgCompose::ConvertTextToHTML(nsIFile *aSigFile, nsString &amp;aSigData)</span>
<a href="#l17.5078"></a><span id="l17.5078" class="difflineminus">-{</span>
<a href="#l17.5079"></a><span id="l17.5079" class="difflineminus">-  nsresult    rv;</span>
<a href="#l17.5080"></a><span id="l17.5080" class="difflineminus">-  nsAutoString    origBuf;</span>
<a href="#l17.5081"></a><span id="l17.5081" class="difflineplus">+nsresult nsMsgCompose::ConvertTextToHTML(nsIFile *aSigFile,</span>
<a href="#l17.5082"></a><span id="l17.5082" class="difflineplus">+                                         nsString &amp;aSigData) {</span>
<a href="#l17.5083"></a><span id="l17.5083" class="difflineplus">+  nsresult rv;</span>
<a href="#l17.5084"></a><span id="l17.5084" class="difflineplus">+  nsAutoString origBuf;</span>
<a href="#l17.5085"></a><span id="l17.5085"> </span>
<a href="#l17.5086"></a><span id="l17.5086">   rv = LoadDataFromFile(aSigFile, origBuf);</span>
<a href="#l17.5087"></a><span id="l17.5087" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l17.5088"></a><span id="l17.5088" class="difflineminus">-    return rv;</span>
<a href="#l17.5089"></a><span id="l17.5089" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l17.5090"></a><span id="l17.5090"> </span>
<a href="#l17.5091"></a><span id="l17.5091">   // Ok, once we are here, we need to escape the data to make sure that</span>
<a href="#l17.5092"></a><span id="l17.5092">   // we don't do HTML stuff with plain text sigs.</span>
<a href="#l17.5093"></a><span id="l17.5093">   //</span>
<a href="#l17.5094"></a><span id="l17.5094">   nsCString escapedUTF8;</span>
<a href="#l17.5095"></a><span id="l17.5095">   nsAppendEscapedHTML(NS_ConvertUTF16toUTF8(origBuf), escapedUTF8);</span>
<a href="#l17.5096"></a><span id="l17.5096">   aSigData.Append(NS_ConvertUTF8toUTF16(escapedUTF8));</span>
<a href="#l17.5097"></a><span id="l17.5097"> </span>
<a href="#l17.5098"></a><span id="l17.5098">   return NS_OK;</span>
<a href="#l17.5099"></a><span id="l17.5099"> }</span>
<a href="#l17.5100"></a><span id="l17.5100"> </span>
<a href="#l17.5101"></a><span id="l17.5101" class="difflineminus">-nsresult</span>
<a href="#l17.5102"></a><span id="l17.5102" class="difflineminus">-nsMsgCompose::LoadDataFromFile(nsIFile *file, nsString &amp;sigData,</span>
<a href="#l17.5103"></a><span id="l17.5103" class="difflineminus">-                               bool aAllowUTF8, bool aAllowUTF16)</span>
<a href="#l17.5104"></a><span id="l17.5104" class="difflineminus">-{</span>
<a href="#l17.5105"></a><span id="l17.5105" class="difflineminus">-  int32_t       readSize;</span>
<a href="#l17.5106"></a><span id="l17.5106" class="difflineminus">-  uint32_t       nGot;</span>
<a href="#l17.5107"></a><span id="l17.5107" class="difflineminus">-  char          *readBuf;</span>
<a href="#l17.5108"></a><span id="l17.5108" class="difflineminus">-  char          *ptr;</span>
<a href="#l17.5109"></a><span id="l17.5109" class="difflineplus">+nsresult nsMsgCompose::LoadDataFromFile(nsIFile *file, nsString &amp;sigData,</span>
<a href="#l17.5110"></a><span id="l17.5110" class="difflineplus">+                                        bool aAllowUTF8, bool aAllowUTF16) {</span>
<a href="#l17.5111"></a><span id="l17.5111" class="difflineplus">+  int32_t readSize;</span>
<a href="#l17.5112"></a><span id="l17.5112" class="difflineplus">+  uint32_t nGot;</span>
<a href="#l17.5113"></a><span id="l17.5113" class="difflineplus">+  char *readBuf;</span>
<a href="#l17.5114"></a><span id="l17.5114" class="difflineplus">+  char *ptr;</span>
<a href="#l17.5115"></a><span id="l17.5115"> </span>
<a href="#l17.5116"></a><span id="l17.5116">   bool isDirectory = false;</span>
<a href="#l17.5117"></a><span id="l17.5117">   file-&gt;IsDirectory(&amp;isDirectory);</span>
<a href="#l17.5118"></a><span id="l17.5118">   if (isDirectory) {</span>
<a href="#l17.5119"></a><span id="l17.5119">     NS_ERROR(&quot;file is a directory&quot;);</span>
<a href="#l17.5120"></a><span id="l17.5120">     return NS_MSG_ERROR_READING_FILE;</span>
<a href="#l17.5121"></a><span id="l17.5121">   }</span>
<a href="#l17.5122"></a><span id="l17.5122"> </span>
<a href="#l17.5123"></a><span id="l17.5123" class="difflineminus">-</span>
<a href="#l17.5124"></a><span id="l17.5124" class="difflineminus">-  nsCOMPtr &lt;nsIInputStream&gt; inputFile;</span>
<a href="#l17.5125"></a><span id="l17.5125" class="difflineplus">+  nsCOMPtr&lt;nsIInputStream&gt; inputFile;</span>
<a href="#l17.5126"></a><span id="l17.5126">   nsresult rv = NS_NewLocalFileInputStream(getter_AddRefs(inputFile), file);</span>
<a href="#l17.5127"></a><span id="l17.5127" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l17.5128"></a><span id="l17.5128" class="difflineminus">-    return NS_MSG_ERROR_READING_FILE;</span>
<a href="#l17.5129"></a><span id="l17.5129" class="difflineplus">+  if (NS_FAILED(rv)) return NS_MSG_ERROR_READING_FILE;</span>
<a href="#l17.5130"></a><span id="l17.5130"> </span>
<a href="#l17.5131"></a><span id="l17.5131">   int64_t fileSize;</span>
<a href="#l17.5132"></a><span id="l17.5132">   file-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l17.5133"></a><span id="l17.5133" class="difflineminus">-  readSize = (uint32_t) fileSize;</span>
<a href="#l17.5134"></a><span id="l17.5134" class="difflineminus">-</span>
<a href="#l17.5135"></a><span id="l17.5135" class="difflineminus">-</span>
<a href="#l17.5136"></a><span id="l17.5136" class="difflineminus">-  ptr = readBuf = (char *)PR_Malloc(readSize + 1);  if (!readBuf)</span>
<a href="#l17.5137"></a><span id="l17.5137" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l17.5138"></a><span id="l17.5138" class="difflineplus">+  readSize = (uint32_t)fileSize;</span>
<a href="#l17.5139"></a><span id="l17.5139" class="difflineplus">+</span>
<a href="#l17.5140"></a><span id="l17.5140" class="difflineplus">+  ptr = readBuf = (char *)PR_Malloc(readSize + 1);</span>
<a href="#l17.5141"></a><span id="l17.5141" class="difflineplus">+  if (!readBuf) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l17.5142"></a><span id="l17.5142">   memset(readBuf, 0, readSize + 1);</span>
<a href="#l17.5143"></a><span id="l17.5143"> </span>
<a href="#l17.5144"></a><span id="l17.5144">   while (readSize) {</span>
<a href="#l17.5145"></a><span id="l17.5145">     inputFile-&gt;Read(ptr, readSize, &amp;nGot);</span>
<a href="#l17.5146"></a><span id="l17.5146">     if (nGot) {</span>
<a href="#l17.5147"></a><span id="l17.5147">       readSize -= nGot;</span>
<a href="#l17.5148"></a><span id="l17.5148">       ptr += nGot;</span>
<a href="#l17.5149"></a><span id="l17.5149" class="difflineminus">-    }</span>
<a href="#l17.5150"></a><span id="l17.5150" class="difflineminus">-    else {</span>
<a href="#l17.5151"></a><span id="l17.5151" class="difflineplus">+    } else {</span>
<a href="#l17.5152"></a><span id="l17.5152">       readSize = 0;</span>
<a href="#l17.5153"></a><span id="l17.5153">     }</span>
<a href="#l17.5154"></a><span id="l17.5154">   }</span>
<a href="#l17.5155"></a><span id="l17.5155">   inputFile-&gt;Close();</span>
<a href="#l17.5156"></a><span id="l17.5156"> </span>
<a href="#l17.5157"></a><span id="l17.5157" class="difflineminus">-  readSize = (uint32_t) fileSize;</span>
<a href="#l17.5158"></a><span id="l17.5158" class="difflineplus">+  readSize = (uint32_t)fileSize;</span>
<a href="#l17.5159"></a><span id="l17.5159"> </span>
<a href="#l17.5160"></a><span id="l17.5160">   nsAutoCString sigEncoding(nsMsgI18NParseMetaCharset(file));</span>
<a href="#l17.5161"></a><span id="l17.5161">   bool removeSigCharset = !sigEncoding.IsEmpty() &amp;&amp; m_composeHTML;</span>
<a href="#l17.5162"></a><span id="l17.5162"> </span>
<a href="#l17.5163"></a><span id="l17.5163">   if (sigEncoding.IsEmpty()) {</span>
<a href="#l17.5164"></a><span id="l17.5164">     if (aAllowUTF8 &amp;&amp; MsgIsUTF8(nsDependentCString(readBuf))) {</span>
<a href="#l17.5165"></a><span id="l17.5165">       sigEncoding.AssignLiteral(&quot;UTF-8&quot;);</span>
<a href="#l17.5166"></a><span id="l17.5166" class="difflineminus">-    }</span>
<a href="#l17.5167"></a><span id="l17.5167" class="difflineminus">-    else if (sigEncoding.IsEmpty() &amp;&amp; aAllowUTF16 &amp;&amp;</span>
<a href="#l17.5168"></a><span id="l17.5168" class="difflineminus">-             readSize % 2 == 0 &amp;&amp; readSize &gt;= 2 &amp;&amp;</span>
<a href="#l17.5169"></a><span id="l17.5169" class="difflineminus">-             ((readBuf[0] == char(0xFE) &amp;&amp; readBuf[1] == char(0xFF)) ||</span>
<a href="#l17.5170"></a><span id="l17.5170" class="difflineminus">-              (readBuf[0] == char(0xFF) &amp;&amp; readBuf[1] == char(0xFE)))) {</span>
<a href="#l17.5171"></a><span id="l17.5171" class="difflineplus">+    } else if (sigEncoding.IsEmpty() &amp;&amp; aAllowUTF16 &amp;&amp; readSize % 2 == 0 &amp;&amp;</span>
<a href="#l17.5172"></a><span id="l17.5172" class="difflineplus">+               readSize &gt;= 2 &amp;&amp;</span>
<a href="#l17.5173"></a><span id="l17.5173" class="difflineplus">+               ((readBuf[0] == char(0xFE) &amp;&amp; readBuf[1] == char(0xFF)) ||</span>
<a href="#l17.5174"></a><span id="l17.5174" class="difflineplus">+                (readBuf[0] == char(0xFF) &amp;&amp; readBuf[1] == char(0xFE)))) {</span>
<a href="#l17.5175"></a><span id="l17.5175">       sigEncoding.AssignLiteral(&quot;UTF-16&quot;);</span>
<a href="#l17.5176"></a><span id="l17.5176" class="difflineminus">-    }</span>
<a href="#l17.5177"></a><span id="l17.5177" class="difflineminus">-    else {</span>
<a href="#l17.5178"></a><span id="l17.5178" class="difflineminus">-      //default to platform encoding for plain text files w/o meta charset</span>
<a href="#l17.5179"></a><span id="l17.5179" class="difflineplus">+    } else {</span>
<a href="#l17.5180"></a><span id="l17.5180" class="difflineplus">+      // default to platform encoding for plain text files w/o meta charset</span>
<a href="#l17.5181"></a><span id="l17.5181">       nsAutoCString textFileCharset;</span>
<a href="#l17.5182"></a><span id="l17.5182">       nsMsgI18NTextFileCharset(textFileCharset);</span>
<a href="#l17.5183"></a><span id="l17.5183">       sigEncoding.Assign(textFileCharset);</span>
<a href="#l17.5184"></a><span id="l17.5184">     }</span>
<a href="#l17.5185"></a><span id="l17.5185">   }</span>
<a href="#l17.5186"></a><span id="l17.5186"> </span>
<a href="#l17.5187"></a><span id="l17.5187" class="difflineminus">-  nsAutoCString readStr(readBuf, (int32_t) fileSize);</span>
<a href="#l17.5188"></a><span id="l17.5188" class="difflineplus">+  nsAutoCString readStr(readBuf, (int32_t)fileSize);</span>
<a href="#l17.5189"></a><span id="l17.5189">   PR_FREEIF(readBuf);</span>
<a href="#l17.5190"></a><span id="l17.5190"> </span>
<a href="#l17.5191"></a><span id="l17.5191">   // XXX: ^^^ could really use nsContentUtils::SlurpFileToString instead!</span>
<a href="#l17.5192"></a><span id="l17.5192"> </span>
<a href="#l17.5193"></a><span id="l17.5193">   if (NS_FAILED(nsMsgI18NConvertToUnicode(sigEncoding, readStr, sigData)))</span>
<a href="#l17.5194"></a><span id="l17.5194">     CopyASCIItoUTF16(readStr, sigData);</span>
<a href="#l17.5195"></a><span id="l17.5195"> </span>
<a href="#l17.5196"></a><span id="l17.5196" class="difflineminus">-  //remove sig meta charset to allow user charset override during composition</span>
<a href="#l17.5197"></a><span id="l17.5197" class="difflineminus">-  if (removeSigCharset)</span>
<a href="#l17.5198"></a><span id="l17.5198" class="difflineminus">-  {</span>
<a href="#l17.5199"></a><span id="l17.5199" class="difflineplus">+  // remove sig meta charset to allow user charset override during composition</span>
<a href="#l17.5200"></a><span id="l17.5200" class="difflineplus">+  if (removeSigCharset) {</span>
<a href="#l17.5201"></a><span id="l17.5201">     nsAutoCString metaCharset(&quot;charset=&quot;);</span>
<a href="#l17.5202"></a><span id="l17.5202">     metaCharset.Append(sigEncoding);</span>
<a href="#l17.5203"></a><span id="l17.5203">     int32_t pos = sigData.Find(metaCharset.BeginReading(), true);</span>
<a href="#l17.5204"></a><span id="l17.5204" class="difflineminus">-    if (pos != kNotFound)</span>
<a href="#l17.5205"></a><span id="l17.5205" class="difflineminus">-      sigData.Cut(pos, metaCharset.Length());</span>
<a href="#l17.5206"></a><span id="l17.5206" class="difflineplus">+    if (pos != kNotFound) sigData.Cut(pos, metaCharset.Length());</span>
<a href="#l17.5207"></a><span id="l17.5207">   }</span>
<a href="#l17.5208"></a><span id="l17.5208">   return NS_OK;</span>
<a href="#l17.5209"></a><span id="l17.5209"> }</span>
<a href="#l17.5210"></a><span id="l17.5210"> </span>
<a href="#l17.5211"></a><span id="l17.5211"> /**</span>
<a href="#l17.5212"></a><span id="l17.5212">  * If the data contains file URLs, convert them to data URLs instead.</span>
<a href="#l17.5213"></a><span id="l17.5213">  * This is intended to be used in for signature files, so that we can make sure</span>
<a href="#l17.5214"></a><span id="l17.5214">  * images loaded into the editor are available on send.</span>
<a href="#l17.5215"></a><span id="l17.5215">  */</span>
<a href="#l17.5216"></a><span id="l17.5216" class="difflineminus">-nsresult</span>
<a href="#l17.5217"></a><span id="l17.5217" class="difflineminus">-nsMsgCompose::ReplaceFileURLs(nsString &amp;aData)</span>
<a href="#l17.5218"></a><span id="l17.5218" class="difflineminus">-{</span>
<a href="#l17.5219"></a><span id="l17.5219" class="difflineplus">+nsresult nsMsgCompose::ReplaceFileURLs(nsString &amp;aData) {</span>
<a href="#l17.5220"></a><span id="l17.5220">   int32_t fPos;</span>
<a href="#l17.5221"></a><span id="l17.5221" class="difflineminus">-  int32_t offset = -1;  // We're using RFind(), so offset -1 is from the very right.</span>
<a href="#l17.5222"></a><span id="l17.5222" class="difflineplus">+  // We're using RFind(), so offset -1 is from the very right.</span>
<a href="#l17.5223"></a><span id="l17.5223" class="difflineplus">+  int32_t offset = -1;</span>
<a href="#l17.5224"></a><span id="l17.5224"> </span>
<a href="#l17.5225"></a><span id="l17.5225">   // XXX This code is rather incomplete since it looks for &quot;file://&quot; even</span>
<a href="#l17.5226"></a><span id="l17.5226">   // outside tags.</span>
<a href="#l17.5227"></a><span id="l17.5227">   while ((fPos = aData.RFind(&quot;file://&quot;, true, offset)) != kNotFound) {</span>
<a href="#l17.5228"></a><span id="l17.5228">     bool quoted = false;</span>
<a href="#l17.5229"></a><span id="l17.5229">     char16_t q = 'x';  // initialise to anything to keep compilers happy.</span>
<a href="#l17.5230"></a><span id="l17.5230">     if (fPos &gt; 0) {</span>
<a href="#l17.5231"></a><span id="l17.5231">       q = aData.CharAt(fPos - 1);</span>
<a href="#l17.5232"></a><span id="l17.5232">       quoted = (q == '&quot;' || q == '\'');</span>
<a href="#l17.5233"></a><span id="l17.5233">     }</span>
<a href="#l17.5234"></a><span id="l17.5234">     int32_t end = kNotFound;</span>
<a href="#l17.5235"></a><span id="l17.5235">     if (quoted) {</span>
<a href="#l17.5236"></a><span id="l17.5236">       end = aData.FindChar(q, fPos);</span>
<a href="#l17.5237"></a><span id="l17.5237" class="difflineminus">-    }</span>
<a href="#l17.5238"></a><span id="l17.5238" class="difflineminus">-    else {</span>
<a href="#l17.5239"></a><span id="l17.5239" class="difflineplus">+    } else {</span>
<a href="#l17.5240"></a><span id="l17.5240">       int32_t spacePos = aData.FindChar(' ', fPos);</span>
<a href="#l17.5241"></a><span id="l17.5241">       int32_t gtPos = aData.FindChar('&gt;', fPos);</span>
<a href="#l17.5242"></a><span id="l17.5242">       if (gtPos != kNotFound &amp;&amp; spacePos != kNotFound) {</span>
<a href="#l17.5243"></a><span id="l17.5243">         end = (spacePos &lt; gtPos) ? spacePos : gtPos;</span>
<a href="#l17.5244"></a><span id="l17.5244" class="difflineminus">-      }</span>
<a href="#l17.5245"></a><span id="l17.5245" class="difflineminus">-      else if (gtPos == kNotFound &amp;&amp; spacePos != kNotFound) {</span>
<a href="#l17.5246"></a><span id="l17.5246" class="difflineplus">+      } else if (gtPos == kNotFound &amp;&amp; spacePos != kNotFound) {</span>
<a href="#l17.5247"></a><span id="l17.5247">         end = spacePos;</span>
<a href="#l17.5248"></a><span id="l17.5248" class="difflineminus">-      }</span>
<a href="#l17.5249"></a><span id="l17.5249" class="difflineminus">-      else if (gtPos != kNotFound &amp;&amp; spacePos == kNotFound) {</span>
<a href="#l17.5250"></a><span id="l17.5250" class="difflineplus">+      } else if (gtPos != kNotFound &amp;&amp; spacePos == kNotFound) {</span>
<a href="#l17.5251"></a><span id="l17.5251">         end = gtPos;</span>
<a href="#l17.5252"></a><span id="l17.5252">       }</span>
<a href="#l17.5253"></a><span id="l17.5253">     }</span>
<a href="#l17.5254"></a><span id="l17.5254">     if (end == kNotFound) {</span>
<a href="#l17.5255"></a><span id="l17.5255">       break;</span>
<a href="#l17.5256"></a><span id="l17.5256">     }</span>
<a href="#l17.5257"></a><span id="l17.5257">     nsString fileURL;</span>
<a href="#l17.5258"></a><span id="l17.5258">     fileURL = Substring(aData, fPos, end - fPos);</span>
<a href="#l17.5259"></a><span id="l17.5259">     nsString dataURL;</span>
<a href="#l17.5260"></a><span id="l17.5260">     nsresult rv = DataURLForFileURL(fileURL, dataURL);</span>
<a href="#l17.5261"></a><span id="l17.5261">     // If this one failed, maybe because the file wasn't found,</span>
<a href="#l17.5262"></a><span id="l17.5262">     // continue to process the next one.</span>
<a href="#l17.5263"></a><span id="l17.5263">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l17.5264"></a><span id="l17.5264">       aData.Replace(fPos, end - fPos, dataURL);</span>
<a href="#l17.5265"></a><span id="l17.5265">     }</span>
<a href="#l17.5266"></a><span id="l17.5266" class="difflineminus">-    if (fPos == 0)</span>
<a href="#l17.5267"></a><span id="l17.5267" class="difflineminus">-      break;</span>
<a href="#l17.5268"></a><span id="l17.5268" class="difflineplus">+    if (fPos == 0) break;</span>
<a href="#l17.5269"></a><span id="l17.5269">     offset = fPos - 1;</span>
<a href="#l17.5270"></a><span id="l17.5270">   }</span>
<a href="#l17.5271"></a><span id="l17.5271">   return NS_OK;</span>
<a href="#l17.5272"></a><span id="l17.5272"> }</span>
<a href="#l17.5273"></a><span id="l17.5273"> </span>
<a href="#l17.5274"></a><span id="l17.5274" class="difflineminus">-nsresult</span>
<a href="#l17.5275"></a><span id="l17.5275" class="difflineminus">-nsMsgCompose::DataURLForFileURL(const nsAString &amp;aFileURL, nsAString &amp;aDataURL)</span>
<a href="#l17.5276"></a><span id="l17.5276" class="difflineminus">-{</span>
<a href="#l17.5277"></a><span id="l17.5277" class="difflineplus">+nsresult nsMsgCompose::DataURLForFileURL(const nsAString &amp;aFileURL,</span>
<a href="#l17.5278"></a><span id="l17.5278" class="difflineplus">+                                         nsAString &amp;aDataURL) {</span>
<a href="#l17.5279"></a><span id="l17.5279">   nsresult rv;</span>
<a href="#l17.5280"></a><span id="l17.5280">   nsCOMPtr&lt;nsIMIMEService&gt; mime = do_GetService(&quot;@mozilla.org/mime;1&quot;, &amp;rv);</span>
<a href="#l17.5281"></a><span id="l17.5281">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.5282"></a><span id="l17.5282"> </span>
<a href="#l17.5283"></a><span id="l17.5283">   nsCOMPtr&lt;nsIURI&gt; fileUri;</span>
<a href="#l17.5284"></a><span id="l17.5284" class="difflineminus">-  rv = NS_NewURI(getter_AddRefs(fileUri), NS_ConvertUTF16toUTF8(aFileURL).get());</span>
<a href="#l17.5285"></a><span id="l17.5285" class="difflineplus">+  rv =</span>
<a href="#l17.5286"></a><span id="l17.5286" class="difflineplus">+      NS_NewURI(getter_AddRefs(fileUri), NS_ConvertUTF16toUTF8(aFileURL).get());</span>
<a href="#l17.5287"></a><span id="l17.5287">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.5288"></a><span id="l17.5288"> </span>
<a href="#l17.5289"></a><span id="l17.5289">   nsCOMPtr&lt;nsIFileURL&gt; fileUrl(do_QueryInterface(fileUri, &amp;rv));</span>
<a href="#l17.5290"></a><span id="l17.5290">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.5291"></a><span id="l17.5291">   nsCOMPtr&lt;nsIFile&gt; file;</span>
<a href="#l17.5292"></a><span id="l17.5292">   rv = fileUrl-&gt;GetFile(getter_AddRefs(file));</span>
<a href="#l17.5293"></a><span id="l17.5293">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.5294"></a><span id="l17.5294"> </span>
<a href="#l17.5295"></a><span id="l17.5295" class="difflineat">@@ -4320,55 +3948,53 @@ nsMsgCompose::DataURLForFileURL(const ns</span>
<a href="#l17.5296"></a><span id="l17.5296"> </span>
<a href="#l17.5297"></a><span id="l17.5297">   aDataURL.AssignLiteral(&quot;data:&quot;);</span>
<a href="#l17.5298"></a><span id="l17.5298">   AppendUTF8toUTF16(type, aDataURL);</span>
<a href="#l17.5299"></a><span id="l17.5299"> </span>
<a href="#l17.5300"></a><span id="l17.5300">   nsAutoString filename;</span>
<a href="#l17.5301"></a><span id="l17.5301">   rv = file-&gt;GetLeafName(filename);</span>
<a href="#l17.5302"></a><span id="l17.5302">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l17.5303"></a><span id="l17.5303">     nsAutoCString fn;</span>
<a href="#l17.5304"></a><span id="l17.5304" class="difflineminus">-    MsgEscapeURL(NS_ConvertUTF16toUTF8(filename),</span>
<a href="#l17.5305"></a><span id="l17.5305" class="difflineminus">-      nsINetUtil::ESCAPE_URL_FILE_BASENAME | nsINetUtil::ESCAPE_URL_FORCED, fn);</span>
<a href="#l17.5306"></a><span id="l17.5306" class="difflineplus">+    MsgEscapeURL(</span>
<a href="#l17.5307"></a><span id="l17.5307" class="difflineplus">+        NS_ConvertUTF16toUTF8(filename),</span>
<a href="#l17.5308"></a><span id="l17.5308" class="difflineplus">+        nsINetUtil::ESCAPE_URL_FILE_BASENAME | nsINetUtil::ESCAPE_URL_FORCED,</span>
<a href="#l17.5309"></a><span id="l17.5309" class="difflineplus">+        fn);</span>
<a href="#l17.5310"></a><span id="l17.5310">     if (!fn.IsEmpty()) {</span>
<a href="#l17.5311"></a><span id="l17.5311">       aDataURL.AppendLiteral(&quot;;filename=&quot;);</span>
<a href="#l17.5312"></a><span id="l17.5312">       aDataURL.Append(NS_ConvertUTF8toUTF16(fn));</span>
<a href="#l17.5313"></a><span id="l17.5313">     }</span>
<a href="#l17.5314"></a><span id="l17.5314">   }</span>
<a href="#l17.5315"></a><span id="l17.5315"> </span>
<a href="#l17.5316"></a><span id="l17.5316">   aDataURL.AppendLiteral(&quot;;base64,&quot;);</span>
<a href="#l17.5317"></a><span id="l17.5317">   char *result = PL_Base64Encode(data.get(), data.Length(), nullptr);</span>
<a href="#l17.5318"></a><span id="l17.5318">   nsDependentCString base64data(result);</span>
<a href="#l17.5319"></a><span id="l17.5319">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.5320"></a><span id="l17.5320">   AppendUTF8toUTF16(base64data, aDataURL);</span>
<a href="#l17.5321"></a><span id="l17.5321">   return NS_OK;</span>
<a href="#l17.5322"></a><span id="l17.5322"> }</span>
<a href="#l17.5323"></a><span id="l17.5323"> </span>
<a href="#l17.5324"></a><span id="l17.5324" class="difflineminus">-nsresult</span>
<a href="#l17.5325"></a><span id="l17.5325" class="difflineminus">-nsMsgCompose::BuildQuotedMessageAndSignature(void)</span>
<a href="#l17.5326"></a><span id="l17.5326" class="difflineminus">-{</span>
<a href="#l17.5327"></a><span id="l17.5327" class="difflineplus">+nsresult nsMsgCompose::BuildQuotedMessageAndSignature(void) {</span>
<a href="#l17.5328"></a><span id="l17.5328">   //</span>
<a href="#l17.5329"></a><span id="l17.5329">   // This should never happen...if it does, just bail out...</span>
<a href="#l17.5330"></a><span id="l17.5330">   //</span>
<a href="#l17.5331"></a><span id="l17.5331">   NS_ASSERTION(m_editor, &quot;BuildQuotedMessageAndSignature but no editor!&quot;);</span>
<a href="#l17.5332"></a><span id="l17.5332" class="difflineminus">-  if (!m_editor)</span>
<a href="#l17.5333"></a><span id="l17.5333" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l17.5334"></a><span id="l17.5334" class="difflineplus">+  if (!m_editor) return NS_ERROR_FAILURE;</span>
<a href="#l17.5335"></a><span id="l17.5335"> </span>
<a href="#l17.5336"></a><span id="l17.5336">   // We will fire off the quote operation and wait for it to</span>
<a href="#l17.5337"></a><span id="l17.5337">   // finish before we actually do anything with Ender...</span>
<a href="#l17.5338"></a><span id="l17.5338">   return QuoteOriginalMessage();</span>
<a href="#l17.5339"></a><span id="l17.5339"> }</span>
<a href="#l17.5340"></a><span id="l17.5340"> </span>
<a href="#l17.5341"></a><span id="l17.5341"> //</span>
<a href="#l17.5342"></a><span id="l17.5342"> // This will process the signature file for the user. This method</span>
<a href="#l17.5343"></a><span id="l17.5343"> // will always append the results to the mMsgBody member variable.</span>
<a href="#l17.5344"></a><span id="l17.5344"> //</span>
<a href="#l17.5345"></a><span id="l17.5345" class="difflineminus">-nsresult</span>
<a href="#l17.5346"></a><span id="l17.5346" class="difflineminus">-nsMsgCompose::ProcessSignature(nsIMsgIdentity *identity, bool aQuoted, nsString *aMsgBody)</span>
<a href="#l17.5347"></a><span id="l17.5347" class="difflineminus">-{</span>
<a href="#l17.5348"></a><span id="l17.5348" class="difflineminus">-  nsresult    rv = NS_OK;</span>
<a href="#l17.5349"></a><span id="l17.5349" class="difflineplus">+nsresult nsMsgCompose::ProcessSignature(nsIMsgIdentity *identity, bool aQuoted,</span>
<a href="#l17.5350"></a><span id="l17.5350" class="difflineplus">+                                        nsString *aMsgBody) {</span>
<a href="#l17.5351"></a><span id="l17.5351" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l17.5352"></a><span id="l17.5352"> </span>
<a href="#l17.5353"></a><span id="l17.5353">   // Now, we can get sort of fancy. This is the time we need to check</span>
<a href="#l17.5354"></a><span id="l17.5354">   // for all sorts of user defined stuff, like signatures and editor</span>
<a href="#l17.5355"></a><span id="l17.5355">   // types and the like!</span>
<a href="#l17.5356"></a><span id="l17.5356">   //</span>
<a href="#l17.5357"></a><span id="l17.5357">   //    user_pref(&quot;.....sig_file&quot;, &quot;y:\\sig.html&quot;);</span>
<a href="#l17.5358"></a><span id="l17.5358">   //    user_pref(&quot;.....attach_signature&quot;, true);</span>
<a href="#l17.5359"></a><span id="l17.5359">   //    user_pref(&quot;.....htmlSigText&quot;, &quot;unicode sig&quot;);</span>
<a href="#l17.5360"></a><span id="l17.5360" class="difflineat">@@ -4378,111 +4004,107 @@ nsMsgCompose::ProcessSignature(nsIMsgIde</span>
<a href="#l17.5361"></a><span id="l17.5361">   // .html, we assume its HTML, otherwise, we assume it is plain text</span>
<a href="#l17.5362"></a><span id="l17.5362">   //</span>
<a href="#l17.5363"></a><span id="l17.5363">   // ...and that's not all! What we will also do now is look and see if</span>
<a href="#l17.5364"></a><span id="l17.5364">   // the file is an image file. If it is an image file, then we should</span>
<a href="#l17.5365"></a><span id="l17.5365">   // insert the correct HTML into the composer to have it work, but if we</span>
<a href="#l17.5366"></a><span id="l17.5366">   // are doing plain text compose, we should insert some sort of message</span>
<a href="#l17.5367"></a><span id="l17.5367">   // saying &quot;Image Signature Omitted&quot; or something (not done yet).</span>
<a href="#l17.5368"></a><span id="l17.5368">   //</span>
<a href="#l17.5369"></a><span id="l17.5369" class="difflineminus">-  // If there's a sig pref, it will only be used if there is no sig file defined,</span>
<a href="#l17.5370"></a><span id="l17.5370" class="difflineminus">-  // thus if attach_signature is checked, htmlSigText is ignored (bug 324495).</span>
<a href="#l17.5371"></a><span id="l17.5371" class="difflineminus">-  // Plain-text signatures may or may not have a trailing line break (bug 428040).</span>
<a href="#l17.5372"></a><span id="l17.5372" class="difflineminus">-</span>
<a href="#l17.5373"></a><span id="l17.5373" class="difflineminus">-  bool          attachFile = false;</span>
<a href="#l17.5374"></a><span id="l17.5374" class="difflineminus">-  bool          useSigFile = false;</span>
<a href="#l17.5375"></a><span id="l17.5375" class="difflineminus">-  bool          htmlSig = false;</span>
<a href="#l17.5376"></a><span id="l17.5376" class="difflineminus">-  bool          imageSig = false;</span>
<a href="#l17.5377"></a><span id="l17.5377" class="difflineminus">-  nsAutoString  sigData;</span>
<a href="#l17.5378"></a><span id="l17.5378" class="difflineplus">+  // If there's a sig pref, it will only be used if there is no sig file</span>
<a href="#l17.5379"></a><span id="l17.5379" class="difflineplus">+  // defined, thus if attach_signature is checked, htmlSigText is ignored (bug</span>
<a href="#l17.5380"></a><span id="l17.5380" class="difflineplus">+  // 324495). Plain-text signatures may or may not have a trailing line break</span>
<a href="#l17.5381"></a><span id="l17.5381" class="difflineplus">+  // (bug 428040).</span>
<a href="#l17.5382"></a><span id="l17.5382" class="difflineplus">+</span>
<a href="#l17.5383"></a><span id="l17.5383" class="difflineplus">+  bool attachFile = false;</span>
<a href="#l17.5384"></a><span id="l17.5384" class="difflineplus">+  bool useSigFile = false;</span>
<a href="#l17.5385"></a><span id="l17.5385" class="difflineplus">+  bool htmlSig = false;</span>
<a href="#l17.5386"></a><span id="l17.5386" class="difflineplus">+  bool imageSig = false;</span>
<a href="#l17.5387"></a><span id="l17.5387" class="difflineplus">+  nsAutoString sigData;</span>
<a href="#l17.5388"></a><span id="l17.5388">   nsAutoString sigOutput;</span>
<a href="#l17.5389"></a><span id="l17.5389" class="difflineminus">-  int32_t      reply_on_top = 0;</span>
<a href="#l17.5390"></a><span id="l17.5390" class="difflineminus">-  bool         sig_bottom = true;</span>
<a href="#l17.5391"></a><span id="l17.5391" class="difflineminus">-  bool          suppressSigSep = false;</span>
<a href="#l17.5392"></a><span id="l17.5392" class="difflineplus">+  int32_t reply_on_top = 0;</span>
<a href="#l17.5393"></a><span id="l17.5393" class="difflineplus">+  bool sig_bottom = true;</span>
<a href="#l17.5394"></a><span id="l17.5394" class="difflineplus">+  bool suppressSigSep = false;</span>
<a href="#l17.5395"></a><span id="l17.5395"> </span>
<a href="#l17.5396"></a><span id="l17.5396">   nsCOMPtr&lt;nsIFile&gt; sigFile;</span>
<a href="#l17.5397"></a><span id="l17.5397" class="difflineminus">-  if (identity)</span>
<a href="#l17.5398"></a><span id="l17.5398" class="difflineminus">-  {</span>
<a href="#l17.5399"></a><span id="l17.5399" class="difflineminus">-    if (!CheckIncludeSignaturePrefs(identity))</span>
<a href="#l17.5400"></a><span id="l17.5400" class="difflineminus">-      return NS_OK;</span>
<a href="#l17.5401"></a><span id="l17.5401" class="difflineplus">+  if (identity) {</span>
<a href="#l17.5402"></a><span id="l17.5402" class="difflineplus">+    if (!CheckIncludeSignaturePrefs(identity)) return NS_OK;</span>
<a href="#l17.5403"></a><span id="l17.5403"> </span>
<a href="#l17.5404"></a><span id="l17.5404">     identity-&gt;GetReplyOnTop(&amp;reply_on_top);</span>
<a href="#l17.5405"></a><span id="l17.5405">     identity-&gt;GetSigBottom(&amp;sig_bottom);</span>
<a href="#l17.5406"></a><span id="l17.5406">     identity-&gt;GetSuppressSigSep(&amp;suppressSigSep);</span>
<a href="#l17.5407"></a><span id="l17.5407"> </span>
<a href="#l17.5408"></a><span id="l17.5408">     rv = identity-&gt;GetAttachSignature(&amp;attachFile);</span>
<a href="#l17.5409"></a><span id="l17.5409" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; attachFile)</span>
<a href="#l17.5410"></a><span id="l17.5410" class="difflineminus">-    {</span>
<a href="#l17.5411"></a><span id="l17.5411" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; attachFile) {</span>
<a href="#l17.5412"></a><span id="l17.5412">       rv = identity-&gt;GetSignature(getter_AddRefs(sigFile));</span>
<a href="#l17.5413"></a><span id="l17.5413">       if (NS_SUCCEEDED(rv) &amp;&amp; sigFile) {</span>
<a href="#l17.5414"></a><span id="l17.5414">         if (!sigFile-&gt;NativePath().IsEmpty()) {</span>
<a href="#l17.5415"></a><span id="l17.5415">           bool exists = false;</span>
<a href="#l17.5416"></a><span id="l17.5416">           sigFile-&gt;Exists(&amp;exists);</span>
<a href="#l17.5417"></a><span id="l17.5417">           if (exists) {</span>
<a href="#l17.5418"></a><span id="l17.5418" class="difflineminus">-            useSigFile = true; // ok, there's a signature file</span>
<a href="#l17.5419"></a><span id="l17.5419" class="difflineminus">-</span>
<a href="#l17.5420"></a><span id="l17.5420" class="difflineminus">-            // Now, most importantly, we need to figure out what the content type is for</span>
<a href="#l17.5421"></a><span id="l17.5421" class="difflineminus">-            // this signature...if we can't, we assume text</span>
<a href="#l17.5422"></a><span id="l17.5422" class="difflineplus">+            useSigFile = true;  // ok, there's a signature file</span>
<a href="#l17.5423"></a><span id="l17.5423" class="difflineplus">+</span>
<a href="#l17.5424"></a><span id="l17.5424" class="difflineplus">+            // Now, most importantly, we need to figure out what the content</span>
<a href="#l17.5425"></a><span id="l17.5425" class="difflineplus">+            // type is for this signature...if we can't, we assume text</span>
<a href="#l17.5426"></a><span id="l17.5426">             nsAutoCString sigContentType;</span>
<a href="#l17.5427"></a><span id="l17.5427" class="difflineminus">-            nsresult rv2; // don't want to clobber the other rv</span>
<a href="#l17.5428"></a><span id="l17.5428" class="difflineminus">-            nsCOMPtr&lt;nsIMIMEService&gt; mimeFinder (do_GetService(NS_MIMESERVICE_CONTRACTID, &amp;rv2));</span>
<a href="#l17.5429"></a><span id="l17.5429" class="difflineplus">+            nsresult rv2;  // don't want to clobber the other rv</span>
<a href="#l17.5430"></a><span id="l17.5430" class="difflineplus">+            nsCOMPtr&lt;nsIMIMEService&gt; mimeFinder(</span>
<a href="#l17.5431"></a><span id="l17.5431" class="difflineplus">+                do_GetService(NS_MIMESERVICE_CONTRACTID, &amp;rv2));</span>
<a href="#l17.5432"></a><span id="l17.5432">             if (NS_SUCCEEDED(rv2)) {</span>
<a href="#l17.5433"></a><span id="l17.5433">               rv2 = mimeFinder-&gt;GetTypeFromFile(sigFile, sigContentType);</span>
<a href="#l17.5434"></a><span id="l17.5434">               if (NS_SUCCEEDED(rv2)) {</span>
<a href="#l17.5435"></a><span id="l17.5435" class="difflineminus">-                if (StringBeginsWith(sigContentType, NS_LITERAL_CSTRING(&quot;image/&quot;), nsCaseInsensitiveCStringComparator()))</span>
<a href="#l17.5436"></a><span id="l17.5436" class="difflineplus">+                if (StringBeginsWith(sigContentType,</span>
<a href="#l17.5437"></a><span id="l17.5437" class="difflineplus">+                                     NS_LITERAL_CSTRING(&quot;image/&quot;),</span>
<a href="#l17.5438"></a><span id="l17.5438" class="difflineplus">+                                     nsCaseInsensitiveCStringComparator()))</span>
<a href="#l17.5439"></a><span id="l17.5439">                   imageSig = true;</span>
<a href="#l17.5440"></a><span id="l17.5440" class="difflineminus">-                else if (sigContentType.Equals(TEXT_HTML, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l17.5441"></a><span id="l17.5441" class="difflineplus">+                else if (sigContentType.Equals(</span>
<a href="#l17.5442"></a><span id="l17.5442" class="difflineplus">+                             TEXT_HTML, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l17.5443"></a><span id="l17.5443">                   htmlSig = true;</span>
<a href="#l17.5444"></a><span id="l17.5444">               }</span>
<a href="#l17.5445"></a><span id="l17.5445">             }</span>
<a href="#l17.5446"></a><span id="l17.5446">           }</span>
<a href="#l17.5447"></a><span id="l17.5447">         }</span>
<a href="#l17.5448"></a><span id="l17.5448">       }</span>
<a href="#l17.5449"></a><span id="l17.5449">     }</span>
<a href="#l17.5450"></a><span id="l17.5450">   }</span>
<a href="#l17.5451"></a><span id="l17.5451"> </span>
<a href="#l17.5452"></a><span id="l17.5452">   // Unless signature to be attached from file, use preference value;</span>
<a href="#l17.5453"></a><span id="l17.5453">   // the htmlSigText value is always going to be treated as html if</span>
<a href="#l17.5454"></a><span id="l17.5454">   // the htmlSigFormat pref is true, otherwise it is considered text</span>
<a href="#l17.5455"></a><span id="l17.5455">   nsAutoString prefSigText;</span>
<a href="#l17.5456"></a><span id="l17.5456" class="difflineminus">-  if (identity &amp;&amp; !attachFile)</span>
<a href="#l17.5457"></a><span id="l17.5457" class="difflineminus">-    identity-&gt;GetHtmlSigText(prefSigText);</span>
<a href="#l17.5458"></a><span id="l17.5458" class="difflineplus">+  if (identity &amp;&amp; !attachFile) identity-&gt;GetHtmlSigText(prefSigText);</span>
<a href="#l17.5459"></a><span id="l17.5459">   // Now, if they didn't even want to use a signature, we should</span>
<a href="#l17.5460"></a><span id="l17.5460">   // just return nicely.</span>
<a href="#l17.5461"></a><span id="l17.5461">   //</span>
<a href="#l17.5462"></a><span id="l17.5462" class="difflineminus">-  if ((!useSigFile  &amp;&amp; prefSigText.IsEmpty()) || NS_FAILED(rv))</span>
<a href="#l17.5463"></a><span id="l17.5463" class="difflineminus">-    return NS_OK;</span>
<a href="#l17.5464"></a><span id="l17.5464" class="difflineminus">-</span>
<a href="#l17.5465"></a><span id="l17.5465" class="difflineminus">-  static const char      htmlBreak[] = &quot;&lt;br&gt;&quot;;</span>
<a href="#l17.5466"></a><span id="l17.5466" class="difflineminus">-  static const char      dashes[] = &quot;-- &quot;;</span>
<a href="#l17.5467"></a><span id="l17.5467" class="difflineminus">-  static const char      htmlsigopen[] = &quot;&lt;div class=\&quot;moz-signature\&quot;&gt;&quot;;</span>
<a href="#l17.5468"></a><span id="l17.5468" class="difflineminus">-  static const char      htmlsigclose[] = &quot;&lt;/div&gt;&quot;;    /* XXX: Due to a bug in</span>
<a href="#l17.5469"></a><span id="l17.5469" class="difflineminus">-                             4.x' HTML editor, it will not be able to</span>
<a href="#l17.5470"></a><span id="l17.5470" class="difflineminus">-                             break this HTML sig, if quoted (for the user to</span>
<a href="#l17.5471"></a><span id="l17.5471" class="difflineminus">-                             interleave a comment). */</span>
<a href="#l17.5472"></a><span id="l17.5472" class="difflineminus">-  static const char      _preopen[] = &quot;&lt;pre class=\&quot;moz-signature\&quot; cols=%d&gt;&quot;;</span>
<a href="#l17.5473"></a><span id="l17.5473" class="difflineminus">-  char*                  preopen;</span>
<a href="#l17.5474"></a><span id="l17.5474" class="difflineminus">-  static const char      preclose[] = &quot;&lt;/pre&gt;&quot;;</span>
<a href="#l17.5475"></a><span id="l17.5475" class="difflineminus">-</span>
<a href="#l17.5476"></a><span id="l17.5476" class="difflineminus">-  int32_t wrapLength = 72; // setup default value in case GetWrapLength failed</span>
<a href="#l17.5477"></a><span id="l17.5477" class="difflineplus">+  if ((!useSigFile &amp;&amp; prefSigText.IsEmpty()) || NS_FAILED(rv)) return NS_OK;</span>
<a href="#l17.5478"></a><span id="l17.5478" class="difflineplus">+</span>
<a href="#l17.5479"></a><span id="l17.5479" class="difflineplus">+  static const char htmlBreak[] = &quot;&lt;br&gt;&quot;;</span>
<a href="#l17.5480"></a><span id="l17.5480" class="difflineplus">+  static const char dashes[] = &quot;-- &quot;;</span>
<a href="#l17.5481"></a><span id="l17.5481" class="difflineplus">+  static const char htmlsigopen[] = &quot;&lt;div class=\&quot;moz-signature\&quot;&gt;&quot;;</span>
<a href="#l17.5482"></a><span id="l17.5482" class="difflineplus">+  static const char htmlsigclose[] = &quot;&lt;/div&gt;&quot;; /* XXX: Due to a bug in</span>
<a href="#l17.5483"></a><span id="l17.5483" class="difflineplus">+                     4.x' HTML editor, it will not be able to</span>
<a href="#l17.5484"></a><span id="l17.5484" class="difflineplus">+                     break this HTML sig, if quoted (for the user to</span>
<a href="#l17.5485"></a><span id="l17.5485" class="difflineplus">+                     interleave a comment). */</span>
<a href="#l17.5486"></a><span id="l17.5486" class="difflineplus">+  static const char _preopen[] = &quot;&lt;pre class=\&quot;moz-signature\&quot; cols=%d&gt;&quot;;</span>
<a href="#l17.5487"></a><span id="l17.5487" class="difflineplus">+  char *preopen;</span>
<a href="#l17.5488"></a><span id="l17.5488" class="difflineplus">+  static const char preclose[] = &quot;&lt;/pre&gt;&quot;;</span>
<a href="#l17.5489"></a><span id="l17.5489" class="difflineplus">+</span>
<a href="#l17.5490"></a><span id="l17.5490" class="difflineplus">+  int32_t wrapLength = 72;  // setup default value in case GetWrapLength failed</span>
<a href="#l17.5491"></a><span id="l17.5491">   GetWrapLength(&amp;wrapLength);</span>
<a href="#l17.5492"></a><span id="l17.5492">   preopen = PR_smprintf(_preopen, wrapLength);</span>
<a href="#l17.5493"></a><span id="l17.5493" class="difflineminus">-  if (!preopen)</span>
<a href="#l17.5494"></a><span id="l17.5494" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l17.5495"></a><span id="l17.5495" class="difflineplus">+  if (!preopen) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l17.5496"></a><span id="l17.5496"> </span>
<a href="#l17.5497"></a><span id="l17.5497">   bool paragraphMode =</span>
<a href="#l17.5498"></a><span id="l17.5498" class="difflineminus">-    mozilla::Preferences::GetBool(&quot;mail.compose.default_to_paragraph&quot;, false);</span>
<a href="#l17.5499"></a><span id="l17.5499" class="difflineminus">-</span>
<a href="#l17.5500"></a><span id="l17.5500" class="difflineminus">-  if (imageSig)</span>
<a href="#l17.5501"></a><span id="l17.5501" class="difflineminus">-  {</span>
<a href="#l17.5502"></a><span id="l17.5502" class="difflineplus">+      mozilla::Preferences::GetBool(&quot;mail.compose.default_to_paragraph&quot;, false);</span>
<a href="#l17.5503"></a><span id="l17.5503" class="difflineplus">+</span>
<a href="#l17.5504"></a><span id="l17.5504" class="difflineplus">+  if (imageSig) {</span>
<a href="#l17.5505"></a><span id="l17.5505">     // We have an image signature. If we're using the in HTML composer, we</span>
<a href="#l17.5506"></a><span id="l17.5506">     // should put in the appropriate HTML for inclusion, otherwise, do nothing.</span>
<a href="#l17.5507"></a><span id="l17.5507" class="difflineminus">-    if (m_composeHTML)</span>
<a href="#l17.5508"></a><span id="l17.5508" class="difflineminus">-    {</span>
<a href="#l17.5509"></a><span id="l17.5509" class="difflineminus">-      if (!paragraphMode)</span>
<a href="#l17.5510"></a><span id="l17.5510" class="difflineminus">-        sigOutput.AppendLiteral(htmlBreak);</span>
<a href="#l17.5511"></a><span id="l17.5511" class="difflineplus">+    if (m_composeHTML) {</span>
<a href="#l17.5512"></a><span id="l17.5512" class="difflineplus">+      if (!paragraphMode) sigOutput.AppendLiteral(htmlBreak);</span>
<a href="#l17.5513"></a><span id="l17.5513">       sigOutput.AppendLiteral(htmlsigopen);</span>
<a href="#l17.5514"></a><span id="l17.5514">       if ((mType == nsIMsgCompType::NewsPost || !suppressSigSep) &amp;&amp;</span>
<a href="#l17.5515"></a><span id="l17.5515">           (reply_on_top != 1 || sig_bottom || !aQuoted)) {</span>
<a href="#l17.5516"></a><span id="l17.5516">         sigOutput.AppendLiteral(dashes);</span>
<a href="#l17.5517"></a><span id="l17.5517">       }</span>
<a href="#l17.5518"></a><span id="l17.5518"> </span>
<a href="#l17.5519"></a><span id="l17.5519">       sigOutput.AppendLiteral(htmlBreak);</span>
<a href="#l17.5520"></a><span id="l17.5520">       sigOutput.AppendLiteral(&quot;&lt;img src='&quot;);</span>
<a href="#l17.5521"></a><span id="l17.5521" class="difflineat">@@ -4496,303 +4118,278 @@ nsMsgCompose::ProcessSignature(nsIMsgIde</span>
<a href="#l17.5522"></a><span id="l17.5522">       nsString dataURL;</span>
<a href="#l17.5523"></a><span id="l17.5523">       rv = DataURLForFileURL(NS_ConvertUTF8toUTF16(fileURL), dataURL);</span>
<a href="#l17.5524"></a><span id="l17.5524">       if (NS_SUCCEEDED(rv)) {</span>
<a href="#l17.5525"></a><span id="l17.5525">         sigOutput.Append(dataURL);</span>
<a href="#l17.5526"></a><span id="l17.5526">       }</span>
<a href="#l17.5527"></a><span id="l17.5527">       sigOutput.AppendLiteral(&quot;' border=0&gt;&quot;);</span>
<a href="#l17.5528"></a><span id="l17.5528">       sigOutput.AppendLiteral(htmlsigclose);</span>
<a href="#l17.5529"></a><span id="l17.5529">     }</span>
<a href="#l17.5530"></a><span id="l17.5530" class="difflineminus">-  }</span>
<a href="#l17.5531"></a><span id="l17.5531" class="difflineminus">-  else if (useSigFile)</span>
<a href="#l17.5532"></a><span id="l17.5532" class="difflineminus">-  {</span>
<a href="#l17.5533"></a><span id="l17.5533" class="difflineplus">+  } else if (useSigFile) {</span>
<a href="#l17.5534"></a><span id="l17.5534">     // is this a text sig with an HTML editor?</span>
<a href="#l17.5535"></a><span id="l17.5535" class="difflineminus">-    if ( (m_composeHTML) &amp;&amp; (!htmlSig) ) {</span>
<a href="#l17.5536"></a><span id="l17.5536" class="difflineplus">+    if ((m_composeHTML) &amp;&amp; (!htmlSig)) {</span>
<a href="#l17.5537"></a><span id="l17.5537">       ConvertTextToHTML(sigFile, sigData);</span>
<a href="#l17.5538"></a><span id="l17.5538">     }</span>
<a href="#l17.5539"></a><span id="l17.5539">     // is this a HTML sig with a text window?</span>
<a href="#l17.5540"></a><span id="l17.5540" class="difflineminus">-    else if ( (!m_composeHTML) &amp;&amp; (htmlSig) ) {</span>
<a href="#l17.5541"></a><span id="l17.5541" class="difflineplus">+    else if ((!m_composeHTML) &amp;&amp; (htmlSig)) {</span>
<a href="#l17.5542"></a><span id="l17.5542">       ConvertHTMLToText(sigFile, sigData);</span>
<a href="#l17.5543"></a><span id="l17.5543" class="difflineminus">-    }</span>
<a href="#l17.5544"></a><span id="l17.5544" class="difflineminus">-    else { // We have a match...</span>
<a href="#l17.5545"></a><span id="l17.5545" class="difflineplus">+    } else {                               // We have a match...</span>
<a href="#l17.5546"></a><span id="l17.5546">       LoadDataFromFile(sigFile, sigData);  // Get the data!</span>
<a href="#l17.5547"></a><span id="l17.5547">       ReplaceFileURLs(sigData);</span>
<a href="#l17.5548"></a><span id="l17.5548">     }</span>
<a href="#l17.5549"></a><span id="l17.5549">   }</span>
<a href="#l17.5550"></a><span id="l17.5550"> </span>
<a href="#l17.5551"></a><span id="l17.5551">   // if we have a prefSigText, append it to sigData.</span>
<a href="#l17.5552"></a><span id="l17.5552" class="difflineminus">-  if (!prefSigText.IsEmpty())</span>
<a href="#l17.5553"></a><span id="l17.5553" class="difflineminus">-  {</span>
<a href="#l17.5554"></a><span id="l17.5554" class="difflineminus">-    // set htmlSig if the pref is supposed to contain HTML code, defaults to false</span>
<a href="#l17.5555"></a><span id="l17.5555" class="difflineplus">+  if (!prefSigText.IsEmpty()) {</span>
<a href="#l17.5556"></a><span id="l17.5556" class="difflineplus">+    // set htmlSig if the pref is supposed to contain HTML code, defaults to</span>
<a href="#l17.5557"></a><span id="l17.5557" class="difflineplus">+    // false</span>
<a href="#l17.5558"></a><span id="l17.5558">     rv = identity-&gt;GetHtmlSigFormat(&amp;htmlSig);</span>
<a href="#l17.5559"></a><span id="l17.5559" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l17.5560"></a><span id="l17.5560" class="difflineminus">-      htmlSig = false;</span>
<a href="#l17.5561"></a><span id="l17.5561" class="difflineminus">-</span>
<a href="#l17.5562"></a><span id="l17.5562" class="difflineminus">-    if (!m_composeHTML)</span>
<a href="#l17.5563"></a><span id="l17.5563" class="difflineminus">-    {</span>
<a href="#l17.5564"></a><span id="l17.5564" class="difflineminus">-      if (htmlSig)</span>
<a href="#l17.5565"></a><span id="l17.5565" class="difflineminus">-        ConvertBufToPlainText(prefSigText, false, false, true, true);</span>
<a href="#l17.5566"></a><span id="l17.5566" class="difflineplus">+    if (NS_FAILED(rv)) htmlSig = false;</span>
<a href="#l17.5567"></a><span id="l17.5567" class="difflineplus">+</span>
<a href="#l17.5568"></a><span id="l17.5568" class="difflineplus">+    if (!m_composeHTML) {</span>
<a href="#l17.5569"></a><span id="l17.5569" class="difflineplus">+      if (htmlSig) ConvertBufToPlainText(prefSigText, false, false, true, true);</span>
<a href="#l17.5570"></a><span id="l17.5570">       sigData.Append(prefSigText);</span>
<a href="#l17.5571"></a><span id="l17.5571" class="difflineminus">-    }</span>
<a href="#l17.5572"></a><span id="l17.5572" class="difflineminus">-    else</span>
<a href="#l17.5573"></a><span id="l17.5573" class="difflineminus">-    {</span>
<a href="#l17.5574"></a><span id="l17.5574" class="difflineminus">-      if (!htmlSig)</span>
<a href="#l17.5575"></a><span id="l17.5575" class="difflineminus">-      {</span>
<a href="#l17.5576"></a><span id="l17.5576" class="difflineplus">+    } else {</span>
<a href="#l17.5577"></a><span id="l17.5577" class="difflineplus">+      if (!htmlSig) {</span>
<a href="#l17.5578"></a><span id="l17.5578">         nsCString escapedUTF8;</span>
<a href="#l17.5579"></a><span id="l17.5579">         nsAppendEscapedHTML(NS_ConvertUTF16toUTF8(prefSigText), escapedUTF8);</span>
<a href="#l17.5580"></a><span id="l17.5580">         sigData.Append(NS_ConvertUTF8toUTF16(escapedUTF8));</span>
<a href="#l17.5581"></a><span id="l17.5581" class="difflineminus">-      }</span>
<a href="#l17.5582"></a><span id="l17.5582" class="difflineminus">-      else {</span>
<a href="#l17.5583"></a><span id="l17.5583" class="difflineplus">+      } else {</span>
<a href="#l17.5584"></a><span id="l17.5584">         ReplaceFileURLs(prefSigText);</span>
<a href="#l17.5585"></a><span id="l17.5585">         sigData.Append(prefSigText);</span>
<a href="#l17.5586"></a><span id="l17.5586">       }</span>
<a href="#l17.5587"></a><span id="l17.5587">     }</span>
<a href="#l17.5588"></a><span id="l17.5588">   }</span>
<a href="#l17.5589"></a><span id="l17.5589"> </span>
<a href="#l17.5590"></a><span id="l17.5590" class="difflineminus">-  // post-processing for plain-text signatures to ensure we end in CR, LF, or CRLF</span>
<a href="#l17.5591"></a><span id="l17.5591" class="difflineminus">-  if (!htmlSig &amp;&amp; !m_composeHTML)</span>
<a href="#l17.5592"></a><span id="l17.5592" class="difflineminus">-  {</span>
<a href="#l17.5593"></a><span id="l17.5593" class="difflineplus">+  // post-processing for plain-text signatures to ensure we end in CR, LF, or</span>
<a href="#l17.5594"></a><span id="l17.5594" class="difflineplus">+  // CRLF</span>
<a href="#l17.5595"></a><span id="l17.5595" class="difflineplus">+  if (!htmlSig &amp;&amp; !m_composeHTML) {</span>
<a href="#l17.5596"></a><span id="l17.5596">     int32_t sigLength = sigData.Length();</span>
<a href="#l17.5597"></a><span id="l17.5597" class="difflineminus">-    if (sigLength &gt; 0 &amp;&amp; !(sigData.CharAt(sigLength - 1) == '\r')</span>
<a href="#l17.5598"></a><span id="l17.5598" class="difflineminus">-                      &amp;&amp; !(sigData.CharAt(sigLength - 1) == '\n'))</span>
<a href="#l17.5599"></a><span id="l17.5599" class="difflineplus">+    if (sigLength &gt; 0 &amp;&amp; !(sigData.CharAt(sigLength - 1) == '\r') &amp;&amp;</span>
<a href="#l17.5600"></a><span id="l17.5600" class="difflineplus">+        !(sigData.CharAt(sigLength - 1) == '\n'))</span>
<a href="#l17.5601"></a><span id="l17.5601">       sigData.AppendLiteral(CRLF);</span>
<a href="#l17.5602"></a><span id="l17.5602">   }</span>
<a href="#l17.5603"></a><span id="l17.5603"> </span>
<a href="#l17.5604"></a><span id="l17.5604">   // Now that sigData holds data...if any, append it to the body in a nice</span>
<a href="#l17.5605"></a><span id="l17.5605">   // looking manner</span>
<a href="#l17.5606"></a><span id="l17.5606" class="difflineminus">-  if (!sigData.IsEmpty())</span>
<a href="#l17.5607"></a><span id="l17.5607" class="difflineminus">-  {</span>
<a href="#l17.5608"></a><span id="l17.5608" class="difflineminus">-    if (m_composeHTML)</span>
<a href="#l17.5609"></a><span id="l17.5609" class="difflineminus">-    {</span>
<a href="#l17.5610"></a><span id="l17.5610" class="difflineminus">-      if (!paragraphMode)</span>
<a href="#l17.5611"></a><span id="l17.5611" class="difflineminus">-        sigOutput.AppendLiteral(htmlBreak);</span>
<a href="#l17.5612"></a><span id="l17.5612" class="difflineplus">+  if (!sigData.IsEmpty()) {</span>
<a href="#l17.5613"></a><span id="l17.5613" class="difflineplus">+    if (m_composeHTML) {</span>
<a href="#l17.5614"></a><span id="l17.5614" class="difflineplus">+      if (!paragraphMode) sigOutput.AppendLiteral(htmlBreak);</span>
<a href="#l17.5615"></a><span id="l17.5615"> </span>
<a href="#l17.5616"></a><span id="l17.5616">       if (htmlSig)</span>
<a href="#l17.5617"></a><span id="l17.5617">         sigOutput.AppendLiteral(htmlsigopen);</span>
<a href="#l17.5618"></a><span id="l17.5618">       else</span>
<a href="#l17.5619"></a><span id="l17.5619">         sigOutput.Append(NS_ConvertASCIItoUTF16(preopen));</span>
<a href="#l17.5620"></a><span id="l17.5620">     }</span>
<a href="#l17.5621"></a><span id="l17.5621"> </span>
<a href="#l17.5622"></a><span id="l17.5622">     if ((reply_on_top != 1 || sig_bottom || !aQuoted) &amp;&amp;</span>
<a href="#l17.5623"></a><span id="l17.5623">         sigData.Find(&quot;\r-- \r&quot;, true) &lt; 0 &amp;&amp;</span>
<a href="#l17.5624"></a><span id="l17.5624">         sigData.Find(&quot;\n-- \n&quot;, true) &lt; 0 &amp;&amp;</span>
<a href="#l17.5625"></a><span id="l17.5625" class="difflineminus">-        sigData.Find(&quot;\n-- \r&quot;, true) &lt; 0)</span>
<a href="#l17.5626"></a><span id="l17.5626" class="difflineminus">-    {</span>
<a href="#l17.5627"></a><span id="l17.5627" class="difflineplus">+        sigData.Find(&quot;\n-- \r&quot;, true) &lt; 0) {</span>
<a href="#l17.5628"></a><span id="l17.5628">       nsDependentSubstring firstFourChars(sigData, 0, 4);</span>
<a href="#l17.5629"></a><span id="l17.5629"> </span>
<a href="#l17.5630"></a><span id="l17.5630">       if ((mType == nsIMsgCompType::NewsPost || !suppressSigSep) &amp;&amp;</span>
<a href="#l17.5631"></a><span id="l17.5631" class="difflineminus">-         !(firstFourChars.EqualsLiteral(&quot;-- \n&quot;) ||</span>
<a href="#l17.5632"></a><span id="l17.5632" class="difflineminus">-           firstFourChars.EqualsLiteral(&quot;-- \r&quot;)))</span>
<a href="#l17.5633"></a><span id="l17.5633" class="difflineminus">-      {</span>
<a href="#l17.5634"></a><span id="l17.5634" class="difflineplus">+          !(firstFourChars.EqualsLiteral(&quot;-- \n&quot;) ||</span>
<a href="#l17.5635"></a><span id="l17.5635" class="difflineplus">+            firstFourChars.EqualsLiteral(&quot;-- \r&quot;))) {</span>
<a href="#l17.5636"></a><span id="l17.5636">         sigOutput.AppendLiteral(dashes);</span>
<a href="#l17.5637"></a><span id="l17.5637"> </span>
<a href="#l17.5638"></a><span id="l17.5638">         if (!m_composeHTML || !htmlSig)</span>
<a href="#l17.5639"></a><span id="l17.5639">           sigOutput.AppendLiteral(CRLF);</span>
<a href="#l17.5640"></a><span id="l17.5640">         else if (m_composeHTML)</span>
<a href="#l17.5641"></a><span id="l17.5641">           sigOutput.AppendLiteral(htmlBreak);</span>
<a href="#l17.5642"></a><span id="l17.5642">       }</span>
<a href="#l17.5643"></a><span id="l17.5643">     }</span>
<a href="#l17.5644"></a><span id="l17.5644"> </span>
<a href="#l17.5645"></a><span id="l17.5645" class="difflineminus">-    // add CRLF before signature for plain-text mode if signature comes before quote</span>
<a href="#l17.5646"></a><span id="l17.5646" class="difflineplus">+    // add CRLF before signature for plain-text mode if signature comes before</span>
<a href="#l17.5647"></a><span id="l17.5647" class="difflineplus">+    // quote</span>
<a href="#l17.5648"></a><span id="l17.5648">     if (!m_composeHTML &amp;&amp; reply_on_top == 1 &amp;&amp; !sig_bottom &amp;&amp; aQuoted)</span>
<a href="#l17.5649"></a><span id="l17.5649">       sigOutput.AppendLiteral(CRLF);</span>
<a href="#l17.5650"></a><span id="l17.5650"> </span>
<a href="#l17.5651"></a><span id="l17.5651">     sigOutput.Append(sigData);</span>
<a href="#l17.5652"></a><span id="l17.5652"> </span>
<a href="#l17.5653"></a><span id="l17.5653" class="difflineminus">-    if (m_composeHTML)</span>
<a href="#l17.5654"></a><span id="l17.5654" class="difflineminus">-    {</span>
<a href="#l17.5655"></a><span id="l17.5655" class="difflineplus">+    if (m_composeHTML) {</span>
<a href="#l17.5656"></a><span id="l17.5656">       if (htmlSig)</span>
<a href="#l17.5657"></a><span id="l17.5657">         sigOutput.AppendLiteral(htmlsigclose);</span>
<a href="#l17.5658"></a><span id="l17.5658">       else</span>
<a href="#l17.5659"></a><span id="l17.5659">         sigOutput.AppendLiteral(preclose);</span>
<a href="#l17.5660"></a><span id="l17.5660">     }</span>
<a href="#l17.5661"></a><span id="l17.5661">   }</span>
<a href="#l17.5662"></a><span id="l17.5662"> </span>
<a href="#l17.5663"></a><span id="l17.5663">   aMsgBody-&gt;Append(sigOutput);</span>
<a href="#l17.5664"></a><span id="l17.5664">   PR_Free(preopen);</span>
<a href="#l17.5665"></a><span id="l17.5665">   return NS_OK;</span>
<a href="#l17.5666"></a><span id="l17.5666"> }</span>
<a href="#l17.5667"></a><span id="l17.5667"> </span>
<a href="#l17.5668"></a><span id="l17.5668" class="difflineminus">-nsresult nsMsgCompose::BuildBodyMessageAndSignature()</span>
<a href="#l17.5669"></a><span id="l17.5669" class="difflineminus">-{</span>
<a href="#l17.5670"></a><span id="l17.5670" class="difflineminus">-  nsresult    rv = NS_OK;</span>
<a href="#l17.5671"></a><span id="l17.5671" class="difflineplus">+nsresult nsMsgCompose::BuildBodyMessageAndSignature() {</span>
<a href="#l17.5672"></a><span id="l17.5672" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l17.5673"></a><span id="l17.5673"> </span>
<a href="#l17.5674"></a><span id="l17.5674">   //</span>
<a href="#l17.5675"></a><span id="l17.5675">   // This should never happen...if it does, just bail out...</span>
<a href="#l17.5676"></a><span id="l17.5676">   //</span>
<a href="#l17.5677"></a><span id="l17.5677" class="difflineminus">-  if (!m_editor)</span>
<a href="#l17.5678"></a><span id="l17.5678" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l17.5679"></a><span id="l17.5679" class="difflineplus">+  if (!m_editor) return NS_ERROR_FAILURE;</span>
<a href="#l17.5680"></a><span id="l17.5680"> </span>
<a href="#l17.5681"></a><span id="l17.5681">   //</span>
<a href="#l17.5682"></a><span id="l17.5682">   // Now, we have the body so we can just blast it into the</span>
<a href="#l17.5683"></a><span id="l17.5683">   // composition editor window.</span>
<a href="#l17.5684"></a><span id="l17.5684">   //</span>
<a href="#l17.5685"></a><span id="l17.5685" class="difflineminus">-  nsAutoString   body;</span>
<a href="#l17.5686"></a><span id="l17.5686" class="difflineplus">+  nsAutoString body;</span>
<a href="#l17.5687"></a><span id="l17.5687">   m_compFields-&gt;GetBody(body);</span>
<a href="#l17.5688"></a><span id="l17.5688"> </span>
<a href="#l17.5689"></a><span id="l17.5689" class="difflineminus">-  /* Some time we want to add a signature and sometime we won't. Let's figure that now...*/</span>
<a href="#l17.5690"></a><span id="l17.5690" class="difflineplus">+  /* Some time we want to add a signature and sometime we won't. Let's figure</span>
<a href="#l17.5691"></a><span id="l17.5691" class="difflineplus">+   * that now...*/</span>
<a href="#l17.5692"></a><span id="l17.5692">   bool addSignature;</span>
<a href="#l17.5693"></a><span id="l17.5693">   bool isQuoted = false;</span>
<a href="#l17.5694"></a><span id="l17.5694" class="difflineminus">-  switch (mType)</span>
<a href="#l17.5695"></a><span id="l17.5695" class="difflineminus">-  {</span>
<a href="#l17.5696"></a><span id="l17.5696" class="difflineminus">-    case nsIMsgCompType::ForwardInline :</span>
<a href="#l17.5697"></a><span id="l17.5697" class="difflineplus">+  switch (mType) {</span>
<a href="#l17.5698"></a><span id="l17.5698" class="difflineplus">+    case nsIMsgCompType::ForwardInline:</span>
<a href="#l17.5699"></a><span id="l17.5699">       addSignature = true;</span>
<a href="#l17.5700"></a><span id="l17.5700">       isQuoted = true;</span>
<a href="#l17.5701"></a><span id="l17.5701">       break;</span>
<a href="#l17.5702"></a><span id="l17.5702" class="difflineminus">-    case nsIMsgCompType::New :</span>
<a href="#l17.5703"></a><span id="l17.5703" class="difflineminus">-    case nsIMsgCompType::MailToUrl :    /* same as New */</span>
<a href="#l17.5704"></a><span id="l17.5704" class="difflineminus">-    case nsIMsgCompType::Reply :        /* should not happen! but just in case */</span>
<a href="#l17.5705"></a><span id="l17.5705" class="difflineminus">-    case nsIMsgCompType::ReplyAll :       /* should not happen! but just in case */</span>
<a href="#l17.5706"></a><span id="l17.5706" class="difflineminus">-    case nsIMsgCompType::ReplyToList :    /* should not happen! but just in case */</span>
<a href="#l17.5707"></a><span id="l17.5707" class="difflineminus">-    case nsIMsgCompType::ForwardAsAttachment :  /* should not happen! but just in case */</span>
<a href="#l17.5708"></a><span id="l17.5708" class="difflineminus">-    case nsIMsgCompType::NewsPost :</span>
<a href="#l17.5709"></a><span id="l17.5709" class="difflineminus">-    case nsIMsgCompType::ReplyToGroup :</span>
<a href="#l17.5710"></a><span id="l17.5710" class="difflineminus">-    case nsIMsgCompType::ReplyToSender :</span>
<a href="#l17.5711"></a><span id="l17.5711" class="difflineminus">-    case nsIMsgCompType::ReplyToSenderAndGroup :</span>
<a href="#l17.5712"></a><span id="l17.5712" class="difflineplus">+    case nsIMsgCompType::New:</span>
<a href="#l17.5713"></a><span id="l17.5713" class="difflineplus">+    case nsIMsgCompType::MailToUrl:   /* same as New */</span>
<a href="#l17.5714"></a><span id="l17.5714" class="difflineplus">+    case nsIMsgCompType::Reply:       /* should not happen! but just in case */</span>
<a href="#l17.5715"></a><span id="l17.5715" class="difflineplus">+    case nsIMsgCompType::ReplyAll:    /* should not happen! but just in case */</span>
<a href="#l17.5716"></a><span id="l17.5716" class="difflineplus">+    case nsIMsgCompType::ReplyToList: /* should not happen! but just in case */</span>
<a href="#l17.5717"></a><span id="l17.5717" class="difflineplus">+    case nsIMsgCompType::ForwardAsAttachment: /* should not happen! but just in</span>
<a href="#l17.5718"></a><span id="l17.5718" class="difflineplus">+                                                 case */</span>
<a href="#l17.5719"></a><span id="l17.5719" class="difflineplus">+    case nsIMsgCompType::NewsPost:</span>
<a href="#l17.5720"></a><span id="l17.5720" class="difflineplus">+    case nsIMsgCompType::ReplyToGroup:</span>
<a href="#l17.5721"></a><span id="l17.5721" class="difflineplus">+    case nsIMsgCompType::ReplyToSender:</span>
<a href="#l17.5722"></a><span id="l17.5722" class="difflineplus">+    case nsIMsgCompType::ReplyToSenderAndGroup:</span>
<a href="#l17.5723"></a><span id="l17.5723">       addSignature = true;</span>
<a href="#l17.5724"></a><span id="l17.5724">       break;</span>
<a href="#l17.5725"></a><span id="l17.5725"> </span>
<a href="#l17.5726"></a><span id="l17.5726" class="difflineminus">-    case nsIMsgCompType::Draft :</span>
<a href="#l17.5727"></a><span id="l17.5727" class="difflineminus">-    case nsIMsgCompType::Template :</span>
<a href="#l17.5728"></a><span id="l17.5728" class="difflineminus">-    case nsIMsgCompType::Redirect :</span>
<a href="#l17.5729"></a><span id="l17.5729" class="difflineminus">-    case nsIMsgCompType::EditAsNew :</span>
<a href="#l17.5730"></a><span id="l17.5730" class="difflineplus">+    case nsIMsgCompType::Draft:</span>
<a href="#l17.5731"></a><span id="l17.5731" class="difflineplus">+    case nsIMsgCompType::Template:</span>
<a href="#l17.5732"></a><span id="l17.5732" class="difflineplus">+    case nsIMsgCompType::Redirect:</span>
<a href="#l17.5733"></a><span id="l17.5733" class="difflineplus">+    case nsIMsgCompType::EditAsNew:</span>
<a href="#l17.5734"></a><span id="l17.5734">       addSignature = false;</span>
<a href="#l17.5735"></a><span id="l17.5735">       break;</span>
<a href="#l17.5736"></a><span id="l17.5736"> </span>
<a href="#l17.5737"></a><span id="l17.5737" class="difflineminus">-    default :</span>
<a href="#l17.5738"></a><span id="l17.5738" class="difflineplus">+    default:</span>
<a href="#l17.5739"></a><span id="l17.5739">       addSignature = false;</span>
<a href="#l17.5740"></a><span id="l17.5740">       break;</span>
<a href="#l17.5741"></a><span id="l17.5741">   }</span>
<a href="#l17.5742"></a><span id="l17.5742"> </span>
<a href="#l17.5743"></a><span id="l17.5743">   nsAutoString tSignature;</span>
<a href="#l17.5744"></a><span id="l17.5744" class="difflineminus">-  if (addSignature)</span>
<a href="#l17.5745"></a><span id="l17.5745" class="difflineminus">-    ProcessSignature(m_identity, isQuoted, &amp;tSignature);</span>
<a href="#l17.5746"></a><span id="l17.5746" class="difflineminus">-</span>
<a href="#l17.5747"></a><span id="l17.5747" class="difflineminus">-  // if type is new, but we have body, this is probably a mapi send, so we need to</span>
<a href="#l17.5748"></a><span id="l17.5748" class="difflineminus">-  // replace '\n' with &lt;br&gt; so that the line breaks won't be lost by html.</span>
<a href="#l17.5749"></a><span id="l17.5749" class="difflineminus">-  // if mailtourl, do the same.</span>
<a href="#l17.5750"></a><span id="l17.5750" class="difflineminus">-  if (m_composeHTML &amp;&amp; (mType == nsIMsgCompType::New || mType == nsIMsgCompType::MailToUrl))</span>
<a href="#l17.5751"></a><span id="l17.5751" class="difflineminus">-    MsgReplaceSubstring(body, NS_LITERAL_STRING(&quot;\n&quot;), NS_LITERAL_STRING(&quot;&lt;br&gt;&quot;));</span>
<a href="#l17.5752"></a><span id="l17.5752" class="difflineplus">+  if (addSignature) ProcessSignature(m_identity, isQuoted, &amp;tSignature);</span>
<a href="#l17.5753"></a><span id="l17.5753" class="difflineplus">+</span>
<a href="#l17.5754"></a><span id="l17.5754" class="difflineplus">+  // if type is new, but we have body, this is probably a mapi send, so we need</span>
<a href="#l17.5755"></a><span id="l17.5755" class="difflineplus">+  // to replace '\n' with &lt;br&gt; so that the line breaks won't be lost by html. if</span>
<a href="#l17.5756"></a><span id="l17.5756" class="difflineplus">+  // mailtourl, do the same.</span>
<a href="#l17.5757"></a><span id="l17.5757" class="difflineplus">+  if (m_composeHTML &amp;&amp;</span>
<a href="#l17.5758"></a><span id="l17.5758" class="difflineplus">+      (mType == nsIMsgCompType::New || mType == nsIMsgCompType::MailToUrl))</span>
<a href="#l17.5759"></a><span id="l17.5759" class="difflineplus">+    MsgReplaceSubstring(body, NS_LITERAL_STRING(&quot;\n&quot;),</span>
<a href="#l17.5760"></a><span id="l17.5760" class="difflineplus">+                        NS_LITERAL_STRING(&quot;&lt;br&gt;&quot;));</span>
<a href="#l17.5761"></a><span id="l17.5761"> </span>
<a href="#l17.5762"></a><span id="l17.5762">   // Restore flowed text wrapping for Drafts/Templates.</span>
<a href="#l17.5763"></a><span id="l17.5763">   // Look for unquoted lines - if we have an unquoted line</span>
<a href="#l17.5764"></a><span id="l17.5764">   // that ends in a space, join this line with the next one</span>
<a href="#l17.5765"></a><span id="l17.5765">   // by removing the end of line char(s).</span>
<a href="#l17.5766"></a><span id="l17.5766">   int32_t wrapping_enabled = 0;</span>
<a href="#l17.5767"></a><span id="l17.5767">   GetWrapLength(&amp;wrapping_enabled);</span>
<a href="#l17.5768"></a><span id="l17.5768" class="difflineminus">-  if (!m_composeHTML &amp;&amp; wrapping_enabled)</span>
<a href="#l17.5769"></a><span id="l17.5769" class="difflineminus">-  {</span>
<a href="#l17.5770"></a><span id="l17.5770" class="difflineplus">+  if (!m_composeHTML &amp;&amp; wrapping_enabled) {</span>
<a href="#l17.5771"></a><span id="l17.5771">     bool quote = false;</span>
<a href="#l17.5772"></a><span id="l17.5772" class="difflineminus">-    for (uint32_t i = 0; i &lt; body.Length(); i ++)</span>
<a href="#l17.5773"></a><span id="l17.5773" class="difflineminus">-    {</span>
<a href="#l17.5774"></a><span id="l17.5774" class="difflineplus">+    for (uint32_t i = 0; i &lt; body.Length(); i++) {</span>
<a href="#l17.5775"></a><span id="l17.5775">       if (i == 0 || body[i - 1] == '\n')  // newline</span>
<a href="#l17.5776"></a><span id="l17.5776">       {</span>
<a href="#l17.5777"></a><span id="l17.5777" class="difflineminus">-        if (body[i] == '&gt;')</span>
<a href="#l17.5778"></a><span id="l17.5778" class="difflineminus">-        {</span>
<a href="#l17.5779"></a><span id="l17.5779" class="difflineplus">+        if (body[i] == '&gt;') {</span>
<a href="#l17.5780"></a><span id="l17.5780">           quote = true;</span>
<a href="#l17.5781"></a><span id="l17.5781">           continue;</span>
<a href="#l17.5782"></a><span id="l17.5782">         }</span>
<a href="#l17.5783"></a><span id="l17.5783">         nsString s(Substring(body, i, 10));</span>
<a href="#l17.5784"></a><span id="l17.5784">         if (StringBeginsWith(s, NS_LITERAL_STRING(&quot;-- \r&quot;)) ||</span>
<a href="#l17.5785"></a><span id="l17.5785" class="difflineminus">-            StringBeginsWith(s, NS_LITERAL_STRING(&quot;-- \n&quot;)))</span>
<a href="#l17.5786"></a><span id="l17.5786" class="difflineminus">-        {</span>
<a href="#l17.5787"></a><span id="l17.5787" class="difflineplus">+            StringBeginsWith(s, NS_LITERAL_STRING(&quot;-- \n&quot;))) {</span>
<a href="#l17.5788"></a><span id="l17.5788">           i += 4;</span>
<a href="#l17.5789"></a><span id="l17.5789">           continue;</span>
<a href="#l17.5790"></a><span id="l17.5790">         }</span>
<a href="#l17.5791"></a><span id="l17.5791">         if (StringBeginsWith(s, NS_LITERAL_STRING(&quot;- -- \r&quot;)) ||</span>
<a href="#l17.5792"></a><span id="l17.5792" class="difflineminus">-            StringBeginsWith(s, NS_LITERAL_STRING(&quot;- -- \n&quot;)))</span>
<a href="#l17.5793"></a><span id="l17.5793" class="difflineminus">-        {</span>
<a href="#l17.5794"></a><span id="l17.5794" class="difflineplus">+            StringBeginsWith(s, NS_LITERAL_STRING(&quot;- -- \n&quot;))) {</span>
<a href="#l17.5795"></a><span id="l17.5795">           i += 6;</span>
<a href="#l17.5796"></a><span id="l17.5796">           continue;</span>
<a href="#l17.5797"></a><span id="l17.5797">         }</span>
<a href="#l17.5798"></a><span id="l17.5798">       }</span>
<a href="#l17.5799"></a><span id="l17.5799" class="difflineminus">-      if (body[i] == '\n' &amp;&amp; i &gt; 1)</span>
<a href="#l17.5800"></a><span id="l17.5800" class="difflineminus">-      {</span>
<a href="#l17.5801"></a><span id="l17.5801" class="difflineminus">-        if (quote)</span>
<a href="#l17.5802"></a><span id="l17.5802" class="difflineminus">-        {</span>
<a href="#l17.5803"></a><span id="l17.5803" class="difflineplus">+      if (body[i] == '\n' &amp;&amp; i &gt; 1) {</span>
<a href="#l17.5804"></a><span id="l17.5804" class="difflineplus">+        if (quote) {</span>
<a href="#l17.5805"></a><span id="l17.5805">           quote = false;</span>
<a href="#l17.5806"></a><span id="l17.5806" class="difflineminus">-          continue;   // skip quoted lines</span>
<a href="#l17.5807"></a><span id="l17.5807" class="difflineplus">+          continue;  // skip quoted lines</span>
<a href="#l17.5808"></a><span id="l17.5808">         }</span>
<a href="#l17.5809"></a><span id="l17.5809">         uint32_t j = i - 1;  // look backward for space</span>
<a href="#l17.5810"></a><span id="l17.5810" class="difflineminus">-        if (body[j] == '\r')</span>
<a href="#l17.5811"></a><span id="l17.5811" class="difflineminus">-          j --;</span>
<a href="#l17.5812"></a><span id="l17.5812" class="difflineminus">-        if (body[j] == ' ')  // join this line with next one</span>
<a href="#l17.5813"></a><span id="l17.5813" class="difflineplus">+        if (body[j] == '\r') j--;</span>
<a href="#l17.5814"></a><span id="l17.5814" class="difflineplus">+        if (body[j] == ' ')        // join this line with next one</span>
<a href="#l17.5815"></a><span id="l17.5815">           body.Cut(j + 1, i - j);  // remove CRLF</span>
<a href="#l17.5816"></a><span id="l17.5816">       }</span>
<a href="#l17.5817"></a><span id="l17.5817">     }</span>
<a href="#l17.5818"></a><span id="l17.5818">   }</span>
<a href="#l17.5819"></a><span id="l17.5819"> </span>
<a href="#l17.5820"></a><span id="l17.5820">   nsString empty;</span>
<a href="#l17.5821"></a><span id="l17.5821" class="difflineminus">-  rv = ConvertAndLoadComposeWindow(empty, body, tSignature,</span>
<a href="#l17.5822"></a><span id="l17.5822" class="difflineminus">-                                   false, m_composeHTML);</span>
<a href="#l17.5823"></a><span id="l17.5823" class="difflineplus">+  rv = ConvertAndLoadComposeWindow(empty, body, tSignature, false,</span>
<a href="#l17.5824"></a><span id="l17.5824" class="difflineplus">+                                   m_composeHTML);</span>
<a href="#l17.5825"></a><span id="l17.5825"> </span>
<a href="#l17.5826"></a><span id="l17.5826">   return rv;</span>
<a href="#l17.5827"></a><span id="l17.5827"> }</span>
<a href="#l17.5828"></a><span id="l17.5828"> </span>
<a href="#l17.5829"></a><span id="l17.5829" class="difflineminus">-nsresult nsMsgCompose::NotifyStateListeners(int32_t aNotificationType, nsresult aResult)</span>
<a href="#l17.5830"></a><span id="l17.5830" class="difflineminus">-{</span>
<a href="#l17.5831"></a><span id="l17.5831" class="difflineminus">-</span>
<a href="#l17.5832"></a><span id="l17.5832" class="difflineplus">+nsresult nsMsgCompose::NotifyStateListeners(int32_t aNotificationType,</span>
<a href="#l17.5833"></a><span id="l17.5833" class="difflineplus">+                                            nsresult aResult) {</span>
<a href="#l17.5834"></a><span id="l17.5834">   if (aNotificationType == nsIMsgComposeNotificationType::SaveInFolderDone)</span>
<a href="#l17.5835"></a><span id="l17.5835">     ResetUrisForEmbeddedObjects();</span>
<a href="#l17.5836"></a><span id="l17.5836"> </span>
<a href="#l17.5837"></a><span id="l17.5837" class="difflineminus">-  nsTObserverArray&lt;nsCOMPtr&lt;nsIMsgComposeStateListener&gt; &gt;::ForwardIterator iter(mStateListeners);</span>
<a href="#l17.5838"></a><span id="l17.5838" class="difflineplus">+  nsTObserverArray&lt;nsCOMPtr&lt;nsIMsgComposeStateListener&gt; &gt;::ForwardIterator iter(</span>
<a href="#l17.5839"></a><span id="l17.5839" class="difflineplus">+      mStateListeners);</span>
<a href="#l17.5840"></a><span id="l17.5840">   nsCOMPtr&lt;nsIMsgComposeStateListener&gt; thisListener;</span>
<a href="#l17.5841"></a><span id="l17.5841"> </span>
<a href="#l17.5842"></a><span id="l17.5842" class="difflineminus">-  while (iter.HasMore())</span>
<a href="#l17.5843"></a><span id="l17.5843" class="difflineminus">-  {</span>
<a href="#l17.5844"></a><span id="l17.5844" class="difflineplus">+  while (iter.HasMore()) {</span>
<a href="#l17.5845"></a><span id="l17.5845">     thisListener = iter.GetNext();</span>
<a href="#l17.5846"></a><span id="l17.5846"> </span>
<a href="#l17.5847"></a><span id="l17.5847" class="difflineminus">-    switch (aNotificationType)</span>
<a href="#l17.5848"></a><span id="l17.5848" class="difflineminus">-    {</span>
<a href="#l17.5849"></a><span id="l17.5849" class="difflineminus">-    case nsIMsgComposeNotificationType::ComposeFieldsReady:</span>
<a href="#l17.5850"></a><span id="l17.5850" class="difflineminus">-      thisListener-&gt;NotifyComposeFieldsReady();</span>
<a href="#l17.5851"></a><span id="l17.5851" class="difflineminus">-      break;</span>
<a href="#l17.5852"></a><span id="l17.5852" class="difflineminus">-</span>
<a href="#l17.5853"></a><span id="l17.5853" class="difflineminus">-    case nsIMsgComposeNotificationType::ComposeProcessDone:</span>
<a href="#l17.5854"></a><span id="l17.5854" class="difflineminus">-      thisListener-&gt;ComposeProcessDone(aResult);</span>
<a href="#l17.5855"></a><span id="l17.5855" class="difflineminus">-      break;</span>
<a href="#l17.5856"></a><span id="l17.5856" class="difflineminus">-</span>
<a href="#l17.5857"></a><span id="l17.5857" class="difflineminus">-    case nsIMsgComposeNotificationType::SaveInFolderDone:</span>
<a href="#l17.5858"></a><span id="l17.5858" class="difflineminus">-      thisListener-&gt;SaveInFolderDone(m_folderName.get());</span>
<a href="#l17.5859"></a><span id="l17.5859" class="difflineminus">-      break;</span>
<a href="#l17.5860"></a><span id="l17.5860" class="difflineminus">-</span>
<a href="#l17.5861"></a><span id="l17.5861" class="difflineminus">-    case nsIMsgComposeNotificationType::ComposeBodyReady:</span>
<a href="#l17.5862"></a><span id="l17.5862" class="difflineminus">-      thisListener-&gt;NotifyComposeBodyReady();</span>
<a href="#l17.5863"></a><span id="l17.5863" class="difflineminus">-      break;</span>
<a href="#l17.5864"></a><span id="l17.5864" class="difflineminus">-</span>
<a href="#l17.5865"></a><span id="l17.5865" class="difflineminus">-    default:</span>
<a href="#l17.5866"></a><span id="l17.5866" class="difflineminus">-      MOZ_ASSERT_UNREACHABLE(&quot;Unknown notification&quot;);</span>
<a href="#l17.5867"></a><span id="l17.5867" class="difflineminus">-      break;</span>
<a href="#l17.5868"></a><span id="l17.5868" class="difflineplus">+    switch (aNotificationType) {</span>
<a href="#l17.5869"></a><span id="l17.5869" class="difflineplus">+      case nsIMsgComposeNotificationType::ComposeFieldsReady:</span>
<a href="#l17.5870"></a><span id="l17.5870" class="difflineplus">+        thisListener-&gt;NotifyComposeFieldsReady();</span>
<a href="#l17.5871"></a><span id="l17.5871" class="difflineplus">+        break;</span>
<a href="#l17.5872"></a><span id="l17.5872" class="difflineplus">+</span>
<a href="#l17.5873"></a><span id="l17.5873" class="difflineplus">+      case nsIMsgComposeNotificationType::ComposeProcessDone:</span>
<a href="#l17.5874"></a><span id="l17.5874" class="difflineplus">+        thisListener-&gt;ComposeProcessDone(aResult);</span>
<a href="#l17.5875"></a><span id="l17.5875" class="difflineplus">+        break;</span>
<a href="#l17.5876"></a><span id="l17.5876" class="difflineplus">+</span>
<a href="#l17.5877"></a><span id="l17.5877" class="difflineplus">+      case nsIMsgComposeNotificationType::SaveInFolderDone:</span>
<a href="#l17.5878"></a><span id="l17.5878" class="difflineplus">+        thisListener-&gt;SaveInFolderDone(m_folderName.get());</span>
<a href="#l17.5879"></a><span id="l17.5879" class="difflineplus">+        break;</span>
<a href="#l17.5880"></a><span id="l17.5880" class="difflineplus">+</span>
<a href="#l17.5881"></a><span id="l17.5881" class="difflineplus">+      case nsIMsgComposeNotificationType::ComposeBodyReady:</span>
<a href="#l17.5882"></a><span id="l17.5882" class="difflineplus">+        thisListener-&gt;NotifyComposeBodyReady();</span>
<a href="#l17.5883"></a><span id="l17.5883" class="difflineplus">+        break;</span>
<a href="#l17.5884"></a><span id="l17.5884" class="difflineplus">+</span>
<a href="#l17.5885"></a><span id="l17.5885" class="difflineplus">+      default:</span>
<a href="#l17.5886"></a><span id="l17.5886" class="difflineplus">+        MOZ_ASSERT_UNREACHABLE(&quot;Unknown notification&quot;);</span>
<a href="#l17.5887"></a><span id="l17.5887" class="difflineplus">+        break;</span>
<a href="#l17.5888"></a><span id="l17.5888">     }</span>
<a href="#l17.5889"></a><span id="l17.5889">   }</span>
<a href="#l17.5890"></a><span id="l17.5890"> </span>
<a href="#l17.5891"></a><span id="l17.5891">   return NS_OK;</span>
<a href="#l17.5892"></a><span id="l17.5892"> }</span>
<a href="#l17.5893"></a><span id="l17.5893"> </span>
<a href="#l17.5894"></a><span id="l17.5894" class="difflineminus">-nsresult nsMsgCompose::AttachmentPrettyName(const nsACString &amp; scheme, const char* charset, nsACString&amp; _retval)</span>
<a href="#l17.5895"></a><span id="l17.5895" class="difflineminus">-{</span>
<a href="#l17.5896"></a><span id="l17.5896" class="difflineplus">+nsresult nsMsgCompose::AttachmentPrettyName(const nsACString &amp;scheme,</span>
<a href="#l17.5897"></a><span id="l17.5897" class="difflineplus">+                                            const char *charset,</span>
<a href="#l17.5898"></a><span id="l17.5898" class="difflineplus">+                                            nsACString &amp;_retval) {</span>
<a href="#l17.5899"></a><span id="l17.5899">   nsresult rv;</span>
<a href="#l17.5900"></a><span id="l17.5900"> </span>
<a href="#l17.5901"></a><span id="l17.5901" class="difflineminus">-  if (MsgLowerCaseEqualsLiteral(StringHead(scheme, 5), &quot;file:&quot;))</span>
<a href="#l17.5902"></a><span id="l17.5902" class="difflineminus">-  {</span>
<a href="#l17.5903"></a><span id="l17.5903" class="difflineplus">+  if (MsgLowerCaseEqualsLiteral(StringHead(scheme, 5), &quot;file:&quot;)) {</span>
<a href="#l17.5904"></a><span id="l17.5904">     nsCOMPtr&lt;nsIFile&gt; file;</span>
<a href="#l17.5905"></a><span id="l17.5905" class="difflineminus">-    rv = NS_GetFileFromURLSpec(scheme,</span>
<a href="#l17.5906"></a><span id="l17.5906" class="difflineminus">-                               getter_AddRefs(file));</span>
<a href="#l17.5907"></a><span id="l17.5907" class="difflineplus">+    rv = NS_GetFileFromURLSpec(scheme, getter_AddRefs(file));</span>
<a href="#l17.5908"></a><span id="l17.5908">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.5909"></a><span id="l17.5909">     nsAutoString leafName;</span>
<a href="#l17.5910"></a><span id="l17.5910">     rv = file-&gt;GetLeafName(leafName);</span>
<a href="#l17.5911"></a><span id="l17.5911">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.5912"></a><span id="l17.5912">     CopyUTF16toUTF8(leafName, _retval);</span>
<a href="#l17.5913"></a><span id="l17.5913">     return rv;</span>
<a href="#l17.5914"></a><span id="l17.5914">   }</span>
<a href="#l17.5915"></a><span id="l17.5915"> </span>
<a href="#l17.5916"></a><span id="l17.5916">   // To work around a mysterious bug in VC++ 6.</span>
<a href="#l17.5917"></a><span id="l17.5917" class="difflineminus">-  const char* cset = (!charset || !*charset) ? &quot;UTF-8&quot; : charset;</span>
<a href="#l17.5918"></a><span id="l17.5918" class="difflineminus">-</span>
<a href="#l17.5919"></a><span id="l17.5919" class="difflineminus">-  nsCOMPtr&lt;nsITextToSubURI&gt; textToSubURI = do_GetService(NS_ITEXTTOSUBURI_CONTRACTID, &amp;rv);</span>
<a href="#l17.5920"></a><span id="l17.5920" class="difflineplus">+  const char *cset = (!charset || !*charset) ? &quot;UTF-8&quot; : charset;</span>
<a href="#l17.5921"></a><span id="l17.5921" class="difflineplus">+</span>
<a href="#l17.5922"></a><span id="l17.5922" class="difflineplus">+  nsCOMPtr&lt;nsITextToSubURI&gt; textToSubURI =</span>
<a href="#l17.5923"></a><span id="l17.5923" class="difflineplus">+      do_GetService(NS_ITEXTTOSUBURI_CONTRACTID, &amp;rv);</span>
<a href="#l17.5924"></a><span id="l17.5924">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.5925"></a><span id="l17.5925"> </span>
<a href="#l17.5926"></a><span id="l17.5926">   nsAutoString retUrl;</span>
<a href="#l17.5927"></a><span id="l17.5927">   rv = textToSubURI-&gt;UnEscapeURIForUI(nsDependentCString(cset), scheme, retUrl);</span>
<a href="#l17.5928"></a><span id="l17.5928"> </span>
<a href="#l17.5929"></a><span id="l17.5929">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l17.5930"></a><span id="l17.5930">     CopyUTF16toUTF8(retUrl, _retval);</span>
<a href="#l17.5931"></a><span id="l17.5931">   } else {</span>
<a href="#l17.5932"></a><span id="l17.5932" class="difflineat">@@ -4806,71 +4403,64 @@ nsresult nsMsgCompose::AttachmentPrettyN</span>
<a href="#l17.5933"></a><span id="l17.5933"> </span>
<a href="#l17.5934"></a><span id="l17.5934"> /**</span>
<a href="#l17.5935"></a><span id="l17.5935">  * Retrieve address book directories and mailing lists.</span>
<a href="#l17.5936"></a><span id="l17.5936">  *</span>
<a href="#l17.5937"></a><span id="l17.5937">  * @param aDirUri               directory URI</span>
<a href="#l17.5938"></a><span id="l17.5938">  * @param allDirectoriesArray   retrieved directories and sub-directories</span>
<a href="#l17.5939"></a><span id="l17.5939">  * @param allMailListArray      retrieved maillists</span>
<a href="#l17.5940"></a><span id="l17.5940">  */</span>
<a href="#l17.5941"></a><span id="l17.5941" class="difflineminus">-nsresult</span>
<a href="#l17.5942"></a><span id="l17.5942" class="difflineminus">-nsMsgCompose::GetABDirAndMailLists(const nsACString&amp; aDirUri,</span>
<a href="#l17.5943"></a><span id="l17.5943" class="difflineminus">-                                   nsCOMArray&lt;nsIAbDirectory&gt; &amp;aDirArray,</span>
<a href="#l17.5944"></a><span id="l17.5944" class="difflineminus">-                                   nsTArray&lt;nsMsgMailList&gt; &amp;aMailListArray)</span>
<a href="#l17.5945"></a><span id="l17.5945" class="difflineminus">-{</span>
<a href="#l17.5946"></a><span id="l17.5946" class="difflineplus">+nsresult nsMsgCompose::GetABDirAndMailLists(</span>
<a href="#l17.5947"></a><span id="l17.5947" class="difflineplus">+    const nsACString &amp;aDirUri, nsCOMArray&lt;nsIAbDirectory&gt; &amp;aDirArray,</span>
<a href="#l17.5948"></a><span id="l17.5948" class="difflineplus">+    nsTArray&lt;nsMsgMailList&gt; &amp;aMailListArray) {</span>
<a href="#l17.5949"></a><span id="l17.5949">   static bool collectedAddressbookFound;</span>
<a href="#l17.5950"></a><span id="l17.5950">   if (aDirUri.EqualsLiteral(kMDBDirectoryRoot))</span>
<a href="#l17.5951"></a><span id="l17.5951">     collectedAddressbookFound = false;</span>
<a href="#l17.5952"></a><span id="l17.5952"> </span>
<a href="#l17.5953"></a><span id="l17.5953">   nsresult rv;</span>
<a href="#l17.5954"></a><span id="l17.5954" class="difflineminus">-  nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l17.5955"></a><span id="l17.5955" class="difflineplus">+  nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l17.5956"></a><span id="l17.5956" class="difflineplus">+      do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l17.5957"></a><span id="l17.5957">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.5958"></a><span id="l17.5958"> </span>
<a href="#l17.5959"></a><span id="l17.5959">   nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l17.5960"></a><span id="l17.5960">   rv = abManager-&gt;GetDirectory(aDirUri, getter_AddRefs(directory));</span>
<a href="#l17.5961"></a><span id="l17.5961">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.5962"></a><span id="l17.5962"> </span>
<a href="#l17.5963"></a><span id="l17.5963">   nsCOMPtr&lt;nsISimpleEnumerator&gt; subDirectories;</span>
<a href="#l17.5964"></a><span id="l17.5964" class="difflineminus">-  if (NS_SUCCEEDED(directory-&gt;GetChildNodes(getter_AddRefs(subDirectories))) &amp;&amp; subDirectories)</span>
<a href="#l17.5965"></a><span id="l17.5965" class="difflineminus">-  {</span>
<a href="#l17.5966"></a><span id="l17.5966" class="difflineplus">+  if (NS_SUCCEEDED(directory-&gt;GetChildNodes(getter_AddRefs(subDirectories))) &amp;&amp;</span>
<a href="#l17.5967"></a><span id="l17.5967" class="difflineplus">+      subDirectories) {</span>
<a href="#l17.5968"></a><span id="l17.5968">     nsCOMPtr&lt;nsISupports&gt; item;</span>
<a href="#l17.5969"></a><span id="l17.5969">     bool hasMore;</span>
<a href="#l17.5970"></a><span id="l17.5970" class="difflineminus">-    while (NS_SUCCEEDED(rv = subDirectories-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l17.5971"></a><span id="l17.5971" class="difflineminus">-    {</span>
<a href="#l17.5972"></a><span id="l17.5972" class="difflineminus">-      if (NS_SUCCEEDED(subDirectories-&gt;GetNext(getter_AddRefs(item))))</span>
<a href="#l17.5973"></a><span id="l17.5973" class="difflineminus">-      {</span>
<a href="#l17.5974"></a><span id="l17.5974" class="difflineplus">+    while (NS_SUCCEEDED(rv = subDirectories-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp;</span>
<a href="#l17.5975"></a><span id="l17.5975" class="difflineplus">+           hasMore) {</span>
<a href="#l17.5976"></a><span id="l17.5976" class="difflineplus">+      if (NS_SUCCEEDED(subDirectories-&gt;GetNext(getter_AddRefs(item)))) {</span>
<a href="#l17.5977"></a><span id="l17.5977">         directory = do_QueryInterface(item, &amp;rv);</span>
<a href="#l17.5978"></a><span id="l17.5978" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l17.5979"></a><span id="l17.5979" class="difflineminus">-        {</span>
<a href="#l17.5980"></a><span id="l17.5980" class="difflineplus">+        if (NS_SUCCEEDED(rv)) {</span>
<a href="#l17.5981"></a><span id="l17.5981">           bool bIsMailList;</span>
<a href="#l17.5982"></a><span id="l17.5982"> </span>
<a href="#l17.5983"></a><span id="l17.5983" class="difflineminus">-          if (NS_SUCCEEDED(directory-&gt;GetIsMailList(&amp;bIsMailList)) &amp;&amp; bIsMailList)</span>
<a href="#l17.5984"></a><span id="l17.5984" class="difflineminus">-          {</span>
<a href="#l17.5985"></a><span id="l17.5985" class="difflineplus">+          if (NS_SUCCEEDED(directory-&gt;GetIsMailList(&amp;bIsMailList)) &amp;&amp;</span>
<a href="#l17.5986"></a><span id="l17.5986" class="difflineplus">+              bIsMailList) {</span>
<a href="#l17.5987"></a><span id="l17.5987">             aMailListArray.AppendElement(directory);</span>
<a href="#l17.5988"></a><span id="l17.5988">             continue;</span>
<a href="#l17.5989"></a><span id="l17.5989">           }</span>
<a href="#l17.5990"></a><span id="l17.5990"> </span>
<a href="#l17.5991"></a><span id="l17.5991">           nsCString uri;</span>
<a href="#l17.5992"></a><span id="l17.5992">           rv = directory-&gt;GetURI(uri);</span>
<a href="#l17.5993"></a><span id="l17.5993">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.5994"></a><span id="l17.5994"> </span>
<a href="#l17.5995"></a><span id="l17.5995">           int32_t pos;</span>
<a href="#l17.5996"></a><span id="l17.5996">           if (uri.EqualsLiteral(kPersonalAddressbookUri))</span>
<a href="#l17.5997"></a><span id="l17.5997">             pos = 0;</span>
<a href="#l17.5998"></a><span id="l17.5998" class="difflineminus">-          else</span>
<a href="#l17.5999"></a><span id="l17.5999" class="difflineminus">-          {</span>
<a href="#l17.6000"></a><span id="l17.6000" class="difflineplus">+          else {</span>
<a href="#l17.6001"></a><span id="l17.6001">             uint32_t count = aDirArray.Count();</span>
<a href="#l17.6002"></a><span id="l17.6002"> </span>
<a href="#l17.6003"></a><span id="l17.6003" class="difflineminus">-            if (uri.EqualsLiteral(kCollectedAddressbookUri))</span>
<a href="#l17.6004"></a><span id="l17.6004" class="difflineminus">-            {</span>
<a href="#l17.6005"></a><span id="l17.6005" class="difflineplus">+            if (uri.EqualsLiteral(kCollectedAddressbookUri)) {</span>
<a href="#l17.6006"></a><span id="l17.6006">               collectedAddressbookFound = true;</span>
<a href="#l17.6007"></a><span id="l17.6007">               pos = count;</span>
<a href="#l17.6008"></a><span id="l17.6008" class="difflineminus">-            }</span>
<a href="#l17.6009"></a><span id="l17.6009" class="difflineminus">-            else</span>
<a href="#l17.6010"></a><span id="l17.6010" class="difflineminus">-            {</span>
<a href="#l17.6011"></a><span id="l17.6011" class="difflineplus">+            } else {</span>
<a href="#l17.6012"></a><span id="l17.6012">               if (collectedAddressbookFound &amp;&amp; count &gt; 1)</span>
<a href="#l17.6013"></a><span id="l17.6013">                 pos = count - 1;</span>
<a href="#l17.6014"></a><span id="l17.6014">               else</span>
<a href="#l17.6015"></a><span id="l17.6015">                 pos = count;</span>
<a href="#l17.6016"></a><span id="l17.6016">             }</span>
<a href="#l17.6017"></a><span id="l17.6017">           }</span>
<a href="#l17.6018"></a><span id="l17.6018"> </span>
<a href="#l17.6019"></a><span id="l17.6019">           aDirArray.InsertObjectAt(directory, pos);</span>
<a href="#l17.6020"></a><span id="l17.6020" class="difflineat">@@ -4881,40 +4471,40 @@ nsMsgCompose::GetABDirAndMailLists(const</span>
<a href="#l17.6021"></a><span id="l17.6021">   }</span>
<a href="#l17.6022"></a><span id="l17.6022">   return rv;</span>
<a href="#l17.6023"></a><span id="l17.6023"> }</span>
<a href="#l17.6024"></a><span id="l17.6024"> </span>
<a href="#l17.6025"></a><span id="l17.6025"> /**</span>
<a href="#l17.6026"></a><span id="l17.6026">  * Comparator for use with nsTArray::IndexOf to find a recipient.</span>
<a href="#l17.6027"></a><span id="l17.6027">  * This comparator will check if an &quot;address&quot; is a mail list or not.</span>
<a href="#l17.6028"></a><span id="l17.6028">  */</span>
<a href="#l17.6029"></a><span id="l17.6029" class="difflineminus">-struct nsMsgMailListComparator</span>
<a href="#l17.6030"></a><span id="l17.6030" class="difflineminus">-{</span>
<a href="#l17.6031"></a><span id="l17.6031" class="difflineplus">+struct nsMsgMailListComparator {</span>
<a href="#l17.6032"></a><span id="l17.6032">   // A mail list will have one of the formats</span>
<a href="#l17.6033"></a><span id="l17.6033">   //  1) &quot;mName &lt;mDescription&gt;&quot; when the list has a description</span>
<a href="#l17.6034"></a><span id="l17.6034">   //  2) &quot;mName &lt;mName&gt;&quot; when the list lacks description</span>
<a href="#l17.6035"></a><span id="l17.6035">   // A recipient is of the form &quot;mName &lt;mEmail&gt;&quot; - for equality the list</span>
<a href="#l17.6036"></a><span id="l17.6036">   // name must be the same. The recipient &quot;email&quot; must match the list name for</span>
<a href="#l17.6037"></a><span id="l17.6037">   // case 1, and the list description for case 2.</span>
<a href="#l17.6038"></a><span id="l17.6038">   bool Equals(const nsMsgMailList &amp;mailList,</span>
<a href="#l17.6039"></a><span id="l17.6039">               const nsMsgRecipient &amp;recipient) const {</span>
<a href="#l17.6040"></a><span id="l17.6040">     if (!mailList.mName.Equals(recipient.mName,</span>
<a href="#l17.6041"></a><span id="l17.6041">                                nsCaseInsensitiveStringComparator()))</span>
<a href="#l17.6042"></a><span id="l17.6042">       return false;</span>
<a href="#l17.6043"></a><span id="l17.6043" class="difflineminus">-    return mailList.mDescription.IsEmpty() ?</span>
<a href="#l17.6044"></a><span id="l17.6044" class="difflineminus">-      mailList.mName.Equals(recipient.mEmail, nsCaseInsensitiveStringComparator()) :</span>
<a href="#l17.6045"></a><span id="l17.6045" class="difflineminus">-      mailList.mDescription.Equals(recipient.mEmail, nsCaseInsensitiveStringComparator());</span>
<a href="#l17.6046"></a><span id="l17.6046" class="difflineplus">+    return mailList.mDescription.IsEmpty()</span>
<a href="#l17.6047"></a><span id="l17.6047" class="difflineplus">+               ? mailList.mName.Equals(recipient.mEmail,</span>
<a href="#l17.6048"></a><span id="l17.6048" class="difflineplus">+                                       nsCaseInsensitiveStringComparator())</span>
<a href="#l17.6049"></a><span id="l17.6049" class="difflineplus">+               : mailList.mDescription.Equals(</span>
<a href="#l17.6050"></a><span id="l17.6050" class="difflineplus">+                     recipient.mEmail, nsCaseInsensitiveStringComparator());</span>
<a href="#l17.6051"></a><span id="l17.6051">   }</span>
<a href="#l17.6052"></a><span id="l17.6052"> };</span>
<a href="#l17.6053"></a><span id="l17.6053"> </span>
<a href="#l17.6054"></a><span id="l17.6054"> /**</span>
<a href="#l17.6055"></a><span id="l17.6055">  * Comparator for use with nsTArray::IndexOf to find a recipient.</span>
<a href="#l17.6056"></a><span id="l17.6056">  */</span>
<a href="#l17.6057"></a><span id="l17.6057" class="difflineminus">-struct nsMsgRecipientComparator</span>
<a href="#l17.6058"></a><span id="l17.6058" class="difflineminus">-{</span>
<a href="#l17.6059"></a><span id="l17.6059" class="difflineplus">+struct nsMsgRecipientComparator {</span>
<a href="#l17.6060"></a><span id="l17.6060">   bool Equals(const nsMsgRecipient &amp;recipient,</span>
<a href="#l17.6061"></a><span id="l17.6061">               const nsMsgRecipient &amp;recipientToFind) const {</span>
<a href="#l17.6062"></a><span id="l17.6062">     if (!recipient.mEmail.Equals(recipientToFind.mEmail,</span>
<a href="#l17.6063"></a><span id="l17.6063">                                  nsCaseInsensitiveStringComparator()))</span>
<a href="#l17.6064"></a><span id="l17.6064">       return false;</span>
<a href="#l17.6065"></a><span id="l17.6065"> </span>
<a href="#l17.6066"></a><span id="l17.6066">     if (!recipient.mName.Equals(recipientToFind.mName,</span>
<a href="#l17.6067"></a><span id="l17.6067">                                 nsCaseInsensitiveStringComparator()))</span>
<a href="#l17.6068"></a><span id="l17.6068" class="difflineat">@@ -4930,68 +4520,63 @@ struct nsMsgRecipientComparator</span>
<a href="#l17.6069"></a><span id="l17.6069">  * already visited mailing lists to avoid endless recursion.</span>
<a href="#l17.6070"></a><span id="l17.6070">  *</span>
<a href="#l17.6071"></a><span id="l17.6071">  * @param aMailList             the list</span>
<a href="#l17.6072"></a><span id="l17.6072">  * @param allDirectoriesArray   all directories</span>
<a href="#l17.6073"></a><span id="l17.6073">  * @param allMailListArray      all maillists</span>
<a href="#l17.6074"></a><span id="l17.6074">  * @param mailListProcessed     maillists processed (to avoid recursive lists)</span>
<a href="#l17.6075"></a><span id="l17.6075">  * @param aListMembers          list members</span>
<a href="#l17.6076"></a><span id="l17.6076">  */</span>
<a href="#l17.6077"></a><span id="l17.6077" class="difflineminus">-nsresult</span>
<a href="#l17.6078"></a><span id="l17.6078" class="difflineminus">-nsMsgCompose::ResolveMailList(nsIAbDirectory* aMailList,</span>
<a href="#l17.6079"></a><span id="l17.6079" class="difflineminus">-                              nsCOMArray&lt;nsIAbDirectory&gt; &amp;allDirectoriesArray,</span>
<a href="#l17.6080"></a><span id="l17.6080" class="difflineminus">-                              nsTArray&lt;nsMsgMailList&gt; &amp;allMailListArray,</span>
<a href="#l17.6081"></a><span id="l17.6081" class="difflineminus">-                              nsTArray&lt;nsMsgMailList&gt; &amp;mailListProcessed,</span>
<a href="#l17.6082"></a><span id="l17.6082" class="difflineminus">-                              nsTArray&lt;nsMsgRecipient&gt; &amp;aListMembers)</span>
<a href="#l17.6083"></a><span id="l17.6083" class="difflineminus">-{</span>
<a href="#l17.6084"></a><span id="l17.6084" class="difflineplus">+nsresult nsMsgCompose::ResolveMailList(</span>
<a href="#l17.6085"></a><span id="l17.6085" class="difflineplus">+    nsIAbDirectory *aMailList, nsCOMArray&lt;nsIAbDirectory&gt; &amp;allDirectoriesArray,</span>
<a href="#l17.6086"></a><span id="l17.6086" class="difflineplus">+    nsTArray&lt;nsMsgMailList&gt; &amp;allMailListArray,</span>
<a href="#l17.6087"></a><span id="l17.6087" class="difflineplus">+    nsTArray&lt;nsMsgMailList&gt; &amp;mailListProcessed,</span>
<a href="#l17.6088"></a><span id="l17.6088" class="difflineplus">+    nsTArray&lt;nsMsgRecipient&gt; &amp;aListMembers) {</span>
<a href="#l17.6089"></a><span id="l17.6089">   nsresult rv = NS_OK;</span>
<a href="#l17.6090"></a><span id="l17.6090"> </span>
<a href="#l17.6091"></a><span id="l17.6091">   nsCOMPtr&lt;nsIMutableArray&gt; mailListAddresses;</span>
<a href="#l17.6092"></a><span id="l17.6092">   rv = aMailList-&gt;GetAddressLists(getter_AddRefs(mailListAddresses));</span>
<a href="#l17.6093"></a><span id="l17.6093" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l17.6094"></a><span id="l17.6094" class="difflineminus">-    return rv;</span>
<a href="#l17.6095"></a><span id="l17.6095" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l17.6096"></a><span id="l17.6096"> </span>
<a href="#l17.6097"></a><span id="l17.6097">   uint32_t nbrAddresses = 0;</span>
<a href="#l17.6098"></a><span id="l17.6098">   mailListAddresses-&gt;GetLength(&amp;nbrAddresses);</span>
<a href="#l17.6099"></a><span id="l17.6099" class="difflineminus">-  for (uint32_t i = 0; i &lt; nbrAddresses; i++)</span>
<a href="#l17.6100"></a><span id="l17.6100" class="difflineminus">-  {</span>
<a href="#l17.6101"></a><span id="l17.6101" class="difflineminus">-    nsCOMPtr&lt;nsIAbCard&gt; existingCard(do_QueryElementAt(mailListAddresses, i, &amp;rv));</span>
<a href="#l17.6102"></a><span id="l17.6102" class="difflineplus">+  for (uint32_t i = 0; i &lt; nbrAddresses; i++) {</span>
<a href="#l17.6103"></a><span id="l17.6103" class="difflineplus">+    nsCOMPtr&lt;nsIAbCard&gt; existingCard(</span>
<a href="#l17.6104"></a><span id="l17.6104" class="difflineplus">+        do_QueryElementAt(mailListAddresses, i, &amp;rv));</span>
<a href="#l17.6105"></a><span id="l17.6105">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.6106"></a><span id="l17.6106"> </span>
<a href="#l17.6107"></a><span id="l17.6107">     nsMsgRecipient newRecipient;</span>
<a href="#l17.6108"></a><span id="l17.6108"> </span>
<a href="#l17.6109"></a><span id="l17.6109">     rv = existingCard-&gt;GetDisplayName(newRecipient.mName);</span>
<a href="#l17.6110"></a><span id="l17.6110">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.6111"></a><span id="l17.6111">     rv = existingCard-&gt;GetPrimaryEmail(newRecipient.mEmail);</span>
<a href="#l17.6112"></a><span id="l17.6112">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.6113"></a><span id="l17.6113"> </span>
<a href="#l17.6114"></a><span id="l17.6114">     if (newRecipient.mName.IsEmpty() &amp;&amp; newRecipient.mEmail.IsEmpty()) {</span>
<a href="#l17.6115"></a><span id="l17.6115">       continue;</span>
<a href="#l17.6116"></a><span id="l17.6116">     }</span>
<a href="#l17.6117"></a><span id="l17.6117"> </span>
<a href="#l17.6118"></a><span id="l17.6118">     // First check if it's a mailing list.</span>
<a href="#l17.6119"></a><span id="l17.6119" class="difflineminus">-    size_t index = allMailListArray.IndexOf(newRecipient, 0, nsMsgMailListComparator());</span>
<a href="#l17.6120"></a><span id="l17.6120" class="difflineminus">-    if (index != allMailListArray.NoIndex &amp;&amp; allMailListArray[index].mDirectory)</span>
<a href="#l17.6121"></a><span id="l17.6121" class="difflineminus">-    {</span>
<a href="#l17.6122"></a><span id="l17.6122" class="difflineplus">+    size_t index =</span>
<a href="#l17.6123"></a><span id="l17.6123" class="difflineplus">+        allMailListArray.IndexOf(newRecipient, 0, nsMsgMailListComparator());</span>
<a href="#l17.6124"></a><span id="l17.6124" class="difflineplus">+    if (index != allMailListArray.NoIndex &amp;&amp;</span>
<a href="#l17.6125"></a><span id="l17.6125" class="difflineplus">+        allMailListArray[index].mDirectory) {</span>
<a href="#l17.6126"></a><span id="l17.6126">       // Check if maillist processed.</span>
<a href="#l17.6127"></a><span id="l17.6127">       if (mailListProcessed.Contains(newRecipient, nsMsgMailListComparator())) {</span>
<a href="#l17.6128"></a><span id="l17.6128">         continue;</span>
<a href="#l17.6129"></a><span id="l17.6129">       }</span>
<a href="#l17.6130"></a><span id="l17.6130"> </span>
<a href="#l17.6131"></a><span id="l17.6131">       nsCOMPtr&lt;nsIAbDirectory&gt; directory2(allMailListArray[index].mDirectory);</span>
<a href="#l17.6132"></a><span id="l17.6132"> </span>
<a href="#l17.6133"></a><span id="l17.6133">       // Add mailList to mailListProcessed.</span>
<a href="#l17.6134"></a><span id="l17.6134">       mailListProcessed.AppendElement(directory2);</span>
<a href="#l17.6135"></a><span id="l17.6135"> </span>
<a href="#l17.6136"></a><span id="l17.6136">       // Resolve mailList members.</span>
<a href="#l17.6137"></a><span id="l17.6137" class="difflineminus">-      rv = ResolveMailList(directory2,</span>
<a href="#l17.6138"></a><span id="l17.6138" class="difflineminus">-                           allDirectoriesArray,</span>
<a href="#l17.6139"></a><span id="l17.6139" class="difflineminus">-                           allMailListArray,</span>
<a href="#l17.6140"></a><span id="l17.6140" class="difflineminus">-                           mailListProcessed,</span>
<a href="#l17.6141"></a><span id="l17.6141" class="difflineminus">-                           aListMembers);</span>
<a href="#l17.6142"></a><span id="l17.6142" class="difflineplus">+      rv = ResolveMailList(directory2, allDirectoriesArray, allMailListArray,</span>
<a href="#l17.6143"></a><span id="l17.6143" class="difflineplus">+                           mailListProcessed, aListMembers);</span>
<a href="#l17.6144"></a><span id="l17.6144">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.6145"></a><span id="l17.6145"> </span>
<a href="#l17.6146"></a><span id="l17.6146">       continue;</span>
<a href="#l17.6147"></a><span id="l17.6147">     }</span>
<a href="#l17.6148"></a><span id="l17.6148"> </span>
<a href="#l17.6149"></a><span id="l17.6149">     // Check if recipient is in aListMembers.</span>
<a href="#l17.6150"></a><span id="l17.6150">     if (aListMembers.Contains(newRecipient, nsMsgRecipientComparator())) {</span>
<a href="#l17.6151"></a><span id="l17.6151">       continue;</span>
<a href="#l17.6152"></a><span id="l17.6152" class="difflineat">@@ -5011,653 +4596,582 @@ nsMsgCompose::ResolveMailList(nsIAbDirec</span>
<a href="#l17.6153"></a><span id="l17.6153">  * Lookup the recipients as specified in the compose fields (To, Cc, Bcc)</span>
<a href="#l17.6154"></a><span id="l17.6154">  * in the address books and return an array of individual recipients.</span>
<a href="#l17.6155"></a><span id="l17.6155">  * Mailing lists are replaced by the cards they contain, nested and recursive</span>
<a href="#l17.6156"></a><span id="l17.6156">  * lists are taken care of, recipients contained in multiple lists are only</span>
<a href="#l17.6157"></a><span id="l17.6157">  * added once.</span>
<a href="#l17.6158"></a><span id="l17.6158">  *</span>
<a href="#l17.6159"></a><span id="l17.6159">  * @param recipientsList        (out) recipient array</span>
<a href="#l17.6160"></a><span id="l17.6160">  */</span>
<a href="#l17.6161"></a><span id="l17.6161" class="difflineminus">-nsresult</span>
<a href="#l17.6162"></a><span id="l17.6162" class="difflineminus">-nsMsgCompose::LookupAddressBook(RecipientsArray &amp;recipientsList)</span>
<a href="#l17.6163"></a><span id="l17.6163" class="difflineminus">-{</span>
<a href="#l17.6164"></a><span id="l17.6164" class="difflineplus">+nsresult nsMsgCompose::LookupAddressBook(RecipientsArray &amp;recipientsList) {</span>
<a href="#l17.6165"></a><span id="l17.6165">   nsresult rv = NS_OK;</span>
<a href="#l17.6166"></a><span id="l17.6166"> </span>
<a href="#l17.6167"></a><span id="l17.6167">   // First, build some arrays with the original recipients.</span>
<a href="#l17.6168"></a><span id="l17.6168"> </span>
<a href="#l17.6169"></a><span id="l17.6169">   nsAutoString originalRecipients[MAX_OF_RECIPIENT_ARRAY];</span>
<a href="#l17.6170"></a><span id="l17.6170">   m_compFields-&gt;GetTo(originalRecipients[0]);</span>
<a href="#l17.6171"></a><span id="l17.6171">   m_compFields-&gt;GetCc(originalRecipients[1]);</span>
<a href="#l17.6172"></a><span id="l17.6172">   m_compFields-&gt;GetBcc(originalRecipients[2]);</span>
<a href="#l17.6173"></a><span id="l17.6173"> </span>
<a href="#l17.6174"></a><span id="l17.6174" class="difflineminus">-  for (uint32_t i = 0; i &lt; MAX_OF_RECIPIENT_ARRAY; ++i)</span>
<a href="#l17.6175"></a><span id="l17.6175" class="difflineminus">-  {</span>
<a href="#l17.6176"></a><span id="l17.6176" class="difflineminus">-    if (originalRecipients[i].IsEmpty())</span>
<a href="#l17.6177"></a><span id="l17.6177" class="difflineminus">-      continue;</span>
<a href="#l17.6178"></a><span id="l17.6178" class="difflineplus">+  for (uint32_t i = 0; i &lt; MAX_OF_RECIPIENT_ARRAY; ++i) {</span>
<a href="#l17.6179"></a><span id="l17.6179" class="difflineplus">+    if (originalRecipients[i].IsEmpty()) continue;</span>
<a href="#l17.6180"></a><span id="l17.6180"> </span>
<a href="#l17.6181"></a><span id="l17.6181">     rv = m_compFields-&gt;SplitRecipientsEx(originalRecipients[i],</span>
<a href="#l17.6182"></a><span id="l17.6182">                                          recipientsList[i]);</span>
<a href="#l17.6183"></a><span id="l17.6183">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.6184"></a><span id="l17.6184">   }</span>
<a href="#l17.6185"></a><span id="l17.6185"> </span>
<a href="#l17.6186"></a><span id="l17.6186">   // Then look them up in the Addressbooks</span>
<a href="#l17.6187"></a><span id="l17.6187">   bool stillNeedToSearch = true;</span>
<a href="#l17.6188"></a><span id="l17.6188">   nsCOMPtr&lt;nsIAbDirectory&gt; abDirectory;</span>
<a href="#l17.6189"></a><span id="l17.6189">   nsCOMPtr&lt;nsIAbCard&gt; existingCard;</span>
<a href="#l17.6190"></a><span id="l17.6190">   nsTArray&lt;nsMsgMailList&gt; mailListArray;</span>
<a href="#l17.6191"></a><span id="l17.6191">   nsTArray&lt;nsMsgMailList&gt; mailListProcessed;</span>
<a href="#l17.6192"></a><span id="l17.6192"> </span>
<a href="#l17.6193"></a><span id="l17.6193">   nsCOMArray&lt;nsIAbDirectory&gt; addrbookDirArray;</span>
<a href="#l17.6194"></a><span id="l17.6194">   rv = GetABDirAndMailLists(NS_LITERAL_CSTRING(kAllDirectoryRoot),</span>
<a href="#l17.6195"></a><span id="l17.6195">                             addrbookDirArray, mailListArray);</span>
<a href="#l17.6196"></a><span id="l17.6196" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l17.6197"></a><span id="l17.6197" class="difflineminus">-    return rv;</span>
<a href="#l17.6198"></a><span id="l17.6198" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l17.6199"></a><span id="l17.6199"> </span>
<a href="#l17.6200"></a><span id="l17.6200">   nsString dirPath;</span>
<a href="#l17.6201"></a><span id="l17.6201">   uint32_t nbrAddressbook = addrbookDirArray.Count();</span>
<a href="#l17.6202"></a><span id="l17.6202"> </span>
<a href="#l17.6203"></a><span id="l17.6203" class="difflineminus">-  for (uint32_t k = 0; k &lt; nbrAddressbook &amp;&amp; stillNeedToSearch; ++k)</span>
<a href="#l17.6204"></a><span id="l17.6204" class="difflineminus">-  {</span>
<a href="#l17.6205"></a><span id="l17.6205" class="difflineplus">+  for (uint32_t k = 0; k &lt; nbrAddressbook &amp;&amp; stillNeedToSearch; ++k) {</span>
<a href="#l17.6206"></a><span id="l17.6206">     // Avoid recursive mailing lists.</span>
<a href="#l17.6207"></a><span id="l17.6207" class="difflineminus">-    if (abDirectory &amp;&amp; (addrbookDirArray[k] == abDirectory))</span>
<a href="#l17.6208"></a><span id="l17.6208" class="difflineminus">-    {</span>
<a href="#l17.6209"></a><span id="l17.6209" class="difflineplus">+    if (abDirectory &amp;&amp; (addrbookDirArray[k] == abDirectory)) {</span>
<a href="#l17.6210"></a><span id="l17.6210">       stillNeedToSearch = false;</span>
<a href="#l17.6211"></a><span id="l17.6211">       break;</span>
<a href="#l17.6212"></a><span id="l17.6212">     }</span>
<a href="#l17.6213"></a><span id="l17.6213"> </span>
<a href="#l17.6214"></a><span id="l17.6214">     abDirectory = addrbookDirArray[k];</span>
<a href="#l17.6215"></a><span id="l17.6215" class="difflineminus">-    if (!abDirectory)</span>
<a href="#l17.6216"></a><span id="l17.6216" class="difflineminus">-      continue;</span>
<a href="#l17.6217"></a><span id="l17.6217" class="difflineplus">+    if (!abDirectory) continue;</span>
<a href="#l17.6218"></a><span id="l17.6218"> </span>
<a href="#l17.6219"></a><span id="l17.6219">     stillNeedToSearch = false;</span>
<a href="#l17.6220"></a><span id="l17.6220" class="difflineminus">-    for (uint32_t i = 0; i &lt; MAX_OF_RECIPIENT_ARRAY; i ++)</span>
<a href="#l17.6221"></a><span id="l17.6221" class="difflineminus">-    {</span>
<a href="#l17.6222"></a><span id="l17.6222" class="difflineplus">+    for (uint32_t i = 0; i &lt; MAX_OF_RECIPIENT_ARRAY; i++) {</span>
<a href="#l17.6223"></a><span id="l17.6223">       mailListProcessed.Clear();</span>
<a href="#l17.6224"></a><span id="l17.6224"> </span>
<a href="#l17.6225"></a><span id="l17.6225">       // Note: We check this each time to allow for length changes.</span>
<a href="#l17.6226"></a><span id="l17.6226" class="difflineminus">-      for (uint32_t j = 0; j &lt; recipientsList[i].Length(); j++)</span>
<a href="#l17.6227"></a><span id="l17.6227" class="difflineminus">-      {</span>
<a href="#l17.6228"></a><span id="l17.6228" class="difflineplus">+      for (uint32_t j = 0; j &lt; recipientsList[i].Length(); j++) {</span>
<a href="#l17.6229"></a><span id="l17.6229">         nsMsgRecipient &amp;recipient = recipientsList[i][j];</span>
<a href="#l17.6230"></a><span id="l17.6230" class="difflineminus">-        if (!recipient.mDirectory)</span>
<a href="#l17.6231"></a><span id="l17.6231" class="difflineminus">-        {</span>
<a href="#l17.6232"></a><span id="l17.6232" class="difflineplus">+        if (!recipient.mDirectory) {</span>
<a href="#l17.6233"></a><span id="l17.6233">           // First check if it's a mailing list.</span>
<a href="#l17.6234"></a><span id="l17.6234" class="difflineminus">-          size_t index = mailListArray.IndexOf(recipient, 0, nsMsgMailListComparator());</span>
<a href="#l17.6235"></a><span id="l17.6235" class="difflineminus">-          if (index != mailListArray.NoIndex &amp;&amp; mailListArray[index].mDirectory)</span>
<a href="#l17.6236"></a><span id="l17.6236" class="difflineminus">-          {</span>
<a href="#l17.6237"></a><span id="l17.6237" class="difflineplus">+          size_t index =</span>
<a href="#l17.6238"></a><span id="l17.6238" class="difflineplus">+              mailListArray.IndexOf(recipient, 0, nsMsgMailListComparator());</span>
<a href="#l17.6239"></a><span id="l17.6239" class="difflineplus">+          if (index != mailListArray.NoIndex &amp;&amp;</span>
<a href="#l17.6240"></a><span id="l17.6240" class="difflineplus">+              mailListArray[index].mDirectory) {</span>
<a href="#l17.6241"></a><span id="l17.6241">             // Check mailList Processed.</span>
<a href="#l17.6242"></a><span id="l17.6242" class="difflineminus">-            if (mailListProcessed.Contains(recipient, nsMsgMailListComparator())) {</span>
<a href="#l17.6243"></a><span id="l17.6243" class="difflineplus">+            if (mailListProcessed.Contains(recipient,</span>
<a href="#l17.6244"></a><span id="l17.6244" class="difflineplus">+                                           nsMsgMailListComparator())) {</span>
<a href="#l17.6245"></a><span id="l17.6245">               // Remove from recipientsList.</span>
<a href="#l17.6246"></a><span id="l17.6246">               recipientsList[i].RemoveElementAt(j--);</span>
<a href="#l17.6247"></a><span id="l17.6247">               continue;</span>
<a href="#l17.6248"></a><span id="l17.6248">             }</span>
<a href="#l17.6249"></a><span id="l17.6249"> </span>
<a href="#l17.6250"></a><span id="l17.6250">             nsCOMPtr&lt;nsIAbDirectory&gt; directory(mailListArray[index].mDirectory);</span>
<a href="#l17.6251"></a><span id="l17.6251"> </span>
<a href="#l17.6252"></a><span id="l17.6252">             // Add mailList to mailListProcessed.</span>
<a href="#l17.6253"></a><span id="l17.6253">             mailListProcessed.AppendElement(directory);</span>
<a href="#l17.6254"></a><span id="l17.6254"> </span>
<a href="#l17.6255"></a><span id="l17.6255">             // Resolve mailList members.</span>
<a href="#l17.6256"></a><span id="l17.6256">             nsTArray&lt;nsMsgRecipient&gt; members;</span>
<a href="#l17.6257"></a><span id="l17.6257" class="difflineminus">-            rv = ResolveMailList(directory,</span>
<a href="#l17.6258"></a><span id="l17.6258" class="difflineminus">-                                 addrbookDirArray,</span>
<a href="#l17.6259"></a><span id="l17.6259" class="difflineminus">-                                 mailListArray,</span>
<a href="#l17.6260"></a><span id="l17.6260" class="difflineminus">-                                 mailListProcessed,</span>
<a href="#l17.6261"></a><span id="l17.6261" class="difflineminus">-                                 members);</span>
<a href="#l17.6262"></a><span id="l17.6262" class="difflineplus">+            rv = ResolveMailList(directory, addrbookDirArray, mailListArray,</span>
<a href="#l17.6263"></a><span id="l17.6263" class="difflineplus">+                                 mailListProcessed, members);</span>
<a href="#l17.6264"></a><span id="l17.6264">             NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.6265"></a><span id="l17.6265"> </span>
<a href="#l17.6266"></a><span id="l17.6266">             // Remove mailList from recipientsList.</span>
<a href="#l17.6267"></a><span id="l17.6267">             recipientsList[i].RemoveElementAt(j);</span>
<a href="#l17.6268"></a><span id="l17.6268"> </span>
<a href="#l17.6269"></a><span id="l17.6269">             // Merge members into recipientsList[i].</span>
<a href="#l17.6270"></a><span id="l17.6270">             uint32_t pos = 0;</span>
<a href="#l17.6271"></a><span id="l17.6271" class="difflineminus">-            for (uint32_t c = 0; c &lt; members.Length(); c++)</span>
<a href="#l17.6272"></a><span id="l17.6272" class="difflineminus">-            {</span>
<a href="#l17.6273"></a><span id="l17.6273" class="difflineplus">+            for (uint32_t c = 0; c &lt; members.Length(); c++) {</span>
<a href="#l17.6274"></a><span id="l17.6274">               nsMsgRecipient &amp;member = members[c];</span>
<a href="#l17.6275"></a><span id="l17.6275" class="difflineminus">-              if (!recipientsList[i].Contains(member, nsMsgRecipientComparator())) {</span>
<a href="#l17.6276"></a><span id="l17.6276" class="difflineplus">+              if (!recipientsList[i].Contains(member,</span>
<a href="#l17.6277"></a><span id="l17.6277" class="difflineplus">+                                              nsMsgRecipientComparator())) {</span>
<a href="#l17.6278"></a><span id="l17.6278">                 recipientsList[i].InsertElementAt(j + pos, member);</span>
<a href="#l17.6279"></a><span id="l17.6279">                 pos++;</span>
<a href="#l17.6280"></a><span id="l17.6280">               }</span>
<a href="#l17.6281"></a><span id="l17.6281">             }</span>
<a href="#l17.6282"></a><span id="l17.6282" class="difflineminus">-          }</span>
<a href="#l17.6283"></a><span id="l17.6283" class="difflineminus">-          else</span>
<a href="#l17.6284"></a><span id="l17.6284" class="difflineminus">-          {</span>
<a href="#l17.6285"></a><span id="l17.6285" class="difflineplus">+          } else {</span>
<a href="#l17.6286"></a><span id="l17.6286">             // Find a card that contains this e-mail address.</span>
<a href="#l17.6287"></a><span id="l17.6287" class="difflineminus">-            rv = abDirectory-&gt;CardForEmailAddress(NS_ConvertUTF16toUTF8(recipient.mEmail),</span>
<a href="#l17.6288"></a><span id="l17.6288" class="difflineminus">-                                                  getter_AddRefs(existingCard));</span>
<a href="#l17.6289"></a><span id="l17.6289" class="difflineminus">-            if (NS_SUCCEEDED(rv) &amp;&amp; existingCard)</span>
<a href="#l17.6290"></a><span id="l17.6290" class="difflineminus">-            {</span>
<a href="#l17.6291"></a><span id="l17.6291" class="difflineplus">+            rv = abDirectory-&gt;CardForEmailAddress(</span>
<a href="#l17.6292"></a><span id="l17.6292" class="difflineplus">+                NS_ConvertUTF16toUTF8(recipient.mEmail),</span>
<a href="#l17.6293"></a><span id="l17.6293" class="difflineplus">+                getter_AddRefs(existingCard));</span>
<a href="#l17.6294"></a><span id="l17.6294" class="difflineplus">+            if (NS_SUCCEEDED(rv) &amp;&amp; existingCard) {</span>
<a href="#l17.6295"></a><span id="l17.6295">               recipient.mCard = existingCard;</span>
<a href="#l17.6296"></a><span id="l17.6296">               recipient.mDirectory = abDirectory;</span>
<a href="#l17.6297"></a><span id="l17.6297" class="difflineminus">-            }</span>
<a href="#l17.6298"></a><span id="l17.6298" class="difflineminus">-            else</span>
<a href="#l17.6299"></a><span id="l17.6299" class="difflineminus">-            {</span>
<a href="#l17.6300"></a><span id="l17.6300" class="difflineplus">+            } else {</span>
<a href="#l17.6301"></a><span id="l17.6301">               stillNeedToSearch = true;</span>
<a href="#l17.6302"></a><span id="l17.6302">             }</span>
<a href="#l17.6303"></a><span id="l17.6303">           }</span>
<a href="#l17.6304"></a><span id="l17.6304">         }</span>
<a href="#l17.6305"></a><span id="l17.6305">       }</span>
<a href="#l17.6306"></a><span id="l17.6306">     }</span>
<a href="#l17.6307"></a><span id="l17.6307">   }</span>
<a href="#l17.6308"></a><span id="l17.6308"> </span>
<a href="#l17.6309"></a><span id="l17.6309">   return rv;</span>
<a href="#l17.6310"></a><span id="l17.6310"> }</span>
<a href="#l17.6311"></a><span id="l17.6311"> </span>
<a href="#l17.6312"></a><span id="l17.6312"> NS_IMETHODIMP</span>
<a href="#l17.6313"></a><span id="l17.6313" class="difflineminus">-nsMsgCompose::ExpandMailingLists()</span>
<a href="#l17.6314"></a><span id="l17.6314" class="difflineminus">-{</span>
<a href="#l17.6315"></a><span id="l17.6315" class="difflineplus">+nsMsgCompose::ExpandMailingLists() {</span>
<a href="#l17.6316"></a><span id="l17.6316">   RecipientsArray recipientsList;</span>
<a href="#l17.6317"></a><span id="l17.6317">   nsresult rv = LookupAddressBook(recipientsList);</span>
<a href="#l17.6318"></a><span id="l17.6318">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.6319"></a><span id="l17.6319"> </span>
<a href="#l17.6320"></a><span id="l17.6320">   // Reset the final headers with the expanded mailing lists.</span>
<a href="#l17.6321"></a><span id="l17.6321">   nsAutoString recipientsStr;</span>
<a href="#l17.6322"></a><span id="l17.6322"> </span>
<a href="#l17.6323"></a><span id="l17.6323" class="difflineminus">-  for (int i = 0; i &lt; MAX_OF_RECIPIENT_ARRAY; ++i)</span>
<a href="#l17.6324"></a><span id="l17.6324" class="difflineminus">-  {</span>
<a href="#l17.6325"></a><span id="l17.6325" class="difflineplus">+  for (int i = 0; i &lt; MAX_OF_RECIPIENT_ARRAY; ++i) {</span>
<a href="#l17.6326"></a><span id="l17.6326">     uint32_t nbrRecipients = recipientsList[i].Length();</span>
<a href="#l17.6327"></a><span id="l17.6327" class="difflineminus">-    if (nbrRecipients == 0)</span>
<a href="#l17.6328"></a><span id="l17.6328" class="difflineminus">-      continue;</span>
<a href="#l17.6329"></a><span id="l17.6329" class="difflineplus">+    if (nbrRecipients == 0) continue;</span>
<a href="#l17.6330"></a><span id="l17.6330">     recipientsStr.Truncate();</span>
<a href="#l17.6331"></a><span id="l17.6331"> </span>
<a href="#l17.6332"></a><span id="l17.6332">     // Note: We check this each time to allow for length changes.</span>
<a href="#l17.6333"></a><span id="l17.6333" class="difflineminus">-    for (uint32_t j = 0; j &lt; recipientsList[i].Length(); ++j)</span>
<a href="#l17.6334"></a><span id="l17.6334" class="difflineminus">-    {</span>
<a href="#l17.6335"></a><span id="l17.6335" class="difflineplus">+    for (uint32_t j = 0; j &lt; recipientsList[i].Length(); ++j) {</span>
<a href="#l17.6336"></a><span id="l17.6336">       nsMsgRecipient &amp;recipient = recipientsList[i][j];</span>
<a href="#l17.6337"></a><span id="l17.6337"> </span>
<a href="#l17.6338"></a><span id="l17.6338" class="difflineminus">-      if (!recipientsStr.IsEmpty())</span>
<a href="#l17.6339"></a><span id="l17.6339" class="difflineminus">-        recipientsStr.Append(char16_t(','));</span>
<a href="#l17.6340"></a><span id="l17.6340" class="difflineplus">+      if (!recipientsStr.IsEmpty()) recipientsStr.Append(char16_t(','));</span>
<a href="#l17.6341"></a><span id="l17.6341">       nsAutoString address;</span>
<a href="#l17.6342"></a><span id="l17.6342">       MakeMimeAddress(recipient.mName, recipient.mEmail, address);</span>
<a href="#l17.6343"></a><span id="l17.6343">       recipientsStr.Append(address);</span>
<a href="#l17.6344"></a><span id="l17.6344"> </span>
<a href="#l17.6345"></a><span id="l17.6345" class="difflineminus">-      if (recipient.mCard)</span>
<a href="#l17.6346"></a><span id="l17.6346" class="difflineminus">-      {</span>
<a href="#l17.6347"></a><span id="l17.6347" class="difflineplus">+      if (recipient.mCard) {</span>
<a href="#l17.6348"></a><span id="l17.6348">         bool readOnly;</span>
<a href="#l17.6349"></a><span id="l17.6349">         rv = recipient.mDirectory-&gt;GetReadOnly(&amp;readOnly);</span>
<a href="#l17.6350"></a><span id="l17.6350">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.6351"></a><span id="l17.6351"> </span>
<a href="#l17.6352"></a><span id="l17.6352">         // Bump the popularity index for this card since we are about to send</span>
<a href="#l17.6353"></a><span id="l17.6353">         // e-mail to it.</span>
<a href="#l17.6354"></a><span id="l17.6354" class="difflineminus">-        if (!readOnly)</span>
<a href="#l17.6355"></a><span id="l17.6355" class="difflineminus">-        {</span>
<a href="#l17.6356"></a><span id="l17.6356" class="difflineplus">+        if (!readOnly) {</span>
<a href="#l17.6357"></a><span id="l17.6357">           uint32_t popularityIndex = 0;</span>
<a href="#l17.6358"></a><span id="l17.6358">           if (NS_FAILED(recipient.mCard-&gt;GetPropertyAsUint32(</span>
<a href="#l17.6359"></a><span id="l17.6359" class="difflineminus">-                kPopularityIndexProperty, &amp;popularityIndex)))</span>
<a href="#l17.6360"></a><span id="l17.6360" class="difflineminus">-          {</span>
<a href="#l17.6361"></a><span id="l17.6361" class="difflineplus">+                  kPopularityIndexProperty, &amp;popularityIndex))) {</span>
<a href="#l17.6362"></a><span id="l17.6362">             // TB 2 wrote the popularity value as hex, so if we get here,</span>
<a href="#l17.6363"></a><span id="l17.6363">             // then we've probably got a hex value. We'll convert it back</span>
<a href="#l17.6364"></a><span id="l17.6364">             // to decimal, as that's the best we can do.</span>
<a href="#l17.6365"></a><span id="l17.6365"> </span>
<a href="#l17.6366"></a><span id="l17.6366">             nsCString hexPopularity;</span>
<a href="#l17.6367"></a><span id="l17.6367">             if (NS_SUCCEEDED(recipient.mCard-&gt;GetPropertyAsAUTF8String(</span>
<a href="#l17.6368"></a><span id="l17.6368" class="difflineminus">-                kPopularityIndexProperty, hexPopularity)))</span>
<a href="#l17.6369"></a><span id="l17.6369" class="difflineminus">-            {</span>
<a href="#l17.6370"></a><span id="l17.6370" class="difflineplus">+                    kPopularityIndexProperty, hexPopularity))) {</span>
<a href="#l17.6371"></a><span id="l17.6371">               nsresult errorCode = NS_OK;</span>
<a href="#l17.6372"></a><span id="l17.6372">               popularityIndex = hexPopularity.ToInteger(&amp;errorCode, 16);</span>
<a href="#l17.6373"></a><span id="l17.6373">               if (NS_FAILED(errorCode))</span>
<a href="#l17.6374"></a><span id="l17.6374">                 // We failed, just set it to zero.</span>
<a href="#l17.6375"></a><span id="l17.6375">                 popularityIndex = 0;</span>
<a href="#l17.6376"></a><span id="l17.6376" class="difflineminus">-            }</span>
<a href="#l17.6377"></a><span id="l17.6377" class="difflineminus">-            else</span>
<a href="#l17.6378"></a><span id="l17.6378" class="difflineplus">+            } else</span>
<a href="#l17.6379"></a><span id="l17.6379">               // We couldn't get it as a string either, so just reset to zero.</span>
<a href="#l17.6380"></a><span id="l17.6380">               popularityIndex = 0;</span>
<a href="#l17.6381"></a><span id="l17.6381">           }</span>
<a href="#l17.6382"></a><span id="l17.6382"> </span>
<a href="#l17.6383"></a><span id="l17.6383">           recipient.mCard-&gt;SetPropertyAsUint32(kPopularityIndexProperty,</span>
<a href="#l17.6384"></a><span id="l17.6384">                                                ++popularityIndex);</span>
<a href="#l17.6385"></a><span id="l17.6385">           recipient.mDirectory-&gt;ModifyCard(recipient.mCard);</span>
<a href="#l17.6386"></a><span id="l17.6386">         }</span>
<a href="#l17.6387"></a><span id="l17.6387">       }</span>
<a href="#l17.6388"></a><span id="l17.6388">     }</span>
<a href="#l17.6389"></a><span id="l17.6389"> </span>
<a href="#l17.6390"></a><span id="l17.6390" class="difflineminus">-    switch (i)</span>
<a href="#l17.6391"></a><span id="l17.6391" class="difflineminus">-    {</span>
<a href="#l17.6392"></a><span id="l17.6392" class="difflineminus">-    case 0: m_compFields-&gt;SetTo(recipientsStr);  break;</span>
<a href="#l17.6393"></a><span id="l17.6393" class="difflineminus">-    case 1: m_compFields-&gt;SetCc(recipientsStr);  break;</span>
<a href="#l17.6394"></a><span id="l17.6394" class="difflineminus">-    case 2: m_compFields-&gt;SetBcc(recipientsStr); break;</span>
<a href="#l17.6395"></a><span id="l17.6395" class="difflineplus">+    switch (i) {</span>
<a href="#l17.6396"></a><span id="l17.6396" class="difflineplus">+      case 0:</span>
<a href="#l17.6397"></a><span id="l17.6397" class="difflineplus">+        m_compFields-&gt;SetTo(recipientsStr);</span>
<a href="#l17.6398"></a><span id="l17.6398" class="difflineplus">+        break;</span>
<a href="#l17.6399"></a><span id="l17.6399" class="difflineplus">+      case 1:</span>
<a href="#l17.6400"></a><span id="l17.6400" class="difflineplus">+        m_compFields-&gt;SetCc(recipientsStr);</span>
<a href="#l17.6401"></a><span id="l17.6401" class="difflineplus">+        break;</span>
<a href="#l17.6402"></a><span id="l17.6402" class="difflineplus">+      case 2:</span>
<a href="#l17.6403"></a><span id="l17.6403" class="difflineplus">+        m_compFields-&gt;SetBcc(recipientsStr);</span>
<a href="#l17.6404"></a><span id="l17.6404" class="difflineplus">+        break;</span>
<a href="#l17.6405"></a><span id="l17.6405">     }</span>
<a href="#l17.6406"></a><span id="l17.6406">   }</span>
<a href="#l17.6407"></a><span id="l17.6407"> </span>
<a href="#l17.6408"></a><span id="l17.6408">   return NS_OK;</span>
<a href="#l17.6409"></a><span id="l17.6409"> }</span>
<a href="#l17.6410"></a><span id="l17.6410"> </span>
<a href="#l17.6411"></a><span id="l17.6411"> /**</span>
<a href="#l17.6412"></a><span id="l17.6412" class="difflineminus">- * This function implements the decision logic for delivery format 'Auto-Detect',</span>
<a href="#l17.6413"></a><span id="l17.6413" class="difflineminus">- * including optional 'Auto-Downgrade' behaviour for HTML messages considered</span>
<a href="#l17.6414"></a><span id="l17.6414" class="difflineminus">- * convertible (silent, &quot;lossless&quot; conversion to plain text).</span>
<a href="#l17.6415"></a><span id="l17.6415" class="difflineplus">+ * This function implements the decision logic for delivery format</span>
<a href="#l17.6416"></a><span id="l17.6416" class="difflineplus">+ * 'Auto-Detect', including optional 'Auto-Downgrade' behaviour for HTML</span>
<a href="#l17.6417"></a><span id="l17.6417" class="difflineplus">+ * messages considered convertible (silent, &quot;lossless&quot; conversion to plain</span>
<a href="#l17.6418"></a><span id="l17.6418" class="difflineplus">+ * text).</span>
<a href="#l17.6419"></a><span id="l17.6419">  * @param aConvertible  the result of analysing message body convertibility:</span>
<a href="#l17.6420"></a><span id="l17.6420">  *                      nsIMsgCompConvertible::Plain | Yes | Altering | No</span>
<a href="#l17.6421"></a><span id="l17.6421">  * @return              nsIMsgCompSendFormat::AskUser | PlainText | HTML | Both</span>
<a href="#l17.6422"></a><span id="l17.6422">  */</span>
<a href="#l17.6423"></a><span id="l17.6423"> NS_IMETHODIMP</span>
<a href="#l17.6424"></a><span id="l17.6424" class="difflineminus">-nsMsgCompose::DetermineHTMLAction(int32_t aConvertible, int32_t *result)</span>
<a href="#l17.6425"></a><span id="l17.6425" class="difflineminus">-{</span>
<a href="#l17.6426"></a><span id="l17.6426" class="difflineplus">+nsMsgCompose::DetermineHTMLAction(int32_t aConvertible, int32_t *result) {</span>
<a href="#l17.6427"></a><span id="l17.6427">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l17.6428"></a><span id="l17.6428">   nsresult rv;</span>
<a href="#l17.6429"></a><span id="l17.6429"> </span>
<a href="#l17.6430"></a><span id="l17.6430" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l17.6431"></a><span id="l17.6431" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(</span>
<a href="#l17.6432"></a><span id="l17.6432" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l17.6433"></a><span id="l17.6433">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.6434"></a><span id="l17.6434"> </span>
<a href="#l17.6435"></a><span id="l17.6435">   // *** Message-centric Auto-Downgrade ***</span>
<a href="#l17.6436"></a><span id="l17.6436">   // If the message has practically no HTML formatting,</span>
<a href="#l17.6437"></a><span id="l17.6437">   // AND if user accepts auto-downgrading (send options pref),</span>
<a href="#l17.6438"></a><span id="l17.6438">   // bypass auto-detection of recipients' preferences and just</span>
<a href="#l17.6439"></a><span id="l17.6439">   // send the message as plain text (silent, &quot;lossless&quot; conversion);</span>
<a href="#l17.6440"></a><span id="l17.6440">   // which will also avoid asking for newsgroups for this typical scenario.</span>
<a href="#l17.6441"></a><span id="l17.6441">   bool autoDowngrade = true;</span>
<a href="#l17.6442"></a><span id="l17.6442" class="difflineminus">-  rv = prefBranch-&gt;GetBoolPref(&quot;mailnews.sendformat.auto_downgrade&quot;, &amp;autoDowngrade);</span>
<a href="#l17.6443"></a><span id="l17.6443" class="difflineplus">+  rv = prefBranch-&gt;GetBoolPref(&quot;mailnews.sendformat.auto_downgrade&quot;,</span>
<a href="#l17.6444"></a><span id="l17.6444" class="difflineplus">+                               &amp;autoDowngrade);</span>
<a href="#l17.6445"></a><span id="l17.6445">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.6446"></a><span id="l17.6446" class="difflineminus">-  if (autoDowngrade &amp;&amp; (aConvertible == nsIMsgCompConvertible::Plain))</span>
<a href="#l17.6447"></a><span id="l17.6447" class="difflineminus">-  {</span>
<a href="#l17.6448"></a><span id="l17.6448" class="difflineplus">+  if (autoDowngrade &amp;&amp; (aConvertible == nsIMsgCompConvertible::Plain)) {</span>
<a href="#l17.6449"></a><span id="l17.6449">     *result = nsIMsgCompSendFormat::PlainText;</span>
<a href="#l17.6450"></a><span id="l17.6450">     return NS_OK;</span>
<a href="#l17.6451"></a><span id="l17.6451">   }</span>
<a href="#l17.6452"></a><span id="l17.6452"> </span>
<a href="#l17.6453"></a><span id="l17.6453">   // *** Newsgroups ***</span>
<a href="#l17.6454"></a><span id="l17.6454">   // Right now, we don't have logic for newsgroups for intelligent send</span>
<a href="#l17.6455"></a><span id="l17.6455">   // preferences. Therefore, bail out early and save us a lot of work if there</span>
<a href="#l17.6456"></a><span id="l17.6456">   // are newsgroups.</span>
<a href="#l17.6457"></a><span id="l17.6457"> </span>
<a href="#l17.6458"></a><span id="l17.6458">   nsAutoString newsgroups;</span>
<a href="#l17.6459"></a><span id="l17.6459">   m_compFields-&gt;GetNewsgroups(newsgroups);</span>
<a href="#l17.6460"></a><span id="l17.6460"> </span>
<a href="#l17.6461"></a><span id="l17.6461" class="difflineminus">-  if (!newsgroups.IsEmpty())</span>
<a href="#l17.6462"></a><span id="l17.6462" class="difflineminus">-  {</span>
<a href="#l17.6463"></a><span id="l17.6463" class="difflineplus">+  if (!newsgroups.IsEmpty()) {</span>
<a href="#l17.6464"></a><span id="l17.6464">     *result = nsIMsgCompSendFormat::AskUser;</span>
<a href="#l17.6465"></a><span id="l17.6465">     return NS_OK;</span>
<a href="#l17.6466"></a><span id="l17.6466">   }</span>
<a href="#l17.6467"></a><span id="l17.6467"> </span>
<a href="#l17.6468"></a><span id="l17.6468">   // *** Recipient-Centric Auto-Detect ***</span>
<a href="#l17.6469"></a><span id="l17.6469"> </span>
<a href="#l17.6470"></a><span id="l17.6470">   RecipientsArray recipientsList;</span>
<a href="#l17.6471"></a><span id="l17.6471">   rv = LookupAddressBook(recipientsList);</span>
<a href="#l17.6472"></a><span id="l17.6472">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.6473"></a><span id="l17.6473"> </span>
<a href="#l17.6474"></a><span id="l17.6474">   // Finally return the list of non-HTML recipients if requested and/or rebuilt</span>
<a href="#l17.6475"></a><span id="l17.6475">   // the recipient field. Also, check for domain preference when preferFormat</span>
<a href="#l17.6476"></a><span id="l17.6476">   // is unknown.</span>
<a href="#l17.6477"></a><span id="l17.6477">   nsString plaintextDomains;</span>
<a href="#l17.6478"></a><span id="l17.6478">   nsString htmlDomains;</span>
<a href="#l17.6479"></a><span id="l17.6479"> </span>
<a href="#l17.6480"></a><span id="l17.6480" class="difflineminus">-  if (prefBranch)</span>
<a href="#l17.6481"></a><span id="l17.6481" class="difflineminus">-  {</span>
<a href="#l17.6482"></a><span id="l17.6482" class="difflineplus">+  if (prefBranch) {</span>
<a href="#l17.6483"></a><span id="l17.6483">     NS_GetUnicharPreferenceWithDefault(prefBranch, &quot;mailnews.plaintext_domains&quot;,</span>
<a href="#l17.6484"></a><span id="l17.6484">                                        EmptyString(), plaintextDomains);</span>
<a href="#l17.6485"></a><span id="l17.6485">     NS_GetUnicharPreferenceWithDefault(prefBranch, &quot;mailnews.html_domains&quot;,</span>
<a href="#l17.6486"></a><span id="l17.6486">                                        EmptyString(), htmlDomains);</span>
<a href="#l17.6487"></a><span id="l17.6487">   }</span>
<a href="#l17.6488"></a><span id="l17.6488"> </span>
<a href="#l17.6489"></a><span id="l17.6489">   // allHTML and allPlain are summary recipient scopes of format preference</span>
<a href="#l17.6490"></a><span id="l17.6490" class="difflineminus">-  // according to address book and send options for recipient-centric Auto-Detect,</span>
<a href="#l17.6491"></a><span id="l17.6491" class="difflineminus">-  // used by Auto-Detect to determine the appropriate message delivery format.</span>
<a href="#l17.6492"></a><span id="l17.6492" class="difflineplus">+  // according to address book and send options for recipient-centric</span>
<a href="#l17.6493"></a><span id="l17.6493" class="difflineplus">+  // Auto-Detect, used by Auto-Detect to determine the appropriate message</span>
<a href="#l17.6494"></a><span id="l17.6494" class="difflineplus">+  // delivery format.</span>
<a href="#l17.6495"></a><span id="l17.6495"> </span>
<a href="#l17.6496"></a><span id="l17.6496">   // allHtml: All recipients prefer HTML.</span>
<a href="#l17.6497"></a><span id="l17.6497">   bool allHtml = true;</span>
<a href="#l17.6498"></a><span id="l17.6498"> </span>
<a href="#l17.6499"></a><span id="l17.6499">   // allPlain: All recipients prefer Plain Text.</span>
<a href="#l17.6500"></a><span id="l17.6500">   bool allPlain = true;</span>
<a href="#l17.6501"></a><span id="l17.6501"> </span>
<a href="#l17.6502"></a><span id="l17.6502">   // Exit the loop early if allHtml and allPlain both decay to false to save us</span>
<a href="#l17.6503"></a><span id="l17.6503">   // some work.</span>
<a href="#l17.6504"></a><span id="l17.6504" class="difflineminus">-  for (int i = 0; i &lt; MAX_OF_RECIPIENT_ARRAY &amp;&amp; (allHtml || allPlain); ++i)</span>
<a href="#l17.6505"></a><span id="l17.6505" class="difflineminus">-  {</span>
<a href="#l17.6506"></a><span id="l17.6506" class="difflineplus">+  for (int i = 0; i &lt; MAX_OF_RECIPIENT_ARRAY &amp;&amp; (allHtml || allPlain); ++i) {</span>
<a href="#l17.6507"></a><span id="l17.6507">     uint32_t nbrRecipients = recipientsList[i].Length();</span>
<a href="#l17.6508"></a><span id="l17.6508" class="difflineminus">-    for (uint32_t j = 0; j &lt; nbrRecipients &amp;&amp; (allHtml || allPlain); ++j)</span>
<a href="#l17.6509"></a><span id="l17.6509" class="difflineminus">-    {</span>
<a href="#l17.6510"></a><span id="l17.6510" class="difflineplus">+    for (uint32_t j = 0; j &lt; nbrRecipients &amp;&amp; (allHtml || allPlain); ++j) {</span>
<a href="#l17.6511"></a><span id="l17.6511">       nsMsgRecipient &amp;recipient = recipientsList[i][j];</span>
<a href="#l17.6512"></a><span id="l17.6512">       uint32_t preferFormat = nsIAbPreferMailFormat::unknown;</span>
<a href="#l17.6513"></a><span id="l17.6513" class="difflineminus">-      if (recipient.mCard)</span>
<a href="#l17.6514"></a><span id="l17.6514" class="difflineminus">-      {</span>
<a href="#l17.6515"></a><span id="l17.6515" class="difflineplus">+      if (recipient.mCard) {</span>
<a href="#l17.6516"></a><span id="l17.6516">         recipient.mCard-&gt;GetPropertyAsUint32(kPreferMailFormatProperty,</span>
<a href="#l17.6517"></a><span id="l17.6517" class="difflineminus">-          &amp;preferFormat);</span>
<a href="#l17.6518"></a><span id="l17.6518" class="difflineplus">+                                             &amp;preferFormat);</span>
<a href="#l17.6519"></a><span id="l17.6519">       }</span>
<a href="#l17.6520"></a><span id="l17.6520"> </span>
<a href="#l17.6521"></a><span id="l17.6521">       // if we don't have a prefer format for a recipient, check the domain in</span>
<a href="#l17.6522"></a><span id="l17.6522">       // case we have a format defined for it</span>
<a href="#l17.6523"></a><span id="l17.6523">       if (preferFormat == nsIAbPreferMailFormat::unknown &amp;&amp;</span>
<a href="#l17.6524"></a><span id="l17.6524" class="difflineminus">-          (!plaintextDomains.IsEmpty() || !htmlDomains.IsEmpty()))</span>
<a href="#l17.6525"></a><span id="l17.6525" class="difflineminus">-      {</span>
<a href="#l17.6526"></a><span id="l17.6526" class="difflineplus">+          (!plaintextDomains.IsEmpty() || !htmlDomains.IsEmpty())) {</span>
<a href="#l17.6527"></a><span id="l17.6527">         int32_t atPos = recipient.mEmail.FindChar('@');</span>
<a href="#l17.6528"></a><span id="l17.6528" class="difflineminus">-        if (atPos &lt; 0)</span>
<a href="#l17.6529"></a><span id="l17.6529" class="difflineminus">-          continue;</span>
<a href="#l17.6530"></a><span id="l17.6530" class="difflineminus">-</span>
<a href="#l17.6531"></a><span id="l17.6531" class="difflineminus">-        nsDependentSubstring emailDomain = Substring(recipient.mEmail,</span>
<a href="#l17.6532"></a><span id="l17.6532" class="difflineminus">-                                                     atPos + 1);</span>
<a href="#l17.6533"></a><span id="l17.6533" class="difflineplus">+        if (atPos &lt; 0) continue;</span>
<a href="#l17.6534"></a><span id="l17.6534" class="difflineplus">+</span>
<a href="#l17.6535"></a><span id="l17.6535" class="difflineplus">+        nsDependentSubstring emailDomain =</span>
<a href="#l17.6536"></a><span id="l17.6536" class="difflineplus">+            Substring(recipient.mEmail, atPos + 1);</span>
<a href="#l17.6537"></a><span id="l17.6537">         if (IsInDomainList(emailDomain, plaintextDomains))</span>
<a href="#l17.6538"></a><span id="l17.6538">           preferFormat = nsIAbPreferMailFormat::plaintext;</span>
<a href="#l17.6539"></a><span id="l17.6539">         else if (IsInDomainList(emailDomain, htmlDomains))</span>
<a href="#l17.6540"></a><span id="l17.6540">           preferFormat = nsIAbPreferMailFormat::html;</span>
<a href="#l17.6541"></a><span id="l17.6541">       }</span>
<a href="#l17.6542"></a><span id="l17.6542"> </span>
<a href="#l17.6543"></a><span id="l17.6543">       // Determine the delivery format preference of this recipient and adjust</span>
<a href="#l17.6544"></a><span id="l17.6544">       // the summary recipient scopes of the message accordingly.</span>
<a href="#l17.6545"></a><span id="l17.6545" class="difflineminus">-      switch (preferFormat)</span>
<a href="#l17.6546"></a><span id="l17.6546" class="difflineminus">-      {</span>
<a href="#l17.6547"></a><span id="l17.6547" class="difflineminus">-      case nsIAbPreferMailFormat::html:</span>
<a href="#l17.6548"></a><span id="l17.6548" class="difflineminus">-        allPlain = false;</span>
<a href="#l17.6549"></a><span id="l17.6549" class="difflineminus">-        break;</span>
<a href="#l17.6550"></a><span id="l17.6550" class="difflineminus">-</span>
<a href="#l17.6551"></a><span id="l17.6551" class="difflineminus">-      case nsIAbPreferMailFormat::plaintext:</span>
<a href="#l17.6552"></a><span id="l17.6552" class="difflineminus">-        allHtml = false;</span>
<a href="#l17.6553"></a><span id="l17.6553" class="difflineminus">-        break;</span>
<a href="#l17.6554"></a><span id="l17.6554" class="difflineminus">-</span>
<a href="#l17.6555"></a><span id="l17.6555" class="difflineminus">-      default: // nsIAbPreferMailFormat::unknown</span>
<a href="#l17.6556"></a><span id="l17.6556" class="difflineminus">-        allHtml = false;</span>
<a href="#l17.6557"></a><span id="l17.6557" class="difflineminus">-        allPlain = false;</span>
<a href="#l17.6558"></a><span id="l17.6558" class="difflineminus">-        break;</span>
<a href="#l17.6559"></a><span id="l17.6559" class="difflineplus">+      switch (preferFormat) {</span>
<a href="#l17.6560"></a><span id="l17.6560" class="difflineplus">+        case nsIAbPreferMailFormat::html:</span>
<a href="#l17.6561"></a><span id="l17.6561" class="difflineplus">+          allPlain = false;</span>
<a href="#l17.6562"></a><span id="l17.6562" class="difflineplus">+          break;</span>
<a href="#l17.6563"></a><span id="l17.6563" class="difflineplus">+</span>
<a href="#l17.6564"></a><span id="l17.6564" class="difflineplus">+        case nsIAbPreferMailFormat::plaintext:</span>
<a href="#l17.6565"></a><span id="l17.6565" class="difflineplus">+          allHtml = false;</span>
<a href="#l17.6566"></a><span id="l17.6566" class="difflineplus">+          break;</span>
<a href="#l17.6567"></a><span id="l17.6567" class="difflineplus">+</span>
<a href="#l17.6568"></a><span id="l17.6568" class="difflineplus">+        default:  // nsIAbPreferMailFormat::unknown</span>
<a href="#l17.6569"></a><span id="l17.6569" class="difflineplus">+          allHtml = false;</span>
<a href="#l17.6570"></a><span id="l17.6570" class="difflineplus">+          allPlain = false;</span>
<a href="#l17.6571"></a><span id="l17.6571" class="difflineplus">+          break;</span>
<a href="#l17.6572"></a><span id="l17.6572">       }</span>
<a href="#l17.6573"></a><span id="l17.6573">     }</span>
<a href="#l17.6574"></a><span id="l17.6574">   }</span>
<a href="#l17.6575"></a><span id="l17.6575"> </span>
<a href="#l17.6576"></a><span id="l17.6576">   // Here's the final part of recipient-centric Auto-Detect logic where we set</span>
<a href="#l17.6577"></a><span id="l17.6577">   // the actual send format (aka delivery format) after analysing recipients'</span>
<a href="#l17.6578"></a><span id="l17.6578">   // format preferences above.</span>
<a href="#l17.6579"></a><span id="l17.6579"> </span>
<a href="#l17.6580"></a><span id="l17.6580">   // If all recipients prefer HTML, then return HTML.</span>
<a href="#l17.6581"></a><span id="l17.6581" class="difflineminus">-  if (allHtml)</span>
<a href="#l17.6582"></a><span id="l17.6582" class="difflineminus">-  {</span>
<a href="#l17.6583"></a><span id="l17.6583" class="difflineplus">+  if (allHtml) {</span>
<a href="#l17.6584"></a><span id="l17.6584">     *result = nsIMsgCompSendFormat::HTML;</span>
<a href="#l17.6585"></a><span id="l17.6585">     return NS_OK;</span>
<a href="#l17.6586"></a><span id="l17.6586">   }</span>
<a href="#l17.6587"></a><span id="l17.6587"> </span>
<a href="#l17.6588"></a><span id="l17.6588">   // If all recipients prefer plaintext, silently strip *all* HTML formatting,</span>
<a href="#l17.6589"></a><span id="l17.6589">   // regardless of (non-)convertibility, and send the message as plaintext.</span>
<a href="#l17.6590"></a><span id="l17.6590">   // **ToDo: UX-error-prevention, UX-wysiwyg: warn against dataloss potential.**</span>
<a href="#l17.6591"></a><span id="l17.6591" class="difflineminus">-  if (allPlain)</span>
<a href="#l17.6592"></a><span id="l17.6592" class="difflineminus">-  {</span>
<a href="#l17.6593"></a><span id="l17.6593" class="difflineplus">+  if (allPlain) {</span>
<a href="#l17.6594"></a><span id="l17.6594">     *result = nsIMsgCompSendFormat::PlainText;</span>
<a href="#l17.6595"></a><span id="l17.6595">     return NS_OK;</span>
<a href="#l17.6596"></a><span id="l17.6596">   }</span>
<a href="#l17.6597"></a><span id="l17.6597"> </span>
<a href="#l17.6598"></a><span id="l17.6598">   // Otherwise, check the preference to see what action we should default to.</span>
<a href="#l17.6599"></a><span id="l17.6599" class="difflineminus">-  // This pref covers all recipient scopes involving prefers-plain (except allplain)</span>
<a href="#l17.6600"></a><span id="l17.6600" class="difflineminus">-  // and prefers-unknown. So we are mixing format conflict resolution options for</span>
<a href="#l17.6601"></a><span id="l17.6601" class="difflineminus">-  // prefers-plain with default format setting for prefers-unknown; not ideal.</span>
<a href="#l17.6602"></a><span id="l17.6602" class="difflineplus">+  // This pref covers all recipient scopes involving prefers-plain (except</span>
<a href="#l17.6603"></a><span id="l17.6603" class="difflineplus">+  // allplain) and prefers-unknown. So we are mixing format conflict resolution</span>
<a href="#l17.6604"></a><span id="l17.6604" class="difflineplus">+  // options for prefers-plain with default format setting for prefers-unknown;</span>
<a href="#l17.6605"></a><span id="l17.6605" class="difflineplus">+  // not ideal.</span>
<a href="#l17.6606"></a><span id="l17.6606">   int32_t action = nsIMsgCompSendFormat::AskUser;</span>
<a href="#l17.6607"></a><span id="l17.6607">   rv = prefBranch-&gt;GetIntPref(&quot;mail.default_html_action&quot;, &amp;action);</span>
<a href="#l17.6608"></a><span id="l17.6608">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.6609"></a><span id="l17.6609"> </span>
<a href="#l17.6610"></a><span id="l17.6610" class="difflineminus">-  // If the action is a known send format, return the value to send in that format.</span>
<a href="#l17.6611"></a><span id="l17.6611" class="difflineminus">-  // Otherwise, ask the user.</span>
<a href="#l17.6612"></a><span id="l17.6612" class="difflineminus">-  // Note that the preference may default to 0 (Ask), which is not a valid value</span>
<a href="#l17.6613"></a><span id="l17.6613" class="difflineminus">-  // for the following enum.</span>
<a href="#l17.6614"></a><span id="l17.6614" class="difflineplus">+  // If the action is a known send format, return the value to send in that</span>
<a href="#l17.6615"></a><span id="l17.6615" class="difflineplus">+  // format. Otherwise, ask the user. Note that the preference may default to 0</span>
<a href="#l17.6616"></a><span id="l17.6616" class="difflineplus">+  // (Ask), which is not a valid value for the following enum.</span>
<a href="#l17.6617"></a><span id="l17.6617">   if (action == nsIMsgCompSendFormat::PlainText ||</span>
<a href="#l17.6618"></a><span id="l17.6618">       action == nsIMsgCompSendFormat::HTML ||</span>
<a href="#l17.6619"></a><span id="l17.6619" class="difflineminus">-      action == nsIMsgCompSendFormat::Both)</span>
<a href="#l17.6620"></a><span id="l17.6620" class="difflineminus">-  {</span>
<a href="#l17.6621"></a><span id="l17.6621" class="difflineplus">+      action == nsIMsgCompSendFormat::Both) {</span>
<a href="#l17.6622"></a><span id="l17.6622">     *result = action;</span>
<a href="#l17.6623"></a><span id="l17.6623">     return NS_OK;</span>
<a href="#l17.6624"></a><span id="l17.6624">   }</span>
<a href="#l17.6625"></a><span id="l17.6625"> </span>
<a href="#l17.6626"></a><span id="l17.6626">   // At this point, ask the user.</span>
<a href="#l17.6627"></a><span id="l17.6627">   *result = nsIMsgCompSendFormat::AskUser;</span>
<a href="#l17.6628"></a><span id="l17.6628">   return NS_OK;</span>
<a href="#l17.6629"></a><span id="l17.6629"> }</span>
<a href="#l17.6630"></a><span id="l17.6630"> </span>
<a href="#l17.6631"></a><span id="l17.6631"> /**</span>
<a href="#l17.6632"></a><span id="l17.6632">  * Decides which tags trigger which convertible mode,</span>
<a href="#l17.6633"></a><span id="l17.6633">  * i.e. here is the logic for BodyConvertible.</span>
<a href="#l17.6634"></a><span id="l17.6634">  * Note: Helper function. Parameters are not checked.</span>
<a href="#l17.6635"></a><span id="l17.6635">  */</span>
<a href="#l17.6636"></a><span id="l17.6636" class="difflineminus">-void nsMsgCompose::TagConvertible(Element *node,  int32_t *_retval)</span>
<a href="#l17.6637"></a><span id="l17.6637" class="difflineminus">-{</span>
<a href="#l17.6638"></a><span id="l17.6638" class="difflineplus">+void nsMsgCompose::TagConvertible(Element *node, int32_t *_retval) {</span>
<a href="#l17.6639"></a><span id="l17.6639" class="difflineplus">+  *_retval = nsIMsgCompConvertible::No;</span>
<a href="#l17.6640"></a><span id="l17.6640" class="difflineplus">+</span>
<a href="#l17.6641"></a><span id="l17.6641" class="difflineplus">+  nsAutoString element;</span>
<a href="#l17.6642"></a><span id="l17.6642" class="difflineplus">+  element = node-&gt;NodeName();</span>
<a href="#l17.6643"></a><span id="l17.6643" class="difflineplus">+</span>
<a href="#l17.6644"></a><span id="l17.6644" class="difflineplus">+  // A style attribute on any element can change layout in any way,</span>
<a href="#l17.6645"></a><span id="l17.6645" class="difflineplus">+  // so that is not convertible.</span>
<a href="#l17.6646"></a><span id="l17.6646" class="difflineplus">+  nsAutoString attribValue;</span>
<a href="#l17.6647"></a><span id="l17.6647" class="difflineplus">+  node-&gt;GetAttribute(NS_LITERAL_STRING(&quot;style&quot;), attribValue);</span>
<a href="#l17.6648"></a><span id="l17.6648" class="difflineplus">+  if (!attribValue.IsEmpty()) {</span>
<a href="#l17.6649"></a><span id="l17.6649">     *_retval = nsIMsgCompConvertible::No;</span>
<a href="#l17.6650"></a><span id="l17.6650" class="difflineminus">-</span>
<a href="#l17.6651"></a><span id="l17.6651" class="difflineminus">-    nsAutoString element;</span>
<a href="#l17.6652"></a><span id="l17.6652" class="difflineminus">-    element = node-&gt;NodeName();</span>
<a href="#l17.6653"></a><span id="l17.6653" class="difflineminus">-</span>
<a href="#l17.6654"></a><span id="l17.6654" class="difflineminus">-    // A style attribute on any element can change layout in any way,</span>
<a href="#l17.6655"></a><span id="l17.6655" class="difflineminus">-    // so that is not convertible.</span>
<a href="#l17.6656"></a><span id="l17.6656" class="difflineminus">-    nsAutoString attribValue;</span>
<a href="#l17.6657"></a><span id="l17.6657" class="difflineminus">-    node-&gt;GetAttribute(NS_LITERAL_STRING(&quot;style&quot;), attribValue);</span>
<a href="#l17.6658"></a><span id="l17.6658" class="difflineminus">-    if (!attribValue.IsEmpty())</span>
<a href="#l17.6659"></a><span id="l17.6659" class="difflineminus">-    {</span>
<a href="#l17.6660"></a><span id="l17.6660" class="difflineplus">+    return;</span>
<a href="#l17.6661"></a><span id="l17.6661" class="difflineplus">+  }</span>
<a href="#l17.6662"></a><span id="l17.6662" class="difflineplus">+</span>
<a href="#l17.6663"></a><span id="l17.6663" class="difflineplus">+  // moz-* classes are used internally by the editor and mail composition</span>
<a href="#l17.6664"></a><span id="l17.6664" class="difflineplus">+  // (like moz-cite-prefix or moz-signature). Those can be discarded.</span>
<a href="#l17.6665"></a><span id="l17.6665" class="difflineplus">+  // But any other ones are unconvertible. Style can be attached to them or any</span>
<a href="#l17.6666"></a><span id="l17.6666" class="difflineplus">+  // other context (e.g. in microformats).</span>
<a href="#l17.6667"></a><span id="l17.6667" class="difflineplus">+  node-&gt;GetAttribute(NS_LITERAL_STRING(&quot;class&quot;), attribValue);</span>
<a href="#l17.6668"></a><span id="l17.6668" class="difflineplus">+  if (!attribValue.IsEmpty()) {</span>
<a href="#l17.6669"></a><span id="l17.6669" class="difflineplus">+    if (StringBeginsWith(attribValue, NS_LITERAL_STRING(&quot;moz-&quot;),</span>
<a href="#l17.6670"></a><span id="l17.6670" class="difflineplus">+                         nsCaseInsensitiveStringComparator())) {</span>
<a href="#l17.6671"></a><span id="l17.6671" class="difflineplus">+      // We assume that anything with a moz-* class is convertible regardless of</span>
<a href="#l17.6672"></a><span id="l17.6672" class="difflineplus">+      // the tag, because we add, for example, class=&quot;moz-signature&quot; to HTML</span>
<a href="#l17.6673"></a><span id="l17.6673" class="difflineplus">+      // messages and we still want to be able to downgrade them.</span>
<a href="#l17.6674"></a><span id="l17.6674" class="difflineplus">+      *_retval = nsIMsgCompConvertible::Plain;</span>
<a href="#l17.6675"></a><span id="l17.6675" class="difflineplus">+    } else {</span>
<a href="#l17.6676"></a><span id="l17.6676">       *_retval = nsIMsgCompConvertible::No;</span>
<a href="#l17.6677"></a><span id="l17.6677" class="difflineminus">-      return;</span>
<a href="#l17.6678"></a><span id="l17.6678" class="difflineminus">-    }</span>
<a href="#l17.6679"></a><span id="l17.6679" class="difflineminus">-</span>
<a href="#l17.6680"></a><span id="l17.6680" class="difflineminus">-    // moz-* classes are used internally by the editor and mail composition</span>
<a href="#l17.6681"></a><span id="l17.6681" class="difflineminus">-    // (like moz-cite-prefix or moz-signature). Those can be discarded.</span>
<a href="#l17.6682"></a><span id="l17.6682" class="difflineminus">-    // But any other ones are unconvertible. Style can be attached to them or any</span>
<a href="#l17.6683"></a><span id="l17.6683" class="difflineminus">-    // other context (e.g. in microformats).</span>
<a href="#l17.6684"></a><span id="l17.6684" class="difflineminus">-    node-&gt;GetAttribute(NS_LITERAL_STRING(&quot;class&quot;), attribValue);</span>
<a href="#l17.6685"></a><span id="l17.6685" class="difflineminus">-    if (!attribValue.IsEmpty())</span>
<a href="#l17.6686"></a><span id="l17.6686" class="difflineminus">-    {</span>
<a href="#l17.6687"></a><span id="l17.6687" class="difflineminus">-      if (StringBeginsWith(attribValue, NS_LITERAL_STRING(&quot;moz-&quot;), nsCaseInsensitiveStringComparator())) {</span>
<a href="#l17.6688"></a><span id="l17.6688" class="difflineminus">-        // We assume that anything with a moz-* class is convertible regardless of the tag,</span>
<a href="#l17.6689"></a><span id="l17.6689" class="difflineminus">-        // because we add, for example, class=&quot;moz-signature&quot; to HTML messages and we still want</span>
<a href="#l17.6690"></a><span id="l17.6690" class="difflineminus">-        // to be able to downgrade them.</span>
<a href="#l17.6691"></a><span id="l17.6691" class="difflineminus">-        *_retval = nsIMsgCompConvertible::Plain;</span>
<a href="#l17.6692"></a><span id="l17.6692" class="difflineminus">-      } else {</span>
<a href="#l17.6693"></a><span id="l17.6693" class="difflineminus">-        *_retval = nsIMsgCompConvertible::No;</span>
<a href="#l17.6694"></a><span id="l17.6694" class="difflineminus">-      }</span>
<a href="#l17.6695"></a><span id="l17.6695" class="difflineminus">-</span>
<a href="#l17.6696"></a><span id="l17.6696" class="difflineminus">-      return;</span>
<a href="#l17.6697"></a><span id="l17.6697">     }</span>
<a href="#l17.6698"></a><span id="l17.6698"> </span>
<a href="#l17.6699"></a><span id="l17.6699" class="difflineminus">-    // ID attributes can contain attached style/context or be target of links</span>
<a href="#l17.6700"></a><span id="l17.6700" class="difflineminus">-    // so we should preserve them.</span>
<a href="#l17.6701"></a><span id="l17.6701" class="difflineminus">-    node-&gt;GetAttribute(NS_LITERAL_STRING(&quot;id&quot;), attribValue);</span>
<a href="#l17.6702"></a><span id="l17.6702" class="difflineminus">-    if (!attribValue.IsEmpty())</span>
<a href="#l17.6703"></a><span id="l17.6703" class="difflineminus">-    {</span>
<a href="#l17.6704"></a><span id="l17.6704" class="difflineplus">+    return;</span>
<a href="#l17.6705"></a><span id="l17.6705" class="difflineplus">+  }</span>
<a href="#l17.6706"></a><span id="l17.6706" class="difflineplus">+</span>
<a href="#l17.6707"></a><span id="l17.6707" class="difflineplus">+  // ID attributes can contain attached style/context or be target of links</span>
<a href="#l17.6708"></a><span id="l17.6708" class="difflineplus">+  // so we should preserve them.</span>
<a href="#l17.6709"></a><span id="l17.6709" class="difflineplus">+  node-&gt;GetAttribute(NS_LITERAL_STRING(&quot;id&quot;), attribValue);</span>
<a href="#l17.6710"></a><span id="l17.6710" class="difflineplus">+  if (!attribValue.IsEmpty()) {</span>
<a href="#l17.6711"></a><span id="l17.6711" class="difflineplus">+    *_retval = nsIMsgCompConvertible::No;</span>
<a href="#l17.6712"></a><span id="l17.6712" class="difflineplus">+    return;</span>
<a href="#l17.6713"></a><span id="l17.6713" class="difflineplus">+  }</span>
<a href="#l17.6714"></a><span id="l17.6714" class="difflineplus">+</span>
<a href="#l17.6715"></a><span id="l17.6715" class="difflineplus">+  // Alignment is not convertible to plaintext; editor currently uses this.</span>
<a href="#l17.6716"></a><span id="l17.6716" class="difflineplus">+  node-&gt;GetAttribute(NS_LITERAL_STRING(&quot;align&quot;), attribValue);</span>
<a href="#l17.6717"></a><span id="l17.6717" class="difflineplus">+  if (!attribValue.IsEmpty()) {</span>
<a href="#l17.6718"></a><span id="l17.6718" class="difflineplus">+    *_retval = nsIMsgCompConvertible::No;</span>
<a href="#l17.6719"></a><span id="l17.6719" class="difflineplus">+    return;</span>
<a href="#l17.6720"></a><span id="l17.6720" class="difflineplus">+  }</span>
<a href="#l17.6721"></a><span id="l17.6721" class="difflineplus">+</span>
<a href="#l17.6722"></a><span id="l17.6722" class="difflineplus">+  // Title attribute is not convertible to plaintext;</span>
<a href="#l17.6723"></a><span id="l17.6723" class="difflineplus">+  // this also preserves any links with titles.</span>
<a href="#l17.6724"></a><span id="l17.6724" class="difflineplus">+  node-&gt;GetAttribute(NS_LITERAL_STRING(&quot;title&quot;), attribValue);</span>
<a href="#l17.6725"></a><span id="l17.6725" class="difflineplus">+  if (!attribValue.IsEmpty()) {</span>
<a href="#l17.6726"></a><span id="l17.6726" class="difflineplus">+    *_retval = nsIMsgCompConvertible::No;</span>
<a href="#l17.6727"></a><span id="l17.6727" class="difflineplus">+    return;</span>
<a href="#l17.6728"></a><span id="l17.6728" class="difflineplus">+  }</span>
<a href="#l17.6729"></a><span id="l17.6729" class="difflineplus">+</span>
<a href="#l17.6730"></a><span id="l17.6730" class="difflineplus">+  if (  // Considered convertible to plaintext: Some &quot;simple&quot; elements</span>
<a href="#l17.6731"></a><span id="l17.6731" class="difflineplus">+        // without non-convertible attributes like style, class, id,</span>
<a href="#l17.6732"></a><span id="l17.6732" class="difflineplus">+        // or align (see above).</span>
<a href="#l17.6733"></a><span id="l17.6733" class="difflineplus">+      element.LowerCaseEqualsLiteral(&quot;br&quot;) ||</span>
<a href="#l17.6734"></a><span id="l17.6734" class="difflineplus">+      element.LowerCaseEqualsLiteral(&quot;p&quot;) ||</span>
<a href="#l17.6735"></a><span id="l17.6735" class="difflineplus">+      element.LowerCaseEqualsLiteral(&quot;tt&quot;) ||</span>
<a href="#l17.6736"></a><span id="l17.6736" class="difflineplus">+      element.LowerCaseEqualsLiteral(&quot;html&quot;) ||</span>
<a href="#l17.6737"></a><span id="l17.6737" class="difflineplus">+      element.LowerCaseEqualsLiteral(&quot;head&quot;) ||</span>
<a href="#l17.6738"></a><span id="l17.6738" class="difflineplus">+      element.LowerCaseEqualsLiteral(&quot;meta&quot;) ||</span>
<a href="#l17.6739"></a><span id="l17.6739" class="difflineplus">+      element.LowerCaseEqualsLiteral(&quot;title&quot;)) {</span>
<a href="#l17.6740"></a><span id="l17.6740" class="difflineplus">+    *_retval = nsIMsgCompConvertible::Plain;</span>
<a href="#l17.6741"></a><span id="l17.6741" class="difflineplus">+  } else if (</span>
<a href="#l17.6742"></a><span id="l17.6742" class="difflineplus">+      // element.LowerCaseEqualsLiteral(&quot;blockquote&quot;) || // see below</span>
<a href="#l17.6743"></a><span id="l17.6743" class="difflineplus">+      element.LowerCaseEqualsLiteral(&quot;ul&quot;) ||</span>
<a href="#l17.6744"></a><span id="l17.6744" class="difflineplus">+      element.LowerCaseEqualsLiteral(&quot;ol&quot;) ||</span>
<a href="#l17.6745"></a><span id="l17.6745" class="difflineplus">+      element.LowerCaseEqualsLiteral(&quot;li&quot;) ||</span>
<a href="#l17.6746"></a><span id="l17.6746" class="difflineplus">+      element.LowerCaseEqualsLiteral(&quot;dl&quot;) ||</span>
<a href="#l17.6747"></a><span id="l17.6747" class="difflineplus">+      element.LowerCaseEqualsLiteral(&quot;dt&quot;) ||</span>
<a href="#l17.6748"></a><span id="l17.6748" class="difflineplus">+      element.LowerCaseEqualsLiteral(&quot;dd&quot;)) {</span>
<a href="#l17.6749"></a><span id="l17.6749" class="difflineplus">+    *_retval = nsIMsgCompConvertible::Yes;</span>
<a href="#l17.6750"></a><span id="l17.6750" class="difflineplus">+  } else if (</span>
<a href="#l17.6751"></a><span id="l17.6751" class="difflineplus">+      // element.LowerCaseEqualsLiteral(&quot;a&quot;) || // see below</span>
<a href="#l17.6752"></a><span id="l17.6752" class="difflineplus">+      element.LowerCaseEqualsLiteral(&quot;h1&quot;) ||</span>
<a href="#l17.6753"></a><span id="l17.6753" class="difflineplus">+      element.LowerCaseEqualsLiteral(&quot;h2&quot;) ||</span>
<a href="#l17.6754"></a><span id="l17.6754" class="difflineplus">+      element.LowerCaseEqualsLiteral(&quot;h3&quot;) ||</span>
<a href="#l17.6755"></a><span id="l17.6755" class="difflineplus">+      element.LowerCaseEqualsLiteral(&quot;h4&quot;) ||</span>
<a href="#l17.6756"></a><span id="l17.6756" class="difflineplus">+      element.LowerCaseEqualsLiteral(&quot;h5&quot;) ||</span>
<a href="#l17.6757"></a><span id="l17.6757" class="difflineplus">+      element.LowerCaseEqualsLiteral(&quot;h6&quot;) ||</span>
<a href="#l17.6758"></a><span id="l17.6758" class="difflineplus">+      element.LowerCaseEqualsLiteral(&quot;hr&quot;) ||</span>
<a href="#l17.6759"></a><span id="l17.6759" class="difflineplus">+      element.LowerCaseEqualsLiteral(&quot;pre&quot;) ||</span>
<a href="#l17.6760"></a><span id="l17.6760" class="difflineplus">+      (mConvertStructs &amp;&amp; (element.LowerCaseEqualsLiteral(&quot;em&quot;) ||</span>
<a href="#l17.6761"></a><span id="l17.6761" class="difflineplus">+                           element.LowerCaseEqualsLiteral(&quot;strong&quot;) ||</span>
<a href="#l17.6762"></a><span id="l17.6762" class="difflineplus">+                           element.LowerCaseEqualsLiteral(&quot;code&quot;) ||</span>
<a href="#l17.6763"></a><span id="l17.6763" class="difflineplus">+                           element.LowerCaseEqualsLiteral(&quot;b&quot;) ||</span>
<a href="#l17.6764"></a><span id="l17.6764" class="difflineplus">+                           element.LowerCaseEqualsLiteral(&quot;i&quot;) ||</span>
<a href="#l17.6765"></a><span id="l17.6765" class="difflineplus">+                           element.LowerCaseEqualsLiteral(&quot;u&quot;)))) {</span>
<a href="#l17.6766"></a><span id="l17.6766" class="difflineplus">+    *_retval = nsIMsgCompConvertible::Altering;</span>
<a href="#l17.6767"></a><span id="l17.6767" class="difflineplus">+  } else if (element.LowerCaseEqualsLiteral(&quot;body&quot;)) {</span>
<a href="#l17.6768"></a><span id="l17.6768" class="difflineplus">+    *_retval = nsIMsgCompConvertible::Plain;</span>
<a href="#l17.6769"></a><span id="l17.6769" class="difflineplus">+</span>
<a href="#l17.6770"></a><span id="l17.6770" class="difflineplus">+    if (node-&gt;HasAttribute(</span>
<a href="#l17.6771"></a><span id="l17.6771" class="difflineplus">+            NS_LITERAL_STRING(&quot;background&quot;)) ||  // There is a background image</span>
<a href="#l17.6772"></a><span id="l17.6772" class="difflineplus">+        node-&gt;HasAttribute(NS_LITERAL_STRING(</span>
<a href="#l17.6773"></a><span id="l17.6773" class="difflineplus">+            &quot;dir&quot;))) {  // dir=rtl attributes should not downconvert</span>
<a href="#l17.6774"></a><span id="l17.6774">       *_retval = nsIMsgCompConvertible::No;</span>
<a href="#l17.6775"></a><span id="l17.6775" class="difflineminus">-      return;</span>
<a href="#l17.6776"></a><span id="l17.6776" class="difflineminus">-    }</span>
<a href="#l17.6777"></a><span id="l17.6777" class="difflineminus">-</span>
<a href="#l17.6778"></a><span id="l17.6778" class="difflineminus">-    // Alignment is not convertible to plaintext; editor currently uses this.</span>
<a href="#l17.6779"></a><span id="l17.6779" class="difflineminus">-    node-&gt;GetAttribute(NS_LITERAL_STRING(&quot;align&quot;), attribValue);</span>
<a href="#l17.6780"></a><span id="l17.6780" class="difflineminus">-    if (!attribValue.IsEmpty())</span>
<a href="#l17.6781"></a><span id="l17.6781" class="difflineminus">-    {</span>
<a href="#l17.6782"></a><span id="l17.6782" class="difflineminus">-      *_retval = nsIMsgCompConvertible::No;</span>
<a href="#l17.6783"></a><span id="l17.6783" class="difflineminus">-      return;</span>
<a href="#l17.6784"></a><span id="l17.6784" class="difflineplus">+    } else {</span>
<a href="#l17.6785"></a><span id="l17.6785" class="difflineplus">+      nsAutoString color;</span>
<a href="#l17.6786"></a><span id="l17.6786" class="difflineplus">+      if (node-&gt;HasAttribute(NS_LITERAL_STRING(&quot;text&quot;))) {</span>
<a href="#l17.6787"></a><span id="l17.6787" class="difflineplus">+        node-&gt;GetAttribute(NS_LITERAL_STRING(&quot;text&quot;), color);</span>
<a href="#l17.6788"></a><span id="l17.6788" class="difflineplus">+        if (!color.EqualsLiteral(&quot;#000000&quot;))</span>
<a href="#l17.6789"></a><span id="l17.6789" class="difflineplus">+          *_retval = nsIMsgCompConvertible::Altering;</span>
<a href="#l17.6790"></a><span id="l17.6790" class="difflineplus">+      }</span>
<a href="#l17.6791"></a><span id="l17.6791" class="difflineplus">+      if (*_retval != nsIMsgCompConvertible::Altering &amp;&amp;  // small optimization</span>
<a href="#l17.6792"></a><span id="l17.6792" class="difflineplus">+          node-&gt;HasAttribute(NS_LITERAL_STRING(&quot;bgcolor&quot;))) {</span>
<a href="#l17.6793"></a><span id="l17.6793" class="difflineplus">+        node-&gt;GetAttribute(NS_LITERAL_STRING(&quot;bgcolor&quot;), color);</span>
<a href="#l17.6794"></a><span id="l17.6794" class="difflineplus">+        if (!color.LowerCaseEqualsLiteral(&quot;#ffffff&quot;))</span>
<a href="#l17.6795"></a><span id="l17.6795" class="difflineplus">+          *_retval = nsIMsgCompConvertible::Altering;</span>
<a href="#l17.6796"></a><span id="l17.6796" class="difflineplus">+      }</span>
<a href="#l17.6797"></a><span id="l17.6797">     }</span>
<a href="#l17.6798"></a><span id="l17.6798"> </span>
<a href="#l17.6799"></a><span id="l17.6799" class="difflineminus">-    // Title attribute is not convertible to plaintext;</span>
<a href="#l17.6800"></a><span id="l17.6800" class="difflineminus">-    // this also preserves any links with titles.</span>
<a href="#l17.6801"></a><span id="l17.6801" class="difflineminus">-    node-&gt;GetAttribute(NS_LITERAL_STRING(&quot;title&quot;), attribValue);</span>
<a href="#l17.6802"></a><span id="l17.6802" class="difflineminus">-    if (!attribValue.IsEmpty())</span>
<a href="#l17.6803"></a><span id="l17.6803" class="difflineminus">-    {</span>
<a href="#l17.6804"></a><span id="l17.6804" class="difflineminus">-      *_retval = nsIMsgCompConvertible::No;</span>
<a href="#l17.6805"></a><span id="l17.6805" class="difflineminus">-      return;</span>
<a href="#l17.6806"></a><span id="l17.6806" class="difflineminus">-    }</span>
<a href="#l17.6807"></a><span id="l17.6807" class="difflineminus">-</span>
<a href="#l17.6808"></a><span id="l17.6808" class="difflineminus">-    if      ( // Considered convertible to plaintext: Some &quot;simple&quot; elements</span>
<a href="#l17.6809"></a><span id="l17.6809" class="difflineminus">-              // without non-convertible attributes like style, class, id,</span>
<a href="#l17.6810"></a><span id="l17.6810" class="difflineminus">-              // or align (see above).</span>
<a href="#l17.6811"></a><span id="l17.6811" class="difflineminus">-              element.LowerCaseEqualsLiteral(&quot;br&quot;) ||</span>
<a href="#l17.6812"></a><span id="l17.6812" class="difflineminus">-              element.LowerCaseEqualsLiteral(&quot;p&quot;) ||</span>
<a href="#l17.6813"></a><span id="l17.6813" class="difflineminus">-              element.LowerCaseEqualsLiteral(&quot;tt&quot;) ||</span>
<a href="#l17.6814"></a><span id="l17.6814" class="difflineminus">-              element.LowerCaseEqualsLiteral(&quot;html&quot;) ||</span>
<a href="#l17.6815"></a><span id="l17.6815" class="difflineminus">-              element.LowerCaseEqualsLiteral(&quot;head&quot;) ||</span>
<a href="#l17.6816"></a><span id="l17.6816" class="difflineminus">-              element.LowerCaseEqualsLiteral(&quot;meta&quot;) ||</span>
<a href="#l17.6817"></a><span id="l17.6817" class="difflineminus">-              element.LowerCaseEqualsLiteral(&quot;title&quot;)</span>
<a href="#l17.6818"></a><span id="l17.6818" class="difflineminus">-            )</span>
<a href="#l17.6819"></a><span id="l17.6819" class="difflineminus">-    {</span>
<a href="#l17.6820"></a><span id="l17.6820" class="difflineplus">+    // ignore special color setting for link, vlink and alink at this point.</span>
<a href="#l17.6821"></a><span id="l17.6821" class="difflineplus">+  } else if (element.LowerCaseEqualsLiteral(&quot;blockquote&quot;)) {</span>
<a href="#l17.6822"></a><span id="l17.6822" class="difflineplus">+    // Skip &lt;blockquote type=&quot;cite&quot;&gt;</span>
<a href="#l17.6823"></a><span id="l17.6823" class="difflineplus">+    *_retval = nsIMsgCompConvertible::Yes;</span>
<a href="#l17.6824"></a><span id="l17.6824" class="difflineplus">+</span>
<a href="#l17.6825"></a><span id="l17.6825" class="difflineplus">+    node-&gt;GetAttribute(NS_LITERAL_STRING(&quot;type&quot;), attribValue);</span>
<a href="#l17.6826"></a><span id="l17.6826" class="difflineplus">+    if (attribValue.LowerCaseEqualsLiteral(&quot;cite&quot;)) {</span>
<a href="#l17.6827"></a><span id="l17.6827">       *_retval = nsIMsgCompConvertible::Plain;</span>
<a href="#l17.6828"></a><span id="l17.6828">     }</span>
<a href="#l17.6829"></a><span id="l17.6829" class="difflineminus">-    else if (</span>
<a href="#l17.6830"></a><span id="l17.6830" class="difflineminus">-              //element.LowerCaseEqualsLiteral(&quot;blockquote&quot;) || // see below</span>
<a href="#l17.6831"></a><span id="l17.6831" class="difflineminus">-              element.LowerCaseEqualsLiteral(&quot;ul&quot;) ||</span>
<a href="#l17.6832"></a><span id="l17.6832" class="difflineminus">-              element.LowerCaseEqualsLiteral(&quot;ol&quot;) ||</span>
<a href="#l17.6833"></a><span id="l17.6833" class="difflineminus">-              element.LowerCaseEqualsLiteral(&quot;li&quot;) ||</span>
<a href="#l17.6834"></a><span id="l17.6834" class="difflineminus">-              element.LowerCaseEqualsLiteral(&quot;dl&quot;) ||</span>
<a href="#l17.6835"></a><span id="l17.6835" class="difflineminus">-              element.LowerCaseEqualsLiteral(&quot;dt&quot;) ||</span>
<a href="#l17.6836"></a><span id="l17.6836" class="difflineminus">-              element.LowerCaseEqualsLiteral(&quot;dd&quot;)</span>
<a href="#l17.6837"></a><span id="l17.6837" class="difflineminus">-            )</span>
<a href="#l17.6838"></a><span id="l17.6838" class="difflineminus">-    {</span>
<a href="#l17.6839"></a><span id="l17.6839" class="difflineminus">-      *_retval = nsIMsgCompConvertible::Yes;</span>
<a href="#l17.6840"></a><span id="l17.6840" class="difflineminus">-    }</span>
<a href="#l17.6841"></a><span id="l17.6841" class="difflineminus">-    else if (</span>
<a href="#l17.6842"></a><span id="l17.6842" class="difflineminus">-              //element.LowerCaseEqualsLiteral(&quot;a&quot;) || // see below</span>
<a href="#l17.6843"></a><span id="l17.6843" class="difflineminus">-              element.LowerCaseEqualsLiteral(&quot;h1&quot;) ||</span>
<a href="#l17.6844"></a><span id="l17.6844" class="difflineminus">-              element.LowerCaseEqualsLiteral(&quot;h2&quot;) ||</span>
<a href="#l17.6845"></a><span id="l17.6845" class="difflineminus">-              element.LowerCaseEqualsLiteral(&quot;h3&quot;) ||</span>
<a href="#l17.6846"></a><span id="l17.6846" class="difflineminus">-              element.LowerCaseEqualsLiteral(&quot;h4&quot;) ||</span>
<a href="#l17.6847"></a><span id="l17.6847" class="difflineminus">-              element.LowerCaseEqualsLiteral(&quot;h5&quot;) ||</span>
<a href="#l17.6848"></a><span id="l17.6848" class="difflineminus">-              element.LowerCaseEqualsLiteral(&quot;h6&quot;) ||</span>
<a href="#l17.6849"></a><span id="l17.6849" class="difflineminus">-              element.LowerCaseEqualsLiteral(&quot;hr&quot;) ||</span>
<a href="#l17.6850"></a><span id="l17.6850" class="difflineminus">-              element.LowerCaseEqualsLiteral(&quot;pre&quot;) ||</span>
<a href="#l17.6851"></a><span id="l17.6851" class="difflineminus">-              (</span>
<a href="#l17.6852"></a><span id="l17.6852" class="difflineminus">-                mConvertStructs</span>
<a href="#l17.6853"></a><span id="l17.6853" class="difflineminus">-                &amp;&amp;</span>
<a href="#l17.6854"></a><span id="l17.6854" class="difflineminus">-                (</span>
<a href="#l17.6855"></a><span id="l17.6855" class="difflineminus">-                  element.LowerCaseEqualsLiteral(&quot;em&quot;) ||</span>
<a href="#l17.6856"></a><span id="l17.6856" class="difflineminus">-                  element.LowerCaseEqualsLiteral(&quot;strong&quot;) ||</span>
<a href="#l17.6857"></a><span id="l17.6857" class="difflineminus">-                  element.LowerCaseEqualsLiteral(&quot;code&quot;) ||</span>
<a href="#l17.6858"></a><span id="l17.6858" class="difflineminus">-                  element.LowerCaseEqualsLiteral(&quot;b&quot;) ||</span>
<a href="#l17.6859"></a><span id="l17.6859" class="difflineminus">-                  element.LowerCaseEqualsLiteral(&quot;i&quot;) ||</span>
<a href="#l17.6860"></a><span id="l17.6860" class="difflineminus">-                  element.LowerCaseEqualsLiteral(&quot;u&quot;)</span>
<a href="#l17.6861"></a><span id="l17.6861" class="difflineminus">-                )</span>
<a href="#l17.6862"></a><span id="l17.6862" class="difflineminus">-              )</span>
<a href="#l17.6863"></a><span id="l17.6863" class="difflineminus">-            )</span>
<a href="#l17.6864"></a><span id="l17.6864" class="difflineminus">-    {</span>
<a href="#l17.6865"></a><span id="l17.6865" class="difflineplus">+  } else if (element.LowerCaseEqualsLiteral(&quot;div&quot;) ||</span>
<a href="#l17.6866"></a><span id="l17.6866" class="difflineplus">+             element.LowerCaseEqualsLiteral(&quot;span&quot;) ||</span>
<a href="#l17.6867"></a><span id="l17.6867" class="difflineplus">+             element.LowerCaseEqualsLiteral(&quot;a&quot;)) {</span>
<a href="#l17.6868"></a><span id="l17.6868" class="difflineplus">+    /* Do some special checks for these tags. They are inside this |else if|</span>
<a href="#l17.6869"></a><span id="l17.6869" class="difflineplus">+       for performance reasons */</span>
<a href="#l17.6870"></a><span id="l17.6870" class="difflineplus">+</span>
<a href="#l17.6871"></a><span id="l17.6871" class="difflineplus">+    // Maybe, it's an &lt;a&gt; element inserted by another recognizer (e.g. 4.x')</span>
<a href="#l17.6872"></a><span id="l17.6872" class="difflineplus">+    if (element.LowerCaseEqualsLiteral(&quot;a&quot;)) {</span>
<a href="#l17.6873"></a><span id="l17.6873" class="difflineplus">+      /* Ignore anchor tag, if the URI is the same as the text</span>
<a href="#l17.6874"></a><span id="l17.6874" class="difflineplus">+         (as inserted by recognizers) */</span>
<a href="#l17.6875"></a><span id="l17.6875">       *_retval = nsIMsgCompConvertible::Altering;</span>
<a href="#l17.6876"></a><span id="l17.6876" class="difflineminus">-    }</span>
<a href="#l17.6877"></a><span id="l17.6877" class="difflineminus">-    else if (element.LowerCaseEqualsLiteral(&quot;body&quot;))</span>
<a href="#l17.6878"></a><span id="l17.6878" class="difflineminus">-    {</span>
<a href="#l17.6879"></a><span id="l17.6879" class="difflineminus">-      *_retval = nsIMsgCompConvertible::Plain;</span>
<a href="#l17.6880"></a><span id="l17.6880" class="difflineminus">-</span>
<a href="#l17.6881"></a><span id="l17.6881" class="difflineminus">-      if (node-&gt;HasAttribute(NS_LITERAL_STRING(&quot;background&quot;)) ||  // There is a background image</span>
<a href="#l17.6882"></a><span id="l17.6882" class="difflineminus">-          node-&gt;HasAttribute(NS_LITERAL_STRING(&quot;dir&quot;))) {         // dir=rtl attributes should not downconvert</span>
<a href="#l17.6883"></a><span id="l17.6883" class="difflineminus">-        *_retval = nsIMsgCompConvertible::No;</span>
<a href="#l17.6884"></a><span id="l17.6884" class="difflineminus">-      } else {</span>
<a href="#l17.6885"></a><span id="l17.6885" class="difflineminus">-        nsAutoString color;</span>
<a href="#l17.6886"></a><span id="l17.6886" class="difflineminus">-        if (node-&gt;HasAttribute(NS_LITERAL_STRING(&quot;text&quot;))) {</span>
<a href="#l17.6887"></a><span id="l17.6887" class="difflineminus">-          node-&gt;GetAttribute(NS_LITERAL_STRING(&quot;text&quot;), color);</span>
<a href="#l17.6888"></a><span id="l17.6888" class="difflineminus">-          if (!color.EqualsLiteral(&quot;#000000&quot;))</span>
<a href="#l17.6889"></a><span id="l17.6889" class="difflineminus">-            *_retval = nsIMsgCompConvertible::Altering;</span>
<a href="#l17.6890"></a><span id="l17.6890" class="difflineminus">-        }</span>
<a href="#l17.6891"></a><span id="l17.6891" class="difflineminus">-        if (*_retval != nsIMsgCompConvertible::Altering &amp;&amp;  // small optimization</span>
<a href="#l17.6892"></a><span id="l17.6892" class="difflineminus">-            node-&gt;HasAttribute(NS_LITERAL_STRING(&quot;bgcolor&quot;))) {</span>
<a href="#l17.6893"></a><span id="l17.6893" class="difflineminus">-          node-&gt;GetAttribute(NS_LITERAL_STRING(&quot;bgcolor&quot;), color);</span>
<a href="#l17.6894"></a><span id="l17.6894" class="difflineminus">-          if (!color.LowerCaseEqualsLiteral(&quot;#ffffff&quot;))</span>
<a href="#l17.6895"></a><span id="l17.6895" class="difflineminus">-            *_retval = nsIMsgCompConvertible::Altering;</span>
<a href="#l17.6896"></a><span id="l17.6896" class="difflineminus">-        }</span>
<a href="#l17.6897"></a><span id="l17.6897" class="difflineminus">-      }</span>
<a href="#l17.6898"></a><span id="l17.6898" class="difflineminus">-</span>
<a href="#l17.6899"></a><span id="l17.6899" class="difflineminus">-      //ignore special color setting for link, vlink and alink at this point.</span>
<a href="#l17.6900"></a><span id="l17.6900" class="difflineminus">-    }</span>
<a href="#l17.6901"></a><span id="l17.6901" class="difflineminus">-    else if (element.LowerCaseEqualsLiteral(&quot;blockquote&quot;))</span>
<a href="#l17.6902"></a><span id="l17.6902" class="difflineminus">-    {</span>
<a href="#l17.6903"></a><span id="l17.6903" class="difflineminus">-      // Skip &lt;blockquote type=&quot;cite&quot;&gt;</span>
<a href="#l17.6904"></a><span id="l17.6904" class="difflineminus">-      *_retval = nsIMsgCompConvertible::Yes;</span>
<a href="#l17.6905"></a><span id="l17.6905" class="difflineminus">-</span>
<a href="#l17.6906"></a><span id="l17.6906" class="difflineminus">-      node-&gt;GetAttribute(NS_LITERAL_STRING(&quot;type&quot;), attribValue);</span>
<a href="#l17.6907"></a><span id="l17.6907" class="difflineminus">-      if (attribValue.LowerCaseEqualsLiteral(&quot;cite&quot;))</span>
<a href="#l17.6908"></a><span id="l17.6908" class="difflineminus">-      {</span>
<a href="#l17.6909"></a><span id="l17.6909" class="difflineminus">-        *_retval = nsIMsgCompConvertible::Plain;</span>
<a href="#l17.6910"></a><span id="l17.6910" class="difflineplus">+</span>
<a href="#l17.6911"></a><span id="l17.6911" class="difflineplus">+      nsAutoString hrefValue;</span>
<a href="#l17.6912"></a><span id="l17.6912" class="difflineplus">+      node-&gt;GetAttribute(NS_LITERAL_STRING(&quot;href&quot;), hrefValue);</span>
<a href="#l17.6913"></a><span id="l17.6913" class="difflineplus">+      nsINodeList *children = node-&gt;ChildNodes();</span>
<a href="#l17.6914"></a><span id="l17.6914" class="difflineplus">+      if (children-&gt;Length() &gt; 0) {</span>
<a href="#l17.6915"></a><span id="l17.6915" class="difflineplus">+        nsINode *pItem = children-&gt;Item(0);</span>
<a href="#l17.6916"></a><span id="l17.6916" class="difflineplus">+        nsAutoString textValue;</span>
<a href="#l17.6917"></a><span id="l17.6917" class="difflineplus">+        pItem-&gt;GetNodeValue(textValue);</span>
<a href="#l17.6918"></a><span id="l17.6918" class="difflineplus">+        if (textValue == hrefValue) *_retval = nsIMsgCompConvertible::Plain;</span>
<a href="#l17.6919"></a><span id="l17.6919">       }</span>
<a href="#l17.6920"></a><span id="l17.6920">     }</span>
<a href="#l17.6921"></a><span id="l17.6921" class="difflineminus">-    else if (</span>
<a href="#l17.6922"></a><span id="l17.6922" class="difflineminus">-              element.LowerCaseEqualsLiteral(&quot;div&quot;) ||</span>
<a href="#l17.6923"></a><span id="l17.6923" class="difflineminus">-              element.LowerCaseEqualsLiteral(&quot;span&quot;) ||</span>
<a href="#l17.6924"></a><span id="l17.6924" class="difflineminus">-              element.LowerCaseEqualsLiteral(&quot;a&quot;)</span>
<a href="#l17.6925"></a><span id="l17.6925" class="difflineminus">-            )</span>
<a href="#l17.6926"></a><span id="l17.6926" class="difflineminus">-    {</span>
<a href="#l17.6927"></a><span id="l17.6927" class="difflineminus">-      /* Do some special checks for these tags. They are inside this |else if|</span>
<a href="#l17.6928"></a><span id="l17.6928" class="difflineminus">-         for performance reasons */</span>
<a href="#l17.6929"></a><span id="l17.6929" class="difflineminus">-</span>
<a href="#l17.6930"></a><span id="l17.6930" class="difflineminus">-      // Maybe, it's an &lt;a&gt; element inserted by another recognizer (e.g. 4.x')</span>
<a href="#l17.6931"></a><span id="l17.6931" class="difflineminus">-      if (element.LowerCaseEqualsLiteral(&quot;a&quot;))</span>
<a href="#l17.6932"></a><span id="l17.6932" class="difflineminus">-      {</span>
<a href="#l17.6933"></a><span id="l17.6933" class="difflineminus">-        /* Ignore anchor tag, if the URI is the same as the text</span>
<a href="#l17.6934"></a><span id="l17.6934" class="difflineminus">-           (as inserted by recognizers) */</span>
<a href="#l17.6935"></a><span id="l17.6935" class="difflineminus">-        *_retval = nsIMsgCompConvertible::Altering;</span>
<a href="#l17.6936"></a><span id="l17.6936" class="difflineminus">-</span>
<a href="#l17.6937"></a><span id="l17.6937" class="difflineminus">-        nsAutoString hrefValue;</span>
<a href="#l17.6938"></a><span id="l17.6938" class="difflineminus">-        node-&gt;GetAttribute(NS_LITERAL_STRING(&quot;href&quot;), hrefValue);</span>
<a href="#l17.6939"></a><span id="l17.6939" class="difflineminus">-        nsINodeList* children = node-&gt;ChildNodes();</span>
<a href="#l17.6940"></a><span id="l17.6940" class="difflineminus">-        if (children-&gt;Length() &gt; 0) {</span>
<a href="#l17.6941"></a><span id="l17.6941" class="difflineminus">-          nsINode* pItem = children-&gt;Item(0);</span>
<a href="#l17.6942"></a><span id="l17.6942" class="difflineminus">-          nsAutoString textValue;</span>
<a href="#l17.6943"></a><span id="l17.6943" class="difflineminus">-          pItem-&gt;GetNodeValue(textValue);</span>
<a href="#l17.6944"></a><span id="l17.6944" class="difflineminus">-          if (textValue == hrefValue)</span>
<a href="#l17.6945"></a><span id="l17.6945" class="difflineminus">-            *_retval = nsIMsgCompConvertible::Plain;</span>
<a href="#l17.6946"></a><span id="l17.6946" class="difflineminus">-        }</span>
<a href="#l17.6947"></a><span id="l17.6947" class="difflineminus">-      }</span>
<a href="#l17.6948"></a><span id="l17.6948" class="difflineminus">-</span>
<a href="#l17.6949"></a><span id="l17.6949" class="difflineminus">-      // Lastly, test, if it is just a &quot;simple&quot; &lt;div&gt; or &lt;span&gt;</span>
<a href="#l17.6950"></a><span id="l17.6950" class="difflineminus">-      else if (</span>
<a href="#l17.6951"></a><span id="l17.6951" class="difflineminus">-                element.LowerCaseEqualsLiteral(&quot;div&quot;) ||</span>
<a href="#l17.6952"></a><span id="l17.6952" class="difflineminus">-                element.LowerCaseEqualsLiteral(&quot;span&quot;)</span>
<a href="#l17.6953"></a><span id="l17.6953" class="difflineminus">-              )</span>
<a href="#l17.6954"></a><span id="l17.6954" class="difflineminus">-      {</span>
<a href="#l17.6955"></a><span id="l17.6955" class="difflineminus">-        *_retval = nsIMsgCompConvertible::Plain;</span>
<a href="#l17.6956"></a><span id="l17.6956" class="difflineminus">-      }</span>
<a href="#l17.6957"></a><span id="l17.6957" class="difflineplus">+</span>
<a href="#l17.6958"></a><span id="l17.6958" class="difflineplus">+    // Lastly, test, if it is just a &quot;simple&quot; &lt;div&gt; or &lt;span&gt;</span>
<a href="#l17.6959"></a><span id="l17.6959" class="difflineplus">+    else if (element.LowerCaseEqualsLiteral(&quot;div&quot;) ||</span>
<a href="#l17.6960"></a><span id="l17.6960" class="difflineplus">+             element.LowerCaseEqualsLiteral(&quot;span&quot;)) {</span>
<a href="#l17.6961"></a><span id="l17.6961" class="difflineplus">+      *_retval = nsIMsgCompConvertible::Plain;</span>
<a href="#l17.6962"></a><span id="l17.6962">     }</span>
<a href="#l17.6963"></a><span id="l17.6963" class="difflineplus">+  }</span>
<a href="#l17.6964"></a><span id="l17.6964"> }</span>
<a href="#l17.6965"></a><span id="l17.6965"> </span>
<a href="#l17.6966"></a><span id="l17.6966"> /**</span>
<a href="#l17.6967"></a><span id="l17.6967">  * Note: Helper function. Parameters are not checked.</span>
<a href="#l17.6968"></a><span id="l17.6968">  */</span>
<a href="#l17.6969"></a><span id="l17.6969" class="difflineminus">-void nsMsgCompose::_NodeTreeConvertible(Element *node, int32_t *_retval)</span>
<a href="#l17.6970"></a><span id="l17.6970" class="difflineminus">-{</span>
<a href="#l17.6971"></a><span id="l17.6971" class="difflineplus">+void nsMsgCompose::_NodeTreeConvertible(Element *node, int32_t *_retval) {</span>
<a href="#l17.6972"></a><span id="l17.6972">   int32_t result;</span>
<a href="#l17.6973"></a><span id="l17.6973"> </span>
<a href="#l17.6974"></a><span id="l17.6974">   // Check this node</span>
<a href="#l17.6975"></a><span id="l17.6975">   TagConvertible(node, &amp;result);</span>
<a href="#l17.6976"></a><span id="l17.6976"> </span>
<a href="#l17.6977"></a><span id="l17.6977">   // Walk tree recursively to check the children.</span>
<a href="#l17.6978"></a><span id="l17.6978" class="difflineminus">-  nsINodeList* children = node-&gt;ChildNodes();</span>
<a href="#l17.6979"></a><span id="l17.6979" class="difflineminus">-  for (uint32_t i = 0; i &lt; children-&gt;Length(); i++)</span>
<a href="#l17.6980"></a><span id="l17.6980" class="difflineminus">-  {</span>
<a href="#l17.6981"></a><span id="l17.6981" class="difflineminus">-    nsINode* pItem = children-&gt;Item(i);</span>
<a href="#l17.6982"></a><span id="l17.6982" class="difflineplus">+  nsINodeList *children = node-&gt;ChildNodes();</span>
<a href="#l17.6983"></a><span id="l17.6983" class="difflineplus">+  for (uint32_t i = 0; i &lt; children-&gt;Length(); i++) {</span>
<a href="#l17.6984"></a><span id="l17.6984" class="difflineplus">+    nsINode *pItem = children-&gt;Item(i);</span>
<a href="#l17.6985"></a><span id="l17.6985">     // We assume all nodes that are not elements are convertible,</span>
<a href="#l17.6986"></a><span id="l17.6986">     // so only test elements.</span>
<a href="#l17.6987"></a><span id="l17.6987">     nsCOMPtr&lt;Element&gt; domElement = do_QueryInterface(pItem);</span>
<a href="#l17.6988"></a><span id="l17.6988">     if (domElement) {</span>
<a href="#l17.6989"></a><span id="l17.6989">       int32_t curresult;</span>
<a href="#l17.6990"></a><span id="l17.6990">       _NodeTreeConvertible(domElement, &amp;curresult);</span>
<a href="#l17.6991"></a><span id="l17.6991"> </span>
<a href="#l17.6992"></a><span id="l17.6992" class="difflineminus">-      if (curresult &gt; result)</span>
<a href="#l17.6993"></a><span id="l17.6993" class="difflineminus">-        result = curresult;</span>
<a href="#l17.6994"></a><span id="l17.6994" class="difflineplus">+      if (curresult &gt; result) result = curresult;</span>
<a href="#l17.6995"></a><span id="l17.6995">     }</span>
<a href="#l17.6996"></a><span id="l17.6996">   }</span>
<a href="#l17.6997"></a><span id="l17.6997"> </span>
<a href="#l17.6998"></a><span id="l17.6998">   *_retval = result;</span>
<a href="#l17.6999"></a><span id="l17.6999"> }</span>
<a href="#l17.7000"></a><span id="l17.7000"> </span>
<a href="#l17.7001"></a><span id="l17.7001"> NS_IMETHODIMP</span>
<a href="#l17.7002"></a><span id="l17.7002" class="difflineminus">-nsMsgCompose::BodyConvertible(int32_t *_retval)</span>
<a href="#l17.7003"></a><span id="l17.7003" class="difflineminus">-{</span>
<a href="#l17.7004"></a><span id="l17.7004" class="difflineminus">-    NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l17.7005"></a><span id="l17.7005" class="difflineminus">-    NS_ENSURE_STATE(m_editor);</span>
<a href="#l17.7006"></a><span id="l17.7006" class="difflineminus">-</span>
<a href="#l17.7007"></a><span id="l17.7007" class="difflineminus">-    nsCOMPtr&lt;Document&gt; rootDocument;</span>
<a href="#l17.7008"></a><span id="l17.7008" class="difflineminus">-    nsresult rv = m_editor-&gt;GetDocument(getter_AddRefs(rootDocument));</span>
<a href="#l17.7009"></a><span id="l17.7009" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l17.7010"></a><span id="l17.7010" class="difflineminus">-      return rv;</span>
<a href="#l17.7011"></a><span id="l17.7011" class="difflineminus">-    if (!rootDocument)</span>
<a href="#l17.7012"></a><span id="l17.7012" class="difflineminus">-      return NS_ERROR_UNEXPECTED;</span>
<a href="#l17.7013"></a><span id="l17.7013" class="difflineminus">-</span>
<a href="#l17.7014"></a><span id="l17.7014" class="difflineminus">-    // get the top level element, which contains &lt;html&gt;</span>
<a href="#l17.7015"></a><span id="l17.7015" class="difflineminus">-    nsCOMPtr&lt;Element&gt; rootElement = rootDocument-&gt;GetDocumentElement();</span>
<a href="#l17.7016"></a><span id="l17.7016" class="difflineminus">-    if (!rootElement)</span>
<a href="#l17.7017"></a><span id="l17.7017" class="difflineminus">-      return NS_ERROR_UNEXPECTED;</span>
<a href="#l17.7018"></a><span id="l17.7018" class="difflineminus">-</span>
<a href="#l17.7019"></a><span id="l17.7019" class="difflineminus">-    _NodeTreeConvertible(rootElement, _retval);</span>
<a href="#l17.7020"></a><span id="l17.7020" class="difflineminus">-    return NS_OK;</span>
<a href="#l17.7021"></a><span id="l17.7021" class="difflineplus">+nsMsgCompose::BodyConvertible(int32_t *_retval) {</span>
<a href="#l17.7022"></a><span id="l17.7022" class="difflineplus">+  NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l17.7023"></a><span id="l17.7023" class="difflineplus">+  NS_ENSURE_STATE(m_editor);</span>
<a href="#l17.7024"></a><span id="l17.7024" class="difflineplus">+</span>
<a href="#l17.7025"></a><span id="l17.7025" class="difflineplus">+  nsCOMPtr&lt;Document&gt; rootDocument;</span>
<a href="#l17.7026"></a><span id="l17.7026" class="difflineplus">+  nsresult rv = m_editor-&gt;GetDocument(getter_AddRefs(rootDocument));</span>
<a href="#l17.7027"></a><span id="l17.7027" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l17.7028"></a><span id="l17.7028" class="difflineplus">+  if (!rootDocument) return NS_ERROR_UNEXPECTED;</span>
<a href="#l17.7029"></a><span id="l17.7029" class="difflineplus">+</span>
<a href="#l17.7030"></a><span id="l17.7030" class="difflineplus">+  // get the top level element, which contains &lt;html&gt;</span>
<a href="#l17.7031"></a><span id="l17.7031" class="difflineplus">+  nsCOMPtr&lt;Element&gt; rootElement = rootDocument-&gt;GetDocumentElement();</span>
<a href="#l17.7032"></a><span id="l17.7032" class="difflineplus">+  if (!rootElement) return NS_ERROR_UNEXPECTED;</span>
<a href="#l17.7033"></a><span id="l17.7033" class="difflineplus">+</span>
<a href="#l17.7034"></a><span id="l17.7034" class="difflineplus">+  _NodeTreeConvertible(rootElement, _retval);</span>
<a href="#l17.7035"></a><span id="l17.7035" class="difflineplus">+  return NS_OK;</span>
<a href="#l17.7036"></a><span id="l17.7036"> }</span>
<a href="#l17.7037"></a><span id="l17.7037"> </span>
<a href="#l17.7038"></a><span id="l17.7038"> NS_IMETHODIMP</span>
<a href="#l17.7039"></a><span id="l17.7039" class="difflineminus">-nsMsgCompose::GetIdentity(nsIMsgIdentity **aIdentity)</span>
<a href="#l17.7040"></a><span id="l17.7040" class="difflineminus">-{</span>
<a href="#l17.7041"></a><span id="l17.7041" class="difflineplus">+nsMsgCompose::GetIdentity(nsIMsgIdentity **aIdentity) {</span>
<a href="#l17.7042"></a><span id="l17.7042">   NS_ENSURE_ARG_POINTER(aIdentity);</span>
<a href="#l17.7043"></a><span id="l17.7043">   NS_IF_ADDREF(*aIdentity = m_identity);</span>
<a href="#l17.7044"></a><span id="l17.7044">   return NS_OK;</span>
<a href="#l17.7045"></a><span id="l17.7045"> }</span>
<a href="#l17.7046"></a><span id="l17.7046"> </span>
<a href="#l17.7047"></a><span id="l17.7047"> /**</span>
<a href="#l17.7048"></a><span id="l17.7048">  * Position above the quote, that is either &lt;blockquote&gt; or</span>
<a href="#l17.7049"></a><span id="l17.7049">  * &lt;div class=&quot;moz-cite-prefix&quot;&gt; or &lt;div class=&quot;moz-forward-container&quot;&gt;</span>
<a href="#l17.7050"></a><span id="l17.7050">  * in an inline-forwarded message.</span>
<a href="#l17.7051"></a><span id="l17.7051">  */</span>
<a href="#l17.7052"></a><span id="l17.7052" class="difflineminus">-nsresult</span>
<a href="#l17.7053"></a><span id="l17.7053" class="difflineminus">-nsMsgCompose::MoveToAboveQuote(void)</span>
<a href="#l17.7054"></a><span id="l17.7054" class="difflineminus">-{</span>
<a href="#l17.7055"></a><span id="l17.7055" class="difflineplus">+nsresult nsMsgCompose::MoveToAboveQuote(void) {</span>
<a href="#l17.7056"></a><span id="l17.7056">   RefPtr&lt;Element&gt; rootElement;</span>
<a href="#l17.7057"></a><span id="l17.7057">   nsresult rv = m_editor-&gt;GetRootElement(getter_AddRefs(rootElement));</span>
<a href="#l17.7058"></a><span id="l17.7058">   if (NS_FAILED(rv) || !rootElement) {</span>
<a href="#l17.7059"></a><span id="l17.7059">     return rv;</span>
<a href="#l17.7060"></a><span id="l17.7060">   }</span>
<a href="#l17.7061"></a><span id="l17.7061"> </span>
<a href="#l17.7062"></a><span id="l17.7062">   nsCOMPtr&lt;nsINode&gt; node;</span>
<a href="#l17.7063"></a><span id="l17.7063">   nsAutoString attributeName;</span>
<a href="#l17.7064"></a><span id="l17.7064" class="difflineat">@@ -5707,53 +5221,47 @@ nsMsgCompose::MoveToAboveQuote(void)</span>
<a href="#l17.7065"></a><span id="l17.7065">   if (node) {</span>
<a href="#l17.7066"></a><span id="l17.7066">     rv = GetChildOffset(node, rootElement2, offset);</span>
<a href="#l17.7067"></a><span id="l17.7067">     if (NS_FAILED(rv)) {</span>
<a href="#l17.7068"></a><span id="l17.7068">       return rv;</span>
<a href="#l17.7069"></a><span id="l17.7069">     }</span>
<a href="#l17.7070"></a><span id="l17.7070">   }</span>
<a href="#l17.7071"></a><span id="l17.7071">   RefPtr&lt;Selection&gt; selection;</span>
<a href="#l17.7072"></a><span id="l17.7072">   m_editor-&gt;GetSelection(getter_AddRefs(selection));</span>
<a href="#l17.7073"></a><span id="l17.7073" class="difflineminus">-  if (selection)</span>
<a href="#l17.7074"></a><span id="l17.7074" class="difflineminus">-    rv = selection-&gt;Collapse(rootElement, offset);</span>
<a href="#l17.7075"></a><span id="l17.7075" class="difflineplus">+  if (selection) rv = selection-&gt;Collapse(rootElement, offset);</span>
<a href="#l17.7076"></a><span id="l17.7076"> </span>
<a href="#l17.7077"></a><span id="l17.7077">   return rv;</span>
<a href="#l17.7078"></a><span id="l17.7078"> }</span>
<a href="#l17.7079"></a><span id="l17.7079"> </span>
<a href="#l17.7080"></a><span id="l17.7080"> /**</span>
<a href="#l17.7081"></a><span id="l17.7081" class="difflineminus">- * nsEditor::BeginningOfDocument() will position to the beginning of the document</span>
<a href="#l17.7082"></a><span id="l17.7082" class="difflineminus">- * before the first editable element. It will position into a container.</span>
<a href="#l17.7083"></a><span id="l17.7083" class="difflineminus">- * We need to be at the very front.</span>
<a href="#l17.7084"></a><span id="l17.7084" class="difflineplus">+ * nsEditor::BeginningOfDocument() will position to the beginning of the</span>
<a href="#l17.7085"></a><span id="l17.7085" class="difflineplus">+ * document before the first editable element. It will position into a</span>
<a href="#l17.7086"></a><span id="l17.7086" class="difflineplus">+ * container. We need to be at the very front.</span>
<a href="#l17.7087"></a><span id="l17.7087">  */</span>
<a href="#l17.7088"></a><span id="l17.7088" class="difflineminus">-nsresult</span>
<a href="#l17.7089"></a><span id="l17.7089" class="difflineminus">-nsMsgCompose::MoveToBeginningOfDocument(void)</span>
<a href="#l17.7090"></a><span id="l17.7090" class="difflineminus">-{</span>
<a href="#l17.7091"></a><span id="l17.7091" class="difflineplus">+nsresult nsMsgCompose::MoveToBeginningOfDocument(void) {</span>
<a href="#l17.7092"></a><span id="l17.7092">   RefPtr&lt;Element&gt; rootElement;</span>
<a href="#l17.7093"></a><span id="l17.7093">   nsresult rv = m_editor-&gt;GetRootElement(getter_AddRefs(rootElement));</span>
<a href="#l17.7094"></a><span id="l17.7094">   if (NS_FAILED(rv) || !rootElement) {</span>
<a href="#l17.7095"></a><span id="l17.7095">     return rv;</span>
<a href="#l17.7096"></a><span id="l17.7096">   }</span>
<a href="#l17.7097"></a><span id="l17.7097"> </span>
<a href="#l17.7098"></a><span id="l17.7098">   RefPtr&lt;Selection&gt; selection;</span>
<a href="#l17.7099"></a><span id="l17.7099">   m_editor-&gt;GetSelection(getter_AddRefs(selection));</span>
<a href="#l17.7100"></a><span id="l17.7100" class="difflineminus">-  if (selection)</span>
<a href="#l17.7101"></a><span id="l17.7101" class="difflineminus">-    rv = selection-&gt;Collapse(rootElement, 0);</span>
<a href="#l17.7102"></a><span id="l17.7102" class="difflineplus">+  if (selection) rv = selection-&gt;Collapse(rootElement, 0);</span>
<a href="#l17.7103"></a><span id="l17.7103"> </span>
<a href="#l17.7104"></a><span id="l17.7104">   return rv;</span>
<a href="#l17.7105"></a><span id="l17.7105"> }</span>
<a href="#l17.7106"></a><span id="l17.7106"> </span>
<a href="#l17.7107"></a><span id="l17.7107"> /**</span>
<a href="#l17.7108"></a><span id="l17.7108">  * M-C's nsEditor::EndOfDocument() will position to the end of the document</span>
<a href="#l17.7109"></a><span id="l17.7109">  * but it will position into a container. We really need to position</span>
<a href="#l17.7110"></a><span id="l17.7110">  * after the last container so we don't accidentally position into a</span>
<a href="#l17.7111"></a><span id="l17.7111">  * &lt;blockquote&gt;. That's why we use our own function.</span>
<a href="#l17.7112"></a><span id="l17.7112">  */</span>
<a href="#l17.7113"></a><span id="l17.7113" class="difflineminus">-nsresult</span>
<a href="#l17.7114"></a><span id="l17.7114" class="difflineminus">-nsMsgCompose::MoveToEndOfDocument(void)</span>
<a href="#l17.7115"></a><span id="l17.7115" class="difflineminus">-{</span>
<a href="#l17.7116"></a><span id="l17.7116" class="difflineplus">+nsresult nsMsgCompose::MoveToEndOfDocument(void) {</span>
<a href="#l17.7117"></a><span id="l17.7117">   int32_t offset;</span>
<a href="#l17.7118"></a><span id="l17.7118">   RefPtr&lt;Element&gt; rootElement;</span>
<a href="#l17.7119"></a><span id="l17.7119">   nsCOMPtr&lt;nsINode&gt; lastNode;</span>
<a href="#l17.7120"></a><span id="l17.7120">   nsresult rv = m_editor-&gt;GetRootElement(getter_AddRefs(rootElement));</span>
<a href="#l17.7121"></a><span id="l17.7121">   if (NS_FAILED(rv) || !rootElement) {</span>
<a href="#l17.7122"></a><span id="l17.7122">     return rv;</span>
<a href="#l17.7123"></a><span id="l17.7123">   }</span>
<a href="#l17.7124"></a><span id="l17.7124"> </span>
<a href="#l17.7125"></a><span id="l17.7125" class="difflineat">@@ -5765,121 +5273,107 @@ nsMsgCompose::MoveToEndOfDocument(void)</span>
<a href="#l17.7126"></a><span id="l17.7126"> </span>
<a href="#l17.7127"></a><span id="l17.7127">   rv = GetChildOffset(lastNode, rootElement2, offset);</span>
<a href="#l17.7128"></a><span id="l17.7128">   if (NS_FAILED(rv)) {</span>
<a href="#l17.7129"></a><span id="l17.7129">     return rv;</span>
<a href="#l17.7130"></a><span id="l17.7130">   }</span>
<a href="#l17.7131"></a><span id="l17.7131"> </span>
<a href="#l17.7132"></a><span id="l17.7132">   RefPtr&lt;Selection&gt; selection;</span>
<a href="#l17.7133"></a><span id="l17.7133">   m_editor-&gt;GetSelection(getter_AddRefs(selection));</span>
<a href="#l17.7134"></a><span id="l17.7134" class="difflineminus">-  if (selection)</span>
<a href="#l17.7135"></a><span id="l17.7135" class="difflineminus">-    rv = selection-&gt;Collapse(rootElement, offset + 1);</span>
<a href="#l17.7136"></a><span id="l17.7136" class="difflineplus">+  if (selection) rv = selection-&gt;Collapse(rootElement, offset + 1);</span>
<a href="#l17.7137"></a><span id="l17.7137"> </span>
<a href="#l17.7138"></a><span id="l17.7138">   return rv;</span>
<a href="#l17.7139"></a><span id="l17.7139"> }</span>
<a href="#l17.7140"></a><span id="l17.7140"> </span>
<a href="#l17.7141"></a><span id="l17.7141"> MOZ_CAN_RUN_SCRIPT_BOUNDARY NS_IMETHODIMP</span>
<a href="#l17.7142"></a><span id="l17.7142" class="difflineminus">-nsMsgCompose::SetIdentity(nsIMsgIdentity *aIdentity)</span>
<a href="#l17.7143"></a><span id="l17.7143" class="difflineminus">-{</span>
<a href="#l17.7144"></a><span id="l17.7144" class="difflineplus">+nsMsgCompose::SetIdentity(nsIMsgIdentity *aIdentity) {</span>
<a href="#l17.7145"></a><span id="l17.7145">   NS_ENSURE_ARG_POINTER(aIdentity);</span>
<a href="#l17.7146"></a><span id="l17.7146"> </span>
<a href="#l17.7147"></a><span id="l17.7147">   m_identity = aIdentity;</span>
<a href="#l17.7148"></a><span id="l17.7148"> </span>
<a href="#l17.7149"></a><span id="l17.7149">   nsresult rv;</span>
<a href="#l17.7150"></a><span id="l17.7150"> </span>
<a href="#l17.7151"></a><span id="l17.7151" class="difflineminus">-  if (! m_editor)</span>
<a href="#l17.7152"></a><span id="l17.7152" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l17.7153"></a><span id="l17.7153" class="difflineplus">+  if (!m_editor) return NS_ERROR_FAILURE;</span>
<a href="#l17.7154"></a><span id="l17.7154"> </span>
<a href="#l17.7155"></a><span id="l17.7155">   RefPtr&lt;Element&gt; rootElement;</span>
<a href="#l17.7156"></a><span id="l17.7156">   rv = m_editor-&gt;GetRootElement(getter_AddRefs(rootElement));</span>
<a href="#l17.7157"></a><span id="l17.7157" class="difflineminus">-  if (NS_FAILED(rv) || !rootElement)</span>
<a href="#l17.7158"></a><span id="l17.7158" class="difflineminus">-    return rv;</span>
<a href="#l17.7159"></a><span id="l17.7159" class="difflineminus">-</span>
<a href="#l17.7160"></a><span id="l17.7160" class="difflineminus">-  //First look for the current signature, if we have one</span>
<a href="#l17.7161"></a><span id="l17.7161" class="difflineplus">+  if (NS_FAILED(rv) || !rootElement) return rv;</span>
<a href="#l17.7162"></a><span id="l17.7162" class="difflineplus">+</span>
<a href="#l17.7163"></a><span id="l17.7163" class="difflineplus">+  // First look for the current signature, if we have one</span>
<a href="#l17.7164"></a><span id="l17.7164">   nsCOMPtr&lt;nsINode&gt; lastNode;</span>
<a href="#l17.7165"></a><span id="l17.7165">   nsCOMPtr&lt;nsINode&gt; node;</span>
<a href="#l17.7166"></a><span id="l17.7166">   nsCOMPtr&lt;nsINode&gt; tempNode;</span>
<a href="#l17.7167"></a><span id="l17.7167">   nsAutoString tagLocalName;</span>
<a href="#l17.7168"></a><span id="l17.7168"> </span>
<a href="#l17.7169"></a><span id="l17.7169">   RefPtr&lt;nsINode&gt; rootElement2 = rootElement;</span>
<a href="#l17.7170"></a><span id="l17.7170">   lastNode = rootElement2-&gt;GetLastChild();</span>
<a href="#l17.7171"></a><span id="l17.7171" class="difflineminus">-  if (lastNode)</span>
<a href="#l17.7172"></a><span id="l17.7172" class="difflineminus">-  {</span>
<a href="#l17.7173"></a><span id="l17.7173" class="difflineplus">+  if (lastNode) {</span>
<a href="#l17.7174"></a><span id="l17.7174">     node = lastNode;</span>
<a href="#l17.7175"></a><span id="l17.7175">     // In html, the signature is inside an element with</span>
<a href="#l17.7176"></a><span id="l17.7176">     // class=&quot;moz-signature&quot;</span>
<a href="#l17.7177"></a><span id="l17.7177">     bool signatureFound = false;</span>
<a href="#l17.7178"></a><span id="l17.7178">     nsAutoString attributeName;</span>
<a href="#l17.7179"></a><span id="l17.7179">     attributeName.AssignLiteral(&quot;class&quot;);</span>
<a href="#l17.7180"></a><span id="l17.7180"> </span>
<a href="#l17.7181"></a><span id="l17.7181" class="difflineminus">-    while (node)</span>
<a href="#l17.7182"></a><span id="l17.7182" class="difflineminus">-    {</span>
<a href="#l17.7183"></a><span id="l17.7183" class="difflineplus">+    while (node) {</span>
<a href="#l17.7184"></a><span id="l17.7184">       nsCOMPtr&lt;Element&gt; element = do_QueryInterface(node);</span>
<a href="#l17.7185"></a><span id="l17.7185" class="difflineminus">-      if (element)</span>
<a href="#l17.7186"></a><span id="l17.7186" class="difflineminus">-      {</span>
<a href="#l17.7187"></a><span id="l17.7187" class="difflineplus">+      if (element) {</span>
<a href="#l17.7188"></a><span id="l17.7188">         nsAutoString attributeValue;</span>
<a href="#l17.7189"></a><span id="l17.7189"> </span>
<a href="#l17.7190"></a><span id="l17.7190">         element-&gt;GetAttribute(attributeName, attributeValue);</span>
<a href="#l17.7191"></a><span id="l17.7191"> </span>
<a href="#l17.7192"></a><span id="l17.7192">         if (attributeValue.Find(&quot;moz-signature&quot;, true) != kNotFound) {</span>
<a href="#l17.7193"></a><span id="l17.7193">           signatureFound = true;</span>
<a href="#l17.7194"></a><span id="l17.7194">           break;</span>
<a href="#l17.7195"></a><span id="l17.7195">         }</span>
<a href="#l17.7196"></a><span id="l17.7196">       }</span>
<a href="#l17.7197"></a><span id="l17.7197">       node = node-&gt;GetPreviousSibling();</span>
<a href="#l17.7198"></a><span id="l17.7198">     }</span>
<a href="#l17.7199"></a><span id="l17.7199"> </span>
<a href="#l17.7200"></a><span id="l17.7200" class="difflineminus">-    if (signatureFound)</span>
<a href="#l17.7201"></a><span id="l17.7201" class="difflineminus">-    {</span>
<a href="#l17.7202"></a><span id="l17.7202" class="difflineplus">+    if (signatureFound) {</span>
<a href="#l17.7203"></a><span id="l17.7203">       nsCOMPtr&lt;nsIEditor&gt; editor(m_editor);  // Strong reference.</span>
<a href="#l17.7204"></a><span id="l17.7204">       editor-&gt;BeginTransaction();</span>
<a href="#l17.7205"></a><span id="l17.7205">       tempNode = node-&gt;GetPreviousSibling();</span>
<a href="#l17.7206"></a><span id="l17.7206">       rv = editor-&gt;DeleteNode(node);</span>
<a href="#l17.7207"></a><span id="l17.7207" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l17.7208"></a><span id="l17.7208" class="difflineminus">-      {</span>
<a href="#l17.7209"></a><span id="l17.7209" class="difflineplus">+      if (NS_FAILED(rv)) {</span>
<a href="#l17.7210"></a><span id="l17.7210">         editor-&gt;EndTransaction();</span>
<a href="#l17.7211"></a><span id="l17.7211">         return rv;</span>
<a href="#l17.7212"></a><span id="l17.7212">       }</span>
<a href="#l17.7213"></a><span id="l17.7213"> </span>
<a href="#l17.7214"></a><span id="l17.7214">       // Also, remove the &lt;br&gt; right before the signature.</span>
<a href="#l17.7215"></a><span id="l17.7215" class="difflineminus">-      if (tempNode)</span>
<a href="#l17.7216"></a><span id="l17.7216" class="difflineminus">-      {</span>
<a href="#l17.7217"></a><span id="l17.7217" class="difflineplus">+      if (tempNode) {</span>
<a href="#l17.7218"></a><span id="l17.7218">         tagLocalName = tempNode-&gt;LocalName();</span>
<a href="#l17.7219"></a><span id="l17.7219" class="difflineminus">-        if (tagLocalName.EqualsLiteral(&quot;br&quot;))</span>
<a href="#l17.7220"></a><span id="l17.7220" class="difflineminus">-          editor-&gt;DeleteNode(tempNode);</span>
<a href="#l17.7221"></a><span id="l17.7221" class="difflineplus">+        if (tagLocalName.EqualsLiteral(&quot;br&quot;)) editor-&gt;DeleteNode(tempNode);</span>
<a href="#l17.7222"></a><span id="l17.7222">       }</span>
<a href="#l17.7223"></a><span id="l17.7223">       editor-&gt;EndTransaction();</span>
<a href="#l17.7224"></a><span id="l17.7224">     }</span>
<a href="#l17.7225"></a><span id="l17.7225">   }</span>
<a href="#l17.7226"></a><span id="l17.7226"> </span>
<a href="#l17.7227"></a><span id="l17.7227" class="difflineminus">-  if (!CheckIncludeSignaturePrefs(aIdentity))</span>
<a href="#l17.7228"></a><span id="l17.7228" class="difflineminus">-    return NS_OK;</span>
<a href="#l17.7229"></a><span id="l17.7229" class="difflineplus">+  if (!CheckIncludeSignaturePrefs(aIdentity)) return NS_OK;</span>
<a href="#l17.7230"></a><span id="l17.7230"> </span>
<a href="#l17.7231"></a><span id="l17.7231">   // Then add the new one if needed</span>
<a href="#l17.7232"></a><span id="l17.7232">   nsAutoString aSignature;</span>
<a href="#l17.7233"></a><span id="l17.7233"> </span>
<a href="#l17.7234"></a><span id="l17.7234">   // No delimiter needed if not a compose window</span>
<a href="#l17.7235"></a><span id="l17.7235">   bool isQuoted;</span>
<a href="#l17.7236"></a><span id="l17.7236" class="difflineminus">-  switch (mType)</span>
<a href="#l17.7237"></a><span id="l17.7237" class="difflineminus">-  {</span>
<a href="#l17.7238"></a><span id="l17.7238" class="difflineminus">-    case nsIMsgCompType::New :</span>
<a href="#l17.7239"></a><span id="l17.7239" class="difflineminus">-    case nsIMsgCompType::NewsPost :</span>
<a href="#l17.7240"></a><span id="l17.7240" class="difflineminus">-    case nsIMsgCompType::MailToUrl :</span>
<a href="#l17.7241"></a><span id="l17.7241" class="difflineminus">-    case nsIMsgCompType::ForwardAsAttachment :</span>
<a href="#l17.7242"></a><span id="l17.7242" class="difflineplus">+  switch (mType) {</span>
<a href="#l17.7243"></a><span id="l17.7243" class="difflineplus">+    case nsIMsgCompType::New:</span>
<a href="#l17.7244"></a><span id="l17.7244" class="difflineplus">+    case nsIMsgCompType::NewsPost:</span>
<a href="#l17.7245"></a><span id="l17.7245" class="difflineplus">+    case nsIMsgCompType::MailToUrl:</span>
<a href="#l17.7246"></a><span id="l17.7246" class="difflineplus">+    case nsIMsgCompType::ForwardAsAttachment:</span>
<a href="#l17.7247"></a><span id="l17.7247">       isQuoted = false;</span>
<a href="#l17.7248"></a><span id="l17.7248">       break;</span>
<a href="#l17.7249"></a><span id="l17.7249" class="difflineminus">-    default :</span>
<a href="#l17.7250"></a><span id="l17.7250" class="difflineplus">+    default:</span>
<a href="#l17.7251"></a><span id="l17.7251">       isQuoted = true;</span>
<a href="#l17.7252"></a><span id="l17.7252">       break;</span>
<a href="#l17.7253"></a><span id="l17.7253">   }</span>
<a href="#l17.7254"></a><span id="l17.7254"> </span>
<a href="#l17.7255"></a><span id="l17.7255">   ProcessSignature(aIdentity, isQuoted, &amp;aSignature);</span>
<a href="#l17.7256"></a><span id="l17.7256"> </span>
<a href="#l17.7257"></a><span id="l17.7257" class="difflineminus">-  if (!aSignature.IsEmpty())</span>
<a href="#l17.7258"></a><span id="l17.7258" class="difflineminus">-  {</span>
<a href="#l17.7259"></a><span id="l17.7259" class="difflineplus">+  if (!aSignature.IsEmpty()) {</span>
<a href="#l17.7260"></a><span id="l17.7260">     TranslateLineEnding(aSignature);</span>
<a href="#l17.7261"></a><span id="l17.7261">     nsCOMPtr&lt;nsIEditor&gt; editor(m_editor);  // Strong reference.</span>
<a href="#l17.7262"></a><span id="l17.7262"> </span>
<a href="#l17.7263"></a><span id="l17.7263">     editor-&gt;BeginTransaction();</span>
<a href="#l17.7264"></a><span id="l17.7264">     int32_t reply_on_top = 0;</span>
<a href="#l17.7265"></a><span id="l17.7265">     bool sig_bottom = true;</span>
<a href="#l17.7266"></a><span id="l17.7266">     aIdentity-&gt;GetReplyOnTop(&amp;reply_on_top);</span>
<a href="#l17.7267"></a><span id="l17.7267">     aIdentity-&gt;GetSigBottom(&amp;sig_bottom);</span>
<a href="#l17.7268"></a><span id="l17.7268" class="difflineat">@@ -5888,54 +5382,52 @@ nsMsgCompose::SetIdentity(nsIMsgIdentity</span>
<a href="#l17.7269"></a><span id="l17.7269">       rv = MoveToAboveQuote();</span>
<a href="#l17.7270"></a><span id="l17.7270">     } else {</span>
<a href="#l17.7271"></a><span id="l17.7271">       // Note: New messages aren't quoted so we always move to the end.</span>
<a href="#l17.7272"></a><span id="l17.7272">       rv = MoveToEndOfDocument();</span>
<a href="#l17.7273"></a><span id="l17.7273">     }</span>
<a href="#l17.7274"></a><span id="l17.7274"> </span>
<a href="#l17.7275"></a><span id="l17.7275">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l17.7276"></a><span id="l17.7276">       if (m_composeHTML) {</span>
<a href="#l17.7277"></a><span id="l17.7277" class="difflineminus">-        nsCOMPtr&lt;nsIHTMLEditor&gt; htmlEditor (do_QueryInterface(editor));</span>
<a href="#l17.7278"></a><span id="l17.7278" class="difflineplus">+        nsCOMPtr&lt;nsIHTMLEditor&gt; htmlEditor(do_QueryInterface(editor));</span>
<a href="#l17.7279"></a><span id="l17.7279">         rv = htmlEditor-&gt;InsertHTML(aSignature);</span>
<a href="#l17.7280"></a><span id="l17.7280">       } else {</span>
<a href="#l17.7281"></a><span id="l17.7281" class="difflineminus">-        nsCOMPtr&lt;nsIPlaintextEditor&gt; textEditor (do_QueryInterface(editor));</span>
<a href="#l17.7282"></a><span id="l17.7282" class="difflineplus">+        nsCOMPtr&lt;nsIPlaintextEditor&gt; textEditor(do_QueryInterface(editor));</span>
<a href="#l17.7283"></a><span id="l17.7283">         rv = textEditor-&gt;InsertLineBreak();</span>
<a href="#l17.7284"></a><span id="l17.7284" class="difflineminus">-        InsertDivWrappedTextAtSelection(aSignature, NS_LITERAL_STRING(&quot;moz-signature&quot;));</span>
<a href="#l17.7285"></a><span id="l17.7285" class="difflineplus">+        InsertDivWrappedTextAtSelection(aSignature,</span>
<a href="#l17.7286"></a><span id="l17.7286" class="difflineplus">+                                        NS_LITERAL_STRING(&quot;moz-signature&quot;));</span>
<a href="#l17.7287"></a><span id="l17.7287">       }</span>
<a href="#l17.7288"></a><span id="l17.7288">     }</span>
<a href="#l17.7289"></a><span id="l17.7289">     editor-&gt;EndTransaction();</span>
<a href="#l17.7290"></a><span id="l17.7290">   }</span>
<a href="#l17.7291"></a><span id="l17.7291"> </span>
<a href="#l17.7292"></a><span id="l17.7292">   return rv;</span>
<a href="#l17.7293"></a><span id="l17.7293"> }</span>
<a href="#l17.7294"></a><span id="l17.7294"> </span>
<a href="#l17.7295"></a><span id="l17.7295" class="difflineminus">-NS_IMETHODIMP nsMsgCompose::CheckCharsetConversion(nsIMsgIdentity *identity, char **fallbackCharset, bool *_retval)</span>
<a href="#l17.7296"></a><span id="l17.7296" class="difflineminus">-{</span>
<a href="#l17.7297"></a><span id="l17.7297" class="difflineplus">+NS_IMETHODIMP nsMsgCompose::CheckCharsetConversion(nsIMsgIdentity *identity,</span>
<a href="#l17.7298"></a><span id="l17.7298" class="difflineplus">+                                                   char **fallbackCharset,</span>
<a href="#l17.7299"></a><span id="l17.7299" class="difflineplus">+                                                   bool *_retval) {</span>
<a href="#l17.7300"></a><span id="l17.7300">   NS_ENSURE_ARG_POINTER(identity);</span>
<a href="#l17.7301"></a><span id="l17.7301">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l17.7302"></a><span id="l17.7302"> </span>
<a href="#l17.7303"></a><span id="l17.7303">   // Kept around for legacy reasons. This method is supposed to check that the</span>
<a href="#l17.7304"></a><span id="l17.7304">   // headers can be converted to the appropriate charset, but we don't support</span>
<a href="#l17.7305"></a><span id="l17.7305">   // encoding headers to non-UTF-8, so this is now moot.</span>
<a href="#l17.7306"></a><span id="l17.7306" class="difflineminus">-  if (fallbackCharset)</span>
<a href="#l17.7307"></a><span id="l17.7307" class="difflineminus">-    *fallbackCharset = nullptr;</span>
<a href="#l17.7308"></a><span id="l17.7308" class="difflineplus">+  if (fallbackCharset) *fallbackCharset = nullptr;</span>
<a href="#l17.7309"></a><span id="l17.7309">   *_retval = true;</span>
<a href="#l17.7310"></a><span id="l17.7310">   return NS_OK;</span>
<a href="#l17.7311"></a><span id="l17.7311"> }</span>
<a href="#l17.7312"></a><span id="l17.7312"> </span>
<a href="#l17.7313"></a><span id="l17.7313" class="difflineminus">-NS_IMETHODIMP nsMsgCompose::GetDeliverMode(MSG_DeliverMode* aDeliverMode)</span>
<a href="#l17.7314"></a><span id="l17.7314" class="difflineminus">-{</span>
<a href="#l17.7315"></a><span id="l17.7315" class="difflineplus">+NS_IMETHODIMP nsMsgCompose::GetDeliverMode(MSG_DeliverMode *aDeliverMode) {</span>
<a href="#l17.7316"></a><span id="l17.7316">   NS_ENSURE_ARG_POINTER(aDeliverMode);</span>
<a href="#l17.7317"></a><span id="l17.7317">   *aDeliverMode = mDeliverMode;</span>
<a href="#l17.7318"></a><span id="l17.7318">   return NS_OK;</span>
<a href="#l17.7319"></a><span id="l17.7319"> }</span>
<a href="#l17.7320"></a><span id="l17.7320"> </span>
<a href="#l17.7321"></a><span id="l17.7321" class="difflineminus">-nsMsgMailList::nsMsgMailList(nsIAbDirectory* directory) :</span>
<a href="#l17.7322"></a><span id="l17.7322" class="difflineminus">-  mDirectory(directory)</span>
<a href="#l17.7323"></a><span id="l17.7323" class="difflineminus">-{</span>
<a href="#l17.7324"></a><span id="l17.7324" class="difflineplus">+nsMsgMailList::nsMsgMailList(nsIAbDirectory *directory)</span>
<a href="#l17.7325"></a><span id="l17.7325" class="difflineplus">+    : mDirectory(directory) {</span>
<a href="#l17.7326"></a><span id="l17.7326">   mDirectory-&gt;GetDirName(mName);</span>
<a href="#l17.7327"></a><span id="l17.7327">   mDirectory-&gt;GetDescription(mDescription);</span>
<a href="#l17.7328"></a><span id="l17.7328"> </span>
<a href="#l17.7329"></a><span id="l17.7329" class="difflineminus">-  if (mDescription.IsEmpty())</span>
<a href="#l17.7330"></a><span id="l17.7330" class="difflineminus">-    mDescription = mName;</span>
<a href="#l17.7331"></a><span id="l17.7331" class="difflineplus">+  if (mDescription.IsEmpty()) mDescription = mName;</span>
<a href="#l17.7332"></a><span id="l17.7332"> </span>
<a href="#l17.7333"></a><span id="l17.7333">   mDirectory = directory;</span>
<a href="#l17.7334"></a><span id="l17.7334"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompose.h</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompose.h</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -24,74 +24,71 @@</span>
<a href="#l18.4"></a><span id="l18.4"> </span>
<a href="#l18.5"></a><span id="l18.5"> // Forward declares</span>
<a href="#l18.6"></a><span id="l18.6"> class QuotingOutputStreamListener;</span>
<a href="#l18.7"></a><span id="l18.7"> class nsMsgComposeSendListener;</span>
<a href="#l18.8"></a><span id="l18.8"> class nsIEditor;</span>
<a href="#l18.9"></a><span id="l18.9"> class nsIArray;</span>
<a href="#l18.10"></a><span id="l18.10"> struct nsMsgMailList;</span>
<a href="#l18.11"></a><span id="l18.11"> </span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-class nsMsgCompose : public nsIMsgCompose, public nsSupportsWeakReference</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-{</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+class nsMsgCompose : public nsIMsgCompose, public nsSupportsWeakReference {</span>
<a href="#l18.15"></a><span id="l18.15">  public:</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineminus">-</span>
<a href="#l18.17"></a><span id="l18.17">   nsMsgCompose();</span>
<a href="#l18.18"></a><span id="l18.18"> </span>
<a href="#l18.19"></a><span id="l18.19">   /* this macro defines QueryInterface, AddRef and Release for this class */</span>
<a href="#l18.20"></a><span id="l18.20">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l18.21"></a><span id="l18.21"> </span>
<a href="#l18.22"></a><span id="l18.22">   /*** nsIMsgCompose pure virtual functions */</span>
<a href="#l18.23"></a><span id="l18.23">   NS_DECL_NSIMSGCOMPOSE</span>
<a href="#l18.24"></a><span id="l18.24"> </span>
<a href="#l18.25"></a><span id="l18.25">   /* nsIMsgSendListener interface */</span>
<a href="#l18.26"></a><span id="l18.26">   NS_DECL_NSIMSGSENDLISTENER</span>
<a href="#l18.27"></a><span id="l18.27"> </span>
<a href="#l18.28"></a><span id="l18.28" class="difflineminus">-protected:</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineplus">+ protected:</span>
<a href="#l18.30"></a><span id="l18.30">   virtual ~nsMsgCompose();</span>
<a href="#l18.31"></a><span id="l18.31"> </span>
<a href="#l18.32"></a><span id="l18.32" class="difflineminus">- // Deal with quoting issues...</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineminus">-  nsresult                      QuoteOriginalMessage(); // New template</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineminus">-  nsresult                      SetQuotingToFollow(bool aVal);</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineminus">-  nsresult                      ConvertHTMLToText(nsIFile *aSigFile, nsString &amp;aSigData);</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineminus">-  nsresult                      ConvertTextToHTML(nsIFile *aSigFile, nsString &amp;aSigData);</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineminus">-  bool                          IsEmbeddedObjectSafe(const char * originalScheme,</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineminus">-                                                     const char * originalHost,</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineminus">-                                                     const char * originalPath,</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineminus">-                                                     mozilla::dom::Element * element);</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineminus">-  nsresult                      ResetUrisForEmbeddedObjects();</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineminus">-  nsresult                      TagEmbeddedObjects(nsIEditor *aEditor);</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineplus">+  // Deal with quoting issues...</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineplus">+  nsresult QuoteOriginalMessage();  // New template</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineplus">+  nsresult SetQuotingToFollow(bool aVal);</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineplus">+  nsresult ConvertHTMLToText(nsIFile *aSigFile, nsString &amp;aSigData);</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineplus">+  nsresult ConvertTextToHTML(nsIFile *aSigFile, nsString &amp;aSigData);</span>
<a href="#l18.48"></a><span id="l18.48" class="difflineplus">+  bool IsEmbeddedObjectSafe(const char *originalScheme,</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineplus">+                            const char *originalHost, const char *originalPath,</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineplus">+                            mozilla::dom::Element *element);</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineplus">+  nsresult ResetUrisForEmbeddedObjects();</span>
<a href="#l18.52"></a><span id="l18.52" class="difflineplus">+  nsresult TagEmbeddedObjects(nsIEditor *aEditor);</span>
<a href="#l18.53"></a><span id="l18.53"> </span>
<a href="#l18.54"></a><span id="l18.54" class="difflineminus">-  nsCString                     mQuoteCharset;</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineminus">-  nsCString                     mOriginalMsgURI; // used so we can mark message disposition flags after we send the message</span>
<a href="#l18.56"></a><span id="l18.56" class="difflineplus">+  nsCString mQuoteCharset;</span>
<a href="#l18.57"></a><span id="l18.57" class="difflineplus">+  nsCString mOriginalMsgURI;  // used so we can mark message disposition flags</span>
<a href="#l18.58"></a><span id="l18.58" class="difflineplus">+                              // after we send the message</span>
<a href="#l18.59"></a><span id="l18.59"> </span>
<a href="#l18.60"></a><span id="l18.60" class="difflineminus">-  int32_t                       mWhatHolder;</span>
<a href="#l18.61"></a><span id="l18.61" class="difflineplus">+  int32_t mWhatHolder;</span>
<a href="#l18.62"></a><span id="l18.62"> </span>
<a href="#l18.63"></a><span id="l18.63" class="difflineminus">-  nsresult                      LoadDataFromFile(nsIFile *file,</span>
<a href="#l18.64"></a><span id="l18.64" class="difflineminus">-                                                 nsString &amp;sigData,</span>
<a href="#l18.65"></a><span id="l18.65" class="difflineminus">-                                                 bool aAllowUTF8 = true,</span>
<a href="#l18.66"></a><span id="l18.66" class="difflineminus">-                                                 bool aAllowUTF16 = true);</span>
<a href="#l18.67"></a><span id="l18.67" class="difflineplus">+  nsresult LoadDataFromFile(nsIFile *file, nsString &amp;sigData,</span>
<a href="#l18.68"></a><span id="l18.68" class="difflineplus">+                            bool aAllowUTF8 = true, bool aAllowUTF16 = true);</span>
<a href="#l18.69"></a><span id="l18.69"> </span>
<a href="#l18.70"></a><span id="l18.70" class="difflineminus">-  bool                          CheckIncludeSignaturePrefs(nsIMsgIdentity *identity);</span>
<a href="#l18.71"></a><span id="l18.71" class="difflineminus">-  //m_folderName to store the value of the saved drafts folder.</span>
<a href="#l18.72"></a><span id="l18.72" class="difflineminus">-  nsCString                     m_folderName;</span>
<a href="#l18.73"></a><span id="l18.73" class="difflineplus">+  bool CheckIncludeSignaturePrefs(nsIMsgIdentity *identity);</span>
<a href="#l18.74"></a><span id="l18.74" class="difflineplus">+  // m_folderName to store the value of the saved drafts folder.</span>
<a href="#l18.75"></a><span id="l18.75" class="difflineplus">+  nsCString m_folderName;</span>
<a href="#l18.76"></a><span id="l18.76">   void InsertDivWrappedTextAtSelection(const nsAString &amp;aText,</span>
<a href="#l18.77"></a><span id="l18.77">                                        const nsAString &amp;classStr);</span>
<a href="#l18.78"></a><span id="l18.78"> </span>
<a href="#l18.79"></a><span id="l18.79">  protected:</span>
<a href="#l18.80"></a><span id="l18.80" class="difflineminus">-  nsresult CreateMessage(const char * originalMsgURI, MSG_ComposeType type, nsIMsgCompFields* compFields);</span>
<a href="#l18.81"></a><span id="l18.81" class="difflineminus">-  void CleanUpRecipients(nsString&amp; recipients);</span>
<a href="#l18.82"></a><span id="l18.82" class="difflineminus">-  nsresult GetABDirAndMailLists(const nsACString&amp; aDirUri,</span>
<a href="#l18.83"></a><span id="l18.83" class="difflineminus">-                                nsCOMArray&lt;nsIAbDirectory&gt;&amp; aDirArray,</span>
<a href="#l18.84"></a><span id="l18.84" class="difflineminus">-                                nsTArray&lt;nsMsgMailList&gt;&amp; aMailListArray);</span>
<a href="#l18.85"></a><span id="l18.85" class="difflineminus">-  nsresult ResolveMailList(nsIAbDirectory* aMailList,</span>
<a href="#l18.86"></a><span id="l18.86" class="difflineminus">-                           nsCOMArray&lt;nsIAbDirectory&gt;&amp; allDirectoriesArray,</span>
<a href="#l18.87"></a><span id="l18.87" class="difflineminus">-                           nsTArray&lt;nsMsgMailList&gt;&amp; allMailListArray,</span>
<a href="#l18.88"></a><span id="l18.88" class="difflineminus">-                           nsTArray&lt;nsMsgMailList&gt;&amp; mailListResolved,</span>
<a href="#l18.89"></a><span id="l18.89" class="difflineminus">-                           nsTArray&lt;nsMsgRecipient&gt;&amp; aListMembers);</span>
<a href="#l18.90"></a><span id="l18.90" class="difflineminus">-  void TagConvertible(mozilla::dom::Element *node,  int32_t *_retval);</span>
<a href="#l18.91"></a><span id="l18.91" class="difflineplus">+  nsresult CreateMessage(const char *originalMsgURI, MSG_ComposeType type,</span>
<a href="#l18.92"></a><span id="l18.92" class="difflineplus">+                         nsIMsgCompFields *compFields);</span>
<a href="#l18.93"></a><span id="l18.93" class="difflineplus">+  void CleanUpRecipients(nsString &amp;recipients);</span>
<a href="#l18.94"></a><span id="l18.94" class="difflineplus">+  nsresult GetABDirAndMailLists(const nsACString &amp;aDirUri,</span>
<a href="#l18.95"></a><span id="l18.95" class="difflineplus">+                                nsCOMArray&lt;nsIAbDirectory&gt; &amp;aDirArray,</span>
<a href="#l18.96"></a><span id="l18.96" class="difflineplus">+                                nsTArray&lt;nsMsgMailList&gt; &amp;aMailListArray);</span>
<a href="#l18.97"></a><span id="l18.97" class="difflineplus">+  nsresult ResolveMailList(nsIAbDirectory *aMailList,</span>
<a href="#l18.98"></a><span id="l18.98" class="difflineplus">+                           nsCOMArray&lt;nsIAbDirectory&gt; &amp;allDirectoriesArray,</span>
<a href="#l18.99"></a><span id="l18.99" class="difflineplus">+                           nsTArray&lt;nsMsgMailList&gt; &amp;allMailListArray,</span>
<a href="#l18.100"></a><span id="l18.100" class="difflineplus">+                           nsTArray&lt;nsMsgMailList&gt; &amp;mailListResolved,</span>
<a href="#l18.101"></a><span id="l18.101" class="difflineplus">+                           nsTArray&lt;nsMsgRecipient&gt; &amp;aListMembers);</span>
<a href="#l18.102"></a><span id="l18.102" class="difflineplus">+  void TagConvertible(mozilla::dom::Element *node, int32_t *_retval);</span>
<a href="#l18.103"></a><span id="l18.103">   void _NodeTreeConvertible(mozilla::dom::Element *node, int32_t *_retval);</span>
<a href="#l18.104"></a><span id="l18.104">   nsresult MoveToAboveQuote(void);</span>
<a href="#l18.105"></a><span id="l18.105">   nsresult MoveToBeginningOfDocument(void);</span>
<a href="#l18.106"></a><span id="l18.106">   nsresult MoveToEndOfDocument(void);</span>
<a href="#l18.107"></a><span id="l18.107">   nsresult ReplaceFileURLs(nsString &amp;sigData);</span>
<a href="#l18.108"></a><span id="l18.108">   nsresult DataURLForFileURL(const nsAString &amp;aFileURL, nsAString &amp;aDataURL);</span>
<a href="#l18.109"></a><span id="l18.109"> </span>
<a href="#l18.110"></a><span id="l18.110"> // 3 = To, Cc, Bcc</span>
<a href="#l18.111"></a><span id="l18.111" class="difflineat">@@ -99,113 +96,110 @@ protected:</span>
<a href="#l18.112"></a><span id="l18.112">   typedef nsTArray&lt;nsMsgRecipient&gt; RecipientsArray[MAX_OF_RECIPIENT_ARRAY];</span>
<a href="#l18.113"></a><span id="l18.113">   /**</span>
<a href="#l18.114"></a><span id="l18.114">    * This method parses the compose fields and associates email addresses with</span>
<a href="#l18.115"></a><span id="l18.115">    * the relevant cards from the address books.</span>
<a href="#l18.116"></a><span id="l18.116">    */</span>
<a href="#l18.117"></a><span id="l18.117">   nsresult LookupAddressBook(RecipientsArray &amp;recipientList);</span>
<a href="#l18.118"></a><span id="l18.118">   bool IsLastWindow();</span>
<a href="#l18.119"></a><span id="l18.119"> </span>
<a href="#l18.120"></a><span id="l18.120" class="difflineminus">-       // Helper function. Parameters are not checked.</span>
<a href="#l18.121"></a><span id="l18.121" class="difflineminus">-  bool                                      mConvertStructs;    // for TagConvertible</span>
<a href="#l18.122"></a><span id="l18.122" class="difflineplus">+  // Helper function. Parameters are not checked.</span>
<a href="#l18.123"></a><span id="l18.123" class="difflineplus">+  bool mConvertStructs;  // for TagConvertible</span>
<a href="#l18.124"></a><span id="l18.124"> </span>
<a href="#l18.125"></a><span id="l18.125" class="difflineminus">-  nsCOMPtr&lt;nsIEditor&gt;                       m_editor;</span>
<a href="#l18.126"></a><span id="l18.126" class="difflineminus">-  mozIDOMWindowProxy                        *m_window;</span>
<a href="#l18.127"></a><span id="l18.127" class="difflineminus">-  nsCOMPtr&lt;nsIDocShell&gt;                     mDocShell;</span>
<a href="#l18.128"></a><span id="l18.128" class="difflineminus">-  nsCOMPtr&lt;nsIBaseWindow&gt;                   m_baseWindow;</span>
<a href="#l18.129"></a><span id="l18.129" class="difflineminus">-  RefPtr&lt;nsMsgCompFields&gt;                   m_compFields;</span>
<a href="#l18.130"></a><span id="l18.130" class="difflineminus">-  nsCOMPtr&lt;nsIMsgIdentity&gt;                  m_identity;</span>
<a href="#l18.131"></a><span id="l18.131" class="difflineminus">-  bool                                      m_composeHTML;</span>
<a href="#l18.132"></a><span id="l18.132" class="difflineminus">-  RefPtr&lt;QuotingOutputStreamListener&gt;       mQuoteStreamListener;</span>
<a href="#l18.133"></a><span id="l18.133" class="difflineminus">-  nsCOMPtr&lt;nsIOutputStream&gt;                 mBaseStream;</span>
<a href="#l18.134"></a><span id="l18.134" class="difflineplus">+  nsCOMPtr&lt;nsIEditor&gt; m_editor;</span>
<a href="#l18.135"></a><span id="l18.135" class="difflineplus">+  mozIDOMWindowProxy *m_window;</span>
<a href="#l18.136"></a><span id="l18.136" class="difflineplus">+  nsCOMPtr&lt;nsIDocShell&gt; mDocShell;</span>
<a href="#l18.137"></a><span id="l18.137" class="difflineplus">+  nsCOMPtr&lt;nsIBaseWindow&gt; m_baseWindow;</span>
<a href="#l18.138"></a><span id="l18.138" class="difflineplus">+  RefPtr&lt;nsMsgCompFields&gt; m_compFields;</span>
<a href="#l18.139"></a><span id="l18.139" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIdentity&gt; m_identity;</span>
<a href="#l18.140"></a><span id="l18.140" class="difflineplus">+  bool m_composeHTML;</span>
<a href="#l18.141"></a><span id="l18.141" class="difflineplus">+  RefPtr&lt;QuotingOutputStreamListener&gt; mQuoteStreamListener;</span>
<a href="#l18.142"></a><span id="l18.142" class="difflineplus">+  nsCOMPtr&lt;nsIOutputStream&gt; mBaseStream;</span>
<a href="#l18.143"></a><span id="l18.143"> </span>
<a href="#l18.144"></a><span id="l18.144" class="difflineminus">-  nsCOMPtr&lt;nsIMsgSend&gt;                      mMsgSend;           // for composition back end</span>
<a href="#l18.145"></a><span id="l18.145" class="difflineminus">-  nsCOMPtr&lt;nsIMsgProgress&gt;                  mProgress;          // use by the back end to report progress to the front end</span>
<a href="#l18.146"></a><span id="l18.146" class="difflineplus">+  nsCOMPtr&lt;nsIMsgSend&gt; mMsgSend;  // for composition back end</span>
<a href="#l18.147"></a><span id="l18.147" class="difflineplus">+  nsCOMPtr&lt;nsIMsgProgress&gt;</span>
<a href="#l18.148"></a><span id="l18.148" class="difflineplus">+      mProgress;  // use by the back end to report progress to the front end</span>
<a href="#l18.149"></a><span id="l18.149"> </span>
<a href="#l18.150"></a><span id="l18.150">   // Deal with quoting issues...</span>
<a href="#l18.151"></a><span id="l18.151" class="difflineminus">-  nsString                                  mCiteReference;</span>
<a href="#l18.152"></a><span id="l18.152" class="difflineminus">-  nsCOMPtr&lt;nsIMsgQuote&gt;                     mQuote;</span>
<a href="#l18.153"></a><span id="l18.153" class="difflineminus">-  bool                                      mQuotingToFollow;   // Quoting indicator</span>
<a href="#l18.154"></a><span id="l18.154" class="difflineminus">-  MSG_ComposeType                           mType;              // Message type</span>
<a href="#l18.155"></a><span id="l18.155" class="difflineminus">-  bool                                      mCharsetOverride;</span>
<a href="#l18.156"></a><span id="l18.156" class="difflineminus">-  bool                                      mAnswerDefaultCharset;</span>
<a href="#l18.157"></a><span id="l18.157" class="difflineminus">-  bool                                      mDeleteDraft;</span>
<a href="#l18.158"></a><span id="l18.158" class="difflineminus">-  nsMsgDispositionState                     mDraftDisposition;</span>
<a href="#l18.159"></a><span id="l18.159" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt;                    mOrigMsgHdr;</span>
<a href="#l18.160"></a><span id="l18.160" class="difflineplus">+  nsString mCiteReference;</span>
<a href="#l18.161"></a><span id="l18.161" class="difflineplus">+  nsCOMPtr&lt;nsIMsgQuote&gt; mQuote;</span>
<a href="#l18.162"></a><span id="l18.162" class="difflineplus">+  bool mQuotingToFollow;  // Quoting indicator</span>
<a href="#l18.163"></a><span id="l18.163" class="difflineplus">+  MSG_ComposeType mType;  // Message type</span>
<a href="#l18.164"></a><span id="l18.164" class="difflineplus">+  bool mCharsetOverride;</span>
<a href="#l18.165"></a><span id="l18.165" class="difflineplus">+  bool mAnswerDefaultCharset;</span>
<a href="#l18.166"></a><span id="l18.166" class="difflineplus">+  bool mDeleteDraft;</span>
<a href="#l18.167"></a><span id="l18.167" class="difflineplus">+  nsMsgDispositionState mDraftDisposition;</span>
<a href="#l18.168"></a><span id="l18.168" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; mOrigMsgHdr;</span>
<a href="#l18.169"></a><span id="l18.169"> </span>
<a href="#l18.170"></a><span id="l18.170" class="difflineminus">-  nsString                                  mSmtpPassword;</span>
<a href="#l18.171"></a><span id="l18.171" class="difflineminus">-  nsCString                                 mHtmlToQuote;</span>
<a href="#l18.172"></a><span id="l18.172" class="difflineplus">+  nsString mSmtpPassword;</span>
<a href="#l18.173"></a><span id="l18.173" class="difflineplus">+  nsCString mHtmlToQuote;</span>
<a href="#l18.174"></a><span id="l18.174"> </span>
<a href="#l18.175"></a><span id="l18.175">   nsTObserverArray&lt;nsCOMPtr&lt;nsIMsgComposeStateListener&gt; &gt; mStateListeners;</span>
<a href="#l18.176"></a><span id="l18.176">   nsTObserverArray&lt;nsCOMPtr&lt;nsIMsgSendListener&gt; &gt; mExternalSendListeners;</span>
<a href="#l18.177"></a><span id="l18.177"> </span>
<a href="#l18.178"></a><span id="l18.178" class="difflineminus">-  bool                                      mInsertingQuotedContent;</span>
<a href="#l18.179"></a><span id="l18.179" class="difflineminus">-  MSG_DeliverMode                           mDeliverMode;  // nsIMsgCompDeliverMode long.</span>
<a href="#l18.180"></a><span id="l18.180" class="difflineplus">+  bool mInsertingQuotedContent;</span>
<a href="#l18.181"></a><span id="l18.181" class="difflineplus">+  MSG_DeliverMode mDeliverMode;  // nsIMsgCompDeliverMode long.</span>
<a href="#l18.182"></a><span id="l18.182"> </span>
<a href="#l18.183"></a><span id="l18.183">   friend class QuotingOutputStreamListener;</span>
<a href="#l18.184"></a><span id="l18.184">   friend class nsMsgComposeSendListener;</span>
<a href="#l18.185"></a><span id="l18.185"> };</span>
<a href="#l18.186"></a><span id="l18.186"> </span>
<a href="#l18.187"></a><span id="l18.187"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l18.188"></a><span id="l18.188"> // THIS IS THE CLASS THAT IS THE STREAM Listener OF THE HTML OUTPUT</span>
<a href="#l18.189"></a><span id="l18.189"> // FROM LIBMIME. THIS IS FOR QUOTING</span>
<a href="#l18.190"></a><span id="l18.190"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l18.191"></a><span id="l18.191" class="difflineminus">-class QuotingOutputStreamListener : public nsIMsgQuotingOutputStreamListener</span>
<a href="#l18.192"></a><span id="l18.192" class="difflineminus">-{</span>
<a href="#l18.193"></a><span id="l18.193" class="difflineminus">-public:</span>
<a href="#l18.194"></a><span id="l18.194" class="difflineminus">-    QuotingOutputStreamListener(const char *originalMsgURI,</span>
<a href="#l18.195"></a><span id="l18.195" class="difflineminus">-                                nsIMsgDBHdr *origMsgHdr,</span>
<a href="#l18.196"></a><span id="l18.196" class="difflineminus">-                                bool quoteHeaders,</span>
<a href="#l18.197"></a><span id="l18.197" class="difflineminus">-                                bool headersOnly,</span>
<a href="#l18.198"></a><span id="l18.198" class="difflineminus">-                                nsIMsgIdentity *identity,</span>
<a href="#l18.199"></a><span id="l18.199" class="difflineminus">-                                nsIMsgQuote* msgQuote,</span>
<a href="#l18.200"></a><span id="l18.200" class="difflineminus">-                                bool charsetFixed,</span>
<a href="#l18.201"></a><span id="l18.201" class="difflineminus">-                                bool quoteOriginal,</span>
<a href="#l18.202"></a><span id="l18.202" class="difflineminus">-                                const nsACString&amp; htmlToQuote);</span>
<a href="#l18.203"></a><span id="l18.203" class="difflineplus">+class QuotingOutputStreamListener : public nsIMsgQuotingOutputStreamListener {</span>
<a href="#l18.204"></a><span id="l18.204" class="difflineplus">+ public:</span>
<a href="#l18.205"></a><span id="l18.205" class="difflineplus">+  QuotingOutputStreamListener(const char *originalMsgURI,</span>
<a href="#l18.206"></a><span id="l18.206" class="difflineplus">+                              nsIMsgDBHdr *origMsgHdr, bool quoteHeaders,</span>
<a href="#l18.207"></a><span id="l18.207" class="difflineplus">+                              bool headersOnly, nsIMsgIdentity *identity,</span>
<a href="#l18.208"></a><span id="l18.208" class="difflineplus">+                              nsIMsgQuote *msgQuote, bool charsetFixed,</span>
<a href="#l18.209"></a><span id="l18.209" class="difflineplus">+                              bool quoteOriginal,</span>
<a href="#l18.210"></a><span id="l18.210" class="difflineplus">+                              const nsACString &amp;htmlToQuote);</span>
<a href="#l18.211"></a><span id="l18.211"> </span>
<a href="#l18.212"></a><span id="l18.212" class="difflineminus">-    NS_DECL_ISUPPORTS</span>
<a href="#l18.213"></a><span id="l18.213" class="difflineminus">-    NS_DECL_NSIREQUESTOBSERVER</span>
<a href="#l18.214"></a><span id="l18.214" class="difflineminus">-    NS_DECL_NSISTREAMLISTENER</span>
<a href="#l18.215"></a><span id="l18.215" class="difflineminus">-    NS_DECL_NSIMSGQUOTINGOUTPUTSTREAMLISTENER</span>
<a href="#l18.216"></a><span id="l18.216" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l18.217"></a><span id="l18.217" class="difflineplus">+  NS_DECL_NSIREQUESTOBSERVER</span>
<a href="#l18.218"></a><span id="l18.218" class="difflineplus">+  NS_DECL_NSISTREAMLISTENER</span>
<a href="#l18.219"></a><span id="l18.219" class="difflineplus">+  NS_DECL_NSIMSGQUOTINGOUTPUTSTREAMLISTENER</span>
<a href="#l18.220"></a><span id="l18.220"> </span>
<a href="#l18.221"></a><span id="l18.221" class="difflineminus">-    nsresult SetComposeObj(nsIMsgCompose *obj);</span>
<a href="#l18.222"></a><span id="l18.222" class="difflineminus">-    nsresult ConvertToPlainText(bool formatflowed,</span>
<a href="#l18.223"></a><span id="l18.223" class="difflineminus">-                                bool delsp,</span>
<a href="#l18.224"></a><span id="l18.224" class="difflineminus">-                                bool formatted,</span>
<a href="#l18.225"></a><span id="l18.225" class="difflineminus">-                                bool disallowBreaks);</span>
<a href="#l18.226"></a><span id="l18.226" class="difflineminus">-    nsresult InsertToCompose(nsIEditor *aEditor, bool aHTMLEditor);</span>
<a href="#l18.227"></a><span id="l18.227" class="difflineminus">-    nsresult AppendToMsgBody(const nsCString &amp;inStr);</span>
<a href="#l18.228"></a><span id="l18.228" class="difflineplus">+  nsresult SetComposeObj(nsIMsgCompose *obj);</span>
<a href="#l18.229"></a><span id="l18.229" class="difflineplus">+  nsresult ConvertToPlainText(bool formatflowed, bool delsp, bool formatted,</span>
<a href="#l18.230"></a><span id="l18.230" class="difflineplus">+                              bool disallowBreaks);</span>
<a href="#l18.231"></a><span id="l18.231" class="difflineplus">+  nsresult InsertToCompose(nsIEditor *aEditor, bool aHTMLEditor);</span>
<a href="#l18.232"></a><span id="l18.232" class="difflineplus">+  nsresult AppendToMsgBody(const nsCString &amp;inStr);</span>
<a href="#l18.233"></a><span id="l18.233"> </span>
<a href="#l18.234"></a><span id="l18.234" class="difflineminus">-private:</span>
<a href="#l18.235"></a><span id="l18.235" class="difflineminus">-    virtual ~QuotingOutputStreamListener();</span>
<a href="#l18.236"></a><span id="l18.236" class="difflineminus">-    nsWeakPtr                   mWeakComposeObj;</span>
<a href="#l18.237"></a><span id="l18.237" class="difflineminus">-    nsString                    mMsgBody;</span>
<a href="#l18.238"></a><span id="l18.238" class="difflineminus">-    nsString                    mCitePrefix;</span>
<a href="#l18.239"></a><span id="l18.239" class="difflineminus">-    nsString                    mSignature;</span>
<a href="#l18.240"></a><span id="l18.240" class="difflineminus">-    bool                        mQuoteHeaders;</span>
<a href="#l18.241"></a><span id="l18.241" class="difflineminus">-    bool                        mHeadersOnly;</span>
<a href="#l18.242"></a><span id="l18.242" class="difflineminus">-    bool                        mCharsetFixed;</span>
<a href="#l18.243"></a><span id="l18.243" class="difflineminus">-    nsCOMPtr&lt;nsIMsgQuote&gt;       mQuote;</span>
<a href="#l18.244"></a><span id="l18.244" class="difflineminus">-    nsCOMPtr&lt;nsIMimeHeaders&gt;    mHeaders;</span>
<a href="#l18.245"></a><span id="l18.245" class="difflineminus">-    nsCOMPtr&lt;nsIMsgIdentity&gt;    mIdentity;</span>
<a href="#l18.246"></a><span id="l18.246" class="difflineminus">-    nsCOMPtr&lt;nsIMsgDBHdr&gt;       mOrigMsgHdr;</span>
<a href="#l18.247"></a><span id="l18.247" class="difflineminus">-    nsString                    mCiteReference;</span>
<a href="#l18.248"></a><span id="l18.248" class="difflineminus">-    nsCOMPtr&lt;nsIMimeConverter&gt;  mMimeConverter;</span>
<a href="#l18.249"></a><span id="l18.249" class="difflineminus">-    int32_t                     mUnicodeBufferCharacterLength;</span>
<a href="#l18.250"></a><span id="l18.250" class="difflineminus">-    bool                        mQuoteOriginal;</span>
<a href="#l18.251"></a><span id="l18.251" class="difflineminus">-    nsCString                   mHtmlToQuote;</span>
<a href="#l18.252"></a><span id="l18.252" class="difflineplus">+ private:</span>
<a href="#l18.253"></a><span id="l18.253" class="difflineplus">+  virtual ~QuotingOutputStreamListener();</span>
<a href="#l18.254"></a><span id="l18.254" class="difflineplus">+  nsWeakPtr mWeakComposeObj;</span>
<a href="#l18.255"></a><span id="l18.255" class="difflineplus">+  nsString mMsgBody;</span>
<a href="#l18.256"></a><span id="l18.256" class="difflineplus">+  nsString mCitePrefix;</span>
<a href="#l18.257"></a><span id="l18.257" class="difflineplus">+  nsString mSignature;</span>
<a href="#l18.258"></a><span id="l18.258" class="difflineplus">+  bool mQuoteHeaders;</span>
<a href="#l18.259"></a><span id="l18.259" class="difflineplus">+  bool mHeadersOnly;</span>
<a href="#l18.260"></a><span id="l18.260" class="difflineplus">+  bool mCharsetFixed;</span>
<a href="#l18.261"></a><span id="l18.261" class="difflineplus">+  nsCOMPtr&lt;nsIMsgQuote&gt; mQuote;</span>
<a href="#l18.262"></a><span id="l18.262" class="difflineplus">+  nsCOMPtr&lt;nsIMimeHeaders&gt; mHeaders;</span>
<a href="#l18.263"></a><span id="l18.263" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIdentity&gt; mIdentity;</span>
<a href="#l18.264"></a><span id="l18.264" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; mOrigMsgHdr;</span>
<a href="#l18.265"></a><span id="l18.265" class="difflineplus">+  nsString mCiteReference;</span>
<a href="#l18.266"></a><span id="l18.266" class="difflineplus">+  nsCOMPtr&lt;nsIMimeConverter&gt; mMimeConverter;</span>
<a href="#l18.267"></a><span id="l18.267" class="difflineplus">+  int32_t mUnicodeBufferCharacterLength;</span>
<a href="#l18.268"></a><span id="l18.268" class="difflineplus">+  bool mQuoteOriginal;</span>
<a href="#l18.269"></a><span id="l18.269" class="difflineplus">+  nsCString mHtmlToQuote;</span>
<a href="#l18.270"></a><span id="l18.270"> };</span>
<a href="#l18.271"></a><span id="l18.271"> </span>
<a href="#l18.272"></a><span id="l18.272"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l18.273"></a><span id="l18.273" class="difflineminus">-// This is the listener class for the send operation. We have to create this class</span>
<a href="#l18.274"></a><span id="l18.274" class="difflineminus">-// to listen for message send completion and eventually notify the caller</span>
<a href="#l18.275"></a><span id="l18.275" class="difflineplus">+// This is the listener class for the send operation. We have to create this</span>
<a href="#l18.276"></a><span id="l18.276" class="difflineplus">+// class to listen for message send completion and eventually notify the caller</span>
<a href="#l18.277"></a><span id="l18.277"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l18.278"></a><span id="l18.278" class="difflineminus">-class nsMsgComposeSendListener : public nsIMsgComposeSendListener, public nsIMsgSendListener, public nsIMsgCopyServiceListener, public nsIWebProgressListener</span>
<a href="#l18.279"></a><span id="l18.279" class="difflineminus">-{</span>
<a href="#l18.280"></a><span id="l18.280" class="difflineminus">-public:</span>
<a href="#l18.281"></a><span id="l18.281" class="difflineplus">+class nsMsgComposeSendListener : public nsIMsgComposeSendListener,</span>
<a href="#l18.282"></a><span id="l18.282" class="difflineplus">+                                 public nsIMsgSendListener,</span>
<a href="#l18.283"></a><span id="l18.283" class="difflineplus">+                                 public nsIMsgCopyServiceListener,</span>
<a href="#l18.284"></a><span id="l18.284" class="difflineplus">+                                 public nsIWebProgressListener {</span>
<a href="#l18.285"></a><span id="l18.285" class="difflineplus">+ public:</span>
<a href="#l18.286"></a><span id="l18.286">   nsMsgComposeSendListener(void);</span>
<a href="#l18.287"></a><span id="l18.287"> </span>
<a href="#l18.288"></a><span id="l18.288">   // nsISupports interface</span>
<a href="#l18.289"></a><span id="l18.289">   NS_DECL_ISUPPORTS</span>
<a href="#l18.290"></a><span id="l18.290"> </span>
<a href="#l18.291"></a><span id="l18.291">   // nsIMsgComposeSendListener interface</span>
<a href="#l18.292"></a><span id="l18.292">   NS_DECL_NSIMSGCOMPOSESENDLISTENER</span>
<a href="#l18.293"></a><span id="l18.293"> </span>
<a href="#l18.294"></a><span id="l18.294" class="difflineat">@@ -213,31 +207,32 @@ public:</span>
<a href="#l18.295"></a><span id="l18.295">   NS_DECL_NSIMSGSENDLISTENER</span>
<a href="#l18.296"></a><span id="l18.296"> </span>
<a href="#l18.297"></a><span id="l18.297">   // nsIMsgCopyServiceListener interface</span>
<a href="#l18.298"></a><span id="l18.298">   NS_DECL_NSIMSGCOPYSERVICELISTENER</span>
<a href="#l18.299"></a><span id="l18.299"> </span>
<a href="#l18.300"></a><span id="l18.300">   // nsIWebProgressListener interface</span>
<a href="#l18.301"></a><span id="l18.301">   NS_DECL_NSIWEBPROGRESSLISTENER</span>
<a href="#l18.302"></a><span id="l18.302"> </span>
<a href="#l18.303"></a><span id="l18.303" class="difflineminus">-  nsresult    RemoveDraftOrTemplate(nsIMsgCompose *compObj, nsCString msgURI, bool isSaveTemplate);</span>
<a href="#l18.304"></a><span id="l18.304" class="difflineminus">-  nsresult    RemoveCurrentDraftMessage(nsIMsgCompose *compObj, bool calledByCopy, bool isSaveTemplate);</span>
<a href="#l18.305"></a><span id="l18.305" class="difflineminus">-  nsresult    GetMsgFolder(nsIMsgCompose *compObj, nsIMsgFolder **msgFolder);</span>
<a href="#l18.306"></a><span id="l18.306" class="difflineplus">+  nsresult RemoveDraftOrTemplate(nsIMsgCompose *compObj, nsCString msgURI,</span>
<a href="#l18.307"></a><span id="l18.307" class="difflineplus">+                                 bool isSaveTemplate);</span>
<a href="#l18.308"></a><span id="l18.308" class="difflineplus">+  nsresult RemoveCurrentDraftMessage(nsIMsgCompose *compObj, bool calledByCopy,</span>
<a href="#l18.309"></a><span id="l18.309" class="difflineplus">+                                     bool isSaveTemplate);</span>
<a href="#l18.310"></a><span id="l18.310" class="difflineplus">+  nsresult GetMsgFolder(nsIMsgCompose *compObj, nsIMsgFolder **msgFolder);</span>
<a href="#l18.311"></a><span id="l18.311"> </span>
<a href="#l18.312"></a><span id="l18.312" class="difflineminus">-private:</span>
<a href="#l18.313"></a><span id="l18.313" class="difflineplus">+ private:</span>
<a href="#l18.314"></a><span id="l18.314">   virtual ~nsMsgComposeSendListener();</span>
<a href="#l18.315"></a><span id="l18.315" class="difflineminus">-  nsWeakPtr               mWeakComposeObj;</span>
<a href="#l18.316"></a><span id="l18.316" class="difflineminus">-  MSG_DeliverMode         mDeliverMode;</span>
<a href="#l18.317"></a><span id="l18.317" class="difflineplus">+  nsWeakPtr mWeakComposeObj;</span>
<a href="#l18.318"></a><span id="l18.318" class="difflineplus">+  MSG_DeliverMode mDeliverMode;</span>
<a href="#l18.319"></a><span id="l18.319"> };</span>
<a href="#l18.320"></a><span id="l18.320"> </span>
<a href="#l18.321"></a><span id="l18.321"> /******************************************************************************</span>
<a href="#l18.322"></a><span id="l18.322">  * nsMsgMailList</span>
<a href="#l18.323"></a><span id="l18.323">  ******************************************************************************/</span>
<a href="#l18.324"></a><span id="l18.324" class="difflineminus">-struct nsMsgMailList</span>
<a href="#l18.325"></a><span id="l18.325" class="difflineminus">-{</span>
<a href="#l18.326"></a><span id="l18.326" class="difflineminus">-  explicit nsMsgMailList(nsIAbDirectory* directory);</span>
<a href="#l18.327"></a><span id="l18.327" class="difflineplus">+struct nsMsgMailList {</span>
<a href="#l18.328"></a><span id="l18.328" class="difflineplus">+  explicit nsMsgMailList(nsIAbDirectory *directory);</span>
<a href="#l18.329"></a><span id="l18.329"> </span>
<a href="#l18.330"></a><span id="l18.330">   nsString mName;</span>
<a href="#l18.331"></a><span id="l18.331">   nsString mDescription;</span>
<a href="#l18.332"></a><span id="l18.332">   nsCOMPtr&lt;nsIAbDirectory&gt; mDirectory;</span>
<a href="#l18.333"></a><span id="l18.333"> };</span>
<a href="#l18.334"></a><span id="l18.334"> </span>
<a href="#l18.335"></a><span id="l18.335"> #endif /* _nsMsgCompose_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgComposeContentHandler.cpp</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgComposeContentHandler.cpp</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -20,103 +20,94 @@</span>
<a href="#l19.4"></a><span id="l19.4"> #include &quot;nsIMsgMailNewsUrl.h&quot;</span>
<a href="#l19.5"></a><span id="l19.5"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l19.6"></a><span id="l19.6"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l19.7"></a><span id="l19.7"> #include &quot;nsIMsgIncomingServer.h&quot;</span>
<a href="#l19.8"></a><span id="l19.8"> #include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l19.9"></a><span id="l19.9"> </span>
<a href="#l19.10"></a><span id="l19.10"> static NS_DEFINE_CID(kMsgComposeServiceCID, NS_MSGCOMPOSESERVICE_CID);</span>
<a href="#l19.11"></a><span id="l19.11"> </span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-nsMsgComposeContentHandler::nsMsgComposeContentHandler()</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-{</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineminus">-}</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineplus">+nsMsgComposeContentHandler::nsMsgComposeContentHandler() {}</span>
<a href="#l19.16"></a><span id="l19.16"> </span>
<a href="#l19.17"></a><span id="l19.17"> // The following macro actually implement addref, release and query interface</span>
<a href="#l19.18"></a><span id="l19.18"> // for our component.</span>
<a href="#l19.19"></a><span id="l19.19"> NS_IMPL_ISUPPORTS(nsMsgComposeContentHandler, nsIContentHandler)</span>
<a href="#l19.20"></a><span id="l19.20"> </span>
<a href="#l19.21"></a><span id="l19.21" class="difflineminus">-nsMsgComposeContentHandler::~nsMsgComposeContentHandler()</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineminus">-{</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineminus">-}</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineplus">+nsMsgComposeContentHandler::~nsMsgComposeContentHandler() {}</span>
<a href="#l19.25"></a><span id="l19.25"> </span>
<a href="#l19.26"></a><span id="l19.26"> // Try to get an appropriate nsIMsgIdentity by going through the window, getting</span>
<a href="#l19.27"></a><span id="l19.27"> // the document's URI, then the corresponding nsIMsgDBHdr. Then find the server</span>
<a href="#l19.28"></a><span id="l19.28"> // associated with that header and get the first identity for it.</span>
<a href="#l19.29"></a><span id="l19.29"> nsresult nsMsgComposeContentHandler::GetBestIdentity(</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineminus">-  nsIInterfaceRequestor* aWindowContext, nsIMsgIdentity **aIdentity)</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineminus">-{</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineplus">+    nsIInterfaceRequestor* aWindowContext, nsIMsgIdentity** aIdentity) {</span>
<a href="#l19.33"></a><span id="l19.33">   nsresult rv;</span>
<a href="#l19.34"></a><span id="l19.34"> </span>
<a href="#l19.35"></a><span id="l19.35">   nsCOMPtr&lt;mozIDOMWindowProxy&gt; domWindow = do_GetInterface(aWindowContext);</span>
<a href="#l19.36"></a><span id="l19.36">   NS_ENSURE_TRUE(domWindow, NS_ERROR_FAILURE);</span>
<a href="#l19.37"></a><span id="l19.37">   nsCOMPtr&lt;nsPIDOMWindowOuter&gt; window = nsPIDOMWindowOuter::From(domWindow);</span>
<a href="#l19.38"></a><span id="l19.38"> </span>
<a href="#l19.39"></a><span id="l19.39">   nsAutoString documentURIString;</span>
<a href="#l19.40"></a><span id="l19.40">   rv = window-&gt;GetDoc()-&gt;GetDocumentURI(documentURIString);</span>
<a href="#l19.41"></a><span id="l19.41">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.42"></a><span id="l19.42"> </span>
<a href="#l19.43"></a><span id="l19.43">   nsCOMPtr&lt;nsIURI&gt; documentURI;</span>
<a href="#l19.44"></a><span id="l19.44">   rv = NS_NewURI(getter_AddRefs(documentURI), documentURIString);</span>
<a href="#l19.45"></a><span id="l19.45">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.46"></a><span id="l19.46"> </span>
<a href="#l19.47"></a><span id="l19.47">   nsCOMPtr&lt;nsIMsgMessageUrl&gt; msgURI = do_QueryInterface(documentURI);</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineminus">-  if (!msgURI)</span>
<a href="#l19.49"></a><span id="l19.49" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineplus">+  if (!msgURI) return NS_ERROR_FAILURE;</span>
<a href="#l19.51"></a><span id="l19.51"> </span>
<a href="#l19.52"></a><span id="l19.52">   nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l19.53"></a><span id="l19.53">   rv = msgURI-&gt;GetMessageHeader(getter_AddRefs(msgHdr));</span>
<a href="#l19.54"></a><span id="l19.54">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.55"></a><span id="l19.55"> </span>
<a href="#l19.56"></a><span id="l19.56">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l19.57"></a><span id="l19.57">   rv = msgHdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l19.58"></a><span id="l19.58">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.59"></a><span id="l19.59"> </span>
<a href="#l19.60"></a><span id="l19.60">   // nsIMsgDBHdrs from .eml messages have a null folder, so bail out if that's</span>
<a href="#l19.61"></a><span id="l19.61">   // the case.</span>
<a href="#l19.62"></a><span id="l19.62" class="difflineminus">-  if (!folder)</span>
<a href="#l19.63"></a><span id="l19.63" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l19.64"></a><span id="l19.64" class="difflineplus">+  if (!folder) return NS_ERROR_FAILURE;</span>
<a href="#l19.65"></a><span id="l19.65"> </span>
<a href="#l19.66"></a><span id="l19.66">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l19.67"></a><span id="l19.67">   rv = folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l19.68"></a><span id="l19.68">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.69"></a><span id="l19.69"> </span>
<a href="#l19.70"></a><span id="l19.70" class="difflineminus">-  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager = do_GetService(</span>
<a href="#l19.71"></a><span id="l19.71" class="difflineminus">-    NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l19.72"></a><span id="l19.72" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l19.73"></a><span id="l19.73" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l19.74"></a><span id="l19.74">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.75"></a><span id="l19.75"> </span>
<a href="#l19.76"></a><span id="l19.76">   rv = accountManager-&gt;GetFirstIdentityForServer(server, aIdentity);</span>
<a href="#l19.77"></a><span id="l19.77">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.78"></a><span id="l19.78"> </span>
<a href="#l19.79"></a><span id="l19.79">   return rv;</span>
<a href="#l19.80"></a><span id="l19.80"> }</span>
<a href="#l19.81"></a><span id="l19.81"> </span>
<a href="#l19.82"></a><span id="l19.82" class="difflineminus">-NS_IMETHODIMP nsMsgComposeContentHandler::HandleContent(const char * aContentType,</span>
<a href="#l19.83"></a><span id="l19.83" class="difflineminus">-                                                nsIInterfaceRequestor* aWindowContext, nsIRequest *request)</span>
<a href="#l19.84"></a><span id="l19.84" class="difflineminus">-{</span>
<a href="#l19.85"></a><span id="l19.85" class="difflineplus">+NS_IMETHODIMP nsMsgComposeContentHandler::HandleContent(</span>
<a href="#l19.86"></a><span id="l19.86" class="difflineplus">+    const char* aContentType, nsIInterfaceRequestor* aWindowContext,</span>
<a href="#l19.87"></a><span id="l19.87" class="difflineplus">+    nsIRequest* request) {</span>
<a href="#l19.88"></a><span id="l19.88">   nsresult rv = NS_OK;</span>
<a href="#l19.89"></a><span id="l19.89" class="difflineminus">-  if (!request)</span>
<a href="#l19.90"></a><span id="l19.90" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l19.91"></a><span id="l19.91" class="difflineplus">+  if (!request) return NS_ERROR_NULL_POINTER;</span>
<a href="#l19.92"></a><span id="l19.92"> </span>
<a href="#l19.93"></a><span id="l19.93">   // First of all, get the content type and make sure it is a content type we</span>
<a href="#l19.94"></a><span id="l19.94">   // know how to handle!</span>
<a href="#l19.95"></a><span id="l19.95">   if (PL_strcasecmp(aContentType, &quot;application/x-mailto&quot;) == 0) {</span>
<a href="#l19.96"></a><span id="l19.96">     nsCOMPtr&lt;nsIMsgIdentity&gt; identity;</span>
<a href="#l19.97"></a><span id="l19.97"> </span>
<a href="#l19.98"></a><span id="l19.98">     if (aWindowContext)</span>
<a href="#l19.99"></a><span id="l19.99">       GetBestIdentity(aWindowContext, getter_AddRefs(identity));</span>
<a href="#l19.100"></a><span id="l19.100"> </span>
<a href="#l19.101"></a><span id="l19.101">     nsCOMPtr&lt;nsIURI&gt; aUri;</span>
<a href="#l19.102"></a><span id="l19.102">     nsCOMPtr&lt;nsIChannel&gt; aChannel = do_QueryInterface(request);</span>
<a href="#l19.103"></a><span id="l19.103" class="difflineminus">-    if(!aChannel) return NS_ERROR_FAILURE;</span>
<a href="#l19.104"></a><span id="l19.104" class="difflineplus">+    if (!aChannel) return NS_ERROR_FAILURE;</span>
<a href="#l19.105"></a><span id="l19.105"> </span>
<a href="#l19.106"></a><span id="l19.106">     rv = aChannel-&gt;GetURI(getter_AddRefs(aUri));</span>
<a href="#l19.107"></a><span id="l19.107" class="difflineminus">-    if (aUri)</span>
<a href="#l19.108"></a><span id="l19.108" class="difflineminus">-    {</span>
<a href="#l19.109"></a><span id="l19.109" class="difflineplus">+    if (aUri) {</span>
<a href="#l19.110"></a><span id="l19.110">       nsCOMPtr&lt;nsIMsgComposeService&gt; composeService =</span>
<a href="#l19.111"></a><span id="l19.111" class="difflineminus">-               do_GetService(kMsgComposeServiceCID, &amp;rv);</span>
<a href="#l19.112"></a><span id="l19.112" class="difflineplus">+          do_GetService(kMsgComposeServiceCID, &amp;rv);</span>
<a href="#l19.113"></a><span id="l19.113">       if (NS_SUCCEEDED(rv))</span>
<a href="#l19.114"></a><span id="l19.114">         rv = composeService-&gt;OpenComposeWindowWithURI(nullptr, aUri, identity);</span>
<a href="#l19.115"></a><span id="l19.115">     }</span>
<a href="#l19.116"></a><span id="l19.116">   } else {</span>
<a href="#l19.117"></a><span id="l19.117">     // The content-type was not application/x-mailto...</span>
<a href="#l19.118"></a><span id="l19.118">     return NS_ERROR_WONT_HANDLE_CONTENT;</span>
<a href="#l19.119"></a><span id="l19.119">   }</span>
<a href="#l19.120"></a><span id="l19.120"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgComposeContentHandler.h</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgComposeContentHandler.h</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -1,20 +1,19 @@</span>
<a href="#l20.4"></a><span id="l20.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l20.5"></a><span id="l20.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l20.6"></a><span id="l20.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l20.7"></a><span id="l20.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l20.8"></a><span id="l20.8"> </span>
<a href="#l20.9"></a><span id="l20.9"> #include &quot;nsIContentHandler.h&quot;</span>
<a href="#l20.10"></a><span id="l20.10"> #include &quot;nsIMsgIdentity.h&quot;</span>
<a href="#l20.11"></a><span id="l20.11"> </span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-class nsMsgComposeContentHandler : public nsIContentHandler</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-{</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineminus">-public:</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineplus">+class nsMsgComposeContentHandler : public nsIContentHandler {</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineplus">+ public:</span>
<a href="#l20.17"></a><span id="l20.17">   nsMsgComposeContentHandler();</span>
<a href="#l20.18"></a><span id="l20.18"> </span>
<a href="#l20.19"></a><span id="l20.19">   NS_DECL_ISUPPORTS</span>
<a href="#l20.20"></a><span id="l20.20">   NS_DECL_NSICONTENTHANDLER</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineminus">-private:</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineplus">+ private:</span>
<a href="#l20.23"></a><span id="l20.23">   virtual ~nsMsgComposeContentHandler();</span>
<a href="#l20.24"></a><span id="l20.24">   nsresult GetBestIdentity(nsIInterfaceRequestor* aWindowContext,</span>
<a href="#l20.25"></a><span id="l20.25" class="difflineminus">-                           nsIMsgIdentity **identity);</span>
<a href="#l20.26"></a><span id="l20.26" class="difflineplus">+                           nsIMsgIdentity** identity);</span>
<a href="#l20.27"></a><span id="l20.27"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgComposeParams.cpp</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgComposeParams.cpp</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -1,166 +1,145 @@</span>
<a href="#l21.4"></a><span id="l21.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l21.5"></a><span id="l21.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l21.6"></a><span id="l21.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l21.7"></a><span id="l21.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l21.8"></a><span id="l21.8"> </span>
<a href="#l21.9"></a><span id="l21.9"> #include &quot;nsMsgComposeParams.h&quot;</span>
<a href="#l21.10"></a><span id="l21.10"> </span>
<a href="#l21.11"></a><span id="l21.11" class="difflineminus">-nsMsgComposeParams::nsMsgComposeParams() :</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-  mType(nsIMsgCompType::New),</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-  mFormat(nsIMsgCompFormat::Default),</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineminus">-  mBodyIsLink(false)</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineminus">-{</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineminus">-}</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineplus">+nsMsgComposeParams::nsMsgComposeParams()</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineplus">+    : mType(nsIMsgCompType::New),</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineplus">+      mFormat(nsIMsgCompFormat::Default),</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineplus">+      mBodyIsLink(false) {}</span>
<a href="#l21.21"></a><span id="l21.21"> </span>
<a href="#l21.22"></a><span id="l21.22" class="difflineminus">-/* the following macro actually implement addref, release and query interface for our component. */</span>
<a href="#l21.23"></a><span id="l21.23" class="difflineplus">+/* the following macro actually implement addref, release and query interface</span>
<a href="#l21.24"></a><span id="l21.24" class="difflineplus">+ * for our component. */</span>
<a href="#l21.25"></a><span id="l21.25"> NS_IMPL_ISUPPORTS(nsMsgComposeParams, nsIMsgComposeParams)</span>
<a href="#l21.26"></a><span id="l21.26"> </span>
<a href="#l21.27"></a><span id="l21.27" class="difflineminus">-nsMsgComposeParams::~nsMsgComposeParams()</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineminus">-{</span>
<a href="#l21.29"></a><span id="l21.29" class="difflineminus">-}</span>
<a href="#l21.30"></a><span id="l21.30" class="difflineplus">+nsMsgComposeParams::~nsMsgComposeParams() {}</span>
<a href="#l21.31"></a><span id="l21.31"> </span>
<a href="#l21.32"></a><span id="l21.32"> /* attribute MSG_ComposeType type; */</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineminus">-NS_IMETHODIMP nsMsgComposeParams::GetType(MSG_ComposeType *aType)</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineminus">-{</span>
<a href="#l21.35"></a><span id="l21.35" class="difflineplus">+NS_IMETHODIMP nsMsgComposeParams::GetType(MSG_ComposeType *aType) {</span>
<a href="#l21.36"></a><span id="l21.36">   NS_ENSURE_ARG_POINTER(aType);</span>
<a href="#l21.37"></a><span id="l21.37"> </span>
<a href="#l21.38"></a><span id="l21.38">   *aType = mType;</span>
<a href="#l21.39"></a><span id="l21.39">   return NS_OK;</span>
<a href="#l21.40"></a><span id="l21.40"> }</span>
<a href="#l21.41"></a><span id="l21.41" class="difflineminus">-NS_IMETHODIMP nsMsgComposeParams::SetType(MSG_ComposeType aType)</span>
<a href="#l21.42"></a><span id="l21.42" class="difflineminus">-{</span>
<a href="#l21.43"></a><span id="l21.43" class="difflineplus">+NS_IMETHODIMP nsMsgComposeParams::SetType(MSG_ComposeType aType) {</span>
<a href="#l21.44"></a><span id="l21.44">   mType = aType;</span>
<a href="#l21.45"></a><span id="l21.45">   return NS_OK;</span>
<a href="#l21.46"></a><span id="l21.46"> }</span>
<a href="#l21.47"></a><span id="l21.47"> </span>
<a href="#l21.48"></a><span id="l21.48"> /* attribute MSG_ComposeFormat format; */</span>
<a href="#l21.49"></a><span id="l21.49" class="difflineminus">-NS_IMETHODIMP nsMsgComposeParams::GetFormat(MSG_ComposeFormat *aFormat)</span>
<a href="#l21.50"></a><span id="l21.50" class="difflineminus">-{</span>
<a href="#l21.51"></a><span id="l21.51" class="difflineplus">+NS_IMETHODIMP nsMsgComposeParams::GetFormat(MSG_ComposeFormat *aFormat) {</span>
<a href="#l21.52"></a><span id="l21.52">   NS_ENSURE_ARG_POINTER(aFormat);</span>
<a href="#l21.53"></a><span id="l21.53"> </span>
<a href="#l21.54"></a><span id="l21.54">   *aFormat = mFormat;</span>
<a href="#l21.55"></a><span id="l21.55">   return NS_OK;</span>
<a href="#l21.56"></a><span id="l21.56"> }</span>
<a href="#l21.57"></a><span id="l21.57" class="difflineminus">-NS_IMETHODIMP nsMsgComposeParams::SetFormat(MSG_ComposeFormat aFormat)</span>
<a href="#l21.58"></a><span id="l21.58" class="difflineminus">-{</span>
<a href="#l21.59"></a><span id="l21.59" class="difflineplus">+NS_IMETHODIMP nsMsgComposeParams::SetFormat(MSG_ComposeFormat aFormat) {</span>
<a href="#l21.60"></a><span id="l21.60">   mFormat = aFormat;</span>
<a href="#l21.61"></a><span id="l21.61">   return NS_OK;</span>
<a href="#l21.62"></a><span id="l21.62"> }</span>
<a href="#l21.63"></a><span id="l21.63"> </span>
<a href="#l21.64"></a><span id="l21.64"> /* attribute string originalMsgURI; */</span>
<a href="#l21.65"></a><span id="l21.65" class="difflineminus">-NS_IMETHODIMP nsMsgComposeParams::GetOriginalMsgURI(char * *aOriginalMsgURI)</span>
<a href="#l21.66"></a><span id="l21.66" class="difflineminus">-{</span>
<a href="#l21.67"></a><span id="l21.67" class="difflineplus">+NS_IMETHODIMP nsMsgComposeParams::GetOriginalMsgURI(char **aOriginalMsgURI) {</span>
<a href="#l21.68"></a><span id="l21.68">   NS_ENSURE_ARG_POINTER(aOriginalMsgURI);</span>
<a href="#l21.69"></a><span id="l21.69"> </span>
<a href="#l21.70"></a><span id="l21.70">   *aOriginalMsgURI = ToNewCString(mOriginalMsgUri);</span>
<a href="#l21.71"></a><span id="l21.71">   return NS_OK;</span>
<a href="#l21.72"></a><span id="l21.72"> }</span>
<a href="#l21.73"></a><span id="l21.73" class="difflineminus">-NS_IMETHODIMP nsMsgComposeParams::SetOriginalMsgURI(const char * aOriginalMsgURI)</span>
<a href="#l21.74"></a><span id="l21.74" class="difflineminus">-{</span>
<a href="#l21.75"></a><span id="l21.75" class="difflineplus">+NS_IMETHODIMP nsMsgComposeParams::SetOriginalMsgURI(</span>
<a href="#l21.76"></a><span id="l21.76" class="difflineplus">+    const char *aOriginalMsgURI) {</span>
<a href="#l21.77"></a><span id="l21.77">   mOriginalMsgUri = aOriginalMsgURI;</span>
<a href="#l21.78"></a><span id="l21.78">   return NS_OK;</span>
<a href="#l21.79"></a><span id="l21.79"> }</span>
<a href="#l21.80"></a><span id="l21.80"> </span>
<a href="#l21.81"></a><span id="l21.81"> /* attribute nsIMsgIdentity identity; */</span>
<a href="#l21.82"></a><span id="l21.82" class="difflineminus">-NS_IMETHODIMP nsMsgComposeParams::GetIdentity(nsIMsgIdentity * *aIdentity)</span>
<a href="#l21.83"></a><span id="l21.83" class="difflineminus">-{</span>
<a href="#l21.84"></a><span id="l21.84" class="difflineplus">+NS_IMETHODIMP nsMsgComposeParams::GetIdentity(nsIMsgIdentity **aIdentity) {</span>
<a href="#l21.85"></a><span id="l21.85">   NS_ENSURE_ARG_POINTER(aIdentity);</span>
<a href="#l21.86"></a><span id="l21.86">   NS_IF_ADDREF(*aIdentity = mIdentity);</span>
<a href="#l21.87"></a><span id="l21.87">   return NS_OK;</span>
<a href="#l21.88"></a><span id="l21.88"> }</span>
<a href="#l21.89"></a><span id="l21.89"> </span>
<a href="#l21.90"></a><span id="l21.90" class="difflineminus">-NS_IMETHODIMP nsMsgComposeParams::SetIdentity(nsIMsgIdentity * aIdentity)</span>
<a href="#l21.91"></a><span id="l21.91" class="difflineminus">-{</span>
<a href="#l21.92"></a><span id="l21.92" class="difflineplus">+NS_IMETHODIMP nsMsgComposeParams::SetIdentity(nsIMsgIdentity *aIdentity) {</span>
<a href="#l21.93"></a><span id="l21.93">   mIdentity = aIdentity;</span>
<a href="#l21.94"></a><span id="l21.94">   return NS_OK;</span>
<a href="#l21.95"></a><span id="l21.95"> }</span>
<a href="#l21.96"></a><span id="l21.96"> </span>
<a href="#l21.97"></a><span id="l21.97" class="difflineminus">-NS_IMETHODIMP nsMsgComposeParams::SetOrigMsgHdr(nsIMsgDBHdr *aMsgHdr)</span>
<a href="#l21.98"></a><span id="l21.98" class="difflineminus">-{</span>
<a href="#l21.99"></a><span id="l21.99" class="difflineplus">+NS_IMETHODIMP nsMsgComposeParams::SetOrigMsgHdr(nsIMsgDBHdr *aMsgHdr) {</span>
<a href="#l21.100"></a><span id="l21.100">   mOrigMsgHdr = aMsgHdr;</span>
<a href="#l21.101"></a><span id="l21.101">   return NS_OK;</span>
<a href="#l21.102"></a><span id="l21.102"> }</span>
<a href="#l21.103"></a><span id="l21.103"> </span>
<a href="#l21.104"></a><span id="l21.104" class="difflineminus">-NS_IMETHODIMP nsMsgComposeParams::GetOrigMsgHdr(nsIMsgDBHdr * *aMsgHdr)</span>
<a href="#l21.105"></a><span id="l21.105" class="difflineminus">-{</span>
<a href="#l21.106"></a><span id="l21.106" class="difflineplus">+NS_IMETHODIMP nsMsgComposeParams::GetOrigMsgHdr(nsIMsgDBHdr **aMsgHdr) {</span>
<a href="#l21.107"></a><span id="l21.107">   NS_ENSURE_ARG_POINTER(aMsgHdr);</span>
<a href="#l21.108"></a><span id="l21.108">   NS_IF_ADDREF(*aMsgHdr = mOrigMsgHdr);</span>
<a href="#l21.109"></a><span id="l21.109">   return NS_OK;</span>
<a href="#l21.110"></a><span id="l21.110"> }</span>
<a href="#l21.111"></a><span id="l21.111"> </span>
<a href="#l21.112"></a><span id="l21.112"> /* attribute ACString htmlToQuote; */</span>
<a href="#l21.113"></a><span id="l21.113" class="difflineminus">-NS_IMETHODIMP nsMsgComposeParams::GetHtmlToQuote(nsACString&amp; aHtmlToQuote)</span>
<a href="#l21.114"></a><span id="l21.114" class="difflineminus">-{</span>
<a href="#l21.115"></a><span id="l21.115" class="difflineplus">+NS_IMETHODIMP nsMsgComposeParams::GetHtmlToQuote(nsACString &amp;aHtmlToQuote) {</span>
<a href="#l21.116"></a><span id="l21.116">   aHtmlToQuote = mHtmlToQuote;</span>
<a href="#l21.117"></a><span id="l21.117">   return NS_OK;</span>
<a href="#l21.118"></a><span id="l21.118"> }</span>
<a href="#l21.119"></a><span id="l21.119" class="difflineminus">-NS_IMETHODIMP nsMsgComposeParams::SetHtmlToQuote(const nsACString&amp; aHtmlToQuote)</span>
<a href="#l21.120"></a><span id="l21.120" class="difflineminus">-{</span>
<a href="#l21.121"></a><span id="l21.121" class="difflineplus">+NS_IMETHODIMP nsMsgComposeParams::SetHtmlToQuote(</span>
<a href="#l21.122"></a><span id="l21.122" class="difflineplus">+    const nsACString &amp;aHtmlToQuote) {</span>
<a href="#l21.123"></a><span id="l21.123">   mHtmlToQuote = aHtmlToQuote;</span>
<a href="#l21.124"></a><span id="l21.124">   return NS_OK;</span>
<a href="#l21.125"></a><span id="l21.125"> }</span>
<a href="#l21.126"></a><span id="l21.126"> </span>
<a href="#l21.127"></a><span id="l21.127"> /* attribute nsIMsgCompFields composeFields; */</span>
<a href="#l21.128"></a><span id="l21.128" class="difflineminus">-NS_IMETHODIMP nsMsgComposeParams::GetComposeFields(nsIMsgCompFields * *aComposeFields)</span>
<a href="#l21.129"></a><span id="l21.129" class="difflineminus">-{</span>
<a href="#l21.130"></a><span id="l21.130" class="difflineplus">+NS_IMETHODIMP nsMsgComposeParams::GetComposeFields(</span>
<a href="#l21.131"></a><span id="l21.131" class="difflineplus">+    nsIMsgCompFields **aComposeFields) {</span>
<a href="#l21.132"></a><span id="l21.132">   NS_ENSURE_ARG_POINTER(aComposeFields);</span>
<a href="#l21.133"></a><span id="l21.133"> </span>
<a href="#l21.134"></a><span id="l21.134" class="difflineminus">-  if (mComposeFields)</span>
<a href="#l21.135"></a><span id="l21.135" class="difflineminus">-  {</span>
<a href="#l21.136"></a><span id="l21.136" class="difflineminus">-     NS_ADDREF(*aComposeFields = mComposeFields);</span>
<a href="#l21.137"></a><span id="l21.137" class="difflineminus">-  }</span>
<a href="#l21.138"></a><span id="l21.138" class="difflineminus">-  else</span>
<a href="#l21.139"></a><span id="l21.139" class="difflineplus">+  if (mComposeFields) {</span>
<a href="#l21.140"></a><span id="l21.140" class="difflineplus">+    NS_ADDREF(*aComposeFields = mComposeFields);</span>
<a href="#l21.141"></a><span id="l21.141" class="difflineplus">+  } else</span>
<a href="#l21.142"></a><span id="l21.142">     *aComposeFields = nullptr;</span>
<a href="#l21.143"></a><span id="l21.143">   return NS_OK;</span>
<a href="#l21.144"></a><span id="l21.144"> }</span>
<a href="#l21.145"></a><span id="l21.145" class="difflineminus">-NS_IMETHODIMP nsMsgComposeParams::SetComposeFields(nsIMsgCompFields * aComposeFields)</span>
<a href="#l21.146"></a><span id="l21.146" class="difflineminus">-{</span>
<a href="#l21.147"></a><span id="l21.147" class="difflineplus">+NS_IMETHODIMP nsMsgComposeParams::SetComposeFields(</span>
<a href="#l21.148"></a><span id="l21.148" class="difflineplus">+    nsIMsgCompFields *aComposeFields) {</span>
<a href="#l21.149"></a><span id="l21.149">   mComposeFields = aComposeFields;</span>
<a href="#l21.150"></a><span id="l21.150">   return NS_OK;</span>
<a href="#l21.151"></a><span id="l21.151"> }</span>
<a href="#l21.152"></a><span id="l21.152"> </span>
<a href="#l21.153"></a><span id="l21.153"> /* attribute boolean bodyIsLink; */</span>
<a href="#l21.154"></a><span id="l21.154" class="difflineminus">-NS_IMETHODIMP nsMsgComposeParams::GetBodyIsLink(bool *aBodyIsLink)</span>
<a href="#l21.155"></a><span id="l21.155" class="difflineminus">-{</span>
<a href="#l21.156"></a><span id="l21.156" class="difflineplus">+NS_IMETHODIMP nsMsgComposeParams::GetBodyIsLink(bool *aBodyIsLink) {</span>
<a href="#l21.157"></a><span id="l21.157">   NS_ENSURE_ARG_POINTER(aBodyIsLink);</span>
<a href="#l21.158"></a><span id="l21.158"> </span>
<a href="#l21.159"></a><span id="l21.159">   *aBodyIsLink = mBodyIsLink;</span>
<a href="#l21.160"></a><span id="l21.160">   return NS_OK;</span>
<a href="#l21.161"></a><span id="l21.161"> }</span>
<a href="#l21.162"></a><span id="l21.162" class="difflineminus">-NS_IMETHODIMP nsMsgComposeParams::SetBodyIsLink(bool aBodyIsLink)</span>
<a href="#l21.163"></a><span id="l21.163" class="difflineminus">-{</span>
<a href="#l21.164"></a><span id="l21.164" class="difflineplus">+NS_IMETHODIMP nsMsgComposeParams::SetBodyIsLink(bool aBodyIsLink) {</span>
<a href="#l21.165"></a><span id="l21.165">   mBodyIsLink = aBodyIsLink;</span>
<a href="#l21.166"></a><span id="l21.166">   return NS_OK;</span>
<a href="#l21.167"></a><span id="l21.167"> }</span>
<a href="#l21.168"></a><span id="l21.168"> </span>
<a href="#l21.169"></a><span id="l21.169"> /* attribute nsIMsgSendLisneter sendListener; */</span>
<a href="#l21.170"></a><span id="l21.170" class="difflineminus">-NS_IMETHODIMP nsMsgComposeParams::GetSendListener(nsIMsgSendListener * *aSendListener)</span>
<a href="#l21.171"></a><span id="l21.171" class="difflineminus">-{</span>
<a href="#l21.172"></a><span id="l21.172" class="difflineplus">+NS_IMETHODIMP nsMsgComposeParams::GetSendListener(</span>
<a href="#l21.173"></a><span id="l21.173" class="difflineplus">+    nsIMsgSendListener **aSendListener) {</span>
<a href="#l21.174"></a><span id="l21.174">   NS_ENSURE_ARG_POINTER(aSendListener);</span>
<a href="#l21.175"></a><span id="l21.175"> </span>
<a href="#l21.176"></a><span id="l21.176" class="difflineminus">-  if (mSendListener)</span>
<a href="#l21.177"></a><span id="l21.177" class="difflineminus">-  {</span>
<a href="#l21.178"></a><span id="l21.178" class="difflineminus">-     NS_ADDREF(*aSendListener = mSendListener);</span>
<a href="#l21.179"></a><span id="l21.179" class="difflineminus">-  }</span>
<a href="#l21.180"></a><span id="l21.180" class="difflineminus">-  else</span>
<a href="#l21.181"></a><span id="l21.181" class="difflineplus">+  if (mSendListener) {</span>
<a href="#l21.182"></a><span id="l21.182" class="difflineplus">+    NS_ADDREF(*aSendListener = mSendListener);</span>
<a href="#l21.183"></a><span id="l21.183" class="difflineplus">+  } else</span>
<a href="#l21.184"></a><span id="l21.184">     *aSendListener = nullptr;</span>
<a href="#l21.185"></a><span id="l21.185">   return NS_OK;</span>
<a href="#l21.186"></a><span id="l21.186"> }</span>
<a href="#l21.187"></a><span id="l21.187" class="difflineminus">-NS_IMETHODIMP nsMsgComposeParams::SetSendListener(nsIMsgSendListener * aSendListener)</span>
<a href="#l21.188"></a><span id="l21.188" class="difflineminus">-{</span>
<a href="#l21.189"></a><span id="l21.189" class="difflineplus">+NS_IMETHODIMP nsMsgComposeParams::SetSendListener(</span>
<a href="#l21.190"></a><span id="l21.190" class="difflineplus">+    nsIMsgSendListener *aSendListener) {</span>
<a href="#l21.191"></a><span id="l21.191">   mSendListener = aSendListener;</span>
<a href="#l21.192"></a><span id="l21.192">   return NS_OK;</span>
<a href="#l21.193"></a><span id="l21.193"> }</span>
<a href="#l21.194"></a><span id="l21.194"> </span>
<a href="#l21.195"></a><span id="l21.195"> /* attribute string smtpPassword; */</span>
<a href="#l21.196"></a><span id="l21.196" class="difflineminus">-NS_IMETHODIMP nsMsgComposeParams::GetSmtpPassword(nsAString &amp;aSmtpPassword)</span>
<a href="#l21.197"></a><span id="l21.197" class="difflineminus">-{</span>
<a href="#l21.198"></a><span id="l21.198" class="difflineplus">+NS_IMETHODIMP nsMsgComposeParams::GetSmtpPassword(nsAString &amp;aSmtpPassword) {</span>
<a href="#l21.199"></a><span id="l21.199">   aSmtpPassword = mSMTPPassword;</span>
<a href="#l21.200"></a><span id="l21.200">   return NS_OK;</span>
<a href="#l21.201"></a><span id="l21.201"> }</span>
<a href="#l21.202"></a><span id="l21.202" class="difflineminus">-NS_IMETHODIMP nsMsgComposeParams::SetSmtpPassword(const nsAString &amp;aSmtpPassword)</span>
<a href="#l21.203"></a><span id="l21.203" class="difflineminus">-{</span>
<a href="#l21.204"></a><span id="l21.204" class="difflineplus">+NS_IMETHODIMP nsMsgComposeParams::SetSmtpPassword(</span>
<a href="#l21.205"></a><span id="l21.205" class="difflineplus">+    const nsAString &amp;aSmtpPassword) {</span>
<a href="#l21.206"></a><span id="l21.206">   mSMTPPassword = aSmtpPassword;</span>
<a href="#l21.207"></a><span id="l21.207">   return NS_OK;</span>
<a href="#l21.208"></a><span id="l21.208"> }</span>
<a href="#l21.209"></a><span id="l21.209" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgComposeParams.h</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgComposeParams.h</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -2,29 +2,28 @@</span>
<a href="#l22.4"></a><span id="l22.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l22.5"></a><span id="l22.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l22.6"></a><span id="l22.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l22.7"></a><span id="l22.7"> </span>
<a href="#l22.8"></a><span id="l22.8"> #include &quot;nsIMsgComposeParams.h&quot;</span>
<a href="#l22.9"></a><span id="l22.9"> #include &quot;nsString.h&quot;</span>
<a href="#l22.10"></a><span id="l22.10"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l22.11"></a><span id="l22.11"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-class nsMsgComposeParams : public nsIMsgComposeParams</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineminus">-{</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineminus">-public:</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineplus">+class nsMsgComposeParams : public nsIMsgComposeParams {</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineplus">+ public:</span>
<a href="#l22.17"></a><span id="l22.17">   nsMsgComposeParams();</span>
<a href="#l22.18"></a><span id="l22.18"> </span>
<a href="#l22.19"></a><span id="l22.19">   NS_DECL_ISUPPORTS</span>
<a href="#l22.20"></a><span id="l22.20">   NS_DECL_NSIMSGCOMPOSEPARAMS</span>
<a href="#l22.21"></a><span id="l22.21"> </span>
<a href="#l22.22"></a><span id="l22.22" class="difflineminus">-private:</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineplus">+ private:</span>
<a href="#l22.24"></a><span id="l22.24">   virtual ~nsMsgComposeParams();</span>
<a href="#l22.25"></a><span id="l22.25" class="difflineminus">-  MSG_ComposeType               mType;</span>
<a href="#l22.26"></a><span id="l22.26" class="difflineminus">-  MSG_ComposeFormat             mFormat;</span>
<a href="#l22.27"></a><span id="l22.27" class="difflineminus">-  nsCString                     mOriginalMsgUri;</span>
<a href="#l22.28"></a><span id="l22.28" class="difflineminus">-  nsCOMPtr&lt;nsIMsgIdentity&gt;      mIdentity;</span>
<a href="#l22.29"></a><span id="l22.29" class="difflineminus">-  nsCOMPtr&lt;nsIMsgCompFields&gt;    mComposeFields;</span>
<a href="#l22.30"></a><span id="l22.30" class="difflineminus">-  bool                          mBodyIsLink;</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineminus">-  nsCOMPtr&lt;nsIMsgSendListener&gt;  mSendListener;</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineminus">-  nsString                     mSMTPPassword;</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineminus">-  nsCOMPtr&lt;nsIMsgDBHdr&gt;         mOrigMsgHdr;</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineminus">-  nsCString                     mHtmlToQuote;</span>
<a href="#l22.35"></a><span id="l22.35" class="difflineplus">+  MSG_ComposeType mType;</span>
<a href="#l22.36"></a><span id="l22.36" class="difflineplus">+  MSG_ComposeFormat mFormat;</span>
<a href="#l22.37"></a><span id="l22.37" class="difflineplus">+  nsCString mOriginalMsgUri;</span>
<a href="#l22.38"></a><span id="l22.38" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIdentity&gt; mIdentity;</span>
<a href="#l22.39"></a><span id="l22.39" class="difflineplus">+  nsCOMPtr&lt;nsIMsgCompFields&gt; mComposeFields;</span>
<a href="#l22.40"></a><span id="l22.40" class="difflineplus">+  bool mBodyIsLink;</span>
<a href="#l22.41"></a><span id="l22.41" class="difflineplus">+  nsCOMPtr&lt;nsIMsgSendListener&gt; mSendListener;</span>
<a href="#l22.42"></a><span id="l22.42" class="difflineplus">+  nsString mSMTPPassword;</span>
<a href="#l22.43"></a><span id="l22.43" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; mOrigMsgHdr;</span>
<a href="#l22.44"></a><span id="l22.44" class="difflineplus">+  nsCString mHtmlToQuote;</span>
<a href="#l22.45"></a><span id="l22.45"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgComposeProgressParams.cpp</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgComposeProgressParams.cpp</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -3,44 +3,38 @@</span>
<a href="#l23.4"></a><span id="l23.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l23.5"></a><span id="l23.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l23.6"></a><span id="l23.6"> </span>
<a href="#l23.7"></a><span id="l23.7"> #include &quot;nsMsgComposeProgressParams.h&quot;</span>
<a href="#l23.8"></a><span id="l23.8"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l23.9"></a><span id="l23.9"> </span>
<a href="#l23.10"></a><span id="l23.10"> NS_IMPL_ISUPPORTS(nsMsgComposeProgressParams, nsIMsgComposeProgressParams)</span>
<a href="#l23.11"></a><span id="l23.11"> </span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-nsMsgComposeProgressParams::nsMsgComposeProgressParams() :</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineminus">-  m_deliveryMode(nsIMsgCompDeliverMode::Now)</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineminus">-{</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineminus">-}</span>
<a href="#l23.16"></a><span id="l23.16" class="difflineplus">+nsMsgComposeProgressParams::nsMsgComposeProgressParams()</span>
<a href="#l23.17"></a><span id="l23.17" class="difflineplus">+    : m_deliveryMode(nsIMsgCompDeliverMode::Now) {}</span>
<a href="#l23.18"></a><span id="l23.18"> </span>
<a href="#l23.19"></a><span id="l23.19" class="difflineminus">-nsMsgComposeProgressParams::~nsMsgComposeProgressParams()</span>
<a href="#l23.20"></a><span id="l23.20" class="difflineminus">-{</span>
<a href="#l23.21"></a><span id="l23.21" class="difflineminus">-}</span>
<a href="#l23.22"></a><span id="l23.22" class="difflineplus">+nsMsgComposeProgressParams::~nsMsgComposeProgressParams() {}</span>
<a href="#l23.23"></a><span id="l23.23"> </span>
<a href="#l23.24"></a><span id="l23.24"> /* attribute wstring subject; */</span>
<a href="#l23.25"></a><span id="l23.25" class="difflineminus">-NS_IMETHODIMP nsMsgComposeProgressParams::GetSubject(char16_t * *aSubject)</span>
<a href="#l23.26"></a><span id="l23.26" class="difflineminus">-{</span>
<a href="#l23.27"></a><span id="l23.27" class="difflineplus">+NS_IMETHODIMP nsMsgComposeProgressParams::GetSubject(char16_t **aSubject) {</span>
<a href="#l23.28"></a><span id="l23.28">   NS_ENSURE_ARG(aSubject);</span>
<a href="#l23.29"></a><span id="l23.29"> </span>
<a href="#l23.30"></a><span id="l23.30">   *aSubject = ToNewUnicode(m_subject);</span>
<a href="#l23.31"></a><span id="l23.31">   return NS_OK;</span>
<a href="#l23.32"></a><span id="l23.32"> }</span>
<a href="#l23.33"></a><span id="l23.33" class="difflineminus">-NS_IMETHODIMP nsMsgComposeProgressParams::SetSubject(const char16_t * aSubject)</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineminus">-{</span>
<a href="#l23.35"></a><span id="l23.35" class="difflineplus">+NS_IMETHODIMP nsMsgComposeProgressParams::SetSubject(const char16_t *aSubject) {</span>
<a href="#l23.36"></a><span id="l23.36">   m_subject = aSubject;</span>
<a href="#l23.37"></a><span id="l23.37">   return NS_OK;</span>
<a href="#l23.38"></a><span id="l23.38"> }</span>
<a href="#l23.39"></a><span id="l23.39"> </span>
<a href="#l23.40"></a><span id="l23.40"> /* attribute MSG_DeliverMode deliveryMode; */</span>
<a href="#l23.41"></a><span id="l23.41" class="difflineminus">-NS_IMETHODIMP nsMsgComposeProgressParams::GetDeliveryMode(MSG_DeliverMode *aDeliveryMode)</span>
<a href="#l23.42"></a><span id="l23.42" class="difflineminus">-{</span>
<a href="#l23.43"></a><span id="l23.43" class="difflineplus">+NS_IMETHODIMP nsMsgComposeProgressParams::GetDeliveryMode(</span>
<a href="#l23.44"></a><span id="l23.44" class="difflineplus">+    MSG_DeliverMode *aDeliveryMode) {</span>
<a href="#l23.45"></a><span id="l23.45">   NS_ENSURE_ARG(aDeliveryMode);</span>
<a href="#l23.46"></a><span id="l23.46"> </span>
<a href="#l23.47"></a><span id="l23.47">   *aDeliveryMode = m_deliveryMode;</span>
<a href="#l23.48"></a><span id="l23.48">   return NS_OK;</span>
<a href="#l23.49"></a><span id="l23.49"> }</span>
<a href="#l23.50"></a><span id="l23.50" class="difflineminus">-NS_IMETHODIMP nsMsgComposeProgressParams::SetDeliveryMode(MSG_DeliverMode aDeliveryMode)</span>
<a href="#l23.51"></a><span id="l23.51" class="difflineminus">-{</span>
<a href="#l23.52"></a><span id="l23.52" class="difflineplus">+NS_IMETHODIMP nsMsgComposeProgressParams::SetDeliveryMode(</span>
<a href="#l23.53"></a><span id="l23.53" class="difflineplus">+    MSG_DeliverMode aDeliveryMode) {</span>
<a href="#l23.54"></a><span id="l23.54">   m_deliveryMode = aDeliveryMode;</span>
<a href="#l23.55"></a><span id="l23.55">   return NS_OK;</span>
<a href="#l23.56"></a><span id="l23.56"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgComposeProgressParams.h</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgComposeProgressParams.h</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -1,20 +1,19 @@</span>
<a href="#l24.4"></a><span id="l24.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l24.5"></a><span id="l24.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l24.6"></a><span id="l24.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l24.7"></a><span id="l24.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l24.8"></a><span id="l24.8"> </span>
<a href="#l24.9"></a><span id="l24.9"> #include &quot;nsIMsgComposeProgressParams.h&quot;</span>
<a href="#l24.10"></a><span id="l24.10"> </span>
<a href="#l24.11"></a><span id="l24.11" class="difflineminus">-class nsMsgComposeProgressParams : public nsIMsgComposeProgressParams</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-{</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineminus">-public:</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineplus">+class nsMsgComposeProgressParams : public nsIMsgComposeProgressParams {</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineplus">+ public:</span>
<a href="#l24.16"></a><span id="l24.16">   NS_DECL_ISUPPORTS</span>
<a href="#l24.17"></a><span id="l24.17">   NS_DECL_NSIMSGCOMPOSEPROGRESSPARAMS</span>
<a href="#l24.18"></a><span id="l24.18"> </span>
<a href="#l24.19"></a><span id="l24.19">   nsMsgComposeProgressParams();</span>
<a href="#l24.20"></a><span id="l24.20"> </span>
<a href="#l24.21"></a><span id="l24.21" class="difflineminus">-private:</span>
<a href="#l24.22"></a><span id="l24.22" class="difflineplus">+ private:</span>
<a href="#l24.23"></a><span id="l24.23">   virtual ~nsMsgComposeProgressParams();</span>
<a href="#l24.24"></a><span id="l24.24" class="difflineminus">-  nsString                          m_subject;</span>
<a href="#l24.25"></a><span id="l24.25" class="difflineminus">-  MSG_DeliverMode                   m_deliveryMode;</span>
<a href="#l24.26"></a><span id="l24.26" class="difflineplus">+  nsString m_subject;</span>
<a href="#l24.27"></a><span id="l24.27" class="difflineplus">+  MSG_DeliverMode m_deliveryMode;</span>
<a href="#l24.28"></a><span id="l24.28"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgComposeService.cpp</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgComposeService.cpp</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -46,281 +46,265 @@</span>
<a href="#l25.4"></a><span id="l25.4"> #include &quot;mozilla/intl/LineBreaker.h&quot;</span>
<a href="#l25.5"></a><span id="l25.5"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l25.6"></a><span id="l25.6"> #include &quot;mimemoz2.h&quot;</span>
<a href="#l25.7"></a><span id="l25.7"> #include &quot;nsIArray.h&quot;</span>
<a href="#l25.8"></a><span id="l25.8"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l25.9"></a><span id="l25.9"> #include &quot;nsIURIMutator.h&quot;</span>
<a href="#l25.10"></a><span id="l25.10"> </span>
<a href="#l25.11"></a><span id="l25.11"> #ifdef MSGCOMP_TRACE_PERFORMANCE</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-#include &quot;mozilla/Logging.h&quot;</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">-#include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineminus">-#include &quot;nsIMsgMessageService.h&quot;</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineminus">-#include &quot;nsMsgUtils.h&quot;</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineplus">+#  include &quot;mozilla/Logging.h&quot;</span>
<a href="#l25.17"></a><span id="l25.17" class="difflineplus">+#  include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l25.18"></a><span id="l25.18" class="difflineplus">+#  include &quot;nsIMsgMessageService.h&quot;</span>
<a href="#l25.19"></a><span id="l25.19" class="difflineplus">+#  include &quot;nsMsgUtils.h&quot;</span>
<a href="#l25.20"></a><span id="l25.20"> #endif</span>
<a href="#l25.21"></a><span id="l25.21"> </span>
<a href="#l25.22"></a><span id="l25.22"> #include &quot;nsICommandLine.h&quot;</span>
<a href="#l25.23"></a><span id="l25.23"> #include &quot;nsIAppStartup.h&quot;</span>
<a href="#l25.24"></a><span id="l25.24"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l25.25"></a><span id="l25.25"> #include &quot;nsIPrincipal.h&quot;</span>
<a href="#l25.26"></a><span id="l25.26"> </span>
<a href="#l25.27"></a><span id="l25.27"> #ifdef XP_WIN</span>
<a href="#l25.28"></a><span id="l25.28" class="difflineminus">-#include &lt;windows.h&gt;</span>
<a href="#l25.29"></a><span id="l25.29" class="difflineminus">-#include &lt;shellapi.h&gt;</span>
<a href="#l25.30"></a><span id="l25.30" class="difflineminus">-#include &quot;nsIWidget.h&quot;</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineplus">+#  include &lt;windows.h&gt;</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineplus">+#  include &lt;shellapi.h&gt;</span>
<a href="#l25.33"></a><span id="l25.33" class="difflineplus">+#  include &quot;nsIWidget.h&quot;</span>
<a href="#l25.34"></a><span id="l25.34"> #endif</span>
<a href="#l25.35"></a><span id="l25.35"> </span>
<a href="#l25.36"></a><span id="l25.36" class="difflineminus">-#define DEFAULT_CHROME  &quot;chrome://messenger/content/messengercompose/messengercompose.xul&quot;</span>
<a href="#l25.37"></a><span id="l25.37" class="difflineminus">-</span>
<a href="#l25.38"></a><span id="l25.38" class="difflineminus">-#define PREF_MAILNEWS_REPLY_QUOTING_SELECTION            &quot;mailnews.reply_quoting_selection&quot;</span>
<a href="#l25.39"></a><span id="l25.39" class="difflineminus">-#define PREF_MAILNEWS_REPLY_QUOTING_SELECTION_MULTI_WORD &quot;mailnews.reply_quoting_selection.multi_word&quot;</span>
<a href="#l25.40"></a><span id="l25.40" class="difflineminus">-#define PREF_MAILNEWS_REPLY_QUOTING_SELECTION_ONLY_IF    &quot;mailnews.reply_quoting_selection.only_if_chars&quot;</span>
<a href="#l25.41"></a><span id="l25.41" class="difflineplus">+#define DEFAULT_CHROME \</span>
<a href="#l25.42"></a><span id="l25.42" class="difflineplus">+  &quot;chrome://messenger/content/messengercompose/messengercompose.xul&quot;</span>
<a href="#l25.43"></a><span id="l25.43"> </span>
<a href="#l25.44"></a><span id="l25.44" class="difflineminus">-#define MAIL_ROOT_PREF                             &quot;mail.&quot;</span>
<a href="#l25.45"></a><span id="l25.45" class="difflineminus">-#define MAILNEWS_ROOT_PREF                         &quot;mailnews.&quot;</span>
<a href="#l25.46"></a><span id="l25.46" class="difflineminus">-#define HTMLDOMAINUPDATE_VERSION_PREF_NAME         &quot;global_html_domains.version&quot;</span>
<a href="#l25.47"></a><span id="l25.47" class="difflineminus">-#define HTMLDOMAINUPDATE_DOMAINLIST_PREF_NAME      &quot;global_html_domains&quot;</span>
<a href="#l25.48"></a><span id="l25.48" class="difflineminus">-#define USER_CURRENT_HTMLDOMAINLIST_PREF_NAME      &quot;html_domains&quot;</span>
<a href="#l25.49"></a><span id="l25.49" class="difflineplus">+#define PREF_MAILNEWS_REPLY_QUOTING_SELECTION &quot;mailnews.reply_quoting_selection&quot;</span>
<a href="#l25.50"></a><span id="l25.50" class="difflineplus">+#define PREF_MAILNEWS_REPLY_QUOTING_SELECTION_MULTI_WORD \</span>
<a href="#l25.51"></a><span id="l25.51" class="difflineplus">+  &quot;mailnews.reply_quoting_selection.multi_word&quot;</span>
<a href="#l25.52"></a><span id="l25.52" class="difflineplus">+#define PREF_MAILNEWS_REPLY_QUOTING_SELECTION_ONLY_IF \</span>
<a href="#l25.53"></a><span id="l25.53" class="difflineplus">+  &quot;mailnews.reply_quoting_selection.only_if_chars&quot;</span>
<a href="#l25.54"></a><span id="l25.54" class="difflineplus">+</span>
<a href="#l25.55"></a><span id="l25.55" class="difflineplus">+#define MAIL_ROOT_PREF &quot;mail.&quot;</span>
<a href="#l25.56"></a><span id="l25.56" class="difflineplus">+#define MAILNEWS_ROOT_PREF &quot;mailnews.&quot;</span>
<a href="#l25.57"></a><span id="l25.57" class="difflineplus">+#define HTMLDOMAINUPDATE_VERSION_PREF_NAME &quot;global_html_domains.version&quot;</span>
<a href="#l25.58"></a><span id="l25.58" class="difflineplus">+#define HTMLDOMAINUPDATE_DOMAINLIST_PREF_NAME &quot;global_html_domains&quot;</span>
<a href="#l25.59"></a><span id="l25.59" class="difflineplus">+#define USER_CURRENT_HTMLDOMAINLIST_PREF_NAME &quot;html_domains&quot;</span>
<a href="#l25.60"></a><span id="l25.60"> #define USER_CURRENT_PLAINTEXTDOMAINLIST_PREF_NAME &quot;plaintext_domains&quot;</span>
<a href="#l25.61"></a><span id="l25.61" class="difflineminus">-#define DOMAIN_DELIMITER                           ','</span>
<a href="#l25.62"></a><span id="l25.62" class="difflineplus">+#define DOMAIN_DELIMITER ','</span>
<a href="#l25.63"></a><span id="l25.63"> </span>
<a href="#l25.64"></a><span id="l25.64"> #ifdef MSGCOMP_TRACE_PERFORMANCE</span>
<a href="#l25.65"></a><span id="l25.65"> static mozilla::LazyLogModule MsgComposeLogModule(&quot;MsgCompose&quot;);</span>
<a href="#l25.66"></a><span id="l25.66"> </span>
<a href="#l25.67"></a><span id="l25.67" class="difflineminus">-static uint32_t GetMessageSizeFromURI(const char * originalMsgURI)</span>
<a href="#l25.68"></a><span id="l25.68" class="difflineminus">-{</span>
<a href="#l25.69"></a><span id="l25.69" class="difflineplus">+static uint32_t GetMessageSizeFromURI(const char *originalMsgURI) {</span>
<a href="#l25.70"></a><span id="l25.70">   uint32_t msgSize = 0;</span>
<a href="#l25.71"></a><span id="l25.71"> </span>
<a href="#l25.72"></a><span id="l25.72" class="difflineminus">-  if (originalMsgURI &amp;&amp; *originalMsgURI)</span>
<a href="#l25.73"></a><span id="l25.73" class="difflineminus">-  {</span>
<a href="#l25.74"></a><span id="l25.74" class="difflineminus">-    nsCOMPtr &lt;nsIMsgDBHdr&gt; originalMsgHdr;</span>
<a href="#l25.75"></a><span id="l25.75" class="difflineplus">+  if (originalMsgURI &amp;&amp; *originalMsgURI) {</span>
<a href="#l25.76"></a><span id="l25.76" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt; originalMsgHdr;</span>
<a href="#l25.77"></a><span id="l25.77">     GetMsgDBHdrFromURI(originalMsgURI, getter_AddRefs(originalMsgHdr));</span>
<a href="#l25.78"></a><span id="l25.78" class="difflineminus">-    if (originalMsgHdr)</span>
<a href="#l25.79"></a><span id="l25.79" class="difflineminus">-    originalMsgHdr-&gt;GetMessageSize(&amp;msgSize);</span>
<a href="#l25.80"></a><span id="l25.80" class="difflineplus">+    if (originalMsgHdr) originalMsgHdr-&gt;GetMessageSize(&amp;msgSize);</span>
<a href="#l25.81"></a><span id="l25.81">   }</span>
<a href="#l25.82"></a><span id="l25.82"> </span>
<a href="#l25.83"></a><span id="l25.83">   return msgSize;</span>
<a href="#l25.84"></a><span id="l25.84"> }</span>
<a href="#l25.85"></a><span id="l25.85"> #endif</span>
<a href="#l25.86"></a><span id="l25.86"> </span>
<a href="#l25.87"></a><span id="l25.87" class="difflineminus">-nsMsgComposeService::nsMsgComposeService()</span>
<a href="#l25.88"></a><span id="l25.88" class="difflineminus">-{</span>
<a href="#l25.89"></a><span id="l25.89" class="difflineminus">-</span>
<a href="#l25.90"></a><span id="l25.90" class="difflineminus">-// Defaulting the value of mLogComposePerformance to FALSE to prevent logging.</span>
<a href="#l25.91"></a><span id="l25.91" class="difflineplus">+nsMsgComposeService::nsMsgComposeService() {</span>
<a href="#l25.92"></a><span id="l25.92" class="difflineplus">+  // Defaulting the value of mLogComposePerformance to FALSE to prevent logging.</span>
<a href="#l25.93"></a><span id="l25.93">   mLogComposePerformance = false;</span>
<a href="#l25.94"></a><span id="l25.94"> #ifdef MSGCOMP_TRACE_PERFORMANCE</span>
<a href="#l25.95"></a><span id="l25.95">   mStartTime = PR_IntervalNow();</span>
<a href="#l25.96"></a><span id="l25.96">   mPreviousTime = mStartTime;</span>
<a href="#l25.97"></a><span id="l25.97"> #endif</span>
<a href="#l25.98"></a><span id="l25.98" class="difflineminus">-</span>
<a href="#l25.99"></a><span id="l25.99"> }</span>
<a href="#l25.100"></a><span id="l25.100"> </span>
<a href="#l25.101"></a><span id="l25.101" class="difflineminus">-NS_IMPL_ISUPPORTS(nsMsgComposeService,</span>
<a href="#l25.102"></a><span id="l25.102" class="difflineminus">-                   nsIMsgComposeService,</span>
<a href="#l25.103"></a><span id="l25.103" class="difflineminus">-                   ICOMMANDLINEHANDLER,</span>
<a href="#l25.104"></a><span id="l25.104" class="difflineminus">-                   nsISupportsWeakReference)</span>
<a href="#l25.105"></a><span id="l25.105" class="difflineplus">+NS_IMPL_ISUPPORTS(nsMsgComposeService, nsIMsgComposeService,</span>
<a href="#l25.106"></a><span id="l25.106" class="difflineplus">+                  ICOMMANDLINEHANDLER, nsISupportsWeakReference)</span>
<a href="#l25.107"></a><span id="l25.107"> </span>
<a href="#l25.108"></a><span id="l25.108" class="difflineminus">-nsMsgComposeService::~nsMsgComposeService()</span>
<a href="#l25.109"></a><span id="l25.109" class="difflineminus">-{</span>
<a href="#l25.110"></a><span id="l25.110" class="difflineminus">-  mOpenComposeWindows.Clear();</span>
<a href="#l25.111"></a><span id="l25.111" class="difflineminus">-}</span>
<a href="#l25.112"></a><span id="l25.112" class="difflineplus">+nsMsgComposeService::~nsMsgComposeService() { mOpenComposeWindows.Clear(); }</span>
<a href="#l25.113"></a><span id="l25.113"> </span>
<a href="#l25.114"></a><span id="l25.114" class="difflineminus">-nsresult nsMsgComposeService::Init()</span>
<a href="#l25.115"></a><span id="l25.115" class="difflineminus">-{</span>
<a href="#l25.116"></a><span id="l25.116" class="difflineplus">+nsresult nsMsgComposeService::Init() {</span>
<a href="#l25.117"></a><span id="l25.117">   nsresult rv = NS_OK;</span>
<a href="#l25.118"></a><span id="l25.118"> </span>
<a href="#l25.119"></a><span id="l25.119">   Reset();</span>
<a href="#l25.120"></a><span id="l25.120"> </span>
<a href="#l25.121"></a><span id="l25.121">   AddGlobalHtmlDomains();</span>
<a href="#l25.122"></a><span id="l25.122">   // Since the compose service should only be initialized once, we can</span>
<a href="#l25.123"></a><span id="l25.123">   // be pretty sure there aren't any existing compose windows open.</span>
<a href="#l25.124"></a><span id="l25.124">   MsgCleanupTempFiles(&quot;nsmail&quot;, &quot;tmp&quot;);</span>
<a href="#l25.125"></a><span id="l25.125">   MsgCleanupTempFiles(&quot;nsemail&quot;, &quot;html&quot;);</span>
<a href="#l25.126"></a><span id="l25.126">   MsgCleanupTempFiles(&quot;nscopy&quot;, &quot;tmp&quot;);</span>
<a href="#l25.127"></a><span id="l25.127">   return rv;</span>
<a href="#l25.128"></a><span id="l25.128"> }</span>
<a href="#l25.129"></a><span id="l25.129"> </span>
<a href="#l25.130"></a><span id="l25.130" class="difflineminus">-void nsMsgComposeService::Reset()</span>
<a href="#l25.131"></a><span id="l25.131" class="difflineminus">-{</span>
<a href="#l25.132"></a><span id="l25.132" class="difflineplus">+void nsMsgComposeService::Reset() {</span>
<a href="#l25.133"></a><span id="l25.133">   mOpenComposeWindows.Clear();</span>
<a href="#l25.134"></a><span id="l25.134"> </span>
<a href="#l25.135"></a><span id="l25.135">   nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l25.136"></a><span id="l25.136">   if (prefs)</span>
<a href="#l25.137"></a><span id="l25.137" class="difflineminus">-    prefs-&gt;GetBoolPref(&quot;mailnews.logComposePerformance&quot;, &amp;mLogComposePerformance);</span>
<a href="#l25.138"></a><span id="l25.138" class="difflineplus">+    prefs-&gt;GetBoolPref(&quot;mailnews.logComposePerformance&quot;,</span>
<a href="#l25.139"></a><span id="l25.139" class="difflineplus">+                       &amp;mLogComposePerformance);</span>
<a href="#l25.140"></a><span id="l25.140"> }</span>
<a href="#l25.141"></a><span id="l25.141"> </span>
<a href="#l25.142"></a><span id="l25.142"> // Function to open a message compose window and pass an nsIMsgComposeParams</span>
<a href="#l25.143"></a><span id="l25.143"> // parameter to it.</span>
<a href="#l25.144"></a><span id="l25.144"> NS_IMETHODIMP</span>
<a href="#l25.145"></a><span id="l25.145"> nsMsgComposeService::OpenComposeWindowWithParams(const char *chrome,</span>
<a href="#l25.146"></a><span id="l25.146" class="difflineminus">-                                                 nsIMsgComposeParams *params)</span>
<a href="#l25.147"></a><span id="l25.147" class="difflineminus">-{</span>
<a href="#l25.148"></a><span id="l25.148" class="difflineplus">+                                                 nsIMsgComposeParams *params) {</span>
<a href="#l25.149"></a><span id="l25.149">   NS_ENSURE_ARG_POINTER(params);</span>
<a href="#l25.150"></a><span id="l25.150"> #ifdef MSGCOMP_TRACE_PERFORMANCE</span>
<a href="#l25.151"></a><span id="l25.151" class="difflineminus">-  if(mLogComposePerformance)</span>
<a href="#l25.152"></a><span id="l25.152" class="difflineminus">-  {</span>
<a href="#l25.153"></a><span id="l25.153" class="difflineplus">+  if (mLogComposePerformance) {</span>
<a href="#l25.154"></a><span id="l25.154">     TimeStamp(&quot;Start opening the window&quot;, true);</span>
<a href="#l25.155"></a><span id="l25.155">   }</span>
<a href="#l25.156"></a><span id="l25.156"> #endif</span>
<a href="#l25.157"></a><span id="l25.157"> </span>
<a href="#l25.158"></a><span id="l25.158">   nsresult rv;</span>
<a href="#l25.159"></a><span id="l25.159"> </span>
<a href="#l25.160"></a><span id="l25.160">   NS_ENSURE_ARG_POINTER(params);</span>
<a href="#l25.161"></a><span id="l25.161"> </span>
<a href="#l25.162"></a><span id="l25.162" class="difflineminus">-  //Use default identity if no identity has been specified</span>
<a href="#l25.163"></a><span id="l25.163" class="difflineplus">+  // Use default identity if no identity has been specified</span>
<a href="#l25.164"></a><span id="l25.164">   nsCOMPtr&lt;nsIMsgIdentity&gt; identity;</span>
<a href="#l25.165"></a><span id="l25.165">   params-&gt;GetIdentity(getter_AddRefs(identity));</span>
<a href="#l25.166"></a><span id="l25.166" class="difflineminus">-  if (!identity)</span>
<a href="#l25.167"></a><span id="l25.167" class="difflineminus">-  {</span>
<a href="#l25.168"></a><span id="l25.168" class="difflineplus">+  if (!identity) {</span>
<a href="#l25.169"></a><span id="l25.169">     GetDefaultIdentity(getter_AddRefs(identity));</span>
<a href="#l25.170"></a><span id="l25.170">     params-&gt;SetIdentity(identity);</span>
<a href="#l25.171"></a><span id="l25.171">   }</span>
<a href="#l25.172"></a><span id="l25.172"> </span>
<a href="#l25.173"></a><span id="l25.173">   // Create a new window.</span>
<a href="#l25.174"></a><span id="l25.174">   nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch(do_GetService(NS_WINDOWWATCHER_CONTRACTID));</span>
<a href="#l25.175"></a><span id="l25.175" class="difflineminus">-  if (!wwatch)</span>
<a href="#l25.176"></a><span id="l25.176" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l25.177"></a><span id="l25.177" class="difflineplus">+  if (!wwatch) return NS_ERROR_FAILURE;</span>
<a href="#l25.178"></a><span id="l25.178"> </span>
<a href="#l25.179"></a><span id="l25.179">   nsCOMPtr&lt;nsISupportsInterfacePointer&gt; msgParamsWrapper =</span>
<a href="#l25.180"></a><span id="l25.180" class="difflineminus">-    do_CreateInstance(NS_SUPPORTS_INTERFACE_POINTER_CONTRACTID, &amp;rv);</span>
<a href="#l25.181"></a><span id="l25.181" class="difflineplus">+      do_CreateInstance(NS_SUPPORTS_INTERFACE_POINTER_CONTRACTID, &amp;rv);</span>
<a href="#l25.182"></a><span id="l25.182">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.183"></a><span id="l25.183"> </span>
<a href="#l25.184"></a><span id="l25.184">   msgParamsWrapper-&gt;SetData(params);</span>
<a href="#l25.185"></a><span id="l25.185">   msgParamsWrapper-&gt;SetDataIID(&amp;NS_GET_IID(nsIMsgComposeParams));</span>
<a href="#l25.186"></a><span id="l25.186"> </span>
<a href="#l25.187"></a><span id="l25.187">   nsCOMPtr&lt;mozIDOMWindowProxy&gt; newWindow;</span>
<a href="#l25.188"></a><span id="l25.188">   rv = wwatch-&gt;OpenWindow(0, chrome &amp;&amp; *chrome ? chrome : DEFAULT_CHROME,</span>
<a href="#l25.189"></a><span id="l25.189" class="difflineminus">-                 &quot;_blank&quot;, &quot;all,chrome,dialog=no,status,toolbar&quot;, msgParamsWrapper,</span>
<a href="#l25.190"></a><span id="l25.190" class="difflineminus">-                 getter_AddRefs(newWindow));</span>
<a href="#l25.191"></a><span id="l25.191" class="difflineplus">+                          &quot;_blank&quot;, &quot;all,chrome,dialog=no,status,toolbar&quot;,</span>
<a href="#l25.192"></a><span id="l25.192" class="difflineplus">+                          msgParamsWrapper, getter_AddRefs(newWindow));</span>
<a href="#l25.193"></a><span id="l25.193"> </span>
<a href="#l25.194"></a><span id="l25.194">   return rv;</span>
<a href="#l25.195"></a><span id="l25.195"> }</span>
<a href="#l25.196"></a><span id="l25.196"> </span>
<a href="#l25.197"></a><span id="l25.197"> NS_IMETHODIMP</span>
<a href="#l25.198"></a><span id="l25.198" class="difflineminus">-nsMsgComposeService::DetermineComposeHTML(nsIMsgIdentity *aIdentity, MSG_ComposeFormat aFormat, bool *aComposeHTML)</span>
<a href="#l25.199"></a><span id="l25.199" class="difflineminus">-{</span>
<a href="#l25.200"></a><span id="l25.200" class="difflineplus">+nsMsgComposeService::DetermineComposeHTML(nsIMsgIdentity *aIdentity,</span>
<a href="#l25.201"></a><span id="l25.201" class="difflineplus">+                                          MSG_ComposeFormat aFormat,</span>
<a href="#l25.202"></a><span id="l25.202" class="difflineplus">+                                          bool *aComposeHTML) {</span>
<a href="#l25.203"></a><span id="l25.203">   NS_ENSURE_ARG_POINTER(aComposeHTML);</span>
<a href="#l25.204"></a><span id="l25.204"> </span>
<a href="#l25.205"></a><span id="l25.205">   *aComposeHTML = true;</span>
<a href="#l25.206"></a><span id="l25.206" class="difflineminus">-  switch (aFormat)</span>
<a href="#l25.207"></a><span id="l25.207" class="difflineminus">-  {</span>
<a href="#l25.208"></a><span id="l25.208" class="difflineplus">+  switch (aFormat) {</span>
<a href="#l25.209"></a><span id="l25.209">     case nsIMsgCompFormat::HTML:</span>
<a href="#l25.210"></a><span id="l25.210">       *aComposeHTML = true;</span>
<a href="#l25.211"></a><span id="l25.211">       break;</span>
<a href="#l25.212"></a><span id="l25.212">     case nsIMsgCompFormat::PlainText:</span>
<a href="#l25.213"></a><span id="l25.213">       *aComposeHTML = false;</span>
<a href="#l25.214"></a><span id="l25.214">       break;</span>
<a href="#l25.215"></a><span id="l25.215"> </span>
<a href="#l25.216"></a><span id="l25.216">     default:</span>
<a href="#l25.217"></a><span id="l25.217">       nsCOMPtr&lt;nsIMsgIdentity&gt; identity = aIdentity;</span>
<a href="#l25.218"></a><span id="l25.218" class="difflineminus">-      if (!identity)</span>
<a href="#l25.219"></a><span id="l25.219" class="difflineminus">-        GetDefaultIdentity(getter_AddRefs(identity));</span>
<a href="#l25.220"></a><span id="l25.220" class="difflineplus">+      if (!identity) GetDefaultIdentity(getter_AddRefs(identity));</span>
<a href="#l25.221"></a><span id="l25.221"> </span>
<a href="#l25.222"></a><span id="l25.222" class="difflineminus">-      if (identity)</span>
<a href="#l25.223"></a><span id="l25.223" class="difflineminus">-      {</span>
<a href="#l25.224"></a><span id="l25.224" class="difflineplus">+      if (identity) {</span>
<a href="#l25.225"></a><span id="l25.225">         identity-&gt;GetComposeHtml(aComposeHTML);</span>
<a href="#l25.226"></a><span id="l25.226">         if (aFormat == nsIMsgCompFormat::OppositeOfDefault)</span>
<a href="#l25.227"></a><span id="l25.227">           *aComposeHTML = !*aComposeHTML;</span>
<a href="#l25.228"></a><span id="l25.228" class="difflineminus">-      }</span>
<a href="#l25.229"></a><span id="l25.229" class="difflineminus">-      else</span>
<a href="#l25.230"></a><span id="l25.230" class="difflineminus">-      {</span>
<a href="#l25.231"></a><span id="l25.231" class="difflineminus">-        // default identity not found.  Use the mail.html_compose pref to determine</span>
<a href="#l25.232"></a><span id="l25.232" class="difflineminus">-        // message compose type (HTML or PlainText).</span>
<a href="#l25.233"></a><span id="l25.233" class="difflineplus">+      } else {</span>
<a href="#l25.234"></a><span id="l25.234" class="difflineplus">+        // default identity not found.  Use the mail.html_compose pref to</span>
<a href="#l25.235"></a><span id="l25.235" class="difflineplus">+        // determine message compose type (HTML or PlainText).</span>
<a href="#l25.236"></a><span id="l25.236">         nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l25.237"></a><span id="l25.237" class="difflineminus">-        if (prefs)</span>
<a href="#l25.238"></a><span id="l25.238" class="difflineminus">-        {</span>
<a href="#l25.239"></a><span id="l25.239" class="difflineplus">+        if (prefs) {</span>
<a href="#l25.240"></a><span id="l25.240">           nsresult rv;</span>
<a href="#l25.241"></a><span id="l25.241">           bool useHTMLCompose;</span>
<a href="#l25.242"></a><span id="l25.242" class="difflineminus">-          rv = prefs-&gt;GetBoolPref(MAIL_ROOT_PREF &quot;html_compose&quot;, &amp;useHTMLCompose);</span>
<a href="#l25.243"></a><span id="l25.243" class="difflineminus">-          if (NS_SUCCEEDED(rv))</span>
<a href="#l25.244"></a><span id="l25.244" class="difflineminus">-            *aComposeHTML = useHTMLCompose;</span>
<a href="#l25.245"></a><span id="l25.245" class="difflineplus">+          rv = prefs-&gt;GetBoolPref(MAIL_ROOT_PREF &quot;html_compose&quot;,</span>
<a href="#l25.246"></a><span id="l25.246" class="difflineplus">+                                  &amp;useHTMLCompose);</span>
<a href="#l25.247"></a><span id="l25.247" class="difflineplus">+          if (NS_SUCCEEDED(rv)) *aComposeHTML = useHTMLCompose;</span>
<a href="#l25.248"></a><span id="l25.248">         }</span>
<a href="#l25.249"></a><span id="l25.249">       }</span>
<a href="#l25.250"></a><span id="l25.250">       break;</span>
<a href="#l25.251"></a><span id="l25.251">   }</span>
<a href="#l25.252"></a><span id="l25.252"> </span>
<a href="#l25.253"></a><span id="l25.253">   return NS_OK;</span>
<a href="#l25.254"></a><span id="l25.254"> }</span>
<a href="#l25.255"></a><span id="l25.255"> </span>
<a href="#l25.256"></a><span id="l25.256"> MOZ_CAN_RUN_SCRIPT_FOR_DEFINITION nsresult</span>
<a href="#l25.257"></a><span id="l25.257" class="difflineminus">-nsMsgComposeService::GetOrigWindowSelection(MSG_ComposeType type, nsIMsgWindow *aMsgWindow, nsACString&amp; aSelHTML)</span>
<a href="#l25.258"></a><span id="l25.258" class="difflineminus">-{</span>
<a href="#l25.259"></a><span id="l25.259" class="difflineplus">+nsMsgComposeService::GetOrigWindowSelection(MSG_ComposeType type,</span>
<a href="#l25.260"></a><span id="l25.260" class="difflineplus">+                                            nsIMsgWindow *aMsgWindow,</span>
<a href="#l25.261"></a><span id="l25.261" class="difflineplus">+                                            nsACString &amp;aSelHTML) {</span>
<a href="#l25.262"></a><span id="l25.262">   nsresult rv;</span>
<a href="#l25.263"></a><span id="l25.263"> </span>
<a href="#l25.264"></a><span id="l25.264">   // Good hygiene</span>
<a href="#l25.265"></a><span id="l25.265">   aSelHTML.Truncate();</span>
<a href="#l25.266"></a><span id="l25.266"> </span>
<a href="#l25.267"></a><span id="l25.267">   // Get the pref to see if we even should do reply quoting selection</span>
<a href="#l25.268"></a><span id="l25.268">   nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l25.269"></a><span id="l25.269">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.270"></a><span id="l25.270"> </span>
<a href="#l25.271"></a><span id="l25.271">   bool replyQuotingSelection;</span>
<a href="#l25.272"></a><span id="l25.272" class="difflineminus">-  rv = prefs-&gt;GetBoolPref(PREF_MAILNEWS_REPLY_QUOTING_SELECTION, &amp;replyQuotingSelection);</span>
<a href="#l25.273"></a><span id="l25.273" class="difflineplus">+  rv = prefs-&gt;GetBoolPref(PREF_MAILNEWS_REPLY_QUOTING_SELECTION,</span>
<a href="#l25.274"></a><span id="l25.274" class="difflineplus">+                          &amp;replyQuotingSelection);</span>
<a href="#l25.275"></a><span id="l25.275">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.276"></a><span id="l25.276" class="difflineminus">-  if (!replyQuotingSelection)</span>
<a href="#l25.277"></a><span id="l25.277" class="difflineminus">-    return NS_ERROR_ABORT;</span>
<a href="#l25.278"></a><span id="l25.278" class="difflineplus">+  if (!replyQuotingSelection) return NS_ERROR_ABORT;</span>
<a href="#l25.279"></a><span id="l25.279"> </span>
<a href="#l25.280"></a><span id="l25.280" class="difflineminus">-  // Now delve down in to the message to get the HTML representation of the selection</span>
<a href="#l25.281"></a><span id="l25.281" class="difflineplus">+  // Now delve down in to the message to get the HTML representation of the</span>
<a href="#l25.282"></a><span id="l25.282" class="difflineplus">+  // selection</span>
<a href="#l25.283"></a><span id="l25.283">   nsCOMPtr&lt;nsIDocShell&gt; rootDocShell;</span>
<a href="#l25.284"></a><span id="l25.284">   rv = aMsgWindow-&gt;GetRootDocShell(getter_AddRefs(rootDocShell));</span>
<a href="#l25.285"></a><span id="l25.285">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.286"></a><span id="l25.286"> </span>
<a href="#l25.287"></a><span id="l25.287">   nsCOMPtr&lt;nsIDocShellTreeItem&gt; childAsItem;</span>
<a href="#l25.288"></a><span id="l25.288" class="difflineminus">-  rv = rootDocShell-&gt;FindChildWithName(NS_LITERAL_STRING(&quot;messagepane&quot;),</span>
<a href="#l25.289"></a><span id="l25.289" class="difflineminus">-                                       true, false, nullptr, nullptr, getter_AddRefs(childAsItem));</span>
<a href="#l25.290"></a><span id="l25.290" class="difflineplus">+  rv = rootDocShell-&gt;FindChildWithName(NS_LITERAL_STRING(&quot;messagepane&quot;), true,</span>
<a href="#l25.291"></a><span id="l25.291" class="difflineplus">+                                       false, nullptr, nullptr,</span>
<a href="#l25.292"></a><span id="l25.292" class="difflineplus">+                                       getter_AddRefs(childAsItem));</span>
<a href="#l25.293"></a><span id="l25.293">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.294"></a><span id="l25.294"> </span>
<a href="#l25.295"></a><span id="l25.295">   nsCOMPtr&lt;nsIDocShell&gt; docShell(do_QueryInterface(childAsItem, &amp;rv));</span>
<a href="#l25.296"></a><span id="l25.296">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.297"></a><span id="l25.297"> </span>
<a href="#l25.298"></a><span id="l25.298">   nsCOMPtr&lt;mozIDOMWindowProxy&gt; domWindow(do_GetInterface(childAsItem));</span>
<a href="#l25.299"></a><span id="l25.299">   NS_ENSURE_TRUE(domWindow, NS_ERROR_FAILURE);</span>
<a href="#l25.300"></a><span id="l25.300" class="difflineminus">-  nsCOMPtr&lt;nsPIDOMWindowOuter&gt; privateWindow = nsPIDOMWindowOuter::From(domWindow);</span>
<a href="#l25.301"></a><span id="l25.301" class="difflineplus">+  nsCOMPtr&lt;nsPIDOMWindowOuter&gt; privateWindow =</span>
<a href="#l25.302"></a><span id="l25.302" class="difflineplus">+      nsPIDOMWindowOuter::From(domWindow);</span>
<a href="#l25.303"></a><span id="l25.303">   RefPtr&lt;mozilla::dom::Selection&gt; sel = privateWindow-&gt;GetSelection();</span>
<a href="#l25.304"></a><span id="l25.304">   NS_ENSURE_TRUE(sel, NS_ERROR_FAILURE);</span>
<a href="#l25.305"></a><span id="l25.305"> </span>
<a href="#l25.306"></a><span id="l25.306">   bool requireMultipleWords = true;</span>
<a href="#l25.307"></a><span id="l25.307">   nsAutoCString charsOnlyIf;</span>
<a href="#l25.308"></a><span id="l25.308" class="difflineminus">-  prefs-&gt;GetBoolPref(PREF_MAILNEWS_REPLY_QUOTING_SELECTION_MULTI_WORD, &amp;requireMultipleWords);</span>
<a href="#l25.309"></a><span id="l25.309" class="difflineminus">-  prefs-&gt;GetCharPref(PREF_MAILNEWS_REPLY_QUOTING_SELECTION_ONLY_IF, charsOnlyIf);</span>
<a href="#l25.310"></a><span id="l25.310" class="difflineminus">-  if (sel &amp;&amp; (requireMultipleWords || !charsOnlyIf.IsEmpty()))</span>
<a href="#l25.311"></a><span id="l25.311" class="difflineminus">-  {</span>
<a href="#l25.312"></a><span id="l25.312" class="difflineplus">+  prefs-&gt;GetBoolPref(PREF_MAILNEWS_REPLY_QUOTING_SELECTION_MULTI_WORD,</span>
<a href="#l25.313"></a><span id="l25.313" class="difflineplus">+                     &amp;requireMultipleWords);</span>
<a href="#l25.314"></a><span id="l25.314" class="difflineplus">+  prefs-&gt;GetCharPref(PREF_MAILNEWS_REPLY_QUOTING_SELECTION_ONLY_IF,</span>
<a href="#l25.315"></a><span id="l25.315" class="difflineplus">+                     charsOnlyIf);</span>
<a href="#l25.316"></a><span id="l25.316" class="difflineplus">+  if (sel &amp;&amp; (requireMultipleWords || !charsOnlyIf.IsEmpty())) {</span>
<a href="#l25.317"></a><span id="l25.317">     nsAutoString selPlain;</span>
<a href="#l25.318"></a><span id="l25.318">     sel-&gt;Stringify(selPlain);</span>
<a href="#l25.319"></a><span id="l25.319"> </span>
<a href="#l25.320"></a><span id="l25.320" class="difflineminus">-    // If &quot;mailnews.reply_quoting_selection.multi_word&quot; is on, then there must be at least</span>
<a href="#l25.321"></a><span id="l25.321" class="difflineminus">-    // two words selected in order to quote just the selected text</span>
<a href="#l25.322"></a><span id="l25.322" class="difflineminus">-    if (requireMultipleWords)</span>
<a href="#l25.323"></a><span id="l25.323" class="difflineminus">-    {</span>
<a href="#l25.324"></a><span id="l25.324" class="difflineminus">-      if (selPlain.IsEmpty())</span>
<a href="#l25.325"></a><span id="l25.325" class="difflineminus">-        return NS_ERROR_ABORT;</span>
<a href="#l25.326"></a><span id="l25.326" class="difflineplus">+    // If &quot;mailnews.reply_quoting_selection.multi_word&quot; is on, then there must</span>
<a href="#l25.327"></a><span id="l25.327" class="difflineplus">+    // be at least two words selected in order to quote just the selected text</span>
<a href="#l25.328"></a><span id="l25.328" class="difflineplus">+    if (requireMultipleWords) {</span>
<a href="#l25.329"></a><span id="l25.329" class="difflineplus">+      if (selPlain.IsEmpty()) return NS_ERROR_ABORT;</span>
<a href="#l25.330"></a><span id="l25.330"> </span>
<a href="#l25.331"></a><span id="l25.331" class="difflineminus">-      RefPtr&lt;mozilla::intl::LineBreaker&gt; lineBreaker = mozilla::intl::LineBreaker::Create();</span>
<a href="#l25.332"></a><span id="l25.332" class="difflineplus">+      RefPtr&lt;mozilla::intl::LineBreaker&gt; lineBreaker =</span>
<a href="#l25.333"></a><span id="l25.333" class="difflineplus">+          mozilla::intl::LineBreaker::Create();</span>
<a href="#l25.334"></a><span id="l25.334"> </span>
<a href="#l25.335"></a><span id="l25.335" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l25.336"></a><span id="l25.336" class="difflineminus">-      {</span>
<a href="#l25.337"></a><span id="l25.337" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l25.338"></a><span id="l25.338">         const uint32_t length = selPlain.Length();</span>
<a href="#l25.339"></a><span id="l25.339" class="difflineminus">-        const char16_t* unicodeStr = selPlain.get();</span>
<a href="#l25.340"></a><span id="l25.340" class="difflineplus">+        const char16_t *unicodeStr = selPlain.get();</span>
<a href="#l25.341"></a><span id="l25.341">         int32_t endWordPos = lineBreaker-&gt;Next(unicodeStr, length, 0);</span>
<a href="#l25.342"></a><span id="l25.342"> </span>
<a href="#l25.343"></a><span id="l25.343">         // If there's not even one word, then there's not multiple words</span>
<a href="#l25.344"></a><span id="l25.344" class="difflineminus">-        if (endWordPos == NS_LINEBREAKER_NEED_MORE_TEXT)</span>
<a href="#l25.345"></a><span id="l25.345" class="difflineminus">-          return NS_ERROR_ABORT;</span>
<a href="#l25.346"></a><span id="l25.346" class="difflineplus">+        if (endWordPos == NS_LINEBREAKER_NEED_MORE_TEXT) return NS_ERROR_ABORT;</span>
<a href="#l25.347"></a><span id="l25.347"> </span>
<a href="#l25.348"></a><span id="l25.348" class="difflineminus">-        // If after the first word is only space, then there's not multiple words</span>
<a href="#l25.349"></a><span id="l25.349" class="difflineminus">-        const char16_t* end;</span>
<a href="#l25.350"></a><span id="l25.350" class="difflineminus">-        for (end = unicodeStr + endWordPos; mozilla::intl::NS_IsSpace(*end); end++)</span>
<a href="#l25.351"></a><span id="l25.351" class="difflineplus">+        // If after the first word is only space, then there's not multiple</span>
<a href="#l25.352"></a><span id="l25.352" class="difflineplus">+        // words</span>
<a href="#l25.353"></a><span id="l25.353" class="difflineplus">+        const char16_t *end;</span>
<a href="#l25.354"></a><span id="l25.354" class="difflineplus">+        for (end = unicodeStr + endWordPos; mozilla::intl::NS_IsSpace(*end);</span>
<a href="#l25.355"></a><span id="l25.355" class="difflineplus">+             end++)</span>
<a href="#l25.356"></a><span id="l25.356">           ;</span>
<a href="#l25.357"></a><span id="l25.357" class="difflineminus">-        if (!*end)</span>
<a href="#l25.358"></a><span id="l25.358" class="difflineminus">-          return NS_ERROR_ABORT;</span>
<a href="#l25.359"></a><span id="l25.359" class="difflineplus">+        if (!*end) return NS_ERROR_ABORT;</span>
<a href="#l25.360"></a><span id="l25.360">       }</span>
<a href="#l25.361"></a><span id="l25.361">     }</span>
<a href="#l25.362"></a><span id="l25.362"> </span>
<a href="#l25.363"></a><span id="l25.363" class="difflineminus">-    if (!charsOnlyIf.IsEmpty())</span>
<a href="#l25.364"></a><span id="l25.364" class="difflineminus">-    {</span>
<a href="#l25.365"></a><span id="l25.365" class="difflineplus">+    if (!charsOnlyIf.IsEmpty()) {</span>
<a href="#l25.366"></a><span id="l25.366">       if (MsgFindCharInSet(selPlain, charsOnlyIf.get()) &lt; 0)</span>
<a href="#l25.367"></a><span id="l25.367">         return NS_ERROR_ABORT;</span>
<a href="#l25.368"></a><span id="l25.368">     }</span>
<a href="#l25.369"></a><span id="l25.369">   }</span>
<a href="#l25.370"></a><span id="l25.370"> </span>
<a href="#l25.371"></a><span id="l25.371">   nsCOMPtr&lt;nsIContentViewer&gt; contentViewer;</span>
<a href="#l25.372"></a><span id="l25.372">   rv = docShell-&gt;GetContentViewer(getter_AddRefs(contentViewer));</span>
<a href="#l25.373"></a><span id="l25.373">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.374"></a><span id="l25.374" class="difflineat">@@ -340,535 +324,505 @@ nsMsgComposeService::GetOrigWindowSelect</span>
<a href="#l25.375"></a><span id="l25.375">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.376"></a><span id="l25.376"> </span>
<a href="#l25.377"></a><span id="l25.377">   // Now remove &lt;span class=&quot;moz-txt-citetags&quot;&gt;&amp;gt; &lt;/span&gt;.</span>
<a href="#l25.378"></a><span id="l25.378">   nsAutoCString html(NS_ConvertUTF16toUTF8(selHTML).get());</span>
<a href="#l25.379"></a><span id="l25.379">   int32_t spanInd = html.Find(&quot;&lt;span class=\&quot;moz-txt-citetags\&quot;&gt;&quot;);</span>
<a href="#l25.380"></a><span id="l25.380">   while (spanInd != kNotFound) {</span>
<a href="#l25.381"></a><span id="l25.381">     nsAutoCString right0(Substring(html, spanInd));</span>
<a href="#l25.382"></a><span id="l25.382">     int32_t endInd = right0.Find(&quot;&lt;/span&gt;&quot;);</span>
<a href="#l25.383"></a><span id="l25.383" class="difflineminus">-    if (endInd == kNotFound)</span>
<a href="#l25.384"></a><span id="l25.384" class="difflineminus">-      break;  // oops, where is the closing tag gone?</span>
<a href="#l25.385"></a><span id="l25.385" class="difflineplus">+    if (endInd == kNotFound) break;  // oops, where is the closing tag gone?</span>
<a href="#l25.386"></a><span id="l25.386">     nsAutoCString right1(Substring(html, spanInd + endInd + 7));</span>
<a href="#l25.387"></a><span id="l25.387">     html.SetLength(spanInd);</span>
<a href="#l25.388"></a><span id="l25.388">     html.Append(right1);</span>
<a href="#l25.389"></a><span id="l25.389">     spanInd = html.Find(&quot;&lt;span class=\&quot;moz-txt-citetags\&quot;&gt;&quot;);</span>
<a href="#l25.390"></a><span id="l25.390">   }</span>
<a href="#l25.391"></a><span id="l25.391"> </span>
<a href="#l25.392"></a><span id="l25.392">   aSelHTML.Assign(html);</span>
<a href="#l25.393"></a><span id="l25.393"> </span>
<a href="#l25.394"></a><span id="l25.394">   return rv;</span>
<a href="#l25.395"></a><span id="l25.395"> }</span>
<a href="#l25.396"></a><span id="l25.396"> </span>
<a href="#l25.397"></a><span id="l25.397"> MOZ_CAN_RUN_SCRIPT_FOR_DEFINITION NS_IMETHODIMP</span>
<a href="#l25.398"></a><span id="l25.398" class="difflineminus">-nsMsgComposeService::OpenComposeWindow(const char *msgComposeWindowURL, nsIMsgDBHdr *origMsgHdr, const char *originalMsgURI,</span>
<a href="#l25.399"></a><span id="l25.399" class="difflineminus">-  MSG_ComposeType type, MSG_ComposeFormat format, nsIMsgIdentity * aIdentity, nsIMsgWindow *aMsgWindow)</span>
<a href="#l25.400"></a><span id="l25.400" class="difflineminus">-{</span>
<a href="#l25.401"></a><span id="l25.401" class="difflineplus">+nsMsgComposeService::OpenComposeWindow(</span>
<a href="#l25.402"></a><span id="l25.402" class="difflineplus">+    const char *msgComposeWindowURL, nsIMsgDBHdr *origMsgHdr,</span>
<a href="#l25.403"></a><span id="l25.403" class="difflineplus">+    const char *originalMsgURI, MSG_ComposeType type, MSG_ComposeFormat format,</span>
<a href="#l25.404"></a><span id="l25.404" class="difflineplus">+    nsIMsgIdentity *aIdentity, nsIMsgWindow *aMsgWindow) {</span>
<a href="#l25.405"></a><span id="l25.405">   nsresult rv;</span>
<a href="#l25.406"></a><span id="l25.406"> </span>
<a href="#l25.407"></a><span id="l25.407">   // Check for any reply type that wants to ignore the quote.</span>
<a href="#l25.408"></a><span id="l25.408">   bool ignoreQuote = false;</span>
<a href="#l25.409"></a><span id="l25.409">   if (type &gt;= nsIMsgCompType::ReplyIgnoreQuote) {</span>
<a href="#l25.410"></a><span id="l25.410">     type -= nsIMsgCompType::ReplyIgnoreQuote;</span>
<a href="#l25.411"></a><span id="l25.411">     ignoreQuote = true;</span>
<a href="#l25.412"></a><span id="l25.412">   }</span>
<a href="#l25.413"></a><span id="l25.413"> </span>
<a href="#l25.414"></a><span id="l25.414">   nsCOMPtr&lt;nsIMsgIdentity&gt; identity = aIdentity;</span>
<a href="#l25.415"></a><span id="l25.415" class="difflineminus">-  if (!identity)</span>
<a href="#l25.416"></a><span id="l25.416" class="difflineminus">-    GetDefaultIdentity(getter_AddRefs(identity));</span>
<a href="#l25.417"></a><span id="l25.417" class="difflineplus">+  if (!identity) GetDefaultIdentity(getter_AddRefs(identity));</span>
<a href="#l25.418"></a><span id="l25.418"> </span>
<a href="#l25.419"></a><span id="l25.419" class="difflineminus">-  /* Actually, the only way to implement forward inline is to simulate a template message.</span>
<a href="#l25.420"></a><span id="l25.420" class="difflineminus">-     Maybe one day when we will have more time we can change that</span>
<a href="#l25.421"></a><span id="l25.421" class="difflineplus">+  /* Actually, the only way to implement forward inline is to simulate a</span>
<a href="#l25.422"></a><span id="l25.422" class="difflineplus">+     template message. Maybe one day when we will have more time we can change</span>
<a href="#l25.423"></a><span id="l25.423" class="difflineplus">+     that</span>
<a href="#l25.424"></a><span id="l25.424">   */</span>
<a href="#l25.425"></a><span id="l25.425">   if (type == nsIMsgCompType::ForwardInline || type == nsIMsgCompType::Draft ||</span>
<a href="#l25.426"></a><span id="l25.426">       type == nsIMsgCompType::EditTemplate ||</span>
<a href="#l25.427"></a><span id="l25.427" class="difflineminus">-      type == nsIMsgCompType::Template || type == nsIMsgCompType::ReplyWithTemplate ||</span>
<a href="#l25.428"></a><span id="l25.428" class="difflineminus">-      type == nsIMsgCompType::Redirect || type == nsIMsgCompType::EditAsNew)</span>
<a href="#l25.429"></a><span id="l25.429" class="difflineminus">-  {</span>
<a href="#l25.430"></a><span id="l25.430" class="difflineplus">+      type == nsIMsgCompType::Template ||</span>
<a href="#l25.431"></a><span id="l25.431" class="difflineplus">+      type == nsIMsgCompType::ReplyWithTemplate ||</span>
<a href="#l25.432"></a><span id="l25.432" class="difflineplus">+      type == nsIMsgCompType::Redirect || type == nsIMsgCompType::EditAsNew) {</span>
<a href="#l25.433"></a><span id="l25.433">     nsAutoCString uriToOpen(originalMsgURI);</span>
<a href="#l25.434"></a><span id="l25.434">     uriToOpen += (uriToOpen.FindChar('?') == kNotFound) ? '?' : '&amp;';</span>
<a href="#l25.435"></a><span id="l25.435">     uriToOpen.AppendLiteral(&quot;fetchCompleteMessage=true&quot;);</span>
<a href="#l25.436"></a><span id="l25.436"> </span>
<a href="#l25.437"></a><span id="l25.437">     // The compose type that gets transmitted to a compose window open in mime</span>
<a href="#l25.438"></a><span id="l25.438">     // is communicated using url query parameters here.</span>
<a href="#l25.439"></a><span id="l25.439">     if (type == nsIMsgCompType::Redirect)</span>
<a href="#l25.440"></a><span id="l25.440">       uriToOpen.AppendLiteral(&quot;&amp;redirect=true&quot;);</span>
<a href="#l25.441"></a><span id="l25.441">     else if (type == nsIMsgCompType::EditAsNew)</span>
<a href="#l25.442"></a><span id="l25.442">       uriToOpen.AppendLiteral(&quot;&amp;editasnew=true&quot;);</span>
<a href="#l25.443"></a><span id="l25.443">     else if (type == nsIMsgCompType::EditTemplate)</span>
<a href="#l25.444"></a><span id="l25.444">       uriToOpen.AppendLiteral(&quot;&amp;edittempl=true&quot;);</span>
<a href="#l25.445"></a><span id="l25.445"> </span>
<a href="#l25.446"></a><span id="l25.446" class="difflineminus">-    return LoadDraftOrTemplate(uriToOpen, type == nsIMsgCompType::ForwardInline || type == nsIMsgCompType::Draft ?</span>
<a href="#l25.447"></a><span id="l25.447" class="difflineminus">-                               nsMimeOutput::nsMimeMessageDraftOrTemplate : nsMimeOutput::nsMimeMessageEditorTemplate,</span>
<a href="#l25.448"></a><span id="l25.448" class="difflineminus">-                               identity, originalMsgURI, origMsgHdr, type == nsIMsgCompType::ForwardInline,</span>
<a href="#l25.449"></a><span id="l25.449" class="difflineminus">-                               format == nsIMsgCompFormat::OppositeOfDefault, aMsgWindow);</span>
<a href="#l25.450"></a><span id="l25.450" class="difflineplus">+    return LoadDraftOrTemplate(</span>
<a href="#l25.451"></a><span id="l25.451" class="difflineplus">+        uriToOpen,</span>
<a href="#l25.452"></a><span id="l25.452" class="difflineplus">+        type == nsIMsgCompType::ForwardInline || type == nsIMsgCompType::Draft</span>
<a href="#l25.453"></a><span id="l25.453" class="difflineplus">+            ? nsMimeOutput::nsMimeMessageDraftOrTemplate</span>
<a href="#l25.454"></a><span id="l25.454" class="difflineplus">+            : nsMimeOutput::nsMimeMessageEditorTemplate,</span>
<a href="#l25.455"></a><span id="l25.455" class="difflineplus">+        identity, originalMsgURI, origMsgHdr,</span>
<a href="#l25.456"></a><span id="l25.456" class="difflineplus">+        type == nsIMsgCompType::ForwardInline,</span>
<a href="#l25.457"></a><span id="l25.457" class="difflineplus">+        format == nsIMsgCompFormat::OppositeOfDefault, aMsgWindow);</span>
<a href="#l25.458"></a><span id="l25.458">   }</span>
<a href="#l25.459"></a><span id="l25.459"> </span>
<a href="#l25.460"></a><span id="l25.460" class="difflineminus">-  nsCOMPtr&lt;nsIMsgComposeParams&gt; pMsgComposeParams (do_CreateInstance(NS_MSGCOMPOSEPARAMS_CONTRACTID, &amp;rv));</span>
<a href="#l25.461"></a><span id="l25.461" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; pMsgComposeParams)</span>
<a href="#l25.462"></a><span id="l25.462" class="difflineminus">-  {</span>
<a href="#l25.463"></a><span id="l25.463" class="difflineminus">-    nsCOMPtr&lt;nsIMsgCompFields&gt; pMsgCompFields (do_CreateInstance(NS_MSGCOMPFIELDS_CONTRACTID, &amp;rv));</span>
<a href="#l25.464"></a><span id="l25.464" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; pMsgCompFields)</span>
<a href="#l25.465"></a><span id="l25.465" class="difflineminus">-    {</span>
<a href="#l25.466"></a><span id="l25.466" class="difflineplus">+  nsCOMPtr&lt;nsIMsgComposeParams&gt; pMsgComposeParams(</span>
<a href="#l25.467"></a><span id="l25.467" class="difflineplus">+      do_CreateInstance(NS_MSGCOMPOSEPARAMS_CONTRACTID, &amp;rv));</span>
<a href="#l25.468"></a><span id="l25.468" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; pMsgComposeParams) {</span>
<a href="#l25.469"></a><span id="l25.469" class="difflineplus">+    nsCOMPtr&lt;nsIMsgCompFields&gt; pMsgCompFields(</span>
<a href="#l25.470"></a><span id="l25.470" class="difflineplus">+        do_CreateInstance(NS_MSGCOMPFIELDS_CONTRACTID, &amp;rv));</span>
<a href="#l25.471"></a><span id="l25.471" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; pMsgCompFields) {</span>
<a href="#l25.472"></a><span id="l25.472">       pMsgComposeParams-&gt;SetType(type);</span>
<a href="#l25.473"></a><span id="l25.473">       pMsgComposeParams-&gt;SetFormat(format);</span>
<a href="#l25.474"></a><span id="l25.474">       pMsgComposeParams-&gt;SetIdentity(identity);</span>
<a href="#l25.475"></a><span id="l25.475"> </span>
<a href="#l25.476"></a><span id="l25.476" class="difflineminus">-      // When doing a reply (except with a template) see if there's a selection that we should quote</span>
<a href="#l25.477"></a><span id="l25.477" class="difflineplus">+      // When doing a reply (except with a template) see if there's a selection</span>
<a href="#l25.478"></a><span id="l25.478" class="difflineplus">+      // that we should quote</span>
<a href="#l25.479"></a><span id="l25.479">       if (!ignoreQuote &amp;&amp;</span>
<a href="#l25.480"></a><span id="l25.480" class="difflineminus">-          (type == nsIMsgCompType::Reply ||</span>
<a href="#l25.481"></a><span id="l25.481" class="difflineminus">-           type == nsIMsgCompType::ReplyAll ||</span>
<a href="#l25.482"></a><span id="l25.482" class="difflineplus">+          (type == nsIMsgCompType::Reply || type == nsIMsgCompType::ReplyAll ||</span>
<a href="#l25.483"></a><span id="l25.483">            type == nsIMsgCompType::ReplyToSender ||</span>
<a href="#l25.484"></a><span id="l25.484">            type == nsIMsgCompType::ReplyToGroup ||</span>
<a href="#l25.485"></a><span id="l25.485">            type == nsIMsgCompType::ReplyToSenderAndGroup ||</span>
<a href="#l25.486"></a><span id="l25.486" class="difflineminus">-           type == nsIMsgCompType::ReplyToList))</span>
<a href="#l25.487"></a><span id="l25.487" class="difflineminus">-      {</span>
<a href="#l25.488"></a><span id="l25.488" class="difflineplus">+           type == nsIMsgCompType::ReplyToList)) {</span>
<a href="#l25.489"></a><span id="l25.489">         nsAutoCString selHTML;</span>
<a href="#l25.490"></a><span id="l25.490">         if (NS_SUCCEEDED(GetOrigWindowSelection(type, aMsgWindow, selHTML)))</span>
<a href="#l25.491"></a><span id="l25.491">           pMsgComposeParams-&gt;SetHtmlToQuote(selHTML);</span>
<a href="#l25.492"></a><span id="l25.492">       }</span>
<a href="#l25.493"></a><span id="l25.493"> </span>
<a href="#l25.494"></a><span id="l25.494" class="difflineminus">-      if (originalMsgURI &amp;&amp; *originalMsgURI)</span>
<a href="#l25.495"></a><span id="l25.495" class="difflineminus">-      {</span>
<a href="#l25.496"></a><span id="l25.496" class="difflineminus">-        if (type == nsIMsgCompType::NewsPost)</span>
<a href="#l25.497"></a><span id="l25.497" class="difflineminus">-        {</span>
<a href="#l25.498"></a><span id="l25.498" class="difflineplus">+      if (originalMsgURI &amp;&amp; *originalMsgURI) {</span>
<a href="#l25.499"></a><span id="l25.499" class="difflineplus">+        if (type == nsIMsgCompType::NewsPost) {</span>
<a href="#l25.500"></a><span id="l25.500">           nsAutoCString newsURI(originalMsgURI);</span>
<a href="#l25.501"></a><span id="l25.501">           nsAutoCString group;</span>
<a href="#l25.502"></a><span id="l25.502">           nsAutoCString host;</span>
<a href="#l25.503"></a><span id="l25.503"> </span>
<a href="#l25.504"></a><span id="l25.504">           int32_t slashpos = newsURI.RFindChar('/');</span>
<a href="#l25.505"></a><span id="l25.505" class="difflineminus">-          if (slashpos &gt; 0 )</span>
<a href="#l25.506"></a><span id="l25.506" class="difflineminus">-          {</span>
<a href="#l25.507"></a><span id="l25.507" class="difflineplus">+          if (slashpos &gt; 0) {</span>
<a href="#l25.508"></a><span id="l25.508">             // uri is &quot;[s]news://host[:port]/group&quot;</span>
<a href="#l25.509"></a><span id="l25.509">             host = StringHead(newsURI, slashpos);</span>
<a href="#l25.510"></a><span id="l25.510">             group = Substring(newsURI, slashpos + 1);</span>
<a href="#l25.511"></a><span id="l25.511"> </span>
<a href="#l25.512"></a><span id="l25.512" class="difflineminus">-          }</span>
<a href="#l25.513"></a><span id="l25.513" class="difflineminus">-          else</span>
<a href="#l25.514"></a><span id="l25.514" class="difflineplus">+          } else</span>
<a href="#l25.515"></a><span id="l25.515">             group = originalMsgURI;</span>
<a href="#l25.516"></a><span id="l25.516"> </span>
<a href="#l25.517"></a><span id="l25.517">           nsAutoCString unescapedName;</span>
<a href="#l25.518"></a><span id="l25.518">           MsgUnescapeString(group,</span>
<a href="#l25.519"></a><span id="l25.519" class="difflineminus">-                            nsINetUtil::ESCAPE_URL_FILE_BASENAME | nsINetUtil::ESCAPE_URL_FORCED,</span>
<a href="#l25.520"></a><span id="l25.520" class="difflineplus">+                            nsINetUtil::ESCAPE_URL_FILE_BASENAME |</span>
<a href="#l25.521"></a><span id="l25.521" class="difflineplus">+                                nsINetUtil::ESCAPE_URL_FORCED,</span>
<a href="#l25.522"></a><span id="l25.522">                             unescapedName);</span>
<a href="#l25.523"></a><span id="l25.523">           pMsgCompFields-&gt;SetNewsgroups(NS_ConvertUTF8toUTF16(unescapedName));</span>
<a href="#l25.524"></a><span id="l25.524">           pMsgCompFields-&gt;SetNewspostUrl(host.get());</span>
<a href="#l25.525"></a><span id="l25.525" class="difflineminus">-        }</span>
<a href="#l25.526"></a><span id="l25.526" class="difflineminus">-        else</span>
<a href="#l25.527"></a><span id="l25.527" class="difflineminus">-        {</span>
<a href="#l25.528"></a><span id="l25.528" class="difflineplus">+        } else {</span>
<a href="#l25.529"></a><span id="l25.529">           pMsgComposeParams-&gt;SetOriginalMsgURI(originalMsgURI);</span>
<a href="#l25.530"></a><span id="l25.530">           pMsgComposeParams-&gt;SetOrigMsgHdr(origMsgHdr);</span>
<a href="#l25.531"></a><span id="l25.531">         }</span>
<a href="#l25.532"></a><span id="l25.532">       }</span>
<a href="#l25.533"></a><span id="l25.533"> </span>
<a href="#l25.534"></a><span id="l25.534">       pMsgComposeParams-&gt;SetComposeFields(pMsgCompFields);</span>
<a href="#l25.535"></a><span id="l25.535"> </span>
<a href="#l25.536"></a><span id="l25.536" class="difflineminus">-      if(mLogComposePerformance)</span>
<a href="#l25.537"></a><span id="l25.537" class="difflineminus">-      {</span>
<a href="#l25.538"></a><span id="l25.538" class="difflineplus">+      if (mLogComposePerformance) {</span>
<a href="#l25.539"></a><span id="l25.539"> #ifdef MSGCOMP_TRACE_PERFORMANCE</span>
<a href="#l25.540"></a><span id="l25.540">         // ducarroz, properly fix this in the case of new message (not a reply)</span>
<a href="#l25.541"></a><span id="l25.541">         if (type != nsIMsgCompType::NewsPost) {</span>
<a href="#l25.542"></a><span id="l25.542">           char buff[256];</span>
<a href="#l25.543"></a><span id="l25.543" class="difflineminus">-          sprintf(buff, &quot;Start opening the window, message size = %d&quot;, GetMessageSizeFromURI(originalMsgURI));</span>
<a href="#l25.544"></a><span id="l25.544" class="difflineplus">+          sprintf(buff, &quot;Start opening the window, message size = %d&quot;,</span>
<a href="#l25.545"></a><span id="l25.545" class="difflineplus">+                  GetMessageSizeFromURI(originalMsgURI));</span>
<a href="#l25.546"></a><span id="l25.546">           TimeStamp(buff, true);</span>
<a href="#l25.547"></a><span id="l25.547">         }</span>
<a href="#l25.548"></a><span id="l25.548"> #endif</span>
<a href="#l25.549"></a><span id="l25.549" class="difflineminus">-      }//end if(mLogComposePerformance)</span>
<a href="#l25.550"></a><span id="l25.550" class="difflineplus">+      }  // end if(mLogComposePerformance)</span>
<a href="#l25.551"></a><span id="l25.551"> </span>
<a href="#l25.552"></a><span id="l25.552">       rv = OpenComposeWindowWithParams(msgComposeWindowURL, pMsgComposeParams);</span>
<a href="#l25.553"></a><span id="l25.553">     }</span>
<a href="#l25.554"></a><span id="l25.554">   }</span>
<a href="#l25.555"></a><span id="l25.555">   return rv;</span>
<a href="#l25.556"></a><span id="l25.556"> }</span>
<a href="#l25.557"></a><span id="l25.557"> </span>
<a href="#l25.558"></a><span id="l25.558" class="difflineminus">-NS_IMETHODIMP nsMsgComposeService::GetParamsForMailto(nsIURI * aURI, nsIMsgComposeParams ** aParams)</span>
<a href="#l25.559"></a><span id="l25.559" class="difflineminus">-{</span>
<a href="#l25.560"></a><span id="l25.560" class="difflineplus">+NS_IMETHODIMP nsMsgComposeService::GetParamsForMailto(</span>
<a href="#l25.561"></a><span id="l25.561" class="difflineplus">+    nsIURI *aURI, nsIMsgComposeParams **aParams) {</span>
<a href="#l25.562"></a><span id="l25.562">   nsresult rv = NS_OK;</span>
<a href="#l25.563"></a><span id="l25.563" class="difflineminus">-  if (aURI)</span>
<a href="#l25.564"></a><span id="l25.564" class="difflineminus">-  {</span>
<a href="#l25.565"></a><span id="l25.565" class="difflineplus">+  if (aURI) {</span>
<a href="#l25.566"></a><span id="l25.566">     nsCOMPtr&lt;nsIMailtoUrl&gt; aMailtoUrl = do_QueryInterface(aURI, &amp;rv);</span>
<a href="#l25.567"></a><span id="l25.567" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l25.568"></a><span id="l25.568" class="difflineminus">-    {</span>
<a href="#l25.569"></a><span id="l25.569" class="difflineminus">-       MSG_ComposeFormat requestedComposeFormat = nsIMsgCompFormat::Default;</span>
<a href="#l25.570"></a><span id="l25.570" class="difflineminus">-       nsCString toPart;</span>
<a href="#l25.571"></a><span id="l25.571" class="difflineminus">-       nsCString ccPart;</span>
<a href="#l25.572"></a><span id="l25.572" class="difflineminus">-       nsCString bccPart;</span>
<a href="#l25.573"></a><span id="l25.573" class="difflineminus">-       nsCString subjectPart;</span>
<a href="#l25.574"></a><span id="l25.574" class="difflineminus">-       nsCString bodyPart;</span>
<a href="#l25.575"></a><span id="l25.575" class="difflineminus">-       nsCString newsgroup;</span>
<a href="#l25.576"></a><span id="l25.576" class="difflineminus">-       nsCString refPart;</span>
<a href="#l25.577"></a><span id="l25.577" class="difflineminus">-       nsCString HTMLBodyPart;</span>
<a href="#l25.578"></a><span id="l25.578" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l25.579"></a><span id="l25.579" class="difflineplus">+      MSG_ComposeFormat requestedComposeFormat = nsIMsgCompFormat::Default;</span>
<a href="#l25.580"></a><span id="l25.580" class="difflineplus">+      nsCString toPart;</span>
<a href="#l25.581"></a><span id="l25.581" class="difflineplus">+      nsCString ccPart;</span>
<a href="#l25.582"></a><span id="l25.582" class="difflineplus">+      nsCString bccPart;</span>
<a href="#l25.583"></a><span id="l25.583" class="difflineplus">+      nsCString subjectPart;</span>
<a href="#l25.584"></a><span id="l25.584" class="difflineplus">+      nsCString bodyPart;</span>
<a href="#l25.585"></a><span id="l25.585" class="difflineplus">+      nsCString newsgroup;</span>
<a href="#l25.586"></a><span id="l25.586" class="difflineplus">+      nsCString refPart;</span>
<a href="#l25.587"></a><span id="l25.587" class="difflineplus">+      nsCString HTMLBodyPart;</span>
<a href="#l25.588"></a><span id="l25.588"> </span>
<a href="#l25.589"></a><span id="l25.589" class="difflineminus">-       aMailtoUrl-&gt;GetMessageContents(toPart, ccPart, bccPart, subjectPart,</span>
<a href="#l25.590"></a><span id="l25.590" class="difflineminus">-                                      bodyPart, HTMLBodyPart, refPart,</span>
<a href="#l25.591"></a><span id="l25.591" class="difflineminus">-                                      newsgroup, &amp;requestedComposeFormat);</span>
<a href="#l25.592"></a><span id="l25.592" class="difflineplus">+      aMailtoUrl-&gt;GetMessageContents(toPart, ccPart, bccPart, subjectPart,</span>
<a href="#l25.593"></a><span id="l25.593" class="difflineplus">+                                     bodyPart, HTMLBodyPart, refPart, newsgroup,</span>
<a href="#l25.594"></a><span id="l25.594" class="difflineplus">+                                     &amp;requestedComposeFormat);</span>
<a href="#l25.595"></a><span id="l25.595"> </span>
<a href="#l25.596"></a><span id="l25.596">       nsAutoString sanitizedBody;</span>
<a href="#l25.597"></a><span id="l25.597"> </span>
<a href="#l25.598"></a><span id="l25.598">       bool composeHTMLFormat;</span>
<a href="#l25.599"></a><span id="l25.599">       DetermineComposeHTML(NULL, requestedComposeFormat, &amp;composeHTMLFormat);</span>
<a href="#l25.600"></a><span id="l25.600"> </span>
<a href="#l25.601"></a><span id="l25.601">       // If there was an 'html-body' param, finding it will have requested</span>
<a href="#l25.602"></a><span id="l25.602">       // HTML format in GetMessageContents, so we try to use it first. If it's</span>
<a href="#l25.603"></a><span id="l25.603">       // empty, but we are composing in HTML because of the user's prefs, the</span>
<a href="#l25.604"></a><span id="l25.604">       // 'body' param needs to be escaped, since it's supposed to be plain</span>
<a href="#l25.605"></a><span id="l25.605">       // text, but it then doesn't need to sanitized.</span>
<a href="#l25.606"></a><span id="l25.606">       nsString rawBody;</span>
<a href="#l25.607"></a><span id="l25.607" class="difflineminus">-      if (HTMLBodyPart.IsEmpty())</span>
<a href="#l25.608"></a><span id="l25.608" class="difflineminus">-      {</span>
<a href="#l25.609"></a><span id="l25.609" class="difflineminus">-        if (composeHTMLFormat)</span>
<a href="#l25.610"></a><span id="l25.610" class="difflineminus">-        {</span>
<a href="#l25.611"></a><span id="l25.611" class="difflineplus">+      if (HTMLBodyPart.IsEmpty()) {</span>
<a href="#l25.612"></a><span id="l25.612" class="difflineplus">+        if (composeHTMLFormat) {</span>
<a href="#l25.613"></a><span id="l25.613">           nsCString escaped;</span>
<a href="#l25.614"></a><span id="l25.614">           nsAppendEscapedHTML(bodyPart, escaped);</span>
<a href="#l25.615"></a><span id="l25.615">           CopyUTF8toUTF16(escaped, sanitizedBody);</span>
<a href="#l25.616"></a><span id="l25.616" class="difflineminus">-        }</span>
<a href="#l25.617"></a><span id="l25.617" class="difflineminus">-        else</span>
<a href="#l25.618"></a><span id="l25.618" class="difflineplus">+        } else</span>
<a href="#l25.619"></a><span id="l25.619">           CopyUTF8toUTF16(bodyPart, rawBody);</span>
<a href="#l25.620"></a><span id="l25.620" class="difflineminus">-      }</span>
<a href="#l25.621"></a><span id="l25.621" class="difflineminus">-      else</span>
<a href="#l25.622"></a><span id="l25.622" class="difflineplus">+      } else</span>
<a href="#l25.623"></a><span id="l25.623">         CopyUTF8toUTF16(HTMLBodyPart, rawBody);</span>
<a href="#l25.624"></a><span id="l25.624"> </span>
<a href="#l25.625"></a><span id="l25.625" class="difflineminus">-      if (!rawBody.IsEmpty() &amp;&amp; composeHTMLFormat)</span>
<a href="#l25.626"></a><span id="l25.626" class="difflineminus">-      {</span>
<a href="#l25.627"></a><span id="l25.627" class="difflineminus">-        //For security reason, we must sanitize the message body before accepting any html...</span>
<a href="#l25.628"></a><span id="l25.628" class="difflineplus">+      if (!rawBody.IsEmpty() &amp;&amp; composeHTMLFormat) {</span>
<a href="#l25.629"></a><span id="l25.629" class="difflineplus">+        // For security reason, we must sanitize the message body before</span>
<a href="#l25.630"></a><span id="l25.630" class="difflineplus">+        // accepting any html...</span>
<a href="#l25.631"></a><span id="l25.631"> </span>
<a href="#l25.632"></a><span id="l25.632" class="difflineminus">-        rv = HTMLSanitize(rawBody, sanitizedBody); // from mimemoz2.h</span>
<a href="#l25.633"></a><span id="l25.633" class="difflineplus">+        rv = HTMLSanitize(rawBody, sanitizedBody);  // from mimemoz2.h</span>
<a href="#l25.634"></a><span id="l25.634"> </span>
<a href="#l25.635"></a><span id="l25.635" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l25.636"></a><span id="l25.636" class="difflineminus">-        {</span>
<a href="#l25.637"></a><span id="l25.637" class="difflineplus">+        if (NS_FAILED(rv)) {</span>
<a href="#l25.638"></a><span id="l25.638">           // Something went horribly wrong with parsing for html format</span>
<a href="#l25.639"></a><span id="l25.639">           // in the body.  Set composeHTMLFormat to false so we show the</span>
<a href="#l25.640"></a><span id="l25.640">           // plain text mail compose.</span>
<a href="#l25.641"></a><span id="l25.641">           composeHTMLFormat = false;</span>
<a href="#l25.642"></a><span id="l25.642">         }</span>
<a href="#l25.643"></a><span id="l25.643">       }</span>
<a href="#l25.644"></a><span id="l25.644"> </span>
<a href="#l25.645"></a><span id="l25.645" class="difflineminus">-      nsCOMPtr&lt;nsIMsgComposeParams&gt; pMsgComposeParams (do_CreateInstance(NS_MSGCOMPOSEPARAMS_CONTRACTID, &amp;rv));</span>
<a href="#l25.646"></a><span id="l25.646" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; pMsgComposeParams)</span>
<a href="#l25.647"></a><span id="l25.647" class="difflineminus">-      {</span>
<a href="#l25.648"></a><span id="l25.648" class="difflineplus">+      nsCOMPtr&lt;nsIMsgComposeParams&gt; pMsgComposeParams(</span>
<a href="#l25.649"></a><span id="l25.649" class="difflineplus">+          do_CreateInstance(NS_MSGCOMPOSEPARAMS_CONTRACTID, &amp;rv));</span>
<a href="#l25.650"></a><span id="l25.650" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; pMsgComposeParams) {</span>
<a href="#l25.651"></a><span id="l25.651">         pMsgComposeParams-&gt;SetType(nsIMsgCompType::MailToUrl);</span>
<a href="#l25.652"></a><span id="l25.652" class="difflineminus">-        pMsgComposeParams-&gt;SetFormat(composeHTMLFormat ? nsIMsgCompFormat::HTML : nsIMsgCompFormat::PlainText);</span>
<a href="#l25.653"></a><span id="l25.653" class="difflineplus">+        pMsgComposeParams-&gt;SetFormat(composeHTMLFormat</span>
<a href="#l25.654"></a><span id="l25.654" class="difflineplus">+                                         ? nsIMsgCompFormat::HTML</span>
<a href="#l25.655"></a><span id="l25.655" class="difflineplus">+                                         : nsIMsgCompFormat::PlainText);</span>
<a href="#l25.656"></a><span id="l25.656"> </span>
<a href="#l25.657"></a><span id="l25.657" class="difflineminus">-</span>
<a href="#l25.658"></a><span id="l25.658" class="difflineminus">-        nsCOMPtr&lt;nsIMsgCompFields&gt; pMsgCompFields (do_CreateInstance(NS_MSGCOMPFIELDS_CONTRACTID, &amp;rv));</span>
<a href="#l25.659"></a><span id="l25.659" class="difflineminus">-        if (pMsgCompFields)</span>
<a href="#l25.660"></a><span id="l25.660" class="difflineminus">-        {</span>
<a href="#l25.661"></a><span id="l25.661" class="difflineminus">-          //ugghh more conversion work!!!!</span>
<a href="#l25.662"></a><span id="l25.662" class="difflineplus">+        nsCOMPtr&lt;nsIMsgCompFields&gt; pMsgCompFields(</span>
<a href="#l25.663"></a><span id="l25.663" class="difflineplus">+            do_CreateInstance(NS_MSGCOMPFIELDS_CONTRACTID, &amp;rv));</span>
<a href="#l25.664"></a><span id="l25.664" class="difflineplus">+        if (pMsgCompFields) {</span>
<a href="#l25.665"></a><span id="l25.665" class="difflineplus">+          // ugghh more conversion work!!!!</span>
<a href="#l25.666"></a><span id="l25.666">           pMsgCompFields-&gt;SetTo(NS_ConvertUTF8toUTF16(toPart));</span>
<a href="#l25.667"></a><span id="l25.667">           pMsgCompFields-&gt;SetCc(NS_ConvertUTF8toUTF16(ccPart));</span>
<a href="#l25.668"></a><span id="l25.668">           pMsgCompFields-&gt;SetBcc(NS_ConvertUTF8toUTF16(bccPart));</span>
<a href="#l25.669"></a><span id="l25.669">           pMsgCompFields-&gt;SetNewsgroups(NS_ConvertUTF8toUTF16(newsgroup));</span>
<a href="#l25.670"></a><span id="l25.670">           pMsgCompFields-&gt;SetReferences(refPart.get());</span>
<a href="#l25.671"></a><span id="l25.671">           pMsgCompFields-&gt;SetSubject(NS_ConvertUTF8toUTF16(subjectPart));</span>
<a href="#l25.672"></a><span id="l25.672">           pMsgCompFields-&gt;SetBody(composeHTMLFormat ? sanitizedBody : rawBody);</span>
<a href="#l25.673"></a><span id="l25.673">           pMsgComposeParams-&gt;SetComposeFields(pMsgCompFields);</span>
<a href="#l25.674"></a><span id="l25.674"> </span>
<a href="#l25.675"></a><span id="l25.675">           NS_ADDREF(*aParams = pMsgComposeParams);</span>
<a href="#l25.676"></a><span id="l25.676">           return NS_OK;</span>
<a href="#l25.677"></a><span id="l25.677">         }</span>
<a href="#l25.678"></a><span id="l25.678" class="difflineminus">-      } // if we created msg compose params....</span>
<a href="#l25.679"></a><span id="l25.679" class="difflineminus">-    } // if we had a mailto url</span>
<a href="#l25.680"></a><span id="l25.680" class="difflineminus">-  } // if we had a url...</span>
<a href="#l25.681"></a><span id="l25.681" class="difflineplus">+      }  // if we created msg compose params....</span>
<a href="#l25.682"></a><span id="l25.682" class="difflineplus">+    }    // if we had a mailto url</span>
<a href="#l25.683"></a><span id="l25.683" class="difflineplus">+  }      // if we had a url...</span>
<a href="#l25.684"></a><span id="l25.684"> </span>
<a href="#l25.685"></a><span id="l25.685">   // if we got here we must have encountered an error</span>
<a href="#l25.686"></a><span id="l25.686">   *aParams = nullptr;</span>
<a href="#l25.687"></a><span id="l25.687">   return NS_ERROR_FAILURE;</span>
<a href="#l25.688"></a><span id="l25.688"> }</span>
<a href="#l25.689"></a><span id="l25.689"> </span>
<a href="#l25.690"></a><span id="l25.690" class="difflineminus">-NS_IMETHODIMP nsMsgComposeService::OpenComposeWindowWithURI(const char * aMsgComposeWindowURL, nsIURI * aURI, nsIMsgIdentity *identity)</span>
<a href="#l25.691"></a><span id="l25.691" class="difflineminus">-{</span>
<a href="#l25.692"></a><span id="l25.692" class="difflineplus">+NS_IMETHODIMP nsMsgComposeService::OpenComposeWindowWithURI(</span>
<a href="#l25.693"></a><span id="l25.693" class="difflineplus">+    const char *aMsgComposeWindowURL, nsIURI *aURI, nsIMsgIdentity *identity) {</span>
<a href="#l25.694"></a><span id="l25.694">   nsCOMPtr&lt;nsIMsgComposeParams&gt; pMsgComposeParams;</span>
<a href="#l25.695"></a><span id="l25.695">   nsresult rv = GetParamsForMailto(aURI, getter_AddRefs(pMsgComposeParams));</span>
<a href="#l25.696"></a><span id="l25.696">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l25.697"></a><span id="l25.697">     pMsgComposeParams-&gt;SetIdentity(identity);</span>
<a href="#l25.698"></a><span id="l25.698">     rv = OpenComposeWindowWithParams(aMsgComposeWindowURL, pMsgComposeParams);</span>
<a href="#l25.699"></a><span id="l25.699">   }</span>
<a href="#l25.700"></a><span id="l25.700">   return rv;</span>
<a href="#l25.701"></a><span id="l25.701"> }</span>
<a href="#l25.702"></a><span id="l25.702"> </span>
<a href="#l25.703"></a><span id="l25.703"> NS_IMETHODIMP nsMsgComposeService::InitCompose(nsIMsgComposeParams *aParams,</span>
<a href="#l25.704"></a><span id="l25.704">                                                mozIDOMWindowProxy *aWindow,</span>
<a href="#l25.705"></a><span id="l25.705">                                                nsIDocShell *aDocShell,</span>
<a href="#l25.706"></a><span id="l25.706" class="difflineminus">-                                               nsIMsgCompose **_retval)</span>
<a href="#l25.707"></a><span id="l25.707" class="difflineminus">-{</span>
<a href="#l25.708"></a><span id="l25.708" class="difflineplus">+                                               nsIMsgCompose **_retval) {</span>
<a href="#l25.709"></a><span id="l25.709">   nsresult rv;</span>
<a href="#l25.710"></a><span id="l25.710">   nsCOMPtr&lt;nsIMsgCompose&gt; msgCompose =</span>
<a href="#l25.711"></a><span id="l25.711" class="difflineminus">-    do_CreateInstance(NS_MSGCOMPOSE_CONTRACTID, &amp;rv);</span>
<a href="#l25.712"></a><span id="l25.712" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l25.713"></a><span id="l25.713" class="difflineplus">+      do_CreateInstance(NS_MSGCOMPOSE_CONTRACTID, &amp;rv);</span>
<a href="#l25.714"></a><span id="l25.714" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.715"></a><span id="l25.715"> </span>
<a href="#l25.716"></a><span id="l25.716">   rv = msgCompose-&gt;Initialize(aParams, aWindow, aDocShell);</span>
<a href="#l25.717"></a><span id="l25.717" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l25.718"></a><span id="l25.718" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.719"></a><span id="l25.719"> </span>
<a href="#l25.720"></a><span id="l25.720">   NS_IF_ADDREF(*_retval = msgCompose);</span>
<a href="#l25.721"></a><span id="l25.721">   return rv;</span>
<a href="#l25.722"></a><span id="l25.722"> }</span>
<a href="#l25.723"></a><span id="l25.723"> </span>
<a href="#l25.724"></a><span id="l25.724"> NS_IMETHODIMP</span>
<a href="#l25.725"></a><span id="l25.725" class="difflineminus">-nsMsgComposeService::GetDefaultIdentity(nsIMsgIdentity **_retval)</span>
<a href="#l25.726"></a><span id="l25.726" class="difflineminus">-{</span>
<a href="#l25.727"></a><span id="l25.727" class="difflineplus">+nsMsgComposeService::GetDefaultIdentity(nsIMsgIdentity **_retval) {</span>
<a href="#l25.728"></a><span id="l25.728">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l25.729"></a><span id="l25.729">   *_retval = nullptr;</span>
<a href="#l25.730"></a><span id="l25.730"> </span>
<a href="#l25.731"></a><span id="l25.731">   nsresult rv;</span>
<a href="#l25.732"></a><span id="l25.732" class="difflineminus">-  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager = do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l25.733"></a><span id="l25.733" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l25.734"></a><span id="l25.734" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l25.735"></a><span id="l25.735">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.736"></a><span id="l25.736"> </span>
<a href="#l25.737"></a><span id="l25.737">   nsCOMPtr&lt;nsIMsgAccount&gt; defaultAccount;</span>
<a href="#l25.738"></a><span id="l25.738">   rv = accountManager-&gt;GetDefaultAccount(getter_AddRefs(defaultAccount));</span>
<a href="#l25.739"></a><span id="l25.739">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.740"></a><span id="l25.740"> </span>
<a href="#l25.741"></a><span id="l25.741">   return defaultAccount ? defaultAccount-&gt;GetDefaultIdentity(_retval) : NS_OK;</span>
<a href="#l25.742"></a><span id="l25.742"> }</span>
<a href="#l25.743"></a><span id="l25.743"> </span>
<a href="#l25.744"></a><span id="l25.744"> /* readonly attribute boolean logComposePerformance; */</span>
<a href="#l25.745"></a><span id="l25.745" class="difflineminus">-NS_IMETHODIMP nsMsgComposeService::GetLogComposePerformance(bool *aLogComposePerformance)</span>
<a href="#l25.746"></a><span id="l25.746" class="difflineminus">-{</span>
<a href="#l25.747"></a><span id="l25.747" class="difflineplus">+NS_IMETHODIMP nsMsgComposeService::GetLogComposePerformance(</span>
<a href="#l25.748"></a><span id="l25.748" class="difflineplus">+    bool *aLogComposePerformance) {</span>
<a href="#l25.749"></a><span id="l25.749">   *aLogComposePerformance = mLogComposePerformance;</span>
<a href="#l25.750"></a><span id="l25.750">   return NS_OK;</span>
<a href="#l25.751"></a><span id="l25.751"> }</span>
<a href="#l25.752"></a><span id="l25.752"> </span>
<a href="#l25.753"></a><span id="l25.753" class="difflineminus">-NS_IMETHODIMP nsMsgComposeService::TimeStamp(const char * label, bool resetTime)</span>
<a href="#l25.754"></a><span id="l25.754" class="difflineminus">-{</span>
<a href="#l25.755"></a><span id="l25.755" class="difflineminus">-  if (!mLogComposePerformance)</span>
<a href="#l25.756"></a><span id="l25.756" class="difflineminus">-    return NS_OK;</span>
<a href="#l25.757"></a><span id="l25.757" class="difflineplus">+NS_IMETHODIMP nsMsgComposeService::TimeStamp(const char *label,</span>
<a href="#l25.758"></a><span id="l25.758" class="difflineplus">+                                             bool resetTime) {</span>
<a href="#l25.759"></a><span id="l25.759" class="difflineplus">+  if (!mLogComposePerformance) return NS_OK;</span>
<a href="#l25.760"></a><span id="l25.760"> </span>
<a href="#l25.761"></a><span id="l25.761"> #ifdef MSGCOMP_TRACE_PERFORMANCE</span>
<a href="#l25.762"></a><span id="l25.762"> </span>
<a href="#l25.763"></a><span id="l25.763">   PRIntervalTime now;</span>
<a href="#l25.764"></a><span id="l25.764"> </span>
<a href="#l25.765"></a><span id="l25.765" class="difflineminus">-  if (resetTime)</span>
<a href="#l25.766"></a><span id="l25.766" class="difflineminus">-  {</span>
<a href="#l25.767"></a><span id="l25.767" class="difflineminus">-    MOZ_LOG(MsgComposeLogModule, mozilla::LogLevel::Info, (&quot;\n[process]: [totalTime][deltaTime]\n--------------------\n&quot;));</span>
<a href="#l25.768"></a><span id="l25.768" class="difflineplus">+  if (resetTime) {</span>
<a href="#l25.769"></a><span id="l25.769" class="difflineplus">+    MOZ_LOG(MsgComposeLogModule, mozilla::LogLevel::Info,</span>
<a href="#l25.770"></a><span id="l25.770" class="difflineplus">+            (&quot;\n[process]: [totalTime][deltaTime]\n--------------------\n&quot;));</span>
<a href="#l25.771"></a><span id="l25.771"> </span>
<a href="#l25.772"></a><span id="l25.772">     mStartTime = PR_IntervalNow();</span>
<a href="#l25.773"></a><span id="l25.773">     mPreviousTime = mStartTime;</span>
<a href="#l25.774"></a><span id="l25.774">     now = mStartTime;</span>
<a href="#l25.775"></a><span id="l25.775" class="difflineminus">-  }</span>
<a href="#l25.776"></a><span id="l25.776" class="difflineminus">-  else</span>
<a href="#l25.777"></a><span id="l25.777" class="difflineplus">+  } else</span>
<a href="#l25.778"></a><span id="l25.778">     now = PR_IntervalNow();</span>
<a href="#l25.779"></a><span id="l25.779"> </span>
<a href="#l25.780"></a><span id="l25.780">   PRIntervalTime totalTime = PR_IntervalToMilliseconds(now - mStartTime);</span>
<a href="#l25.781"></a><span id="l25.781">   PRIntervalTime deltaTime = PR_IntervalToMilliseconds(now - mPreviousTime);</span>
<a href="#l25.782"></a><span id="l25.782"> </span>
<a href="#l25.783"></a><span id="l25.783" class="difflineminus">-  MOZ_LOG(MsgComposeLogModule, mozilla::LogLevel::Info, (&quot;[%3.2f][%3.2f] - %s\n&quot;,</span>
<a href="#l25.784"></a><span id="l25.784" class="difflineminus">-((double)totalTime/1000.0) + 0.005, ((double)deltaTime/1000.0) + 0.005, label));</span>
<a href="#l25.785"></a><span id="l25.785" class="difflineplus">+  MOZ_LOG(MsgComposeLogModule, mozilla::LogLevel::Info,</span>
<a href="#l25.786"></a><span id="l25.786" class="difflineplus">+          (&quot;[%3.2f][%3.2f] - %s\n&quot;, ((double)totalTime / 1000.0) + 0.005,</span>
<a href="#l25.787"></a><span id="l25.787" class="difflineplus">+           ((double)deltaTime / 1000.0) + 0.005, label));</span>
<a href="#l25.788"></a><span id="l25.788"> </span>
<a href="#l25.789"></a><span id="l25.789">   mPreviousTime = now;</span>
<a href="#l25.790"></a><span id="l25.790"> #endif</span>
<a href="#l25.791"></a><span id="l25.791">   return NS_OK;</span>
<a href="#l25.792"></a><span id="l25.792"> }</span>
<a href="#l25.793"></a><span id="l25.793"> </span>
<a href="#l25.794"></a><span id="l25.794" class="difflineminus">-class nsMsgTemplateReplyHelper final: public nsIStreamListener,</span>
<a href="#l25.795"></a><span id="l25.795" class="difflineminus">-                                      public nsIUrlListener</span>
<a href="#l25.796"></a><span id="l25.796" class="difflineminus">-{</span>
<a href="#l25.797"></a><span id="l25.797" class="difflineminus">-public:</span>
<a href="#l25.798"></a><span id="l25.798" class="difflineplus">+class nsMsgTemplateReplyHelper final : public nsIStreamListener,</span>
<a href="#l25.799"></a><span id="l25.799" class="difflineplus">+                                       public nsIUrlListener {</span>
<a href="#l25.800"></a><span id="l25.800" class="difflineplus">+ public:</span>
<a href="#l25.801"></a><span id="l25.801">   NS_DECL_ISUPPORTS</span>
<a href="#l25.802"></a><span id="l25.802">   NS_DECL_NSIURLLISTENER</span>
<a href="#l25.803"></a><span id="l25.803">   NS_DECL_NSISTREAMLISTENER</span>
<a href="#l25.804"></a><span id="l25.804">   NS_DECL_NSIREQUESTOBSERVER</span>
<a href="#l25.805"></a><span id="l25.805"> </span>
<a href="#l25.806"></a><span id="l25.806">   nsMsgTemplateReplyHelper();</span>
<a href="#l25.807"></a><span id="l25.807"> </span>
<a href="#l25.808"></a><span id="l25.808">   nsCOMPtr&lt;nsIMsgDBHdr&gt; mHdrToReplyTo;</span>
<a href="#l25.809"></a><span id="l25.809">   nsCOMPtr&lt;nsIMsgDBHdr&gt; mTemplateHdr;</span>
<a href="#l25.810"></a><span id="l25.810">   nsCOMPtr&lt;nsIMsgWindow&gt; mMsgWindow;</span>
<a href="#l25.811"></a><span id="l25.811">   nsCOMPtr&lt;nsIMsgIdentity&gt; mIdentity;</span>
<a href="#l25.812"></a><span id="l25.812">   nsCString mTemplateBody;</span>
<a href="#l25.813"></a><span id="l25.813">   bool mInMsgBody;</span>
<a href="#l25.814"></a><span id="l25.814">   char mLastBlockChars[3];</span>
<a href="#l25.815"></a><span id="l25.815"> </span>
<a href="#l25.816"></a><span id="l25.816" class="difflineminus">-private:</span>
<a href="#l25.817"></a><span id="l25.817" class="difflineplus">+ private:</span>
<a href="#l25.818"></a><span id="l25.818">   ~nsMsgTemplateReplyHelper();</span>
<a href="#l25.819"></a><span id="l25.819"> };</span>
<a href="#l25.820"></a><span id="l25.820"> </span>
<a href="#l25.821"></a><span id="l25.821" class="difflineminus">-NS_IMPL_ISUPPORTS(nsMsgTemplateReplyHelper,</span>
<a href="#l25.822"></a><span id="l25.822" class="difflineminus">-                   nsIStreamListener,</span>
<a href="#l25.823"></a><span id="l25.823" class="difflineminus">-                   nsIRequestObserver,</span>
<a href="#l25.824"></a><span id="l25.824" class="difflineminus">-                   nsIUrlListener)</span>
<a href="#l25.825"></a><span id="l25.825" class="difflineplus">+NS_IMPL_ISUPPORTS(nsMsgTemplateReplyHelper, nsIStreamListener,</span>
<a href="#l25.826"></a><span id="l25.826" class="difflineplus">+                  nsIRequestObserver, nsIUrlListener)</span>
<a href="#l25.827"></a><span id="l25.827"> </span>
<a href="#l25.828"></a><span id="l25.828" class="difflineminus">-nsMsgTemplateReplyHelper::nsMsgTemplateReplyHelper()</span>
<a href="#l25.829"></a><span id="l25.829" class="difflineminus">-{</span>
<a href="#l25.830"></a><span id="l25.830" class="difflineplus">+nsMsgTemplateReplyHelper::nsMsgTemplateReplyHelper() {</span>
<a href="#l25.831"></a><span id="l25.831">   mInMsgBody = false;</span>
<a href="#l25.832"></a><span id="l25.832">   memset(mLastBlockChars, 0, sizeof(mLastBlockChars));</span>
<a href="#l25.833"></a><span id="l25.833"> }</span>
<a href="#l25.834"></a><span id="l25.834"> </span>
<a href="#l25.835"></a><span id="l25.835" class="difflineminus">-nsMsgTemplateReplyHelper::~nsMsgTemplateReplyHelper()</span>
<a href="#l25.836"></a><span id="l25.836" class="difflineminus">-{</span>
<a href="#l25.837"></a><span id="l25.837" class="difflineminus">-}</span>
<a href="#l25.838"></a><span id="l25.838" class="difflineplus">+nsMsgTemplateReplyHelper::~nsMsgTemplateReplyHelper() {}</span>
<a href="#l25.839"></a><span id="l25.839"> </span>
<a href="#l25.840"></a><span id="l25.840" class="difflineminus">-</span>
<a href="#l25.841"></a><span id="l25.841" class="difflineminus">-NS_IMETHODIMP nsMsgTemplateReplyHelper::OnStartRunningUrl(nsIURI *aUrl)</span>
<a href="#l25.842"></a><span id="l25.842" class="difflineminus">-{</span>
<a href="#l25.843"></a><span id="l25.843" class="difflineplus">+NS_IMETHODIMP nsMsgTemplateReplyHelper::OnStartRunningUrl(nsIURI *aUrl) {</span>
<a href="#l25.844"></a><span id="l25.844">   return NS_OK;</span>
<a href="#l25.845"></a><span id="l25.845"> }</span>
<a href="#l25.846"></a><span id="l25.846"> </span>
<a href="#l25.847"></a><span id="l25.847" class="difflineminus">-NS_IMETHODIMP nsMsgTemplateReplyHelper::OnStopRunningUrl(nsIURI *aUrl, nsresult aExitCode)</span>
<a href="#l25.848"></a><span id="l25.848" class="difflineminus">-{</span>
<a href="#l25.849"></a><span id="l25.849" class="difflineplus">+NS_IMETHODIMP nsMsgTemplateReplyHelper::OnStopRunningUrl(nsIURI *aUrl,</span>
<a href="#l25.850"></a><span id="l25.850" class="difflineplus">+                                                         nsresult aExitCode) {</span>
<a href="#l25.851"></a><span id="l25.851">   NS_ENSURE_SUCCESS(aExitCode, aExitCode);</span>
<a href="#l25.852"></a><span id="l25.852">   nsresult rv;</span>
<a href="#l25.853"></a><span id="l25.853">   nsCOMPtr&lt;nsPIDOMWindowOuter&gt; parentWindow;</span>
<a href="#l25.854"></a><span id="l25.854" class="difflineminus">-  if (mMsgWindow)</span>
<a href="#l25.855"></a><span id="l25.855" class="difflineminus">-  {</span>
<a href="#l25.856"></a><span id="l25.856" class="difflineplus">+  if (mMsgWindow) {</span>
<a href="#l25.857"></a><span id="l25.857">     nsCOMPtr&lt;nsIDocShell&gt; docShell;</span>
<a href="#l25.858"></a><span id="l25.858">     rv = mMsgWindow-&gt;GetRootDocShell(getter_AddRefs(docShell));</span>
<a href="#l25.859"></a><span id="l25.859">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.860"></a><span id="l25.860">     parentWindow = do_GetInterface(docShell);</span>
<a href="#l25.861"></a><span id="l25.861">     NS_ENSURE_TRUE(parentWindow, NS_ERROR_FAILURE);</span>
<a href="#l25.862"></a><span id="l25.862">   }</span>
<a href="#l25.863"></a><span id="l25.863"> </span>
<a href="#l25.864"></a><span id="l25.864">   // create the compose params object</span>
<a href="#l25.865"></a><span id="l25.865" class="difflineminus">-  nsCOMPtr&lt;nsIMsgComposeParams&gt; pMsgComposeParams (do_CreateInstance(NS_MSGCOMPOSEPARAMS_CONTRACTID, &amp;rv));</span>
<a href="#l25.866"></a><span id="l25.866" class="difflineminus">-  if (NS_FAILED(rv) || (!pMsgComposeParams) ) return rv ;</span>
<a href="#l25.867"></a><span id="l25.867" class="difflineminus">-  nsCOMPtr&lt;nsIMsgCompFields&gt; compFields = do_CreateInstance(NS_MSGCOMPFIELDS_CONTRACTID, &amp;rv) ;</span>
<a href="#l25.868"></a><span id="l25.868" class="difflineplus">+  nsCOMPtr&lt;nsIMsgComposeParams&gt; pMsgComposeParams(</span>
<a href="#l25.869"></a><span id="l25.869" class="difflineplus">+      do_CreateInstance(NS_MSGCOMPOSEPARAMS_CONTRACTID, &amp;rv));</span>
<a href="#l25.870"></a><span id="l25.870" class="difflineplus">+  if (NS_FAILED(rv) || (!pMsgComposeParams)) return rv;</span>
<a href="#l25.871"></a><span id="l25.871" class="difflineplus">+  nsCOMPtr&lt;nsIMsgCompFields&gt; compFields =</span>
<a href="#l25.872"></a><span id="l25.872" class="difflineplus">+      do_CreateInstance(NS_MSGCOMPFIELDS_CONTRACTID, &amp;rv);</span>
<a href="#l25.873"></a><span id="l25.873"> </span>
<a href="#l25.874"></a><span id="l25.874">   nsCString replyTo;</span>
<a href="#l25.875"></a><span id="l25.875">   mHdrToReplyTo-&gt;GetStringProperty(&quot;replyTo&quot;, getter_Copies(replyTo));</span>
<a href="#l25.876"></a><span id="l25.876" class="difflineminus">-  if (replyTo.IsEmpty())</span>
<a href="#l25.877"></a><span id="l25.877" class="difflineminus">-    mHdrToReplyTo-&gt;GetAuthor(getter_Copies(replyTo));</span>
<a href="#l25.878"></a><span id="l25.878" class="difflineplus">+  if (replyTo.IsEmpty()) mHdrToReplyTo-&gt;GetAuthor(getter_Copies(replyTo));</span>
<a href="#l25.879"></a><span id="l25.879">   compFields-&gt;SetTo(NS_ConvertUTF8toUTF16(replyTo));</span>
<a href="#l25.880"></a><span id="l25.880"> </span>
<a href="#l25.881"></a><span id="l25.881">   nsString body;</span>
<a href="#l25.882"></a><span id="l25.882">   nsString templateSubject, replySubject;</span>
<a href="#l25.883"></a><span id="l25.883"> </span>
<a href="#l25.884"></a><span id="l25.884">   mHdrToReplyTo-&gt;GetMime2DecodedSubject(replySubject);</span>
<a href="#l25.885"></a><span id="l25.885">   mTemplateHdr-&gt;GetMime2DecodedSubject(templateSubject);</span>
<a href="#l25.886"></a><span id="l25.886" class="difflineminus">-  nsString subject(NS_LITERAL_STRING(&quot;Auto: &quot;)); // RFC 3834 3.1.5.</span>
<a href="#l25.887"></a><span id="l25.887" class="difflineplus">+  nsString subject(NS_LITERAL_STRING(&quot;Auto: &quot;));  // RFC 3834 3.1.5.</span>
<a href="#l25.888"></a><span id="l25.888">   subject.Append(templateSubject);</span>
<a href="#l25.889"></a><span id="l25.889" class="difflineminus">-  if (!replySubject.IsEmpty())</span>
<a href="#l25.890"></a><span id="l25.890" class="difflineminus">-  {</span>
<a href="#l25.891"></a><span id="l25.891" class="difflineplus">+  if (!replySubject.IsEmpty()) {</span>
<a href="#l25.892"></a><span id="l25.892">     subject.AppendLiteral(u&quot; (was: &quot;);</span>
<a href="#l25.893"></a><span id="l25.893">     subject.Append(replySubject);</span>
<a href="#l25.894"></a><span id="l25.894">     subject.Append(u')');</span>
<a href="#l25.895"></a><span id="l25.895">   }</span>
<a href="#l25.896"></a><span id="l25.896"> </span>
<a href="#l25.897"></a><span id="l25.897">   compFields-&gt;SetSubject(subject);</span>
<a href="#l25.898"></a><span id="l25.898" class="difflineminus">-  compFields-&gt;SetRawHeader(&quot;Auto-Submitted&quot;, NS_LITERAL_CSTRING(&quot;auto-replied&quot;), nullptr);</span>
<a href="#l25.899"></a><span id="l25.899" class="difflineplus">+  compFields-&gt;SetRawHeader(&quot;Auto-Submitted&quot;, NS_LITERAL_CSTRING(&quot;auto-replied&quot;),</span>
<a href="#l25.900"></a><span id="l25.900" class="difflineplus">+                           nullptr);</span>
<a href="#l25.901"></a><span id="l25.901"> </span>
<a href="#l25.902"></a><span id="l25.902">   nsCString charset;</span>
<a href="#l25.903"></a><span id="l25.903">   rv = mTemplateHdr-&gt;GetCharset(getter_Copies(charset));</span>
<a href="#l25.904"></a><span id="l25.904">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.905"></a><span id="l25.905">   compFields-&gt;SetCharacterSet(charset.get());</span>
<a href="#l25.906"></a><span id="l25.906">   rv = nsMsgI18NConvertToUnicode(charset, mTemplateBody, body);</span>
<a href="#l25.907"></a><span id="l25.907" class="difflineminus">-  NS_WARNING_ASSERTION(NS_SUCCEEDED(rv), &quot;couldn't convert templ body to unicode&quot;);</span>
<a href="#l25.908"></a><span id="l25.908" class="difflineplus">+  NS_WARNING_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l25.909"></a><span id="l25.909" class="difflineplus">+                       &quot;couldn't convert templ body to unicode&quot;);</span>
<a href="#l25.910"></a><span id="l25.910">   compFields-&gt;SetBody(body);</span>
<a href="#l25.911"></a><span id="l25.911"> </span>
<a href="#l25.912"></a><span id="l25.912">   nsCString msgUri;</span>
<a href="#l25.913"></a><span id="l25.913" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; folder;</span>
<a href="#l25.914"></a><span id="l25.914" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l25.915"></a><span id="l25.915">   mHdrToReplyTo-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l25.916"></a><span id="l25.916">   folder-&gt;GetUriForMsg(mHdrToReplyTo, msgUri);</span>
<a href="#l25.917"></a><span id="l25.917">   // populate the compose params</span>
<a href="#l25.918"></a><span id="l25.918">   pMsgComposeParams-&gt;SetType(nsIMsgCompType::ReplyWithTemplate);</span>
<a href="#l25.919"></a><span id="l25.919">   pMsgComposeParams-&gt;SetFormat(nsIMsgCompFormat::Default);</span>
<a href="#l25.920"></a><span id="l25.920">   pMsgComposeParams-&gt;SetIdentity(mIdentity);</span>
<a href="#l25.921"></a><span id="l25.921">   pMsgComposeParams-&gt;SetComposeFields(compFields);</span>
<a href="#l25.922"></a><span id="l25.922">   pMsgComposeParams-&gt;SetOriginalMsgURI(msgUri.get());</span>
<a href="#l25.923"></a><span id="l25.923"> </span>
<a href="#l25.924"></a><span id="l25.924">   // create the nsIMsgCompose object to send the object</span>
<a href="#l25.925"></a><span id="l25.925" class="difflineminus">-  nsCOMPtr&lt;nsIMsgCompose&gt; pMsgCompose (do_CreateInstance(NS_MSGCOMPOSE_CONTRACTID, &amp;rv));</span>
<a href="#l25.926"></a><span id="l25.926" class="difflineplus">+  nsCOMPtr&lt;nsIMsgCompose&gt; pMsgCompose(</span>
<a href="#l25.927"></a><span id="l25.927" class="difflineplus">+      do_CreateInstance(NS_MSGCOMPOSE_CONTRACTID, &amp;rv));</span>
<a href="#l25.928"></a><span id="l25.928">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.929"></a><span id="l25.929"> </span>
<a href="#l25.930"></a><span id="l25.930" class="difflineminus">-  /** initialize nsIMsgCompose, Send the message, wait for send completion response **/</span>
<a href="#l25.931"></a><span id="l25.931" class="difflineplus">+  /** initialize nsIMsgCompose, Send the message, wait for send completion</span>
<a href="#l25.932"></a><span id="l25.932" class="difflineplus">+   * response **/</span>
<a href="#l25.933"></a><span id="l25.933"> </span>
<a href="#l25.934"></a><span id="l25.934">   rv = pMsgCompose-&gt;Initialize(pMsgComposeParams, parentWindow, nullptr);</span>
<a href="#l25.935"></a><span id="l25.935" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l25.936"></a><span id="l25.936" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.937"></a><span id="l25.937"> </span>
<a href="#l25.938"></a><span id="l25.938" class="difflineminus">-  return pMsgCompose-&gt;SendMsg(nsIMsgSend::nsMsgDeliverNow, mIdentity, nullptr, nullptr, nullptr) ;</span>
<a href="#l25.939"></a><span id="l25.939" class="difflineplus">+  return pMsgCompose-&gt;SendMsg(nsIMsgSend::nsMsgDeliverNow, mIdentity, nullptr,</span>
<a href="#l25.940"></a><span id="l25.940" class="difflineplus">+                              nullptr, nullptr);</span>
<a href="#l25.941"></a><span id="l25.941"> }</span>
<a href="#l25.942"></a><span id="l25.942"> </span>
<a href="#l25.943"></a><span id="l25.943"> NS_IMETHODIMP</span>
<a href="#l25.944"></a><span id="l25.944" class="difflineminus">-nsMsgTemplateReplyHelper::OnStartRequest(nsIRequest* request)</span>
<a href="#l25.945"></a><span id="l25.945" class="difflineminus">-{</span>
<a href="#l25.946"></a><span id="l25.946" class="difflineminus">-  return NS_OK;</span>
<a href="#l25.947"></a><span id="l25.947" class="difflineminus">-}</span>
<a href="#l25.948"></a><span id="l25.948" class="difflineplus">+nsMsgTemplateReplyHelper::OnStartRequest(nsIRequest *request) { return NS_OK; }</span>
<a href="#l25.949"></a><span id="l25.949"> </span>
<a href="#l25.950"></a><span id="l25.950"> NS_IMETHODIMP</span>
<a href="#l25.951"></a><span id="l25.951" class="difflineminus">-nsMsgTemplateReplyHelper::OnStopRequest(nsIRequest* request, nsresult status)</span>
<a href="#l25.952"></a><span id="l25.952" class="difflineminus">-{</span>
<a href="#l25.953"></a><span id="l25.953" class="difflineminus">-  if (NS_SUCCEEDED(status))</span>
<a href="#l25.954"></a><span id="l25.954" class="difflineminus">-  {</span>
<a href="#l25.955"></a><span id="l25.955" class="difflineplus">+nsMsgTemplateReplyHelper::OnStopRequest(nsIRequest *request, nsresult status) {</span>
<a href="#l25.956"></a><span id="l25.956" class="difflineplus">+  if (NS_SUCCEEDED(status)) {</span>
<a href="#l25.957"></a><span id="l25.957">     // now we've got the message body in mTemplateBody -</span>
<a href="#l25.958"></a><span id="l25.958">     // need to set body in compose params and send the reply.</span>
<a href="#l25.959"></a><span id="l25.959">   }</span>
<a href="#l25.960"></a><span id="l25.960">   return NS_OK;</span>
<a href="#l25.961"></a><span id="l25.961"> }</span>
<a href="#l25.962"></a><span id="l25.962"> </span>
<a href="#l25.963"></a><span id="l25.963"> NS_IMETHODIMP</span>
<a href="#l25.964"></a><span id="l25.964" class="difflineminus">-nsMsgTemplateReplyHelper::OnDataAvailable(nsIRequest* request,</span>
<a href="#l25.965"></a><span id="l25.965" class="difflineminus">-                                  nsIInputStream* inStream,</span>
<a href="#l25.966"></a><span id="l25.966" class="difflineminus">-                                  uint64_t srcOffset,</span>
<a href="#l25.967"></a><span id="l25.967" class="difflineminus">-                                  uint32_t count)</span>
<a href="#l25.968"></a><span id="l25.968" class="difflineminus">-{</span>
<a href="#l25.969"></a><span id="l25.969" class="difflineplus">+nsMsgTemplateReplyHelper::OnDataAvailable(nsIRequest *request,</span>
<a href="#l25.970"></a><span id="l25.970" class="difflineplus">+                                          nsIInputStream *inStream,</span>
<a href="#l25.971"></a><span id="l25.971" class="difflineplus">+                                          uint64_t srcOffset, uint32_t count) {</span>
<a href="#l25.972"></a><span id="l25.972">   nsresult rv = NS_OK;</span>
<a href="#l25.973"></a><span id="l25.973"> </span>
<a href="#l25.974"></a><span id="l25.974">   char readBuf[1024];</span>
<a href="#l25.975"></a><span id="l25.975"> </span>
<a href="#l25.976"></a><span id="l25.976">   uint64_t available;</span>
<a href="#l25.977"></a><span id="l25.977">   uint32_t readCount;</span>
<a href="#l25.978"></a><span id="l25.978">   uint32_t maxReadCount = sizeof(readBuf) - 1;</span>
<a href="#l25.979"></a><span id="l25.979"> </span>
<a href="#l25.980"></a><span id="l25.980">   rv = inStream-&gt;Available(&amp;available);</span>
<a href="#l25.981"></a><span id="l25.981" class="difflineminus">-  while (NS_SUCCEEDED(rv) &amp;&amp; available &gt; 0)</span>
<a href="#l25.982"></a><span id="l25.982" class="difflineminus">-  {</span>
<a href="#l25.983"></a><span id="l25.983" class="difflineplus">+  while (NS_SUCCEEDED(rv) &amp;&amp; available &gt; 0) {</span>
<a href="#l25.984"></a><span id="l25.984">     uint32_t bodyOffset = 0, readOffset = 0;</span>
<a href="#l25.985"></a><span id="l25.985" class="difflineminus">-    if (!mInMsgBody &amp;&amp; mLastBlockChars[0])</span>
<a href="#l25.986"></a><span id="l25.986" class="difflineminus">-    {</span>
<a href="#l25.987"></a><span id="l25.987" class="difflineplus">+    if (!mInMsgBody &amp;&amp; mLastBlockChars[0]) {</span>
<a href="#l25.988"></a><span id="l25.988">       memcpy(readBuf, mLastBlockChars, 3);</span>
<a href="#l25.989"></a><span id="l25.989">       readOffset = 3;</span>
<a href="#l25.990"></a><span id="l25.990">       maxReadCount -= 3;</span>
<a href="#l25.991"></a><span id="l25.991">     }</span>
<a href="#l25.992"></a><span id="l25.992" class="difflineminus">-    if (maxReadCount &gt; available)</span>
<a href="#l25.993"></a><span id="l25.993" class="difflineminus">-      maxReadCount = (uint32_t)available;</span>
<a href="#l25.994"></a><span id="l25.994" class="difflineplus">+    if (maxReadCount &gt; available) maxReadCount = (uint32_t)available;</span>
<a href="#l25.995"></a><span id="l25.995">     memset(readBuf, 0, sizeof(readBuf));</span>
<a href="#l25.996"></a><span id="l25.996">     rv = inStream-&gt;Read(readBuf + readOffset, maxReadCount, &amp;readCount);</span>
<a href="#l25.997"></a><span id="l25.997">     available -= readCount;</span>
<a href="#l25.998"></a><span id="l25.998">     readCount += readOffset;</span>
<a href="#l25.999"></a><span id="l25.999">     // we're mainly interested in the msg body, so we need to</span>
<a href="#l25.1000"></a><span id="l25.1000">     // find the header/body delimiter of a blank line. A blank line</span>
<a href="#l25.1001"></a><span id="l25.1001">     // looks like &lt;CR&gt;&lt;CR&gt;, &lt;LF&gt;&lt;LF&gt;, or &lt;CRLF&gt;&lt;CRLF&gt;</span>
<a href="#l25.1002"></a><span id="l25.1002" class="difflineminus">-    if (!mInMsgBody)</span>
<a href="#l25.1003"></a><span id="l25.1003" class="difflineminus">-    {</span>
<a href="#l25.1004"></a><span id="l25.1004" class="difflineminus">-      for (uint32_t charIndex = 0; charIndex &lt; readCount &amp;&amp; !bodyOffset; charIndex++)</span>
<a href="#l25.1005"></a><span id="l25.1005" class="difflineminus">-      {</span>
<a href="#l25.1006"></a><span id="l25.1006" class="difflineminus">-        if (readBuf[charIndex] == '\r' || readBuf[charIndex] == '\n')</span>
<a href="#l25.1007"></a><span id="l25.1007" class="difflineminus">-        {</span>
<a href="#l25.1008"></a><span id="l25.1008" class="difflineminus">-          if (charIndex + 1 &lt; readCount)</span>
<a href="#l25.1009"></a><span id="l25.1009" class="difflineminus">-          {</span>
<a href="#l25.1010"></a><span id="l25.1010" class="difflineminus">-            if (readBuf[charIndex] == readBuf[charIndex + 1])</span>
<a href="#l25.1011"></a><span id="l25.1011" class="difflineminus">-            {</span>
<a href="#l25.1012"></a><span id="l25.1012" class="difflineminus">-            // got header+body separator</span>
<a href="#l25.1013"></a><span id="l25.1013" class="difflineplus">+    if (!mInMsgBody) {</span>
<a href="#l25.1014"></a><span id="l25.1014" class="difflineplus">+      for (uint32_t charIndex = 0; charIndex &lt; readCount &amp;&amp; !bodyOffset;</span>
<a href="#l25.1015"></a><span id="l25.1015" class="difflineplus">+           charIndex++) {</span>
<a href="#l25.1016"></a><span id="l25.1016" class="difflineplus">+        if (readBuf[charIndex] == '\r' || readBuf[charIndex] == '\n') {</span>
<a href="#l25.1017"></a><span id="l25.1017" class="difflineplus">+          if (charIndex + 1 &lt; readCount) {</span>
<a href="#l25.1018"></a><span id="l25.1018" class="difflineplus">+            if (readBuf[charIndex] == readBuf[charIndex + 1]) {</span>
<a href="#l25.1019"></a><span id="l25.1019" class="difflineplus">+              // got header+body separator</span>
<a href="#l25.1020"></a><span id="l25.1020">               bodyOffset = charIndex + 2;</span>
<a href="#l25.1021"></a><span id="l25.1021">               break;</span>
<a href="#l25.1022"></a><span id="l25.1022" class="difflineminus">-            }</span>
<a href="#l25.1023"></a><span id="l25.1023" class="difflineminus">-            else if ((charIndex + 3 &lt; readCount) &amp;&amp; !strncmp(readBuf + charIndex, &quot;\r\n\r\n&quot;, 4))</span>
<a href="#l25.1024"></a><span id="l25.1024" class="difflineminus">-            {</span>
<a href="#l25.1025"></a><span id="l25.1025" class="difflineplus">+            } else if ((charIndex + 3 &lt; readCount) &amp;&amp;</span>
<a href="#l25.1026"></a><span id="l25.1026" class="difflineplus">+                       !strncmp(readBuf + charIndex, &quot;\r\n\r\n&quot;, 4)) {</span>
<a href="#l25.1027"></a><span id="l25.1027">               bodyOffset = charIndex + 4;</span>
<a href="#l25.1028"></a><span id="l25.1028">               break;</span>
<a href="#l25.1029"></a><span id="l25.1029">             }</span>
<a href="#l25.1030"></a><span id="l25.1030">           }</span>
<a href="#l25.1031"></a><span id="l25.1031">         }</span>
<a href="#l25.1032"></a><span id="l25.1032">       }</span>
<a href="#l25.1033"></a><span id="l25.1033">       mInMsgBody = bodyOffset != 0;</span>
<a href="#l25.1034"></a><span id="l25.1034" class="difflineminus">-      if (!mInMsgBody &amp;&amp; readCount &gt; 3) // still in msg hdrs</span>
<a href="#l25.1035"></a><span id="l25.1035" class="difflineplus">+      if (!mInMsgBody &amp;&amp; readCount &gt; 3)  // still in msg hdrs</span>
<a href="#l25.1036"></a><span id="l25.1036">         strncpy(mLastBlockChars, readBuf + readCount - 3, 3);</span>
<a href="#l25.1037"></a><span id="l25.1037">     }</span>
<a href="#l25.1038"></a><span id="l25.1038">     mTemplateBody.Append(readBuf + bodyOffset);</span>
<a href="#l25.1039"></a><span id="l25.1039">   }</span>
<a href="#l25.1040"></a><span id="l25.1040">   return NS_OK;</span>
<a href="#l25.1041"></a><span id="l25.1041"> }</span>
<a href="#l25.1042"></a><span id="l25.1042"> </span>
<a href="#l25.1043"></a><span id="l25.1043" class="difflineminus">-</span>
<a href="#l25.1044"></a><span id="l25.1044" class="difflineminus">-NS_IMETHODIMP nsMsgComposeService::ReplyWithTemplate(nsIMsgDBHdr *aMsgHdr, const char *templateUri,</span>
<a href="#l25.1045"></a><span id="l25.1045" class="difflineminus">-                                             nsIMsgWindow *aMsgWindow, nsIMsgIncomingServer *aServer)</span>
<a href="#l25.1046"></a><span id="l25.1046" class="difflineminus">-{</span>
<a href="#l25.1047"></a><span id="l25.1047" class="difflineplus">+NS_IMETHODIMP nsMsgComposeService::ReplyWithTemplate(</span>
<a href="#l25.1048"></a><span id="l25.1048" class="difflineplus">+    nsIMsgDBHdr *aMsgHdr, const char *templateUri, nsIMsgWindow *aMsgWindow,</span>
<a href="#l25.1049"></a><span id="l25.1049" class="difflineplus">+    nsIMsgIncomingServer *aServer) {</span>
<a href="#l25.1050"></a><span id="l25.1050">   // To reply with template, we need the message body of the template.</span>
<a href="#l25.1051"></a><span id="l25.1051">   // I think we're going to need to stream the template message to ourselves,</span>
<a href="#l25.1052"></a><span id="l25.1052">   // and construct the body, and call setBody on the compFields.</span>
<a href="#l25.1053"></a><span id="l25.1053">   nsresult rv;</span>
<a href="#l25.1054"></a><span id="l25.1054" class="difflineminus">-  nsCOMPtr &lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l25.1055"></a><span id="l25.1055" class="difflineminus">-    do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l25.1056"></a><span id="l25.1056" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l25.1057"></a><span id="l25.1057" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l25.1058"></a><span id="l25.1058">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.1059"></a><span id="l25.1059"> </span>
<a href="#l25.1060"></a><span id="l25.1060">   nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l25.1061"></a><span id="l25.1061">   rv = accountManager-&gt;FindAccountForServer(aServer, getter_AddRefs(account));</span>
<a href="#l25.1062"></a><span id="l25.1062">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.1063"></a><span id="l25.1063"> </span>
<a href="#l25.1064"></a><span id="l25.1064">   nsCOMPtr&lt;nsIArray&gt; identities;</span>
<a href="#l25.1065"></a><span id="l25.1065">   rv = account-&gt;GetIdentities(getter_AddRefs(identities));</span>
<a href="#l25.1066"></a><span id="l25.1066" class="difflineat">@@ -878,266 +832,268 @@ NS_IMETHODIMP nsMsgComposeService::Reply</span>
<a href="#l25.1067"></a><span id="l25.1067">   aMsgHdr-&gt;GetRecipients(getter_Copies(recipients));</span>
<a href="#l25.1068"></a><span id="l25.1068"> </span>
<a href="#l25.1069"></a><span id="l25.1069">   nsAutoCString ccList;</span>
<a href="#l25.1070"></a><span id="l25.1070">   aMsgHdr-&gt;GetCcList(getter_Copies(ccList));</span>
<a href="#l25.1071"></a><span id="l25.1071"> </span>
<a href="#l25.1072"></a><span id="l25.1072">   // Go through the identities to see to whom this was addressed.</span>
<a href="#l25.1073"></a><span id="l25.1073">   // In case we get no match, this is likely a list/bulk/bcc/spam mail and we</span>
<a href="#l25.1074"></a><span id="l25.1074">   // shouldn't reply. RFC 3834 2.</span>
<a href="#l25.1075"></a><span id="l25.1075" class="difflineminus">-  nsCOMPtr&lt;nsIMsgIdentity&gt; identity; // identity to reply from</span>
<a href="#l25.1076"></a><span id="l25.1076" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIdentity&gt; identity;  // identity to reply from</span>
<a href="#l25.1077"></a><span id="l25.1077">   uint32_t count = 0;</span>
<a href="#l25.1078"></a><span id="l25.1078">   identities-&gt;GetLength(&amp;count);</span>
<a href="#l25.1079"></a><span id="l25.1079" class="difflineminus">-  for (uint32_t i = 0; i &lt; count; i++)</span>
<a href="#l25.1080"></a><span id="l25.1080" class="difflineminus">-  {</span>
<a href="#l25.1081"></a><span id="l25.1081" class="difflineplus">+  for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l25.1082"></a><span id="l25.1082">     nsCOMPtr&lt;nsIMsgIdentity&gt; anIdentity(do_QueryElementAt(identities, i, &amp;rv));</span>
<a href="#l25.1083"></a><span id="l25.1083">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.1084"></a><span id="l25.1084"> </span>
<a href="#l25.1085"></a><span id="l25.1085">     nsAutoCString identityEmail;</span>
<a href="#l25.1086"></a><span id="l25.1086">     anIdentity-&gt;GetEmail(identityEmail);</span>
<a href="#l25.1087"></a><span id="l25.1087"> </span>
<a href="#l25.1088"></a><span id="l25.1088">     if (recipients.Find(identityEmail, /* ignoreCase = */ true) != kNotFound ||</span>
<a href="#l25.1089"></a><span id="l25.1089" class="difflineminus">-        ccList.Find(identityEmail, /* ignoreCase = */ true) != kNotFound)</span>
<a href="#l25.1090"></a><span id="l25.1090" class="difflineminus">-    {</span>
<a href="#l25.1091"></a><span id="l25.1091" class="difflineplus">+        ccList.Find(identityEmail, /* ignoreCase = */ true) != kNotFound) {</span>
<a href="#l25.1092"></a><span id="l25.1092">       identity = anIdentity;</span>
<a href="#l25.1093"></a><span id="l25.1093">       break;</span>
<a href="#l25.1094"></a><span id="l25.1094">     }</span>
<a href="#l25.1095"></a><span id="l25.1095">   }</span>
<a href="#l25.1096"></a><span id="l25.1096" class="difflineminus">-  if (!identity) // Found no match -&gt; don't reply.</span>
<a href="#l25.1097"></a><span id="l25.1097" class="difflineplus">+  if (!identity)  // Found no match -&gt; don't reply.</span>
<a href="#l25.1098"></a><span id="l25.1098">     return NS_ERROR_ABORT;</span>
<a href="#l25.1099"></a><span id="l25.1099"> </span>
<a href="#l25.1100"></a><span id="l25.1100">   RefPtr&lt;nsMsgTemplateReplyHelper&gt; helper = new nsMsgTemplateReplyHelper;</span>
<a href="#l25.1101"></a><span id="l25.1101"> </span>
<a href="#l25.1102"></a><span id="l25.1102">   helper-&gt;mHdrToReplyTo = aMsgHdr;</span>
<a href="#l25.1103"></a><span id="l25.1103">   helper-&gt;mMsgWindow = aMsgWindow;</span>
<a href="#l25.1104"></a><span id="l25.1104">   helper-&gt;mIdentity = identity;</span>
<a href="#l25.1105"></a><span id="l25.1105"> </span>
<a href="#l25.1106"></a><span id="l25.1106">   nsAutoCString replyTo;</span>
<a href="#l25.1107"></a><span id="l25.1107">   aMsgHdr-&gt;GetStringProperty(&quot;replyTo&quot;, getter_Copies(replyTo));</span>
<a href="#l25.1108"></a><span id="l25.1108" class="difflineminus">-  if (replyTo.IsEmpty())</span>
<a href="#l25.1109"></a><span id="l25.1109" class="difflineminus">-    aMsgHdr-&gt;GetAuthor(getter_Copies(replyTo));</span>
<a href="#l25.1110"></a><span id="l25.1110" class="difflineminus">-  if (replyTo.IsEmpty())</span>
<a href="#l25.1111"></a><span id="l25.1111" class="difflineminus">-    return NS_ERROR_FAILURE; // nowhere to send the reply</span>
<a href="#l25.1112"></a><span id="l25.1112" class="difflineplus">+  if (replyTo.IsEmpty()) aMsgHdr-&gt;GetAuthor(getter_Copies(replyTo));</span>
<a href="#l25.1113"></a><span id="l25.1113" class="difflineplus">+  if (replyTo.IsEmpty()) return NS_ERROR_FAILURE;  // nowhere to send the reply</span>
<a href="#l25.1114"></a><span id="l25.1114"> </span>
<a href="#l25.1115"></a><span id="l25.1115" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; templateFolder;</span>
<a href="#l25.1116"></a><span id="l25.1116" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDatabase&gt; templateDB;</span>
<a href="#l25.1117"></a><span id="l25.1117" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; templateFolder;</span>
<a href="#l25.1118"></a><span id="l25.1118" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; templateDB;</span>
<a href="#l25.1119"></a><span id="l25.1119">   nsCString templateMsgHdrUri;</span>
<a href="#l25.1120"></a><span id="l25.1120" class="difflineminus">-  const char * query = PL_strstr(templateUri, &quot;?messageId=&quot;);</span>
<a href="#l25.1121"></a><span id="l25.1121" class="difflineminus">-  if (!query)</span>
<a href="#l25.1122"></a><span id="l25.1122" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l25.1123"></a><span id="l25.1123" class="difflineplus">+  const char *query = PL_strstr(templateUri, &quot;?messageId=&quot;);</span>
<a href="#l25.1124"></a><span id="l25.1124" class="difflineplus">+  if (!query) return NS_ERROR_FAILURE;</span>
<a href="#l25.1125"></a><span id="l25.1125"> </span>
<a href="#l25.1126"></a><span id="l25.1126">   nsAutoCString folderUri(Substring(templateUri, query));</span>
<a href="#l25.1127"></a><span id="l25.1127">   rv = GetExistingFolder(folderUri, getter_AddRefs(templateFolder));</span>
<a href="#l25.1128"></a><span id="l25.1128">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.1129"></a><span id="l25.1129">   rv = templateFolder-&gt;GetMsgDatabase(getter_AddRefs(templateDB));</span>
<a href="#l25.1130"></a><span id="l25.1130">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.1131"></a><span id="l25.1131"> </span>
<a href="#l25.1132"></a><span id="l25.1132">   const char *subject = PL_strstr(templateUri, &quot;&amp;subject=&quot;);</span>
<a href="#l25.1133"></a><span id="l25.1133" class="difflineminus">-  if (subject)</span>
<a href="#l25.1134"></a><span id="l25.1134" class="difflineminus">-  {</span>
<a href="#l25.1135"></a><span id="l25.1135" class="difflineplus">+  if (subject) {</span>
<a href="#l25.1136"></a><span id="l25.1136">     const char *subjectEnd = subject + strlen(subject);</span>
<a href="#l25.1137"></a><span id="l25.1137">     nsAutoCString messageId(Substring(query + 11, subject));</span>
<a href="#l25.1138"></a><span id="l25.1138">     nsAutoCString subjectString(Substring(subject + 9, subjectEnd));</span>
<a href="#l25.1139"></a><span id="l25.1139" class="difflineminus">-    templateDB-&gt;GetMsgHdrForMessageID(messageId.get(), getter_AddRefs(helper-&gt;mTemplateHdr));</span>
<a href="#l25.1140"></a><span id="l25.1140" class="difflineplus">+    templateDB-&gt;GetMsgHdrForMessageID(messageId.get(),</span>
<a href="#l25.1141"></a><span id="l25.1141" class="difflineplus">+                                      getter_AddRefs(helper-&gt;mTemplateHdr));</span>
<a href="#l25.1142"></a><span id="l25.1142">     if (helper-&gt;mTemplateHdr)</span>
<a href="#l25.1143"></a><span id="l25.1143">       templateFolder-&gt;GetUriForMsg(helper-&gt;mTemplateHdr, templateMsgHdrUri);</span>
<a href="#l25.1144"></a><span id="l25.1144" class="difflineminus">-    // to use the subject, we'd need to expose a method to find a message by subject,</span>
<a href="#l25.1145"></a><span id="l25.1145" class="difflineminus">-    // or painfully iterate through messages...We'll try to make the message-id</span>
<a href="#l25.1146"></a><span id="l25.1146" class="difflineminus">-    // not change when saving a template first.</span>
<a href="#l25.1147"></a><span id="l25.1147" class="difflineplus">+    // to use the subject, we'd need to expose a method to find a message by</span>
<a href="#l25.1148"></a><span id="l25.1148" class="difflineplus">+    // subject, or painfully iterate through messages...We'll try to make the</span>
<a href="#l25.1149"></a><span id="l25.1149" class="difflineplus">+    // message-id not change when saving a template first.</span>
<a href="#l25.1150"></a><span id="l25.1150">   }</span>
<a href="#l25.1151"></a><span id="l25.1151" class="difflineminus">-  if (templateMsgHdrUri.IsEmpty())</span>
<a href="#l25.1152"></a><span id="l25.1152" class="difflineminus">-  {</span>
<a href="#l25.1153"></a><span id="l25.1153" class="difflineplus">+  if (templateMsgHdrUri.IsEmpty()) {</span>
<a href="#l25.1154"></a><span id="l25.1154">     // ### probably want to return a specific error and</span>
<a href="#l25.1155"></a><span id="l25.1155">     // have the calling code disable the filter.</span>
<a href="#l25.1156"></a><span id="l25.1156">     NS_ASSERTION(false, &quot;failed to get msg hdr&quot;);</span>
<a href="#l25.1157"></a><span id="l25.1157">     return NS_ERROR_FAILURE;</span>
<a href="#l25.1158"></a><span id="l25.1158">   }</span>
<a href="#l25.1159"></a><span id="l25.1159">   // we need to convert the template uri, which is of the form</span>
<a href="#l25.1160"></a><span id="l25.1160">   // &lt;folder uri&gt;?messageId=&lt;messageId&gt;&amp;subject=&lt;subject&gt;</span>
<a href="#l25.1161"></a><span id="l25.1161" class="difflineminus">-  nsCOMPtr &lt;nsIMsgMessageService&gt; msgService;</span>
<a href="#l25.1162"></a><span id="l25.1162" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMessageService&gt; msgService;</span>
<a href="#l25.1163"></a><span id="l25.1163">   rv = GetMessageServiceFromURI(templateMsgHdrUri, getter_AddRefs(msgService));</span>
<a href="#l25.1164"></a><span id="l25.1164">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.1165"></a><span id="l25.1165"> </span>
<a href="#l25.1166"></a><span id="l25.1166">   nsCOMPtr&lt;nsISupports&gt; listenerSupports;</span>
<a href="#l25.1167"></a><span id="l25.1167" class="difflineminus">-  helper-&gt;QueryInterface(NS_GET_IID(nsISupports), getter_AddRefs(listenerSupports));</span>
<a href="#l25.1168"></a><span id="l25.1168" class="difflineplus">+  helper-&gt;QueryInterface(NS_GET_IID(nsISupports),</span>
<a href="#l25.1169"></a><span id="l25.1169" class="difflineplus">+                         getter_AddRefs(listenerSupports));</span>
<a href="#l25.1170"></a><span id="l25.1170"> </span>
<a href="#l25.1171"></a><span id="l25.1171">   nsCOMPtr&lt;nsIURI&gt; dummyNull;</span>
<a href="#l25.1172"></a><span id="l25.1172" class="difflineminus">-  rv = msgService-&gt;StreamMessage(templateMsgHdrUri.get(), listenerSupports,</span>
<a href="#l25.1173"></a><span id="l25.1173" class="difflineminus">-                                 aMsgWindow, helper,</span>
<a href="#l25.1174"></a><span id="l25.1174" class="difflineminus">-                                 false, // convert data</span>
<a href="#l25.1175"></a><span id="l25.1175" class="difflineminus">-                                 EmptyCString(), false, getter_AddRefs(dummyNull));</span>
<a href="#l25.1176"></a><span id="l25.1176" class="difflineplus">+  rv = msgService-&gt;StreamMessage(</span>
<a href="#l25.1177"></a><span id="l25.1177" class="difflineplus">+      templateMsgHdrUri.get(), listenerSupports, aMsgWindow, helper,</span>
<a href="#l25.1178"></a><span id="l25.1178" class="difflineplus">+      false,  // convert data</span>
<a href="#l25.1179"></a><span id="l25.1179" class="difflineplus">+      EmptyCString(), false, getter_AddRefs(dummyNull));</span>
<a href="#l25.1180"></a><span id="l25.1180">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.1181"></a><span id="l25.1181"> </span>
<a href="#l25.1182"></a><span id="l25.1182">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l25.1183"></a><span id="l25.1183">   aMsgHdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l25.1184"></a><span id="l25.1184" class="difflineminus">-  if (!folder)</span>
<a href="#l25.1185"></a><span id="l25.1185" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l25.1186"></a><span id="l25.1186" class="difflineplus">+  if (!folder) return NS_ERROR_NULL_POINTER;</span>
<a href="#l25.1187"></a><span id="l25.1187"> </span>
<a href="#l25.1188"></a><span id="l25.1188">   // We're sending a new message. Conceptually it's a reply though, so mark the</span>
<a href="#l25.1189"></a><span id="l25.1189">   // original message as replied.</span>
<a href="#l25.1190"></a><span id="l25.1190" class="difflineminus">-  return folder-&gt;AddMessageDispositionState(aMsgHdr, nsIMsgFolder::nsMsgDispositionState_Replied);</span>
<a href="#l25.1191"></a><span id="l25.1191" class="difflineplus">+  return folder-&gt;AddMessageDispositionState(</span>
<a href="#l25.1192"></a><span id="l25.1192" class="difflineplus">+      aMsgHdr, nsIMsgFolder::nsMsgDispositionState_Replied);</span>
<a href="#l25.1193"></a><span id="l25.1193"> }</span>
<a href="#l25.1194"></a><span id="l25.1194"> </span>
<a href="#l25.1195"></a><span id="l25.1195"> NS_IMETHODIMP</span>
<a href="#l25.1196"></a><span id="l25.1196"> nsMsgComposeService::ForwardMessage(const nsAString &amp;forwardTo,</span>
<a href="#l25.1197"></a><span id="l25.1197">                                     nsIMsgDBHdr *aMsgHdr,</span>
<a href="#l25.1198"></a><span id="l25.1198">                                     nsIMsgWindow *aMsgWindow,</span>
<a href="#l25.1199"></a><span id="l25.1199">                                     nsIMsgIncomingServer *aServer,</span>
<a href="#l25.1200"></a><span id="l25.1200" class="difflineminus">-                                    uint32_t aForwardType)</span>
<a href="#l25.1201"></a><span id="l25.1201" class="difflineminus">-{</span>
<a href="#l25.1202"></a><span id="l25.1202" class="difflineplus">+                                    uint32_t aForwardType) {</span>
<a href="#l25.1203"></a><span id="l25.1203">   NS_ENSURE_ARG_POINTER(aMsgHdr);</span>
<a href="#l25.1204"></a><span id="l25.1204"> </span>
<a href="#l25.1205"></a><span id="l25.1205">   nsresult rv;</span>
<a href="#l25.1206"></a><span id="l25.1206" class="difflineminus">-  if (aForwardType == nsIMsgComposeService::kForwardAsDefault)</span>
<a href="#l25.1207"></a><span id="l25.1207" class="difflineminus">-  {</span>
<a href="#l25.1208"></a><span id="l25.1208" class="difflineplus">+  if (aForwardType == nsIMsgComposeService::kForwardAsDefault) {</span>
<a href="#l25.1209"></a><span id="l25.1209">     int32_t forwardPref = 0;</span>
<a href="#l25.1210"></a><span id="l25.1210" class="difflineminus">-    nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l25.1211"></a><span id="l25.1211" class="difflineplus">+    nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(</span>
<a href="#l25.1212"></a><span id="l25.1212" class="difflineplus">+        do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l25.1213"></a><span id="l25.1213">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.1214"></a><span id="l25.1214">     prefBranch-&gt;GetIntPref(&quot;mail.forward_message_mode&quot;, &amp;forwardPref);</span>
<a href="#l25.1215"></a><span id="l25.1215">     // 0=default as attachment 2=forward as inline with attachments,</span>
<a href="#l25.1216"></a><span id="l25.1216">     // (obsolete 4.x value)1=forward as quoted (mapped to 2 in mozilla)</span>
<a href="#l25.1217"></a><span id="l25.1217" class="difflineminus">-    aForwardType = forwardPref == 0 ? nsIMsgComposeService::kForwardAsAttachment :</span>
<a href="#l25.1218"></a><span id="l25.1218" class="difflineminus">-                                      nsIMsgComposeService::kForwardInline;</span>
<a href="#l25.1219"></a><span id="l25.1219" class="difflineplus">+    aForwardType = forwardPref == 0 ? nsIMsgComposeService::kForwardAsAttachment</span>
<a href="#l25.1220"></a><span id="l25.1220" class="difflineplus">+                                    : nsIMsgComposeService::kForwardInline;</span>
<a href="#l25.1221"></a><span id="l25.1221">   }</span>
<a href="#l25.1222"></a><span id="l25.1222">   nsCString msgUri;</span>
<a href="#l25.1223"></a><span id="l25.1223"> </span>
<a href="#l25.1224"></a><span id="l25.1224">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l25.1225"></a><span id="l25.1225">   aMsgHdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l25.1226"></a><span id="l25.1226">   NS_ENSURE_TRUE(folder, NS_ERROR_NULL_POINTER);</span>
<a href="#l25.1227"></a><span id="l25.1227"> </span>
<a href="#l25.1228"></a><span id="l25.1228">   folder-&gt;GetUriForMsg(aMsgHdr, msgUri);</span>
<a href="#l25.1229"></a><span id="l25.1229"> </span>
<a href="#l25.1230"></a><span id="l25.1230">   nsAutoCString uriToOpen(msgUri);</span>
<a href="#l25.1231"></a><span id="l25.1231">   uriToOpen += (uriToOpen.FindChar('?') == kNotFound) ? '?' : '&amp;';</span>
<a href="#l25.1232"></a><span id="l25.1232">   uriToOpen.AppendLiteral(&quot;fetchCompleteMessage=true&quot;);</span>
<a href="#l25.1233"></a><span id="l25.1233"> </span>
<a href="#l25.1234"></a><span id="l25.1234">   // get the MsgIdentity for the above key using AccountManager</span>
<a href="#l25.1235"></a><span id="l25.1235">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l25.1236"></a><span id="l25.1236" class="difflineminus">-    do_GetService (NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l25.1237"></a><span id="l25.1237" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l25.1238"></a><span id="l25.1238">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.1239"></a><span id="l25.1239"> </span>
<a href="#l25.1240"></a><span id="l25.1240">   nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l25.1241"></a><span id="l25.1241">   nsCOMPtr&lt;nsIMsgIdentity&gt; identity;</span>
<a href="#l25.1242"></a><span id="l25.1242"> </span>
<a href="#l25.1243"></a><span id="l25.1243">   rv = accountManager-&gt;FindAccountForServer(aServer, getter_AddRefs(account));</span>
<a href="#l25.1244"></a><span id="l25.1244">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.1245"></a><span id="l25.1245">   rv = account-&gt;GetDefaultIdentity(getter_AddRefs(identity));</span>
<a href="#l25.1246"></a><span id="l25.1246">   // Use default identity if no identity has been found on this account</span>
<a href="#l25.1247"></a><span id="l25.1247" class="difflineminus">-  if (NS_FAILED(rv) || !identity)</span>
<a href="#l25.1248"></a><span id="l25.1248" class="difflineminus">-  {</span>
<a href="#l25.1249"></a><span id="l25.1249" class="difflineplus">+  if (NS_FAILED(rv) || !identity) {</span>
<a href="#l25.1250"></a><span id="l25.1250">     rv = GetDefaultIdentity(getter_AddRefs(identity));</span>
<a href="#l25.1251"></a><span id="l25.1251">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.1252"></a><span id="l25.1252">   }</span>
<a href="#l25.1253"></a><span id="l25.1253"> </span>
<a href="#l25.1254"></a><span id="l25.1254">   if (aForwardType == nsIMsgComposeService::kForwardInline)</span>
<a href="#l25.1255"></a><span id="l25.1255" class="difflineminus">-    return RunMessageThroughMimeDraft(uriToOpen,</span>
<a href="#l25.1256"></a><span id="l25.1256" class="difflineminus">-                                      nsMimeOutput::nsMimeMessageDraftOrTemplate,</span>
<a href="#l25.1257"></a><span id="l25.1257" class="difflineminus">-                                      identity,</span>
<a href="#l25.1258"></a><span id="l25.1258" class="difflineminus">-                                      uriToOpen.get(), aMsgHdr,</span>
<a href="#l25.1259"></a><span id="l25.1259" class="difflineminus">-                                      true, forwardTo,</span>
<a href="#l25.1260"></a><span id="l25.1260" class="difflineminus">-                                      false, aMsgWindow);</span>
<a href="#l25.1261"></a><span id="l25.1261" class="difflineplus">+    return RunMessageThroughMimeDraft(</span>
<a href="#l25.1262"></a><span id="l25.1262" class="difflineplus">+        uriToOpen, nsMimeOutput::nsMimeMessageDraftOrTemplate, identity,</span>
<a href="#l25.1263"></a><span id="l25.1263" class="difflineplus">+        uriToOpen.get(), aMsgHdr, true, forwardTo, false, aMsgWindow);</span>
<a href="#l25.1264"></a><span id="l25.1264"> </span>
<a href="#l25.1265"></a><span id="l25.1265">   nsCOMPtr&lt;mozIDOMWindowProxy&gt; parentWindow;</span>
<a href="#l25.1266"></a><span id="l25.1266" class="difflineminus">-  if (aMsgWindow)</span>
<a href="#l25.1267"></a><span id="l25.1267" class="difflineminus">-  {</span>
<a href="#l25.1268"></a><span id="l25.1268" class="difflineplus">+  if (aMsgWindow) {</span>
<a href="#l25.1269"></a><span id="l25.1269">     nsCOMPtr&lt;nsIDocShell&gt; docShell;</span>
<a href="#l25.1270"></a><span id="l25.1270">     rv = aMsgWindow-&gt;GetRootDocShell(getter_AddRefs(docShell));</span>
<a href="#l25.1271"></a><span id="l25.1271">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.1272"></a><span id="l25.1272">     parentWindow = do_GetInterface(docShell);</span>
<a href="#l25.1273"></a><span id="l25.1273">     NS_ENSURE_TRUE(parentWindow, NS_ERROR_FAILURE);</span>
<a href="#l25.1274"></a><span id="l25.1274">   }</span>
<a href="#l25.1275"></a><span id="l25.1275">   // create the compose params object</span>
<a href="#l25.1276"></a><span id="l25.1276" class="difflineminus">-  nsCOMPtr&lt;nsIMsgComposeParams&gt; pMsgComposeParams (do_CreateInstance(NS_MSGCOMPOSEPARAMS_CONTRACTID, &amp;rv));</span>
<a href="#l25.1277"></a><span id="l25.1277" class="difflineplus">+  nsCOMPtr&lt;nsIMsgComposeParams&gt; pMsgComposeParams(</span>
<a href="#l25.1278"></a><span id="l25.1278" class="difflineplus">+      do_CreateInstance(NS_MSGCOMPOSEPARAMS_CONTRACTID, &amp;rv));</span>
<a href="#l25.1279"></a><span id="l25.1279">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.1280"></a><span id="l25.1280" class="difflineminus">-  nsCOMPtr&lt;nsIMsgCompFields&gt; compFields = do_CreateInstance(NS_MSGCOMPFIELDS_CONTRACTID, &amp;rv);</span>
<a href="#l25.1281"></a><span id="l25.1281" class="difflineplus">+  nsCOMPtr&lt;nsIMsgCompFields&gt; compFields =</span>
<a href="#l25.1282"></a><span id="l25.1282" class="difflineplus">+      do_CreateInstance(NS_MSGCOMPFIELDS_CONTRACTID, &amp;rv);</span>
<a href="#l25.1283"></a><span id="l25.1283"> </span>
<a href="#l25.1284"></a><span id="l25.1284">   compFields-&gt;SetTo(forwardTo);</span>
<a href="#l25.1285"></a><span id="l25.1285">   // populate the compose params</span>
<a href="#l25.1286"></a><span id="l25.1286">   pMsgComposeParams-&gt;SetType(nsIMsgCompType::ForwardAsAttachment);</span>
<a href="#l25.1287"></a><span id="l25.1287">   pMsgComposeParams-&gt;SetFormat(nsIMsgCompFormat::Default);</span>
<a href="#l25.1288"></a><span id="l25.1288">   pMsgComposeParams-&gt;SetIdentity(identity);</span>
<a href="#l25.1289"></a><span id="l25.1289">   pMsgComposeParams-&gt;SetComposeFields(compFields);</span>
<a href="#l25.1290"></a><span id="l25.1290">   pMsgComposeParams-&gt;SetOriginalMsgURI(uriToOpen.get());</span>
<a href="#l25.1291"></a><span id="l25.1291">   // create the nsIMsgCompose object to send the object</span>
<a href="#l25.1292"></a><span id="l25.1292" class="difflineminus">-  nsCOMPtr&lt;nsIMsgCompose&gt; pMsgCompose (do_CreateInstance(NS_MSGCOMPOSE_CONTRACTID, &amp;rv));</span>
<a href="#l25.1293"></a><span id="l25.1293" class="difflineplus">+  nsCOMPtr&lt;nsIMsgCompose&gt; pMsgCompose(</span>
<a href="#l25.1294"></a><span id="l25.1294" class="difflineplus">+      do_CreateInstance(NS_MSGCOMPOSE_CONTRACTID, &amp;rv));</span>
<a href="#l25.1295"></a><span id="l25.1295">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.1296"></a><span id="l25.1296"> </span>
<a href="#l25.1297"></a><span id="l25.1297" class="difflineminus">-  /** initialize nsIMsgCompose, Send the message, wait for send completion response **/</span>
<a href="#l25.1298"></a><span id="l25.1298" class="difflineplus">+  /** initialize nsIMsgCompose, Send the message, wait for send completion</span>
<a href="#l25.1299"></a><span id="l25.1299" class="difflineplus">+   * response **/</span>
<a href="#l25.1300"></a><span id="l25.1300">   rv = pMsgCompose-&gt;Initialize(pMsgComposeParams, parentWindow, nullptr);</span>
<a href="#l25.1301"></a><span id="l25.1301">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.1302"></a><span id="l25.1302"> </span>
<a href="#l25.1303"></a><span id="l25.1303" class="difflineminus">-  rv = pMsgCompose-&gt;SendMsg(nsIMsgSend::nsMsgDeliverNow, identity, nullptr, nullptr, nullptr);</span>
<a href="#l25.1304"></a><span id="l25.1304" class="difflineplus">+  rv = pMsgCompose-&gt;SendMsg(nsIMsgSend::nsMsgDeliverNow, identity, nullptr,</span>
<a href="#l25.1305"></a><span id="l25.1305" class="difflineplus">+                            nullptr, nullptr);</span>
<a href="#l25.1306"></a><span id="l25.1306">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.1307"></a><span id="l25.1307"> </span>
<a href="#l25.1308"></a><span id="l25.1308">   // nsMsgCompose::ProcessReplyFlags usually takes care of marking messages</span>
<a href="#l25.1309"></a><span id="l25.1309">   // as forwarded. ProcessReplyFlags is normally called from</span>
<a href="#l25.1310"></a><span id="l25.1310">   // nsMsgComposeSendListener::OnStopSending but for this case the msgCompose</span>
<a href="#l25.1311"></a><span id="l25.1311">   // object is not set so ProcessReplyFlags won't get called.</span>
<a href="#l25.1312"></a><span id="l25.1312">   // Therefore, let's just mark it here instead.</span>
<a href="#l25.1313"></a><span id="l25.1313" class="difflineminus">-  return folder-&gt;AddMessageDispositionState(aMsgHdr, nsIMsgFolder::nsMsgDispositionState_Forwarded);</span>
<a href="#l25.1314"></a><span id="l25.1314" class="difflineplus">+  return folder-&gt;AddMessageDispositionState(</span>
<a href="#l25.1315"></a><span id="l25.1315" class="difflineplus">+      aMsgHdr, nsIMsgFolder::nsMsgDispositionState_Forwarded);</span>
<a href="#l25.1316"></a><span id="l25.1316"> }</span>
<a href="#l25.1317"></a><span id="l25.1317"> </span>
<a href="#l25.1318"></a><span id="l25.1318" class="difflineminus">-nsresult nsMsgComposeService::AddGlobalHtmlDomains()</span>
<a href="#l25.1319"></a><span id="l25.1319" class="difflineminus">-{</span>
<a href="#l25.1320"></a><span id="l25.1320" class="difflineminus">-</span>
<a href="#l25.1321"></a><span id="l25.1321" class="difflineplus">+nsresult nsMsgComposeService::AddGlobalHtmlDomains() {</span>
<a href="#l25.1322"></a><span id="l25.1322">   nsresult rv;</span>
<a href="#l25.1323"></a><span id="l25.1323" class="difflineminus">-  nsCOMPtr&lt;nsIPrefService&gt; prefs = do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l25.1324"></a><span id="l25.1324" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l25.1325"></a><span id="l25.1325" class="difflineplus">+  nsCOMPtr&lt;nsIPrefService&gt; prefs =</span>
<a href="#l25.1326"></a><span id="l25.1326" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l25.1327"></a><span id="l25.1327" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.1328"></a><span id="l25.1328"> </span>
<a href="#l25.1329"></a><span id="l25.1329">   nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch;</span>
<a href="#l25.1330"></a><span id="l25.1330">   rv = prefs-&gt;GetBranch(MAILNEWS_ROOT_PREF, getter_AddRefs(prefBranch));</span>
<a href="#l25.1331"></a><span id="l25.1331" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l25.1332"></a><span id="l25.1332" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.1333"></a><span id="l25.1333"> </span>
<a href="#l25.1334"></a><span id="l25.1334">   nsCOMPtr&lt;nsIPrefBranch&gt; defaultsPrefBranch;</span>
<a href="#l25.1335"></a><span id="l25.1335" class="difflineminus">-  rv = prefs-&gt;GetDefaultBranch(MAILNEWS_ROOT_PREF, getter_AddRefs(defaultsPrefBranch));</span>
<a href="#l25.1336"></a><span id="l25.1336" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l25.1337"></a><span id="l25.1337" class="difflineplus">+  rv = prefs-&gt;GetDefaultBranch(MAILNEWS_ROOT_PREF,</span>
<a href="#l25.1338"></a><span id="l25.1338" class="difflineplus">+                               getter_AddRefs(defaultsPrefBranch));</span>
<a href="#l25.1339"></a><span id="l25.1339" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.1340"></a><span id="l25.1340"> </span>
<a href="#l25.1341"></a><span id="l25.1341">   /**</span>
<a href="#l25.1342"></a><span id="l25.1342">    * Check to see if we need to add any global domains.</span>
<a href="#l25.1343"></a><span id="l25.1343">    * If so, make sure the following prefs are added to mailnews.js</span>
<a href="#l25.1344"></a><span id="l25.1344">    *</span>
<a href="#l25.1345"></a><span id="l25.1345">    * 1. pref(&quot;mailnews.global_html_domains.version&quot;, version number);</span>
<a href="#l25.1346"></a><span id="l25.1346" class="difflineminus">-   * This pref registers the current version in the user prefs file. A default value is stored</span>
<a href="#l25.1347"></a><span id="l25.1347" class="difflineminus">-   * in mailnews file. Depending the changes we plan to make we can move the default version number.</span>
<a href="#l25.1348"></a><span id="l25.1348" class="difflineminus">-   * Comparing version number from user's prefs file and the default one from mailnews.js, we</span>
<a href="#l25.1349"></a><span id="l25.1349" class="difflineminus">-   * can effect ppropriate changes.</span>
<a href="#l25.1350"></a><span id="l25.1350" class="difflineplus">+   * This pref registers the current version in the user prefs file. A default</span>
<a href="#l25.1351"></a><span id="l25.1351" class="difflineplus">+   * value is stored in mailnews file. Depending the changes we plan to make we</span>
<a href="#l25.1352"></a><span id="l25.1352" class="difflineplus">+   * can move the default version number. Comparing version number from user's</span>
<a href="#l25.1353"></a><span id="l25.1353" class="difflineplus">+   * prefs file and the default one from mailnews.js, we can effect ppropriate</span>
<a href="#l25.1354"></a><span id="l25.1354" class="difflineplus">+   * changes.</span>
<a href="#l25.1355"></a><span id="l25.1355">    *</span>
<a href="#l25.1356"></a><span id="l25.1356">    * 2. pref(&quot;mailnews.global_html_domains&quot;, &lt;comma separated domain list&gt;);</span>
<a href="#l25.1357"></a><span id="l25.1357" class="difflineminus">-   * This pref contains the list of html domains that ISP can add to make that user's contain all</span>
<a href="#l25.1358"></a><span id="l25.1358" class="difflineminus">-   * of these under the HTML domains in the Mail&amp;NewsGrpus|Send Format under global preferences.</span>
<a href="#l25.1359"></a><span id="l25.1359" class="difflineplus">+   * This pref contains the list of html domains that ISP can add to make that</span>
<a href="#l25.1360"></a><span id="l25.1360" class="difflineplus">+   * user's contain all of these under the HTML domains in the</span>
<a href="#l25.1361"></a><span id="l25.1361" class="difflineplus">+   * Mail&amp;NewsGrpus|Send Format under global preferences.</span>
<a href="#l25.1362"></a><span id="l25.1362">    */</span>
<a href="#l25.1363"></a><span id="l25.1363">   int32_t htmlDomainListCurrentVersion, htmlDomainListDefaultVersion;</span>
<a href="#l25.1364"></a><span id="l25.1364" class="difflineminus">-  rv = prefBranch-&gt;GetIntPref(HTMLDOMAINUPDATE_VERSION_PREF_NAME, &amp;htmlDomainListCurrentVersion);</span>
<a href="#l25.1365"></a><span id="l25.1365" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l25.1366"></a><span id="l25.1366" class="difflineplus">+  rv = prefBranch-&gt;GetIntPref(HTMLDOMAINUPDATE_VERSION_PREF_NAME,</span>
<a href="#l25.1367"></a><span id="l25.1367" class="difflineplus">+                              &amp;htmlDomainListCurrentVersion);</span>
<a href="#l25.1368"></a><span id="l25.1368" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.1369"></a><span id="l25.1369"> </span>
<a href="#l25.1370"></a><span id="l25.1370" class="difflineminus">-  rv = defaultsPrefBranch-&gt;GetIntPref(HTMLDOMAINUPDATE_VERSION_PREF_NAME, &amp;htmlDomainListDefaultVersion);</span>
<a href="#l25.1371"></a><span id="l25.1371" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l25.1372"></a><span id="l25.1372" class="difflineplus">+  rv = defaultsPrefBranch-&gt;GetIntPref(HTMLDOMAINUPDATE_VERSION_PREF_NAME,</span>
<a href="#l25.1373"></a><span id="l25.1373" class="difflineplus">+                                      &amp;htmlDomainListDefaultVersion);</span>
<a href="#l25.1374"></a><span id="l25.1374" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.1375"></a><span id="l25.1375"> </span>
<a href="#l25.1376"></a><span id="l25.1376">   // Update the list as needed</span>
<a href="#l25.1377"></a><span id="l25.1377">   if (htmlDomainListCurrentVersion &lt;= htmlDomainListDefaultVersion) {</span>
<a href="#l25.1378"></a><span id="l25.1378">     // Get list of global domains need to be added</span>
<a href="#l25.1379"></a><span id="l25.1379">     nsCString globalHtmlDomainList;</span>
<a href="#l25.1380"></a><span id="l25.1380" class="difflineminus">-    rv = prefBranch-&gt;GetCharPref(HTMLDOMAINUPDATE_DOMAINLIST_PREF_NAME, globalHtmlDomainList);</span>
<a href="#l25.1381"></a><span id="l25.1381" class="difflineplus">+    rv = prefBranch-&gt;GetCharPref(HTMLDOMAINUPDATE_DOMAINLIST_PREF_NAME,</span>
<a href="#l25.1382"></a><span id="l25.1382" class="difflineplus">+                                 globalHtmlDomainList);</span>
<a href="#l25.1383"></a><span id="l25.1383"> </span>
<a href="#l25.1384"></a><span id="l25.1384">     if (NS_SUCCEEDED(rv) &amp;&amp; !globalHtmlDomainList.IsEmpty()) {</span>
<a href="#l25.1385"></a><span id="l25.1385">       nsTArray&lt;nsCString&gt; domainArray;</span>
<a href="#l25.1386"></a><span id="l25.1386"> </span>
<a href="#l25.1387"></a><span id="l25.1387">       // Get user's current HTML domain set for send format</span>
<a href="#l25.1388"></a><span id="l25.1388">       nsCString currentHtmlDomainList;</span>
<a href="#l25.1389"></a><span id="l25.1389" class="difflineminus">-      rv = prefBranch-&gt;GetCharPref(USER_CURRENT_HTMLDOMAINLIST_PREF_NAME, currentHtmlDomainList);</span>
<a href="#l25.1390"></a><span id="l25.1390" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l25.1391"></a><span id="l25.1391" class="difflineplus">+      rv = prefBranch-&gt;GetCharPref(USER_CURRENT_HTMLDOMAINLIST_PREF_NAME,</span>
<a href="#l25.1392"></a><span id="l25.1392" class="difflineplus">+                                   currentHtmlDomainList);</span>
<a href="#l25.1393"></a><span id="l25.1393" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.1394"></a><span id="l25.1394"> </span>
<a href="#l25.1395"></a><span id="l25.1395">       nsAutoCString newHtmlDomainList(currentHtmlDomainList);</span>
<a href="#l25.1396"></a><span id="l25.1396">       // Get the current html domain list into new list var</span>
<a href="#l25.1397"></a><span id="l25.1397">       ParseString(currentHtmlDomainList, DOMAIN_DELIMITER, domainArray);</span>
<a href="#l25.1398"></a><span id="l25.1398"> </span>
<a href="#l25.1399"></a><span id="l25.1399">       // Get user's current Plaintext domain set for send format</span>
<a href="#l25.1400"></a><span id="l25.1400">       nsCString currentPlaintextDomainList;</span>
<a href="#l25.1401"></a><span id="l25.1401" class="difflineminus">-      rv = prefBranch-&gt;GetCharPref(USER_CURRENT_PLAINTEXTDOMAINLIST_PREF_NAME, currentPlaintextDomainList);</span>
<a href="#l25.1402"></a><span id="l25.1402" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l25.1403"></a><span id="l25.1403" class="difflineplus">+      rv = prefBranch-&gt;GetCharPref(USER_CURRENT_PLAINTEXTDOMAINLIST_PREF_NAME,</span>
<a href="#l25.1404"></a><span id="l25.1404" class="difflineplus">+                                   currentPlaintextDomainList);</span>
<a href="#l25.1405"></a><span id="l25.1405" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.1406"></a><span id="l25.1406"> </span>
<a href="#l25.1407"></a><span id="l25.1407">       // Get the current plaintext domain list into new list var</span>
<a href="#l25.1408"></a><span id="l25.1408">       ParseString(currentPlaintextDomainList, DOMAIN_DELIMITER, domainArray);</span>
<a href="#l25.1409"></a><span id="l25.1409"> </span>
<a href="#l25.1410"></a><span id="l25.1410">       size_t i = domainArray.Length();</span>
<a href="#l25.1411"></a><span id="l25.1411">       if (i &gt; 0) {</span>
<a href="#l25.1412"></a><span id="l25.1412">         // Append each domain in the preconfigured html domain list</span>
<a href="#l25.1413"></a><span id="l25.1413">         globalHtmlDomainList.StripWhitespace();</span>
<a href="#l25.1414"></a><span id="l25.1414" class="difflineat">@@ -1147,114 +1103,106 @@ nsresult nsMsgComposeService::AddGlobalH</span>
<a href="#l25.1415"></a><span id="l25.1415">         // the user's current html or plaintext domain lists</span>
<a href="#l25.1416"></a><span id="l25.1416">         for (; i &lt; domainArray.Length(); i++) {</span>
<a href="#l25.1417"></a><span id="l25.1417">           if (domainArray.IndexOf(domainArray[i]) == i) {</span>
<a href="#l25.1418"></a><span id="l25.1418">             if (!newHtmlDomainList.IsEmpty())</span>
<a href="#l25.1419"></a><span id="l25.1419">               newHtmlDomainList += DOMAIN_DELIMITER;</span>
<a href="#l25.1420"></a><span id="l25.1420">             newHtmlDomainList += domainArray[i];</span>
<a href="#l25.1421"></a><span id="l25.1421">           }</span>
<a href="#l25.1422"></a><span id="l25.1422">         }</span>
<a href="#l25.1423"></a><span id="l25.1423" class="difflineminus">-      }</span>
<a href="#l25.1424"></a><span id="l25.1424" class="difflineminus">-      else</span>
<a href="#l25.1425"></a><span id="l25.1425" class="difflineminus">-      {</span>
<a href="#l25.1426"></a><span id="l25.1426" class="difflineplus">+      } else {</span>
<a href="#l25.1427"></a><span id="l25.1427">         // User has no domains listed either in html or plain text category.</span>
<a href="#l25.1428"></a><span id="l25.1428">         // Assign the global list to be the user's current html domain list</span>
<a href="#l25.1429"></a><span id="l25.1429">         newHtmlDomainList = globalHtmlDomainList;</span>
<a href="#l25.1430"></a><span id="l25.1430">       }</span>
<a href="#l25.1431"></a><span id="l25.1431"> </span>
<a href="#l25.1432"></a><span id="l25.1432">       // Set user's html domain pref with the updated list</span>
<a href="#l25.1433"></a><span id="l25.1433" class="difflineminus">-      rv = prefBranch-&gt;SetCharPref(USER_CURRENT_HTMLDOMAINLIST_PREF_NAME, newHtmlDomainList);</span>
<a href="#l25.1434"></a><span id="l25.1434" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l25.1435"></a><span id="l25.1435" class="difflineplus">+      rv = prefBranch-&gt;SetCharPref(USER_CURRENT_HTMLDOMAINLIST_PREF_NAME,</span>
<a href="#l25.1436"></a><span id="l25.1436" class="difflineplus">+                                   newHtmlDomainList);</span>
<a href="#l25.1437"></a><span id="l25.1437" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.1438"></a><span id="l25.1438"> </span>
<a href="#l25.1439"></a><span id="l25.1439" class="difflineminus">-      // Increase the version to avoid running the update code unless needed (based on default version)</span>
<a href="#l25.1440"></a><span id="l25.1440" class="difflineminus">-      rv = prefBranch-&gt;SetIntPref(HTMLDOMAINUPDATE_VERSION_PREF_NAME, htmlDomainListCurrentVersion + 1);</span>
<a href="#l25.1441"></a><span id="l25.1441" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l25.1442"></a><span id="l25.1442" class="difflineplus">+      // Increase the version to avoid running the update code unless needed</span>
<a href="#l25.1443"></a><span id="l25.1443" class="difflineplus">+      // (based on default version)</span>
<a href="#l25.1444"></a><span id="l25.1444" class="difflineplus">+      rv = prefBranch-&gt;SetIntPref(HTMLDOMAINUPDATE_VERSION_PREF_NAME,</span>
<a href="#l25.1445"></a><span id="l25.1445" class="difflineplus">+                                  htmlDomainListCurrentVersion + 1);</span>
<a href="#l25.1446"></a><span id="l25.1446" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.1447"></a><span id="l25.1447">     }</span>
<a href="#l25.1448"></a><span id="l25.1448">   }</span>
<a href="#l25.1449"></a><span id="l25.1449">   return NS_OK;</span>
<a href="#l25.1450"></a><span id="l25.1450"> }</span>
<a href="#l25.1451"></a><span id="l25.1451"> </span>
<a href="#l25.1452"></a><span id="l25.1452"> NS_IMETHODIMP</span>
<a href="#l25.1453"></a><span id="l25.1453"> nsMsgComposeService::RegisterComposeDocShell(nsIDocShell *aDocShell,</span>
<a href="#l25.1454"></a><span id="l25.1454" class="difflineminus">-                                             nsIMsgCompose *aComposeObject)</span>
<a href="#l25.1455"></a><span id="l25.1455" class="difflineminus">-{</span>
<a href="#l25.1456"></a><span id="l25.1456" class="difflineplus">+                                             nsIMsgCompose *aComposeObject) {</span>
<a href="#l25.1457"></a><span id="l25.1457">   NS_ENSURE_ARG_POINTER(aDocShell);</span>
<a href="#l25.1458"></a><span id="l25.1458">   NS_ENSURE_ARG_POINTER(aComposeObject);</span>
<a href="#l25.1459"></a><span id="l25.1459"> </span>
<a href="#l25.1460"></a><span id="l25.1460">   nsresult rv;</span>
<a href="#l25.1461"></a><span id="l25.1461"> </span>
<a href="#l25.1462"></a><span id="l25.1462">   // add the msg compose / dom window mapping to our hash table</span>
<a href="#l25.1463"></a><span id="l25.1463">   nsWeakPtr weakDocShell = do_GetWeakReference(aDocShell, &amp;rv);</span>
<a href="#l25.1464"></a><span id="l25.1464" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l25.1465"></a><span id="l25.1465" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.1466"></a><span id="l25.1466">   nsWeakPtr weakMsgComposePtr = do_GetWeakReference(aComposeObject);</span>
<a href="#l25.1467"></a><span id="l25.1467" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l25.1468"></a><span id="l25.1468" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.1469"></a><span id="l25.1469">   mOpenComposeWindows.Put(weakDocShell, weakMsgComposePtr);</span>
<a href="#l25.1470"></a><span id="l25.1470"> </span>
<a href="#l25.1471"></a><span id="l25.1471">   return rv;</span>
<a href="#l25.1472"></a><span id="l25.1472"> }</span>
<a href="#l25.1473"></a><span id="l25.1473"> </span>
<a href="#l25.1474"></a><span id="l25.1474"> NS_IMETHODIMP</span>
<a href="#l25.1475"></a><span id="l25.1475" class="difflineminus">-nsMsgComposeService::UnregisterComposeDocShell(nsIDocShell *aDocShell)</span>
<a href="#l25.1476"></a><span id="l25.1476" class="difflineminus">-{</span>
<a href="#l25.1477"></a><span id="l25.1477" class="difflineplus">+nsMsgComposeService::UnregisterComposeDocShell(nsIDocShell *aDocShell) {</span>
<a href="#l25.1478"></a><span id="l25.1478">   NS_ENSURE_ARG_POINTER(aDocShell);</span>
<a href="#l25.1479"></a><span id="l25.1479"> </span>
<a href="#l25.1480"></a><span id="l25.1480">   nsresult rv;</span>
<a href="#l25.1481"></a><span id="l25.1481">   nsWeakPtr weakDocShell = do_GetWeakReference(aDocShell, &amp;rv);</span>
<a href="#l25.1482"></a><span id="l25.1482" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l25.1483"></a><span id="l25.1483" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.1484"></a><span id="l25.1484"> </span>
<a href="#l25.1485"></a><span id="l25.1485">   mOpenComposeWindows.Remove(weakDocShell);</span>
<a href="#l25.1486"></a><span id="l25.1486"> </span>
<a href="#l25.1487"></a><span id="l25.1487">   return rv;</span>
<a href="#l25.1488"></a><span id="l25.1488"> }</span>
<a href="#l25.1489"></a><span id="l25.1489"> </span>
<a href="#l25.1490"></a><span id="l25.1490"> NS_IMETHODIMP</span>
<a href="#l25.1491"></a><span id="l25.1491"> nsMsgComposeService::GetMsgComposeForDocShell(nsIDocShell *aDocShell,</span>
<a href="#l25.1492"></a><span id="l25.1492" class="difflineminus">-                                              nsIMsgCompose **aComposeObject)</span>
<a href="#l25.1493"></a><span id="l25.1493" class="difflineminus">-{</span>
<a href="#l25.1494"></a><span id="l25.1494" class="difflineplus">+                                              nsIMsgCompose **aComposeObject) {</span>
<a href="#l25.1495"></a><span id="l25.1495">   NS_ENSURE_ARG_POINTER(aDocShell);</span>
<a href="#l25.1496"></a><span id="l25.1496">   NS_ENSURE_ARG_POINTER(aComposeObject);</span>
<a href="#l25.1497"></a><span id="l25.1497"> </span>
<a href="#l25.1498"></a><span id="l25.1498" class="difflineminus">-  if (!mOpenComposeWindows.Count())</span>
<a href="#l25.1499"></a><span id="l25.1499" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l25.1500"></a><span id="l25.1500" class="difflineplus">+  if (!mOpenComposeWindows.Count()) return NS_ERROR_FAILURE;</span>
<a href="#l25.1501"></a><span id="l25.1501"> </span>
<a href="#l25.1502"></a><span id="l25.1502">   // get the weak reference for our dom window</span>
<a href="#l25.1503"></a><span id="l25.1503">   nsresult rv;</span>
<a href="#l25.1504"></a><span id="l25.1504">   nsWeakPtr weakDocShell = do_GetWeakReference(aDocShell, &amp;rv);</span>
<a href="#l25.1505"></a><span id="l25.1505">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.1506"></a><span id="l25.1506"> </span>
<a href="#l25.1507"></a><span id="l25.1507">   nsWeakPtr weakMsgComposePtr;</span>
<a href="#l25.1508"></a><span id="l25.1508"> </span>
<a href="#l25.1509"></a><span id="l25.1509" class="difflineminus">-  if (!mOpenComposeWindows.Get(weakDocShell,</span>
<a href="#l25.1510"></a><span id="l25.1510" class="difflineminus">-                               getter_AddRefs(weakMsgComposePtr)))</span>
<a href="#l25.1511"></a><span id="l25.1511" class="difflineplus">+  if (!mOpenComposeWindows.Get(weakDocShell, getter_AddRefs(weakMsgComposePtr)))</span>
<a href="#l25.1512"></a><span id="l25.1512">     return NS_ERROR_FAILURE;</span>
<a href="#l25.1513"></a><span id="l25.1513"> </span>
<a href="#l25.1514"></a><span id="l25.1514">   nsCOMPtr&lt;nsIMsgCompose&gt; msgCompose = do_QueryReferent(weakMsgComposePtr, &amp;rv);</span>
<a href="#l25.1515"></a><span id="l25.1515">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.1516"></a><span id="l25.1516"> </span>
<a href="#l25.1517"></a><span id="l25.1517">   NS_IF_ADDREF(*aComposeObject = msgCompose);</span>
<a href="#l25.1518"></a><span id="l25.1518">   return rv;</span>
<a href="#l25.1519"></a><span id="l25.1519"> }</span>
<a href="#l25.1520"></a><span id="l25.1520"> </span>
<a href="#l25.1521"></a><span id="l25.1521"> /**</span>
<a href="#l25.1522"></a><span id="l25.1522">  * LoadDraftOrTemplate</span>
<a href="#l25.1523"></a><span id="l25.1523" class="difflineminus">- *   Helper routine used to run msgURI through libmime in order to fetch the contents for a</span>
<a href="#l25.1524"></a><span id="l25.1524" class="difflineminus">- *   draft or template.</span>
<a href="#l25.1525"></a><span id="l25.1525" class="difflineplus">+ *   Helper routine used to run msgURI through libmime in order to fetch the</span>
<a href="#l25.1526"></a><span id="l25.1526" class="difflineplus">+ * contents for a draft or template.</span>
<a href="#l25.1527"></a><span id="l25.1527">  */</span>
<a href="#l25.1528"></a><span id="l25.1528" class="difflineminus">-nsresult</span>
<a href="#l25.1529"></a><span id="l25.1529" class="difflineminus">-nsMsgComposeService::LoadDraftOrTemplate(const nsACString&amp; aMsgURI, nsMimeOutputType aOutType,</span>
<a href="#l25.1530"></a><span id="l25.1530" class="difflineminus">-                                         nsIMsgIdentity * aIdentity, const char * aOriginalMsgURI,</span>
<a href="#l25.1531"></a><span id="l25.1531" class="difflineminus">-                                         nsIMsgDBHdr * aOrigMsgHdr,</span>
<a href="#l25.1532"></a><span id="l25.1532" class="difflineminus">-                                         bool aForwardInline,</span>
<a href="#l25.1533"></a><span id="l25.1533" class="difflineminus">-                                         bool overrideComposeFormat,</span>
<a href="#l25.1534"></a><span id="l25.1534" class="difflineminus">-                                         nsIMsgWindow *aMsgWindow)</span>
<a href="#l25.1535"></a><span id="l25.1535" class="difflineminus">-{</span>
<a href="#l25.1536"></a><span id="l25.1536" class="difflineminus">-  return RunMessageThroughMimeDraft(aMsgURI, aOutType, aIdentity,</span>
<a href="#l25.1537"></a><span id="l25.1537" class="difflineminus">-                                    aOriginalMsgURI, aOrigMsgHdr,</span>
<a href="#l25.1538"></a><span id="l25.1538" class="difflineminus">-                                    aForwardInline, EmptyString(),</span>
<a href="#l25.1539"></a><span id="l25.1539" class="difflineminus">-                                    overrideComposeFormat, aMsgWindow);</span>
<a href="#l25.1540"></a><span id="l25.1540" class="difflineplus">+nsresult nsMsgComposeService::LoadDraftOrTemplate(</span>
<a href="#l25.1541"></a><span id="l25.1541" class="difflineplus">+    const nsACString &amp;aMsgURI, nsMimeOutputType aOutType,</span>
<a href="#l25.1542"></a><span id="l25.1542" class="difflineplus">+    nsIMsgIdentity *aIdentity, const char *aOriginalMsgURI,</span>
<a href="#l25.1543"></a><span id="l25.1543" class="difflineplus">+    nsIMsgDBHdr *aOrigMsgHdr, bool aForwardInline, bool overrideComposeFormat,</span>
<a href="#l25.1544"></a><span id="l25.1544" class="difflineplus">+    nsIMsgWindow *aMsgWindow) {</span>
<a href="#l25.1545"></a><span id="l25.1545" class="difflineplus">+  return RunMessageThroughMimeDraft(</span>
<a href="#l25.1546"></a><span id="l25.1546" class="difflineplus">+      aMsgURI, aOutType, aIdentity, aOriginalMsgURI, aOrigMsgHdr,</span>
<a href="#l25.1547"></a><span id="l25.1547" class="difflineplus">+      aForwardInline, EmptyString(), overrideComposeFormat, aMsgWindow);</span>
<a href="#l25.1548"></a><span id="l25.1548"> }</span>
<a href="#l25.1549"></a><span id="l25.1549"> </span>
<a href="#l25.1550"></a><span id="l25.1550"> /**</span>
<a href="#l25.1551"></a><span id="l25.1551">  * Run the aMsgURI message through libmime. We set various attributes of the</span>
<a href="#l25.1552"></a><span id="l25.1552">  * nsIMimeStreamConverter so mimedrft.cpp will know what to do with the message</span>
<a href="#l25.1553"></a><span id="l25.1553">  * when its done streaming. Usually that will be opening a compose window</span>
<a href="#l25.1554"></a><span id="l25.1554">  * with the contents of the message, but if forwardTo is non-empty, mimedrft.cpp</span>
<a href="#l25.1555"></a><span id="l25.1555">  * will forward the contents directly.</span>
<a href="#l25.1556"></a><span id="l25.1556" class="difflineat">@@ -1270,209 +1218,199 @@ nsMsgComposeService::LoadDraftOrTemplate</span>
<a href="#l25.1557"></a><span id="l25.1557">  * @param aForwardTo  e-mail address to forward msg to. This is used for</span>
<a href="#l25.1558"></a><span id="l25.1558">  *                     forward inline message filter actions.</span>
<a href="#l25.1559"></a><span id="l25.1559">  * @param aOverrideComposeFormat True if the user had shift key down when</span>
<a href="#l25.1560"></a><span id="l25.1560">                                  doing a command that opens the compose window,</span>
<a href="#l25.1561"></a><span id="l25.1561">  *                               which means we switch the compose window used</span>
<a href="#l25.1562"></a><span id="l25.1562">  *                               from the default.</span>
<a href="#l25.1563"></a><span id="l25.1563">  * @param aMsgWindow msgWindow to pass into DisplayMessage.</span>
<a href="#l25.1564"></a><span id="l25.1564">  */</span>
<a href="#l25.1565"></a><span id="l25.1565" class="difflineminus">-nsresult</span>
<a href="#l25.1566"></a><span id="l25.1566" class="difflineminus">-nsMsgComposeService::RunMessageThroughMimeDraft(</span>
<a href="#l25.1567"></a><span id="l25.1567" class="difflineminus">-            const nsACString&amp; aMsgURI, nsMimeOutputType aOutType,</span>
<a href="#l25.1568"></a><span id="l25.1568" class="difflineminus">-            nsIMsgIdentity * aIdentity, const char * aOriginalMsgURI,</span>
<a href="#l25.1569"></a><span id="l25.1569" class="difflineminus">-            nsIMsgDBHdr * aOrigMsgHdr,</span>
<a href="#l25.1570"></a><span id="l25.1570" class="difflineminus">-            bool aForwardInline,</span>
<a href="#l25.1571"></a><span id="l25.1571" class="difflineminus">-            const nsAString &amp;aForwardTo,</span>
<a href="#l25.1572"></a><span id="l25.1572" class="difflineminus">-            bool aOverrideComposeFormat,</span>
<a href="#l25.1573"></a><span id="l25.1573" class="difflineminus">-            nsIMsgWindow *aMsgWindow)</span>
<a href="#l25.1574"></a><span id="l25.1574" class="difflineminus">-{</span>
<a href="#l25.1575"></a><span id="l25.1575" class="difflineminus">-  nsCOMPtr &lt;nsIMsgMessageService&gt; messageService;</span>
<a href="#l25.1576"></a><span id="l25.1576" class="difflineminus">-  nsresult rv = GetMessageServiceFromURI(aMsgURI, getter_AddRefs(messageService));</span>
<a href="#l25.1577"></a><span id="l25.1577" class="difflineplus">+nsresult nsMsgComposeService::RunMessageThroughMimeDraft(</span>
<a href="#l25.1578"></a><span id="l25.1578" class="difflineplus">+    const nsACString &amp;aMsgURI, nsMimeOutputType aOutType,</span>
<a href="#l25.1579"></a><span id="l25.1579" class="difflineplus">+    nsIMsgIdentity *aIdentity, const char *aOriginalMsgURI,</span>
<a href="#l25.1580"></a><span id="l25.1580" class="difflineplus">+    nsIMsgDBHdr *aOrigMsgHdr, bool aForwardInline, const nsAString &amp;aForwardTo,</span>
<a href="#l25.1581"></a><span id="l25.1581" class="difflineplus">+    bool aOverrideComposeFormat, nsIMsgWindow *aMsgWindow) {</span>
<a href="#l25.1582"></a><span id="l25.1582" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMessageService&gt; messageService;</span>
<a href="#l25.1583"></a><span id="l25.1583" class="difflineplus">+  nsresult rv =</span>
<a href="#l25.1584"></a><span id="l25.1584" class="difflineplus">+      GetMessageServiceFromURI(aMsgURI, getter_AddRefs(messageService));</span>
<a href="#l25.1585"></a><span id="l25.1585">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.1586"></a><span id="l25.1586"> </span>
<a href="#l25.1587"></a><span id="l25.1587">   // Create a mime parser (nsIMimeStreamConverter)to do the conversion.</span>
<a href="#l25.1588"></a><span id="l25.1588">   nsCOMPtr&lt;nsIMimeStreamConverter&gt; mimeConverter =</span>
<a href="#l25.1589"></a><span id="l25.1589" class="difflineminus">-    do_CreateInstance(NS_MAILNEWS_MIME_STREAM_CONVERTER_CONTRACTID, &amp;rv);</span>
<a href="#l25.1590"></a><span id="l25.1590" class="difflineplus">+      do_CreateInstance(NS_MAILNEWS_MIME_STREAM_CONVERTER_CONTRACTID, &amp;rv);</span>
<a href="#l25.1591"></a><span id="l25.1591">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.1592"></a><span id="l25.1592"> </span>
<a href="#l25.1593"></a><span id="l25.1593" class="difflineminus">-  mimeConverter-&gt;SetMimeOutputType(aOutType); // Set the type of output for libmime</span>
<a href="#l25.1594"></a><span id="l25.1594" class="difflineplus">+  mimeConverter-&gt;SetMimeOutputType(</span>
<a href="#l25.1595"></a><span id="l25.1595" class="difflineplus">+      aOutType);  // Set the type of output for libmime</span>
<a href="#l25.1596"></a><span id="l25.1596">   mimeConverter-&gt;SetForwardInline(aForwardInline);</span>
<a href="#l25.1597"></a><span id="l25.1597" class="difflineminus">-  if (!aForwardTo.IsEmpty())</span>
<a href="#l25.1598"></a><span id="l25.1598" class="difflineminus">-  {</span>
<a href="#l25.1599"></a><span id="l25.1599" class="difflineplus">+  if (!aForwardTo.IsEmpty()) {</span>
<a href="#l25.1600"></a><span id="l25.1600">     mimeConverter-&gt;SetForwardInlineFilter(true);</span>
<a href="#l25.1601"></a><span id="l25.1601">     mimeConverter-&gt;SetForwardToAddress(aForwardTo);</span>
<a href="#l25.1602"></a><span id="l25.1602">   }</span>
<a href="#l25.1603"></a><span id="l25.1603">   mimeConverter-&gt;SetOverrideComposeFormat(aOverrideComposeFormat);</span>
<a href="#l25.1604"></a><span id="l25.1604">   mimeConverter-&gt;SetIdentity(aIdentity);</span>
<a href="#l25.1605"></a><span id="l25.1605">   mimeConverter-&gt;SetOriginalMsgURI(aOriginalMsgURI);</span>
<a href="#l25.1606"></a><span id="l25.1606">   mimeConverter-&gt;SetOrigMsgHdr(aOrigMsgHdr);</span>
<a href="#l25.1607"></a><span id="l25.1607"> </span>
<a href="#l25.1608"></a><span id="l25.1608">   nsCOMPtr&lt;nsIURI&gt; url;</span>
<a href="#l25.1609"></a><span id="l25.1609">   bool fileUrl = StringBeginsWith(aMsgURI, NS_LITERAL_CSTRING(&quot;file:&quot;));</span>
<a href="#l25.1610"></a><span id="l25.1610">   nsCString mailboxUri(aMsgURI);</span>
<a href="#l25.1611"></a><span id="l25.1611" class="difflineminus">-  if (fileUrl)</span>
<a href="#l25.1612"></a><span id="l25.1612" class="difflineminus">-  {</span>
<a href="#l25.1613"></a><span id="l25.1613" class="difflineplus">+  if (fileUrl) {</span>
<a href="#l25.1614"></a><span id="l25.1614">     // We loaded a .eml file from a file: url. Construct equivalent mailbox url.</span>
<a href="#l25.1615"></a><span id="l25.1615">     mailboxUri.Replace(0, 5, NS_LITERAL_CSTRING(&quot;mailbox:&quot;));</span>
<a href="#l25.1616"></a><span id="l25.1616">     mailboxUri.AppendLiteral(&quot;&amp;number=0&quot;);</span>
<a href="#l25.1617"></a><span id="l25.1617">     // Need this to prevent nsMsgCompose::TagEmbeddedObjects from setting</span>
<a href="#l25.1618"></a><span id="l25.1618">     // inline images as moz-do-not-send.</span>
<a href="#l25.1619"></a><span id="l25.1619">     mimeConverter-&gt;SetOriginalMsgURI(mailboxUri.get());</span>
<a href="#l25.1620"></a><span id="l25.1620">   }</span>
<a href="#l25.1621"></a><span id="l25.1621" class="difflineminus">-  if (fileUrl || PromiseFlatCString(aMsgURI).Find(&quot;&amp;type=application/x-message-display&quot;) &gt;= 0)</span>
<a href="#l25.1622"></a><span id="l25.1622" class="difflineplus">+  if (fileUrl || PromiseFlatCString(aMsgURI).Find(</span>
<a href="#l25.1623"></a><span id="l25.1623" class="difflineplus">+                     &quot;&amp;type=application/x-message-display&quot;) &gt;= 0)</span>
<a href="#l25.1624"></a><span id="l25.1624">     rv = NS_NewURI(getter_AddRefs(url), mailboxUri);</span>
<a href="#l25.1625"></a><span id="l25.1625">   else</span>
<a href="#l25.1626"></a><span id="l25.1626" class="difflineminus">-    rv = messageService-&gt;GetUrlForUri(PromiseFlatCString(aMsgURI).get(), getter_AddRefs(url), aMsgWindow);</span>
<a href="#l25.1627"></a><span id="l25.1627" class="difflineplus">+    rv = messageService-&gt;GetUrlForUri(PromiseFlatCString(aMsgURI).get(),</span>
<a href="#l25.1628"></a><span id="l25.1628" class="difflineplus">+                                      getter_AddRefs(url), aMsgWindow);</span>
<a href="#l25.1629"></a><span id="l25.1629">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.1630"></a><span id="l25.1630"> </span>
<a href="#l25.1631"></a><span id="l25.1631">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsurl = do_QueryInterface(url);</span>
<a href="#l25.1632"></a><span id="l25.1632">   if (!mailnewsurl) {</span>
<a href="#l25.1633"></a><span id="l25.1633" class="difflineminus">-    NS_WARNING(&quot;Trying to run a message through MIME which doesn't have a nsIMsgMailNewsUrl?&quot;);</span>
<a href="#l25.1634"></a><span id="l25.1634" class="difflineplus">+    NS_WARNING(</span>
<a href="#l25.1635"></a><span id="l25.1635" class="difflineplus">+        &quot;Trying to run a message through MIME which doesn't have a &quot;</span>
<a href="#l25.1636"></a><span id="l25.1636" class="difflineplus">+        &quot;nsIMsgMailNewsUrl?&quot;);</span>
<a href="#l25.1637"></a><span id="l25.1637">     return NS_ERROR_UNEXPECTED;</span>
<a href="#l25.1638"></a><span id="l25.1638">   }</span>
<a href="#l25.1639"></a><span id="l25.1639" class="difflineminus">-  // SetSpecInternal must not fail, or else the URL won't have a base URL and we'll crash later.</span>
<a href="#l25.1640"></a><span id="l25.1640" class="difflineplus">+  // SetSpecInternal must not fail, or else the URL won't have a base URL and</span>
<a href="#l25.1641"></a><span id="l25.1641" class="difflineplus">+  // we'll crash later.</span>
<a href="#l25.1642"></a><span id="l25.1642">   rv = mailnewsurl-&gt;SetSpecInternal(mailboxUri);</span>
<a href="#l25.1643"></a><span id="l25.1643">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.1644"></a><span id="l25.1644"> </span>
<a href="#l25.1645"></a><span id="l25.1645">   // if we are forwarding a message and that message used a charset over ride</span>
<a href="#l25.1646"></a><span id="l25.1646" class="difflineminus">-  // then use that over ride charset instead of the charset specified in the message</span>
<a href="#l25.1647"></a><span id="l25.1647" class="difflineplus">+  // then use that over ride charset instead of the charset specified in the</span>
<a href="#l25.1648"></a><span id="l25.1648" class="difflineplus">+  // message</span>
<a href="#l25.1649"></a><span id="l25.1649">   nsCString mailCharset;</span>
<a href="#l25.1650"></a><span id="l25.1650" class="difflineminus">-  if (aMsgWindow)</span>
<a href="#l25.1651"></a><span id="l25.1651" class="difflineminus">-  {</span>
<a href="#l25.1652"></a><span id="l25.1652" class="difflineplus">+  if (aMsgWindow) {</span>
<a href="#l25.1653"></a><span id="l25.1653">     bool charsetOverride;</span>
<a href="#l25.1654"></a><span id="l25.1654" class="difflineminus">-    if (NS_SUCCEEDED(aMsgWindow-&gt;GetCharsetOverride(&amp;charsetOverride)) &amp;&amp; charsetOverride)</span>
<a href="#l25.1655"></a><span id="l25.1655" class="difflineminus">-    {</span>
<a href="#l25.1656"></a><span id="l25.1656" class="difflineminus">-      if (NS_SUCCEEDED(aMsgWindow-&gt;GetMailCharacterSet(mailCharset)))</span>
<a href="#l25.1657"></a><span id="l25.1657" class="difflineminus">-      {</span>
<a href="#l25.1658"></a><span id="l25.1658" class="difflineplus">+    if (NS_SUCCEEDED(aMsgWindow-&gt;GetCharsetOverride(&amp;charsetOverride)) &amp;&amp;</span>
<a href="#l25.1659"></a><span id="l25.1659" class="difflineplus">+        charsetOverride) {</span>
<a href="#l25.1660"></a><span id="l25.1660" class="difflineplus">+      if (NS_SUCCEEDED(aMsgWindow-&gt;GetMailCharacterSet(mailCharset))) {</span>
<a href="#l25.1661"></a><span id="l25.1661">         nsCOMPtr&lt;nsIMsgI18NUrl&gt; i18nUrl(do_QueryInterface(url));</span>
<a href="#l25.1662"></a><span id="l25.1662" class="difflineminus">-        if (i18nUrl)</span>
<a href="#l25.1663"></a><span id="l25.1663" class="difflineminus">-          (void) i18nUrl-&gt;SetCharsetOverRide(mailCharset.get());</span>
<a href="#l25.1664"></a><span id="l25.1664" class="difflineplus">+        if (i18nUrl) (void)i18nUrl-&gt;SetCharsetOverRide(mailCharset.get());</span>
<a href="#l25.1665"></a><span id="l25.1665">       }</span>
<a href="#l25.1666"></a><span id="l25.1666">     }</span>
<a href="#l25.1667"></a><span id="l25.1667">   }</span>
<a href="#l25.1668"></a><span id="l25.1668"> </span>
<a href="#l25.1669"></a><span id="l25.1669">   nsCOMPtr&lt;nsIPrincipal&gt; nullPrincipal =</span>
<a href="#l25.1670"></a><span id="l25.1670" class="difflineminus">-    do_CreateInstance(&quot;@mozilla.org/nullprincipal;1&quot;, &amp;rv);</span>
<a href="#l25.1671"></a><span id="l25.1671" class="difflineplus">+      do_CreateInstance(&quot;@mozilla.org/nullprincipal;1&quot;, &amp;rv);</span>
<a href="#l25.1672"></a><span id="l25.1672">   NS_ASSERTION(NS_SUCCEEDED(rv), &quot;CreateInstance of nullprincipal failed&quot;);</span>
<a href="#l25.1673"></a><span id="l25.1673" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l25.1674"></a><span id="l25.1674" class="difflineminus">-    return rv;</span>
<a href="#l25.1675"></a><span id="l25.1675" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l25.1676"></a><span id="l25.1676"> </span>
<a href="#l25.1677"></a><span id="l25.1677">   nsCOMPtr&lt;nsIChannel&gt; channel;</span>
<a href="#l25.1678"></a><span id="l25.1678" class="difflineminus">-  rv = NS_NewInputStreamChannel(getter_AddRefs(channel),</span>
<a href="#l25.1679"></a><span id="l25.1679" class="difflineminus">-                                url,</span>
<a href="#l25.1680"></a><span id="l25.1680" class="difflineminus">-                                nullptr,</span>
<a href="#l25.1681"></a><span id="l25.1681" class="difflineminus">-                                nullPrincipal,</span>
<a href="#l25.1682"></a><span id="l25.1682" class="difflineminus">-                                nsILoadInfo::SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l25.1683"></a><span id="l25.1683" class="difflineminus">-                                nsIContentPolicy::TYPE_OTHER);</span>
<a href="#l25.1684"></a><span id="l25.1684" class="difflineplus">+  rv = NS_NewInputStreamChannel(</span>
<a href="#l25.1685"></a><span id="l25.1685" class="difflineplus">+      getter_AddRefs(channel), url, nullptr, nullPrincipal,</span>
<a href="#l25.1686"></a><span id="l25.1686" class="difflineplus">+      nsILoadInfo::SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l25.1687"></a><span id="l25.1687" class="difflineplus">+      nsIContentPolicy::TYPE_OTHER);</span>
<a href="#l25.1688"></a><span id="l25.1688">   NS_ASSERTION(NS_SUCCEEDED(rv), &quot;NS_NewChannel failed.&quot;);</span>
<a href="#l25.1689"></a><span id="l25.1689" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l25.1690"></a><span id="l25.1690" class="difflineminus">-    return rv;</span>
<a href="#l25.1691"></a><span id="l25.1691" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l25.1692"></a><span id="l25.1692"> </span>
<a href="#l25.1693"></a><span id="l25.1693">   nsCOMPtr&lt;nsIStreamConverter&gt; converter = do_QueryInterface(mimeConverter);</span>
<a href="#l25.1694"></a><span id="l25.1694">   rv = converter-&gt;AsyncConvertData(nullptr, nullptr, nullptr, channel);</span>
<a href="#l25.1695"></a><span id="l25.1695">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.1696"></a><span id="l25.1696"> </span>
<a href="#l25.1697"></a><span id="l25.1697">   // Now, just plug the two together and get the hell out of the way!</span>
<a href="#l25.1698"></a><span id="l25.1698">   nsCOMPtr&lt;nsIStreamListener&gt; streamListener = do_QueryInterface(mimeConverter);</span>
<a href="#l25.1699"></a><span id="l25.1699">   nsCOMPtr&lt;nsIURI&gt; dummyNull;</span>
<a href="#l25.1700"></a><span id="l25.1700" class="difflineminus">-  return messageService-&gt;DisplayMessage(PromiseFlatCString(aMsgURI).get(), streamListener,</span>
<a href="#l25.1701"></a><span id="l25.1701" class="difflineminus">-                                        aMsgWindow, nullptr, mailCharset.get(),</span>
<a href="#l25.1702"></a><span id="l25.1702" class="difflineminus">-                                        getter_AddRefs(dummyNull));</span>
<a href="#l25.1703"></a><span id="l25.1703" class="difflineplus">+  return messageService-&gt;DisplayMessage(</span>
<a href="#l25.1704"></a><span id="l25.1704" class="difflineplus">+      PromiseFlatCString(aMsgURI).get(), streamListener, aMsgWindow, nullptr,</span>
<a href="#l25.1705"></a><span id="l25.1705" class="difflineplus">+      mailCharset.get(), getter_AddRefs(dummyNull));</span>
<a href="#l25.1706"></a><span id="l25.1706"> }</span>
<a href="#l25.1707"></a><span id="l25.1707"> </span>
<a href="#l25.1708"></a><span id="l25.1708"> NS_IMETHODIMP</span>
<a href="#l25.1709"></a><span id="l25.1709" class="difflineminus">-nsMsgComposeService::Handle(nsICommandLine* aCmdLine)</span>
<a href="#l25.1710"></a><span id="l25.1710" class="difflineminus">-{</span>
<a href="#l25.1711"></a><span id="l25.1711" class="difflineplus">+nsMsgComposeService::Handle(nsICommandLine *aCmdLine) {</span>
<a href="#l25.1712"></a><span id="l25.1712">   NS_ENSURE_ARG_POINTER(aCmdLine);</span>
<a href="#l25.1713"></a><span id="l25.1713"> </span>
<a href="#l25.1714"></a><span id="l25.1714">   nsresult rv;</span>
<a href="#l25.1715"></a><span id="l25.1715">   int32_t found, end, count;</span>
<a href="#l25.1716"></a><span id="l25.1716">   nsAutoString uristr;</span>
<a href="#l25.1717"></a><span id="l25.1717">   bool composeShouldHandle = true;</span>
<a href="#l25.1718"></a><span id="l25.1718"> </span>
<a href="#l25.1719"></a><span id="l25.1719">   rv = aCmdLine-&gt;FindFlag(NS_LITERAL_STRING(&quot;compose&quot;), false, &amp;found);</span>
<a href="#l25.1720"></a><span id="l25.1720">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.1721"></a><span id="l25.1721"> </span>
<a href="#l25.1722"></a><span id="l25.1722"> #ifndef MOZ_SUITE</span>
<a href="#l25.1723"></a><span id="l25.1723">   // MAC OS X passes in -url mailto:mscott@mozilla.org into the command line</span>
<a href="#l25.1724"></a><span id="l25.1724">   // instead of -compose.</span>
<a href="#l25.1725"></a><span id="l25.1725" class="difflineminus">-  if (found == -1)</span>
<a href="#l25.1726"></a><span id="l25.1726" class="difflineminus">-  {</span>
<a href="#l25.1727"></a><span id="l25.1727" class="difflineplus">+  if (found == -1) {</span>
<a href="#l25.1728"></a><span id="l25.1728">     rv = aCmdLine-&gt;FindFlag(NS_LITERAL_STRING(&quot;url&quot;), false, &amp;found);</span>
<a href="#l25.1729"></a><span id="l25.1729" class="difflineminus">-    // we don't want to consume the argument for -url unless we're sure it is a mailto url and we'll</span>
<a href="#l25.1730"></a><span id="l25.1730" class="difflineminus">-    // figure that out shortly.</span>
<a href="#l25.1731"></a><span id="l25.1731" class="difflineplus">+    // we don't want to consume the argument for -url unless we're sure it is a</span>
<a href="#l25.1732"></a><span id="l25.1732" class="difflineplus">+    // mailto url and we'll figure that out shortly.</span>
<a href="#l25.1733"></a><span id="l25.1733">     composeShouldHandle = false;</span>
<a href="#l25.1734"></a><span id="l25.1734">   }</span>
<a href="#l25.1735"></a><span id="l25.1735"> #endif</span>
<a href="#l25.1736"></a><span id="l25.1736"> </span>
<a href="#l25.1737"></a><span id="l25.1737" class="difflineminus">-  if (found == -1)</span>
<a href="#l25.1738"></a><span id="l25.1738" class="difflineminus">-    return NS_OK;</span>
<a href="#l25.1739"></a><span id="l25.1739" class="difflineplus">+  if (found == -1) return NS_OK;</span>
<a href="#l25.1740"></a><span id="l25.1740"> </span>
<a href="#l25.1741"></a><span id="l25.1741">   end = found;</span>
<a href="#l25.1742"></a><span id="l25.1742"> </span>
<a href="#l25.1743"></a><span id="l25.1743">   rv = aCmdLine-&gt;GetLength(&amp;count);</span>
<a href="#l25.1744"></a><span id="l25.1744">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.1745"></a><span id="l25.1745"> </span>
<a href="#l25.1746"></a><span id="l25.1746">   if (count &gt; found + 1) {</span>
<a href="#l25.1747"></a><span id="l25.1747">     aCmdLine-&gt;GetArgument(found + 1, uristr);</span>
<a href="#l25.1748"></a><span id="l25.1748" class="difflineminus">-    if (StringBeginsWith(uristr, NS_LITERAL_STRING(&quot;mailto:&quot;))  ||</span>
<a href="#l25.1749"></a><span id="l25.1749" class="difflineplus">+    if (StringBeginsWith(uristr, NS_LITERAL_STRING(&quot;mailto:&quot;)) ||</span>
<a href="#l25.1750"></a><span id="l25.1750">         StringBeginsWith(uristr, NS_LITERAL_STRING(&quot;preselectid=&quot;)) ||</span>
<a href="#l25.1751"></a><span id="l25.1751" class="difflineminus">-        StringBeginsWith(uristr, NS_LITERAL_STRING(&quot;to=&quot;))  ||</span>
<a href="#l25.1752"></a><span id="l25.1752" class="difflineminus">-        StringBeginsWith(uristr, NS_LITERAL_STRING(&quot;cc=&quot;))  ||</span>
<a href="#l25.1753"></a><span id="l25.1753" class="difflineplus">+        StringBeginsWith(uristr, NS_LITERAL_STRING(&quot;to=&quot;)) ||</span>
<a href="#l25.1754"></a><span id="l25.1754" class="difflineplus">+        StringBeginsWith(uristr, NS_LITERAL_STRING(&quot;cc=&quot;)) ||</span>
<a href="#l25.1755"></a><span id="l25.1755">         StringBeginsWith(uristr, NS_LITERAL_STRING(&quot;bcc=&quot;)) ||</span>
<a href="#l25.1756"></a><span id="l25.1756">         StringBeginsWith(uristr, NS_LITERAL_STRING(&quot;newsgroups=&quot;)) ||</span>
<a href="#l25.1757"></a><span id="l25.1757">         StringBeginsWith(uristr, NS_LITERAL_STRING(&quot;subject=&quot;)) ||</span>
<a href="#l25.1758"></a><span id="l25.1758">         StringBeginsWith(uristr, NS_LITERAL_STRING(&quot;format=&quot;)) ||</span>
<a href="#l25.1759"></a><span id="l25.1759" class="difflineminus">-        StringBeginsWith(uristr, NS_LITERAL_STRING(&quot;body=&quot;))  ||</span>
<a href="#l25.1760"></a><span id="l25.1760" class="difflineplus">+        StringBeginsWith(uristr, NS_LITERAL_STRING(&quot;body=&quot;)) ||</span>
<a href="#l25.1761"></a><span id="l25.1761">         StringBeginsWith(uristr, NS_LITERAL_STRING(&quot;attachment=&quot;)) ||</span>
<a href="#l25.1762"></a><span id="l25.1762">         StringBeginsWith(uristr, NS_LITERAL_STRING(&quot;message=&quot;)) ||</span>
<a href="#l25.1763"></a><span id="l25.1763">         StringBeginsWith(uristr, NS_LITERAL_STRING(&quot;from=&quot;))) {</span>
<a href="#l25.1764"></a><span id="l25.1764" class="difflineminus">-      composeShouldHandle = true; // the -url argument looks like mailto</span>
<a href="#l25.1765"></a><span id="l25.1765" class="difflineplus">+      composeShouldHandle = true;  // the -url argument looks like mailto</span>
<a href="#l25.1766"></a><span id="l25.1766">       end++;</span>
<a href="#l25.1767"></a><span id="l25.1767">       // mailto: URIs are frequently passed with spaces in them. They should be</span>
<a href="#l25.1768"></a><span id="l25.1768">       // escaped with %20, but we hack around broken clients. See bug 231032.</span>
<a href="#l25.1769"></a><span id="l25.1769">       while (end + 1 &lt; count) {</span>
<a href="#l25.1770"></a><span id="l25.1770">         nsAutoString curarg;</span>
<a href="#l25.1771"></a><span id="l25.1771">         aCmdLine-&gt;GetArgument(end + 1, curarg);</span>
<a href="#l25.1772"></a><span id="l25.1772" class="difflineminus">-        if (curarg.First() == '-')</span>
<a href="#l25.1773"></a><span id="l25.1773" class="difflineminus">-          break;</span>
<a href="#l25.1774"></a><span id="l25.1774" class="difflineplus">+        if (curarg.First() == '-') break;</span>
<a href="#l25.1775"></a><span id="l25.1775"> </span>
<a href="#l25.1776"></a><span id="l25.1776">         uristr.Append(' ');</span>
<a href="#l25.1777"></a><span id="l25.1777">         uristr.Append(curarg);</span>
<a href="#l25.1778"></a><span id="l25.1778">         ++end;</span>
<a href="#l25.1779"></a><span id="l25.1779">       }</span>
<a href="#l25.1780"></a><span id="l25.1780" class="difflineminus">-    }</span>
<a href="#l25.1781"></a><span id="l25.1781" class="difflineminus">-    else {</span>
<a href="#l25.1782"></a><span id="l25.1782" class="difflineplus">+    } else {</span>
<a href="#l25.1783"></a><span id="l25.1783">       uristr.Truncate();</span>
<a href="#l25.1784"></a><span id="l25.1784">     }</span>
<a href="#l25.1785"></a><span id="l25.1785">   }</span>
<a href="#l25.1786"></a><span id="l25.1786" class="difflineminus">-  if (composeShouldHandle)</span>
<a href="#l25.1787"></a><span id="l25.1787" class="difflineminus">-  {</span>
<a href="#l25.1788"></a><span id="l25.1788" class="difflineplus">+  if (composeShouldHandle) {</span>
<a href="#l25.1789"></a><span id="l25.1789">     aCmdLine-&gt;RemoveArguments(found, end);</span>
<a href="#l25.1790"></a><span id="l25.1790"> </span>
<a href="#l25.1791"></a><span id="l25.1791" class="difflineminus">-    nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch (do_GetService(NS_WINDOWWATCHER_CONTRACTID));</span>
<a href="#l25.1792"></a><span id="l25.1792" class="difflineplus">+    nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch(</span>
<a href="#l25.1793"></a><span id="l25.1793" class="difflineplus">+        do_GetService(NS_WINDOWWATCHER_CONTRACTID));</span>
<a href="#l25.1794"></a><span id="l25.1794">     NS_ENSURE_TRUE(wwatch, NS_ERROR_FAILURE);</span>
<a href="#l25.1795"></a><span id="l25.1795"> </span>
<a href="#l25.1796"></a><span id="l25.1796" class="difflineminus">-    nsCOMPtr&lt;nsISupportsString&gt; arg(do_CreateInstance(NS_SUPPORTS_STRING_CONTRACTID));</span>
<a href="#l25.1797"></a><span id="l25.1797" class="difflineminus">-    if (arg)</span>
<a href="#l25.1798"></a><span id="l25.1798" class="difflineminus">-      arg-&gt;SetData(uristr);</span>
<a href="#l25.1799"></a><span id="l25.1799" class="difflineplus">+    nsCOMPtr&lt;nsISupportsString&gt; arg(</span>
<a href="#l25.1800"></a><span id="l25.1800" class="difflineplus">+        do_CreateInstance(NS_SUPPORTS_STRING_CONTRACTID));</span>
<a href="#l25.1801"></a><span id="l25.1801" class="difflineplus">+    if (arg) arg-&gt;SetData(uristr);</span>
<a href="#l25.1802"></a><span id="l25.1802"> </span>
<a href="#l25.1803"></a><span id="l25.1803">     nsCOMPtr&lt;mozIDOMWindowProxy&gt; opened;</span>
<a href="#l25.1804"></a><span id="l25.1804">     wwatch-&gt;OpenWindow(nullptr, DEFAULT_CHROME, &quot;_blank&quot;,</span>
<a href="#l25.1805"></a><span id="l25.1805">                        &quot;chrome,dialog=no,all&quot;, arg, getter_AddRefs(opened));</span>
<a href="#l25.1806"></a><span id="l25.1806"> </span>
<a href="#l25.1807"></a><span id="l25.1807">     aCmdLine-&gt;SetPreventDefault(true);</span>
<a href="#l25.1808"></a><span id="l25.1808">   }</span>
<a href="#l25.1809"></a><span id="l25.1809">   return NS_OK;</span>
<a href="#l25.1810"></a><span id="l25.1810"> }</span>
<a href="#l25.1811"></a><span id="l25.1811"> </span>
<a href="#l25.1812"></a><span id="l25.1812"> NS_IMETHODIMP</span>
<a href="#l25.1813"></a><span id="l25.1813" class="difflineminus">-nsMsgComposeService::GetHelpInfo(nsACString&amp; aResult)</span>
<a href="#l25.1814"></a><span id="l25.1814" class="difflineminus">-{</span>
<a href="#l25.1815"></a><span id="l25.1815" class="difflineplus">+nsMsgComposeService::GetHelpInfo(nsACString &amp;aResult) {</span>
<a href="#l25.1816"></a><span id="l25.1816" class="difflineplus">+  // clang-format off</span>
<a href="#l25.1817"></a><span id="l25.1817">   aResult.AssignLiteral(</span>
<a href="#l25.1818"></a><span id="l25.1818">     &quot;  -compose [ &lt;options&gt; ] Compose a mail or news message. Options are specified\n&quot;</span>
<a href="#l25.1819"></a><span id="l25.1819">     &quot;                     as string \&quot;option='value,...',option=value,...\&quot; and\n&quot;</span>
<a href="#l25.1820"></a><span id="l25.1820">     &quot;                     include: from, to, cc, bcc, newsgroups, subject, body,\n&quot;</span>
<a href="#l25.1821"></a><span id="l25.1821">     &quot;                     message (file), attachment (file), format (html | text).\n&quot;</span>
<a href="#l25.1822"></a><span id="l25.1822">     &quot;                     Example: \&quot;to=john@example.com,subject='Dinner tonight?'\&quot;\n&quot;);</span>
<a href="#l25.1823"></a><span id="l25.1823">   return NS_OK;</span>
<a href="#l25.1824"></a><span id="l25.1824" class="difflineplus">+  // clang-format on</span>
<a href="#l25.1825"></a><span id="l25.1825"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgComposeService.h</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgComposeService.h</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -13,57 +13,57 @@</span>
<a href="#l26.4"></a><span id="l26.4"> #include &quot;nsWeakReference.h&quot;</span>
<a href="#l26.5"></a><span id="l26.5"> #include &quot;nsIWeakReference.h&quot;</span>
<a href="#l26.6"></a><span id="l26.6"> #include &quot;nsIMimeStreamConverter.h&quot;</span>
<a href="#l26.7"></a><span id="l26.7"> #include &quot;nsInterfaceHashtable.h&quot;</span>
<a href="#l26.8"></a><span id="l26.8"> </span>
<a href="#l26.9"></a><span id="l26.9"> #include &quot;nsICommandLineHandler.h&quot;</span>
<a href="#l26.10"></a><span id="l26.10"> #define ICOMMANDLINEHANDLER nsICommandLineHandler</span>
<a href="#l26.11"></a><span id="l26.11"> </span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-class nsMsgComposeService :</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineminus">-  public nsIMsgComposeService,</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineminus">-  public ICOMMANDLINEHANDLER,</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineminus">-  public nsSupportsWeakReference</span>
<a href="#l26.16"></a><span id="l26.16" class="difflineminus">-{</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineminus">-public:</span>
<a href="#l26.18"></a><span id="l26.18" class="difflineplus">+class nsMsgComposeService : public nsIMsgComposeService,</span>
<a href="#l26.19"></a><span id="l26.19" class="difflineplus">+                            public ICOMMANDLINEHANDLER,</span>
<a href="#l26.20"></a><span id="l26.20" class="difflineplus">+                            public nsSupportsWeakReference {</span>
<a href="#l26.21"></a><span id="l26.21" class="difflineplus">+ public:</span>
<a href="#l26.22"></a><span id="l26.22">   nsMsgComposeService();</span>
<a href="#l26.23"></a><span id="l26.23"> </span>
<a href="#l26.24"></a><span id="l26.24">   NS_DECL_ISUPPORTS</span>
<a href="#l26.25"></a><span id="l26.25">   NS_DECL_NSIMSGCOMPOSESERVICE</span>
<a href="#l26.26"></a><span id="l26.26">   NS_DECL_NSICOMMANDLINEHANDLER</span>
<a href="#l26.27"></a><span id="l26.27"> </span>
<a href="#l26.28"></a><span id="l26.28">   nsresult Init();</span>
<a href="#l26.29"></a><span id="l26.29">   void Reset();</span>
<a href="#l26.30"></a><span id="l26.30">   void DeleteCachedWindows();</span>
<a href="#l26.31"></a><span id="l26.31">   nsresult AddGlobalHtmlDomains();</span>
<a href="#l26.32"></a><span id="l26.32"> </span>
<a href="#l26.33"></a><span id="l26.33" class="difflineminus">-private:</span>
<a href="#l26.34"></a><span id="l26.34" class="difflineplus">+ private:</span>
<a href="#l26.35"></a><span id="l26.35">   virtual ~nsMsgComposeService();</span>
<a href="#l26.36"></a><span id="l26.36">   bool mLogComposePerformance;</span>
<a href="#l26.37"></a><span id="l26.37"> </span>
<a href="#l26.38"></a><span id="l26.38" class="difflineminus">-  nsresult LoadDraftOrTemplate(const nsACString&amp; aMsgURI, nsMimeOutputType aOutType,</span>
<a href="#l26.39"></a><span id="l26.39" class="difflineminus">-                               nsIMsgIdentity * aIdentity, const char * aOriginalMsgURI,</span>
<a href="#l26.40"></a><span id="l26.40" class="difflineminus">-                               nsIMsgDBHdr * aOrigMsgHdr, bool aForwardInline,</span>
<a href="#l26.41"></a><span id="l26.41" class="difflineplus">+  nsresult LoadDraftOrTemplate(const nsACString &amp;aMsgURI,</span>
<a href="#l26.42"></a><span id="l26.42" class="difflineplus">+                               nsMimeOutputType aOutType,</span>
<a href="#l26.43"></a><span id="l26.43" class="difflineplus">+                               nsIMsgIdentity *aIdentity,</span>
<a href="#l26.44"></a><span id="l26.44" class="difflineplus">+                               const char *aOriginalMsgURI,</span>
<a href="#l26.45"></a><span id="l26.45" class="difflineplus">+                               nsIMsgDBHdr *aOrigMsgHdr, bool aForwardInline,</span>
<a href="#l26.46"></a><span id="l26.46">                                bool overrideComposeFormat,</span>
<a href="#l26.47"></a><span id="l26.47">                                nsIMsgWindow *aMsgWindow);</span>
<a href="#l26.48"></a><span id="l26.48"> </span>
<a href="#l26.49"></a><span id="l26.49" class="difflineminus">-  nsresult RunMessageThroughMimeDraft(const nsACString&amp; aMsgURI,</span>
<a href="#l26.50"></a><span id="l26.50" class="difflineminus">-                                      nsMimeOutputType aOutType,</span>
<a href="#l26.51"></a><span id="l26.51" class="difflineminus">-                                      nsIMsgIdentity * aIdentity,</span>
<a href="#l26.52"></a><span id="l26.52" class="difflineminus">-                                      const char * aOriginalMsgURI,</span>
<a href="#l26.53"></a><span id="l26.53" class="difflineminus">-                                      nsIMsgDBHdr * aOrigMsgHdr,</span>
<a href="#l26.54"></a><span id="l26.54" class="difflineminus">-                                      bool aForwardInline,</span>
<a href="#l26.55"></a><span id="l26.55" class="difflineminus">-                                      const nsAString &amp;forwardTo,</span>
<a href="#l26.56"></a><span id="l26.56" class="difflineminus">-                                      bool overrideComposeFormat,</span>
<a href="#l26.57"></a><span id="l26.57" class="difflineminus">-                                      nsIMsgWindow *aMsgWindow);</span>
<a href="#l26.58"></a><span id="l26.58" class="difflineplus">+  nsresult RunMessageThroughMimeDraft(</span>
<a href="#l26.59"></a><span id="l26.59" class="difflineplus">+      const nsACString &amp;aMsgURI, nsMimeOutputType aOutType,</span>
<a href="#l26.60"></a><span id="l26.60" class="difflineplus">+      nsIMsgIdentity *aIdentity, const char *aOriginalMsgURI,</span>
<a href="#l26.61"></a><span id="l26.61" class="difflineplus">+      nsIMsgDBHdr *aOrigMsgHdr, bool aForwardInline, const nsAString &amp;forwardTo,</span>
<a href="#l26.62"></a><span id="l26.62" class="difflineplus">+      bool overrideComposeFormat, nsIMsgWindow *aMsgWindow);</span>
<a href="#l26.63"></a><span id="l26.63"> </span>
<a href="#l26.64"></a><span id="l26.64">   // hash table mapping dom windows to nsIMsgCompose objects</span>
<a href="#l26.65"></a><span id="l26.65" class="difflineminus">-  nsInterfaceHashtable&lt;nsISupportsHashKey, nsIWeakReference&gt; mOpenComposeWindows;</span>
<a href="#l26.66"></a><span id="l26.66" class="difflineplus">+  nsInterfaceHashtable&lt;nsISupportsHashKey, nsIWeakReference&gt;</span>
<a href="#l26.67"></a><span id="l26.67" class="difflineplus">+      mOpenComposeWindows;</span>
<a href="#l26.68"></a><span id="l26.68"> </span>
<a href="#l26.69"></a><span id="l26.69" class="difflineminus">-  // When doing a reply and the settings are enabled, get the HTML of the selected text</span>
<a href="#l26.70"></a><span id="l26.70" class="difflineminus">-  // in the original message window so that it can be quoted instead of the entire message.</span>
<a href="#l26.71"></a><span id="l26.71" class="difflineminus">-  nsresult GetOrigWindowSelection(MSG_ComposeType type, nsIMsgWindow *aMsgWindow, nsACString&amp; aSelHTML);</span>
<a href="#l26.72"></a><span id="l26.72" class="difflineplus">+  // When doing a reply and the settings are enabled, get the HTML of the</span>
<a href="#l26.73"></a><span id="l26.73" class="difflineplus">+  // selected text in the original message window so that it can be quoted</span>
<a href="#l26.74"></a><span id="l26.74" class="difflineplus">+  // instead of the entire message.</span>
<a href="#l26.75"></a><span id="l26.75" class="difflineplus">+  nsresult GetOrigWindowSelection(MSG_ComposeType type,</span>
<a href="#l26.76"></a><span id="l26.76" class="difflineplus">+                                  nsIMsgWindow *aMsgWindow,</span>
<a href="#l26.77"></a><span id="l26.77" class="difflineplus">+                                  nsACString &amp;aSelHTML);</span>
<a href="#l26.78"></a><span id="l26.78"> </span>
<a href="#l26.79"></a><span id="l26.79"> #ifdef MSGCOMP_TRACE_PERFORMANCE</span>
<a href="#l26.80"></a><span id="l26.80" class="difflineminus">-  PRIntervalTime            mStartTime;</span>
<a href="#l26.81"></a><span id="l26.81" class="difflineminus">-  PRIntervalTime            mPreviousTime;</span>
<a href="#l26.82"></a><span id="l26.82" class="difflineplus">+  PRIntervalTime mStartTime;</span>
<a href="#l26.83"></a><span id="l26.83" class="difflineplus">+  PRIntervalTime mPreviousTime;</span>
<a href="#l26.84"></a><span id="l26.84"> #endif</span>
<a href="#l26.85"></a><span id="l26.85"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCopy.cpp</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCopy.cpp</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -26,346 +26,286 @@</span>
<a href="#l27.4"></a><span id="l27.4"> #include &quot;prmem.h&quot;</span>
<a href="#l27.5"></a><span id="l27.5"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l27.6"></a><span id="l27.6"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l27.7"></a><span id="l27.7"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l27.8"></a><span id="l27.8"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l27.9"></a><span id="l27.9"> #include &quot;nsIURIMutator.h&quot;</span>
<a href="#l27.10"></a><span id="l27.10"> </span>
<a href="#l27.11"></a><span id="l27.11"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-// This is the listener class for the copy operation. We have to create this class</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineminus">-// to listen for message copy completion and eventually notify the caller</span>
<a href="#l27.14"></a><span id="l27.14" class="difflineplus">+// This is the listener class for the copy operation. We have to create this</span>
<a href="#l27.15"></a><span id="l27.15" class="difflineplus">+// class to listen for message copy completion and eventually notify the caller</span>
<a href="#l27.16"></a><span id="l27.16"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l27.17"></a><span id="l27.17"> NS_IMPL_ISUPPORTS(CopyListener, nsIMsgCopyServiceListener)</span>
<a href="#l27.18"></a><span id="l27.18"> </span>
<a href="#l27.19"></a><span id="l27.19" class="difflineminus">-CopyListener::CopyListener(void)</span>
<a href="#l27.20"></a><span id="l27.20" class="difflineminus">-{</span>
<a href="#l27.21"></a><span id="l27.21" class="difflineminus">-  mCopyInProgress = false;</span>
<a href="#l27.22"></a><span id="l27.22" class="difflineminus">-}</span>
<a href="#l27.23"></a><span id="l27.23" class="difflineplus">+CopyListener::CopyListener(void) { mCopyInProgress = false; }</span>
<a href="#l27.24"></a><span id="l27.24"> </span>
<a href="#l27.25"></a><span id="l27.25" class="difflineminus">-CopyListener::~CopyListener(void)</span>
<a href="#l27.26"></a><span id="l27.26" class="difflineminus">-{</span>
<a href="#l27.27"></a><span id="l27.27" class="difflineminus">-}</span>
<a href="#l27.28"></a><span id="l27.28" class="difflineplus">+CopyListener::~CopyListener(void) {}</span>
<a href="#l27.29"></a><span id="l27.29"> </span>
<a href="#l27.30"></a><span id="l27.30" class="difflineminus">-nsresult</span>
<a href="#l27.31"></a><span id="l27.31" class="difflineminus">-CopyListener::OnStartCopy()</span>
<a href="#l27.32"></a><span id="l27.32" class="difflineminus">-{</span>
<a href="#l27.33"></a><span id="l27.33" class="difflineplus">+nsresult CopyListener::OnStartCopy() {</span>
<a href="#l27.34"></a><span id="l27.34"> #ifdef NS_DEBUG</span>
<a href="#l27.35"></a><span id="l27.35">   printf(&quot;CopyListener::OnStartCopy()\n&quot;);</span>
<a href="#l27.36"></a><span id="l27.36"> #endif</span>
<a href="#l27.37"></a><span id="l27.37"> </span>
<a href="#l27.38"></a><span id="l27.38" class="difflineminus">-  if (mComposeAndSend)</span>
<a href="#l27.39"></a><span id="l27.39" class="difflineminus">-    mComposeAndSend-&gt;NotifyListenerOnStartCopy();</span>
<a href="#l27.40"></a><span id="l27.40" class="difflineplus">+  if (mComposeAndSend) mComposeAndSend-&gt;NotifyListenerOnStartCopy();</span>
<a href="#l27.41"></a><span id="l27.41">   return NS_OK;</span>
<a href="#l27.42"></a><span id="l27.42"> }</span>
<a href="#l27.43"></a><span id="l27.43"> </span>
<a href="#l27.44"></a><span id="l27.44" class="difflineminus">-nsresult</span>
<a href="#l27.45"></a><span id="l27.45" class="difflineminus">-CopyListener::OnProgress(uint32_t aProgress, uint32_t aProgressMax)</span>
<a href="#l27.46"></a><span id="l27.46" class="difflineminus">-{</span>
<a href="#l27.47"></a><span id="l27.47" class="difflineplus">+nsresult CopyListener::OnProgress(uint32_t aProgress, uint32_t aProgressMax) {</span>
<a href="#l27.48"></a><span id="l27.48"> #ifdef NS_DEBUG</span>
<a href="#l27.49"></a><span id="l27.49">   printf(&quot;CopyListener::OnProgress() %d of %d\n&quot;, aProgress, aProgressMax);</span>
<a href="#l27.50"></a><span id="l27.50"> #endif</span>
<a href="#l27.51"></a><span id="l27.51"> </span>
<a href="#l27.52"></a><span id="l27.52">   if (mComposeAndSend)</span>
<a href="#l27.53"></a><span id="l27.53">     mComposeAndSend-&gt;NotifyListenerOnProgressCopy(aProgress, aProgressMax);</span>
<a href="#l27.54"></a><span id="l27.54"> </span>
<a href="#l27.55"></a><span id="l27.55">   return NS_OK;</span>
<a href="#l27.56"></a><span id="l27.56"> }</span>
<a href="#l27.57"></a><span id="l27.57"> </span>
<a href="#l27.58"></a><span id="l27.58" class="difflineminus">-nsresult</span>
<a href="#l27.59"></a><span id="l27.59" class="difflineminus">-CopyListener::SetMessageKey(nsMsgKey aMessageKey)</span>
<a href="#l27.60"></a><span id="l27.60" class="difflineminus">-{</span>
<a href="#l27.61"></a><span id="l27.61" class="difflineminus">-  if (mComposeAndSend)</span>
<a href="#l27.62"></a><span id="l27.62" class="difflineminus">-      mComposeAndSend-&gt;SetMessageKey(aMessageKey);</span>
<a href="#l27.63"></a><span id="l27.63" class="difflineplus">+nsresult CopyListener::SetMessageKey(nsMsgKey aMessageKey) {</span>
<a href="#l27.64"></a><span id="l27.64" class="difflineplus">+  if (mComposeAndSend) mComposeAndSend-&gt;SetMessageKey(aMessageKey);</span>
<a href="#l27.65"></a><span id="l27.65">   return NS_OK;</span>
<a href="#l27.66"></a><span id="l27.66"> }</span>
<a href="#l27.67"></a><span id="l27.67"> </span>
<a href="#l27.68"></a><span id="l27.68"> NS_IMETHODIMP</span>
<a href="#l27.69"></a><span id="l27.69" class="difflineminus">-CopyListener::GetMessageId(nsACString&amp; aMessageId)</span>
<a href="#l27.70"></a><span id="l27.70" class="difflineminus">-{</span>
<a href="#l27.71"></a><span id="l27.71" class="difflineminus">-  if (mComposeAndSend)</span>
<a href="#l27.72"></a><span id="l27.72" class="difflineminus">-    mComposeAndSend-&gt;GetMessageId(aMessageId);</span>
<a href="#l27.73"></a><span id="l27.73" class="difflineplus">+CopyListener::GetMessageId(nsACString &amp;aMessageId) {</span>
<a href="#l27.74"></a><span id="l27.74" class="difflineplus">+  if (mComposeAndSend) mComposeAndSend-&gt;GetMessageId(aMessageId);</span>
<a href="#l27.75"></a><span id="l27.75">   return NS_OK;</span>
<a href="#l27.76"></a><span id="l27.76"> }</span>
<a href="#l27.77"></a><span id="l27.77"> </span>
<a href="#l27.78"></a><span id="l27.78" class="difflineminus">-nsresult</span>
<a href="#l27.79"></a><span id="l27.79" class="difflineminus">-CopyListener::OnStopCopy(nsresult aStatus)</span>
<a href="#l27.80"></a><span id="l27.80" class="difflineminus">-{</span>
<a href="#l27.81"></a><span id="l27.81" class="difflineminus">-  if (NS_SUCCEEDED(aStatus))</span>
<a href="#l27.82"></a><span id="l27.82" class="difflineminus">-  {</span>
<a href="#l27.83"></a><span id="l27.83" class="difflineplus">+nsresult CopyListener::OnStopCopy(nsresult aStatus) {</span>
<a href="#l27.84"></a><span id="l27.84" class="difflineplus">+  if (NS_SUCCEEDED(aStatus)) {</span>
<a href="#l27.85"></a><span id="l27.85"> #ifdef NS_DEBUG</span>
<a href="#l27.86"></a><span id="l27.86">     printf(&quot;CopyListener: SUCCESSFUL ON THE COPY OPERATION!\n&quot;);</span>
<a href="#l27.87"></a><span id="l27.87"> #endif</span>
<a href="#l27.88"></a><span id="l27.88" class="difflineminus">-  }</span>
<a href="#l27.89"></a><span id="l27.89" class="difflineminus">-  else</span>
<a href="#l27.90"></a><span id="l27.90" class="difflineminus">-  {</span>
<a href="#l27.91"></a><span id="l27.91" class="difflineplus">+  } else {</span>
<a href="#l27.92"></a><span id="l27.92"> #ifdef NS_DEBUG</span>
<a href="#l27.93"></a><span id="l27.93">     printf(&quot;CopyListener: COPY OPERATION FAILED!\n&quot;);</span>
<a href="#l27.94"></a><span id="l27.94"> #endif</span>
<a href="#l27.95"></a><span id="l27.95">   }</span>
<a href="#l27.96"></a><span id="l27.96"> </span>
<a href="#l27.97"></a><span id="l27.97" class="difflineminus">-  if (mCopyInProgress)</span>
<a href="#l27.98"></a><span id="l27.98" class="difflineminus">-  {</span>
<a href="#l27.99"></a><span id="l27.99" class="difflineminus">-      PR_CEnterMonitor(this);</span>
<a href="#l27.100"></a><span id="l27.100" class="difflineminus">-      PR_CNotifyAll(this);</span>
<a href="#l27.101"></a><span id="l27.101" class="difflineminus">-      mCopyInProgress = false;</span>
<a href="#l27.102"></a><span id="l27.102" class="difflineminus">-      PR_CExitMonitor(this);</span>
<a href="#l27.103"></a><span id="l27.103" class="difflineplus">+  if (mCopyInProgress) {</span>
<a href="#l27.104"></a><span id="l27.104" class="difflineplus">+    PR_CEnterMonitor(this);</span>
<a href="#l27.105"></a><span id="l27.105" class="difflineplus">+    PR_CNotifyAll(this);</span>
<a href="#l27.106"></a><span id="l27.106" class="difflineplus">+    mCopyInProgress = false;</span>
<a href="#l27.107"></a><span id="l27.107" class="difflineplus">+    PR_CExitMonitor(this);</span>
<a href="#l27.108"></a><span id="l27.108">   }</span>
<a href="#l27.109"></a><span id="l27.109" class="difflineminus">-  if (mComposeAndSend)</span>
<a href="#l27.110"></a><span id="l27.110" class="difflineminus">-    mComposeAndSend-&gt;NotifyListenerOnStopCopy(aStatus);</span>
<a href="#l27.111"></a><span id="l27.111" class="difflineplus">+  if (mComposeAndSend) mComposeAndSend-&gt;NotifyListenerOnStopCopy(aStatus);</span>
<a href="#l27.112"></a><span id="l27.112"> </span>
<a href="#l27.113"></a><span id="l27.113">   return NS_OK;</span>
<a href="#l27.114"></a><span id="l27.114"> }</span>
<a href="#l27.115"></a><span id="l27.115"> </span>
<a href="#l27.116"></a><span id="l27.116" class="difflineminus">-nsresult</span>
<a href="#l27.117"></a><span id="l27.117" class="difflineminus">-CopyListener::SetMsgComposeAndSendObject(nsIMsgSend *obj)</span>
<a href="#l27.118"></a><span id="l27.118" class="difflineminus">-{</span>
<a href="#l27.119"></a><span id="l27.119" class="difflineminus">-  if (obj)</span>
<a href="#l27.120"></a><span id="l27.120" class="difflineminus">-    mComposeAndSend = obj;</span>
<a href="#l27.121"></a><span id="l27.121" class="difflineplus">+nsresult CopyListener::SetMsgComposeAndSendObject(nsIMsgSend *obj) {</span>
<a href="#l27.122"></a><span id="l27.122" class="difflineplus">+  if (obj) mComposeAndSend = obj;</span>
<a href="#l27.123"></a><span id="l27.123"> </span>
<a href="#l27.124"></a><span id="l27.124">   return NS_OK;</span>
<a href="#l27.125"></a><span id="l27.125"> }</span>
<a href="#l27.126"></a><span id="l27.126"> </span>
<a href="#l27.127"></a><span id="l27.127"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l27.128"></a><span id="l27.128"> // END  END  END  END  END  END  END  END  END  END  END  END  END  END  END</span>
<a href="#l27.129"></a><span id="l27.129" class="difflineminus">-// This is the listener class for the copy operation. We have to create this class</span>
<a href="#l27.130"></a><span id="l27.130" class="difflineminus">-// to listen for message copy completion and eventually notify the caller</span>
<a href="#l27.131"></a><span id="l27.131" class="difflineplus">+// This is the listener class for the copy operation. We have to create this</span>
<a href="#l27.132"></a><span id="l27.132" class="difflineplus">+// class to listen for message copy completion and eventually notify the caller</span>
<a href="#l27.133"></a><span id="l27.133"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l27.134"></a><span id="l27.134"> </span>
<a href="#l27.135"></a><span id="l27.135"> NS_IMPL_ISUPPORTS(nsMsgCopy, nsIUrlListener)</span>
<a href="#l27.136"></a><span id="l27.136"> </span>
<a href="#l27.137"></a><span id="l27.137" class="difflineminus">-nsMsgCopy::nsMsgCopy()</span>
<a href="#l27.138"></a><span id="l27.138" class="difflineminus">-{</span>
<a href="#l27.139"></a><span id="l27.139" class="difflineplus">+nsMsgCopy::nsMsgCopy() {</span>
<a href="#l27.140"></a><span id="l27.140">   mFile = nullptr;</span>
<a href="#l27.141"></a><span id="l27.141">   mMode = nsIMsgSend::nsMsgDeliverNow;</span>
<a href="#l27.142"></a><span id="l27.142">   mSavePref = nullptr;</span>
<a href="#l27.143"></a><span id="l27.143"> }</span>
<a href="#l27.144"></a><span id="l27.144"> </span>
<a href="#l27.145"></a><span id="l27.145" class="difflineminus">-nsMsgCopy::~nsMsgCopy()</span>
<a href="#l27.146"></a><span id="l27.146" class="difflineminus">-{</span>
<a href="#l27.147"></a><span id="l27.147" class="difflineminus">-  PR_Free(mSavePref);</span>
<a href="#l27.148"></a><span id="l27.148" class="difflineminus">-}</span>
<a href="#l27.149"></a><span id="l27.149" class="difflineplus">+nsMsgCopy::~nsMsgCopy() { PR_Free(mSavePref); }</span>
<a href="#l27.150"></a><span id="l27.150"> </span>
<a href="#l27.151"></a><span id="l27.151" class="difflineminus">-nsresult</span>
<a href="#l27.152"></a><span id="l27.152" class="difflineminus">-nsMsgCopy::StartCopyOperation(nsIMsgIdentity       *aUserIdentity,</span>
<a href="#l27.153"></a><span id="l27.153" class="difflineminus">-                              nsIFile          *aFile,</span>
<a href="#l27.154"></a><span id="l27.154" class="difflineminus">-                              nsMsgDeliverMode     aMode,</span>
<a href="#l27.155"></a><span id="l27.155" class="difflineminus">-                              nsIMsgSend           *aMsgSendObj,</span>
<a href="#l27.156"></a><span id="l27.156" class="difflineminus">-                              const char           *aSavePref,</span>
<a href="#l27.157"></a><span id="l27.157" class="difflineminus">-                              nsIMsgDBHdr            *aMsgToReplace)</span>
<a href="#l27.158"></a><span id="l27.158" class="difflineminus">-{</span>
<a href="#l27.159"></a><span id="l27.159" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolder&gt;  dstFolder;</span>
<a href="#l27.160"></a><span id="l27.160" class="difflineminus">-  bool                    isDraft = false;</span>
<a href="#l27.161"></a><span id="l27.161" class="difflineminus">-  bool                    waitForUrl = false;</span>
<a href="#l27.162"></a><span id="l27.162" class="difflineminus">-  nsresult                rv;</span>
<a href="#l27.163"></a><span id="l27.163" class="difflineplus">+nsresult nsMsgCopy::StartCopyOperation(nsIMsgIdentity *aUserIdentity,</span>
<a href="#l27.164"></a><span id="l27.164" class="difflineplus">+                                       nsIFile *aFile, nsMsgDeliverMode aMode,</span>
<a href="#l27.165"></a><span id="l27.165" class="difflineplus">+                                       nsIMsgSend *aMsgSendObj,</span>
<a href="#l27.166"></a><span id="l27.166" class="difflineplus">+                                       const char *aSavePref,</span>
<a href="#l27.167"></a><span id="l27.167" class="difflineplus">+                                       nsIMsgDBHdr *aMsgToReplace) {</span>
<a href="#l27.168"></a><span id="l27.168" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; dstFolder;</span>
<a href="#l27.169"></a><span id="l27.169" class="difflineplus">+  bool isDraft = false;</span>
<a href="#l27.170"></a><span id="l27.170" class="difflineplus">+  bool waitForUrl = false;</span>
<a href="#l27.171"></a><span id="l27.171" class="difflineplus">+  nsresult rv;</span>
<a href="#l27.172"></a><span id="l27.172"> </span>
<a href="#l27.173"></a><span id="l27.173" class="difflineminus">-  if (!aMsgSendObj)</span>
<a href="#l27.174"></a><span id="l27.174" class="difflineminus">-    return NS_ERROR_INVALID_ARG;</span>
<a href="#l27.175"></a><span id="l27.175" class="difflineplus">+  if (!aMsgSendObj) return NS_ERROR_INVALID_ARG;</span>
<a href="#l27.176"></a><span id="l27.176"> </span>
<a href="#l27.177"></a><span id="l27.177">   // Store away the server location...</span>
<a href="#l27.178"></a><span id="l27.178" class="difflineminus">-  if (aSavePref)</span>
<a href="#l27.179"></a><span id="l27.179" class="difflineminus">-    mSavePref = PL_strdup(aSavePref);</span>
<a href="#l27.180"></a><span id="l27.180" class="difflineplus">+  if (aSavePref) mSavePref = PL_strdup(aSavePref);</span>
<a href="#l27.181"></a><span id="l27.181"> </span>
<a href="#l27.182"></a><span id="l27.182">   //</span>
<a href="#l27.183"></a><span id="l27.183">   // Vars for implementation...</span>
<a href="#l27.184"></a><span id="l27.184">   //</span>
<a href="#l27.185"></a><span id="l27.185"> </span>
<a href="#l27.186"></a><span id="l27.186">   // QueueForLater (Outbox)</span>
<a href="#l27.187"></a><span id="l27.187">   if (aMode == nsIMsgSend::nsMsgQueueForLater ||</span>
<a href="#l27.188"></a><span id="l27.188" class="difflineminus">-      aMode == nsIMsgSend::nsMsgDeliverBackground)</span>
<a href="#l27.189"></a><span id="l27.189" class="difflineminus">-  {</span>
<a href="#l27.190"></a><span id="l27.190" class="difflineminus">-    rv = GetUnsentMessagesFolder(aUserIdentity, getter_AddRefs(dstFolder), &amp;waitForUrl);</span>
<a href="#l27.191"></a><span id="l27.191" class="difflineplus">+      aMode == nsIMsgSend::nsMsgDeliverBackground) {</span>
<a href="#l27.192"></a><span id="l27.192" class="difflineplus">+    rv = GetUnsentMessagesFolder(aUserIdentity, getter_AddRefs(dstFolder),</span>
<a href="#l27.193"></a><span id="l27.193" class="difflineplus">+                                 &amp;waitForUrl);</span>
<a href="#l27.194"></a><span id="l27.194">     isDraft = false;</span>
<a href="#l27.195"></a><span id="l27.195">     if (!dstFolder || NS_FAILED(rv)) {</span>
<a href="#l27.196"></a><span id="l27.196">       return NS_MSG_UNABLE_TO_SEND_LATER;</span>
<a href="#l27.197"></a><span id="l27.197">     }</span>
<a href="#l27.198"></a><span id="l27.198" class="difflineminus">-  }</span>
<a href="#l27.199"></a><span id="l27.199" class="difflineminus">-  else if (aMode == nsIMsgSend::nsMsgSaveAsDraft)    // SaveAsDraft (Drafts)</span>
<a href="#l27.200"></a><span id="l27.200" class="difflineplus">+  } else if (aMode == nsIMsgSend::nsMsgSaveAsDraft)  // SaveAsDraft (Drafts)</span>
<a href="#l27.201"></a><span id="l27.201">   {</span>
<a href="#l27.202"></a><span id="l27.202">     rv = GetDraftsFolder(aUserIdentity, getter_AddRefs(dstFolder), &amp;waitForUrl);</span>
<a href="#l27.203"></a><span id="l27.203">     isDraft = true;</span>
<a href="#l27.204"></a><span id="l27.204" class="difflineminus">-    if (!dstFolder || NS_FAILED(rv))</span>
<a href="#l27.205"></a><span id="l27.205" class="difflineminus">-      return NS_MSG_UNABLE_TO_SAVE_DRAFT;</span>
<a href="#l27.206"></a><span id="l27.206" class="difflineminus">-  }</span>
<a href="#l27.207"></a><span id="l27.207" class="difflineminus">-  else if (aMode == nsIMsgSend::nsMsgSaveAsTemplate) // SaveAsTemplate (Templates)</span>
<a href="#l27.208"></a><span id="l27.208" class="difflineplus">+    if (!dstFolder || NS_FAILED(rv)) return NS_MSG_UNABLE_TO_SAVE_DRAFT;</span>
<a href="#l27.209"></a><span id="l27.209" class="difflineplus">+  } else if (aMode ==</span>
<a href="#l27.210"></a><span id="l27.210" class="difflineplus">+             nsIMsgSend::nsMsgSaveAsTemplate)  // SaveAsTemplate (Templates)</span>
<a href="#l27.211"></a><span id="l27.211">   {</span>
<a href="#l27.212"></a><span id="l27.212" class="difflineminus">-    rv = GetTemplatesFolder(aUserIdentity, getter_AddRefs(dstFolder), &amp;waitForUrl);</span>
<a href="#l27.213"></a><span id="l27.213" class="difflineplus">+    rv = GetTemplatesFolder(aUserIdentity, getter_AddRefs(dstFolder),</span>
<a href="#l27.214"></a><span id="l27.214" class="difflineplus">+                            &amp;waitForUrl);</span>
<a href="#l27.215"></a><span id="l27.215">     isDraft = false;</span>
<a href="#l27.216"></a><span id="l27.216" class="difflineminus">-    if (!dstFolder || NS_FAILED(rv))</span>
<a href="#l27.217"></a><span id="l27.217" class="difflineminus">-      return NS_MSG_UNABLE_TO_SAVE_TEMPLATE;</span>
<a href="#l27.218"></a><span id="l27.218" class="difflineminus">-  }</span>
<a href="#l27.219"></a><span id="l27.219" class="difflineminus">-  else // SaveInSentFolder (Sent) -  nsMsgDeliverNow or nsMsgSendUnsent</span>
<a href="#l27.220"></a><span id="l27.220" class="difflineplus">+    if (!dstFolder || NS_FAILED(rv)) return NS_MSG_UNABLE_TO_SAVE_TEMPLATE;</span>
<a href="#l27.221"></a><span id="l27.221" class="difflineplus">+  } else  // SaveInSentFolder (Sent) -  nsMsgDeliverNow or nsMsgSendUnsent</span>
<a href="#l27.222"></a><span id="l27.222">   {</span>
<a href="#l27.223"></a><span id="l27.223">     rv = GetSentFolder(aUserIdentity, getter_AddRefs(dstFolder), &amp;waitForUrl);</span>
<a href="#l27.224"></a><span id="l27.224">     isDraft = false;</span>
<a href="#l27.225"></a><span id="l27.225" class="difflineminus">-    if (!dstFolder || NS_FAILED(rv))</span>
<a href="#l27.226"></a><span id="l27.226" class="difflineminus">-      return NS_MSG_COULDNT_OPEN_FCC_FOLDER;</span>
<a href="#l27.227"></a><span id="l27.227" class="difflineplus">+    if (!dstFolder || NS_FAILED(rv)) return NS_MSG_COULDNT_OPEN_FCC_FOLDER;</span>
<a href="#l27.228"></a><span id="l27.228">   }</span>
<a href="#l27.229"></a><span id="l27.229"> </span>
<a href="#l27.230"></a><span id="l27.230" class="difflineminus">-  nsCOMPtr &lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l27.231"></a><span id="l27.231" class="difflineplus">+  nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l27.232"></a><span id="l27.232"> </span>
<a href="#l27.233"></a><span id="l27.233" class="difflineminus">-  if (aMsgSendObj)</span>
<a href="#l27.234"></a><span id="l27.234" class="difflineminus">-  {</span>
<a href="#l27.235"></a><span id="l27.235" class="difflineminus">-    nsCOMPtr &lt;nsIMsgProgress&gt; progress;</span>
<a href="#l27.236"></a><span id="l27.236" class="difflineplus">+  if (aMsgSendObj) {</span>
<a href="#l27.237"></a><span id="l27.237" class="difflineplus">+    nsCOMPtr&lt;nsIMsgProgress&gt; progress;</span>
<a href="#l27.238"></a><span id="l27.238">     aMsgSendObj-&gt;GetProgress(getter_AddRefs(progress));</span>
<a href="#l27.239"></a><span id="l27.239" class="difflineminus">-    if (progress)</span>
<a href="#l27.240"></a><span id="l27.240" class="difflineminus">-      progress-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l27.241"></a><span id="l27.241" class="difflineplus">+    if (progress) progress-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l27.242"></a><span id="l27.242">   }</span>
<a href="#l27.243"></a><span id="l27.243"> </span>
<a href="#l27.244"></a><span id="l27.244">   mMode = aMode;</span>
<a href="#l27.245"></a><span id="l27.245">   mFile = aFile;</span>
<a href="#l27.246"></a><span id="l27.246">   mDstFolder = dstFolder;</span>
<a href="#l27.247"></a><span id="l27.247">   mMsgToReplace = aMsgToReplace;</span>
<a href="#l27.248"></a><span id="l27.248">   mIsDraft = isDraft;</span>
<a href="#l27.249"></a><span id="l27.249">   mMsgSendObj = aMsgSendObj;</span>
<a href="#l27.250"></a><span id="l27.250" class="difflineminus">-  if (!waitForUrl)</span>
<a href="#l27.251"></a><span id="l27.251" class="difflineminus">-  {</span>
<a href="#l27.252"></a><span id="l27.252" class="difflineplus">+  if (!waitForUrl) {</span>
<a href="#l27.253"></a><span id="l27.253">     // cache info needed for DoCopy and call DoCopy when OnStopUrl is called.</span>
<a href="#l27.254"></a><span id="l27.254" class="difflineminus">-    rv = DoCopy(aFile, dstFolder, aMsgToReplace, isDraft, msgWindow, aMsgSendObj);</span>
<a href="#l27.255"></a><span id="l27.255" class="difflineplus">+    rv = DoCopy(aFile, dstFolder, aMsgToReplace, isDraft, msgWindow,</span>
<a href="#l27.256"></a><span id="l27.256" class="difflineplus">+                aMsgSendObj);</span>
<a href="#l27.257"></a><span id="l27.257">     // N.B. &quot;this&quot; may be deleted when this call returns.</span>
<a href="#l27.258"></a><span id="l27.258">   }</span>
<a href="#l27.259"></a><span id="l27.259">   return rv;</span>
<a href="#l27.260"></a><span id="l27.260"> }</span>
<a href="#l27.261"></a><span id="l27.261"> </span>
<a href="#l27.262"></a><span id="l27.262" class="difflineminus">-nsresult</span>
<a href="#l27.263"></a><span id="l27.263" class="difflineminus">-nsMsgCopy::DoCopy(nsIFile *aDiskFile, nsIMsgFolder *dstFolder,</span>
<a href="#l27.264"></a><span id="l27.264" class="difflineminus">-                  nsIMsgDBHdr *aMsgToReplace, bool aIsDraft,</span>
<a href="#l27.265"></a><span id="l27.265" class="difflineminus">-                  nsIMsgWindow *msgWindow,</span>
<a href="#l27.266"></a><span id="l27.266" class="difflineminus">-                  nsIMsgSend   *aMsgSendObj)</span>
<a href="#l27.267"></a><span id="l27.267" class="difflineminus">-{</span>
<a href="#l27.268"></a><span id="l27.268" class="difflineplus">+nsresult nsMsgCopy::DoCopy(nsIFile *aDiskFile, nsIMsgFolder *dstFolder,</span>
<a href="#l27.269"></a><span id="l27.269" class="difflineplus">+                           nsIMsgDBHdr *aMsgToReplace, bool aIsDraft,</span>
<a href="#l27.270"></a><span id="l27.270" class="difflineplus">+                           nsIMsgWindow *msgWindow, nsIMsgSend *aMsgSendObj) {</span>
<a href="#l27.271"></a><span id="l27.271">   nsresult rv = NS_OK;</span>
<a href="#l27.272"></a><span id="l27.272"> </span>
<a href="#l27.273"></a><span id="l27.273">   // Check sanity</span>
<a href="#l27.274"></a><span id="l27.274" class="difflineminus">-  if ((!aDiskFile) || (!dstFolder))</span>
<a href="#l27.275"></a><span id="l27.275" class="difflineminus">-    return NS_ERROR_INVALID_ARG;</span>
<a href="#l27.276"></a><span id="l27.276" class="difflineplus">+  if ((!aDiskFile) || (!dstFolder)) return NS_ERROR_INVALID_ARG;</span>
<a href="#l27.277"></a><span id="l27.277"> </span>
<a href="#l27.278"></a><span id="l27.278" class="difflineminus">-  //Call copyservice with dstFolder, disk file, and txnManager</span>
<a href="#l27.279"></a><span id="l27.279" class="difflineminus">-  if(NS_SUCCEEDED(rv))</span>
<a href="#l27.280"></a><span id="l27.280" class="difflineminus">-  {</span>
<a href="#l27.281"></a><span id="l27.281" class="difflineplus">+  // Call copyservice with dstFolder, disk file, and txnManager</span>
<a href="#l27.282"></a><span id="l27.282" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l27.283"></a><span id="l27.283">     RefPtr&lt;CopyListener&gt; copyListener = new CopyListener();</span>
<a href="#l27.284"></a><span id="l27.284" class="difflineminus">-    if (!copyListener)</span>
<a href="#l27.285"></a><span id="l27.285" class="difflineminus">-      return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l27.286"></a><span id="l27.286" class="difflineplus">+    if (!copyListener) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l27.287"></a><span id="l27.287"> </span>
<a href="#l27.288"></a><span id="l27.288">     copyListener-&gt;SetMsgComposeAndSendObject(aMsgSendObj);</span>
<a href="#l27.289"></a><span id="l27.289">     nsCOMPtr&lt;nsIThread&gt; thread;</span>
<a href="#l27.290"></a><span id="l27.290"> </span>
<a href="#l27.291"></a><span id="l27.291" class="difflineminus">-    if (aIsDraft)</span>
<a href="#l27.292"></a><span id="l27.292" class="difflineminus">-    {</span>
<a href="#l27.293"></a><span id="l27.293" class="difflineminus">-        nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapFolder =</span>
<a href="#l27.294"></a><span id="l27.294" class="difflineminus">-            do_QueryInterface(dstFolder);</span>
<a href="#l27.295"></a><span id="l27.295" class="difflineminus">-        nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l27.296"></a><span id="l27.296" class="difflineminus">-                 do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l27.297"></a><span id="l27.297" class="difflineminus">-        if (NS_FAILED(rv)) return rv;</span>
<a href="#l27.298"></a><span id="l27.298" class="difflineminus">-        bool shutdownInProgress = false;</span>
<a href="#l27.299"></a><span id="l27.299" class="difflineminus">-        rv = accountManager-&gt;GetShutdownInProgress(&amp;shutdownInProgress);</span>
<a href="#l27.300"></a><span id="l27.300" class="difflineplus">+    if (aIsDraft) {</span>
<a href="#l27.301"></a><span id="l27.301" class="difflineplus">+      nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(dstFolder);</span>
<a href="#l27.302"></a><span id="l27.302" class="difflineplus">+      nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l27.303"></a><span id="l27.303" class="difflineplus">+          do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l27.304"></a><span id="l27.304" class="difflineplus">+      if (NS_FAILED(rv)) return rv;</span>
<a href="#l27.305"></a><span id="l27.305" class="difflineplus">+      bool shutdownInProgress = false;</span>
<a href="#l27.306"></a><span id="l27.306" class="difflineplus">+      rv = accountManager-&gt;GetShutdownInProgress(&amp;shutdownInProgress);</span>
<a href="#l27.307"></a><span id="l27.307"> </span>
<a href="#l27.308"></a><span id="l27.308" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; shutdownInProgress &amp;&amp; imapFolder)</span>
<a href="#l27.309"></a><span id="l27.309" class="difflineminus">-        {</span>
<a href="#l27.310"></a><span id="l27.310" class="difflineminus">-          // set the following only when we were in the middle of shutdown</span>
<a href="#l27.311"></a><span id="l27.311" class="difflineminus">-          // process</span>
<a href="#l27.312"></a><span id="l27.312" class="difflineminus">-            copyListener-&gt;mCopyInProgress = true;</span>
<a href="#l27.313"></a><span id="l27.313" class="difflineminus">-            thread = do_GetCurrentThread();</span>
<a href="#l27.314"></a><span id="l27.314" class="difflineminus">-        }</span>
<a href="#l27.315"></a><span id="l27.315" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; shutdownInProgress &amp;&amp; imapFolder) {</span>
<a href="#l27.316"></a><span id="l27.316" class="difflineplus">+        // set the following only when we were in the middle of shutdown</span>
<a href="#l27.317"></a><span id="l27.317" class="difflineplus">+        // process</span>
<a href="#l27.318"></a><span id="l27.318" class="difflineplus">+        copyListener-&gt;mCopyInProgress = true;</span>
<a href="#l27.319"></a><span id="l27.319" class="difflineplus">+        thread = do_GetCurrentThread();</span>
<a href="#l27.320"></a><span id="l27.320" class="difflineplus">+      }</span>
<a href="#l27.321"></a><span id="l27.321">     }</span>
<a href="#l27.322"></a><span id="l27.322" class="difflineminus">-    nsCOMPtr&lt;nsIMsgCopyService&gt; copyService = do_GetService(NS_MSGCOPYSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l27.323"></a><span id="l27.323" class="difflineplus">+    nsCOMPtr&lt;nsIMsgCopyService&gt; copyService =</span>
<a href="#l27.324"></a><span id="l27.324" class="difflineplus">+        do_GetService(NS_MSGCOPYSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l27.325"></a><span id="l27.325">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.326"></a><span id="l27.326"> </span>
<a href="#l27.327"></a><span id="l27.327">     rv = copyService-&gt;CopyFileMessage(aDiskFile, dstFolder, aMsgToReplace,</span>
<a href="#l27.328"></a><span id="l27.328">                                       aIsDraft,</span>
<a href="#l27.329"></a><span id="l27.329">                                       aIsDraft ? 0 : nsMsgMessageFlags::Read,</span>
<a href="#l27.330"></a><span id="l27.330">                                       EmptyCString(), copyListener, msgWindow);</span>
<a href="#l27.331"></a><span id="l27.331">     // copyListener-&gt;mCopyInProgress can only be set when we are in the</span>
<a href="#l27.332"></a><span id="l27.332">     // middle of the shutdown process</span>
<a href="#l27.333"></a><span id="l27.333" class="difflineminus">-    while (copyListener-&gt;mCopyInProgress)</span>
<a href="#l27.334"></a><span id="l27.334" class="difflineminus">-    {</span>
<a href="#l27.335"></a><span id="l27.335" class="difflineminus">-        PR_CEnterMonitor(copyListener);</span>
<a href="#l27.336"></a><span id="l27.336" class="difflineminus">-        PR_CWait(copyListener, PR_MicrosecondsToInterval(1000UL));</span>
<a href="#l27.337"></a><span id="l27.337" class="difflineminus">-        PR_CExitMonitor(copyListener);</span>
<a href="#l27.338"></a><span id="l27.338" class="difflineminus">-        if (thread)</span>
<a href="#l27.339"></a><span id="l27.339" class="difflineminus">-            NS_ProcessPendingEvents(thread);</span>
<a href="#l27.340"></a><span id="l27.340" class="difflineplus">+    while (copyListener-&gt;mCopyInProgress) {</span>
<a href="#l27.341"></a><span id="l27.341" class="difflineplus">+      PR_CEnterMonitor(copyListener);</span>
<a href="#l27.342"></a><span id="l27.342" class="difflineplus">+      PR_CWait(copyListener, PR_MicrosecondsToInterval(1000UL));</span>
<a href="#l27.343"></a><span id="l27.343" class="difflineplus">+      PR_CExitMonitor(copyListener);</span>
<a href="#l27.344"></a><span id="l27.344" class="difflineplus">+      if (thread) NS_ProcessPendingEvents(thread);</span>
<a href="#l27.345"></a><span id="l27.345">     }</span>
<a href="#l27.346"></a><span id="l27.346">   }</span>
<a href="#l27.347"></a><span id="l27.347"> </span>
<a href="#l27.348"></a><span id="l27.348">   return rv;</span>
<a href="#l27.349"></a><span id="l27.349"> }</span>
<a href="#l27.350"></a><span id="l27.350"> </span>
<a href="#l27.351"></a><span id="l27.351"> // nsIUrlListener methods</span>
<a href="#l27.352"></a><span id="l27.352"> NS_IMETHODIMP</span>
<a href="#l27.353"></a><span id="l27.353" class="difflineminus">-nsMsgCopy::OnStartRunningUrl(nsIURI * aUrl)</span>
<a href="#l27.354"></a><span id="l27.354" class="difflineminus">-{</span>
<a href="#l27.355"></a><span id="l27.355" class="difflineminus">-    return NS_OK;</span>
<a href="#l27.356"></a><span id="l27.356" class="difflineminus">-}</span>
<a href="#l27.357"></a><span id="l27.357" class="difflineplus">+nsMsgCopy::OnStartRunningUrl(nsIURI *aUrl) { return NS_OK; }</span>
<a href="#l27.358"></a><span id="l27.358"> </span>
<a href="#l27.359"></a><span id="l27.359"> NS_IMETHODIMP</span>
<a href="#l27.360"></a><span id="l27.360" class="difflineminus">-nsMsgCopy::OnStopRunningUrl(nsIURI * aUrl, nsresult aExitCode)</span>
<a href="#l27.361"></a><span id="l27.361" class="difflineminus">-{</span>
<a href="#l27.362"></a><span id="l27.362" class="difflineplus">+nsMsgCopy::OnStopRunningUrl(nsIURI *aUrl, nsresult aExitCode) {</span>
<a href="#l27.363"></a><span id="l27.363">   nsresult rv = aExitCode;</span>
<a href="#l27.364"></a><span id="l27.364" class="difflineminus">-  if (NS_SUCCEEDED(aExitCode))</span>
<a href="#l27.365"></a><span id="l27.365" class="difflineminus">-  {</span>
<a href="#l27.366"></a><span id="l27.366" class="difflineminus">-    rv = DoCopy(mFile, mDstFolder, mMsgToReplace, mIsDraft, nullptr, mMsgSendObj);</span>
<a href="#l27.367"></a><span id="l27.367" class="difflineplus">+  if (NS_SUCCEEDED(aExitCode)) {</span>
<a href="#l27.368"></a><span id="l27.368" class="difflineplus">+    rv = DoCopy(mFile, mDstFolder, mMsgToReplace, mIsDraft, nullptr,</span>
<a href="#l27.369"></a><span id="l27.369" class="difflineplus">+                mMsgSendObj);</span>
<a href="#l27.370"></a><span id="l27.370">   }</span>
<a href="#l27.371"></a><span id="l27.371">   return rv;</span>
<a href="#l27.372"></a><span id="l27.372"> }</span>
<a href="#l27.373"></a><span id="l27.373"> </span>
<a href="#l27.374"></a><span id="l27.374" class="difflineminus">-nsresult</span>
<a href="#l27.375"></a><span id="l27.375" class="difflineminus">-nsMsgCopy::GetUnsentMessagesFolder(nsIMsgIdentity   *userIdentity, nsIMsgFolder **folder, bool *waitForUrl)</span>
<a href="#l27.376"></a><span id="l27.376" class="difflineminus">-{</span>
<a href="#l27.377"></a><span id="l27.377" class="difflineminus">-  nsresult ret = LocateMessageFolder(userIdentity, nsIMsgSend::nsMsgQueueForLater, mSavePref, folder);</span>
<a href="#l27.378"></a><span id="l27.378" class="difflineminus">-  if (*folder)</span>
<a href="#l27.379"></a><span id="l27.379" class="difflineminus">-    (*folder)-&gt;SetFlag(nsMsgFolderFlags::Queue);</span>
<a href="#l27.380"></a><span id="l27.380" class="difflineplus">+nsresult nsMsgCopy::GetUnsentMessagesFolder(nsIMsgIdentity *userIdentity,</span>
<a href="#l27.381"></a><span id="l27.381" class="difflineplus">+                                            nsIMsgFolder **folder,</span>
<a href="#l27.382"></a><span id="l27.382" class="difflineplus">+                                            bool *waitForUrl) {</span>
<a href="#l27.383"></a><span id="l27.383" class="difflineplus">+  nsresult ret = LocateMessageFolder(</span>
<a href="#l27.384"></a><span id="l27.384" class="difflineplus">+      userIdentity, nsIMsgSend::nsMsgQueueForLater, mSavePref, folder);</span>
<a href="#l27.385"></a><span id="l27.385" class="difflineplus">+  if (*folder) (*folder)-&gt;SetFlag(nsMsgFolderFlags::Queue);</span>
<a href="#l27.386"></a><span id="l27.386">   CreateIfMissing(folder, waitForUrl);</span>
<a href="#l27.387"></a><span id="l27.387">   return ret;</span>
<a href="#l27.388"></a><span id="l27.388"> }</span>
<a href="#l27.389"></a><span id="l27.389"> </span>
<a href="#l27.390"></a><span id="l27.390" class="difflineminus">-nsresult</span>
<a href="#l27.391"></a><span id="l27.391" class="difflineminus">-nsMsgCopy::GetDraftsFolder(nsIMsgIdentity *userIdentity, nsIMsgFolder **folder, bool *waitForUrl)</span>
<a href="#l27.392"></a><span id="l27.392" class="difflineminus">-{</span>
<a href="#l27.393"></a><span id="l27.393" class="difflineminus">-  nsresult ret = LocateMessageFolder(userIdentity, nsIMsgSend::nsMsgSaveAsDraft, mSavePref, folder);</span>
<a href="#l27.394"></a><span id="l27.394" class="difflineminus">-  if (*folder)</span>
<a href="#l27.395"></a><span id="l27.395" class="difflineminus">-    (*folder)-&gt;SetFlag(nsMsgFolderFlags::Drafts);</span>
<a href="#l27.396"></a><span id="l27.396" class="difflineplus">+nsresult nsMsgCopy::GetDraftsFolder(nsIMsgIdentity *userIdentity,</span>
<a href="#l27.397"></a><span id="l27.397" class="difflineplus">+                                    nsIMsgFolder **folder, bool *waitForUrl) {</span>
<a href="#l27.398"></a><span id="l27.398" class="difflineplus">+  nsresult ret = LocateMessageFolder(userIdentity, nsIMsgSend::nsMsgSaveAsDraft,</span>
<a href="#l27.399"></a><span id="l27.399" class="difflineplus">+                                     mSavePref, folder);</span>
<a href="#l27.400"></a><span id="l27.400" class="difflineplus">+  if (*folder) (*folder)-&gt;SetFlag(nsMsgFolderFlags::Drafts);</span>
<a href="#l27.401"></a><span id="l27.401">   CreateIfMissing(folder, waitForUrl);</span>
<a href="#l27.402"></a><span id="l27.402">   return ret;</span>
<a href="#l27.403"></a><span id="l27.403"> }</span>
<a href="#l27.404"></a><span id="l27.404"> </span>
<a href="#l27.405"></a><span id="l27.405" class="difflineminus">-nsresult</span>
<a href="#l27.406"></a><span id="l27.406" class="difflineminus">-nsMsgCopy::GetTemplatesFolder(nsIMsgIdentity *userIdentity, nsIMsgFolder **folder, bool *waitForUrl)</span>
<a href="#l27.407"></a><span id="l27.407" class="difflineminus">-{</span>
<a href="#l27.408"></a><span id="l27.408" class="difflineminus">-  nsresult ret = LocateMessageFolder(userIdentity, nsIMsgSend::nsMsgSaveAsTemplate, mSavePref, folder);</span>
<a href="#l27.409"></a><span id="l27.409" class="difflineminus">-  if (*folder)</span>
<a href="#l27.410"></a><span id="l27.410" class="difflineminus">-    (*folder)-&gt;SetFlag(nsMsgFolderFlags::Templates);</span>
<a href="#l27.411"></a><span id="l27.411" class="difflineplus">+nsresult nsMsgCopy::GetTemplatesFolder(nsIMsgIdentity *userIdentity,</span>
<a href="#l27.412"></a><span id="l27.412" class="difflineplus">+                                       nsIMsgFolder **folder,</span>
<a href="#l27.413"></a><span id="l27.413" class="difflineplus">+                                       bool *waitForUrl) {</span>
<a href="#l27.414"></a><span id="l27.414" class="difflineplus">+  nsresult ret = LocateMessageFolder(</span>
<a href="#l27.415"></a><span id="l27.415" class="difflineplus">+      userIdentity, nsIMsgSend::nsMsgSaveAsTemplate, mSavePref, folder);</span>
<a href="#l27.416"></a><span id="l27.416" class="difflineplus">+  if (*folder) (*folder)-&gt;SetFlag(nsMsgFolderFlags::Templates);</span>
<a href="#l27.417"></a><span id="l27.417">   CreateIfMissing(folder, waitForUrl);</span>
<a href="#l27.418"></a><span id="l27.418">   return ret;</span>
<a href="#l27.419"></a><span id="l27.419"> }</span>
<a href="#l27.420"></a><span id="l27.420"> </span>
<a href="#l27.421"></a><span id="l27.421" class="difflineminus">-nsresult</span>
<a href="#l27.422"></a><span id="l27.422" class="difflineminus">-nsMsgCopy::GetSentFolder(nsIMsgIdentity *userIdentity, nsIMsgFolder **folder, bool *waitForUrl)</span>
<a href="#l27.423"></a><span id="l27.423" class="difflineminus">-{</span>
<a href="#l27.424"></a><span id="l27.424" class="difflineminus">-  nsresult ret = LocateMessageFolder(userIdentity, nsIMsgSend::nsMsgDeliverNow, mSavePref, folder);</span>
<a href="#l27.425"></a><span id="l27.425" class="difflineminus">-  if (*folder)</span>
<a href="#l27.426"></a><span id="l27.426" class="difflineminus">-  {</span>
<a href="#l27.427"></a><span id="l27.427" class="difflineplus">+nsresult nsMsgCopy::GetSentFolder(nsIMsgIdentity *userIdentity,</span>
<a href="#l27.428"></a><span id="l27.428" class="difflineplus">+                                  nsIMsgFolder **folder, bool *waitForUrl) {</span>
<a href="#l27.429"></a><span id="l27.429" class="difflineplus">+  nsresult ret = LocateMessageFolder(userIdentity, nsIMsgSend::nsMsgDeliverNow,</span>
<a href="#l27.430"></a><span id="l27.430" class="difflineplus">+                                     mSavePref, folder);</span>
<a href="#l27.431"></a><span id="l27.431" class="difflineplus">+  if (*folder) {</span>
<a href="#l27.432"></a><span id="l27.432">     // If mSavePref is the same as the identity's fcc folder, set the sent flag.</span>
<a href="#l27.433"></a><span id="l27.433">     nsCString identityFccUri;</span>
<a href="#l27.434"></a><span id="l27.434">     userIdentity-&gt;GetFccFolder(identityFccUri);</span>
<a href="#l27.435"></a><span id="l27.435">     if (identityFccUri.Equals(mSavePref))</span>
<a href="#l27.436"></a><span id="l27.436">       (*folder)-&gt;SetFlag(nsMsgFolderFlags::SentMail);</span>
<a href="#l27.437"></a><span id="l27.437">   }</span>
<a href="#l27.438"></a><span id="l27.438">   CreateIfMissing(folder, waitForUrl);</span>
<a href="#l27.439"></a><span id="l27.439">   return ret;</span>
<a href="#l27.440"></a><span id="l27.440"> }</span>
<a href="#l27.441"></a><span id="l27.441"> </span>
<a href="#l27.442"></a><span id="l27.442" class="difflineminus">-nsresult</span>
<a href="#l27.443"></a><span id="l27.443" class="difflineminus">-nsMsgCopy::CreateIfMissing(nsIMsgFolder **folder, bool *waitForUrl)</span>
<a href="#l27.444"></a><span id="l27.444" class="difflineminus">-{</span>
<a href="#l27.445"></a><span id="l27.445" class="difflineplus">+nsresult nsMsgCopy::CreateIfMissing(nsIMsgFolder **folder, bool *waitForUrl) {</span>
<a href="#l27.446"></a><span id="l27.446">   nsresult rv = NS_OK;</span>
<a href="#l27.447"></a><span id="l27.447" class="difflineminus">-  if (folder &amp;&amp; *folder)</span>
<a href="#l27.448"></a><span id="l27.448" class="difflineminus">-  {</span>
<a href="#l27.449"></a><span id="l27.449" class="difflineplus">+  if (folder &amp;&amp; *folder) {</span>
<a href="#l27.450"></a><span id="l27.450">     nsCOMPtr&lt;nsIMsgFolder&gt; parent;</span>
<a href="#l27.451"></a><span id="l27.451">     (*folder)-&gt;GetParent(getter_AddRefs(parent));</span>
<a href="#l27.452"></a><span id="l27.452" class="difflineminus">-    if (!parent)</span>
<a href="#l27.453"></a><span id="l27.453" class="difflineminus">-    {</span>
<a href="#l27.454"></a><span id="l27.454" class="difflineplus">+    if (!parent) {</span>
<a href="#l27.455"></a><span id="l27.455">       nsCOMPtr&lt;nsIFile&gt; folderPath;</span>
<a href="#l27.456"></a><span id="l27.456">       // for local folders, path is to the berkeley mailbox.</span>
<a href="#l27.457"></a><span id="l27.457">       // for imap folders, path needs to have .msf appended to the name</span>
<a href="#l27.458"></a><span id="l27.458">       (*folder)-&gt;GetFilePath(getter_AddRefs(folderPath));</span>
<a href="#l27.459"></a><span id="l27.459"> </span>
<a href="#l27.460"></a><span id="l27.460">       nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l27.461"></a><span id="l27.461">       rv = (*folder)-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l27.462"></a><span id="l27.462">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.463"></a><span id="l27.463" class="difflineat">@@ -373,162 +313,145 @@ nsMsgCopy::CreateIfMissing(nsIMsgFolder </span>
<a href="#l27.464"></a><span id="l27.464">       nsCOMPtr&lt;nsIMsgProtocolInfo&gt; protocolInfo;</span>
<a href="#l27.465"></a><span id="l27.465">       rv = server-&gt;GetProtocolInfo(getter_AddRefs(protocolInfo));</span>
<a href="#l27.466"></a><span id="l27.466">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.467"></a><span id="l27.467"> </span>
<a href="#l27.468"></a><span id="l27.468">       bool isAsyncFolder;</span>
<a href="#l27.469"></a><span id="l27.469">       rv = protocolInfo-&gt;GetFoldersCreatedAsync(&amp;isAsyncFolder);</span>
<a href="#l27.470"></a><span id="l27.470">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.471"></a><span id="l27.471"> </span>
<a href="#l27.472"></a><span id="l27.472" class="difflineminus">-      // if we can't get the path from the folder, then try to create the storage.</span>
<a href="#l27.473"></a><span id="l27.473" class="difflineminus">-      // for imap, it doesn't matter if the .msf file exists - it still might not</span>
<a href="#l27.474"></a><span id="l27.474" class="difflineminus">-      // exist on the server, so we should try to create it</span>
<a href="#l27.475"></a><span id="l27.475" class="difflineplus">+      // if we can't get the path from the folder, then try to create the</span>
<a href="#l27.476"></a><span id="l27.476" class="difflineplus">+      // storage. for imap, it doesn't matter if the .msf file exists - it still</span>
<a href="#l27.477"></a><span id="l27.477" class="difflineplus">+      // might not exist on the server, so we should try to create it</span>
<a href="#l27.478"></a><span id="l27.478">       bool exists = false;</span>
<a href="#l27.479"></a><span id="l27.479" class="difflineminus">-      if (!isAsyncFolder &amp;&amp; folderPath)</span>
<a href="#l27.480"></a><span id="l27.480" class="difflineminus">-        folderPath-&gt;Exists(&amp;exists);</span>
<a href="#l27.481"></a><span id="l27.481" class="difflineminus">-      if (!exists)</span>
<a href="#l27.482"></a><span id="l27.482" class="difflineminus">-      {</span>
<a href="#l27.483"></a><span id="l27.483" class="difflineplus">+      if (!isAsyncFolder &amp;&amp; folderPath) folderPath-&gt;Exists(&amp;exists);</span>
<a href="#l27.484"></a><span id="l27.484" class="difflineplus">+      if (!exists) {</span>
<a href="#l27.485"></a><span id="l27.485">         (*folder)-&gt;CreateStorageIfMissing(this);</span>
<a href="#l27.486"></a><span id="l27.486" class="difflineminus">-        if (isAsyncFolder)</span>
<a href="#l27.487"></a><span id="l27.487" class="difflineminus">-          *waitForUrl = true;</span>
<a href="#l27.488"></a><span id="l27.488" class="difflineplus">+        if (isAsyncFolder) *waitForUrl = true;</span>
<a href="#l27.489"></a><span id="l27.489"> </span>
<a href="#l27.490"></a><span id="l27.490">         rv = NS_OK;</span>
<a href="#l27.491"></a><span id="l27.491">       }</span>
<a href="#l27.492"></a><span id="l27.492">     }</span>
<a href="#l27.493"></a><span id="l27.493">   }</span>
<a href="#l27.494"></a><span id="l27.494">   return rv;</span>
<a href="#l27.495"></a><span id="l27.495"> }</span>
<a href="#l27.496"></a><span id="l27.496"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l27.497"></a><span id="l27.497"> // Utility Functions for MsgFolders</span>
<a href="#l27.498"></a><span id="l27.498"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l27.499"></a><span id="l27.499" class="difflineminus">-nsresult</span>
<a href="#l27.500"></a><span id="l27.500" class="difflineminus">-LocateMessageFolder(nsIMsgIdentity   *userIdentity,</span>
<a href="#l27.501"></a><span id="l27.501" class="difflineminus">-                    nsMsgDeliverMode aFolderType,</span>
<a href="#l27.502"></a><span id="l27.502" class="difflineminus">-                    const char       *aFolderURI,</span>
<a href="#l27.503"></a><span id="l27.503" class="difflineminus">-                    nsIMsgFolder     **msgFolder)</span>
<a href="#l27.504"></a><span id="l27.504" class="difflineminus">-{</span>
<a href="#l27.505"></a><span id="l27.505" class="difflineminus">-  nsresult                  rv = NS_OK;</span>
<a href="#l27.506"></a><span id="l27.506" class="difflineplus">+nsresult LocateMessageFolder(nsIMsgIdentity *userIdentity,</span>
<a href="#l27.507"></a><span id="l27.507" class="difflineplus">+                             nsMsgDeliverMode aFolderType,</span>
<a href="#l27.508"></a><span id="l27.508" class="difflineplus">+                             const char *aFolderURI, nsIMsgFolder **msgFolder) {</span>
<a href="#l27.509"></a><span id="l27.509" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l27.510"></a><span id="l27.510"> </span>
<a href="#l27.511"></a><span id="l27.511">   if (!msgFolder) return NS_ERROR_NULL_POINTER;</span>
<a href="#l27.512"></a><span id="l27.512">   *msgFolder = nullptr;</span>
<a href="#l27.513"></a><span id="l27.513"> </span>
<a href="#l27.514"></a><span id="l27.514" class="difflineminus">-  if (!aFolderURI || !*aFolderURI)</span>
<a href="#l27.515"></a><span id="l27.515" class="difflineminus">-    return NS_ERROR_INVALID_ARG;</span>
<a href="#l27.516"></a><span id="l27.516" class="difflineplus">+  if (!aFolderURI || !*aFolderURI) return NS_ERROR_INVALID_ARG;</span>
<a href="#l27.517"></a><span id="l27.517"> </span>
<a href="#l27.518"></a><span id="l27.518">   // as long as it doesn't start with anyfolder://</span>
<a href="#l27.519"></a><span id="l27.519" class="difflineminus">-  if (PL_strncasecmp(ANY_SERVER, aFolderURI, strlen(aFolderURI)) != 0)</span>
<a href="#l27.520"></a><span id="l27.520" class="difflineminus">-  {</span>
<a href="#l27.521"></a><span id="l27.521" class="difflineplus">+  if (PL_strncasecmp(ANY_SERVER, aFolderURI, strlen(aFolderURI)) != 0) {</span>
<a href="#l27.522"></a><span id="l27.522">     nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l27.523"></a><span id="l27.523" class="difflineminus">-    rv = GetOrCreateFolder(nsDependentCString(aFolderURI), getter_AddRefs(folder));</span>
<a href="#l27.524"></a><span id="l27.524" class="difflineplus">+    rv = GetOrCreateFolder(nsDependentCString(aFolderURI),</span>
<a href="#l27.525"></a><span id="l27.525" class="difflineplus">+                           getter_AddRefs(folder));</span>
<a href="#l27.526"></a><span id="l27.526">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.527"></a><span id="l27.527">     // Don't check validity of folder - caller will handle creating it.</span>
<a href="#l27.528"></a><span id="l27.528">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l27.529"></a><span id="l27.529" class="difflineminus">-    // make sure that folder hierarchy is built so that legitimate parent-child relationship is established.</span>
<a href="#l27.530"></a><span id="l27.530" class="difflineplus">+    // make sure that folder hierarchy is built so that legitimate parent-child</span>
<a href="#l27.531"></a><span id="l27.531" class="difflineplus">+    // relationship is established.</span>
<a href="#l27.532"></a><span id="l27.532">     rv = folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l27.533"></a><span id="l27.533">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.534"></a><span id="l27.534" class="difflineminus">-    return server-&gt;GetMsgFolderFromURI(folder, nsDependentCString(aFolderURI), msgFolder);</span>
<a href="#l27.535"></a><span id="l27.535" class="difflineminus">-  }</span>
<a href="#l27.536"></a><span id="l27.536" class="difflineminus">-  else</span>
<a href="#l27.537"></a><span id="l27.537" class="difflineminus">-  {</span>
<a href="#l27.538"></a><span id="l27.538" class="difflineminus">-    uint32_t                  cnt = 0;</span>
<a href="#l27.539"></a><span id="l27.539" class="difflineminus">-    uint32_t                  i;</span>
<a href="#l27.540"></a><span id="l27.540" class="difflineplus">+    return server-&gt;GetMsgFolderFromURI(folder, nsDependentCString(aFolderURI),</span>
<a href="#l27.541"></a><span id="l27.541" class="difflineplus">+                                       msgFolder);</span>
<a href="#l27.542"></a><span id="l27.542" class="difflineplus">+  } else {</span>
<a href="#l27.543"></a><span id="l27.543" class="difflineplus">+    uint32_t cnt = 0;</span>
<a href="#l27.544"></a><span id="l27.544" class="difflineplus">+    uint32_t i;</span>
<a href="#l27.545"></a><span id="l27.545"> </span>
<a href="#l27.546"></a><span id="l27.546" class="difflineminus">-    if (!userIdentity)</span>
<a href="#l27.547"></a><span id="l27.547" class="difflineminus">-      return NS_ERROR_INVALID_ARG;</span>
<a href="#l27.548"></a><span id="l27.548" class="difflineplus">+    if (!userIdentity) return NS_ERROR_INVALID_ARG;</span>
<a href="#l27.549"></a><span id="l27.549"> </span>
<a href="#l27.550"></a><span id="l27.550">     // get the account manager</span>
<a href="#l27.551"></a><span id="l27.551">     nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l27.552"></a><span id="l27.552" class="difflineminus">-             do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l27.553"></a><span id="l27.553" class="difflineplus">+        do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l27.554"></a><span id="l27.554">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l27.555"></a><span id="l27.555"> </span>
<a href="#l27.556"></a><span id="l27.556">     // If any folder will do, go look for one.</span>
<a href="#l27.557"></a><span id="l27.557">     nsCOMPtr&lt;nsIArray&gt; retval;</span>
<a href="#l27.558"></a><span id="l27.558">     accountManager-&gt;GetServersForIdentity(userIdentity, getter_AddRefs(retval));</span>
<a href="#l27.559"></a><span id="l27.559">     if (!retval) return NS_ERROR_FAILURE;</span>
<a href="#l27.560"></a><span id="l27.560"> </span>
<a href="#l27.561"></a><span id="l27.561">     // Ok, we have to look through the servers and try to find the server that</span>
<a href="#l27.562"></a><span id="l27.562">     // has a valid folder of the type that interests us...</span>
<a href="#l27.563"></a><span id="l27.563">     rv = retval-&gt;GetLength(&amp;cnt);</span>
<a href="#l27.564"></a><span id="l27.564">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l27.565"></a><span id="l27.565"> </span>
<a href="#l27.566"></a><span id="l27.566" class="difflineminus">-    for (i=0; i&lt;cnt; i++) {</span>
<a href="#l27.567"></a><span id="l27.567" class="difflineplus">+    for (i = 0; i &lt; cnt; i++) {</span>
<a href="#l27.568"></a><span id="l27.568">       // Now that we have the server...we need to get the named message folder</span>
<a href="#l27.569"></a><span id="l27.569">       nsCOMPtr&lt;nsIMsgIncomingServer&gt; inServer;</span>
<a href="#l27.570"></a><span id="l27.570"> </span>
<a href="#l27.571"></a><span id="l27.571">       inServer = do_QueryElementAt(retval, i, &amp;rv);</span>
<a href="#l27.572"></a><span id="l27.572" class="difflineminus">-      if(NS_FAILED(rv) || (!inServer))</span>
<a href="#l27.573"></a><span id="l27.573" class="difflineminus">-        continue;</span>
<a href="#l27.574"></a><span id="l27.574" class="difflineplus">+      if (NS_FAILED(rv) || (!inServer)) continue;</span>
<a href="#l27.575"></a><span id="l27.575"> </span>
<a href="#l27.576"></a><span id="l27.576">       //</span>
<a href="#l27.577"></a><span id="l27.577">       // If aFolderURI is passed in, then the user has chosen a specific</span>
<a href="#l27.578"></a><span id="l27.578">       // mail folder to save the message, but if it is null, just find the</span>
<a href="#l27.579"></a><span id="l27.579">       // first one and make that work. The folder is specified as a URI, like</span>
<a href="#l27.580"></a><span id="l27.580">       // the following:</span>
<a href="#l27.581"></a><span id="l27.581">       //</span>
<a href="#l27.582"></a><span id="l27.582">       //   mailbox://nobody@Local Folders/Sent</span>
<a href="#l27.583"></a><span id="l27.583">       //                  imap://rhp@nsmail-2/Drafts</span>
<a href="#l27.584"></a><span id="l27.584">       //                  newsgroup://news.mozilla.org/netscape.test</span>
<a href="#l27.585"></a><span id="l27.585">       //</span>
<a href="#l27.586"></a><span id="l27.586">       nsCString serverURI;</span>
<a href="#l27.587"></a><span id="l27.587">       rv = inServer-&gt;GetServerURI(serverURI);</span>
<a href="#l27.588"></a><span id="l27.588" class="difflineminus">-      if (NS_FAILED(rv) || serverURI.IsEmpty())</span>
<a href="#l27.589"></a><span id="l27.589" class="difflineminus">-        continue;</span>
<a href="#l27.590"></a><span id="l27.590" class="difflineplus">+      if (NS_FAILED(rv) || serverURI.IsEmpty()) continue;</span>
<a href="#l27.591"></a><span id="l27.591"> </span>
<a href="#l27.592"></a><span id="l27.592">       nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l27.593"></a><span id="l27.593">       rv = inServer-&gt;GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l27.594"></a><span id="l27.594"> </span>
<a href="#l27.595"></a><span id="l27.595" class="difflineminus">-      if(NS_FAILED(rv) || (!rootFolder))</span>
<a href="#l27.596"></a><span id="l27.596" class="difflineminus">-        continue;</span>
<a href="#l27.597"></a><span id="l27.597" class="difflineplus">+      if (NS_FAILED(rv) || (!rootFolder)) continue;</span>
<a href="#l27.598"></a><span id="l27.598"> </span>
<a href="#l27.599"></a><span id="l27.599">       // use the defaults by getting the folder by flags</span>
<a href="#l27.600"></a><span id="l27.600">       if (aFolderType == nsIMsgSend::nsMsgQueueForLater ||</span>
<a href="#l27.601"></a><span id="l27.601" class="difflineminus">-          aFolderType == nsIMsgSend::nsMsgDeliverBackground)</span>
<a href="#l27.602"></a><span id="l27.602" class="difflineminus">-      {</span>
<a href="#l27.603"></a><span id="l27.603" class="difflineplus">+          aFolderType == nsIMsgSend::nsMsgDeliverBackground) {</span>
<a href="#l27.604"></a><span id="l27.604">         // QueueForLater (Outbox)</span>
<a href="#l27.605"></a><span id="l27.605">         rootFolder-&gt;GetFolderWithFlags(nsMsgFolderFlags::Queue, msgFolder);</span>
<a href="#l27.606"></a><span id="l27.606" class="difflineminus">-      }</span>
<a href="#l27.607"></a><span id="l27.607" class="difflineminus">-      else if (aFolderType == nsIMsgSend::nsMsgSaveAsDraft)    // SaveAsDraft (Drafts)</span>
<a href="#l27.608"></a><span id="l27.608" class="difflineplus">+      } else if (aFolderType ==</span>
<a href="#l27.609"></a><span id="l27.609" class="difflineplus">+                 nsIMsgSend::nsMsgSaveAsDraft)  // SaveAsDraft (Drafts)</span>
<a href="#l27.610"></a><span id="l27.610">       {</span>
<a href="#l27.611"></a><span id="l27.611">         rootFolder-&gt;GetFolderWithFlags(nsMsgFolderFlags::Drafts, msgFolder);</span>
<a href="#l27.612"></a><span id="l27.612" class="difflineminus">-      }</span>
<a href="#l27.613"></a><span id="l27.613" class="difflineminus">-      else if (aFolderType == nsIMsgSend::nsMsgSaveAsTemplate) // SaveAsTemplate (Templates)</span>
<a href="#l27.614"></a><span id="l27.614" class="difflineplus">+      } else if (aFolderType ==</span>
<a href="#l27.615"></a><span id="l27.615" class="difflineplus">+                 nsIMsgSend::nsMsgSaveAsTemplate)  // SaveAsTemplate (Templates)</span>
<a href="#l27.616"></a><span id="l27.616">       {</span>
<a href="#l27.617"></a><span id="l27.617">         rootFolder-&gt;GetFolderWithFlags(nsMsgFolderFlags::Templates, msgFolder);</span>
<a href="#l27.618"></a><span id="l27.618" class="difflineminus">-      }</span>
<a href="#l27.619"></a><span id="l27.619" class="difflineminus">-      else // SaveInSentFolder (Sent) -  nsMsgDeliverNow or nsMsgSendUnsent</span>
<a href="#l27.620"></a><span id="l27.620" class="difflineplus">+      } else  // SaveInSentFolder (Sent) -  nsMsgDeliverNow or nsMsgSendUnsent</span>
<a href="#l27.621"></a><span id="l27.621">       {</span>
<a href="#l27.622"></a><span id="l27.622">         rootFolder-&gt;GetFolderWithFlags(nsMsgFolderFlags::SentMail, msgFolder);</span>
<a href="#l27.623"></a><span id="l27.623">       }</span>
<a href="#l27.624"></a><span id="l27.624"> </span>
<a href="#l27.625"></a><span id="l27.625" class="difflineminus">-      if (*msgFolder)</span>
<a href="#l27.626"></a><span id="l27.626" class="difflineminus">-      {</span>
<a href="#l27.627"></a><span id="l27.627" class="difflineplus">+      if (*msgFolder) {</span>
<a href="#l27.628"></a><span id="l27.628">         return NS_OK;</span>
<a href="#l27.629"></a><span id="l27.629">       }</span>
<a href="#l27.630"></a><span id="l27.630">     }</span>
<a href="#l27.631"></a><span id="l27.631">   }</span>
<a href="#l27.632"></a><span id="l27.632">   return NS_ERROR_FAILURE;</span>
<a href="#l27.633"></a><span id="l27.633"> }</span>
<a href="#l27.634"></a><span id="l27.634"> </span>
<a href="#l27.635"></a><span id="l27.635"> //</span>
<a href="#l27.636"></a><span id="l27.636"> // Figure out if a folder is local or not and return a boolean to</span>
<a href="#l27.637"></a><span id="l27.637"> // say so.</span>
<a href="#l27.638"></a><span id="l27.638"> //</span>
<a href="#l27.639"></a><span id="l27.639" class="difflineminus">-nsresult</span>
<a href="#l27.640"></a><span id="l27.640" class="difflineminus">-MessageFolderIsLocal(nsIMsgIdentity   *userIdentity,</span>
<a href="#l27.641"></a><span id="l27.641" class="difflineminus">-                     nsMsgDeliverMode aFolderType,</span>
<a href="#l27.642"></a><span id="l27.642" class="difflineminus">-                     const char       *aFolderURI,</span>
<a href="#l27.643"></a><span id="l27.643" class="difflineminus">-                     bool            *aResult)</span>
<a href="#l27.644"></a><span id="l27.644" class="difflineminus">-{</span>
<a href="#l27.645"></a><span id="l27.645" class="difflineplus">+nsresult MessageFolderIsLocal(nsIMsgIdentity *userIdentity,</span>
<a href="#l27.646"></a><span id="l27.646" class="difflineplus">+                              nsMsgDeliverMode aFolderType,</span>
<a href="#l27.647"></a><span id="l27.647" class="difflineplus">+                              const char *aFolderURI, bool *aResult) {</span>
<a href="#l27.648"></a><span id="l27.648">   nsresult rv;</span>
<a href="#l27.649"></a><span id="l27.649"> </span>
<a href="#l27.650"></a><span id="l27.650">   if (!aFolderURI) return NS_ERROR_NULL_POINTER;</span>
<a href="#l27.651"></a><span id="l27.651"> </span>
<a href="#l27.652"></a><span id="l27.652" class="difflineminus">-  nsCOMPtr &lt;nsIURL&gt; url;</span>
<a href="#l27.653"></a><span id="l27.653" class="difflineminus">-  rv = NS_MutateURI(NS_STANDARDURLMUTATOR_CONTRACTID).SetSpec(nsDependentCString(aFolderURI))</span>
<a href="#l27.654"></a><span id="l27.654" class="difflineminus">-                                                     .Finalize(url);</span>
<a href="#l27.655"></a><span id="l27.655" class="difflineplus">+  nsCOMPtr&lt;nsIURL&gt; url;</span>
<a href="#l27.656"></a><span id="l27.656" class="difflineplus">+  rv = NS_MutateURI(NS_STANDARDURLMUTATOR_CONTRACTID)</span>
<a href="#l27.657"></a><span id="l27.657" class="difflineplus">+           .SetSpec(nsDependentCString(aFolderURI))</span>
<a href="#l27.658"></a><span id="l27.658" class="difflineplus">+           .Finalize(url);</span>
<a href="#l27.659"></a><span id="l27.659">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l27.660"></a><span id="l27.660"> </span>
<a href="#l27.661"></a><span id="l27.661">   /* mailbox:/ means its local (on disk) */</span>
<a href="#l27.662"></a><span id="l27.662">   rv = url-&gt;SchemeIs(&quot;mailbox&quot;, aResult);</span>
<a href="#l27.663"></a><span id="l27.663">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l27.664"></a><span id="l27.664">   return NS_OK;</span>
<a href="#l27.665"></a><span id="l27.665"> }</span>
<a href="#l27.666"></a><span id="l27.666" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCopy.h</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCopy.h</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -11,110 +11,104 @@</span>
<a href="#l28.4"></a><span id="l28.4"> #include &quot;nsIFile.h&quot;</span>
<a href="#l28.5"></a><span id="l28.5"> #include &quot;nsMsgSend.h&quot;</span>
<a href="#l28.6"></a><span id="l28.6"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l28.7"></a><span id="l28.7"> #include &quot;nsITransactionManager.h&quot;</span>
<a href="#l28.8"></a><span id="l28.8"> #include &quot;nsIMsgCopyServiceListener.h&quot;</span>
<a href="#l28.9"></a><span id="l28.9"> #include &quot;nsIMsgCopyService.h&quot;</span>
<a href="#l28.10"></a><span id="l28.10"> </span>
<a href="#l28.11"></a><span id="l28.11"> // {0874C3B5-317D-11d3-8EFB-00A024A7D144}</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-#define NS_IMSGCOPY_IID           \</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineminus">-{ 0x874c3b5, 0x317d, 0x11d3,      \</span>
<a href="#l28.14"></a><span id="l28.14" class="difflineminus">-{ 0x8e, 0xfb, 0x0, 0xa0, 0x24, 0xa7, 0xd1, 0x44 } };</span>
<a href="#l28.15"></a><span id="l28.15" class="difflineplus">+#define NS_IMSGCOPY_IID \</span>
<a href="#l28.16"></a><span id="l28.16" class="difflineplus">+  {0x874c3b5, 0x317d, 0x11d3, {0x8e, 0xfb, 0x0, 0xa0, 0x24, 0xa7, 0xd1, 0x44}};</span>
<a href="#l28.17"></a><span id="l28.17"> </span>
<a href="#l28.18"></a><span id="l28.18"> // Forward declarations...</span>
<a href="#l28.19"></a><span id="l28.19" class="difflineminus">-class   nsMsgCopy;</span>
<a href="#l28.20"></a><span id="l28.20" class="difflineplus">+class nsMsgCopy;</span>
<a href="#l28.21"></a><span id="l28.21"> </span>
<a href="#l28.22"></a><span id="l28.22"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l28.23"></a><span id="l28.23" class="difflineminus">-// This is the listener class for the copy operation. We have to create this class</span>
<a href="#l28.24"></a><span id="l28.24" class="difflineminus">-// to listen for message copy completion and eventually notify the caller</span>
<a href="#l28.25"></a><span id="l28.25" class="difflineplus">+// This is the listener class for the copy operation. We have to create this</span>
<a href="#l28.26"></a><span id="l28.26" class="difflineplus">+// class to listen for message copy completion and eventually notify the caller</span>
<a href="#l28.27"></a><span id="l28.27"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l28.28"></a><span id="l28.28" class="difflineminus">-class CopyListener : public nsIMsgCopyServiceListener</span>
<a href="#l28.29"></a><span id="l28.29" class="difflineminus">-{</span>
<a href="#l28.30"></a><span id="l28.30" class="difflineminus">-public:</span>
<a href="#l28.31"></a><span id="l28.31" class="difflineplus">+class CopyListener : public nsIMsgCopyServiceListener {</span>
<a href="#l28.32"></a><span id="l28.32" class="difflineplus">+ public:</span>
<a href="#l28.33"></a><span id="l28.33">   CopyListener(void);</span>
<a href="#l28.34"></a><span id="l28.34"> </span>
<a href="#l28.35"></a><span id="l28.35">   // nsISupports interface</span>
<a href="#l28.36"></a><span id="l28.36">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l28.37"></a><span id="l28.37"> </span>
<a href="#l28.38"></a><span id="l28.38">   NS_IMETHOD OnStartCopy() override;</span>
<a href="#l28.39"></a><span id="l28.39"> </span>
<a href="#l28.40"></a><span id="l28.40">   NS_IMETHOD OnProgress(uint32_t aProgress, uint32_t aProgressMax) override;</span>
<a href="#l28.41"></a><span id="l28.41"> </span>
<a href="#l28.42"></a><span id="l28.42">   NS_IMETHOD SetMessageKey(nsMsgKey aMessageKey) override;</span>
<a href="#l28.43"></a><span id="l28.43"> </span>
<a href="#l28.44"></a><span id="l28.44" class="difflineminus">-  NS_IMETHOD GetMessageId(nsACString&amp; aMessageId) override;</span>
<a href="#l28.45"></a><span id="l28.45" class="difflineplus">+  NS_IMETHOD GetMessageId(nsACString &amp;aMessageId) override;</span>
<a href="#l28.46"></a><span id="l28.46"> </span>
<a href="#l28.47"></a><span id="l28.47">   NS_IMETHOD OnStopCopy(nsresult aStatus) override;</span>
<a href="#l28.48"></a><span id="l28.48"> </span>
<a href="#l28.49"></a><span id="l28.49">   NS_IMETHOD SetMsgComposeAndSendObject(nsIMsgSend *obj);</span>
<a href="#l28.50"></a><span id="l28.50"> </span>
<a href="#l28.51"></a><span id="l28.51">   bool mCopyInProgress;</span>
<a href="#l28.52"></a><span id="l28.52"> </span>
<a href="#l28.53"></a><span id="l28.53" class="difflineminus">-private:</span>
<a href="#l28.54"></a><span id="l28.54" class="difflineplus">+ private:</span>
<a href="#l28.55"></a><span id="l28.55">   virtual ~CopyListener();</span>
<a href="#l28.56"></a><span id="l28.56">   nsCOMPtr&lt;nsIMsgSend&gt; mComposeAndSend;</span>
<a href="#l28.57"></a><span id="l28.57"> };</span>
<a href="#l28.58"></a><span id="l28.58"> </span>
<a href="#l28.59"></a><span id="l28.59"> //</span>
<a href="#l28.60"></a><span id="l28.60"> // This is a class that deals with processing remote attachments. It implements</span>
<a href="#l28.61"></a><span id="l28.61"> // an nsIStreamListener interface to deal with incoming data</span>
<a href="#l28.62"></a><span id="l28.62"> //</span>
<a href="#l28.63"></a><span id="l28.63" class="difflineminus">-class nsMsgCopy : public nsIUrlListener</span>
<a href="#l28.64"></a><span id="l28.64" class="difflineminus">-{</span>
<a href="#l28.65"></a><span id="l28.65" class="difflineminus">-public:</span>
<a href="#l28.66"></a><span id="l28.66" class="difflineplus">+class nsMsgCopy : public nsIUrlListener {</span>
<a href="#l28.67"></a><span id="l28.67" class="difflineplus">+ public:</span>
<a href="#l28.68"></a><span id="l28.68">   nsMsgCopy();</span>
<a href="#l28.69"></a><span id="l28.69"> </span>
<a href="#l28.70"></a><span id="l28.70">   // nsISupports interface</span>
<a href="#l28.71"></a><span id="l28.71">   NS_DECL_ISUPPORTS</span>
<a href="#l28.72"></a><span id="l28.72">   NS_DECL_NSIURLLISTENER</span>
<a href="#l28.73"></a><span id="l28.73"> </span>
<a href="#l28.74"></a><span id="l28.74" class="difflineminus">-</span>
<a href="#l28.75"></a><span id="l28.75">   //////////////////////////////////////////////////////////////////////</span>
<a href="#l28.76"></a><span id="l28.76">   // Object methods...</span>
<a href="#l28.77"></a><span id="l28.77">   //////////////////////////////////////////////////////////////////////</span>
<a href="#l28.78"></a><span id="l28.78">   //</span>
<a href="#l28.79"></a><span id="l28.79" class="difflineminus">-  nsresult              StartCopyOperation(nsIMsgIdentity   *aUserIdentity,</span>
<a href="#l28.80"></a><span id="l28.80" class="difflineminus">-                                           nsIFile          *aFile,</span>
<a href="#l28.81"></a><span id="l28.81" class="difflineminus">-                                           nsMsgDeliverMode aMode,</span>
<a href="#l28.82"></a><span id="l28.82" class="difflineminus">-                                           nsIMsgSend       *aMsgSendObj,</span>
<a href="#l28.83"></a><span id="l28.83" class="difflineminus">-                                           const char       *aSavePref,</span>
<a href="#l28.84"></a><span id="l28.84" class="difflineminus">-                                           nsIMsgDBHdr      *aMsgToReplace);</span>
<a href="#l28.85"></a><span id="l28.85" class="difflineplus">+  nsresult StartCopyOperation(nsIMsgIdentity *aUserIdentity, nsIFile *aFile,</span>
<a href="#l28.86"></a><span id="l28.86" class="difflineplus">+                              nsMsgDeliverMode aMode, nsIMsgSend *aMsgSendObj,</span>
<a href="#l28.87"></a><span id="l28.87" class="difflineplus">+                              const char *aSavePref,</span>
<a href="#l28.88"></a><span id="l28.88" class="difflineplus">+                              nsIMsgDBHdr *aMsgToReplace);</span>
<a href="#l28.89"></a><span id="l28.89" class="difflineplus">+</span>
<a href="#l28.90"></a><span id="l28.90" class="difflineplus">+  nsresult DoCopy(nsIFile *aDiskFile, nsIMsgFolder *dstFolder,</span>
<a href="#l28.91"></a><span id="l28.91" class="difflineplus">+                  nsIMsgDBHdr *aMsgToReplace, bool aIsDraft,</span>
<a href="#l28.92"></a><span id="l28.92" class="difflineplus">+                  nsIMsgWindow *msgWindow, nsIMsgSend *aMsgSendObj);</span>
<a href="#l28.93"></a><span id="l28.93"> </span>
<a href="#l28.94"></a><span id="l28.94" class="difflineminus">-  nsresult              DoCopy(nsIFile *aDiskFile, nsIMsgFolder *dstFolder,</span>
<a href="#l28.95"></a><span id="l28.95" class="difflineminus">-                               nsIMsgDBHdr *aMsgToReplace, bool aIsDraft,</span>
<a href="#l28.96"></a><span id="l28.96" class="difflineminus">-                               nsIMsgWindow *msgWindow,</span>
<a href="#l28.97"></a><span id="l28.97" class="difflineminus">-                               nsIMsgSend   *aMsgSendObj);</span>
<a href="#l28.98"></a><span id="l28.98" class="difflineminus">-</span>
<a href="#l28.99"></a><span id="l28.99" class="difflineminus">-  nsresult GetUnsentMessagesFolder(nsIMsgIdentity *userIdentity, nsIMsgFolder **msgFolder, bool *waitForUrl);</span>
<a href="#l28.100"></a><span id="l28.100" class="difflineminus">-  nsresult GetDraftsFolder(nsIMsgIdentity *userIdentity, nsIMsgFolder **msgFolder, bool *waitForUrl);</span>
<a href="#l28.101"></a><span id="l28.101" class="difflineminus">-  nsresult GetTemplatesFolder(nsIMsgIdentity *userIdentity, nsIMsgFolder **msgFolder, bool *waitForUrl);</span>
<a href="#l28.102"></a><span id="l28.102" class="difflineminus">-  nsresult GetSentFolder(nsIMsgIdentity *userIdentity,  nsIMsgFolder **msgFolder, bool *waitForUrl);</span>
<a href="#l28.103"></a><span id="l28.103" class="difflineplus">+  nsresult GetUnsentMessagesFolder(nsIMsgIdentity *userIdentity,</span>
<a href="#l28.104"></a><span id="l28.104" class="difflineplus">+                                   nsIMsgFolder **msgFolder, bool *waitForUrl);</span>
<a href="#l28.105"></a><span id="l28.105" class="difflineplus">+  nsresult GetDraftsFolder(nsIMsgIdentity *userIdentity,</span>
<a href="#l28.106"></a><span id="l28.106" class="difflineplus">+                           nsIMsgFolder **msgFolder, bool *waitForUrl);</span>
<a href="#l28.107"></a><span id="l28.107" class="difflineplus">+  nsresult GetTemplatesFolder(nsIMsgIdentity *userIdentity,</span>
<a href="#l28.108"></a><span id="l28.108" class="difflineplus">+                              nsIMsgFolder **msgFolder, bool *waitForUrl);</span>
<a href="#l28.109"></a><span id="l28.109" class="difflineplus">+  nsresult GetSentFolder(nsIMsgIdentity *userIdentity, nsIMsgFolder **msgFolder,</span>
<a href="#l28.110"></a><span id="l28.110" class="difflineplus">+                         bool *waitForUrl);</span>
<a href="#l28.111"></a><span id="l28.111">   nsresult CreateIfMissing(nsIMsgFolder **folder, bool *waitForUrl);</span>
<a href="#l28.112"></a><span id="l28.112"> </span>
<a href="#l28.113"></a><span id="l28.113" class="difflineminus">-</span>
<a href="#l28.114"></a><span id="l28.114">   //</span>
<a href="#l28.115"></a><span id="l28.115">   // Vars for implementation...</span>
<a href="#l28.116"></a><span id="l28.116">   //</span>
<a href="#l28.117"></a><span id="l28.117" class="difflineminus">-  nsIFile                *mFile;     // the file we are sending...</span>
<a href="#l28.118"></a><span id="l28.118" class="difflineminus">-  nsMsgDeliverMode       mMode;</span>
<a href="#l28.119"></a><span id="l28.119" class="difflineplus">+  nsIFile *mFile;  // the file we are sending...</span>
<a href="#l28.120"></a><span id="l28.120" class="difflineplus">+  nsMsgDeliverMode mMode;</span>
<a href="#l28.121"></a><span id="l28.121">   nsCOMPtr&lt;nsIMsgFolder&gt; mDstFolder;</span>
<a href="#l28.122"></a><span id="l28.122" class="difflineminus">-  nsCOMPtr&lt;nsIMsgDBHdr&gt;  mMsgToReplace;</span>
<a href="#l28.123"></a><span id="l28.123" class="difflineminus">-  bool                   mIsDraft;</span>
<a href="#l28.124"></a><span id="l28.124" class="difflineminus">-  nsCOMPtr&lt;nsIMsgSend&gt;   mMsgSendObj;</span>
<a href="#l28.125"></a><span id="l28.125" class="difflineminus">-  char                   *mSavePref;</span>
<a href="#l28.126"></a><span id="l28.126" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; mMsgToReplace;</span>
<a href="#l28.127"></a><span id="l28.127" class="difflineplus">+  bool mIsDraft;</span>
<a href="#l28.128"></a><span id="l28.128" class="difflineplus">+  nsCOMPtr&lt;nsIMsgSend&gt; mMsgSendObj;</span>
<a href="#l28.129"></a><span id="l28.129" class="difflineplus">+  char *mSavePref;</span>
<a href="#l28.130"></a><span id="l28.130"> </span>
<a href="#l28.131"></a><span id="l28.131" class="difflineminus">-private:</span>
<a href="#l28.132"></a><span id="l28.132" class="difflineplus">+ private:</span>
<a href="#l28.133"></a><span id="l28.133">   virtual ~nsMsgCopy();</span>
<a href="#l28.134"></a><span id="l28.134"> };</span>
<a href="#l28.135"></a><span id="l28.135"> </span>
<a href="#l28.136"></a><span id="l28.136"> // Useful function for the back end...</span>
<a href="#l28.137"></a><span id="l28.137" class="difflineminus">-nsresult LocateMessageFolder(nsIMsgIdentity   *userIdentity,</span>
<a href="#l28.138"></a><span id="l28.138" class="difflineminus">-                             nsMsgDeliverMode aFolderType,</span>
<a href="#l28.139"></a><span id="l28.139" class="difflineminus">-                             const char       *aSaveURI,</span>
<a href="#l28.140"></a><span id="l28.140" class="difflineplus">+nsresult LocateMessageFolder(nsIMsgIdentity *userIdentity,</span>
<a href="#l28.141"></a><span id="l28.141" class="difflineplus">+                             nsMsgDeliverMode aFolderType, const char *aSaveURI,</span>
<a href="#l28.142"></a><span id="l28.142">                              nsIMsgFolder **msgFolder);</span>
<a href="#l28.143"></a><span id="l28.143"> </span>
<a href="#l28.144"></a><span id="l28.144" class="difflineminus">-nsresult MessageFolderIsLocal(nsIMsgIdentity   *userIdentity,</span>
<a href="#l28.145"></a><span id="l28.145" class="difflineplus">+nsresult MessageFolderIsLocal(nsIMsgIdentity *userIdentity,</span>
<a href="#l28.146"></a><span id="l28.146">                               nsMsgDeliverMode aFolderType,</span>
<a href="#l28.147"></a><span id="l28.147" class="difflineminus">-                              const char       *aSaveURI,</span>
<a href="#l28.148"></a><span id="l28.148" class="difflineminus">-                              bool             *aResult);</span>
<a href="#l28.149"></a><span id="l28.149" class="difflineplus">+                              const char *aSaveURI, bool *aResult);</span>
<a href="#l28.150"></a><span id="l28.150"> </span>
<a href="#l28.151"></a><span id="l28.151"> #endif /* _nsMsgCopy_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgPrompts.cpp</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgPrompts.cpp</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -9,107 +9,97 @@</span>
<a href="#l29.4"></a><span id="l29.4"> #include &quot;nsIWindowWatcher.h&quot;</span>
<a href="#l29.5"></a><span id="l29.5"> #include &quot;nsMsgCompCID.h&quot;</span>
<a href="#l29.6"></a><span id="l29.6"> #include &quot;nsComposeStrings.h&quot;</span>
<a href="#l29.7"></a><span id="l29.7"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l29.8"></a><span id="l29.8"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l29.9"></a><span id="l29.9"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l29.10"></a><span id="l29.10"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l29.11"></a><span id="l29.11"> </span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-nsresult</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineminus">-nsMsgGetMessageByName(const char* aName, nsString&amp; aResult)</span>
<a href="#l29.14"></a><span id="l29.14" class="difflineminus">-{</span>
<a href="#l29.15"></a><span id="l29.15" class="difflineplus">+nsresult nsMsgGetMessageByName(const char *aName, nsString &amp;aResult) {</span>
<a href="#l29.16"></a><span id="l29.16">   nsresult rv;</span>
<a href="#l29.17"></a><span id="l29.17">   nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l29.18"></a><span id="l29.18" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l29.19"></a><span id="l29.19" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l29.20"></a><span id="l29.20">   NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l29.21"></a><span id="l29.21"> </span>
<a href="#l29.22"></a><span id="l29.22">   nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l29.23"></a><span id="l29.23">   rv = bundleService-&gt;CreateBundle(</span>
<a href="#l29.24"></a><span id="l29.24" class="difflineminus">-    &quot;chrome://messenger/locale/messengercompose/composeMsgs.properties&quot;,</span>
<a href="#l29.25"></a><span id="l29.25" class="difflineminus">-    getter_AddRefs(bundle));</span>
<a href="#l29.26"></a><span id="l29.26" class="difflineplus">+      &quot;chrome://messenger/locale/messengercompose/composeMsgs.properties&quot;,</span>
<a href="#l29.27"></a><span id="l29.27" class="difflineplus">+      getter_AddRefs(bundle));</span>
<a href="#l29.28"></a><span id="l29.28">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l29.29"></a><span id="l29.29"> </span>
<a href="#l29.30"></a><span id="l29.30">   return bundle-&gt;GetStringFromName(aName, aResult);</span>
<a href="#l29.31"></a><span id="l29.31"> }</span>
<a href="#l29.32"></a><span id="l29.32"> </span>
<a href="#l29.33"></a><span id="l29.33" class="difflineminus">-static nsresult</span>
<a href="#l29.34"></a><span id="l29.34" class="difflineminus">-nsMsgBuildMessageByName(const char *aName, nsIFile *aFile, nsString&amp; aResult)</span>
<a href="#l29.35"></a><span id="l29.35" class="difflineminus">-{</span>
<a href="#l29.36"></a><span id="l29.36" class="difflineplus">+static nsresult nsMsgBuildMessageByName(const char *aName, nsIFile *aFile,</span>
<a href="#l29.37"></a><span id="l29.37" class="difflineplus">+                                        nsString &amp;aResult) {</span>
<a href="#l29.38"></a><span id="l29.38">   NS_ENSURE_ARG_POINTER(aFile);</span>
<a href="#l29.39"></a><span id="l29.39">   nsresult rv;</span>
<a href="#l29.40"></a><span id="l29.40">   nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l29.41"></a><span id="l29.41" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l29.42"></a><span id="l29.42" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l29.43"></a><span id="l29.43">   NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l29.44"></a><span id="l29.44"> </span>
<a href="#l29.45"></a><span id="l29.45">   nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l29.46"></a><span id="l29.46" class="difflineminus">-  rv = bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/messengercompose/composeMsgs.properties&quot;, getter_AddRefs(bundle));</span>
<a href="#l29.47"></a><span id="l29.47" class="difflineplus">+  rv = bundleService-&gt;CreateBundle(</span>
<a href="#l29.48"></a><span id="l29.48" class="difflineplus">+      &quot;chrome://messenger/locale/messengercompose/composeMsgs.properties&quot;,</span>
<a href="#l29.49"></a><span id="l29.49" class="difflineplus">+      getter_AddRefs(bundle));</span>
<a href="#l29.50"></a><span id="l29.50">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l29.51"></a><span id="l29.51"> </span>
<a href="#l29.52"></a><span id="l29.52">   nsString path;</span>
<a href="#l29.53"></a><span id="l29.53">   aFile-&gt;GetPath(path);</span>
<a href="#l29.54"></a><span id="l29.54"> </span>
<a href="#l29.55"></a><span id="l29.55">   const char16_t *params[1] = {path.get()};</span>
<a href="#l29.56"></a><span id="l29.56">   return bundle-&gt;FormatStringFromName(aName, params, 1, aResult);</span>
<a href="#l29.57"></a><span id="l29.57"> }</span>
<a href="#l29.58"></a><span id="l29.58"> </span>
<a href="#l29.59"></a><span id="l29.59" class="difflineminus">-nsresult</span>
<a href="#l29.60"></a><span id="l29.60" class="difflineminus">-nsMsgBuildMessageWithFile(nsIFile *aFile, nsString&amp; aResult)</span>
<a href="#l29.61"></a><span id="l29.61" class="difflineminus">-{</span>
<a href="#l29.62"></a><span id="l29.62" class="difflineplus">+nsresult nsMsgBuildMessageWithFile(nsIFile *aFile, nsString &amp;aResult) {</span>
<a href="#l29.63"></a><span id="l29.63">   return nsMsgBuildMessageByName(&quot;unableToOpenFile&quot;, aFile, aResult);</span>
<a href="#l29.64"></a><span id="l29.64"> }</span>
<a href="#l29.65"></a><span id="l29.65"> </span>
<a href="#l29.66"></a><span id="l29.66" class="difflineminus">-nsresult</span>
<a href="#l29.67"></a><span id="l29.67" class="difflineminus">-nsMsgBuildMessageWithTmpFile(nsIFile *aFile, nsString&amp; aResult)</span>
<a href="#l29.68"></a><span id="l29.68" class="difflineminus">-{</span>
<a href="#l29.69"></a><span id="l29.69" class="difflineplus">+nsresult nsMsgBuildMessageWithTmpFile(nsIFile *aFile, nsString &amp;aResult) {</span>
<a href="#l29.70"></a><span id="l29.70">   return nsMsgBuildMessageByName(&quot;unableToOpenTmpFile&quot;, aFile, aResult);</span>
<a href="#l29.71"></a><span id="l29.71"> }</span>
<a href="#l29.72"></a><span id="l29.72"> </span>
<a href="#l29.73"></a><span id="l29.73" class="difflineminus">-nsresult</span>
<a href="#l29.74"></a><span id="l29.74" class="difflineminus">-nsMsgDisplayMessageByName(nsIPrompt *aPrompt, const char* aName, const char16_t *windowTitle)</span>
<a href="#l29.75"></a><span id="l29.75" class="difflineminus">-{</span>
<a href="#l29.76"></a><span id="l29.76" class="difflineplus">+nsresult nsMsgDisplayMessageByName(nsIPrompt *aPrompt, const char *aName,</span>
<a href="#l29.77"></a><span id="l29.77" class="difflineplus">+                                   const char16_t *windowTitle) {</span>
<a href="#l29.78"></a><span id="l29.78">   nsString msg;</span>
<a href="#l29.79"></a><span id="l29.79">   nsMsgGetMessageByName(aName, msg);</span>
<a href="#l29.80"></a><span id="l29.80">   return nsMsgDisplayMessageByString(aPrompt, msg.get(), windowTitle);</span>
<a href="#l29.81"></a><span id="l29.81"> }</span>
<a href="#l29.82"></a><span id="l29.82"> </span>
<a href="#l29.83"></a><span id="l29.83" class="difflineminus">-nsresult</span>
<a href="#l29.84"></a><span id="l29.84" class="difflineminus">-nsMsgDisplayMessageByString(nsIPrompt * aPrompt, const char16_t * msg, const char16_t * windowTitle)</span>
<a href="#l29.85"></a><span id="l29.85" class="difflineminus">-{</span>
<a href="#l29.86"></a><span id="l29.86" class="difflineplus">+nsresult nsMsgDisplayMessageByString(nsIPrompt *aPrompt, const char16_t *msg,</span>
<a href="#l29.87"></a><span id="l29.87" class="difflineplus">+                                     const char16_t *windowTitle) {</span>
<a href="#l29.88"></a><span id="l29.88">   NS_ENSURE_ARG_POINTER(msg);</span>
<a href="#l29.89"></a><span id="l29.89"> </span>
<a href="#l29.90"></a><span id="l29.90">   nsresult rv = NS_OK;</span>
<a href="#l29.91"></a><span id="l29.91">   nsCOMPtr&lt;nsIPrompt&gt; prompt = aPrompt;</span>
<a href="#l29.92"></a><span id="l29.92"> </span>
<a href="#l29.93"></a><span id="l29.93" class="difflineminus">-  if (!prompt)</span>
<a href="#l29.94"></a><span id="l29.94" class="difflineminus">-  {</span>
<a href="#l29.95"></a><span id="l29.95" class="difflineminus">-    nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch(do_GetService(NS_WINDOWWATCHER_CONTRACTID));</span>
<a href="#l29.96"></a><span id="l29.96" class="difflineminus">-    if (wwatch)</span>
<a href="#l29.97"></a><span id="l29.97" class="difflineminus">-      wwatch-&gt;GetNewPrompter(0, getter_AddRefs(prompt));</span>
<a href="#l29.98"></a><span id="l29.98" class="difflineplus">+  if (!prompt) {</span>
<a href="#l29.99"></a><span id="l29.99" class="difflineplus">+    nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch(</span>
<a href="#l29.100"></a><span id="l29.100" class="difflineplus">+        do_GetService(NS_WINDOWWATCHER_CONTRACTID));</span>
<a href="#l29.101"></a><span id="l29.101" class="difflineplus">+    if (wwatch) wwatch-&gt;GetNewPrompter(0, getter_AddRefs(prompt));</span>
<a href="#l29.102"></a><span id="l29.102">   }</span>
<a href="#l29.103"></a><span id="l29.103"> </span>
<a href="#l29.104"></a><span id="l29.104" class="difflineminus">-  if (prompt)</span>
<a href="#l29.105"></a><span id="l29.105" class="difflineminus">-    rv = prompt-&gt;Alert(windowTitle, msg);</span>
<a href="#l29.106"></a><span id="l29.106" class="difflineplus">+  if (prompt) rv = prompt-&gt;Alert(windowTitle, msg);</span>
<a href="#l29.107"></a><span id="l29.107"> </span>
<a href="#l29.108"></a><span id="l29.108">   return rv;</span>
<a href="#l29.109"></a><span id="l29.109"> }</span>
<a href="#l29.110"></a><span id="l29.110"> </span>
<a href="#l29.111"></a><span id="l29.111" class="difflineminus">-nsresult</span>
<a href="#l29.112"></a><span id="l29.112" class="difflineminus">-nsMsgAskBooleanQuestionByString(nsIPrompt * aPrompt, const char16_t * msg, bool *answer, const char16_t * windowTitle)</span>
<a href="#l29.113"></a><span id="l29.113" class="difflineminus">-{</span>
<a href="#l29.114"></a><span id="l29.114" class="difflineplus">+nsresult nsMsgAskBooleanQuestionByString(nsIPrompt *aPrompt,</span>
<a href="#l29.115"></a><span id="l29.115" class="difflineplus">+                                         const char16_t *msg, bool *answer,</span>
<a href="#l29.116"></a><span id="l29.116" class="difflineplus">+                                         const char16_t *windowTitle) {</span>
<a href="#l29.117"></a><span id="l29.117">   NS_ENSURE_TRUE(msg &amp;&amp; *msg, NS_ERROR_INVALID_ARG);</span>
<a href="#l29.118"></a><span id="l29.118"> </span>
<a href="#l29.119"></a><span id="l29.119">   nsresult rv = NS_OK;</span>
<a href="#l29.120"></a><span id="l29.120">   nsCOMPtr&lt;nsIPrompt&gt; dialog = aPrompt;</span>
<a href="#l29.121"></a><span id="l29.121"> </span>
<a href="#l29.122"></a><span id="l29.122" class="difflineminus">-  if (!dialog)</span>
<a href="#l29.123"></a><span id="l29.123" class="difflineminus">-  {</span>
<a href="#l29.124"></a><span id="l29.124" class="difflineminus">-    nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch(do_GetService(NS_WINDOWWATCHER_CONTRACTID));</span>
<a href="#l29.125"></a><span id="l29.125" class="difflineminus">-    if (wwatch)</span>
<a href="#l29.126"></a><span id="l29.126" class="difflineminus">-      wwatch-&gt;GetNewPrompter(0, getter_AddRefs(dialog));</span>
<a href="#l29.127"></a><span id="l29.127" class="difflineplus">+  if (!dialog) {</span>
<a href="#l29.128"></a><span id="l29.128" class="difflineplus">+    nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch(</span>
<a href="#l29.129"></a><span id="l29.129" class="difflineplus">+        do_GetService(NS_WINDOWWATCHER_CONTRACTID));</span>
<a href="#l29.130"></a><span id="l29.130" class="difflineplus">+    if (wwatch) wwatch-&gt;GetNewPrompter(0, getter_AddRefs(dialog));</span>
<a href="#l29.131"></a><span id="l29.131">   }</span>
<a href="#l29.132"></a><span id="l29.132"> </span>
<a href="#l29.133"></a><span id="l29.133">   if (dialog) {</span>
<a href="#l29.134"></a><span id="l29.134">     rv = dialog-&gt;Confirm(windowTitle, msg, answer);</span>
<a href="#l29.135"></a><span id="l29.135">   }</span>
<a href="#l29.136"></a><span id="l29.136"> </span>
<a href="#l29.137"></a><span id="l29.137">   return rv;</span>
<a href="#l29.138"></a><span id="l29.138"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgPrompts.h</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgPrompts.h</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -7,16 +7,20 @@</span>
<a href="#l30.4"></a><span id="l30.4"> #define _nsMsgPrompts_H_</span>
<a href="#l30.5"></a><span id="l30.5"> </span>
<a href="#l30.6"></a><span id="l30.6"> #include &quot;nscore.h&quot;</span>
<a href="#l30.7"></a><span id="l30.7"> #include &quot;nsError.h&quot;</span>
<a href="#l30.8"></a><span id="l30.8"> #include &quot;nsString.h&quot;</span>
<a href="#l30.9"></a><span id="l30.9"> </span>
<a href="#l30.10"></a><span id="l30.10"> class nsIPrompt;</span>
<a href="#l30.11"></a><span id="l30.11"> </span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-nsresult      nsMsgGetMessageByName(const char* aName, nsString&amp; aResult);</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineminus">-nsresult      nsMsgBuildMessageWithFile(nsIFile * aFile, nsString&amp; aResult);</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineminus">-nsresult      nsMsgBuildMessageWithTmpFile(nsIFile * aFile, nsString&amp; aResult);</span>
<a href="#l30.15"></a><span id="l30.15" class="difflineminus">-nsresult      nsMsgDisplayMessageByName(nsIPrompt *aPrompt, const char *aName, const char16_t *windowTitle = nullptr);</span>
<a href="#l30.16"></a><span id="l30.16" class="difflineminus">-nsresult      nsMsgDisplayMessageByString(nsIPrompt * aPrompt, const char16_t * msg, const char16_t * windowTitle = nullptr);</span>
<a href="#l30.17"></a><span id="l30.17" class="difflineminus">-nsresult      nsMsgAskBooleanQuestionByString(nsIPrompt * aPrompt, const char16_t * msg, bool *answer, const char16_t * windowTitle = nullptr);</span>
<a href="#l30.18"></a><span id="l30.18" class="difflineplus">+nsresult nsMsgGetMessageByName(const char* aName, nsString&amp; aResult);</span>
<a href="#l30.19"></a><span id="l30.19" class="difflineplus">+nsresult nsMsgBuildMessageWithFile(nsIFile* aFile, nsString&amp; aResult);</span>
<a href="#l30.20"></a><span id="l30.20" class="difflineplus">+nsresult nsMsgBuildMessageWithTmpFile(nsIFile* aFile, nsString&amp; aResult);</span>
<a href="#l30.21"></a><span id="l30.21" class="difflineplus">+nsresult nsMsgDisplayMessageByName(nsIPrompt* aPrompt, const char* aName,</span>
<a href="#l30.22"></a><span id="l30.22" class="difflineplus">+                                   const char16_t* windowTitle = nullptr);</span>
<a href="#l30.23"></a><span id="l30.23" class="difflineplus">+nsresult nsMsgDisplayMessageByString(nsIPrompt* aPrompt, const char16_t* msg,</span>
<a href="#l30.24"></a><span id="l30.24" class="difflineplus">+                                     const char16_t* windowTitle = nullptr);</span>
<a href="#l30.25"></a><span id="l30.25" class="difflineplus">+nsresult nsMsgAskBooleanQuestionByString(nsIPrompt* aPrompt,</span>
<a href="#l30.26"></a><span id="l30.26" class="difflineplus">+                                         const char16_t* msg, bool* answer,</span>
<a href="#l30.27"></a><span id="l30.27" class="difflineplus">+                                         const char16_t* windowTitle = nullptr);</span>
<a href="#l30.28"></a><span id="l30.28"> </span>
<a href="#l30.29"></a><span id="l30.29"> #endif /* _nsMsgPrompts_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgQuote.cpp</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgQuote.cpp</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -22,196 +22,168 @@</span>
<a href="#l31.4"></a><span id="l31.4"> #include &quot;nsMsgMimeCID.h&quot;</span>
<a href="#l31.5"></a><span id="l31.5"> #include &quot;nsMsgCompCID.h&quot;</span>
<a href="#l31.6"></a><span id="l31.6"> #include &quot;nsMsgCompose.h&quot;</span>
<a href="#l31.7"></a><span id="l31.7"> #include &quot;nsMsgMailNewsUrl.h&quot;</span>
<a href="#l31.8"></a><span id="l31.8"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l31.9"></a><span id="l31.9"> #include &quot;nsContentUtils.h&quot;</span>
<a href="#l31.10"></a><span id="l31.10"> </span>
<a href="#l31.11"></a><span id="l31.11"> NS_IMPL_ISUPPORTS(nsMsgQuoteListener, nsIMsgQuoteListener,</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-  nsIMimeStreamConverterListener)</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineplus">+                  nsIMimeStreamConverterListener)</span>
<a href="#l31.14"></a><span id="l31.14"> </span>
<a href="#l31.15"></a><span id="l31.15" class="difflineminus">-nsMsgQuoteListener::nsMsgQuoteListener()</span>
<a href="#l31.16"></a><span id="l31.16" class="difflineminus">-{</span>
<a href="#l31.17"></a><span id="l31.17" class="difflineminus">-}</span>
<a href="#l31.18"></a><span id="l31.18" class="difflineplus">+nsMsgQuoteListener::nsMsgQuoteListener() {}</span>
<a href="#l31.19"></a><span id="l31.19"> </span>
<a href="#l31.20"></a><span id="l31.20" class="difflineminus">-nsMsgQuoteListener::~nsMsgQuoteListener()</span>
<a href="#l31.21"></a><span id="l31.21" class="difflineminus">-{</span>
<a href="#l31.22"></a><span id="l31.22" class="difflineminus">-}</span>
<a href="#l31.23"></a><span id="l31.23" class="difflineplus">+nsMsgQuoteListener::~nsMsgQuoteListener() {}</span>
<a href="#l31.24"></a><span id="l31.24"> </span>
<a href="#l31.25"></a><span id="l31.25" class="difflineminus">-NS_IMETHODIMP nsMsgQuoteListener::SetMsgQuote(nsIMsgQuote * msgQuote)</span>
<a href="#l31.26"></a><span id="l31.26" class="difflineminus">-{</span>
<a href="#l31.27"></a><span id="l31.27" class="difflineplus">+NS_IMETHODIMP nsMsgQuoteListener::SetMsgQuote(nsIMsgQuote *msgQuote) {</span>
<a href="#l31.28"></a><span id="l31.28">   mMsgQuote = do_GetWeakReference(msgQuote);</span>
<a href="#l31.29"></a><span id="l31.29">   return NS_OK;</span>
<a href="#l31.30"></a><span id="l31.30"> }</span>
<a href="#l31.31"></a><span id="l31.31"> </span>
<a href="#l31.32"></a><span id="l31.32" class="difflineminus">-NS_IMETHODIMP nsMsgQuoteListener::GetMsgQuote(nsIMsgQuote ** aMsgQuote)</span>
<a href="#l31.33"></a><span id="l31.33" class="difflineminus">-{</span>
<a href="#l31.34"></a><span id="l31.34" class="difflineplus">+NS_IMETHODIMP nsMsgQuoteListener::GetMsgQuote(nsIMsgQuote **aMsgQuote) {</span>
<a href="#l31.35"></a><span id="l31.35">   nsresult rv = NS_OK;</span>
<a href="#l31.36"></a><span id="l31.36" class="difflineminus">-  if (aMsgQuote)</span>
<a href="#l31.37"></a><span id="l31.37" class="difflineminus">-  {</span>
<a href="#l31.38"></a><span id="l31.38" class="difflineplus">+  if (aMsgQuote) {</span>
<a href="#l31.39"></a><span id="l31.39">     nsCOMPtr&lt;nsIMsgQuote&gt; msgQuote = do_QueryReferent(mMsgQuote);</span>
<a href="#l31.40"></a><span id="l31.40">     msgQuote.forget(aMsgQuote);</span>
<a href="#l31.41"></a><span id="l31.41" class="difflineminus">-  }</span>
<a href="#l31.42"></a><span id="l31.42" class="difflineminus">-  else</span>
<a href="#l31.43"></a><span id="l31.43" class="difflineplus">+  } else</span>
<a href="#l31.44"></a><span id="l31.44">     rv = NS_ERROR_NULL_POINTER;</span>
<a href="#l31.45"></a><span id="l31.45"> </span>
<a href="#l31.46"></a><span id="l31.46">   return rv;</span>
<a href="#l31.47"></a><span id="l31.47"> }</span>
<a href="#l31.48"></a><span id="l31.48"> </span>
<a href="#l31.49"></a><span id="l31.49" class="difflineminus">-nsresult nsMsgQuoteListener::OnHeadersReady(nsIMimeHeaders * headers)</span>
<a href="#l31.50"></a><span id="l31.50" class="difflineminus">-{</span>
<a href="#l31.51"></a><span id="l31.51" class="difflineplus">+nsresult nsMsgQuoteListener::OnHeadersReady(nsIMimeHeaders *headers) {</span>
<a href="#l31.52"></a><span id="l31.52">   nsCOMPtr&lt;nsIMsgQuotingOutputStreamListener&gt; quotingOutputStreamListener;</span>
<a href="#l31.53"></a><span id="l31.53">   nsCOMPtr&lt;nsIMsgQuote&gt; msgQuote = do_QueryReferent(mMsgQuote);</span>
<a href="#l31.54"></a><span id="l31.54"> </span>
<a href="#l31.55"></a><span id="l31.55">   if (msgQuote)</span>
<a href="#l31.56"></a><span id="l31.56">     msgQuote-&gt;GetStreamListener(getter_AddRefs(quotingOutputStreamListener));</span>
<a href="#l31.57"></a><span id="l31.57"> </span>
<a href="#l31.58"></a><span id="l31.58">   if (quotingOutputStreamListener)</span>
<a href="#l31.59"></a><span id="l31.59">     quotingOutputStreamListener-&gt;SetMimeHeaders(headers);</span>
<a href="#l31.60"></a><span id="l31.60">   return NS_OK;</span>
<a href="#l31.61"></a><span id="l31.61"> }</span>
<a href="#l31.62"></a><span id="l31.62"> </span>
<a href="#l31.63"></a><span id="l31.63"> //</span>
<a href="#l31.64"></a><span id="l31.64"> // Implementation...</span>
<a href="#l31.65"></a><span id="l31.65"> //</span>
<a href="#l31.66"></a><span id="l31.66" class="difflineminus">-nsMsgQuote::nsMsgQuote()</span>
<a href="#l31.67"></a><span id="l31.67" class="difflineminus">-{</span>
<a href="#l31.68"></a><span id="l31.68" class="difflineplus">+nsMsgQuote::nsMsgQuote() {</span>
<a href="#l31.69"></a><span id="l31.69">   mQuoteHeaders = false;</span>
<a href="#l31.70"></a><span id="l31.70">   mQuoteListener = nullptr;</span>
<a href="#l31.71"></a><span id="l31.71"> }</span>
<a href="#l31.72"></a><span id="l31.72"> </span>
<a href="#l31.73"></a><span id="l31.73" class="difflineminus">-nsMsgQuote::~nsMsgQuote()</span>
<a href="#l31.74"></a><span id="l31.74" class="difflineminus">-{</span>
<a href="#l31.75"></a><span id="l31.75" class="difflineminus">-}</span>
<a href="#l31.76"></a><span id="l31.76" class="difflineplus">+nsMsgQuote::~nsMsgQuote() {}</span>
<a href="#l31.77"></a><span id="l31.77"> </span>
<a href="#l31.78"></a><span id="l31.78"> NS_IMPL_ISUPPORTS(nsMsgQuote, nsIMsgQuote, nsISupportsWeakReference)</span>
<a href="#l31.79"></a><span id="l31.79"> </span>
<a href="#l31.80"></a><span id="l31.80" class="difflineminus">-NS_IMETHODIMP nsMsgQuote::GetStreamListener(nsIMsgQuotingOutputStreamListener ** aStreamListener)</span>
<a href="#l31.81"></a><span id="l31.81" class="difflineminus">-{</span>
<a href="#l31.82"></a><span id="l31.82" class="difflineplus">+NS_IMETHODIMP nsMsgQuote::GetStreamListener(</span>
<a href="#l31.83"></a><span id="l31.83" class="difflineplus">+    nsIMsgQuotingOutputStreamListener **aStreamListener) {</span>
<a href="#l31.84"></a><span id="l31.84">   nsresult rv = NS_OK;</span>
<a href="#l31.85"></a><span id="l31.85" class="difflineminus">-  if (aStreamListener)</span>
<a href="#l31.86"></a><span id="l31.86" class="difflineminus">-  {</span>
<a href="#l31.87"></a><span id="l31.87" class="difflineplus">+  if (aStreamListener) {</span>
<a href="#l31.88"></a><span id="l31.88">     NS_IF_ADDREF(*aStreamListener = mStreamListener);</span>
<a href="#l31.89"></a><span id="l31.89" class="difflineminus">-  }</span>
<a href="#l31.90"></a><span id="l31.90" class="difflineminus">-  else</span>
<a href="#l31.91"></a><span id="l31.91" class="difflineplus">+  } else</span>
<a href="#l31.92"></a><span id="l31.92">     rv = NS_ERROR_NULL_POINTER;</span>
<a href="#l31.93"></a><span id="l31.93"> </span>
<a href="#l31.94"></a><span id="l31.94">   return rv;</span>
<a href="#l31.95"></a><span id="l31.95"> }</span>
<a href="#l31.96"></a><span id="l31.96"> </span>
<a href="#l31.97"></a><span id="l31.97" class="difflineminus">-nsresult</span>
<a href="#l31.98"></a><span id="l31.98" class="difflineminus">-nsMsgQuote::QuoteMessage(const char *msgURI, bool quoteHeaders,</span>
<a href="#l31.99"></a><span id="l31.99" class="difflineminus">-                         nsIMsgQuotingOutputStreamListener * aQuoteMsgStreamListener,</span>
<a href="#l31.100"></a><span id="l31.100" class="difflineminus">-                         const char * aMsgCharSet, bool headersOnly,</span>
<a href="#l31.101"></a><span id="l31.101" class="difflineminus">-                         nsIMsgDBHdr *aMsgHdr)</span>
<a href="#l31.102"></a><span id="l31.102" class="difflineminus">-{</span>
<a href="#l31.103"></a><span id="l31.103" class="difflineminus">-  nsresult  rv;</span>
<a href="#l31.104"></a><span id="l31.104" class="difflineminus">-  if (!msgURI)</span>
<a href="#l31.105"></a><span id="l31.105" class="difflineminus">-    return NS_ERROR_INVALID_ARG;</span>
<a href="#l31.106"></a><span id="l31.106" class="difflineplus">+nsresult nsMsgQuote::QuoteMessage(</span>
<a href="#l31.107"></a><span id="l31.107" class="difflineplus">+    const char *msgURI, bool quoteHeaders,</span>
<a href="#l31.108"></a><span id="l31.108" class="difflineplus">+    nsIMsgQuotingOutputStreamListener *aQuoteMsgStreamListener,</span>
<a href="#l31.109"></a><span id="l31.109" class="difflineplus">+    const char *aMsgCharSet, bool headersOnly, nsIMsgDBHdr *aMsgHdr) {</span>
<a href="#l31.110"></a><span id="l31.110" class="difflineplus">+  nsresult rv;</span>
<a href="#l31.111"></a><span id="l31.111" class="difflineplus">+  if (!msgURI) return NS_ERROR_INVALID_ARG;</span>
<a href="#l31.112"></a><span id="l31.112"> </span>
<a href="#l31.113"></a><span id="l31.113">   mQuoteHeaders = quoteHeaders;</span>
<a href="#l31.114"></a><span id="l31.114">   mStreamListener = aQuoteMsgStreamListener;</span>
<a href="#l31.115"></a><span id="l31.115"> </span>
<a href="#l31.116"></a><span id="l31.116">   nsAutoCString msgUri(msgURI);</span>
<a href="#l31.117"></a><span id="l31.117">   bool fileUrl = !strncmp(msgURI, &quot;file:&quot;, 5);</span>
<a href="#l31.118"></a><span id="l31.118" class="difflineminus">-  bool forwardedMessage = PL_strstr(msgURI, &quot;&amp;realtype=message/rfc822&quot;) != nullptr;</span>
<a href="#l31.119"></a><span id="l31.119" class="difflineplus">+  bool forwardedMessage =</span>
<a href="#l31.120"></a><span id="l31.120" class="difflineplus">+      PL_strstr(msgURI, &quot;&amp;realtype=message/rfc822&quot;) != nullptr;</span>
<a href="#l31.121"></a><span id="l31.121">   nsCOMPtr&lt;nsIURI&gt; newURI;</span>
<a href="#l31.122"></a><span id="l31.122" class="difflineminus">-  if (fileUrl)</span>
<a href="#l31.123"></a><span id="l31.123" class="difflineminus">-  {</span>
<a href="#l31.124"></a><span id="l31.124" class="difflineplus">+  if (fileUrl) {</span>
<a href="#l31.125"></a><span id="l31.125">     msgUri.Replace(0, 5, NS_LITERAL_CSTRING(&quot;mailbox:&quot;));</span>
<a href="#l31.126"></a><span id="l31.126">     msgUri.AppendLiteral(&quot;?number=0&quot;);</span>
<a href="#l31.127"></a><span id="l31.127">     rv = NS_NewURI(getter_AddRefs(newURI), msgUri);</span>
<a href="#l31.128"></a><span id="l31.128">     nsCOMPtr&lt;nsIMsgMessageUrl&gt; mailUrl(do_QueryInterface(newURI));</span>
<a href="#l31.129"></a><span id="l31.129" class="difflineminus">-    if (mailUrl)</span>
<a href="#l31.130"></a><span id="l31.130" class="difflineminus">-      mailUrl-&gt;SetMessageHeader(aMsgHdr);</span>
<a href="#l31.131"></a><span id="l31.131" class="difflineminus">-  }</span>
<a href="#l31.132"></a><span id="l31.132" class="difflineminus">-  else if (forwardedMessage)</span>
<a href="#l31.133"></a><span id="l31.133" class="difflineplus">+    if (mailUrl) mailUrl-&gt;SetMessageHeader(aMsgHdr);</span>
<a href="#l31.134"></a><span id="l31.134" class="difflineplus">+  } else if (forwardedMessage)</span>
<a href="#l31.135"></a><span id="l31.135">     rv = NS_NewURI(getter_AddRefs(newURI), msgURI);</span>
<a href="#l31.136"></a><span id="l31.136" class="difflineminus">-  else</span>
<a href="#l31.137"></a><span id="l31.137" class="difflineminus">-  {</span>
<a href="#l31.138"></a><span id="l31.138" class="difflineminus">-    nsCOMPtr &lt;nsIMsgMessageService&gt; msgService;</span>
<a href="#l31.139"></a><span id="l31.139" class="difflineminus">-    rv = GetMessageServiceFromURI(nsDependentCString(msgURI), getter_AddRefs(msgService));</span>
<a href="#l31.140"></a><span id="l31.140" class="difflineplus">+  else {</span>
<a href="#l31.141"></a><span id="l31.141" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMessageService&gt; msgService;</span>
<a href="#l31.142"></a><span id="l31.142" class="difflineplus">+    rv = GetMessageServiceFromURI(nsDependentCString(msgURI),</span>
<a href="#l31.143"></a><span id="l31.143" class="difflineplus">+                                  getter_AddRefs(msgService));</span>
<a href="#l31.144"></a><span id="l31.144">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l31.145"></a><span id="l31.145">     rv = msgService-&gt;GetUrlForUri(msgURI, getter_AddRefs(newURI), nullptr);</span>
<a href="#l31.146"></a><span id="l31.146">   }</span>
<a href="#l31.147"></a><span id="l31.147">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l31.148"></a><span id="l31.148"> </span>
<a href="#l31.149"></a><span id="l31.149">   nsAutoCString queryPart;</span>
<a href="#l31.150"></a><span id="l31.150">   rv = newURI-&gt;GetQuery(queryPart);</span>
<a href="#l31.151"></a><span id="l31.151" class="difflineminus">-  if (!queryPart.IsEmpty())</span>
<a href="#l31.152"></a><span id="l31.152" class="difflineminus">-    queryPart.Append('&amp;');</span>
<a href="#l31.153"></a><span id="l31.153" class="difflineplus">+  if (!queryPart.IsEmpty()) queryPart.Append('&amp;');</span>
<a href="#l31.154"></a><span id="l31.154"> </span>
<a href="#l31.155"></a><span id="l31.155" class="difflineminus">-  if (headersOnly) /* We don't need to quote the message body but we still need to extract the headers */</span>
<a href="#l31.156"></a><span id="l31.156" class="difflineplus">+  if (headersOnly) /* We don't need to quote the message body but we still need</span>
<a href="#l31.157"></a><span id="l31.157" class="difflineplus">+                      to extract the headers */</span>
<a href="#l31.158"></a><span id="l31.158">     queryPart.AppendLiteral(&quot;header=only&quot;);</span>
<a href="#l31.159"></a><span id="l31.159">   else if (quoteHeaders)</span>
<a href="#l31.160"></a><span id="l31.160">     queryPart.AppendLiteral(&quot;header=quote&quot;);</span>
<a href="#l31.161"></a><span id="l31.161">   else</span>
<a href="#l31.162"></a><span id="l31.162">     queryPart.AppendLiteral(&quot;header=quotebody&quot;);</span>
<a href="#l31.163"></a><span id="l31.163">   rv = NS_MutateURI(newURI).SetQuery(queryPart).Finalize(newURI);</span>
<a href="#l31.164"></a><span id="l31.164" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l31.165"></a><span id="l31.165" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l31.166"></a><span id="l31.166"> </span>
<a href="#l31.167"></a><span id="l31.167">   // if we were given a non empty charset, then use it</span>
<a href="#l31.168"></a><span id="l31.168" class="difflineminus">-  if (aMsgCharSet &amp;&amp; *aMsgCharSet)</span>
<a href="#l31.169"></a><span id="l31.169" class="difflineminus">-  {</span>
<a href="#l31.170"></a><span id="l31.170" class="difflineminus">-    nsCOMPtr&lt;nsIMsgI18NUrl&gt; i18nUrl (do_QueryInterface(newURI));</span>
<a href="#l31.171"></a><span id="l31.171" class="difflineminus">-    if (i18nUrl)</span>
<a href="#l31.172"></a><span id="l31.172" class="difflineminus">-      i18nUrl-&gt;SetCharsetOverRide(aMsgCharSet);</span>
<a href="#l31.173"></a><span id="l31.173" class="difflineplus">+  if (aMsgCharSet &amp;&amp; *aMsgCharSet) {</span>
<a href="#l31.174"></a><span id="l31.174" class="difflineplus">+    nsCOMPtr&lt;nsIMsgI18NUrl&gt; i18nUrl(do_QueryInterface(newURI));</span>
<a href="#l31.175"></a><span id="l31.175" class="difflineplus">+    if (i18nUrl) i18nUrl-&gt;SetCharsetOverRide(aMsgCharSet);</span>
<a href="#l31.176"></a><span id="l31.176">   }</span>
<a href="#l31.177"></a><span id="l31.177"> </span>
<a href="#l31.178"></a><span id="l31.178">   mQuoteListener = do_CreateInstance(NS_MSGQUOTELISTENER_CONTRACTID, &amp;rv);</span>
<a href="#l31.179"></a><span id="l31.179">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l31.180"></a><span id="l31.180">   mQuoteListener-&gt;SetMsgQuote(this);</span>
<a href="#l31.181"></a><span id="l31.181"> </span>
<a href="#l31.182"></a><span id="l31.182" class="difflineminus">-  // funky magic go get the isupports for this class which inherits from multiple interfaces.</span>
<a href="#l31.183"></a><span id="l31.183" class="difflineminus">-  nsISupports * supports;</span>
<a href="#l31.184"></a><span id="l31.184" class="difflineminus">-  QueryInterface(NS_GET_IID(nsISupports), (void **) &amp;supports);</span>
<a href="#l31.185"></a><span id="l31.185" class="difflineplus">+  // funky magic go get the isupports for this class which inherits from</span>
<a href="#l31.186"></a><span id="l31.186" class="difflineplus">+  // multiple interfaces.</span>
<a href="#l31.187"></a><span id="l31.187" class="difflineplus">+  nsISupports *supports;</span>
<a href="#l31.188"></a><span id="l31.188" class="difflineplus">+  QueryInterface(NS_GET_IID(nsISupports), (void **)&amp;supports);</span>
<a href="#l31.189"></a><span id="l31.189">   nsCOMPtr&lt;nsISupports&gt; quoteSupport = supports;</span>
<a href="#l31.190"></a><span id="l31.190">   NS_IF_RELEASE(supports);</span>
<a href="#l31.191"></a><span id="l31.191"> </span>
<a href="#l31.192"></a><span id="l31.192">   // now we want to create a necko channel for this url and we want to open it</span>
<a href="#l31.193"></a><span id="l31.193">   mQuoteChannel = nullptr;</span>
<a href="#l31.194"></a><span id="l31.194">   nsCOMPtr&lt;nsIIOService&gt; netService = mozilla::services::GetIOService();</span>
<a href="#l31.195"></a><span id="l31.195">   NS_ENSURE_TRUE(netService, NS_ERROR_UNEXPECTED);</span>
<a href="#l31.196"></a><span id="l31.196" class="difflineminus">-  rv = netService-&gt;NewChannelFromURI(newURI,</span>
<a href="#l31.197"></a><span id="l31.197" class="difflineminus">-                                     nullptr,</span>
<a href="#l31.198"></a><span id="l31.198" class="difflineminus">-                                     nsContentUtils::GetSystemPrincipal(),</span>
<a href="#l31.199"></a><span id="l31.199" class="difflineminus">-                                     nullptr,</span>
<a href="#l31.200"></a><span id="l31.200" class="difflineminus">-                                     nsILoadInfo::SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l31.201"></a><span id="l31.201" class="difflineminus">-                                     nsIContentPolicy::TYPE_OTHER,</span>
<a href="#l31.202"></a><span id="l31.202" class="difflineminus">-                                     getter_AddRefs(mQuoteChannel));</span>
<a href="#l31.203"></a><span id="l31.203" class="difflineplus">+  rv = netService-&gt;NewChannelFromURI(</span>
<a href="#l31.204"></a><span id="l31.204" class="difflineplus">+      newURI, nullptr, nsContentUtils::GetSystemPrincipal(), nullptr,</span>
<a href="#l31.205"></a><span id="l31.205" class="difflineplus">+      nsILoadInfo::SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l31.206"></a><span id="l31.206" class="difflineplus">+      nsIContentPolicy::TYPE_OTHER, getter_AddRefs(mQuoteChannel));</span>
<a href="#l31.207"></a><span id="l31.207"> </span>
<a href="#l31.208"></a><span id="l31.208">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l31.209"></a><span id="l31.209"> </span>
<a href="#l31.210"></a><span id="l31.210">   nsCOMPtr&lt;nsIStreamConverterService&gt; streamConverterService =</span>
<a href="#l31.211"></a><span id="l31.211" class="difflineminus">-           do_GetService(&quot;@mozilla.org/streamConverters;1&quot;, &amp;rv);</span>
<a href="#l31.212"></a><span id="l31.212" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l31.213"></a><span id="l31.213" class="difflineplus">+      do_GetService(&quot;@mozilla.org/streamConverters;1&quot;, &amp;rv);</span>
<a href="#l31.214"></a><span id="l31.214" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l31.215"></a><span id="l31.215"> </span>
<a href="#l31.216"></a><span id="l31.216">   nsCOMPtr&lt;nsIStreamListener&gt; convertedListener;</span>
<a href="#l31.217"></a><span id="l31.217" class="difflineminus">-  rv = streamConverterService-&gt;AsyncConvertData(&quot;message/rfc822&quot;,</span>
<a href="#l31.218"></a><span id="l31.218" class="difflineminus">-                                                &quot;application/vnd.mozilla.xul+xml&quot;,</span>
<a href="#l31.219"></a><span id="l31.219" class="difflineminus">-                                                mStreamListener,</span>
<a href="#l31.220"></a><span id="l31.220" class="difflineminus">-                                                quoteSupport,</span>
<a href="#l31.221"></a><span id="l31.221" class="difflineminus">-                                                getter_AddRefs(convertedListener));</span>
<a href="#l31.222"></a><span id="l31.222" class="difflineplus">+  rv = streamConverterService-&gt;AsyncConvertData(</span>
<a href="#l31.223"></a><span id="l31.223" class="difflineplus">+      &quot;message/rfc822&quot;, &quot;application/vnd.mozilla.xul+xml&quot;, mStreamListener,</span>
<a href="#l31.224"></a><span id="l31.224" class="difflineplus">+      quoteSupport, getter_AddRefs(convertedListener));</span>
<a href="#l31.225"></a><span id="l31.225">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l31.226"></a><span id="l31.226"> </span>
<a href="#l31.227"></a><span id="l31.227" class="difflineminus">-  //  now try to open the channel passing in our display consumer as the listener</span>
<a href="#l31.228"></a><span id="l31.228" class="difflineplus">+  //  now try to open the channel passing in our display consumer as the</span>
<a href="#l31.229"></a><span id="l31.229" class="difflineplus">+  //  listener</span>
<a href="#l31.230"></a><span id="l31.230">   rv = mQuoteChannel-&gt;AsyncOpen(convertedListener);</span>
<a href="#l31.231"></a><span id="l31.231">   return rv;</span>
<a href="#l31.232"></a><span id="l31.232"> }</span>
<a href="#l31.233"></a><span id="l31.233"> </span>
<a href="#l31.234"></a><span id="l31.234"> NS_IMETHODIMP</span>
<a href="#l31.235"></a><span id="l31.235" class="difflineminus">-nsMsgQuote::GetQuoteListener(nsIMimeStreamConverterListener** aQuoteListener)</span>
<a href="#l31.236"></a><span id="l31.236" class="difflineminus">-{</span>
<a href="#l31.237"></a><span id="l31.237" class="difflineminus">-    if (!aQuoteListener || !mQuoteListener)</span>
<a href="#l31.238"></a><span id="l31.238" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l31.239"></a><span id="l31.239" class="difflineminus">-    NS_ADDREF(*aQuoteListener = mQuoteListener);</span>
<a href="#l31.240"></a><span id="l31.240" class="difflineminus">-    return NS_OK;</span>
<a href="#l31.241"></a><span id="l31.241" class="difflineplus">+nsMsgQuote::GetQuoteListener(nsIMimeStreamConverterListener **aQuoteListener) {</span>
<a href="#l31.242"></a><span id="l31.242" class="difflineplus">+  if (!aQuoteListener || !mQuoteListener) return NS_ERROR_NULL_POINTER;</span>
<a href="#l31.243"></a><span id="l31.243" class="difflineplus">+  NS_ADDREF(*aQuoteListener = mQuoteListener);</span>
<a href="#l31.244"></a><span id="l31.244" class="difflineplus">+  return NS_OK;</span>
<a href="#l31.245"></a><span id="l31.245"> }</span>
<a href="#l31.246"></a><span id="l31.246"> </span>
<a href="#l31.247"></a><span id="l31.247"> NS_IMETHODIMP</span>
<a href="#l31.248"></a><span id="l31.248" class="difflineminus">-nsMsgQuote::GetQuoteChannel(nsIChannel** aQuoteChannel)</span>
<a href="#l31.249"></a><span id="l31.249" class="difflineminus">-{</span>
<a href="#l31.250"></a><span id="l31.250" class="difflineminus">-    if (!aQuoteChannel || !mQuoteChannel)</span>
<a href="#l31.251"></a><span id="l31.251" class="difflineminus">-        return NS_ERROR_NULL_POINTER;</span>
<a href="#l31.252"></a><span id="l31.252" class="difflineminus">-    NS_ADDREF(*aQuoteChannel = mQuoteChannel);</span>
<a href="#l31.253"></a><span id="l31.253" class="difflineminus">-    return NS_OK;</span>
<a href="#l31.254"></a><span id="l31.254" class="difflineplus">+nsMsgQuote::GetQuoteChannel(nsIChannel **aQuoteChannel) {</span>
<a href="#l31.255"></a><span id="l31.255" class="difflineplus">+  if (!aQuoteChannel || !mQuoteChannel) return NS_ERROR_NULL_POINTER;</span>
<a href="#l31.256"></a><span id="l31.256" class="difflineplus">+  NS_ADDREF(*aQuoteChannel = mQuoteChannel);</span>
<a href="#l31.257"></a><span id="l31.257" class="difflineplus">+  return NS_OK;</span>
<a href="#l31.258"></a><span id="l31.258"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgQuote.h</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgQuote.h</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -10,40 +10,39 @@</span>
<a href="#l32.4"></a><span id="l32.4"> #include &quot;nsIStreamListener.h&quot;</span>
<a href="#l32.5"></a><span id="l32.5"> #include &quot;nsIMimeStreamConverter.h&quot;</span>
<a href="#l32.6"></a><span id="l32.6"> #include &quot;nsIChannel.h&quot;</span>
<a href="#l32.7"></a><span id="l32.7"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l32.8"></a><span id="l32.8"> #include &quot;nsWeakReference.h&quot;</span>
<a href="#l32.9"></a><span id="l32.9"> </span>
<a href="#l32.10"></a><span id="l32.10"> class nsMsgQuote;</span>
<a href="#l32.11"></a><span id="l32.11"> </span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-class nsMsgQuoteListener: public nsIMsgQuoteListener</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineminus">-{</span>
<a href="#l32.14"></a><span id="l32.14" class="difflineminus">-public:</span>
<a href="#l32.15"></a><span id="l32.15" class="difflineplus">+class nsMsgQuoteListener : public nsIMsgQuoteListener {</span>
<a href="#l32.16"></a><span id="l32.16" class="difflineplus">+ public:</span>
<a href="#l32.17"></a><span id="l32.17">   nsMsgQuoteListener();</span>
<a href="#l32.18"></a><span id="l32.18"> </span>
<a href="#l32.19"></a><span id="l32.19">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l32.20"></a><span id="l32.20"> </span>
<a href="#l32.21"></a><span id="l32.21">   // nsIMimeStreamConverterListener support</span>
<a href="#l32.22"></a><span id="l32.22">   NS_DECL_NSIMIMESTREAMCONVERTERLISTENER</span>
<a href="#l32.23"></a><span id="l32.23">   NS_DECL_NSIMSGQUOTELISTENER</span>
<a href="#l32.24"></a><span id="l32.24"> </span>
<a href="#l32.25"></a><span id="l32.25" class="difflineminus">-private:</span>
<a href="#l32.26"></a><span id="l32.26" class="difflineplus">+ private:</span>
<a href="#l32.27"></a><span id="l32.27">   virtual ~nsMsgQuoteListener();</span>
<a href="#l32.28"></a><span id="l32.28">   nsWeakPtr mMsgQuote;</span>
<a href="#l32.29"></a><span id="l32.29"> };</span>
<a href="#l32.30"></a><span id="l32.30"> </span>
<a href="#l32.31"></a><span id="l32.31" class="difflineminus">-class nsMsgQuote: public nsIMsgQuote, public nsSupportsWeakReference {</span>
<a href="#l32.32"></a><span id="l32.32" class="difflineminus">-public:</span>
<a href="#l32.33"></a><span id="l32.33" class="difflineplus">+class nsMsgQuote : public nsIMsgQuote, public nsSupportsWeakReference {</span>
<a href="#l32.34"></a><span id="l32.34" class="difflineplus">+ public:</span>
<a href="#l32.35"></a><span id="l32.35">   nsMsgQuote();</span>
<a href="#l32.36"></a><span id="l32.36"> </span>
<a href="#l32.37"></a><span id="l32.37">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l32.38"></a><span id="l32.38">   NS_DECL_NSIMSGQUOTE</span>
<a href="#l32.39"></a><span id="l32.39"> </span>
<a href="#l32.40"></a><span id="l32.40" class="difflineminus">-private:</span>
<a href="#l32.41"></a><span id="l32.41" class="difflineplus">+ private:</span>
<a href="#l32.42"></a><span id="l32.42">   virtual ~nsMsgQuote();</span>
<a href="#l32.43"></a><span id="l32.43">   //</span>
<a href="#l32.44"></a><span id="l32.44">   // Implementation data...</span>
<a href="#l32.45"></a><span id="l32.45">   //</span>
<a href="#l32.46"></a><span id="l32.46">   nsCOMPtr&lt;nsIMsgQuotingOutputStreamListener&gt; mStreamListener;</span>
<a href="#l32.47"></a><span id="l32.47">   bool mQuoteHeaders;</span>
<a href="#l32.48"></a><span id="l32.48">   nsCOMPtr&lt;nsIMsgQuoteListener&gt; mQuoteListener;</span>
<a href="#l32.49"></a><span id="l32.49">   nsCOMPtr&lt;nsIChannel&gt; mQuoteChannel;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -41,17 +41,17 @@</span>
<a href="#l33.4"></a><span id="l33.4"> #include &quot;nsTextFormatter.h&quot;</span>
<a href="#l33.5"></a><span id="l33.5"> #include &quot;nsIPrompt.h&quot;</span>
<a href="#l33.6"></a><span id="l33.6"> #include &quot;nsMailHeaders.h&quot;</span>
<a href="#l33.7"></a><span id="l33.7"> #include &quot;nsIDocShell.h&quot;</span>
<a href="#l33.8"></a><span id="l33.8"> #include &quot;nsMimeTypes.h&quot;</span>
<a href="#l33.9"></a><span id="l33.9"> #include &quot;nsISmtpUrl.h&quot;</span>
<a href="#l33.10"></a><span id="l33.10"> #include &quot;nsIInterfaceRequestor.h&quot;</span>
<a href="#l33.11"></a><span id="l33.11"> #include &quot;nsIInterfaceRequestorUtils.h&quot;</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-#include &quot;nsIDocumentEncoder.h&quot;    // for editor output flags</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+#include &quot;nsIDocumentEncoder.h&quot;  // for editor output flags</span>
<a href="#l33.14"></a><span id="l33.14"> #include &quot;nsILoadGroup.h&quot;</span>
<a href="#l33.15"></a><span id="l33.15"> #include &quot;nsMsgSendReport.h&quot;</span>
<a href="#l33.16"></a><span id="l33.16"> #include &quot;nsNetCID.h&quot;</span>
<a href="#l33.17"></a><span id="l33.17"> #include &quot;nsError.h&quot;</span>
<a href="#l33.18"></a><span id="l33.18"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l33.19"></a><span id="l33.19"> #include &quot;nsIMsgMdnGenerator.h&quot;</span>
<a href="#l33.20"></a><span id="l33.20"> #include &quot;nsISmtpServer.h&quot;</span>
<a href="#l33.21"></a><span id="l33.21"> #include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l33.22"></a><span id="l33.22" class="difflineat">@@ -88,186 +88,167 @@ using namespace mozilla;</span>
<a href="#l33.23"></a><span id="l33.23"> using namespace mozilla::dom;</span>
<a href="#l33.24"></a><span id="l33.24"> using namespace mozilla::mailnews;</span>
<a href="#l33.25"></a><span id="l33.25"> </span>
<a href="#l33.26"></a><span id="l33.26"> extern LazyLogModule FILTERLOGMODULE;</span>
<a href="#l33.27"></a><span id="l33.27"> </span>
<a href="#l33.28"></a><span id="l33.28"> #define PREF_MAIL_SEND_STRUCT &quot;mail.send_struct&quot;</span>
<a href="#l33.29"></a><span id="l33.29"> #define PREF_MAIL_STRICTLY_MIME &quot;mail.strictly_mime&quot;</span>
<a href="#l33.30"></a><span id="l33.30"> #define PREF_MAIL_MESSAGE_WARNING_SIZE &quot;mailnews.message_warning_size&quot;</span>
<a href="#l33.31"></a><span id="l33.31" class="difflineminus">-#define PREF_MAIL_COLLECT_EMAIL_ADDRESS_OUTGOING &quot;mail.collect_email_address_outgoing&quot;</span>
<a href="#l33.32"></a><span id="l33.32" class="difflineplus">+#define PREF_MAIL_COLLECT_EMAIL_ADDRESS_OUTGOING \</span>
<a href="#l33.33"></a><span id="l33.33" class="difflineplus">+  &quot;mail.collect_email_address_outgoing&quot;</span>
<a href="#l33.34"></a><span id="l33.34"> </span>
<a href="#l33.35"></a><span id="l33.35"> #define ATTR_MOZ_DO_NOT_SEND &quot;moz-do-not-send&quot;</span>
<a href="#l33.36"></a><span id="l33.36"> </span>
<a href="#l33.37"></a><span id="l33.37" class="difflineminus">-enum  { kDefaultMode = (PR_WRONLY | PR_CREATE_FILE | PR_TRUNCATE) };</span>
<a href="#l33.38"></a><span id="l33.38" class="difflineplus">+enum { kDefaultMode = (PR_WRONLY | PR_CREATE_FILE | PR_TRUNCATE) };</span>
<a href="#l33.39"></a><span id="l33.39"> </span>
<a href="#l33.40"></a><span id="l33.40"> static bool mime_use_quoted_printable_p = false;</span>
<a href="#l33.41"></a><span id="l33.41"> </span>
<a href="#l33.42"></a><span id="l33.42"> //</span>
<a href="#l33.43"></a><span id="l33.43"> // Ugh, we need to do this currently to access this boolean.</span>
<a href="#l33.44"></a><span id="l33.44"> //</span>
<a href="#l33.45"></a><span id="l33.45" class="difflineminus">-bool</span>
<a href="#l33.46"></a><span id="l33.46" class="difflineminus">-UseQuotedPrintable(void)</span>
<a href="#l33.47"></a><span id="l33.47" class="difflineminus">-{</span>
<a href="#l33.48"></a><span id="l33.48" class="difflineminus">-  return mime_use_quoted_printable_p;</span>
<a href="#l33.49"></a><span id="l33.49" class="difflineminus">-}</span>
<a href="#l33.50"></a><span id="l33.50" class="difflineplus">+bool UseQuotedPrintable(void) { return mime_use_quoted_printable_p; }</span>
<a href="#l33.51"></a><span id="l33.51"> </span>
<a href="#l33.52"></a><span id="l33.52"> /* This function will parse a list of email addresses and groups and just</span>
<a href="#l33.53"></a><span id="l33.53">  * return a list of email addresses (recipient)</span>
<a href="#l33.54"></a><span id="l33.54">  *</span>
<a href="#l33.55"></a><span id="l33.55">  * The input could be:</span>
<a href="#l33.56"></a><span id="l33.56">  *    [recipient | group] *[,recipient | group]</span>
<a href="#l33.57"></a><span id="l33.57">  *</span>
<a href="#l33.58"></a><span id="l33.58">  * The group syntax is:</span>
<a href="#l33.59"></a><span id="l33.59">  *    group-name:[recipient *[,recipient]];</span>
<a href="#l33.60"></a><span id="l33.60">  *</span>
<a href="#l33.61"></a><span id="l33.61">  * the output will be:</span>
<a href="#l33.62"></a><span id="l33.62">  *    recipient *[, recipient]</span>
<a href="#l33.63"></a><span id="l33.63">  *</span>
<a href="#l33.64"></a><span id="l33.64">  * As the result will always be equal or smaller than the input string,</span>
<a href="#l33.65"></a><span id="l33.65">  * the extraction will be made in place. Don't need to create a new buffer.</span>
<a href="#l33.66"></a><span id="l33.66">  */</span>
<a href="#l33.67"></a><span id="l33.67" class="difflineminus">-static nsresult StripOutGroupNames(char * addresses)</span>
<a href="#l33.68"></a><span id="l33.68" class="difflineminus">-{</span>
<a href="#l33.69"></a><span id="l33.69" class="difflineplus">+static nsresult StripOutGroupNames(char *addresses) {</span>
<a href="#l33.70"></a><span id="l33.70">   char aChar;</span>
<a href="#l33.71"></a><span id="l33.71" class="difflineminus">-  char * readPtr = addresses;           // current read position</span>
<a href="#l33.72"></a><span id="l33.72" class="difflineminus">-  char * writePtr = addresses;          // current write position</span>
<a href="#l33.73"></a><span id="l33.73" class="difflineminus">-  char * previousSeparator = addresses; // remember last time we wrote a recipient separator</span>
<a href="#l33.74"></a><span id="l33.74" class="difflineminus">-  char * endPtr = addresses + PL_strlen(addresses);</span>
<a href="#l33.75"></a><span id="l33.75" class="difflineplus">+  char *readPtr = addresses;   // current read position</span>
<a href="#l33.76"></a><span id="l33.76" class="difflineplus">+  char *writePtr = addresses;  // current write position</span>
<a href="#l33.77"></a><span id="l33.77" class="difflineplus">+  char *previousSeparator =</span>
<a href="#l33.78"></a><span id="l33.78" class="difflineplus">+      addresses;  // remember last time we wrote a recipient separator</span>
<a href="#l33.79"></a><span id="l33.79" class="difflineplus">+  char *endPtr = addresses + PL_strlen(addresses);</span>
<a href="#l33.80"></a><span id="l33.80"> </span>
<a href="#l33.81"></a><span id="l33.81">   bool quoted = false;   // indicate if we are between double quote</span>
<a href="#l33.82"></a><span id="l33.82" class="difflineminus">-  bool group = false;   // indicate if we found a group prefix</span>
<a href="#l33.83"></a><span id="l33.83" class="difflineminus">-  bool atFound = false;  // indicate if we found an @ in the current recipient. group name should not have an @</span>
<a href="#l33.84"></a><span id="l33.84" class="difflineminus">-</span>
<a href="#l33.85"></a><span id="l33.85" class="difflineminus">-  while (readPtr &lt; endPtr)</span>
<a href="#l33.86"></a><span id="l33.86" class="difflineminus">-  {</span>
<a href="#l33.87"></a><span id="l33.87" class="difflineplus">+  bool group = false;    // indicate if we found a group prefix</span>
<a href="#l33.88"></a><span id="l33.88" class="difflineplus">+  bool atFound = false;  // indicate if we found an @ in the current recipient.</span>
<a href="#l33.89"></a><span id="l33.89" class="difflineplus">+                         // group name should not have an @</span>
<a href="#l33.90"></a><span id="l33.90" class="difflineplus">+</span>
<a href="#l33.91"></a><span id="l33.91" class="difflineplus">+  while (readPtr &lt; endPtr) {</span>
<a href="#l33.92"></a><span id="l33.92">     aChar = *readPtr;</span>
<a href="#l33.93"></a><span id="l33.93" class="difflineminus">-    readPtr ++;</span>
<a href="#l33.94"></a><span id="l33.94" class="difflineminus">-    switch(aChar)</span>
<a href="#l33.95"></a><span id="l33.95" class="difflineminus">-    {</span>
<a href="#l33.96"></a><span id="l33.96" class="difflineplus">+    readPtr++;</span>
<a href="#l33.97"></a><span id="l33.97" class="difflineplus">+    switch (aChar) {</span>
<a href="#l33.98"></a><span id="l33.98">       case '\\':</span>
<a href="#l33.99"></a><span id="l33.99" class="difflineminus">-        if (*readPtr == '&quot;') //ignore escaped quote</span>
<a href="#l33.100"></a><span id="l33.100" class="difflineminus">-          readPtr ++;</span>
<a href="#l33.101"></a><span id="l33.101" class="difflineplus">+        if (*readPtr == '&quot;')  // ignore escaped quote</span>
<a href="#l33.102"></a><span id="l33.102" class="difflineplus">+          readPtr++;</span>
<a href="#l33.103"></a><span id="l33.103">         continue;</span>
<a href="#l33.104"></a><span id="l33.104"> </span>
<a href="#l33.105"></a><span id="l33.105">       case '&quot;':</span>
<a href="#l33.106"></a><span id="l33.106">         quoted = !quoted;</span>
<a href="#l33.107"></a><span id="l33.107">         break;</span>
<a href="#l33.108"></a><span id="l33.108"> </span>
<a href="#l33.109"></a><span id="l33.109">       case '@':</span>
<a href="#l33.110"></a><span id="l33.110" class="difflineminus">-        if (!quoted)</span>
<a href="#l33.111"></a><span id="l33.111" class="difflineminus">-          atFound = true;</span>
<a href="#l33.112"></a><span id="l33.112" class="difflineplus">+        if (!quoted) atFound = true;</span>
<a href="#l33.113"></a><span id="l33.113">         break;</span>
<a href="#l33.114"></a><span id="l33.114"> </span>
<a href="#l33.115"></a><span id="l33.115">       case ':':</span>
<a href="#l33.116"></a><span id="l33.116" class="difflineminus">-        if (!quoted &amp;&amp; !atFound)</span>
<a href="#l33.117"></a><span id="l33.117" class="difflineminus">-        {</span>
<a href="#l33.118"></a><span id="l33.118" class="difflineplus">+        if (!quoted &amp;&amp; !atFound) {</span>
<a href="#l33.119"></a><span id="l33.119">           // ok, we found a group name</span>
<a href="#l33.120"></a><span id="l33.120">           // let's backup the write cursor to remove the group name</span>
<a href="#l33.121"></a><span id="l33.121">           writePtr = previousSeparator;</span>
<a href="#l33.122"></a><span id="l33.122">           group = true;</span>
<a href="#l33.123"></a><span id="l33.123">           continue;</span>
<a href="#l33.124"></a><span id="l33.124">         }</span>
<a href="#l33.125"></a><span id="l33.125">         break;</span>
<a href="#l33.126"></a><span id="l33.126"> </span>
<a href="#l33.127"></a><span id="l33.127">       case ';':</span>
<a href="#l33.128"></a><span id="l33.128">         if (quoted || !group)</span>
<a href="#l33.129"></a><span id="l33.129">           break;</span>
<a href="#l33.130"></a><span id="l33.130">         else</span>
<a href="#l33.131"></a><span id="l33.131">           group = false;</span>
<a href="#l33.132"></a><span id="l33.132" class="difflineminus">-          //end of the group, act like a recipient separator now...</span>
<a href="#l33.133"></a><span id="l33.133" class="difflineplus">+        // end of the group, act like a recipient separator now...</span>
<a href="#l33.134"></a><span id="l33.134">         /* NO BREAK */</span>
<a href="#l33.135"></a><span id="l33.135">         MOZ_FALLTHROUGH;</span>
<a href="#l33.136"></a><span id="l33.136">       case ',':</span>
<a href="#l33.137"></a><span id="l33.137" class="difflineminus">-        if (!quoted)</span>
<a href="#l33.138"></a><span id="l33.138" class="difflineminus">-        {</span>
<a href="#l33.139"></a><span id="l33.139" class="difflineplus">+        if (!quoted) {</span>
<a href="#l33.140"></a><span id="l33.140">           atFound = false;</span>
<a href="#l33.141"></a><span id="l33.141" class="difflineminus">-          //let check if we already have a comma separator in the output string</span>
<a href="#l33.142"></a><span id="l33.142" class="difflineminus">-          if (writePtr &gt; addresses &amp;&amp; *(writePtr - 1) == ',')</span>
<a href="#l33.143"></a><span id="l33.143" class="difflineminus">-            writePtr --;</span>
<a href="#l33.144"></a><span id="l33.144" class="difflineplus">+          // let check if we already have a comma separator in the output string</span>
<a href="#l33.145"></a><span id="l33.145" class="difflineplus">+          if (writePtr &gt; addresses &amp;&amp; *(writePtr - 1) == ',') writePtr--;</span>
<a href="#l33.146"></a><span id="l33.146">           *writePtr = ',';</span>
<a href="#l33.147"></a><span id="l33.147">           previousSeparator = writePtr;</span>
<a href="#l33.148"></a><span id="l33.148" class="difflineminus">-          writePtr ++;</span>
<a href="#l33.149"></a><span id="l33.149" class="difflineplus">+          writePtr++;</span>
<a href="#l33.150"></a><span id="l33.150">           continue;</span>
<a href="#l33.151"></a><span id="l33.151">         }</span>
<a href="#l33.152"></a><span id="l33.152">         break;</span>
<a href="#l33.153"></a><span id="l33.153">     }</span>
<a href="#l33.154"></a><span id="l33.154">     *writePtr = aChar;</span>
<a href="#l33.155"></a><span id="l33.155" class="difflineminus">-    writePtr ++;</span>
<a href="#l33.156"></a><span id="l33.156" class="difflineplus">+    writePtr++;</span>
<a href="#l33.157"></a><span id="l33.157">   }</span>
<a href="#l33.158"></a><span id="l33.158"> </span>
<a href="#l33.159"></a><span id="l33.159" class="difflineminus">-  if (writePtr &gt; addresses &amp;&amp; *(writePtr - 1) == ',')</span>
<a href="#l33.160"></a><span id="l33.160" class="difflineminus">-    writePtr --;</span>
<a href="#l33.161"></a><span id="l33.161" class="difflineplus">+  if (writePtr &gt; addresses &amp;&amp; *(writePtr - 1) == ',') writePtr--;</span>
<a href="#l33.162"></a><span id="l33.162">   *writePtr = '\0';</span>
<a href="#l33.163"></a><span id="l33.163"> </span>
<a href="#l33.164"></a><span id="l33.164">   return NS_OK;</span>
<a href="#l33.165"></a><span id="l33.165"> }</span>
<a href="#l33.166"></a><span id="l33.166"> </span>
<a href="#l33.167"></a><span id="l33.167" class="difflineminus">-</span>
<a href="#l33.168"></a><span id="l33.168" class="difflineminus">-// This private class just provides us an external URL listener, with callback functionality.</span>
<a href="#l33.169"></a><span id="l33.169" class="difflineminus">-</span>
<a href="#l33.170"></a><span id="l33.170" class="difflineminus">-class MsgDeliveryListener : public nsIUrlListener</span>
<a href="#l33.171"></a><span id="l33.171" class="difflineminus">-{</span>
<a href="#l33.172"></a><span id="l33.172" class="difflineminus">-public:</span>
<a href="#l33.173"></a><span id="l33.173" class="difflineplus">+// This private class just provides us an external URL listener, with callback</span>
<a href="#l33.174"></a><span id="l33.174" class="difflineplus">+// functionality.</span>
<a href="#l33.175"></a><span id="l33.175" class="difflineplus">+</span>
<a href="#l33.176"></a><span id="l33.176" class="difflineplus">+class MsgDeliveryListener : public nsIUrlListener {</span>
<a href="#l33.177"></a><span id="l33.177" class="difflineplus">+ public:</span>
<a href="#l33.178"></a><span id="l33.178">   MsgDeliveryListener(nsIMsgSend *aMsgSend, bool inIsNewsDelivery);</span>
<a href="#l33.179"></a><span id="l33.179"> </span>
<a href="#l33.180"></a><span id="l33.180">   NS_DECL_ISUPPORTS</span>
<a href="#l33.181"></a><span id="l33.181">   NS_DECL_NSIURLLISTENER</span>
<a href="#l33.182"></a><span id="l33.182"> </span>
<a href="#l33.183"></a><span id="l33.183" class="difflineminus">-private:</span>
<a href="#l33.184"></a><span id="l33.184" class="difflineplus">+ private:</span>
<a href="#l33.185"></a><span id="l33.185">   virtual ~MsgDeliveryListener();</span>
<a href="#l33.186"></a><span id="l33.186">   nsCOMPtr&lt;nsIMsgSend&gt; mMsgSend;</span>
<a href="#l33.187"></a><span id="l33.187" class="difflineminus">-  bool                 mIsNewsDelivery;</span>
<a href="#l33.188"></a><span id="l33.188" class="difflineplus">+  bool mIsNewsDelivery;</span>
<a href="#l33.189"></a><span id="l33.189"> };</span>
<a href="#l33.190"></a><span id="l33.190"> </span>
<a href="#l33.191"></a><span id="l33.191"> NS_IMPL_ISUPPORTS(MsgDeliveryListener, nsIUrlListener)</span>
<a href="#l33.192"></a><span id="l33.192"> </span>
<a href="#l33.193"></a><span id="l33.193" class="difflineminus">-MsgDeliveryListener::MsgDeliveryListener(nsIMsgSend *aMsgSend, bool inIsNewsDelivery)</span>
<a href="#l33.194"></a><span id="l33.194" class="difflineminus">-{</span>
<a href="#l33.195"></a><span id="l33.195" class="difflineplus">+MsgDeliveryListener::MsgDeliveryListener(nsIMsgSend *aMsgSend,</span>
<a href="#l33.196"></a><span id="l33.196" class="difflineplus">+                                         bool inIsNewsDelivery) {</span>
<a href="#l33.197"></a><span id="l33.197">   mMsgSend = aMsgSend;</span>
<a href="#l33.198"></a><span id="l33.198">   mIsNewsDelivery = inIsNewsDelivery;</span>
<a href="#l33.199"></a><span id="l33.199"> }</span>
<a href="#l33.200"></a><span id="l33.200"> </span>
<a href="#l33.201"></a><span id="l33.201" class="difflineminus">-MsgDeliveryListener::~MsgDeliveryListener()</span>
<a href="#l33.202"></a><span id="l33.202" class="difflineminus">-{</span>
<a href="#l33.203"></a><span id="l33.203" class="difflineminus">-}</span>
<a href="#l33.204"></a><span id="l33.204" class="difflineminus">-</span>
<a href="#l33.205"></a><span id="l33.205" class="difflineminus">-NS_IMETHODIMP MsgDeliveryListener::OnStartRunningUrl(nsIURI *url)</span>
<a href="#l33.206"></a><span id="l33.206" class="difflineminus">-{</span>
<a href="#l33.207"></a><span id="l33.207" class="difflineminus">-  if (mMsgSend)</span>
<a href="#l33.208"></a><span id="l33.208" class="difflineminus">-    mMsgSend-&gt;NotifyListenerOnStartSending(nullptr, 0);</span>
<a href="#l33.209"></a><span id="l33.209" class="difflineplus">+MsgDeliveryListener::~MsgDeliveryListener() {}</span>
<a href="#l33.210"></a><span id="l33.210" class="difflineplus">+</span>
<a href="#l33.211"></a><span id="l33.211" class="difflineplus">+NS_IMETHODIMP MsgDeliveryListener::OnStartRunningUrl(nsIURI *url) {</span>
<a href="#l33.212"></a><span id="l33.212" class="difflineplus">+  if (mMsgSend) mMsgSend-&gt;NotifyListenerOnStartSending(nullptr, 0);</span>
<a href="#l33.213"></a><span id="l33.213"> </span>
<a href="#l33.214"></a><span id="l33.214">   return NS_OK;</span>
<a href="#l33.215"></a><span id="l33.215"> }</span>
<a href="#l33.216"></a><span id="l33.216"> </span>
<a href="#l33.217"></a><span id="l33.217" class="difflineminus">-NS_IMETHODIMP MsgDeliveryListener::OnStopRunningUrl(nsIURI *url, nsresult aExitCode)</span>
<a href="#l33.218"></a><span id="l33.218" class="difflineminus">-{</span>
<a href="#l33.219"></a><span id="l33.219" class="difflineminus">-  if (url)</span>
<a href="#l33.220"></a><span id="l33.220" class="difflineminus">-  {</span>
<a href="#l33.221"></a><span id="l33.221" class="difflineplus">+NS_IMETHODIMP MsgDeliveryListener::OnStopRunningUrl(nsIURI *url,</span>
<a href="#l33.222"></a><span id="l33.222" class="difflineplus">+                                                    nsresult aExitCode) {</span>
<a href="#l33.223"></a><span id="l33.223" class="difflineplus">+  if (url) {</span>
<a href="#l33.224"></a><span id="l33.224">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailUrl = do_QueryInterface(url);</span>
<a href="#l33.225"></a><span id="l33.225" class="difflineminus">-    if (mailUrl)</span>
<a href="#l33.226"></a><span id="l33.226" class="difflineminus">-      mailUrl-&gt;UnRegisterListener(this);</span>
<a href="#l33.227"></a><span id="l33.227" class="difflineplus">+    if (mailUrl) mailUrl-&gt;UnRegisterListener(this);</span>
<a href="#l33.228"></a><span id="l33.228">   }</span>
<a href="#l33.229"></a><span id="l33.229"> </span>
<a href="#l33.230"></a><span id="l33.230">   // Let mMsgSend sort out the OnStopSending notification - it knows more about</span>
<a href="#l33.231"></a><span id="l33.231">   // the messages than we do.</span>
<a href="#l33.232"></a><span id="l33.232" class="difflineminus">-  if (mMsgSend)</span>
<a href="#l33.233"></a><span id="l33.233" class="difflineminus">-    mMsgSend-&gt;SendDeliveryCallback(url, mIsNewsDelivery, aExitCode);</span>
<a href="#l33.234"></a><span id="l33.234" class="difflineplus">+  if (mMsgSend) mMsgSend-&gt;SendDeliveryCallback(url, mIsNewsDelivery, aExitCode);</span>
<a href="#l33.235"></a><span id="l33.235"> </span>
<a href="#l33.236"></a><span id="l33.236">   return NS_OK;</span>
<a href="#l33.237"></a><span id="l33.237"> }</span>
<a href="#l33.238"></a><span id="l33.238"> </span>
<a href="#l33.239"></a><span id="l33.239" class="difflineminus">-</span>
<a href="#l33.240"></a><span id="l33.240" class="difflineminus">-/* the following macro actually implement addref, release and query interface for our component. */</span>
<a href="#l33.241"></a><span id="l33.241" class="difflineplus">+/* the following macro actually implement addref, release and query interface</span>
<a href="#l33.242"></a><span id="l33.242" class="difflineplus">+ * for our component. */</span>
<a href="#l33.243"></a><span id="l33.243"> NS_IMPL_ISUPPORTS(nsMsgComposeAndSend, nsIMsgSend, nsIMsgOperationListener,</span>
<a href="#l33.244"></a><span id="l33.244">                   nsISupportsWeakReference)</span>
<a href="#l33.245"></a><span id="l33.245"> </span>
<a href="#l33.246"></a><span id="l33.246" class="difflineminus">-nsMsgComposeAndSend::nsMsgComposeAndSend() :</span>
<a href="#l33.247"></a><span id="l33.247" class="difflineminus">-    m_messageKey(nsMsgKey_None)</span>
<a href="#l33.248"></a><span id="l33.248" class="difflineminus">-{</span>
<a href="#l33.249"></a><span id="l33.249" class="difflineplus">+nsMsgComposeAndSend::nsMsgComposeAndSend() : m_messageKey(nsMsgKey_None) {</span>
<a href="#l33.250"></a><span id="l33.250">   mGUINotificationEnabled = true;</span>
<a href="#l33.251"></a><span id="l33.251">   mAbortInProcess = false;</span>
<a href="#l33.252"></a><span id="l33.252">   mMultipartRelatedAttachmentCount = -1;</span>
<a href="#l33.253"></a><span id="l33.253">   mSendMailAlso = false;</span>
<a href="#l33.254"></a><span id="l33.254"> </span>
<a href="#l33.255"></a><span id="l33.255">   m_dont_deliver_p = false;</span>
<a href="#l33.256"></a><span id="l33.256">   m_deliver_mode = nsMsgDeliverNow;</span>
<a href="#l33.257"></a><span id="l33.257"> </span>
<a href="#l33.258"></a><span id="l33.258" class="difflineat">@@ -293,509 +274,449 @@ nsMsgComposeAndSend::nsMsgComposeAndSend</span>
<a href="#l33.259"></a><span id="l33.259">   mRemoteAttachmentCount = 0;</span>
<a href="#l33.260"></a><span id="l33.260">   mCompFieldLocalAttachments = 0;</span>
<a href="#l33.261"></a><span id="l33.261">   mCompFieldRemoteAttachments = 0;</span>
<a href="#l33.262"></a><span id="l33.262">   mMessageWarningSize = 0;</span>
<a href="#l33.263"></a><span id="l33.263"> </span>
<a href="#l33.264"></a><span id="l33.264">   mSendReport = new nsMsgSendReport();</span>
<a href="#l33.265"></a><span id="l33.265"> }</span>
<a href="#l33.266"></a><span id="l33.266"> </span>
<a href="#l33.267"></a><span id="l33.267" class="difflineminus">-nsMsgComposeAndSend::~nsMsgComposeAndSend()</span>
<a href="#l33.268"></a><span id="l33.268" class="difflineminus">-{</span>
<a href="#l33.269"></a><span id="l33.269" class="difflineplus">+nsMsgComposeAndSend::~nsMsgComposeAndSend() {</span>
<a href="#l33.270"></a><span id="l33.270">   PR_Free(m_attachment1_type);</span>
<a href="#l33.271"></a><span id="l33.271">   PR_Free(m_attachment1_encoding);</span>
<a href="#l33.272"></a><span id="l33.272">   PR_Free(m_attachment1_body);</span>
<a href="#l33.273"></a><span id="l33.273">   PR_Free(mOriginalHTMLBody);</span>
<a href="#l33.274"></a><span id="l33.274"> </span>
<a href="#l33.275"></a><span id="l33.275" class="difflineminus">-  if (m_plaintext)</span>
<a href="#l33.276"></a><span id="l33.276" class="difflineminus">-  {</span>
<a href="#l33.277"></a><span id="l33.277" class="difflineminus">-    if (m_plaintext-&gt;mTmpFile)</span>
<a href="#l33.278"></a><span id="l33.278" class="difflineminus">-      m_plaintext-&gt;mTmpFile-&gt;Remove(false);</span>
<a href="#l33.279"></a><span id="l33.279" class="difflineplus">+  if (m_plaintext) {</span>
<a href="#l33.280"></a><span id="l33.280" class="difflineplus">+    if (m_plaintext-&gt;mTmpFile) m_plaintext-&gt;mTmpFile-&gt;Remove(false);</span>
<a href="#l33.281"></a><span id="l33.281"> </span>
<a href="#l33.282"></a><span id="l33.282">     m_plaintext = nullptr;</span>
<a href="#l33.283"></a><span id="l33.283">   }</span>
<a href="#l33.284"></a><span id="l33.284"> </span>
<a href="#l33.285"></a><span id="l33.285" class="difflineminus">-  if (mHTMLFile)</span>
<a href="#l33.286"></a><span id="l33.286" class="difflineminus">-    mHTMLFile-&gt;Remove(false);</span>
<a href="#l33.287"></a><span id="l33.287" class="difflineminus">-</span>
<a href="#l33.288"></a><span id="l33.288" class="difflineminus">-  if (mCopyFile)</span>
<a href="#l33.289"></a><span id="l33.289" class="difflineminus">-    mCopyFile-&gt;Remove(false);</span>
<a href="#l33.290"></a><span id="l33.290" class="difflineminus">-</span>
<a href="#l33.291"></a><span id="l33.291" class="difflineminus">-  if (mCopyFile2)</span>
<a href="#l33.292"></a><span id="l33.292" class="difflineminus">-    mCopyFile2-&gt;Remove(false);</span>
<a href="#l33.293"></a><span id="l33.293" class="difflineminus">-</span>
<a href="#l33.294"></a><span id="l33.294" class="difflineminus">-  if (mTempFile &amp;&amp; !mReturnFile)</span>
<a href="#l33.295"></a><span id="l33.295" class="difflineminus">-    mTempFile-&gt;Remove(false);</span>
<a href="#l33.296"></a><span id="l33.296" class="difflineplus">+  if (mHTMLFile) mHTMLFile-&gt;Remove(false);</span>
<a href="#l33.297"></a><span id="l33.297" class="difflineplus">+</span>
<a href="#l33.298"></a><span id="l33.298" class="difflineplus">+  if (mCopyFile) mCopyFile-&gt;Remove(false);</span>
<a href="#l33.299"></a><span id="l33.299" class="difflineplus">+</span>
<a href="#l33.300"></a><span id="l33.300" class="difflineplus">+  if (mCopyFile2) mCopyFile2-&gt;Remove(false);</span>
<a href="#l33.301"></a><span id="l33.301" class="difflineplus">+</span>
<a href="#l33.302"></a><span id="l33.302" class="difflineplus">+  if (mTempFile &amp;&amp; !mReturnFile) mTempFile-&gt;Remove(false);</span>
<a href="#l33.303"></a><span id="l33.303"> </span>
<a href="#l33.304"></a><span id="l33.304">   m_attachments.Clear();</span>
<a href="#l33.305"></a><span id="l33.305"> }</span>
<a href="#l33.306"></a><span id="l33.306"> </span>
<a href="#l33.307"></a><span id="l33.307" class="difflineminus">-NS_IMETHODIMP nsMsgComposeAndSend::GetDefaultPrompt(nsIPrompt ** aPrompt)</span>
<a href="#l33.308"></a><span id="l33.308" class="difflineminus">-{</span>
<a href="#l33.309"></a><span id="l33.309" class="difflineplus">+NS_IMETHODIMP nsMsgComposeAndSend::GetDefaultPrompt(nsIPrompt **aPrompt) {</span>
<a href="#l33.310"></a><span id="l33.310">   NS_ENSURE_ARG(aPrompt);</span>
<a href="#l33.311"></a><span id="l33.311">   *aPrompt = nullptr;</span>
<a href="#l33.312"></a><span id="l33.312"> </span>
<a href="#l33.313"></a><span id="l33.313">   nsresult rv = NS_OK;</span>
<a href="#l33.314"></a><span id="l33.314"> </span>
<a href="#l33.315"></a><span id="l33.315" class="difflineminus">-  if (mParentWindow)</span>
<a href="#l33.316"></a><span id="l33.316" class="difflineminus">-  {</span>
<a href="#l33.317"></a><span id="l33.317" class="difflineplus">+  if (mParentWindow) {</span>
<a href="#l33.318"></a><span id="l33.318">     rv = mParentWindow-&gt;GetPrompter(aPrompt);</span>
<a href="#l33.319"></a><span id="l33.319" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; *aPrompt)</span>
<a href="#l33.320"></a><span id="l33.320" class="difflineminus">-      return NS_OK;</span>
<a href="#l33.321"></a><span id="l33.321" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; *aPrompt) return NS_OK;</span>
<a href="#l33.322"></a><span id="l33.322">   }</span>
<a href="#l33.323"></a><span id="l33.323"> </span>
<a href="#l33.324"></a><span id="l33.324">   /* If we cannot find a prompter, try the mail3Pane window */</span>
<a href="#l33.325"></a><span id="l33.325">   nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l33.326"></a><span id="l33.326" class="difflineminus">-  nsCOMPtr &lt;nsIMsgMailSession&gt; mailSession (do_GetService(NS_MSGMAILSESSION_CONTRACTID));</span>
<a href="#l33.327"></a><span id="l33.327" class="difflineminus">-  if (mailSession)</span>
<a href="#l33.328"></a><span id="l33.328" class="difflineminus">-  {</span>
<a href="#l33.329"></a><span id="l33.329" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession(</span>
<a href="#l33.330"></a><span id="l33.330" class="difflineplus">+      do_GetService(NS_MSGMAILSESSION_CONTRACTID));</span>
<a href="#l33.331"></a><span id="l33.331" class="difflineplus">+  if (mailSession) {</span>
<a href="#l33.332"></a><span id="l33.332">     mailSession-&gt;GetTopmostMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l33.333"></a><span id="l33.333" class="difflineminus">-    if (msgWindow)</span>
<a href="#l33.334"></a><span id="l33.334" class="difflineminus">-      rv = msgWindow-&gt;GetPromptDialog(aPrompt);</span>
<a href="#l33.335"></a><span id="l33.335" class="difflineplus">+    if (msgWindow) rv = msgWindow-&gt;GetPromptDialog(aPrompt);</span>
<a href="#l33.336"></a><span id="l33.336">   }</span>
<a href="#l33.337"></a><span id="l33.337"> </span>
<a href="#l33.338"></a><span id="l33.338">   return rv;</span>
<a href="#l33.339"></a><span id="l33.339"> }</span>
<a href="#l33.340"></a><span id="l33.340"> </span>
<a href="#l33.341"></a><span id="l33.341" class="difflineminus">-nsresult nsMsgComposeAndSend::GetNotificationCallbacks(nsIInterfaceRequestor** aCallbacks)</span>
<a href="#l33.342"></a><span id="l33.342" class="difflineminus">-{</span>
<a href="#l33.343"></a><span id="l33.343" class="difflineminus">-// TODO: stop using mail3pane window!</span>
<a href="#l33.344"></a><span id="l33.344" class="difflineplus">+nsresult nsMsgComposeAndSend::GetNotificationCallbacks(</span>
<a href="#l33.345"></a><span id="l33.345" class="difflineplus">+    nsIInterfaceRequestor **aCallbacks) {</span>
<a href="#l33.346"></a><span id="l33.346" class="difflineplus">+  // TODO: stop using mail3pane window!</span>
<a href="#l33.347"></a><span id="l33.347">   nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l33.348"></a><span id="l33.348" class="difflineminus">-  nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession(do_GetService(NS_MSGMAILSESSION_CONTRACTID));</span>
<a href="#l33.349"></a><span id="l33.349" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession(</span>
<a href="#l33.350"></a><span id="l33.350" class="difflineplus">+      do_GetService(NS_MSGMAILSESSION_CONTRACTID));</span>
<a href="#l33.351"></a><span id="l33.351">   mailSession-&gt;GetTopmostMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l33.352"></a><span id="l33.352">   if (msgWindow) {</span>
<a href="#l33.353"></a><span id="l33.353">     nsCOMPtr&lt;nsIDocShell&gt; docShell;</span>
<a href="#l33.354"></a><span id="l33.354">     msgWindow-&gt;GetRootDocShell(getter_AddRefs(docShell));</span>
<a href="#l33.355"></a><span id="l33.355">     nsCOMPtr&lt;nsIInterfaceRequestor&gt; ir(do_QueryInterface(docShell));</span>
<a href="#l33.356"></a><span id="l33.356">     nsCOMPtr&lt;nsIInterfaceRequestor&gt; notificationCallbacks;</span>
<a href="#l33.357"></a><span id="l33.357">     msgWindow-&gt;GetNotificationCallbacks(getter_AddRefs(notificationCallbacks));</span>
<a href="#l33.358"></a><span id="l33.358">     if (notificationCallbacks) {</span>
<a href="#l33.359"></a><span id="l33.359">       nsCOMPtr&lt;nsIInterfaceRequestor&gt; aggregrateIR;</span>
<a href="#l33.360"></a><span id="l33.360" class="difflineminus">-      MsgNewInterfaceRequestorAggregation(notificationCallbacks, ir, getter_AddRefs(aggregrateIR));</span>
<a href="#l33.361"></a><span id="l33.361" class="difflineplus">+      MsgNewInterfaceRequestorAggregation(notificationCallbacks, ir,</span>
<a href="#l33.362"></a><span id="l33.362" class="difflineplus">+                                          getter_AddRefs(aggregrateIR));</span>
<a href="#l33.363"></a><span id="l33.363">       ir = aggregrateIR;</span>
<a href="#l33.364"></a><span id="l33.364">     }</span>
<a href="#l33.365"></a><span id="l33.365">     if (ir) {</span>
<a href="#l33.366"></a><span id="l33.366">       ir.forget(aCallbacks);</span>
<a href="#l33.367"></a><span id="l33.367">       return NS_OK;</span>
<a href="#l33.368"></a><span id="l33.368">     }</span>
<a href="#l33.369"></a><span id="l33.369">   }</span>
<a href="#l33.370"></a><span id="l33.370">   return NS_ERROR_FAILURE;</span>
<a href="#l33.371"></a><span id="l33.371"> }</span>
<a href="#l33.372"></a><span id="l33.372"> </span>
<a href="#l33.373"></a><span id="l33.373" class="difflineminus">-</span>
<a href="#l33.374"></a><span id="l33.374"> static char *mime_mailto_stream_read_buffer = 0;</span>
<a href="#l33.375"></a><span id="l33.375"> static char *mime_mailto_stream_write_buffer = 0;</span>
<a href="#l33.376"></a><span id="l33.376"> </span>
<a href="#l33.377"></a><span id="l33.377" class="difflineminus">-</span>
<a href="#l33.378"></a><span id="l33.378" class="difflineminus">-char * mime_get_stream_write_buffer(void)</span>
<a href="#l33.379"></a><span id="l33.379" class="difflineminus">-{</span>
<a href="#l33.380"></a><span id="l33.380" class="difflineplus">+char *mime_get_stream_write_buffer(void) {</span>
<a href="#l33.381"></a><span id="l33.381">   if (!mime_mailto_stream_write_buffer)</span>
<a href="#l33.382"></a><span id="l33.382" class="difflineminus">-    mime_mailto_stream_write_buffer = (char *) PR_Malloc(MIME_BUFFER_SIZE);</span>
<a href="#l33.383"></a><span id="l33.383" class="difflineplus">+    mime_mailto_stream_write_buffer = (char *)PR_Malloc(MIME_BUFFER_SIZE);</span>
<a href="#l33.384"></a><span id="l33.384">   return mime_mailto_stream_write_buffer;</span>
<a href="#l33.385"></a><span id="l33.385"> }</span>
<a href="#l33.386"></a><span id="l33.386"> </span>
<a href="#l33.387"></a><span id="l33.387" class="difflineminus">-static bool isEmpty(const char* aString)</span>
<a href="#l33.388"></a><span id="l33.388" class="difflineminus">-{</span>
<a href="#l33.389"></a><span id="l33.389" class="difflineminus">-  return (!aString) || (!*aString);</span>
<a href="#l33.390"></a><span id="l33.390" class="difflineminus">-}</span>
<a href="#l33.391"></a><span id="l33.391" class="difflineminus">-</span>
<a href="#l33.392"></a><span id="l33.392" class="difflineminus">-void nsMsgComposeAndSend::GenerateMessageId()</span>
<a href="#l33.393"></a><span id="l33.393" class="difflineminus">-{</span>
<a href="#l33.394"></a><span id="l33.394" class="difflineminus">-  if (isEmpty(mCompFields-&gt;GetMessageId()))</span>
<a href="#l33.395"></a><span id="l33.395" class="difflineminus">-  {</span>
<a href="#l33.396"></a><span id="l33.396" class="difflineminus">-    if (isEmpty(mCompFields-&gt;GetTo()) &amp;&amp;</span>
<a href="#l33.397"></a><span id="l33.397" class="difflineminus">-        isEmpty(mCompFields-&gt;GetCc()) &amp;&amp;</span>
<a href="#l33.398"></a><span id="l33.398" class="difflineplus">+static bool isEmpty(const char *aString) { return (!aString) || (!*aString); }</span>
<a href="#l33.399"></a><span id="l33.399" class="difflineplus">+</span>
<a href="#l33.400"></a><span id="l33.400" class="difflineplus">+void nsMsgComposeAndSend::GenerateMessageId() {</span>
<a href="#l33.401"></a><span id="l33.401" class="difflineplus">+  if (isEmpty(mCompFields-&gt;GetMessageId())) {</span>
<a href="#l33.402"></a><span id="l33.402" class="difflineplus">+    if (isEmpty(mCompFields-&gt;GetTo()) &amp;&amp; isEmpty(mCompFields-&gt;GetCc()) &amp;&amp;</span>
<a href="#l33.403"></a><span id="l33.403">         isEmpty(mCompFields-&gt;GetBcc()) &amp;&amp;</span>
<a href="#l33.404"></a><span id="l33.404" class="difflineminus">-        !isEmpty(mCompFields-&gt;GetNewsgroups()))</span>
<a href="#l33.405"></a><span id="l33.405" class="difflineminus">-    {</span>
<a href="#l33.406"></a><span id="l33.406" class="difflineplus">+        !isEmpty(mCompFields-&gt;GetNewsgroups())) {</span>
<a href="#l33.407"></a><span id="l33.407">       bool generateNewsMessageId = false;</span>
<a href="#l33.408"></a><span id="l33.408" class="difflineminus">-      mUserIdentity-&gt;GetBoolAttribute(&quot;generate_news_message_id&quot;, &amp;generateNewsMessageId);</span>
<a href="#l33.409"></a><span id="l33.409" class="difflineminus">-      if (!generateNewsMessageId)</span>
<a href="#l33.410"></a><span id="l33.410" class="difflineminus">-        return;</span>
<a href="#l33.411"></a><span id="l33.411" class="difflineplus">+      mUserIdentity-&gt;GetBoolAttribute(&quot;generate_news_message_id&quot;,</span>
<a href="#l33.412"></a><span id="l33.412" class="difflineplus">+                                      &amp;generateNewsMessageId);</span>
<a href="#l33.413"></a><span id="l33.413" class="difflineplus">+      if (!generateNewsMessageId) return;</span>
<a href="#l33.414"></a><span id="l33.414">     }</span>
<a href="#l33.415"></a><span id="l33.415"> </span>
<a href="#l33.416"></a><span id="l33.416" class="difflineminus">-    char* msgID = msg_generate_message_id(mUserIdentity);</span>
<a href="#l33.417"></a><span id="l33.417" class="difflineplus">+    char *msgID = msg_generate_message_id(mUserIdentity);</span>
<a href="#l33.418"></a><span id="l33.418">     mCompFields-&gt;SetMessageId(msgID);</span>
<a href="#l33.419"></a><span id="l33.419">     PR_Free(msgID);</span>
<a href="#l33.420"></a><span id="l33.420">   }</span>
<a href="#l33.421"></a><span id="l33.421"> }</span>
<a href="#l33.422"></a><span id="l33.422"> </span>
<a href="#l33.423"></a><span id="l33.423"> // Don't I18N this line...this is per the spec!</span>
<a href="#l33.424"></a><span id="l33.424" class="difflineminus">-#define   MIME_MULTIPART_BLURB     &quot;This is a multi-part message in MIME format.&quot;</span>
<a href="#l33.425"></a><span id="l33.425" class="difflineplus">+#define MIME_MULTIPART_BLURB &quot;This is a multi-part message in MIME format.&quot;</span>
<a href="#l33.426"></a><span id="l33.426"> </span>
<a href="#l33.427"></a><span id="l33.427"> /* All of the desired attachments have been written to individual temp files,</span>
<a href="#l33.428"></a><span id="l33.428">    and we know what's in them.  Now we need to make a final temp file of the</span>
<a href="#l33.429"></a><span id="l33.429">    actual mail message, containing all of the other files after having been</span>
<a href="#l33.430"></a><span id="l33.430">    encoded as appropriate.</span>
<a href="#l33.431"></a><span id="l33.431">  */</span>
<a href="#l33.432"></a><span id="l33.432"> NS_IMETHODIMP</span>
<a href="#l33.433"></a><span id="l33.433" class="difflineminus">-nsMsgComposeAndSend::GatherMimeAttachments()</span>
<a href="#l33.434"></a><span id="l33.434" class="difflineminus">-{</span>
<a href="#l33.435"></a><span id="l33.435" class="difflineplus">+nsMsgComposeAndSend::GatherMimeAttachments() {</span>
<a href="#l33.436"></a><span id="l33.436">   nsCOMPtr&lt;nsIMsgSend&gt; kungFuDeathGrip(this);</span>
<a href="#l33.437"></a><span id="l33.437"> </span>
<a href="#l33.438"></a><span id="l33.438">   bool shouldDeleteDeliveryState = true;</span>
<a href="#l33.439"></a><span id="l33.439">   nsresult status;</span>
<a href="#l33.440"></a><span id="l33.440" class="difflineminus">-  uint32_t    i;</span>
<a href="#l33.441"></a><span id="l33.441" class="difflineminus">-  PRFileDesc  *in_file = 0;</span>
<a href="#l33.442"></a><span id="l33.442" class="difflineplus">+  uint32_t i;</span>
<a href="#l33.443"></a><span id="l33.443" class="difflineplus">+  PRFileDesc *in_file = 0;</span>
<a href="#l33.444"></a><span id="l33.444">   char *buffer = 0;</span>
<a href="#l33.445"></a><span id="l33.445">   nsString msg;</span>
<a href="#l33.446"></a><span id="l33.446">   bool body_is_us_ascii = true;</span>
<a href="#l33.447"></a><span id="l33.447">   bool isUsingQP = false;</span>
<a href="#l33.448"></a><span id="l33.448"> </span>
<a href="#l33.449"></a><span id="l33.449" class="difflineminus">-  nsMsgSendPart* toppart = nullptr;      // The very top most container of the message</span>
<a href="#l33.450"></a><span id="l33.450" class="difflineminus">-                      // that we are going to send.</span>
<a href="#l33.451"></a><span id="l33.451" class="difflineminus">-</span>
<a href="#l33.452"></a><span id="l33.452" class="difflineminus">-  nsMsgSendPart* mainbody = nullptr;     // The leaf node that contains the text of the</span>
<a href="#l33.453"></a><span id="l33.453" class="difflineminus">-                      // message we're going to contain.</span>
<a href="#l33.454"></a><span id="l33.454" class="difflineminus">-</span>
<a href="#l33.455"></a><span id="l33.455" class="difflineminus">-  nsMsgSendPart* maincontainer = nullptr;  // The direct child of toppart that will</span>
<a href="#l33.456"></a><span id="l33.456" class="difflineminus">-                      // contain the mainbody.  If mainbody is</span>
<a href="#l33.457"></a><span id="l33.457" class="difflineminus">-                      // the same as toppart, then this is</span>
<a href="#l33.458"></a><span id="l33.458" class="difflineminus">-                      // also the same.  But if mainbody is</span>
<a href="#l33.459"></a><span id="l33.459" class="difflineminus">-                      // to end up somewhere inside of a</span>
<a href="#l33.460"></a><span id="l33.460" class="difflineminus">-                      // multipart/alternative or a</span>
<a href="#l33.461"></a><span id="l33.461" class="difflineminus">-                      // multipart/related, then this is that</span>
<a href="#l33.462"></a><span id="l33.462" class="difflineminus">-                      // multipart object.</span>
<a href="#l33.463"></a><span id="l33.463" class="difflineminus">-</span>
<a href="#l33.464"></a><span id="l33.464" class="difflineminus">-  nsMsgSendPart* plainpart = nullptr;    // If we converted HTML into plaintext,</span>
<a href="#l33.465"></a><span id="l33.465" class="difflineminus">-                      // the message or child containing the plaintext</span>
<a href="#l33.466"></a><span id="l33.466" class="difflineminus">-                      // goes here. (Need to use this to determine</span>
<a href="#l33.467"></a><span id="l33.467" class="difflineminus">-                      // what headers to append/set to the main</span>
<a href="#l33.468"></a><span id="l33.468" class="difflineminus">-                      // message body.)</span>
<a href="#l33.469"></a><span id="l33.469" class="difflineminus">-</span>
<a href="#l33.470"></a><span id="l33.470" class="difflineminus">-  uint32_t multipartRelatedCount = GetMultipartRelatedCount(); // The number of related part we will have to generate</span>
<a href="#l33.471"></a><span id="l33.471" class="difflineplus">+  nsMsgSendPart *toppart = nullptr;  // The very top most container of the</span>
<a href="#l33.472"></a><span id="l33.472" class="difflineplus">+                                     // message that we are going to send.</span>
<a href="#l33.473"></a><span id="l33.473" class="difflineplus">+</span>
<a href="#l33.474"></a><span id="l33.474" class="difflineplus">+  nsMsgSendPart *mainbody = nullptr;  // The leaf node that contains the text of</span>
<a href="#l33.475"></a><span id="l33.475" class="difflineplus">+                                      // the message we're going to contain.</span>
<a href="#l33.476"></a><span id="l33.476" class="difflineplus">+</span>
<a href="#l33.477"></a><span id="l33.477" class="difflineplus">+  nsMsgSendPart *maincontainer = nullptr;  // The direct child of toppart that</span>
<a href="#l33.478"></a><span id="l33.478" class="difflineplus">+                                           // will contain the mainbody.  If</span>
<a href="#l33.479"></a><span id="l33.479" class="difflineplus">+                                           // mainbody is the same as toppart,</span>
<a href="#l33.480"></a><span id="l33.480" class="difflineplus">+                                           // then this is also the same.  But</span>
<a href="#l33.481"></a><span id="l33.481" class="difflineplus">+                                           // if mainbody is to end up somewhere</span>
<a href="#l33.482"></a><span id="l33.482" class="difflineplus">+                                           // inside of a multipart/alternative</span>
<a href="#l33.483"></a><span id="l33.483" class="difflineplus">+                                           // or a multipart/related, then this</span>
<a href="#l33.484"></a><span id="l33.484" class="difflineplus">+                                           // is that multipart object.</span>
<a href="#l33.485"></a><span id="l33.485" class="difflineplus">+</span>
<a href="#l33.486"></a><span id="l33.486" class="difflineplus">+  nsMsgSendPart *plainpart = nullptr;  // If we converted HTML into plaintext,</span>
<a href="#l33.487"></a><span id="l33.487" class="difflineplus">+                                       // the message or child containing the</span>
<a href="#l33.488"></a><span id="l33.488" class="difflineplus">+                                       // plaintext goes here. (Need to use this</span>
<a href="#l33.489"></a><span id="l33.489" class="difflineplus">+                                       // to determine what headers to</span>
<a href="#l33.490"></a><span id="l33.490" class="difflineplus">+                                       // append/set to the main message body.)</span>
<a href="#l33.491"></a><span id="l33.491" class="difflineplus">+</span>
<a href="#l33.492"></a><span id="l33.492" class="difflineplus">+  uint32_t multipartRelatedCount =</span>
<a href="#l33.493"></a><span id="l33.493" class="difflineplus">+      GetMultipartRelatedCount();  // The number of related part we will have to</span>
<a href="#l33.494"></a><span id="l33.494" class="difflineplus">+                                   // generate</span>
<a href="#l33.495"></a><span id="l33.495"> </span>
<a href="#l33.496"></a><span id="l33.496">   char *hdrs = 0;</span>
<a href="#l33.497"></a><span id="l33.497">   bool maincontainerISrelatedpart = false;</span>
<a href="#l33.498"></a><span id="l33.498" class="difflineminus">-  const char * toppart_type = nullptr;</span>
<a href="#l33.499"></a><span id="l33.499" class="difflineplus">+  const char *toppart_type = nullptr;</span>
<a href="#l33.500"></a><span id="l33.500">   status = m_status;</span>
<a href="#l33.501"></a><span id="l33.501"> </span>
<a href="#l33.502"></a><span id="l33.502" class="difflineminus">-  if (NS_FAILED(status))</span>
<a href="#l33.503"></a><span id="l33.503" class="difflineminus">-    goto FAIL;</span>
<a href="#l33.504"></a><span id="l33.504" class="difflineplus">+  if (NS_FAILED(status)) goto FAIL;</span>
<a href="#l33.505"></a><span id="l33.505"> </span>
<a href="#l33.506"></a><span id="l33.506">   if (!m_attachment1_type) {</span>
<a href="#l33.507"></a><span id="l33.507">     m_attachment1_type = PL_strdup(TEXT_PLAIN);</span>
<a href="#l33.508"></a><span id="l33.508" class="difflineminus">-    if (!m_attachment1_type)</span>
<a href="#l33.509"></a><span id="l33.509" class="difflineminus">-      goto FAILMEM;</span>
<a href="#l33.510"></a><span id="l33.510" class="difflineplus">+    if (!m_attachment1_type) goto FAILMEM;</span>
<a href="#l33.511"></a><span id="l33.511">   }</span>
<a href="#l33.512"></a><span id="l33.512"> </span>
<a href="#l33.513"></a><span id="l33.513">   nsresult rv;</span>
<a href="#l33.514"></a><span id="l33.514"> </span>
<a href="#l33.515"></a><span id="l33.515">   // If we have a text/html main part, and we need a plaintext attachment, then</span>
<a href="#l33.516"></a><span id="l33.516">   // we'll do so now.  This is an asynchronous thing, so we'll kick it off and</span>
<a href="#l33.517"></a><span id="l33.517">   // count on getting back here when it finishes.</span>
<a href="#l33.518"></a><span id="l33.518"> </span>
<a href="#l33.519"></a><span id="l33.519">   if (m_plaintext == nullptr &amp;&amp;</span>
<a href="#l33.520"></a><span id="l33.520">       (mCompFields-&gt;GetForcePlainText() ||</span>
<a href="#l33.521"></a><span id="l33.521">        mCompFields-&gt;GetUseMultipartAlternative()) &amp;&amp;</span>
<a href="#l33.522"></a><span id="l33.522" class="difflineminus">-       m_attachment1_body &amp;&amp; PL_strcmp(m_attachment1_type, TEXT_HTML) == 0)</span>
<a href="#l33.523"></a><span id="l33.523" class="difflineminus">-  {</span>
<a href="#l33.524"></a><span id="l33.524" class="difflineplus">+      m_attachment1_body &amp;&amp; PL_strcmp(m_attachment1_type, TEXT_HTML) == 0) {</span>
<a href="#l33.525"></a><span id="l33.525">     //</span>
<a href="#l33.526"></a><span id="l33.526">     // If we get here, we have an HTML body, but we really need to send</span>
<a href="#l33.527"></a><span id="l33.527">     // a text/plain message, so we will write the HTML out to a disk file,</span>
<a href="#l33.528"></a><span id="l33.528">     // fire off another URL request for this local disk file and that will</span>
<a href="#l33.529"></a><span id="l33.529">     // take care of the conversion...</span>
<a href="#l33.530"></a><span id="l33.530">     //</span>
<a href="#l33.531"></a><span id="l33.531">     rv = nsMsgCreateTempFile(&quot;nsemail.html&quot;, getter_AddRefs(mHTMLFile));</span>
<a href="#l33.532"></a><span id="l33.532">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l33.533"></a><span id="l33.533"> </span>
<a href="#l33.534"></a><span id="l33.534">     nsCOMPtr&lt;nsIOutputStream&gt; tempfile;</span>
<a href="#l33.535"></a><span id="l33.535" class="difflineminus">-    rv = MsgNewBufferedFileOutputStream(getter_AddRefs(tempfile), mHTMLFile, -1, 00600);</span>
<a href="#l33.536"></a><span id="l33.536" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l33.537"></a><span id="l33.537" class="difflineminus">-    {</span>
<a href="#l33.538"></a><span id="l33.538" class="difflineminus">-      if (mSendReport)</span>
<a href="#l33.539"></a><span id="l33.539" class="difflineminus">-      {</span>
<a href="#l33.540"></a><span id="l33.540" class="difflineplus">+    rv = MsgNewBufferedFileOutputStream(getter_AddRefs(tempfile), mHTMLFile, -1,</span>
<a href="#l33.541"></a><span id="l33.541" class="difflineplus">+                                        00600);</span>
<a href="#l33.542"></a><span id="l33.542" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l33.543"></a><span id="l33.543" class="difflineplus">+      if (mSendReport) {</span>
<a href="#l33.544"></a><span id="l33.544">         nsAutoString error_msg;</span>
<a href="#l33.545"></a><span id="l33.545">         nsMsgBuildMessageWithTmpFile(mHTMLFile, error_msg);</span>
<a href="#l33.546"></a><span id="l33.546" class="difflineminus">-        mSendReport-&gt;SetMessage(nsIMsgSendReport::process_Current, error_msg.get(), false);</span>
<a href="#l33.547"></a><span id="l33.547" class="difflineplus">+        mSendReport-&gt;SetMessage(nsIMsgSendReport::process_Current,</span>
<a href="#l33.548"></a><span id="l33.548" class="difflineplus">+                                error_msg.get(), false);</span>
<a href="#l33.549"></a><span id="l33.549">       }</span>
<a href="#l33.550"></a><span id="l33.550">       status = NS_MSG_UNABLE_TO_OPEN_TMP_FILE;</span>
<a href="#l33.551"></a><span id="l33.551">       goto FAIL;</span>
<a href="#l33.552"></a><span id="l33.552">     }</span>
<a href="#l33.553"></a><span id="l33.553"> </span>
<a href="#l33.554"></a><span id="l33.554" class="difflineminus">-    if (mOriginalHTMLBody)</span>
<a href="#l33.555"></a><span id="l33.555" class="difflineminus">-    {</span>
<a href="#l33.556"></a><span id="l33.556" class="difflineplus">+    if (mOriginalHTMLBody) {</span>
<a href="#l33.557"></a><span id="l33.557">       uint32_t origLen = strlen(mOriginalHTMLBody);</span>
<a href="#l33.558"></a><span id="l33.558">       uint32_t n;</span>
<a href="#l33.559"></a><span id="l33.559">       nsresult rv = tempfile-&gt;Write(mOriginalHTMLBody, origLen, &amp;n);</span>
<a href="#l33.560"></a><span id="l33.560" class="difflineminus">-      if (NS_FAILED(rv) || n != origLen)</span>
<a href="#l33.561"></a><span id="l33.561" class="difflineminus">-      {</span>
<a href="#l33.562"></a><span id="l33.562" class="difflineplus">+      if (NS_FAILED(rv) || n != origLen) {</span>
<a href="#l33.563"></a><span id="l33.563">         status = NS_MSG_ERROR_WRITING_FILE;</span>
<a href="#l33.564"></a><span id="l33.564">         goto FAIL;</span>
<a href="#l33.565"></a><span id="l33.565">       }</span>
<a href="#l33.566"></a><span id="l33.566">     }</span>
<a href="#l33.567"></a><span id="l33.567"> </span>
<a href="#l33.568"></a><span id="l33.568" class="difflineminus">-    if (NS_FAILED(tempfile-&gt;Flush()))</span>
<a href="#l33.569"></a><span id="l33.569" class="difflineminus">-    {</span>
<a href="#l33.570"></a><span id="l33.570" class="difflineplus">+    if (NS_FAILED(tempfile-&gt;Flush())) {</span>
<a href="#l33.571"></a><span id="l33.571">       status = NS_MSG_ERROR_WRITING_FILE;</span>
<a href="#l33.572"></a><span id="l33.572">       goto FAIL;</span>
<a href="#l33.573"></a><span id="l33.573">     }</span>
<a href="#l33.574"></a><span id="l33.574"> </span>
<a href="#l33.575"></a><span id="l33.575">     tempfile-&gt;Close();</span>
<a href="#l33.576"></a><span id="l33.576"> </span>
<a href="#l33.577"></a><span id="l33.577">     m_plaintext = new nsMsgAttachmentHandler;</span>
<a href="#l33.578"></a><span id="l33.578" class="difflineminus">-    if (!m_plaintext)</span>
<a href="#l33.579"></a><span id="l33.579" class="difflineminus">-      goto FAILMEM;</span>
<a href="#l33.580"></a><span id="l33.580" class="difflineplus">+    if (!m_plaintext) goto FAILMEM;</span>
<a href="#l33.581"></a><span id="l33.581">     m_plaintext-&gt;SetMimeDeliveryState(this);</span>
<a href="#l33.582"></a><span id="l33.582">     m_plaintext-&gt;m_bogus_attachment = true;</span>
<a href="#l33.583"></a><span id="l33.583"> </span>
<a href="#l33.584"></a><span id="l33.584">     nsAutoCString tempURL;</span>
<a href="#l33.585"></a><span id="l33.585">     rv = NS_GetURLSpecFromFile(mHTMLFile, tempURL);</span>
<a href="#l33.586"></a><span id="l33.586" class="difflineminus">-    if (NS_FAILED(rv) || NS_FAILED(nsMsgNewURL(getter_AddRefs(m_plaintext-&gt;mURL), tempURL)))</span>
<a href="#l33.587"></a><span id="l33.587" class="difflineminus">-    {</span>
<a href="#l33.588"></a><span id="l33.588" class="difflineplus">+    if (NS_FAILED(rv) ||</span>
<a href="#l33.589"></a><span id="l33.589" class="difflineplus">+        NS_FAILED(nsMsgNewURL(getter_AddRefs(m_plaintext-&gt;mURL), tempURL))) {</span>
<a href="#l33.590"></a><span id="l33.590">       m_plaintext = nullptr;</span>
<a href="#l33.591"></a><span id="l33.591">       goto FAILMEM;</span>
<a href="#l33.592"></a><span id="l33.592">     }</span>
<a href="#l33.593"></a><span id="l33.593"> </span>
<a href="#l33.594"></a><span id="l33.594">     m_plaintext-&gt;m_type = TEXT_HTML;</span>
<a href="#l33.595"></a><span id="l33.595">     m_plaintext-&gt;m_charset = mCompFields-&gt;GetCharacterSet();</span>
<a href="#l33.596"></a><span id="l33.596">     m_plaintext-&gt;m_desiredType = TEXT_PLAIN;</span>
<a href="#l33.597"></a><span id="l33.597" class="difflineminus">-    m_attachment_pending_count ++;</span>
<a href="#l33.598"></a><span id="l33.598" class="difflineplus">+    m_attachment_pending_count++;</span>
<a href="#l33.599"></a><span id="l33.599">     status = m_plaintext-&gt;SnarfAttachment(mCompFields);</span>
<a href="#l33.600"></a><span id="l33.600" class="difflineminus">-    if (NS_FAILED(status))</span>
<a href="#l33.601"></a><span id="l33.601" class="difflineminus">-      goto FAIL;</span>
<a href="#l33.602"></a><span id="l33.602" class="difflineminus">-    if (m_attachment_pending_count &gt; 0)</span>
<a href="#l33.603"></a><span id="l33.603" class="difflineminus">-      return NS_OK;</span>
<a href="#l33.604"></a><span id="l33.604" class="difflineplus">+    if (NS_FAILED(status)) goto FAIL;</span>
<a href="#l33.605"></a><span id="l33.605" class="difflineplus">+    if (m_attachment_pending_count &gt; 0) return NS_OK;</span>
<a href="#l33.606"></a><span id="l33.606">   }</span>
<a href="#l33.607"></a><span id="l33.607"> </span>
<a href="#l33.608"></a><span id="l33.608">   /* Kludge to avoid having to allocate memory on the toy computers... */</span>
<a href="#l33.609"></a><span id="l33.609">   buffer = mime_get_stream_write_buffer();</span>
<a href="#l33.610"></a><span id="l33.610" class="difflineminus">-  if (! buffer)</span>
<a href="#l33.611"></a><span id="l33.611" class="difflineminus">-    goto FAILMEM;</span>
<a href="#l33.612"></a><span id="l33.612" class="difflineminus">-</span>
<a href="#l33.613"></a><span id="l33.613" class="difflineminus">-  NS_ASSERTION (m_attachment_pending_count == 0, &quot;m_attachment_pending_count != 0&quot;);</span>
<a href="#l33.614"></a><span id="l33.614" class="difflineplus">+  if (!buffer) goto FAILMEM;</span>
<a href="#l33.615"></a><span id="l33.615" class="difflineplus">+</span>
<a href="#l33.616"></a><span id="l33.616" class="difflineplus">+  NS_ASSERTION(m_attachment_pending_count == 0,</span>
<a href="#l33.617"></a><span id="l33.617" class="difflineplus">+               &quot;m_attachment_pending_count != 0&quot;);</span>
<a href="#l33.618"></a><span id="l33.618"> </span>
<a href="#l33.619"></a><span id="l33.619">   mComposeBundle-&gt;GetStringFromName(&quot;assemblingMessage&quot;, msg);</span>
<a href="#l33.620"></a><span id="l33.620" class="difflineminus">-  SetStatusMessage( msg );</span>
<a href="#l33.621"></a><span id="l33.621" class="difflineplus">+  SetStatusMessage(msg);</span>
<a href="#l33.622"></a><span id="l33.622"> </span>
<a href="#l33.623"></a><span id="l33.623">   /* First, open the message file.</span>
<a href="#l33.624"></a><span id="l33.624" class="difflineminus">-  */</span>
<a href="#l33.625"></a><span id="l33.625" class="difflineplus">+   */</span>
<a href="#l33.626"></a><span id="l33.626">   rv = nsMsgCreateTempFile(&quot;nsemail.eml&quot;, getter_AddRefs(mTempFile));</span>
<a href="#l33.627"></a><span id="l33.627">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l33.628"></a><span id="l33.628"> </span>
<a href="#l33.629"></a><span id="l33.629" class="difflineminus">-  rv = MsgNewBufferedFileOutputStream(getter_AddRefs(mOutputFile), mTempFile, -1, 00600);</span>
<a href="#l33.630"></a><span id="l33.630" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l33.631"></a><span id="l33.631" class="difflineminus">-  {</span>
<a href="#l33.632"></a><span id="l33.632" class="difflineplus">+  rv = MsgNewBufferedFileOutputStream(getter_AddRefs(mOutputFile), mTempFile,</span>
<a href="#l33.633"></a><span id="l33.633" class="difflineplus">+                                      -1, 00600);</span>
<a href="#l33.634"></a><span id="l33.634" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l33.635"></a><span id="l33.635">     status = NS_MSG_UNABLE_TO_OPEN_TMP_FILE;</span>
<a href="#l33.636"></a><span id="l33.636" class="difflineminus">-    if (mSendReport)</span>
<a href="#l33.637"></a><span id="l33.637" class="difflineminus">-    {</span>
<a href="#l33.638"></a><span id="l33.638" class="difflineplus">+    if (mSendReport) {</span>
<a href="#l33.639"></a><span id="l33.639">       nsAutoString error_msg;</span>
<a href="#l33.640"></a><span id="l33.640">       nsMsgBuildMessageWithTmpFile(mTempFile, error_msg);</span>
<a href="#l33.641"></a><span id="l33.641" class="difflineminus">-      mSendReport-&gt;SetMessage(nsIMsgSendReport::process_Current, error_msg.get(), false);</span>
<a href="#l33.642"></a><span id="l33.642" class="difflineplus">+      mSendReport-&gt;SetMessage(nsIMsgSendReport::process_Current,</span>
<a href="#l33.643"></a><span id="l33.643" class="difflineplus">+                              error_msg.get(), false);</span>
<a href="#l33.644"></a><span id="l33.644">     }</span>
<a href="#l33.645"></a><span id="l33.645">     goto FAIL;</span>
<a href="#l33.646"></a><span id="l33.646">   }</span>
<a href="#l33.647"></a><span id="l33.647"> </span>
<a href="#l33.648"></a><span id="l33.648">   // generate a message id, if necessary</span>
<a href="#l33.649"></a><span id="l33.649" class="difflineminus">-  GenerateMessageId( );</span>
<a href="#l33.650"></a><span id="l33.650" class="difflineplus">+  GenerateMessageId();</span>
<a href="#l33.651"></a><span id="l33.651"> </span>
<a href="#l33.652"></a><span id="l33.652">   mainbody = new nsMsgSendPart(this, mCompFields-&gt;GetCharacterSet());</span>
<a href="#l33.653"></a><span id="l33.653" class="difflineminus">-  if (!mainbody)</span>
<a href="#l33.654"></a><span id="l33.654" class="difflineminus">-    goto FAILMEM;</span>
<a href="#l33.655"></a><span id="l33.655" class="difflineplus">+  if (!mainbody) goto FAILMEM;</span>
<a href="#l33.656"></a><span id="l33.656"> </span>
<a href="#l33.657"></a><span id="l33.657">   mainbody-&gt;SetMainPart(true);</span>
<a href="#l33.658"></a><span id="l33.658">   mainbody-&gt;SetType(m_attachment1_type ? m_attachment1_type : TEXT_PLAIN);</span>
<a href="#l33.659"></a><span id="l33.659"> </span>
<a href="#l33.660"></a><span id="l33.660">   NS_ASSERTION(mainbody-&gt;GetBuffer() == nullptr, &quot;not-null buffer&quot;);</span>
<a href="#l33.661"></a><span id="l33.661">   status = mainbody-&gt;SetBuffer(m_attachment1_body ? m_attachment1_body : &quot;&quot;);</span>
<a href="#l33.662"></a><span id="l33.662" class="difflineminus">-  if (NS_FAILED(status))</span>
<a href="#l33.663"></a><span id="l33.663" class="difflineminus">-    goto FAIL;</span>
<a href="#l33.664"></a><span id="l33.664" class="difflineplus">+  if (NS_FAILED(status)) goto FAIL;</span>
<a href="#l33.665"></a><span id="l33.665"> </span>
<a href="#l33.666"></a><span id="l33.666">   // Determine the encoding of the main message body before we free it.</span>
<a href="#l33.667"></a><span id="l33.667">   PR_FREEIF(m_attachment1_encoding);</span>
<a href="#l33.668"></a><span id="l33.668" class="difflineminus">-  if (m_attachment1_body)</span>
<a href="#l33.669"></a><span id="l33.669" class="difflineminus">-    mCompFields-&gt;GetBodyIsAsciiOnly(&amp;body_is_us_ascii);</span>
<a href="#l33.670"></a><span id="l33.670" class="difflineminus">-</span>
<a href="#l33.671"></a><span id="l33.671" class="difflineminus">-  if (!mCompFields-&gt;GetForceMsgEncoding() &amp;&amp; (body_is_us_ascii ||</span>
<a href="#l33.672"></a><span id="l33.672" class="difflineminus">-      nsMsgI18Nstateful_charset(mCompFields-&gt;GetCharacterSet()))) {</span>
<a href="#l33.673"></a><span id="l33.673" class="difflineminus">-    m_attachment1_encoding = PL_strdup (ENCODING_7BIT);</span>
<a href="#l33.674"></a><span id="l33.674" class="difflineplus">+  if (m_attachment1_body) mCompFields-&gt;GetBodyIsAsciiOnly(&amp;body_is_us_ascii);</span>
<a href="#l33.675"></a><span id="l33.675" class="difflineplus">+</span>
<a href="#l33.676"></a><span id="l33.676" class="difflineplus">+  if (!mCompFields-&gt;GetForceMsgEncoding() &amp;&amp;</span>
<a href="#l33.677"></a><span id="l33.677" class="difflineplus">+      (body_is_us_ascii ||</span>
<a href="#l33.678"></a><span id="l33.678" class="difflineplus">+       nsMsgI18Nstateful_charset(mCompFields-&gt;GetCharacterSet()))) {</span>
<a href="#l33.679"></a><span id="l33.679" class="difflineplus">+    m_attachment1_encoding = PL_strdup(ENCODING_7BIT);</span>
<a href="#l33.680"></a><span id="l33.680">   } else if (mime_use_quoted_printable_p) {</span>
<a href="#l33.681"></a><span id="l33.681" class="difflineminus">-    m_attachment1_encoding = PL_strdup (ENCODING_QUOTED_PRINTABLE);</span>
<a href="#l33.682"></a><span id="l33.682" class="difflineplus">+    m_attachment1_encoding = PL_strdup(ENCODING_QUOTED_PRINTABLE);</span>
<a href="#l33.683"></a><span id="l33.683">     isUsingQP = true;</span>
<a href="#l33.684"></a><span id="l33.684">   } else {</span>
<a href="#l33.685"></a><span id="l33.685" class="difflineminus">-    m_attachment1_encoding = PL_strdup (ENCODING_8BIT);</span>
<a href="#l33.686"></a><span id="l33.686" class="difflineplus">+    m_attachment1_encoding = PL_strdup(ENCODING_8BIT);</span>
<a href="#l33.687"></a><span id="l33.687">   }</span>
<a href="#l33.688"></a><span id="l33.688"> </span>
<a href="#l33.689"></a><span id="l33.689">   // Make sure the lines don't get to long.</span>
<a href="#l33.690"></a><span id="l33.690">   if (m_attachment1_body) {</span>
<a href="#l33.691"></a><span id="l33.691">     uint32_t max_column = 0;</span>
<a href="#l33.692"></a><span id="l33.692">     uint32_t cur_column = 0;</span>
<a href="#l33.693"></a><span id="l33.693" class="difflineminus">-    for (char* c = m_attachment1_body; *c; c++) {</span>
<a href="#l33.694"></a><span id="l33.694" class="difflineplus">+    for (char *c = m_attachment1_body; *c; c++) {</span>
<a href="#l33.695"></a><span id="l33.695">       if (*c == '\n') {</span>
<a href="#l33.696"></a><span id="l33.696" class="difflineminus">-        if (cur_column &gt; max_column)</span>
<a href="#l33.697"></a><span id="l33.697" class="difflineminus">-          max_column = cur_column;</span>
<a href="#l33.698"></a><span id="l33.698" class="difflineplus">+        if (cur_column &gt; max_column) max_column = cur_column;</span>
<a href="#l33.699"></a><span id="l33.699">         cur_column = 0;</span>
<a href="#l33.700"></a><span id="l33.700">       } else if (*c != '\r') {</span>
<a href="#l33.701"></a><span id="l33.701">         cur_column++;</span>
<a href="#l33.702"></a><span id="l33.702">       }</span>
<a href="#l33.703"></a><span id="l33.703">     }</span>
<a href="#l33.704"></a><span id="l33.704">     // Check one last time for the last line.</span>
<a href="#l33.705"></a><span id="l33.705" class="difflineminus">-    if (cur_column &gt; max_column)</span>
<a href="#l33.706"></a><span id="l33.706" class="difflineminus">-      max_column = cur_column;</span>
<a href="#l33.707"></a><span id="l33.707" class="difflineplus">+    if (cur_column &gt; max_column) max_column = cur_column;</span>
<a href="#l33.708"></a><span id="l33.708">     if (max_column &gt; LINELENGTH_ENCODING_THRESHOLD &amp;&amp; !isUsingQP) {</span>
<a href="#l33.709"></a><span id="l33.709">       // To encode &quot;long lines&quot; use a CTE that will transmit shorter lines.</span>
<a href="#l33.710"></a><span id="l33.710">       // Switch to base64 if we are not already using &quot;quoted printable&quot;.</span>
<a href="#l33.711"></a><span id="l33.711">       PR_FREEIF(m_attachment1_encoding);</span>
<a href="#l33.712"></a><span id="l33.712" class="difflineminus">-      m_attachment1_encoding = PL_strdup (ENCODING_BASE64);</span>
<a href="#l33.713"></a><span id="l33.713" class="difflineplus">+      m_attachment1_encoding = PL_strdup(ENCODING_BASE64);</span>
<a href="#l33.714"></a><span id="l33.714">     }</span>
<a href="#l33.715"></a><span id="l33.715">   }</span>
<a href="#l33.716"></a><span id="l33.716" class="difflineminus">-  PR_FREEIF (m_attachment1_body);</span>
<a href="#l33.717"></a><span id="l33.717" class="difflineplus">+  PR_FREEIF(m_attachment1_body);</span>
<a href="#l33.718"></a><span id="l33.718"> </span>
<a href="#l33.719"></a><span id="l33.719">   maincontainer = mainbody;</span>
<a href="#l33.720"></a><span id="l33.720"> </span>
<a href="#l33.721"></a><span id="l33.721">   // If we were given a pre-saved collection of HTML and contained images,</span>
<a href="#l33.722"></a><span id="l33.722">   // then we want mainbody to point to the HTML lump therein.</span>
<a href="#l33.723"></a><span id="l33.723" class="difflineminus">-  if (m_related_part)</span>
<a href="#l33.724"></a><span id="l33.724" class="difflineminus">-  {</span>
<a href="#l33.725"></a><span id="l33.725" class="difflineplus">+  if (m_related_part) {</span>
<a href="#l33.726"></a><span id="l33.726">     // If m_related_part is of type text/html, set both maincontainer</span>
<a href="#l33.727"></a><span id="l33.727">     // and mainbody to point to it. If m_related_part is multipart/related,</span>
<a href="#l33.728"></a><span id="l33.728">     // however, set mainbody to be the first child within m_related_part.</span>
<a href="#l33.729"></a><span id="l33.729">     delete mainbody;</span>
<a href="#l33.730"></a><span id="l33.730"> </span>
<a href="#l33.731"></a><span id="l33.731">     // No matter what, maincontainer points to the outermost related part.</span>
<a href="#l33.732"></a><span id="l33.732">     maincontainer = m_related_part;</span>
<a href="#l33.733"></a><span id="l33.733">     maincontainerISrelatedpart = true;</span>
<a href="#l33.734"></a><span id="l33.734"> </span>
<a href="#l33.735"></a><span id="l33.735">     mainbody = m_related_part-&gt;GetChild(0);</span>
<a href="#l33.736"></a><span id="l33.736">     mainbody-&gt;SetMainPart(true);</span>
<a href="#l33.737"></a><span id="l33.737">   }</span>
<a href="#l33.738"></a><span id="l33.738" class="difflineminus">-  if (m_plaintext)</span>
<a href="#l33.739"></a><span id="l33.739" class="difflineminus">-  {</span>
<a href="#l33.740"></a><span id="l33.740" class="difflineplus">+  if (m_plaintext) {</span>
<a href="#l33.741"></a><span id="l33.741">     //</span>
<a href="#l33.742"></a><span id="l33.742">     // OK.  We have a plaintext version of the main body that we want to</span>
<a href="#l33.743"></a><span id="l33.743">     // send instead of or with the text/html.  Shove it in.</span>
<a href="#l33.744"></a><span id="l33.744">     //</span>
<a href="#l33.745"></a><span id="l33.745">     plainpart = new nsMsgSendPart(this, mCompFields-&gt;GetCharacterSet());</span>
<a href="#l33.746"></a><span id="l33.746" class="difflineminus">-    if (!plainpart)</span>
<a href="#l33.747"></a><span id="l33.747" class="difflineminus">-      goto FAILMEM;</span>
<a href="#l33.748"></a><span id="l33.748" class="difflineplus">+    if (!plainpart) goto FAILMEM;</span>
<a href="#l33.749"></a><span id="l33.749">     status = plainpart-&gt;SetType(TEXT_PLAIN);</span>
<a href="#l33.750"></a><span id="l33.750" class="difflineminus">-    if (NS_FAILED(status))</span>
<a href="#l33.751"></a><span id="l33.751" class="difflineminus">-      goto FAIL;</span>
<a href="#l33.752"></a><span id="l33.752" class="difflineplus">+    if (NS_FAILED(status)) goto FAIL;</span>
<a href="#l33.753"></a><span id="l33.753">     status = plainpart-&gt;SetFile(m_plaintext-&gt;mTmpFile);</span>
<a href="#l33.754"></a><span id="l33.754" class="difflineminus">-    if (NS_FAILED(status))</span>
<a href="#l33.755"></a><span id="l33.755" class="difflineminus">-      goto FAIL;</span>
<a href="#l33.756"></a><span id="l33.756" class="difflineplus">+    if (NS_FAILED(status)) goto FAIL;</span>
<a href="#l33.757"></a><span id="l33.757"> </span>
<a href="#l33.758"></a><span id="l33.758">     m_plaintext-&gt;mMainBody = true;</span>
<a href="#l33.759"></a><span id="l33.759"> </span>
<a href="#l33.760"></a><span id="l33.760">     // Determine Content-Transfer-Encoding for the attachments.</span>
<a href="#l33.761"></a><span id="l33.761">     m_plaintext-&gt;PickEncoding(mCompFields-&gt;GetCharacterSet(), this);</span>
<a href="#l33.762"></a><span id="l33.762">     const char *charset = mCompFields-&gt;GetCharacterSet();</span>
<a href="#l33.763"></a><span id="l33.763" class="difflineminus">-    hdrs = mime_generate_attachment_headers(m_plaintext-&gt;m_type.get(),</span>
<a href="#l33.764"></a><span id="l33.764" class="difflineminus">-                        nullptr,</span>
<a href="#l33.765"></a><span id="l33.765" class="difflineminus">-                        m_plaintext-&gt;m_encoding.get(),</span>
<a href="#l33.766"></a><span id="l33.766" class="difflineminus">-                        m_plaintext-&gt;m_description.get(),</span>
<a href="#l33.767"></a><span id="l33.767" class="difflineminus">-                        m_plaintext-&gt;m_xMacType.get(),</span>
<a href="#l33.768"></a><span id="l33.768" class="difflineminus">-                        m_plaintext-&gt;m_xMacCreator.get(),</span>
<a href="#l33.769"></a><span id="l33.769" class="difflineminus">-                        nullptr, 0,</span>
<a href="#l33.770"></a><span id="l33.770" class="difflineminus">-                        m_digest_p,</span>
<a href="#l33.771"></a><span id="l33.771" class="difflineminus">-                        m_plaintext,</span>
<a href="#l33.772"></a><span id="l33.772" class="difflineminus">-                        charset,</span>
<a href="#l33.773"></a><span id="l33.773" class="difflineminus">-                        charset,</span>
<a href="#l33.774"></a><span id="l33.774" class="difflineminus">-                        body_is_us_ascii,</span>
<a href="#l33.775"></a><span id="l33.775" class="difflineminus">-                        nullptr,</span>
<a href="#l33.776"></a><span id="l33.776" class="difflineminus">-                        true);</span>
<a href="#l33.777"></a><span id="l33.777" class="difflineminus">-    if (!hdrs)</span>
<a href="#l33.778"></a><span id="l33.778" class="difflineminus">-      goto FAILMEM;</span>
<a href="#l33.779"></a><span id="l33.779" class="difflineplus">+    hdrs = mime_generate_attachment_headers(</span>
<a href="#l33.780"></a><span id="l33.780" class="difflineplus">+        m_plaintext-&gt;m_type.get(), nullptr, m_plaintext-&gt;m_encoding.get(),</span>
<a href="#l33.781"></a><span id="l33.781" class="difflineplus">+        m_plaintext-&gt;m_description.get(), m_plaintext-&gt;m_xMacType.get(),</span>
<a href="#l33.782"></a><span id="l33.782" class="difflineplus">+        m_plaintext-&gt;m_xMacCreator.get(), nullptr, 0, m_digest_p, m_plaintext,</span>
<a href="#l33.783"></a><span id="l33.783" class="difflineplus">+        charset, charset, body_is_us_ascii, nullptr, true);</span>
<a href="#l33.784"></a><span id="l33.784" class="difflineplus">+    if (!hdrs) goto FAILMEM;</span>
<a href="#l33.785"></a><span id="l33.785">     status = plainpart-&gt;SetOtherHeaders(hdrs);</span>
<a href="#l33.786"></a><span id="l33.786">     PR_Free(hdrs);</span>
<a href="#l33.787"></a><span id="l33.787">     hdrs = nullptr;</span>
<a href="#l33.788"></a><span id="l33.788" class="difflineminus">-    if (NS_FAILED(status))</span>
<a href="#l33.789"></a><span id="l33.789" class="difflineminus">-      goto FAIL;</span>
<a href="#l33.790"></a><span id="l33.790" class="difflineminus">-</span>
<a href="#l33.791"></a><span id="l33.791" class="difflineminus">-    if (mCompFields-&gt;GetUseMultipartAlternative())</span>
<a href="#l33.792"></a><span id="l33.792" class="difflineminus">-    {</span>
<a href="#l33.793"></a><span id="l33.793" class="difflineminus">-      nsMsgSendPart* htmlpart = maincontainer;</span>
<a href="#l33.794"></a><span id="l33.794" class="difflineplus">+    if (NS_FAILED(status)) goto FAIL;</span>
<a href="#l33.795"></a><span id="l33.795" class="difflineplus">+</span>
<a href="#l33.796"></a><span id="l33.796" class="difflineplus">+    if (mCompFields-&gt;GetUseMultipartAlternative()) {</span>
<a href="#l33.797"></a><span id="l33.797" class="difflineplus">+      nsMsgSendPart *htmlpart = maincontainer;</span>
<a href="#l33.798"></a><span id="l33.798">       maincontainer = new nsMsgSendPart(this);</span>
<a href="#l33.799"></a><span id="l33.799" class="difflineminus">-      if (!maincontainer)</span>
<a href="#l33.800"></a><span id="l33.800" class="difflineminus">-        goto FAILMEM;</span>
<a href="#l33.801"></a><span id="l33.801" class="difflineplus">+      if (!maincontainer) goto FAILMEM;</span>
<a href="#l33.802"></a><span id="l33.802"> </span>
<a href="#l33.803"></a><span id="l33.803">       // Setup the maincontainer stuff...</span>
<a href="#l33.804"></a><span id="l33.804">       status = maincontainer-&gt;SetType(MULTIPART_ALTERNATIVE);</span>
<a href="#l33.805"></a><span id="l33.805" class="difflineminus">-      if (NS_FAILED(status))</span>
<a href="#l33.806"></a><span id="l33.806" class="difflineminus">-        goto FAIL;</span>
<a href="#l33.807"></a><span id="l33.807" class="difflineplus">+      if (NS_FAILED(status)) goto FAIL;</span>
<a href="#l33.808"></a><span id="l33.808"> </span>
<a href="#l33.809"></a><span id="l33.809">       status = maincontainer-&gt;AddChild(plainpart);</span>
<a href="#l33.810"></a><span id="l33.810" class="difflineminus">-      if (NS_FAILED(status))</span>
<a href="#l33.811"></a><span id="l33.811" class="difflineminus">-        goto FAIL;</span>
<a href="#l33.812"></a><span id="l33.812" class="difflineplus">+      if (NS_FAILED(status)) goto FAIL;</span>
<a href="#l33.813"></a><span id="l33.813"> </span>
<a href="#l33.814"></a><span id="l33.814">       status = maincontainer-&gt;AddChild(htmlpart);</span>
<a href="#l33.815"></a><span id="l33.815" class="difflineminus">-      if (NS_FAILED(status))</span>
<a href="#l33.816"></a><span id="l33.816" class="difflineminus">-        goto FAIL;</span>
<a href="#l33.817"></a><span id="l33.817" class="difflineplus">+      if (NS_FAILED(status)) goto FAIL;</span>
<a href="#l33.818"></a><span id="l33.818"> </span>
<a href="#l33.819"></a><span id="l33.819">       // Create the encoder for the plaintext part here,</span>
<a href="#l33.820"></a><span id="l33.820">       // because we aren't the main part (attachment1).</span>
<a href="#l33.821"></a><span id="l33.821">       // (This, along with the rest of the routine, should really</span>
<a href="#l33.822"></a><span id="l33.822">       // be restructured so that no special treatment is given to</span>
<a href="#l33.823"></a><span id="l33.823">       // the main body text that came in. Best to put attachment1_text</span>
<a href="#l33.824"></a><span id="l33.824">       // etc. into a nsMsgSendPart, then reshuffle the parts. Sigh.)</span>
<a href="#l33.825"></a><span id="l33.825" class="difflineminus">-      if (m_plaintext-&gt;m_encoding.LowerCaseEqualsLiteral(ENCODING_QUOTED_PRINTABLE))</span>
<a href="#l33.826"></a><span id="l33.826" class="difflineminus">-      {</span>
<a href="#l33.827"></a><span id="l33.827" class="difflineminus">-        plainpart-&gt;SetEncoder(MimeEncoder::GetQPEncoder(</span>
<a href="#l33.828"></a><span id="l33.828" class="difflineminus">-          mime_encoder_output_fn, this));</span>
<a href="#l33.829"></a><span id="l33.829" class="difflineplus">+      if (m_plaintext-&gt;m_encoding.LowerCaseEqualsLiteral(</span>
<a href="#l33.830"></a><span id="l33.830" class="difflineplus">+              ENCODING_QUOTED_PRINTABLE)) {</span>
<a href="#l33.831"></a><span id="l33.831" class="difflineplus">+        plainpart-&gt;SetEncoder(</span>
<a href="#l33.832"></a><span id="l33.832" class="difflineplus">+            MimeEncoder::GetQPEncoder(mime_encoder_output_fn, this));</span>
<a href="#l33.833"></a><span id="l33.833" class="difflineplus">+      } else if (m_plaintext-&gt;m_encoding.LowerCaseEqualsLiteral(</span>
<a href="#l33.834"></a><span id="l33.834" class="difflineplus">+                     ENCODING_BASE64)) {</span>
<a href="#l33.835"></a><span id="l33.835" class="difflineplus">+        plainpart-&gt;SetEncoder(</span>
<a href="#l33.836"></a><span id="l33.836" class="difflineplus">+            MimeEncoder::GetBase64Encoder(mime_encoder_output_fn, this));</span>
<a href="#l33.837"></a><span id="l33.837">       }</span>
<a href="#l33.838"></a><span id="l33.838" class="difflineminus">-      else if (m_plaintext-&gt;m_encoding.LowerCaseEqualsLiteral(ENCODING_BASE64))</span>
<a href="#l33.839"></a><span id="l33.839" class="difflineminus">-      {</span>
<a href="#l33.840"></a><span id="l33.840" class="difflineminus">-        plainpart-&gt;SetEncoder(MimeEncoder::GetBase64Encoder(</span>
<a href="#l33.841"></a><span id="l33.841" class="difflineminus">-          mime_encoder_output_fn, this));</span>
<a href="#l33.842"></a><span id="l33.842" class="difflineminus">-      }</span>
<a href="#l33.843"></a><span id="l33.843" class="difflineminus">-    }</span>
<a href="#l33.844"></a><span id="l33.844" class="difflineminus">-    else</span>
<a href="#l33.845"></a><span id="l33.845" class="difflineminus">-    {</span>
<a href="#l33.846"></a><span id="l33.846" class="difflineplus">+    } else {</span>
<a href="#l33.847"></a><span id="l33.847">       delete maincontainer;</span>
<a href="#l33.848"></a><span id="l33.848">       if (maincontainerISrelatedpart)</span>
<a href="#l33.849"></a><span id="l33.849" class="difflineminus">-        m_related_part = nullptr; // in that case, m_related_part == maincontainer which we have just deleted!</span>
<a href="#l33.850"></a><span id="l33.850" class="difflineplus">+        m_related_part = nullptr;  // in that case, m_related_part ==</span>
<a href="#l33.851"></a><span id="l33.851" class="difflineplus">+                                   // maincontainer which we have just deleted!</span>
<a href="#l33.852"></a><span id="l33.852">       maincontainer = plainpart;</span>
<a href="#l33.853"></a><span id="l33.853">       mainbody = maincontainer;</span>
<a href="#l33.854"></a><span id="l33.854">       PR_FREEIF(m_attachment1_type);</span>
<a href="#l33.855"></a><span id="l33.855">       m_attachment1_type = PL_strdup(TEXT_PLAIN);</span>
<a href="#l33.856"></a><span id="l33.856" class="difflineminus">-      if (!m_attachment1_type)</span>
<a href="#l33.857"></a><span id="l33.857" class="difflineminus">-        goto FAILMEM;</span>
<a href="#l33.858"></a><span id="l33.858" class="difflineplus">+      if (!m_attachment1_type) goto FAILMEM;</span>
<a href="#l33.859"></a><span id="l33.859"> </span>
<a href="#l33.860"></a><span id="l33.860">       // Override attachment1_encoding here. We do this blindly since we are</span>
<a href="#l33.861"></a><span id="l33.861">       // sending plaintext only at this point.</span>
<a href="#l33.862"></a><span id="l33.862">       PR_FREEIF(m_attachment1_encoding);</span>
<a href="#l33.863"></a><span id="l33.863">       m_attachment1_encoding = ToNewCString(m_plaintext-&gt;m_encoding);</span>
<a href="#l33.864"></a><span id="l33.864">     }</span>
<a href="#l33.865"></a><span id="l33.865">   }</span>
<a href="#l33.866"></a><span id="l33.866"> </span>
<a href="#l33.867"></a><span id="l33.867" class="difflineminus">-  // check if we need to encapsulate the message in a multipart/mixed or multipart/digest</span>
<a href="#l33.868"></a><span id="l33.868" class="difflineminus">-  if (m_attachment_count &gt; multipartRelatedCount)</span>
<a href="#l33.869"></a><span id="l33.869" class="difflineminus">-  {</span>
<a href="#l33.870"></a><span id="l33.870" class="difflineplus">+  // check if we need to encapsulate the message in a multipart/mixed or</span>
<a href="#l33.871"></a><span id="l33.871" class="difflineplus">+  // multipart/digest</span>
<a href="#l33.872"></a><span id="l33.872" class="difflineplus">+  if (m_attachment_count &gt; multipartRelatedCount) {</span>
<a href="#l33.873"></a><span id="l33.873">     toppart = new nsMsgSendPart(this);</span>
<a href="#l33.874"></a><span id="l33.874" class="difflineminus">-    if (!toppart)</span>
<a href="#l33.875"></a><span id="l33.875" class="difflineminus">-      goto FAILMEM;</span>
<a href="#l33.876"></a><span id="l33.876" class="difflineplus">+    if (!toppart) goto FAILMEM;</span>
<a href="#l33.877"></a><span id="l33.877"> </span>
<a href="#l33.878"></a><span id="l33.878">     status = toppart-&gt;SetType(m_digest_p ? MULTIPART_DIGEST : MULTIPART_MIXED);</span>
<a href="#l33.879"></a><span id="l33.879" class="difflineminus">-    if (NS_FAILED(status))</span>
<a href="#l33.880"></a><span id="l33.880" class="difflineminus">-      goto FAIL;</span>
<a href="#l33.881"></a><span id="l33.881" class="difflineplus">+    if (NS_FAILED(status)) goto FAIL;</span>
<a href="#l33.882"></a><span id="l33.882"> </span>
<a href="#l33.883"></a><span id="l33.883">     status = toppart-&gt;AddChild(maincontainer);</span>
<a href="#l33.884"></a><span id="l33.884" class="difflineminus">-    if (NS_FAILED(status))</span>
<a href="#l33.885"></a><span id="l33.885" class="difflineminus">-      goto FAIL;</span>
<a href="#l33.886"></a><span id="l33.886" class="difflineminus">-  }</span>
<a href="#l33.887"></a><span id="l33.887" class="difflineminus">-  else</span>
<a href="#l33.888"></a><span id="l33.888" class="difflineplus">+    if (NS_FAILED(status)) goto FAIL;</span>
<a href="#l33.889"></a><span id="l33.889" class="difflineplus">+  } else</span>
<a href="#l33.890"></a><span id="l33.890">     toppart = maincontainer;</span>
<a href="#l33.891"></a><span id="l33.891"> </span>
<a href="#l33.892"></a><span id="l33.892">   // Is the top part a multipart container?</span>
<a href="#l33.893"></a><span id="l33.893">   // can't use m_attachment_count because it's not reliable for that</span>
<a href="#l33.894"></a><span id="l33.894">   // instead use type of main part. See bug #174396</span>
<a href="#l33.895"></a><span id="l33.895" class="difflineminus">-  toppart_type = toppart-&gt;GetType(); // GetType return directly the member variable, don't free it!</span>
<a href="#l33.896"></a><span id="l33.896" class="difflineminus">-  if (!m_crypto_closure &amp;&amp; toppart_type &amp;&amp; !PL_strncasecmp(toppart_type, &quot;multipart/&quot;, 10))</span>
<a href="#l33.897"></a><span id="l33.897" class="difflineminus">-  {</span>
<a href="#l33.898"></a><span id="l33.898" class="difflineplus">+  toppart_type = toppart-&gt;GetType();  // GetType return directly the member</span>
<a href="#l33.899"></a><span id="l33.899" class="difflineplus">+                                      // variable, don't free it!</span>
<a href="#l33.900"></a><span id="l33.900" class="difflineplus">+  if (!m_crypto_closure &amp;&amp; toppart_type &amp;&amp;</span>
<a href="#l33.901"></a><span id="l33.901" class="difflineplus">+      !PL_strncasecmp(toppart_type, &quot;multipart/&quot;, 10)) {</span>
<a href="#l33.902"></a><span id="l33.902">     status = toppart-&gt;SetBuffer(MIME_MULTIPART_BLURB);</span>
<a href="#l33.903"></a><span id="l33.903" class="difflineminus">-    if (NS_FAILED(status))</span>
<a href="#l33.904"></a><span id="l33.904" class="difflineminus">-      goto FAIL;</span>
<a href="#l33.905"></a><span id="l33.905" class="difflineplus">+    if (NS_FAILED(status)) goto FAIL;</span>
<a href="#l33.906"></a><span id="l33.906">   }</span>
<a href="#l33.907"></a><span id="l33.907"> </span>
<a href="#l33.908"></a><span id="l33.908">   {</span>
<a href="#l33.909"></a><span id="l33.909">     nsCOMPtr&lt;msgIWritableStructuredHeaders&gt; outputHeaders =</span>
<a href="#l33.910"></a><span id="l33.910" class="difflineminus">-      do_CreateInstance(NS_ISTRUCTUREDHEADERS_CONTRACTID);</span>
<a href="#l33.911"></a><span id="l33.911" class="difflineplus">+        do_CreateInstance(NS_ISTRUCTUREDHEADERS_CONTRACTID);</span>
<a href="#l33.912"></a><span id="l33.912">     status = mime_generate_headers(mCompFields, m_deliver_mode, outputHeaders);</span>
<a href="#l33.913"></a><span id="l33.913" class="difflineminus">-    if (NS_FAILED(status))</span>
<a href="#l33.914"></a><span id="l33.914" class="difflineminus">-      goto FAIL;</span>
<a href="#l33.915"></a><span id="l33.915" class="difflineplus">+    if (NS_FAILED(status)) goto FAIL;</span>
<a href="#l33.916"></a><span id="l33.916"> </span>
<a href="#l33.917"></a><span id="l33.917">     // Convert the blocks of headers into a single string for emission.</span>
<a href="#l33.918"></a><span id="l33.918">     nsAutoCString headers;</span>
<a href="#l33.919"></a><span id="l33.919">     outputHeaders-&gt;BuildMimeText(headers);</span>
<a href="#l33.920"></a><span id="l33.920"> </span>
<a href="#l33.921"></a><span id="l33.921">     // If we converted HTML into plaintext, the plaintext part (plainpart)</span>
<a href="#l33.922"></a><span id="l33.922">     // already has its content-type and content-transfer-encoding (&quot;other&quot;)</span>
<a href="#l33.923"></a><span id="l33.923">     // headers set.</span>
<a href="#l33.924"></a><span id="l33.924" class="difflineat">@@ -809,672 +730,577 @@ nsMsgComposeAndSend::GatherMimeAttachmen</span>
<a href="#l33.925"></a><span id="l33.925">     // So, in the above case we append the main message headers, otherwise we</span>
<a href="#l33.926"></a><span id="l33.926">     // overwrite whatever headers may have existed.</span>
<a href="#l33.927"></a><span id="l33.927">     if (plainpart &amp;&amp; plainpart == toppart)</span>
<a href="#l33.928"></a><span id="l33.928">       status = toppart-&gt;AppendOtherHeaders(headers.get());</span>
<a href="#l33.929"></a><span id="l33.929">     else</span>
<a href="#l33.930"></a><span id="l33.930">       status = toppart-&gt;SetOtherHeaders(headers.get());</span>
<a href="#l33.931"></a><span id="l33.931">   }</span>
<a href="#l33.932"></a><span id="l33.932"> </span>
<a href="#l33.933"></a><span id="l33.933" class="difflineminus">-  if (NS_FAILED(status))</span>
<a href="#l33.934"></a><span id="l33.934" class="difflineminus">-    goto FAIL;</span>
<a href="#l33.935"></a><span id="l33.935" class="difflineplus">+  if (NS_FAILED(status)) goto FAIL;</span>
<a href="#l33.936"></a><span id="l33.936"> </span>
<a href="#l33.937"></a><span id="l33.937">   // Set up the first part (user-typed.)  For now, do it even if the first</span>
<a href="#l33.938"></a><span id="l33.938">   // part is empty; we need to add things to skip it if this part is empty.</span>
<a href="#l33.939"></a><span id="l33.939"> </span>
<a href="#l33.940"></a><span id="l33.940">   // Set up encoder for the first part (message body.)</span>
<a href="#l33.941"></a><span id="l33.941">   //</span>
<a href="#l33.942"></a><span id="l33.942">   NS_ASSERTION(!m_attachment1_encoder, &quot;not-null m_attachment1_encoder&quot;);</span>
<a href="#l33.943"></a><span id="l33.943" class="difflineminus">-  if (!PL_strcasecmp(m_attachment1_encoding, ENCODING_BASE64))</span>
<a href="#l33.944"></a><span id="l33.944" class="difflineminus">-  {</span>
<a href="#l33.945"></a><span id="l33.945" class="difflineminus">-    m_attachment1_encoder = MimeEncoder::GetBase64Encoder(</span>
<a href="#l33.946"></a><span id="l33.946" class="difflineminus">-      mime_encoder_output_fn, this);</span>
<a href="#l33.947"></a><span id="l33.947" class="difflineminus">-  }</span>
<a href="#l33.948"></a><span id="l33.948" class="difflineminus">-  else if (!PL_strcasecmp(m_attachment1_encoding, ENCODING_QUOTED_PRINTABLE))</span>
<a href="#l33.949"></a><span id="l33.949" class="difflineminus">-  {</span>
<a href="#l33.950"></a><span id="l33.950" class="difflineminus">-    m_attachment1_encoder = MimeEncoder::GetQPEncoder(mime_encoder_output_fn,</span>
<a href="#l33.951"></a><span id="l33.951" class="difflineminus">-      this);</span>
<a href="#l33.952"></a><span id="l33.952" class="difflineplus">+  if (!PL_strcasecmp(m_attachment1_encoding, ENCODING_BASE64)) {</span>
<a href="#l33.953"></a><span id="l33.953" class="difflineplus">+    m_attachment1_encoder =</span>
<a href="#l33.954"></a><span id="l33.954" class="difflineplus">+        MimeEncoder::GetBase64Encoder(mime_encoder_output_fn, this);</span>
<a href="#l33.955"></a><span id="l33.955" class="difflineplus">+  } else if (!PL_strcasecmp(m_attachment1_encoding,</span>
<a href="#l33.956"></a><span id="l33.956" class="difflineplus">+                            ENCODING_QUOTED_PRINTABLE)) {</span>
<a href="#l33.957"></a><span id="l33.957" class="difflineplus">+    m_attachment1_encoder =</span>
<a href="#l33.958"></a><span id="l33.958" class="difflineplus">+        MimeEncoder::GetQPEncoder(mime_encoder_output_fn, this);</span>
<a href="#l33.959"></a><span id="l33.959">   }</span>
<a href="#l33.960"></a><span id="l33.960"> </span>
<a href="#l33.961"></a><span id="l33.961">   // If we converted HTML into plaintext, the plaintext part</span>
<a href="#l33.962"></a><span id="l33.962">   // already has its type/encoding headers set. So, in the specific</span>
<a href="#l33.963"></a><span id="l33.963">   // case where such a plaintext part is the main message body</span>
<a href="#l33.964"></a><span id="l33.964">   // (iff an HTML message is being sent as text only)</span>
<a href="#l33.965"></a><span id="l33.965">   // we want to avoid generating type/encoding/digest headers;</span>
<a href="#l33.966"></a><span id="l33.966">   // in all other cases, generate such headers here.</span>
<a href="#l33.967"></a><span id="l33.967">   //</span>
<a href="#l33.968"></a><span id="l33.968">   // We really want to set up headers as a dictionary of some sort</span>
<a href="#l33.969"></a><span id="l33.969">   // so that we need not worry about duplicate header lines.</span>
<a href="#l33.970"></a><span id="l33.970">   //</span>
<a href="#l33.971"></a><span id="l33.971" class="difflineminus">-  if ((!plainpart) || (plainpart != mainbody))</span>
<a href="#l33.972"></a><span id="l33.972" class="difflineminus">-  {</span>
<a href="#l33.973"></a><span id="l33.973" class="difflineplus">+  if ((!plainpart) || (plainpart != mainbody)) {</span>
<a href="#l33.974"></a><span id="l33.974">     const char *charset = mCompFields-&gt;GetCharacterSet();</span>
<a href="#l33.975"></a><span id="l33.975" class="difflineminus">-    hdrs = mime_generate_attachment_headers (m_attachment1_type,</span>
<a href="#l33.976"></a><span id="l33.976" class="difflineminus">-                         nullptr,</span>
<a href="#l33.977"></a><span id="l33.977" class="difflineminus">-                         m_attachment1_encoding,</span>
<a href="#l33.978"></a><span id="l33.978" class="difflineminus">-                         0, 0, 0, 0, 0,</span>
<a href="#l33.979"></a><span id="l33.979" class="difflineminus">-                         m_digest_p,</span>
<a href="#l33.980"></a><span id="l33.980" class="difflineminus">-                         nullptr, /* no &quot;ma&quot;! */</span>
<a href="#l33.981"></a><span id="l33.981" class="difflineminus">-                         charset,</span>
<a href="#l33.982"></a><span id="l33.982" class="difflineminus">-                         charset,</span>
<a href="#l33.983"></a><span id="l33.983" class="difflineminus">-                         mCompFields-&gt;GetBodyIsAsciiOnly(),</span>
<a href="#l33.984"></a><span id="l33.984" class="difflineminus">-                         nullptr,</span>
<a href="#l33.985"></a><span id="l33.985" class="difflineminus">-                         true);</span>
<a href="#l33.986"></a><span id="l33.986" class="difflineminus">-    if (!hdrs)</span>
<a href="#l33.987"></a><span id="l33.987" class="difflineminus">-      goto FAILMEM;</span>
<a href="#l33.988"></a><span id="l33.988" class="difflineplus">+    hdrs = mime_generate_attachment_headers(</span>
<a href="#l33.989"></a><span id="l33.989" class="difflineplus">+        m_attachment1_type, nullptr, m_attachment1_encoding, 0, 0, 0, 0, 0,</span>
<a href="#l33.990"></a><span id="l33.990" class="difflineplus">+        m_digest_p, nullptr, /* no &quot;ma&quot;! */</span>
<a href="#l33.991"></a><span id="l33.991" class="difflineplus">+        charset, charset, mCompFields-&gt;GetBodyIsAsciiOnly(), nullptr, true);</span>
<a href="#l33.992"></a><span id="l33.992" class="difflineplus">+    if (!hdrs) goto FAILMEM;</span>
<a href="#l33.993"></a><span id="l33.993">     status = mainbody-&gt;AppendOtherHeaders(hdrs);</span>
<a href="#l33.994"></a><span id="l33.994" class="difflineminus">-    if (NS_FAILED(status))</span>
<a href="#l33.995"></a><span id="l33.995" class="difflineminus">-      goto FAIL;</span>
<a href="#l33.996"></a><span id="l33.996" class="difflineplus">+    if (NS_FAILED(status)) goto FAIL;</span>
<a href="#l33.997"></a><span id="l33.997">   }</span>
<a href="#l33.998"></a><span id="l33.998"> </span>
<a href="#l33.999"></a><span id="l33.999">   PR_FREEIF(hdrs);</span>
<a href="#l33.1000"></a><span id="l33.1000"> </span>
<a href="#l33.1001"></a><span id="l33.1001">   mainbody-&gt;SetEncoder(m_attachment1_encoder.forget());</span>
<a href="#l33.1002"></a><span id="l33.1002"> </span>
<a href="#l33.1003"></a><span id="l33.1003">   //</span>
<a href="#l33.1004"></a><span id="l33.1004">   // Now we need to process attachments and slot them in the</span>
<a href="#l33.1005"></a><span id="l33.1005">   // correct hierarchy.</span>
<a href="#l33.1006"></a><span id="l33.1006">   //</span>
<a href="#l33.1007"></a><span id="l33.1007" class="difflineminus">-  if (m_attachment_count &gt; 0)</span>
<a href="#l33.1008"></a><span id="l33.1008" class="difflineminus">-  {</span>
<a href="#l33.1009"></a><span id="l33.1009" class="difflineplus">+  if (m_attachment_count &gt; 0) {</span>
<a href="#l33.1010"></a><span id="l33.1010">     // Kludge to avoid having to allocate memory on the toy computers...</span>
<a href="#l33.1011"></a><span id="l33.1011" class="difflineminus">-    if (! mime_mailto_stream_read_buffer)</span>
<a href="#l33.1012"></a><span id="l33.1012" class="difflineminus">-      mime_mailto_stream_read_buffer = (char *) PR_Malloc (MIME_BUFFER_SIZE);</span>
<a href="#l33.1013"></a><span id="l33.1013" class="difflineplus">+    if (!mime_mailto_stream_read_buffer)</span>
<a href="#l33.1014"></a><span id="l33.1014" class="difflineplus">+      mime_mailto_stream_read_buffer = (char *)PR_Malloc(MIME_BUFFER_SIZE);</span>
<a href="#l33.1015"></a><span id="l33.1015">     buffer = mime_mailto_stream_read_buffer;</span>
<a href="#l33.1016"></a><span id="l33.1016" class="difflineminus">-    if (! buffer)</span>
<a href="#l33.1017"></a><span id="l33.1017" class="difflineminus">-      goto FAILMEM;</span>
<a href="#l33.1018"></a><span id="l33.1018" class="difflineplus">+    if (!buffer) goto FAILMEM;</span>
<a href="#l33.1019"></a><span id="l33.1019"> </span>
<a href="#l33.1020"></a><span id="l33.1020">     // Gather all of the attachments for this message that are NOT</span>
<a href="#l33.1021"></a><span id="l33.1021">     // part of an enclosed MHTML message!</span>
<a href="#l33.1022"></a><span id="l33.1022" class="difflineminus">-    for (i = 0; i &lt; m_attachment_count; i++)</span>
<a href="#l33.1023"></a><span id="l33.1023" class="difflineminus">-    {</span>
<a href="#l33.1024"></a><span id="l33.1024" class="difflineplus">+    for (i = 0; i &lt; m_attachment_count; i++) {</span>
<a href="#l33.1025"></a><span id="l33.1025">       nsMsgAttachmentHandler *ma = m_attachments[i];</span>
<a href="#l33.1026"></a><span id="l33.1026" class="difflineminus">-      if (!ma-&gt;mMHTMLPart)</span>
<a href="#l33.1027"></a><span id="l33.1027" class="difflineminus">-        PreProcessPart(ma, toppart);</span>
<a href="#l33.1028"></a><span id="l33.1028" class="difflineplus">+      if (!ma-&gt;mMHTMLPart) PreProcessPart(ma, toppart);</span>
<a href="#l33.1029"></a><span id="l33.1029">     }</span>
<a href="#l33.1030"></a><span id="l33.1030"> </span>
<a href="#l33.1031"></a><span id="l33.1031">     //</span>
<a href="#l33.1032"></a><span id="l33.1032">     // If we have a m_related_part as a container for children, then we have to</span>
<a href="#l33.1033"></a><span id="l33.1033">     // tack on these children for the part</span>
<a href="#l33.1034"></a><span id="l33.1034">     //</span>
<a href="#l33.1035"></a><span id="l33.1035" class="difflineminus">-    if (m_related_part)</span>
<a href="#l33.1036"></a><span id="l33.1036" class="difflineminus">-    {</span>
<a href="#l33.1037"></a><span id="l33.1037" class="difflineminus">-      for (i = 0; i &lt; m_attachment_count; i++)</span>
<a href="#l33.1038"></a><span id="l33.1038" class="difflineminus">-      {</span>
<a href="#l33.1039"></a><span id="l33.1039" class="difflineplus">+    if (m_related_part) {</span>
<a href="#l33.1040"></a><span id="l33.1040" class="difflineplus">+      for (i = 0; i &lt; m_attachment_count; i++) {</span>
<a href="#l33.1041"></a><span id="l33.1041">         //</span>
<a href="#l33.1042"></a><span id="l33.1042">         // look for earlier part with the same content id. If we find it,</span>
<a href="#l33.1043"></a><span id="l33.1043">         // need to remember the mapping between our node index and the</span>
<a href="#l33.1044"></a><span id="l33.1044">         // part num of the earlier part.</span>
<a href="#l33.1045"></a><span id="l33.1045">         int32_t nodeIndex = m_attachments[i]-&gt;mNodeIndex;</span>
<a href="#l33.1046"></a><span id="l33.1046" class="difflineminus">-        if (nodeIndex != -1)</span>
<a href="#l33.1047"></a><span id="l33.1047" class="difflineminus">-        {</span>
<a href="#l33.1048"></a><span id="l33.1048" class="difflineminus">-          for (uint32_t j = 0; j &lt; i; j++)</span>
<a href="#l33.1049"></a><span id="l33.1049" class="difflineminus">-          {</span>
<a href="#l33.1050"></a><span id="l33.1050" class="difflineplus">+        if (nodeIndex != -1) {</span>
<a href="#l33.1051"></a><span id="l33.1051" class="difflineplus">+          for (uint32_t j = 0; j &lt; i; j++) {</span>
<a href="#l33.1052"></a><span id="l33.1052">             if (m_attachments[j]-&gt;mNodeIndex != -1 &amp;&amp;</span>
<a href="#l33.1053"></a><span id="l33.1053" class="difflineminus">-                m_attachments[j]-&gt;m_contentId.Equals(m_attachments[i]-&gt;m_contentId))</span>
<a href="#l33.1054"></a><span id="l33.1054" class="difflineminus">-              m_partNumbers[nodeIndex] = m_partNumbers[m_attachments[j]-&gt;mNodeIndex];</span>
<a href="#l33.1055"></a><span id="l33.1055" class="difflineplus">+                m_attachments[j]-&gt;m_contentId.Equals(</span>
<a href="#l33.1056"></a><span id="l33.1056" class="difflineplus">+                    m_attachments[i]-&gt;m_contentId))</span>
<a href="#l33.1057"></a><span id="l33.1057" class="difflineplus">+              m_partNumbers[nodeIndex] =</span>
<a href="#l33.1058"></a><span id="l33.1058" class="difflineplus">+                  m_partNumbers[m_attachments[j]-&gt;mNodeIndex];</span>
<a href="#l33.1059"></a><span id="l33.1059">           }</span>
<a href="#l33.1060"></a><span id="l33.1060">         }</span>
<a href="#l33.1061"></a><span id="l33.1061">         // rhp: This is here because we could get here after saying OK</span>
<a href="#l33.1062"></a><span id="l33.1062">         // to a lot of prompts about not being able to fetch this part!</span>
<a href="#l33.1063"></a><span id="l33.1063">         //</span>
<a href="#l33.1064"></a><span id="l33.1064" class="difflineminus">-        if (m_attachments[i]-&gt;mPartUserOmissionOverride)</span>
<a href="#l33.1065"></a><span id="l33.1065" class="difflineminus">-          continue;</span>
<a href="#l33.1066"></a><span id="l33.1066" class="difflineplus">+        if (m_attachments[i]-&gt;mPartUserOmissionOverride) continue;</span>
<a href="#l33.1067"></a><span id="l33.1067"> </span>
<a href="#l33.1068"></a><span id="l33.1068">         // Now, we need to add this part to the m_related_part member so the</span>
<a href="#l33.1069"></a><span id="l33.1069">         // message will be generated correctly.</span>
<a href="#l33.1070"></a><span id="l33.1070">         if (m_attachments[i]-&gt;mMHTMLPart)</span>
<a href="#l33.1071"></a><span id="l33.1071">           PreProcessPart(m_attachments[i], m_related_part);</span>
<a href="#l33.1072"></a><span id="l33.1072">       }</span>
<a href="#l33.1073"></a><span id="l33.1073">     }</span>
<a href="#l33.1074"></a><span id="l33.1074" class="difflineminus">-</span>
<a href="#l33.1075"></a><span id="l33.1075">   }</span>
<a href="#l33.1076"></a><span id="l33.1076"> </span>
<a href="#l33.1077"></a><span id="l33.1077">   // Tell the user we are creating the message...</span>
<a href="#l33.1078"></a><span id="l33.1078">   mComposeBundle-&gt;GetStringFromName(&quot;creatingMailMessage&quot;, msg);</span>
<a href="#l33.1079"></a><span id="l33.1079" class="difflineminus">-  SetStatusMessage( msg );</span>
<a href="#l33.1080"></a><span id="l33.1080" class="difflineplus">+  SetStatusMessage(msg);</span>
<a href="#l33.1081"></a><span id="l33.1081"> </span>
<a href="#l33.1082"></a><span id="l33.1082">   // OK, now actually write the structure we've carefully built up.</span>
<a href="#l33.1083"></a><span id="l33.1083">   status = toppart-&gt;Write();</span>
<a href="#l33.1084"></a><span id="l33.1084" class="difflineminus">-  if (NS_FAILED(status))</span>
<a href="#l33.1085"></a><span id="l33.1085" class="difflineminus">-    goto FAIL;</span>
<a href="#l33.1086"></a><span id="l33.1086" class="difflineplus">+  if (NS_FAILED(status)) goto FAIL;</span>
<a href="#l33.1087"></a><span id="l33.1087"> </span>
<a href="#l33.1088"></a><span id="l33.1088">   /* Close down encryption stream */</span>
<a href="#l33.1089"></a><span id="l33.1089" class="difflineminus">-  if (m_crypto_closure)</span>
<a href="#l33.1090"></a><span id="l33.1090" class="difflineminus">-  {</span>
<a href="#l33.1091"></a><span id="l33.1091" class="difflineplus">+  if (m_crypto_closure) {</span>
<a href="#l33.1092"></a><span id="l33.1092">     status = m_crypto_closure-&gt;FinishCryptoEncapsulation(false, mSendReport);</span>
<a href="#l33.1093"></a><span id="l33.1093">     m_crypto_closure = nullptr;</span>
<a href="#l33.1094"></a><span id="l33.1094">     if (NS_FAILED(status)) goto FAIL;</span>
<a href="#l33.1095"></a><span id="l33.1095">   }</span>
<a href="#l33.1096"></a><span id="l33.1096"> </span>
<a href="#l33.1097"></a><span id="l33.1097" class="difflineminus">-  if (mOutputFile)</span>
<a href="#l33.1098"></a><span id="l33.1098" class="difflineminus">-  {</span>
<a href="#l33.1099"></a><span id="l33.1099" class="difflineminus">-    if (NS_FAILED(mOutputFile-&gt;Flush()))</span>
<a href="#l33.1100"></a><span id="l33.1100" class="difflineminus">-    {</span>
<a href="#l33.1101"></a><span id="l33.1101" class="difflineplus">+  if (mOutputFile) {</span>
<a href="#l33.1102"></a><span id="l33.1102" class="difflineplus">+    if (NS_FAILED(mOutputFile-&gt;Flush())) {</span>
<a href="#l33.1103"></a><span id="l33.1103">       status = NS_MSG_ERROR_WRITING_FILE;</span>
<a href="#l33.1104"></a><span id="l33.1104">       goto FAIL;</span>
<a href="#l33.1105"></a><span id="l33.1105">     }</span>
<a href="#l33.1106"></a><span id="l33.1106"> </span>
<a href="#l33.1107"></a><span id="l33.1107">     mOutputFile-&gt;Close();</span>
<a href="#l33.1108"></a><span id="l33.1108">     mOutputFile = nullptr;</span>
<a href="#l33.1109"></a><span id="l33.1109"> </span>
<a href="#l33.1110"></a><span id="l33.1110">     // mTempFile is stale because we wrote to it.  Get another copy to refresh.</span>
<a href="#l33.1111"></a><span id="l33.1111">     nsCOMPtr&lt;nsIFile&gt; tempFileCopy;</span>
<a href="#l33.1112"></a><span id="l33.1112">     mTempFile-&gt;Clone(getter_AddRefs(tempFileCopy));</span>
<a href="#l33.1113"></a><span id="l33.1113">     mTempFile = tempFileCopy;</span>
<a href="#l33.1114"></a><span id="l33.1114">     tempFileCopy = nullptr;</span>
<a href="#l33.1115"></a><span id="l33.1115">     /* If we don't do this check...ZERO length files can be sent */</span>
<a href="#l33.1116"></a><span id="l33.1116">     int64_t fileSize;</span>
<a href="#l33.1117"></a><span id="l33.1117">     rv = mTempFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l33.1118"></a><span id="l33.1118" class="difflineminus">-    if (NS_FAILED(rv) || fileSize == 0)</span>
<a href="#l33.1119"></a><span id="l33.1119" class="difflineminus">-    {</span>
<a href="#l33.1120"></a><span id="l33.1120" class="difflineplus">+    if (NS_FAILED(rv) || fileSize == 0) {</span>
<a href="#l33.1121"></a><span id="l33.1121">       status = NS_MSG_ERROR_WRITING_FILE;</span>
<a href="#l33.1122"></a><span id="l33.1122">       goto FAIL;</span>
<a href="#l33.1123"></a><span id="l33.1123">     }</span>
<a href="#l33.1124"></a><span id="l33.1124">   }</span>
<a href="#l33.1125"></a><span id="l33.1125"> </span>
<a href="#l33.1126"></a><span id="l33.1126">   mComposeBundle-&gt;GetStringFromName(&quot;assemblingMessageDone&quot;, msg);</span>
<a href="#l33.1127"></a><span id="l33.1127">   SetStatusMessage(msg);</span>
<a href="#l33.1128"></a><span id="l33.1128"> </span>
<a href="#l33.1129"></a><span id="l33.1129" class="difflineminus">-  if (m_dont_deliver_p &amp;&amp; mListener)</span>
<a href="#l33.1130"></a><span id="l33.1130" class="difflineminus">-  {</span>
<a href="#l33.1131"></a><span id="l33.1131" class="difflineplus">+  if (m_dont_deliver_p &amp;&amp; mListener) {</span>
<a href="#l33.1132"></a><span id="l33.1132">     //</span>
<a href="#l33.1133"></a><span id="l33.1133">     // Need to ditch the file spec here so that we don't delete the</span>
<a href="#l33.1134"></a><span id="l33.1134">     // file, since in this case, the caller wants the file</span>
<a href="#l33.1135"></a><span id="l33.1135">     //</span>
<a href="#l33.1136"></a><span id="l33.1136">     mReturnFile = mTempFile;</span>
<a href="#l33.1137"></a><span id="l33.1137">     mTempFile = nullptr;</span>
<a href="#l33.1138"></a><span id="l33.1138">     if (!mReturnFile)</span>
<a href="#l33.1139"></a><span id="l33.1139" class="difflineminus">-      NotifyListenerOnStopSending(nullptr, NS_ERROR_OUT_OF_MEMORY, nullptr, nullptr);</span>
<a href="#l33.1140"></a><span id="l33.1140" class="difflineminus">-    else</span>
<a href="#l33.1141"></a><span id="l33.1141" class="difflineminus">-    {</span>
<a href="#l33.1142"></a><span id="l33.1142" class="difflineplus">+      NotifyListenerOnStopSending(nullptr, NS_ERROR_OUT_OF_MEMORY, nullptr,</span>
<a href="#l33.1143"></a><span id="l33.1143" class="difflineplus">+                                  nullptr);</span>
<a href="#l33.1144"></a><span id="l33.1144" class="difflineplus">+    else {</span>
<a href="#l33.1145"></a><span id="l33.1145">       NotifyListenerOnStopSending(nullptr, NS_OK, nullptr, mReturnFile);</span>
<a href="#l33.1146"></a><span id="l33.1146">     }</span>
<a href="#l33.1147"></a><span id="l33.1147" class="difflineminus">-  }</span>
<a href="#l33.1148"></a><span id="l33.1148" class="difflineminus">-  else</span>
<a href="#l33.1149"></a><span id="l33.1149" class="difflineminus">-  {</span>
<a href="#l33.1150"></a><span id="l33.1150" class="difflineplus">+  } else {</span>
<a href="#l33.1151"></a><span id="l33.1151">     status = DeliverMessage();</span>
<a href="#l33.1152"></a><span id="l33.1152" class="difflineminus">-    if (NS_SUCCEEDED(status))</span>
<a href="#l33.1153"></a><span id="l33.1153" class="difflineminus">-      shouldDeleteDeliveryState = false;</span>
<a href="#l33.1154"></a><span id="l33.1154" class="difflineplus">+    if (NS_SUCCEEDED(status)) shouldDeleteDeliveryState = false;</span>
<a href="#l33.1155"></a><span id="l33.1155">   }</span>
<a href="#l33.1156"></a><span id="l33.1156">   goto FAIL;</span>
<a href="#l33.1157"></a><span id="l33.1157"> </span>
<a href="#l33.1158"></a><span id="l33.1158"> FAILMEM:</span>
<a href="#l33.1159"></a><span id="l33.1159">   status = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l33.1160"></a><span id="l33.1160"> </span>
<a href="#l33.1161"></a><span id="l33.1161"> FAIL:</span>
<a href="#l33.1162"></a><span id="l33.1162" class="difflineminus">-  if (toppart)</span>
<a href="#l33.1163"></a><span id="l33.1163" class="difflineminus">-    delete toppart;</span>
<a href="#l33.1164"></a><span id="l33.1164" class="difflineplus">+  if (toppart) delete toppart;</span>
<a href="#l33.1165"></a><span id="l33.1165">   toppart = nullptr;</span>
<a href="#l33.1166"></a><span id="l33.1166">   mainbody = nullptr;</span>
<a href="#l33.1167"></a><span id="l33.1167">   maincontainer = nullptr;</span>
<a href="#l33.1168"></a><span id="l33.1168"> </span>
<a href="#l33.1169"></a><span id="l33.1169" class="difflineminus">-  if (in_file)</span>
<a href="#l33.1170"></a><span id="l33.1170" class="difflineminus">-  {</span>
<a href="#l33.1171"></a><span id="l33.1171" class="difflineminus">-    PR_Close (in_file);</span>
<a href="#l33.1172"></a><span id="l33.1172" class="difflineplus">+  if (in_file) {</span>
<a href="#l33.1173"></a><span id="l33.1173" class="difflineplus">+    PR_Close(in_file);</span>
<a href="#l33.1174"></a><span id="l33.1174">     in_file = nullptr;</span>
<a href="#l33.1175"></a><span id="l33.1175">   }</span>
<a href="#l33.1176"></a><span id="l33.1176"> </span>
<a href="#l33.1177"></a><span id="l33.1177" class="difflineminus">-  if (shouldDeleteDeliveryState)</span>
<a href="#l33.1178"></a><span id="l33.1178" class="difflineminus">-  {</span>
<a href="#l33.1179"></a><span id="l33.1179" class="difflineminus">-    if (NS_FAILED(status))</span>
<a href="#l33.1180"></a><span id="l33.1180" class="difflineminus">-    {</span>
<a href="#l33.1181"></a><span id="l33.1181" class="difflineplus">+  if (shouldDeleteDeliveryState) {</span>
<a href="#l33.1182"></a><span id="l33.1182" class="difflineplus">+    if (NS_FAILED(status)) {</span>
<a href="#l33.1183"></a><span id="l33.1183">       m_status = status;</span>
<a href="#l33.1184"></a><span id="l33.1184">       nsresult ignoreMe;</span>
<a href="#l33.1185"></a><span id="l33.1185">       Fail(status, nullptr, &amp;ignoreMe);</span>
<a href="#l33.1186"></a><span id="l33.1186">     }</span>
<a href="#l33.1187"></a><span id="l33.1187">   }</span>
<a href="#l33.1188"></a><span id="l33.1188"> </span>
<a href="#l33.1189"></a><span id="l33.1189">   return status;</span>
<a href="#l33.1190"></a><span id="l33.1190"> }</span>
<a href="#l33.1191"></a><span id="l33.1191"> </span>
<a href="#l33.1192"></a><span id="l33.1192" class="difflineminus">-int32_t</span>
<a href="#l33.1193"></a><span id="l33.1193" class="difflineminus">-nsMsgComposeAndSend::PreProcessPart(nsMsgAttachmentHandler  *ma,</span>
<a href="#l33.1194"></a><span id="l33.1194" class="difflineminus">-                                    nsMsgSendPart           *toppart) // The very top most container of the message</span>
<a href="#l33.1195"></a><span id="l33.1195" class="difflineplus">+int32_t nsMsgComposeAndSend::PreProcessPart(</span>
<a href="#l33.1196"></a><span id="l33.1196" class="difflineplus">+    nsMsgAttachmentHandler *ma,</span>
<a href="#l33.1197"></a><span id="l33.1197" class="difflineplus">+    nsMsgSendPart *toppart)  // The very top most container of the message</span>
<a href="#l33.1198"></a><span id="l33.1198"> {</span>
<a href="#l33.1199"></a><span id="l33.1199" class="difflineminus">-  nsresult        status;</span>
<a href="#l33.1200"></a><span id="l33.1200" class="difflineminus">-  char            *hdrs = 0;</span>
<a href="#l33.1201"></a><span id="l33.1201" class="difflineminus">-  nsMsgSendPart   *part = nullptr;</span>
<a href="#l33.1202"></a><span id="l33.1202" class="difflineplus">+  nsresult status;</span>
<a href="#l33.1203"></a><span id="l33.1203" class="difflineplus">+  char *hdrs = 0;</span>
<a href="#l33.1204"></a><span id="l33.1204" class="difflineplus">+  nsMsgSendPart *part = nullptr;</span>
<a href="#l33.1205"></a><span id="l33.1205"> </span>
<a href="#l33.1206"></a><span id="l33.1206">   // If this was one of those dead parts from a quoted web page,</span>
<a href="#l33.1207"></a><span id="l33.1207">   // then just return safely.</span>
<a href="#l33.1208"></a><span id="l33.1208">   //</span>
<a href="#l33.1209"></a><span id="l33.1209" class="difflineminus">-  if (ma-&gt;m_bogus_attachment)</span>
<a href="#l33.1210"></a><span id="l33.1210" class="difflineminus">-    return 0;</span>
<a href="#l33.1211"></a><span id="l33.1211" class="difflineplus">+  if (ma-&gt;m_bogus_attachment) return 0;</span>
<a href="#l33.1212"></a><span id="l33.1212"> </span>
<a href="#l33.1213"></a><span id="l33.1213">   // If at this point we *still* don't have a content-type, then</span>
<a href="#l33.1214"></a><span id="l33.1214">   // we're never going to get one.</span>
<a href="#l33.1215"></a><span id="l33.1215" class="difflineminus">-  if (ma-&gt;m_type.IsEmpty())</span>
<a href="#l33.1216"></a><span id="l33.1216" class="difflineminus">-    ma-&gt;m_type = UNKNOWN_CONTENT_TYPE;</span>
<a href="#l33.1217"></a><span id="l33.1217" class="difflineplus">+  if (ma-&gt;m_type.IsEmpty()) ma-&gt;m_type = UNKNOWN_CONTENT_TYPE;</span>
<a href="#l33.1218"></a><span id="l33.1218"> </span>
<a href="#l33.1219"></a><span id="l33.1219">   ma-&gt;PickEncoding(mCompFields-&gt;GetCharacterSet(), this);</span>
<a href="#l33.1220"></a><span id="l33.1220">   ma-&gt;PickCharset();</span>
<a href="#l33.1221"></a><span id="l33.1221"> </span>
<a href="#l33.1222"></a><span id="l33.1222">   part = new nsMsgSendPart(this);</span>
<a href="#l33.1223"></a><span id="l33.1223" class="difflineminus">-  if (!part)</span>
<a href="#l33.1224"></a><span id="l33.1224" class="difflineminus">-    return 0;</span>
<a href="#l33.1225"></a><span id="l33.1225" class="difflineplus">+  if (!part) return 0;</span>
<a href="#l33.1226"></a><span id="l33.1226">   status = toppart-&gt;AddChild(part);</span>
<a href="#l33.1227"></a><span id="l33.1227">   // Remember the part number if it has a node index.</span>
<a href="#l33.1228"></a><span id="l33.1228" class="difflineminus">-  if (ma-&gt;mNodeIndex != -1)</span>
<a href="#l33.1229"></a><span id="l33.1229" class="difflineminus">-    m_partNumbers[ma-&gt;mNodeIndex] = part-&gt;m_partNum;</span>
<a href="#l33.1230"></a><span id="l33.1230" class="difflineminus">-</span>
<a href="#l33.1231"></a><span id="l33.1231" class="difflineminus">-  if (NS_FAILED(status))</span>
<a href="#l33.1232"></a><span id="l33.1232" class="difflineminus">-    return 0;</span>
<a href="#l33.1233"></a><span id="l33.1233" class="difflineplus">+  if (ma-&gt;mNodeIndex != -1) m_partNumbers[ma-&gt;mNodeIndex] = part-&gt;m_partNum;</span>
<a href="#l33.1234"></a><span id="l33.1234" class="difflineplus">+</span>
<a href="#l33.1235"></a><span id="l33.1235" class="difflineplus">+  if (NS_FAILED(status)) return 0;</span>
<a href="#l33.1236"></a><span id="l33.1236">   status = part-&gt;SetType(ma-&gt;m_type.get());</span>
<a href="#l33.1237"></a><span id="l33.1237" class="difflineminus">-  if (NS_FAILED(status))</span>
<a href="#l33.1238"></a><span id="l33.1238" class="difflineminus">-    return 0;</span>
<a href="#l33.1239"></a><span id="l33.1239" class="difflineminus">-</span>
<a href="#l33.1240"></a><span id="l33.1240" class="difflineminus">-  if (ma-&gt;mSendViaCloud)</span>
<a href="#l33.1241"></a><span id="l33.1241" class="difflineminus">-    ma-&gt;m_encoding = ENCODING_7BIT;</span>
<a href="#l33.1242"></a><span id="l33.1242" class="difflineplus">+  if (NS_FAILED(status)) return 0;</span>
<a href="#l33.1243"></a><span id="l33.1243" class="difflineplus">+</span>
<a href="#l33.1244"></a><span id="l33.1244" class="difflineplus">+  if (ma-&gt;mSendViaCloud) ma-&gt;m_encoding = ENCODING_7BIT;</span>
<a href="#l33.1245"></a><span id="l33.1245"> </span>
<a href="#l33.1246"></a><span id="l33.1246">   nsCString turl;</span>
<a href="#l33.1247"></a><span id="l33.1247" class="difflineminus">-  if (!ma-&gt;mURL)</span>
<a href="#l33.1248"></a><span id="l33.1248" class="difflineminus">-  {</span>
<a href="#l33.1249"></a><span id="l33.1249" class="difflineminus">-    if (!ma-&gt;m_uri.IsEmpty())</span>
<a href="#l33.1250"></a><span id="l33.1250" class="difflineminus">-      turl = ma-&gt;m_uri;</span>
<a href="#l33.1251"></a><span id="l33.1251" class="difflineminus">-  }</span>
<a href="#l33.1252"></a><span id="l33.1252" class="difflineminus">-  else {</span>
<a href="#l33.1253"></a><span id="l33.1253" class="difflineplus">+  if (!ma-&gt;mURL) {</span>
<a href="#l33.1254"></a><span id="l33.1254" class="difflineplus">+    if (!ma-&gt;m_uri.IsEmpty()) turl = ma-&gt;m_uri;</span>
<a href="#l33.1255"></a><span id="l33.1255" class="difflineplus">+  } else {</span>
<a href="#l33.1256"></a><span id="l33.1256">     status = ma-&gt;mURL-&gt;GetSpec(turl);</span>
<a href="#l33.1257"></a><span id="l33.1257" class="difflineminus">-    if (NS_FAILED(status))</span>
<a href="#l33.1258"></a><span id="l33.1258" class="difflineminus">-      return 0;</span>
<a href="#l33.1259"></a><span id="l33.1259" class="difflineplus">+    if (NS_FAILED(status)) return 0;</span>
<a href="#l33.1260"></a><span id="l33.1260">   }</span>
<a href="#l33.1261"></a><span id="l33.1261"> </span>
<a href="#l33.1262"></a><span id="l33.1262">   nsCString type(ma-&gt;m_type);</span>
<a href="#l33.1263"></a><span id="l33.1263">   nsCString realName(ma-&gt;m_realName);</span>
<a href="#l33.1264"></a><span id="l33.1264"> </span>
<a href="#l33.1265"></a><span id="l33.1265">   // for cloud attachments, make the part an html part with no name,</span>
<a href="#l33.1266"></a><span id="l33.1266">   // so we don't show it as an attachment.</span>
<a href="#l33.1267"></a><span id="l33.1267" class="difflineminus">-  if (ma-&gt;mSendViaCloud)</span>
<a href="#l33.1268"></a><span id="l33.1268" class="difflineminus">-  {</span>
<a href="#l33.1269"></a><span id="l33.1269" class="difflineplus">+  if (ma-&gt;mSendViaCloud) {</span>
<a href="#l33.1270"></a><span id="l33.1270">     type.AssignLiteral(&quot;application/octet-stream&quot;);</span>
<a href="#l33.1271"></a><span id="l33.1271">     realName.Truncate();</span>
<a href="#l33.1272"></a><span id="l33.1272">   }</span>
<a href="#l33.1273"></a><span id="l33.1273" class="difflineminus">-  hdrs = mime_generate_attachment_headers (type.get(),</span>
<a href="#l33.1274"></a><span id="l33.1274" class="difflineminus">-                                           ma-&gt;m_typeParam.get(),</span>
<a href="#l33.1275"></a><span id="l33.1275" class="difflineminus">-                                           ma-&gt;m_encoding.get(),</span>
<a href="#l33.1276"></a><span id="l33.1276" class="difflineminus">-                                           ma-&gt;m_description.get(),</span>
<a href="#l33.1277"></a><span id="l33.1277" class="difflineminus">-                                           ma-&gt;m_xMacType.get(),</span>
<a href="#l33.1278"></a><span id="l33.1278" class="difflineminus">-                                           ma-&gt;m_xMacCreator.get(),</span>
<a href="#l33.1279"></a><span id="l33.1279" class="difflineminus">-                                           realName.get(),</span>
<a href="#l33.1280"></a><span id="l33.1280" class="difflineminus">-                                           turl.get(),</span>
<a href="#l33.1281"></a><span id="l33.1281" class="difflineminus">-                                           m_digest_p,</span>
<a href="#l33.1282"></a><span id="l33.1282" class="difflineminus">-                                           ma,</span>
<a href="#l33.1283"></a><span id="l33.1283" class="difflineminus">-                                           ma-&gt;m_charset.get(), // rhp - this needs</span>
<a href="#l33.1284"></a><span id="l33.1284" class="difflineminus">-                                                          // to be the charset</span>
<a href="#l33.1285"></a><span id="l33.1285" class="difflineminus">-                                                          // we determine from</span>
<a href="#l33.1286"></a><span id="l33.1286" class="difflineminus">-                                                          // the file or none</span>
<a href="#l33.1287"></a><span id="l33.1287" class="difflineminus">-                                                          // at all!</span>
<a href="#l33.1288"></a><span id="l33.1288" class="difflineminus">-                                           mCompFields-&gt;GetCharacterSet(),</span>
<a href="#l33.1289"></a><span id="l33.1289" class="difflineminus">-                                           false,      // bodyIsAsciiOnly to false</span>
<a href="#l33.1290"></a><span id="l33.1290" class="difflineminus">-                                                          // for attachments</span>
<a href="#l33.1291"></a><span id="l33.1291" class="difflineminus">-                                           ma-&gt;m_contentId.get(),</span>
<a href="#l33.1292"></a><span id="l33.1292" class="difflineminus">-                                           false);</span>
<a href="#l33.1293"></a><span id="l33.1293" class="difflineminus">-  if (!hdrs)</span>
<a href="#l33.1294"></a><span id="l33.1294" class="difflineminus">-    return 0;</span>
<a href="#l33.1295"></a><span id="l33.1295" class="difflineplus">+  hdrs = mime_generate_attachment_headers(</span>
<a href="#l33.1296"></a><span id="l33.1296" class="difflineplus">+      type.get(), ma-&gt;m_typeParam.get(), ma-&gt;m_encoding.get(),</span>
<a href="#l33.1297"></a><span id="l33.1297" class="difflineplus">+      ma-&gt;m_description.get(), ma-&gt;m_xMacType.get(), ma-&gt;m_xMacCreator.get(),</span>
<a href="#l33.1298"></a><span id="l33.1298" class="difflineplus">+      realName.get(), turl.get(), m_digest_p, ma,</span>
<a href="#l33.1299"></a><span id="l33.1299" class="difflineplus">+      ma-&gt;m_charset.get(),  // rhp - this needs</span>
<a href="#l33.1300"></a><span id="l33.1300" class="difflineplus">+                            // to be the charset</span>
<a href="#l33.1301"></a><span id="l33.1301" class="difflineplus">+                            // we determine from</span>
<a href="#l33.1302"></a><span id="l33.1302" class="difflineplus">+                            // the file or none</span>
<a href="#l33.1303"></a><span id="l33.1303" class="difflineplus">+                            // at all!</span>
<a href="#l33.1304"></a><span id="l33.1304" class="difflineplus">+      mCompFields-&gt;GetCharacterSet(),</span>
<a href="#l33.1305"></a><span id="l33.1305" class="difflineplus">+      false,  // bodyIsAsciiOnly to false</span>
<a href="#l33.1306"></a><span id="l33.1306" class="difflineplus">+              // for attachments</span>
<a href="#l33.1307"></a><span id="l33.1307" class="difflineplus">+      ma-&gt;m_contentId.get(), false);</span>
<a href="#l33.1308"></a><span id="l33.1308" class="difflineplus">+  if (!hdrs) return 0;</span>
<a href="#l33.1309"></a><span id="l33.1309"> </span>
<a href="#l33.1310"></a><span id="l33.1310">   status = part-&gt;SetOtherHeaders(hdrs);</span>
<a href="#l33.1311"></a><span id="l33.1311">   PR_FREEIF(hdrs);</span>
<a href="#l33.1312"></a><span id="l33.1312" class="difflineminus">-  if (ma-&gt;mSendViaCloud)</span>
<a href="#l33.1313"></a><span id="l33.1313" class="difflineminus">-  {</span>
<a href="#l33.1314"></a><span id="l33.1314" class="difflineplus">+  if (ma-&gt;mSendViaCloud) {</span>
<a href="#l33.1315"></a><span id="l33.1315">     nsCString urlSpec;</span>
<a href="#l33.1316"></a><span id="l33.1316">     status = ma-&gt;mURL-&gt;GetSpec(urlSpec);</span>
<a href="#l33.1317"></a><span id="l33.1317" class="difflineminus">-    if (NS_FAILED(status))</span>
<a href="#l33.1318"></a><span id="l33.1318" class="difflineminus">-      return 0;</span>
<a href="#l33.1319"></a><span id="l33.1319" class="difflineplus">+    if (NS_FAILED(status)) return 0;</span>
<a href="#l33.1320"></a><span id="l33.1320"> </span>
<a href="#l33.1321"></a><span id="l33.1321">     // Need to add some headers so that libmime can restore the cloud info</span>
<a href="#l33.1322"></a><span id="l33.1322">     // when loading a draft message.</span>
<a href="#l33.1323"></a><span id="l33.1323" class="difflineminus">-    nsCString draftInfo(HEADER_X_MOZILLA_CLOUD_PART&quot;: cloudFile; url=&quot;);</span>
<a href="#l33.1324"></a><span id="l33.1324" class="difflineplus">+    nsCString draftInfo(HEADER_X_MOZILLA_CLOUD_PART &quot;: cloudFile; url=&quot;);</span>
<a href="#l33.1325"></a><span id="l33.1325">     draftInfo.Append(ma-&gt;mCloudUrl.get());</span>
<a href="#l33.1326"></a><span id="l33.1326">     // don't leak user file paths or account keys to recipients.</span>
<a href="#l33.1327"></a><span id="l33.1327" class="difflineminus">-    if (m_deliver_mode == nsMsgSaveAsDraft)</span>
<a href="#l33.1328"></a><span id="l33.1328" class="difflineminus">-    {</span>
<a href="#l33.1329"></a><span id="l33.1329" class="difflineplus">+    if (m_deliver_mode == nsMsgSaveAsDraft) {</span>
<a href="#l33.1330"></a><span id="l33.1330">       draftInfo.AppendLiteral(&quot;; provider=&quot;);</span>
<a href="#l33.1331"></a><span id="l33.1331">       draftInfo.Append(ma-&gt;mCloudFileAccountKey.get());</span>
<a href="#l33.1332"></a><span id="l33.1332">       draftInfo.AppendLiteral(&quot;; file=&quot;);</span>
<a href="#l33.1333"></a><span id="l33.1333">       draftInfo.Append(urlSpec.get());</span>
<a href="#l33.1334"></a><span id="l33.1334">     }</span>
<a href="#l33.1335"></a><span id="l33.1335">     draftInfo.AppendLiteral(&quot;; name=&quot;);</span>
<a href="#l33.1336"></a><span id="l33.1336">     draftInfo.Append(ma-&gt;m_realName.get());</span>
<a href="#l33.1337"></a><span id="l33.1337">     draftInfo.Append(CRLF);</span>
<a href="#l33.1338"></a><span id="l33.1338">     part-&gt;AppendOtherHeaders(draftInfo.get());</span>
<a href="#l33.1339"></a><span id="l33.1339">     part-&gt;SetType(&quot;application/octet-stream&quot;);</span>
<a href="#l33.1340"></a><span id="l33.1340">     part-&gt;SetBuffer(&quot;&quot;);</span>
<a href="#l33.1341"></a><span id="l33.1341">   }</span>
<a href="#l33.1342"></a><span id="l33.1342" class="difflineminus">-  if (NS_FAILED(status))</span>
<a href="#l33.1343"></a><span id="l33.1343" class="difflineminus">-    return 0;</span>
<a href="#l33.1344"></a><span id="l33.1344" class="difflineplus">+  if (NS_FAILED(status)) return 0;</span>
<a href="#l33.1345"></a><span id="l33.1345">   status = part-&gt;SetFile(ma-&gt;mTmpFile);</span>
<a href="#l33.1346"></a><span id="l33.1346" class="difflineminus">-  if (NS_FAILED(status))</span>
<a href="#l33.1347"></a><span id="l33.1347" class="difflineminus">-    return 0;</span>
<a href="#l33.1348"></a><span id="l33.1348" class="difflineminus">-  if (ma-&gt;m_encoder)</span>
<a href="#l33.1349"></a><span id="l33.1349" class="difflineminus">-  {</span>
<a href="#l33.1350"></a><span id="l33.1350" class="difflineplus">+  if (NS_FAILED(status)) return 0;</span>
<a href="#l33.1351"></a><span id="l33.1351" class="difflineplus">+  if (ma-&gt;m_encoder) {</span>
<a href="#l33.1352"></a><span id="l33.1352">     part-&gt;SetEncoder(ma-&gt;m_encoder.forget());</span>
<a href="#l33.1353"></a><span id="l33.1353">   }</span>
<a href="#l33.1354"></a><span id="l33.1354"> </span>
<a href="#l33.1355"></a><span id="l33.1355">   ma-&gt;m_current_column = 0;</span>
<a href="#l33.1356"></a><span id="l33.1356"> </span>
<a href="#l33.1357"></a><span id="l33.1357">   if (ma-&gt;m_type.LowerCaseEqualsLiteral(MESSAGE_RFC822) ||</span>
<a href="#l33.1358"></a><span id="l33.1358">       ma-&gt;m_type.LowerCaseEqualsLiteral(MESSAGE_NEWS)) {</span>
<a href="#l33.1359"></a><span id="l33.1359">     part-&gt;SetStripSensitiveHeaders(true);</span>
<a href="#l33.1360"></a><span id="l33.1360">   }</span>
<a href="#l33.1361"></a><span id="l33.1361"> </span>
<a href="#l33.1362"></a><span id="l33.1362">   return 1;</span>
<a href="#l33.1363"></a><span id="l33.1363"> }</span>
<a href="#l33.1364"></a><span id="l33.1364"> </span>
<a href="#l33.1365"></a><span id="l33.1365" class="difflineminus">-# define FROB(X) \</span>
<a href="#l33.1366"></a><span id="l33.1366" class="difflineminus">-    if (X &amp;&amp; *X) \</span>
<a href="#l33.1367"></a><span id="l33.1367" class="difflineminus">-    { \</span>
<a href="#l33.1368"></a><span id="l33.1368" class="difflineminus">-      if (*recipients) PL_strcat(recipients, &quot;,&quot;); \</span>
<a href="#l33.1369"></a><span id="l33.1369" class="difflineminus">-      PL_strcat(recipients, X); \</span>
<a href="#l33.1370"></a><span id="l33.1370" class="difflineminus">-    }</span>
<a href="#l33.1371"></a><span id="l33.1371" class="difflineminus">-</span>
<a href="#l33.1372"></a><span id="l33.1372" class="difflineminus">-nsresult nsMsgComposeAndSend::BeginCryptoEncapsulation ()</span>
<a href="#l33.1373"></a><span id="l33.1373" class="difflineminus">-{</span>
<a href="#l33.1374"></a><span id="l33.1374" class="difflineminus">-  // Try to create a secure compose object. If we can create it, then query to see</span>
<a href="#l33.1375"></a><span id="l33.1375" class="difflineminus">-  // if we need to use it for this send transaction.</span>
<a href="#l33.1376"></a><span id="l33.1376" class="difflineplus">+#define FROB(X)                                  \</span>
<a href="#l33.1377"></a><span id="l33.1377" class="difflineplus">+  if (X &amp;&amp; *X) {                                 \</span>
<a href="#l33.1378"></a><span id="l33.1378" class="difflineplus">+    if (*recipients) PL_strcat(recipients, &quot;,&quot;); \</span>
<a href="#l33.1379"></a><span id="l33.1379" class="difflineplus">+    PL_strcat(recipients, X);                    \</span>
<a href="#l33.1380"></a><span id="l33.1380" class="difflineplus">+  }</span>
<a href="#l33.1381"></a><span id="l33.1381" class="difflineplus">+</span>
<a href="#l33.1382"></a><span id="l33.1382" class="difflineplus">+nsresult nsMsgComposeAndSend::BeginCryptoEncapsulation() {</span>
<a href="#l33.1383"></a><span id="l33.1383" class="difflineplus">+  // Try to create a secure compose object. If we can create it, then query to</span>
<a href="#l33.1384"></a><span id="l33.1384" class="difflineplus">+  // see if we need to use it for this send transaction.</span>
<a href="#l33.1385"></a><span id="l33.1385"> </span>
<a href="#l33.1386"></a><span id="l33.1386">   nsresult rv = NS_OK;</span>
<a href="#l33.1387"></a><span id="l33.1387">   nsCOMPtr&lt;nsIMsgComposeSecure&gt; secureCompose;</span>
<a href="#l33.1388"></a><span id="l33.1388">   rv = mCompFields-&gt;GetComposeSecure(getter_AddRefs(secureCompose));</span>
<a href="#l33.1389"></a><span id="l33.1389">   // it's not an error scenario of there is secure compose</span>
<a href="#l33.1390"></a><span id="l33.1390" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l33.1391"></a><span id="l33.1391" class="difflineminus">-    return NS_OK;</span>
<a href="#l33.1392"></a><span id="l33.1392" class="difflineminus">-</span>
<a href="#l33.1393"></a><span id="l33.1393" class="difflineminus">-  if (secureCompose)</span>
<a href="#l33.1394"></a><span id="l33.1394" class="difflineminus">-  {</span>
<a href="#l33.1395"></a><span id="l33.1395" class="difflineplus">+  if (NS_FAILED(rv)) return NS_OK;</span>
<a href="#l33.1396"></a><span id="l33.1396" class="difflineplus">+</span>
<a href="#l33.1397"></a><span id="l33.1397" class="difflineplus">+  if (secureCompose) {</span>
<a href="#l33.1398"></a><span id="l33.1398">     bool requiresEncryptionWork = false;</span>
<a href="#l33.1399"></a><span id="l33.1399" class="difflineminus">-    secureCompose-&gt;RequiresCryptoEncapsulation(mUserIdentity, mCompFields, &amp;requiresEncryptionWork);</span>
<a href="#l33.1400"></a><span id="l33.1400" class="difflineminus">-    if (requiresEncryptionWork)</span>
<a href="#l33.1401"></a><span id="l33.1401" class="difflineminus">-    {</span>
<a href="#l33.1402"></a><span id="l33.1402" class="difflineplus">+    secureCompose-&gt;RequiresCryptoEncapsulation(mUserIdentity, mCompFields,</span>
<a href="#l33.1403"></a><span id="l33.1403" class="difflineplus">+                                               &amp;requiresEncryptionWork);</span>
<a href="#l33.1404"></a><span id="l33.1404" class="difflineplus">+    if (requiresEncryptionWork) {</span>
<a href="#l33.1405"></a><span id="l33.1405">       m_crypto_closure = secureCompose;</span>
<a href="#l33.1406"></a><span id="l33.1406" class="difflineminus">-      // bah i'd like to move the following blurb into the implementation of BeginCryptoEncapsulation; however</span>
<a href="#l33.1407"></a><span id="l33.1407" class="difflineminus">-      // the apis for nsIMsgComposeField just aren't rich enough. It requires the implementor to jump through way</span>
<a href="#l33.1408"></a><span id="l33.1408" class="difflineminus">-      // too many string conversions....</span>
<a href="#l33.1409"></a><span id="l33.1409" class="difflineminus">-      char * recipients = (char *)</span>
<a href="#l33.1410"></a><span id="l33.1410" class="difflineminus">-      PR_MALLOC((mCompFields-&gt;GetTo()  ? strlen(mCompFields-&gt;GetTo())  : 0) +</span>
<a href="#l33.1411"></a><span id="l33.1411" class="difflineminus">-         (mCompFields-&gt;GetCc()  ? strlen(mCompFields-&gt;GetCc())  : 0) +</span>
<a href="#l33.1412"></a><span id="l33.1412" class="difflineminus">-         (mCompFields-&gt;GetBcc() ? strlen(mCompFields-&gt;GetBcc()) : 0) +</span>
<a href="#l33.1413"></a><span id="l33.1413" class="difflineminus">-         (mCompFields-&gt;GetNewsgroups() ? strlen(mCompFields-&gt;GetNewsgroups()) : 0) + 20);</span>
<a href="#l33.1414"></a><span id="l33.1414" class="difflineplus">+      // bah i'd like to move the following blurb into the implementation of</span>
<a href="#l33.1415"></a><span id="l33.1415" class="difflineplus">+      // BeginCryptoEncapsulation; however the apis for nsIMsgComposeField just</span>
<a href="#l33.1416"></a><span id="l33.1416" class="difflineplus">+      // aren't rich enough. It requires the implementor to jump through way too</span>
<a href="#l33.1417"></a><span id="l33.1417" class="difflineplus">+      // many string conversions....</span>
<a href="#l33.1418"></a><span id="l33.1418" class="difflineplus">+      char *recipients = (char *)PR_MALLOC(</span>
<a href="#l33.1419"></a><span id="l33.1419" class="difflineplus">+          (mCompFields-&gt;GetTo() ? strlen(mCompFields-&gt;GetTo()) : 0) +</span>
<a href="#l33.1420"></a><span id="l33.1420" class="difflineplus">+          (mCompFields-&gt;GetCc() ? strlen(mCompFields-&gt;GetCc()) : 0) +</span>
<a href="#l33.1421"></a><span id="l33.1421" class="difflineplus">+          (mCompFields-&gt;GetBcc() ? strlen(mCompFields-&gt;GetBcc()) : 0) +</span>
<a href="#l33.1422"></a><span id="l33.1422" class="difflineplus">+          (mCompFields-&gt;GetNewsgroups() ? strlen(mCompFields-&gt;GetNewsgroups())</span>
<a href="#l33.1423"></a><span id="l33.1423" class="difflineplus">+                                        : 0) +</span>
<a href="#l33.1424"></a><span id="l33.1424" class="difflineplus">+          20);</span>
<a href="#l33.1425"></a><span id="l33.1425">       if (!recipients) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l33.1426"></a><span id="l33.1426"> </span>
<a href="#l33.1427"></a><span id="l33.1427">       *recipients = 0;</span>
<a href="#l33.1428"></a><span id="l33.1428"> </span>
<a href="#l33.1429"></a><span id="l33.1429">       FROB(mCompFields-&gt;GetTo())</span>
<a href="#l33.1430"></a><span id="l33.1430">       FROB(mCompFields-&gt;GetCc())</span>
<a href="#l33.1431"></a><span id="l33.1431">       FROB(mCompFields-&gt;GetBcc())</span>
<a href="#l33.1432"></a><span id="l33.1432">       FROB(mCompFields-&gt;GetNewsgroups())</span>
<a href="#l33.1433"></a><span id="l33.1433"> </span>
<a href="#l33.1434"></a><span id="l33.1434">       // end section of code I'd like to move to the implementor.....</span>
<a href="#l33.1435"></a><span id="l33.1435" class="difflineminus">-      rv = m_crypto_closure-&gt;BeginCryptoEncapsulation(mOutputFile,</span>
<a href="#l33.1436"></a><span id="l33.1436" class="difflineminus">-                                                      recipients,</span>
<a href="#l33.1437"></a><span id="l33.1437" class="difflineminus">-                                                      mCompFields,</span>
<a href="#l33.1438"></a><span id="l33.1438" class="difflineminus">-                                                      mUserIdentity,</span>
<a href="#l33.1439"></a><span id="l33.1439" class="difflineminus">-                                                      mSendReport,</span>
<a href="#l33.1440"></a><span id="l33.1440" class="difflineminus">-                                                      (m_deliver_mode == nsMsgSaveAsDraft));</span>
<a href="#l33.1441"></a><span id="l33.1441" class="difflineplus">+      rv = m_crypto_closure-&gt;BeginCryptoEncapsulation(</span>
<a href="#l33.1442"></a><span id="l33.1442" class="difflineplus">+          mOutputFile, recipients, mCompFields, mUserIdentity, mSendReport,</span>
<a href="#l33.1443"></a><span id="l33.1443" class="difflineplus">+          (m_deliver_mode == nsMsgSaveAsDraft));</span>
<a href="#l33.1444"></a><span id="l33.1444"> </span>
<a href="#l33.1445"></a><span id="l33.1445">       PR_FREEIF(recipients);</span>
<a href="#l33.1446"></a><span id="l33.1446">     }</span>
<a href="#l33.1447"></a><span id="l33.1447" class="difflineminus">-</span>
<a href="#l33.1448"></a><span id="l33.1448">   }</span>
<a href="#l33.1449"></a><span id="l33.1449"> </span>
<a href="#l33.1450"></a><span id="l33.1450">   return rv;</span>
<a href="#l33.1451"></a><span id="l33.1451"> }</span>
<a href="#l33.1452"></a><span id="l33.1452"> </span>
<a href="#l33.1453"></a><span id="l33.1453" class="difflineminus">-nsresult</span>
<a href="#l33.1454"></a><span id="l33.1454" class="difflineminus">-mime_write_message_body(nsIMsgSend *state, const char *buf, uint32_t size)</span>
<a href="#l33.1455"></a><span id="l33.1455" class="difflineminus">-{</span>
<a href="#l33.1456"></a><span id="l33.1456" class="difflineplus">+nsresult mime_write_message_body(nsIMsgSend *state, const char *buf,</span>
<a href="#l33.1457"></a><span id="l33.1457" class="difflineplus">+                                 uint32_t size) {</span>
<a href="#l33.1458"></a><span id="l33.1458">   NS_ENSURE_ARG_POINTER(state);</span>
<a href="#l33.1459"></a><span id="l33.1459"> </span>
<a href="#l33.1460"></a><span id="l33.1460">   nsCOMPtr&lt;nsIOutputStream&gt; output;</span>
<a href="#l33.1461"></a><span id="l33.1461">   nsCOMPtr&lt;nsIMsgComposeSecure&gt; crypto_closure;</span>
<a href="#l33.1462"></a><span id="l33.1462"> </span>
<a href="#l33.1463"></a><span id="l33.1463">   state-&gt;GetOutputStream(getter_AddRefs(output));</span>
<a href="#l33.1464"></a><span id="l33.1464" class="difflineminus">-  if (!output)</span>
<a href="#l33.1465"></a><span id="l33.1465" class="difflineminus">-    return NS_MSG_ERROR_WRITING_FILE;</span>
<a href="#l33.1466"></a><span id="l33.1466" class="difflineplus">+  if (!output) return NS_MSG_ERROR_WRITING_FILE;</span>
<a href="#l33.1467"></a><span id="l33.1467"> </span>
<a href="#l33.1468"></a><span id="l33.1468">   state-&gt;GetCryptoclosure(getter_AddRefs(crypto_closure));</span>
<a href="#l33.1469"></a><span id="l33.1469" class="difflineminus">-  if (crypto_closure)</span>
<a href="#l33.1470"></a><span id="l33.1470" class="difflineminus">-  {</span>
<a href="#l33.1471"></a><span id="l33.1471" class="difflineplus">+  if (crypto_closure) {</span>
<a href="#l33.1472"></a><span id="l33.1472">     // Copy to new null-terminated string so JS glue doesn't crash when</span>
<a href="#l33.1473"></a><span id="l33.1473">     // MimeCryptoWriteBlock() is implemented in JS.</span>
<a href="#l33.1474"></a><span id="l33.1474">     nsCString bufWithNull;</span>
<a href="#l33.1475"></a><span id="l33.1475">     bufWithNull.Assign(buf, size);</span>
<a href="#l33.1476"></a><span id="l33.1476">     return crypto_closure-&gt;MimeCryptoWriteBlock(bufWithNull.get(), size);</span>
<a href="#l33.1477"></a><span id="l33.1477">   }</span>
<a href="#l33.1478"></a><span id="l33.1478"> </span>
<a href="#l33.1479"></a><span id="l33.1479">   uint32_t n;</span>
<a href="#l33.1480"></a><span id="l33.1480">   nsresult rv = output-&gt;Write(buf, size, &amp;n);</span>
<a href="#l33.1481"></a><span id="l33.1481" class="difflineminus">-  if (NS_FAILED(rv) || n != size)</span>
<a href="#l33.1482"></a><span id="l33.1482" class="difflineminus">-  {</span>
<a href="#l33.1483"></a><span id="l33.1483" class="difflineplus">+  if (NS_FAILED(rv) || n != size) {</span>
<a href="#l33.1484"></a><span id="l33.1484">     return NS_MSG_ERROR_WRITING_FILE;</span>
<a href="#l33.1485"></a><span id="l33.1485">   }</span>
<a href="#l33.1486"></a><span id="l33.1486"> </span>
<a href="#l33.1487"></a><span id="l33.1487">   return NS_OK;</span>
<a href="#l33.1488"></a><span id="l33.1488"> }</span>
<a href="#l33.1489"></a><span id="l33.1489"> </span>
<a href="#l33.1490"></a><span id="l33.1490" class="difflineminus">-nsresult</span>
<a href="#l33.1491"></a><span id="l33.1491" class="difflineminus">-mime_encoder_output_fn(const char *buf, int32_t size, void *closure)</span>
<a href="#l33.1492"></a><span id="l33.1492" class="difflineminus">-{</span>
<a href="#l33.1493"></a><span id="l33.1493" class="difflineminus">-  nsMsgComposeAndSend *state = (nsMsgComposeAndSend *) closure;</span>
<a href="#l33.1494"></a><span id="l33.1494" class="difflineminus">-  return mime_write_message_body (state, (char *) buf, (uint32_t)size);</span>
<a href="#l33.1495"></a><span id="l33.1495" class="difflineplus">+nsresult mime_encoder_output_fn(const char *buf, int32_t size, void *closure) {</span>
<a href="#l33.1496"></a><span id="l33.1496" class="difflineplus">+  nsMsgComposeAndSend *state = (nsMsgComposeAndSend *)closure;</span>
<a href="#l33.1497"></a><span id="l33.1497" class="difflineplus">+  return mime_write_message_body(state, (char *)buf, (uint32_t)size);</span>
<a href="#l33.1498"></a><span id="l33.1498"> }</span>
<a href="#l33.1499"></a><span id="l33.1499"> </span>
<a href="#l33.1500"></a><span id="l33.1500" class="difflineminus">-nsresult</span>
<a href="#l33.1501"></a><span id="l33.1501" class="difflineminus">-nsMsgComposeAndSend::GetEmbeddedObjectInfo(Element *domElement, nsMsgAttachmentData *attachment, bool *acceptObject)</span>
<a href="#l33.1502"></a><span id="l33.1502" class="difflineminus">-{</span>
<a href="#l33.1503"></a><span id="l33.1503" class="difflineplus">+nsresult nsMsgComposeAndSend::GetEmbeddedObjectInfo(</span>
<a href="#l33.1504"></a><span id="l33.1504" class="difflineplus">+    Element *domElement, nsMsgAttachmentData *attachment, bool *acceptObject) {</span>
<a href="#l33.1505"></a><span id="l33.1505">   NS_ENSURE_ARG_POINTER(domElement);</span>
<a href="#l33.1506"></a><span id="l33.1506">   NS_ENSURE_ARG_POINTER(attachment);</span>
<a href="#l33.1507"></a><span id="l33.1507">   NS_ENSURE_ARG_POINTER(acceptObject);</span>
<a href="#l33.1508"></a><span id="l33.1508"> </span>
<a href="#l33.1509"></a><span id="l33.1509">   // GetEmbeddedObjectInfo will determine if we need to attach the source of the</span>
<a href="#l33.1510"></a><span id="l33.1510">   // embedded object with the message. The decision is made automatically unless</span>
<a href="#l33.1511"></a><span id="l33.1511">   // the attribute moz-do-not-send has been set to true or false.</span>
<a href="#l33.1512"></a><span id="l33.1512">   nsresult rv = NS_OK;</span>
<a href="#l33.1513"></a><span id="l33.1513"> </span>
<a href="#l33.1514"></a><span id="l33.1514">   // Reset this structure to null!</span>
<a href="#l33.1515"></a><span id="l33.1515">   *acceptObject = false;</span>
<a href="#l33.1516"></a><span id="l33.1516"> </span>
<a href="#l33.1517"></a><span id="l33.1517">   bool isImage = false;</span>
<a href="#l33.1518"></a><span id="l33.1518">   nsAutoString mozDoNotSendAttr;</span>
<a href="#l33.1519"></a><span id="l33.1519" class="difflineminus">-  domElement-&gt;GetAttribute(NS_LITERAL_STRING(ATTR_MOZ_DO_NOT_SEND), mozDoNotSendAttr);</span>
<a href="#l33.1520"></a><span id="l33.1520" class="difflineplus">+  domElement-&gt;GetAttribute(NS_LITERAL_STRING(ATTR_MOZ_DO_NOT_SEND),</span>
<a href="#l33.1521"></a><span id="l33.1521" class="difflineplus">+                           mozDoNotSendAttr);</span>
<a href="#l33.1522"></a><span id="l33.1522"> </span>
<a href="#l33.1523"></a><span id="l33.1523">   // Only empty or moz-do-not-send=&quot;false&quot; may be accepted later.</span>
<a href="#l33.1524"></a><span id="l33.1524" class="difflineminus">-  if (!(mozDoNotSendAttr.IsEmpty() || mozDoNotSendAttr.LowerCaseEqualsLiteral(&quot;false&quot;)))</span>
<a href="#l33.1525"></a><span id="l33.1525" class="difflineplus">+  if (!(mozDoNotSendAttr.IsEmpty() ||</span>
<a href="#l33.1526"></a><span id="l33.1526" class="difflineplus">+        mozDoNotSendAttr.LowerCaseEqualsLiteral(&quot;false&quot;)))</span>
<a href="#l33.1527"></a><span id="l33.1527">     return NS_OK;</span>
<a href="#l33.1528"></a><span id="l33.1528"> </span>
<a href="#l33.1529"></a><span id="l33.1529">   // We're only interested in body, image, link and anchors which are all</span>
<a href="#l33.1530"></a><span id="l33.1530">   // elements. Let's see what we have.</span>
<a href="#l33.1531"></a><span id="l33.1531" class="difflineminus">-  RefPtr&lt;HTMLImageElement&gt;  image  = HTMLImageElement::FromNode(domElement);</span>
<a href="#l33.1532"></a><span id="l33.1532" class="difflineplus">+  RefPtr&lt;HTMLImageElement&gt; image = HTMLImageElement::FromNode(domElement);</span>
<a href="#l33.1533"></a><span id="l33.1533">   RefPtr&lt;HTMLAnchorElement&gt; anchor = HTMLAnchorElement::FromNode(domElement);</span>
<a href="#l33.1534"></a><span id="l33.1534" class="difflineminus">-  RefPtr&lt;HTMLBodyElement&gt;   body   = HTMLBodyElement::FromNode(domElement);</span>
<a href="#l33.1535"></a><span id="l33.1535" class="difflineplus">+  RefPtr&lt;HTMLBodyElement&gt; body = HTMLBodyElement::FromNode(domElement);</span>
<a href="#l33.1536"></a><span id="l33.1536"> </span>
<a href="#l33.1537"></a><span id="l33.1537">   // First, try to see if the body as a background image</span>
<a href="#l33.1538"></a><span id="l33.1538" class="difflineminus">-  if (body)</span>
<a href="#l33.1539"></a><span id="l33.1539" class="difflineminus">-  {</span>
<a href="#l33.1540"></a><span id="l33.1540" class="difflineplus">+  if (body) {</span>
<a href="#l33.1541"></a><span id="l33.1541">     nsString tUrl;</span>
<a href="#l33.1542"></a><span id="l33.1542">     body-&gt;GetBackground(tUrl);</span>
<a href="#l33.1543"></a><span id="l33.1543" class="difflineminus">-    if (tUrl.IsEmpty())</span>
<a href="#l33.1544"></a><span id="l33.1544" class="difflineminus">-      return NS_OK;</span>
<a href="#l33.1545"></a><span id="l33.1545" class="difflineplus">+    if (tUrl.IsEmpty()) return NS_OK;</span>
<a href="#l33.1546"></a><span id="l33.1546">     nsAutoCString turlC;</span>
<a href="#l33.1547"></a><span id="l33.1547">     CopyUTF16toUTF8(tUrl, turlC);</span>
<a href="#l33.1548"></a><span id="l33.1548">     if (NS_FAILED(nsMsgNewURL(getter_AddRefs(attachment-&gt;m_url), turlC)))</span>
<a href="#l33.1549"></a><span id="l33.1549">       return NS_OK;</span>
<a href="#l33.1550"></a><span id="l33.1550">     isImage = true;</span>
<a href="#l33.1551"></a><span id="l33.1551" class="difflineminus">-  }</span>
<a href="#l33.1552"></a><span id="l33.1552" class="difflineminus">-  else if (image)        // Is this an image?</span>
<a href="#l33.1553"></a><span id="l33.1553" class="difflineplus">+  } else if (image)  // Is this an image?</span>
<a href="#l33.1554"></a><span id="l33.1554">   {</span>
<a href="#l33.1555"></a><span id="l33.1555" class="difflineminus">-    nsString    tUrl;</span>
<a href="#l33.1556"></a><span id="l33.1556" class="difflineminus">-    nsString    tName;</span>
<a href="#l33.1557"></a><span id="l33.1557" class="difflineminus">-    nsString    tDesc;</span>
<a href="#l33.1558"></a><span id="l33.1558" class="difflineplus">+    nsString tUrl;</span>
<a href="#l33.1559"></a><span id="l33.1559" class="difflineplus">+    nsString tName;</span>
<a href="#l33.1560"></a><span id="l33.1560" class="difflineplus">+    nsString tDesc;</span>
<a href="#l33.1561"></a><span id="l33.1561"> </span>
<a href="#l33.1562"></a><span id="l33.1562">     // Create the URI</span>
<a href="#l33.1563"></a><span id="l33.1563">     image-&gt;GetSrc(tUrl);</span>
<a href="#l33.1564"></a><span id="l33.1564" class="difflineminus">-    if (tUrl.IsEmpty())</span>
<a href="#l33.1565"></a><span id="l33.1565" class="difflineminus">-      return NS_OK;</span>
<a href="#l33.1566"></a><span id="l33.1566" class="difflineplus">+    if (tUrl.IsEmpty()) return NS_OK;</span>
<a href="#l33.1567"></a><span id="l33.1567"> </span>
<a href="#l33.1568"></a><span id="l33.1568">     nsAutoCString turlC;</span>
<a href="#l33.1569"></a><span id="l33.1569">     CopyUTF16toUTF8(tUrl, turlC);</span>
<a href="#l33.1570"></a><span id="l33.1570" class="difflineminus">-    if (NS_FAILED(nsMsgNewURL(getter_AddRefs(attachment-&gt;m_url), turlC)))</span>
<a href="#l33.1571"></a><span id="l33.1571" class="difflineminus">-    {</span>
<a href="#l33.1572"></a><span id="l33.1572" class="difflineplus">+    if (NS_FAILED(nsMsgNewURL(getter_AddRefs(attachment-&gt;m_url), turlC))) {</span>
<a href="#l33.1573"></a><span id="l33.1573">       // Well, the first time failed...which means we probably didn't get</span>
<a href="#l33.1574"></a><span id="l33.1574">       // the full path name...</span>
<a href="#l33.1575"></a><span id="l33.1575">       nsAutoCString spec;</span>
<a href="#l33.1576"></a><span id="l33.1576">       rv = image-&gt;OwnerDoc()-&gt;GetDocumentURI()-&gt;GetSpec(spec);</span>
<a href="#l33.1577"></a><span id="l33.1577">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l33.1578"></a><span id="l33.1578"> </span>
<a href="#l33.1579"></a><span id="l33.1579">       // Ok, now get the path to the root doc and tack on the name we</span>
<a href="#l33.1580"></a><span id="l33.1580">       // got from the GetSrc() call....</span>
<a href="#l33.1581"></a><span id="l33.1581">       NS_ConvertUTF8toUTF16 workURL(spec);</span>
<a href="#l33.1582"></a><span id="l33.1582"> </span>
<a href="#l33.1583"></a><span id="l33.1583">       int32_t loc = workURL.RFindChar('/');</span>
<a href="#l33.1584"></a><span id="l33.1584" class="difflineminus">-      if (loc &gt;= 0)</span>
<a href="#l33.1585"></a><span id="l33.1585" class="difflineminus">-        workURL.SetLength(loc+1);</span>
<a href="#l33.1586"></a><span id="l33.1586" class="difflineplus">+      if (loc &gt;= 0) workURL.SetLength(loc + 1);</span>
<a href="#l33.1587"></a><span id="l33.1587">       workURL.Append(tUrl);</span>
<a href="#l33.1588"></a><span id="l33.1588">       NS_ConvertUTF16toUTF8 workurlC(workURL);</span>
<a href="#l33.1589"></a><span id="l33.1589">       if (NS_FAILED(nsMsgNewURL(getter_AddRefs(attachment-&gt;m_url), workurlC)))</span>
<a href="#l33.1590"></a><span id="l33.1590" class="difflineminus">-        return NS_OK; // Continue and send it without this image.</span>
<a href="#l33.1591"></a><span id="l33.1591" class="difflineplus">+        return NS_OK;  // Continue and send it without this image.</span>
<a href="#l33.1592"></a><span id="l33.1592">     }</span>
<a href="#l33.1593"></a><span id="l33.1593">     isImage = true;</span>
<a href="#l33.1594"></a><span id="l33.1594"> </span>
<a href="#l33.1595"></a><span id="l33.1595">     image-&gt;GetName(tName);</span>
<a href="#l33.1596"></a><span id="l33.1596"> </span>
<a href="#l33.1597"></a><span id="l33.1597">     LossyCopyUTF16toASCII(tName, attachment-&gt;m_realName);</span>
<a href="#l33.1598"></a><span id="l33.1598">     image-&gt;GetLongDesc(tDesc);</span>
<a href="#l33.1599"></a><span id="l33.1599" class="difflineminus">-    attachment-&gt;m_description = NS_LossyConvertUTF16toASCII(tDesc); // XXX i18n</span>
<a href="#l33.1600"></a><span id="l33.1600" class="difflineminus">-  }</span>
<a href="#l33.1601"></a><span id="l33.1601" class="difflineminus">-  else if (anchor)</span>
<a href="#l33.1602"></a><span id="l33.1602" class="difflineminus">-  {</span>
<a href="#l33.1603"></a><span id="l33.1603" class="difflineminus">-    nsString    tUrl;</span>
<a href="#l33.1604"></a><span id="l33.1604" class="difflineplus">+    attachment-&gt;m_description = NS_LossyConvertUTF16toASCII(tDesc);  // XXX i18n</span>
<a href="#l33.1605"></a><span id="l33.1605" class="difflineplus">+  } else if (anchor) {</span>
<a href="#l33.1606"></a><span id="l33.1606" class="difflineplus">+    nsString tUrl;</span>
<a href="#l33.1607"></a><span id="l33.1607"> </span>
<a href="#l33.1608"></a><span id="l33.1608">     // Create the URI</span>
<a href="#l33.1609"></a><span id="l33.1609">     anchor-&gt;GetHref(tUrl);</span>
<a href="#l33.1610"></a><span id="l33.1610" class="difflineminus">-    if (tUrl.IsEmpty())</span>
<a href="#l33.1611"></a><span id="l33.1611" class="difflineminus">-      return NS_OK;</span>
<a href="#l33.1612"></a><span id="l33.1612" class="difflineplus">+    if (tUrl.IsEmpty()) return NS_OK;</span>
<a href="#l33.1613"></a><span id="l33.1613">     nsAutoCString turlC;</span>
<a href="#l33.1614"></a><span id="l33.1614">     CopyUTF16toUTF8(tUrl, turlC);</span>
<a href="#l33.1615"></a><span id="l33.1615">     // This can fail since the URL might not be recognised, for example:</span>
<a href="#l33.1616"></a><span id="l33.1616">     // &lt;a href=&quot;skype:some-name?call&quot; title=&quot;Skype&quot;&gt;Some Name&lt;/a&gt;</span>
<a href="#l33.1617"></a><span id="l33.1617">     if (NS_FAILED(nsMsgNewURL(getter_AddRefs(attachment-&gt;m_url), turlC)))</span>
<a href="#l33.1618"></a><span id="l33.1618">       return NS_OK;</span>
<a href="#l33.1619"></a><span id="l33.1619">     nsString tName;</span>
<a href="#l33.1620"></a><span id="l33.1620">     anchor-&gt;GetName(tName);</span>
<a href="#l33.1621"></a><span id="l33.1621">     LossyCopyUTF16toASCII(tName, attachment-&gt;m_realName);</span>
<a href="#l33.1622"></a><span id="l33.1622" class="difflineminus">-  }</span>
<a href="#l33.1623"></a><span id="l33.1623" class="difflineminus">-  else</span>
<a href="#l33.1624"></a><span id="l33.1624" class="difflineminus">-  {</span>
<a href="#l33.1625"></a><span id="l33.1625" class="difflineplus">+  } else {</span>
<a href="#l33.1626"></a><span id="l33.1626">     // If we get here, we got something we didn't expect!</span>
<a href="#l33.1627"></a><span id="l33.1627">     // Just try to continue and send it without this thing.</span>
<a href="#l33.1628"></a><span id="l33.1628">     return NS_OK;</span>
<a href="#l33.1629"></a><span id="l33.1629">   }</span>
<a href="#l33.1630"></a><span id="l33.1630"> </span>
<a href="#l33.1631"></a><span id="l33.1631">   // Before going further, check what scheme we're dealing with. Files need to</span>
<a href="#l33.1632"></a><span id="l33.1632">   // be converted to data URLs during composition. &quot;Attaching&quot; means</span>
<a href="#l33.1633"></a><span id="l33.1633">   // sending as a cid: part instead of original URL.</span>
<a href="#l33.1634"></a><span id="l33.1634">   bool isHttp =</span>
<a href="#l33.1635"></a><span id="l33.1635" class="difflineminus">-    (NS_SUCCEEDED(attachment-&gt;m_url-&gt;SchemeIs(&quot;http&quot;, &amp;isHttp)) &amp;&amp; isHttp) ||</span>
<a href="#l33.1636"></a><span id="l33.1636" class="difflineminus">-    (NS_SUCCEEDED(attachment-&gt;m_url-&gt;SchemeIs(&quot;https&quot;, &amp;isHttp)) &amp;&amp; isHttp);</span>
<a href="#l33.1637"></a><span id="l33.1637" class="difflineplus">+      (NS_SUCCEEDED(attachment-&gt;m_url-&gt;SchemeIs(&quot;http&quot;, &amp;isHttp)) &amp;&amp; isHttp) ||</span>
<a href="#l33.1638"></a><span id="l33.1638" class="difflineplus">+      (NS_SUCCEEDED(attachment-&gt;m_url-&gt;SchemeIs(&quot;https&quot;, &amp;isHttp)) &amp;&amp; isHttp);</span>
<a href="#l33.1639"></a><span id="l33.1639">   // Attach (= create cid: part) http resources if moz-do-not-send is set to</span>
<a href="#l33.1640"></a><span id="l33.1640" class="difflineminus">-  // &quot;false&quot;. Special processing for images: We attach if the preference says so.</span>
<a href="#l33.1641"></a><span id="l33.1641" class="difflineminus">-  // Note that moz-do-not-send=&quot;true&quot; is already processed above so the preference</span>
<a href="#l33.1642"></a><span id="l33.1642" class="difflineminus">-  // doesn't override this.</span>
<a href="#l33.1643"></a><span id="l33.1643" class="difflineminus">-  if (isHttp)</span>
<a href="#l33.1644"></a><span id="l33.1644" class="difflineminus">-  {</span>
<a href="#l33.1645"></a><span id="l33.1645" class="difflineplus">+  // &quot;false&quot;. Special processing for images: We attach if the preference says</span>
<a href="#l33.1646"></a><span id="l33.1646" class="difflineplus">+  // so. Note that moz-do-not-send=&quot;true&quot; is already processed above so the</span>
<a href="#l33.1647"></a><span id="l33.1647" class="difflineplus">+  // preference doesn't override this.</span>
<a href="#l33.1648"></a><span id="l33.1648" class="difflineplus">+  if (isHttp) {</span>
<a href="#l33.1649"></a><span id="l33.1649">     *acceptObject =</span>
<a href="#l33.1650"></a><span id="l33.1650" class="difflineminus">-      (isImage &amp;&amp; Preferences::GetBool(&quot;mail.compose.attach_http_images&quot;, false)) ||</span>
<a href="#l33.1651"></a><span id="l33.1651" class="difflineminus">-      mozDoNotSendAttr.LowerCaseEqualsLiteral(&quot;false&quot;);</span>
<a href="#l33.1652"></a><span id="l33.1652" class="difflineplus">+        (isImage &amp;&amp;</span>
<a href="#l33.1653"></a><span id="l33.1653" class="difflineplus">+         Preferences::GetBool(&quot;mail.compose.attach_http_images&quot;, false)) ||</span>
<a href="#l33.1654"></a><span id="l33.1654" class="difflineplus">+        mozDoNotSendAttr.LowerCaseEqualsLiteral(&quot;false&quot;);</span>
<a href="#l33.1655"></a><span id="l33.1655">     return NS_OK;</span>
<a href="#l33.1656"></a><span id="l33.1656">   }</span>
<a href="#l33.1657"></a><span id="l33.1657"> </span>
<a href="#l33.1658"></a><span id="l33.1658">   bool isData =</span>
<a href="#l33.1659"></a><span id="l33.1659" class="difflineminus">-    (NS_SUCCEEDED(attachment-&gt;m_url-&gt;SchemeIs(&quot;data&quot;, &amp;isData)) &amp;&amp; isData);</span>
<a href="#l33.1660"></a><span id="l33.1660" class="difflineplus">+      (NS_SUCCEEDED(attachment-&gt;m_url-&gt;SchemeIs(&quot;data&quot;, &amp;isData)) &amp;&amp; isData);</span>
<a href="#l33.1661"></a><span id="l33.1661">   bool isNews =</span>
<a href="#l33.1662"></a><span id="l33.1662" class="difflineminus">-    (NS_SUCCEEDED(attachment-&gt;m_url-&gt;SchemeIs(&quot;news&quot;, &amp;isNews)) &amp;&amp; isNews) ||</span>
<a href="#l33.1663"></a><span id="l33.1663" class="difflineminus">-    (NS_SUCCEEDED(attachment-&gt;m_url-&gt;SchemeIs(&quot;snews&quot;, &amp;isNews)) &amp;&amp; isNews) ||</span>
<a href="#l33.1664"></a><span id="l33.1664" class="difflineminus">-    (NS_SUCCEEDED(attachment-&gt;m_url-&gt;SchemeIs(&quot;nntp&quot;, &amp;isNews)) &amp;&amp; isNews);</span>
<a href="#l33.1665"></a><span id="l33.1665" class="difflineplus">+      (NS_SUCCEEDED(attachment-&gt;m_url-&gt;SchemeIs(&quot;news&quot;, &amp;isNews)) &amp;&amp; isNews) ||</span>
<a href="#l33.1666"></a><span id="l33.1666" class="difflineplus">+      (NS_SUCCEEDED(attachment-&gt;m_url-&gt;SchemeIs(&quot;snews&quot;, &amp;isNews)) &amp;&amp; isNews) ||</span>
<a href="#l33.1667"></a><span id="l33.1667" class="difflineplus">+      (NS_SUCCEEDED(attachment-&gt;m_url-&gt;SchemeIs(&quot;nntp&quot;, &amp;isNews)) &amp;&amp; isNews);</span>
<a href="#l33.1668"></a><span id="l33.1668">   // Attach (= create cid: part) data resources if moz-do-not-send is not</span>
<a href="#l33.1669"></a><span id="l33.1669">   // specified or set to &quot;false&quot;.</span>
<a href="#l33.1670"></a><span id="l33.1670" class="difflineminus">-  if (isData || isNews)</span>
<a href="#l33.1671"></a><span id="l33.1671" class="difflineminus">-  {</span>
<a href="#l33.1672"></a><span id="l33.1672" class="difflineplus">+  if (isData || isNews) {</span>
<a href="#l33.1673"></a><span id="l33.1673">     *acceptObject = mozDoNotSendAttr.IsEmpty() ||</span>
<a href="#l33.1674"></a><span id="l33.1674" class="difflineminus">-      mozDoNotSendAttr.LowerCaseEqualsLiteral(&quot;false&quot;);</span>
<a href="#l33.1675"></a><span id="l33.1675" class="difflineplus">+                    mozDoNotSendAttr.LowerCaseEqualsLiteral(&quot;false&quot;);</span>
<a href="#l33.1676"></a><span id="l33.1676">     return NS_OK;</span>
<a href="#l33.1677"></a><span id="l33.1677">   }</span>
<a href="#l33.1678"></a><span id="l33.1678"> </span>
<a href="#l33.1679"></a><span id="l33.1679">   return NS_OK;</span>
<a href="#l33.1680"></a><span id="l33.1680"> }</span>
<a href="#l33.1681"></a><span id="l33.1681"> </span>
<a href="#l33.1682"></a><span id="l33.1682" class="difflineminus">-</span>
<a href="#l33.1683"></a><span id="l33.1683" class="difflineminus">-uint32_t</span>
<a href="#l33.1684"></a><span id="l33.1684" class="difflineminus">-nsMsgComposeAndSend::GetMultipartRelatedCount(bool forceToBeCalculated /*=false*/)</span>
<a href="#l33.1685"></a><span id="l33.1685" class="difflineminus">-{</span>
<a href="#l33.1686"></a><span id="l33.1686" class="difflineminus">-  nsresult                  rv = NS_OK;</span>
<a href="#l33.1687"></a><span id="l33.1687" class="difflineminus">-  uint32_t                  count;</span>
<a href="#l33.1688"></a><span id="l33.1688" class="difflineplus">+uint32_t nsMsgComposeAndSend::GetMultipartRelatedCount(</span>
<a href="#l33.1689"></a><span id="l33.1689" class="difflineplus">+    bool forceToBeCalculated /*=false*/) {</span>
<a href="#l33.1690"></a><span id="l33.1690" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l33.1691"></a><span id="l33.1691" class="difflineplus">+  uint32_t count;</span>
<a href="#l33.1692"></a><span id="l33.1692"> </span>
<a href="#l33.1693"></a><span id="l33.1693">   if (mMultipartRelatedAttachmentCount != -1 &amp;&amp; !forceToBeCalculated)</span>
<a href="#l33.1694"></a><span id="l33.1694">     return (uint32_t)mMultipartRelatedAttachmentCount;</span>
<a href="#l33.1695"></a><span id="l33.1695"> </span>
<a href="#l33.1696"></a><span id="l33.1696" class="difflineminus">-  //First time here, let's calculate the correct number of related part we need to generate</span>
<a href="#l33.1697"></a><span id="l33.1697" class="difflineplus">+  // First time here, let's calculate the correct number of related part we need</span>
<a href="#l33.1698"></a><span id="l33.1698" class="difflineplus">+  // to generate</span>
<a href="#l33.1699"></a><span id="l33.1699">   mMultipartRelatedAttachmentCount = 0;</span>
<a href="#l33.1700"></a><span id="l33.1700" class="difflineminus">-  if (mEditor)</span>
<a href="#l33.1701"></a><span id="l33.1701" class="difflineminus">-  {</span>
<a href="#l33.1702"></a><span id="l33.1702" class="difflineplus">+  if (mEditor) {</span>
<a href="#l33.1703"></a><span id="l33.1703">     nsCOMPtr&lt;mozilla::dom::Document&gt; document;</span>
<a href="#l33.1704"></a><span id="l33.1704">     mEditor-&gt;GetDocument(getter_AddRefs(document));</span>
<a href="#l33.1705"></a><span id="l33.1705" class="difflineminus">-    if (!document)</span>
<a href="#l33.1706"></a><span id="l33.1706" class="difflineminus">-      return 0;</span>
<a href="#l33.1707"></a><span id="l33.1707" class="difflineplus">+    if (!document) return 0;</span>
<a href="#l33.1708"></a><span id="l33.1708">     mEmbeddedObjectList = GetEmbeddedObjects(document);</span>
<a href="#l33.1709"></a><span id="l33.1709">   }</span>
<a href="#l33.1710"></a><span id="l33.1710" class="difflineminus">-  if (!mEmbeddedObjectList)</span>
<a href="#l33.1711"></a><span id="l33.1711" class="difflineminus">-    return 0;</span>
<a href="#l33.1712"></a><span id="l33.1712" class="difflineminus">-</span>
<a href="#l33.1713"></a><span id="l33.1713" class="difflineminus">-  if (NS_SUCCEEDED(mEmbeddedObjectList-&gt;GetLength(&amp;count)))</span>
<a href="#l33.1714"></a><span id="l33.1714" class="difflineminus">-  {</span>
<a href="#l33.1715"></a><span id="l33.1715" class="difflineminus">-    if (count &gt; 0)</span>
<a href="#l33.1716"></a><span id="l33.1716" class="difflineminus">-    {</span>
<a href="#l33.1717"></a><span id="l33.1717" class="difflineplus">+  if (!mEmbeddedObjectList) return 0;</span>
<a href="#l33.1718"></a><span id="l33.1718" class="difflineplus">+</span>
<a href="#l33.1719"></a><span id="l33.1719" class="difflineplus">+  if (NS_SUCCEEDED(mEmbeddedObjectList-&gt;GetLength(&amp;count))) {</span>
<a href="#l33.1720"></a><span id="l33.1720" class="difflineplus">+    if (count &gt; 0) {</span>
<a href="#l33.1721"></a><span id="l33.1721">       // preallocate space for part numbers</span>
<a href="#l33.1722"></a><span id="l33.1722">       m_partNumbers.SetLength(count);</span>
<a href="#l33.1723"></a><span id="l33.1723" class="difflineminus">-      // Let parse the list to count the number of valid objects. BTW, we can remove the others from the list</span>
<a href="#l33.1724"></a><span id="l33.1724" class="difflineplus">+      // Let parse the list to count the number of valid objects. BTW, we can</span>
<a href="#l33.1725"></a><span id="l33.1725" class="difflineplus">+      // remove the others from the list</span>
<a href="#l33.1726"></a><span id="l33.1726">       RefPtr&lt;nsMsgAttachmentData&gt; attachment(new nsMsgAttachmentData);</span>
<a href="#l33.1727"></a><span id="l33.1727"> </span>
<a href="#l33.1728"></a><span id="l33.1728">       int32_t i;</span>
<a href="#l33.1729"></a><span id="l33.1729">       nsCOMPtr&lt;Element&gt; domElement;</span>
<a href="#l33.1730"></a><span id="l33.1730"> </span>
<a href="#l33.1731"></a><span id="l33.1731" class="difflineminus">-      for (i = count - 1, count = 0; i &gt;= 0; i --)</span>
<a href="#l33.1732"></a><span id="l33.1732" class="difflineminus">-      {</span>
<a href="#l33.1733"></a><span id="l33.1733" class="difflineplus">+      for (i = count - 1, count = 0; i &gt;= 0; i--) {</span>
<a href="#l33.1734"></a><span id="l33.1734">         // Reset this structure to null!</span>
<a href="#l33.1735"></a><span id="l33.1735"> </span>
<a href="#l33.1736"></a><span id="l33.1736">         // now we need to get the element in the array and do the magic</span>
<a href="#l33.1737"></a><span id="l33.1737">         // to process this element.</span>
<a href="#l33.1738"></a><span id="l33.1738">         //</span>
<a href="#l33.1739"></a><span id="l33.1739">         domElement = do_QueryElementAt(mEmbeddedObjectList, i, &amp;rv);</span>
<a href="#l33.1740"></a><span id="l33.1740">         bool acceptObject = false;</span>
<a href="#l33.1741"></a><span id="l33.1741" class="difflineminus">-        if (domElement)</span>
<a href="#l33.1742"></a><span id="l33.1742" class="difflineminus">-        {</span>
<a href="#l33.1743"></a><span id="l33.1743" class="difflineplus">+        if (domElement) {</span>
<a href="#l33.1744"></a><span id="l33.1744">           rv = GetEmbeddedObjectInfo(domElement, attachment, &amp;acceptObject);</span>
<a href="#l33.1745"></a><span id="l33.1745" class="difflineminus">-        }</span>
<a href="#l33.1746"></a><span id="l33.1746" class="difflineminus">-        else // outlook import case</span>
<a href="#l33.1747"></a><span id="l33.1747" class="difflineplus">+        } else  // outlook import case</span>
<a href="#l33.1748"></a><span id="l33.1748">         {</span>
<a href="#l33.1749"></a><span id="l33.1749">           nsCOMPtr&lt;nsIMsgEmbeddedImageData&gt; imageData =</span>
<a href="#l33.1750"></a><span id="l33.1750" class="difflineminus">-            do_QueryElementAt(mEmbeddedObjectList, i, &amp;rv);</span>
<a href="#l33.1751"></a><span id="l33.1751" class="difflineminus">-          if (!imageData)</span>
<a href="#l33.1752"></a><span id="l33.1752" class="difflineminus">-            continue;</span>
<a href="#l33.1753"></a><span id="l33.1753" class="difflineplus">+              do_QueryElementAt(mEmbeddedObjectList, i, &amp;rv);</span>
<a href="#l33.1754"></a><span id="l33.1754" class="difflineplus">+          if (!imageData) continue;</span>
<a href="#l33.1755"></a><span id="l33.1755">           acceptObject = true;</span>
<a href="#l33.1756"></a><span id="l33.1756">         }</span>
<a href="#l33.1757"></a><span id="l33.1757" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; acceptObject)</span>
<a href="#l33.1758"></a><span id="l33.1758" class="difflineminus">-          count ++;</span>
<a href="#l33.1759"></a><span id="l33.1759" class="difflineplus">+        if (NS_SUCCEEDED(rv) &amp;&amp; acceptObject) count++;</span>
<a href="#l33.1760"></a><span id="l33.1760">       }</span>
<a href="#l33.1761"></a><span id="l33.1761">     }</span>
<a href="#l33.1762"></a><span id="l33.1762">     mMultipartRelatedAttachmentCount = (int32_t)count;</span>
<a href="#l33.1763"></a><span id="l33.1763">     return count;</span>
<a href="#l33.1764"></a><span id="l33.1764" class="difflineminus">-  }</span>
<a href="#l33.1765"></a><span id="l33.1765" class="difflineminus">-  else</span>
<a href="#l33.1766"></a><span id="l33.1766" class="difflineplus">+  } else</span>
<a href="#l33.1767"></a><span id="l33.1767">     return 0;</span>
<a href="#l33.1768"></a><span id="l33.1768"> }</span>
<a href="#l33.1769"></a><span id="l33.1769"> </span>
<a href="#l33.1770"></a><span id="l33.1770" class="difflineminus">-nsresult</span>
<a href="#l33.1771"></a><span id="l33.1771" class="difflineminus">-nsMsgComposeAndSend::GetBodyFromEditor()</span>
<a href="#l33.1772"></a><span id="l33.1772" class="difflineminus">-{</span>
<a href="#l33.1773"></a><span id="l33.1773" class="difflineplus">+nsresult nsMsgComposeAndSend::GetBodyFromEditor() {</span>
<a href="#l33.1774"></a><span id="l33.1774">   //</span>
<a href="#l33.1775"></a><span id="l33.1775">   // Now we have to fix up and get the HTML from the editor. After we</span>
<a href="#l33.1776"></a><span id="l33.1776">   // get the HTML data, we need to store it in the m_attachment_1_body</span>
<a href="#l33.1777"></a><span id="l33.1777">   // member variable after doing the necessary charset conversion.</span>
<a href="#l33.1778"></a><span id="l33.1778">   //</span>
<a href="#l33.1779"></a><span id="l33.1779"> </span>
<a href="#l33.1780"></a><span id="l33.1780">   //</span>
<a href="#l33.1781"></a><span id="l33.1781">   // Query the editor, get the body of HTML!</span>
<a href="#l33.1782"></a><span id="l33.1782" class="difflineat">@@ -1490,224 +1316,195 @@ nsMsgComposeAndSend::GetBodyFromEditor()</span>
<a href="#l33.1783"></a><span id="l33.1783">   // Ok, get the body...the DOM should have been whacked with</span>
<a href="#l33.1784"></a><span id="l33.1784">   // Content ID's already</span>
<a href="#l33.1785"></a><span id="l33.1785">   if (mEditor)</span>
<a href="#l33.1786"></a><span id="l33.1786">     mEditor-&gt;OutputToString(NS_LITERAL_STRING(TEXT_HTML), flags, bodyStr);</span>
<a href="#l33.1787"></a><span id="l33.1787">   else</span>
<a href="#l33.1788"></a><span id="l33.1788">     bodyStr = NS_ConvertASCIItoUTF16(m_attachment1_body);</span>
<a href="#l33.1789"></a><span id="l33.1789"> </span>
<a href="#l33.1790"></a><span id="l33.1790">   // If we really didn't get a body, just return NS_OK</span>
<a href="#l33.1791"></a><span id="l33.1791" class="difflineminus">-  if (bodyStr.IsEmpty())</span>
<a href="#l33.1792"></a><span id="l33.1792" class="difflineminus">-    return NS_OK;</span>
<a href="#l33.1793"></a><span id="l33.1793" class="difflineplus">+  if (bodyStr.IsEmpty()) return NS_OK;</span>
<a href="#l33.1794"></a><span id="l33.1794">   bodyText = bodyStr;</span>
<a href="#l33.1795"></a><span id="l33.1795"> </span>
<a href="#l33.1796"></a><span id="l33.1796">   // If we are forcing this to be plain text, we should not be</span>
<a href="#l33.1797"></a><span id="l33.1797">   // doing this conversion.</span>
<a href="#l33.1798"></a><span id="l33.1798">   bool doConversion = true;</span>
<a href="#l33.1799"></a><span id="l33.1799"> </span>
<a href="#l33.1800"></a><span id="l33.1800" class="difflineminus">-  if ( (mCompFields) &amp;&amp; mCompFields-&gt;GetForcePlainText() )</span>
<a href="#l33.1801"></a><span id="l33.1801" class="difflineminus">-    doConversion = false;</span>
<a href="#l33.1802"></a><span id="l33.1802" class="difflineminus">-</span>
<a href="#l33.1803"></a><span id="l33.1803" class="difflineminus">-  if (doConversion)</span>
<a href="#l33.1804"></a><span id="l33.1804" class="difflineminus">-  {</span>
<a href="#l33.1805"></a><span id="l33.1805" class="difflineminus">-    nsCOMPtr&lt;mozITXTToHTMLConv&gt; conv = do_CreateInstance(MOZ_TXTTOHTMLCONV_CONTRACTID, &amp;rv);</span>
<a href="#l33.1806"></a><span id="l33.1806" class="difflineminus">-</span>
<a href="#l33.1807"></a><span id="l33.1807" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l33.1808"></a><span id="l33.1808" class="difflineminus">-    {</span>
<a href="#l33.1809"></a><span id="l33.1809" class="difflineplus">+  if ((mCompFields) &amp;&amp; mCompFields-&gt;GetForcePlainText()) doConversion = false;</span>
<a href="#l33.1810"></a><span id="l33.1810" class="difflineplus">+</span>
<a href="#l33.1811"></a><span id="l33.1811" class="difflineplus">+  if (doConversion) {</span>
<a href="#l33.1812"></a><span id="l33.1812" class="difflineplus">+    nsCOMPtr&lt;mozITXTToHTMLConv&gt; conv =</span>
<a href="#l33.1813"></a><span id="l33.1813" class="difflineplus">+        do_CreateInstance(MOZ_TXTTOHTMLCONV_CONTRACTID, &amp;rv);</span>
<a href="#l33.1814"></a><span id="l33.1814" class="difflineplus">+</span>
<a href="#l33.1815"></a><span id="l33.1815" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l33.1816"></a><span id="l33.1816">       uint32_t whattodo = mozITXTToHTMLConv::kURLs;</span>
<a href="#l33.1817"></a><span id="l33.1817">       bool enable_structs = false;</span>
<a href="#l33.1818"></a><span id="l33.1818" class="difflineminus">-      nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l33.1819"></a><span id="l33.1819" class="difflineminus">-      if (pPrefBranch)</span>
<a href="#l33.1820"></a><span id="l33.1820" class="difflineminus">-      {</span>
<a href="#l33.1821"></a><span id="l33.1821" class="difflineplus">+      nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranch(</span>
<a href="#l33.1822"></a><span id="l33.1822" class="difflineplus">+          do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l33.1823"></a><span id="l33.1823" class="difflineplus">+      if (pPrefBranch) {</span>
<a href="#l33.1824"></a><span id="l33.1824">         rv = pPrefBranch-&gt;GetBoolPref(PREF_MAIL_SEND_STRUCT, &amp;enable_structs);</span>
<a href="#l33.1825"></a><span id="l33.1825">         if (enable_structs)</span>
<a href="#l33.1826"></a><span id="l33.1826">           whattodo = whattodo | mozITXTToHTMLConv::kStructPhrase;</span>
<a href="#l33.1827"></a><span id="l33.1827">       }</span>
<a href="#l33.1828"></a><span id="l33.1828"> </span>
<a href="#l33.1829"></a><span id="l33.1829">       nsAutoString wresult;</span>
<a href="#l33.1830"></a><span id="l33.1830">       rv = conv-&gt;ScanHTML(bodyText, whattodo, wresult);</span>
<a href="#l33.1831"></a><span id="l33.1831" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l33.1832"></a><span id="l33.1832" class="difflineminus">-      {</span>
<a href="#l33.1833"></a><span id="l33.1833" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l33.1834"></a><span id="l33.1834">         // Save the original body for possible attachment as plain text</span>
<a href="#l33.1835"></a><span id="l33.1835">         // We should have what the user typed in stored in mOriginalHTMLBody</span>
<a href="#l33.1836"></a><span id="l33.1836">         origHTMLBody = bodyText;</span>
<a href="#l33.1837"></a><span id="l33.1837">         bodyText = wresult;</span>
<a href="#l33.1838"></a><span id="l33.1838">       }</span>
<a href="#l33.1839"></a><span id="l33.1839">     }</span>
<a href="#l33.1840"></a><span id="l33.1840">   }</span>
<a href="#l33.1841"></a><span id="l33.1841"> </span>
<a href="#l33.1842"></a><span id="l33.1842">   nsCString attachment1_body;</span>
<a href="#l33.1843"></a><span id="l33.1843"> </span>
<a href="#l33.1844"></a><span id="l33.1844">   // Convert body to mail charset</span>
<a href="#l33.1845"></a><span id="l33.1845" class="difflineminus">-  nsCString    outCString;</span>
<a href="#l33.1846"></a><span id="l33.1846" class="difflineminus">-  const char  *aCharset = mCompFields-&gt;GetCharacterSet();</span>
<a href="#l33.1847"></a><span id="l33.1847" class="difflineminus">-</span>
<a href="#l33.1848"></a><span id="l33.1848" class="difflineminus">-  if (aCharset &amp;&amp; *aCharset)</span>
<a href="#l33.1849"></a><span id="l33.1849" class="difflineminus">-  {</span>
<a href="#l33.1850"></a><span id="l33.1850" class="difflineminus">-    bool isAsciiOnly = mozilla::IsAsciiNullTerminated(static_cast&lt;const char16_t*&gt;(bodyText.get()));</span>
<a href="#l33.1851"></a><span id="l33.1851" class="difflineminus">-    rv = nsMsgI18NConvertFromUnicode(nsDependentCString(aCharset),</span>
<a href="#l33.1852"></a><span id="l33.1852" class="difflineminus">-                                     bodyText,</span>
<a href="#l33.1853"></a><span id="l33.1853" class="difflineminus">-                                     outCString,</span>
<a href="#l33.1854"></a><span id="l33.1854" class="difflineminus">-                                     true);</span>
<a href="#l33.1855"></a><span id="l33.1855" class="difflineminus">-    if (mCompFields-&gt;GetForceMsgEncoding())</span>
<a href="#l33.1856"></a><span id="l33.1856" class="difflineminus">-      isAsciiOnly = false;</span>
<a href="#l33.1857"></a><span id="l33.1857" class="difflineplus">+  nsCString outCString;</span>
<a href="#l33.1858"></a><span id="l33.1858" class="difflineplus">+  const char *aCharset = mCompFields-&gt;GetCharacterSet();</span>
<a href="#l33.1859"></a><span id="l33.1859" class="difflineplus">+</span>
<a href="#l33.1860"></a><span id="l33.1860" class="difflineplus">+  if (aCharset &amp;&amp; *aCharset) {</span>
<a href="#l33.1861"></a><span id="l33.1861" class="difflineplus">+    bool isAsciiOnly = mozilla::IsAsciiNullTerminated(</span>
<a href="#l33.1862"></a><span id="l33.1862" class="difflineplus">+        static_cast&lt;const char16_t *&gt;(bodyText.get()));</span>
<a href="#l33.1863"></a><span id="l33.1863" class="difflineplus">+    rv = nsMsgI18NConvertFromUnicode(nsDependentCString(aCharset), bodyText,</span>
<a href="#l33.1864"></a><span id="l33.1864" class="difflineplus">+                                     outCString, true);</span>
<a href="#l33.1865"></a><span id="l33.1865" class="difflineplus">+    if (mCompFields-&gt;GetForceMsgEncoding()) isAsciiOnly = false;</span>
<a href="#l33.1866"></a><span id="l33.1866">     mCompFields-&gt;SetBodyIsAsciiOnly(isAsciiOnly);</span>
<a href="#l33.1867"></a><span id="l33.1867"> </span>
<a href="#l33.1868"></a><span id="l33.1868">     // If the body contains characters outside the current mail charset,</span>
<a href="#l33.1869"></a><span id="l33.1869">     // convert to UTF-8.</span>
<a href="#l33.1870"></a><span id="l33.1870" class="difflineminus">-    if (NS_ERROR_UENC_NOMAPPING == rv)</span>
<a href="#l33.1871"></a><span id="l33.1871" class="difflineminus">-    {</span>
<a href="#l33.1872"></a><span id="l33.1872" class="difflineplus">+    if (NS_ERROR_UENC_NOMAPPING == rv) {</span>
<a href="#l33.1873"></a><span id="l33.1873">       bool needToCheckCharset;</span>
<a href="#l33.1874"></a><span id="l33.1874">       mCompFields-&gt;GetNeedToCheckCharset(&amp;needToCheckCharset);</span>
<a href="#l33.1875"></a><span id="l33.1875" class="difflineminus">-      if (needToCheckCharset)</span>
<a href="#l33.1876"></a><span id="l33.1876" class="difflineminus">-      {</span>
<a href="#l33.1877"></a><span id="l33.1877" class="difflineplus">+      if (needToCheckCharset) {</span>
<a href="#l33.1878"></a><span id="l33.1878">         // Just use UTF-8 and be done with it</span>
<a href="#l33.1879"></a><span id="l33.1879">         // unless disable_fallback_to_utf8 is set for this charset.</span>
<a href="#l33.1880"></a><span id="l33.1880">         bool disableFallback = false;</span>
<a href="#l33.1881"></a><span id="l33.1881" class="difflineminus">-        nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch (do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l33.1882"></a><span id="l33.1882" class="difflineminus">-        if (prefBranch)</span>
<a href="#l33.1883"></a><span id="l33.1883" class="difflineminus">-        {</span>
<a href="#l33.1884"></a><span id="l33.1884" class="difflineplus">+        nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(</span>
<a href="#l33.1885"></a><span id="l33.1885" class="difflineplus">+            do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l33.1886"></a><span id="l33.1886" class="difflineplus">+        if (prefBranch) {</span>
<a href="#l33.1887"></a><span id="l33.1887">           nsCString prefName(&quot;mailnews.disable_fallback_to_utf8.&quot;);</span>
<a href="#l33.1888"></a><span id="l33.1888">           prefName.Append(aCharset);</span>
<a href="#l33.1889"></a><span id="l33.1889">           prefBranch-&gt;GetBoolPref(prefName.get(), &amp;disableFallback);</span>
<a href="#l33.1890"></a><span id="l33.1890">         }</span>
<a href="#l33.1891"></a><span id="l33.1891" class="difflineminus">-        if (!disableFallback)</span>
<a href="#l33.1892"></a><span id="l33.1892" class="difflineminus">-        {</span>
<a href="#l33.1893"></a><span id="l33.1893" class="difflineplus">+        if (!disableFallback) {</span>
<a href="#l33.1894"></a><span id="l33.1894">           CopyUTF16toUTF8(bodyText, outCString);</span>
<a href="#l33.1895"></a><span id="l33.1895">           mCompFields-&gt;SetCharacterSet(&quot;UTF-8&quot;);</span>
<a href="#l33.1896"></a><span id="l33.1896">         }</span>
<a href="#l33.1897"></a><span id="l33.1897">       }</span>
<a href="#l33.1898"></a><span id="l33.1898">     }</span>
<a href="#l33.1899"></a><span id="l33.1899"> </span>
<a href="#l33.1900"></a><span id="l33.1900" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l33.1901"></a><span id="l33.1901" class="difflineminus">-      attachment1_body = outCString;</span>
<a href="#l33.1902"></a><span id="l33.1902" class="difflineplus">+    if (NS_SUCCEEDED(rv)) attachment1_body = outCString;</span>
<a href="#l33.1903"></a><span id="l33.1903"> </span>
<a href="#l33.1904"></a><span id="l33.1904">     // If we have an origHTMLBody that is not null, this means that it is</span>
<a href="#l33.1905"></a><span id="l33.1905">     // different than the bodyText because of formatting conversions. Because of</span>
<a href="#l33.1906"></a><span id="l33.1906">     // this we need to do the charset conversion on this part separately</span>
<a href="#l33.1907"></a><span id="l33.1907" class="difflineminus">-    if (!origHTMLBody.IsEmpty())</span>
<a href="#l33.1908"></a><span id="l33.1908" class="difflineminus">-    {</span>
<a href="#l33.1909"></a><span id="l33.1909" class="difflineplus">+    if (!origHTMLBody.IsEmpty()) {</span>
<a href="#l33.1910"></a><span id="l33.1910">       nsCString newBody;</span>
<a href="#l33.1911"></a><span id="l33.1911">       rv = nsMsgI18NConvertFromUnicode(nsDependentCString(aCharset),</span>
<a href="#l33.1912"></a><span id="l33.1912" class="difflineminus">-                                       origHTMLBody,</span>
<a href="#l33.1913"></a><span id="l33.1913" class="difflineminus">-                                       newBody,</span>
<a href="#l33.1914"></a><span id="l33.1914" class="difflineminus">-                                       true);</span>
<a href="#l33.1915"></a><span id="l33.1915" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l33.1916"></a><span id="l33.1916" class="difflineminus">-      {</span>
<a href="#l33.1917"></a><span id="l33.1917" class="difflineplus">+                                       origHTMLBody, newBody, true);</span>
<a href="#l33.1918"></a><span id="l33.1918" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l33.1919"></a><span id="l33.1919">         mOriginalHTMLBody = ToNewCString(newBody);</span>
<a href="#l33.1920"></a><span id="l33.1920">       }</span>
<a href="#l33.1921"></a><span id="l33.1921" class="difflineminus">-    }</span>
<a href="#l33.1922"></a><span id="l33.1922" class="difflineminus">-    else {</span>
<a href="#l33.1923"></a><span id="l33.1923" class="difflineplus">+    } else {</span>
<a href="#l33.1924"></a><span id="l33.1924">       mOriginalHTMLBody = ToNewCString(attachment1_body);</span>
<a href="#l33.1925"></a><span id="l33.1925">     }</span>
<a href="#l33.1926"></a><span id="l33.1926" class="difflineminus">-  }</span>
<a href="#l33.1927"></a><span id="l33.1927" class="difflineminus">-  else</span>
<a href="#l33.1928"></a><span id="l33.1928" class="difflineplus">+  } else</span>
<a href="#l33.1929"></a><span id="l33.1929">     return NS_ERROR_FAILURE;</span>
<a href="#l33.1930"></a><span id="l33.1930"> </span>
<a href="#l33.1931"></a><span id="l33.1931">   rv = SnarfAndCopyBody(attachment1_body, TEXT_HTML);</span>
<a href="#l33.1932"></a><span id="l33.1932"> </span>
<a href="#l33.1933"></a><span id="l33.1933">   return rv;</span>
<a href="#l33.1934"></a><span id="l33.1934"> }</span>
<a href="#l33.1935"></a><span id="l33.1935"> </span>
<a href="#l33.1936"></a><span id="l33.1936"> //</span>
<a href="#l33.1937"></a><span id="l33.1937"> // This is the routine that does the magic of generating the body and the</span>
<a href="#l33.1938"></a><span id="l33.1938"> // attachments for the multipart/related email message.</span>
<a href="#l33.1939"></a><span id="l33.1939"> //</span>
<a href="#l33.1940"></a><span id="l33.1940" class="difflineminus">-typedef struct</span>
<a href="#l33.1941"></a><span id="l33.1941" class="difflineminus">-{</span>
<a href="#l33.1942"></a><span id="l33.1942" class="difflineplus">+typedef struct {</span>
<a href="#l33.1943"></a><span id="l33.1943">   Element *element;</span>
<a href="#l33.1944"></a><span id="l33.1944">   char *url;</span>
<a href="#l33.1945"></a><span id="l33.1945"> } domSaveStruct;</span>
<a href="#l33.1946"></a><span id="l33.1946"> </span>
<a href="#l33.1947"></a><span id="l33.1947" class="difflineminus">-nsresult</span>
<a href="#l33.1948"></a><span id="l33.1948" class="difflineminus">-nsMsgComposeAndSend::ProcessMultipartRelated(int32_t *aMailboxCount, int32_t *aNewsCount)</span>
<a href="#l33.1949"></a><span id="l33.1949" class="difflineminus">-{</span>
<a href="#l33.1950"></a><span id="l33.1950" class="difflineminus">-  uint32_t                  multipartCount = GetMultipartRelatedCount();</span>
<a href="#l33.1951"></a><span id="l33.1951" class="difflineminus">-  nsresult                  rv = NS_OK;</span>
<a href="#l33.1952"></a><span id="l33.1952" class="difflineminus">-  uint32_t                  i;</span>
<a href="#l33.1953"></a><span id="l33.1953" class="difflineminus">-  int32_t                   j = -1;</span>
<a href="#l33.1954"></a><span id="l33.1954" class="difflineminus">-  uint32_t                  k;</span>
<a href="#l33.1955"></a><span id="l33.1955" class="difflineminus">-  int32_t                   duplicateOf;</span>
<a href="#l33.1956"></a><span id="l33.1956" class="difflineminus">-  domSaveStruct             *domSaveArray = nullptr;</span>
<a href="#l33.1957"></a><span id="l33.1957" class="difflineminus">-</span>
<a href="#l33.1958"></a><span id="l33.1958" class="difflineminus">-   if (!mEmbeddedObjectList)</span>
<a href="#l33.1959"></a><span id="l33.1959" class="difflineminus">-    return NS_ERROR_MIME_MPART_ATTACHMENT_ERROR;</span>
<a href="#l33.1960"></a><span id="l33.1960" class="difflineplus">+nsresult nsMsgComposeAndSend::ProcessMultipartRelated(int32_t *aMailboxCount,</span>
<a href="#l33.1961"></a><span id="l33.1961" class="difflineplus">+                                                      int32_t *aNewsCount) {</span>
<a href="#l33.1962"></a><span id="l33.1962" class="difflineplus">+  uint32_t multipartCount = GetMultipartRelatedCount();</span>
<a href="#l33.1963"></a><span id="l33.1963" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l33.1964"></a><span id="l33.1964" class="difflineplus">+  uint32_t i;</span>
<a href="#l33.1965"></a><span id="l33.1965" class="difflineplus">+  int32_t j = -1;</span>
<a href="#l33.1966"></a><span id="l33.1966" class="difflineplus">+  uint32_t k;</span>
<a href="#l33.1967"></a><span id="l33.1967" class="difflineplus">+  int32_t duplicateOf;</span>
<a href="#l33.1968"></a><span id="l33.1968" class="difflineplus">+  domSaveStruct *domSaveArray = nullptr;</span>
<a href="#l33.1969"></a><span id="l33.1969" class="difflineplus">+</span>
<a href="#l33.1970"></a><span id="l33.1970" class="difflineplus">+  if (!mEmbeddedObjectList) return NS_ERROR_MIME_MPART_ATTACHMENT_ERROR;</span>
<a href="#l33.1971"></a><span id="l33.1971"> </span>
<a href="#l33.1972"></a><span id="l33.1972">   RefPtr&lt;nsMsgAttachmentData&gt; attachment(new nsMsgAttachmentData);</span>
<a href="#l33.1973"></a><span id="l33.1973" class="difflineminus">-  int32_t               locCount = -1;</span>
<a href="#l33.1974"></a><span id="l33.1974" class="difflineminus">-</span>
<a href="#l33.1975"></a><span id="l33.1975" class="difflineminus">-  if (multipartCount &gt; 0)</span>
<a href="#l33.1976"></a><span id="l33.1976" class="difflineminus">-  {</span>
<a href="#l33.1977"></a><span id="l33.1977" class="difflineminus">-    domSaveArray = (domSaveStruct *)PR_MALLOC(sizeof(domSaveStruct) * multipartCount);</span>
<a href="#l33.1978"></a><span id="l33.1978" class="difflineminus">-    if (!domSaveArray)</span>
<a href="#l33.1979"></a><span id="l33.1979" class="difflineminus">-      return NS_ERROR_MIME_MPART_ATTACHMENT_ERROR;</span>
<a href="#l33.1980"></a><span id="l33.1980" class="difflineplus">+  int32_t locCount = -1;</span>
<a href="#l33.1981"></a><span id="l33.1981" class="difflineplus">+</span>
<a href="#l33.1982"></a><span id="l33.1982" class="difflineplus">+  if (multipartCount &gt; 0) {</span>
<a href="#l33.1983"></a><span id="l33.1983" class="difflineplus">+    domSaveArray =</span>
<a href="#l33.1984"></a><span id="l33.1984" class="difflineplus">+        (domSaveStruct *)PR_MALLOC(sizeof(domSaveStruct) * multipartCount);</span>
<a href="#l33.1985"></a><span id="l33.1985" class="difflineplus">+    if (!domSaveArray) return NS_ERROR_MIME_MPART_ATTACHMENT_ERROR;</span>
<a href="#l33.1986"></a><span id="l33.1986">     memset(domSaveArray, 0, sizeof(domSaveStruct) * multipartCount);</span>
<a href="#l33.1987"></a><span id="l33.1987">   }</span>
<a href="#l33.1988"></a><span id="l33.1988"> </span>
<a href="#l33.1989"></a><span id="l33.1989">   i = mPreloadedAttachmentCount;</span>
<a href="#l33.1990"></a><span id="l33.1990" class="difflineminus">-  while (i &lt; mPreloadedAttachmentCount + multipartCount)</span>
<a href="#l33.1991"></a><span id="l33.1991" class="difflineminus">-  {</span>
<a href="#l33.1992"></a><span id="l33.1992" class="difflineplus">+  while (i &lt; mPreloadedAttachmentCount + multipartCount) {</span>
<a href="#l33.1993"></a><span id="l33.1993">     // Ok, now we need to get the element in the array and do the magic</span>
<a href="#l33.1994"></a><span id="l33.1994">     // to process this element.</span>
<a href="#l33.1995"></a><span id="l33.1995">     //</span>
<a href="#l33.1996"></a><span id="l33.1996"> </span>
<a href="#l33.1997"></a><span id="l33.1997">     locCount++;</span>
<a href="#l33.1998"></a><span id="l33.1998" class="difflineminus">-    nsCOMPtr&lt;Element&gt; domElement = do_QueryElementAt(mEmbeddedObjectList, locCount);</span>
<a href="#l33.1999"></a><span id="l33.1999" class="difflineminus">-    if (domElement)</span>
<a href="#l33.2000"></a><span id="l33.2000" class="difflineminus">-    {</span>
<a href="#l33.2001"></a><span id="l33.2001" class="difflineplus">+    nsCOMPtr&lt;Element&gt; domElement =</span>
<a href="#l33.2002"></a><span id="l33.2002" class="difflineplus">+        do_QueryElementAt(mEmbeddedObjectList, locCount);</span>
<a href="#l33.2003"></a><span id="l33.2003" class="difflineplus">+    if (domElement) {</span>
<a href="#l33.2004"></a><span id="l33.2004">       bool acceptObject = false;</span>
<a href="#l33.2005"></a><span id="l33.2005">       rv = GetEmbeddedObjectInfo(domElement, attachment, &amp;acceptObject);</span>
<a href="#l33.2006"></a><span id="l33.2006">       NS_ENSURE_SUCCESS(rv, NS_ERROR_MIME_MPART_ATTACHMENT_ERROR);</span>
<a href="#l33.2007"></a><span id="l33.2007" class="difflineminus">-      if (!acceptObject)</span>
<a href="#l33.2008"></a><span id="l33.2008" class="difflineminus">-        continue;</span>
<a href="#l33.2009"></a><span id="l33.2009" class="difflineplus">+      if (!acceptObject) continue;</span>
<a href="#l33.2010"></a><span id="l33.2010">       nsString nodeValue;</span>
<a href="#l33.2011"></a><span id="l33.2011">       domElement-&gt;GetNodeValue(nodeValue);</span>
<a href="#l33.2012"></a><span id="l33.2012">       LossyCopyUTF16toASCII(nodeValue, m_attachments[i]-&gt;m_contentId);</span>
<a href="#l33.2013"></a><span id="l33.2013" class="difflineminus">-    }</span>
<a href="#l33.2014"></a><span id="l33.2014" class="difflineminus">-    else</span>
<a href="#l33.2015"></a><span id="l33.2015" class="difflineminus">-    {</span>
<a href="#l33.2016"></a><span id="l33.2016" class="difflineminus">-      nsCOMPtr&lt;nsIMsgEmbeddedImageData&gt; imageData = do_QueryElementAt(mEmbeddedObjectList, locCount, &amp;rv);</span>
<a href="#l33.2017"></a><span id="l33.2017" class="difflineminus">-      if (!imageData)</span>
<a href="#l33.2018"></a><span id="l33.2018" class="difflineminus">-        return NS_ERROR_MIME_MPART_ATTACHMENT_ERROR;</span>
<a href="#l33.2019"></a><span id="l33.2019" class="difflineplus">+    } else {</span>
<a href="#l33.2020"></a><span id="l33.2020" class="difflineplus">+      nsCOMPtr&lt;nsIMsgEmbeddedImageData&gt; imageData =</span>
<a href="#l33.2021"></a><span id="l33.2021" class="difflineplus">+          do_QueryElementAt(mEmbeddedObjectList, locCount, &amp;rv);</span>
<a href="#l33.2022"></a><span id="l33.2022" class="difflineplus">+      if (!imageData) return NS_ERROR_MIME_MPART_ATTACHMENT_ERROR;</span>
<a href="#l33.2023"></a><span id="l33.2023">       imageData-&gt;GetUri(getter_AddRefs(attachment-&gt;m_url));</span>
<a href="#l33.2024"></a><span id="l33.2024" class="difflineminus">-      if (!attachment-&gt;m_url)</span>
<a href="#l33.2025"></a><span id="l33.2025" class="difflineminus">-        return NS_ERROR_MIME_MPART_ATTACHMENT_ERROR;</span>
<a href="#l33.2026"></a><span id="l33.2026" class="difflineplus">+      if (!attachment-&gt;m_url) return NS_ERROR_MIME_MPART_ATTACHMENT_ERROR;</span>
<a href="#l33.2027"></a><span id="l33.2027">       imageData-&gt;GetCid(m_attachments[i]-&gt;m_contentId);</span>
<a href="#l33.2028"></a><span id="l33.2028">       imageData-&gt;GetName(attachment-&gt;m_realName);</span>
<a href="#l33.2029"></a><span id="l33.2029">     }</span>
<a href="#l33.2030"></a><span id="l33.2030"> </span>
<a href="#l33.2031"></a><span id="l33.2031" class="difflineminus">-</span>
<a href="#l33.2032"></a><span id="l33.2032">     // MUST set this to get placed in the correct part of the message</span>
<a href="#l33.2033"></a><span id="l33.2033">     m_attachments[i]-&gt;mMHTMLPart = true;</span>
<a href="#l33.2034"></a><span id="l33.2034"> </span>
<a href="#l33.2035"></a><span id="l33.2035">     m_attachments[i]-&gt;mDeleteFile = true;</span>
<a href="#l33.2036"></a><span id="l33.2036">     m_attachments[i]-&gt;m_done = false;</span>
<a href="#l33.2037"></a><span id="l33.2037">     m_attachments[i]-&gt;SetMimeDeliveryState(this);</span>
<a href="#l33.2038"></a><span id="l33.2038">     m_attachments[i]-&gt;mNodeIndex = locCount;</span>
<a href="#l33.2039"></a><span id="l33.2039"> </span>
<a href="#l33.2040"></a><span id="l33.2040">     j++;</span>
<a href="#l33.2041"></a><span id="l33.2041">     domSaveArray[j].element = domElement;</span>
<a href="#l33.2042"></a><span id="l33.2042"> </span>
<a href="#l33.2043"></a><span id="l33.2043" class="difflineminus">-    // check if we have already attached this object, don't need to attach it twice</span>
<a href="#l33.2044"></a><span id="l33.2044" class="difflineplus">+    // check if we have already attached this object, don't need to attach it</span>
<a href="#l33.2045"></a><span id="l33.2045" class="difflineplus">+    // twice</span>
<a href="#l33.2046"></a><span id="l33.2046">     duplicateOf = -1;</span>
<a href="#l33.2047"></a><span id="l33.2047" class="difflineminus">-    for (k = mPreloadedAttachmentCount; k &lt; i; k++)</span>
<a href="#l33.2048"></a><span id="l33.2048" class="difflineminus">-    {</span>
<a href="#l33.2049"></a><span id="l33.2049" class="difflineplus">+    for (k = mPreloadedAttachmentCount; k &lt; i; k++) {</span>
<a href="#l33.2050"></a><span id="l33.2050">       bool isEqual = false;</span>
<a href="#l33.2051"></a><span id="l33.2051">       NS_ASSERTION(attachment-&gt;m_url, &quot;null attachment url!&quot;);</span>
<a href="#l33.2052"></a><span id="l33.2052">       if (attachment-&gt;m_url)</span>
<a href="#l33.2053"></a><span id="l33.2053">         (void)attachment-&gt;m_url-&gt;Equals(m_attachments[k]-&gt;mURL, &amp;isEqual);</span>
<a href="#l33.2054"></a><span id="l33.2054" class="difflineminus">-      if (isEqual)</span>
<a href="#l33.2055"></a><span id="l33.2055" class="difflineminus">-      {</span>
<a href="#l33.2056"></a><span id="l33.2056" class="difflineplus">+      if (isEqual) {</span>
<a href="#l33.2057"></a><span id="l33.2057">         duplicateOf = k;</span>
<a href="#l33.2058"></a><span id="l33.2058">         break;</span>
<a href="#l33.2059"></a><span id="l33.2059">       }</span>
<a href="#l33.2060"></a><span id="l33.2060">     }</span>
<a href="#l33.2061"></a><span id="l33.2061"> </span>
<a href="#l33.2062"></a><span id="l33.2062" class="difflineminus">-    if (duplicateOf == -1)</span>
<a href="#l33.2063"></a><span id="l33.2063" class="difflineminus">-    {</span>
<a href="#l33.2064"></a><span id="l33.2064" class="difflineplus">+    if (duplicateOf == -1) {</span>
<a href="#l33.2065"></a><span id="l33.2065">       //</span>
<a href="#l33.2066"></a><span id="l33.2066">       // Now we have to get all of the interesting information from</span>
<a href="#l33.2067"></a><span id="l33.2067">       // the DOM node we have in hand...</span>
<a href="#l33.2068"></a><span id="l33.2068">       m_attachments[i]-&gt;mURL = attachment-&gt;m_url;</span>
<a href="#l33.2069"></a><span id="l33.2069"> </span>
<a href="#l33.2070"></a><span id="l33.2070">       m_attachments[i]-&gt;m_overrideType = attachment-&gt;m_realType;</span>
<a href="#l33.2071"></a><span id="l33.2071">       m_attachments[i]-&gt;m_overrideEncoding = attachment-&gt;m_realEncoding;</span>
<a href="#l33.2072"></a><span id="l33.2072">       m_attachments[i]-&gt;m_desiredType = attachment-&gt;m_desiredType;</span>
<a href="#l33.2073"></a><span id="l33.2073" class="difflineat">@@ -1715,133 +1512,130 @@ nsMsgComposeAndSend::ProcessMultipartRel</span>
<a href="#l33.2074"></a><span id="l33.2074">       m_attachments[i]-&gt;m_realName = attachment-&gt;m_realName;</span>
<a href="#l33.2075"></a><span id="l33.2075">       m_attachments[i]-&gt;m_xMacType = attachment-&gt;m_xMacType;</span>
<a href="#l33.2076"></a><span id="l33.2076">       m_attachments[i]-&gt;m_xMacCreator = attachment-&gt;m_xMacCreator;</span>
<a href="#l33.2077"></a><span id="l33.2077"> </span>
<a href="#l33.2078"></a><span id="l33.2078">       m_attachments[i]-&gt;m_charset = mCompFields-&gt;GetCharacterSet();</span>
<a href="#l33.2079"></a><span id="l33.2079">       m_attachments[i]-&gt;m_encoding = ENCODING_7BIT;</span>
<a href="#l33.2080"></a><span id="l33.2080"> </span>
<a href="#l33.2081"></a><span id="l33.2081">       if (m_attachments[i]-&gt;mURL)</span>
<a href="#l33.2082"></a><span id="l33.2082" class="difflineminus">-        msg_pick_real_name(m_attachments[i], nullptr, mCompFields-&gt;GetCharacterSet());</span>
<a href="#l33.2083"></a><span id="l33.2083" class="difflineminus">-</span>
<a href="#l33.2084"></a><span id="l33.2084" class="difflineminus">-      if (m_attachments[i]-&gt;m_contentId.IsEmpty())</span>
<a href="#l33.2085"></a><span id="l33.2085" class="difflineminus">-      {</span>
<a href="#l33.2086"></a><span id="l33.2086" class="difflineplus">+        msg_pick_real_name(m_attachments[i], nullptr,</span>
<a href="#l33.2087"></a><span id="l33.2087" class="difflineplus">+                           mCompFields-&gt;GetCharacterSet());</span>
<a href="#l33.2088"></a><span id="l33.2088" class="difflineplus">+</span>
<a href="#l33.2089"></a><span id="l33.2089" class="difflineplus">+      if (m_attachments[i]-&gt;m_contentId.IsEmpty()) {</span>
<a href="#l33.2090"></a><span id="l33.2090">         //</span>
<a href="#l33.2091"></a><span id="l33.2091">         // Next, generate a content id for use with this part</span>
<a href="#l33.2092"></a><span id="l33.2092">         //</span>
<a href="#l33.2093"></a><span id="l33.2093">         nsCString email;</span>
<a href="#l33.2094"></a><span id="l33.2094">         mUserIdentity-&gt;GetEmail(email);</span>
<a href="#l33.2095"></a><span id="l33.2095" class="difflineminus">-        m_attachments[i]-&gt;m_contentId = mime_gen_content_id(locCount+1, email.get());</span>
<a href="#l33.2096"></a><span id="l33.2096" class="difflineplus">+        m_attachments[i]-&gt;m_contentId =</span>
<a href="#l33.2097"></a><span id="l33.2097" class="difflineplus">+            mime_gen_content_id(locCount + 1, email.get());</span>
<a href="#l33.2098"></a><span id="l33.2098">       }</span>
<a href="#l33.2099"></a><span id="l33.2099"> </span>
<a href="#l33.2100"></a><span id="l33.2100">       //</span>
<a href="#l33.2101"></a><span id="l33.2101" class="difflineminus">-      // Start counting the attachments which are going to come from mail folders</span>
<a href="#l33.2102"></a><span id="l33.2102" class="difflineminus">-      // and from NNTP servers.</span>
<a href="#l33.2103"></a><span id="l33.2103" class="difflineplus">+      // Start counting the attachments which are going to come from mail</span>
<a href="#l33.2104"></a><span id="l33.2104" class="difflineplus">+      // folders and from NNTP servers.</span>
<a href="#l33.2105"></a><span id="l33.2105">       //</span>
<a href="#l33.2106"></a><span id="l33.2106" class="difflineminus">-      if (m_attachments[i]-&gt;mURL)</span>
<a href="#l33.2107"></a><span id="l33.2107" class="difflineminus">-      {</span>
<a href="#l33.2108"></a><span id="l33.2108" class="difflineplus">+      if (m_attachments[i]-&gt;mURL) {</span>
<a href="#l33.2109"></a><span id="l33.2109">         nsIURI *uri = m_attachments[i]-&gt;mURL;</span>
<a href="#l33.2110"></a><span id="l33.2110">         bool match = false;</span>
<a href="#l33.2111"></a><span id="l33.2111">         if ((NS_SUCCEEDED(uri-&gt;SchemeIs(&quot;mailbox&quot;, &amp;match)) &amp;&amp; match) ||</span>
<a href="#l33.2112"></a><span id="l33.2112">             (NS_SUCCEEDED(uri-&gt;SchemeIs(&quot;imap&quot;, &amp;match)) &amp;&amp; match))</span>
<a href="#l33.2113"></a><span id="l33.2113">           (*aMailboxCount)++;</span>
<a href="#l33.2114"></a><span id="l33.2114">         else if ((NS_SUCCEEDED(uri-&gt;SchemeIs(&quot;news&quot;, &amp;match)) &amp;&amp; match) ||</span>
<a href="#l33.2115"></a><span id="l33.2115">                  (NS_SUCCEEDED(uri-&gt;SchemeIs(&quot;snews&quot;, &amp;match)) &amp;&amp; match))</span>
<a href="#l33.2116"></a><span id="l33.2116">           (*aNewsCount)++;</span>
<a href="#l33.2117"></a><span id="l33.2117" class="difflineminus">-        else</span>
<a href="#l33.2118"></a><span id="l33.2118" class="difflineminus">-        {</span>
<a href="#l33.2119"></a><span id="l33.2119" class="difflineplus">+        else {</span>
<a href="#l33.2120"></a><span id="l33.2120">           // Additional account types need a mechanism to report that they are</span>
<a href="#l33.2121"></a><span id="l33.2121">           // message protocols. If there is an nsIMsgProtocolInfo component</span>
<a href="#l33.2122"></a><span id="l33.2122">           // registered for this scheme, we'll consider it a mailbox</span>
<a href="#l33.2123"></a><span id="l33.2123">           // attachment.</span>
<a href="#l33.2124"></a><span id="l33.2124">           nsAutoCString contractID;</span>
<a href="#l33.2125"></a><span id="l33.2125">           contractID.Assign(</span>
<a href="#l33.2126"></a><span id="l33.2126" class="difflineminus">-            NS_LITERAL_CSTRING(&quot;@mozilla.org/messenger/protocol/info;1&quot;));</span>
<a href="#l33.2127"></a><span id="l33.2127" class="difflineplus">+              NS_LITERAL_CSTRING(&quot;@mozilla.org/messenger/protocol/info;1&quot;));</span>
<a href="#l33.2128"></a><span id="l33.2128">           nsAutoCString scheme;</span>
<a href="#l33.2129"></a><span id="l33.2129">           uri-&gt;GetScheme(scheme);</span>
<a href="#l33.2130"></a><span id="l33.2130">           contractID.Append(scheme);</span>
<a href="#l33.2131"></a><span id="l33.2131">           nsCOMPtr&lt;nsIMsgProtocolInfo&gt; msgProtocolInfo =</span>
<a href="#l33.2132"></a><span id="l33.2132" class="difflineminus">-            do_CreateInstance(contractID.get());</span>
<a href="#l33.2133"></a><span id="l33.2133" class="difflineminus">-          if (msgProtocolInfo)</span>
<a href="#l33.2134"></a><span id="l33.2134" class="difflineminus">-            (*aMailboxCount)++;</span>
<a href="#l33.2135"></a><span id="l33.2135" class="difflineplus">+              do_CreateInstance(contractID.get());</span>
<a href="#l33.2136"></a><span id="l33.2136" class="difflineplus">+          if (msgProtocolInfo) (*aMailboxCount)++;</span>
<a href="#l33.2137"></a><span id="l33.2137">         }</span>
<a href="#l33.2138"></a><span id="l33.2138" class="difflineminus">-</span>
<a href="#l33.2139"></a><span id="l33.2139">       }</span>
<a href="#l33.2140"></a><span id="l33.2140" class="difflineminus">-    }</span>
<a href="#l33.2141"></a><span id="l33.2141" class="difflineminus">-    else</span>
<a href="#l33.2142"></a><span id="l33.2142" class="difflineminus">-    {</span>
<a href="#l33.2143"></a><span id="l33.2143" class="difflineplus">+    } else {</span>
<a href="#l33.2144"></a><span id="l33.2144">       m_attachments[i]-&gt;m_contentId = m_attachments[duplicateOf]-&gt;m_contentId;</span>
<a href="#l33.2145"></a><span id="l33.2145">       m_attachments[i]-&gt;SetMimeDeliveryState(nullptr);</span>
<a href="#l33.2146"></a><span id="l33.2146">     }</span>
<a href="#l33.2147"></a><span id="l33.2147"> </span>
<a href="#l33.2148"></a><span id="l33.2148">     //</span>
<a href="#l33.2149"></a><span id="l33.2149">     // Ok, while we are here, we should whack the DOM with the generated</span>
<a href="#l33.2150"></a><span id="l33.2150">     // Content-ID for this object. This will be necessary for generating</span>
<a href="#l33.2151"></a><span id="l33.2151">     // the HTML we need.</span>
<a href="#l33.2152"></a><span id="l33.2152">     //</span>
<a href="#l33.2153"></a><span id="l33.2153">     if (domSaveArray[j].element &amp;&amp;</span>
<a href="#l33.2154"></a><span id="l33.2154" class="difflineminus">-        !m_attachments[duplicateOf == -1 ? i : duplicateOf]-&gt;m_contentId.IsEmpty())</span>
<a href="#l33.2155"></a><span id="l33.2155" class="difflineminus">-    {</span>
<a href="#l33.2156"></a><span id="l33.2156" class="difflineminus">-      nsString   newSpec(NS_LITERAL_STRING(&quot;cid:&quot;));</span>
<a href="#l33.2157"></a><span id="l33.2157" class="difflineminus">-      newSpec.AppendASCII(m_attachments[duplicateOf == -1 ? i : duplicateOf]-&gt;m_contentId.get());</span>
<a href="#l33.2158"></a><span id="l33.2158" class="difflineminus">-</span>
<a href="#l33.2159"></a><span id="l33.2159" class="difflineminus">-      // We know the types of objects this element can be, let's see what we come up with.</span>
<a href="#l33.2160"></a><span id="l33.2160" class="difflineminus">-      RefPtr&lt;HTMLImageElement&gt;  image  = HTMLImageElement::FromNode(domSaveArray[j].element);</span>
<a href="#l33.2161"></a><span id="l33.2161" class="difflineminus">-      RefPtr&lt;HTMLAnchorElement&gt; anchor = HTMLAnchorElement::FromNode(domSaveArray[j].element);</span>
<a href="#l33.2162"></a><span id="l33.2162" class="difflineminus">-      RefPtr&lt;HTMLBodyElement&gt;   body   = HTMLBodyElement::FromNode(domSaveArray[j].element);</span>
<a href="#l33.2163"></a><span id="l33.2163" class="difflineplus">+        !m_attachments[duplicateOf == -1 ? i : duplicateOf]</span>
<a href="#l33.2164"></a><span id="l33.2164" class="difflineplus">+             -&gt;m_contentId.IsEmpty()) {</span>
<a href="#l33.2165"></a><span id="l33.2165" class="difflineplus">+      nsString newSpec(NS_LITERAL_STRING(&quot;cid:&quot;));</span>
<a href="#l33.2166"></a><span id="l33.2166" class="difflineplus">+      newSpec.AppendASCII(m_attachments[duplicateOf == -1 ? i : duplicateOf]</span>
<a href="#l33.2167"></a><span id="l33.2167" class="difflineplus">+                              -&gt;m_contentId.get());</span>
<a href="#l33.2168"></a><span id="l33.2168" class="difflineplus">+</span>
<a href="#l33.2169"></a><span id="l33.2169" class="difflineplus">+      // We know the types of objects this element can be, let's see what we</span>
<a href="#l33.2170"></a><span id="l33.2170" class="difflineplus">+      // come up with.</span>
<a href="#l33.2171"></a><span id="l33.2171" class="difflineplus">+      RefPtr&lt;HTMLImageElement&gt; image =</span>
<a href="#l33.2172"></a><span id="l33.2172" class="difflineplus">+          HTMLImageElement::FromNode(domSaveArray[j].element);</span>
<a href="#l33.2173"></a><span id="l33.2173" class="difflineplus">+      RefPtr&lt;HTMLAnchorElement&gt; anchor =</span>
<a href="#l33.2174"></a><span id="l33.2174" class="difflineplus">+          HTMLAnchorElement::FromNode(domSaveArray[j].element);</span>
<a href="#l33.2175"></a><span id="l33.2175" class="difflineplus">+      RefPtr&lt;HTMLBodyElement&gt; body =</span>
<a href="#l33.2176"></a><span id="l33.2176" class="difflineplus">+          HTMLBodyElement::FromNode(domSaveArray[j].element);</span>
<a href="#l33.2177"></a><span id="l33.2177"> </span>
<a href="#l33.2178"></a><span id="l33.2178">       nsString domURL;</span>
<a href="#l33.2179"></a><span id="l33.2179">       IgnoredErrorResult rv2;</span>
<a href="#l33.2180"></a><span id="l33.2180" class="difflineminus">-      if (anchor)</span>
<a href="#l33.2181"></a><span id="l33.2181" class="difflineminus">-      {</span>
<a href="#l33.2182"></a><span id="l33.2182" class="difflineplus">+      if (anchor) {</span>
<a href="#l33.2183"></a><span id="l33.2183">         anchor-&gt;GetHref(domURL);</span>
<a href="#l33.2184"></a><span id="l33.2184">         anchor-&gt;SetHref(newSpec, rv2);</span>
<a href="#l33.2185"></a><span id="l33.2185" class="difflineminus">-      }</span>
<a href="#l33.2186"></a><span id="l33.2186" class="difflineminus">-      else if (image)</span>
<a href="#l33.2187"></a><span id="l33.2187" class="difflineminus">-      {</span>
<a href="#l33.2188"></a><span id="l33.2188" class="difflineplus">+      } else if (image) {</span>
<a href="#l33.2189"></a><span id="l33.2189">         image-&gt;GetSrc(domURL);</span>
<a href="#l33.2190"></a><span id="l33.2190">         image-&gt;SetSrc(newSpec, rv2);</span>
<a href="#l33.2191"></a><span id="l33.2191" class="difflineminus">-      }</span>
<a href="#l33.2192"></a><span id="l33.2192" class="difflineminus">-      else if (body)</span>
<a href="#l33.2193"></a><span id="l33.2193" class="difflineminus">-      {</span>
<a href="#l33.2194"></a><span id="l33.2194" class="difflineplus">+      } else if (body) {</span>
<a href="#l33.2195"></a><span id="l33.2195">         body-&gt;GetBackground(domURL);</span>
<a href="#l33.2196"></a><span id="l33.2196">         body-&gt;SetBackground(newSpec, rv2);</span>
<a href="#l33.2197"></a><span id="l33.2197">       }</span>
<a href="#l33.2198"></a><span id="l33.2198"> </span>
<a href="#l33.2199"></a><span id="l33.2199">       if (!domURL.IsEmpty())</span>
<a href="#l33.2200"></a><span id="l33.2200">         domSaveArray[j].url = ToNewCString(NS_LossyConvertUTF16toASCII(domURL));</span>
<a href="#l33.2201"></a><span id="l33.2201">     }</span>
<a href="#l33.2202"></a><span id="l33.2202">     i++;</span>
<a href="#l33.2203"></a><span id="l33.2203">   }</span>
<a href="#l33.2204"></a><span id="l33.2204"> </span>
<a href="#l33.2205"></a><span id="l33.2205">   rv = GetBodyFromEditor();</span>
<a href="#l33.2206"></a><span id="l33.2206"> </span>
<a href="#l33.2207"></a><span id="l33.2207">   //</span>
<a href="#l33.2208"></a><span id="l33.2208">   // Ok, now we need to un-whack the DOM or we have a screwed up document on</span>
<a href="#l33.2209"></a><span id="l33.2209">   // Send failure.</span>
<a href="#l33.2210"></a><span id="l33.2210">   //</span>
<a href="#l33.2211"></a><span id="l33.2211" class="difflineminus">-  for (i = 0; i &lt; multipartCount; i++)</span>
<a href="#l33.2212"></a><span id="l33.2212" class="difflineminus">-  {</span>
<a href="#l33.2213"></a><span id="l33.2213" class="difflineminus">-    if (!domSaveArray[i].element || !domSaveArray[i].url)</span>
<a href="#l33.2214"></a><span id="l33.2214" class="difflineminus">-      continue;</span>
<a href="#l33.2215"></a><span id="l33.2215" class="difflineminus">-</span>
<a href="#l33.2216"></a><span id="l33.2216" class="difflineminus">-    // We know the types of objects this element can be, let's see what we come up with.</span>
<a href="#l33.2217"></a><span id="l33.2217" class="difflineminus">-    RefPtr&lt;HTMLImageElement&gt;  image  = HTMLImageElement::FromNode(domSaveArray[i].element);</span>
<a href="#l33.2218"></a><span id="l33.2218" class="difflineminus">-    RefPtr&lt;HTMLAnchorElement&gt; anchor = HTMLAnchorElement::FromNode(domSaveArray[i].element);</span>
<a href="#l33.2219"></a><span id="l33.2219" class="difflineminus">-    RefPtr&lt;HTMLBodyElement&gt;   body   = HTMLBodyElement::FromNode(domSaveArray[i].element);</span>
<a href="#l33.2220"></a><span id="l33.2220" class="difflineminus">-</span>
<a href="#l33.2221"></a><span id="l33.2221" class="difflineminus">-      // STRING USE WARNING: hoisting the following conversion might save code-space, since it happens along every path</span>
<a href="#l33.2222"></a><span id="l33.2222" class="difflineplus">+  for (i = 0; i &lt; multipartCount; i++) {</span>
<a href="#l33.2223"></a><span id="l33.2223" class="difflineplus">+    if (!domSaveArray[i].element || !domSaveArray[i].url) continue;</span>
<a href="#l33.2224"></a><span id="l33.2224" class="difflineplus">+</span>
<a href="#l33.2225"></a><span id="l33.2225" class="difflineplus">+    // We know the types of objects this element can be, let's see what we come</span>
<a href="#l33.2226"></a><span id="l33.2226" class="difflineplus">+    // up with.</span>
<a href="#l33.2227"></a><span id="l33.2227" class="difflineplus">+    RefPtr&lt;HTMLImageElement&gt; image =</span>
<a href="#l33.2228"></a><span id="l33.2228" class="difflineplus">+        HTMLImageElement::FromNode(domSaveArray[i].element);</span>
<a href="#l33.2229"></a><span id="l33.2229" class="difflineplus">+    RefPtr&lt;HTMLAnchorElement&gt; anchor =</span>
<a href="#l33.2230"></a><span id="l33.2230" class="difflineplus">+        HTMLAnchorElement::FromNode(domSaveArray[i].element);</span>
<a href="#l33.2231"></a><span id="l33.2231" class="difflineplus">+    RefPtr&lt;HTMLBodyElement&gt; body =</span>
<a href="#l33.2232"></a><span id="l33.2232" class="difflineplus">+        HTMLBodyElement::FromNode(domSaveArray[i].element);</span>
<a href="#l33.2233"></a><span id="l33.2233" class="difflineplus">+</span>
<a href="#l33.2234"></a><span id="l33.2234" class="difflineplus">+    // STRING USE WARNING: hoisting the following conversion might save</span>
<a href="#l33.2235"></a><span id="l33.2235" class="difflineplus">+    // code-space, since it happens along every path</span>
<a href="#l33.2236"></a><span id="l33.2236"> </span>
<a href="#l33.2237"></a><span id="l33.2237">     IgnoredErrorResult rv2;</span>
<a href="#l33.2238"></a><span id="l33.2238">     if (anchor) {</span>
<a href="#l33.2239"></a><span id="l33.2239">       anchor-&gt;SetHref(NS_ConvertASCIItoUTF16(domSaveArray[i].url), rv2);</span>
<a href="#l33.2240"></a><span id="l33.2240">     } else if (image) {</span>
<a href="#l33.2241"></a><span id="l33.2241">       image-&gt;SetSrc(NS_ConvertASCIItoUTF16(domSaveArray[i].url), rv2);</span>
<a href="#l33.2242"></a><span id="l33.2242" class="difflineminus">-    }</span>
<a href="#l33.2243"></a><span id="l33.2243" class="difflineminus">-    else if (body) {</span>
<a href="#l33.2244"></a><span id="l33.2244" class="difflineplus">+    } else if (body) {</span>
<a href="#l33.2245"></a><span id="l33.2245">       body-&gt;SetBackground(NS_ConvertASCIItoUTF16(domSaveArray[i].url), rv2);</span>
<a href="#l33.2246"></a><span id="l33.2246">     }</span>
<a href="#l33.2247"></a><span id="l33.2247"> </span>
<a href="#l33.2248"></a><span id="l33.2248">     free(domSaveArray[i].url);</span>
<a href="#l33.2249"></a><span id="l33.2249">   }</span>
<a href="#l33.2250"></a><span id="l33.2250"> </span>
<a href="#l33.2251"></a><span id="l33.2251">   PR_FREEIF(domSaveArray);</span>
<a href="#l33.2252"></a><span id="l33.2252"> </span>
<a href="#l33.2253"></a><span id="l33.2253" class="difflineat">@@ -1849,459 +1643,437 @@ nsMsgComposeAndSend::ProcessMultipartRel</span>
<a href="#l33.2254"></a><span id="l33.2254">   // Now, we have to create that first child node for the multipart</span>
<a href="#l33.2255"></a><span id="l33.2255">   // message that holds the body as well as the attachment handler</span>
<a href="#l33.2256"></a><span id="l33.2256">   // for this body part.</span>
<a href="#l33.2257"></a><span id="l33.2257">   //</span>
<a href="#l33.2258"></a><span id="l33.2258">   // If we ONLY have multipart objects, then we don't need the container</span>
<a href="#l33.2259"></a><span id="l33.2259">   // for the multipart section...</span>
<a href="#l33.2260"></a><span id="l33.2260">   //</span>
<a href="#l33.2261"></a><span id="l33.2261">   m_related_part = new nsMsgSendPart(this);</span>
<a href="#l33.2262"></a><span id="l33.2262" class="difflineminus">-  if (!m_related_part)</span>
<a href="#l33.2263"></a><span id="l33.2263" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l33.2264"></a><span id="l33.2264" class="difflineplus">+  if (!m_related_part) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l33.2265"></a><span id="l33.2265"> </span>
<a href="#l33.2266"></a><span id="l33.2266">   m_related_part-&gt;SetMimeDeliveryState(this);</span>
<a href="#l33.2267"></a><span id="l33.2267">   m_related_part-&gt;SetType(MULTIPART_RELATED);</span>
<a href="#l33.2268"></a><span id="l33.2268">   // We are now going to use the m_related_part as a way to store the</span>
<a href="#l33.2269"></a><span id="l33.2269">   // MHTML message for this email.</span>
<a href="#l33.2270"></a><span id="l33.2270">   //</span>
<a href="#l33.2271"></a><span id="l33.2271">   m_related_body_part = new nsMsgSendPart(this);</span>
<a href="#l33.2272"></a><span id="l33.2272" class="difflineminus">-  if (!m_related_body_part)</span>
<a href="#l33.2273"></a><span id="l33.2273" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l33.2274"></a><span id="l33.2274" class="difflineplus">+  if (!m_related_body_part) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l33.2275"></a><span id="l33.2275"> </span>
<a href="#l33.2276"></a><span id="l33.2276">   // Set the body contents...</span>
<a href="#l33.2277"></a><span id="l33.2277">   m_related_body_part-&gt;SetBuffer(m_attachment1_body);</span>
<a href="#l33.2278"></a><span id="l33.2278">   m_related_body_part-&gt;SetType(m_attachment1_type);</span>
<a href="#l33.2279"></a><span id="l33.2279"> </span>
<a href="#l33.2280"></a><span id="l33.2280">   m_related_part-&gt;AddChild(m_related_body_part);</span>
<a href="#l33.2281"></a><span id="l33.2281"> </span>
<a href="#l33.2282"></a><span id="l33.2282">   return rv;</span>
<a href="#l33.2283"></a><span id="l33.2283"> }</span>
<a href="#l33.2284"></a><span id="l33.2284"> </span>
<a href="#l33.2285"></a><span id="l33.2285" class="difflineminus">-nsresult</span>
<a href="#l33.2286"></a><span id="l33.2286" class="difflineminus">-nsMsgComposeAndSend::CountCompFieldAttachments()</span>
<a href="#l33.2287"></a><span id="l33.2287" class="difflineminus">-{</span>
<a href="#l33.2288"></a><span id="l33.2288" class="difflineminus">-  //Reset the counters</span>
<a href="#l33.2289"></a><span id="l33.2289" class="difflineplus">+nsresult nsMsgComposeAndSend::CountCompFieldAttachments() {</span>
<a href="#l33.2290"></a><span id="l33.2290" class="difflineplus">+  // Reset the counters</span>
<a href="#l33.2291"></a><span id="l33.2291">   mCompFieldLocalAttachments = 0;</span>
<a href="#l33.2292"></a><span id="l33.2292">   mCompFieldRemoteAttachments = 0;</span>
<a href="#l33.2293"></a><span id="l33.2293"> </span>
<a href="#l33.2294"></a><span id="l33.2294" class="difflineminus">-  //Get the attachments array</span>
<a href="#l33.2295"></a><span id="l33.2295" class="difflineplus">+  // Get the attachments array</span>
<a href="#l33.2296"></a><span id="l33.2296">   nsCOMPtr&lt;nsISimpleEnumerator&gt; attachments;</span>
<a href="#l33.2297"></a><span id="l33.2297">   mCompFields-&gt;GetAttachments(getter_AddRefs(attachments));</span>
<a href="#l33.2298"></a><span id="l33.2298" class="difflineminus">-  if (!attachments)</span>
<a href="#l33.2299"></a><span id="l33.2299" class="difflineminus">-    return NS_OK;</span>
<a href="#l33.2300"></a><span id="l33.2300" class="difflineplus">+  if (!attachments) return NS_OK;</span>
<a href="#l33.2301"></a><span id="l33.2301"> </span>
<a href="#l33.2302"></a><span id="l33.2302">   nsresult rv;</span>
<a href="#l33.2303"></a><span id="l33.2303"> </span>
<a href="#l33.2304"></a><span id="l33.2304">   // Parse the attachments array</span>
<a href="#l33.2305"></a><span id="l33.2305">   bool moreAttachments;</span>
<a href="#l33.2306"></a><span id="l33.2306">   nsCString url;</span>
<a href="#l33.2307"></a><span id="l33.2307">   nsCOMPtr&lt;nsISupports&gt; element;</span>
<a href="#l33.2308"></a><span id="l33.2308" class="difflineminus">-  while (NS_SUCCEEDED(attachments-&gt;HasMoreElements(&amp;moreAttachments)) &amp;&amp; moreAttachments) {</span>
<a href="#l33.2309"></a><span id="l33.2309" class="difflineplus">+  while (NS_SUCCEEDED(attachments-&gt;HasMoreElements(&amp;moreAttachments)) &amp;&amp;</span>
<a href="#l33.2310"></a><span id="l33.2310" class="difflineplus">+         moreAttachments) {</span>
<a href="#l33.2311"></a><span id="l33.2311">     rv = attachments-&gt;GetNext(getter_AddRefs(element));</span>
<a href="#l33.2312"></a><span id="l33.2312">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l33.2313"></a><span id="l33.2313"> </span>
<a href="#l33.2314"></a><span id="l33.2314">     nsCOMPtr&lt;nsIMsgAttachment&gt; attachment = do_QueryInterface(element, &amp;rv);</span>
<a href="#l33.2315"></a><span id="l33.2315" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; attachment)</span>
<a href="#l33.2316"></a><span id="l33.2316" class="difflineminus">-    {</span>
<a href="#l33.2317"></a><span id="l33.2317" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; attachment) {</span>
<a href="#l33.2318"></a><span id="l33.2318">       attachment-&gt;GetUrl(url);</span>
<a href="#l33.2319"></a><span id="l33.2319" class="difflineminus">-      if (!url.IsEmpty())</span>
<a href="#l33.2320"></a><span id="l33.2320" class="difflineminus">-      {</span>
<a href="#l33.2321"></a><span id="l33.2321" class="difflineplus">+      if (!url.IsEmpty()) {</span>
<a href="#l33.2322"></a><span id="l33.2322">         // Check to see if this is a file URL, if so, don't retrieve</span>
<a href="#l33.2323"></a><span id="l33.2323">         // like a remote URL...</span>
<a href="#l33.2324"></a><span id="l33.2324">         if (nsMsgIsLocalFile(url.get()))</span>
<a href="#l33.2325"></a><span id="l33.2325">           mCompFieldLocalAttachments++;</span>
<a href="#l33.2326"></a><span id="l33.2326" class="difflineminus">-        else    // This is a remote URL...</span>
<a href="#l33.2327"></a><span id="l33.2327" class="difflineplus">+        else  // This is a remote URL...</span>
<a href="#l33.2328"></a><span id="l33.2328">           mCompFieldRemoteAttachments++;</span>
<a href="#l33.2329"></a><span id="l33.2329">       }</span>
<a href="#l33.2330"></a><span id="l33.2330">     }</span>
<a href="#l33.2331"></a><span id="l33.2331">   }</span>
<a href="#l33.2332"></a><span id="l33.2332"> </span>
<a href="#l33.2333"></a><span id="l33.2333">   return NS_OK;</span>
<a href="#l33.2334"></a><span id="l33.2334"> }</span>
<a href="#l33.2335"></a><span id="l33.2335"> </span>
<a href="#l33.2336"></a><span id="l33.2336"> //</span>
<a href="#l33.2337"></a><span id="l33.2337"> // Since we are at the head of the list, we start from ZERO.</span>
<a href="#l33.2338"></a><span id="l33.2338"> //</span>
<a href="#l33.2339"></a><span id="l33.2339" class="difflineminus">-nsresult</span>
<a href="#l33.2340"></a><span id="l33.2340" class="difflineminus">-nsMsgComposeAndSend::AddCompFieldLocalAttachments()</span>
<a href="#l33.2341"></a><span id="l33.2341" class="difflineminus">-{</span>
<a href="#l33.2342"></a><span id="l33.2342" class="difflineplus">+nsresult nsMsgComposeAndSend::AddCompFieldLocalAttachments() {</span>
<a href="#l33.2343"></a><span id="l33.2343">   // If none, just return...</span>
<a href="#l33.2344"></a><span id="l33.2344" class="difflineminus">-  if (mCompFieldLocalAttachments &lt;= 0)</span>
<a href="#l33.2345"></a><span id="l33.2345" class="difflineminus">-    return NS_OK;</span>
<a href="#l33.2346"></a><span id="l33.2346" class="difflineminus">-</span>
<a href="#l33.2347"></a><span id="l33.2347" class="difflineminus">-  //Get the attachments array</span>
<a href="#l33.2348"></a><span id="l33.2348" class="difflineplus">+  if (mCompFieldLocalAttachments &lt;= 0) return NS_OK;</span>
<a href="#l33.2349"></a><span id="l33.2349" class="difflineplus">+</span>
<a href="#l33.2350"></a><span id="l33.2350" class="difflineplus">+  // Get the attachments array</span>
<a href="#l33.2351"></a><span id="l33.2351">   nsCOMPtr&lt;nsISimpleEnumerator&gt; attachments;</span>
<a href="#l33.2352"></a><span id="l33.2352">   mCompFields-&gt;GetAttachments(getter_AddRefs(attachments));</span>
<a href="#l33.2353"></a><span id="l33.2353" class="difflineminus">-  if (!attachments)</span>
<a href="#l33.2354"></a><span id="l33.2354" class="difflineminus">-    return NS_OK;</span>
<a href="#l33.2355"></a><span id="l33.2355" class="difflineminus">-</span>
<a href="#l33.2356"></a><span id="l33.2356" class="difflineminus">-  uint32_t  newLoc = 0;</span>
<a href="#l33.2357"></a><span id="l33.2357" class="difflineplus">+  if (!attachments) return NS_OK;</span>
<a href="#l33.2358"></a><span id="l33.2358" class="difflineplus">+</span>
<a href="#l33.2359"></a><span id="l33.2359" class="difflineplus">+  uint32_t newLoc = 0;</span>
<a href="#l33.2360"></a><span id="l33.2360">   nsresult rv;</span>
<a href="#l33.2361"></a><span id="l33.2361">   nsCString url;</span>
<a href="#l33.2362"></a><span id="l33.2362"> </span>
<a href="#l33.2363"></a><span id="l33.2363" class="difflineminus">-  //Parse the attachments array</span>
<a href="#l33.2364"></a><span id="l33.2364" class="difflineplus">+  // Parse the attachments array</span>
<a href="#l33.2365"></a><span id="l33.2365">   bool moreAttachments;</span>
<a href="#l33.2366"></a><span id="l33.2366">   nsCOMPtr&lt;nsISupports&gt; element;</span>
<a href="#l33.2367"></a><span id="l33.2367" class="difflineminus">-  while (NS_SUCCEEDED(attachments-&gt;HasMoreElements(&amp;moreAttachments)) &amp;&amp; moreAttachments) {</span>
<a href="#l33.2368"></a><span id="l33.2368" class="difflineplus">+  while (NS_SUCCEEDED(attachments-&gt;HasMoreElements(&amp;moreAttachments)) &amp;&amp;</span>
<a href="#l33.2369"></a><span id="l33.2369" class="difflineplus">+         moreAttachments) {</span>
<a href="#l33.2370"></a><span id="l33.2370">     rv = attachments-&gt;GetNext(getter_AddRefs(element));</span>
<a href="#l33.2371"></a><span id="l33.2371">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l33.2372"></a><span id="l33.2372"> </span>
<a href="#l33.2373"></a><span id="l33.2373">     nsCOMPtr&lt;nsIMsgAttachment&gt; attachment = do_QueryInterface(element, &amp;rv);</span>
<a href="#l33.2374"></a><span id="l33.2374" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; attachment)</span>
<a href="#l33.2375"></a><span id="l33.2375" class="difflineminus">-    {</span>
<a href="#l33.2376"></a><span id="l33.2376" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; attachment) {</span>
<a href="#l33.2377"></a><span id="l33.2377">       bool sendViaCloud = false;</span>
<a href="#l33.2378"></a><span id="l33.2378">       attachment-&gt;GetSendViaCloud(&amp;sendViaCloud);</span>
<a href="#l33.2379"></a><span id="l33.2379">       m_attachments[newLoc]-&gt;mSendViaCloud = sendViaCloud;</span>
<a href="#l33.2380"></a><span id="l33.2380">       attachment-&gt;GetUrl(url);</span>
<a href="#l33.2381"></a><span id="l33.2381" class="difflineminus">-      if (!url.IsEmpty())</span>
<a href="#l33.2382"></a><span id="l33.2382" class="difflineminus">-      {</span>
<a href="#l33.2383"></a><span id="l33.2383" class="difflineplus">+      if (!url.IsEmpty()) {</span>
<a href="#l33.2384"></a><span id="l33.2384">         bool sendViaCloud;</span>
<a href="#l33.2385"></a><span id="l33.2385">         attachment-&gt;GetSendViaCloud(&amp;sendViaCloud);</span>
<a href="#l33.2386"></a><span id="l33.2386" class="difflineminus">-        if (sendViaCloud)</span>
<a href="#l33.2387"></a><span id="l33.2387" class="difflineminus">-        {</span>
<a href="#l33.2388"></a><span id="l33.2388" class="difflineplus">+        if (sendViaCloud) {</span>
<a href="#l33.2389"></a><span id="l33.2389">           nsCString cloudFileAccountKey;</span>
<a href="#l33.2390"></a><span id="l33.2390">           // We'd like to output a part for the attachment, just an html part</span>
<a href="#l33.2391"></a><span id="l33.2391">           // with information about how to download the attachment.</span>
<a href="#l33.2392"></a><span id="l33.2392">           // m_attachments[newLoc]-&gt;m_done = true;</span>
<a href="#l33.2393"></a><span id="l33.2393">           attachment-&gt;GetHtmlAnnotation(m_attachments[newLoc]-&gt;mHtmlAnnotation);</span>
<a href="#l33.2394"></a><span id="l33.2394">           m_attachments[newLoc]-&gt;m_type.AssignLiteral(&quot;text/html&quot;);</span>
<a href="#l33.2395"></a><span id="l33.2395" class="difflineminus">-          attachment-&gt;GetCloudFileAccountKey(m_attachments[newLoc]-&gt;mCloudFileAccountKey);</span>
<a href="#l33.2396"></a><span id="l33.2396" class="difflineplus">+          attachment-&gt;GetCloudFileAccountKey(</span>
<a href="#l33.2397"></a><span id="l33.2397" class="difflineplus">+              m_attachments[newLoc]-&gt;mCloudFileAccountKey);</span>
<a href="#l33.2398"></a><span id="l33.2398">           attachment-&gt;GetContentLocation(m_attachments[newLoc]-&gt;mCloudUrl);</span>
<a href="#l33.2399"></a><span id="l33.2399">         }</span>
<a href="#l33.2400"></a><span id="l33.2400">         // Just look for local file:// attachments and do the right thing.</span>
<a href="#l33.2401"></a><span id="l33.2401" class="difflineminus">-        if (nsMsgIsLocalFile(url.get()))</span>
<a href="#l33.2402"></a><span id="l33.2402" class="difflineminus">-        {</span>
<a href="#l33.2403"></a><span id="l33.2403" class="difflineplus">+        if (nsMsgIsLocalFile(url.get())) {</span>
<a href="#l33.2404"></a><span id="l33.2404">           //</span>
<a href="#l33.2405"></a><span id="l33.2405">           // Now we have to setup the m_attachments entry for the file://</span>
<a href="#l33.2406"></a><span id="l33.2406">           // URL that is passed in...</span>
<a href="#l33.2407"></a><span id="l33.2407">           //</span>
<a href="#l33.2408"></a><span id="l33.2408">           m_attachments[newLoc]-&gt;mDeleteFile = false;</span>
<a href="#l33.2409"></a><span id="l33.2409"> </span>
<a href="#l33.2410"></a><span id="l33.2410">           nsMsgNewURL(getter_AddRefs(m_attachments[newLoc]-&gt;mURL), url);</span>
<a href="#l33.2411"></a><span id="l33.2411"> </span>
<a href="#l33.2412"></a><span id="l33.2412" class="difflineminus">-          if (m_attachments[newLoc]-&gt;mTmpFile)</span>
<a href="#l33.2413"></a><span id="l33.2413" class="difflineminus">-          {</span>
<a href="#l33.2414"></a><span id="l33.2414" class="difflineplus">+          if (m_attachments[newLoc]-&gt;mTmpFile) {</span>
<a href="#l33.2415"></a><span id="l33.2415">             if (m_attachments[newLoc]-&gt;mDeleteFile)</span>
<a href="#l33.2416"></a><span id="l33.2416">               m_attachments[newLoc]-&gt;mTmpFile-&gt;Remove(false);</span>
<a href="#l33.2417"></a><span id="l33.2417" class="difflineminus">-            m_attachments[newLoc]-&gt;mTmpFile =nullptr;</span>
<a href="#l33.2418"></a><span id="l33.2418" class="difflineplus">+            m_attachments[newLoc]-&gt;mTmpFile = nullptr;</span>
<a href="#l33.2419"></a><span id="l33.2419">           }</span>
<a href="#l33.2420"></a><span id="l33.2420">           nsresult rv;</span>
<a href="#l33.2421"></a><span id="l33.2421" class="difflineminus">-          nsCOMPtr&lt;nsIIOService&gt; ioService =</span>
<a href="#l33.2422"></a><span id="l33.2422" class="difflineminus">-            mozilla::services::GetIOService();</span>
<a href="#l33.2423"></a><span id="l33.2423" class="difflineplus">+          nsCOMPtr&lt;nsIIOService&gt; ioService = mozilla::services::GetIOService();</span>
<a href="#l33.2424"></a><span id="l33.2424">           NS_ENSURE_TRUE(ioService, NS_ERROR_UNEXPECTED);</span>
<a href="#l33.2425"></a><span id="l33.2425" class="difflineminus">-          nsCOMPtr &lt;nsIURI&gt; uri;</span>
<a href="#l33.2426"></a><span id="l33.2426" class="difflineplus">+          nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l33.2427"></a><span id="l33.2427">           rv = ioService-&gt;NewURI(url, nullptr, nullptr, getter_AddRefs(uri));</span>
<a href="#l33.2428"></a><span id="l33.2428">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l33.2429"></a><span id="l33.2429" class="difflineminus">-          nsCOMPtr &lt;nsIFileURL&gt; fileURL = do_QueryInterface(uri);</span>
<a href="#l33.2430"></a><span id="l33.2430" class="difflineplus">+          nsCOMPtr&lt;nsIFileURL&gt; fileURL = do_QueryInterface(uri);</span>
<a href="#l33.2431"></a><span id="l33.2431">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l33.2432"></a><span id="l33.2432" class="difflineminus">-          nsCOMPtr &lt;nsIFile&gt; fileURLFile;</span>
<a href="#l33.2433"></a><span id="l33.2433" class="difflineplus">+          nsCOMPtr&lt;nsIFile&gt; fileURLFile;</span>
<a href="#l33.2434"></a><span id="l33.2434">           fileURL-&gt;GetFile(getter_AddRefs(fileURLFile));</span>
<a href="#l33.2435"></a><span id="l33.2435">           m_attachments[newLoc]-&gt;mTmpFile = fileURLFile;</span>
<a href="#l33.2436"></a><span id="l33.2436">           m_attachments[newLoc]-&gt;mDeleteFile = false;</span>
<a href="#l33.2437"></a><span id="l33.2437" class="difflineminus">-          if (m_attachments[newLoc]-&gt;mURL)</span>
<a href="#l33.2438"></a><span id="l33.2438" class="difflineminus">-          {</span>
<a href="#l33.2439"></a><span id="l33.2439" class="difflineplus">+          if (m_attachments[newLoc]-&gt;mURL) {</span>
<a href="#l33.2440"></a><span id="l33.2440">             nsAutoString proposedName;</span>
<a href="#l33.2441"></a><span id="l33.2441">             attachment-&gt;GetName(proposedName);</span>
<a href="#l33.2442"></a><span id="l33.2442" class="difflineminus">-            msg_pick_real_name(m_attachments[newLoc], proposedName.get(), mCompFields-&gt;GetCharacterSet());</span>
<a href="#l33.2443"></a><span id="l33.2443" class="difflineplus">+            msg_pick_real_name(m_attachments[newLoc], proposedName.get(),</span>
<a href="#l33.2444"></a><span id="l33.2444" class="difflineplus">+                               mCompFields-&gt;GetCharacterSet());</span>
<a href="#l33.2445"></a><span id="l33.2445">           }</span>
<a href="#l33.2446"></a><span id="l33.2446"> </span>
<a href="#l33.2447"></a><span id="l33.2447" class="difflineminus">-          // Now, most importantly, we need to figure out what the content type is for</span>
<a href="#l33.2448"></a><span id="l33.2448" class="difflineminus">-          // this attachment...If we can't, then just make it application/octet-stream</span>
<a href="#l33.2449"></a><span id="l33.2449" class="difflineminus">-</span>
<a href="#l33.2450"></a><span id="l33.2450" class="difflineminus">-  #ifdef MAC_OSX</span>
<a href="#l33.2451"></a><span id="l33.2451" class="difflineminus">-          //Mac always need to snarf the file to figure out how to send it, maybe we need to use apple double...</span>
<a href="#l33.2452"></a><span id="l33.2452" class="difflineminus">-          //  unless caller has already set the content type, in which case, trust them.</span>
<a href="#l33.2453"></a><span id="l33.2453" class="difflineplus">+          // Now, most importantly, we need to figure out what the content type</span>
<a href="#l33.2454"></a><span id="l33.2454" class="difflineplus">+          // is for this attachment... If we can't, then just make it</span>
<a href="#l33.2455"></a><span id="l33.2455" class="difflineplus">+          // application/octet-stream.</span>
<a href="#l33.2456"></a><span id="l33.2456" class="difflineplus">+</span>
<a href="#l33.2457"></a><span id="l33.2457" class="difflineplus">+#ifdef MAC_OSX</span>
<a href="#l33.2458"></a><span id="l33.2458" class="difflineplus">+          // Mac always need to snarf the file to figure out how to send it,</span>
<a href="#l33.2459"></a><span id="l33.2459" class="difflineplus">+          // maybe we need to use apple double...</span>
<a href="#l33.2460"></a><span id="l33.2460" class="difflineplus">+          // unless caller has already set the content type, in which case,</span>
<a href="#l33.2461"></a><span id="l33.2461" class="difflineplus">+          // trust them.</span>
<a href="#l33.2462"></a><span id="l33.2462">           bool mustSnarfAttachment = true;</span>
<a href="#l33.2463"></a><span id="l33.2463" class="difflineminus">-  #else</span>
<a href="#l33.2464"></a><span id="l33.2464" class="difflineplus">+#else</span>
<a href="#l33.2465"></a><span id="l33.2465">           bool mustSnarfAttachment = false;</span>
<a href="#l33.2466"></a><span id="l33.2466" class="difflineminus">-  #endif</span>
<a href="#l33.2467"></a><span id="l33.2467" class="difflineminus">-          if (sendViaCloud)</span>
<a href="#l33.2468"></a><span id="l33.2468" class="difflineminus">-            mustSnarfAttachment = false;</span>
<a href="#l33.2469"></a><span id="l33.2469" class="difflineminus">-</span>
<a href="#l33.2470"></a><span id="l33.2470" class="difflineminus">-          attachment-&gt;GetContentType(getter_Copies(m_attachments[newLoc]-&gt;m_type));</span>
<a href="#l33.2471"></a><span id="l33.2471" class="difflineminus">-          if (m_attachments[newLoc]-&gt;m_type.IsEmpty())</span>
<a href="#l33.2472"></a><span id="l33.2472" class="difflineminus">-          {</span>
<a href="#l33.2473"></a><span id="l33.2473" class="difflineminus">-            nsresult  rv = NS_OK;</span>
<a href="#l33.2474"></a><span id="l33.2474" class="difflineminus">-            nsCOMPtr&lt;nsIMIMEService&gt; mimeFinder (do_GetService(NS_MIMESERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l33.2475"></a><span id="l33.2475" class="difflineminus">-            if (NS_SUCCEEDED(rv) &amp;&amp; mimeFinder)</span>
<a href="#l33.2476"></a><span id="l33.2476" class="difflineminus">-            {</span>
<a href="#l33.2477"></a><span id="l33.2477" class="difflineplus">+#endif</span>
<a href="#l33.2478"></a><span id="l33.2478" class="difflineplus">+          if (sendViaCloud) mustSnarfAttachment = false;</span>
<a href="#l33.2479"></a><span id="l33.2479" class="difflineplus">+</span>
<a href="#l33.2480"></a><span id="l33.2480" class="difflineplus">+          attachment-&gt;GetContentType(</span>
<a href="#l33.2481"></a><span id="l33.2481" class="difflineplus">+              getter_Copies(m_attachments[newLoc]-&gt;m_type));</span>
<a href="#l33.2482"></a><span id="l33.2482" class="difflineplus">+          if (m_attachments[newLoc]-&gt;m_type.IsEmpty()) {</span>
<a href="#l33.2483"></a><span id="l33.2483" class="difflineplus">+            nsresult rv = NS_OK;</span>
<a href="#l33.2484"></a><span id="l33.2484" class="difflineplus">+            nsCOMPtr&lt;nsIMIMEService&gt; mimeFinder(</span>
<a href="#l33.2485"></a><span id="l33.2485" class="difflineplus">+                do_GetService(NS_MIMESERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l33.2486"></a><span id="l33.2486" class="difflineplus">+            if (NS_SUCCEEDED(rv) &amp;&amp; mimeFinder) {</span>
<a href="#l33.2487"></a><span id="l33.2487">               nsCOMPtr&lt;nsIURL&gt; fileUrl;</span>
<a href="#l33.2488"></a><span id="l33.2488">               rv = NS_MutateURI(NS_STANDARDURLMUTATOR_CONTRACTID)</span>
<a href="#l33.2489"></a><span id="l33.2489" class="difflineminus">-                     .Apply(NS_MutatorMethod(&amp;nsIURLMutator::SetFileName,</span>
<a href="#l33.2490"></a><span id="l33.2490" class="difflineminus">-                                             m_attachments[newLoc]-&gt;m_realName,</span>
<a href="#l33.2491"></a><span id="l33.2491" class="difflineminus">-                                             nullptr))</span>
<a href="#l33.2492"></a><span id="l33.2492" class="difflineminus">-                     .Finalize(fileUrl);</span>
<a href="#l33.2493"></a><span id="l33.2493" class="difflineminus">-              if (NS_SUCCEEDED(rv))</span>
<a href="#l33.2494"></a><span id="l33.2494" class="difflineminus">-              {</span>
<a href="#l33.2495"></a><span id="l33.2495" class="difflineplus">+                       .Apply(NS_MutatorMethod(</span>
<a href="#l33.2496"></a><span id="l33.2496" class="difflineplus">+                           &amp;nsIURLMutator::SetFileName,</span>
<a href="#l33.2497"></a><span id="l33.2497" class="difflineplus">+                           m_attachments[newLoc]-&gt;m_realName, nullptr))</span>
<a href="#l33.2498"></a><span id="l33.2498" class="difflineplus">+                       .Finalize(fileUrl);</span>
<a href="#l33.2499"></a><span id="l33.2499" class="difflineplus">+              if (NS_SUCCEEDED(rv)) {</span>
<a href="#l33.2500"></a><span id="l33.2500">                 nsAutoCString fileExt;</span>
<a href="#l33.2501"></a><span id="l33.2501">                 // First try using the real file name.</span>
<a href="#l33.2502"></a><span id="l33.2502">                 rv = fileUrl-&gt;GetFileExtension(fileExt);</span>
<a href="#l33.2503"></a><span id="l33.2503">                 if (NS_SUCCEEDED(rv) &amp;&amp; !fileExt.IsEmpty()) {</span>
<a href="#l33.2504"></a><span id="l33.2504">                   nsAutoCString type;</span>
<a href="#l33.2505"></a><span id="l33.2505">                   mimeFinder-&gt;GetTypeFromExtension(fileExt, type);</span>
<a href="#l33.2506"></a><span id="l33.2506"> #ifndef XP_MACOSX</span>
<a href="#l33.2507"></a><span id="l33.2507" class="difflineminus">-                  if (!type.EqualsLiteral(&quot;multipart/appledouble&quot;))  // can't do apple double on non-macs</span>
<a href="#l33.2508"></a><span id="l33.2508" class="difflineplus">+                  if (!type.EqualsLiteral(</span>
<a href="#l33.2509"></a><span id="l33.2509" class="difflineplus">+                          &quot;multipart/appledouble&quot;))  // can't do apple double on</span>
<a href="#l33.2510"></a><span id="l33.2510" class="difflineplus">+                                                     // non-macs</span>
<a href="#l33.2511"></a><span id="l33.2511"> #endif</span>
<a href="#l33.2512"></a><span id="l33.2512" class="difflineminus">-                  m_attachments[newLoc]-&gt;m_type = type;</span>
<a href="#l33.2513"></a><span id="l33.2513" class="difflineplus">+                    m_attachments[newLoc]-&gt;m_type = type;</span>
<a href="#l33.2514"></a><span id="l33.2514">                 }</span>
<a href="#l33.2515"></a><span id="l33.2515"> </span>
<a href="#l33.2516"></a><span id="l33.2516" class="difflineminus">-                //Then try using the url if we still haven't figured out the content type</span>
<a href="#l33.2517"></a><span id="l33.2517" class="difflineminus">-                if (m_attachments[newLoc]-&gt;m_type.IsEmpty())</span>
<a href="#l33.2518"></a><span id="l33.2518" class="difflineminus">-                {</span>
<a href="#l33.2519"></a><span id="l33.2519" class="difflineplus">+                // Then try using the url if we still haven't figured out the</span>
<a href="#l33.2520"></a><span id="l33.2520" class="difflineplus">+                // content type</span>
<a href="#l33.2521"></a><span id="l33.2521" class="difflineplus">+                if (m_attachments[newLoc]-&gt;m_type.IsEmpty()) {</span>
<a href="#l33.2522"></a><span id="l33.2522">                   rv = NS_MutateURI(fileUrl).SetSpec(url).Finalize(fileUrl);</span>
<a href="#l33.2523"></a><span id="l33.2523" class="difflineminus">-                  if (NS_SUCCEEDED(rv))</span>
<a href="#l33.2524"></a><span id="l33.2524" class="difflineminus">-                  {</span>
<a href="#l33.2525"></a><span id="l33.2525" class="difflineplus">+                  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l33.2526"></a><span id="l33.2526">                     rv = fileUrl-&gt;GetFileExtension(fileExt);</span>
<a href="#l33.2527"></a><span id="l33.2527">                     if (NS_SUCCEEDED(rv) &amp;&amp; !fileExt.IsEmpty()) {</span>
<a href="#l33.2528"></a><span id="l33.2528">                       nsAutoCString type;</span>
<a href="#l33.2529"></a><span id="l33.2529">                       mimeFinder-&gt;GetTypeFromExtension(fileExt, type);</span>
<a href="#l33.2530"></a><span id="l33.2530" class="difflineminus">-  #ifndef XP_MACOSX</span>
<a href="#l33.2531"></a><span id="l33.2531" class="difflineminus">-                    if (!type.EqualsLiteral(&quot;multipart/appledouble&quot;))  // can't do apple double on non-macs</span>
<a href="#l33.2532"></a><span id="l33.2532" class="difflineminus">-  #endif</span>
<a href="#l33.2533"></a><span id="l33.2533" class="difflineminus">-                      m_attachments[newLoc]-&gt;m_type = type;</span>
<a href="#l33.2534"></a><span id="l33.2534" class="difflineminus">-                    // rtf and vcs files may look like text to sniffers,</span>
<a href="#l33.2535"></a><span id="l33.2535" class="difflineminus">-                    // but they're not human readable.</span>
<a href="#l33.2536"></a><span id="l33.2536" class="difflineminus">-                    if (type.IsEmpty() &amp;&amp; !fileExt.IsEmpty() &amp;&amp;</span>
<a href="#l33.2537"></a><span id="l33.2537" class="difflineminus">-                         (MsgLowerCaseEqualsLiteral(fileExt, &quot;rtf&quot;) ||</span>
<a href="#l33.2538"></a><span id="l33.2538" class="difflineminus">-                          MsgLowerCaseEqualsLiteral(fileExt, &quot;vcs&quot;)))</span>
<a href="#l33.2539"></a><span id="l33.2539" class="difflineminus">-                      m_attachments[newLoc]-&gt;m_type = APPLICATION_OCTET_STREAM;</span>
<a href="#l33.2540"></a><span id="l33.2540" class="difflineplus">+#ifndef XP_MACOSX</span>
<a href="#l33.2541"></a><span id="l33.2541" class="difflineplus">+                      if (!type.EqualsLiteral(</span>
<a href="#l33.2542"></a><span id="l33.2542" class="difflineplus">+                              &quot;multipart/appledouble&quot;))  // can't do apple</span>
<a href="#l33.2543"></a><span id="l33.2543" class="difflineplus">+                                                         // double on non-macs</span>
<a href="#l33.2544"></a><span id="l33.2544" class="difflineplus">+#endif</span>
<a href="#l33.2545"></a><span id="l33.2545" class="difflineplus">+                        m_attachments[newLoc]-&gt;m_type = type;</span>
<a href="#l33.2546"></a><span id="l33.2546" class="difflineplus">+                      // rtf and vcs files may look like text to sniffers,</span>
<a href="#l33.2547"></a><span id="l33.2547" class="difflineplus">+                      // but they're not human readable.</span>
<a href="#l33.2548"></a><span id="l33.2548" class="difflineplus">+                      if (type.IsEmpty() &amp;&amp; !fileExt.IsEmpty() &amp;&amp;</span>
<a href="#l33.2549"></a><span id="l33.2549" class="difflineplus">+                          (MsgLowerCaseEqualsLiteral(fileExt, &quot;rtf&quot;) ||</span>
<a href="#l33.2550"></a><span id="l33.2550" class="difflineplus">+                           MsgLowerCaseEqualsLiteral(fileExt, &quot;vcs&quot;)))</span>
<a href="#l33.2551"></a><span id="l33.2551" class="difflineplus">+                        m_attachments[newLoc]-&gt;m_type =</span>
<a href="#l33.2552"></a><span id="l33.2552" class="difflineplus">+                            APPLICATION_OCTET_STREAM;</span>
<a href="#l33.2553"></a><span id="l33.2553">                     }</span>
<a href="#l33.2554"></a><span id="l33.2554">                   }</span>
<a href="#l33.2555"></a><span id="l33.2555">                 }</span>
<a href="#l33.2556"></a><span id="l33.2556">               }</span>
<a href="#l33.2557"></a><span id="l33.2557">             }</span>
<a href="#l33.2558"></a><span id="l33.2558" class="difflineminus">-          }</span>
<a href="#l33.2559"></a><span id="l33.2559" class="difflineminus">-          else</span>
<a href="#l33.2560"></a><span id="l33.2560" class="difflineminus">-          {</span>
<a href="#l33.2561"></a><span id="l33.2561" class="difflineminus">-            attachment-&gt;GetContentTypeParam(getter_Copies(m_attachments[newLoc]-&gt;m_typeParam));</span>
<a href="#l33.2562"></a><span id="l33.2562" class="difflineplus">+          } else {</span>
<a href="#l33.2563"></a><span id="l33.2563" class="difflineplus">+            attachment-&gt;GetContentTypeParam(</span>
<a href="#l33.2564"></a><span id="l33.2564" class="difflineplus">+                getter_Copies(m_attachments[newLoc]-&gt;m_typeParam));</span>
<a href="#l33.2565"></a><span id="l33.2565">             mustSnarfAttachment = false;</span>
<a href="#l33.2566"></a><span id="l33.2566">           }</span>
<a href="#l33.2567"></a><span id="l33.2567"> </span>
<a href="#l33.2568"></a><span id="l33.2568" class="difflineminus">-          //We need to snarf the file to figure out how to send it only if we don't have a content type...</span>
<a href="#l33.2569"></a><span id="l33.2569" class="difflineminus">-          if (mustSnarfAttachment || m_attachments[newLoc]-&gt;m_type.IsEmpty())</span>
<a href="#l33.2570"></a><span id="l33.2570" class="difflineminus">-          {</span>
<a href="#l33.2571"></a><span id="l33.2571" class="difflineplus">+          // We need to snarf the file to figure out how to send it only if we</span>
<a href="#l33.2572"></a><span id="l33.2572" class="difflineplus">+          // don't have a content type...</span>
<a href="#l33.2573"></a><span id="l33.2573" class="difflineplus">+          if (mustSnarfAttachment || m_attachments[newLoc]-&gt;m_type.IsEmpty()) {</span>
<a href="#l33.2574"></a><span id="l33.2574">             m_attachments[newLoc]-&gt;m_done = false;</span>
<a href="#l33.2575"></a><span id="l33.2575">             m_attachments[newLoc]-&gt;SetMimeDeliveryState(this);</span>
<a href="#l33.2576"></a><span id="l33.2576" class="difflineminus">-          }</span>
<a href="#l33.2577"></a><span id="l33.2577" class="difflineminus">-          else</span>
<a href="#l33.2578"></a><span id="l33.2578" class="difflineminus">-          {</span>
<a href="#l33.2579"></a><span id="l33.2579" class="difflineplus">+          } else {</span>
<a href="#l33.2580"></a><span id="l33.2580">             m_attachments[newLoc]-&gt;m_done = true;</span>
<a href="#l33.2581"></a><span id="l33.2581">             m_attachments[newLoc]-&gt;SetMimeDeliveryState(nullptr);</span>
<a href="#l33.2582"></a><span id="l33.2582">           }</span>
<a href="#l33.2583"></a><span id="l33.2583" class="difflineminus">-          // For local files, if they are HTML docs and we don't have a charset, we should</span>
<a href="#l33.2584"></a><span id="l33.2584" class="difflineminus">-          // sniff the file and see if we can figure it out.</span>
<a href="#l33.2585"></a><span id="l33.2585" class="difflineminus">-          if (!m_attachments[newLoc]-&gt;m_type.IsEmpty())</span>
<a href="#l33.2586"></a><span id="l33.2586" class="difflineminus">-          {</span>
<a href="#l33.2587"></a><span id="l33.2587" class="difflineminus">-            if (m_attachments[newLoc]-&gt;m_type.LowerCaseEqualsLiteral(TEXT_HTML))</span>
<a href="#l33.2588"></a><span id="l33.2588" class="difflineminus">-            {</span>
<a href="#l33.2589"></a><span id="l33.2589" class="difflineminus">-              char *tmpCharset = (char *)nsMsgI18NParseMetaCharset(m_attachments[newLoc]-&gt;mTmpFile);</span>
<a href="#l33.2590"></a><span id="l33.2590" class="difflineplus">+          // For local files, if they are HTML docs and we don't have a charset,</span>
<a href="#l33.2591"></a><span id="l33.2591" class="difflineplus">+          // we should sniff the file and see if we can figure it out.</span>
<a href="#l33.2592"></a><span id="l33.2592" class="difflineplus">+          if (!m_attachments[newLoc]-&gt;m_type.IsEmpty()) {</span>
<a href="#l33.2593"></a><span id="l33.2593" class="difflineplus">+            if (m_attachments[newLoc]-&gt;m_type.LowerCaseEqualsLiteral(</span>
<a href="#l33.2594"></a><span id="l33.2594" class="difflineplus">+                    TEXT_HTML)) {</span>
<a href="#l33.2595"></a><span id="l33.2595" class="difflineplus">+              char *tmpCharset = (char *)nsMsgI18NParseMetaCharset(</span>
<a href="#l33.2596"></a><span id="l33.2596" class="difflineplus">+                  m_attachments[newLoc]-&gt;mTmpFile);</span>
<a href="#l33.2597"></a><span id="l33.2597">               if (tmpCharset[0] != '\0')</span>
<a href="#l33.2598"></a><span id="l33.2598">                 m_attachments[newLoc]-&gt;m_charset = tmpCharset;</span>
<a href="#l33.2599"></a><span id="l33.2599">             }</span>
<a href="#l33.2600"></a><span id="l33.2600">           }</span>
<a href="#l33.2601"></a><span id="l33.2601"> </span>
<a href="#l33.2602"></a><span id="l33.2602" class="difflineminus">-          attachment-&gt;GetMacType(getter_Copies(m_attachments[newLoc]-&gt;m_xMacType));</span>
<a href="#l33.2603"></a><span id="l33.2603" class="difflineminus">-          attachment-&gt;GetMacCreator(getter_Copies(m_attachments[newLoc]-&gt;m_xMacCreator));</span>
<a href="#l33.2604"></a><span id="l33.2604" class="difflineplus">+          attachment-&gt;GetMacType(</span>
<a href="#l33.2605"></a><span id="l33.2605" class="difflineplus">+              getter_Copies(m_attachments[newLoc]-&gt;m_xMacType));</span>
<a href="#l33.2606"></a><span id="l33.2606" class="difflineplus">+          attachment-&gt;GetMacCreator(</span>
<a href="#l33.2607"></a><span id="l33.2607" class="difflineplus">+              getter_Copies(m_attachments[newLoc]-&gt;m_xMacCreator));</span>
<a href="#l33.2608"></a><span id="l33.2608"> </span>
<a href="#l33.2609"></a><span id="l33.2609">           ++newLoc;</span>
<a href="#l33.2610"></a><span id="l33.2610">         }</span>
<a href="#l33.2611"></a><span id="l33.2611">       }</span>
<a href="#l33.2612"></a><span id="l33.2612">     }</span>
<a href="#l33.2613"></a><span id="l33.2613">   }</span>
<a href="#l33.2614"></a><span id="l33.2614">   return NS_OK;</span>
<a href="#l33.2615"></a><span id="l33.2615"> }</span>
<a href="#l33.2616"></a><span id="l33.2616"> </span>
<a href="#l33.2617"></a><span id="l33.2617" class="difflineminus">-nsresult</span>
<a href="#l33.2618"></a><span id="l33.2618" class="difflineminus">-nsMsgComposeAndSend::AddCompFieldRemoteAttachments(uint32_t   aStartLocation,</span>
<a href="#l33.2619"></a><span id="l33.2619" class="difflineminus">-                                                   int32_t    *aMailboxCount,</span>
<a href="#l33.2620"></a><span id="l33.2620" class="difflineminus">-                                                   int32_t    *aNewsCount)</span>
<a href="#l33.2621"></a><span id="l33.2621" class="difflineminus">-{</span>
<a href="#l33.2622"></a><span id="l33.2622" class="difflineplus">+nsresult nsMsgComposeAndSend::AddCompFieldRemoteAttachments(</span>
<a href="#l33.2623"></a><span id="l33.2623" class="difflineplus">+    uint32_t aStartLocation, int32_t *aMailboxCount, int32_t *aNewsCount) {</span>
<a href="#l33.2624"></a><span id="l33.2624">   // If none, just return...</span>
<a href="#l33.2625"></a><span id="l33.2625" class="difflineminus">-  if (mCompFieldRemoteAttachments &lt;= 0)</span>
<a href="#l33.2626"></a><span id="l33.2626" class="difflineminus">-    return NS_OK;</span>
<a href="#l33.2627"></a><span id="l33.2627" class="difflineminus">-</span>
<a href="#l33.2628"></a><span id="l33.2628" class="difflineminus">-  //Get the attachments array</span>
<a href="#l33.2629"></a><span id="l33.2629" class="difflineplus">+  if (mCompFieldRemoteAttachments &lt;= 0) return NS_OK;</span>
<a href="#l33.2630"></a><span id="l33.2630" class="difflineplus">+</span>
<a href="#l33.2631"></a><span id="l33.2631" class="difflineplus">+  // Get the attachments array</span>
<a href="#l33.2632"></a><span id="l33.2632">   nsCOMPtr&lt;nsISimpleEnumerator&gt; attachments;</span>
<a href="#l33.2633"></a><span id="l33.2633">   mCompFields-&gt;GetAttachments(getter_AddRefs(attachments));</span>
<a href="#l33.2634"></a><span id="l33.2634" class="difflineminus">-  if (!attachments)</span>
<a href="#l33.2635"></a><span id="l33.2635" class="difflineminus">-    return NS_OK;</span>
<a href="#l33.2636"></a><span id="l33.2636" class="difflineminus">-</span>
<a href="#l33.2637"></a><span id="l33.2637" class="difflineminus">-  uint32_t  newLoc = aStartLocation;</span>
<a href="#l33.2638"></a><span id="l33.2638" class="difflineplus">+  if (!attachments) return NS_OK;</span>
<a href="#l33.2639"></a><span id="l33.2639" class="difflineplus">+</span>
<a href="#l33.2640"></a><span id="l33.2640" class="difflineplus">+  uint32_t newLoc = aStartLocation;</span>
<a href="#l33.2641"></a><span id="l33.2641"> </span>
<a href="#l33.2642"></a><span id="l33.2642">   nsresult rv;</span>
<a href="#l33.2643"></a><span id="l33.2643">   bool moreAttachments;</span>
<a href="#l33.2644"></a><span id="l33.2644">   nsCString url;</span>
<a href="#l33.2645"></a><span id="l33.2645">   nsCOMPtr&lt;nsISupports&gt; element;</span>
<a href="#l33.2646"></a><span id="l33.2646" class="difflineminus">-  while (NS_SUCCEEDED(attachments-&gt;HasMoreElements(&amp;moreAttachments)) &amp;&amp; moreAttachments) {</span>
<a href="#l33.2647"></a><span id="l33.2647" class="difflineplus">+  while (NS_SUCCEEDED(attachments-&gt;HasMoreElements(&amp;moreAttachments)) &amp;&amp;</span>
<a href="#l33.2648"></a><span id="l33.2648" class="difflineplus">+         moreAttachments) {</span>
<a href="#l33.2649"></a><span id="l33.2649">     rv = attachments-&gt;GetNext(getter_AddRefs(element));</span>
<a href="#l33.2650"></a><span id="l33.2650">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l33.2651"></a><span id="l33.2651"> </span>
<a href="#l33.2652"></a><span id="l33.2652">     nsCOMPtr&lt;nsIMsgAttachment&gt; attachment = do_QueryInterface(element, &amp;rv);</span>
<a href="#l33.2653"></a><span id="l33.2653" class="difflineminus">-     if (NS_SUCCEEDED(rv) &amp;&amp; attachment)</span>
<a href="#l33.2654"></a><span id="l33.2654" class="difflineminus">-    {</span>
<a href="#l33.2655"></a><span id="l33.2655" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; attachment) {</span>
<a href="#l33.2656"></a><span id="l33.2656">       attachment-&gt;GetUrl(url);</span>
<a href="#l33.2657"></a><span id="l33.2657" class="difflineminus">-      if (!url.IsEmpty())</span>
<a href="#l33.2658"></a><span id="l33.2658" class="difflineminus">-      {</span>
<a href="#l33.2659"></a><span id="l33.2659" class="difflineplus">+      if (!url.IsEmpty()) {</span>
<a href="#l33.2660"></a><span id="l33.2660">         // Just look for files that are NOT local file attachments and do</span>
<a href="#l33.2661"></a><span id="l33.2661">         // the right thing.</span>
<a href="#l33.2662"></a><span id="l33.2662" class="difflineminus">-        if (! nsMsgIsLocalFile(url.get()))</span>
<a href="#l33.2663"></a><span id="l33.2663" class="difflineminus">-        {</span>
<a href="#l33.2664"></a><span id="l33.2664" class="difflineminus">-          // Check for message attachment, see nsMsgMailNewsUrl::GetIsMessageUri.</span>
<a href="#l33.2665"></a><span id="l33.2665" class="difflineplus">+        if (!nsMsgIsLocalFile(url.get())) {</span>
<a href="#l33.2666"></a><span id="l33.2666" class="difflineplus">+          // Check for message attachment, see</span>
<a href="#l33.2667"></a><span id="l33.2667" class="difflineplus">+          // nsMsgMailNewsUrl::GetIsMessageUri.</span>
<a href="#l33.2668"></a><span id="l33.2668">           nsCOMPtr&lt;nsIURI&gt; nsiuri;</span>
<a href="#l33.2669"></a><span id="l33.2669" class="difflineminus">-          rv = NS_MutateURI(NS_STANDARDURLMUTATOR_CONTRACTID).SetSpec(url).Finalize(nsiuri);</span>
<a href="#l33.2670"></a><span id="l33.2670" class="difflineplus">+          rv = NS_MutateURI(NS_STANDARDURLMUTATOR_CONTRACTID)</span>
<a href="#l33.2671"></a><span id="l33.2671" class="difflineplus">+                   .SetSpec(url)</span>
<a href="#l33.2672"></a><span id="l33.2672" class="difflineplus">+                   .Finalize(nsiuri);</span>
<a href="#l33.2673"></a><span id="l33.2673">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l33.2674"></a><span id="l33.2674"> </span>
<a href="#l33.2675"></a><span id="l33.2675">           nsAutoCString scheme;</span>
<a href="#l33.2676"></a><span id="l33.2676">           nsiuri-&gt;GetScheme(scheme);</span>
<a href="#l33.2677"></a><span id="l33.2677">           bool isAMessageAttachment =</span>
<a href="#l33.2678"></a><span id="l33.2678" class="difflineminus">-            StringEndsWith(scheme, NS_LITERAL_CSTRING(&quot;-message&quot;));</span>
<a href="#l33.2679"></a><span id="l33.2679" class="difflineplus">+              StringEndsWith(scheme, NS_LITERAL_CSTRING(&quot;-message&quot;));</span>
<a href="#l33.2680"></a><span id="l33.2680"> </span>
<a href="#l33.2681"></a><span id="l33.2681">           m_attachments[newLoc]-&gt;mDeleteFile = true;</span>
<a href="#l33.2682"></a><span id="l33.2682">           m_attachments[newLoc]-&gt;m_done = false;</span>
<a href="#l33.2683"></a><span id="l33.2683">           m_attachments[newLoc]-&gt;SetMimeDeliveryState(this);</span>
<a href="#l33.2684"></a><span id="l33.2684"> </span>
<a href="#l33.2685"></a><span id="l33.2685">           if (!isAMessageAttachment)</span>
<a href="#l33.2686"></a><span id="l33.2686">             nsMsgNewURL(getter_AddRefs(m_attachments[newLoc]-&gt;mURL), url);</span>
<a href="#l33.2687"></a><span id="l33.2687"> </span>
<a href="#l33.2688"></a><span id="l33.2688">           m_attachments[newLoc]-&gt;m_encoding = ENCODING_7BIT;</span>
<a href="#l33.2689"></a><span id="l33.2689"> </span>
<a href="#l33.2690"></a><span id="l33.2690" class="difflineminus">-          attachment-&gt;GetMacType(getter_Copies(m_attachments[newLoc]-&gt;m_xMacType));</span>
<a href="#l33.2691"></a><span id="l33.2691" class="difflineminus">-          attachment-&gt;GetMacCreator(getter_Copies(m_attachments[newLoc]-&gt;m_xMacCreator));</span>
<a href="#l33.2692"></a><span id="l33.2692" class="difflineplus">+          attachment-&gt;GetMacType(</span>
<a href="#l33.2693"></a><span id="l33.2693" class="difflineplus">+              getter_Copies(m_attachments[newLoc]-&gt;m_xMacType));</span>
<a href="#l33.2694"></a><span id="l33.2694" class="difflineplus">+          attachment-&gt;GetMacCreator(</span>
<a href="#l33.2695"></a><span id="l33.2695" class="difflineplus">+              getter_Copies(m_attachments[newLoc]-&gt;m_xMacCreator));</span>
<a href="#l33.2696"></a><span id="l33.2696"> </span>
<a href="#l33.2697"></a><span id="l33.2697">           /* Count up attachments which are going to come from mail folders</span>
<a href="#l33.2698"></a><span id="l33.2698">              and from NNTP servers. */</span>
<a href="#l33.2699"></a><span id="l33.2699">           bool do_add_attachment = false;</span>
<a href="#l33.2700"></a><span id="l33.2700" class="difflineminus">-          if (isAMessageAttachment)</span>
<a href="#l33.2701"></a><span id="l33.2701" class="difflineminus">-          {</span>
<a href="#l33.2702"></a><span id="l33.2702" class="difflineplus">+          if (isAMessageAttachment) {</span>
<a href="#l33.2703"></a><span id="l33.2703">             do_add_attachment = true;</span>
<a href="#l33.2704"></a><span id="l33.2704">             if (!PL_strncasecmp(url.get(), &quot;news-message://&quot;, 15))</span>
<a href="#l33.2705"></a><span id="l33.2705">               (*aNewsCount)++;</span>
<a href="#l33.2706"></a><span id="l33.2706">             else</span>
<a href="#l33.2707"></a><span id="l33.2707">               (*aMailboxCount)++;</span>
<a href="#l33.2708"></a><span id="l33.2708"> </span>
<a href="#l33.2709"></a><span id="l33.2709">             m_attachments[newLoc]-&gt;m_uri = url;</span>
<a href="#l33.2710"></a><span id="l33.2710">             m_attachments[newLoc]-&gt;mURL = nullptr;</span>
<a href="#l33.2711"></a><span id="l33.2711" class="difflineminus">-          }</span>
<a href="#l33.2712"></a><span id="l33.2712" class="difflineminus">-          else</span>
<a href="#l33.2713"></a><span id="l33.2713" class="difflineplus">+          } else</span>
<a href="#l33.2714"></a><span id="l33.2714">             do_add_attachment = (nullptr != m_attachments[newLoc]-&gt;mURL);</span>
<a href="#l33.2715"></a><span id="l33.2715">           m_attachments[newLoc]-&gt;mSendViaCloud = false;</span>
<a href="#l33.2716"></a><span id="l33.2716" class="difflineminus">-          if (do_add_attachment)</span>
<a href="#l33.2717"></a><span id="l33.2717" class="difflineminus">-          {</span>
<a href="#l33.2718"></a><span id="l33.2718" class="difflineplus">+          if (do_add_attachment) {</span>
<a href="#l33.2719"></a><span id="l33.2719">             nsAutoString proposedName;</span>
<a href="#l33.2720"></a><span id="l33.2720">             attachment-&gt;GetName(proposedName);</span>
<a href="#l33.2721"></a><span id="l33.2721" class="difflineminus">-            msg_pick_real_name(m_attachments[newLoc], proposedName.get(), mCompFields-&gt;GetCharacterSet());</span>
<a href="#l33.2722"></a><span id="l33.2722" class="difflineplus">+            msg_pick_real_name(m_attachments[newLoc], proposedName.get(),</span>
<a href="#l33.2723"></a><span id="l33.2723" class="difflineplus">+                               mCompFields-&gt;GetCharacterSet());</span>
<a href="#l33.2724"></a><span id="l33.2724">             ++newLoc;</span>
<a href="#l33.2725"></a><span id="l33.2725">           }</span>
<a href="#l33.2726"></a><span id="l33.2726">         }</span>
<a href="#l33.2727"></a><span id="l33.2727">       }</span>
<a href="#l33.2728"></a><span id="l33.2728">     }</span>
<a href="#l33.2729"></a><span id="l33.2729">   }</span>
<a href="#l33.2730"></a><span id="l33.2730">   return NS_OK;</span>
<a href="#l33.2731"></a><span id="l33.2731"> }</span>
<a href="#l33.2732"></a><span id="l33.2732"> </span>
<a href="#l33.2733"></a><span id="l33.2733" class="difflineminus">-nsresult</span>
<a href="#l33.2734"></a><span id="l33.2734" class="difflineminus">-nsMsgComposeAndSend::HackAttachments(nsIArray *attachments,</span>
<a href="#l33.2735"></a><span id="l33.2735" class="difflineminus">-                                     nsIArray *preloadedAttachments)</span>
<a href="#l33.2736"></a><span id="l33.2736" class="difflineminus">-{</span>
<a href="#l33.2737"></a><span id="l33.2737" class="difflineplus">+nsresult nsMsgComposeAndSend::HackAttachments(nsIArray *attachments,</span>
<a href="#l33.2738"></a><span id="l33.2738" class="difflineplus">+                                              nsIArray *preloadedAttachments) {</span>
<a href="#l33.2739"></a><span id="l33.2739">   //</span>
<a href="#l33.2740"></a><span id="l33.2740">   // First, count the total number of attachments we are going to process</span>
<a href="#l33.2741"></a><span id="l33.2741">   // for this operation! This is a little more complicated than you might</span>
<a href="#l33.2742"></a><span id="l33.2742" class="difflineminus">-  // think because we have a few ways to specify attachments. Via the nsMsgAttachmentData</span>
<a href="#l33.2743"></a><span id="l33.2743" class="difflineminus">-  // as well as the composition fields.</span>
<a href="#l33.2744"></a><span id="l33.2744" class="difflineplus">+  // think because we have a few ways to specify attachments. Via the</span>
<a href="#l33.2745"></a><span id="l33.2745" class="difflineplus">+  // nsMsgAttachmentData as well as the composition fields.</span>
<a href="#l33.2746"></a><span id="l33.2746">   //</span>
<a href="#l33.2747"></a><span id="l33.2747">   CountCompFieldAttachments();</span>
<a href="#l33.2748"></a><span id="l33.2748"> </span>
<a href="#l33.2749"></a><span id="l33.2749">   // Count the preloaded attachments!</span>
<a href="#l33.2750"></a><span id="l33.2750">   mPreloadedAttachmentCount = 0;</span>
<a href="#l33.2751"></a><span id="l33.2751"> </span>
<a href="#l33.2752"></a><span id="l33.2752">   // For now, manually add the local attachments in the comp field!</span>
<a href="#l33.2753"></a><span id="l33.2753">   mPreloadedAttachmentCount += mCompFieldLocalAttachments;</span>
<a href="#l33.2754"></a><span id="l33.2754">   uint32_t numAttachments = 0, numPreloadedAttachments = 0;</span>
<a href="#l33.2755"></a><span id="l33.2755" class="difflineminus">-  if (attachments)</span>
<a href="#l33.2756"></a><span id="l33.2756" class="difflineminus">-    attachments-&gt;GetLength(&amp;numAttachments);</span>
<a href="#l33.2757"></a><span id="l33.2757" class="difflineplus">+  if (attachments) attachments-&gt;GetLength(&amp;numAttachments);</span>
<a href="#l33.2758"></a><span id="l33.2758">   if (preloadedAttachments)</span>
<a href="#l33.2759"></a><span id="l33.2759">     preloadedAttachments-&gt;GetLength(&amp;numPreloadedAttachments);</span>
<a href="#l33.2760"></a><span id="l33.2760">   mPreloadedAttachmentCount += numPreloadedAttachments;</span>
<a href="#l33.2761"></a><span id="l33.2761"> </span>
<a href="#l33.2762"></a><span id="l33.2762">   // Count the attachments we have to go retrieve! Keep in mind, that these</span>
<a href="#l33.2763"></a><span id="l33.2763">   // will be APPENDED to the current list of URL's that we have gathered if</span>
<a href="#l33.2764"></a><span id="l33.2764">   // this is a multpart/related send operation</span>
<a href="#l33.2765"></a><span id="l33.2765">   mRemoteAttachmentCount = GetMultipartRelatedCount();</span>
<a href="#l33.2766"></a><span id="l33.2766"> </span>
<a href="#l33.2767"></a><span id="l33.2767">   // For now, manually add the remote attachments in the comp field!</span>
<a href="#l33.2768"></a><span id="l33.2768">   mRemoteAttachmentCount += mCompFieldRemoteAttachments;</span>
<a href="#l33.2769"></a><span id="l33.2769"> </span>
<a href="#l33.2770"></a><span id="l33.2770">   mRemoteAttachmentCount += numAttachments;</span>
<a href="#l33.2771"></a><span id="l33.2771"> </span>
<a href="#l33.2772"></a><span id="l33.2772">   m_attachment_count = mPreloadedAttachmentCount + mRemoteAttachmentCount;</span>
<a href="#l33.2773"></a><span id="l33.2773"> </span>
<a href="#l33.2774"></a><span id="l33.2774" class="difflineminus">-  uint32_t i; // counter for location in attachment array...</span>
<a href="#l33.2775"></a><span id="l33.2775" class="difflineplus">+  uint32_t i;  // counter for location in attachment array...</span>
<a href="#l33.2776"></a><span id="l33.2776">   // Now create the array of attachment handlers...</span>
<a href="#l33.2777"></a><span id="l33.2777">   for (i = 0; i &lt; m_attachment_count; i++) {</span>
<a href="#l33.2778"></a><span id="l33.2778">     RefPtr&lt;nsMsgAttachmentHandler&gt; handler = new nsMsgAttachmentHandler;</span>
<a href="#l33.2779"></a><span id="l33.2779">     m_attachments.AppendElement(handler);</span>
<a href="#l33.2780"></a><span id="l33.2780">   }</span>
<a href="#l33.2781"></a><span id="l33.2781"> </span>
<a href="#l33.2782"></a><span id="l33.2782">   //</span>
<a href="#l33.2783"></a><span id="l33.2783">   // First, we need to attach the files that are defined in the comp fields...</span>
<a href="#l33.2784"></a><span id="l33.2784" class="difflineminus">-  if (NS_FAILED(AddCompFieldLocalAttachments()))</span>
<a href="#l33.2785"></a><span id="l33.2785" class="difflineminus">-    return NS_ERROR_INVALID_ARG;</span>
<a href="#l33.2786"></a><span id="l33.2786" class="difflineplus">+  if (NS_FAILED(AddCompFieldLocalAttachments())) return NS_ERROR_INVALID_ARG;</span>
<a href="#l33.2787"></a><span id="l33.2787"> </span>
<a href="#l33.2788"></a><span id="l33.2788">   // Now handle the preloaded attachments...</span>
<a href="#l33.2789"></a><span id="l33.2789" class="difflineminus">-  if (numPreloadedAttachments &gt; 0)</span>
<a href="#l33.2790"></a><span id="l33.2790" class="difflineminus">-  {</span>
<a href="#l33.2791"></a><span id="l33.2791" class="difflineplus">+  if (numPreloadedAttachments &gt; 0) {</span>
<a href="#l33.2792"></a><span id="l33.2792">     // These are attachments which have already been downloaded to tmp files.</span>
<a href="#l33.2793"></a><span id="l33.2793">     // We merely need to point the internal attachment data at those tmp</span>
<a href="#l33.2794"></a><span id="l33.2794">     // files.</span>
<a href="#l33.2795"></a><span id="l33.2795">     m_pre_snarfed_attachments_p = true;</span>
<a href="#l33.2796"></a><span id="l33.2796"> </span>
<a href="#l33.2797"></a><span id="l33.2797" class="difflineminus">-    for (i = mCompFieldLocalAttachments; i &lt; mPreloadedAttachmentCount; i++)</span>
<a href="#l33.2798"></a><span id="l33.2798" class="difflineminus">-    {</span>
<a href="#l33.2799"></a><span id="l33.2799" class="difflineminus">-      nsCOMPtr&lt;nsIMsgAttachedFile&gt; attachedFile = do_QueryElementAt(preloadedAttachments, i);</span>
<a href="#l33.2800"></a><span id="l33.2800" class="difflineminus">-      if (!attachedFile)</span>
<a href="#l33.2801"></a><span id="l33.2801" class="difflineminus">-        continue;</span>
<a href="#l33.2802"></a><span id="l33.2802" class="difflineplus">+    for (i = mCompFieldLocalAttachments; i &lt; mPreloadedAttachmentCount; i++) {</span>
<a href="#l33.2803"></a><span id="l33.2803" class="difflineplus">+      nsCOMPtr&lt;nsIMsgAttachedFile&gt; attachedFile =</span>
<a href="#l33.2804"></a><span id="l33.2804" class="difflineplus">+          do_QueryElementAt(preloadedAttachments, i);</span>
<a href="#l33.2805"></a><span id="l33.2805" class="difflineplus">+      if (!attachedFile) continue;</span>
<a href="#l33.2806"></a><span id="l33.2806"> </span>
<a href="#l33.2807"></a><span id="l33.2807">       /* These attachments are already &quot;snarfed&quot;. */</span>
<a href="#l33.2808"></a><span id="l33.2808">       m_attachments[i]-&gt;mDeleteFile = false;</span>
<a href="#l33.2809"></a><span id="l33.2809">       m_attachments[i]-&gt;SetMimeDeliveryState(nullptr);</span>
<a href="#l33.2810"></a><span id="l33.2810">       m_attachments[i]-&gt;m_done = true;</span>
<a href="#l33.2811"></a><span id="l33.2811"> </span>
<a href="#l33.2812"></a><span id="l33.2812">       attachedFile-&gt;GetOrigUrl(getter_AddRefs(m_attachments[i]-&gt;mURL));</span>
<a href="#l33.2813"></a><span id="l33.2813"> </span>
<a href="#l33.2814"></a><span id="l33.2814">       attachedFile-&gt;GetType(m_attachments[i]-&gt;m_type);</span>
<a href="#l33.2815"></a><span id="l33.2815"> </span>
<a href="#l33.2816"></a><span id="l33.2816">       // Set it to the compose fields for a default...</span>
<a href="#l33.2817"></a><span id="l33.2817">       m_attachments[i]-&gt;m_charset = mCompFields-&gt;GetCharacterSet();</span>
<a href="#l33.2818"></a><span id="l33.2818"> </span>
<a href="#l33.2819"></a><span id="l33.2819" class="difflineminus">-      // If we still don't have a content type, we should really try sniff one out!</span>
<a href="#l33.2820"></a><span id="l33.2820" class="difflineplus">+      // If we still don't have a content type, we should really try sniff one</span>
<a href="#l33.2821"></a><span id="l33.2821" class="difflineplus">+      // out!</span>
<a href="#l33.2822"></a><span id="l33.2822">       if (m_attachments[i]-&gt;m_type.IsEmpty())</span>
<a href="#l33.2823"></a><span id="l33.2823">         m_attachments[i]-&gt;PickEncoding(mCompFields-&gt;GetCharacterSet(), this);</span>
<a href="#l33.2824"></a><span id="l33.2824"> </span>
<a href="#l33.2825"></a><span id="l33.2825" class="difflineminus">-      // For local files, if they are HTML docs and we don't have a charset, we should</span>
<a href="#l33.2826"></a><span id="l33.2826" class="difflineminus">-      // sniff the file and see if we can figure it out.</span>
<a href="#l33.2827"></a><span id="l33.2827" class="difflineminus">-      if (!m_attachments[i]-&gt;m_type.IsEmpty())</span>
<a href="#l33.2828"></a><span id="l33.2828" class="difflineminus">-      {</span>
<a href="#l33.2829"></a><span id="l33.2829" class="difflineplus">+      // For local files, if they are HTML docs and we don't have a charset, we</span>
<a href="#l33.2830"></a><span id="l33.2830" class="difflineplus">+      // should sniff the file and see if we can figure it out.</span>
<a href="#l33.2831"></a><span id="l33.2831" class="difflineplus">+      if (!m_attachments[i]-&gt;m_type.IsEmpty()) {</span>
<a href="#l33.2832"></a><span id="l33.2832">         nsCOMPtr&lt;nsIFile&gt; tmpFile;</span>
<a href="#l33.2833"></a><span id="l33.2833">         attachedFile-&gt;GetTmpFile(getter_AddRefs(tmpFile));</span>
<a href="#l33.2834"></a><span id="l33.2834" class="difflineminus">-        if (m_attachments[i]-&gt;m_type.LowerCaseEqualsLiteral(TEXT_HTML) &amp;&amp; tmpFile)</span>
<a href="#l33.2835"></a><span id="l33.2835" class="difflineminus">-        {</span>
<a href="#l33.2836"></a><span id="l33.2836" class="difflineplus">+        if (m_attachments[i]-&gt;m_type.LowerCaseEqualsLiteral(TEXT_HTML) &amp;&amp;</span>
<a href="#l33.2837"></a><span id="l33.2837" class="difflineplus">+            tmpFile) {</span>
<a href="#l33.2838"></a><span id="l33.2838">           char *tmpCharset = (char *)nsMsgI18NParseMetaCharset(tmpFile);</span>
<a href="#l33.2839"></a><span id="l33.2839" class="difflineminus">-          if (tmpCharset[0] != '\0')</span>
<a href="#l33.2840"></a><span id="l33.2840" class="difflineminus">-            m_attachments[i]-&gt;m_charset = tmpCharset;</span>
<a href="#l33.2841"></a><span id="l33.2841" class="difflineplus">+          if (tmpCharset[0] != '\0') m_attachments[i]-&gt;m_charset = tmpCharset;</span>
<a href="#l33.2842"></a><span id="l33.2842">         }</span>
<a href="#l33.2843"></a><span id="l33.2843">       }</span>
<a href="#l33.2844"></a><span id="l33.2844"> </span>
<a href="#l33.2845"></a><span id="l33.2845">       attachedFile-&gt;GetDescription(m_attachments[i]-&gt;m_description);</span>
<a href="#l33.2846"></a><span id="l33.2846">       attachedFile-&gt;GetRealName(m_attachments[i]-&gt;m_realName);</span>
<a href="#l33.2847"></a><span id="l33.2847">       attachedFile-&gt;GetXMacType(m_attachments[i]-&gt;m_xMacType);</span>
<a href="#l33.2848"></a><span id="l33.2848">       attachedFile-&gt;GetXMacCreator(m_attachments[i]-&gt;m_xMacCreator);</span>
<a href="#l33.2849"></a><span id="l33.2849">       attachedFile-&gt;GetEncoding(m_attachments[i]-&gt;m_encoding);</span>
<a href="#l33.2850"></a><span id="l33.2850"> </span>
<a href="#l33.2851"></a><span id="l33.2851" class="difflineminus">-      if (m_attachments[i]-&gt;mTmpFile)</span>
<a href="#l33.2852"></a><span id="l33.2852" class="difflineminus">-      {</span>
<a href="#l33.2853"></a><span id="l33.2853" class="difflineplus">+      if (m_attachments[i]-&gt;mTmpFile) {</span>
<a href="#l33.2854"></a><span id="l33.2854">         if (m_attachments[i]-&gt;mDeleteFile)</span>
<a href="#l33.2855"></a><span id="l33.2855">           m_attachments[i]-&gt;mTmpFile-&gt;Remove(false);</span>
<a href="#l33.2856"></a><span id="l33.2856">         m_attachments[i]-&gt;mTmpFile = nullptr;</span>
<a href="#l33.2857"></a><span id="l33.2857">       }</span>
<a href="#l33.2858"></a><span id="l33.2858">       attachedFile-&gt;GetTmpFile(getter_AddRefs(m_attachments[i]-&gt;mTmpFile));</span>
<a href="#l33.2859"></a><span id="l33.2859"> </span>
<a href="#l33.2860"></a><span id="l33.2860">       attachedFile-&gt;GetSize(&amp;m_attachments[i]-&gt;m_size);</span>
<a href="#l33.2861"></a><span id="l33.2861">       attachedFile-&gt;GetUnprintableCount(&amp;m_attachments[i]-&gt;m_unprintable_count);</span>
<a href="#l33.2862"></a><span id="l33.2862" class="difflineat">@@ -2314,137 +2086,131 @@ nsMsgComposeAndSend::HackAttachments(nsI</span>
<a href="#l33.2863"></a><span id="l33.2863">       the &quot;null&quot; encodings, then keep it. */</span>
<a href="#l33.2864"></a><span id="l33.2864">       if (!m_attachments[i]-&gt;m_encoding.IsEmpty() &amp;&amp;</span>
<a href="#l33.2865"></a><span id="l33.2865">           !m_attachments[i]-&gt;m_encoding.LowerCaseEqualsLiteral(ENCODING_7BIT) &amp;&amp;</span>
<a href="#l33.2866"></a><span id="l33.2866">           !m_attachments[i]-&gt;m_encoding.LowerCaseEqualsLiteral(ENCODING_8BIT) &amp;&amp;</span>
<a href="#l33.2867"></a><span id="l33.2867">           !m_attachments[i]-&gt;m_encoding.LowerCaseEqualsLiteral(ENCODING_BINARY))</span>
<a href="#l33.2868"></a><span id="l33.2868">         m_attachments[i]-&gt;m_already_encoded_p = true;</span>
<a href="#l33.2869"></a><span id="l33.2869"> </span>
<a href="#l33.2870"></a><span id="l33.2870">       if (m_attachments[i]-&gt;mURL)</span>
<a href="#l33.2871"></a><span id="l33.2871" class="difflineminus">-        msg_pick_real_name(m_attachments[i], nullptr, mCompFields-&gt;GetCharacterSet());</span>
<a href="#l33.2872"></a><span id="l33.2872" class="difflineplus">+        msg_pick_real_name(m_attachments[i], nullptr,</span>
<a href="#l33.2873"></a><span id="l33.2873" class="difflineplus">+                           mCompFields-&gt;GetCharacterSet());</span>
<a href="#l33.2874"></a><span id="l33.2874">     }</span>
<a href="#l33.2875"></a><span id="l33.2875">   }</span>
<a href="#l33.2876"></a><span id="l33.2876"> </span>
<a href="#l33.2877"></a><span id="l33.2877">   // First, handle the multipart related attachments if any...</span>
<a href="#l33.2878"></a><span id="l33.2878">   //</span>
<a href="#l33.2879"></a><span id="l33.2879">   int32_t mailbox_count = 0, news_count = 0;</span>
<a href="#l33.2880"></a><span id="l33.2880">   int32_t multipartRelatedCount = GetMultipartRelatedCount();</span>
<a href="#l33.2881"></a><span id="l33.2881"> </span>
<a href="#l33.2882"></a><span id="l33.2882" class="difflineminus">-  if (multipartRelatedCount &gt; 0)</span>
<a href="#l33.2883"></a><span id="l33.2883" class="difflineminus">-  {</span>
<a href="#l33.2884"></a><span id="l33.2884" class="difflineplus">+  if (multipartRelatedCount &gt; 0) {</span>
<a href="#l33.2885"></a><span id="l33.2885">     nsresult rv = ProcessMultipartRelated(&amp;mailbox_count, &amp;news_count);</span>
<a href="#l33.2886"></a><span id="l33.2886" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l33.2887"></a><span id="l33.2887" class="difflineminus">-    {</span>
<a href="#l33.2888"></a><span id="l33.2888" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l33.2889"></a><span id="l33.2889">       // The destructor will take care of the m_attachment array</span>
<a href="#l33.2890"></a><span id="l33.2890">       return rv;</span>
<a href="#l33.2891"></a><span id="l33.2891">     }</span>
<a href="#l33.2892"></a><span id="l33.2892">   }</span>
<a href="#l33.2893"></a><span id="l33.2893"> </span>
<a href="#l33.2894"></a><span id="l33.2894">   //</span>
<a href="#l33.2895"></a><span id="l33.2895">   // Now add the comp field remote attachments...</span>
<a href="#l33.2896"></a><span id="l33.2896">   //</span>
<a href="#l33.2897"></a><span id="l33.2897" class="difflineminus">-  if (NS_FAILED( AddCompFieldRemoteAttachments( (mPreloadedAttachmentCount + multipartRelatedCount),</span>
<a href="#l33.2898"></a><span id="l33.2898" class="difflineminus">-                                                 &amp;mailbox_count, &amp;news_count) ))</span>
<a href="#l33.2899"></a><span id="l33.2899" class="difflineplus">+  if (NS_FAILED(AddCompFieldRemoteAttachments(</span>
<a href="#l33.2900"></a><span id="l33.2900" class="difflineplus">+          (mPreloadedAttachmentCount + multipartRelatedCount), &amp;mailbox_count,</span>
<a href="#l33.2901"></a><span id="l33.2901" class="difflineplus">+          &amp;news_count)))</span>
<a href="#l33.2902"></a><span id="l33.2902">     return NS_ERROR_INVALID_ARG;</span>
<a href="#l33.2903"></a><span id="l33.2903"> </span>
<a href="#l33.2904"></a><span id="l33.2904">   //</span>
<a href="#l33.2905"></a><span id="l33.2905" class="difflineminus">-  // Now deal remote attachments and attach multipart/related attachments (url's and such..)</span>
<a href="#l33.2906"></a><span id="l33.2906" class="difflineminus">-  // first!</span>
<a href="#l33.2907"></a><span id="l33.2907" class="difflineplus">+  // Now deal remote attachments and attach multipart/related attachments (url's</span>
<a href="#l33.2908"></a><span id="l33.2908" class="difflineplus">+  // and such..) first!</span>
<a href="#l33.2909"></a><span id="l33.2909">   //</span>
<a href="#l33.2910"></a><span id="l33.2910" class="difflineminus">-  if (attachments)</span>
<a href="#l33.2911"></a><span id="l33.2911" class="difflineminus">-  {</span>
<a href="#l33.2912"></a><span id="l33.2912" class="difflineminus">-    int32_t     locCount = -1;</span>
<a href="#l33.2913"></a><span id="l33.2913" class="difflineminus">-</span>
<a href="#l33.2914"></a><span id="l33.2914" class="difflineminus">-    for (i = (mPreloadedAttachmentCount + GetMultipartRelatedCount() + mCompFieldRemoteAttachments); i &lt; m_attachment_count; i++)</span>
<a href="#l33.2915"></a><span id="l33.2915" class="difflineminus">-    {</span>
<a href="#l33.2916"></a><span id="l33.2916" class="difflineplus">+  if (attachments) {</span>
<a href="#l33.2917"></a><span id="l33.2917" class="difflineplus">+    int32_t locCount = -1;</span>
<a href="#l33.2918"></a><span id="l33.2918" class="difflineplus">+</span>
<a href="#l33.2919"></a><span id="l33.2919" class="difflineplus">+    for (i = (mPreloadedAttachmentCount + GetMultipartRelatedCount() +</span>
<a href="#l33.2920"></a><span id="l33.2920" class="difflineplus">+              mCompFieldRemoteAttachments);</span>
<a href="#l33.2921"></a><span id="l33.2921" class="difflineplus">+         i &lt; m_attachment_count; i++) {</span>
<a href="#l33.2922"></a><span id="l33.2922">       locCount++;</span>
<a href="#l33.2923"></a><span id="l33.2923" class="difflineminus">-      nsCOMPtr&lt;nsIMsgAttachmentData&gt; attachment(do_QueryElementAt(attachments, i));</span>
<a href="#l33.2924"></a><span id="l33.2924" class="difflineminus">-      if (!attachment)</span>
<a href="#l33.2925"></a><span id="l33.2925" class="difflineminus">-        continue;</span>
<a href="#l33.2926"></a><span id="l33.2926" class="difflineplus">+      nsCOMPtr&lt;nsIMsgAttachmentData&gt; attachment(</span>
<a href="#l33.2927"></a><span id="l33.2927" class="difflineplus">+          do_QueryElementAt(attachments, i));</span>
<a href="#l33.2928"></a><span id="l33.2928" class="difflineplus">+      if (!attachment) continue;</span>
<a href="#l33.2929"></a><span id="l33.2929">       m_attachments[i]-&gt;mDeleteFile = true;</span>
<a href="#l33.2930"></a><span id="l33.2930">       m_attachments[i]-&gt;m_done = false;</span>
<a href="#l33.2931"></a><span id="l33.2931">       m_attachments[i]-&gt;SetMimeDeliveryState(this);</span>
<a href="#l33.2932"></a><span id="l33.2932"> </span>
<a href="#l33.2933"></a><span id="l33.2933">       attachment-&gt;GetUrl(getter_AddRefs(m_attachments[i]-&gt;mURL));</span>
<a href="#l33.2934"></a><span id="l33.2934"> </span>
<a href="#l33.2935"></a><span id="l33.2935">       attachment-&gt;GetRealType(m_attachments[i]-&gt;m_overrideType);</span>
<a href="#l33.2936"></a><span id="l33.2936">       m_attachments[i]-&gt;m_charset = mCompFields-&gt;GetCharacterSet();</span>
<a href="#l33.2937"></a><span id="l33.2937">       attachment-&gt;GetRealEncoding(m_attachments[i]-&gt;m_overrideEncoding);</span>
<a href="#l33.2938"></a><span id="l33.2938">       attachment-&gt;GetDesiredType(m_attachments[i]-&gt;m_desiredType);</span>
<a href="#l33.2939"></a><span id="l33.2939">       attachment-&gt;GetDescription(m_attachments[i]-&gt;m_description);</span>
<a href="#l33.2940"></a><span id="l33.2940">       attachment-&gt;GetRealName(m_attachments[i]-&gt;m_realName);</span>
<a href="#l33.2941"></a><span id="l33.2941">       attachment-&gt;GetXMacType(m_attachments[i]-&gt;m_xMacType);</span>
<a href="#l33.2942"></a><span id="l33.2942">       attachment-&gt;GetXMacCreator(m_attachments[i]-&gt;m_xMacCreator);</span>
<a href="#l33.2943"></a><span id="l33.2943">       m_attachments[i]-&gt;m_encoding = ENCODING_7BIT;</span>
<a href="#l33.2944"></a><span id="l33.2944"> </span>
<a href="#l33.2945"></a><span id="l33.2945" class="difflineminus">-      // real name is set in the case of vcard so don't change it.  XXX STILL NEEDED?</span>
<a href="#l33.2946"></a><span id="l33.2946" class="difflineminus">-      // m_attachments[i]-&gt;m_real_name = 0;</span>
<a href="#l33.2947"></a><span id="l33.2947" class="difflineplus">+      // real name is set in the case of vcard so don't change it.  XXX STILL</span>
<a href="#l33.2948"></a><span id="l33.2948" class="difflineplus">+      // NEEDED? m_attachments[i]-&gt;m_real_name = 0;</span>
<a href="#l33.2949"></a><span id="l33.2949"> </span>
<a href="#l33.2950"></a><span id="l33.2950">       /* Count up attachments which are going to come from mail folders</span>
<a href="#l33.2951"></a><span id="l33.2951">       and from NNTP servers. */</span>
<a href="#l33.2952"></a><span id="l33.2952" class="difflineminus">-      if (m_attachments[i]-&gt;mURL)</span>
<a href="#l33.2953"></a><span id="l33.2953" class="difflineminus">-      {</span>
<a href="#l33.2954"></a><span id="l33.2954" class="difflineplus">+      if (m_attachments[i]-&gt;mURL) {</span>
<a href="#l33.2955"></a><span id="l33.2955">         nsIURI *uri = m_attachments[i]-&gt;mURL;</span>
<a href="#l33.2956"></a><span id="l33.2956">         bool match = false;</span>
<a href="#l33.2957"></a><span id="l33.2957">         if ((NS_SUCCEEDED(uri-&gt;SchemeIs(&quot;mailbox&quot;, &amp;match)) &amp;&amp; match) ||</span>
<a href="#l33.2958"></a><span id="l33.2958">             (NS_SUCCEEDED(uri-&gt;SchemeIs(&quot;imap&quot;, &amp;match)) &amp;&amp; match))</span>
<a href="#l33.2959"></a><span id="l33.2959">           mailbox_count++;</span>
<a href="#l33.2960"></a><span id="l33.2960">         else if ((NS_SUCCEEDED(uri-&gt;SchemeIs(&quot;news&quot;, &amp;match)) &amp;&amp; match) ||</span>
<a href="#l33.2961"></a><span id="l33.2961">                  (NS_SUCCEEDED(uri-&gt;SchemeIs(&quot;snews&quot;, &amp;match)) &amp;&amp; match))</span>
<a href="#l33.2962"></a><span id="l33.2962" class="difflineminus">-            news_count++;</span>
<a href="#l33.2963"></a><span id="l33.2963" class="difflineminus">-        else</span>
<a href="#l33.2964"></a><span id="l33.2964" class="difflineminus">-        {</span>
<a href="#l33.2965"></a><span id="l33.2965" class="difflineplus">+          news_count++;</span>
<a href="#l33.2966"></a><span id="l33.2966" class="difflineplus">+        else {</span>
<a href="#l33.2967"></a><span id="l33.2967">           // Additional account types need a mechanism to report that they are</span>
<a href="#l33.2968"></a><span id="l33.2968">           // message protocols. If there is an nsIMsgProtocolInfo component</span>
<a href="#l33.2969"></a><span id="l33.2969">           // registered for this scheme, we'll consider it a mailbox</span>
<a href="#l33.2970"></a><span id="l33.2970">           // attachment.</span>
<a href="#l33.2971"></a><span id="l33.2971">           nsAutoCString contractID;</span>
<a href="#l33.2972"></a><span id="l33.2972">           contractID.Assign(</span>
<a href="#l33.2973"></a><span id="l33.2973" class="difflineminus">-            NS_LITERAL_CSTRING(&quot;@mozilla.org/messenger/protocol/info;1&quot;));</span>
<a href="#l33.2974"></a><span id="l33.2974" class="difflineplus">+              NS_LITERAL_CSTRING(&quot;@mozilla.org/messenger/protocol/info;1&quot;));</span>
<a href="#l33.2975"></a><span id="l33.2975">           nsAutoCString scheme;</span>
<a href="#l33.2976"></a><span id="l33.2976">           uri-&gt;GetScheme(scheme);</span>
<a href="#l33.2977"></a><span id="l33.2977">           contractID.Append(scheme);</span>
<a href="#l33.2978"></a><span id="l33.2978">           nsCOMPtr&lt;nsIMsgProtocolInfo&gt; msgProtocolInfo =</span>
<a href="#l33.2979"></a><span id="l33.2979" class="difflineminus">-            do_CreateInstance(contractID.get());</span>
<a href="#l33.2980"></a><span id="l33.2980" class="difflineminus">-          if (msgProtocolInfo)</span>
<a href="#l33.2981"></a><span id="l33.2981" class="difflineminus">-            mailbox_count++;</span>
<a href="#l33.2982"></a><span id="l33.2982" class="difflineplus">+              do_CreateInstance(contractID.get());</span>
<a href="#l33.2983"></a><span id="l33.2983" class="difflineplus">+          if (msgProtocolInfo) mailbox_count++;</span>
<a href="#l33.2984"></a><span id="l33.2984">         }</span>
<a href="#l33.2985"></a><span id="l33.2985">         if (uri)</span>
<a href="#l33.2986"></a><span id="l33.2986" class="difflineminus">-          msg_pick_real_name(m_attachments[i], nullptr, mCompFields-&gt;GetCharacterSet());</span>
<a href="#l33.2987"></a><span id="l33.2987" class="difflineplus">+          msg_pick_real_name(m_attachments[i], nullptr,</span>
<a href="#l33.2988"></a><span id="l33.2988" class="difflineplus">+                             mCompFields-&gt;GetCharacterSet());</span>
<a href="#l33.2989"></a><span id="l33.2989">       }</span>
<a href="#l33.2990"></a><span id="l33.2990">     }</span>
<a href="#l33.2991"></a><span id="l33.2991">   }</span>
<a href="#l33.2992"></a><span id="l33.2992"> </span>
<a href="#l33.2993"></a><span id="l33.2993">   bool needToCallGatherMimeAttachments = true;</span>
<a href="#l33.2994"></a><span id="l33.2994"> </span>
<a href="#l33.2995"></a><span id="l33.2995" class="difflineminus">-  if (m_attachment_count &gt; 0)</span>
<a href="#l33.2996"></a><span id="l33.2996" class="difflineminus">-  {</span>
<a href="#l33.2997"></a><span id="l33.2997" class="difflineplus">+  if (m_attachment_count &gt; 0) {</span>
<a href="#l33.2998"></a><span id="l33.2998">     // If there is more than one mailbox URL, or more than one NNTP url,</span>
<a href="#l33.2999"></a><span id="l33.2999">     // do the load in serial rather than parallel, for efficiency.</span>
<a href="#l33.3000"></a><span id="l33.3000" class="difflineminus">-    if (mailbox_count &gt; 1 || news_count &gt; 1)</span>
<a href="#l33.3001"></a><span id="l33.3001" class="difflineminus">-      m_be_synchronous_p = true;</span>
<a href="#l33.3002"></a><span id="l33.3002" class="difflineplus">+    if (mailbox_count &gt; 1 || news_count &gt; 1) m_be_synchronous_p = true;</span>
<a href="#l33.3003"></a><span id="l33.3003"> </span>
<a href="#l33.3004"></a><span id="l33.3004">     m_attachment_pending_count = m_attachment_count;</span>
<a href="#l33.3005"></a><span id="l33.3005"> </span>
<a href="#l33.3006"></a><span id="l33.3006">     // Start the URL attachments loading (eventually, an exit routine will</span>
<a href="#l33.3007"></a><span id="l33.3007">     // call the done_callback).</span>
<a href="#l33.3008"></a><span id="l33.3008"> </span>
<a href="#l33.3009"></a><span id="l33.3009" class="difflineminus">-    for (i = 0; i &lt; m_attachment_count; i++)</span>
<a href="#l33.3010"></a><span id="l33.3010" class="difflineminus">-    {</span>
<a href="#l33.3011"></a><span id="l33.3011" class="difflineminus">-      if (m_attachments[i]-&gt;m_done || m_attachments[i]-&gt;mSendViaCloud)</span>
<a href="#l33.3012"></a><span id="l33.3012" class="difflineminus">-      {</span>
<a href="#l33.3013"></a><span id="l33.3013" class="difflineplus">+    for (i = 0; i &lt; m_attachment_count; i++) {</span>
<a href="#l33.3014"></a><span id="l33.3014" class="difflineplus">+      if (m_attachments[i]-&gt;m_done || m_attachments[i]-&gt;mSendViaCloud) {</span>
<a href="#l33.3015"></a><span id="l33.3015">         m_attachment_pending_count--;</span>
<a href="#l33.3016"></a><span id="l33.3016">         continue;</span>
<a href="#l33.3017"></a><span id="l33.3017">       }</span>
<a href="#l33.3018"></a><span id="l33.3018"> </span>
<a href="#l33.3019"></a><span id="l33.3019">       //</span>
<a href="#l33.3020"></a><span id="l33.3020" class="difflineminus">-      //  IF we get here and the URL is NULL, just dec the pending count and move on!!!</span>
<a href="#l33.3021"></a><span id="l33.3021" class="difflineplus">+      //  IF we get here and the URL is NULL, just dec the pending count and</span>
<a href="#l33.3022"></a><span id="l33.3022" class="difflineplus">+      //  move on!!!</span>
<a href="#l33.3023"></a><span id="l33.3023">       //</span>
<a href="#l33.3024"></a><span id="l33.3024" class="difflineminus">-      if ( (!m_attachments[i]-&gt;mURL) &amp;&amp; (!m_attachments[i]-&gt;m_uri.Length()) )</span>
<a href="#l33.3025"></a><span id="l33.3025" class="difflineminus">-      {</span>
<a href="#l33.3026"></a><span id="l33.3026" class="difflineplus">+      if ((!m_attachments[i]-&gt;mURL) &amp;&amp; (!m_attachments[i]-&gt;m_uri.Length())) {</span>
<a href="#l33.3027"></a><span id="l33.3027">         m_attachments[i]-&gt;m_bogus_attachment = true;</span>
<a href="#l33.3028"></a><span id="l33.3028">         m_attachments[i]-&gt;m_done = true;</span>
<a href="#l33.3029"></a><span id="l33.3029">         m_attachments[i]-&gt;SetMimeDeliveryState(nullptr);</span>
<a href="#l33.3030"></a><span id="l33.3030">         m_attachment_pending_count--;</span>
<a href="#l33.3031"></a><span id="l33.3031">         continue;</span>
<a href="#l33.3032"></a><span id="l33.3032">       }</span>
<a href="#l33.3033"></a><span id="l33.3033"> </span>
<a href="#l33.3034"></a><span id="l33.3034">       //</span>
<a href="#l33.3035"></a><span id="l33.3035" class="difflineat">@@ -2460,222 +2226,191 @@ nsMsgComposeAndSend::HackAttachments(nsI</span>
<a href="#l33.3036"></a><span id="l33.3036">       if (!params.IsEmpty()) {</span>
<a href="#l33.3037"></a><span id="l33.3037">         formatParams[0] = params.get();</span>
<a href="#l33.3038"></a><span id="l33.3038">       } else if (m_attachments[i]-&gt;mURL) {</span>
<a href="#l33.3039"></a><span id="l33.3039">         nsCString asciiSpec;</span>
<a href="#l33.3040"></a><span id="l33.3040">         m_attachments[i]-&gt;mURL-&gt;GetAsciiSpec(asciiSpec);</span>
<a href="#l33.3041"></a><span id="l33.3041">         attachmentFileName.AssignASCII(asciiSpec.get());</span>
<a href="#l33.3042"></a><span id="l33.3042">         formatParams[0] = attachmentFileName.get();</span>
<a href="#l33.3043"></a><span id="l33.3043">       }</span>
<a href="#l33.3044"></a><span id="l33.3044" class="difflineminus">-      mComposeBundle-&gt;FormatStringFromName(&quot;gatheringAttachment&quot;,</span>
<a href="#l33.3045"></a><span id="l33.3045" class="difflineminus">-                                           formatParams, 1, msg);</span>
<a href="#l33.3046"></a><span id="l33.3046" class="difflineminus">-</span>
<a href="#l33.3047"></a><span id="l33.3047" class="difflineminus">-      if (!msg.IsEmpty())</span>
<a href="#l33.3048"></a><span id="l33.3048" class="difflineminus">-      {</span>
<a href="#l33.3049"></a><span id="l33.3049" class="difflineplus">+      mComposeBundle-&gt;FormatStringFromName(&quot;gatheringAttachment&quot;, formatParams,</span>
<a href="#l33.3050"></a><span id="l33.3050" class="difflineplus">+                                           1, msg);</span>
<a href="#l33.3051"></a><span id="l33.3051" class="difflineplus">+</span>
<a href="#l33.3052"></a><span id="l33.3052" class="difflineplus">+      if (!msg.IsEmpty()) {</span>
<a href="#l33.3053"></a><span id="l33.3053">         SetStatusMessage(msg);</span>
<a href="#l33.3054"></a><span id="l33.3054">       }</span>
<a href="#l33.3055"></a><span id="l33.3055"> </span>
<a href="#l33.3056"></a><span id="l33.3056" class="difflineminus">-      /* As SnarfAttachment will call GatherMimeAttachments when it will be done (this is an async process),</span>
<a href="#l33.3057"></a><span id="l33.3057" class="difflineminus">-         we need to avoid to call it ourself.</span>
<a href="#l33.3058"></a><span id="l33.3058" class="difflineplus">+      /* As SnarfAttachment will call GatherMimeAttachments when it will be done</span>
<a href="#l33.3059"></a><span id="l33.3059" class="difflineplus">+         (this is an async process), we need to avoid to call it ourself.</span>
<a href="#l33.3060"></a><span id="l33.3060">       */</span>
<a href="#l33.3061"></a><span id="l33.3061">       needToCallGatherMimeAttachments = false;</span>
<a href="#l33.3062"></a><span id="l33.3062"> </span>
<a href="#l33.3063"></a><span id="l33.3063">       nsresult status = m_attachments[i]-&gt;SnarfAttachment(mCompFields);</span>
<a href="#l33.3064"></a><span id="l33.3064" class="difflineminus">-      if (NS_FAILED(status))</span>
<a href="#l33.3065"></a><span id="l33.3065" class="difflineminus">-      {</span>
<a href="#l33.3066"></a><span id="l33.3066" class="difflineplus">+      if (NS_FAILED(status)) {</span>
<a href="#l33.3067"></a><span id="l33.3067">         nsString errorMsg;</span>
<a href="#l33.3068"></a><span id="l33.3068" class="difflineminus">-        NS_CopyNativeToUnicode(m_attachments[i]-&gt;m_realName, attachmentFileName);</span>
<a href="#l33.3069"></a><span id="l33.3069" class="difflineplus">+        NS_CopyNativeToUnicode(m_attachments[i]-&gt;m_realName,</span>
<a href="#l33.3070"></a><span id="l33.3070" class="difflineplus">+                               attachmentFileName);</span>
<a href="#l33.3071"></a><span id="l33.3071">         nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l33.3072"></a><span id="l33.3072" class="difflineminus">-        const char16_t *params[] = { attachmentFileName.get() };</span>
<a href="#l33.3073"></a><span id="l33.3073" class="difflineminus">-        mComposeBundle-&gt;FormatStringFromName(&quot;errorAttachingFile&quot;,</span>
<a href="#l33.3074"></a><span id="l33.3074" class="difflineminus">-                                             params, 1,</span>
<a href="#l33.3075"></a><span id="l33.3075" class="difflineplus">+        const char16_t *params[] = {attachmentFileName.get()};</span>
<a href="#l33.3076"></a><span id="l33.3076" class="difflineplus">+        mComposeBundle-&gt;FormatStringFromName(&quot;errorAttachingFile&quot;, params, 1,</span>
<a href="#l33.3077"></a><span id="l33.3077">                                              errorMsg);</span>
<a href="#l33.3078"></a><span id="l33.3078" class="difflineminus">-        mSendReport-&gt;SetMessage(nsIMsgSendReport::process_Current, errorMsg.get(), false);</span>
<a href="#l33.3079"></a><span id="l33.3079" class="difflineplus">+        mSendReport-&gt;SetMessage(nsIMsgSendReport::process_Current,</span>
<a href="#l33.3080"></a><span id="l33.3080" class="difflineplus">+                                errorMsg.get(), false);</span>
<a href="#l33.3081"></a><span id="l33.3081">         mSendReport-&gt;SetError(nsIMsgSendReport::process_Current,</span>
<a href="#l33.3082"></a><span id="l33.3082" class="difflineminus">-                              NS_MSG_ERROR_ATTACHING_FILE,</span>
<a href="#l33.3083"></a><span id="l33.3083" class="difflineminus">-                              false);</span>
<a href="#l33.3084"></a><span id="l33.3084" class="difflineplus">+                              NS_MSG_ERROR_ATTACHING_FILE, false);</span>
<a href="#l33.3085"></a><span id="l33.3085">         return NS_MSG_ERROR_ATTACHING_FILE;</span>
<a href="#l33.3086"></a><span id="l33.3086">       }</span>
<a href="#l33.3087"></a><span id="l33.3087" class="difflineminus">-      if (m_be_synchronous_p)</span>
<a href="#l33.3088"></a><span id="l33.3088" class="difflineminus">-        break;</span>
<a href="#l33.3089"></a><span id="l33.3089" class="difflineplus">+      if (m_be_synchronous_p) break;</span>
<a href="#l33.3090"></a><span id="l33.3090">     }</span>
<a href="#l33.3091"></a><span id="l33.3091">   }</span>
<a href="#l33.3092"></a><span id="l33.3092"> </span>
<a href="#l33.3093"></a><span id="l33.3093">   // If no attachments - finish now (this will call the done_callback).</span>
<a href="#l33.3094"></a><span id="l33.3094" class="difflineminus">-  if (needToCallGatherMimeAttachments)</span>
<a href="#l33.3095"></a><span id="l33.3095" class="difflineminus">-    return GatherMimeAttachments();</span>
<a href="#l33.3096"></a><span id="l33.3096" class="difflineplus">+  if (needToCallGatherMimeAttachments) return GatherMimeAttachments();</span>
<a href="#l33.3097"></a><span id="l33.3097"> </span>
<a href="#l33.3098"></a><span id="l33.3098">   return NS_OK;</span>
<a href="#l33.3099"></a><span id="l33.3099"> }</span>
<a href="#l33.3100"></a><span id="l33.3100"> </span>
<a href="#l33.3101"></a><span id="l33.3101" class="difflineminus">-nsresult</span>
<a href="#l33.3102"></a><span id="l33.3102" class="difflineminus">-nsMsgComposeAndSend::InitCompositionFields(nsMsgCompFields *fields,</span>
<a href="#l33.3103"></a><span id="l33.3103" class="difflineminus">-                                           const nsACString &amp;aOriginalMsgURI,</span>
<a href="#l33.3104"></a><span id="l33.3104" class="difflineminus">-                                           MSG_ComposeType aType)</span>
<a href="#l33.3105"></a><span id="l33.3105" class="difflineminus">-{</span>
<a href="#l33.3106"></a><span id="l33.3106" class="difflineminus">-  nsresult        rv = NS_OK;</span>
<a href="#l33.3107"></a><span id="l33.3107" class="difflineminus">-  const char      *pStr = nullptr;</span>
<a href="#l33.3108"></a><span id="l33.3108" class="difflineplus">+nsresult nsMsgComposeAndSend::InitCompositionFields(</span>
<a href="#l33.3109"></a><span id="l33.3109" class="difflineplus">+    nsMsgCompFields *fields, const nsACString &amp;aOriginalMsgURI,</span>
<a href="#l33.3110"></a><span id="l33.3110" class="difflineplus">+    MSG_ComposeType aType) {</span>
<a href="#l33.3111"></a><span id="l33.3111" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l33.3112"></a><span id="l33.3112" class="difflineplus">+  const char *pStr = nullptr;</span>
<a href="#l33.3113"></a><span id="l33.3113"> </span>
<a href="#l33.3114"></a><span id="l33.3114">   mCompFields = new nsMsgCompFields();</span>
<a href="#l33.3115"></a><span id="l33.3115" class="difflineminus">-  if (!mCompFields)</span>
<a href="#l33.3116"></a><span id="l33.3116" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l33.3117"></a><span id="l33.3117" class="difflineplus">+  if (!mCompFields) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l33.3118"></a><span id="l33.3118"> </span>
<a href="#l33.3119"></a><span id="l33.3119">   const char *cset = fields-&gt;GetCharacterSet();</span>
<a href="#l33.3120"></a><span id="l33.3120">   // Make sure charset is sane...</span>
<a href="#l33.3121"></a><span id="l33.3121" class="difflineminus">-  if (!cset || !*cset)</span>
<a href="#l33.3122"></a><span id="l33.3122" class="difflineminus">-  {</span>
<a href="#l33.3123"></a><span id="l33.3123" class="difflineplus">+  if (!cset || !*cset) {</span>
<a href="#l33.3124"></a><span id="l33.3124">     mCompFields-&gt;SetCharacterSet(&quot;UTF-8&quot;);</span>
<a href="#l33.3125"></a><span id="l33.3125" class="difflineminus">-  }</span>
<a href="#l33.3126"></a><span id="l33.3126" class="difflineminus">-  else</span>
<a href="#l33.3127"></a><span id="l33.3127" class="difflineminus">-  {</span>
<a href="#l33.3128"></a><span id="l33.3128" class="difflineplus">+  } else {</span>
<a href="#l33.3129"></a><span id="l33.3129">     mCompFields-&gt;SetCharacterSet(fields-&gt;GetCharacterSet());</span>
<a href="#l33.3130"></a><span id="l33.3130">   }</span>
<a href="#l33.3131"></a><span id="l33.3131"> </span>
<a href="#l33.3132"></a><span id="l33.3132" class="difflineminus">-  // Now, we will look for a URI defined as the default FCC pref. If this is set,</span>
<a href="#l33.3133"></a><span id="l33.3133" class="difflineminus">-  // then SetFcc will use this value. The FCC field is a URI for the server that</span>
<a href="#l33.3134"></a><span id="l33.3134" class="difflineminus">-  // will hold the &quot;Sent&quot; folder...the</span>
<a href="#l33.3135"></a><span id="l33.3135" class="difflineplus">+  // Now, we will look for a URI defined as the default FCC pref. If this is</span>
<a href="#l33.3136"></a><span id="l33.3136" class="difflineplus">+  // set, then SetFcc will use this value. The FCC field is a URI for the server</span>
<a href="#l33.3137"></a><span id="l33.3137" class="difflineplus">+  // that will hold the &quot;Sent&quot; folder...the</span>
<a href="#l33.3138"></a><span id="l33.3138">   //</span>
<a href="#l33.3139"></a><span id="l33.3139">   // First, look at what was passed in via the &quot;fields&quot; structure...if that was</span>
<a href="#l33.3140"></a><span id="l33.3140">   // set then use it, otherwise, fall back to what is set in the prefs...</span>
<a href="#l33.3141"></a><span id="l33.3141">   //</span>
<a href="#l33.3142"></a><span id="l33.3142" class="difflineminus">-  // But even before that, pay attention to the new OVERRIDE pref that will cancel</span>
<a href="#l33.3143"></a><span id="l33.3143" class="difflineminus">-  // any and all copy operations!</span>
<a href="#l33.3144"></a><span id="l33.3144" class="difflineplus">+  // But even before that, pay attention to the new OVERRIDE pref that will</span>
<a href="#l33.3145"></a><span id="l33.3145" class="difflineplus">+  // cancel any and all copy operations!</span>
<a href="#l33.3146"></a><span id="l33.3146">   //</span>
<a href="#l33.3147"></a><span id="l33.3147" class="difflineminus">-  bool      doFcc = true;</span>
<a href="#l33.3148"></a><span id="l33.3148" class="difflineplus">+  bool doFcc = true;</span>
<a href="#l33.3149"></a><span id="l33.3149">   rv = mUserIdentity-&gt;GetDoFcc(&amp;doFcc);</span>
<a href="#l33.3150"></a><span id="l33.3150" class="difflineminus">-  if (!doFcc)</span>
<a href="#l33.3151"></a><span id="l33.3151" class="difflineminus">-  {</span>
<a href="#l33.3152"></a><span id="l33.3152" class="difflineplus">+  if (!doFcc) {</span>
<a href="#l33.3153"></a><span id="l33.3153">     // If the identity pref &quot;fcc&quot; is set to false, then we will not do</span>
<a href="#l33.3154"></a><span id="l33.3154">     // any FCC operation!</span>
<a href="#l33.3155"></a><span id="l33.3155">     mCompFields-&gt;SetFcc(&quot;&quot;);</span>
<a href="#l33.3156"></a><span id="l33.3156" class="difflineminus">-  }</span>
<a href="#l33.3157"></a><span id="l33.3157" class="difflineminus">-  else</span>
<a href="#l33.3158"></a><span id="l33.3158" class="difflineminus">-  {</span>
<a href="#l33.3159"></a><span id="l33.3159" class="difflineplus">+  } else {</span>
<a href="#l33.3160"></a><span id="l33.3160">     bool useDefaultFCC = true;</span>
<a href="#l33.3161"></a><span id="l33.3161">     const char *fieldsFCC = fields-&gt;GetFcc();</span>
<a href="#l33.3162"></a><span id="l33.3162" class="difflineminus">-    if (fieldsFCC &amp;&amp; *fieldsFCC)</span>
<a href="#l33.3163"></a><span id="l33.3163" class="difflineminus">-    {</span>
<a href="#l33.3164"></a><span id="l33.3164" class="difflineminus">-      if (PL_strcasecmp(fieldsFCC, &quot;nocopy://&quot;) == 0)</span>
<a href="#l33.3165"></a><span id="l33.3165" class="difflineminus">-      {</span>
<a href="#l33.3166"></a><span id="l33.3166" class="difflineplus">+    if (fieldsFCC &amp;&amp; *fieldsFCC) {</span>
<a href="#l33.3167"></a><span id="l33.3167" class="difflineplus">+      if (PL_strcasecmp(fieldsFCC, &quot;nocopy://&quot;) == 0) {</span>
<a href="#l33.3168"></a><span id="l33.3168">         useDefaultFCC = false;</span>
<a href="#l33.3169"></a><span id="l33.3169">         mCompFields-&gt;SetFcc(&quot;&quot;);</span>
<a href="#l33.3170"></a><span id="l33.3170" class="difflineminus">-      }</span>
<a href="#l33.3171"></a><span id="l33.3171" class="difflineminus">-      else</span>
<a href="#l33.3172"></a><span id="l33.3172" class="difflineminus">-      {</span>
<a href="#l33.3173"></a><span id="l33.3173" class="difflineplus">+      } else {</span>
<a href="#l33.3174"></a><span id="l33.3174">         nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l33.3175"></a><span id="l33.3175">         rv = FindFolder(nsDependentCString(fieldsFCC), getter_AddRefs(folder));</span>
<a href="#l33.3176"></a><span id="l33.3176">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l33.3177"></a><span id="l33.3177" class="difflineminus">-        if (folder)</span>
<a href="#l33.3178"></a><span id="l33.3178" class="difflineminus">-        {</span>
<a href="#l33.3179"></a><span id="l33.3179" class="difflineplus">+        if (folder) {</span>
<a href="#l33.3180"></a><span id="l33.3180">           useDefaultFCC = false;</span>
<a href="#l33.3181"></a><span id="l33.3181">           mCompFields-&gt;SetFcc(mime_fix_header(fieldsFCC));</span>
<a href="#l33.3182"></a><span id="l33.3182">         }</span>
<a href="#l33.3183"></a><span id="l33.3183">       }</span>
<a href="#l33.3184"></a><span id="l33.3184">     }</span>
<a href="#l33.3185"></a><span id="l33.3185"> </span>
<a href="#l33.3186"></a><span id="l33.3186" class="difflineminus">-    // We use default FCC setting if it's not set or was set to an invalid folder.</span>
<a href="#l33.3187"></a><span id="l33.3187" class="difflineminus">-    if (useDefaultFCC)</span>
<a href="#l33.3188"></a><span id="l33.3188" class="difflineminus">-    {</span>
<a href="#l33.3189"></a><span id="l33.3189" class="difflineplus">+    // We use default FCC setting if it's not set or was set to an invalid</span>
<a href="#l33.3190"></a><span id="l33.3190" class="difflineplus">+    // folder.</span>
<a href="#l33.3191"></a><span id="l33.3191" class="difflineplus">+    if (useDefaultFCC) {</span>
<a href="#l33.3192"></a><span id="l33.3192">       // Only check whether the user wants the message in the original message</span>
<a href="#l33.3193"></a><span id="l33.3193">       // folder if the msgcomptype is some kind of a reply.</span>
<a href="#l33.3194"></a><span id="l33.3194" class="difflineminus">-      if (!aOriginalMsgURI.IsEmpty() &amp;&amp; (</span>
<a href="#l33.3195"></a><span id="l33.3195" class="difflineminus">-            aType == nsIMsgCompType::Reply ||</span>
<a href="#l33.3196"></a><span id="l33.3196" class="difflineminus">-            aType == nsIMsgCompType::ReplyAll ||</span>
<a href="#l33.3197"></a><span id="l33.3197" class="difflineminus">-            aType == nsIMsgCompType::ReplyToGroup ||</span>
<a href="#l33.3198"></a><span id="l33.3198" class="difflineminus">-            aType == nsIMsgCompType::ReplyToSender ||</span>
<a href="#l33.3199"></a><span id="l33.3199" class="difflineminus">-            aType == nsIMsgCompType::ReplyToSenderAndGroup ||</span>
<a href="#l33.3200"></a><span id="l33.3200" class="difflineminus">-            aType == nsIMsgCompType::ReplyWithTemplate )</span>
<a href="#l33.3201"></a><span id="l33.3201" class="difflineminus">-         )</span>
<a href="#l33.3202"></a><span id="l33.3202" class="difflineminus">-      {</span>
<a href="#l33.3203"></a><span id="l33.3203" class="difflineminus">-        nsCOMPtr &lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l33.3204"></a><span id="l33.3204" class="difflineplus">+      if (!aOriginalMsgURI.IsEmpty() &amp;&amp;</span>
<a href="#l33.3205"></a><span id="l33.3205" class="difflineplus">+          (aType == nsIMsgCompType::Reply ||</span>
<a href="#l33.3206"></a><span id="l33.3206" class="difflineplus">+           aType == nsIMsgCompType::ReplyAll ||</span>
<a href="#l33.3207"></a><span id="l33.3207" class="difflineplus">+           aType == nsIMsgCompType::ReplyToGroup ||</span>
<a href="#l33.3208"></a><span id="l33.3208" class="difflineplus">+           aType == nsIMsgCompType::ReplyToSender ||</span>
<a href="#l33.3209"></a><span id="l33.3209" class="difflineplus">+           aType == nsIMsgCompType::ReplyToSenderAndGroup ||</span>
<a href="#l33.3210"></a><span id="l33.3210" class="difflineplus">+           aType == nsIMsgCompType::ReplyWithTemplate)) {</span>
<a href="#l33.3211"></a><span id="l33.3211" class="difflineplus">+        nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l33.3212"></a><span id="l33.3212">             do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l33.3213"></a><span id="l33.3213" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l33.3214"></a><span id="l33.3214" class="difflineminus">-        {</span>
<a href="#l33.3215"></a><span id="l33.3215" class="difflineminus">-          nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l33.3216"></a><span id="l33.3216" class="difflineplus">+        if (NS_SUCCEEDED(rv)) {</span>
<a href="#l33.3217"></a><span id="l33.3217" class="difflineplus">+          nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l33.3218"></a><span id="l33.3218">           rv = GetMsgDBHdrFromURI(PromiseFlatCString(aOriginalMsgURI).get(),</span>
<a href="#l33.3219"></a><span id="l33.3219">                                   getter_AddRefs(msgHdr));</span>
<a href="#l33.3220"></a><span id="l33.3220" class="difflineminus">-          if (NS_SUCCEEDED(rv))</span>
<a href="#l33.3221"></a><span id="l33.3221" class="difflineminus">-          {</span>
<a href="#l33.3222"></a><span id="l33.3222" class="difflineminus">-            nsCOMPtr &lt;nsIMsgFolder&gt; folder;</span>
<a href="#l33.3223"></a><span id="l33.3223" class="difflineplus">+          if (NS_SUCCEEDED(rv)) {</span>
<a href="#l33.3224"></a><span id="l33.3224" class="difflineplus">+            nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l33.3225"></a><span id="l33.3225">             msgHdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l33.3226"></a><span id="l33.3226" class="difflineminus">-            if (NS_SUCCEEDED(rv))</span>
<a href="#l33.3227"></a><span id="l33.3227" class="difflineminus">-            {</span>
<a href="#l33.3228"></a><span id="l33.3228" class="difflineplus">+            if (NS_SUCCEEDED(rv)) {</span>
<a href="#l33.3229"></a><span id="l33.3229">               bool canFileMessages;</span>
<a href="#l33.3230"></a><span id="l33.3230">               rv = folder-&gt;GetCanFileMessages(&amp;canFileMessages);</span>
<a href="#l33.3231"></a><span id="l33.3231" class="difflineminus">-              if (NS_SUCCEEDED(rv) &amp;&amp; canFileMessages)</span>
<a href="#l33.3232"></a><span id="l33.3232" class="difflineminus">-              {</span>
<a href="#l33.3233"></a><span id="l33.3233" class="difflineminus">-                nsCOMPtr &lt;nsIMsgIncomingServer&gt; incomingServer;</span>
<a href="#l33.3234"></a><span id="l33.3234" class="difflineplus">+              if (NS_SUCCEEDED(rv) &amp;&amp; canFileMessages) {</span>
<a href="#l33.3235"></a><span id="l33.3235" class="difflineplus">+                nsCOMPtr&lt;nsIMsgIncomingServer&gt; incomingServer;</span>
<a href="#l33.3236"></a><span id="l33.3236">                 rv = folder-&gt;GetServer(getter_AddRefs(incomingServer));</span>
<a href="#l33.3237"></a><span id="l33.3237" class="difflineminus">-                if (NS_SUCCEEDED(rv))</span>
<a href="#l33.3238"></a><span id="l33.3238" class="difflineminus">-                {</span>
<a href="#l33.3239"></a><span id="l33.3239" class="difflineplus">+                if (NS_SUCCEEDED(rv)) {</span>
<a href="#l33.3240"></a><span id="l33.3240">                   nsCString incomingServerType;</span>
<a href="#l33.3241"></a><span id="l33.3241">                   rv = incomingServer-&gt;GetCharValue(&quot;type&quot;, incomingServerType);</span>
<a href="#l33.3242"></a><span id="l33.3242">                   // Exclude RSS accounts, as they falsely report</span>
<a href="#l33.3243"></a><span id="l33.3243">                   // 'canFileMessages' = true</span>
<a href="#l33.3244"></a><span id="l33.3244" class="difflineminus">-                  if (NS_SUCCEEDED(rv) &amp;&amp; !incomingServerType.EqualsLiteral(&quot;rss&quot;))</span>
<a href="#l33.3245"></a><span id="l33.3245" class="difflineminus">-                  {</span>
<a href="#l33.3246"></a><span id="l33.3246" class="difflineplus">+                  if (NS_SUCCEEDED(rv) &amp;&amp;</span>
<a href="#l33.3247"></a><span id="l33.3247" class="difflineplus">+                      !incomingServerType.EqualsLiteral(&quot;rss&quot;)) {</span>
<a href="#l33.3248"></a><span id="l33.3248">                     bool fccReplyFollowsParent;</span>
<a href="#l33.3249"></a><span id="l33.3249">                     rv = mUserIdentity-&gt;GetFccReplyFollowsParent(</span>
<a href="#l33.3250"></a><span id="l33.3250" class="difflineminus">-                             &amp;fccReplyFollowsParent);</span>
<a href="#l33.3251"></a><span id="l33.3251" class="difflineminus">-                    if (NS_SUCCEEDED(rv) &amp;&amp; fccReplyFollowsParent)</span>
<a href="#l33.3252"></a><span id="l33.3252" class="difflineminus">-                    {</span>
<a href="#l33.3253"></a><span id="l33.3253" class="difflineplus">+                        &amp;fccReplyFollowsParent);</span>
<a href="#l33.3254"></a><span id="l33.3254" class="difflineplus">+                    if (NS_SUCCEEDED(rv) &amp;&amp; fccReplyFollowsParent) {</span>
<a href="#l33.3255"></a><span id="l33.3255">                       nsCString folderURI;</span>
<a href="#l33.3256"></a><span id="l33.3256">                       rv = folder-&gt;GetURI(folderURI);</span>
<a href="#l33.3257"></a><span id="l33.3257" class="difflineminus">-                      if (NS_SUCCEEDED(rv))</span>
<a href="#l33.3258"></a><span id="l33.3258" class="difflineminus">-                      {</span>
<a href="#l33.3259"></a><span id="l33.3259" class="difflineplus">+                      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l33.3260"></a><span id="l33.3260">                         mCompFields-&gt;SetFcc(folderURI.get());</span>
<a href="#l33.3261"></a><span id="l33.3261">                         useDefaultFCC = false;</span>
<a href="#l33.3262"></a><span id="l33.3262">                       }</span>
<a href="#l33.3263"></a><span id="l33.3263">                     }</span>
<a href="#l33.3264"></a><span id="l33.3264">                   }</span>
<a href="#l33.3265"></a><span id="l33.3265">                 }</span>
<a href="#l33.3266"></a><span id="l33.3266">               }</span>
<a href="#l33.3267"></a><span id="l33.3267">             }</span>
<a href="#l33.3268"></a><span id="l33.3268">           }</span>
<a href="#l33.3269"></a><span id="l33.3269">         }</span>
<a href="#l33.3270"></a><span id="l33.3270">       }</span>
<a href="#l33.3271"></a><span id="l33.3271"> </span>
<a href="#l33.3272"></a><span id="l33.3272" class="difflineminus">-      if (useDefaultFCC)</span>
<a href="#l33.3273"></a><span id="l33.3273" class="difflineminus">-      {</span>
<a href="#l33.3274"></a><span id="l33.3274" class="difflineplus">+      if (useDefaultFCC) {</span>
<a href="#l33.3275"></a><span id="l33.3275">         nsCString uri;</span>
<a href="#l33.3276"></a><span id="l33.3276">         GetFolderURIFromUserPrefs(nsMsgDeliverNow, mUserIdentity, uri);</span>
<a href="#l33.3277"></a><span id="l33.3277" class="difflineminus">-        mCompFields-&gt;SetFcc(MsgLowerCaseEqualsLiteral(uri, &quot;nocopy://&quot;) ? &quot;&quot; : uri.get());</span>
<a href="#l33.3278"></a><span id="l33.3278" class="difflineplus">+        mCompFields-&gt;SetFcc(</span>
<a href="#l33.3279"></a><span id="l33.3279" class="difflineplus">+            MsgLowerCaseEqualsLiteral(uri, &quot;nocopy://&quot;) ? &quot;&quot; : uri.get());</span>
<a href="#l33.3280"></a><span id="l33.3280">       }</span>
<a href="#l33.3281"></a><span id="l33.3281">     }</span>
<a href="#l33.3282"></a><span id="l33.3282">   }</span>
<a href="#l33.3283"></a><span id="l33.3283"> </span>
<a href="#l33.3284"></a><span id="l33.3284">   //</span>
<a href="#l33.3285"></a><span id="l33.3285">   // Deal with an additional FCC operation for this email.</span>
<a href="#l33.3286"></a><span id="l33.3286">   //</span>
<a href="#l33.3287"></a><span id="l33.3287">   const char *fieldsFCC2 = fields-&gt;GetFcc2();</span>
<a href="#l33.3288"></a><span id="l33.3288" class="difflineminus">-  if ( (fieldsFCC2) &amp;&amp; (*fieldsFCC2) )</span>
<a href="#l33.3289"></a><span id="l33.3289" class="difflineminus">-  {</span>
<a href="#l33.3290"></a><span id="l33.3290" class="difflineminus">-    if (PL_strcasecmp(fieldsFCC2, &quot;nocopy://&quot;) == 0)</span>
<a href="#l33.3291"></a><span id="l33.3291" class="difflineminus">-    {</span>
<a href="#l33.3292"></a><span id="l33.3292" class="difflineplus">+  if ((fieldsFCC2) &amp;&amp; (*fieldsFCC2)) {</span>
<a href="#l33.3293"></a><span id="l33.3293" class="difflineplus">+    if (PL_strcasecmp(fieldsFCC2, &quot;nocopy://&quot;) == 0) {</span>
<a href="#l33.3294"></a><span id="l33.3294">       mCompFields-&gt;SetFcc2(&quot;&quot;);</span>
<a href="#l33.3295"></a><span id="l33.3295">       mNeedToPerformSecondFCC = false;</span>
<a href="#l33.3296"></a><span id="l33.3296" class="difflineminus">-    }</span>
<a href="#l33.3297"></a><span id="l33.3297" class="difflineminus">-    else</span>
<a href="#l33.3298"></a><span id="l33.3298" class="difflineminus">-    {</span>
<a href="#l33.3299"></a><span id="l33.3299" class="difflineplus">+    } else {</span>
<a href="#l33.3300"></a><span id="l33.3300">       mCompFields-&gt;SetFcc2(fieldsFCC2);</span>
<a href="#l33.3301"></a><span id="l33.3301">       mNeedToPerformSecondFCC = true;</span>
<a href="#l33.3302"></a><span id="l33.3302">     }</span>
<a href="#l33.3303"></a><span id="l33.3303">   }</span>
<a href="#l33.3304"></a><span id="l33.3304"> </span>
<a href="#l33.3305"></a><span id="l33.3305">   // Copy the main bodies of headers over.</span>
<a href="#l33.3306"></a><span id="l33.3306">   rv = mCompFields-&gt;AddAllHeaders(fields);</span>
<a href="#l33.3307"></a><span id="l33.3307">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l33.3308"></a><span id="l33.3308"> </span>
<a href="#l33.3309"></a><span id="l33.3309">   nsCOMPtr&lt;nsISimpleEnumerator&gt; srcAttachments;</span>
<a href="#l33.3310"></a><span id="l33.3310">   fields-&gt;GetAttachments(getter_AddRefs(srcAttachments));</span>
<a href="#l33.3311"></a><span id="l33.3311" class="difflineminus">-  if (srcAttachments)</span>
<a href="#l33.3312"></a><span id="l33.3312" class="difflineminus">-  {</span>
<a href="#l33.3313"></a><span id="l33.3313" class="difflineplus">+  if (srcAttachments) {</span>
<a href="#l33.3314"></a><span id="l33.3314">     bool moreAttachments;</span>
<a href="#l33.3315"></a><span id="l33.3315">     nsCOMPtr&lt;nsISupports&gt; element;</span>
<a href="#l33.3316"></a><span id="l33.3316" class="difflineminus">-    while (NS_SUCCEEDED(srcAttachments-&gt;HasMoreElements(&amp;moreAttachments)) &amp;&amp; moreAttachments) {</span>
<a href="#l33.3317"></a><span id="l33.3317" class="difflineplus">+    while (NS_SUCCEEDED(srcAttachments-&gt;HasMoreElements(&amp;moreAttachments)) &amp;&amp;</span>
<a href="#l33.3318"></a><span id="l33.3318" class="difflineplus">+           moreAttachments) {</span>
<a href="#l33.3319"></a><span id="l33.3319">       rv = srcAttachments-&gt;GetNext(getter_AddRefs(element));</span>
<a href="#l33.3320"></a><span id="l33.3320">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l33.3321"></a><span id="l33.3321"> </span>
<a href="#l33.3322"></a><span id="l33.3322">       nsCOMPtr&lt;nsIMsgAttachment&gt; attachment = do_QueryInterface(element, &amp;rv);</span>
<a href="#l33.3323"></a><span id="l33.3323">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l33.3324"></a><span id="l33.3324">       mCompFields-&gt;AddAttachment(attachment);</span>
<a href="#l33.3325"></a><span id="l33.3325">     }</span>
<a href="#l33.3326"></a><span id="l33.3326">   }</span>
<a href="#l33.3327"></a><span id="l33.3327" class="difflineat">@@ -2685,18 +2420,17 @@ nsMsgComposeAndSend::InitCompositionFiel</span>
<a href="#l33.3328"></a><span id="l33.3328">   AddMailFollowupToHeader();</span>
<a href="#l33.3329"></a><span id="l33.3329">   AddMailReplyToHeader();</span>
<a href="#l33.3330"></a><span id="l33.3330"> </span>
<a href="#l33.3331"></a><span id="l33.3331">   if (aType == nsIMsgCompType::ForwardInline ||</span>
<a href="#l33.3332"></a><span id="l33.3332">       aType == nsIMsgCompType::ForwardAsAttachment)</span>
<a href="#l33.3333"></a><span id="l33.3333">     AddXForwardedMessageIdHeader();</span>
<a href="#l33.3334"></a><span id="l33.3334"> </span>
<a href="#l33.3335"></a><span id="l33.3335">   pStr = fields-&gt;GetPriority();</span>
<a href="#l33.3336"></a><span id="l33.3336" class="difflineminus">-  if (pStr)</span>
<a href="#l33.3337"></a><span id="l33.3337" class="difflineminus">-    mCompFields-&gt;SetPriority((char *) pStr);</span>
<a href="#l33.3338"></a><span id="l33.3338" class="difflineplus">+  if (pStr) mCompFields-&gt;SetPriority((char *)pStr);</span>
<a href="#l33.3339"></a><span id="l33.3339"> </span>
<a href="#l33.3340"></a><span id="l33.3340">   mCompFields-&gt;SetAttachVCard(fields-&gt;GetAttachVCard());</span>
<a href="#l33.3341"></a><span id="l33.3341">   mCompFields-&gt;SetForcePlainText(fields-&gt;GetForcePlainText());</span>
<a href="#l33.3342"></a><span id="l33.3342">   mCompFields-&gt;SetUseMultipartAlternative(fields-&gt;GetUseMultipartAlternative());</span>
<a href="#l33.3343"></a><span id="l33.3343">   int32_t receiptType = nsIMsgMdnGenerator::eDntType;</span>
<a href="#l33.3344"></a><span id="l33.3344">   fields-&gt;GetReceiptHeaderType(&amp;receiptType);</span>
<a href="#l33.3345"></a><span id="l33.3345"> </span>
<a href="#l33.3346"></a><span id="l33.3346">   mCompFields-&gt;SetReturnReceipt(fields-&gt;GetReturnReceipt());</span>
<a href="#l33.3347"></a><span id="l33.3347" class="difflineat">@@ -2714,37 +2448,35 @@ nsMsgComposeAndSend::InitCompositionFiel</span>
<a href="#l33.3348"></a><span id="l33.3348">   fields-&gt;GetComposeSecure(getter_AddRefs(compSec));</span>
<a href="#l33.3349"></a><span id="l33.3349"> </span>
<a href="#l33.3350"></a><span id="l33.3350">   mCompFields-&gt;SetComposeSecure(compSec);</span>
<a href="#l33.3351"></a><span id="l33.3351"> </span>
<a href="#l33.3352"></a><span id="l33.3352">   bool needToCheckCharset;</span>
<a href="#l33.3353"></a><span id="l33.3353">   fields-&gt;GetNeedToCheckCharset(&amp;needToCheckCharset);</span>
<a href="#l33.3354"></a><span id="l33.3354">   mCompFields-&gt;SetNeedToCheckCharset(needToCheckCharset);</span>
<a href="#l33.3355"></a><span id="l33.3355"> </span>
<a href="#l33.3356"></a><span id="l33.3356" class="difflineminus">-  if ( m_deliver_mode != nsMsgSaveAsDraft &amp;&amp; m_deliver_mode != nsMsgSaveAsTemplate )</span>
<a href="#l33.3357"></a><span id="l33.3357" class="difflineminus">-  {</span>
<a href="#l33.3358"></a><span id="l33.3358" class="difflineplus">+  if (m_deliver_mode != nsMsgSaveAsDraft &amp;&amp;</span>
<a href="#l33.3359"></a><span id="l33.3359" class="difflineplus">+      m_deliver_mode != nsMsgSaveAsTemplate) {</span>
<a href="#l33.3360"></a><span id="l33.3360">     // Check the fields for legitimacy...</span>
<a href="#l33.3361"></a><span id="l33.3361" class="difflineminus">-    return mime_sanity_check_fields (</span>
<a href="#l33.3362"></a><span id="l33.3362" class="difflineminus">-                    mCompFields-&gt;GetFrom(), mCompFields-&gt;GetReplyTo(),</span>
<a href="#l33.3363"></a><span id="l33.3363" class="difflineminus">-                    mCompFields-&gt;GetTo(), mCompFields-&gt;GetCc(),</span>
<a href="#l33.3364"></a><span id="l33.3364" class="difflineminus">-                    mCompFields-&gt;GetBcc(), mCompFields-&gt;GetFcc(),</span>
<a href="#l33.3365"></a><span id="l33.3365" class="difflineminus">-                    mCompFields-&gt;GetNewsgroups(), mCompFields-&gt;GetFollowupTo(),</span>
<a href="#l33.3366"></a><span id="l33.3366" class="difflineminus">-                    mCompFields-&gt;GetSubject(), mCompFields-&gt;GetReferences(),</span>
<a href="#l33.3367"></a><span id="l33.3367" class="difflineminus">-                    mCompFields-&gt;GetOrganization(), &quot;&quot;);</span>
<a href="#l33.3368"></a><span id="l33.3368" class="difflineplus">+    return mime_sanity_check_fields(</span>
<a href="#l33.3369"></a><span id="l33.3369" class="difflineplus">+        mCompFields-&gt;GetFrom(), mCompFields-&gt;GetReplyTo(), mCompFields-&gt;GetTo(),</span>
<a href="#l33.3370"></a><span id="l33.3370" class="difflineplus">+        mCompFields-&gt;GetCc(), mCompFields-&gt;GetBcc(), mCompFields-&gt;GetFcc(),</span>
<a href="#l33.3371"></a><span id="l33.3371" class="difflineplus">+        mCompFields-&gt;GetNewsgroups(), mCompFields-&gt;GetFollowupTo(),</span>
<a href="#l33.3372"></a><span id="l33.3372" class="difflineplus">+        mCompFields-&gt;GetSubject(), mCompFields-&gt;GetReferences(),</span>
<a href="#l33.3373"></a><span id="l33.3373" class="difflineplus">+        mCompFields-&gt;GetOrganization(), &quot;&quot;);</span>
<a href="#l33.3374"></a><span id="l33.3374">   }</span>
<a href="#l33.3375"></a><span id="l33.3375">   return NS_OK;</span>
<a href="#l33.3376"></a><span id="l33.3376"> }</span>
<a href="#l33.3377"></a><span id="l33.3377"> </span>
<a href="#l33.3378"></a><span id="l33.3378"> // Add default headers to outgoing messages see Bug #61520</span>
<a href="#l33.3379"></a><span id="l33.3379"> // mail.identity.&lt;id#&gt;.headers pref is a comma separated value of pref names</span>
<a href="#l33.3380"></a><span id="l33.3380"> // containing headers to add headers are stored in</span>
<a href="#l33.3381"></a><span id="l33.3381"> // mail.identity.&lt;id#&gt;.header.&lt;header name&gt; grab all the headers, mime encode</span>
<a href="#l33.3382"></a><span id="l33.3382"> // them and add them to the other custom headers.</span>
<a href="#l33.3383"></a><span id="l33.3383" class="difflineminus">-nsresult</span>
<a href="#l33.3384"></a><span id="l33.3384" class="difflineminus">-nsMsgComposeAndSend::AddDefaultCustomHeaders() {</span>
<a href="#l33.3385"></a><span id="l33.3385" class="difflineplus">+nsresult nsMsgComposeAndSend::AddDefaultCustomHeaders() {</span>
<a href="#l33.3386"></a><span id="l33.3386">   nsCString headersList;</span>
<a href="#l33.3387"></a><span id="l33.3387">   // get names of prefs containing headers to add</span>
<a href="#l33.3388"></a><span id="l33.3388">   nsresult rv = mUserIdentity-&gt;GetCharAttribute(&quot;headers&quot;, headersList);</span>
<a href="#l33.3389"></a><span id="l33.3389">   if (NS_SUCCEEDED(rv) &amp;&amp; !headersList.IsEmpty()) {</span>
<a href="#l33.3390"></a><span id="l33.3390">     int32_t start = 0;</span>
<a href="#l33.3391"></a><span id="l33.3391">     int32_t end = 0;</span>
<a href="#l33.3392"></a><span id="l33.3392">     int32_t len = 0;</span>
<a href="#l33.3393"></a><span id="l33.3393">     while (end != -1) {</span>
<a href="#l33.3394"></a><span id="l33.3394" class="difflineat">@@ -2758,105 +2490,99 @@ nsMsgComposeAndSend::AddDefaultCustomHea</span>
<a href="#l33.3395"></a><span id="l33.3395">       nsAutoCString headerName(&quot;header.&quot;);</span>
<a href="#l33.3396"></a><span id="l33.3396">       headerName.Append(Substring(headersList, start, len));</span>
<a href="#l33.3397"></a><span id="l33.3397">       start = end + 1;</span>
<a href="#l33.3398"></a><span id="l33.3398"> </span>
<a href="#l33.3399"></a><span id="l33.3399">       nsCString headerVal;</span>
<a href="#l33.3400"></a><span id="l33.3400">       rv = mUserIdentity-&gt;GetCharAttribute(headerName.get(), headerVal);</span>
<a href="#l33.3401"></a><span id="l33.3401">       if (NS_SUCCEEDED(rv)) {</span>
<a href="#l33.3402"></a><span id="l33.3402">         int32_t colonIdx = headerVal.FindChar(':');</span>
<a href="#l33.3403"></a><span id="l33.3403" class="difflineminus">-        if (colonIdx &gt; 0) { // check that the header is *most likely* valid.</span>
<a href="#l33.3404"></a><span id="l33.3404" class="difflineplus">+        if (colonIdx &gt; 0) {  // check that the header is *most likely* valid.</span>
<a href="#l33.3405"></a><span id="l33.3405">           nsCString name(Substring(headerVal, 0, colonIdx));</span>
<a href="#l33.3406"></a><span id="l33.3406" class="difflineminus">-          mCompFields-&gt;SetRawHeader(name.get(),</span>
<a href="#l33.3407"></a><span id="l33.3407" class="difflineminus">-            Substring(headerVal, colonIdx + 1), nullptr);</span>
<a href="#l33.3408"></a><span id="l33.3408" class="difflineplus">+          mCompFields-&gt;SetRawHeader(</span>
<a href="#l33.3409"></a><span id="l33.3409" class="difflineplus">+              name.get(), Substring(headerVal, colonIdx + 1), nullptr);</span>
<a href="#l33.3410"></a><span id="l33.3410">         }</span>
<a href="#l33.3411"></a><span id="l33.3411">       }</span>
<a href="#l33.3412"></a><span id="l33.3412">     }</span>
<a href="#l33.3413"></a><span id="l33.3413">   }</span>
<a href="#l33.3414"></a><span id="l33.3414">   return rv;</span>
<a href="#l33.3415"></a><span id="l33.3415"> }</span>
<a href="#l33.3416"></a><span id="l33.3416"> </span>
<a href="#l33.3417"></a><span id="l33.3417"> // Add Mail-Followup-To header</span>
<a href="#l33.3418"></a><span id="l33.3418"> // See bug #204339 and http://cr.yp.to/proto/replyto.html for details</span>
<a href="#l33.3419"></a><span id="l33.3419" class="difflineminus">-nsresult</span>
<a href="#l33.3420"></a><span id="l33.3420" class="difflineminus">-nsMsgComposeAndSend::AddMailFollowupToHeader() {</span>
<a href="#l33.3421"></a><span id="l33.3421" class="difflineplus">+nsresult nsMsgComposeAndSend::AddMailFollowupToHeader() {</span>
<a href="#l33.3422"></a><span id="l33.3422">   nsresult rv;</span>
<a href="#l33.3423"></a><span id="l33.3423"> </span>
<a href="#l33.3424"></a><span id="l33.3424">   // If there's already a Mail-Followup-To header, don't need to do anything.</span>
<a href="#l33.3425"></a><span id="l33.3425">   nsAutoCString mftHeader;</span>
<a href="#l33.3426"></a><span id="l33.3426">   mCompFields-&gt;GetRawHeader(HEADER_MAIL_FOLLOWUP_TO, mftHeader);</span>
<a href="#l33.3427"></a><span id="l33.3427" class="difflineminus">-  if (!mftHeader.IsEmpty())</span>
<a href="#l33.3428"></a><span id="l33.3428" class="difflineminus">-  {</span>
<a href="#l33.3429"></a><span id="l33.3429" class="difflineplus">+  if (!mftHeader.IsEmpty()) {</span>
<a href="#l33.3430"></a><span id="l33.3430">     return NS_OK;</span>
<a href="#l33.3431"></a><span id="l33.3431">   }</span>
<a href="#l33.3432"></a><span id="l33.3432"> </span>
<a href="#l33.3433"></a><span id="l33.3433">   // Get list of subscribed mailing lists</span>
<a href="#l33.3434"></a><span id="l33.3434">   nsAutoCString mailing_lists;</span>
<a href="#l33.3435"></a><span id="l33.3435" class="difflineminus">-  rv = mUserIdentity-&gt;GetCharAttribute(&quot;subscribed_mailing_lists&quot;, mailing_lists);</span>
<a href="#l33.3436"></a><span id="l33.3436" class="difflineplus">+  rv = mUserIdentity-&gt;GetCharAttribute(&quot;subscribed_mailing_lists&quot;,</span>
<a href="#l33.3437"></a><span id="l33.3437" class="difflineplus">+                                       mailing_lists);</span>
<a href="#l33.3438"></a><span id="l33.3438">   // Stop here if this list is missing or empty</span>
<a href="#l33.3439"></a><span id="l33.3439" class="difflineminus">-  if (NS_FAILED(rv) || mailing_lists.IsEmpty())</span>
<a href="#l33.3440"></a><span id="l33.3440" class="difflineminus">-    return NS_OK;</span>
<a href="#l33.3441"></a><span id="l33.3441" class="difflineplus">+  if (NS_FAILED(rv) || mailing_lists.IsEmpty()) return NS_OK;</span>
<a href="#l33.3442"></a><span id="l33.3442"> </span>
<a href="#l33.3443"></a><span id="l33.3443">   // Get a list of all recipients excluding bcc</span>
<a href="#l33.3444"></a><span id="l33.3444">   nsDependentCString to(mCompFields-&gt;GetTo());</span>
<a href="#l33.3445"></a><span id="l33.3445">   nsDependentCString cc(mCompFields-&gt;GetCc());</span>
<a href="#l33.3446"></a><span id="l33.3446">   nsAutoCString recipients;</span>
<a href="#l33.3447"></a><span id="l33.3447"> </span>
<a href="#l33.3448"></a><span id="l33.3448">   if (to.IsEmpty() &amp;&amp; cc.IsEmpty())</span>
<a href="#l33.3449"></a><span id="l33.3449">     // We have bcc recipients only, so we don't add the Mail-Followup-To header</span>
<a href="#l33.3450"></a><span id="l33.3450">     return NS_OK;</span>
<a href="#l33.3451"></a><span id="l33.3451"> </span>
<a href="#l33.3452"></a><span id="l33.3452">   if (!to.IsEmpty() &amp;&amp; cc.IsEmpty())</span>
<a href="#l33.3453"></a><span id="l33.3453">     recipients = to;</span>
<a href="#l33.3454"></a><span id="l33.3454">   else if (to.IsEmpty() &amp;&amp; !cc.IsEmpty())</span>
<a href="#l33.3455"></a><span id="l33.3455">     recipients = cc;</span>
<a href="#l33.3456"></a><span id="l33.3456" class="difflineminus">-  else</span>
<a href="#l33.3457"></a><span id="l33.3457" class="difflineminus">-  {</span>
<a href="#l33.3458"></a><span id="l33.3458" class="difflineplus">+  else {</span>
<a href="#l33.3459"></a><span id="l33.3459">     recipients.Assign(to);</span>
<a href="#l33.3460"></a><span id="l33.3460">     recipients.AppendLiteral(&quot;, &quot;);</span>
<a href="#l33.3461"></a><span id="l33.3461">     recipients.Append(cc);</span>
<a href="#l33.3462"></a><span id="l33.3462">   }</span>
<a href="#l33.3463"></a><span id="l33.3463"> </span>
<a href="#l33.3464"></a><span id="l33.3464">   // Remove duplicate addresses in recipients</span>
<a href="#l33.3465"></a><span id="l33.3465">   nsAutoCString recipients_no_dups;</span>
<a href="#l33.3466"></a><span id="l33.3466">   RemoveDuplicateAddresses(recipients, EmptyCString(), recipients_no_dups);</span>
<a href="#l33.3467"></a><span id="l33.3467"> </span>
<a href="#l33.3468"></a><span id="l33.3468">   // Remove subscribed mailing lists from recipients...</span>
<a href="#l33.3469"></a><span id="l33.3469">   nsAutoCString recipients_without_mailing_lists;</span>
<a href="#l33.3470"></a><span id="l33.3470">   RemoveDuplicateAddresses(recipients_no_dups, mailing_lists,</span>
<a href="#l33.3471"></a><span id="l33.3471">                            recipients_without_mailing_lists);</span>
<a href="#l33.3472"></a><span id="l33.3472"> </span>
<a href="#l33.3473"></a><span id="l33.3473">   // ... If the result is equal to the input, we don't write to a subscribed</span>
<a href="#l33.3474"></a><span id="l33.3474">   // mailing list and therefore we don't add Mail-Followup-To</span>
<a href="#l33.3475"></a><span id="l33.3475" class="difflineminus">-  if (recipients_no_dups == recipients_without_mailing_lists)</span>
<a href="#l33.3476"></a><span id="l33.3476" class="difflineminus">-    return NS_OK;</span>
<a href="#l33.3477"></a><span id="l33.3477" class="difflineplus">+  if (recipients_no_dups == recipients_without_mailing_lists) return NS_OK;</span>
<a href="#l33.3478"></a><span id="l33.3478"> </span>
<a href="#l33.3479"></a><span id="l33.3479">   // Set Mail-Followup-To</span>
<a href="#l33.3480"></a><span id="l33.3480">   return mCompFields-&gt;SetRawHeader(HEADER_MAIL_FOLLOWUP_TO, recipients,</span>
<a href="#l33.3481"></a><span id="l33.3481" class="difflineminus">-    mCompFields-&gt;GetCharacterSet());</span>
<a href="#l33.3482"></a><span id="l33.3482" class="difflineplus">+                                   mCompFields-&gt;GetCharacterSet());</span>
<a href="#l33.3483"></a><span id="l33.3483"> }</span>
<a href="#l33.3484"></a><span id="l33.3484"> </span>
<a href="#l33.3485"></a><span id="l33.3485"> // Add Mail-Reply-To header</span>
<a href="#l33.3486"></a><span id="l33.3486"> // See bug #204339 and http://cr.yp.to/proto/replyto.html for details</span>
<a href="#l33.3487"></a><span id="l33.3487" class="difflineminus">-nsresult</span>
<a href="#l33.3488"></a><span id="l33.3488" class="difflineminus">-nsMsgComposeAndSend::AddMailReplyToHeader() {</span>
<a href="#l33.3489"></a><span id="l33.3489" class="difflineplus">+nsresult nsMsgComposeAndSend::AddMailReplyToHeader() {</span>
<a href="#l33.3490"></a><span id="l33.3490">   nsresult rv;</span>
<a href="#l33.3491"></a><span id="l33.3491"> </span>
<a href="#l33.3492"></a><span id="l33.3492">   // If there's already a Mail-Reply-To header, don't need to do anything.</span>
<a href="#l33.3493"></a><span id="l33.3493">   nsAutoCString mrtHeader;</span>
<a href="#l33.3494"></a><span id="l33.3494">   mCompFields-&gt;GetRawHeader(HEADER_MAIL_REPLY_TO, mrtHeader);</span>
<a href="#l33.3495"></a><span id="l33.3495" class="difflineminus">-  if (!mrtHeader.IsEmpty())</span>
<a href="#l33.3496"></a><span id="l33.3496" class="difflineminus">-    return NS_OK;</span>
<a href="#l33.3497"></a><span id="l33.3497" class="difflineplus">+  if (!mrtHeader.IsEmpty()) return NS_OK;</span>
<a href="#l33.3498"></a><span id="l33.3498"> </span>
<a href="#l33.3499"></a><span id="l33.3499">   // Get list of reply-to mangling mailing lists</span>
<a href="#l33.3500"></a><span id="l33.3500">   nsAutoCString mailing_lists;</span>
<a href="#l33.3501"></a><span id="l33.3501" class="difflineminus">-  rv = mUserIdentity-&gt;GetCharAttribute(&quot;replyto_mangling_mailing_lists&quot;, mailing_lists);</span>
<a href="#l33.3502"></a><span id="l33.3502" class="difflineplus">+  rv = mUserIdentity-&gt;GetCharAttribute(&quot;replyto_mangling_mailing_lists&quot;,</span>
<a href="#l33.3503"></a><span id="l33.3503" class="difflineplus">+                                       mailing_lists);</span>
<a href="#l33.3504"></a><span id="l33.3504">   // Stop here if this list is missing or empty</span>
<a href="#l33.3505"></a><span id="l33.3505" class="difflineminus">-  if (NS_FAILED(rv) || mailing_lists.IsEmpty())</span>
<a href="#l33.3506"></a><span id="l33.3506" class="difflineminus">-    return NS_OK;</span>
<a href="#l33.3507"></a><span id="l33.3507" class="difflineplus">+  if (NS_FAILED(rv) || mailing_lists.IsEmpty()) return NS_OK;</span>
<a href="#l33.3508"></a><span id="l33.3508"> </span>
<a href="#l33.3509"></a><span id="l33.3509">   // MRT will be set if the recipients of the message contains at least one</span>
<a href="#l33.3510"></a><span id="l33.3510">   // of the addresses in mailing_lists or if mailing_lists has '*' as first</span>
<a href="#l33.3511"></a><span id="l33.3511">   // character.  The latter case gives the user an easy way to always set</span>
<a href="#l33.3512"></a><span id="l33.3512">   // the MRT header.  Notice that this behaviour wouldn't make sense for MFT</span>
<a href="#l33.3513"></a><span id="l33.3513">   // in AddMailFollowupToHeader() above.</span>
<a href="#l33.3514"></a><span id="l33.3514"> </span>
<a href="#l33.3515"></a><span id="l33.3515">   if (mailing_lists[0] != '*') {</span>
<a href="#l33.3516"></a><span id="l33.3516" class="difflineat">@@ -2868,116 +2594,103 @@ nsMsgComposeAndSend::AddMailReplyToHeade</span>
<a href="#l33.3517"></a><span id="l33.3517">     if (to.IsEmpty() &amp;&amp; cc.IsEmpty())</span>
<a href="#l33.3518"></a><span id="l33.3518">       // We have bcc recipients only, so we don't add the Mail-Reply-To header</span>
<a href="#l33.3519"></a><span id="l33.3519">       return NS_OK;</span>
<a href="#l33.3520"></a><span id="l33.3520"> </span>
<a href="#l33.3521"></a><span id="l33.3521">     if (!to.IsEmpty() &amp;&amp; cc.IsEmpty())</span>
<a href="#l33.3522"></a><span id="l33.3522">       recipients = to;</span>
<a href="#l33.3523"></a><span id="l33.3523">     else if (to.IsEmpty() &amp;&amp; !cc.IsEmpty())</span>
<a href="#l33.3524"></a><span id="l33.3524">       recipients = cc;</span>
<a href="#l33.3525"></a><span id="l33.3525" class="difflineminus">-    else</span>
<a href="#l33.3526"></a><span id="l33.3526" class="difflineminus">-    {</span>
<a href="#l33.3527"></a><span id="l33.3527" class="difflineplus">+    else {</span>
<a href="#l33.3528"></a><span id="l33.3528">       recipients.Assign(to);</span>
<a href="#l33.3529"></a><span id="l33.3529">       recipients.AppendLiteral(&quot;, &quot;);</span>
<a href="#l33.3530"></a><span id="l33.3530">       recipients.Append(cc);</span>
<a href="#l33.3531"></a><span id="l33.3531">     }</span>
<a href="#l33.3532"></a><span id="l33.3532"> </span>
<a href="#l33.3533"></a><span id="l33.3533">     // Remove duplicate addresses in recipients</span>
<a href="#l33.3534"></a><span id="l33.3534">     nsAutoCString recipients_no_dups;</span>
<a href="#l33.3535"></a><span id="l33.3535">     RemoveDuplicateAddresses(recipients, EmptyCString(), recipients_no_dups);</span>
<a href="#l33.3536"></a><span id="l33.3536"> </span>
<a href="#l33.3537"></a><span id="l33.3537">     // Remove reply-to mangling mailing lists from recipients...</span>
<a href="#l33.3538"></a><span id="l33.3538">     nsAutoCString recipients_without_mailing_lists;</span>
<a href="#l33.3539"></a><span id="l33.3539">     RemoveDuplicateAddresses(recipients_no_dups, mailing_lists,</span>
<a href="#l33.3540"></a><span id="l33.3540">                              recipients_without_mailing_lists);</span>
<a href="#l33.3541"></a><span id="l33.3541"> </span>
<a href="#l33.3542"></a><span id="l33.3542">     // ... If the result is equal to the input, none of the recipients</span>
<a href="#l33.3543"></a><span id="l33.3543">     // occur in the MRT addresses and therefore we stop here.</span>
<a href="#l33.3544"></a><span id="l33.3544" class="difflineminus">-    if (recipients_no_dups == recipients_without_mailing_lists)</span>
<a href="#l33.3545"></a><span id="l33.3545" class="difflineminus">-      return NS_OK;</span>
<a href="#l33.3546"></a><span id="l33.3546" class="difflineplus">+    if (recipients_no_dups == recipients_without_mailing_lists) return NS_OK;</span>
<a href="#l33.3547"></a><span id="l33.3547">   }</span>
<a href="#l33.3548"></a><span id="l33.3548"> </span>
<a href="#l33.3549"></a><span id="l33.3549">   // Set Mail-Reply-To</span>
<a href="#l33.3550"></a><span id="l33.3550">   nsAutoCString replyTo, mailReplyTo;</span>
<a href="#l33.3551"></a><span id="l33.3551">   replyTo = mCompFields-&gt;GetReplyTo();</span>
<a href="#l33.3552"></a><span id="l33.3552">   if (replyTo.IsEmpty())</span>
<a href="#l33.3553"></a><span id="l33.3553">     mailReplyTo = mCompFields-&gt;GetFrom();</span>
<a href="#l33.3554"></a><span id="l33.3554">   else</span>
<a href="#l33.3555"></a><span id="l33.3555">     mailReplyTo = replyTo;</span>
<a href="#l33.3556"></a><span id="l33.3556"> </span>
<a href="#l33.3557"></a><span id="l33.3557">   mCompFields-&gt;SetRawHeader(HEADER_MAIL_REPLY_TO, mailReplyTo,</span>
<a href="#l33.3558"></a><span id="l33.3558" class="difflineminus">-    mCompFields-&gt;GetCharacterSet());</span>
<a href="#l33.3559"></a><span id="l33.3559" class="difflineplus">+                            mCompFields-&gt;GetCharacterSet());</span>
<a href="#l33.3560"></a><span id="l33.3560">   return NS_OK;</span>
<a href="#l33.3561"></a><span id="l33.3561"> }</span>
<a href="#l33.3562"></a><span id="l33.3562"> </span>
<a href="#l33.3563"></a><span id="l33.3563" class="difflineminus">-nsresult</span>
<a href="#l33.3564"></a><span id="l33.3564" class="difflineminus">-nsMsgComposeAndSend::AddXForwardedMessageIdHeader() {</span>
<a href="#l33.3565"></a><span id="l33.3565" class="difflineminus">-  return mCompFields-&gt;SetRawHeader(&quot;X-Forwarded-Message-Id&quot;,</span>
<a href="#l33.3566"></a><span id="l33.3566" class="difflineminus">-    nsDependentCString(mCompFields-&gt;GetReferences()), nullptr);</span>
<a href="#l33.3567"></a><span id="l33.3567" class="difflineplus">+nsresult nsMsgComposeAndSend::AddXForwardedMessageIdHeader() {</span>
<a href="#l33.3568"></a><span id="l33.3568" class="difflineplus">+  return mCompFields-&gt;SetRawHeader(</span>
<a href="#l33.3569"></a><span id="l33.3569" class="difflineplus">+      &quot;X-Forwarded-Message-Id&quot;,</span>
<a href="#l33.3570"></a><span id="l33.3570" class="difflineplus">+      nsDependentCString(mCompFields-&gt;GetReferences()), nullptr);</span>
<a href="#l33.3571"></a><span id="l33.3571"> }</span>
<a href="#l33.3572"></a><span id="l33.3572"> </span>
<a href="#l33.3573"></a><span id="l33.3573" class="difflineminus">-nsresult</span>
<a href="#l33.3574"></a><span id="l33.3574" class="difflineminus">-nsMsgComposeAndSend::SnarfAndCopyBody(const nsACString &amp;attachment1_body,</span>
<a href="#l33.3575"></a><span id="l33.3575" class="difflineminus">-                                      const char  *attachment1_type)</span>
<a href="#l33.3576"></a><span id="l33.3576" class="difflineminus">-{</span>
<a href="#l33.3577"></a><span id="l33.3577" class="difflineplus">+nsresult nsMsgComposeAndSend::SnarfAndCopyBody(</span>
<a href="#l33.3578"></a><span id="l33.3578" class="difflineplus">+    const nsACString &amp;attachment1_body, const char *attachment1_type) {</span>
<a href="#l33.3579"></a><span id="l33.3579">   //</span>
<a href="#l33.3580"></a><span id="l33.3580">   // If we are here, then just process the body from what was</span>
<a href="#l33.3581"></a><span id="l33.3581">   // passed in the attachment1_body field.</span>
<a href="#l33.3582"></a><span id="l33.3582">   //</span>
<a href="#l33.3583"></a><span id="l33.3583">   // strip out whitespaces from the end of body ONLY.</span>
<a href="#l33.3584"></a><span id="l33.3584">   nsAutoCString body(attachment1_body);</span>
<a href="#l33.3585"></a><span id="l33.3585">   body.Trim(&quot; &quot;, false, true);</span>
<a href="#l33.3586"></a><span id="l33.3586"> </span>
<a href="#l33.3587"></a><span id="l33.3587" class="difflineminus">-  if (body.Length() &gt; 0)</span>
<a href="#l33.3588"></a><span id="l33.3588" class="difflineminus">-  {</span>
<a href="#l33.3589"></a><span id="l33.3589" class="difflineplus">+  if (body.Length() &gt; 0) {</span>
<a href="#l33.3590"></a><span id="l33.3590">     m_attachment1_body = ToNewCString(body);</span>
<a href="#l33.3591"></a><span id="l33.3591">     if (!m_attachment1_body) {</span>
<a href="#l33.3592"></a><span id="l33.3592">       return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l33.3593"></a><span id="l33.3593">     }</span>
<a href="#l33.3594"></a><span id="l33.3594">     m_attachment1_body_length = body.Length();</span>
<a href="#l33.3595"></a><span id="l33.3595">   }</span>
<a href="#l33.3596"></a><span id="l33.3596"> </span>
<a href="#l33.3597"></a><span id="l33.3597">   PR_FREEIF(m_attachment1_type);</span>
<a href="#l33.3598"></a><span id="l33.3598" class="difflineminus">-  m_attachment1_type = PL_strdup (attachment1_type);</span>
<a href="#l33.3599"></a><span id="l33.3599" class="difflineplus">+  m_attachment1_type = PL_strdup(attachment1_type);</span>
<a href="#l33.3600"></a><span id="l33.3600">   PR_FREEIF(m_attachment1_encoding);</span>
<a href="#l33.3601"></a><span id="l33.3601" class="difflineminus">-  m_attachment1_encoding = PL_strdup (ENCODING_8BIT);</span>
<a href="#l33.3602"></a><span id="l33.3602" class="difflineplus">+  m_attachment1_encoding = PL_strdup(ENCODING_8BIT);</span>
<a href="#l33.3603"></a><span id="l33.3603">   return NS_OK;</span>
<a href="#l33.3604"></a><span id="l33.3604"> }</span>
<a href="#l33.3605"></a><span id="l33.3605"> </span>
<a href="#l33.3606"></a><span id="l33.3606" class="difflineminus">-nsresult</span>
<a href="#l33.3607"></a><span id="l33.3607" class="difflineminus">-nsMsgComposeAndSend::Init(</span>
<a href="#l33.3608"></a><span id="l33.3608" class="difflineminus">-              nsIMsgIdentity  *aUserIdentity,</span>
<a href="#l33.3609"></a><span id="l33.3609" class="difflineminus">-              const char *aAccountKey,</span>
<a href="#l33.3610"></a><span id="l33.3610" class="difflineminus">-              nsMsgCompFields *fields,</span>
<a href="#l33.3611"></a><span id="l33.3611" class="difflineminus">-              nsIFile      *sendFile,</span>
<a href="#l33.3612"></a><span id="l33.3612" class="difflineminus">-              bool digest_p,</span>
<a href="#l33.3613"></a><span id="l33.3613" class="difflineminus">-              bool dont_deliver_p,</span>
<a href="#l33.3614"></a><span id="l33.3614" class="difflineminus">-              nsMsgDeliverMode mode,</span>
<a href="#l33.3615"></a><span id="l33.3615" class="difflineminus">-              nsIMsgDBHdr *msgToReplace,</span>
<a href="#l33.3616"></a><span id="l33.3616" class="difflineminus">-              const char *attachment1_type,</span>
<a href="#l33.3617"></a><span id="l33.3617" class="difflineminus">-              const nsACString &amp;attachment1_body,</span>
<a href="#l33.3618"></a><span id="l33.3618" class="difflineminus">-              nsIArray *attachments,</span>
<a href="#l33.3619"></a><span id="l33.3619" class="difflineminus">-              nsIArray *preloaded_attachments,</span>
<a href="#l33.3620"></a><span id="l33.3620" class="difflineminus">-              const nsAString &amp;password,</span>
<a href="#l33.3621"></a><span id="l33.3621" class="difflineminus">-              const nsACString &amp;aOriginalMsgURI,</span>
<a href="#l33.3622"></a><span id="l33.3622" class="difflineminus">-              MSG_ComposeType aType)</span>
<a href="#l33.3623"></a><span id="l33.3623" class="difflineminus">-{</span>
<a href="#l33.3624"></a><span id="l33.3624" class="difflineminus">-  nsresult      rv = NS_OK;</span>
<a href="#l33.3625"></a><span id="l33.3625" class="difflineminus">-</span>
<a href="#l33.3626"></a><span id="l33.3626" class="difflineminus">-  //Let make sure we retrieve the correct number of related parts. It may have changed since last time</span>
<a href="#l33.3627"></a><span id="l33.3627" class="difflineplus">+nsresult nsMsgComposeAndSend::Init(</span>
<a href="#l33.3628"></a><span id="l33.3628" class="difflineplus">+    nsIMsgIdentity *aUserIdentity, const char *aAccountKey,</span>
<a href="#l33.3629"></a><span id="l33.3629" class="difflineplus">+    nsMsgCompFields *fields, nsIFile *sendFile, bool digest_p,</span>
<a href="#l33.3630"></a><span id="l33.3630" class="difflineplus">+    bool dont_deliver_p, nsMsgDeliverMode mode, nsIMsgDBHdr *msgToReplace,</span>
<a href="#l33.3631"></a><span id="l33.3631" class="difflineplus">+    const char *attachment1_type, const nsACString &amp;attachment1_body,</span>
<a href="#l33.3632"></a><span id="l33.3632" class="difflineplus">+    nsIArray *attachments, nsIArray *preloaded_attachments,</span>
<a href="#l33.3633"></a><span id="l33.3633" class="difflineplus">+    const nsAString &amp;password, const nsACString &amp;aOriginalMsgURI,</span>
<a href="#l33.3634"></a><span id="l33.3634" class="difflineplus">+    MSG_ComposeType aType) {</span>
<a href="#l33.3635"></a><span id="l33.3635" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l33.3636"></a><span id="l33.3636" class="difflineplus">+</span>
<a href="#l33.3637"></a><span id="l33.3637" class="difflineplus">+  // Let make sure we retrieve the correct number of related parts. It may have</span>
<a href="#l33.3638"></a><span id="l33.3638" class="difflineplus">+  // changed since last time</span>
<a href="#l33.3639"></a><span id="l33.3639">   GetMultipartRelatedCount(true);</span>
<a href="#l33.3640"></a><span id="l33.3640"> </span>
<a href="#l33.3641"></a><span id="l33.3641">   nsString msg;</span>
<a href="#l33.3642"></a><span id="l33.3642" class="difflineminus">-  if (!mComposeBundle)</span>
<a href="#l33.3643"></a><span id="l33.3643" class="difflineminus">-  {</span>
<a href="#l33.3644"></a><span id="l33.3644" class="difflineplus">+  if (!mComposeBundle) {</span>
<a href="#l33.3645"></a><span id="l33.3645">     nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l33.3646"></a><span id="l33.3646" class="difflineminus">-      mozilla::services::GetStringBundleService();</span>
<a href="#l33.3647"></a><span id="l33.3647" class="difflineplus">+        mozilla::services::GetStringBundleService();</span>
<a href="#l33.3648"></a><span id="l33.3648">     NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l33.3649"></a><span id="l33.3649">     nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l33.3650"></a><span id="l33.3650" class="difflineminus">-    rv = bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/messengercompose/composeMsgs.properties&quot;, getter_AddRefs(mComposeBundle));</span>
<a href="#l33.3651"></a><span id="l33.3651" class="difflineplus">+    rv = bundleService-&gt;CreateBundle(</span>
<a href="#l33.3652"></a><span id="l33.3652" class="difflineplus">+        &quot;chrome://messenger/locale/messengercompose/composeMsgs.properties&quot;,</span>
<a href="#l33.3653"></a><span id="l33.3653" class="difflineplus">+        getter_AddRefs(mComposeBundle));</span>
<a href="#l33.3654"></a><span id="l33.3654">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l33.3655"></a><span id="l33.3655">   }</span>
<a href="#l33.3656"></a><span id="l33.3656"> </span>
<a href="#l33.3657"></a><span id="l33.3657">   // Tell the user we are assembling the message...</span>
<a href="#l33.3658"></a><span id="l33.3658">   mComposeBundle-&gt;GetStringFromName(&quot;assemblingMailInformation&quot;, msg);</span>
<a href="#l33.3659"></a><span id="l33.3659">   SetStatusMessage(msg);</span>
<a href="#l33.3660"></a><span id="l33.3660">   if (mSendReport)</span>
<a href="#l33.3661"></a><span id="l33.3661">     mSendReport-&gt;SetCurrentProcess(nsIMsgSendReport::process_BuildMessage);</span>
<a href="#l33.3662"></a><span id="l33.3662" class="difflineat">@@ -2995,126 +2708,113 @@ nsMsgComposeAndSend::Init(</span>
<a href="#l33.3663"></a><span id="l33.3663">   mAccountKey = aAccountKey;</span>
<a href="#l33.3664"></a><span id="l33.3664">   NS_ASSERTION(mUserIdentity, &quot;Got null identity!&quot;);</span>
<a href="#l33.3665"></a><span id="l33.3665">   if (!mUserIdentity) return NS_ERROR_UNEXPECTED;</span>
<a href="#l33.3666"></a><span id="l33.3666"> </span>
<a href="#l33.3667"></a><span id="l33.3667">   //</span>
<a href="#l33.3668"></a><span id="l33.3668">   // First sanity check the composition fields parameter and</span>
<a href="#l33.3669"></a><span id="l33.3669">   // see if we should continue</span>
<a href="#l33.3670"></a><span id="l33.3670">   //</span>
<a href="#l33.3671"></a><span id="l33.3671" class="difflineminus">-  if (!fields)</span>
<a href="#l33.3672"></a><span id="l33.3672" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l33.3673"></a><span id="l33.3673" class="difflineplus">+  if (!fields) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l33.3674"></a><span id="l33.3674"> </span>
<a href="#l33.3675"></a><span id="l33.3675">   m_digest_p = digest_p;</span>
<a href="#l33.3676"></a><span id="l33.3676"> </span>
<a href="#l33.3677"></a><span id="l33.3677">   //</span>
<a href="#l33.3678"></a><span id="l33.3678">   // Needed for mime encoding!</span>
<a href="#l33.3679"></a><span id="l33.3679">   //</span>
<a href="#l33.3680"></a><span id="l33.3680">   bool strictly_mime = true;</span>
<a href="#l33.3681"></a><span id="l33.3681">   nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l33.3682"></a><span id="l33.3682" class="difflineminus">-  if (pPrefBranch)</span>
<a href="#l33.3683"></a><span id="l33.3683" class="difflineminus">-  {</span>
<a href="#l33.3684"></a><span id="l33.3684" class="difflineplus">+  if (pPrefBranch) {</span>
<a href="#l33.3685"></a><span id="l33.3685">     rv = pPrefBranch-&gt;GetBoolPref(PREF_MAIL_STRICTLY_MIME, &amp;strictly_mime);</span>
<a href="#l33.3686"></a><span id="l33.3686" class="difflineminus">-    rv = pPrefBranch-&gt;GetIntPref(PREF_MAIL_MESSAGE_WARNING_SIZE, (int32_t *) &amp;mMessageWarningSize);</span>
<a href="#l33.3687"></a><span id="l33.3687" class="difflineplus">+    rv = pPrefBranch-&gt;GetIntPref(PREF_MAIL_MESSAGE_WARNING_SIZE,</span>
<a href="#l33.3688"></a><span id="l33.3688" class="difflineplus">+                                 (int32_t *)&amp;mMessageWarningSize);</span>
<a href="#l33.3689"></a><span id="l33.3689">   }</span>
<a href="#l33.3690"></a><span id="l33.3690"> </span>
<a href="#l33.3691"></a><span id="l33.3691">   nsCOMPtr&lt;nsIMsgComposeSecure&gt; secureCompose;</span>
<a href="#l33.3692"></a><span id="l33.3692">   rv = fields-&gt;GetComposeSecure(getter_AddRefs(secureCompose));</span>
<a href="#l33.3693"></a><span id="l33.3693"> </span>
<a href="#l33.3694"></a><span id="l33.3694" class="difflineminus">-</span>
<a href="#l33.3695"></a><span id="l33.3695">   // It's not an error scenario if there is no secure compose.</span>
<a href="#l33.3696"></a><span id="l33.3696">   // The S/MIME extension may be unavailable.</span>
<a href="#l33.3697"></a><span id="l33.3697" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; secureCompose)</span>
<a href="#l33.3698"></a><span id="l33.3698" class="difflineminus">-  {</span>
<a href="#l33.3699"></a><span id="l33.3699" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; secureCompose) {</span>
<a href="#l33.3700"></a><span id="l33.3700">     bool requiresEncryptionWork = false;</span>
<a href="#l33.3701"></a><span id="l33.3701">     rv = secureCompose-&gt;RequiresCryptoEncapsulation(aUserIdentity, fields,</span>
<a href="#l33.3702"></a><span id="l33.3702">                                                     &amp;requiresEncryptionWork);</span>
<a href="#l33.3703"></a><span id="l33.3703">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l33.3704"></a><span id="l33.3704" class="difflineminus">-    if (requiresEncryptionWork)</span>
<a href="#l33.3705"></a><span id="l33.3705" class="difflineminus">-    {</span>
<a href="#l33.3706"></a><span id="l33.3706" class="difflineplus">+    if (requiresEncryptionWork) {</span>
<a href="#l33.3707"></a><span id="l33.3707">       strictly_mime = true;</span>
<a href="#l33.3708"></a><span id="l33.3708">       // RFC2633 3.1.3 doesn't require multipart/signed entities to have</span>
<a href="#l33.3709"></a><span id="l33.3709">       // transfer encoding applied for ascii, but do it anyway to make sure</span>
<a href="#l33.3710"></a><span id="l33.3710">       // the content (e.g. line endings) isn't mangled along the way.</span>
<a href="#l33.3711"></a><span id="l33.3711">       fields-&gt;SetForceMsgEncoding(true);</span>
<a href="#l33.3712"></a><span id="l33.3712">     }</span>
<a href="#l33.3713"></a><span id="l33.3713">   }</span>
<a href="#l33.3714"></a><span id="l33.3714"> </span>
<a href="#l33.3715"></a><span id="l33.3715">   nsMsgMIMESetConformToStandard(strictly_mime);</span>
<a href="#l33.3716"></a><span id="l33.3716">   mime_use_quoted_printable_p = strictly_mime;</span>
<a href="#l33.3717"></a><span id="l33.3717"> </span>
<a href="#l33.3718"></a><span id="l33.3718">   rv = InitCompositionFields(fields, aOriginalMsgURI, aType);</span>
<a href="#l33.3719"></a><span id="l33.3719" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l33.3720"></a><span id="l33.3720" class="difflineminus">-    return rv;</span>
<a href="#l33.3721"></a><span id="l33.3721" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l33.3722"></a><span id="l33.3722"> </span>
<a href="#l33.3723"></a><span id="l33.3723">   //</span>
<a href="#l33.3724"></a><span id="l33.3724">   // At this point, if we are only creating this object to do</span>
<a href="#l33.3725"></a><span id="l33.3725">   // send operations on externally created RFC822 disk files,</span>
<a href="#l33.3726"></a><span id="l33.3726">   // make sure we have setup the appropriate nsIFile and</span>
<a href="#l33.3727"></a><span id="l33.3727">   // move on with life.</span>
<a href="#l33.3728"></a><span id="l33.3728">   //</span>
<a href="#l33.3729"></a><span id="l33.3729">   //</span>
<a href="#l33.3730"></a><span id="l33.3730">   // First check to see if we are doing a send operation on an external file</span>
<a href="#l33.3731"></a><span id="l33.3731">   // or creating the file itself.</span>
<a href="#l33.3732"></a><span id="l33.3732">   //</span>
<a href="#l33.3733"></a><span id="l33.3733" class="difflineminus">-  if (sendFile)</span>
<a href="#l33.3734"></a><span id="l33.3734" class="difflineminus">-  {</span>
<a href="#l33.3735"></a><span id="l33.3735" class="difflineplus">+  if (sendFile) {</span>
<a href="#l33.3736"></a><span id="l33.3736">     mTempFile = sendFile;</span>
<a href="#l33.3737"></a><span id="l33.3737">     return NS_OK;</span>
<a href="#l33.3738"></a><span id="l33.3738">   }</span>
<a href="#l33.3739"></a><span id="l33.3739"> </span>
<a href="#l33.3740"></a><span id="l33.3740">   // Ok, now watch me pull a rabbit out of my hat....what we need</span>
<a href="#l33.3741"></a><span id="l33.3741">   // to do here is figure out what the body will be. If this is a</span>
<a href="#l33.3742"></a><span id="l33.3742">   // MHTML request, then we need to do some processing of the document</span>
<a href="#l33.3743"></a><span id="l33.3743">   // and figure out what we need to package along with this message</span>
<a href="#l33.3744"></a><span id="l33.3744">   // to send. See ProcessMultipartRelated() for further details.</span>
<a href="#l33.3745"></a><span id="l33.3745">   //</span>
<a href="#l33.3746"></a><span id="l33.3746"> </span>
<a href="#l33.3747"></a><span id="l33.3747">   //</span>
<a href="#l33.3748"></a><span id="l33.3748" class="difflineminus">-  // If we don't have an editor, then we won't be doing multipart related processing</span>
<a href="#l33.3749"></a><span id="l33.3749" class="difflineminus">-  // for the body, so make a copy of the one passed in.</span>
<a href="#l33.3750"></a><span id="l33.3750" class="difflineplus">+  // If we don't have an editor, then we won't be doing multipart related</span>
<a href="#l33.3751"></a><span id="l33.3751" class="difflineplus">+  // processing for the body, so make a copy of the one passed in.</span>
<a href="#l33.3752"></a><span id="l33.3752">   //</span>
<a href="#l33.3753"></a><span id="l33.3753" class="difflineminus">-  if (!mEditor)</span>
<a href="#l33.3754"></a><span id="l33.3754" class="difflineminus">-  {</span>
<a href="#l33.3755"></a><span id="l33.3755" class="difflineplus">+  if (!mEditor) {</span>
<a href="#l33.3756"></a><span id="l33.3756">     SnarfAndCopyBody(attachment1_body, attachment1_type);</span>
<a href="#l33.3757"></a><span id="l33.3757">     mOriginalHTMLBody = ToNewCString(attachment1_body);</span>
<a href="#l33.3758"></a><span id="l33.3758" class="difflineminus">-  }</span>
<a href="#l33.3759"></a><span id="l33.3759" class="difflineminus">-  else if (GetMultipartRelatedCount() == 0) // Only do this if there are not embedded objects</span>
<a href="#l33.3760"></a><span id="l33.3760" class="difflineminus">-  {</span>
<a href="#l33.3761"></a><span id="l33.3761" class="difflineplus">+  } else if (GetMultipartRelatedCount() == 0) {</span>
<a href="#l33.3762"></a><span id="l33.3762" class="difflineplus">+    // Only do this if there are not embedded objects</span>
<a href="#l33.3763"></a><span id="l33.3763">     rv = GetBodyFromEditor();</span>
<a href="#l33.3764"></a><span id="l33.3764" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l33.3765"></a><span id="l33.3765" class="difflineminus">-      return rv;</span>
<a href="#l33.3766"></a><span id="l33.3766" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l33.3767"></a><span id="l33.3767">   }</span>
<a href="#l33.3768"></a><span id="l33.3768"> </span>
<a href="#l33.3769"></a><span id="l33.3769">   mSmtpPassword = password;</span>
<a href="#l33.3770"></a><span id="l33.3770"> </span>
<a href="#l33.3771"></a><span id="l33.3771">   return HackAttachments(attachments, preloaded_attachments);</span>
<a href="#l33.3772"></a><span id="l33.3772"> }</span>
<a href="#l33.3773"></a><span id="l33.3773"> </span>
<a href="#l33.3774"></a><span id="l33.3774" class="difflineminus">-NS_IMETHODIMP nsMsgComposeAndSend::SendDeliveryCallback(nsIURI *aUrl, bool inIsNewsDelivery, nsresult aExitCode)</span>
<a href="#l33.3775"></a><span id="l33.3775" class="difflineminus">-{</span>
<a href="#l33.3776"></a><span id="l33.3776" class="difflineminus">-  if (inIsNewsDelivery)</span>
<a href="#l33.3777"></a><span id="l33.3777" class="difflineminus">-  {</span>
<a href="#l33.3778"></a><span id="l33.3778" class="difflineplus">+NS_IMETHODIMP nsMsgComposeAndSend::SendDeliveryCallback(nsIURI *aUrl,</span>
<a href="#l33.3779"></a><span id="l33.3779" class="difflineplus">+                                                        bool inIsNewsDelivery,</span>
<a href="#l33.3780"></a><span id="l33.3780" class="difflineplus">+                                                        nsresult aExitCode) {</span>
<a href="#l33.3781"></a><span id="l33.3781" class="difflineplus">+  if (inIsNewsDelivery) {</span>
<a href="#l33.3782"></a><span id="l33.3782">     if (NS_FAILED(aExitCode))</span>
<a href="#l33.3783"></a><span id="l33.3783">       if (aExitCode != NS_ERROR_ABORT &amp;&amp; !NS_IS_MSG_ERROR(aExitCode))</span>
<a href="#l33.3784"></a><span id="l33.3784">         aExitCode = NS_ERROR_POST_FAILED;</span>
<a href="#l33.3785"></a><span id="l33.3785"> </span>
<a href="#l33.3786"></a><span id="l33.3786">     DeliverAsNewsExit(aUrl, aExitCode);</span>
<a href="#l33.3787"></a><span id="l33.3787" class="difflineminus">-  }</span>
<a href="#l33.3788"></a><span id="l33.3788" class="difflineminus">-  else</span>
<a href="#l33.3789"></a><span id="l33.3789" class="difflineminus">-  {</span>
<a href="#l33.3790"></a><span id="l33.3790" class="difflineminus">-    if (NS_FAILED(aExitCode))</span>
<a href="#l33.3791"></a><span id="l33.3791" class="difflineminus">-    {</span>
<a href="#l33.3792"></a><span id="l33.3792" class="difflineplus">+  } else {</span>
<a href="#l33.3793"></a><span id="l33.3793" class="difflineplus">+    if (NS_FAILED(aExitCode)) {</span>
<a href="#l33.3794"></a><span id="l33.3794"> #ifdef __GNUC__</span>
<a href="#l33.3795"></a><span id="l33.3795"> // Temporary workaround until bug 783526 is fixed.</span>
<a href="#l33.3796"></a><span id="l33.3796" class="difflineminus">-#pragma GCC diagnostic push</span>
<a href="#l33.3797"></a><span id="l33.3797" class="difflineminus">-#pragma GCC diagnostic ignored &quot;-Wswitch&quot;</span>
<a href="#l33.3798"></a><span id="l33.3798" class="difflineplus">+#  pragma GCC diagnostic push</span>
<a href="#l33.3799"></a><span id="l33.3799" class="difflineplus">+#  pragma GCC diagnostic ignored &quot;-Wswitch&quot;</span>
<a href="#l33.3800"></a><span id="l33.3800"> #endif</span>
<a href="#l33.3801"></a><span id="l33.3801" class="difflineminus">-      switch (aExitCode)</span>
<a href="#l33.3802"></a><span id="l33.3802" class="difflineminus">-      {</span>
<a href="#l33.3803"></a><span id="l33.3803" class="difflineplus">+      switch (aExitCode) {</span>
<a href="#l33.3804"></a><span id="l33.3804">         case NS_ERROR_UNKNOWN_HOST:</span>
<a href="#l33.3805"></a><span id="l33.3805">         case NS_ERROR_UNKNOWN_PROXY_HOST:</span>
<a href="#l33.3806"></a><span id="l33.3806">           aExitCode = NS_ERROR_SMTP_SEND_FAILED_UNKNOWN_SERVER;</span>
<a href="#l33.3807"></a><span id="l33.3807">           break;</span>
<a href="#l33.3808"></a><span id="l33.3808">         case NS_ERROR_CONNECTION_REFUSED:</span>
<a href="#l33.3809"></a><span id="l33.3809">         case NS_ERROR_PROXY_CONNECTION_REFUSED:</span>
<a href="#l33.3810"></a><span id="l33.3810">           aExitCode = NS_ERROR_SMTP_SEND_FAILED_REFUSED;</span>
<a href="#l33.3811"></a><span id="l33.3811">           break;</span>
<a href="#l33.3812"></a><span id="l33.3812" class="difflineat">@@ -3122,130 +2822,121 @@ NS_IMETHODIMP nsMsgComposeAndSend::SendD</span>
<a href="#l33.3813"></a><span id="l33.3813">         case NS_ERROR_ABORT:</span>
<a href="#l33.3814"></a><span id="l33.3814">           aExitCode = NS_ERROR_SMTP_SEND_FAILED_INTERRUPTED;</span>
<a href="#l33.3815"></a><span id="l33.3815">           break;</span>
<a href="#l33.3816"></a><span id="l33.3816">         case NS_ERROR_NET_TIMEOUT:</span>
<a href="#l33.3817"></a><span id="l33.3817">         case NS_ERROR_NET_RESET:</span>
<a href="#l33.3818"></a><span id="l33.3818">           aExitCode = NS_ERROR_SMTP_SEND_FAILED_TIMEOUT;</span>
<a href="#l33.3819"></a><span id="l33.3819">           break;</span>
<a href="#l33.3820"></a><span id="l33.3820">         case NS_ERROR_SMTP_PASSWORD_UNDEFINED:</span>
<a href="#l33.3821"></a><span id="l33.3821" class="difflineminus">-            // nothing to do, just keep the code</span>
<a href="#l33.3822"></a><span id="l33.3822" class="difflineplus">+          // nothing to do, just keep the code</span>
<a href="#l33.3823"></a><span id="l33.3823">           break;</span>
<a href="#l33.3824"></a><span id="l33.3824">         default:</span>
<a href="#l33.3825"></a><span id="l33.3825">           break;</span>
<a href="#l33.3826"></a><span id="l33.3826">       }</span>
<a href="#l33.3827"></a><span id="l33.3827"> #ifdef __GNUC__</span>
<a href="#l33.3828"></a><span id="l33.3828" class="difflineminus">-#pragma GCC diagnostic pop</span>
<a href="#l33.3829"></a><span id="l33.3829" class="difflineplus">+#  pragma GCC diagnostic pop</span>
<a href="#l33.3830"></a><span id="l33.3830"> #endif</span>
<a href="#l33.3831"></a><span id="l33.3831">     }</span>
<a href="#l33.3832"></a><span id="l33.3832">     DeliverAsMailExit(aUrl, aExitCode);</span>
<a href="#l33.3833"></a><span id="l33.3833">   }</span>
<a href="#l33.3834"></a><span id="l33.3834"> </span>
<a href="#l33.3835"></a><span id="l33.3835">   return aExitCode;</span>
<a href="#l33.3836"></a><span id="l33.3836"> }</span>
<a href="#l33.3837"></a><span id="l33.3837"> </span>
<a href="#l33.3838"></a><span id="l33.3838" class="difflineminus">-nsresult</span>
<a href="#l33.3839"></a><span id="l33.3839" class="difflineminus">-nsMsgComposeAndSend::DeliverMessage()</span>
<a href="#l33.3840"></a><span id="l33.3840" class="difflineminus">-{</span>
<a href="#l33.3841"></a><span id="l33.3841" class="difflineminus">-  if (mSendProgress)</span>
<a href="#l33.3842"></a><span id="l33.3842" class="difflineminus">-  {</span>
<a href="#l33.3843"></a><span id="l33.3843" class="difflineplus">+nsresult nsMsgComposeAndSend::DeliverMessage() {</span>
<a href="#l33.3844"></a><span id="l33.3844" class="difflineplus">+  if (mSendProgress) {</span>
<a href="#l33.3845"></a><span id="l33.3845">     bool canceled = false;</span>
<a href="#l33.3846"></a><span id="l33.3846">     mSendProgress-&gt;GetProcessCanceledByUser(&amp;canceled);</span>
<a href="#l33.3847"></a><span id="l33.3847" class="difflineminus">-    if (canceled)</span>
<a href="#l33.3848"></a><span id="l33.3848" class="difflineminus">-      return NS_ERROR_ABORT;</span>
<a href="#l33.3849"></a><span id="l33.3849" class="difflineplus">+    if (canceled) return NS_ERROR_ABORT;</span>
<a href="#l33.3850"></a><span id="l33.3850">   }</span>
<a href="#l33.3851"></a><span id="l33.3851"> </span>
<a href="#l33.3852"></a><span id="l33.3852">   bool mail_p = ((mCompFields-&gt;GetTo() &amp;&amp; *mCompFields-&gt;GetTo()) ||</span>
<a href="#l33.3853"></a><span id="l33.3853" class="difflineminus">-          (mCompFields-&gt;GetCc() &amp;&amp; *mCompFields-&gt;GetCc()) ||</span>
<a href="#l33.3854"></a><span id="l33.3854" class="difflineminus">-          (mCompFields-&gt;GetBcc() &amp;&amp; *mCompFields-&gt;GetBcc()));</span>
<a href="#l33.3855"></a><span id="l33.3855" class="difflineplus">+                 (mCompFields-&gt;GetCc() &amp;&amp; *mCompFields-&gt;GetCc()) ||</span>
<a href="#l33.3856"></a><span id="l33.3856" class="difflineplus">+                 (mCompFields-&gt;GetBcc() &amp;&amp; *mCompFields-&gt;GetBcc()));</span>
<a href="#l33.3857"></a><span id="l33.3857">   bool news_p = mCompFields-&gt;GetNewsgroups() &amp;&amp; *(mCompFields-&gt;GetNewsgroups());</span>
<a href="#l33.3858"></a><span id="l33.3858" class="difflineminus">-  NS_ASSERTION(!( m_deliver_mode != nsMsgSaveAsDraft &amp;&amp; m_deliver_mode != nsMsgSaveAsTemplate)  || (mail_p || news_p), &quot;message without destination&quot;);</span>
<a href="#l33.3859"></a><span id="l33.3859" class="difflineplus">+  NS_ASSERTION(!(m_deliver_mode != nsMsgSaveAsDraft &amp;&amp;</span>
<a href="#l33.3860"></a><span id="l33.3860" class="difflineplus">+                 m_deliver_mode != nsMsgSaveAsTemplate) ||</span>
<a href="#l33.3861"></a><span id="l33.3861" class="difflineplus">+                   (mail_p || news_p),</span>
<a href="#l33.3862"></a><span id="l33.3862" class="difflineplus">+               &quot;message without destination&quot;);</span>
<a href="#l33.3863"></a><span id="l33.3863">   if (m_deliver_mode == nsMsgQueueForLater ||</span>
<a href="#l33.3864"></a><span id="l33.3864">       m_deliver_mode == nsMsgDeliverBackground ||</span>
<a href="#l33.3865"></a><span id="l33.3865">       m_deliver_mode == nsMsgSaveAsDraft ||</span>
<a href="#l33.3866"></a><span id="l33.3866">       m_deliver_mode == nsMsgSaveAsTemplate)</span>
<a href="#l33.3867"></a><span id="l33.3867">     return SendToMagicFolder(m_deliver_mode);</span>
<a href="#l33.3868"></a><span id="l33.3868"> </span>
<a href="#l33.3869"></a><span id="l33.3869">   //</span>
<a href="#l33.3870"></a><span id="l33.3870">   // Ok, we are about to send the file that we have built up...but what</span>
<a href="#l33.3871"></a><span id="l33.3871">   // if this is a mongo email...we should have a way to warn the user that</span>
<a href="#l33.3872"></a><span id="l33.3872">   // they are about to do something they may not want to do.</span>
<a href="#l33.3873"></a><span id="l33.3873">   //</span>
<a href="#l33.3874"></a><span id="l33.3874">   int64_t fileSize;</span>
<a href="#l33.3875"></a><span id="l33.3875">   nsresult rv = mTempFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l33.3876"></a><span id="l33.3876" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l33.3877"></a><span id="l33.3877" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l33.3878"></a><span id="l33.3878" class="difflineminus">-</span>
<a href="#l33.3879"></a><span id="l33.3879" class="difflineminus">-  if ((mMessageWarningSize &gt; 0) &amp;&amp; (fileSize &gt; mMessageWarningSize) &amp;&amp; (mGUINotificationEnabled))</span>
<a href="#l33.3880"></a><span id="l33.3880" class="difflineminus">-  {</span>
<a href="#l33.3881"></a><span id="l33.3881" class="difflineplus">+  if (NS_FAILED(rv)) return NS_ERROR_FAILURE;</span>
<a href="#l33.3882"></a><span id="l33.3882" class="difflineplus">+</span>
<a href="#l33.3883"></a><span id="l33.3883" class="difflineplus">+  if ((mMessageWarningSize &gt; 0) &amp;&amp; (fileSize &gt; mMessageWarningSize) &amp;&amp;</span>
<a href="#l33.3884"></a><span id="l33.3884" class="difflineplus">+      (mGUINotificationEnabled)) {</span>
<a href="#l33.3885"></a><span id="l33.3885">     bool abortTheSend = false;</span>
<a href="#l33.3886"></a><span id="l33.3886">     nsString msg;</span>
<a href="#l33.3887"></a><span id="l33.3887">     nsAutoString formattedFileSize;</span>
<a href="#l33.3888"></a><span id="l33.3888">     FormatFileSize(fileSize, true, formattedFileSize);</span>
<a href="#l33.3889"></a><span id="l33.3889" class="difflineminus">-    const char16_t* params[] = { formattedFileSize.get() };</span>
<a href="#l33.3890"></a><span id="l33.3890" class="difflineminus">-    mComposeBundle-&gt;FormatStringFromName(&quot;largeMessageSendWarning&quot;,</span>
<a href="#l33.3891"></a><span id="l33.3891" class="difflineminus">-                                         params, 1, msg);</span>
<a href="#l33.3892"></a><span id="l33.3892" class="difflineminus">-</span>
<a href="#l33.3893"></a><span id="l33.3893" class="difflineminus">-    if (!msg.IsEmpty())</span>
<a href="#l33.3894"></a><span id="l33.3894" class="difflineminus">-    {</span>
<a href="#l33.3895"></a><span id="l33.3895" class="difflineplus">+    const char16_t *params[] = {formattedFileSize.get()};</span>
<a href="#l33.3896"></a><span id="l33.3896" class="difflineplus">+    mComposeBundle-&gt;FormatStringFromName(&quot;largeMessageSendWarning&quot;, params, 1,</span>
<a href="#l33.3897"></a><span id="l33.3897" class="difflineplus">+                                         msg);</span>
<a href="#l33.3898"></a><span id="l33.3898" class="difflineplus">+</span>
<a href="#l33.3899"></a><span id="l33.3899" class="difflineplus">+    if (!msg.IsEmpty()) {</span>
<a href="#l33.3900"></a><span id="l33.3900">       nsCOMPtr&lt;nsIPrompt&gt; prompt;</span>
<a href="#l33.3901"></a><span id="l33.3901">       rv = GetDefaultPrompt(getter_AddRefs(prompt));</span>
<a href="#l33.3902"></a><span id="l33.3902">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l33.3903"></a><span id="l33.3903">       nsMsgAskBooleanQuestionByString(prompt, msg.get(), &amp;abortTheSend);</span>
<a href="#l33.3904"></a><span id="l33.3904" class="difflineminus">-      if (!abortTheSend)</span>
<a href="#l33.3905"></a><span id="l33.3905" class="difflineminus">-      {</span>
<a href="#l33.3906"></a><span id="l33.3906" class="difflineplus">+      if (!abortTheSend) {</span>
<a href="#l33.3907"></a><span id="l33.3907">         nsresult ignoreMe;</span>
<a href="#l33.3908"></a><span id="l33.3908">         Fail(NS_ERROR_BUT_DONT_SHOW_ALERT, msg.get(), &amp;ignoreMe);</span>
<a href="#l33.3909"></a><span id="l33.3909">         return NS_ERROR_FAILURE;</span>
<a href="#l33.3910"></a><span id="l33.3910">       }</span>
<a href="#l33.3911"></a><span id="l33.3911">     }</span>
<a href="#l33.3912"></a><span id="l33.3912">   }</span>
<a href="#l33.3913"></a><span id="l33.3913"> </span>
<a href="#l33.3914"></a><span id="l33.3914" class="difflineminus">-  if (news_p)</span>
<a href="#l33.3915"></a><span id="l33.3915" class="difflineminus">-  {</span>
<a href="#l33.3916"></a><span id="l33.3916" class="difflineminus">-    if (mail_p)</span>
<a href="#l33.3917"></a><span id="l33.3917" class="difflineminus">-      mSendMailAlso = true;</span>
<a href="#l33.3918"></a><span id="l33.3918" class="difflineminus">-</span>
<a href="#l33.3919"></a><span id="l33.3919" class="difflineminus">-    return DeliverFileAsNews();   /* will call DeliverFileAsMail if it needs to */</span>
<a href="#l33.3920"></a><span id="l33.3920" class="difflineplus">+  if (news_p) {</span>
<a href="#l33.3921"></a><span id="l33.3921" class="difflineplus">+    if (mail_p) mSendMailAlso = true;</span>
<a href="#l33.3922"></a><span id="l33.3922" class="difflineplus">+</span>
<a href="#l33.3923"></a><span id="l33.3923" class="difflineplus">+    return DeliverFileAsNews(); /* will call DeliverFileAsMail if it needs to */</span>
<a href="#l33.3924"></a><span id="l33.3924">   }</span>
<a href="#l33.3925"></a><span id="l33.3925"> </span>
<a href="#l33.3926"></a><span id="l33.3926" class="difflineminus">-  if (mail_p)</span>
<a href="#l33.3927"></a><span id="l33.3927" class="difflineminus">-    return DeliverFileAsMail();</span>
<a href="#l33.3928"></a><span id="l33.3928" class="difflineplus">+  if (mail_p) return DeliverFileAsMail();</span>
<a href="#l33.3929"></a><span id="l33.3929"> </span>
<a href="#l33.3930"></a><span id="l33.3930">   return NS_ERROR_UNEXPECTED;</span>
<a href="#l33.3931"></a><span id="l33.3931"> }</span>
<a href="#l33.3932"></a><span id="l33.3932"> </span>
<a href="#l33.3933"></a><span id="l33.3933" class="difflineminus">-</span>
<a href="#l33.3934"></a><span id="l33.3934" class="difflineminus">-nsresult</span>
<a href="#l33.3935"></a><span id="l33.3935" class="difflineminus">-nsMsgComposeAndSend::DeliverFileAsMail()</span>
<a href="#l33.3936"></a><span id="l33.3936" class="difflineminus">-{</span>
<a href="#l33.3937"></a><span id="l33.3937" class="difflineplus">+nsresult nsMsgComposeAndSend::DeliverFileAsMail() {</span>
<a href="#l33.3938"></a><span id="l33.3938">   char *buf, *buf2;</span>
<a href="#l33.3939"></a><span id="l33.3939" class="difflineminus">-  buf = (char *) PR_Malloc ((mCompFields-&gt;GetTo() ? PL_strlen (mCompFields-&gt;GetTo())  + 10 : 0) +</span>
<a href="#l33.3940"></a><span id="l33.3940" class="difflineminus">-               (mCompFields-&gt;GetCc() ? PL_strlen (mCompFields-&gt;GetCc())  + 10 : 0) +</span>
<a href="#l33.3941"></a><span id="l33.3941" class="difflineminus">-               (mCompFields-&gt;GetBcc() ? PL_strlen (mCompFields-&gt;GetBcc()) + 10 : 0) +</span>
<a href="#l33.3942"></a><span id="l33.3942" class="difflineminus">-               10);</span>
<a href="#l33.3943"></a><span id="l33.3943" class="difflineplus">+  buf = (char *)PR_Malloc(</span>
<a href="#l33.3944"></a><span id="l33.3944" class="difflineplus">+      (mCompFields-&gt;GetTo() ? PL_strlen(mCompFields-&gt;GetTo()) + 10 : 0) +</span>
<a href="#l33.3945"></a><span id="l33.3945" class="difflineplus">+      (mCompFields-&gt;GetCc() ? PL_strlen(mCompFields-&gt;GetCc()) + 10 : 0) +</span>
<a href="#l33.3946"></a><span id="l33.3946" class="difflineplus">+      (mCompFields-&gt;GetBcc() ? PL_strlen(mCompFields-&gt;GetBcc()) + 10 : 0) + 10);</span>
<a href="#l33.3947"></a><span id="l33.3947"> </span>
<a href="#l33.3948"></a><span id="l33.3948">   if (mSendReport)</span>
<a href="#l33.3949"></a><span id="l33.3949">     mSendReport-&gt;SetCurrentProcess(nsIMsgSendReport::process_SMTP);</span>
<a href="#l33.3950"></a><span id="l33.3950"> </span>
<a href="#l33.3951"></a><span id="l33.3951" class="difflineminus">-  if (!buf)</span>
<a href="#l33.3952"></a><span id="l33.3952" class="difflineminus">-  {</span>
<a href="#l33.3953"></a><span id="l33.3953" class="difflineplus">+  if (!buf) {</span>
<a href="#l33.3954"></a><span id="l33.3954">     nsresult ignoreMe;</span>
<a href="#l33.3955"></a><span id="l33.3955">     Fail(NS_ERROR_OUT_OF_MEMORY, nullptr, &amp;ignoreMe);</span>
<a href="#l33.3956"></a><span id="l33.3956" class="difflineminus">-    NotifyListenerOnStopSending(nullptr, NS_ERROR_OUT_OF_MEMORY, nullptr, nullptr);</span>
<a href="#l33.3957"></a><span id="l33.3957" class="difflineplus">+    NotifyListenerOnStopSending(nullptr, NS_ERROR_OUT_OF_MEMORY, nullptr,</span>
<a href="#l33.3958"></a><span id="l33.3958" class="difflineplus">+                                nullptr);</span>
<a href="#l33.3959"></a><span id="l33.3959">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l33.3960"></a><span id="l33.3960">   }</span>
<a href="#l33.3961"></a><span id="l33.3961"> </span>
<a href="#l33.3962"></a><span id="l33.3962">   bool collectOutgoingAddresses = true;</span>
<a href="#l33.3963"></a><span id="l33.3963">   nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l33.3964"></a><span id="l33.3964">   if (pPrefBranch)</span>
<a href="#l33.3965"></a><span id="l33.3965" class="difflineminus">-    pPrefBranch-&gt;GetBoolPref(PREF_MAIL_COLLECT_EMAIL_ADDRESS_OUTGOING, &amp;collectOutgoingAddresses);</span>
<a href="#l33.3966"></a><span id="l33.3966" class="difflineplus">+    pPrefBranch-&gt;GetBoolPref(PREF_MAIL_COLLECT_EMAIL_ADDRESS_OUTGOING,</span>
<a href="#l33.3967"></a><span id="l33.3967" class="difflineplus">+                             &amp;collectOutgoingAddresses);</span>
<a href="#l33.3968"></a><span id="l33.3968"> </span>
<a href="#l33.3969"></a><span id="l33.3969">   nsCOMPtr&lt;nsIAbAddressCollector&gt; addressCollector =</span>
<a href="#l33.3970"></a><span id="l33.3970" class="difflineminus">-           do_GetService(NS_ABADDRESSCOLLECTOR_CONTRACTID);</span>
<a href="#l33.3971"></a><span id="l33.3971" class="difflineplus">+      do_GetService(NS_ABADDRESSCOLLECTOR_CONTRACTID);</span>
<a href="#l33.3972"></a><span id="l33.3972"> </span>
<a href="#l33.3973"></a><span id="l33.3973">   bool collectAddresses = (collectOutgoingAddresses &amp;&amp; addressCollector);</span>
<a href="#l33.3974"></a><span id="l33.3974">   uint32_t sendFormat = nsIAbPreferMailFormat::unknown;</span>
<a href="#l33.3975"></a><span id="l33.3975"> </span>
<a href="#l33.3976"></a><span id="l33.3976">   // this code is not ready yet</span>
<a href="#l33.3977"></a><span id="l33.3977">   // see bug #44494 for more details</span>
<a href="#l33.3978"></a><span id="l33.3978">   // so for now, just pass in nsIAbPreferMailFormat::unknown</span>
<a href="#l33.3979"></a><span id="l33.3979">   // which will have no effect on the &quot;prefers&quot; attribute in the ab</span>
<a href="#l33.3980"></a><span id="l33.3980" class="difflineat">@@ -3267,294 +2958,276 @@ nsMsgComposeAndSend::DeliverFileAsMail()</span>
<a href="#l33.3981"></a><span id="l33.3981">     sendFormat = nsIAbPreferMailFormat::unknown;</span>
<a href="#l33.3982"></a><span id="l33.3982">   }</span>
<a href="#l33.3983"></a><span id="l33.3983">   else if (!forcePlainText)</span>
<a href="#l33.3984"></a><span id="l33.3984">     sendFormat = nsIAbPreferMailFormat::html;</span>
<a href="#l33.3985"></a><span id="l33.3985">   else</span>
<a href="#l33.3986"></a><span id="l33.3986">     NS_ERROR(&quot;unknown send format, should not happen&quot;);</span>
<a href="#l33.3987"></a><span id="l33.3987"> #endif</span>
<a href="#l33.3988"></a><span id="l33.3988"> </span>
<a href="#l33.3989"></a><span id="l33.3989" class="difflineminus">-  PL_strcpy (buf, &quot;&quot;);</span>
<a href="#l33.3990"></a><span id="l33.3990" class="difflineminus">-  buf2 = buf + PL_strlen (buf);</span>
<a href="#l33.3991"></a><span id="l33.3991" class="difflineminus">-  if (mCompFields-&gt;GetTo() &amp;&amp; *mCompFields-&gt;GetTo())</span>
<a href="#l33.3992"></a><span id="l33.3992" class="difflineminus">-  {</span>
<a href="#l33.3993"></a><span id="l33.3993" class="difflineminus">-    PL_strcat (buf2, mCompFields-&gt;GetTo());</span>
<a href="#l33.3994"></a><span id="l33.3994" class="difflineplus">+  PL_strcpy(buf, &quot;&quot;);</span>
<a href="#l33.3995"></a><span id="l33.3995" class="difflineplus">+  buf2 = buf + PL_strlen(buf);</span>
<a href="#l33.3996"></a><span id="l33.3996" class="difflineplus">+  if (mCompFields-&gt;GetTo() &amp;&amp; *mCompFields-&gt;GetTo()) {</span>
<a href="#l33.3997"></a><span id="l33.3997" class="difflineplus">+    PL_strcat(buf2, mCompFields-&gt;GetTo());</span>
<a href="#l33.3998"></a><span id="l33.3998">     if (addressCollector)</span>
<a href="#l33.3999"></a><span id="l33.3999" class="difflineminus">-      addressCollector-&gt;CollectAddress(nsCString(mCompFields-&gt;GetTo()),</span>
<a href="#l33.4000"></a><span id="l33.4000" class="difflineminus">-            collectAddresses /* create card if one doesn't exist */, sendFormat);</span>
<a href="#l33.4001"></a><span id="l33.4001" class="difflineplus">+      addressCollector-&gt;CollectAddress(</span>
<a href="#l33.4002"></a><span id="l33.4002" class="difflineplus">+          nsCString(mCompFields-&gt;GetTo()),</span>
<a href="#l33.4003"></a><span id="l33.4003" class="difflineplus">+          collectAddresses /* create card if one doesn't exist */, sendFormat);</span>
<a href="#l33.4004"></a><span id="l33.4004">   }</span>
<a href="#l33.4005"></a><span id="l33.4005">   if (mCompFields-&gt;GetCc() &amp;&amp; *mCompFields-&gt;GetCc()) {</span>
<a href="#l33.4006"></a><span id="l33.4006" class="difflineminus">-    if (*buf2) PL_strcat (buf2, &quot;,&quot;);</span>
<a href="#l33.4007"></a><span id="l33.4007" class="difflineminus">-      PL_strcat (buf2, mCompFields-&gt;GetCc());</span>
<a href="#l33.4008"></a><span id="l33.4008" class="difflineplus">+    if (*buf2) PL_strcat(buf2, &quot;,&quot;);</span>
<a href="#l33.4009"></a><span id="l33.4009" class="difflineplus">+    PL_strcat(buf2, mCompFields-&gt;GetCc());</span>
<a href="#l33.4010"></a><span id="l33.4010">     if (addressCollector)</span>
<a href="#l33.4011"></a><span id="l33.4011" class="difflineminus">-      addressCollector-&gt;CollectAddress(nsCString(mCompFields-&gt;GetCc()),</span>
<a href="#l33.4012"></a><span id="l33.4012" class="difflineminus">-            collectAddresses /* create card if one doesn't exist */, sendFormat);</span>
<a href="#l33.4013"></a><span id="l33.4013" class="difflineplus">+      addressCollector-&gt;CollectAddress(</span>
<a href="#l33.4014"></a><span id="l33.4014" class="difflineplus">+          nsCString(mCompFields-&gt;GetCc()),</span>
<a href="#l33.4015"></a><span id="l33.4015" class="difflineplus">+          collectAddresses /* create card if one doesn't exist */, sendFormat);</span>
<a href="#l33.4016"></a><span id="l33.4016">   }</span>
<a href="#l33.4017"></a><span id="l33.4017">   if (mCompFields-&gt;GetBcc() &amp;&amp; *mCompFields-&gt;GetBcc()) {</span>
<a href="#l33.4018"></a><span id="l33.4018" class="difflineminus">-    if (*buf2) PL_strcat (buf2, &quot;,&quot;);</span>
<a href="#l33.4019"></a><span id="l33.4019" class="difflineminus">-      PL_strcat (buf2, mCompFields-&gt;GetBcc());</span>
<a href="#l33.4020"></a><span id="l33.4020" class="difflineplus">+    if (*buf2) PL_strcat(buf2, &quot;,&quot;);</span>
<a href="#l33.4021"></a><span id="l33.4021" class="difflineplus">+    PL_strcat(buf2, mCompFields-&gt;GetBcc());</span>
<a href="#l33.4022"></a><span id="l33.4022">     if (addressCollector)</span>
<a href="#l33.4023"></a><span id="l33.4023" class="difflineminus">-      addressCollector-&gt;CollectAddress(nsCString(mCompFields-&gt;GetBcc()),</span>
<a href="#l33.4024"></a><span id="l33.4024" class="difflineminus">-            collectAddresses /* create card if one doesn't exist */, sendFormat);</span>
<a href="#l33.4025"></a><span id="l33.4025" class="difflineplus">+      addressCollector-&gt;CollectAddress(</span>
<a href="#l33.4026"></a><span id="l33.4026" class="difflineplus">+          nsCString(mCompFields-&gt;GetBcc()),</span>
<a href="#l33.4027"></a><span id="l33.4027" class="difflineplus">+          collectAddresses /* create card if one doesn't exist */, sendFormat);</span>
<a href="#l33.4028"></a><span id="l33.4028">   }</span>
<a href="#l33.4029"></a><span id="l33.4029"> </span>
<a href="#l33.4030"></a><span id="l33.4030">   // We need undo groups to keep only the addresses</span>
<a href="#l33.4031"></a><span id="l33.4031">   nsresult rv = StripOutGroupNames(buf);</span>
<a href="#l33.4032"></a><span id="l33.4032">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l33.4033"></a><span id="l33.4033"> </span>
<a href="#l33.4034"></a><span id="l33.4034">   // Ok, now MIME II encode this to prevent 8bit problems...</span>
<a href="#l33.4035"></a><span id="l33.4035" class="difflineminus">-  char *convbuf = nsMsgI18NEncodeMimePartIIStr(buf, true,</span>
<a href="#l33.4036"></a><span id="l33.4036" class="difflineminus">-            mCompFields-&gt;GetCharacterSet(), 0, nsMsgMIMEGetConformToStandard());</span>
<a href="#l33.4037"></a><span id="l33.4037" class="difflineminus">-  if (convbuf)</span>
<a href="#l33.4038"></a><span id="l33.4038" class="difflineminus">-  {</span>
<a href="#l33.4039"></a><span id="l33.4039" class="difflineplus">+  char *convbuf =</span>
<a href="#l33.4040"></a><span id="l33.4040" class="difflineplus">+      nsMsgI18NEncodeMimePartIIStr(buf, true, mCompFields-&gt;GetCharacterSet(), 0,</span>
<a href="#l33.4041"></a><span id="l33.4041" class="difflineplus">+                                   nsMsgMIMEGetConformToStandard());</span>
<a href="#l33.4042"></a><span id="l33.4042" class="difflineplus">+  if (convbuf) {</span>
<a href="#l33.4043"></a><span id="l33.4043">     // MIME-PartII conversion</span>
<a href="#l33.4044"></a><span id="l33.4044">     PR_FREEIF(buf);</span>
<a href="#l33.4045"></a><span id="l33.4045">     buf = convbuf;</span>
<a href="#l33.4046"></a><span id="l33.4046">   }</span>
<a href="#l33.4047"></a><span id="l33.4047"> </span>
<a href="#l33.4048"></a><span id="l33.4048">   nsCString escaped_buf;</span>
<a href="#l33.4049"></a><span id="l33.4049" class="difflineminus">-  MsgEscapeString(nsDependentCString(buf), nsINetUtil::ESCAPE_URL_PATH, escaped_buf);</span>
<a href="#l33.4050"></a><span id="l33.4050" class="difflineminus">-</span>
<a href="#l33.4051"></a><span id="l33.4051" class="difflineminus">-  if (!escaped_buf.IsEmpty())</span>
<a href="#l33.4052"></a><span id="l33.4052" class="difflineminus">-  {</span>
<a href="#l33.4053"></a><span id="l33.4053" class="difflineplus">+  MsgEscapeString(nsDependentCString(buf), nsINetUtil::ESCAPE_URL_PATH,</span>
<a href="#l33.4054"></a><span id="l33.4054" class="difflineplus">+                  escaped_buf);</span>
<a href="#l33.4055"></a><span id="l33.4055" class="difflineplus">+</span>
<a href="#l33.4056"></a><span id="l33.4056" class="difflineplus">+  if (!escaped_buf.IsEmpty()) {</span>
<a href="#l33.4057"></a><span id="l33.4057">     free(buf);</span>
<a href="#l33.4058"></a><span id="l33.4058">     buf = ToNewCString(escaped_buf);</span>
<a href="#l33.4059"></a><span id="l33.4059">   }</span>
<a href="#l33.4060"></a><span id="l33.4060"> </span>
<a href="#l33.4061"></a><span id="l33.4061" class="difflineminus">-  nsCOMPtr&lt;nsISmtpService&gt; smtpService(do_GetService(NS_SMTPSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l33.4062"></a><span id="l33.4062" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; smtpService)</span>
<a href="#l33.4063"></a><span id="l33.4063" class="difflineminus">-  {</span>
<a href="#l33.4064"></a><span id="l33.4064" class="difflineminus">-    MsgDeliveryListener *deliveryListener = new MsgDeliveryListener(this, false);</span>
<a href="#l33.4065"></a><span id="l33.4065" class="difflineminus">-    if (!deliveryListener)</span>
<a href="#l33.4066"></a><span id="l33.4066" class="difflineminus">-      return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l33.4067"></a><span id="l33.4067" class="difflineplus">+  nsCOMPtr&lt;nsISmtpService&gt; smtpService(</span>
<a href="#l33.4068"></a><span id="l33.4068" class="difflineplus">+      do_GetService(NS_SMTPSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l33.4069"></a><span id="l33.4069" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; smtpService) {</span>
<a href="#l33.4070"></a><span id="l33.4070" class="difflineplus">+    MsgDeliveryListener *deliveryListener =</span>
<a href="#l33.4071"></a><span id="l33.4071" class="difflineplus">+        new MsgDeliveryListener(this, false);</span>
<a href="#l33.4072"></a><span id="l33.4072" class="difflineplus">+    if (!deliveryListener) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l33.4073"></a><span id="l33.4073"> </span>
<a href="#l33.4074"></a><span id="l33.4074">     // we used to get the prompt from the compose window and we'd pass that in</span>
<a href="#l33.4075"></a><span id="l33.4075">     // to the smtp protocol as the prompt to use. But when you send a message,</span>
<a href="#l33.4076"></a><span id="l33.4076" class="difflineminus">-    // we dismiss the compose window.....so you are parenting off of a window that</span>
<a href="#l33.4077"></a><span id="l33.4077" class="difflineminus">-    // isn't there. To have it work correctly I think we want the alert dialogs to be modal</span>
<a href="#l33.4078"></a><span id="l33.4078" class="difflineminus">-    // to the top most mail window...after all, that's where we are going to be sending status</span>
<a href="#l33.4079"></a><span id="l33.4079" class="difflineminus">-    // update information too....</span>
<a href="#l33.4080"></a><span id="l33.4080" class="difflineplus">+    // we dismiss the compose window.....so you are parenting off of a window</span>
<a href="#l33.4081"></a><span id="l33.4081" class="difflineplus">+    // that isn't there. To have it work correctly I think we want the alert</span>
<a href="#l33.4082"></a><span id="l33.4082" class="difflineplus">+    // dialogs to be modal to the top most mail window...after all, that's where</span>
<a href="#l33.4083"></a><span id="l33.4083" class="difflineplus">+    // we are going to be sending status update information too....</span>
<a href="#l33.4084"></a><span id="l33.4084"> </span>
<a href="#l33.4085"></a><span id="l33.4085">     nsCOMPtr&lt;nsIInterfaceRequestor&gt; callbacks;</span>
<a href="#l33.4086"></a><span id="l33.4086">     GetNotificationCallbacks(getter_AddRefs(callbacks));</span>
<a href="#l33.4087"></a><span id="l33.4087"> </span>
<a href="#l33.4088"></a><span id="l33.4088">     // Tell the user we are sending the message!</span>
<a href="#l33.4089"></a><span id="l33.4089">     nsString msg;</span>
<a href="#l33.4090"></a><span id="l33.4090">     mComposeBundle-&gt;GetStringFromName(&quot;sendingMessage&quot;, msg);</span>
<a href="#l33.4091"></a><span id="l33.4091">     SetStatusMessage(msg);</span>
<a href="#l33.4092"></a><span id="l33.4092" class="difflineminus">-    nsCOMPtr&lt;nsIMsgStatusFeedback&gt; msgStatus (do_QueryInterface(mSendProgress));</span>
<a href="#l33.4093"></a><span id="l33.4093" class="difflineplus">+    nsCOMPtr&lt;nsIMsgStatusFeedback&gt; msgStatus(do_QueryInterface(mSendProgress));</span>
<a href="#l33.4094"></a><span id="l33.4094">     // if the sendProgress isn't set, let's use the member variable.</span>
<a href="#l33.4095"></a><span id="l33.4095" class="difflineminus">-    if (!msgStatus)</span>
<a href="#l33.4096"></a><span id="l33.4096" class="difflineminus">-      msgStatus = mStatusFeedback;</span>
<a href="#l33.4097"></a><span id="l33.4097" class="difflineplus">+    if (!msgStatus) msgStatus = mStatusFeedback;</span>
<a href="#l33.4098"></a><span id="l33.4098"> </span>
<a href="#l33.4099"></a><span id="l33.4099">     nsCOMPtr&lt;nsIURI&gt; runningUrl;</span>
<a href="#l33.4100"></a><span id="l33.4100" class="difflineminus">-    rv = smtpService-&gt;SendMailMessage(mTempFile, buf, mUserIdentity, mCompFields-&gt;GetFrom(),</span>
<a href="#l33.4101"></a><span id="l33.4101" class="difflineminus">-                                      mSmtpPassword, deliveryListener, msgStatus,</span>
<a href="#l33.4102"></a><span id="l33.4102" class="difflineminus">-                                      callbacks, mCompFields-&gt;GetDSN(),</span>
<a href="#l33.4103"></a><span id="l33.4103" class="difflineminus">-                                      getter_AddRefs(runningUrl),</span>
<a href="#l33.4104"></a><span id="l33.4104" class="difflineminus">-                                      getter_AddRefs(mRunningRequest));</span>
<a href="#l33.4105"></a><span id="l33.4105" class="difflineplus">+    rv = smtpService-&gt;SendMailMessage(</span>
<a href="#l33.4106"></a><span id="l33.4106" class="difflineplus">+        mTempFile, buf, mUserIdentity, mCompFields-&gt;GetFrom(), mSmtpPassword,</span>
<a href="#l33.4107"></a><span id="l33.4107" class="difflineplus">+        deliveryListener, msgStatus, callbacks, mCompFields-&gt;GetDSN(),</span>
<a href="#l33.4108"></a><span id="l33.4108" class="difflineplus">+        getter_AddRefs(runningUrl), getter_AddRefs(mRunningRequest));</span>
<a href="#l33.4109"></a><span id="l33.4109">     // set envid on the returned URL</span>
<a href="#l33.4110"></a><span id="l33.4110" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l33.4111"></a><span id="l33.4111" class="difflineminus">-    {</span>
<a href="#l33.4112"></a><span id="l33.4112" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l33.4113"></a><span id="l33.4113">       nsCOMPtr&lt;nsISmtpUrl&gt; smtpUrl(do_QueryInterface(runningUrl, &amp;rv));</span>
<a href="#l33.4114"></a><span id="l33.4114">       if (NS_SUCCEEDED(rv))</span>
<a href="#l33.4115"></a><span id="l33.4115">         smtpUrl-&gt;SetDsnEnvid(nsDependentCString(mCompFields-&gt;GetMessageId()));</span>
<a href="#l33.4116"></a><span id="l33.4116">     }</span>
<a href="#l33.4117"></a><span id="l33.4117">   }</span>
<a href="#l33.4118"></a><span id="l33.4118"> </span>
<a href="#l33.4119"></a><span id="l33.4119" class="difflineminus">-  PR_FREEIF(buf); // free the buf because we are done with it....</span>
<a href="#l33.4120"></a><span id="l33.4120" class="difflineplus">+  PR_FREEIF(buf);  // free the buf because we are done with it....</span>
<a href="#l33.4121"></a><span id="l33.4121">   return rv;</span>
<a href="#l33.4122"></a><span id="l33.4122"> }</span>
<a href="#l33.4123"></a><span id="l33.4123"> </span>
<a href="#l33.4124"></a><span id="l33.4124" class="difflineminus">-nsresult</span>
<a href="#l33.4125"></a><span id="l33.4125" class="difflineminus">-nsMsgComposeAndSend::DeliverFileAsNews()</span>
<a href="#l33.4126"></a><span id="l33.4126" class="difflineminus">-{</span>
<a href="#l33.4127"></a><span id="l33.4127" class="difflineplus">+nsresult nsMsgComposeAndSend::DeliverFileAsNews() {</span>
<a href="#l33.4128"></a><span id="l33.4128">   nsresult rv = NS_OK;</span>
<a href="#l33.4129"></a><span id="l33.4129" class="difflineminus">-  if (!(mCompFields-&gt;GetNewsgroups()))</span>
<a href="#l33.4130"></a><span id="l33.4130" class="difflineminus">-    return rv;</span>
<a href="#l33.4131"></a><span id="l33.4131" class="difflineplus">+  if (!(mCompFields-&gt;GetNewsgroups())) return rv;</span>
<a href="#l33.4132"></a><span id="l33.4132"> </span>
<a href="#l33.4133"></a><span id="l33.4133">   if (mSendReport)</span>
<a href="#l33.4134"></a><span id="l33.4134">     mSendReport-&gt;SetCurrentProcess(nsIMsgSendReport::process_NNTP);</span>
<a href="#l33.4135"></a><span id="l33.4135"> </span>
<a href="#l33.4136"></a><span id="l33.4136" class="difflineminus">-  nsCOMPtr&lt;nsINntpService&gt; nntpService(do_GetService(NS_NNTPSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l33.4137"></a><span id="l33.4137" class="difflineminus">-</span>
<a href="#l33.4138"></a><span id="l33.4138" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; nntpService)</span>
<a href="#l33.4139"></a><span id="l33.4139" class="difflineminus">-  {</span>
<a href="#l33.4140"></a><span id="l33.4140" class="difflineplus">+  nsCOMPtr&lt;nsINntpService&gt; nntpService(</span>
<a href="#l33.4141"></a><span id="l33.4141" class="difflineplus">+      do_GetService(NS_NNTPSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l33.4142"></a><span id="l33.4142" class="difflineplus">+</span>
<a href="#l33.4143"></a><span id="l33.4143" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; nntpService) {</span>
<a href="#l33.4144"></a><span id="l33.4144">     MsgDeliveryListener *deliveryListener = new MsgDeliveryListener(this, true);</span>
<a href="#l33.4145"></a><span id="l33.4145" class="difflineminus">-    if (!deliveryListener)</span>
<a href="#l33.4146"></a><span id="l33.4146" class="difflineminus">-      return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l33.4147"></a><span id="l33.4147" class="difflineplus">+    if (!deliveryListener) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l33.4148"></a><span id="l33.4148"> </span>
<a href="#l33.4149"></a><span id="l33.4149">     // Tell the user we are posting the message!</span>
<a href="#l33.4150"></a><span id="l33.4150">     nsString msg;</span>
<a href="#l33.4151"></a><span id="l33.4151">     mComposeBundle-&gt;GetStringFromName(&quot;postingMessage&quot;, msg);</span>
<a href="#l33.4152"></a><span id="l33.4152">     SetStatusMessage(msg);</span>
<a href="#l33.4153"></a><span id="l33.4153"> </span>
<a href="#l33.4154"></a><span id="l33.4154" class="difflineminus">-    nsCOMPtr &lt;nsIMsgMailSession&gt; mailSession = do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l33.4155"></a><span id="l33.4155" class="difflineplus">+    nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession =</span>
<a href="#l33.4156"></a><span id="l33.4156" class="difflineplus">+        do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l33.4157"></a><span id="l33.4157">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l33.4158"></a><span id="l33.4158"> </span>
<a href="#l33.4159"></a><span id="l33.4159">     // JFD TODO: we should use GetDefaultPrompt instead</span>
<a href="#l33.4160"></a><span id="l33.4160">     nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l33.4161"></a><span id="l33.4161">     rv = mailSession-&gt;GetTopmostMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l33.4162"></a><span id="l33.4162">     // see bug #163139</span>
<a href="#l33.4163"></a><span id="l33.4163">     // we might not have a msg window if only the compose window is open.</span>
<a href="#l33.4164"></a><span id="l33.4164" class="difflineminus">-    if(NS_FAILED(rv))</span>
<a href="#l33.4165"></a><span id="l33.4165" class="difflineminus">-      msgWindow = nullptr;</span>
<a href="#l33.4166"></a><span id="l33.4166" class="difflineminus">-</span>
<a href="#l33.4167"></a><span id="l33.4167" class="difflineminus">-    rv = nntpService-&gt;PostMessage(mTempFile, mCompFields-&gt;GetNewsgroups(), mAccountKey.get(),</span>
<a href="#l33.4168"></a><span id="l33.4168" class="difflineminus">-                                  deliveryListener, msgWindow, nullptr);</span>
<a href="#l33.4169"></a><span id="l33.4169" class="difflineplus">+    if (NS_FAILED(rv)) msgWindow = nullptr;</span>
<a href="#l33.4170"></a><span id="l33.4170" class="difflineplus">+</span>
<a href="#l33.4171"></a><span id="l33.4171" class="difflineplus">+    rv = nntpService-&gt;PostMessage(mTempFile, mCompFields-&gt;GetNewsgroups(),</span>
<a href="#l33.4172"></a><span id="l33.4172" class="difflineplus">+                                  mAccountKey.get(), deliveryListener,</span>
<a href="#l33.4173"></a><span id="l33.4173" class="difflineplus">+                                  msgWindow, nullptr);</span>
<a href="#l33.4174"></a><span id="l33.4174">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l33.4175"></a><span id="l33.4175">   }</span>
<a href="#l33.4176"></a><span id="l33.4176"> </span>
<a href="#l33.4177"></a><span id="l33.4177">   return rv;</span>
<a href="#l33.4178"></a><span id="l33.4178"> }</span>
<a href="#l33.4179"></a><span id="l33.4179"> </span>
<a href="#l33.4180"></a><span id="l33.4180"> NS_IMETHODIMP</span>
<a href="#l33.4181"></a><span id="l33.4181"> nsMsgComposeAndSend::Fail(nsresult aFailureCode, const char16_t *aErrorMsg,</span>
<a href="#l33.4182"></a><span id="l33.4182" class="difflineminus">-                          nsresult *aResult)</span>
<a href="#l33.4183"></a><span id="l33.4183" class="difflineminus">-{</span>
<a href="#l33.4184"></a><span id="l33.4184" class="difflineplus">+                          nsresult *aResult) {</span>
<a href="#l33.4185"></a><span id="l33.4185">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l33.4186"></a><span id="l33.4186">   *aResult = aFailureCode;</span>
<a href="#l33.4187"></a><span id="l33.4187"> </span>
<a href="#l33.4188"></a><span id="l33.4188" class="difflineminus">-  if (NS_FAILED(aFailureCode))</span>
<a href="#l33.4189"></a><span id="l33.4189" class="difflineminus">-  {</span>
<a href="#l33.4190"></a><span id="l33.4190" class="difflineplus">+  if (NS_FAILED(aFailureCode)) {</span>
<a href="#l33.4191"></a><span id="l33.4191">     nsCOMPtr&lt;nsIPrompt&gt; prompt;</span>
<a href="#l33.4192"></a><span id="l33.4192">     nsresult rv = GetDefaultPrompt(getter_AddRefs(prompt));</span>
<a href="#l33.4193"></a><span id="l33.4193">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l33.4194"></a><span id="l33.4194"> </span>
<a href="#l33.4195"></a><span id="l33.4195" class="difflineminus">-    if (mSendReport)</span>
<a href="#l33.4196"></a><span id="l33.4196" class="difflineminus">-    {</span>
<a href="#l33.4197"></a><span id="l33.4197" class="difflineplus">+    if (mSendReport) {</span>
<a href="#l33.4198"></a><span id="l33.4198">       int32_t process;</span>
<a href="#l33.4199"></a><span id="l33.4199" class="difflineminus">-      if (NS_SUCCEEDED(mSendReport-&gt;GetCurrentProcess(&amp;process)) &amp;&amp; process == nsIMsgSendReport::process_Current)</span>
<a href="#l33.4200"></a><span id="l33.4200" class="difflineminus">-      {</span>
<a href="#l33.4201"></a><span id="l33.4201" class="difflineplus">+      if (NS_SUCCEEDED(mSendReport-&gt;GetCurrentProcess(&amp;process)) &amp;&amp;</span>
<a href="#l33.4202"></a><span id="l33.4202" class="difflineplus">+          process == nsIMsgSendReport::process_Current) {</span>
<a href="#l33.4203"></a><span id="l33.4203">         // currentProcess isn't set yet, so we need another value.</span>
<a href="#l33.4204"></a><span id="l33.4204">         mSendReport-&gt;SetCurrentProcess(nsIMsgSendReport::process_BuildMessage);</span>
<a href="#l33.4205"></a><span id="l33.4205">       }</span>
<a href="#l33.4206"></a><span id="l33.4206" class="difflineminus">-      mSendReport-&gt;SetError(nsIMsgSendReport::process_Current, aFailureCode, false);</span>
<a href="#l33.4207"></a><span id="l33.4207" class="difflineminus">-      mSendReport-&gt;SetMessage(nsIMsgSendReport::process_Current, aErrorMsg, false);</span>
<a href="#l33.4208"></a><span id="l33.4208" class="difflineplus">+      mSendReport-&gt;SetError(nsIMsgSendReport::process_Current, aFailureCode,</span>
<a href="#l33.4209"></a><span id="l33.4209" class="difflineplus">+                            false);</span>
<a href="#l33.4210"></a><span id="l33.4210" class="difflineplus">+      mSendReport-&gt;SetMessage(nsIMsgSendReport::process_Current, aErrorMsg,</span>
<a href="#l33.4211"></a><span id="l33.4211" class="difflineplus">+                              false);</span>
<a href="#l33.4212"></a><span id="l33.4212">       mSendReport-&gt;DisplayReport(prompt, true, true, aResult);</span>
<a href="#l33.4213"></a><span id="l33.4213" class="difflineminus">-    }</span>
<a href="#l33.4214"></a><span id="l33.4214" class="difflineminus">-    else</span>
<a href="#l33.4215"></a><span id="l33.4215" class="difflineminus">-    {</span>
<a href="#l33.4216"></a><span id="l33.4216" class="difflineplus">+    } else {</span>
<a href="#l33.4217"></a><span id="l33.4217">       if (aFailureCode != NS_ERROR_BUT_DONT_SHOW_ALERT)</span>
<a href="#l33.4218"></a><span id="l33.4218">         nsMsgDisplayMessageByName(prompt, &quot;sendFailed&quot;);</span>
<a href="#l33.4219"></a><span id="l33.4219">     }</span>
<a href="#l33.4220"></a><span id="l33.4220">   }</span>
<a href="#l33.4221"></a><span id="l33.4221"> </span>
<a href="#l33.4222"></a><span id="l33.4222" class="difflineminus">-  if (NS_SUCCEEDED(m_status))</span>
<a href="#l33.4223"></a><span id="l33.4223" class="difflineminus">-    m_status = NS_ERROR_BUT_DONT_SHOW_ALERT;</span>
<a href="#l33.4224"></a><span id="l33.4224" class="difflineminus">-</span>
<a href="#l33.4225"></a><span id="l33.4225" class="difflineminus">-  //Stop any pending process...</span>
<a href="#l33.4226"></a><span id="l33.4226" class="difflineplus">+  if (NS_SUCCEEDED(m_status)) m_status = NS_ERROR_BUT_DONT_SHOW_ALERT;</span>
<a href="#l33.4227"></a><span id="l33.4227" class="difflineplus">+</span>
<a href="#l33.4228"></a><span id="l33.4228" class="difflineplus">+  // Stop any pending process...</span>
<a href="#l33.4229"></a><span id="l33.4229">   Abort();</span>
<a href="#l33.4230"></a><span id="l33.4230"> </span>
<a href="#l33.4231"></a><span id="l33.4231">   return NS_OK;</span>
<a href="#l33.4232"></a><span id="l33.4232"> }</span>
<a href="#l33.4233"></a><span id="l33.4233"> </span>
<a href="#l33.4234"></a><span id="l33.4234" class="difflineminus">-nsresult</span>
<a href="#l33.4235"></a><span id="l33.4235" class="difflineminus">-nsMsgComposeAndSend::FormatStringWithSMTPHostNameByName(const char* aMsgName, nsAString&amp; aString)</span>
<a href="#l33.4236"></a><span id="l33.4236" class="difflineminus">-{</span>
<a href="#l33.4237"></a><span id="l33.4237" class="difflineplus">+nsresult nsMsgComposeAndSend::FormatStringWithSMTPHostNameByName(</span>
<a href="#l33.4238"></a><span id="l33.4238" class="difflineplus">+    const char *aMsgName, nsAString &amp;aString) {</span>
<a href="#l33.4239"></a><span id="l33.4239">   nsresult rv;</span>
<a href="#l33.4240"></a><span id="l33.4240" class="difflineminus">-  nsCOMPtr&lt;nsISmtpService&gt; smtpService(do_GetService(NS_SMTPSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l33.4241"></a><span id="l33.4241" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l33.4242"></a><span id="l33.4242" class="difflineplus">+  nsCOMPtr&lt;nsISmtpService&gt; smtpService(</span>
<a href="#l33.4243"></a><span id="l33.4243" class="difflineplus">+      do_GetService(NS_SMTPSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l33.4244"></a><span id="l33.4244" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l33.4245"></a><span id="l33.4245"> </span>
<a href="#l33.4246"></a><span id="l33.4246">   // Get the smtp hostname and format the string.</span>
<a href="#l33.4247"></a><span id="l33.4247">   nsCString smtpHostName;</span>
<a href="#l33.4248"></a><span id="l33.4248">   nsCOMPtr&lt;nsISmtpServer&gt; smtpServer;</span>
<a href="#l33.4249"></a><span id="l33.4249" class="difflineminus">-  rv = smtpService-&gt;GetServerByIdentity(mUserIdentity, getter_AddRefs(smtpServer));</span>
<a href="#l33.4250"></a><span id="l33.4250" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l33.4251"></a><span id="l33.4251" class="difflineminus">-    smtpServer-&gt;GetHostname(smtpHostName);</span>
<a href="#l33.4252"></a><span id="l33.4252" class="difflineplus">+  rv = smtpService-&gt;GetServerByIdentity(mUserIdentity,</span>
<a href="#l33.4253"></a><span id="l33.4253" class="difflineplus">+                                        getter_AddRefs(smtpServer));</span>
<a href="#l33.4254"></a><span id="l33.4254" class="difflineplus">+  if (NS_SUCCEEDED(rv)) smtpServer-&gt;GetHostname(smtpHostName);</span>
<a href="#l33.4255"></a><span id="l33.4255"> </span>
<a href="#l33.4256"></a><span id="l33.4256">   nsAutoString hostStr;</span>
<a href="#l33.4257"></a><span id="l33.4257">   CopyASCIItoUTF16(smtpHostName, hostStr);</span>
<a href="#l33.4258"></a><span id="l33.4258" class="difflineminus">-  const char16_t *params[] = { hostStr.get() };</span>
<a href="#l33.4259"></a><span id="l33.4259" class="difflineplus">+  const char16_t *params[] = {hostStr.get()};</span>
<a href="#l33.4260"></a><span id="l33.4260">   if (NS_SUCCEEDED(rv))</span>
<a href="#l33.4261"></a><span id="l33.4261">     mComposeBundle-&gt;FormatStringFromName(aMsgName, params, 1, aString);</span>
<a href="#l33.4262"></a><span id="l33.4262">   return rv;</span>
<a href="#l33.4263"></a><span id="l33.4263"> }</span>
<a href="#l33.4264"></a><span id="l33.4264"> </span>
<a href="#l33.4265"></a><span id="l33.4265" class="difflineminus">-void</span>
<a href="#l33.4266"></a><span id="l33.4266" class="difflineminus">-nsMsgComposeAndSend::DoDeliveryExitProcessing(nsIURI * aUri, nsresult aExitCode, bool aCheckForMail)</span>
<a href="#l33.4267"></a><span id="l33.4267" class="difflineminus">-{</span>
<a href="#l33.4268"></a><span id="l33.4268" class="difflineplus">+void nsMsgComposeAndSend::DoDeliveryExitProcessing(nsIURI *aUri,</span>
<a href="#l33.4269"></a><span id="l33.4269" class="difflineplus">+                                                   nsresult aExitCode,</span>
<a href="#l33.4270"></a><span id="l33.4270" class="difflineplus">+                                                   bool aCheckForMail) {</span>
<a href="#l33.4271"></a><span id="l33.4271">   // If we fail on the news delivery, no sense in going on so just notify</span>
<a href="#l33.4272"></a><span id="l33.4272">   // the user and exit.</span>
<a href="#l33.4273"></a><span id="l33.4273" class="difflineminus">-  if (NS_FAILED(aExitCode))</span>
<a href="#l33.4274"></a><span id="l33.4274" class="difflineminus">-  {</span>
<a href="#l33.4275"></a><span id="l33.4275" class="difflineminus">-    const char* exitString = errorStringNameForErrorCode(aExitCode);</span>
<a href="#l33.4276"></a><span id="l33.4276" class="difflineplus">+  if (NS_FAILED(aExitCode)) {</span>
<a href="#l33.4277"></a><span id="l33.4277" class="difflineplus">+    const char *exitString = errorStringNameForErrorCode(aExitCode);</span>
<a href="#l33.4278"></a><span id="l33.4278">     nsString eMsg;</span>
<a href="#l33.4279"></a><span id="l33.4279">     if (aExitCode == NS_ERROR_SMTP_SEND_FAILED_UNKNOWN_SERVER ||</span>
<a href="#l33.4280"></a><span id="l33.4280">         aExitCode == NS_ERROR_SMTP_SEND_FAILED_REFUSED ||</span>
<a href="#l33.4281"></a><span id="l33.4281">         aExitCode == NS_ERROR_SMTP_SEND_FAILED_INTERRUPTED ||</span>
<a href="#l33.4282"></a><span id="l33.4282">         aExitCode == NS_ERROR_SMTP_SEND_FAILED_TIMEOUT ||</span>
<a href="#l33.4283"></a><span id="l33.4283">         aExitCode == NS_ERROR_SMTP_PASSWORD_UNDEFINED ||</span>
<a href="#l33.4284"></a><span id="l33.4284">         aExitCode == NS_ERROR_SMTP_AUTH_FAILURE ||</span>
<a href="#l33.4285"></a><span id="l33.4285">         aExitCode == NS_ERROR_SMTP_AUTH_GSSAPI ||</span>
<a href="#l33.4286"></a><span id="l33.4286">         aExitCode == NS_ERROR_SMTP_AUTH_MECH_NOT_SUPPORTED ||</span>
<a href="#l33.4287"></a><span id="l33.4287">         aExitCode == NS_ERROR_SMTP_AUTH_CHANGE_ENCRYPT_TO_PLAIN_NO_SSL ||</span>
<a href="#l33.4288"></a><span id="l33.4288">         aExitCode == NS_ERROR_SMTP_AUTH_CHANGE_ENCRYPT_TO_PLAIN_SSL ||</span>
<a href="#l33.4289"></a><span id="l33.4289">         aExitCode == NS_ERROR_SMTP_AUTH_CHANGE_PLAIN_TO_ENCRYPT ||</span>
<a href="#l33.4290"></a><span id="l33.4290" class="difflineminus">-        aExitCode == NS_ERROR_STARTTLS_FAILED_EHLO_STARTTLS)</span>
<a href="#l33.4291"></a><span id="l33.4291" class="difflineminus">-    {</span>
<a href="#l33.4292"></a><span id="l33.4292" class="difflineplus">+        aExitCode == NS_ERROR_STARTTLS_FAILED_EHLO_STARTTLS) {</span>
<a href="#l33.4293"></a><span id="l33.4293">       // Print basic SMTP error with the server name encoded.</span>
<a href="#l33.4294"></a><span id="l33.4294">       FormatStringWithSMTPHostNameByName(exitString, eMsg);</span>
<a href="#l33.4295"></a><span id="l33.4295" class="difflineminus">-    }</span>
<a href="#l33.4296"></a><span id="l33.4296" class="difflineminus">-    else</span>
<a href="#l33.4297"></a><span id="l33.4297" class="difflineminus">-    {</span>
<a href="#l33.4298"></a><span id="l33.4298" class="difflineminus">-      nsCOMPtr&lt;nsINSSErrorsService&gt; nsserr = do_GetService(NS_NSS_ERRORS_SERVICE_CONTRACTID);</span>
<a href="#l33.4299"></a><span id="l33.4299" class="difflineminus">-      if (nsserr &amp;&amp;  NS_SUCCEEDED(nsserr-&gt;GetErrorMessage(aExitCode, eMsg)))</span>
<a href="#l33.4300"></a><span id="l33.4300" class="difflineminus">-      {</span>
<a href="#l33.4301"></a><span id="l33.4301" class="difflineminus">-        // This is a server security issue as determined by the Mozilla platform.</span>
<a href="#l33.4302"></a><span id="l33.4302" class="difflineminus">-        // To the Mozilla security message string, appended a string having</span>
<a href="#l33.4303"></a><span id="l33.4303" class="difflineminus">-        // additional information with the server name encoded.</span>
<a href="#l33.4304"></a><span id="l33.4304" class="difflineplus">+    } else {</span>
<a href="#l33.4305"></a><span id="l33.4305" class="difflineplus">+      nsCOMPtr&lt;nsINSSErrorsService&gt; nsserr =</span>
<a href="#l33.4306"></a><span id="l33.4306" class="difflineplus">+          do_GetService(NS_NSS_ERRORS_SERVICE_CONTRACTID);</span>
<a href="#l33.4307"></a><span id="l33.4307" class="difflineplus">+      if (nsserr &amp;&amp; NS_SUCCEEDED(nsserr-&gt;GetErrorMessage(aExitCode, eMsg))) {</span>
<a href="#l33.4308"></a><span id="l33.4308" class="difflineplus">+        // This is a server security issue as determined by the Mozilla</span>
<a href="#l33.4309"></a><span id="l33.4309" class="difflineplus">+        // platform. To the Mozilla security message string, appended a string</span>
<a href="#l33.4310"></a><span id="l33.4310" class="difflineplus">+        // having additional information with the server name encoded.</span>
<a href="#l33.4311"></a><span id="l33.4311">         nsString securityMsg;</span>
<a href="#l33.4312"></a><span id="l33.4312">         FormatStringWithSMTPHostNameByName(&quot;smtpSecurityIssue&quot;, securityMsg);</span>
<a href="#l33.4313"></a><span id="l33.4313">         eMsg.Append('\n');</span>
<a href="#l33.4314"></a><span id="l33.4314">         eMsg.Append(securityMsg);</span>
<a href="#l33.4315"></a><span id="l33.4315" class="difflineminus">-      }</span>
<a href="#l33.4316"></a><span id="l33.4316" class="difflineminus">-      else if (PL_strcmp(exitString, &quot;sendFailed&quot;))</span>
<a href="#l33.4317"></a><span id="l33.4317" class="difflineminus">-      {</span>
<a href="#l33.4318"></a><span id="l33.4318" class="difflineplus">+      } else if (PL_strcmp(exitString, &quot;sendFailed&quot;)) {</span>
<a href="#l33.4319"></a><span id="l33.4319">         // Not the default string. A mailnews error occurred that does not</span>
<a href="#l33.4320"></a><span id="l33.4320">         // require the server name to be encoded. Just print the descriptive</span>
<a href="#l33.4321"></a><span id="l33.4321">         // string.</span>
<a href="#l33.4322"></a><span id="l33.4322">         mComposeBundle-&gt;GetStringFromName(exitString, eMsg);</span>
<a href="#l33.4323"></a><span id="l33.4323" class="difflineminus">-      }</span>
<a href="#l33.4324"></a><span id="l33.4324" class="difflineminus">-      else</span>
<a href="#l33.4325"></a><span id="l33.4325" class="difflineminus">-      {</span>
<a href="#l33.4326"></a><span id="l33.4326" class="difflineplus">+      } else {</span>
<a href="#l33.4327"></a><span id="l33.4327">         // Encode the error code in first string. Then append a supplemental</span>
<a href="#l33.4328"></a><span id="l33.4328">         // string that encodes the server name.</span>
<a href="#l33.4329"></a><span id="l33.4329">         nsString tmpStr;</span>
<a href="#l33.4330"></a><span id="l33.4330">         mComposeBundle-&gt;GetStringFromName(&quot;sendFailedUnexpected&quot;, tmpStr);</span>
<a href="#l33.4331"></a><span id="l33.4331" class="difflineminus">-        nsTextFormatter::ssprintf(eMsg, tmpStr.get(), static_cast&lt;uint32_t&gt;(aExitCode));</span>
<a href="#l33.4332"></a><span id="l33.4332" class="difflineminus">-        FormatStringWithSMTPHostNameByName(&quot;smtpSendFailedUnknownReason&quot;, tmpStr);</span>
<a href="#l33.4333"></a><span id="l33.4333" class="difflineplus">+        nsTextFormatter::ssprintf(eMsg, tmpStr.get(),</span>
<a href="#l33.4334"></a><span id="l33.4334" class="difflineplus">+                                  static_cast&lt;uint32_t&gt;(aExitCode));</span>
<a href="#l33.4335"></a><span id="l33.4335" class="difflineplus">+        FormatStringWithSMTPHostNameByName(&quot;smtpSendFailedUnknownReason&quot;,</span>
<a href="#l33.4336"></a><span id="l33.4336" class="difflineplus">+                                           tmpStr);</span>
<a href="#l33.4337"></a><span id="l33.4337">         eMsg.Append('\n');</span>
<a href="#l33.4338"></a><span id="l33.4338">         eMsg.Append(tmpStr);</span>
<a href="#l33.4339"></a><span id="l33.4339">       }</span>
<a href="#l33.4340"></a><span id="l33.4340">     }</span>
<a href="#l33.4341"></a><span id="l33.4341">     Fail(aExitCode, eMsg.get(), &amp;aExitCode);</span>
<a href="#l33.4342"></a><span id="l33.4342">     NotifyListenerOnStopSending(nullptr, aExitCode, nullptr, nullptr);</span>
<a href="#l33.4343"></a><span id="l33.4343">     return;</span>
<a href="#l33.4344"></a><span id="l33.4344">   }</span>
<a href="#l33.4345"></a><span id="l33.4345"> </span>
<a href="#l33.4346"></a><span id="l33.4346" class="difflineminus">-  if (aCheckForMail)</span>
<a href="#l33.4347"></a><span id="l33.4347" class="difflineminus">-  {</span>
<a href="#l33.4348"></a><span id="l33.4348" class="difflineplus">+  if (aCheckForMail) {</span>
<a href="#l33.4349"></a><span id="l33.4349">     if ((mCompFields-&gt;GetTo() &amp;&amp; *mCompFields-&gt;GetTo()) ||</span>
<a href="#l33.4350"></a><span id="l33.4350">         (mCompFields-&gt;GetCc() &amp;&amp; *mCompFields-&gt;GetCc()) ||</span>
<a href="#l33.4351"></a><span id="l33.4351" class="difflineminus">-        (mCompFields-&gt;GetBcc() &amp;&amp; *mCompFields-&gt;GetBcc()))</span>
<a href="#l33.4352"></a><span id="l33.4352" class="difflineminus">-    {</span>
<a href="#l33.4353"></a><span id="l33.4353" class="difflineplus">+        (mCompFields-&gt;GetBcc() &amp;&amp; *mCompFields-&gt;GetBcc())) {</span>
<a href="#l33.4354"></a><span id="l33.4354">       // If we're sending this news message to mail as well, start it now.</span>
<a href="#l33.4355"></a><span id="l33.4355">       // Completion and further errors will be handled there.</span>
<a href="#l33.4356"></a><span id="l33.4356">       DeliverFileAsMail();</span>
<a href="#l33.4357"></a><span id="l33.4357">       return;</span>
<a href="#l33.4358"></a><span id="l33.4358">     }</span>
<a href="#l33.4359"></a><span id="l33.4359">   }</span>
<a href="#l33.4360"></a><span id="l33.4360"> </span>
<a href="#l33.4361"></a><span id="l33.4361">   //</span>
<a href="#l33.4362"></a><span id="l33.4362">   // Tell the listeners that we are done with the sending operation...</span>
<a href="#l33.4363"></a><span id="l33.4363">   //</span>
<a href="#l33.4364"></a><span id="l33.4364" class="difflineminus">-  NotifyListenerOnStopSending(mCompFields-&gt;GetMessageId(),</span>
<a href="#l33.4365"></a><span id="l33.4365" class="difflineminus">-                              aExitCode,</span>
<a href="#l33.4366"></a><span id="l33.4366" class="difflineminus">-                              nullptr,</span>
<a href="#l33.4367"></a><span id="l33.4367" class="difflineplus">+  NotifyListenerOnStopSending(mCompFields-&gt;GetMessageId(), aExitCode, nullptr,</span>
<a href="#l33.4368"></a><span id="l33.4368">                               nullptr);</span>
<a href="#l33.4369"></a><span id="l33.4369"> </span>
<a href="#l33.4370"></a><span id="l33.4370">   // If we hit here, we are done with delivery!</span>
<a href="#l33.4371"></a><span id="l33.4371">   //</span>
<a href="#l33.4372"></a><span id="l33.4372">   // Just call the DoFCC() method and if that fails, then we should just</span>
<a href="#l33.4373"></a><span id="l33.4373">   // cleanup and get out. If DoFCC &quot;succeeds&quot;, then all that means is the</span>
<a href="#l33.4374"></a><span id="l33.4374">   // async copy operation has been started and we will be notified later</span>
<a href="#l33.4375"></a><span id="l33.4375">   // when it is done. DON'T cleanup until the copy is complete and don't</span>
<a href="#l33.4376"></a><span id="l33.4376" class="difflineat">@@ -3563,483 +3236,425 @@ nsMsgComposeAndSend::DoDeliveryExitProce</span>
<a href="#l33.4377"></a><span id="l33.4377">   // For now, we don't need to do anything here, but the code will stay this</span>
<a href="#l33.4378"></a><span id="l33.4378">   // way until later...</span>
<a href="#l33.4379"></a><span id="l33.4379">   //</span>
<a href="#l33.4380"></a><span id="l33.4380"> </span>
<a href="#l33.4381"></a><span id="l33.4381">   DoFcc();</span>
<a href="#l33.4382"></a><span id="l33.4382"> }</span>
<a href="#l33.4383"></a><span id="l33.4383"> </span>
<a href="#l33.4384"></a><span id="l33.4384"> NS_IMETHODIMP</span>
<a href="#l33.4385"></a><span id="l33.4385" class="difflineminus">-nsMsgComposeAndSend::DeliverAsMailExit(nsIURI *aUrl, nsresult aExitCode)</span>
<a href="#l33.4386"></a><span id="l33.4386" class="difflineminus">-{</span>
<a href="#l33.4387"></a><span id="l33.4387" class="difflineplus">+nsMsgComposeAndSend::DeliverAsMailExit(nsIURI *aUrl, nsresult aExitCode) {</span>
<a href="#l33.4388"></a><span id="l33.4388">   DoDeliveryExitProcessing(aUrl, aExitCode, false);</span>
<a href="#l33.4389"></a><span id="l33.4389">   return NS_OK;</span>
<a href="#l33.4390"></a><span id="l33.4390"> }</span>
<a href="#l33.4391"></a><span id="l33.4391"> </span>
<a href="#l33.4392"></a><span id="l33.4392"> NS_IMETHODIMP</span>
<a href="#l33.4393"></a><span id="l33.4393" class="difflineminus">-nsMsgComposeAndSend::DeliverAsNewsExit(nsIURI *aUrl, nsresult aExitCode)</span>
<a href="#l33.4394"></a><span id="l33.4394" class="difflineminus">-{</span>
<a href="#l33.4395"></a><span id="l33.4395" class="difflineplus">+nsMsgComposeAndSend::DeliverAsNewsExit(nsIURI *aUrl, nsresult aExitCode) {</span>
<a href="#l33.4396"></a><span id="l33.4396">   DoDeliveryExitProcessing(aUrl, aExitCode, mSendMailAlso);</span>
<a href="#l33.4397"></a><span id="l33.4397">   return NS_OK;</span>
<a href="#l33.4398"></a><span id="l33.4398"> }</span>
<a href="#l33.4399"></a><span id="l33.4399"> </span>
<a href="#l33.4400"></a><span id="l33.4400" class="difflineminus">-nsresult</span>
<a href="#l33.4401"></a><span id="l33.4401" class="difflineminus">-nsMsgComposeAndSend::GetIncomingServer(const char *folderURL, nsIMsgIncomingServer **aServer)</span>
<a href="#l33.4402"></a><span id="l33.4402" class="difflineminus">-{</span>
<a href="#l33.4403"></a><span id="l33.4403" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; thisFolder;</span>
<a href="#l33.4404"></a><span id="l33.4404" class="difflineplus">+nsresult nsMsgComposeAndSend::GetIncomingServer(</span>
<a href="#l33.4405"></a><span id="l33.4405" class="difflineplus">+    const char *folderURL, nsIMsgIncomingServer **aServer) {</span>
<a href="#l33.4406"></a><span id="l33.4406" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; thisFolder;</span>
<a href="#l33.4407"></a><span id="l33.4407"> </span>
<a href="#l33.4408"></a><span id="l33.4408">   nsresult rv = GetOrCreateFolder(nsDependentCString(folderURL),</span>
<a href="#l33.4409"></a><span id="l33.4409" class="difflineminus">-    getter_AddRefs(thisFolder));</span>
<a href="#l33.4410"></a><span id="l33.4410" class="difflineplus">+                                  getter_AddRefs(thisFolder));</span>
<a href="#l33.4411"></a><span id="l33.4411">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l33.4412"></a><span id="l33.4412"> </span>
<a href="#l33.4413"></a><span id="l33.4413">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l33.4414"></a><span id="l33.4414">   rv = thisFolder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l33.4415"></a><span id="l33.4415" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l33.4416"></a><span id="l33.4416" class="difflineminus">-    return rv;</span>
<a href="#l33.4417"></a><span id="l33.4417" class="difflineminus">-  if (!server)</span>
<a href="#l33.4418"></a><span id="l33.4418" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l33.4419"></a><span id="l33.4419" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l33.4420"></a><span id="l33.4420" class="difflineplus">+  if (!server) return NS_ERROR_NULL_POINTER;</span>
<a href="#l33.4421"></a><span id="l33.4421"> </span>
<a href="#l33.4422"></a><span id="l33.4422">   server.forget(aServer);</span>
<a href="#l33.4423"></a><span id="l33.4423">   return NS_OK;</span>
<a href="#l33.4424"></a><span id="l33.4424"> }</span>
<a href="#l33.4425"></a><span id="l33.4425"> </span>
<a href="#l33.4426"></a><span id="l33.4426" class="difflineminus">-bool</span>
<a href="#l33.4427"></a><span id="l33.4427" class="difflineminus">-nsMsgComposeAndSend::CanSaveMessagesToFolder(const char *folderURL)</span>
<a href="#l33.4428"></a><span id="l33.4428" class="difflineminus">-{</span>
<a href="#l33.4429"></a><span id="l33.4429" class="difflineplus">+bool nsMsgComposeAndSend::CanSaveMessagesToFolder(const char *folderURL) {</span>
<a href="#l33.4430"></a><span id="l33.4430">   bool canSave = false;</span>
<a href="#l33.4431"></a><span id="l33.4431">   // Get pointer to server.</span>
<a href="#l33.4432"></a><span id="l33.4432">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l33.4433"></a><span id="l33.4433">   nsresult rv = GetIncomingServer(folderURL, getter_AddRefs(server));</span>
<a href="#l33.4434"></a><span id="l33.4434" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l33.4435"></a><span id="l33.4435" class="difflineminus">-    return false;</span>
<a href="#l33.4436"></a><span id="l33.4436" class="difflineplus">+  if (NS_FAILED(rv)) return false;</span>
<a href="#l33.4437"></a><span id="l33.4437"> </span>
<a href="#l33.4438"></a><span id="l33.4438">   // See if we are allowed to save/file msgs to this folder.</span>
<a href="#l33.4439"></a><span id="l33.4439" class="difflineminus">-  if (server)</span>
<a href="#l33.4440"></a><span id="l33.4440" class="difflineminus">-  {</span>
<a href="#l33.4441"></a><span id="l33.4441" class="difflineplus">+  if (server) {</span>
<a href="#l33.4442"></a><span id="l33.4442">     rv = server-&gt;GetCanFileMessagesOnServer(&amp;canSave);</span>
<a href="#l33.4443"></a><span id="l33.4443" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l33.4444"></a><span id="l33.4444" class="difflineminus">-      canSave = false;</span>
<a href="#l33.4445"></a><span id="l33.4445" class="difflineplus">+    if (NS_FAILED(rv)) canSave = false;</span>
<a href="#l33.4446"></a><span id="l33.4446">   }</span>
<a href="#l33.4447"></a><span id="l33.4447">   return canSave;</span>
<a href="#l33.4448"></a><span id="l33.4448"> }</span>
<a href="#l33.4449"></a><span id="l33.4449"> </span>
<a href="#l33.4450"></a><span id="l33.4450"> //</span>
<a href="#l33.4451"></a><span id="l33.4451"> // Now, start the appropriate copy operation.</span>
<a href="#l33.4452"></a><span id="l33.4452"> //</span>
<a href="#l33.4453"></a><span id="l33.4453" class="difflineminus">-nsresult</span>
<a href="#l33.4454"></a><span id="l33.4454" class="difflineminus">-nsMsgComposeAndSend::DoFcc()</span>
<a href="#l33.4455"></a><span id="l33.4455" class="difflineminus">-{</span>
<a href="#l33.4456"></a><span id="l33.4456" class="difflineplus">+nsresult nsMsgComposeAndSend::DoFcc() {</span>
<a href="#l33.4457"></a><span id="l33.4457">   //</span>
<a href="#l33.4458"></a><span id="l33.4458" class="difflineminus">-  // Just cleanup and return success if we're not allowed to save msgs to FCC folder.</span>
<a href="#l33.4459"></a><span id="l33.4459" class="difflineplus">+  // Just cleanup and return success if we're not allowed to save msgs to FCC</span>
<a href="#l33.4460"></a><span id="l33.4460" class="difflineplus">+  // folder.</span>
<a href="#l33.4461"></a><span id="l33.4461">   //</span>
<a href="#l33.4462"></a><span id="l33.4462" class="difflineminus">-  const char* fcc = mCompFields-&gt;GetFcc();</span>
<a href="#l33.4463"></a><span id="l33.4463" class="difflineminus">-  if (!fcc || !*fcc || !CanSaveMessagesToFolder(fcc))</span>
<a href="#l33.4464"></a><span id="l33.4464" class="difflineminus">-  {</span>
<a href="#l33.4465"></a><span id="l33.4465" class="difflineminus">-</span>
<a href="#l33.4466"></a><span id="l33.4466" class="difflineplus">+  const char *fcc = mCompFields-&gt;GetFcc();</span>
<a href="#l33.4467"></a><span id="l33.4467" class="difflineplus">+  if (!fcc || !*fcc || !CanSaveMessagesToFolder(fcc)) {</span>
<a href="#l33.4468"></a><span id="l33.4468">     // It is the caller's responsibility to say we've stopped sending, so just</span>
<a href="#l33.4469"></a><span id="l33.4469">     // let the listeners know we're not doing a copy.</span>
<a href="#l33.4470"></a><span id="l33.4470">     NotifyListenerOnStopCopy(NS_OK);  // For closure of compose window...</span>
<a href="#l33.4471"></a><span id="l33.4471">     return NS_OK;</span>
<a href="#l33.4472"></a><span id="l33.4472">   }</span>
<a href="#l33.4473"></a><span id="l33.4473"> </span>
<a href="#l33.4474"></a><span id="l33.4474">   if (mSendReport)</span>
<a href="#l33.4475"></a><span id="l33.4475">     mSendReport-&gt;SetCurrentProcess(nsIMsgSendReport::process_Copy);</span>
<a href="#l33.4476"></a><span id="l33.4476"> </span>
<a href="#l33.4477"></a><span id="l33.4477">   //</span>
<a href="#l33.4478"></a><span id="l33.4478">   // If we are here, then we need to save off the FCC file to save and</span>
<a href="#l33.4479"></a><span id="l33.4479">   // start the copy operation. MimeDoFCC() will take care of all of this</span>
<a href="#l33.4480"></a><span id="l33.4480">   // for us.</span>
<a href="#l33.4481"></a><span id="l33.4481">   //</span>
<a href="#l33.4482"></a><span id="l33.4482" class="difflineminus">-  nsresult rv = MimeDoFCC(mTempFile,</span>
<a href="#l33.4483"></a><span id="l33.4483" class="difflineminus">-                          nsMsgDeliverNow,</span>
<a href="#l33.4484"></a><span id="l33.4484" class="difflineminus">-                          mCompFields-&gt;GetBcc(),</span>
<a href="#l33.4485"></a><span id="l33.4485" class="difflineminus">-                          mCompFields-&gt;GetFcc(),</span>
<a href="#l33.4486"></a><span id="l33.4486" class="difflineminus">-                          mCompFields-&gt;GetNewspostUrl());</span>
<a href="#l33.4487"></a><span id="l33.4487" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l33.4488"></a><span id="l33.4488" class="difflineminus">-  {</span>
<a href="#l33.4489"></a><span id="l33.4489" class="difflineplus">+  nsresult rv = MimeDoFCC(mTempFile, nsMsgDeliverNow, mCompFields-&gt;GetBcc(),</span>
<a href="#l33.4490"></a><span id="l33.4490" class="difflineplus">+                          mCompFields-&gt;GetFcc(), mCompFields-&gt;GetNewspostUrl());</span>
<a href="#l33.4491"></a><span id="l33.4491" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l33.4492"></a><span id="l33.4492">     //</span>
<a href="#l33.4493"></a><span id="l33.4493">     // If we hit here, the copy operation FAILED and we should at least tell the</span>
<a href="#l33.4494"></a><span id="l33.4494">     // user that it did fail but the send operation has already succeeded.</span>
<a href="#l33.4495"></a><span id="l33.4495">     //</span>
<a href="#l33.4496"></a><span id="l33.4496">     NotifyListenerOnStopCopy(rv);</span>
<a href="#l33.4497"></a><span id="l33.4497">   }</span>
<a href="#l33.4498"></a><span id="l33.4498"> </span>
<a href="#l33.4499"></a><span id="l33.4499">   return rv;</span>
<a href="#l33.4500"></a><span id="l33.4500"> }</span>
<a href="#l33.4501"></a><span id="l33.4501"> </span>
<a href="#l33.4502"></a><span id="l33.4502"> NS_IMETHODIMP</span>
<a href="#l33.4503"></a><span id="l33.4503" class="difflineminus">-nsMsgComposeAndSend::NotifyListenerOnStartSending(const char *aMsgID, uint32_t aMsgSize)</span>
<a href="#l33.4504"></a><span id="l33.4504" class="difflineminus">-{</span>
<a href="#l33.4505"></a><span id="l33.4505" class="difflineminus">-  if (mListener)</span>
<a href="#l33.4506"></a><span id="l33.4506" class="difflineminus">-    mListener-&gt;OnStartSending(aMsgID, aMsgSize);</span>
<a href="#l33.4507"></a><span id="l33.4507" class="difflineplus">+nsMsgComposeAndSend::NotifyListenerOnStartSending(const char *aMsgID,</span>
<a href="#l33.4508"></a><span id="l33.4508" class="difflineplus">+                                                  uint32_t aMsgSize) {</span>
<a href="#l33.4509"></a><span id="l33.4509" class="difflineplus">+  if (mListener) mListener-&gt;OnStartSending(aMsgID, aMsgSize);</span>
<a href="#l33.4510"></a><span id="l33.4510"> </span>
<a href="#l33.4511"></a><span id="l33.4511">   return NS_OK;</span>
<a href="#l33.4512"></a><span id="l33.4512"> }</span>
<a href="#l33.4513"></a><span id="l33.4513"> </span>
<a href="#l33.4514"></a><span id="l33.4514"> NS_IMETHODIMP</span>
<a href="#l33.4515"></a><span id="l33.4515" class="difflineminus">-nsMsgComposeAndSend::NotifyListenerOnProgress(const char *aMsgID, uint32_t aProgress, uint32_t aProgressMax)</span>
<a href="#l33.4516"></a><span id="l33.4516" class="difflineminus">-{</span>
<a href="#l33.4517"></a><span id="l33.4517" class="difflineminus">-  if (mListener)</span>
<a href="#l33.4518"></a><span id="l33.4518" class="difflineminus">-    mListener-&gt;OnProgress(aMsgID, aProgress, aProgressMax);</span>
<a href="#l33.4519"></a><span id="l33.4519" class="difflineplus">+nsMsgComposeAndSend::NotifyListenerOnProgress(const char *aMsgID,</span>
<a href="#l33.4520"></a><span id="l33.4520" class="difflineplus">+                                              uint32_t aProgress,</span>
<a href="#l33.4521"></a><span id="l33.4521" class="difflineplus">+                                              uint32_t aProgressMax) {</span>
<a href="#l33.4522"></a><span id="l33.4522" class="difflineplus">+  if (mListener) mListener-&gt;OnProgress(aMsgID, aProgress, aProgressMax);</span>
<a href="#l33.4523"></a><span id="l33.4523"> </span>
<a href="#l33.4524"></a><span id="l33.4524">   return NS_OK;</span>
<a href="#l33.4525"></a><span id="l33.4525"> }</span>
<a href="#l33.4526"></a><span id="l33.4526"> </span>
<a href="#l33.4527"></a><span id="l33.4527"> NS_IMETHODIMP</span>
<a href="#l33.4528"></a><span id="l33.4528" class="difflineminus">-nsMsgComposeAndSend::NotifyListenerOnStatus(const char *aMsgID, const char16_t *aMsg)</span>
<a href="#l33.4529"></a><span id="l33.4529" class="difflineminus">-{</span>
<a href="#l33.4530"></a><span id="l33.4530" class="difflineminus">-  if (mListener)</span>
<a href="#l33.4531"></a><span id="l33.4531" class="difflineminus">-    mListener-&gt;OnStatus(aMsgID, aMsg);</span>
<a href="#l33.4532"></a><span id="l33.4532" class="difflineplus">+nsMsgComposeAndSend::NotifyListenerOnStatus(const char *aMsgID,</span>
<a href="#l33.4533"></a><span id="l33.4533" class="difflineplus">+                                            const char16_t *aMsg) {</span>
<a href="#l33.4534"></a><span id="l33.4534" class="difflineplus">+  if (mListener) mListener-&gt;OnStatus(aMsgID, aMsg);</span>
<a href="#l33.4535"></a><span id="l33.4535"> </span>
<a href="#l33.4536"></a><span id="l33.4536">   return NS_OK;</span>
<a href="#l33.4537"></a><span id="l33.4537"> }</span>
<a href="#l33.4538"></a><span id="l33.4538"> </span>
<a href="#l33.4539"></a><span id="l33.4539"> NS_IMETHODIMP</span>
<a href="#l33.4540"></a><span id="l33.4540" class="difflineminus">-nsMsgComposeAndSend::NotifyListenerOnStopSending(const char *aMsgID, nsresult aStatus, const char16_t *aMsg,</span>
<a href="#l33.4541"></a><span id="l33.4541" class="difflineminus">-                                                  nsIFile *returnFile)</span>
<a href="#l33.4542"></a><span id="l33.4542" class="difflineminus">-{</span>
<a href="#l33.4543"></a><span id="l33.4543" class="difflineplus">+nsMsgComposeAndSend::NotifyListenerOnStopSending(const char *aMsgID,</span>
<a href="#l33.4544"></a><span id="l33.4544" class="difflineplus">+                                                 nsresult aStatus,</span>
<a href="#l33.4545"></a><span id="l33.4545" class="difflineplus">+                                                 const char16_t *aMsg,</span>
<a href="#l33.4546"></a><span id="l33.4546" class="difflineplus">+                                                 nsIFile *returnFile) {</span>
<a href="#l33.4547"></a><span id="l33.4547">   if (mListener != nullptr)</span>
<a href="#l33.4548"></a><span id="l33.4548">     mListener-&gt;OnStopSending(aMsgID, aStatus, aMsg, returnFile);</span>
<a href="#l33.4549"></a><span id="l33.4549"> </span>
<a href="#l33.4550"></a><span id="l33.4550">   return NS_OK;</span>
<a href="#l33.4551"></a><span id="l33.4551"> }</span>
<a href="#l33.4552"></a><span id="l33.4552"> </span>
<a href="#l33.4553"></a><span id="l33.4553"> NS_IMETHODIMP</span>
<a href="#l33.4554"></a><span id="l33.4554" class="difflineminus">-nsMsgComposeAndSend::NotifyListenerOnStartCopy()</span>
<a href="#l33.4555"></a><span id="l33.4555" class="difflineminus">-{</span>
<a href="#l33.4556"></a><span id="l33.4556" class="difflineplus">+nsMsgComposeAndSend::NotifyListenerOnStartCopy() {</span>
<a href="#l33.4557"></a><span id="l33.4557">   nsCOMPtr&lt;nsIMsgCopyServiceListener&gt; copyListener;</span>
<a href="#l33.4558"></a><span id="l33.4558"> </span>
<a href="#l33.4559"></a><span id="l33.4559" class="difflineminus">-  if (mListener)</span>
<a href="#l33.4560"></a><span id="l33.4560" class="difflineminus">-  {</span>
<a href="#l33.4561"></a><span id="l33.4561" class="difflineplus">+  if (mListener) {</span>
<a href="#l33.4562"></a><span id="l33.4562">     copyListener = do_QueryInterface(mListener);</span>
<a href="#l33.4563"></a><span id="l33.4563" class="difflineminus">-    if (copyListener)</span>
<a href="#l33.4564"></a><span id="l33.4564" class="difflineminus">-      copyListener-&gt;OnStartCopy();</span>
<a href="#l33.4565"></a><span id="l33.4565" class="difflineplus">+    if (copyListener) copyListener-&gt;OnStartCopy();</span>
<a href="#l33.4566"></a><span id="l33.4566">   }</span>
<a href="#l33.4567"></a><span id="l33.4567"> </span>
<a href="#l33.4568"></a><span id="l33.4568">   return NS_OK;</span>
<a href="#l33.4569"></a><span id="l33.4569"> }</span>
<a href="#l33.4570"></a><span id="l33.4570"> </span>
<a href="#l33.4571"></a><span id="l33.4571"> NS_IMETHODIMP</span>
<a href="#l33.4572"></a><span id="l33.4572"> nsMsgComposeAndSend::NotifyListenerOnProgressCopy(uint32_t aProgress,</span>
<a href="#l33.4573"></a><span id="l33.4573" class="difflineminus">-                                                   uint32_t aProgressMax)</span>
<a href="#l33.4574"></a><span id="l33.4574" class="difflineminus">-{</span>
<a href="#l33.4575"></a><span id="l33.4575" class="difflineplus">+                                                  uint32_t aProgressMax) {</span>
<a href="#l33.4576"></a><span id="l33.4576">   nsCOMPtr&lt;nsIMsgCopyServiceListener&gt; copyListener;</span>
<a href="#l33.4577"></a><span id="l33.4577"> </span>
<a href="#l33.4578"></a><span id="l33.4578" class="difflineminus">-  if (mListener)</span>
<a href="#l33.4579"></a><span id="l33.4579" class="difflineminus">-  {</span>
<a href="#l33.4580"></a><span id="l33.4580" class="difflineplus">+  if (mListener) {</span>
<a href="#l33.4581"></a><span id="l33.4581">     copyListener = do_QueryInterface(mListener);</span>
<a href="#l33.4582"></a><span id="l33.4582" class="difflineminus">-    if (copyListener)</span>
<a href="#l33.4583"></a><span id="l33.4583" class="difflineminus">-      copyListener-&gt;OnProgress(aProgress, aProgressMax);</span>
<a href="#l33.4584"></a><span id="l33.4584" class="difflineplus">+    if (copyListener) copyListener-&gt;OnProgress(aProgress, aProgressMax);</span>
<a href="#l33.4585"></a><span id="l33.4585">   }</span>
<a href="#l33.4586"></a><span id="l33.4586"> </span>
<a href="#l33.4587"></a><span id="l33.4587">   return NS_OK;</span>
<a href="#l33.4588"></a><span id="l33.4588"> }</span>
<a href="#l33.4589"></a><span id="l33.4589"> </span>
<a href="#l33.4590"></a><span id="l33.4590"> NS_IMETHODIMP</span>
<a href="#l33.4591"></a><span id="l33.4591" class="difflineminus">-nsMsgComposeAndSend::SetMessageKey(nsMsgKey aMessageKey)</span>
<a href="#l33.4592"></a><span id="l33.4592" class="difflineminus">-{</span>
<a href="#l33.4593"></a><span id="l33.4593" class="difflineminus">-    m_messageKey = aMessageKey;</span>
<a href="#l33.4594"></a><span id="l33.4594" class="difflineminus">-    return NS_OK;</span>
<a href="#l33.4595"></a><span id="l33.4595" class="difflineplus">+nsMsgComposeAndSend::SetMessageKey(nsMsgKey aMessageKey) {</span>
<a href="#l33.4596"></a><span id="l33.4596" class="difflineplus">+  m_messageKey = aMessageKey;</span>
<a href="#l33.4597"></a><span id="l33.4597" class="difflineplus">+  return NS_OK;</span>
<a href="#l33.4598"></a><span id="l33.4598"> }</span>
<a href="#l33.4599"></a><span id="l33.4599"> </span>
<a href="#l33.4600"></a><span id="l33.4600"> NS_IMETHODIMP</span>
<a href="#l33.4601"></a><span id="l33.4601" class="difflineminus">-nsMsgComposeAndSend::GetMessageKey(nsMsgKey *aMessageKey)</span>
<a href="#l33.4602"></a><span id="l33.4602" class="difflineminus">-{</span>
<a href="#l33.4603"></a><span id="l33.4603" class="difflineminus">-    *aMessageKey = m_messageKey;</span>
<a href="#l33.4604"></a><span id="l33.4604" class="difflineminus">-    return NS_OK;</span>
<a href="#l33.4605"></a><span id="l33.4605" class="difflineplus">+nsMsgComposeAndSend::GetMessageKey(nsMsgKey *aMessageKey) {</span>
<a href="#l33.4606"></a><span id="l33.4606" class="difflineplus">+  *aMessageKey = m_messageKey;</span>
<a href="#l33.4607"></a><span id="l33.4607" class="difflineplus">+  return NS_OK;</span>
<a href="#l33.4608"></a><span id="l33.4608"> }</span>
<a href="#l33.4609"></a><span id="l33.4609"> </span>
<a href="#l33.4610"></a><span id="l33.4610"> NS_IMETHODIMP</span>
<a href="#l33.4611"></a><span id="l33.4611" class="difflineminus">-nsMsgComposeAndSend::GetFolderUri(nsACString &amp;aFolderUri)</span>
<a href="#l33.4612"></a><span id="l33.4612" class="difflineminus">-{</span>
<a href="#l33.4613"></a><span id="l33.4613" class="difflineplus">+nsMsgComposeAndSend::GetFolderUri(nsACString &amp;aFolderUri) {</span>
<a href="#l33.4614"></a><span id="l33.4614">   aFolderUri = m_folderName;</span>
<a href="#l33.4615"></a><span id="l33.4615">   return NS_OK;</span>
<a href="#l33.4616"></a><span id="l33.4616"> }</span>
<a href="#l33.4617"></a><span id="l33.4617"> </span>
<a href="#l33.4618"></a><span id="l33.4618"> NS_IMETHODIMP</span>
<a href="#l33.4619"></a><span id="l33.4619" class="difflineminus">-nsMsgComposeAndSend::GetPartForDomIndex(int32_t aDomIndex, nsACString &amp;aPartNum)</span>
<a href="#l33.4620"></a><span id="l33.4620" class="difflineminus">-{</span>
<a href="#l33.4621"></a><span id="l33.4621" class="difflineplus">+nsMsgComposeAndSend::GetPartForDomIndex(int32_t aDomIndex,</span>
<a href="#l33.4622"></a><span id="l33.4622" class="difflineplus">+                                        nsACString &amp;aPartNum) {</span>
<a href="#l33.4623"></a><span id="l33.4623">   aPartNum = m_partNumbers.SafeElementAt(aDomIndex, EmptyCString());</span>
<a href="#l33.4624"></a><span id="l33.4624">   return NS_OK;</span>
<a href="#l33.4625"></a><span id="l33.4625"> }</span>
<a href="#l33.4626"></a><span id="l33.4626"> </span>
<a href="#l33.4627"></a><span id="l33.4627"> NS_IMETHODIMP</span>
<a href="#l33.4628"></a><span id="l33.4628" class="difflineminus">-nsMsgComposeAndSend::GetMessageId(nsACString&amp; aMessageId)</span>
<a href="#l33.4629"></a><span id="l33.4629" class="difflineminus">-{</span>
<a href="#l33.4630"></a><span id="l33.4630" class="difflineplus">+nsMsgComposeAndSend::GetMessageId(nsACString &amp;aMessageId) {</span>
<a href="#l33.4631"></a><span id="l33.4631">   nsresult rv = NS_OK;</span>
<a href="#l33.4632"></a><span id="l33.4632">   if (mCompFields)</span>
<a href="#l33.4633"></a><span id="l33.4633">     aMessageId = mCompFields-&gt;GetMessageId();</span>
<a href="#l33.4634"></a><span id="l33.4634">   else</span>
<a href="#l33.4635"></a><span id="l33.4635">     rv = NS_ERROR_NULL_POINTER;</span>
<a href="#l33.4636"></a><span id="l33.4636">   return rv;</span>
<a href="#l33.4637"></a><span id="l33.4637"> }</span>
<a href="#l33.4638"></a><span id="l33.4638"> </span>
<a href="#l33.4639"></a><span id="l33.4639"> NS_IMETHODIMP</span>
<a href="#l33.4640"></a><span id="l33.4640" class="difflineminus">-nsMsgComposeAndSend::NotifyListenerOnStopCopy(nsresult aStatus)</span>
<a href="#l33.4641"></a><span id="l33.4641" class="difflineminus">-{</span>
<a href="#l33.4642"></a><span id="l33.4642" class="difflineplus">+nsMsgComposeAndSend::NotifyListenerOnStopCopy(nsresult aStatus) {</span>
<a href="#l33.4643"></a><span id="l33.4643">   nsresult rv;</span>
<a href="#l33.4644"></a><span id="l33.4644"> </span>
<a href="#l33.4645"></a><span id="l33.4645">   // This is one per copy so make sure we clean this up first.</span>
<a href="#l33.4646"></a><span id="l33.4646">   mCopyObj = nullptr;</span>
<a href="#l33.4647"></a><span id="l33.4647"> </span>
<a href="#l33.4648"></a><span id="l33.4648">   // Set a status message...</span>
<a href="#l33.4649"></a><span id="l33.4649">   nsString msg;</span>
<a href="#l33.4650"></a><span id="l33.4650">   if (NS_SUCCEEDED(aStatus))</span>
<a href="#l33.4651"></a><span id="l33.4651">     mComposeBundle-&gt;GetStringFromName(&quot;copyMessageComplete&quot;, msg);</span>
<a href="#l33.4652"></a><span id="l33.4652">   else</span>
<a href="#l33.4653"></a><span id="l33.4653">     mComposeBundle-&gt;GetStringFromName(&quot;copyMessageFailed&quot;, msg);</span>
<a href="#l33.4654"></a><span id="l33.4654"> </span>
<a href="#l33.4655"></a><span id="l33.4655">   SetStatusMessage(msg);</span>
<a href="#l33.4656"></a><span id="l33.4656"> </span>
<a href="#l33.4657"></a><span id="l33.4657" class="difflineminus">-  if (NS_FAILED(aStatus))</span>
<a href="#l33.4658"></a><span id="l33.4658" class="difflineminus">-  {</span>
<a href="#l33.4659"></a><span id="l33.4659" class="difflineplus">+  if (NS_FAILED(aStatus)) {</span>
<a href="#l33.4660"></a><span id="l33.4660">     nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l33.4661"></a><span id="l33.4661" class="difflineminus">-      mozilla::services::GetStringBundleService();</span>
<a href="#l33.4662"></a><span id="l33.4662" class="difflineplus">+        mozilla::services::GetStringBundleService();</span>
<a href="#l33.4663"></a><span id="l33.4663">     NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l33.4664"></a><span id="l33.4664">     nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l33.4665"></a><span id="l33.4665" class="difflineminus">-    rv = bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/messengercompose/composeMsgs.properties&quot;, getter_AddRefs(bundle));</span>
<a href="#l33.4666"></a><span id="l33.4666" class="difflineplus">+    rv = bundleService-&gt;CreateBundle(</span>
<a href="#l33.4667"></a><span id="l33.4667" class="difflineplus">+        &quot;chrome://messenger/locale/messengercompose/composeMsgs.properties&quot;,</span>
<a href="#l33.4668"></a><span id="l33.4668" class="difflineplus">+        getter_AddRefs(bundle));</span>
<a href="#l33.4669"></a><span id="l33.4669">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l33.4670"></a><span id="l33.4670"> </span>
<a href="#l33.4671"></a><span id="l33.4671">     // Obtain account name for local folders.</span>
<a href="#l33.4672"></a><span id="l33.4672">     nsString localFoldersAccountName;</span>
<a href="#l33.4673"></a><span id="l33.4673">     nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l33.4674"></a><span id="l33.4674" class="difflineminus">-      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l33.4675"></a><span id="l33.4675" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l33.4676"></a><span id="l33.4676" class="difflineminus">-    {</span>
<a href="#l33.4677"></a><span id="l33.4677" class="difflineplus">+        do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l33.4678"></a><span id="l33.4678" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l33.4679"></a><span id="l33.4679">       nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l33.4680"></a><span id="l33.4680">       rv = accountManager-&gt;GetLocalFoldersServer(getter_AddRefs(server));</span>
<a href="#l33.4681"></a><span id="l33.4681" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l33.4682"></a><span id="l33.4682" class="difflineminus">-        rv = server-&gt;GetPrettyName(localFoldersAccountName);</span>
<a href="#l33.4683"></a><span id="l33.4683" class="difflineplus">+      if (NS_SUCCEEDED(rv)) rv = server-&gt;GetPrettyName(localFoldersAccountName);</span>
<a href="#l33.4684"></a><span id="l33.4684">     }</span>
<a href="#l33.4685"></a><span id="l33.4685" class="difflineminus">-    if (NS_FAILED(rv) || localFoldersAccountName.IsEmpty())</span>
<a href="#l33.4686"></a><span id="l33.4686" class="difflineminus">-    {</span>
<a href="#l33.4687"></a><span id="l33.4687" class="difflineplus">+    if (NS_FAILED(rv) || localFoldersAccountName.IsEmpty()) {</span>
<a href="#l33.4688"></a><span id="l33.4688">       // Unable to obtain localFoldersAccountName.</span>
<a href="#l33.4689"></a><span id="l33.4689">       Fail(NS_OK, nullptr, &amp;aStatus);</span>
<a href="#l33.4690"></a><span id="l33.4690">       return NS_ERROR_FAILURE;</span>
<a href="#l33.4691"></a><span id="l33.4691">     }</span>
<a href="#l33.4692"></a><span id="l33.4692"> </span>
<a href="#l33.4693"></a><span id="l33.4693">     // Get the user account name where &quot;save to&quot; failed.</span>
<a href="#l33.4694"></a><span id="l33.4694">     nsString accountName;</span>
<a href="#l33.4695"></a><span id="l33.4695" class="difflineminus">-    const char* fcc = mCompFields-&gt;GetFcc();</span>
<a href="#l33.4696"></a><span id="l33.4696" class="difflineminus">-    if (fcc &amp;&amp; *fcc)</span>
<a href="#l33.4697"></a><span id="l33.4697" class="difflineminus">-    {</span>
<a href="#l33.4698"></a><span id="l33.4698" class="difflineplus">+    const char *fcc = mCompFields-&gt;GetFcc();</span>
<a href="#l33.4699"></a><span id="l33.4699" class="difflineplus">+    if (fcc &amp;&amp; *fcc) {</span>
<a href="#l33.4700"></a><span id="l33.4700">       nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l33.4701"></a><span id="l33.4701">       rv = GetIncomingServer(fcc, getter_AddRefs(server));</span>
<a href="#l33.4702"></a><span id="l33.4702" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; server)</span>
<a href="#l33.4703"></a><span id="l33.4703" class="difflineminus">-        rv = server-&gt;GetPrettyName(accountName);</span>
<a href="#l33.4704"></a><span id="l33.4704" class="difflineminus">-    }</span>
<a href="#l33.4705"></a><span id="l33.4705" class="difflineminus">-    else</span>
<a href="#l33.4706"></a><span id="l33.4706" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; server) rv = server-&gt;GetPrettyName(accountName);</span>
<a href="#l33.4707"></a><span id="l33.4707" class="difflineplus">+    } else</span>
<a href="#l33.4708"></a><span id="l33.4708">       rv = NS_ERROR_FAILURE;</span>
<a href="#l33.4709"></a><span id="l33.4709" class="difflineminus">-    if (NS_FAILED(rv) || accountName.IsEmpty())</span>
<a href="#l33.4710"></a><span id="l33.4710" class="difflineminus">-    {</span>
<a href="#l33.4711"></a><span id="l33.4711" class="difflineplus">+    if (NS_FAILED(rv) || accountName.IsEmpty()) {</span>
<a href="#l33.4712"></a><span id="l33.4712">       // Unable to obtain accountName.</span>
<a href="#l33.4713"></a><span id="l33.4713">       Fail(NS_OK, nullptr, &amp;aStatus);</span>
<a href="#l33.4714"></a><span id="l33.4714">       return NS_ERROR_FAILURE;</span>
<a href="#l33.4715"></a><span id="l33.4715">     }</span>
<a href="#l33.4716"></a><span id="l33.4716"> </span>
<a href="#l33.4717"></a><span id="l33.4717" class="difflineminus">-    const char16_t *formatStrings[] = { mSavedToFolderName.get(), accountName.get(),</span>
<a href="#l33.4718"></a><span id="l33.4718" class="difflineminus">-                                        localFoldersAccountName.get() };</span>
<a href="#l33.4719"></a><span id="l33.4719" class="difflineplus">+    const char16_t *formatStrings[] = {mSavedToFolderName.get(),</span>
<a href="#l33.4720"></a><span id="l33.4720" class="difflineplus">+                                       accountName.get(),</span>
<a href="#l33.4721"></a><span id="l33.4721" class="difflineplus">+                                       localFoldersAccountName.get()};</span>
<a href="#l33.4722"></a><span id="l33.4722"> </span>
<a href="#l33.4723"></a><span id="l33.4723">     nsString msg;</span>
<a href="#l33.4724"></a><span id="l33.4724" class="difflineminus">-    switch (m_deliver_mode)</span>
<a href="#l33.4725"></a><span id="l33.4725" class="difflineminus">-    {</span>
<a href="#l33.4726"></a><span id="l33.4726" class="difflineplus">+    switch (m_deliver_mode) {</span>
<a href="#l33.4727"></a><span id="l33.4727">       case nsMsgDeliverNow:</span>
<a href="#l33.4728"></a><span id="l33.4728">       case nsMsgSendUnsent:</span>
<a href="#l33.4729"></a><span id="l33.4729">         rv = bundle-&gt;FormatStringFromName(&quot;promptToSaveSentLocally2&quot;,</span>
<a href="#l33.4730"></a><span id="l33.4730" class="difflineminus">-                                          formatStrings, 3,</span>
<a href="#l33.4731"></a><span id="l33.4731" class="difflineminus">-                                          msg);</span>
<a href="#l33.4732"></a><span id="l33.4732" class="difflineplus">+                                          formatStrings, 3, msg);</span>
<a href="#l33.4733"></a><span id="l33.4733">         break;</span>
<a href="#l33.4734"></a><span id="l33.4734">       case nsMsgSaveAsDraft:</span>
<a href="#l33.4735"></a><span id="l33.4735">         rv = bundle-&gt;FormatStringFromName(&quot;promptToSaveDraftLocally2&quot;,</span>
<a href="#l33.4736"></a><span id="l33.4736" class="difflineminus">-                                          formatStrings, 3,</span>
<a href="#l33.4737"></a><span id="l33.4737" class="difflineminus">-                                          msg);</span>
<a href="#l33.4738"></a><span id="l33.4738" class="difflineplus">+                                          formatStrings, 3, msg);</span>
<a href="#l33.4739"></a><span id="l33.4739">         break;</span>
<a href="#l33.4740"></a><span id="l33.4740">       case nsMsgSaveAsTemplate:</span>
<a href="#l33.4741"></a><span id="l33.4741">         rv = bundle-&gt;FormatStringFromName(&quot;promptToSaveTemplateLocally2&quot;,</span>
<a href="#l33.4742"></a><span id="l33.4742" class="difflineminus">-                                          formatStrings, 3,</span>
<a href="#l33.4743"></a><span id="l33.4743" class="difflineminus">-                                          msg);</span>
<a href="#l33.4744"></a><span id="l33.4744" class="difflineplus">+                                          formatStrings, 3, msg);</span>
<a href="#l33.4745"></a><span id="l33.4745">         break;</span>
<a href="#l33.4746"></a><span id="l33.4746">       default:</span>
<a href="#l33.4747"></a><span id="l33.4747">         rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l33.4748"></a><span id="l33.4748">     }</span>
<a href="#l33.4749"></a><span id="l33.4749">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l33.4750"></a><span id="l33.4750">     int32_t buttonPressed = 0;</span>
<a href="#l33.4751"></a><span id="l33.4751">     bool showCheckBox = false;</span>
<a href="#l33.4752"></a><span id="l33.4752" class="difflineminus">-    uint32_t buttonFlags = (nsIPrompt::BUTTON_POS_0 * nsIPrompt::BUTTON_TITLE_IS_STRING) +</span>
<a href="#l33.4753"></a><span id="l33.4753" class="difflineminus">-                           (nsIPrompt::BUTTON_POS_1 * nsIPrompt::BUTTON_TITLE_DONT_SAVE) +</span>
<a href="#l33.4754"></a><span id="l33.4754" class="difflineminus">-                           (nsIPrompt::BUTTON_POS_2 * nsIPrompt::BUTTON_TITLE_SAVE);</span>
<a href="#l33.4755"></a><span id="l33.4755" class="difflineplus">+    uint32_t buttonFlags =</span>
<a href="#l33.4756"></a><span id="l33.4756" class="difflineplus">+        (nsIPrompt::BUTTON_POS_0 * nsIPrompt::BUTTON_TITLE_IS_STRING) +</span>
<a href="#l33.4757"></a><span id="l33.4757" class="difflineplus">+        (nsIPrompt::BUTTON_POS_1 * nsIPrompt::BUTTON_TITLE_DONT_SAVE) +</span>
<a href="#l33.4758"></a><span id="l33.4758" class="difflineplus">+        (nsIPrompt::BUTTON_POS_2 * nsIPrompt::BUTTON_TITLE_SAVE);</span>
<a href="#l33.4759"></a><span id="l33.4759">     nsString dialogTitle, buttonLabelRetry;</span>
<a href="#l33.4760"></a><span id="l33.4760">     bundle-&gt;GetStringFromName(&quot;SaveDialogTitle&quot;, dialogTitle);</span>
<a href="#l33.4761"></a><span id="l33.4761">     bundle-&gt;GetStringFromName(&quot;buttonLabelRetry2&quot;, buttonLabelRetry);</span>
<a href="#l33.4762"></a><span id="l33.4762"> </span>
<a href="#l33.4763"></a><span id="l33.4763">     nsCOMPtr&lt;nsIPrompt&gt; prompt;</span>
<a href="#l33.4764"></a><span id="l33.4764">     rv = GetDefaultPrompt(getter_AddRefs(prompt));</span>
<a href="#l33.4765"></a><span id="l33.4765">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l33.4766"></a><span id="l33.4766" class="difflineminus">-    prompt-&gt;ConfirmEx(dialogTitle.get(), msg.get(), buttonFlags, buttonLabelRetry.get(),</span>
<a href="#l33.4767"></a><span id="l33.4767" class="difflineminus">-                      nullptr, nullptr, nullptr, &amp;showCheckBox, &amp;buttonPressed);</span>
<a href="#l33.4768"></a><span id="l33.4768" class="difflineminus">-    if (buttonPressed == 0)</span>
<a href="#l33.4769"></a><span id="l33.4769" class="difflineminus">-    {</span>
<a href="#l33.4770"></a><span id="l33.4770" class="difflineplus">+    prompt-&gt;ConfirmEx(dialogTitle.get(), msg.get(), buttonFlags,</span>
<a href="#l33.4771"></a><span id="l33.4771" class="difflineplus">+                      buttonLabelRetry.get(), nullptr, nullptr, nullptr,</span>
<a href="#l33.4772"></a><span id="l33.4772" class="difflineplus">+                      &amp;showCheckBox, &amp;buttonPressed);</span>
<a href="#l33.4773"></a><span id="l33.4773" class="difflineplus">+    if (buttonPressed == 0) {</span>
<a href="#l33.4774"></a><span id="l33.4774">       // retry button clicked</span>
<a href="#l33.4775"></a><span id="l33.4775" class="difflineminus">-      mSendProgress = nullptr; // this was canceled, so we need to clear it.</span>
<a href="#l33.4776"></a><span id="l33.4776" class="difflineplus">+      mSendProgress = nullptr;  // this was canceled, so we need to clear it.</span>
<a href="#l33.4777"></a><span id="l33.4777">       return SendToMagicFolder(m_deliver_mode);</span>
<a href="#l33.4778"></a><span id="l33.4778">     }</span>
<a href="#l33.4779"></a><span id="l33.4779"> </span>
<a href="#l33.4780"></a><span id="l33.4780">     bool saveLocally = (buttonPressed == 2);</span>
<a href="#l33.4781"></a><span id="l33.4781"> </span>
<a href="#l33.4782"></a><span id="l33.4782" class="difflineminus">-    if (saveLocally)</span>
<a href="#l33.4783"></a><span id="l33.4783" class="difflineminus">-    {</span>
<a href="#l33.4784"></a><span id="l33.4784" class="difflineplus">+    if (saveLocally) {</span>
<a href="#l33.4785"></a><span id="l33.4785">       // Try to save to Local Folders/&lt;account name&gt;.</span>
<a href="#l33.4786"></a><span id="l33.4786">       // Pass in &quot;nsMsgDeliverNow&quot; so draft saves too. Also, fcc pointer</span>
<a href="#l33.4787"></a><span id="l33.4787">       // is nullptr to tell function to save to local folders and not the</span>
<a href="#l33.4788"></a><span id="l33.4788">       // configured fcc.</span>
<a href="#l33.4789"></a><span id="l33.4789" class="difflineminus">-      rv = MimeDoFCC(mTempFile,</span>
<a href="#l33.4790"></a><span id="l33.4790" class="difflineminus">-                     nsIMsgSend::nsMsgDeliverNow,</span>
<a href="#l33.4791"></a><span id="l33.4791" class="difflineminus">-                     mCompFields-&gt;GetBcc(),</span>
<a href="#l33.4792"></a><span id="l33.4792" class="difflineminus">-                     nullptr,</span>
<a href="#l33.4793"></a><span id="l33.4793" class="difflineplus">+      rv = MimeDoFCC(mTempFile, nsIMsgSend::nsMsgDeliverNow,</span>
<a href="#l33.4794"></a><span id="l33.4794" class="difflineplus">+                     mCompFields-&gt;GetBcc(), nullptr,</span>
<a href="#l33.4795"></a><span id="l33.4795">                      mCompFields-&gt;GetNewspostUrl());</span>
<a href="#l33.4796"></a><span id="l33.4796"> </span>
<a href="#l33.4797"></a><span id="l33.4797" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l33.4798"></a><span id="l33.4798" class="difflineminus">-      {</span>
<a href="#l33.4799"></a><span id="l33.4799" class="difflineplus">+      if (NS_FAILED(rv)) {</span>
<a href="#l33.4800"></a><span id="l33.4800">         // Save to Local Folders failed. Inform the user.</span>
<a href="#l33.4801"></a><span id="l33.4801">         nsCOMPtr&lt;nsIPrompt&gt; prompt;</span>
<a href="#l33.4802"></a><span id="l33.4802">         rv = GetDefaultPrompt(getter_AddRefs(prompt));</span>
<a href="#l33.4803"></a><span id="l33.4803">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l33.4804"></a><span id="l33.4804">         nsMsgDisplayMessageByName(prompt, &quot;saveToLocalFoldersFailed&quot;);</span>
<a href="#l33.4805"></a><span id="l33.4805">       }</span>
<a href="#l33.4806"></a><span id="l33.4806">     }</span>
<a href="#l33.4807"></a><span id="l33.4807"> </span>
<a href="#l33.4808"></a><span id="l33.4808">     // Failure detected when user saved to default folder and the user did not</span>
<a href="#l33.4809"></a><span id="l33.4809">     // retry; instead the user saved to Local Folders or canceled the save. So</span>
<a href="#l33.4810"></a><span id="l33.4810">     // just call Fail() with a success code so that it doesn't prompt the user</span>
<a href="#l33.4811"></a><span id="l33.4811">     // again since the user already knows about the failure and has reacted.</span>
<a href="#l33.4812"></a><span id="l33.4812">     Fail(NS_OK, nullptr, &amp;aStatus);</span>
<a href="#l33.4813"></a><span id="l33.4813">   }</span>
<a href="#l33.4814"></a><span id="l33.4814"> </span>
<a href="#l33.4815"></a><span id="l33.4815" class="difflineminus">-  if (NS_SUCCEEDED(aStatus) &amp;&amp;</span>
<a href="#l33.4816"></a><span id="l33.4816" class="difflineminus">-      !mPerformingSecondFCC &amp;&amp; m_messageKey != nsMsgKey_None &amp;&amp;</span>
<a href="#l33.4817"></a><span id="l33.4817" class="difflineminus">-      (m_deliver_mode == nsMsgDeliverNow || m_deliver_mode == nsMsgSendUnsent))</span>
<a href="#l33.4818"></a><span id="l33.4818" class="difflineminus">-  {</span>
<a href="#l33.4819"></a><span id="l33.4819" class="difflineplus">+  if (NS_SUCCEEDED(aStatus) &amp;&amp; !mPerformingSecondFCC &amp;&amp;</span>
<a href="#l33.4820"></a><span id="l33.4820" class="difflineplus">+      m_messageKey != nsMsgKey_None &amp;&amp;</span>
<a href="#l33.4821"></a><span id="l33.4821" class="difflineplus">+      (m_deliver_mode == nsMsgDeliverNow ||</span>
<a href="#l33.4822"></a><span id="l33.4822" class="difflineplus">+       m_deliver_mode == nsMsgSendUnsent)) {</span>
<a href="#l33.4823"></a><span id="l33.4823">     rv = FilterSentMessage();</span>
<a href="#l33.4824"></a><span id="l33.4824" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l33.4825"></a><span id="l33.4825" class="difflineminus">-      OnStopOperation(rv);</span>
<a href="#l33.4826"></a><span id="l33.4826" class="difflineplus">+    if (NS_FAILED(rv)) OnStopOperation(rv);</span>
<a href="#l33.4827"></a><span id="l33.4827">     return rv;</span>
<a href="#l33.4828"></a><span id="l33.4828">   }</span>
<a href="#l33.4829"></a><span id="l33.4829"> </span>
<a href="#l33.4830"></a><span id="l33.4830">   return MaybePerformSecondFCC(aStatus);</span>
<a href="#l33.4831"></a><span id="l33.4831"> }</span>
<a href="#l33.4832"></a><span id="l33.4832"> </span>
<a href="#l33.4833"></a><span id="l33.4833" class="difflineminus">-nsresult</span>
<a href="#l33.4834"></a><span id="l33.4834" class="difflineminus">-nsMsgComposeAndSend::FilterSentMessage()</span>
<a href="#l33.4835"></a><span id="l33.4835" class="difflineminus">-{</span>
<a href="#l33.4836"></a><span id="l33.4836" class="difflineplus">+nsresult nsMsgComposeAndSend::FilterSentMessage() {</span>
<a href="#l33.4837"></a><span id="l33.4837">   if (mSendReport)</span>
<a href="#l33.4838"></a><span id="l33.4838">     mSendReport-&gt;SetCurrentProcess(nsIMsgSendReport::process_Filter);</span>
<a href="#l33.4839"></a><span id="l33.4839"> </span>
<a href="#l33.4840"></a><span id="l33.4840">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l33.4841"></a><span id="l33.4841">   nsresult rv = GetExistingFolder(m_folderName, getter_AddRefs(folder));</span>
<a href="#l33.4842"></a><span id="l33.4842" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l33.4843"></a><span id="l33.4843" class="difflineminus">-    return rv;</span>
<a href="#l33.4844"></a><span id="l33.4844" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l33.4845"></a><span id="l33.4845"> </span>
<a href="#l33.4846"></a><span id="l33.4846">   nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l33.4847"></a><span id="l33.4847">   rv = folder-&gt;GetMessageHeader(m_messageKey, getter_AddRefs(msgHdr));</span>
<a href="#l33.4848"></a><span id="l33.4848" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l33.4849"></a><span id="l33.4849" class="difflineminus">-    return rv;</span>
<a href="#l33.4850"></a><span id="l33.4850" class="difflineminus">-</span>
<a href="#l33.4851"></a><span id="l33.4851" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; msgArray(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l33.4852"></a><span id="l33.4852" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l33.4853"></a><span id="l33.4853" class="difflineminus">-    return rv;</span>
<a href="#l33.4854"></a><span id="l33.4854" class="difflineminus">-</span>
<a href="#l33.4855"></a><span id="l33.4855" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFilterService&gt; filterSvc = do_GetService(NS_MSGFILTERSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l33.4856"></a><span id="l33.4856" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l33.4857"></a><span id="l33.4857" class="difflineminus">-    return rv;</span>
<a href="#l33.4858"></a><span id="l33.4858" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l33.4859"></a><span id="l33.4859" class="difflineplus">+</span>
<a href="#l33.4860"></a><span id="l33.4860" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; msgArray(</span>
<a href="#l33.4861"></a><span id="l33.4861" class="difflineplus">+      do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l33.4862"></a><span id="l33.4862" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l33.4863"></a><span id="l33.4863" class="difflineplus">+</span>
<a href="#l33.4864"></a><span id="l33.4864" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFilterService&gt; filterSvc =</span>
<a href="#l33.4865"></a><span id="l33.4865" class="difflineplus">+      do_GetService(NS_MSGFILTERSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l33.4866"></a><span id="l33.4866" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l33.4867"></a><span id="l33.4867"> </span>
<a href="#l33.4868"></a><span id="l33.4868">   rv = msgArray-&gt;AppendElement(msgHdr);</span>
<a href="#l33.4869"></a><span id="l33.4869" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l33.4870"></a><span id="l33.4870" class="difflineminus">-    return rv;</span>
<a href="#l33.4871"></a><span id="l33.4871" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l33.4872"></a><span id="l33.4872"> </span>
<a href="#l33.4873"></a><span id="l33.4873">   nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l33.4874"></a><span id="l33.4874" class="difflineminus">-  if (mSendProgress)</span>
<a href="#l33.4875"></a><span id="l33.4875" class="difflineminus">-    mSendProgress-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l33.4876"></a><span id="l33.4876" class="difflineminus">-</span>
<a href="#l33.4877"></a><span id="l33.4877" class="difflineminus">-  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Send) Running filters on sent message&quot;));</span>
<a href="#l33.4878"></a><span id="l33.4878" class="difflineminus">-  return filterSvc-&gt;ApplyFilters(nsMsgFilterType::PostOutgoing, msgArray, folder, msgWindow, this);</span>
<a href="#l33.4879"></a><span id="l33.4879" class="difflineplus">+  if (mSendProgress) mSendProgress-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l33.4880"></a><span id="l33.4880" class="difflineplus">+</span>
<a href="#l33.4881"></a><span id="l33.4881" class="difflineplus">+  MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l33.4882"></a><span id="l33.4882" class="difflineplus">+          (&quot;(Send) Running filters on sent message&quot;));</span>
<a href="#l33.4883"></a><span id="l33.4883" class="difflineplus">+  return filterSvc-&gt;ApplyFilters(nsMsgFilterType::PostOutgoing, msgArray,</span>
<a href="#l33.4884"></a><span id="l33.4884" class="difflineplus">+                                 folder, msgWindow, this);</span>
<a href="#l33.4885"></a><span id="l33.4885"> }</span>
<a href="#l33.4886"></a><span id="l33.4886"> </span>
<a href="#l33.4887"></a><span id="l33.4887"> NS_IMETHODIMP</span>
<a href="#l33.4888"></a><span id="l33.4888" class="difflineminus">-nsMsgComposeAndSend::OnStopOperation(nsresult aStatus)</span>
<a href="#l33.4889"></a><span id="l33.4889" class="difflineminus">-{</span>
<a href="#l33.4890"></a><span id="l33.4890" class="difflineplus">+nsMsgComposeAndSend::OnStopOperation(nsresult aStatus) {</span>
<a href="#l33.4891"></a><span id="l33.4891">   // Set a status message...</span>
<a href="#l33.4892"></a><span id="l33.4892">   nsString msg;</span>
<a href="#l33.4893"></a><span id="l33.4893">   if (NS_SUCCEEDED(aStatus)) {</span>
<a href="#l33.4894"></a><span id="l33.4894">     mComposeBundle-&gt;GetStringFromName(&quot;filterMessageComplete&quot;, msg);</span>
<a href="#l33.4895"></a><span id="l33.4895">     MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Send) Filter run complete&quot;));</span>
<a href="#l33.4896"></a><span id="l33.4896">   } else {</span>
<a href="#l33.4897"></a><span id="l33.4897">     mComposeBundle-&gt;GetStringFromName(&quot;filterMessageFailed&quot;, msg);</span>
<a href="#l33.4898"></a><span id="l33.4898">     MOZ_LOG(FILTERLOGMODULE, LogLevel::Info, (&quot;(Send) Filter run failed&quot;));</span>
<a href="#l33.4899"></a><span id="l33.4899">   }</span>
<a href="#l33.4900"></a><span id="l33.4900"> </span>
<a href="#l33.4901"></a><span id="l33.4901">   SetStatusMessage(msg);</span>
<a href="#l33.4902"></a><span id="l33.4902"> </span>
<a href="#l33.4903"></a><span id="l33.4903" class="difflineminus">-  if (NS_FAILED(aStatus))</span>
<a href="#l33.4904"></a><span id="l33.4904" class="difflineminus">-  {</span>
<a href="#l33.4905"></a><span id="l33.4905" class="difflineplus">+  if (NS_FAILED(aStatus)) {</span>
<a href="#l33.4906"></a><span id="l33.4906">     nsresult rv = mComposeBundle-&gt;GetStringFromName(&quot;errorFilteringMsg&quot;, msg);</span>
<a href="#l33.4907"></a><span id="l33.4907" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l33.4908"></a><span id="l33.4908" class="difflineminus">-    {</span>
<a href="#l33.4909"></a><span id="l33.4909" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l33.4910"></a><span id="l33.4910">       nsCOMPtr&lt;nsIPrompt&gt; prompt;</span>
<a href="#l33.4911"></a><span id="l33.4911">       rv = GetDefaultPrompt(getter_AddRefs(prompt));</span>
<a href="#l33.4912"></a><span id="l33.4912">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l33.4913"></a><span id="l33.4913">       nsMsgDisplayMessageByString(prompt, msg.get(), nullptr);</span>
<a href="#l33.4914"></a><span id="l33.4914">     }</span>
<a href="#l33.4915"></a><span id="l33.4915"> </span>
<a href="#l33.4916"></a><span id="l33.4916">     // We failed, however, give Fail a success code so that it doesn't prompt</span>
<a href="#l33.4917"></a><span id="l33.4917">     // the user a second time as they already know about the failure.</span>
<a href="#l33.4918"></a><span id="l33.4918">     Fail(NS_OK, nullptr, &amp;aStatus);</span>
<a href="#l33.4919"></a><span id="l33.4919">   }</span>
<a href="#l33.4920"></a><span id="l33.4920"> </span>
<a href="#l33.4921"></a><span id="l33.4921">   return MaybePerformSecondFCC(aStatus);</span>
<a href="#l33.4922"></a><span id="l33.4922"> }</span>
<a href="#l33.4923"></a><span id="l33.4923"> </span>
<a href="#l33.4924"></a><span id="l33.4924" class="difflineminus">-nsresult</span>
<a href="#l33.4925"></a><span id="l33.4925" class="difflineminus">-nsMsgComposeAndSend::MaybePerformSecondFCC(nsresult aStatus)</span>
<a href="#l33.4926"></a><span id="l33.4926" class="difflineminus">-{</span>
<a href="#l33.4927"></a><span id="l33.4927" class="difflineplus">+nsresult nsMsgComposeAndSend::MaybePerformSecondFCC(nsresult aStatus) {</span>
<a href="#l33.4928"></a><span id="l33.4928">   // Ok, now to support a second copy operation, we need to figure</span>
<a href="#l33.4929"></a><span id="l33.4929">   // out which copy request just finished. If the user has requested</span>
<a href="#l33.4930"></a><span id="l33.4930">   // a second copy operation, then we need to fire that off, but if they</span>
<a href="#l33.4931"></a><span id="l33.4931">   // just wanted a single copy operation, we can tell everyone we are done</span>
<a href="#l33.4932"></a><span id="l33.4932">   // and move on with life. Only do the second copy if the first one worked.</span>
<a href="#l33.4933"></a><span id="l33.4933">   //</span>
<a href="#l33.4934"></a><span id="l33.4934" class="difflineminus">-  if ( NS_SUCCEEDED(aStatus) &amp;&amp; (mNeedToPerformSecondFCC) )</span>
<a href="#l33.4935"></a><span id="l33.4935" class="difflineminus">-  {</span>
<a href="#l33.4936"></a><span id="l33.4936" class="difflineplus">+  if (NS_SUCCEEDED(aStatus) &amp;&amp; (mNeedToPerformSecondFCC)) {</span>
<a href="#l33.4937"></a><span id="l33.4937">     if (mSendReport)</span>
<a href="#l33.4938"></a><span id="l33.4938">       mSendReport-&gt;SetCurrentProcess(nsIMsgSendReport::process_FCC);</span>
<a href="#l33.4939"></a><span id="l33.4939"> </span>
<a href="#l33.4940"></a><span id="l33.4940">     mNeedToPerformSecondFCC = false;</span>
<a href="#l33.4941"></a><span id="l33.4941">     mPerformingSecondFCC = true;</span>
<a href="#l33.4942"></a><span id="l33.4942"> </span>
<a href="#l33.4943"></a><span id="l33.4943">     const char *fcc2 = mCompFields-&gt;GetFcc2();</span>
<a href="#l33.4944"></a><span id="l33.4944" class="difflineminus">-    if (fcc2 &amp;&amp; *fcc2)</span>
<a href="#l33.4945"></a><span id="l33.4945" class="difflineminus">-    {</span>
<a href="#l33.4946"></a><span id="l33.4946" class="difflineminus">-      nsresult rv = MimeDoFCC(mTempFile,</span>
<a href="#l33.4947"></a><span id="l33.4947" class="difflineminus">-                              nsMsgDeliverNow,</span>
<a href="#l33.4948"></a><span id="l33.4948" class="difflineminus">-                              mCompFields-&gt;GetBcc(),</span>
<a href="#l33.4949"></a><span id="l33.4949" class="difflineminus">-                              fcc2,</span>
<a href="#l33.4950"></a><span id="l33.4950" class="difflineminus">-                              mCompFields-&gt;GetNewspostUrl());</span>
<a href="#l33.4951"></a><span id="l33.4951" class="difflineplus">+    if (fcc2 &amp;&amp; *fcc2) {</span>
<a href="#l33.4952"></a><span id="l33.4952" class="difflineplus">+      nsresult rv = MimeDoFCC(mTempFile, nsMsgDeliverNow, mCompFields-&gt;GetBcc(),</span>
<a href="#l33.4953"></a><span id="l33.4953" class="difflineplus">+                              fcc2, mCompFields-&gt;GetNewspostUrl());</span>
<a href="#l33.4954"></a><span id="l33.4954">       if (NS_FAILED(rv))</span>
<a href="#l33.4955"></a><span id="l33.4955">         Fail(rv, nullptr, &amp;aStatus);</span>
<a href="#l33.4956"></a><span id="l33.4956">       else</span>
<a href="#l33.4957"></a><span id="l33.4957">         return NS_OK;</span>
<a href="#l33.4958"></a><span id="l33.4958">     }</span>
<a href="#l33.4959"></a><span id="l33.4959">   }</span>
<a href="#l33.4960"></a><span id="l33.4960"> </span>
<a href="#l33.4961"></a><span id="l33.4961">   // If we are here, its real cleanup time!</span>
<a href="#l33.4962"></a><span id="l33.4962" class="difflineminus">-  if (mListener)</span>
<a href="#l33.4963"></a><span id="l33.4963" class="difflineminus">-  {</span>
<a href="#l33.4964"></a><span id="l33.4964" class="difflineplus">+  if (mListener) {</span>
<a href="#l33.4965"></a><span id="l33.4965">     nsCOMPtr&lt;nsIMsgCopyServiceListener&gt; copyListener =</span>
<a href="#l33.4966"></a><span id="l33.4966" class="difflineminus">-      do_QueryInterface(mListener);</span>
<a href="#l33.4967"></a><span id="l33.4967" class="difflineminus">-    if (copyListener)</span>
<a href="#l33.4968"></a><span id="l33.4968" class="difflineminus">-      copyListener-&gt;OnStopCopy(aStatus);</span>
<a href="#l33.4969"></a><span id="l33.4969" class="difflineplus">+        do_QueryInterface(mListener);</span>
<a href="#l33.4970"></a><span id="l33.4970" class="difflineplus">+    if (copyListener) copyListener-&gt;OnStopCopy(aStatus);</span>
<a href="#l33.4971"></a><span id="l33.4971">   }</span>
<a href="#l33.4972"></a><span id="l33.4972"> </span>
<a href="#l33.4973"></a><span id="l33.4973">   return aStatus;</span>
<a href="#l33.4974"></a><span id="l33.4974"> }</span>
<a href="#l33.4975"></a><span id="l33.4975"> </span>
<a href="#l33.4976"></a><span id="l33.4976"> /* This is the main driving function of this module.  It generates a</span>
<a href="#l33.4977"></a><span id="l33.4977">    document of type message/rfc822, which contains the stuff provided.</span>
<a href="#l33.4978"></a><span id="l33.4978">    The first few arguments are the standard header fields that the</span>
<a href="#l33.4979"></a><span id="l33.4979" class="difflineat">@@ -4072,280 +3687,230 @@ nsMsgComposeAndSend::MaybePerformSecondF</span>
<a href="#l33.4980"></a><span id="l33.4980">    freeing the file name string, and deleting the file when it is done with</span>
<a href="#l33.4981"></a><span id="l33.4981">    it.  If an error occurred, then `status' will be negative and</span>
<a href="#l33.4982"></a><span id="l33.4982">    `error_message' may be an error message to display.  If status is non-</span>
<a href="#l33.4983"></a><span id="l33.4983">    negative, then `error_message' contains the file name (this is kind of</span>
<a href="#l33.4984"></a><span id="l33.4984">    a kludge...)</span>
<a href="#l33.4985"></a><span id="l33.4985">  */</span>
<a href="#l33.4986"></a><span id="l33.4986"> NS_IMETHODIMP</span>
<a href="#l33.4987"></a><span id="l33.4987"> nsMsgComposeAndSend::CreateAndSendMessage(</span>
<a href="#l33.4988"></a><span id="l33.4988" class="difflineminus">-              nsIEditor                         *aEditor,</span>
<a href="#l33.4989"></a><span id="l33.4989" class="difflineminus">-              nsIMsgIdentity                    *aUserIdentity,</span>
<a href="#l33.4990"></a><span id="l33.4990" class="difflineminus">-              const char                        *aAccountKey,</span>
<a href="#l33.4991"></a><span id="l33.4991" class="difflineminus">-              nsIMsgCompFields                  *fields,</span>
<a href="#l33.4992"></a><span id="l33.4992" class="difflineminus">-              bool                              digest_p,</span>
<a href="#l33.4993"></a><span id="l33.4993" class="difflineminus">-              bool                              dont_deliver_p,</span>
<a href="#l33.4994"></a><span id="l33.4994" class="difflineminus">-              nsMsgDeliverMode                  mode,</span>
<a href="#l33.4995"></a><span id="l33.4995" class="difflineminus">-              nsIMsgDBHdr                       *msgToReplace,</span>
<a href="#l33.4996"></a><span id="l33.4996" class="difflineminus">-              const char                        *attachment1_type,</span>
<a href="#l33.4997"></a><span id="l33.4997" class="difflineminus">-              const nsACString                  &amp;attachment1_body,</span>
<a href="#l33.4998"></a><span id="l33.4998" class="difflineminus">-              nsIArray *attachments,</span>
<a href="#l33.4999"></a><span id="l33.4999" class="difflineminus">-              nsIArray *preloaded_attachments,</span>
<a href="#l33.5000"></a><span id="l33.5000" class="difflineminus">-              mozIDOMWindowProxy                *parentWindow,</span>
<a href="#l33.5001"></a><span id="l33.5001" class="difflineminus">-              nsIMsgProgress                    *progress,</span>
<a href="#l33.5002"></a><span id="l33.5002" class="difflineminus">-              nsIMsgSendListener                *aListener,</span>
<a href="#l33.5003"></a><span id="l33.5003" class="difflineminus">-              const nsAString                   &amp;password,</span>
<a href="#l33.5004"></a><span id="l33.5004" class="difflineminus">-              const nsACString                  &amp;aOriginalMsgURI,</span>
<a href="#l33.5005"></a><span id="l33.5005" class="difflineminus">-              MSG_ComposeType                   aType</span>
<a href="#l33.5006"></a><span id="l33.5006" class="difflineminus">-              )</span>
<a href="#l33.5007"></a><span id="l33.5007" class="difflineminus">-{</span>
<a href="#l33.5008"></a><span id="l33.5008" class="difflineplus">+    nsIEditor *aEditor, nsIMsgIdentity *aUserIdentity, const char *aAccountKey,</span>
<a href="#l33.5009"></a><span id="l33.5009" class="difflineplus">+    nsIMsgCompFields *fields, bool digest_p, bool dont_deliver_p,</span>
<a href="#l33.5010"></a><span id="l33.5010" class="difflineplus">+    nsMsgDeliverMode mode, nsIMsgDBHdr *msgToReplace,</span>
<a href="#l33.5011"></a><span id="l33.5011" class="difflineplus">+    const char *attachment1_type, const nsACString &amp;attachment1_body,</span>
<a href="#l33.5012"></a><span id="l33.5012" class="difflineplus">+    nsIArray *attachments, nsIArray *preloaded_attachments,</span>
<a href="#l33.5013"></a><span id="l33.5013" class="difflineplus">+    mozIDOMWindowProxy *parentWindow, nsIMsgProgress *progress,</span>
<a href="#l33.5014"></a><span id="l33.5014" class="difflineplus">+    nsIMsgSendListener *aListener, const nsAString &amp;password,</span>
<a href="#l33.5015"></a><span id="l33.5015" class="difflineplus">+    const nsACString &amp;aOriginalMsgURI, MSG_ComposeType aType) {</span>
<a href="#l33.5016"></a><span id="l33.5016">   nsCOMPtr&lt;nsIMsgSend&gt; kungFuDeathGrip(this);</span>
<a href="#l33.5017"></a><span id="l33.5017"> </span>
<a href="#l33.5018"></a><span id="l33.5018" class="difflineminus">-  nsresult      rv;</span>
<a href="#l33.5019"></a><span id="l33.5019" class="difflineplus">+  nsresult rv;</span>
<a href="#l33.5020"></a><span id="l33.5020">   /* First thing to do is to reset the send errors report */</span>
<a href="#l33.5021"></a><span id="l33.5021">   mSendReport-&gt;Reset();</span>
<a href="#l33.5022"></a><span id="l33.5022">   mSendReport-&gt;SetDeliveryMode(mode);</span>
<a href="#l33.5023"></a><span id="l33.5023"> </span>
<a href="#l33.5024"></a><span id="l33.5024">   mParentWindow = do_QueryInterface(parentWindow);</span>
<a href="#l33.5025"></a><span id="l33.5025">   mSendProgress = progress;</span>
<a href="#l33.5026"></a><span id="l33.5026">   mListener = aListener;</span>
<a href="#l33.5027"></a><span id="l33.5027"> </span>
<a href="#l33.5028"></a><span id="l33.5028">   // Set the editor for MHTML operations if necessary</span>
<a href="#l33.5029"></a><span id="l33.5029" class="difflineminus">-  if (aEditor)</span>
<a href="#l33.5030"></a><span id="l33.5030" class="difflineminus">-    mEditor = aEditor;</span>
<a href="#l33.5031"></a><span id="l33.5031" class="difflineplus">+  if (aEditor) mEditor = aEditor;</span>
<a href="#l33.5032"></a><span id="l33.5032"> </span>
<a href="#l33.5033"></a><span id="l33.5033">   rv = Init(aUserIdentity, aAccountKey, (nsMsgCompFields *)fields, nullptr,</span>
<a href="#l33.5034"></a><span id="l33.5034" class="difflineminus">-          digest_p, dont_deliver_p, mode, msgToReplace,</span>
<a href="#l33.5035"></a><span id="l33.5035" class="difflineminus">-          attachment1_type, attachment1_body,</span>
<a href="#l33.5036"></a><span id="l33.5036" class="difflineminus">-          attachments, preloaded_attachments,</span>
<a href="#l33.5037"></a><span id="l33.5037" class="difflineminus">-          password, aOriginalMsgURI, aType);</span>
<a href="#l33.5038"></a><span id="l33.5038" class="difflineplus">+            digest_p, dont_deliver_p, mode, msgToReplace, attachment1_type,</span>
<a href="#l33.5039"></a><span id="l33.5039" class="difflineplus">+            attachment1_body, attachments, preloaded_attachments, password,</span>
<a href="#l33.5040"></a><span id="l33.5040" class="difflineplus">+            aOriginalMsgURI, aType);</span>
<a href="#l33.5041"></a><span id="l33.5041"> </span>
<a href="#l33.5042"></a><span id="l33.5042">   if (NS_FAILED(rv) &amp;&amp; mSendReport)</span>
<a href="#l33.5043"></a><span id="l33.5043">     mSendReport-&gt;SetError(nsIMsgSendReport::process_Current, rv, false);</span>
<a href="#l33.5044"></a><span id="l33.5044"> </span>
<a href="#l33.5045"></a><span id="l33.5045">   return rv;</span>
<a href="#l33.5046"></a><span id="l33.5046"> }</span>
<a href="#l33.5047"></a><span id="l33.5047"> </span>
<a href="#l33.5048"></a><span id="l33.5048"> NS_IMETHODIMP</span>
<a href="#l33.5049"></a><span id="l33.5049" class="difflineminus">-nsMsgComposeAndSend::CreateRFC822Message(</span>
<a href="#l33.5050"></a><span id="l33.5050" class="difflineminus">-              nsIMsgIdentity *aUserIdentity,</span>
<a href="#l33.5051"></a><span id="l33.5051" class="difflineminus">-              nsIMsgCompFields *aFields,</span>
<a href="#l33.5052"></a><span id="l33.5052" class="difflineminus">-              const char *aMsgType,</span>
<a href="#l33.5053"></a><span id="l33.5053" class="difflineminus">-              const nsACString &amp;aMsgBody,</span>
<a href="#l33.5054"></a><span id="l33.5054" class="difflineminus">-              bool aIsDraft,</span>
<a href="#l33.5055"></a><span id="l33.5055" class="difflineminus">-              nsIArray *aAttachments,</span>
<a href="#l33.5056"></a><span id="l33.5056" class="difflineminus">-              nsIArray *aEmbeddedObjects,</span>
<a href="#l33.5057"></a><span id="l33.5057" class="difflineminus">-              nsIMsgSendListener *aListener</span>
<a href="#l33.5058"></a><span id="l33.5058" class="difflineminus">-              )</span>
<a href="#l33.5059"></a><span id="l33.5059" class="difflineminus">-{</span>
<a href="#l33.5060"></a><span id="l33.5060" class="difflineplus">+nsMsgComposeAndSend::CreateRFC822Message(nsIMsgIdentity *aUserIdentity,</span>
<a href="#l33.5061"></a><span id="l33.5061" class="difflineplus">+                                         nsIMsgCompFields *aFields,</span>
<a href="#l33.5062"></a><span id="l33.5062" class="difflineplus">+                                         const char *aMsgType,</span>
<a href="#l33.5063"></a><span id="l33.5063" class="difflineplus">+                                         const nsACString &amp;aMsgBody,</span>
<a href="#l33.5064"></a><span id="l33.5064" class="difflineplus">+                                         bool aIsDraft, nsIArray *aAttachments,</span>
<a href="#l33.5065"></a><span id="l33.5065" class="difflineplus">+                                         nsIArray *aEmbeddedObjects,</span>
<a href="#l33.5066"></a><span id="l33.5066" class="difflineplus">+                                         nsIMsgSendListener *aListener) {</span>
<a href="#l33.5067"></a><span id="l33.5067">   nsresult rv;</span>
<a href="#l33.5068"></a><span id="l33.5068" class="difflineminus">-  nsMsgDeliverMode mode = aIsDraft ? nsIMsgSend::nsMsgSaveAsDraft :</span>
<a href="#l33.5069"></a><span id="l33.5069" class="difflineminus">-                                     nsIMsgSend::nsMsgDeliverNow;</span>
<a href="#l33.5070"></a><span id="l33.5070" class="difflineplus">+  nsMsgDeliverMode mode =</span>
<a href="#l33.5071"></a><span id="l33.5071" class="difflineplus">+      aIsDraft ? nsIMsgSend::nsMsgSaveAsDraft : nsIMsgSend::nsMsgDeliverNow;</span>
<a href="#l33.5072"></a><span id="l33.5072"> </span>
<a href="#l33.5073"></a><span id="l33.5073">   /* First thing to do is to reset the send errors report */</span>
<a href="#l33.5074"></a><span id="l33.5074">   mSendReport-&gt;Reset();</span>
<a href="#l33.5075"></a><span id="l33.5075">   mSendReport-&gt;SetDeliveryMode(mode);</span>
<a href="#l33.5076"></a><span id="l33.5076"> </span>
<a href="#l33.5077"></a><span id="l33.5077">   mParentWindow = nullptr;</span>
<a href="#l33.5078"></a><span id="l33.5078">   mSendProgress = nullptr;</span>
<a href="#l33.5079"></a><span id="l33.5079">   mListener = aListener;</span>
<a href="#l33.5080"></a><span id="l33.5080">   mEmbeddedObjectList = aEmbeddedObjects;</span>
<a href="#l33.5081"></a><span id="l33.5081"> </span>
<a href="#l33.5082"></a><span id="l33.5082" class="difflineminus">-  rv = Init(aUserIdentity, nullptr, (nsMsgCompFields *)aFields, nullptr,</span>
<a href="#l33.5083"></a><span id="l33.5083" class="difflineminus">-            false, true, mode, nullptr,</span>
<a href="#l33.5084"></a><span id="l33.5084" class="difflineminus">-            aMsgType,</span>
<a href="#l33.5085"></a><span id="l33.5085" class="difflineminus">-            aMsgBody,</span>
<a href="#l33.5086"></a><span id="l33.5086" class="difflineminus">-            nullptr, aAttachments,</span>
<a href="#l33.5087"></a><span id="l33.5087" class="difflineplus">+  rv = Init(aUserIdentity, nullptr, (nsMsgCompFields *)aFields, nullptr, false,</span>
<a href="#l33.5088"></a><span id="l33.5088" class="difflineplus">+            true, mode, nullptr, aMsgType, aMsgBody, nullptr, aAttachments,</span>
<a href="#l33.5089"></a><span id="l33.5089">             EmptyString(), EmptyCString(), nsIMsgCompType::New);</span>
<a href="#l33.5090"></a><span id="l33.5090"> </span>
<a href="#l33.5091"></a><span id="l33.5091">   if (NS_FAILED(rv) &amp;&amp; mSendReport)</span>
<a href="#l33.5092"></a><span id="l33.5092">     mSendReport-&gt;SetError(nsIMsgSendReport::process_Current, rv, false);</span>
<a href="#l33.5093"></a><span id="l33.5093"> </span>
<a href="#l33.5094"></a><span id="l33.5094">   return rv;</span>
<a href="#l33.5095"></a><span id="l33.5095"> }</span>
<a href="#l33.5096"></a><span id="l33.5096"> </span>
<a href="#l33.5097"></a><span id="l33.5097" class="difflineminus">-nsresult</span>
<a href="#l33.5098"></a><span id="l33.5098" class="difflineminus">-nsMsgComposeAndSend::SendMessageFile(</span>
<a href="#l33.5099"></a><span id="l33.5099" class="difflineminus">-              nsIMsgIdentity                    *aUserIndentity,</span>
<a href="#l33.5100"></a><span id="l33.5100" class="difflineminus">-              const char                        *aAccountKey,</span>
<a href="#l33.5101"></a><span id="l33.5101" class="difflineminus">-              nsIMsgCompFields                  *fields,</span>
<a href="#l33.5102"></a><span id="l33.5102" class="difflineminus">-              nsIFile                           *sendIFile,</span>
<a href="#l33.5103"></a><span id="l33.5103" class="difflineminus">-              bool                              deleteSendFileOnCompletion,</span>
<a href="#l33.5104"></a><span id="l33.5104" class="difflineminus">-              bool                              digest_p,</span>
<a href="#l33.5105"></a><span id="l33.5105" class="difflineminus">-              nsMsgDeliverMode                  mode,</span>
<a href="#l33.5106"></a><span id="l33.5106" class="difflineminus">-              nsIMsgDBHdr                       *msgToReplace,</span>
<a href="#l33.5107"></a><span id="l33.5107" class="difflineminus">-              nsIMsgSendListener                *aListener,</span>
<a href="#l33.5108"></a><span id="l33.5108" class="difflineminus">-              nsIMsgStatusFeedback              *aStatusFeedback,</span>
<a href="#l33.5109"></a><span id="l33.5109" class="difflineminus">-              const char16_t                    *password</span>
<a href="#l33.5110"></a><span id="l33.5110" class="difflineminus">-              )</span>
<a href="#l33.5111"></a><span id="l33.5111" class="difflineminus">-{</span>
<a href="#l33.5112"></a><span id="l33.5112" class="difflineplus">+nsresult nsMsgComposeAndSend::SendMessageFile(</span>
<a href="#l33.5113"></a><span id="l33.5113" class="difflineplus">+    nsIMsgIdentity *aUserIndentity, const char *aAccountKey,</span>
<a href="#l33.5114"></a><span id="l33.5114" class="difflineplus">+    nsIMsgCompFields *fields, nsIFile *sendIFile,</span>
<a href="#l33.5115"></a><span id="l33.5115" class="difflineplus">+    bool deleteSendFileOnCompletion, bool digest_p, nsMsgDeliverMode mode,</span>
<a href="#l33.5116"></a><span id="l33.5116" class="difflineplus">+    nsIMsgDBHdr *msgToReplace, nsIMsgSendListener *aListener,</span>
<a href="#l33.5117"></a><span id="l33.5117" class="difflineplus">+    nsIMsgStatusFeedback *aStatusFeedback, const char16_t *password) {</span>
<a href="#l33.5118"></a><span id="l33.5118">   NS_ENSURE_ARG_POINTER(fields);</span>
<a href="#l33.5119"></a><span id="l33.5119">   NS_ENSURE_ARG_POINTER(sendIFile);</span>
<a href="#l33.5120"></a><span id="l33.5120"> </span>
<a href="#l33.5121"></a><span id="l33.5121" class="difflineminus">-  nsresult      rv;</span>
<a href="#l33.5122"></a><span id="l33.5122" class="difflineplus">+  nsresult rv;</span>
<a href="#l33.5123"></a><span id="l33.5123"> </span>
<a href="#l33.5124"></a><span id="l33.5124">   /* First thing to do is to reset the send errors report */</span>
<a href="#l33.5125"></a><span id="l33.5125">   mSendReport-&gt;Reset();</span>
<a href="#l33.5126"></a><span id="l33.5126">   mSendReport-&gt;SetDeliveryMode(mode);</span>
<a href="#l33.5127"></a><span id="l33.5127"> </span>
<a href="#l33.5128"></a><span id="l33.5128">   mStatusFeedback = aStatusFeedback;</span>
<a href="#l33.5129"></a><span id="l33.5129">   //</span>
<a href="#l33.5130"></a><span id="l33.5130">   // First check to see if the external file we are sending is a valid file.</span>
<a href="#l33.5131"></a><span id="l33.5131">   //</span>
<a href="#l33.5132"></a><span id="l33.5132">   bool exists;</span>
<a href="#l33.5133"></a><span id="l33.5133" class="difflineminus">-  if (NS_FAILED(sendIFile-&gt;Exists(&amp;exists)))</span>
<a href="#l33.5134"></a><span id="l33.5134" class="difflineminus">-    return NS_ERROR_INVALID_ARG;</span>
<a href="#l33.5135"></a><span id="l33.5135" class="difflineminus">-</span>
<a href="#l33.5136"></a><span id="l33.5136" class="difflineminus">-  if (!exists)</span>
<a href="#l33.5137"></a><span id="l33.5137" class="difflineminus">-    return NS_ERROR_INVALID_ARG;</span>
<a href="#l33.5138"></a><span id="l33.5138" class="difflineplus">+  if (NS_FAILED(sendIFile-&gt;Exists(&amp;exists))) return NS_ERROR_INVALID_ARG;</span>
<a href="#l33.5139"></a><span id="l33.5139" class="difflineplus">+</span>
<a href="#l33.5140"></a><span id="l33.5140" class="difflineplus">+  if (!exists) return NS_ERROR_INVALID_ARG;</span>
<a href="#l33.5141"></a><span id="l33.5141"> </span>
<a href="#l33.5142"></a><span id="l33.5142">   // Setup the listener...</span>
<a href="#l33.5143"></a><span id="l33.5143">   mListener = aListener;</span>
<a href="#l33.5144"></a><span id="l33.5144"> </span>
<a href="#l33.5145"></a><span id="l33.5145">   // Should we delete the temp file when done?</span>
<a href="#l33.5146"></a><span id="l33.5146" class="difflineminus">-  if (!deleteSendFileOnCompletion)</span>
<a href="#l33.5147"></a><span id="l33.5147" class="difflineminus">-    mReturnFile = sendIFile;</span>
<a href="#l33.5148"></a><span id="l33.5148" class="difflineplus">+  if (!deleteSendFileOnCompletion) mReturnFile = sendIFile;</span>
<a href="#l33.5149"></a><span id="l33.5149"> </span>
<a href="#l33.5150"></a><span id="l33.5150">   rv = Init(aUserIndentity, aAccountKey, (nsMsgCompFields *)fields, sendIFile,</span>
<a href="#l33.5151"></a><span id="l33.5151" class="difflineminus">-            digest_p, false, mode, msgToReplace,</span>
<a href="#l33.5152"></a><span id="l33.5152" class="difflineminus">-            nullptr, EmptyCString(),</span>
<a href="#l33.5153"></a><span id="l33.5153" class="difflineplus">+            digest_p, false, mode, msgToReplace, nullptr, EmptyCString(),</span>
<a href="#l33.5154"></a><span id="l33.5154">             nullptr, nullptr,</span>
<a href="#l33.5155"></a><span id="l33.5155">             password ? nsDependentString(password) : EmptyString(),</span>
<a href="#l33.5156"></a><span id="l33.5156">             EmptyCString(), nsIMsgCompType::New);</span>
<a href="#l33.5157"></a><span id="l33.5157"> </span>
<a href="#l33.5158"></a><span id="l33.5158" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l33.5159"></a><span id="l33.5159" class="difflineminus">-    rv = DeliverMessage();</span>
<a href="#l33.5160"></a><span id="l33.5160" class="difflineplus">+  if (NS_SUCCEEDED(rv)) rv = DeliverMessage();</span>
<a href="#l33.5161"></a><span id="l33.5161"> </span>
<a href="#l33.5162"></a><span id="l33.5162">   if (NS_FAILED(rv) &amp;&amp; mSendReport)</span>
<a href="#l33.5163"></a><span id="l33.5163">     mSendReport-&gt;SetError(nsIMsgSendReport::process_Current, rv, false);</span>
<a href="#l33.5164"></a><span id="l33.5164"> </span>
<a href="#l33.5165"></a><span id="l33.5165">   return rv;</span>
<a href="#l33.5166"></a><span id="l33.5166"> }</span>
<a href="#l33.5167"></a><span id="l33.5167"> </span>
<a href="#l33.5168"></a><span id="l33.5168"> //</span>
<a href="#l33.5169"></a><span id="l33.5169"> // Send the message to the magic folder, and runs the completion/failure</span>
<a href="#l33.5170"></a><span id="l33.5170"> // callback.</span>
<a href="#l33.5171"></a><span id="l33.5171"> //</span>
<a href="#l33.5172"></a><span id="l33.5172" class="difflineminus">-nsresult</span>
<a href="#l33.5173"></a><span id="l33.5173" class="difflineminus">-nsMsgComposeAndSend::SendToMagicFolder(nsMsgDeliverMode mode)</span>
<a href="#l33.5174"></a><span id="l33.5174" class="difflineminus">-{</span>
<a href="#l33.5175"></a><span id="l33.5175" class="difflineminus">-    nsresult rv = MimeDoFCC(mTempFile,</span>
<a href="#l33.5176"></a><span id="l33.5176" class="difflineminus">-                            mode,</span>
<a href="#l33.5177"></a><span id="l33.5177" class="difflineminus">-                            mCompFields-&gt;GetBcc(),</span>
<a href="#l33.5178"></a><span id="l33.5178" class="difflineminus">-                            mCompFields-&gt;GetFcc(),</span>
<a href="#l33.5179"></a><span id="l33.5179" class="difflineminus">-                            mCompFields-&gt;GetNewspostUrl());</span>
<a href="#l33.5180"></a><span id="l33.5180" class="difflineminus">-    //</span>
<a href="#l33.5181"></a><span id="l33.5181" class="difflineminus">-    // The caller of MimeDoFCC needs to deal with failure.</span>
<a href="#l33.5182"></a><span id="l33.5182" class="difflineminus">-    //</span>
<a href="#l33.5183"></a><span id="l33.5183" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l33.5184"></a><span id="l33.5184" class="difflineminus">-      rv = NotifyListenerOnStopCopy(rv);</span>
<a href="#l33.5185"></a><span id="l33.5185" class="difflineminus">-</span>
<a href="#l33.5186"></a><span id="l33.5186" class="difflineminus">-    return rv;</span>
<a href="#l33.5187"></a><span id="l33.5187" class="difflineplus">+nsresult nsMsgComposeAndSend::SendToMagicFolder(nsMsgDeliverMode mode) {</span>
<a href="#l33.5188"></a><span id="l33.5188" class="difflineplus">+  nsresult rv = MimeDoFCC(mTempFile, mode, mCompFields-&gt;GetBcc(),</span>
<a href="#l33.5189"></a><span id="l33.5189" class="difflineplus">+                          mCompFields-&gt;GetFcc(), mCompFields-&gt;GetNewspostUrl());</span>
<a href="#l33.5190"></a><span id="l33.5190" class="difflineplus">+  //</span>
<a href="#l33.5191"></a><span id="l33.5191" class="difflineplus">+  // The caller of MimeDoFCC needs to deal with failure.</span>
<a href="#l33.5192"></a><span id="l33.5192" class="difflineplus">+  //</span>
<a href="#l33.5193"></a><span id="l33.5193" class="difflineplus">+  if (NS_FAILED(rv)) rv = NotifyListenerOnStopCopy(rv);</span>
<a href="#l33.5194"></a><span id="l33.5194" class="difflineplus">+</span>
<a href="#l33.5195"></a><span id="l33.5195" class="difflineplus">+  return rv;</span>
<a href="#l33.5196"></a><span id="l33.5196"> }</span>
<a href="#l33.5197"></a><span id="l33.5197"> </span>
<a href="#l33.5198"></a><span id="l33.5198" class="difflineminus">-char*</span>
<a href="#l33.5199"></a><span id="l33.5199" class="difflineminus">-nsMsgGetEnvelopeLine(void)</span>
<a href="#l33.5200"></a><span id="l33.5200" class="difflineminus">-{</span>
<a href="#l33.5201"></a><span id="l33.5201" class="difflineminus">-  static char       result[75] = &quot;&quot;;</span>
<a href="#l33.5202"></a><span id="l33.5202" class="difflineminus">-  PRExplodedTime    now;</span>
<a href="#l33.5203"></a><span id="l33.5203" class="difflineminus">-  char              buffer[128] = &quot;&quot;;</span>
<a href="#l33.5204"></a><span id="l33.5204" class="difflineplus">+char *nsMsgGetEnvelopeLine(void) {</span>
<a href="#l33.5205"></a><span id="l33.5205" class="difflineplus">+  static char result[75] = &quot;&quot;;</span>
<a href="#l33.5206"></a><span id="l33.5206" class="difflineplus">+  PRExplodedTime now;</span>
<a href="#l33.5207"></a><span id="l33.5207" class="difflineplus">+  char buffer[128] = &quot;&quot;;</span>
<a href="#l33.5208"></a><span id="l33.5208"> </span>
<a href="#l33.5209"></a><span id="l33.5209">   // Generate envelope line in format of:  From - Sat Apr 18 20:01:49 1998</span>
<a href="#l33.5210"></a><span id="l33.5210">   //</span>
<a href="#l33.5211"></a><span id="l33.5211">   // Use PR_FormatTimeUSEnglish() to format the date in US English format,</span>
<a href="#l33.5212"></a><span id="l33.5212">   // then figure out what our local GMT offset is, and append it (since</span>
<a href="#l33.5213"></a><span id="l33.5213">   // PR_FormatTimeUSEnglish() can't do that.) Generate four digit years as</span>
<a href="#l33.5214"></a><span id="l33.5214">   // per RFC 1123 (superseding RFC 822.)</span>
<a href="#l33.5215"></a><span id="l33.5215">   //</span>
<a href="#l33.5216"></a><span id="l33.5216">   PR_ExplodeTime(PR_Now(), PR_LocalTimeParameters, &amp;now);</span>
<a href="#l33.5217"></a><span id="l33.5217" class="difflineminus">-  PR_FormatTimeUSEnglish(buffer, sizeof(buffer),</span>
<a href="#l33.5218"></a><span id="l33.5218" class="difflineminus">-               &quot;%a %b %d %H:%M:%S %Y&quot;,</span>
<a href="#l33.5219"></a><span id="l33.5219" class="difflineminus">-               &amp;now);</span>
<a href="#l33.5220"></a><span id="l33.5220" class="difflineplus">+  PR_FormatTimeUSEnglish(buffer, sizeof(buffer), &quot;%a %b %d %H:%M:%S %Y&quot;, &amp;now);</span>
<a href="#l33.5221"></a><span id="l33.5221"> </span>
<a href="#l33.5222"></a><span id="l33.5222">   // This value must be in ctime() format, with English abbreviations.</span>
<a href="#l33.5223"></a><span id="l33.5223">   // PL_strftime(&quot;... %c ...&quot;) is no good, because it is localized.</span>
<a href="#l33.5224"></a><span id="l33.5224">   //</span>
<a href="#l33.5225"></a><span id="l33.5225">   PL_strcpy(result, &quot;From - &quot;);</span>
<a href="#l33.5226"></a><span id="l33.5226">   PL_strcpy(result + 7, buffer);</span>
<a href="#l33.5227"></a><span id="l33.5227">   PL_strcpy(result + 7 + 24, CRLF);</span>
<a href="#l33.5228"></a><span id="l33.5228">   return result;</span>
<a href="#l33.5229"></a><span id="l33.5229"> }</span>
<a href="#l33.5230"></a><span id="l33.5230"> </span>
<a href="#l33.5231"></a><span id="l33.5231"> #define ibuffer_size FILE_IO_BUFFER_SIZE</span>
<a href="#l33.5232"></a><span id="l33.5232" class="difflineminus">-nsresult</span>
<a href="#l33.5233"></a><span id="l33.5233" class="difflineminus">-nsMsgComposeAndSend::MimeDoFCC(nsIFile          *input_file,</span>
<a href="#l33.5234"></a><span id="l33.5234" class="difflineminus">-                               nsMsgDeliverMode mode,</span>
<a href="#l33.5235"></a><span id="l33.5235" class="difflineminus">-                               const char       *bcc_header,</span>
<a href="#l33.5236"></a><span id="l33.5236" class="difflineminus">-                               const char       *fcc_header,</span>
<a href="#l33.5237"></a><span id="l33.5237" class="difflineminus">-                               const char       *news_url)</span>
<a href="#l33.5238"></a><span id="l33.5238" class="difflineminus">-{</span>
<a href="#l33.5239"></a><span id="l33.5239" class="difflineminus">-  nsresult      status = NS_OK;</span>
<a href="#l33.5240"></a><span id="l33.5240" class="difflineminus">-  char          *ibuffer = nullptr;</span>
<a href="#l33.5241"></a><span id="l33.5241" class="difflineminus">-  uint32_t      n;</span>
<a href="#l33.5242"></a><span id="l33.5242" class="difflineminus">-  bool          folderIsLocal = true;</span>
<a href="#l33.5243"></a><span id="l33.5243" class="difflineminus">-  nsCString     tmpUri;</span>
<a href="#l33.5244"></a><span id="l33.5244" class="difflineminus">-  nsString      printfString;</span>
<a href="#l33.5245"></a><span id="l33.5245" class="difflineplus">+nsresult nsMsgComposeAndSend::MimeDoFCC(nsIFile *input_file,</span>
<a href="#l33.5246"></a><span id="l33.5246" class="difflineplus">+                                        nsMsgDeliverMode mode,</span>
<a href="#l33.5247"></a><span id="l33.5247" class="difflineplus">+                                        const char *bcc_header,</span>
<a href="#l33.5248"></a><span id="l33.5248" class="difflineplus">+                                        const char *fcc_header,</span>
<a href="#l33.5249"></a><span id="l33.5249" class="difflineplus">+                                        const char *news_url) {</span>
<a href="#l33.5250"></a><span id="l33.5250" class="difflineplus">+  nsresult status = NS_OK;</span>
<a href="#l33.5251"></a><span id="l33.5251" class="difflineplus">+  char *ibuffer = nullptr;</span>
<a href="#l33.5252"></a><span id="l33.5252" class="difflineplus">+  uint32_t n;</span>
<a href="#l33.5253"></a><span id="l33.5253" class="difflineplus">+  bool folderIsLocal = true;</span>
<a href="#l33.5254"></a><span id="l33.5254" class="difflineplus">+  nsCString tmpUri;</span>
<a href="#l33.5255"></a><span id="l33.5255" class="difflineplus">+  nsString printfString;</span>
<a href="#l33.5256"></a><span id="l33.5256">   nsString msg;</span>
<a href="#l33.5257"></a><span id="l33.5257">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l33.5258"></a><span id="l33.5258"> </span>
<a href="#l33.5259"></a><span id="l33.5259">   if (mSendProgress)</span>
<a href="#l33.5260"></a><span id="l33.5260">     mSendProgress-&gt;OnProgressChange(nullptr, nullptr, 0, 0, 0, -1);</span>
<a href="#l33.5261"></a><span id="l33.5261"> </span>
<a href="#l33.5262"></a><span id="l33.5262">   //</span>
<a href="#l33.5263"></a><span id="l33.5263">   // Ok, this is here to keep track of this for 2 copy operations...</span>
<a href="#l33.5264"></a><span id="l33.5264">   //</span>
<a href="#l33.5265"></a><span id="l33.5265" class="difflineminus">-  if (mCopyFile)</span>
<a href="#l33.5266"></a><span id="l33.5266" class="difflineminus">-  {</span>
<a href="#l33.5267"></a><span id="l33.5267" class="difflineplus">+  if (mCopyFile) {</span>
<a href="#l33.5268"></a><span id="l33.5268">     mCopyFile2 = mCopyFile;</span>
<a href="#l33.5269"></a><span id="l33.5269">     mCopyFile = nullptr;</span>
<a href="#l33.5270"></a><span id="l33.5270">   }</span>
<a href="#l33.5271"></a><span id="l33.5271"> </span>
<a href="#l33.5272"></a><span id="l33.5272">   //</span>
<a href="#l33.5273"></a><span id="l33.5273">   // Create the file that will be used for the copy service!</span>
<a href="#l33.5274"></a><span id="l33.5274">   //</span>
<a href="#l33.5275"></a><span id="l33.5275">   nsresult rv = nsMsgCreateTempFile(&quot;nscopy.tmp&quot;, getter_AddRefs(mCopyFile));</span>
<a href="#l33.5276"></a><span id="l33.5276">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l33.5277"></a><span id="l33.5277"> </span>
<a href="#l33.5278"></a><span id="l33.5278">   nsCOMPtr&lt;nsIOutputStream&gt; tempOutfile;</span>
<a href="#l33.5279"></a><span id="l33.5279" class="difflineminus">-  rv = MsgNewBufferedFileOutputStream(getter_AddRefs(tempOutfile), mCopyFile, -1, 00600);</span>
<a href="#l33.5280"></a><span id="l33.5280" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l33.5281"></a><span id="l33.5281" class="difflineminus">-  {</span>
<a href="#l33.5282"></a><span id="l33.5282" class="difflineminus">-    if (mSendReport)</span>
<a href="#l33.5283"></a><span id="l33.5283" class="difflineminus">-    {</span>
<a href="#l33.5284"></a><span id="l33.5284" class="difflineplus">+  rv = MsgNewBufferedFileOutputStream(getter_AddRefs(tempOutfile), mCopyFile,</span>
<a href="#l33.5285"></a><span id="l33.5285" class="difflineplus">+                                      -1, 00600);</span>
<a href="#l33.5286"></a><span id="l33.5286" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l33.5287"></a><span id="l33.5287" class="difflineplus">+    if (mSendReport) {</span>
<a href="#l33.5288"></a><span id="l33.5288">       nsAutoString error_msg;</span>
<a href="#l33.5289"></a><span id="l33.5289">       nsMsgBuildMessageWithTmpFile(mCopyFile, error_msg);</span>
<a href="#l33.5290"></a><span id="l33.5290" class="difflineminus">-      mSendReport-&gt;SetMessage(nsIMsgSendReport::process_Current, error_msg.get(), false);</span>
<a href="#l33.5291"></a><span id="l33.5291" class="difflineplus">+      mSendReport-&gt;SetMessage(nsIMsgSendReport::process_Current,</span>
<a href="#l33.5292"></a><span id="l33.5292" class="difflineplus">+                              error_msg.get(), false);</span>
<a href="#l33.5293"></a><span id="l33.5293">     }</span>
<a href="#l33.5294"></a><span id="l33.5294">     status = NS_MSG_UNABLE_TO_OPEN_TMP_FILE;</span>
<a href="#l33.5295"></a><span id="l33.5295"> </span>
<a href="#l33.5296"></a><span id="l33.5296">     mCopyFile = nullptr;</span>
<a href="#l33.5297"></a><span id="l33.5297">     return status;</span>
<a href="#l33.5298"></a><span id="l33.5298">   }</span>
<a href="#l33.5299"></a><span id="l33.5299"> </span>
<a href="#l33.5300"></a><span id="l33.5300">   //</span>
<a href="#l33.5301"></a><span id="l33.5301">   // Get our files ready...</span>
<a href="#l33.5302"></a><span id="l33.5302">   //</span>
<a href="#l33.5303"></a><span id="l33.5303">   nsCOMPtr&lt;nsIInputStream&gt; inputFile;</span>
<a href="#l33.5304"></a><span id="l33.5304">   rv = NS_NewLocalFileInputStream(getter_AddRefs(inputFile), input_file);</span>
<a href="#l33.5305"></a><span id="l33.5305" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l33.5306"></a><span id="l33.5306" class="difflineminus">-  {</span>
<a href="#l33.5307"></a><span id="l33.5307" class="difflineminus">-    if (mSendReport)</span>
<a href="#l33.5308"></a><span id="l33.5308" class="difflineminus">-    {</span>
<a href="#l33.5309"></a><span id="l33.5309" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l33.5310"></a><span id="l33.5310" class="difflineplus">+    if (mSendReport) {</span>
<a href="#l33.5311"></a><span id="l33.5311">       nsAutoString error_msg;</span>
<a href="#l33.5312"></a><span id="l33.5312">       nsMsgBuildMessageWithFile(input_file, error_msg);</span>
<a href="#l33.5313"></a><span id="l33.5313" class="difflineminus">-      mSendReport-&gt;SetMessage(nsIMsgSendReport::process_Current, error_msg.get(), false);</span>
<a href="#l33.5314"></a><span id="l33.5314" class="difflineplus">+      mSendReport-&gt;SetMessage(nsIMsgSendReport::process_Current,</span>
<a href="#l33.5315"></a><span id="l33.5315" class="difflineplus">+                              error_msg.get(), false);</span>
<a href="#l33.5316"></a><span id="l33.5316">     }</span>
<a href="#l33.5317"></a><span id="l33.5317">     status = NS_MSG_UNABLE_TO_OPEN_FILE;</span>
<a href="#l33.5318"></a><span id="l33.5318">     goto FAIL;</span>
<a href="#l33.5319"></a><span id="l33.5319">   }</span>
<a href="#l33.5320"></a><span id="l33.5320"> </span>
<a href="#l33.5321"></a><span id="l33.5321">   // now the buffers...</span>
<a href="#l33.5322"></a><span id="l33.5322" class="difflineminus">-  ibuffer = (char *) PR_Malloc(ibuffer_size);</span>
<a href="#l33.5323"></a><span id="l33.5323" class="difflineminus">-  if (!ibuffer)</span>
<a href="#l33.5324"></a><span id="l33.5324" class="difflineminus">-  {</span>
<a href="#l33.5325"></a><span id="l33.5325" class="difflineplus">+  ibuffer = (char *)PR_Malloc(ibuffer_size);</span>
<a href="#l33.5326"></a><span id="l33.5326" class="difflineplus">+  if (!ibuffer) {</span>
<a href="#l33.5327"></a><span id="l33.5327">     status = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l33.5328"></a><span id="l33.5328">     goto FAIL;</span>
<a href="#l33.5329"></a><span id="l33.5329">   }</span>
<a href="#l33.5330"></a><span id="l33.5330"> </span>
<a href="#l33.5331"></a><span id="l33.5331">   //</span>
<a href="#l33.5332"></a><span id="l33.5332">   // First, we we need to put a Berkeley &quot;From - &quot; delimiter at the head of</span>
<a href="#l33.5333"></a><span id="l33.5333">   // the file for parsing...</span>
<a href="#l33.5334"></a><span id="l33.5334">   //</span>
<a href="#l33.5335"></a><span id="l33.5335" class="difflineat">@@ -4353,194 +3918,171 @@ nsMsgComposeAndSend::MimeDoFCC(nsIFile  </span>
<a href="#l33.5336"></a><span id="l33.5336">   if (fcc_header &amp;&amp; *fcc_header) {</span>
<a href="#l33.5337"></a><span id="l33.5337">     rv = FindFolder(nsDependentCString(fcc_header), getter_AddRefs(folder));</span>
<a href="#l33.5338"></a><span id="l33.5338">     if (NS_FAILED(rv)) {</span>
<a href="#l33.5339"></a><span id="l33.5339">       status = rv;</span>
<a href="#l33.5340"></a><span id="l33.5340">       goto FAIL;</span>
<a href="#l33.5341"></a><span id="l33.5341">     }</span>
<a href="#l33.5342"></a><span id="l33.5342">   }</span>
<a href="#l33.5343"></a><span id="l33.5343"> </span>
<a href="#l33.5344"></a><span id="l33.5344" class="difflineminus">-  if ((mode == nsMsgDeliverNow || mode == nsMsgSendUnsent) &amp;&amp; folder)</span>
<a href="#l33.5345"></a><span id="l33.5345" class="difflineminus">-  {</span>
<a href="#l33.5346"></a><span id="l33.5346" class="difflineplus">+  if ((mode == nsMsgDeliverNow || mode == nsMsgSendUnsent) &amp;&amp; folder) {</span>
<a href="#l33.5347"></a><span id="l33.5347">     tmpUri = fcc_header;</span>
<a href="#l33.5348"></a><span id="l33.5348" class="difflineminus">-  }</span>
<a href="#l33.5349"></a><span id="l33.5349" class="difflineminus">-  else if (!fcc_header)</span>
<a href="#l33.5350"></a><span id="l33.5350" class="difflineminus">-  {</span>
<a href="#l33.5351"></a><span id="l33.5351" class="difflineplus">+  } else if (!fcc_header) {</span>
<a href="#l33.5352"></a><span id="l33.5352">     // Set fcc_header to a special folder in Local Folders &quot;account&quot; since can't</span>
<a href="#l33.5353"></a><span id="l33.5353">     // save to Sent mbox, typically because imap connection is down. This</span>
<a href="#l33.5354"></a><span id="l33.5354">     // folder is created if it doesn't yet exist.</span>
<a href="#l33.5355"></a><span id="l33.5355"> </span>
<a href="#l33.5356"></a><span id="l33.5356">     nsCString folder;</span>
<a href="#l33.5357"></a><span id="l33.5357">     // First, in folder string, obtain the uri for the local folders account</span>
<a href="#l33.5358"></a><span id="l33.5358">     // which is typically &quot;mailbox://nobody@Local%20Folders/&quot;</span>
<a href="#l33.5359"></a><span id="l33.5359">     nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l33.5360"></a><span id="l33.5360" class="difflineminus">-      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l33.5361"></a><span id="l33.5361" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; accountManager)</span>
<a href="#l33.5362"></a><span id="l33.5362" class="difflineminus">-    {</span>
<a href="#l33.5363"></a><span id="l33.5363" class="difflineplus">+        do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l33.5364"></a><span id="l33.5364" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; accountManager) {</span>
<a href="#l33.5365"></a><span id="l33.5365">       nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l33.5366"></a><span id="l33.5366">       rv = accountManager-&gt;GetLocalFoldersServer(getter_AddRefs(server));</span>
<a href="#l33.5367"></a><span id="l33.5367" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; server)</span>
<a href="#l33.5368"></a><span id="l33.5368" class="difflineminus">-      {</span>
<a href="#l33.5369"></a><span id="l33.5369" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; server) {</span>
<a href="#l33.5370"></a><span id="l33.5370">         nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l33.5371"></a><span id="l33.5371">         rv = server-&gt;GetRootMsgFolder(getter_AddRefs(rootFolder));</span>
<a href="#l33.5372"></a><span id="l33.5372" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; rootFolder)</span>
<a href="#l33.5373"></a><span id="l33.5373" class="difflineminus">-        {</span>
<a href="#l33.5374"></a><span id="l33.5374" class="difflineplus">+        if (NS_SUCCEEDED(rv) &amp;&amp; rootFolder) {</span>
<a href="#l33.5375"></a><span id="l33.5375">           rv = rootFolder-&gt;GetURI(folder);</span>
<a href="#l33.5376"></a><span id="l33.5376">           folder.Append('/');</span>
<a href="#l33.5377"></a><span id="l33.5377">         }</span>
<a href="#l33.5378"></a><span id="l33.5378">       }</span>
<a href="#l33.5379"></a><span id="l33.5379">     }</span>
<a href="#l33.5380"></a><span id="l33.5380" class="difflineminus">-    if (NS_FAILED(rv) || folder.IsEmpty())</span>
<a href="#l33.5381"></a><span id="l33.5381" class="difflineminus">-    {</span>
<a href="#l33.5382"></a><span id="l33.5382" class="difflineplus">+    if (NS_FAILED(rv) || folder.IsEmpty()) {</span>
<a href="#l33.5383"></a><span id="l33.5383">       status = NS_ERROR_FAILURE;</span>
<a href="#l33.5384"></a><span id="l33.5384">       goto FAIL;</span>
<a href="#l33.5385"></a><span id="l33.5385">     }</span>
<a href="#l33.5386"></a><span id="l33.5386"> </span>
<a href="#l33.5387"></a><span id="l33.5387">     // Now append the special folder name folder to the local folder uri.</span>
<a href="#l33.5388"></a><span id="l33.5388" class="difflineminus">-    switch (m_deliver_mode)</span>
<a href="#l33.5389"></a><span id="l33.5389" class="difflineminus">-    {</span>
<a href="#l33.5390"></a><span id="l33.5390" class="difflineplus">+    switch (m_deliver_mode) {</span>
<a href="#l33.5391"></a><span id="l33.5391">       case nsMsgDeliverNow:</span>
<a href="#l33.5392"></a><span id="l33.5392">       case nsMsgSendUnsent:</span>
<a href="#l33.5393"></a><span id="l33.5393">       case nsMsgSaveAsDraft:</span>
<a href="#l33.5394"></a><span id="l33.5394">       case nsMsgSaveAsTemplate:</span>
<a href="#l33.5395"></a><span id="l33.5395">         // Typically, this appends &quot;Sent-&quot;, &quot;Drafts-&quot; or &quot;Templates-&quot; to folder</span>
<a href="#l33.5396"></a><span id="l33.5396">         // and then has the account name appended, e.g., .../Sent-MyImapAccount.</span>
<a href="#l33.5397"></a><span id="l33.5397">         folder.Append(NS_ConvertUTF16toUTF8(mSavedToFolderName));</span>
<a href="#l33.5398"></a><span id="l33.5398">         folder.Append('-');</span>
<a href="#l33.5399"></a><span id="l33.5399">         break;</span>
<a href="#l33.5400"></a><span id="l33.5400">       default:</span>
<a href="#l33.5401"></a><span id="l33.5401">         status = NS_ERROR_FAILURE;</span>
<a href="#l33.5402"></a><span id="l33.5402">         goto FAIL;</span>
<a href="#l33.5403"></a><span id="l33.5403">     }</span>
<a href="#l33.5404"></a><span id="l33.5404"> </span>
<a href="#l33.5405"></a><span id="l33.5405">     // Get the account name where the &quot;save to&quot; failed.</span>
<a href="#l33.5406"></a><span id="l33.5406">     nsString accountName;</span>
<a href="#l33.5407"></a><span id="l33.5407" class="difflineminus">-    const char* fcc = mCompFields-&gt;GetFcc();</span>
<a href="#l33.5408"></a><span id="l33.5408" class="difflineminus">-    if (fcc &amp;&amp; *fcc)</span>
<a href="#l33.5409"></a><span id="l33.5409" class="difflineminus">-    {</span>
<a href="#l33.5410"></a><span id="l33.5410" class="difflineplus">+    const char *fcc = mCompFields-&gt;GetFcc();</span>
<a href="#l33.5411"></a><span id="l33.5411" class="difflineplus">+    if (fcc &amp;&amp; *fcc) {</span>
<a href="#l33.5412"></a><span id="l33.5412">       nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l33.5413"></a><span id="l33.5413">       rv = GetIncomingServer(fcc, getter_AddRefs(server));</span>
<a href="#l33.5414"></a><span id="l33.5414" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; server)</span>
<a href="#l33.5415"></a><span id="l33.5415" class="difflineminus">-      {</span>
<a href="#l33.5416"></a><span id="l33.5416" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; server) {</span>
<a href="#l33.5417"></a><span id="l33.5417">         rv = server-&gt;GetPrettyName(accountName);</span>
<a href="#l33.5418"></a><span id="l33.5418">       }</span>
<a href="#l33.5419"></a><span id="l33.5419" class="difflineminus">-    }</span>
<a href="#l33.5420"></a><span id="l33.5420" class="difflineminus">-    else</span>
<a href="#l33.5421"></a><span id="l33.5421" class="difflineplus">+    } else</span>
<a href="#l33.5422"></a><span id="l33.5422">       rv = NS_ERROR_FAILURE;</span>
<a href="#l33.5423"></a><span id="l33.5423" class="difflineminus">-    if (NS_FAILED(rv) || accountName.IsEmpty())</span>
<a href="#l33.5424"></a><span id="l33.5424" class="difflineminus">-    {</span>
<a href="#l33.5425"></a><span id="l33.5425" class="difflineplus">+    if (NS_FAILED(rv) || accountName.IsEmpty()) {</span>
<a href="#l33.5426"></a><span id="l33.5426">       status = NS_ERROR_FAILURE;</span>
<a href="#l33.5427"></a><span id="l33.5427">       goto FAIL;</span>
<a href="#l33.5428"></a><span id="l33.5428">     }</span>
<a href="#l33.5429"></a><span id="l33.5429"> </span>
<a href="#l33.5430"></a><span id="l33.5430">     // Now append the imap account name (escaped) to the folder uri.</span>
<a href="#l33.5431"></a><span id="l33.5431">     nsCString escAccountName;</span>
<a href="#l33.5432"></a><span id="l33.5432" class="difflineminus">-    MsgEscapeString(NS_ConvertUTF16toUTF8(accountName), nsINetUtil::ESCAPE_URL_PATH, escAccountName);</span>
<a href="#l33.5433"></a><span id="l33.5433" class="difflineplus">+    MsgEscapeString(NS_ConvertUTF16toUTF8(accountName),</span>
<a href="#l33.5434"></a><span id="l33.5434" class="difflineplus">+                    nsINetUtil::ESCAPE_URL_PATH, escAccountName);</span>
<a href="#l33.5435"></a><span id="l33.5435">     folder += escAccountName;</span>
<a href="#l33.5436"></a><span id="l33.5436">     fcc_header = ToNewCString(folder);</span>
<a href="#l33.5437"></a><span id="l33.5437">     tmpUri = fcc_header;</span>
<a href="#l33.5438"></a><span id="l33.5438" class="difflineminus">-  }</span>
<a href="#l33.5439"></a><span id="l33.5439" class="difflineminus">-  else</span>
<a href="#l33.5440"></a><span id="l33.5440" class="difflineminus">-  {</span>
<a href="#l33.5441"></a><span id="l33.5441" class="difflineplus">+  } else {</span>
<a href="#l33.5442"></a><span id="l33.5442">     GetFolderURIFromUserPrefs(mode, mUserIdentity, tmpUri);</span>
<a href="#l33.5443"></a><span id="l33.5443">   }</span>
<a href="#l33.5444"></a><span id="l33.5444" class="difflineminus">-  status = MessageFolderIsLocal(mUserIdentity, mode, tmpUri.get(), &amp;folderIsLocal);</span>
<a href="#l33.5445"></a><span id="l33.5445" class="difflineminus">-  if (NS_FAILED(status))</span>
<a href="#l33.5446"></a><span id="l33.5446" class="difflineminus">-    goto FAIL;</span>
<a href="#l33.5447"></a><span id="l33.5447" class="difflineplus">+  status =</span>
<a href="#l33.5448"></a><span id="l33.5448" class="difflineplus">+      MessageFolderIsLocal(mUserIdentity, mode, tmpUri.get(), &amp;folderIsLocal);</span>
<a href="#l33.5449"></a><span id="l33.5449" class="difflineplus">+  if (NS_FAILED(status)) goto FAIL;</span>
<a href="#l33.5450"></a><span id="l33.5450"> </span>
<a href="#l33.5451"></a><span id="l33.5451">   // Tell the user we are copying the message...</span>
<a href="#l33.5452"></a><span id="l33.5452">   mComposeBundle-&gt;GetStringFromName(&quot;copyMessageStart&quot;, msg);</span>
<a href="#l33.5453"></a><span id="l33.5453" class="difflineminus">-  if (!msg.IsEmpty())</span>
<a href="#l33.5454"></a><span id="l33.5454" class="difflineminus">-  {</span>
<a href="#l33.5455"></a><span id="l33.5455" class="difflineplus">+  if (!msg.IsEmpty()) {</span>
<a href="#l33.5456"></a><span id="l33.5456">     nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l33.5457"></a><span id="l33.5457">     rv = GetOrCreateFolder(tmpUri, getter_AddRefs(folder));</span>
<a href="#l33.5458"></a><span id="l33.5458">     if (NS_FAILED(rv)) {</span>
<a href="#l33.5459"></a><span id="l33.5459">       status = rv;</span>
<a href="#l33.5460"></a><span id="l33.5460">       goto FAIL;</span>
<a href="#l33.5461"></a><span id="l33.5461">     }</span>
<a href="#l33.5462"></a><span id="l33.5462">     folder-&gt;GetName(mSavedToFolderName);</span>
<a href="#l33.5463"></a><span id="l33.5463">     if (!mSavedToFolderName.IsEmpty())</span>
<a href="#l33.5464"></a><span id="l33.5464">       nsTextFormatter::ssprintf(printfString, msg.get(),</span>
<a href="#l33.5465"></a><span id="l33.5465">                                 mSavedToFolderName.get());</span>
<a href="#l33.5466"></a><span id="l33.5466">     else</span>
<a href="#l33.5467"></a><span id="l33.5467">       nsTextFormatter::ssprintf(printfString, msg.get(), &quot;?&quot;);</span>
<a href="#l33.5468"></a><span id="l33.5468">     SetStatusMessage(printfString);</span>
<a href="#l33.5469"></a><span id="l33.5469">   }</span>
<a href="#l33.5470"></a><span id="l33.5470"> </span>
<a href="#l33.5471"></a><span id="l33.5471" class="difflineminus">-  if (folderIsLocal)</span>
<a href="#l33.5472"></a><span id="l33.5472" class="difflineminus">-  {</span>
<a href="#l33.5473"></a><span id="l33.5473" class="difflineplus">+  if (folderIsLocal) {</span>
<a href="#l33.5474"></a><span id="l33.5474">     char *envelopeLine = nsMsgGetEnvelopeLine();</span>
<a href="#l33.5475"></a><span id="l33.5475" class="difflineminus">-    uint32_t   len = PL_strlen(envelopeLine);</span>
<a href="#l33.5476"></a><span id="l33.5476" class="difflineplus">+    uint32_t len = PL_strlen(envelopeLine);</span>
<a href="#l33.5477"></a><span id="l33.5477"> </span>
<a href="#l33.5478"></a><span id="l33.5478">     rv = tempOutfile-&gt;Write(envelopeLine, len, &amp;n);</span>
<a href="#l33.5479"></a><span id="l33.5479" class="difflineminus">-    if (NS_FAILED(rv) || n != len)</span>
<a href="#l33.5480"></a><span id="l33.5480" class="difflineminus">-    {</span>
<a href="#l33.5481"></a><span id="l33.5481" class="difflineplus">+    if (NS_FAILED(rv) || n != len) {</span>
<a href="#l33.5482"></a><span id="l33.5482">       status = NS_ERROR_FAILURE;</span>
<a href="#l33.5483"></a><span id="l33.5483">       goto FAIL;</span>
<a href="#l33.5484"></a><span id="l33.5484">     }</span>
<a href="#l33.5485"></a><span id="l33.5485">   }</span>
<a href="#l33.5486"></a><span id="l33.5486"> </span>
<a href="#l33.5487"></a><span id="l33.5487">   //</span>
<a href="#l33.5488"></a><span id="l33.5488">   // Write out an X-Mozilla-Status header.</span>
<a href="#l33.5489"></a><span id="l33.5489">   //</span>
<a href="#l33.5490"></a><span id="l33.5490">   // This is required for the queue file, so that we can overwrite it once</span>
<a href="#l33.5491"></a><span id="l33.5491" class="difflineminus">-  // the messages have been delivered, and so that the nsMsgMessageFlags::Queued bit</span>
<a href="#l33.5492"></a><span id="l33.5492" class="difflineminus">-  // is set.</span>
<a href="#l33.5493"></a><span id="l33.5493" class="difflineplus">+  // the messages have been delivered, and so that the nsMsgMessageFlags::Queued</span>
<a href="#l33.5494"></a><span id="l33.5494" class="difflineplus">+  // bit is set.</span>
<a href="#l33.5495"></a><span id="l33.5495">   //</span>
<a href="#l33.5496"></a><span id="l33.5496">   // For FCC files, we don't necessarily need one, but we might as well put</span>
<a href="#l33.5497"></a><span id="l33.5497">   // one in so that it's marked as read already.</span>
<a href="#l33.5498"></a><span id="l33.5498">   //</span>
<a href="#l33.5499"></a><span id="l33.5499">   //</span>
<a href="#l33.5500"></a><span id="l33.5500">   // Need to add these lines for POP3 ONLY! IMAP servers will handle</span>
<a href="#l33.5501"></a><span id="l33.5501">   // this status information for summary file regeneration for us.</span>
<a href="#l33.5502"></a><span id="l33.5502">   if ((mode == nsMsgQueueForLater || mode == nsMsgSaveAsDraft ||</span>
<a href="#l33.5503"></a><span id="l33.5503">        mode == nsMsgSaveAsTemplate || mode == nsMsgDeliverNow ||</span>
<a href="#l33.5504"></a><span id="l33.5504">        mode == nsMsgSendUnsent || mode == nsMsgDeliverBackground) &amp;&amp;</span>
<a href="#l33.5505"></a><span id="l33.5505" class="difflineminus">-      folderIsLocal)</span>
<a href="#l33.5506"></a><span id="l33.5506" class="difflineminus">-  {</span>
<a href="#l33.5507"></a><span id="l33.5507" class="difflineminus">-    char       *buf = 0;</span>
<a href="#l33.5508"></a><span id="l33.5508" class="difflineminus">-    uint16_t   flags = 0;</span>
<a href="#l33.5509"></a><span id="l33.5509" class="difflineplus">+      folderIsLocal) {</span>
<a href="#l33.5510"></a><span id="l33.5510" class="difflineplus">+    char *buf = 0;</span>
<a href="#l33.5511"></a><span id="l33.5511" class="difflineplus">+    uint16_t flags = 0;</span>
<a href="#l33.5512"></a><span id="l33.5512"> </span>
<a href="#l33.5513"></a><span id="l33.5513">     // for save as draft and send later, we want to leave the message as unread.</span>
<a href="#l33.5514"></a><span id="l33.5514">     // See Bug #198087</span>
<a href="#l33.5515"></a><span id="l33.5515">     // Messages sent with mode nsMsgDeliverBackground must not have the Queued</span>
<a href="#l33.5516"></a><span id="l33.5516">     // flag sent so that they get picked up by the background send function.</span>
<a href="#l33.5517"></a><span id="l33.5517">     if (mode == nsMsgQueueForLater)</span>
<a href="#l33.5518"></a><span id="l33.5518">       flags |= nsMsgMessageFlags::Queued;</span>
<a href="#l33.5519"></a><span id="l33.5519">     else if (mode != nsMsgSaveAsDraft &amp;&amp; mode != nsMsgDeliverBackground)</span>
<a href="#l33.5520"></a><span id="l33.5520">       flags |= nsMsgMessageFlags::Read;</span>
<a href="#l33.5521"></a><span id="l33.5521">     buf = PR_smprintf(X_MOZILLA_STATUS_FORMAT CRLF, flags);</span>
<a href="#l33.5522"></a><span id="l33.5522" class="difflineminus">-    if (buf)</span>
<a href="#l33.5523"></a><span id="l33.5523" class="difflineminus">-    {</span>
<a href="#l33.5524"></a><span id="l33.5524" class="difflineminus">-      uint32_t   len = PL_strlen(buf);</span>
<a href="#l33.5525"></a><span id="l33.5525" class="difflineplus">+    if (buf) {</span>
<a href="#l33.5526"></a><span id="l33.5526" class="difflineplus">+      uint32_t len = PL_strlen(buf);</span>
<a href="#l33.5527"></a><span id="l33.5527">       rv = tempOutfile-&gt;Write(buf, len, &amp;n);</span>
<a href="#l33.5528"></a><span id="l33.5528">       PR_Free(buf);</span>
<a href="#l33.5529"></a><span id="l33.5529" class="difflineminus">-      if (NS_FAILED(rv) || n != len)</span>
<a href="#l33.5530"></a><span id="l33.5530" class="difflineminus">-      {</span>
<a href="#l33.5531"></a><span id="l33.5531" class="difflineplus">+      if (NS_FAILED(rv) || n != len) {</span>
<a href="#l33.5532"></a><span id="l33.5532">         status = NS_ERROR_FAILURE;</span>
<a href="#l33.5533"></a><span id="l33.5533">         goto FAIL;</span>
<a href="#l33.5534"></a><span id="l33.5534">       }</span>
<a href="#l33.5535"></a><span id="l33.5535">     }</span>
<a href="#l33.5536"></a><span id="l33.5536"> </span>
<a href="#l33.5537"></a><span id="l33.5537">     uint32_t flags2 = 0;</span>
<a href="#l33.5538"></a><span id="l33.5538" class="difflineminus">-    if (mode == nsMsgSaveAsTemplate)</span>
<a href="#l33.5539"></a><span id="l33.5539" class="difflineminus">-      flags2 |= nsMsgMessageFlags::Template;</span>
<a href="#l33.5540"></a><span id="l33.5540" class="difflineminus">-    if (mode == nsMsgDeliverNow || mode == nsMsgSendUnsent)</span>
<a href="#l33.5541"></a><span id="l33.5541" class="difflineminus">-    {</span>
<a href="#l33.5542"></a><span id="l33.5542" class="difflineplus">+    if (mode == nsMsgSaveAsTemplate) flags2 |= nsMsgMessageFlags::Template;</span>
<a href="#l33.5543"></a><span id="l33.5543" class="difflineplus">+    if (mode == nsMsgDeliverNow || mode == nsMsgSendUnsent) {</span>
<a href="#l33.5544"></a><span id="l33.5544">       flags2 &amp;= ~nsMsgMessageFlags::MDNReportNeeded;</span>
<a href="#l33.5545"></a><span id="l33.5545">       flags2 |= nsMsgMessageFlags::MDNReportSent;</span>
<a href="#l33.5546"></a><span id="l33.5546">     }</span>
<a href="#l33.5547"></a><span id="l33.5547">     buf = PR_smprintf(X_MOZILLA_STATUS2_FORMAT CRLF, flags2);</span>
<a href="#l33.5548"></a><span id="l33.5548" class="difflineminus">-    if (buf)</span>
<a href="#l33.5549"></a><span id="l33.5549" class="difflineminus">-    {</span>
<a href="#l33.5550"></a><span id="l33.5550" class="difflineminus">-      uint32_t   len = PL_strlen(buf);</span>
<a href="#l33.5551"></a><span id="l33.5551" class="difflineplus">+    if (buf) {</span>
<a href="#l33.5552"></a><span id="l33.5552" class="difflineplus">+      uint32_t len = PL_strlen(buf);</span>
<a href="#l33.5553"></a><span id="l33.5553">       rv = tempOutfile-&gt;Write(buf, len, &amp;n);</span>
<a href="#l33.5554"></a><span id="l33.5554">       PR_Free(buf);</span>
<a href="#l33.5555"></a><span id="l33.5555" class="difflineminus">-      if (NS_FAILED(rv) || n != len)</span>
<a href="#l33.5556"></a><span id="l33.5556" class="difflineminus">-      {</span>
<a href="#l33.5557"></a><span id="l33.5557" class="difflineplus">+      if (NS_FAILED(rv) || n != len) {</span>
<a href="#l33.5558"></a><span id="l33.5558">         status = NS_ERROR_FAILURE;</span>
<a href="#l33.5559"></a><span id="l33.5559">         goto FAIL;</span>
<a href="#l33.5560"></a><span id="l33.5560">       }</span>
<a href="#l33.5561"></a><span id="l33.5561">     }</span>
<a href="#l33.5562"></a><span id="l33.5562">     tempOutfile-&gt;Write(X_MOZILLA_KEYWORDS, sizeof(X_MOZILLA_KEYWORDS) - 1, &amp;n);</span>
<a href="#l33.5563"></a><span id="l33.5563">   }</span>
<a href="#l33.5564"></a><span id="l33.5564"> </span>
<a href="#l33.5565"></a><span id="l33.5565">   // Write out the FCC and BCC headers.</span>
<a href="#l33.5566"></a><span id="l33.5566" class="difflineat">@@ -4566,159 +4108,141 @@ nsMsgComposeAndSend::MimeDoFCC(nsIFile  </span>
<a href="#l33.5567"></a><span id="l33.5567">   // Thus the consultation of the #define SAVE_BCC_IN_FCC_FILE.</span>
<a href="#l33.5568"></a><span id="l33.5568">   //</span>
<a href="#l33.5569"></a><span id="l33.5569">   // (Note that, if there is a BCC header present in a message in some random</span>
<a href="#l33.5570"></a><span id="l33.5570">   // folder, and that message is forwarded to someone, then the attachment</span>
<a href="#l33.5571"></a><span id="l33.5571">   // code will strip out the BCC header before forwarding it.)</span>
<a href="#l33.5572"></a><span id="l33.5572">   //</span>
<a href="#l33.5573"></a><span id="l33.5573">   if ((mode == nsMsgQueueForLater || mode == nsMsgDeliverBackground ||</span>
<a href="#l33.5574"></a><span id="l33.5574">        mode == nsMsgSaveAsDraft || mode == nsMsgSaveAsTemplate) &amp;&amp;</span>
<a href="#l33.5575"></a><span id="l33.5575" class="difflineminus">-      fcc_header &amp;&amp; *fcc_header)</span>
<a href="#l33.5576"></a><span id="l33.5576" class="difflineminus">-  {</span>
<a href="#l33.5577"></a><span id="l33.5577" class="difflineplus">+      fcc_header &amp;&amp; *fcc_header) {</span>
<a href="#l33.5578"></a><span id="l33.5578">     int32_t L = PL_strlen(fcc_header) + 20;</span>
<a href="#l33.5579"></a><span id="l33.5579" class="difflineminus">-    char  *buf = (char *) PR_Malloc (L);</span>
<a href="#l33.5580"></a><span id="l33.5580" class="difflineminus">-    if (!buf)</span>
<a href="#l33.5581"></a><span id="l33.5581" class="difflineminus">-    {</span>
<a href="#l33.5582"></a><span id="l33.5582" class="difflineplus">+    char *buf = (char *)PR_Malloc(L);</span>
<a href="#l33.5583"></a><span id="l33.5583" class="difflineplus">+    if (!buf) {</span>
<a href="#l33.5584"></a><span id="l33.5584">       status = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l33.5585"></a><span id="l33.5585">       goto FAIL;</span>
<a href="#l33.5586"></a><span id="l33.5586">     }</span>
<a href="#l33.5587"></a><span id="l33.5587"> </span>
<a href="#l33.5588"></a><span id="l33.5588" class="difflineminus">-    PR_snprintf(buf, L-1, &quot;FCC: %s&quot; CRLF, fcc_header);</span>
<a href="#l33.5589"></a><span id="l33.5589" class="difflineminus">-</span>
<a href="#l33.5590"></a><span id="l33.5590" class="difflineminus">-    uint32_t   len = PL_strlen(buf);</span>
<a href="#l33.5591"></a><span id="l33.5591" class="difflineplus">+    PR_snprintf(buf, L - 1, &quot;FCC: %s&quot; CRLF, fcc_header);</span>
<a href="#l33.5592"></a><span id="l33.5592" class="difflineplus">+</span>
<a href="#l33.5593"></a><span id="l33.5593" class="difflineplus">+    uint32_t len = PL_strlen(buf);</span>
<a href="#l33.5594"></a><span id="l33.5594">     rv = tempOutfile-&gt;Write(buf, len, &amp;n);</span>
<a href="#l33.5595"></a><span id="l33.5595" class="difflineminus">-    if (NS_FAILED(rv) || n != len)</span>
<a href="#l33.5596"></a><span id="l33.5596" class="difflineminus">-    {</span>
<a href="#l33.5597"></a><span id="l33.5597" class="difflineplus">+    if (NS_FAILED(rv) || n != len) {</span>
<a href="#l33.5598"></a><span id="l33.5598">       status = NS_ERROR_FAILURE;</span>
<a href="#l33.5599"></a><span id="l33.5599">       goto FAIL;</span>
<a href="#l33.5600"></a><span id="l33.5600">     }</span>
<a href="#l33.5601"></a><span id="l33.5601">   }</span>
<a href="#l33.5602"></a><span id="l33.5602"> </span>
<a href="#l33.5603"></a><span id="l33.5603">   //</span>
<a href="#l33.5604"></a><span id="l33.5604">   // Ok, now I want to get the identity key and write it out if this is for a</span>
<a href="#l33.5605"></a><span id="l33.5605">   // nsMsgQueueForLater operation!</span>
<a href="#l33.5606"></a><span id="l33.5606">   //</span>
<a href="#l33.5607"></a><span id="l33.5607">   if ((nsMsgQueueForLater == mode || nsMsgSaveAsDraft == mode ||</span>
<a href="#l33.5608"></a><span id="l33.5608">        nsMsgDeliverBackground == mode || nsMsgSaveAsTemplate == mode) &amp;&amp;</span>
<a href="#l33.5609"></a><span id="l33.5609" class="difflineminus">-      mUserIdentity)</span>
<a href="#l33.5610"></a><span id="l33.5610" class="difflineminus">-  {</span>
<a href="#l33.5611"></a><span id="l33.5611" class="difflineplus">+      mUserIdentity) {</span>
<a href="#l33.5612"></a><span id="l33.5612">     char *buf = nullptr;</span>
<a href="#l33.5613"></a><span id="l33.5613">     nsCString key;</span>
<a href="#l33.5614"></a><span id="l33.5614"> </span>
<a href="#l33.5615"></a><span id="l33.5615" class="difflineminus">-    if (NS_SUCCEEDED(mUserIdentity-&gt;GetKey(key)) &amp;&amp; !key.IsEmpty())</span>
<a href="#l33.5616"></a><span id="l33.5616" class="difflineminus">-    {</span>
<a href="#l33.5617"></a><span id="l33.5617" class="difflineplus">+    if (NS_SUCCEEDED(mUserIdentity-&gt;GetKey(key)) &amp;&amp; !key.IsEmpty()) {</span>
<a href="#l33.5618"></a><span id="l33.5618">       buf = PR_smprintf(HEADER_X_MOZILLA_IDENTITY_KEY &quot;: %s&quot; CRLF, key.get());</span>
<a href="#l33.5619"></a><span id="l33.5619" class="difflineminus">-      if (buf)</span>
<a href="#l33.5620"></a><span id="l33.5620" class="difflineminus">-      {</span>
<a href="#l33.5621"></a><span id="l33.5621" class="difflineplus">+      if (buf) {</span>
<a href="#l33.5622"></a><span id="l33.5622">         uint32_t len = strlen(buf);</span>
<a href="#l33.5623"></a><span id="l33.5623">         rv = tempOutfile-&gt;Write(buf, len, &amp;n);</span>
<a href="#l33.5624"></a><span id="l33.5624">         PR_Free(buf);</span>
<a href="#l33.5625"></a><span id="l33.5625" class="difflineminus">-        if (NS_FAILED(rv) || n != len)</span>
<a href="#l33.5626"></a><span id="l33.5626" class="difflineminus">-        {</span>
<a href="#l33.5627"></a><span id="l33.5627" class="difflineplus">+        if (NS_FAILED(rv) || n != len) {</span>
<a href="#l33.5628"></a><span id="l33.5628">           status = NS_ERROR_FAILURE;</span>
<a href="#l33.5629"></a><span id="l33.5629">           goto FAIL;</span>
<a href="#l33.5630"></a><span id="l33.5630">         }</span>
<a href="#l33.5631"></a><span id="l33.5631">       }</span>
<a href="#l33.5632"></a><span id="l33.5632">     }</span>
<a href="#l33.5633"></a><span id="l33.5633"> </span>
<a href="#l33.5634"></a><span id="l33.5634" class="difflineminus">-    if (!mAccountKey.IsEmpty())</span>
<a href="#l33.5635"></a><span id="l33.5635" class="difflineminus">-    {</span>
<a href="#l33.5636"></a><span id="l33.5636" class="difflineminus">-      buf = PR_smprintf(HEADER_X_MOZILLA_ACCOUNT_KEY &quot;: %s&quot; CRLF, mAccountKey.get());</span>
<a href="#l33.5637"></a><span id="l33.5637" class="difflineminus">-      if (buf)</span>
<a href="#l33.5638"></a><span id="l33.5638" class="difflineminus">-      {</span>
<a href="#l33.5639"></a><span id="l33.5639" class="difflineplus">+    if (!mAccountKey.IsEmpty()) {</span>
<a href="#l33.5640"></a><span id="l33.5640" class="difflineplus">+      buf = PR_smprintf(HEADER_X_MOZILLA_ACCOUNT_KEY &quot;: %s&quot; CRLF,</span>
<a href="#l33.5641"></a><span id="l33.5641" class="difflineplus">+                        mAccountKey.get());</span>
<a href="#l33.5642"></a><span id="l33.5642" class="difflineplus">+      if (buf) {</span>
<a href="#l33.5643"></a><span id="l33.5643">         uint32_t len = strlen(buf);</span>
<a href="#l33.5644"></a><span id="l33.5644">         rv = tempOutfile-&gt;Write(buf, len, &amp;n);</span>
<a href="#l33.5645"></a><span id="l33.5645">         PR_Free(buf);</span>
<a href="#l33.5646"></a><span id="l33.5646" class="difflineminus">-        if (NS_FAILED(rv) || n != len)</span>
<a href="#l33.5647"></a><span id="l33.5647" class="difflineminus">-        {</span>
<a href="#l33.5648"></a><span id="l33.5648" class="difflineplus">+        if (NS_FAILED(rv) || n != len) {</span>
<a href="#l33.5649"></a><span id="l33.5649">           status = NS_ERROR_FAILURE;</span>
<a href="#l33.5650"></a><span id="l33.5650">           goto FAIL;</span>
<a href="#l33.5651"></a><span id="l33.5651">         }</span>
<a href="#l33.5652"></a><span id="l33.5652">       }</span>
<a href="#l33.5653"></a><span id="l33.5653">     }</span>
<a href="#l33.5654"></a><span id="l33.5654">   }</span>
<a href="#l33.5655"></a><span id="l33.5655"> </span>
<a href="#l33.5656"></a><span id="l33.5656">   if (bcc_header &amp;&amp; *bcc_header</span>
<a href="#l33.5657"></a><span id="l33.5657"> #ifndef SAVE_BCC_IN_FCC_FILE</span>
<a href="#l33.5658"></a><span id="l33.5658">       &amp;&amp; (mode == MSG_QueueForLater || mode == MSG_SaveAsDraft ||</span>
<a href="#l33.5659"></a><span id="l33.5659">           mode == MSG_SaveAsTemplate)</span>
<a href="#l33.5660"></a><span id="l33.5660"> #endif</span>
<a href="#l33.5661"></a><span id="l33.5661" class="difflineminus">-    )</span>
<a href="#l33.5662"></a><span id="l33.5662" class="difflineminus">-  {</span>
<a href="#l33.5663"></a><span id="l33.5663" class="difflineplus">+  ) {</span>
<a href="#l33.5664"></a><span id="l33.5664">     char *convBcc;</span>
<a href="#l33.5665"></a><span id="l33.5665" class="difflineminus">-    convBcc = nsMsgI18NEncodeMimePartIIStr(bcc_header, true,</span>
<a href="#l33.5666"></a><span id="l33.5666" class="difflineminus">-                    mCompFields-&gt;GetCharacterSet(), sizeof(&quot;BCC: &quot;),</span>
<a href="#l33.5667"></a><span id="l33.5667" class="difflineminus">-                    nsMsgMIMEGetConformToStandard());</span>
<a href="#l33.5668"></a><span id="l33.5668" class="difflineplus">+    convBcc = nsMsgI18NEncodeMimePartIIStr(</span>
<a href="#l33.5669"></a><span id="l33.5669" class="difflineplus">+        bcc_header, true, mCompFields-&gt;GetCharacterSet(), sizeof(&quot;BCC: &quot;),</span>
<a href="#l33.5670"></a><span id="l33.5670" class="difflineplus">+        nsMsgMIMEGetConformToStandard());</span>
<a href="#l33.5671"></a><span id="l33.5671"> </span>
<a href="#l33.5672"></a><span id="l33.5672">     int32_t L = strlen(convBcc ? convBcc : bcc_header) + 20;</span>
<a href="#l33.5673"></a><span id="l33.5673" class="difflineminus">-    char *buf = (char *) PR_Malloc (L);</span>
<a href="#l33.5674"></a><span id="l33.5674" class="difflineminus">-    if (!buf)</span>
<a href="#l33.5675"></a><span id="l33.5675" class="difflineminus">-    {</span>
<a href="#l33.5676"></a><span id="l33.5676" class="difflineplus">+    char *buf = (char *)PR_Malloc(L);</span>
<a href="#l33.5677"></a><span id="l33.5677" class="difflineplus">+    if (!buf) {</span>
<a href="#l33.5678"></a><span id="l33.5678">       status = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l33.5679"></a><span id="l33.5679">       goto FAIL;</span>
<a href="#l33.5680"></a><span id="l33.5680">     }</span>
<a href="#l33.5681"></a><span id="l33.5681"> </span>
<a href="#l33.5682"></a><span id="l33.5682" class="difflineminus">-    PR_snprintf(buf, L-1, &quot;BCC: %s&quot; CRLF, convBcc ? convBcc : bcc_header);</span>
<a href="#l33.5683"></a><span id="l33.5683" class="difflineminus">-    uint32_t   len = strlen(buf);</span>
<a href="#l33.5684"></a><span id="l33.5684" class="difflineplus">+    PR_snprintf(buf, L - 1, &quot;BCC: %s&quot; CRLF, convBcc ? convBcc : bcc_header);</span>
<a href="#l33.5685"></a><span id="l33.5685" class="difflineplus">+    uint32_t len = strlen(buf);</span>
<a href="#l33.5686"></a><span id="l33.5686">     rv = tempOutfile-&gt;Write(buf, len, &amp;n);</span>
<a href="#l33.5687"></a><span id="l33.5687">     PR_Free(buf);</span>
<a href="#l33.5688"></a><span id="l33.5688">     PR_Free(convBcc);</span>
<a href="#l33.5689"></a><span id="l33.5689" class="difflineminus">-    if (NS_FAILED(rv) || n != len)</span>
<a href="#l33.5690"></a><span id="l33.5690" class="difflineminus">-    {</span>
<a href="#l33.5691"></a><span id="l33.5691" class="difflineplus">+    if (NS_FAILED(rv) || n != len) {</span>
<a href="#l33.5692"></a><span id="l33.5692">       status = NS_ERROR_FAILURE;</span>
<a href="#l33.5693"></a><span id="l33.5693">       goto FAIL;</span>
<a href="#l33.5694"></a><span id="l33.5694">     }</span>
<a href="#l33.5695"></a><span id="l33.5695">   }</span>
<a href="#l33.5696"></a><span id="l33.5696"> </span>
<a href="#l33.5697"></a><span id="l33.5697">   //</span>
<a href="#l33.5698"></a><span id="l33.5698">   // Write out the X-Mozilla-News-Host header.</span>
<a href="#l33.5699"></a><span id="l33.5699">   // This is done only when writing to the queue file, not the FCC file.</span>
<a href="#l33.5700"></a><span id="l33.5700">   // We need this to complement the &quot;Newsgroups&quot; header for the case of</span>
<a href="#l33.5701"></a><span id="l33.5701">   // queueing a message for a non-default news host.</span>
<a href="#l33.5702"></a><span id="l33.5702">   //</span>
<a href="#l33.5703"></a><span id="l33.5703">   // Convert a URL like &quot;snews://host:123/&quot; to the form &quot;host:123/secure&quot;</span>
<a href="#l33.5704"></a><span id="l33.5704">   // or &quot;news://user@host:222&quot; to simply &quot;host:222&quot;.</span>
<a href="#l33.5705"></a><span id="l33.5705">   //</span>
<a href="#l33.5706"></a><span id="l33.5706">   if ((mode == nsMsgQueueForLater || mode == nsMsgSaveAsDraft ||</span>
<a href="#l33.5707"></a><span id="l33.5707">        mode == nsMsgSaveAsTemplate || mode == nsMsgDeliverBackground) &amp;&amp;</span>
<a href="#l33.5708"></a><span id="l33.5708" class="difflineminus">-      news_url &amp;&amp; *news_url)</span>
<a href="#l33.5709"></a><span id="l33.5709" class="difflineminus">-  {</span>
<a href="#l33.5710"></a><span id="l33.5710" class="difflineplus">+      news_url &amp;&amp; *news_url) {</span>
<a href="#l33.5711"></a><span id="l33.5711">     bool secure_p = (news_url[0] == 's' || news_url[0] == 'S');</span>
<a href="#l33.5712"></a><span id="l33.5712" class="difflineminus">-    char *orig_hap = nsMsgParseURLHost (news_url);</span>
<a href="#l33.5713"></a><span id="l33.5713" class="difflineplus">+    char *orig_hap = nsMsgParseURLHost(news_url);</span>
<a href="#l33.5714"></a><span id="l33.5714">     char *host_and_port = orig_hap;</span>
<a href="#l33.5715"></a><span id="l33.5715" class="difflineminus">-    if (host_and_port)</span>
<a href="#l33.5716"></a><span id="l33.5716" class="difflineminus">-    {</span>
<a href="#l33.5717"></a><span id="l33.5717" class="difflineplus">+    if (host_and_port) {</span>
<a href="#l33.5718"></a><span id="l33.5718">       // There may be authinfo at the front of the host - it could be of</span>
<a href="#l33.5719"></a><span id="l33.5719">       // the form &quot;user:password@host:port&quot;, so take off everything before</span>
<a href="#l33.5720"></a><span id="l33.5720">       // the first at-sign.  We don't want to store authinfo in the queue</span>
<a href="#l33.5721"></a><span id="l33.5721">       // folder, I guess, but would want it to be re-prompted-for at</span>
<a href="#l33.5722"></a><span id="l33.5722">       // delivery-time.</span>
<a href="#l33.5723"></a><span id="l33.5723">       //</span>
<a href="#l33.5724"></a><span id="l33.5724" class="difflineminus">-      char *at = PL_strchr (host_and_port, '@');</span>
<a href="#l33.5725"></a><span id="l33.5725" class="difflineminus">-      if (at)</span>
<a href="#l33.5726"></a><span id="l33.5726" class="difflineminus">-        host_and_port = at + 1;</span>
<a href="#l33.5727"></a><span id="l33.5727" class="difflineplus">+      char *at = PL_strchr(host_and_port, '@');</span>
<a href="#l33.5728"></a><span id="l33.5728" class="difflineplus">+      if (at) host_and_port = at + 1;</span>
<a href="#l33.5729"></a><span id="l33.5729">     }</span>
<a href="#l33.5730"></a><span id="l33.5730"> </span>
<a href="#l33.5731"></a><span id="l33.5731" class="difflineminus">-    if ((host_and_port &amp;&amp; *host_and_port) || !secure_p)</span>
<a href="#l33.5732"></a><span id="l33.5732" class="difflineminus">-    {</span>
<a href="#l33.5733"></a><span id="l33.5733" class="difflineplus">+    if ((host_and_port &amp;&amp; *host_and_port) || !secure_p) {</span>
<a href="#l33.5734"></a><span id="l33.5734">       char *line = PR_smprintf(X_MOZILLA_NEWSHOST &quot;: %s%s&quot; CRLF,</span>
<a href="#l33.5735"></a><span id="l33.5735" class="difflineminus">-                   host_and_port ? host_and_port : &quot;&quot;,</span>
<a href="#l33.5736"></a><span id="l33.5736" class="difflineminus">-                   secure_p ? &quot;/secure&quot; : &quot;&quot;);</span>
<a href="#l33.5737"></a><span id="l33.5737" class="difflineplus">+                               host_and_port ? host_and_port : &quot;&quot;,</span>
<a href="#l33.5738"></a><span id="l33.5738" class="difflineplus">+                               secure_p ? &quot;/secure&quot; : &quot;&quot;);</span>
<a href="#l33.5739"></a><span id="l33.5739">       PR_FREEIF(orig_hap);</span>
<a href="#l33.5740"></a><span id="l33.5740" class="difflineminus">-      if (!line)</span>
<a href="#l33.5741"></a><span id="l33.5741" class="difflineminus">-      {</span>
<a href="#l33.5742"></a><span id="l33.5742" class="difflineplus">+      if (!line) {</span>
<a href="#l33.5743"></a><span id="l33.5743">         status = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l33.5744"></a><span id="l33.5744">         goto FAIL;</span>
<a href="#l33.5745"></a><span id="l33.5745">       }</span>
<a href="#l33.5746"></a><span id="l33.5746"> </span>
<a href="#l33.5747"></a><span id="l33.5747" class="difflineminus">-      uint32_t   len = PL_strlen(line);</span>
<a href="#l33.5748"></a><span id="l33.5748" class="difflineplus">+      uint32_t len = PL_strlen(line);</span>
<a href="#l33.5749"></a><span id="l33.5749">       rv = tempOutfile-&gt;Write(line, len, &amp;n);</span>
<a href="#l33.5750"></a><span id="l33.5750">       PR_Free(line);</span>
<a href="#l33.5751"></a><span id="l33.5751" class="difflineminus">-      if (NS_FAILED(rv) || n != len)</span>
<a href="#l33.5752"></a><span id="l33.5752" class="difflineminus">-      {</span>
<a href="#l33.5753"></a><span id="l33.5753" class="difflineplus">+      if (NS_FAILED(rv) || n != len) {</span>
<a href="#l33.5754"></a><span id="l33.5754">         status = NS_ERROR_FAILURE;</span>
<a href="#l33.5755"></a><span id="l33.5755">         goto FAIL;</span>
<a href="#l33.5756"></a><span id="l33.5756">       }</span>
<a href="#l33.5757"></a><span id="l33.5757">     }</span>
<a href="#l33.5758"></a><span id="l33.5758"> </span>
<a href="#l33.5759"></a><span id="l33.5759">     PR_Free(orig_hap);</span>
<a href="#l33.5760"></a><span id="l33.5760">   }</span>
<a href="#l33.5761"></a><span id="l33.5761"> </span>
<a href="#l33.5762"></a><span id="l33.5762" class="difflineat">@@ -4730,635 +4254,561 @@ nsMsgComposeAndSend::MimeDoFCC(nsIFile  </span>
<a href="#l33.5763"></a><span id="l33.5763">   // but the FCC file must have those lines mangled.</span>
<a href="#l33.5764"></a><span id="l33.5764">   //</span>
<a href="#l33.5765"></a><span id="l33.5765">   // It's unfortunate that we end up writing the FCC file a line</span>
<a href="#l33.5766"></a><span id="l33.5766">   // at a time, but it's the easiest way...</span>
<a href="#l33.5767"></a><span id="l33.5767">   //</span>
<a href="#l33.5768"></a><span id="l33.5768">   uint64_t available;</span>
<a href="#l33.5769"></a><span id="l33.5769">   rv = inputFile-&gt;Available(&amp;available);</span>
<a href="#l33.5770"></a><span id="l33.5770">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l33.5771"></a><span id="l33.5771" class="difflineminus">-  while (available &gt; 0)</span>
<a href="#l33.5772"></a><span id="l33.5772" class="difflineminus">-  {</span>
<a href="#l33.5773"></a><span id="l33.5773" class="difflineplus">+  while (available &gt; 0) {</span>
<a href="#l33.5774"></a><span id="l33.5774">     // check *ibuffer in case that ibuffer isn't big enough</span>
<a href="#l33.5775"></a><span id="l33.5775">     uint32_t readCount;</span>
<a href="#l33.5776"></a><span id="l33.5776">     rv = inputFile-&gt;Read(ibuffer, ibuffer_size, &amp;readCount);</span>
<a href="#l33.5777"></a><span id="l33.5777" class="difflineminus">-    if (NS_FAILED(rv) || readCount == 0 || *ibuffer == 0)</span>
<a href="#l33.5778"></a><span id="l33.5778" class="difflineminus">-    {</span>
<a href="#l33.5779"></a><span id="l33.5779" class="difflineplus">+    if (NS_FAILED(rv) || readCount == 0 || *ibuffer == 0) {</span>
<a href="#l33.5780"></a><span id="l33.5780">       status = NS_ERROR_FAILURE;</span>
<a href="#l33.5781"></a><span id="l33.5781">       goto FAIL;</span>
<a href="#l33.5782"></a><span id="l33.5782">     }</span>
<a href="#l33.5783"></a><span id="l33.5783"> </span>
<a href="#l33.5784"></a><span id="l33.5784">     rv = tempOutfile-&gt;Write(ibuffer, readCount, &amp;n);</span>
<a href="#l33.5785"></a><span id="l33.5785" class="difflineminus">-    if (NS_FAILED(rv) || n != readCount) // write failed</span>
<a href="#l33.5786"></a><span id="l33.5786" class="difflineplus">+    if (NS_FAILED(rv) || n != readCount)  // write failed</span>
<a href="#l33.5787"></a><span id="l33.5787">     {</span>
<a href="#l33.5788"></a><span id="l33.5788">       status = NS_MSG_ERROR_WRITING_FILE;</span>
<a href="#l33.5789"></a><span id="l33.5789">       goto FAIL;</span>
<a href="#l33.5790"></a><span id="l33.5790">     }</span>
<a href="#l33.5791"></a><span id="l33.5791"> </span>
<a href="#l33.5792"></a><span id="l33.5792">     rv = inputFile-&gt;Available(&amp;available);</span>
<a href="#l33.5793"></a><span id="l33.5793">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l33.5794"></a><span id="l33.5794">   }</span>
<a href="#l33.5795"></a><span id="l33.5795"> </span>
<a href="#l33.5796"></a><span id="l33.5796"> FAIL:</span>
<a href="#l33.5797"></a><span id="l33.5797">   PR_Free(ibuffer);</span>
<a href="#l33.5798"></a><span id="l33.5798"> </span>
<a href="#l33.5799"></a><span id="l33.5799" class="difflineminus">-  if (NS_FAILED(tempOutfile-&gt;Flush()))</span>
<a href="#l33.5800"></a><span id="l33.5800" class="difflineminus">-    status = NS_MSG_ERROR_WRITING_FILE;</span>
<a href="#l33.5801"></a><span id="l33.5801" class="difflineplus">+  if (NS_FAILED(tempOutfile-&gt;Flush())) status = NS_MSG_ERROR_WRITING_FILE;</span>
<a href="#l33.5802"></a><span id="l33.5802"> </span>
<a href="#l33.5803"></a><span id="l33.5803">   tempOutfile-&gt;Close();</span>
<a href="#l33.5804"></a><span id="l33.5804"> </span>
<a href="#l33.5805"></a><span id="l33.5805" class="difflineminus">-  if (inputFile)</span>
<a href="#l33.5806"></a><span id="l33.5806" class="difflineminus">-    inputFile-&gt;Close();</span>
<a href="#l33.5807"></a><span id="l33.5807" class="difflineminus">-</span>
<a href="#l33.5808"></a><span id="l33.5808" class="difflineplus">+  if (inputFile) inputFile-&gt;Close();</span>
<a href="#l33.5809"></a><span id="l33.5809"> </span>
<a href="#l33.5810"></a><span id="l33.5810">   // here we should clone mCopyFile, since it has changed on disk.</span>
<a href="#l33.5811"></a><span id="l33.5811" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; clonedFile;</span>
<a href="#l33.5812"></a><span id="l33.5812" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; clonedFile;</span>
<a href="#l33.5813"></a><span id="l33.5813">   mCopyFile-&gt;Clone(getter_AddRefs(clonedFile));</span>
<a href="#l33.5814"></a><span id="l33.5814">   mCopyFile = clonedFile;</span>
<a href="#l33.5815"></a><span id="l33.5815"> </span>
<a href="#l33.5816"></a><span id="l33.5816">   // When we get here, we have to see if we have been successful so far.</span>
<a href="#l33.5817"></a><span id="l33.5817">   // If we have, then we should start up the async copy service operation.</span>
<a href="#l33.5818"></a><span id="l33.5818">   // If we weren't successful, then we should just return the error and</span>
<a href="#l33.5819"></a><span id="l33.5819">   // bail out.</span>
<a href="#l33.5820"></a><span id="l33.5820" class="difflineminus">-  if (NS_SUCCEEDED(status))</span>
<a href="#l33.5821"></a><span id="l33.5821" class="difflineminus">-  {</span>
<a href="#l33.5822"></a><span id="l33.5822" class="difflineplus">+  if (NS_SUCCEEDED(status)) {</span>
<a href="#l33.5823"></a><span id="l33.5823">     // If we are here, time to start the async copy service operation!</span>
<a href="#l33.5824"></a><span id="l33.5824">     status = StartMessageCopyOperation(mCopyFile, mode, tmpUri);</span>
<a href="#l33.5825"></a><span id="l33.5825">   }</span>
<a href="#l33.5826"></a><span id="l33.5826">   return status;</span>
<a href="#l33.5827"></a><span id="l33.5827"> }</span>
<a href="#l33.5828"></a><span id="l33.5828"> </span>
<a href="#l33.5829"></a><span id="l33.5829"> //</span>
<a href="#l33.5830"></a><span id="l33.5830"> // This is pretty much a wrapper to the functionality that lives in the</span>
<a href="#l33.5831"></a><span id="l33.5831"> // nsMsgCopy class</span>
<a href="#l33.5832"></a><span id="l33.5832"> //</span>
<a href="#l33.5833"></a><span id="l33.5833" class="difflineminus">-nsresult</span>
<a href="#l33.5834"></a><span id="l33.5834" class="difflineminus">-nsMsgComposeAndSend::StartMessageCopyOperation(nsIFile          *aFile,</span>
<a href="#l33.5835"></a><span id="l33.5835" class="difflineminus">-                                               nsMsgDeliverMode mode,</span>
<a href="#l33.5836"></a><span id="l33.5836" class="difflineminus">-                                               const nsCString&amp; dest_uri)</span>
<a href="#l33.5837"></a><span id="l33.5837" class="difflineminus">-{</span>
<a href="#l33.5838"></a><span id="l33.5838" class="difflineplus">+nsresult nsMsgComposeAndSend::StartMessageCopyOperation(</span>
<a href="#l33.5839"></a><span id="l33.5839" class="difflineplus">+    nsIFile *aFile, nsMsgDeliverMode mode, const nsCString &amp;dest_uri) {</span>
<a href="#l33.5840"></a><span id="l33.5840">   mCopyObj = new nsMsgCopy();</span>
<a href="#l33.5841"></a><span id="l33.5841" class="difflineminus">-  if (!mCopyObj)</span>
<a href="#l33.5842"></a><span id="l33.5842" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l33.5843"></a><span id="l33.5843" class="difflineplus">+  if (!mCopyObj) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l33.5844"></a><span id="l33.5844"> </span>
<a href="#l33.5845"></a><span id="l33.5845">   //</span>
<a href="#l33.5846"></a><span id="l33.5846">   // Actually, we need to pick up the proper folder from the prefs and not</span>
<a href="#l33.5847"></a><span id="l33.5847">   // default to the default &quot;Flagged&quot; folder choices</span>
<a href="#l33.5848"></a><span id="l33.5848">   //</span>
<a href="#l33.5849"></a><span id="l33.5849" class="difflineminus">-  nsresult    rv;</span>
<a href="#l33.5850"></a><span id="l33.5850" class="difflineplus">+  nsresult rv;</span>
<a href="#l33.5851"></a><span id="l33.5851">   if (!dest_uri.IsEmpty())</span>
<a href="#l33.5852"></a><span id="l33.5852">     m_folderName = dest_uri;</span>
<a href="#l33.5853"></a><span id="l33.5853">   else</span>
<a href="#l33.5854"></a><span id="l33.5854">     GetFolderURIFromUserPrefs(mode, mUserIdentity, m_folderName);</span>
<a href="#l33.5855"></a><span id="l33.5855"> </span>
<a href="#l33.5856"></a><span id="l33.5856" class="difflineminus">-  if (mListener)</span>
<a href="#l33.5857"></a><span id="l33.5857" class="difflineminus">-    mListener-&gt;OnGetDraftFolderURI(m_folderName.get());</span>
<a href="#l33.5858"></a><span id="l33.5858" class="difflineminus">-</span>
<a href="#l33.5859"></a><span id="l33.5859" class="difflineminus">-  rv = mCopyObj-&gt;StartCopyOperation(mUserIdentity, aFile, mode,</span>
<a href="#l33.5860"></a><span id="l33.5860" class="difflineminus">-                                    this, m_folderName.get(), mMsgToReplace);</span>
<a href="#l33.5861"></a><span id="l33.5861" class="difflineplus">+  if (mListener) mListener-&gt;OnGetDraftFolderURI(m_folderName.get());</span>
<a href="#l33.5862"></a><span id="l33.5862" class="difflineplus">+</span>
<a href="#l33.5863"></a><span id="l33.5863" class="difflineplus">+  rv = mCopyObj-&gt;StartCopyOperation(mUserIdentity, aFile, mode, this,</span>
<a href="#l33.5864"></a><span id="l33.5864" class="difflineplus">+                                    m_folderName.get(), mMsgToReplace);</span>
<a href="#l33.5865"></a><span id="l33.5865">   return rv;</span>
<a href="#l33.5866"></a><span id="l33.5866"> }</span>
<a href="#l33.5867"></a><span id="l33.5867"> </span>
<a href="#l33.5868"></a><span id="l33.5868" class="difflineminus">-//I'm getting this each time without holding onto the feedback so that 3 pane windows can be closed</span>
<a href="#l33.5869"></a><span id="l33.5869" class="difflineminus">-//without any chance of crashing due to holding onto a deleted feedback.</span>
<a href="#l33.5870"></a><span id="l33.5870" class="difflineminus">-nsresult</span>
<a href="#l33.5871"></a><span id="l33.5871" class="difflineminus">-nsMsgComposeAndSend::SetStatusMessage(const nsString &amp;aMsgString)</span>
<a href="#l33.5872"></a><span id="l33.5872" class="difflineminus">-{</span>
<a href="#l33.5873"></a><span id="l33.5873" class="difflineplus">+// I'm getting this each time without holding onto the feedback so that 3 pane</span>
<a href="#l33.5874"></a><span id="l33.5874" class="difflineplus">+// windows can be closed without any chance of crashing due to holding onto a</span>
<a href="#l33.5875"></a><span id="l33.5875" class="difflineplus">+// deleted feedback.</span>
<a href="#l33.5876"></a><span id="l33.5876" class="difflineplus">+nsresult nsMsgComposeAndSend::SetStatusMessage(const nsString &amp;aMsgString) {</span>
<a href="#l33.5877"></a><span id="l33.5877">   if (mSendProgress)</span>
<a href="#l33.5878"></a><span id="l33.5878">     mSendProgress-&gt;OnStatusChange(nullptr, nullptr, NS_OK, aMsgString.get());</span>
<a href="#l33.5879"></a><span id="l33.5879">   return NS_OK;</span>
<a href="#l33.5880"></a><span id="l33.5880"> }</span>
<a href="#l33.5881"></a><span id="l33.5881"> </span>
<a href="#l33.5882"></a><span id="l33.5882"> // For GUI notification...</span>
<a href="#l33.5883"></a><span id="l33.5883" class="difflineminus">-nsresult</span>
<a href="#l33.5884"></a><span id="l33.5884" class="difflineminus">-nsMsgComposeAndSend::SetGUINotificationState(bool aEnableFlag)</span>
<a href="#l33.5885"></a><span id="l33.5885" class="difflineminus">-{</span>
<a href="#l33.5886"></a><span id="l33.5886" class="difflineplus">+nsresult nsMsgComposeAndSend::SetGUINotificationState(bool aEnableFlag) {</span>
<a href="#l33.5887"></a><span id="l33.5887">   mGUINotificationEnabled = aEnableFlag;</span>
<a href="#l33.5888"></a><span id="l33.5888">   return NS_OK;</span>
<a href="#l33.5889"></a><span id="l33.5889"> }</span>
<a href="#l33.5890"></a><span id="l33.5890"> </span>
<a href="#l33.5891"></a><span id="l33.5891"> /* readonly attribute nsIMsgSendReport sendReport; */</span>
<a href="#l33.5892"></a><span id="l33.5892"> NS_IMETHODIMP</span>
<a href="#l33.5893"></a><span id="l33.5893" class="difflineminus">-nsMsgComposeAndSend::GetSendReport(nsIMsgSendReport * *aSendReport)</span>
<a href="#l33.5894"></a><span id="l33.5894" class="difflineminus">-{</span>
<a href="#l33.5895"></a><span id="l33.5895" class="difflineplus">+nsMsgComposeAndSend::GetSendReport(nsIMsgSendReport **aSendReport) {</span>
<a href="#l33.5896"></a><span id="l33.5896">   NS_ENSURE_ARG_POINTER(aSendReport);</span>
<a href="#l33.5897"></a><span id="l33.5897">   NS_IF_ADDREF(*aSendReport = mSendReport);</span>
<a href="#l33.5898"></a><span id="l33.5898">   return NS_OK;</span>
<a href="#l33.5899"></a><span id="l33.5899"> }</span>
<a href="#l33.5900"></a><span id="l33.5900"> </span>
<a href="#l33.5901"></a><span id="l33.5901" class="difflineminus">-nsresult nsMsgComposeAndSend::Abort()</span>
<a href="#l33.5902"></a><span id="l33.5902" class="difflineminus">-{</span>
<a href="#l33.5903"></a><span id="l33.5903" class="difflineplus">+nsresult nsMsgComposeAndSend::Abort() {</span>
<a href="#l33.5904"></a><span id="l33.5904">   uint32_t i;</span>
<a href="#l33.5905"></a><span id="l33.5905">   nsresult rv;</span>
<a href="#l33.5906"></a><span id="l33.5906"> </span>
<a href="#l33.5907"></a><span id="l33.5907" class="difflineminus">-  if (mAbortInProcess)</span>
<a href="#l33.5908"></a><span id="l33.5908" class="difflineminus">-    return NS_OK;</span>
<a href="#l33.5909"></a><span id="l33.5909" class="difflineplus">+  if (mAbortInProcess) return NS_OK;</span>
<a href="#l33.5910"></a><span id="l33.5910"> </span>
<a href="#l33.5911"></a><span id="l33.5911">   mAbortInProcess = true;</span>
<a href="#l33.5912"></a><span id="l33.5912"> </span>
<a href="#l33.5913"></a><span id="l33.5913" class="difflineminus">-  if (m_plaintext)</span>
<a href="#l33.5914"></a><span id="l33.5914" class="difflineminus">-    rv = m_plaintext-&gt;Abort();</span>
<a href="#l33.5915"></a><span id="l33.5915" class="difflineminus">-</span>
<a href="#l33.5916"></a><span id="l33.5916" class="difflineminus">-  for (i = 0; i &lt; m_attachment_count; i ++)</span>
<a href="#l33.5917"></a><span id="l33.5917" class="difflineminus">-  {</span>
<a href="#l33.5918"></a><span id="l33.5918" class="difflineplus">+  if (m_plaintext) rv = m_plaintext-&gt;Abort();</span>
<a href="#l33.5919"></a><span id="l33.5919" class="difflineplus">+</span>
<a href="#l33.5920"></a><span id="l33.5920" class="difflineplus">+  for (i = 0; i &lt; m_attachment_count; i++) {</span>
<a href="#l33.5921"></a><span id="l33.5921">     nsMsgAttachmentHandler *ma = m_attachments[i];</span>
<a href="#l33.5922"></a><span id="l33.5922" class="difflineminus">-    if (ma)</span>
<a href="#l33.5923"></a><span id="l33.5923" class="difflineminus">-      rv = ma-&gt;Abort();</span>
<a href="#l33.5924"></a><span id="l33.5924" class="difflineplus">+    if (ma) rv = ma-&gt;Abort();</span>
<a href="#l33.5925"></a><span id="l33.5925">   }</span>
<a href="#l33.5926"></a><span id="l33.5926"> </span>
<a href="#l33.5927"></a><span id="l33.5927">   /* stop the current running url */</span>
<a href="#l33.5928"></a><span id="l33.5928" class="difflineminus">-  if (mRunningRequest)</span>
<a href="#l33.5929"></a><span id="l33.5929" class="difflineminus">-  {</span>
<a href="#l33.5930"></a><span id="l33.5930" class="difflineplus">+  if (mRunningRequest) {</span>
<a href="#l33.5931"></a><span id="l33.5931">     mRunningRequest-&gt;Cancel(NS_ERROR_ABORT);</span>
<a href="#l33.5932"></a><span id="l33.5932">     mRunningRequest = nullptr;</span>
<a href="#l33.5933"></a><span id="l33.5933">   }</span>
<a href="#l33.5934"></a><span id="l33.5934"> </span>
<a href="#l33.5935"></a><span id="l33.5935" class="difflineminus">-  if (mCopyObj)</span>
<a href="#l33.5936"></a><span id="l33.5936" class="difflineminus">-  {</span>
<a href="#l33.5937"></a><span id="l33.5937" class="difflineminus">-    nsCOMPtr&lt;nsIMsgCopyService&gt; copyService = do_GetService(NS_MSGCOPYSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l33.5938"></a><span id="l33.5938" class="difflineplus">+  if (mCopyObj) {</span>
<a href="#l33.5939"></a><span id="l33.5939" class="difflineplus">+    nsCOMPtr&lt;nsIMsgCopyService&gt; copyService =</span>
<a href="#l33.5940"></a><span id="l33.5940" class="difflineplus">+        do_GetService(NS_MSGCOPYSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l33.5941"></a><span id="l33.5941">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l33.5942"></a><span id="l33.5942"> </span>
<a href="#l33.5943"></a><span id="l33.5943" class="difflineminus">-    copyService-&gt;NotifyCompletion(mCopyFile, mCopyObj-&gt;mDstFolder, NS_ERROR_ABORT);</span>
<a href="#l33.5944"></a><span id="l33.5944" class="difflineplus">+    copyService-&gt;NotifyCompletion(mCopyFile, mCopyObj-&gt;mDstFolder,</span>
<a href="#l33.5945"></a><span id="l33.5945" class="difflineplus">+                                  NS_ERROR_ABORT);</span>
<a href="#l33.5946"></a><span id="l33.5946">   }</span>
<a href="#l33.5947"></a><span id="l33.5947">   mAbortInProcess = false;</span>
<a href="#l33.5948"></a><span id="l33.5948">   return NS_OK;</span>
<a href="#l33.5949"></a><span id="l33.5949"> }</span>
<a href="#l33.5950"></a><span id="l33.5950"> </span>
<a href="#l33.5951"></a><span id="l33.5951" class="difflineminus">-NS_IMETHODIMP nsMsgComposeAndSend::GetProcessAttachmentsSynchronously(bool *_retval)</span>
<a href="#l33.5952"></a><span id="l33.5952" class="difflineminus">-{</span>
<a href="#l33.5953"></a><span id="l33.5953" class="difflineplus">+NS_IMETHODIMP nsMsgComposeAndSend::GetProcessAttachmentsSynchronously(</span>
<a href="#l33.5954"></a><span id="l33.5954" class="difflineplus">+    bool *_retval) {</span>
<a href="#l33.5955"></a><span id="l33.5955">   NS_ENSURE_ARG(_retval);</span>
<a href="#l33.5956"></a><span id="l33.5956">   *_retval = m_be_synchronous_p;</span>
<a href="#l33.5957"></a><span id="l33.5957">   return NS_OK;</span>
<a href="#l33.5958"></a><span id="l33.5958"> }</span>
<a href="#l33.5959"></a><span id="l33.5959"> </span>
<a href="#l33.5960"></a><span id="l33.5960" class="difflineminus">-NS_IMETHODIMP nsMsgComposeAndSend::GetAttachmentHandlers(nsTArray&lt;RefPtr&lt;nsMsgAttachmentHandler&gt;&gt; **_retval)</span>
<a href="#l33.5961"></a><span id="l33.5961" class="difflineminus">-{</span>
<a href="#l33.5962"></a><span id="l33.5962" class="difflineplus">+NS_IMETHODIMP nsMsgComposeAndSend::GetAttachmentHandlers(</span>
<a href="#l33.5963"></a><span id="l33.5963" class="difflineplus">+    nsTArray&lt;RefPtr&lt;nsMsgAttachmentHandler&gt;&gt; **_retval) {</span>
<a href="#l33.5964"></a><span id="l33.5964">   NS_ENSURE_ARG(_retval);</span>
<a href="#l33.5965"></a><span id="l33.5965">   *_retval = &amp;m_attachments;</span>
<a href="#l33.5966"></a><span id="l33.5966">   return NS_OK;</span>
<a href="#l33.5967"></a><span id="l33.5967"> }</span>
<a href="#l33.5968"></a><span id="l33.5968"> </span>
<a href="#l33.5969"></a><span id="l33.5969" class="difflineminus">-NS_IMETHODIMP nsMsgComposeAndSend::GetAttachmentCount(uint32_t *aAttachmentCount)</span>
<a href="#l33.5970"></a><span id="l33.5970" class="difflineminus">-{</span>
<a href="#l33.5971"></a><span id="l33.5971" class="difflineplus">+NS_IMETHODIMP nsMsgComposeAndSend::GetAttachmentCount(</span>
<a href="#l33.5972"></a><span id="l33.5972" class="difflineplus">+    uint32_t *aAttachmentCount) {</span>
<a href="#l33.5973"></a><span id="l33.5973">   NS_ENSURE_ARG(aAttachmentCount);</span>
<a href="#l33.5974"></a><span id="l33.5974">   *aAttachmentCount = m_attachment_count;</span>
<a href="#l33.5975"></a><span id="l33.5975">   return NS_OK;</span>
<a href="#l33.5976"></a><span id="l33.5976"> }</span>
<a href="#l33.5977"></a><span id="l33.5977"> </span>
<a href="#l33.5978"></a><span id="l33.5978" class="difflineminus">-NS_IMETHODIMP nsMsgComposeAndSend::GetPendingAttachmentCount(uint32_t *aPendingAttachmentCount)</span>
<a href="#l33.5979"></a><span id="l33.5979" class="difflineminus">-{</span>
<a href="#l33.5980"></a><span id="l33.5980" class="difflineplus">+NS_IMETHODIMP nsMsgComposeAndSend::GetPendingAttachmentCount(</span>
<a href="#l33.5981"></a><span id="l33.5981" class="difflineplus">+    uint32_t *aPendingAttachmentCount) {</span>
<a href="#l33.5982"></a><span id="l33.5982">   NS_ENSURE_ARG(aPendingAttachmentCount);</span>
<a href="#l33.5983"></a><span id="l33.5983">   *aPendingAttachmentCount = m_attachment_pending_count;</span>
<a href="#l33.5984"></a><span id="l33.5984">   return NS_OK;</span>
<a href="#l33.5985"></a><span id="l33.5985"> }</span>
<a href="#l33.5986"></a><span id="l33.5986" class="difflineminus">-NS_IMETHODIMP nsMsgComposeAndSend::SetPendingAttachmentCount(uint32_t aPendingAttachmentCount)</span>
<a href="#l33.5987"></a><span id="l33.5987" class="difflineminus">-{</span>
<a href="#l33.5988"></a><span id="l33.5988" class="difflineplus">+NS_IMETHODIMP nsMsgComposeAndSend::SetPendingAttachmentCount(</span>
<a href="#l33.5989"></a><span id="l33.5989" class="difflineplus">+    uint32_t aPendingAttachmentCount) {</span>
<a href="#l33.5990"></a><span id="l33.5990">   m_attachment_pending_count = aPendingAttachmentCount;</span>
<a href="#l33.5991"></a><span id="l33.5991">   return NS_OK;</span>
<a href="#l33.5992"></a><span id="l33.5992"> }</span>
<a href="#l33.5993"></a><span id="l33.5993"> </span>
<a href="#l33.5994"></a><span id="l33.5994" class="difflineminus">-NS_IMETHODIMP nsMsgComposeAndSend::GetDeliveryMode(nsMsgDeliverMode *aDeliveryMode)</span>
<a href="#l33.5995"></a><span id="l33.5995" class="difflineminus">-{</span>
<a href="#l33.5996"></a><span id="l33.5996" class="difflineplus">+NS_IMETHODIMP nsMsgComposeAndSend::GetDeliveryMode(</span>
<a href="#l33.5997"></a><span id="l33.5997" class="difflineplus">+    nsMsgDeliverMode *aDeliveryMode) {</span>
<a href="#l33.5998"></a><span id="l33.5998">   NS_ENSURE_ARG(aDeliveryMode);</span>
<a href="#l33.5999"></a><span id="l33.5999">   *aDeliveryMode = m_deliver_mode;</span>
<a href="#l33.6000"></a><span id="l33.6000">   return NS_OK;</span>
<a href="#l33.6001"></a><span id="l33.6001"> }</span>
<a href="#l33.6002"></a><span id="l33.6002"> </span>
<a href="#l33.6003"></a><span id="l33.6003" class="difflineminus">-NS_IMETHODIMP nsMsgComposeAndSend::GetProgress(nsIMsgProgress **_retval)</span>
<a href="#l33.6004"></a><span id="l33.6004" class="difflineminus">-{</span>
<a href="#l33.6005"></a><span id="l33.6005" class="difflineplus">+NS_IMETHODIMP nsMsgComposeAndSend::GetProgress(nsIMsgProgress **_retval) {</span>
<a href="#l33.6006"></a><span id="l33.6006">   NS_ENSURE_ARG(_retval);</span>
<a href="#l33.6007"></a><span id="l33.6007">   NS_IF_ADDREF(*_retval = mSendProgress);</span>
<a href="#l33.6008"></a><span id="l33.6008">   return NS_OK;</span>
<a href="#l33.6009"></a><span id="l33.6009"> }</span>
<a href="#l33.6010"></a><span id="l33.6010"> </span>
<a href="#l33.6011"></a><span id="l33.6011" class="difflineminus">-NS_IMETHODIMP nsMsgComposeAndSend::GetOutputStream(nsIOutputStream **_retval)</span>
<a href="#l33.6012"></a><span id="l33.6012" class="difflineminus">-{</span>
<a href="#l33.6013"></a><span id="l33.6013" class="difflineplus">+NS_IMETHODIMP nsMsgComposeAndSend::GetOutputStream(nsIOutputStream **_retval) {</span>
<a href="#l33.6014"></a><span id="l33.6014">   NS_ENSURE_ARG(_retval);</span>
<a href="#l33.6015"></a><span id="l33.6015">   NS_IF_ADDREF(*_retval = mOutputFile);</span>
<a href="#l33.6016"></a><span id="l33.6016">   return NS_OK;</span>
<a href="#l33.6017"></a><span id="l33.6017"> }</span>
<a href="#l33.6018"></a><span id="l33.6018"> </span>
<a href="#l33.6019"></a><span id="l33.6019" class="difflineminus">-</span>
<a href="#l33.6020"></a><span id="l33.6020"> /* [noscript] attribute nsIURI runningURL; */</span>
<a href="#l33.6021"></a><span id="l33.6021" class="difflineminus">-NS_IMETHODIMP nsMsgComposeAndSend::GetRunningRequest(nsIRequest **request)</span>
<a href="#l33.6022"></a><span id="l33.6022" class="difflineminus">-{</span>
<a href="#l33.6023"></a><span id="l33.6023" class="difflineplus">+NS_IMETHODIMP nsMsgComposeAndSend::GetRunningRequest(nsIRequest **request) {</span>
<a href="#l33.6024"></a><span id="l33.6024">   NS_ENSURE_ARG(request);</span>
<a href="#l33.6025"></a><span id="l33.6025">   NS_IF_ADDREF(*request = mRunningRequest);</span>
<a href="#l33.6026"></a><span id="l33.6026">   return NS_OK;</span>
<a href="#l33.6027"></a><span id="l33.6027"> }</span>
<a href="#l33.6028"></a><span id="l33.6028" class="difflineminus">-NS_IMETHODIMP nsMsgComposeAndSend::SetRunningRequest(nsIRequest *request)</span>
<a href="#l33.6029"></a><span id="l33.6029" class="difflineminus">-{</span>
<a href="#l33.6030"></a><span id="l33.6030" class="difflineplus">+NS_IMETHODIMP nsMsgComposeAndSend::SetRunningRequest(nsIRequest *request) {</span>
<a href="#l33.6031"></a><span id="l33.6031">   mRunningRequest = request;</span>
<a href="#l33.6032"></a><span id="l33.6032">   return NS_OK;</span>
<a href="#l33.6033"></a><span id="l33.6033"> }</span>
<a href="#l33.6034"></a><span id="l33.6034"> </span>
<a href="#l33.6035"></a><span id="l33.6035" class="difflineminus">-NS_IMETHODIMP nsMsgComposeAndSend::GetStatus(nsresult *aStatus)</span>
<a href="#l33.6036"></a><span id="l33.6036" class="difflineminus">-{</span>
<a href="#l33.6037"></a><span id="l33.6037" class="difflineplus">+NS_IMETHODIMP nsMsgComposeAndSend::GetStatus(nsresult *aStatus) {</span>
<a href="#l33.6038"></a><span id="l33.6038">   NS_ENSURE_ARG(aStatus);</span>
<a href="#l33.6039"></a><span id="l33.6039">   *aStatus = m_status;</span>
<a href="#l33.6040"></a><span id="l33.6040">   return NS_OK;</span>
<a href="#l33.6041"></a><span id="l33.6041"> }</span>
<a href="#l33.6042"></a><span id="l33.6042"> </span>
<a href="#l33.6043"></a><span id="l33.6043" class="difflineminus">-NS_IMETHODIMP nsMsgComposeAndSend::SetStatus(nsresult aStatus)</span>
<a href="#l33.6044"></a><span id="l33.6044" class="difflineminus">-{</span>
<a href="#l33.6045"></a><span id="l33.6045" class="difflineplus">+NS_IMETHODIMP nsMsgComposeAndSend::SetStatus(nsresult aStatus) {</span>
<a href="#l33.6046"></a><span id="l33.6046">   m_status = aStatus;</span>
<a href="#l33.6047"></a><span id="l33.6047">   return NS_OK;</span>
<a href="#l33.6048"></a><span id="l33.6048"> }</span>
<a href="#l33.6049"></a><span id="l33.6049"> </span>
<a href="#l33.6050"></a><span id="l33.6050" class="difflineminus">-NS_IMETHODIMP nsMsgComposeAndSend::GetCryptoclosure(nsIMsgComposeSecure ** aCryptoclosure)</span>
<a href="#l33.6051"></a><span id="l33.6051" class="difflineminus">-{</span>
<a href="#l33.6052"></a><span id="l33.6052" class="difflineplus">+NS_IMETHODIMP nsMsgComposeAndSend::GetCryptoclosure(</span>
<a href="#l33.6053"></a><span id="l33.6053" class="difflineplus">+    nsIMsgComposeSecure **aCryptoclosure) {</span>
<a href="#l33.6054"></a><span id="l33.6054">   NS_ENSURE_ARG(aCryptoclosure);</span>
<a href="#l33.6055"></a><span id="l33.6055">   NS_IF_ADDREF(*aCryptoclosure = m_crypto_closure);</span>
<a href="#l33.6056"></a><span id="l33.6056">   return NS_OK;</span>
<a href="#l33.6057"></a><span id="l33.6057"> }</span>
<a href="#l33.6058"></a><span id="l33.6058"> </span>
<a href="#l33.6059"></a><span id="l33.6059" class="difflineminus">-NS_IMETHODIMP nsMsgComposeAndSend::SetCryptoclosure(nsIMsgComposeSecure * aCryptoclosure)</span>
<a href="#l33.6060"></a><span id="l33.6060" class="difflineminus">-{</span>
<a href="#l33.6061"></a><span id="l33.6061" class="difflineplus">+NS_IMETHODIMP nsMsgComposeAndSend::SetCryptoclosure(</span>
<a href="#l33.6062"></a><span id="l33.6062" class="difflineplus">+    nsIMsgComposeSecure *aCryptoclosure) {</span>
<a href="#l33.6063"></a><span id="l33.6063">   m_crypto_closure = aCryptoclosure;</span>
<a href="#l33.6064"></a><span id="l33.6064">   return NS_OK;</span>
<a href="#l33.6065"></a><span id="l33.6065"> }</span>
<a href="#l33.6066"></a><span id="l33.6066"> </span>
<a href="#l33.6067"></a><span id="l33.6067"> NS_IMETHODIMP</span>
<a href="#l33.6068"></a><span id="l33.6068" class="difflineminus">-nsMsgComposeAndSend::GetSendCompFields(nsIMsgCompFields** aCompFields)</span>
<a href="#l33.6069"></a><span id="l33.6069" class="difflineminus">-{</span>
<a href="#l33.6070"></a><span id="l33.6070" class="difflineplus">+nsMsgComposeAndSend::GetSendCompFields(nsIMsgCompFields **aCompFields) {</span>
<a href="#l33.6071"></a><span id="l33.6071">   NS_ENSURE_ARG_POINTER(aCompFields);</span>
<a href="#l33.6072"></a><span id="l33.6072">   nsCOMPtr&lt;nsIMsgCompFields&gt; qiCompFields(mCompFields);</span>
<a href="#l33.6073"></a><span id="l33.6073">   NS_ENSURE_STATE(qiCompFields);</span>
<a href="#l33.6074"></a><span id="l33.6074">   qiCompFields.forget(aCompFields);</span>
<a href="#l33.6075"></a><span id="l33.6075">   return NS_OK;</span>
<a href="#l33.6076"></a><span id="l33.6076"> }</span>
<a href="#l33.6077"></a><span id="l33.6077"> </span>
<a href="#l33.6078"></a><span id="l33.6078"> NS_IMETHODIMP</span>
<a href="#l33.6079"></a><span id="l33.6079" class="difflineminus">-nsMsgComposeAndSend::GetSendBody(nsAString&amp; aBody)</span>
<a href="#l33.6080"></a><span id="l33.6080" class="difflineminus">-{</span>
<a href="#l33.6081"></a><span id="l33.6081" class="difflineplus">+nsMsgComposeAndSend::GetSendBody(nsAString &amp;aBody) {</span>
<a href="#l33.6082"></a><span id="l33.6082">   nsCString charSet;</span>
<a href="#l33.6083"></a><span id="l33.6083" class="difflineminus">-  if (mCompFields)</span>
<a href="#l33.6084"></a><span id="l33.6084" class="difflineminus">-    mCompFields-&gt;GetCharacterSet(getter_Copies(charSet));</span>
<a href="#l33.6085"></a><span id="l33.6085" class="difflineplus">+  if (mCompFields) mCompFields-&gt;GetCharacterSet(getter_Copies(charSet));</span>
<a href="#l33.6086"></a><span id="l33.6086">   if (!m_attachment1_body) {</span>
<a href="#l33.6087"></a><span id="l33.6087">     aBody.Truncate();</span>
<a href="#l33.6088"></a><span id="l33.6088">     return NS_OK;</span>
<a href="#l33.6089"></a><span id="l33.6089">   }</span>
<a href="#l33.6090"></a><span id="l33.6090" class="difflineminus">-  return nsMsgI18NConvertToUnicode(charSet,</span>
<a href="#l33.6091"></a><span id="l33.6091" class="difflineminus">-                                   nsDependentCString(m_attachment1_body),</span>
<a href="#l33.6092"></a><span id="l33.6092" class="difflineminus">-                                   aBody);</span>
<a href="#l33.6093"></a><span id="l33.6093" class="difflineplus">+  return nsMsgI18NConvertToUnicode(</span>
<a href="#l33.6094"></a><span id="l33.6094" class="difflineplus">+      charSet, nsDependentCString(m_attachment1_body), aBody);</span>
<a href="#l33.6095"></a><span id="l33.6095"> }</span>
<a href="#l33.6096"></a><span id="l33.6096"> </span>
<a href="#l33.6097"></a><span id="l33.6097"> NS_IMETHODIMP</span>
<a href="#l33.6098"></a><span id="l33.6098" class="difflineminus">-nsMsgComposeAndSend::GetSendBodyType(nsACString&amp; aBodyType)</span>
<a href="#l33.6099"></a><span id="l33.6099" class="difflineminus">-{</span>
<a href="#l33.6100"></a><span id="l33.6100" class="difflineplus">+nsMsgComposeAndSend::GetSendBodyType(nsACString &amp;aBodyType) {</span>
<a href="#l33.6101"></a><span id="l33.6101">   if (m_attachment1_type &amp;&amp; *m_attachment1_type)</span>
<a href="#l33.6102"></a><span id="l33.6102">     aBodyType.Assign(nsDependentCString(m_attachment1_type));</span>
<a href="#l33.6103"></a><span id="l33.6103">   return NS_OK;</span>
<a href="#l33.6104"></a><span id="l33.6104"> }</span>
<a href="#l33.6105"></a><span id="l33.6105"> </span>
<a href="#l33.6106"></a><span id="l33.6106"> NS_IMETHODIMP</span>
<a href="#l33.6107"></a><span id="l33.6107" class="difflineminus">-nsMsgComposeAndSend::GetIdentity(nsIMsgIdentity **aIdentity)</span>
<a href="#l33.6108"></a><span id="l33.6108" class="difflineminus">-{</span>
<a href="#l33.6109"></a><span id="l33.6109" class="difflineplus">+nsMsgComposeAndSend::GetIdentity(nsIMsgIdentity **aIdentity) {</span>
<a href="#l33.6110"></a><span id="l33.6110">   NS_ENSURE_ARG_POINTER(aIdentity);</span>
<a href="#l33.6111"></a><span id="l33.6111">   NS_IF_ADDREF(*aIdentity = mUserIdentity);</span>
<a href="#l33.6112"></a><span id="l33.6112">   return NS_OK;</span>
<a href="#l33.6113"></a><span id="l33.6113"> }</span>
<a href="#l33.6114"></a><span id="l33.6114"> </span>
<a href="#l33.6115"></a><span id="l33.6115"> NS_IMETHODIMP</span>
<a href="#l33.6116"></a><span id="l33.6116"> nsMsgComposeAndSend::GetAttachment(uint32_t aIndex,</span>
<a href="#l33.6117"></a><span id="l33.6117" class="difflineminus">-                                   nsIMsgAttachmentHandler **aAttachment)</span>
<a href="#l33.6118"></a><span id="l33.6118" class="difflineminus">-{</span>
<a href="#l33.6119"></a><span id="l33.6119" class="difflineplus">+                                   nsIMsgAttachmentHandler **aAttachment) {</span>
<a href="#l33.6120"></a><span id="l33.6120">   NS_ENSURE_ARG_POINTER(aAttachment);</span>
<a href="#l33.6121"></a><span id="l33.6121" class="difflineminus">-  if (aIndex &gt;= m_attachment_count)</span>
<a href="#l33.6122"></a><span id="l33.6122" class="difflineminus">-    return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l33.6123"></a><span id="l33.6123" class="difflineplus">+  if (aIndex &gt;= m_attachment_count) return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l33.6124"></a><span id="l33.6124">   NS_IF_ADDREF(*aAttachment = m_attachments[aIndex]);</span>
<a href="#l33.6125"></a><span id="l33.6125">   return NS_OK;</span>
<a href="#l33.6126"></a><span id="l33.6126"> }</span>
<a href="#l33.6127"></a><span id="l33.6127"> </span>
<a href="#l33.6128"></a><span id="l33.6128"> NS_IMETHODIMP</span>
<a href="#l33.6129"></a><span id="l33.6129" class="difflineminus">-nsMsgComposeAndSend::SetSavedToFolderName(const nsAString&amp; aName)</span>
<a href="#l33.6130"></a><span id="l33.6130" class="difflineminus">-{</span>
<a href="#l33.6131"></a><span id="l33.6131" class="difflineplus">+nsMsgComposeAndSend::SetSavedToFolderName(const nsAString &amp;aName) {</span>
<a href="#l33.6132"></a><span id="l33.6132">   mSavedToFolderName.Assign(aName);</span>
<a href="#l33.6133"></a><span id="l33.6133">   return NS_OK;</span>
<a href="#l33.6134"></a><span id="l33.6134"> }</span>
<a href="#l33.6135"></a><span id="l33.6135"> </span>
<a href="#l33.6136"></a><span id="l33.6136"> NS_IMETHODIMP</span>
<a href="#l33.6137"></a><span id="l33.6137" class="difflineminus">-nsMsgComposeAndSend::GetSavedToFolderName(nsAString&amp; aName)</span>
<a href="#l33.6138"></a><span id="l33.6138" class="difflineminus">-{</span>
<a href="#l33.6139"></a><span id="l33.6139" class="difflineplus">+nsMsgComposeAndSend::GetSavedToFolderName(nsAString &amp;aName) {</span>
<a href="#l33.6140"></a><span id="l33.6140">   aName.Assign(mSavedToFolderName);</span>
<a href="#l33.6141"></a><span id="l33.6141">   return NS_OK;</span>
<a href="#l33.6142"></a><span id="l33.6142"> }</span>
<a href="#l33.6143"></a><span id="l33.6143"> </span>
<a href="#l33.6144"></a><span id="l33.6144"> NS_IMETHODIMP</span>
<a href="#l33.6145"></a><span id="l33.6145" class="difflineminus">-nsMsgComposeAndSend::SetDontDeliver(bool aDontDeliver)</span>
<a href="#l33.6146"></a><span id="l33.6146" class="difflineminus">-{</span>
<a href="#l33.6147"></a><span id="l33.6147" class="difflineplus">+nsMsgComposeAndSend::SetDontDeliver(bool aDontDeliver) {</span>
<a href="#l33.6148"></a><span id="l33.6148">   m_dont_deliver_p = aDontDeliver;</span>
<a href="#l33.6149"></a><span id="l33.6149">   return NS_OK;</span>
<a href="#l33.6150"></a><span id="l33.6150"> }</span>
<a href="#l33.6151"></a><span id="l33.6151"> NS_IMETHODIMP</span>
<a href="#l33.6152"></a><span id="l33.6152" class="difflineminus">-nsMsgComposeAndSend::GetDontDeliver(bool *aDontDeliver)</span>
<a href="#l33.6153"></a><span id="l33.6153" class="difflineminus">-{</span>
<a href="#l33.6154"></a><span id="l33.6154" class="difflineplus">+nsMsgComposeAndSend::GetDontDeliver(bool *aDontDeliver) {</span>
<a href="#l33.6155"></a><span id="l33.6155">   NS_ENSURE_ARG_POINTER(aDontDeliver);</span>
<a href="#l33.6156"></a><span id="l33.6156">   *aDontDeliver = m_dont_deliver_p;</span>
<a href="#l33.6157"></a><span id="l33.6157">   return NS_OK;</span>
<a href="#l33.6158"></a><span id="l33.6158"> }</span>
<a href="#l33.6159"></a><span id="l33.6159"> </span>
<a href="#l33.6160"></a><span id="l33.6160"> NS_IMPL_ISUPPORTS(nsMsgAttachmentData, nsIMsgAttachmentData)</span>
<a href="#l33.6161"></a><span id="l33.6161"> </span>
<a href="#l33.6162"></a><span id="l33.6162" class="difflineminus">-nsMsgAttachmentData::nsMsgAttachmentData() :  m_size(0), m_sizeExternalStr(&quot;-1&quot;),</span>
<a href="#l33.6163"></a><span id="l33.6163" class="difflineminus">-  m_isExternalAttachment(false), m_isExternalLinkAttachment(false),</span>
<a href="#l33.6164"></a><span id="l33.6164" class="difflineminus">-  m_isDownloaded(false), m_hasFilename(false), m_displayableInline(false)</span>
<a href="#l33.6165"></a><span id="l33.6165" class="difflineminus">-{</span>
<a href="#l33.6166"></a><span id="l33.6166" class="difflineminus">-}</span>
<a href="#l33.6167"></a><span id="l33.6167" class="difflineminus">-</span>
<a href="#l33.6168"></a><span id="l33.6168" class="difflineminus">-nsMsgAttachmentData::~nsMsgAttachmentData()</span>
<a href="#l33.6169"></a><span id="l33.6169" class="difflineminus">-{</span>
<a href="#l33.6170"></a><span id="l33.6170" class="difflineminus">-}</span>
<a href="#l33.6171"></a><span id="l33.6171" class="difflineminus">-</span>
<a href="#l33.6172"></a><span id="l33.6172" class="difflineminus">-NS_IMETHODIMP nsMsgAttachmentData::GetUrl(nsIURI **aUrl)</span>
<a href="#l33.6173"></a><span id="l33.6173" class="difflineminus">-{</span>
<a href="#l33.6174"></a><span id="l33.6174" class="difflineplus">+nsMsgAttachmentData::nsMsgAttachmentData()</span>
<a href="#l33.6175"></a><span id="l33.6175" class="difflineplus">+    : m_size(0),</span>
<a href="#l33.6176"></a><span id="l33.6176" class="difflineplus">+      m_sizeExternalStr(&quot;-1&quot;),</span>
<a href="#l33.6177"></a><span id="l33.6177" class="difflineplus">+      m_isExternalAttachment(false),</span>
<a href="#l33.6178"></a><span id="l33.6178" class="difflineplus">+      m_isExternalLinkAttachment(false),</span>
<a href="#l33.6179"></a><span id="l33.6179" class="difflineplus">+      m_isDownloaded(false),</span>
<a href="#l33.6180"></a><span id="l33.6180" class="difflineplus">+      m_hasFilename(false),</span>
<a href="#l33.6181"></a><span id="l33.6181" class="difflineplus">+      m_displayableInline(false) {}</span>
<a href="#l33.6182"></a><span id="l33.6182" class="difflineplus">+</span>
<a href="#l33.6183"></a><span id="l33.6183" class="difflineplus">+nsMsgAttachmentData::~nsMsgAttachmentData() {}</span>
<a href="#l33.6184"></a><span id="l33.6184" class="difflineplus">+</span>
<a href="#l33.6185"></a><span id="l33.6185" class="difflineplus">+NS_IMETHODIMP nsMsgAttachmentData::GetUrl(nsIURI **aUrl) {</span>
<a href="#l33.6186"></a><span id="l33.6186">   NS_ENSURE_ARG_POINTER(aUrl);</span>
<a href="#l33.6187"></a><span id="l33.6187">   NS_IF_ADDREF(*aUrl = m_url);</span>
<a href="#l33.6188"></a><span id="l33.6188">   return NS_OK;</span>
<a href="#l33.6189"></a><span id="l33.6189"> }</span>
<a href="#l33.6190"></a><span id="l33.6190"> </span>
<a href="#l33.6191"></a><span id="l33.6191" class="difflineminus">-NS_IMETHODIMP nsMsgAttachmentData::SetUrl(nsIURI *aUrl)</span>
<a href="#l33.6192"></a><span id="l33.6192" class="difflineminus">-{</span>
<a href="#l33.6193"></a><span id="l33.6193" class="difflineplus">+NS_IMETHODIMP nsMsgAttachmentData::SetUrl(nsIURI *aUrl) {</span>
<a href="#l33.6194"></a><span id="l33.6194">   m_url = aUrl;</span>
<a href="#l33.6195"></a><span id="l33.6195">   return NS_OK;</span>
<a href="#l33.6196"></a><span id="l33.6196"> }</span>
<a href="#l33.6197"></a><span id="l33.6197"> </span>
<a href="#l33.6198"></a><span id="l33.6198" class="difflineminus">-NS_IMETHODIMP nsMsgAttachmentData::GetDesiredType(nsACString &amp;aDesiredType)</span>
<a href="#l33.6199"></a><span id="l33.6199" class="difflineminus">-{</span>
<a href="#l33.6200"></a><span id="l33.6200" class="difflineplus">+NS_IMETHODIMP nsMsgAttachmentData::GetDesiredType(nsACString &amp;aDesiredType) {</span>
<a href="#l33.6201"></a><span id="l33.6201">   aDesiredType = m_desiredType;</span>
<a href="#l33.6202"></a><span id="l33.6202">   return NS_OK;</span>
<a href="#l33.6203"></a><span id="l33.6203"> }</span>
<a href="#l33.6204"></a><span id="l33.6204"> </span>
<a href="#l33.6205"></a><span id="l33.6205" class="difflineminus">-NS_IMETHODIMP nsMsgAttachmentData::SetDesiredType(const nsACString &amp;aDesiredType)</span>
<a href="#l33.6206"></a><span id="l33.6206" class="difflineminus">-{</span>
<a href="#l33.6207"></a><span id="l33.6207" class="difflineplus">+NS_IMETHODIMP nsMsgAttachmentData::SetDesiredType(</span>
<a href="#l33.6208"></a><span id="l33.6208" class="difflineplus">+    const nsACString &amp;aDesiredType) {</span>
<a href="#l33.6209"></a><span id="l33.6209">   m_desiredType = aDesiredType;</span>
<a href="#l33.6210"></a><span id="l33.6210">   return NS_OK;</span>
<a href="#l33.6211"></a><span id="l33.6211"> }</span>
<a href="#l33.6212"></a><span id="l33.6212"> </span>
<a href="#l33.6213"></a><span id="l33.6213" class="difflineminus">-NS_IMETHODIMP nsMsgAttachmentData::GetRealType(nsACString &amp;aRealType)</span>
<a href="#l33.6214"></a><span id="l33.6214" class="difflineminus">-{</span>
<a href="#l33.6215"></a><span id="l33.6215" class="difflineplus">+NS_IMETHODIMP nsMsgAttachmentData::GetRealType(nsACString &amp;aRealType) {</span>
<a href="#l33.6216"></a><span id="l33.6216">   aRealType = m_realType;</span>
<a href="#l33.6217"></a><span id="l33.6217">   return NS_OK;</span>
<a href="#l33.6218"></a><span id="l33.6218"> }</span>
<a href="#l33.6219"></a><span id="l33.6219"> </span>
<a href="#l33.6220"></a><span id="l33.6220" class="difflineminus">-NS_IMETHODIMP nsMsgAttachmentData::SetRealType(const nsACString &amp;aRealType)</span>
<a href="#l33.6221"></a><span id="l33.6221" class="difflineminus">-{</span>
<a href="#l33.6222"></a><span id="l33.6222" class="difflineplus">+NS_IMETHODIMP nsMsgAttachmentData::SetRealType(const nsACString &amp;aRealType) {</span>
<a href="#l33.6223"></a><span id="l33.6223">   m_realType = aRealType;</span>
<a href="#l33.6224"></a><span id="l33.6224">   return NS_OK;</span>
<a href="#l33.6225"></a><span id="l33.6225"> }</span>
<a href="#l33.6226"></a><span id="l33.6226"> </span>
<a href="#l33.6227"></a><span id="l33.6227" class="difflineminus">-NS_IMETHODIMP nsMsgAttachmentData::GetRealEncoding(nsACString &amp;aRealEncoding)</span>
<a href="#l33.6228"></a><span id="l33.6228" class="difflineminus">-{</span>
<a href="#l33.6229"></a><span id="l33.6229" class="difflineplus">+NS_IMETHODIMP nsMsgAttachmentData::GetRealEncoding(nsACString &amp;aRealEncoding) {</span>
<a href="#l33.6230"></a><span id="l33.6230">   aRealEncoding = m_realEncoding;</span>
<a href="#l33.6231"></a><span id="l33.6231">   return NS_OK;</span>
<a href="#l33.6232"></a><span id="l33.6232"> }</span>
<a href="#l33.6233"></a><span id="l33.6233"> </span>
<a href="#l33.6234"></a><span id="l33.6234" class="difflineminus">-NS_IMETHODIMP nsMsgAttachmentData::SetRealEncoding(const nsACString &amp;aRealEncoding)</span>
<a href="#l33.6235"></a><span id="l33.6235" class="difflineminus">-{</span>
<a href="#l33.6236"></a><span id="l33.6236" class="difflineplus">+NS_IMETHODIMP nsMsgAttachmentData::SetRealEncoding(</span>
<a href="#l33.6237"></a><span id="l33.6237" class="difflineplus">+    const nsACString &amp;aRealEncoding) {</span>
<a href="#l33.6238"></a><span id="l33.6238">   m_realEncoding = aRealEncoding;</span>
<a href="#l33.6239"></a><span id="l33.6239">   return NS_OK;</span>
<a href="#l33.6240"></a><span id="l33.6240"> }</span>
<a href="#l33.6241"></a><span id="l33.6241"> </span>
<a href="#l33.6242"></a><span id="l33.6242" class="difflineminus">-NS_IMETHODIMP nsMsgAttachmentData::GetRealName(nsACString &amp;aRealName)</span>
<a href="#l33.6243"></a><span id="l33.6243" class="difflineminus">-{</span>
<a href="#l33.6244"></a><span id="l33.6244" class="difflineplus">+NS_IMETHODIMP nsMsgAttachmentData::GetRealName(nsACString &amp;aRealName) {</span>
<a href="#l33.6245"></a><span id="l33.6245">   aRealName = m_realName;</span>
<a href="#l33.6246"></a><span id="l33.6246">   return NS_OK;</span>
<a href="#l33.6247"></a><span id="l33.6247"> }</span>
<a href="#l33.6248"></a><span id="l33.6248"> </span>
<a href="#l33.6249"></a><span id="l33.6249" class="difflineminus">-NS_IMETHODIMP nsMsgAttachmentData::SetRealName(const nsACString &amp;aRealName)</span>
<a href="#l33.6250"></a><span id="l33.6250" class="difflineminus">-{</span>
<a href="#l33.6251"></a><span id="l33.6251" class="difflineplus">+NS_IMETHODIMP nsMsgAttachmentData::SetRealName(const nsACString &amp;aRealName) {</span>
<a href="#l33.6252"></a><span id="l33.6252">   m_realName = aRealName;</span>
<a href="#l33.6253"></a><span id="l33.6253">   return NS_OK;</span>
<a href="#l33.6254"></a><span id="l33.6254"> }</span>
<a href="#l33.6255"></a><span id="l33.6255"> </span>
<a href="#l33.6256"></a><span id="l33.6256" class="difflineminus">-NS_IMETHODIMP nsMsgAttachmentData::GetDescription(nsACString &amp;aDescription)</span>
<a href="#l33.6257"></a><span id="l33.6257" class="difflineminus">-{</span>
<a href="#l33.6258"></a><span id="l33.6258" class="difflineplus">+NS_IMETHODIMP nsMsgAttachmentData::GetDescription(nsACString &amp;aDescription) {</span>
<a href="#l33.6259"></a><span id="l33.6259">   aDescription = m_description;</span>
<a href="#l33.6260"></a><span id="l33.6260">   return NS_OK;</span>
<a href="#l33.6261"></a><span id="l33.6261"> }</span>
<a href="#l33.6262"></a><span id="l33.6262"> </span>
<a href="#l33.6263"></a><span id="l33.6263" class="difflineminus">-NS_IMETHODIMP nsMsgAttachmentData::SetDescription(const nsACString &amp;aDescription)</span>
<a href="#l33.6264"></a><span id="l33.6264" class="difflineminus">-{</span>
<a href="#l33.6265"></a><span id="l33.6265" class="difflineplus">+NS_IMETHODIMP nsMsgAttachmentData::SetDescription(</span>
<a href="#l33.6266"></a><span id="l33.6266" class="difflineplus">+    const nsACString &amp;aDescription) {</span>
<a href="#l33.6267"></a><span id="l33.6267">   m_description = aDescription;</span>
<a href="#l33.6268"></a><span id="l33.6268">   return NS_OK;</span>
<a href="#l33.6269"></a><span id="l33.6269"> }</span>
<a href="#l33.6270"></a><span id="l33.6270"> </span>
<a href="#l33.6271"></a><span id="l33.6271" class="difflineminus">-NS_IMETHODIMP nsMsgAttachmentData::GetXMacType(nsACString &amp; aXMacType)</span>
<a href="#l33.6272"></a><span id="l33.6272" class="difflineminus">-{</span>
<a href="#l33.6273"></a><span id="l33.6273" class="difflineplus">+NS_IMETHODIMP nsMsgAttachmentData::GetXMacType(nsACString &amp;aXMacType) {</span>
<a href="#l33.6274"></a><span id="l33.6274">   aXMacType = m_xMacType;</span>
<a href="#l33.6275"></a><span id="l33.6275">   return NS_OK;</span>
<a href="#l33.6276"></a><span id="l33.6276"> }</span>
<a href="#l33.6277"></a><span id="l33.6277"> </span>
<a href="#l33.6278"></a><span id="l33.6278" class="difflineminus">-NS_IMETHODIMP nsMsgAttachmentData::SetXMacType(const nsACString &amp; aXMacType)</span>
<a href="#l33.6279"></a><span id="l33.6279" class="difflineminus">-{</span>
<a href="#l33.6280"></a><span id="l33.6280" class="difflineplus">+NS_IMETHODIMP nsMsgAttachmentData::SetXMacType(const nsACString &amp;aXMacType) {</span>
<a href="#l33.6281"></a><span id="l33.6281">   m_xMacType = aXMacType;</span>
<a href="#l33.6282"></a><span id="l33.6282">   return NS_OK;</span>
<a href="#l33.6283"></a><span id="l33.6283"> }</span>
<a href="#l33.6284"></a><span id="l33.6284"> </span>
<a href="#l33.6285"></a><span id="l33.6285" class="difflineminus">-NS_IMETHODIMP nsMsgAttachmentData::GetXMacCreator(nsACString &amp; aXMacCreator)</span>
<a href="#l33.6286"></a><span id="l33.6286" class="difflineminus">-{</span>
<a href="#l33.6287"></a><span id="l33.6287" class="difflineplus">+NS_IMETHODIMP nsMsgAttachmentData::GetXMacCreator(nsACString &amp;aXMacCreator) {</span>
<a href="#l33.6288"></a><span id="l33.6288">   aXMacCreator = m_xMacCreator;</span>
<a href="#l33.6289"></a><span id="l33.6289">   return NS_OK;</span>
<a href="#l33.6290"></a><span id="l33.6290"> }</span>
<a href="#l33.6291"></a><span id="l33.6291"> </span>
<a href="#l33.6292"></a><span id="l33.6292" class="difflineminus">-NS_IMETHODIMP nsMsgAttachmentData::SetXMacCreator(const nsACString &amp; aXMacCreator)</span>
<a href="#l33.6293"></a><span id="l33.6293" class="difflineminus">-{</span>
<a href="#l33.6294"></a><span id="l33.6294" class="difflineplus">+NS_IMETHODIMP nsMsgAttachmentData::SetXMacCreator(</span>
<a href="#l33.6295"></a><span id="l33.6295" class="difflineplus">+    const nsACString &amp;aXMacCreator) {</span>
<a href="#l33.6296"></a><span id="l33.6296">   m_xMacCreator = aXMacCreator;</span>
<a href="#l33.6297"></a><span id="l33.6297">   return NS_OK;</span>
<a href="#l33.6298"></a><span id="l33.6298"> }</span>
<a href="#l33.6299"></a><span id="l33.6299"> </span>
<a href="#l33.6300"></a><span id="l33.6300"> NS_IMPL_ISUPPORTS(nsMsgAttachedFile, nsIMsgAttachedFile)</span>
<a href="#l33.6301"></a><span id="l33.6301"> </span>
<a href="#l33.6302"></a><span id="l33.6302" class="difflineminus">-nsMsgAttachedFile::nsMsgAttachedFile() :  m_size(0), m_unprintableCount(0),</span>
<a href="#l33.6303"></a><span id="l33.6303" class="difflineminus">-  m_highbitCount(0), m_ctlCount(0), m_nullCount(0), m_maxLineLength(0)</span>
<a href="#l33.6304"></a><span id="l33.6304" class="difflineminus">-{</span>
<a href="#l33.6305"></a><span id="l33.6305" class="difflineminus">-}</span>
<a href="#l33.6306"></a><span id="l33.6306" class="difflineminus">-</span>
<a href="#l33.6307"></a><span id="l33.6307" class="difflineminus">-nsMsgAttachedFile::~nsMsgAttachedFile()</span>
<a href="#l33.6308"></a><span id="l33.6308" class="difflineminus">-{</span>
<a href="#l33.6309"></a><span id="l33.6309" class="difflineminus">-}</span>
<a href="#l33.6310"></a><span id="l33.6310" class="difflineminus">-</span>
<a href="#l33.6311"></a><span id="l33.6311" class="difflineminus">-NS_IMETHODIMP nsMsgAttachedFile::GetOrigUrl(nsIURI **aOrigUrl)</span>
<a href="#l33.6312"></a><span id="l33.6312" class="difflineminus">-{</span>
<a href="#l33.6313"></a><span id="l33.6313" class="difflineplus">+nsMsgAttachedFile::nsMsgAttachedFile()</span>
<a href="#l33.6314"></a><span id="l33.6314" class="difflineplus">+    : m_size(0),</span>
<a href="#l33.6315"></a><span id="l33.6315" class="difflineplus">+      m_unprintableCount(0),</span>
<a href="#l33.6316"></a><span id="l33.6316" class="difflineplus">+      m_highbitCount(0),</span>
<a href="#l33.6317"></a><span id="l33.6317" class="difflineplus">+      m_ctlCount(0),</span>
<a href="#l33.6318"></a><span id="l33.6318" class="difflineplus">+      m_nullCount(0),</span>
<a href="#l33.6319"></a><span id="l33.6319" class="difflineplus">+      m_maxLineLength(0) {}</span>
<a href="#l33.6320"></a><span id="l33.6320" class="difflineplus">+</span>
<a href="#l33.6321"></a><span id="l33.6321" class="difflineplus">+nsMsgAttachedFile::~nsMsgAttachedFile() {}</span>
<a href="#l33.6322"></a><span id="l33.6322" class="difflineplus">+</span>
<a href="#l33.6323"></a><span id="l33.6323" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::GetOrigUrl(nsIURI **aOrigUrl) {</span>
<a href="#l33.6324"></a><span id="l33.6324">   NS_ENSURE_ARG_POINTER(aOrigUrl);</span>
<a href="#l33.6325"></a><span id="l33.6325">   NS_IF_ADDREF(*aOrigUrl = m_origUrl);</span>
<a href="#l33.6326"></a><span id="l33.6326">   return NS_OK;</span>
<a href="#l33.6327"></a><span id="l33.6327"> }</span>
<a href="#l33.6328"></a><span id="l33.6328"> </span>
<a href="#l33.6329"></a><span id="l33.6329" class="difflineminus">-NS_IMETHODIMP nsMsgAttachedFile::SetOrigUrl(nsIURI *aOrigUrl)</span>
<a href="#l33.6330"></a><span id="l33.6330" class="difflineminus">-{</span>
<a href="#l33.6331"></a><span id="l33.6331" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::SetOrigUrl(nsIURI *aOrigUrl) {</span>
<a href="#l33.6332"></a><span id="l33.6332">   m_origUrl = aOrigUrl;</span>
<a href="#l33.6333"></a><span id="l33.6333">   return NS_OK;</span>
<a href="#l33.6334"></a><span id="l33.6334"> }</span>
<a href="#l33.6335"></a><span id="l33.6335"> </span>
<a href="#l33.6336"></a><span id="l33.6336" class="difflineminus">-NS_IMETHODIMP nsMsgAttachedFile::GetTmpFile(nsIFile **aTmpFile)</span>
<a href="#l33.6337"></a><span id="l33.6337" class="difflineminus">-{</span>
<a href="#l33.6338"></a><span id="l33.6338" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::GetTmpFile(nsIFile **aTmpFile) {</span>
<a href="#l33.6339"></a><span id="l33.6339">   NS_ENSURE_ARG_POINTER(aTmpFile);</span>
<a href="#l33.6340"></a><span id="l33.6340">   NS_IF_ADDREF(*aTmpFile = m_tmpFile);</span>
<a href="#l33.6341"></a><span id="l33.6341">   return NS_OK;</span>
<a href="#l33.6342"></a><span id="l33.6342"> }</span>
<a href="#l33.6343"></a><span id="l33.6343"> </span>
<a href="#l33.6344"></a><span id="l33.6344" class="difflineminus">-NS_IMETHODIMP nsMsgAttachedFile::SetTmpFile(nsIFile *aTmpFile)</span>
<a href="#l33.6345"></a><span id="l33.6345" class="difflineminus">-{</span>
<a href="#l33.6346"></a><span id="l33.6346" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::SetTmpFile(nsIFile *aTmpFile) {</span>
<a href="#l33.6347"></a><span id="l33.6347">   m_tmpFile = aTmpFile;</span>
<a href="#l33.6348"></a><span id="l33.6348">   return NS_OK;</span>
<a href="#l33.6349"></a><span id="l33.6349"> }</span>
<a href="#l33.6350"></a><span id="l33.6350"> </span>
<a href="#l33.6351"></a><span id="l33.6351" class="difflineminus">-NS_IMETHODIMP nsMsgAttachedFile::GetType(nsACString &amp;aType)</span>
<a href="#l33.6352"></a><span id="l33.6352" class="difflineminus">-{</span>
<a href="#l33.6353"></a><span id="l33.6353" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::GetType(nsACString &amp;aType) {</span>
<a href="#l33.6354"></a><span id="l33.6354">   aType = m_type;</span>
<a href="#l33.6355"></a><span id="l33.6355">   return NS_OK;</span>
<a href="#l33.6356"></a><span id="l33.6356"> }</span>
<a href="#l33.6357"></a><span id="l33.6357"> </span>
<a href="#l33.6358"></a><span id="l33.6358" class="difflineminus">-NS_IMETHODIMP nsMsgAttachedFile::SetType(const nsACString &amp;aType)</span>
<a href="#l33.6359"></a><span id="l33.6359" class="difflineminus">-{</span>
<a href="#l33.6360"></a><span id="l33.6360" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::SetType(const nsACString &amp;aType) {</span>
<a href="#l33.6361"></a><span id="l33.6361">   m_type = aType;</span>
<a href="#l33.6362"></a><span id="l33.6362">   return NS_OK;</span>
<a href="#l33.6363"></a><span id="l33.6363"> }</span>
<a href="#l33.6364"></a><span id="l33.6364"> </span>
<a href="#l33.6365"></a><span id="l33.6365" class="difflineminus">-NS_IMETHODIMP nsMsgAttachedFile::GetEncoding(nsACString &amp;aEncoding)</span>
<a href="#l33.6366"></a><span id="l33.6366" class="difflineminus">-{</span>
<a href="#l33.6367"></a><span id="l33.6367" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::GetEncoding(nsACString &amp;aEncoding) {</span>
<a href="#l33.6368"></a><span id="l33.6368">   aEncoding = m_encoding;</span>
<a href="#l33.6369"></a><span id="l33.6369">   return NS_OK;</span>
<a href="#l33.6370"></a><span id="l33.6370"> }</span>
<a href="#l33.6371"></a><span id="l33.6371"> </span>
<a href="#l33.6372"></a><span id="l33.6372" class="difflineminus">-NS_IMETHODIMP nsMsgAttachedFile::SetEncoding(const nsACString &amp;aEncoding)</span>
<a href="#l33.6373"></a><span id="l33.6373" class="difflineminus">-{</span>
<a href="#l33.6374"></a><span id="l33.6374" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::SetEncoding(const nsACString &amp;aEncoding) {</span>
<a href="#l33.6375"></a><span id="l33.6375">   m_encoding = aEncoding;</span>
<a href="#l33.6376"></a><span id="l33.6376">   return NS_OK;</span>
<a href="#l33.6377"></a><span id="l33.6377"> }</span>
<a href="#l33.6378"></a><span id="l33.6378"> </span>
<a href="#l33.6379"></a><span id="l33.6379" class="difflineminus">-NS_IMETHODIMP nsMsgAttachedFile::GetDescription(nsACString &amp;aDescription)</span>
<a href="#l33.6380"></a><span id="l33.6380" class="difflineminus">-{</span>
<a href="#l33.6381"></a><span id="l33.6381" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::GetDescription(nsACString &amp;aDescription) {</span>
<a href="#l33.6382"></a><span id="l33.6382">   aDescription = m_description;</span>
<a href="#l33.6383"></a><span id="l33.6383">   return NS_OK;</span>
<a href="#l33.6384"></a><span id="l33.6384"> }</span>
<a href="#l33.6385"></a><span id="l33.6385"> </span>
<a href="#l33.6386"></a><span id="l33.6386" class="difflineminus">-NS_IMETHODIMP nsMsgAttachedFile::SetDescription(const nsACString &amp;aDescription)</span>
<a href="#l33.6387"></a><span id="l33.6387" class="difflineminus">-{</span>
<a href="#l33.6388"></a><span id="l33.6388" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::SetDescription(</span>
<a href="#l33.6389"></a><span id="l33.6389" class="difflineplus">+    const nsACString &amp;aDescription) {</span>
<a href="#l33.6390"></a><span id="l33.6390">   m_description = aDescription;</span>
<a href="#l33.6391"></a><span id="l33.6391">   return NS_OK;</span>
<a href="#l33.6392"></a><span id="l33.6392"> }</span>
<a href="#l33.6393"></a><span id="l33.6393"> </span>
<a href="#l33.6394"></a><span id="l33.6394" class="difflineminus">-NS_IMETHODIMP nsMsgAttachedFile::GetCloudPartInfo(nsACString &amp;aCloudPartInfo)</span>
<a href="#l33.6395"></a><span id="l33.6395" class="difflineminus">-{</span>
<a href="#l33.6396"></a><span id="l33.6396" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::GetCloudPartInfo(nsACString &amp;aCloudPartInfo) {</span>
<a href="#l33.6397"></a><span id="l33.6397">   aCloudPartInfo = m_cloudPartInfo;</span>
<a href="#l33.6398"></a><span id="l33.6398">   return NS_OK;</span>
<a href="#l33.6399"></a><span id="l33.6399"> }</span>
<a href="#l33.6400"></a><span id="l33.6400"> </span>
<a href="#l33.6401"></a><span id="l33.6401" class="difflineminus">-NS_IMETHODIMP nsMsgAttachedFile::SetCloudPartInfo(const nsACString &amp;aCloudPartInfo)</span>
<a href="#l33.6402"></a><span id="l33.6402" class="difflineminus">-{</span>
<a href="#l33.6403"></a><span id="l33.6403" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::SetCloudPartInfo(</span>
<a href="#l33.6404"></a><span id="l33.6404" class="difflineplus">+    const nsACString &amp;aCloudPartInfo) {</span>
<a href="#l33.6405"></a><span id="l33.6405">   m_cloudPartInfo = aCloudPartInfo;</span>
<a href="#l33.6406"></a><span id="l33.6406">   return NS_OK;</span>
<a href="#l33.6407"></a><span id="l33.6407"> }</span>
<a href="#l33.6408"></a><span id="l33.6408"> </span>
<a href="#l33.6409"></a><span id="l33.6409" class="difflineminus">-NS_IMETHODIMP nsMsgAttachedFile::GetXMacType(nsACString &amp; aXMacType)</span>
<a href="#l33.6410"></a><span id="l33.6410" class="difflineminus">-{</span>
<a href="#l33.6411"></a><span id="l33.6411" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::GetXMacType(nsACString &amp;aXMacType) {</span>
<a href="#l33.6412"></a><span id="l33.6412">   aXMacType = m_xMacType;</span>
<a href="#l33.6413"></a><span id="l33.6413">   return NS_OK;</span>
<a href="#l33.6414"></a><span id="l33.6414"> }</span>
<a href="#l33.6415"></a><span id="l33.6415"> </span>
<a href="#l33.6416"></a><span id="l33.6416" class="difflineminus">-NS_IMETHODIMP nsMsgAttachedFile::SetXMacType(const nsACString &amp; aXMacType)</span>
<a href="#l33.6417"></a><span id="l33.6417" class="difflineminus">-{</span>
<a href="#l33.6418"></a><span id="l33.6418" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::SetXMacType(const nsACString &amp;aXMacType) {</span>
<a href="#l33.6419"></a><span id="l33.6419">   m_xMacType = aXMacType;</span>
<a href="#l33.6420"></a><span id="l33.6420">   return NS_OK;</span>
<a href="#l33.6421"></a><span id="l33.6421"> }</span>
<a href="#l33.6422"></a><span id="l33.6422"> </span>
<a href="#l33.6423"></a><span id="l33.6423" class="difflineminus">-NS_IMETHODIMP nsMsgAttachedFile::GetXMacCreator(nsACString &amp; aXMacCreator)</span>
<a href="#l33.6424"></a><span id="l33.6424" class="difflineminus">-{</span>
<a href="#l33.6425"></a><span id="l33.6425" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::GetXMacCreator(nsACString &amp;aXMacCreator) {</span>
<a href="#l33.6426"></a><span id="l33.6426">   aXMacCreator = m_xMacCreator;</span>
<a href="#l33.6427"></a><span id="l33.6427">   return NS_OK;</span>
<a href="#l33.6428"></a><span id="l33.6428"> }</span>
<a href="#l33.6429"></a><span id="l33.6429"> </span>
<a href="#l33.6430"></a><span id="l33.6430" class="difflineminus">-NS_IMETHODIMP nsMsgAttachedFile::SetXMacCreator(const nsACString &amp; aXMacCreator)</span>
<a href="#l33.6431"></a><span id="l33.6431" class="difflineminus">-{</span>
<a href="#l33.6432"></a><span id="l33.6432" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::SetXMacCreator(</span>
<a href="#l33.6433"></a><span id="l33.6433" class="difflineplus">+    const nsACString &amp;aXMacCreator) {</span>
<a href="#l33.6434"></a><span id="l33.6434">   m_xMacCreator = aXMacCreator;</span>
<a href="#l33.6435"></a><span id="l33.6435">   return NS_OK;</span>
<a href="#l33.6436"></a><span id="l33.6436"> }</span>
<a href="#l33.6437"></a><span id="l33.6437"> </span>
<a href="#l33.6438"></a><span id="l33.6438" class="difflineminus">-NS_IMETHODIMP nsMsgAttachedFile::GetRealName(nsACString &amp; aRealName)</span>
<a href="#l33.6439"></a><span id="l33.6439" class="difflineminus">-{</span>
<a href="#l33.6440"></a><span id="l33.6440" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::GetRealName(nsACString &amp;aRealName) {</span>
<a href="#l33.6441"></a><span id="l33.6441">   aRealName = m_realName;</span>
<a href="#l33.6442"></a><span id="l33.6442">   return NS_OK;</span>
<a href="#l33.6443"></a><span id="l33.6443"> }</span>
<a href="#l33.6444"></a><span id="l33.6444"> </span>
<a href="#l33.6445"></a><span id="l33.6445" class="difflineminus">-NS_IMETHODIMP nsMsgAttachedFile::SetRealName(const nsACString &amp; aRealName)</span>
<a href="#l33.6446"></a><span id="l33.6446" class="difflineminus">-{</span>
<a href="#l33.6447"></a><span id="l33.6447" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::SetRealName(const nsACString &amp;aRealName) {</span>
<a href="#l33.6448"></a><span id="l33.6448">   m_realName = aRealName;</span>
<a href="#l33.6449"></a><span id="l33.6449">   return NS_OK;</span>
<a href="#l33.6450"></a><span id="l33.6450"> }</span>
<a href="#l33.6451"></a><span id="l33.6451"> </span>
<a href="#l33.6452"></a><span id="l33.6452" class="difflineminus">-NS_IMETHODIMP nsMsgAttachedFile::GetSize(uint32_t *aSize)</span>
<a href="#l33.6453"></a><span id="l33.6453" class="difflineminus">-{</span>
<a href="#l33.6454"></a><span id="l33.6454" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::GetSize(uint32_t *aSize) {</span>
<a href="#l33.6455"></a><span id="l33.6455">   NS_ENSURE_ARG_POINTER(aSize);</span>
<a href="#l33.6456"></a><span id="l33.6456">   *aSize = m_size;</span>
<a href="#l33.6457"></a><span id="l33.6457">   return NS_OK;</span>
<a href="#l33.6458"></a><span id="l33.6458"> }</span>
<a href="#l33.6459"></a><span id="l33.6459"> </span>
<a href="#l33.6460"></a><span id="l33.6460" class="difflineminus">-NS_IMETHODIMP nsMsgAttachedFile::SetSize(uint32_t aSize)</span>
<a href="#l33.6461"></a><span id="l33.6461" class="difflineminus">-{</span>
<a href="#l33.6462"></a><span id="l33.6462" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::SetSize(uint32_t aSize) {</span>
<a href="#l33.6463"></a><span id="l33.6463">   m_size = aSize;</span>
<a href="#l33.6464"></a><span id="l33.6464">   return NS_OK;</span>
<a href="#l33.6465"></a><span id="l33.6465"> }</span>
<a href="#l33.6466"></a><span id="l33.6466"> </span>
<a href="#l33.6467"></a><span id="l33.6467" class="difflineminus">-NS_IMETHODIMP nsMsgAttachedFile::GetUnprintableCount(uint32_t *aUnprintableCount)</span>
<a href="#l33.6468"></a><span id="l33.6468" class="difflineminus">-{</span>
<a href="#l33.6469"></a><span id="l33.6469" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::GetUnprintableCount(</span>
<a href="#l33.6470"></a><span id="l33.6470" class="difflineplus">+    uint32_t *aUnprintableCount) {</span>
<a href="#l33.6471"></a><span id="l33.6471">   NS_ENSURE_ARG_POINTER(aUnprintableCount);</span>
<a href="#l33.6472"></a><span id="l33.6472">   *aUnprintableCount = m_unprintableCount;</span>
<a href="#l33.6473"></a><span id="l33.6473">   return NS_OK;</span>
<a href="#l33.6474"></a><span id="l33.6474"> }</span>
<a href="#l33.6475"></a><span id="l33.6475"> </span>
<a href="#l33.6476"></a><span id="l33.6476" class="difflineminus">-NS_IMETHODIMP nsMsgAttachedFile::SetUnprintableCount(uint32_t aUnprintableCount)</span>
<a href="#l33.6477"></a><span id="l33.6477" class="difflineminus">-{</span>
<a href="#l33.6478"></a><span id="l33.6478" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::SetUnprintableCount(</span>
<a href="#l33.6479"></a><span id="l33.6479" class="difflineplus">+    uint32_t aUnprintableCount) {</span>
<a href="#l33.6480"></a><span id="l33.6480">   m_unprintableCount = aUnprintableCount;</span>
<a href="#l33.6481"></a><span id="l33.6481">   return NS_OK;</span>
<a href="#l33.6482"></a><span id="l33.6482"> }</span>
<a href="#l33.6483"></a><span id="l33.6483"> </span>
<a href="#l33.6484"></a><span id="l33.6484" class="difflineminus">-NS_IMETHODIMP nsMsgAttachedFile::GetHighbitCount(uint32_t *aHighbitCount)</span>
<a href="#l33.6485"></a><span id="l33.6485" class="difflineminus">-{</span>
<a href="#l33.6486"></a><span id="l33.6486" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::GetHighbitCount(uint32_t *aHighbitCount) {</span>
<a href="#l33.6487"></a><span id="l33.6487">   NS_ENSURE_ARG_POINTER(aHighbitCount);</span>
<a href="#l33.6488"></a><span id="l33.6488">   *aHighbitCount = m_highbitCount;</span>
<a href="#l33.6489"></a><span id="l33.6489">   return NS_OK;</span>
<a href="#l33.6490"></a><span id="l33.6490"> }</span>
<a href="#l33.6491"></a><span id="l33.6491" class="difflineminus">-NS_IMETHODIMP nsMsgAttachedFile::SetHighbitCount(uint32_t aHighbitCount)</span>
<a href="#l33.6492"></a><span id="l33.6492" class="difflineminus">-{</span>
<a href="#l33.6493"></a><span id="l33.6493" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::SetHighbitCount(uint32_t aHighbitCount) {</span>
<a href="#l33.6494"></a><span id="l33.6494">   m_highbitCount = aHighbitCount;</span>
<a href="#l33.6495"></a><span id="l33.6495">   return NS_OK;</span>
<a href="#l33.6496"></a><span id="l33.6496"> }</span>
<a href="#l33.6497"></a><span id="l33.6497"> </span>
<a href="#l33.6498"></a><span id="l33.6498" class="difflineminus">-NS_IMETHODIMP nsMsgAttachedFile::GetCtlCount(uint32_t *aCtlCount)</span>
<a href="#l33.6499"></a><span id="l33.6499" class="difflineminus">-{</span>
<a href="#l33.6500"></a><span id="l33.6500" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::GetCtlCount(uint32_t *aCtlCount) {</span>
<a href="#l33.6501"></a><span id="l33.6501">   NS_ENSURE_ARG_POINTER(aCtlCount);</span>
<a href="#l33.6502"></a><span id="l33.6502">   *aCtlCount = m_ctlCount;</span>
<a href="#l33.6503"></a><span id="l33.6503">   return NS_OK;</span>
<a href="#l33.6504"></a><span id="l33.6504"> }</span>
<a href="#l33.6505"></a><span id="l33.6505"> </span>
<a href="#l33.6506"></a><span id="l33.6506" class="difflineminus">-NS_IMETHODIMP nsMsgAttachedFile::SetCtlCount(uint32_t aCtlCount)</span>
<a href="#l33.6507"></a><span id="l33.6507" class="difflineminus">-{</span>
<a href="#l33.6508"></a><span id="l33.6508" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::SetCtlCount(uint32_t aCtlCount) {</span>
<a href="#l33.6509"></a><span id="l33.6509">   m_ctlCount = aCtlCount;</span>
<a href="#l33.6510"></a><span id="l33.6510">   return NS_OK;</span>
<a href="#l33.6511"></a><span id="l33.6511"> }</span>
<a href="#l33.6512"></a><span id="l33.6512"> </span>
<a href="#l33.6513"></a><span id="l33.6513" class="difflineminus">-NS_IMETHODIMP nsMsgAttachedFile::GetNullCount(uint32_t *aNullCount)</span>
<a href="#l33.6514"></a><span id="l33.6514" class="difflineminus">-{</span>
<a href="#l33.6515"></a><span id="l33.6515" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::GetNullCount(uint32_t *aNullCount) {</span>
<a href="#l33.6516"></a><span id="l33.6516">   NS_ENSURE_ARG_POINTER(aNullCount);</span>
<a href="#l33.6517"></a><span id="l33.6517">   *aNullCount = m_nullCount;</span>
<a href="#l33.6518"></a><span id="l33.6518">   return NS_OK;</span>
<a href="#l33.6519"></a><span id="l33.6519"> }</span>
<a href="#l33.6520"></a><span id="l33.6520"> </span>
<a href="#l33.6521"></a><span id="l33.6521" class="difflineminus">-NS_IMETHODIMP nsMsgAttachedFile::SetNullCount(uint32_t aNullCount)</span>
<a href="#l33.6522"></a><span id="l33.6522" class="difflineminus">-{</span>
<a href="#l33.6523"></a><span id="l33.6523" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::SetNullCount(uint32_t aNullCount) {</span>
<a href="#l33.6524"></a><span id="l33.6524">   m_nullCount = aNullCount;</span>
<a href="#l33.6525"></a><span id="l33.6525">   return NS_OK;</span>
<a href="#l33.6526"></a><span id="l33.6526"> }</span>
<a href="#l33.6527"></a><span id="l33.6527"> </span>
<a href="#l33.6528"></a><span id="l33.6528" class="difflineminus">-NS_IMETHODIMP nsMsgAttachedFile::GetMaxLineLength(uint32_t *aMaxLineLength)</span>
<a href="#l33.6529"></a><span id="l33.6529" class="difflineminus">-{</span>
<a href="#l33.6530"></a><span id="l33.6530" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::GetMaxLineLength(uint32_t *aMaxLineLength) {</span>
<a href="#l33.6531"></a><span id="l33.6531">   NS_ENSURE_ARG_POINTER(aMaxLineLength);</span>
<a href="#l33.6532"></a><span id="l33.6532">   *aMaxLineLength = m_maxLineLength;</span>
<a href="#l33.6533"></a><span id="l33.6533">   return NS_OK;</span>
<a href="#l33.6534"></a><span id="l33.6534"> }</span>
<a href="#l33.6535"></a><span id="l33.6535"> </span>
<a href="#l33.6536"></a><span id="l33.6536" class="difflineminus">-NS_IMETHODIMP nsMsgAttachedFile::SetMaxLineLength(uint32_t aMaxLineLength)</span>
<a href="#l33.6537"></a><span id="l33.6537" class="difflineminus">-{</span>
<a href="#l33.6538"></a><span id="l33.6538" class="difflineplus">+NS_IMETHODIMP nsMsgAttachedFile::SetMaxLineLength(uint32_t aMaxLineLength) {</span>
<a href="#l33.6539"></a><span id="l33.6539">   m_maxLineLength = aMaxLineLength;</span>
<a href="#l33.6540"></a><span id="l33.6540">   return NS_OK;</span>
<a href="#l33.6541"></a><span id="l33.6541"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSend.h</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSend.h</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -98,17 +98,16 @@</span>
<a href="#l34.4"></a><span id="l34.4"> </span>
<a href="#l34.5"></a><span id="l34.5">    If GENERATE_CONTENT_BASE, we generate a Content-Base header.</span>
<a href="#l34.6"></a><span id="l34.6"> </span>
<a href="#l34.7"></a><span id="l34.7">    We used to have a MANGLE_HTML_ATTACHMENTS_WITH_BASE_TAG symbol that we</span>
<a href="#l34.8"></a><span id="l34.8">    defined, which added a BASE tag to the bodies.  We stopped doing this in</span>
<a href="#l34.9"></a><span id="l34.9">    4.0.  */</span>
<a href="#l34.10"></a><span id="l34.10"> #define GENERATE_CONTENT_BASE</span>
<a href="#l34.11"></a><span id="l34.11"> </span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-</span>
<a href="#l34.13"></a><span id="l34.13"> //</span>
<a href="#l34.14"></a><span id="l34.14"> // Necessary includes</span>
<a href="#l34.15"></a><span id="l34.15"> //</span>
<a href="#l34.16"></a><span id="l34.16"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l34.17"></a><span id="l34.17"> #include &quot;nsIMsgSend.h&quot;</span>
<a href="#l34.18"></a><span id="l34.18"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l34.19"></a><span id="l34.19"> #include &quot;msgCore.h&quot;</span>
<a href="#l34.20"></a><span id="l34.20"> #include &quot;prprf.h&quot;</span>
<a href="#l34.21"></a><span id="l34.21" class="difflineat">@@ -131,277 +130,294 @@</span>
<a href="#l34.22"></a><span id="l34.22"> #include &quot;nsIMsgFilterService.h&quot;</span>
<a href="#l34.23"></a><span id="l34.23"> #include &quot;nsIMsgOperationListener.h&quot;</span>
<a href="#l34.24"></a><span id="l34.24"> #include &quot;nsMsgIncomingServer.h&quot;</span>
<a href="#l34.25"></a><span id="l34.25"> #include &quot;mozilla/dom/Element.h&quot;</span>
<a href="#l34.26"></a><span id="l34.26"> </span>
<a href="#l34.27"></a><span id="l34.27"> //</span>
<a href="#l34.28"></a><span id="l34.28"> // Some necessary defines...</span>
<a href="#l34.29"></a><span id="l34.29"> //</span>
<a href="#l34.30"></a><span id="l34.30" class="difflineminus">-#define MIME_BUFFER_SIZE      4096 // must be greater than 1000</span>
<a href="#l34.31"></a><span id="l34.31" class="difflineminus">-                                   // SMTP (RFC821) limit</span>
<a href="#l34.32"></a><span id="l34.32" class="difflineplus">+// must be greater than 1000, SMTP (RFC821) limit</span>
<a href="#l34.33"></a><span id="l34.33" class="difflineplus">+#define MIME_BUFFER_SIZE 4096</span>
<a href="#l34.34"></a><span id="l34.34" class="difflineplus">+</span>
<a href="#l34.35"></a><span id="l34.35"> // Maximum number of bytes we allow in a line before we force</span>
<a href="#l34.36"></a><span id="l34.36"> // encoding to base64 if not already QR-encoded or of type message/rfc822.</span>
<a href="#l34.37"></a><span id="l34.37"> #define LINELENGTH_ENCODING_THRESHOLD 990</span>
<a href="#l34.38"></a><span id="l34.38"> </span>
<a href="#l34.39"></a><span id="l34.39"> //</span>
<a href="#l34.40"></a><span id="l34.40"> // Utilities for string handling</span>
<a href="#l34.41"></a><span id="l34.41"> //</span>
<a href="#l34.42"></a><span id="l34.42" class="difflineminus">-#define PUSH_STRING(S) \</span>
<a href="#l34.43"></a><span id="l34.43" class="difflineminus">- do { PL_strcpy (buffer_tail, S); buffer_tail += PL_strlen (S); } while(0)</span>
<a href="#l34.44"></a><span id="l34.44" class="difflineminus">-#define PUSH_STRINGN(S,N) \</span>
<a href="#l34.45"></a><span id="l34.45" class="difflineminus">- do { memcpy(buffer_tail, (S), (N)); buffer_tail += (N); } while(0)</span>
<a href="#l34.46"></a><span id="l34.46" class="difflineminus">-#define PUSH_NEWLINE() \</span>
<a href="#l34.47"></a><span id="l34.47" class="difflineminus">- do { *buffer_tail++ = '\r'; *buffer_tail++ = '\n'; *buffer_tail = '\0'; } while(0)</span>
<a href="#l34.48"></a><span id="l34.48" class="difflineplus">+#define PUSH_STRING(S)           \</span>
<a href="#l34.49"></a><span id="l34.49" class="difflineplus">+  do {                           \</span>
<a href="#l34.50"></a><span id="l34.50" class="difflineplus">+    PL_strcpy(buffer_tail, S);   \</span>
<a href="#l34.51"></a><span id="l34.51" class="difflineplus">+    buffer_tail += PL_strlen(S); \</span>
<a href="#l34.52"></a><span id="l34.52" class="difflineplus">+  } while (0)</span>
<a href="#l34.53"></a><span id="l34.53" class="difflineplus">+#define PUSH_STRINGN(S, N)         \</span>
<a href="#l34.54"></a><span id="l34.54" class="difflineplus">+  do {                             \</span>
<a href="#l34.55"></a><span id="l34.55" class="difflineplus">+    memcpy(buffer_tail, (S), (N)); \</span>
<a href="#l34.56"></a><span id="l34.56" class="difflineplus">+    buffer_tail += (N);            \</span>
<a href="#l34.57"></a><span id="l34.57" class="difflineplus">+  } while (0)</span>
<a href="#l34.58"></a><span id="l34.58" class="difflineplus">+#define PUSH_NEWLINE()     \</span>
<a href="#l34.59"></a><span id="l34.59" class="difflineplus">+  do {                     \</span>
<a href="#l34.60"></a><span id="l34.60" class="difflineplus">+    *buffer_tail++ = '\r'; \</span>
<a href="#l34.61"></a><span id="l34.61" class="difflineplus">+    *buffer_tail++ = '\n'; \</span>
<a href="#l34.62"></a><span id="l34.62" class="difflineplus">+    *buffer_tail = '\0';   \</span>
<a href="#l34.63"></a><span id="l34.63" class="difflineplus">+  } while (0)</span>
<a href="#l34.64"></a><span id="l34.64"> </span>
<a href="#l34.65"></a><span id="l34.65"> //</span>
<a href="#l34.66"></a><span id="l34.66"> // Forward declarations...</span>
<a href="#l34.67"></a><span id="l34.67"> //</span>
<a href="#l34.68"></a><span id="l34.68"> class nsMsgSendPart;</span>
<a href="#l34.69"></a><span id="l34.69"> class nsMsgCopy;</span>
<a href="#l34.70"></a><span id="l34.70"> class nsIPrompt;</span>
<a href="#l34.71"></a><span id="l34.71"> class nsIInterfaceRequestor;</span>
<a href="#l34.72"></a><span id="l34.72"> </span>
<a href="#l34.73"></a><span id="l34.73"> namespace mozilla {</span>
<a href="#l34.74"></a><span id="l34.74"> namespace mailnews {</span>
<a href="#l34.75"></a><span id="l34.75"> class MimeEncoder;</span>
<a href="#l34.76"></a><span id="l34.76"> }</span>
<a href="#l34.77"></a><span id="l34.77" class="difflineminus">-}</span>
<a href="#l34.78"></a><span id="l34.78" class="difflineplus">+}  // namespace mozilla</span>
<a href="#l34.79"></a><span id="l34.79"> </span>
<a href="#l34.80"></a><span id="l34.80"> class nsMsgComposeAndSend : public nsIMsgSend,</span>
<a href="#l34.81"></a><span id="l34.81">                             public nsIMsgOperationListener,</span>
<a href="#l34.82"></a><span id="l34.82" class="difflineminus">-                            public nsSupportsWeakReference</span>
<a href="#l34.83"></a><span id="l34.83" class="difflineminus">-{</span>
<a href="#l34.84"></a><span id="l34.84" class="difflineplus">+                            public nsSupportsWeakReference {</span>
<a href="#l34.85"></a><span id="l34.85">   typedef mozilla::mailnews::MimeEncoder MimeEncoder;</span>
<a href="#l34.86"></a><span id="l34.86" class="difflineminus">-public:</span>
<a href="#l34.87"></a><span id="l34.87" class="difflineplus">+</span>
<a href="#l34.88"></a><span id="l34.88" class="difflineplus">+ public:</span>
<a href="#l34.89"></a><span id="l34.89">   //</span>
<a href="#l34.90"></a><span id="l34.90">   // Define QueryInterface, AddRef and Release for this class</span>
<a href="#l34.91"></a><span id="l34.91">   //</span>
<a href="#l34.92"></a><span id="l34.92">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l34.93"></a><span id="l34.93">   NS_DECL_NSIMSGSEND</span>
<a href="#l34.94"></a><span id="l34.94">   NS_DECL_NSIMSGOPERATIONLISTENER</span>
<a href="#l34.95"></a><span id="l34.95"> </span>
<a href="#l34.96"></a><span id="l34.96">   nsMsgComposeAndSend();</span>
<a href="#l34.97"></a><span id="l34.97"> </span>
<a href="#l34.98"></a><span id="l34.98" class="difflineplus">+  // Delivery and completion callback routines...</span>
<a href="#l34.99"></a><span id="l34.99" class="difflineplus">+  NS_IMETHOD DeliverMessage();</span>
<a href="#l34.100"></a><span id="l34.100" class="difflineplus">+  NS_IMETHOD DeliverFileAsMail();</span>
<a href="#l34.101"></a><span id="l34.101" class="difflineplus">+  NS_IMETHOD DeliverFileAsNews();</span>
<a href="#l34.102"></a><span id="l34.102" class="difflineplus">+  void DoDeliveryExitProcessing(nsIURI *aUrl, nsresult aExitCode,</span>
<a href="#l34.103"></a><span id="l34.103" class="difflineplus">+                                bool aCheckForMail);</span>
<a href="#l34.104"></a><span id="l34.104" class="difflineplus">+  nsresult FormatStringWithSMTPHostNameByName(const char *aMsgName,</span>
<a href="#l34.105"></a><span id="l34.105" class="difflineplus">+                                              nsAString &amp;aString);</span>
<a href="#l34.106"></a><span id="l34.106"> </span>
<a href="#l34.107"></a><span id="l34.107" class="difflineminus">-  // Delivery and completion callback routines...</span>
<a href="#l34.108"></a><span id="l34.108" class="difflineminus">-  NS_IMETHOD  DeliverMessage();</span>
<a href="#l34.109"></a><span id="l34.109" class="difflineminus">-  NS_IMETHOD  DeliverFileAsMail();</span>
<a href="#l34.110"></a><span id="l34.110" class="difflineminus">-  NS_IMETHOD  DeliverFileAsNews();</span>
<a href="#l34.111"></a><span id="l34.111" class="difflineminus">-  void        DoDeliveryExitProcessing(nsIURI * aUrl, nsresult aExitCode, bool aCheckForMail);</span>
<a href="#l34.112"></a><span id="l34.112" class="difflineminus">-  nsresult    FormatStringWithSMTPHostNameByName(const char* aMsgName, nsAString&amp; aString);</span>
<a href="#l34.113"></a><span id="l34.113" class="difflineminus">-</span>
<a href="#l34.114"></a><span id="l34.114" class="difflineminus">-  nsresult    DoFcc();</span>
<a href="#l34.115"></a><span id="l34.115" class="difflineminus">-  nsresult    StartMessageCopyOperation(nsIFile          *aFileSpec,</span>
<a href="#l34.116"></a><span id="l34.116" class="difflineminus">-                                        nsMsgDeliverMode mode,</span>
<a href="#l34.117"></a><span id="l34.117" class="difflineminus">-                                        const nsCString&amp; dest_uri);</span>
<a href="#l34.118"></a><span id="l34.118" class="difflineminus">-</span>
<a href="#l34.119"></a><span id="l34.119" class="difflineplus">+  nsresult DoFcc();</span>
<a href="#l34.120"></a><span id="l34.120" class="difflineplus">+  nsresult StartMessageCopyOperation(nsIFile *aFileSpec, nsMsgDeliverMode mode,</span>
<a href="#l34.121"></a><span id="l34.121" class="difflineplus">+                                     const nsCString &amp;dest_uri);</span>
<a href="#l34.122"></a><span id="l34.122"> </span>
<a href="#l34.123"></a><span id="l34.123">   nsresult SendToMagicFolder(nsMsgDeliverMode flag);</span>
<a href="#l34.124"></a><span id="l34.124"> </span>
<a href="#l34.125"></a><span id="l34.125">   // For the folderURL return the corresponding pointer to the incoming server.</span>
<a href="#l34.126"></a><span id="l34.126" class="difflineminus">-  nsresult GetIncomingServer(const char *folderURL, nsIMsgIncomingServer **aServer);</span>
<a href="#l34.127"></a><span id="l34.127" class="difflineplus">+  nsresult GetIncomingServer(const char *folderURL,</span>
<a href="#l34.128"></a><span id="l34.128" class="difflineplus">+                             nsIMsgIncomingServer **aServer);</span>
<a href="#l34.129"></a><span id="l34.129"> </span>
<a href="#l34.130"></a><span id="l34.130">   // Check to see if it's ok to save msgs to the configured folder.</span>
<a href="#l34.131"></a><span id="l34.131">   bool CanSaveMessagesToFolder(const char *folderURL);</span>
<a href="#l34.132"></a><span id="l34.132"> </span>
<a href="#l34.133"></a><span id="l34.133">   //</span>
<a href="#l34.134"></a><span id="l34.134">   // FCC operations...</span>
<a href="#l34.135"></a><span id="l34.135">   //</span>
<a href="#l34.136"></a><span id="l34.136" class="difflineminus">-  nsresult    MimeDoFCC (nsIFile *input_file,</span>
<a href="#l34.137"></a><span id="l34.137" class="difflineminus">-    nsMsgDeliverMode mode,</span>
<a href="#l34.138"></a><span id="l34.138" class="difflineminus">-    const char *bcc_header,</span>
<a href="#l34.139"></a><span id="l34.139" class="difflineminus">-    const char *fcc_header,</span>
<a href="#l34.140"></a><span id="l34.140" class="difflineminus">-    const char *news_url);</span>
<a href="#l34.141"></a><span id="l34.141" class="difflineplus">+  nsresult MimeDoFCC(nsIFile *input_file, nsMsgDeliverMode mode,</span>
<a href="#l34.142"></a><span id="l34.142" class="difflineplus">+                     const char *bcc_header, const char *fcc_header,</span>
<a href="#l34.143"></a><span id="l34.143" class="difflineplus">+                     const char *news_url);</span>
<a href="#l34.144"></a><span id="l34.144"> </span>
<a href="#l34.145"></a><span id="l34.145">   // Init() will allow for either message creation without delivery or full</span>
<a href="#l34.146"></a><span id="l34.146">   // message creation and send operations</span>
<a href="#l34.147"></a><span id="l34.147">   //</span>
<a href="#l34.148"></a><span id="l34.148" class="difflineminus">-  nsresult    Init(</span>
<a href="#l34.149"></a><span id="l34.149" class="difflineminus">-                   nsIMsgIdentity   *aUserIdentity,</span>
<a href="#l34.150"></a><span id="l34.150" class="difflineminus">-                   const char       *aAccountKey,</span>
<a href="#l34.151"></a><span id="l34.151" class="difflineminus">-                   nsMsgCompFields  *fields,</span>
<a href="#l34.152"></a><span id="l34.152" class="difflineminus">-                   nsIFile          *sendFile,</span>
<a href="#l34.153"></a><span id="l34.153" class="difflineminus">-                   bool             digest_p,</span>
<a href="#l34.154"></a><span id="l34.154" class="difflineminus">-                   bool             dont_deliver_p,</span>
<a href="#l34.155"></a><span id="l34.155" class="difflineminus">-                   nsMsgDeliverMode mode,</span>
<a href="#l34.156"></a><span id="l34.156" class="difflineminus">-                   nsIMsgDBHdr      *msgToReplace,</span>
<a href="#l34.157"></a><span id="l34.157" class="difflineminus">-                   const char       *attachment1_type,</span>
<a href="#l34.158"></a><span id="l34.158" class="difflineminus">-                   const nsACString &amp;attachment1_body,</span>
<a href="#l34.159"></a><span id="l34.159" class="difflineminus">-                   nsIArray   *attachments,</span>
<a href="#l34.160"></a><span id="l34.160" class="difflineminus">-                   nsIArray     *preloaded_attachments,</span>
<a href="#l34.161"></a><span id="l34.161" class="difflineminus">-                   const nsAString &amp;password,</span>
<a href="#l34.162"></a><span id="l34.162" class="difflineminus">-                   const nsACString &amp;aOriginalMsgURI,</span>
<a href="#l34.163"></a><span id="l34.163" class="difflineminus">-                   MSG_ComposeType  aType);</span>
<a href="#l34.164"></a><span id="l34.164" class="difflineplus">+  nsresult Init(nsIMsgIdentity *aUserIdentity, const char *aAccountKey,</span>
<a href="#l34.165"></a><span id="l34.165" class="difflineplus">+                nsMsgCompFields *fields, nsIFile *sendFile, bool digest_p,</span>
<a href="#l34.166"></a><span id="l34.166" class="difflineplus">+                bool dont_deliver_p, nsMsgDeliverMode mode,</span>
<a href="#l34.167"></a><span id="l34.167" class="difflineplus">+                nsIMsgDBHdr *msgToReplace, const char *attachment1_type,</span>
<a href="#l34.168"></a><span id="l34.168" class="difflineplus">+                const nsACString &amp;attachment1_body, nsIArray *attachments,</span>
<a href="#l34.169"></a><span id="l34.169" class="difflineplus">+                nsIArray *preloaded_attachments, const nsAString &amp;password,</span>
<a href="#l34.170"></a><span id="l34.170" class="difflineplus">+                const nsACString &amp;aOriginalMsgURI, MSG_ComposeType aType);</span>
<a href="#l34.171"></a><span id="l34.171"> </span>
<a href="#l34.172"></a><span id="l34.172">   //</span>
<a href="#l34.173"></a><span id="l34.173">   // Setup the composition fields</span>
<a href="#l34.174"></a><span id="l34.174">   //</span>
<a href="#l34.175"></a><span id="l34.175" class="difflineminus">-  nsresult    InitCompositionFields(nsMsgCompFields *fields,</span>
<a href="#l34.176"></a><span id="l34.176" class="difflineminus">-                                    const nsACString &amp;aOriginalMsgURI,</span>
<a href="#l34.177"></a><span id="l34.177" class="difflineminus">-                                    MSG_ComposeType aType);</span>
<a href="#l34.178"></a><span id="l34.178" class="difflineplus">+  nsresult InitCompositionFields(nsMsgCompFields *fields,</span>
<a href="#l34.179"></a><span id="l34.179" class="difflineplus">+                                 const nsACString &amp;aOriginalMsgURI,</span>
<a href="#l34.180"></a><span id="l34.180" class="difflineplus">+                                 MSG_ComposeType aType);</span>
<a href="#l34.181"></a><span id="l34.181"> </span>
<a href="#l34.182"></a><span id="l34.182" class="difflineminus">-  NS_IMETHOD  GetBodyFromEditor();</span>
<a href="#l34.183"></a><span id="l34.183" class="difflineminus">-</span>
<a href="#l34.184"></a><span id="l34.184" class="difflineplus">+  NS_IMETHOD GetBodyFromEditor();</span>
<a href="#l34.185"></a><span id="l34.185"> </span>
<a href="#l34.186"></a><span id="l34.186">   //</span>
<a href="#l34.187"></a><span id="l34.187">   // Attachment processing...</span>
<a href="#l34.188"></a><span id="l34.188">   //</span>
<a href="#l34.189"></a><span id="l34.189" class="difflineminus">-  nsresult    HackAttachments(nsIArray *attachments,</span>
<a href="#l34.190"></a><span id="l34.190" class="difflineminus">-                              nsIArray *preloaded_attachments);</span>
<a href="#l34.191"></a><span id="l34.191" class="difflineminus">-  nsresult    CountCompFieldAttachments();</span>
<a href="#l34.192"></a><span id="l34.192" class="difflineminus">-  nsresult    AddCompFieldLocalAttachments();</span>
<a href="#l34.193"></a><span id="l34.193" class="difflineminus">-  nsresult    AddCompFieldRemoteAttachments(uint32_t  aStartLocation, int32_t *aMailboxCount, int32_t *aNewsCount);</span>
<a href="#l34.194"></a><span id="l34.194" class="difflineplus">+  nsresult HackAttachments(nsIArray *attachments,</span>
<a href="#l34.195"></a><span id="l34.195" class="difflineplus">+                           nsIArray *preloaded_attachments);</span>
<a href="#l34.196"></a><span id="l34.196" class="difflineplus">+  nsresult CountCompFieldAttachments();</span>
<a href="#l34.197"></a><span id="l34.197" class="difflineplus">+  nsresult AddCompFieldLocalAttachments();</span>
<a href="#l34.198"></a><span id="l34.198" class="difflineplus">+  nsresult AddCompFieldRemoteAttachments(uint32_t aStartLocation,</span>
<a href="#l34.199"></a><span id="l34.199" class="difflineplus">+                                         int32_t *aMailboxCount,</span>
<a href="#l34.200"></a><span id="l34.200" class="difflineplus">+                                         int32_t *aNewsCount);</span>
<a href="#l34.201"></a><span id="l34.201"> </span>
<a href="#l34.202"></a><span id="l34.202">   // Deal with multipart related data</span>
<a href="#l34.203"></a><span id="l34.203" class="difflineminus">-  nsresult    ProcessMultipartRelated(int32_t *aMailboxCount, int32_t *aNewsCount);</span>
<a href="#l34.204"></a><span id="l34.204" class="difflineminus">-  nsresult    GetEmbeddedObjectInfo(mozilla::dom::Element *domElement, nsMsgAttachmentData *attachment, bool *acceptObject);</span>
<a href="#l34.205"></a><span id="l34.205" class="difflineminus">-  uint32_t    GetMultipartRelatedCount(bool forceToBeCalculated = false);</span>
<a href="#l34.206"></a><span id="l34.206" class="difflineminus">-  nsCOMPtr&lt;nsIArray&gt; mEmbeddedObjectList; // it's initialized when calling GetMultipartRelatedCount</span>
<a href="#l34.207"></a><span id="l34.207" class="difflineplus">+  nsresult ProcessMultipartRelated(int32_t *aMailboxCount, int32_t *aNewsCount);</span>
<a href="#l34.208"></a><span id="l34.208" class="difflineplus">+  nsresult GetEmbeddedObjectInfo(mozilla::dom::Element *domElement,</span>
<a href="#l34.209"></a><span id="l34.209" class="difflineplus">+                                 nsMsgAttachmentData *attachment,</span>
<a href="#l34.210"></a><span id="l34.210" class="difflineplus">+                                 bool *acceptObject);</span>
<a href="#l34.211"></a><span id="l34.211" class="difflineplus">+  uint32_t GetMultipartRelatedCount(bool forceToBeCalculated = false);</span>
<a href="#l34.212"></a><span id="l34.212" class="difflineplus">+  nsCOMPtr&lt;nsIArray&gt; mEmbeddedObjectList;  // it's initialized when calling</span>
<a href="#l34.213"></a><span id="l34.213" class="difflineplus">+                                           // GetMultipartRelatedCount</span>
<a href="#l34.214"></a><span id="l34.214"> </span>
<a href="#l34.215"></a><span id="l34.215">   // Body processing</span>
<a href="#l34.216"></a><span id="l34.216" class="difflineminus">-  nsresult    SnarfAndCopyBody(const nsACString &amp;attachment1_body,</span>
<a href="#l34.217"></a><span id="l34.217" class="difflineminus">-                               const char  *attachment1_type);</span>
<a href="#l34.218"></a><span id="l34.218" class="difflineplus">+  nsresult SnarfAndCopyBody(const nsACString &amp;attachment1_body,</span>
<a href="#l34.219"></a><span id="l34.219" class="difflineplus">+                            const char *attachment1_type);</span>
<a href="#l34.220"></a><span id="l34.220"> </span>
<a href="#l34.221"></a><span id="l34.221" class="difflineminus">-  int32_t     PreProcessPart(nsMsgAttachmentHandler  *ma,</span>
<a href="#l34.222"></a><span id="l34.222" class="difflineminus">-                             nsMsgSendPart           *toppart); // The very top most container of the message</span>
<a href="#l34.223"></a><span id="l34.223" class="difflineminus">-                                                                // For part processing</span>
<a href="#l34.224"></a><span id="l34.224" class="difflineplus">+  int32_t PreProcessPart(</span>
<a href="#l34.225"></a><span id="l34.225" class="difflineplus">+      nsMsgAttachmentHandler *ma,</span>
<a href="#l34.226"></a><span id="l34.226" class="difflineplus">+      nsMsgSendPart *toppart);  // The very top most container of the message</span>
<a href="#l34.227"></a><span id="l34.227" class="difflineplus">+                                // For part processing</span>
<a href="#l34.228"></a><span id="l34.228"> </span>
<a href="#l34.229"></a><span id="l34.229" class="difflineminus">-  nsresult    SetStatusMessage(const nsString &amp;aMsgString);     // Status message method</span>
<a href="#l34.230"></a><span id="l34.230" class="difflineplus">+  nsresult SetStatusMessage(</span>
<a href="#l34.231"></a><span id="l34.231" class="difflineplus">+      const nsString &amp;aMsgString);  // Status message method</span>
<a href="#l34.232"></a><span id="l34.232"> </span>
<a href="#l34.233"></a><span id="l34.233">   //</span>
<a href="#l34.234"></a><span id="l34.234">   // All vars necessary for this implementation</span>
<a href="#l34.235"></a><span id="l34.235">   //</span>
<a href="#l34.236"></a><span id="l34.236" class="difflineminus">-  nsMsgKey                  m_messageKey;        // jt -- Draft/Template support; newly created key</span>
<a href="#l34.237"></a><span id="l34.237" class="difflineminus">-  nsCOMPtr&lt;nsIMsgIdentity&gt;  mUserIdentity;</span>
<a href="#l34.238"></a><span id="l34.238" class="difflineminus">-  nsCString                 mAccountKey;</span>
<a href="#l34.239"></a><span id="l34.239" class="difflineminus">-  RefPtr&lt;nsMsgCompFields&gt; mCompFields;         // All needed composition fields (header, etc...)</span>
<a href="#l34.240"></a><span id="l34.240" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt;         mTempFile;           // our temporary file</span>
<a href="#l34.241"></a><span id="l34.241" class="difflineplus">+  nsMsgKey m_messageKey;  // jt -- Draft/Template support; newly created key</span>
<a href="#l34.242"></a><span id="l34.242" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIdentity&gt; mUserIdentity;</span>
<a href="#l34.243"></a><span id="l34.243" class="difflineplus">+  nsCString mAccountKey;</span>
<a href="#l34.244"></a><span id="l34.244" class="difflineplus">+  RefPtr&lt;nsMsgCompFields&gt;</span>
<a href="#l34.245"></a><span id="l34.245" class="difflineplus">+      mCompFields;  // All needed composition fields (header, etc...)</span>
<a href="#l34.246"></a><span id="l34.246" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; mTempFile;  // our temporary file</span>
<a href="#l34.247"></a><span id="l34.247"> </span>
<a href="#l34.248"></a><span id="l34.248" class="difflineminus">-  nsCOMPtr&lt;nsIOutputStream&gt; mOutputFile;         // the actual output file stream</span>
<a href="#l34.249"></a><span id="l34.249" class="difflineminus">-  uint32_t                  mMessageWarningSize; // Warn if a message is over this size!</span>
<a href="#l34.250"></a><span id="l34.250" class="difflineplus">+  nsCOMPtr&lt;nsIOutputStream&gt; mOutputFile;  // the actual output file stream</span>
<a href="#l34.251"></a><span id="l34.251" class="difflineplus">+  uint32_t mMessageWarningSize;  // Warn if a message is over this size!</span>
<a href="#l34.252"></a><span id="l34.252"> </span>
<a href="#l34.253"></a><span id="l34.253" class="difflineminus">-  bool                      m_dont_deliver_p;    // If set, we just return the nsIFile of the file</span>
<a href="#l34.254"></a><span id="l34.254" class="difflineminus">-                                                 // created, instead of actually delivering message.</span>
<a href="#l34.255"></a><span id="l34.255" class="difflineminus">-  nsMsgDeliverMode          m_deliver_mode;      // nsMsgDeliverNow, nsMsgQueueForLater, nsMsgSaveAsDraft,</span>
<a href="#l34.256"></a><span id="l34.256" class="difflineminus">-                                                 // nsMsgSaveAsTemplate and nsMsgSendUnsent</span>
<a href="#l34.257"></a><span id="l34.257" class="difflineminus">-  nsCOMPtr&lt;nsIMsgDBHdr&gt;     mMsgToReplace;       // If the mode is nsMsgSaveAsDraft, this is the message it will</span>
<a href="#l34.258"></a><span id="l34.258" class="difflineminus">-                                                 // replace</span>
<a href="#l34.259"></a><span id="l34.259" class="difflineminus">-  nsString mSavedToFolderName; // Name of folder we're saving to, used when</span>
<a href="#l34.260"></a><span id="l34.260" class="difflineminus">-                               // displaying error on save.</span>
<a href="#l34.261"></a><span id="l34.261" class="difflineplus">+  bool m_dont_deliver_p;  // If set, we just return the nsIFile of the file</span>
<a href="#l34.262"></a><span id="l34.262" class="difflineplus">+                          // created, instead of actually delivering message.</span>
<a href="#l34.263"></a><span id="l34.263" class="difflineplus">+  nsMsgDeliverMode</span>
<a href="#l34.264"></a><span id="l34.264" class="difflineplus">+      m_deliver_mode;  // nsMsgDeliverNow, nsMsgQueueForLater, nsMsgSaveAsDraft,</span>
<a href="#l34.265"></a><span id="l34.265" class="difflineplus">+                       // nsMsgSaveAsTemplate and nsMsgSendUnsent</span>
<a href="#l34.266"></a><span id="l34.266" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; mMsgToReplace;  // If the mode is nsMsgSaveAsDraft, this</span>
<a href="#l34.267"></a><span id="l34.267" class="difflineplus">+                                        // is the message it will replace</span>
<a href="#l34.268"></a><span id="l34.268" class="difflineplus">+  nsString mSavedToFolderName;  // Name of folder we're saving to, used when</span>
<a href="#l34.269"></a><span id="l34.269" class="difflineplus">+                                // displaying error on save.</span>
<a href="#l34.270"></a><span id="l34.270">   // These are needed for callbacks to the FE...</span>
<a href="#l34.271"></a><span id="l34.271" class="difflineminus">-  nsCOMPtr&lt;nsPIDOMWindowOuter&gt;    mParentWindow;</span>
<a href="#l34.272"></a><span id="l34.272" class="difflineminus">-  nsCOMPtr&lt;nsIMsgProgress&gt;        mSendProgress;</span>
<a href="#l34.273"></a><span id="l34.273" class="difflineminus">-  nsCOMPtr&lt;nsIMsgSendListener&gt;    mListener;</span>
<a href="#l34.274"></a><span id="l34.274" class="difflineminus">-  nsCOMPtr&lt;nsIMsgStatusFeedback&gt;  mStatusFeedback;</span>
<a href="#l34.275"></a><span id="l34.275" class="difflineminus">-  nsCOMPtr&lt;nsIRequest&gt;      mRunningRequest;</span>
<a href="#l34.276"></a><span id="l34.276" class="difflineminus">-  bool                      mSendMailAlso;</span>
<a href="#l34.277"></a><span id="l34.277" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt;         mReturnFile;     // a holder for file spec's to be returned to caller</span>
<a href="#l34.278"></a><span id="l34.278" class="difflineplus">+  nsCOMPtr&lt;nsPIDOMWindowOuter&gt; mParentWindow;</span>
<a href="#l34.279"></a><span id="l34.279" class="difflineplus">+  nsCOMPtr&lt;nsIMsgProgress&gt; mSendProgress;</span>
<a href="#l34.280"></a><span id="l34.280" class="difflineplus">+  nsCOMPtr&lt;nsIMsgSendListener&gt; mListener;</span>
<a href="#l34.281"></a><span id="l34.281" class="difflineplus">+  nsCOMPtr&lt;nsIMsgStatusFeedback&gt; mStatusFeedback;</span>
<a href="#l34.282"></a><span id="l34.282" class="difflineplus">+  nsCOMPtr&lt;nsIRequest&gt; mRunningRequest;</span>
<a href="#l34.283"></a><span id="l34.283" class="difflineplus">+  bool mSendMailAlso;</span>
<a href="#l34.284"></a><span id="l34.284" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt;</span>
<a href="#l34.285"></a><span id="l34.285" class="difflineplus">+      mReturnFile;  // a holder for file spec's to be returned to caller</span>
<a href="#l34.286"></a><span id="l34.286"> </span>
<a href="#l34.287"></a><span id="l34.287">   // File where we stored our HTML so that we could make the plaintext form.</span>
<a href="#l34.288"></a><span id="l34.288" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt;         mHTMLFile;</span>
<a href="#l34.289"></a><span id="l34.289" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; mHTMLFile;</span>
<a href="#l34.290"></a><span id="l34.290"> </span>
<a href="#l34.291"></a><span id="l34.291">   // Variable for storing the draft name;</span>
<a href="#l34.292"></a><span id="l34.292" class="difflineminus">-  nsCString                  m_folderName;</span>
<a href="#l34.293"></a><span id="l34.293" class="difflineplus">+  nsCString m_folderName;</span>
<a href="#l34.294"></a><span id="l34.294"> </span>
<a href="#l34.295"></a><span id="l34.295">   // mapping between editor dom node indexes and saved mime part numbers.</span>
<a href="#l34.296"></a><span id="l34.296">   nsTArray&lt;nsCString&gt; m_partNumbers;</span>
<a href="#l34.297"></a><span id="l34.297">   //</span>
<a href="#l34.298"></a><span id="l34.298">   // These variables are needed for message Copy operations!</span>
<a href="#l34.299"></a><span id="l34.299">   //</span>
<a href="#l34.300"></a><span id="l34.300" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt;         mCopyFile;</span>
<a href="#l34.301"></a><span id="l34.301" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt;         mCopyFile2;</span>
<a href="#l34.302"></a><span id="l34.302" class="difflineminus">-  RefPtr&lt;nsMsgCopy&gt;       mCopyObj;</span>
<a href="#l34.303"></a><span id="l34.303" class="difflineminus">-  bool                      mNeedToPerformSecondFCC;</span>
<a href="#l34.304"></a><span id="l34.304" class="difflineminus">-  bool                      mPerformingSecondFCC;</span>
<a href="#l34.305"></a><span id="l34.305" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; mCopyFile;</span>
<a href="#l34.306"></a><span id="l34.306" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; mCopyFile2;</span>
<a href="#l34.307"></a><span id="l34.307" class="difflineplus">+  RefPtr&lt;nsMsgCopy&gt; mCopyObj;</span>
<a href="#l34.308"></a><span id="l34.308" class="difflineplus">+  bool mNeedToPerformSecondFCC;</span>
<a href="#l34.309"></a><span id="l34.309" class="difflineplus">+  bool mPerformingSecondFCC;</span>
<a href="#l34.310"></a><span id="l34.310"> </span>
<a href="#l34.311"></a><span id="l34.311">   // For MHTML message creation</span>
<a href="#l34.312"></a><span id="l34.312" class="difflineminus">-  nsCOMPtr&lt;nsIEditor&gt;       mEditor;</span>
<a href="#l34.313"></a><span id="l34.313" class="difflineplus">+  nsCOMPtr&lt;nsIEditor&gt; mEditor;</span>
<a href="#l34.314"></a><span id="l34.314"> </span>
<a href="#l34.315"></a><span id="l34.315">   //</span>
<a href="#l34.316"></a><span id="l34.316">   // The first attachment, if any (typed in by the user.)</span>
<a href="#l34.317"></a><span id="l34.317">   //</span>
<a href="#l34.318"></a><span id="l34.318" class="difflineminus">-  char                    *m_attachment1_type;</span>
<a href="#l34.319"></a><span id="l34.319" class="difflineminus">-  char                    *m_attachment1_encoding;</span>
<a href="#l34.320"></a><span id="l34.320" class="difflineminus">-  nsAutoPtr&lt;MimeEncoder&gt;  m_attachment1_encoder;</span>
<a href="#l34.321"></a><span id="l34.321" class="difflineminus">-  char                    *m_attachment1_body;</span>
<a href="#l34.322"></a><span id="l34.322" class="difflineminus">-  uint32_t                m_attachment1_body_length;</span>
<a href="#l34.323"></a><span id="l34.323" class="difflineminus">-  char                    *mOriginalHTMLBody;</span>
<a href="#l34.324"></a><span id="l34.324" class="difflineplus">+  char *m_attachment1_type;</span>
<a href="#l34.325"></a><span id="l34.325" class="difflineplus">+  char *m_attachment1_encoding;</span>
<a href="#l34.326"></a><span id="l34.326" class="difflineplus">+  nsAutoPtr&lt;MimeEncoder&gt; m_attachment1_encoder;</span>
<a href="#l34.327"></a><span id="l34.327" class="difflineplus">+  char *m_attachment1_body;</span>
<a href="#l34.328"></a><span id="l34.328" class="difflineplus">+  uint32_t m_attachment1_body_length;</span>
<a href="#l34.329"></a><span id="l34.329" class="difflineplus">+  char *mOriginalHTMLBody;</span>
<a href="#l34.330"></a><span id="l34.330"> </span>
<a href="#l34.331"></a><span id="l34.331">   // The plaintext form of the first attachment, if needed.</span>
<a href="#l34.332"></a><span id="l34.332" class="difflineminus">-  RefPtr&lt;nsMsgAttachmentHandler&gt;  m_plaintext;</span>
<a href="#l34.333"></a><span id="l34.333" class="difflineplus">+  RefPtr&lt;nsMsgAttachmentHandler&gt; m_plaintext;</span>
<a href="#l34.334"></a><span id="l34.334"> </span>
<a href="#l34.335"></a><span id="l34.335">   // The multipart/related save object for HTML text.</span>
<a href="#l34.336"></a><span id="l34.336" class="difflineminus">-  nsMsgSendPart           *m_related_part;</span>
<a href="#l34.337"></a><span id="l34.337" class="difflineminus">-  nsMsgSendPart           *m_related_body_part;</span>
<a href="#l34.338"></a><span id="l34.338" class="difflineplus">+  nsMsgSendPart *m_related_part;</span>
<a href="#l34.339"></a><span id="l34.339" class="difflineplus">+  nsMsgSendPart *m_related_body_part;</span>
<a href="#l34.340"></a><span id="l34.340"> </span>
<a href="#l34.341"></a><span id="l34.341">   //</span>
<a href="#l34.342"></a><span id="l34.342">   // Subsequent attachments, if any.</span>
<a href="#l34.343"></a><span id="l34.343">   //</span>
<a href="#l34.344"></a><span id="l34.344" class="difflineminus">-  uint32_t                m_attachment_count;</span>
<a href="#l34.345"></a><span id="l34.345" class="difflineminus">-  uint32_t                m_attachment_pending_count;</span>
<a href="#l34.346"></a><span id="l34.346" class="difflineminus">-  nsTArray&lt; RefPtr&lt;nsMsgAttachmentHandler&gt; &gt;  m_attachments;</span>
<a href="#l34.347"></a><span id="l34.347" class="difflineminus">-  nsresult                m_status; // in case some attachments fail but not all</span>
<a href="#l34.348"></a><span id="l34.348" class="difflineplus">+  uint32_t m_attachment_count;</span>
<a href="#l34.349"></a><span id="l34.349" class="difflineplus">+  uint32_t m_attachment_pending_count;</span>
<a href="#l34.350"></a><span id="l34.350" class="difflineplus">+  nsTArray&lt;RefPtr&lt;nsMsgAttachmentHandler&gt; &gt; m_attachments;</span>
<a href="#l34.351"></a><span id="l34.351" class="difflineplus">+  nsresult m_status;  // in case some attachments fail but not all</span>
<a href="#l34.352"></a><span id="l34.352"> </span>
<a href="#l34.353"></a><span id="l34.353" class="difflineminus">-  uint32_t                mPreloadedAttachmentCount;</span>
<a href="#l34.354"></a><span id="l34.354" class="difflineminus">-  uint32_t                mRemoteAttachmentCount;</span>
<a href="#l34.355"></a><span id="l34.355" class="difflineminus">-  int32_t                 mMultipartRelatedAttachmentCount; // the number of mpart related attachments, -1 means it has not been yet initialized</span>
<a href="#l34.356"></a><span id="l34.356" class="difflineplus">+  uint32_t mPreloadedAttachmentCount;</span>
<a href="#l34.357"></a><span id="l34.357" class="difflineplus">+  uint32_t mRemoteAttachmentCount;</span>
<a href="#l34.358"></a><span id="l34.358" class="difflineplus">+  int32_t mMultipartRelatedAttachmentCount;  // the number of mpart related</span>
<a href="#l34.359"></a><span id="l34.359" class="difflineplus">+                                             // attachments, -1 means it has not</span>
<a href="#l34.360"></a><span id="l34.360" class="difflineplus">+                                             // been yet initialized</span>
<a href="#l34.361"></a><span id="l34.361"> </span>
<a href="#l34.362"></a><span id="l34.362" class="difflineminus">-  uint32_t                mCompFieldLocalAttachments;     // the number of file:// attachments in the comp fields</span>
<a href="#l34.363"></a><span id="l34.363" class="difflineminus">-  uint32_t                mCompFieldRemoteAttachments;    // the number of remote attachments in the comp fields</span>
<a href="#l34.364"></a><span id="l34.364" class="difflineplus">+  uint32_t mCompFieldLocalAttachments;   // the number of file:// attachments in</span>
<a href="#l34.365"></a><span id="l34.365" class="difflineplus">+                                         // the comp fields</span>
<a href="#l34.366"></a><span id="l34.366" class="difflineplus">+  uint32_t mCompFieldRemoteAttachments;  // the number of remote attachments in</span>
<a href="#l34.367"></a><span id="l34.367" class="difflineplus">+                                         // the comp fields</span>
<a href="#l34.368"></a><span id="l34.368"> </span>
<a href="#l34.369"></a><span id="l34.369">   //</span>
<a href="#l34.370"></a><span id="l34.370">   // attachment states and other info...</span>
<a href="#l34.371"></a><span id="l34.371">   //</span>
<a href="#l34.372"></a><span id="l34.372" class="difflineminus">-  bool                    m_pre_snarfed_attachments_p;  // If true, then the attachments were</span>
<a href="#l34.373"></a><span id="l34.373" class="difflineminus">-                                                        // loaded by in the background and therefore</span>
<a href="#l34.374"></a><span id="l34.374" class="difflineminus">-                                                        // we shouldn't delete the tmp files (but should</span>
<a href="#l34.375"></a><span id="l34.375" class="difflineminus">-                                                        // leave that to the caller.)</span>
<a href="#l34.376"></a><span id="l34.376" class="difflineplus">+  bool</span>
<a href="#l34.377"></a><span id="l34.377" class="difflineplus">+      m_pre_snarfed_attachments_p;  // If true, then the attachments were</span>
<a href="#l34.378"></a><span id="l34.378" class="difflineplus">+                                    // loaded by in the background and therefore</span>
<a href="#l34.379"></a><span id="l34.379" class="difflineplus">+                                    // we shouldn't delete the tmp files (but</span>
<a href="#l34.380"></a><span id="l34.380" class="difflineplus">+                                    // should leave that to the caller.)</span>
<a href="#l34.381"></a><span id="l34.381"> </span>
<a href="#l34.382"></a><span id="l34.382" class="difflineminus">-  bool                    m_digest_p;                   // Whether to be multipart/digest instead of</span>
<a href="#l34.383"></a><span id="l34.383" class="difflineminus">-                                                        // multipart/mixed.</span>
<a href="#l34.384"></a><span id="l34.384" class="difflineplus">+  bool m_digest_p;  // Whether to be multipart/digest instead of</span>
<a href="#l34.385"></a><span id="l34.385" class="difflineplus">+                    // multipart/mixed.</span>
<a href="#l34.386"></a><span id="l34.386"> </span>
<a href="#l34.387"></a><span id="l34.387" class="difflineminus">-  bool                    m_be_synchronous_p;            // If true, we will load one URL after another,</span>
<a href="#l34.388"></a><span id="l34.388" class="difflineminus">-                                                        // rather than starting all URLs going at once</span>
<a href="#l34.389"></a><span id="l34.389" class="difflineminus">-                                                        // and letting them load in parallel.  This is</span>
<a href="#l34.390"></a><span id="l34.390" class="difflineminus">-                                                        // more efficient if (for example) all URLs are</span>
<a href="#l34.391"></a><span id="l34.391" class="difflineminus">-                                                        // known to be coming from the same news server</span>
<a href="#l34.392"></a><span id="l34.392" class="difflineminus">-                                                        // or mailbox: loading them in parallel would</span>
<a href="#l34.393"></a><span id="l34.393" class="difflineminus">-                                                        // cause multiple connections to the news</span>
<a href="#l34.394"></a><span id="l34.394" class="difflineminus">-                                                        // server to be opened, or would cause much seek()ing.</span>
<a href="#l34.395"></a><span id="l34.395" class="difflineplus">+  bool m_be_synchronous_p;  // If true, we will load one URL after another,</span>
<a href="#l34.396"></a><span id="l34.396" class="difflineplus">+                            // rather than starting all URLs going at once</span>
<a href="#l34.397"></a><span id="l34.397" class="difflineplus">+                            // and letting them load in parallel.  This is</span>
<a href="#l34.398"></a><span id="l34.398" class="difflineplus">+                            // more efficient if (for example) all URLs are</span>
<a href="#l34.399"></a><span id="l34.399" class="difflineplus">+                            // known to be coming from the same news server</span>
<a href="#l34.400"></a><span id="l34.400" class="difflineplus">+                            // or mailbox: loading them in parallel would</span>
<a href="#l34.401"></a><span id="l34.401" class="difflineplus">+                            // cause multiple connections to the news</span>
<a href="#l34.402"></a><span id="l34.402" class="difflineplus">+                            // server to be opened, or would cause much</span>
<a href="#l34.403"></a><span id="l34.403" class="difflineplus">+                            // seek()ing.</span>
<a href="#l34.404"></a><span id="l34.404"> </span>
<a href="#l34.405"></a><span id="l34.405" class="difflineminus">-  bool                    mGUINotificationEnabled;      // Should we throw up the GUI alerts on errors?</span>
<a href="#l34.406"></a><span id="l34.406" class="difflineminus">-  bool                    mAbortInProcess;              // Used by Abort to avoid reentrance.</span>
<a href="#l34.407"></a><span id="l34.407" class="difflineplus">+  bool mGUINotificationEnabled;  // Should we throw up the GUI alerts on errors?</span>
<a href="#l34.408"></a><span id="l34.408" class="difflineplus">+  bool mAbortInProcess;          // Used by Abort to avoid reentrance.</span>
<a href="#l34.409"></a><span id="l34.409"> </span>
<a href="#l34.410"></a><span id="l34.410">   nsCOMPtr&lt;nsIMsgComposeSecure&gt; m_crypto_closure;</span>
<a href="#l34.411"></a><span id="l34.411"> </span>
<a href="#l34.412"></a><span id="l34.412" class="difflineminus">-protected:</span>
<a href="#l34.413"></a><span id="l34.413" class="difflineplus">+ protected:</span>
<a href="#l34.414"></a><span id="l34.414">   nsCOMPtr&lt;nsIStringBundle&gt; mComposeBundle;</span>
<a href="#l34.415"></a><span id="l34.415" class="difflineminus">-  nsresult GetNotificationCallbacks(nsIInterfaceRequestor** aCallbacks);</span>
<a href="#l34.416"></a><span id="l34.416" class="difflineplus">+  nsresult GetNotificationCallbacks(nsIInterfaceRequestor **aCallbacks);</span>
<a href="#l34.417"></a><span id="l34.417"> </span>
<a href="#l34.418"></a><span id="l34.418">   virtual ~nsMsgComposeAndSend();</span>
<a href="#l34.419"></a><span id="l34.419">   nsresult FilterSentMessage();</span>
<a href="#l34.420"></a><span id="l34.420">   nsresult MaybePerformSecondFCC(nsresult aStatus);</span>
<a href="#l34.421"></a><span id="l34.421"> </span>
<a href="#l34.422"></a><span id="l34.422">   // generates a message id for our message, if necessary</span>
<a href="#l34.423"></a><span id="l34.423" class="difflineminus">-  void GenerateMessageId( );</span>
<a href="#l34.424"></a><span id="l34.424" class="difflineplus">+  void GenerateMessageId();</span>
<a href="#l34.425"></a><span id="l34.425"> </span>
<a href="#l34.426"></a><span id="l34.426">   // add default custom headers to the message</span>
<a href="#l34.427"></a><span id="l34.427">   nsresult AddDefaultCustomHeaders();</span>
<a href="#l34.428"></a><span id="l34.428"> </span>
<a href="#l34.429"></a><span id="l34.429">   // add Mail-Followup-To and Mail-Reply-To header</span>
<a href="#l34.430"></a><span id="l34.430">   nsresult AddMailFollowupToHeader();</span>
<a href="#l34.431"></a><span id="l34.431">   nsresult AddMailReplyToHeader();</span>
<a href="#l34.432"></a><span id="l34.432">   nsresult AddXForwardedMessageIdHeader();</span>
<a href="#l34.433"></a><span id="l34.433"> </span>
<a href="#l34.434"></a><span id="l34.434" class="difflineminus">-  nsCOMPtr&lt;nsIMsgSendReport&gt;  mSendReport;</span>
<a href="#l34.435"></a><span id="l34.435" class="difflineminus">-  nsString                    mSmtpPassword;            // store the smtp Password use during a send</span>
<a href="#l34.436"></a><span id="l34.436" class="difflineplus">+  nsCOMPtr&lt;nsIMsgSendReport&gt; mSendReport;</span>
<a href="#l34.437"></a><span id="l34.437" class="difflineplus">+  nsString mSmtpPassword;  // store the smtp Password use during a send</span>
<a href="#l34.438"></a><span id="l34.438"> };</span>
<a href="#l34.439"></a><span id="l34.439"> </span>
<a href="#l34.440"></a><span id="l34.440"> //</span>
<a href="#l34.441"></a><span id="l34.441"> // These C routines should only be used by the nsMsgSendPart class.</span>
<a href="#l34.442"></a><span id="l34.442"> //</span>
<a href="#l34.443"></a><span id="l34.443" class="difflineminus">-extern nsresult mime_write_message_body(nsIMsgSend *state, const char *buf, uint32_t size);</span>
<a href="#l34.444"></a><span id="l34.444" class="difflineminus">-extern char   *mime_get_stream_write_buffer(void);</span>
<a href="#l34.445"></a><span id="l34.445" class="difflineminus">-extern nsresult mime_encoder_output_fn (const char *buf, int32_t size, void *closure);</span>
<a href="#l34.446"></a><span id="l34.446" class="difflineplus">+extern nsresult mime_write_message_body(nsIMsgSend *state, const char *buf,</span>
<a href="#l34.447"></a><span id="l34.447" class="difflineplus">+                                        uint32_t size);</span>
<a href="#l34.448"></a><span id="l34.448" class="difflineplus">+extern char *mime_get_stream_write_buffer(void);</span>
<a href="#l34.449"></a><span id="l34.449" class="difflineplus">+extern nsresult mime_encoder_output_fn(const char *buf, int32_t size,</span>
<a href="#l34.450"></a><span id="l34.450" class="difflineplus">+                                       void *closure);</span>
<a href="#l34.451"></a><span id="l34.451"> extern bool UseQuotedPrintable(void);</span>
<a href="#l34.452"></a><span id="l34.452"> </span>
<a href="#l34.453"></a><span id="l34.453"> #endif /*  __MSGSEND_H__ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSendLater.cpp</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSendLater.cpp</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -33,27 +33,21 @@</span>
<a href="#l35.4"></a><span id="l35.4"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l35.5"></a><span id="l35.5"> </span>
<a href="#l35.6"></a><span id="l35.6"> // Consts for checking and sending mail in milliseconds</span>
<a href="#l35.7"></a><span id="l35.7"> </span>
<a href="#l35.8"></a><span id="l35.8"> // 1 second from mail into the unsent messages folder to initially trying to</span>
<a href="#l35.9"></a><span id="l35.9"> // send it.</span>
<a href="#l35.10"></a><span id="l35.10"> const uint32_t kInitialMessageSendTime = 1000;</span>
<a href="#l35.11"></a><span id="l35.11"> </span>
<a href="#l35.12"></a><span id="l35.12" class="difflineminus">-NS_IMPL_ISUPPORTS(nsMsgSendLater,</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineminus">-                   nsIMsgSendLater,</span>
<a href="#l35.14"></a><span id="l35.14" class="difflineminus">-                   nsIFolderListener,</span>
<a href="#l35.15"></a><span id="l35.15" class="difflineminus">-                   nsIRequestObserver,</span>
<a href="#l35.16"></a><span id="l35.16" class="difflineminus">-                   nsIStreamListener,</span>
<a href="#l35.17"></a><span id="l35.17" class="difflineminus">-                   nsIObserver,</span>
<a href="#l35.18"></a><span id="l35.18" class="difflineminus">-                   nsIUrlListener,</span>
<a href="#l35.19"></a><span id="l35.19" class="difflineminus">-                   nsIMsgShutdownTask)</span>
<a href="#l35.20"></a><span id="l35.20" class="difflineplus">+NS_IMPL_ISUPPORTS(nsMsgSendLater, nsIMsgSendLater, nsIFolderListener,</span>
<a href="#l35.21"></a><span id="l35.21" class="difflineplus">+                  nsIRequestObserver, nsIStreamListener, nsIObserver,</span>
<a href="#l35.22"></a><span id="l35.22" class="difflineplus">+                  nsIUrlListener, nsIMsgShutdownTask)</span>
<a href="#l35.23"></a><span id="l35.23"> </span>
<a href="#l35.24"></a><span id="l35.24" class="difflineminus">-nsMsgSendLater::nsMsgSendLater()</span>
<a href="#l35.25"></a><span id="l35.25" class="difflineminus">-{</span>
<a href="#l35.26"></a><span id="l35.26" class="difflineplus">+nsMsgSendLater::nsMsgSendLater() {</span>
<a href="#l35.27"></a><span id="l35.27">   mSendingMessages = false;</span>
<a href="#l35.28"></a><span id="l35.28">   mTimerSet = false;</span>
<a href="#l35.29"></a><span id="l35.29">   mTotalSentSuccessfully = 0;</span>
<a href="#l35.30"></a><span id="l35.30">   mTotalSendCount = 0;</span>
<a href="#l35.31"></a><span id="l35.31">   mLeftoverBuffer = nullptr;</span>
<a href="#l35.32"></a><span id="l35.32"> </span>
<a href="#l35.33"></a><span id="l35.33">   m_to = nullptr;</span>
<a href="#l35.34"></a><span id="l35.34">   m_bcc = nullptr;</span>
<a href="#l35.35"></a><span id="l35.35" class="difflineat">@@ -70,45 +64,41 @@ nsMsgSendLater::nsMsgSendLater()</span>
<a href="#l35.36"></a><span id="l35.36">   m_position = 0;</span>
<a href="#l35.37"></a><span id="l35.37">   m_flagsPosition = 0;</span>
<a href="#l35.38"></a><span id="l35.38">   m_headersSize = 0;</span>
<a href="#l35.39"></a><span id="l35.39"> </span>
<a href="#l35.40"></a><span id="l35.40">   mIdentityKey = nullptr;</span>
<a href="#l35.41"></a><span id="l35.41">   mAccountKey = nullptr;</span>
<a href="#l35.42"></a><span id="l35.42"> }</span>
<a href="#l35.43"></a><span id="l35.43"> </span>
<a href="#l35.44"></a><span id="l35.44" class="difflineminus">-nsMsgSendLater::~nsMsgSendLater()</span>
<a href="#l35.45"></a><span id="l35.45" class="difflineminus">-{</span>
<a href="#l35.46"></a><span id="l35.46" class="difflineplus">+nsMsgSendLater::~nsMsgSendLater() {</span>
<a href="#l35.47"></a><span id="l35.47">   PR_Free(m_to);</span>
<a href="#l35.48"></a><span id="l35.48">   PR_Free(m_fcc);</span>
<a href="#l35.49"></a><span id="l35.49">   PR_Free(m_bcc);</span>
<a href="#l35.50"></a><span id="l35.50">   PR_Free(m_newsgroups);</span>
<a href="#l35.51"></a><span id="l35.51">   PR_Free(m_newshost);</span>
<a href="#l35.52"></a><span id="l35.52">   PR_Free(m_headers);</span>
<a href="#l35.53"></a><span id="l35.53">   PR_Free(mLeftoverBuffer);</span>
<a href="#l35.54"></a><span id="l35.54">   PR_Free(mIdentityKey);</span>
<a href="#l35.55"></a><span id="l35.55">   PR_Free(mAccountKey);</span>
<a href="#l35.56"></a><span id="l35.56"> }</span>
<a href="#l35.57"></a><span id="l35.57"> </span>
<a href="#l35.58"></a><span id="l35.58" class="difflineminus">-nsresult</span>
<a href="#l35.59"></a><span id="l35.59" class="difflineminus">-nsMsgSendLater::Init()</span>
<a href="#l35.60"></a><span id="l35.60" class="difflineminus">-{</span>
<a href="#l35.61"></a><span id="l35.61" class="difflineplus">+nsresult nsMsgSendLater::Init() {</span>
<a href="#l35.62"></a><span id="l35.62">   nsresult rv;</span>
<a href="#l35.63"></a><span id="l35.63">   nsCOMPtr&lt;nsIPrefBranch&gt; prefs = do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l35.64"></a><span id="l35.64">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l35.65"></a><span id="l35.65"> </span>
<a href="#l35.66"></a><span id="l35.66">   bool sendInBackground;</span>
<a href="#l35.67"></a><span id="l35.67">   rv = prefs-&gt;GetBoolPref(&quot;mailnews.sendInBackground&quot;, &amp;sendInBackground);</span>
<a href="#l35.68"></a><span id="l35.68">   // If we're not sending in the background, don't do anything else</span>
<a href="#l35.69"></a><span id="l35.69" class="difflineminus">-  if (NS_FAILED(rv) || !sendInBackground)</span>
<a href="#l35.70"></a><span id="l35.70" class="difflineminus">-    return NS_OK;</span>
<a href="#l35.71"></a><span id="l35.71" class="difflineplus">+  if (NS_FAILED(rv) || !sendInBackground) return NS_OK;</span>
<a href="#l35.72"></a><span id="l35.72"> </span>
<a href="#l35.73"></a><span id="l35.73">   // We need to know when we're shutting down.</span>
<a href="#l35.74"></a><span id="l35.74">   nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l35.75"></a><span id="l35.75" class="difflineminus">-    mozilla::services::GetObserverService();</span>
<a href="#l35.76"></a><span id="l35.76" class="difflineplus">+      mozilla::services::GetObserverService();</span>
<a href="#l35.77"></a><span id="l35.77">   NS_ENSURE_TRUE(observerService, NS_ERROR_UNEXPECTED);</span>
<a href="#l35.78"></a><span id="l35.78"> </span>
<a href="#l35.79"></a><span id="l35.79">   rv = observerService-&gt;AddObserver(this, &quot;xpcom-shutdown&quot;, false);</span>
<a href="#l35.80"></a><span id="l35.80">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l35.81"></a><span id="l35.81"> </span>
<a href="#l35.82"></a><span id="l35.82">   rv = observerService-&gt;AddObserver(this, &quot;quit-application&quot;, false);</span>
<a href="#l35.83"></a><span id="l35.83">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l35.84"></a><span id="l35.84"> </span>
<a href="#l35.85"></a><span id="l35.85" class="difflineat">@@ -116,537 +106,468 @@ nsMsgSendLater::Init()</span>
<a href="#l35.86"></a><span id="l35.86">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l35.87"></a><span id="l35.87"> </span>
<a href="#l35.88"></a><span id="l35.88">   // Subscribe to the unsent messages folder</span>
<a href="#l35.89"></a><span id="l35.89">   // XXX This code should be set up for multiple unsent folders, however we</span>
<a href="#l35.90"></a><span id="l35.90">   // don't support that at the moment, so for now just assume one folder.</span>
<a href="#l35.91"></a><span id="l35.91">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l35.92"></a><span id="l35.92">   rv = GetUnsentMessagesFolder(nullptr, getter_AddRefs(folder));</span>
<a href="#l35.93"></a><span id="l35.93">   // There doesn't have to be a nsMsgQueueForLater flagged folder.</span>
<a href="#l35.94"></a><span id="l35.94" class="difflineminus">-  if (NS_FAILED(rv) || !folder)</span>
<a href="#l35.95"></a><span id="l35.95" class="difflineminus">-    return NS_OK;</span>
<a href="#l35.96"></a><span id="l35.96" class="difflineplus">+  if (NS_FAILED(rv) || !folder) return NS_OK;</span>
<a href="#l35.97"></a><span id="l35.97"> </span>
<a href="#l35.98"></a><span id="l35.98">   rv = folder-&gt;AddFolderListener(this);</span>
<a href="#l35.99"></a><span id="l35.99">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l35.100"></a><span id="l35.100"> </span>
<a href="#l35.101"></a><span id="l35.101">   // XXX may want to send messages X seconds after startup if there are any.</span>
<a href="#l35.102"></a><span id="l35.102"> </span>
<a href="#l35.103"></a><span id="l35.103">   return NS_OK;</span>
<a href="#l35.104"></a><span id="l35.104"> }</span>
<a href="#l35.105"></a><span id="l35.105"> </span>
<a href="#l35.106"></a><span id="l35.106"> NS_IMETHODIMP</span>
<a href="#l35.107"></a><span id="l35.107" class="difflineminus">-nsMsgSendLater::Observe(nsISupports *aSubject, const char* aTopic,</span>
<a href="#l35.108"></a><span id="l35.108" class="difflineminus">-                        const char16_t *aData)</span>
<a href="#l35.109"></a><span id="l35.109" class="difflineminus">-{</span>
<a href="#l35.110"></a><span id="l35.110" class="difflineminus">-  if (aSubject == mTimer &amp;&amp; !strcmp(aTopic, &quot;timer-callback&quot;))</span>
<a href="#l35.111"></a><span id="l35.111" class="difflineminus">-  {</span>
<a href="#l35.112"></a><span id="l35.112" class="difflineplus">+nsMsgSendLater::Observe(nsISupports *aSubject, const char *aTopic,</span>
<a href="#l35.113"></a><span id="l35.113" class="difflineplus">+                        const char16_t *aData) {</span>
<a href="#l35.114"></a><span id="l35.114" class="difflineplus">+  if (aSubject == mTimer &amp;&amp; !strcmp(aTopic, &quot;timer-callback&quot;)) {</span>
<a href="#l35.115"></a><span id="l35.115">     if (mTimer)</span>
<a href="#l35.116"></a><span id="l35.116">       mTimer-&gt;Cancel();</span>
<a href="#l35.117"></a><span id="l35.117">     else</span>
<a href="#l35.118"></a><span id="l35.118">       NS_ERROR(&quot;mTimer was null in nsMsgSendLater::Observe&quot;);</span>
<a href="#l35.119"></a><span id="l35.119"> </span>
<a href="#l35.120"></a><span id="l35.120">     mTimerSet = false;</span>
<a href="#l35.121"></a><span id="l35.121">     // If we've already started a send since the timer fired, don't start</span>
<a href="#l35.122"></a><span id="l35.122">     // another</span>
<a href="#l35.123"></a><span id="l35.123" class="difflineminus">-    if (!mSendingMessages)</span>
<a href="#l35.124"></a><span id="l35.124" class="difflineminus">-      InternalSendMessages(false, nullptr);</span>
<a href="#l35.125"></a><span id="l35.125" class="difflineminus">-  }</span>
<a href="#l35.126"></a><span id="l35.126" class="difflineminus">-  else if (!strcmp(aTopic, &quot;quit-application&quot;))</span>
<a href="#l35.127"></a><span id="l35.127" class="difflineminus">-  {</span>
<a href="#l35.128"></a><span id="l35.128" class="difflineplus">+    if (!mSendingMessages) InternalSendMessages(false, nullptr);</span>
<a href="#l35.129"></a><span id="l35.129" class="difflineplus">+  } else if (!strcmp(aTopic, &quot;quit-application&quot;)) {</span>
<a href="#l35.130"></a><span id="l35.130">     // If the timer is set, cancel it - we're quitting, the shutdown service</span>
<a href="#l35.131"></a><span id="l35.131">     // interfaces will sort out sending etc.</span>
<a href="#l35.132"></a><span id="l35.132" class="difflineminus">-    if (mTimer)</span>
<a href="#l35.133"></a><span id="l35.133" class="difflineminus">-      mTimer-&gt;Cancel();</span>
<a href="#l35.134"></a><span id="l35.134" class="difflineplus">+    if (mTimer) mTimer-&gt;Cancel();</span>
<a href="#l35.135"></a><span id="l35.135"> </span>
<a href="#l35.136"></a><span id="l35.136">     mTimerSet = false;</span>
<a href="#l35.137"></a><span id="l35.137" class="difflineminus">-  }</span>
<a href="#l35.138"></a><span id="l35.138" class="difflineminus">-  else if (!strcmp(aTopic, NS_XPCOM_SHUTDOWN_OBSERVER_ID))</span>
<a href="#l35.139"></a><span id="l35.139" class="difflineminus">-  {</span>
<a href="#l35.140"></a><span id="l35.140" class="difflineplus">+  } else if (!strcmp(aTopic, NS_XPCOM_SHUTDOWN_OBSERVER_ID)) {</span>
<a href="#l35.141"></a><span id="l35.141">     // We're shutting down. Unsubscribe from the unsentFolder notifications</span>
<a href="#l35.142"></a><span id="l35.142">     // they aren't any use to us now, we don't want to start sending more</span>
<a href="#l35.143"></a><span id="l35.143">     // messages.</span>
<a href="#l35.144"></a><span id="l35.144">     nsresult rv;</span>
<a href="#l35.145"></a><span id="l35.145" class="difflineminus">-    if (mMessageFolder)</span>
<a href="#l35.146"></a><span id="l35.146" class="difflineminus">-    {</span>
<a href="#l35.147"></a><span id="l35.147" class="difflineplus">+    if (mMessageFolder) {</span>
<a href="#l35.148"></a><span id="l35.148">       nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryReferent(mMessageFolder, &amp;rv);</span>
<a href="#l35.149"></a><span id="l35.149" class="difflineminus">-      if (folder)</span>
<a href="#l35.150"></a><span id="l35.150" class="difflineminus">-      {</span>
<a href="#l35.151"></a><span id="l35.151" class="difflineplus">+      if (folder) {</span>
<a href="#l35.152"></a><span id="l35.152">         rv = folder-&gt;RemoveFolderListener(this);</span>
<a href="#l35.153"></a><span id="l35.153">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l35.154"></a><span id="l35.154">       }</span>
<a href="#l35.155"></a><span id="l35.155">     }</span>
<a href="#l35.156"></a><span id="l35.156"> </span>
<a href="#l35.157"></a><span id="l35.157">     // Now remove ourselves from the observer service as well.</span>
<a href="#l35.158"></a><span id="l35.158">     nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l35.159"></a><span id="l35.159" class="difflineminus">-      mozilla::services::GetObserverService();</span>
<a href="#l35.160"></a><span id="l35.160" class="difflineplus">+        mozilla::services::GetObserverService();</span>
<a href="#l35.161"></a><span id="l35.161">     NS_ENSURE_TRUE(observerService, NS_ERROR_UNEXPECTED);</span>
<a href="#l35.162"></a><span id="l35.162"> </span>
<a href="#l35.163"></a><span id="l35.163">     rv = observerService-&gt;RemoveObserver(this, &quot;xpcom-shutdown&quot;);</span>
<a href="#l35.164"></a><span id="l35.164">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l35.165"></a><span id="l35.165"> </span>
<a href="#l35.166"></a><span id="l35.166">     rv = observerService-&gt;RemoveObserver(this, &quot;quit-application&quot;);</span>
<a href="#l35.167"></a><span id="l35.167">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l35.168"></a><span id="l35.168"> </span>
<a href="#l35.169"></a><span id="l35.169">     rv = observerService-&gt;RemoveObserver(this, &quot;msg-shutdown&quot;);</span>
<a href="#l35.170"></a><span id="l35.170">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l35.171"></a><span id="l35.171">   }</span>
<a href="#l35.172"></a><span id="l35.172"> </span>
<a href="#l35.173"></a><span id="l35.173">   return NS_OK;</span>
<a href="#l35.174"></a><span id="l35.174"> }</span>
<a href="#l35.175"></a><span id="l35.175"> </span>
<a href="#l35.176"></a><span id="l35.176"> NS_IMETHODIMP</span>
<a href="#l35.177"></a><span id="l35.177" class="difflineminus">-nsMsgSendLater::SetStatusFeedback(nsIMsgStatusFeedback *aFeedback)</span>
<a href="#l35.178"></a><span id="l35.178" class="difflineminus">-{</span>
<a href="#l35.179"></a><span id="l35.179" class="difflineplus">+nsMsgSendLater::SetStatusFeedback(nsIMsgStatusFeedback *aFeedback) {</span>
<a href="#l35.180"></a><span id="l35.180">   mFeedback = aFeedback;</span>
<a href="#l35.181"></a><span id="l35.181">   return NS_OK;</span>
<a href="#l35.182"></a><span id="l35.182"> }</span>
<a href="#l35.183"></a><span id="l35.183"> </span>
<a href="#l35.184"></a><span id="l35.184"> NS_IMETHODIMP</span>
<a href="#l35.185"></a><span id="l35.185" class="difflineminus">-nsMsgSendLater::GetStatusFeedback(nsIMsgStatusFeedback **aFeedback)</span>
<a href="#l35.186"></a><span id="l35.186" class="difflineminus">-{</span>
<a href="#l35.187"></a><span id="l35.187" class="difflineplus">+nsMsgSendLater::GetStatusFeedback(nsIMsgStatusFeedback **aFeedback) {</span>
<a href="#l35.188"></a><span id="l35.188">   NS_ENSURE_ARG_POINTER(aFeedback);</span>
<a href="#l35.189"></a><span id="l35.189">   NS_IF_ADDREF(*aFeedback = mFeedback);</span>
<a href="#l35.190"></a><span id="l35.190">   return NS_OK;</span>
<a href="#l35.191"></a><span id="l35.191"> }</span>
<a href="#l35.192"></a><span id="l35.192"> </span>
<a href="#l35.193"></a><span id="l35.193"> // Stream is done...drive on!</span>
<a href="#l35.194"></a><span id="l35.194"> NS_IMETHODIMP</span>
<a href="#l35.195"></a><span id="l35.195" class="difflineminus">-nsMsgSendLater::OnStopRequest(nsIRequest *request, nsresult status)</span>
<a href="#l35.196"></a><span id="l35.196" class="difflineminus">-{</span>
<a href="#l35.197"></a><span id="l35.197" class="difflineminus">-  nsresult    rv;</span>
<a href="#l35.198"></a><span id="l35.198" class="difflineplus">+nsMsgSendLater::OnStopRequest(nsIRequest *request, nsresult status) {</span>
<a href="#l35.199"></a><span id="l35.199" class="difflineplus">+  nsresult rv;</span>
<a href="#l35.200"></a><span id="l35.200"> </span>
<a href="#l35.201"></a><span id="l35.201">   // First, this shouldn't happen, but if</span>
<a href="#l35.202"></a><span id="l35.202">   // it does, flush the buffer and move on.</span>
<a href="#l35.203"></a><span id="l35.203" class="difflineminus">-  if (mLeftoverBuffer)</span>
<a href="#l35.204"></a><span id="l35.204" class="difflineminus">-  {</span>
<a href="#l35.205"></a><span id="l35.205" class="difflineplus">+  if (mLeftoverBuffer) {</span>
<a href="#l35.206"></a><span id="l35.206">     DeliverQueuedLine(mLeftoverBuffer, PL_strlen(mLeftoverBuffer));</span>
<a href="#l35.207"></a><span id="l35.207">   }</span>
<a href="#l35.208"></a><span id="l35.208"> </span>
<a href="#l35.209"></a><span id="l35.209" class="difflineminus">-  if (mOutFile)</span>
<a href="#l35.210"></a><span id="l35.210" class="difflineminus">-    mOutFile-&gt;Close();</span>
<a href="#l35.211"></a><span id="l35.211" class="difflineplus">+  if (mOutFile) mOutFile-&gt;Close();</span>
<a href="#l35.212"></a><span id="l35.212"> </span>
<a href="#l35.213"></a><span id="l35.213">   // See if we succeeded on reading the message from the message store?</span>
<a href="#l35.214"></a><span id="l35.214">   //</span>
<a href="#l35.215"></a><span id="l35.215" class="difflineminus">-  if (NS_SUCCEEDED(status))</span>
<a href="#l35.216"></a><span id="l35.216" class="difflineminus">-  {</span>
<a href="#l35.217"></a><span id="l35.217" class="difflineplus">+  if (NS_SUCCEEDED(status)) {</span>
<a href="#l35.218"></a><span id="l35.218">     // Message is done...send it!</span>
<a href="#l35.219"></a><span id="l35.219">     rv = CompleteMailFileSend();</span>
<a href="#l35.220"></a><span id="l35.220"> </span>
<a href="#l35.221"></a><span id="l35.221"> #ifdef NS_DEBUG</span>
<a href="#l35.222"></a><span id="l35.222">     printf(&quot;nsMsgSendLater: Success on getting message...\n&quot;);</span>
<a href="#l35.223"></a><span id="l35.223"> #endif</span>
<a href="#l35.224"></a><span id="l35.224"> </span>
<a href="#l35.225"></a><span id="l35.225">     // If the send operation failed..try the next one...</span>
<a href="#l35.226"></a><span id="l35.226" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l35.227"></a><span id="l35.227" class="difflineminus">-    {</span>
<a href="#l35.228"></a><span id="l35.228" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l35.229"></a><span id="l35.229">       rv = StartNextMailFileSend(rv);</span>
<a href="#l35.230"></a><span id="l35.230">       if (NS_FAILED(rv))</span>
<a href="#l35.231"></a><span id="l35.231">         EndSendMessages(rv, nullptr, mTotalSendCount, mTotalSentSuccessfully);</span>
<a href="#l35.232"></a><span id="l35.232">     }</span>
<a href="#l35.233"></a><span id="l35.233" class="difflineminus">-  }</span>
<a href="#l35.234"></a><span id="l35.234" class="difflineminus">-  else</span>
<a href="#l35.235"></a><span id="l35.235" class="difflineminus">-  {</span>
<a href="#l35.236"></a><span id="l35.236" class="difflineplus">+  } else {</span>
<a href="#l35.237"></a><span id="l35.237">     nsCOMPtr&lt;nsIChannel&gt; channel = do_QueryInterface(request);</span>
<a href="#l35.238"></a><span id="l35.238" class="difflineminus">-    if(!channel) return NS_ERROR_FAILURE;</span>
<a href="#l35.239"></a><span id="l35.239" class="difflineplus">+    if (!channel) return NS_ERROR_FAILURE;</span>
<a href="#l35.240"></a><span id="l35.240"> </span>
<a href="#l35.241"></a><span id="l35.241">     // extract the prompt object to use for the alert from the url....</span>
<a href="#l35.242"></a><span id="l35.242">     nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l35.243"></a><span id="l35.243">     nsCOMPtr&lt;nsIPrompt&gt; promptObject;</span>
<a href="#l35.244"></a><span id="l35.244" class="difflineminus">-    if (channel)</span>
<a href="#l35.245"></a><span id="l35.245" class="difflineminus">-    {</span>
<a href="#l35.246"></a><span id="l35.246" class="difflineplus">+    if (channel) {</span>
<a href="#l35.247"></a><span id="l35.247">       channel-&gt;GetURI(getter_AddRefs(uri));</span>
<a href="#l35.248"></a><span id="l35.248" class="difflineminus">-      nsCOMPtr&lt;nsISmtpUrl&gt; smtpUrl (do_QueryInterface(uri));</span>
<a href="#l35.249"></a><span id="l35.249" class="difflineminus">-      if (smtpUrl)</span>
<a href="#l35.250"></a><span id="l35.250" class="difflineminus">-        smtpUrl-&gt;GetPrompt(getter_AddRefs(promptObject));</span>
<a href="#l35.251"></a><span id="l35.251" class="difflineplus">+      nsCOMPtr&lt;nsISmtpUrl&gt; smtpUrl(do_QueryInterface(uri));</span>
<a href="#l35.252"></a><span id="l35.252" class="difflineplus">+      if (smtpUrl) smtpUrl-&gt;GetPrompt(getter_AddRefs(promptObject));</span>
<a href="#l35.253"></a><span id="l35.253">     }</span>
<a href="#l35.254"></a><span id="l35.254">     nsMsgDisplayMessageByName(promptObject, &quot;errorQueuedDeliveryFailed&quot;);</span>
<a href="#l35.255"></a><span id="l35.255"> </span>
<a href="#l35.256"></a><span id="l35.256" class="difflineminus">-    // Getting the data failed, but we will still keep trying to send the rest...</span>
<a href="#l35.257"></a><span id="l35.257" class="difflineplus">+    // Getting the data failed, but we will still keep trying to send the</span>
<a href="#l35.258"></a><span id="l35.258" class="difflineplus">+    // rest...</span>
<a href="#l35.259"></a><span id="l35.259">     rv = StartNextMailFileSend(status);</span>
<a href="#l35.260"></a><span id="l35.260">     if (NS_FAILED(rv))</span>
<a href="#l35.261"></a><span id="l35.261">       EndSendMessages(rv, nullptr, mTotalSendCount, mTotalSentSuccessfully);</span>
<a href="#l35.262"></a><span id="l35.262">   }</span>
<a href="#l35.263"></a><span id="l35.263"> </span>
<a href="#l35.264"></a><span id="l35.264">   return rv;</span>
<a href="#l35.265"></a><span id="l35.265"> }</span>
<a href="#l35.266"></a><span id="l35.266"> </span>
<a href="#l35.267"></a><span id="l35.267" class="difflineminus">-char *</span>
<a href="#l35.268"></a><span id="l35.268" class="difflineminus">-FindEOL(char *inBuf, char *buf_end)</span>
<a href="#l35.269"></a><span id="l35.269" class="difflineminus">-{</span>
<a href="#l35.270"></a><span id="l35.270" class="difflineplus">+char *FindEOL(char *inBuf, char *buf_end) {</span>
<a href="#l35.271"></a><span id="l35.271">   char *buf = inBuf;</span>
<a href="#l35.272"></a><span id="l35.272">   char *findLoc = nullptr;</span>
<a href="#l35.273"></a><span id="l35.273"> </span>
<a href="#l35.274"></a><span id="l35.274">   while (buf &lt;= buf_end)</span>
<a href="#l35.275"></a><span id="l35.275">     if (*buf == 0)</span>
<a href="#l35.276"></a><span id="l35.276">       return buf;</span>
<a href="#l35.277"></a><span id="l35.277" class="difflineminus">-    else if ( (*buf == '\n') || (*buf == '\r') )</span>
<a href="#l35.278"></a><span id="l35.278" class="difflineminus">-    {</span>
<a href="#l35.279"></a><span id="l35.279" class="difflineplus">+    else if ((*buf == '\n') || (*buf == '\r')) {</span>
<a href="#l35.280"></a><span id="l35.280">       findLoc = buf;</span>
<a href="#l35.281"></a><span id="l35.281">       break;</span>
<a href="#l35.282"></a><span id="l35.282" class="difflineminus">-    }</span>
<a href="#l35.283"></a><span id="l35.283" class="difflineminus">-    else</span>
<a href="#l35.284"></a><span id="l35.284" class="difflineplus">+    } else</span>
<a href="#l35.285"></a><span id="l35.285">       ++buf;</span>
<a href="#l35.286"></a><span id="l35.286"> </span>
<a href="#l35.287"></a><span id="l35.287">   if (!findLoc)</span>
<a href="#l35.288"></a><span id="l35.288">     return nullptr;</span>
<a href="#l35.289"></a><span id="l35.289">   else if ((findLoc + 1) &gt; buf_end)</span>
<a href="#l35.290"></a><span id="l35.290">     return buf;</span>
<a href="#l35.291"></a><span id="l35.291"> </span>
<a href="#l35.292"></a><span id="l35.292" class="difflineminus">-  if ( (*findLoc == '\n' &amp;&amp; *(findLoc+1) == '\r') ||</span>
<a href="#l35.293"></a><span id="l35.293" class="difflineminus">-       (*findLoc == '\r' &amp;&amp; *(findLoc+1) == '\n'))</span>
<a href="#l35.294"></a><span id="l35.294" class="difflineminus">-    findLoc++; // possibly a pair.</span>
<a href="#l35.295"></a><span id="l35.295" class="difflineplus">+  if ((*findLoc == '\n' &amp;&amp; *(findLoc + 1) == '\r') ||</span>
<a href="#l35.296"></a><span id="l35.296" class="difflineplus">+      (*findLoc == '\r' &amp;&amp; *(findLoc + 1) == '\n'))</span>
<a href="#l35.297"></a><span id="l35.297" class="difflineplus">+    findLoc++;  // possibly a pair.</span>
<a href="#l35.298"></a><span id="l35.298">   return findLoc;</span>
<a href="#l35.299"></a><span id="l35.299"> }</span>
<a href="#l35.300"></a><span id="l35.300"> </span>
<a href="#l35.301"></a><span id="l35.301" class="difflineminus">-nsresult</span>
<a href="#l35.302"></a><span id="l35.302" class="difflineminus">-nsMsgSendLater::RebufferLeftovers(char *startBuf, uint32_t aLen)</span>
<a href="#l35.303"></a><span id="l35.303" class="difflineminus">-{</span>
<a href="#l35.304"></a><span id="l35.304" class="difflineplus">+nsresult nsMsgSendLater::RebufferLeftovers(char *startBuf, uint32_t aLen) {</span>
<a href="#l35.305"></a><span id="l35.305">   PR_FREEIF(mLeftoverBuffer);</span>
<a href="#l35.306"></a><span id="l35.306">   mLeftoverBuffer = (char *)PR_Malloc(aLen + 1);</span>
<a href="#l35.307"></a><span id="l35.307" class="difflineminus">-  if (!mLeftoverBuffer)</span>
<a href="#l35.308"></a><span id="l35.308" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l35.309"></a><span id="l35.309" class="difflineplus">+  if (!mLeftoverBuffer) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l35.310"></a><span id="l35.310"> </span>
<a href="#l35.311"></a><span id="l35.311">   memcpy(mLeftoverBuffer, startBuf, aLen);</span>
<a href="#l35.312"></a><span id="l35.312">   mLeftoverBuffer[aLen] = '\0';</span>
<a href="#l35.313"></a><span id="l35.313">   return NS_OK;</span>
<a href="#l35.314"></a><span id="l35.314"> }</span>
<a href="#l35.315"></a><span id="l35.315"> </span>
<a href="#l35.316"></a><span id="l35.316" class="difflineminus">-nsresult</span>
<a href="#l35.317"></a><span id="l35.317" class="difflineminus">-nsMsgSendLater::BuildNewBuffer(const char* aBuf, uint32_t aCount, uint32_t *totalBufSize)</span>
<a href="#l35.318"></a><span id="l35.318" class="difflineminus">-{</span>
<a href="#l35.319"></a><span id="l35.319" class="difflineplus">+nsresult nsMsgSendLater::BuildNewBuffer(const char *aBuf, uint32_t aCount,</span>
<a href="#l35.320"></a><span id="l35.320" class="difflineplus">+                                        uint32_t *totalBufSize) {</span>
<a href="#l35.321"></a><span id="l35.321">   // Only build a buffer when there are leftovers...</span>
<a href="#l35.322"></a><span id="l35.322">   NS_ENSURE_TRUE(mLeftoverBuffer, NS_ERROR_FAILURE);</span>
<a href="#l35.323"></a><span id="l35.323"> </span>
<a href="#l35.324"></a><span id="l35.324">   int32_t leftoverSize = PL_strlen(mLeftoverBuffer);</span>
<a href="#l35.325"></a><span id="l35.325" class="difflineminus">-  char* newBuffer = (char *) PR_Realloc(mLeftoverBuffer, aCount + leftoverSize);</span>
<a href="#l35.326"></a><span id="l35.326" class="difflineplus">+  char *newBuffer = (char *)PR_Realloc(mLeftoverBuffer, aCount + leftoverSize);</span>
<a href="#l35.327"></a><span id="l35.327">   NS_ENSURE_TRUE(newBuffer, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l35.328"></a><span id="l35.328">   mLeftoverBuffer = newBuffer;</span>
<a href="#l35.329"></a><span id="l35.329"> </span>
<a href="#l35.330"></a><span id="l35.330">   memcpy(mLeftoverBuffer + leftoverSize, aBuf, aCount);</span>
<a href="#l35.331"></a><span id="l35.331">   *totalBufSize = aCount + leftoverSize;</span>
<a href="#l35.332"></a><span id="l35.332">   return NS_OK;</span>
<a href="#l35.333"></a><span id="l35.333"> }</span>
<a href="#l35.334"></a><span id="l35.334"> </span>
<a href="#l35.335"></a><span id="l35.335"> // Got data?</span>
<a href="#l35.336"></a><span id="l35.336"> NS_IMETHODIMP</span>
<a href="#l35.337"></a><span id="l35.337" class="difflineminus">-nsMsgSendLater::OnDataAvailable(nsIRequest *request, nsIInputStream *inStr, uint64_t sourceOffset, uint32_t count)</span>
<a href="#l35.338"></a><span id="l35.338" class="difflineminus">-{</span>
<a href="#l35.339"></a><span id="l35.339" class="difflineplus">+nsMsgSendLater::OnDataAvailable(nsIRequest *request, nsIInputStream *inStr,</span>
<a href="#l35.340"></a><span id="l35.340" class="difflineplus">+                                uint64_t sourceOffset, uint32_t count) {</span>
<a href="#l35.341"></a><span id="l35.341">   NS_ENSURE_ARG_POINTER(inStr);</span>
<a href="#l35.342"></a><span id="l35.342"> </span>
<a href="#l35.343"></a><span id="l35.343">   // This is a little bit tricky since we have to chop random</span>
<a href="#l35.344"></a><span id="l35.344">   // buffers into lines and deliver the lines...plus keeping the</span>
<a href="#l35.345"></a><span id="l35.345">   // leftovers for next time...some fun, eh?</span>
<a href="#l35.346"></a><span id="l35.346">   //</span>
<a href="#l35.347"></a><span id="l35.347" class="difflineminus">-  nsresult    rv = NS_OK;</span>
<a href="#l35.348"></a><span id="l35.348" class="difflineminus">-  char        *startBuf;</span>
<a href="#l35.349"></a><span id="l35.349" class="difflineminus">-  char        *endBuf;</span>
<a href="#l35.350"></a><span id="l35.350" class="difflineminus">-  char        *lineEnd;</span>
<a href="#l35.351"></a><span id="l35.351" class="difflineminus">-  char        *newbuf = nullptr;</span>
<a href="#l35.352"></a><span id="l35.352" class="difflineminus">-  uint32_t    size;</span>
<a href="#l35.353"></a><span id="l35.353" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l35.354"></a><span id="l35.354" class="difflineplus">+  char *startBuf;</span>
<a href="#l35.355"></a><span id="l35.355" class="difflineplus">+  char *endBuf;</span>
<a href="#l35.356"></a><span id="l35.356" class="difflineplus">+  char *lineEnd;</span>
<a href="#l35.357"></a><span id="l35.357" class="difflineplus">+  char *newbuf = nullptr;</span>
<a href="#l35.358"></a><span id="l35.358" class="difflineplus">+  uint32_t size;</span>
<a href="#l35.359"></a><span id="l35.359"> </span>
<a href="#l35.360"></a><span id="l35.360" class="difflineminus">-  uint32_t    aCount = count;</span>
<a href="#l35.361"></a><span id="l35.361" class="difflineminus">-  char        *aBuf = (char *)PR_Malloc(aCount + 1);</span>
<a href="#l35.362"></a><span id="l35.362" class="difflineplus">+  uint32_t aCount = count;</span>
<a href="#l35.363"></a><span id="l35.363" class="difflineplus">+  char *aBuf = (char *)PR_Malloc(aCount + 1);</span>
<a href="#l35.364"></a><span id="l35.364"> </span>
<a href="#l35.365"></a><span id="l35.365">   inStr-&gt;Read(aBuf, count, &amp;aCount);</span>
<a href="#l35.366"></a><span id="l35.366"> </span>
<a href="#l35.367"></a><span id="l35.367">   // First, create a new work buffer that will</span>
<a href="#l35.368"></a><span id="l35.368" class="difflineminus">-  if (NS_FAILED(BuildNewBuffer(aBuf, aCount, &amp;size))) // no leftovers...</span>
<a href="#l35.369"></a><span id="l35.369" class="difflineplus">+  if (NS_FAILED(BuildNewBuffer(aBuf, aCount, &amp;size)))  // no leftovers...</span>
<a href="#l35.370"></a><span id="l35.370">   {</span>
<a href="#l35.371"></a><span id="l35.371">     startBuf = (char *)aBuf;</span>
<a href="#l35.372"></a><span id="l35.372">     endBuf = (char *)(aBuf + aCount - 1);</span>
<a href="#l35.373"></a><span id="l35.373" class="difflineminus">-  }</span>
<a href="#l35.374"></a><span id="l35.374" class="difflineminus">-  else  // yum, leftovers...new buffer created...sitting in mLeftoverBuffer</span>
<a href="#l35.375"></a><span id="l35.375" class="difflineplus">+  } else  // yum, leftovers...new buffer created...sitting in mLeftoverBuffer</span>
<a href="#l35.376"></a><span id="l35.376">   {</span>
<a href="#l35.377"></a><span id="l35.377">     newbuf = mLeftoverBuffer;</span>
<a href="#l35.378"></a><span id="l35.378">     startBuf = newbuf;</span>
<a href="#l35.379"></a><span id="l35.379">     endBuf = startBuf + size - 1;</span>
<a href="#l35.380"></a><span id="l35.380" class="difflineminus">-    mLeftoverBuffer = nullptr; // null out this</span>
<a href="#l35.381"></a><span id="l35.381" class="difflineplus">+    mLeftoverBuffer = nullptr;  // null out this</span>
<a href="#l35.382"></a><span id="l35.382">   }</span>
<a href="#l35.383"></a><span id="l35.383"> </span>
<a href="#l35.384"></a><span id="l35.384" class="difflineminus">-  while (startBuf &lt;= endBuf)</span>
<a href="#l35.385"></a><span id="l35.385" class="difflineminus">-  {</span>
<a href="#l35.386"></a><span id="l35.386" class="difflineplus">+  while (startBuf &lt;= endBuf) {</span>
<a href="#l35.387"></a><span id="l35.387">     lineEnd = FindEOL(startBuf, endBuf);</span>
<a href="#l35.388"></a><span id="l35.388" class="difflineminus">-    if (!lineEnd)</span>
<a href="#l35.389"></a><span id="l35.389" class="difflineminus">-    {</span>
<a href="#l35.390"></a><span id="l35.390" class="difflineplus">+    if (!lineEnd) {</span>
<a href="#l35.391"></a><span id="l35.391">       rv = RebufferLeftovers(startBuf, (endBuf - startBuf) + 1);</span>
<a href="#l35.392"></a><span id="l35.392">       break;</span>
<a href="#l35.393"></a><span id="l35.393">     }</span>
<a href="#l35.394"></a><span id="l35.394"> </span>
<a href="#l35.395"></a><span id="l35.395">     rv = DeliverQueuedLine(startBuf, (lineEnd - startBuf) + 1);</span>
<a href="#l35.396"></a><span id="l35.396" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l35.397"></a><span id="l35.397" class="difflineminus">-      break;</span>
<a href="#l35.398"></a><span id="l35.398" class="difflineplus">+    if (NS_FAILED(rv)) break;</span>
<a href="#l35.399"></a><span id="l35.399"> </span>
<a href="#l35.400"></a><span id="l35.400" class="difflineminus">-    startBuf = lineEnd+1;</span>
<a href="#l35.401"></a><span id="l35.401" class="difflineplus">+    startBuf = lineEnd + 1;</span>
<a href="#l35.402"></a><span id="l35.402">   }</span>
<a href="#l35.403"></a><span id="l35.403"> </span>
<a href="#l35.404"></a><span id="l35.404">   PR_Free(newbuf);</span>
<a href="#l35.405"></a><span id="l35.405">   PR_Free(aBuf);</span>
<a href="#l35.406"></a><span id="l35.406">   return rv;</span>
<a href="#l35.407"></a><span id="l35.407"> }</span>
<a href="#l35.408"></a><span id="l35.408"> </span>
<a href="#l35.409"></a><span id="l35.409"> NS_IMETHODIMP</span>
<a href="#l35.410"></a><span id="l35.410" class="difflineminus">-nsMsgSendLater::OnStartRunningUrl(nsIURI *url)</span>
<a href="#l35.411"></a><span id="l35.411" class="difflineminus">-{</span>
<a href="#l35.412"></a><span id="l35.412" class="difflineminus">-  return NS_OK;</span>
<a href="#l35.413"></a><span id="l35.413" class="difflineminus">-}</span>
<a href="#l35.414"></a><span id="l35.414" class="difflineplus">+nsMsgSendLater::OnStartRunningUrl(nsIURI *url) { return NS_OK; }</span>
<a href="#l35.415"></a><span id="l35.415"> </span>
<a href="#l35.416"></a><span id="l35.416"> NS_IMETHODIMP</span>
<a href="#l35.417"></a><span id="l35.417" class="difflineminus">-nsMsgSendLater::OnStopRunningUrl(nsIURI *url, nsresult aExitCode)</span>
<a href="#l35.418"></a><span id="l35.418" class="difflineminus">-{</span>
<a href="#l35.419"></a><span id="l35.419" class="difflineminus">-  if (NS_SUCCEEDED(aExitCode))</span>
<a href="#l35.420"></a><span id="l35.420" class="difflineminus">-    InternalSendMessages(mUserInitiated, mIdentity);</span>
<a href="#l35.421"></a><span id="l35.421" class="difflineplus">+nsMsgSendLater::OnStopRunningUrl(nsIURI *url, nsresult aExitCode) {</span>
<a href="#l35.422"></a><span id="l35.422" class="difflineplus">+  if (NS_SUCCEEDED(aExitCode)) InternalSendMessages(mUserInitiated, mIdentity);</span>
<a href="#l35.423"></a><span id="l35.423">   return NS_OK;</span>
<a href="#l35.424"></a><span id="l35.424"> }</span>
<a href="#l35.425"></a><span id="l35.425"> </span>
<a href="#l35.426"></a><span id="l35.426"> NS_IMETHODIMP</span>
<a href="#l35.427"></a><span id="l35.427" class="difflineminus">-nsMsgSendLater::OnStartRequest(nsIRequest *request)</span>
<a href="#l35.428"></a><span id="l35.428" class="difflineminus">-{</span>
<a href="#l35.429"></a><span id="l35.429" class="difflineminus">-  return NS_OK;</span>
<a href="#l35.430"></a><span id="l35.430" class="difflineminus">-}</span>
<a href="#l35.431"></a><span id="l35.431" class="difflineplus">+nsMsgSendLater::OnStartRequest(nsIRequest *request) { return NS_OK; }</span>
<a href="#l35.432"></a><span id="l35.432"> </span>
<a href="#l35.433"></a><span id="l35.433"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l35.434"></a><span id="l35.434" class="difflineminus">-// This is the listener class for the send operation. We have to create this class</span>
<a href="#l35.435"></a><span id="l35.435" class="difflineminus">-// to listen for message send completion and eventually notify the caller</span>
<a href="#l35.436"></a><span id="l35.436" class="difflineplus">+// This is the listener class for the send operation. We have to create this</span>
<a href="#l35.437"></a><span id="l35.437" class="difflineplus">+// class to listen for message send completion and eventually notify the caller</span>
<a href="#l35.438"></a><span id="l35.438"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l35.439"></a><span id="l35.439"> NS_IMPL_ISUPPORTS(SendOperationListener, nsIMsgSendListener,</span>
<a href="#l35.440"></a><span id="l35.440" class="difflineminus">-                   nsIMsgCopyServiceListener)</span>
<a href="#l35.441"></a><span id="l35.441" class="difflineplus">+                  nsIMsgCopyServiceListener)</span>
<a href="#l35.442"></a><span id="l35.442"> </span>
<a href="#l35.443"></a><span id="l35.443"> SendOperationListener::SendOperationListener(nsMsgSendLater *aSendLater)</span>
<a href="#l35.444"></a><span id="l35.444" class="difflineminus">-: mSendLater(aSendLater)</span>
<a href="#l35.445"></a><span id="l35.445" class="difflineminus">-{</span>
<a href="#l35.446"></a><span id="l35.446" class="difflineminus">-}</span>
<a href="#l35.447"></a><span id="l35.447" class="difflineplus">+    : mSendLater(aSendLater) {}</span>
<a href="#l35.448"></a><span id="l35.448"> </span>
<a href="#l35.449"></a><span id="l35.449" class="difflineminus">-SendOperationListener::~SendOperationListener(void)</span>
<a href="#l35.450"></a><span id="l35.450" class="difflineminus">-{</span>
<a href="#l35.451"></a><span id="l35.451" class="difflineminus">-}</span>
<a href="#l35.452"></a><span id="l35.452" class="difflineplus">+SendOperationListener::~SendOperationListener(void) {}</span>
<a href="#l35.453"></a><span id="l35.453"> </span>
<a href="#l35.454"></a><span id="l35.454"> NS_IMETHODIMP</span>
<a href="#l35.455"></a><span id="l35.455" class="difflineminus">-SendOperationListener::OnGetDraftFolderURI(const char *aFolderURI)</span>
<a href="#l35.456"></a><span id="l35.456" class="difflineminus">-{</span>
<a href="#l35.457"></a><span id="l35.457" class="difflineplus">+SendOperationListener::OnGetDraftFolderURI(const char *aFolderURI) {</span>
<a href="#l35.458"></a><span id="l35.458">   return NS_OK;</span>
<a href="#l35.459"></a><span id="l35.459"> }</span>
<a href="#l35.460"></a><span id="l35.460"> </span>
<a href="#l35.461"></a><span id="l35.461"> NS_IMETHODIMP</span>
<a href="#l35.462"></a><span id="l35.462" class="difflineminus">-SendOperationListener::OnStartSending(const char *aMsgID, uint32_t aMsgSize)</span>
<a href="#l35.463"></a><span id="l35.463" class="difflineminus">-{</span>
<a href="#l35.464"></a><span id="l35.464" class="difflineplus">+SendOperationListener::OnStartSending(const char *aMsgID, uint32_t aMsgSize) {</span>
<a href="#l35.465"></a><span id="l35.465"> #ifdef NS_DEBUG</span>
<a href="#l35.466"></a><span id="l35.466">   printf(&quot;SendOperationListener::OnStartSending()\n&quot;);</span>
<a href="#l35.467"></a><span id="l35.467"> #endif</span>
<a href="#l35.468"></a><span id="l35.468">   return NS_OK;</span>
<a href="#l35.469"></a><span id="l35.469"> }</span>
<a href="#l35.470"></a><span id="l35.470"> </span>
<a href="#l35.471"></a><span id="l35.471"> NS_IMETHODIMP</span>
<a href="#l35.472"></a><span id="l35.472" class="difflineminus">-SendOperationListener::OnProgress(const char *aMsgID, uint32_t aProgress, uint32_t aProgressMax)</span>
<a href="#l35.473"></a><span id="l35.473" class="difflineminus">-{</span>
<a href="#l35.474"></a><span id="l35.474" class="difflineplus">+SendOperationListener::OnProgress(const char *aMsgID, uint32_t aProgress,</span>
<a href="#l35.475"></a><span id="l35.475" class="difflineplus">+                                  uint32_t aProgressMax) {</span>
<a href="#l35.476"></a><span id="l35.476"> #ifdef NS_DEBUG</span>
<a href="#l35.477"></a><span id="l35.477">   printf(&quot;SendOperationListener::OnProgress()\n&quot;);</span>
<a href="#l35.478"></a><span id="l35.478"> #endif</span>
<a href="#l35.479"></a><span id="l35.479">   return NS_OK;</span>
<a href="#l35.480"></a><span id="l35.480"> }</span>
<a href="#l35.481"></a><span id="l35.481"> </span>
<a href="#l35.482"></a><span id="l35.482"> NS_IMETHODIMP</span>
<a href="#l35.483"></a><span id="l35.483" class="difflineminus">-SendOperationListener::OnStatus(const char *aMsgID, const char16_t *aMsg)</span>
<a href="#l35.484"></a><span id="l35.484" class="difflineminus">-{</span>
<a href="#l35.485"></a><span id="l35.485" class="difflineplus">+SendOperationListener::OnStatus(const char *aMsgID, const char16_t *aMsg) {</span>
<a href="#l35.486"></a><span id="l35.486"> #ifdef NS_DEBUG</span>
<a href="#l35.487"></a><span id="l35.487">   printf(&quot;SendOperationListener::OnStatus()\n&quot;);</span>
<a href="#l35.488"></a><span id="l35.488"> #endif</span>
<a href="#l35.489"></a><span id="l35.489"> </span>
<a href="#l35.490"></a><span id="l35.490">   return NS_OK;</span>
<a href="#l35.491"></a><span id="l35.491"> }</span>
<a href="#l35.492"></a><span id="l35.492"> </span>
<a href="#l35.493"></a><span id="l35.493"> NS_IMETHODIMP</span>
<a href="#l35.494"></a><span id="l35.494" class="difflineminus">-SendOperationListener::OnSendNotPerformed(const char *aMsgID, nsresult aStatus)</span>
<a href="#l35.495"></a><span id="l35.495" class="difflineminus">-{</span>
<a href="#l35.496"></a><span id="l35.496" class="difflineplus">+SendOperationListener::OnSendNotPerformed(const char *aMsgID,</span>
<a href="#l35.497"></a><span id="l35.497" class="difflineplus">+                                          nsresult aStatus) {</span>
<a href="#l35.498"></a><span id="l35.498">   return NS_OK;</span>
<a href="#l35.499"></a><span id="l35.499"> }</span>
<a href="#l35.500"></a><span id="l35.500"> </span>
<a href="#l35.501"></a><span id="l35.501"> NS_IMETHODIMP</span>
<a href="#l35.502"></a><span id="l35.502" class="difflineminus">-SendOperationListener::OnStopSending(const char *aMsgID, nsresult aStatus, const char16_t *aMsg,</span>
<a href="#l35.503"></a><span id="l35.503" class="difflineminus">-                                     nsIFile *returnFile)</span>
<a href="#l35.504"></a><span id="l35.504" class="difflineminus">-{</span>
<a href="#l35.505"></a><span id="l35.505" class="difflineplus">+SendOperationListener::OnStopSending(const char *aMsgID, nsresult aStatus,</span>
<a href="#l35.506"></a><span id="l35.506" class="difflineplus">+                                     const char16_t *aMsg,</span>
<a href="#l35.507"></a><span id="l35.507" class="difflineplus">+                                     nsIFile *returnFile) {</span>
<a href="#l35.508"></a><span id="l35.508">   if (mSendLater &amp;&amp; !mSendLater-&gt;OnSendStepFinished(aStatus))</span>
<a href="#l35.509"></a><span id="l35.509">     mSendLater = nullptr;</span>
<a href="#l35.510"></a><span id="l35.510"> </span>
<a href="#l35.511"></a><span id="l35.511">   return NS_OK;</span>
<a href="#l35.512"></a><span id="l35.512"> }</span>
<a href="#l35.513"></a><span id="l35.513"> </span>
<a href="#l35.514"></a><span id="l35.514"> // nsIMsgCopyServiceListener</span>
<a href="#l35.515"></a><span id="l35.515"> </span>
<a href="#l35.516"></a><span id="l35.516"> NS_IMETHODIMP</span>
<a href="#l35.517"></a><span id="l35.517" class="difflineminus">-SendOperationListener::OnStartCopy(void)</span>
<a href="#l35.518"></a><span id="l35.518" class="difflineminus">-{</span>
<a href="#l35.519"></a><span id="l35.519" class="difflineplus">+SendOperationListener::OnStartCopy(void) { return NS_OK; }</span>
<a href="#l35.520"></a><span id="l35.520" class="difflineplus">+</span>
<a href="#l35.521"></a><span id="l35.521" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l35.522"></a><span id="l35.522" class="difflineplus">+SendOperationListener::OnProgress(uint32_t aProgress, uint32_t aProgressMax) {</span>
<a href="#l35.523"></a><span id="l35.523">   return NS_OK;</span>
<a href="#l35.524"></a><span id="l35.524"> }</span>
<a href="#l35.525"></a><span id="l35.525"> </span>
<a href="#l35.526"></a><span id="l35.526"> NS_IMETHODIMP</span>
<a href="#l35.527"></a><span id="l35.527" class="difflineminus">-SendOperationListener::OnProgress(uint32_t aProgress, uint32_t aProgressMax)</span>
<a href="#l35.528"></a><span id="l35.528" class="difflineminus">-{</span>
<a href="#l35.529"></a><span id="l35.529" class="difflineminus">-  return NS_OK;</span>
<a href="#l35.530"></a><span id="l35.530" class="difflineminus">-}</span>
<a href="#l35.531"></a><span id="l35.531" class="difflineminus">-</span>
<a href="#l35.532"></a><span id="l35.532" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l35.533"></a><span id="l35.533" class="difflineminus">-SendOperationListener::SetMessageKey(nsMsgKey aKey)</span>
<a href="#l35.534"></a><span id="l35.534" class="difflineminus">-{</span>
<a href="#l35.535"></a><span id="l35.535" class="difflineplus">+SendOperationListener::SetMessageKey(nsMsgKey aKey) {</span>
<a href="#l35.536"></a><span id="l35.536">   MOZ_ASSERT_UNREACHABLE(&quot;SendOperationListener::SetMessageKey()&quot;);</span>
<a href="#l35.537"></a><span id="l35.537">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l35.538"></a><span id="l35.538"> }</span>
<a href="#l35.539"></a><span id="l35.539"> </span>
<a href="#l35.540"></a><span id="l35.540"> NS_IMETHODIMP</span>
<a href="#l35.541"></a><span id="l35.541" class="difflineminus">-SendOperationListener::GetMessageId(nsACString&amp; messageId)</span>
<a href="#l35.542"></a><span id="l35.542" class="difflineminus">-{</span>
<a href="#l35.543"></a><span id="l35.543" class="difflineplus">+SendOperationListener::GetMessageId(nsACString &amp;messageId) {</span>
<a href="#l35.544"></a><span id="l35.544">   MOZ_ASSERT_UNREACHABLE(&quot;SendOperationListener::GetMessageId()\n&quot;);</span>
<a href="#l35.545"></a><span id="l35.545">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l35.546"></a><span id="l35.546"> }</span>
<a href="#l35.547"></a><span id="l35.547"> </span>
<a href="#l35.548"></a><span id="l35.548"> NS_IMETHODIMP</span>
<a href="#l35.549"></a><span id="l35.549" class="difflineminus">-SendOperationListener::OnStopCopy(nsresult aStatus)</span>
<a href="#l35.550"></a><span id="l35.550" class="difflineminus">-{</span>
<a href="#l35.551"></a><span id="l35.551" class="difflineminus">-  if (mSendLater)</span>
<a href="#l35.552"></a><span id="l35.552" class="difflineminus">-  {</span>
<a href="#l35.553"></a><span id="l35.553" class="difflineplus">+SendOperationListener::OnStopCopy(nsresult aStatus) {</span>
<a href="#l35.554"></a><span id="l35.554" class="difflineplus">+  if (mSendLater) {</span>
<a href="#l35.555"></a><span id="l35.555">     mSendLater-&gt;OnCopyStepFinished(aStatus);</span>
<a href="#l35.556"></a><span id="l35.556">     mSendLater = nullptr;</span>
<a href="#l35.557"></a><span id="l35.557">   }</span>
<a href="#l35.558"></a><span id="l35.558"> </span>
<a href="#l35.559"></a><span id="l35.559">   return NS_OK;</span>
<a href="#l35.560"></a><span id="l35.560"> }</span>
<a href="#l35.561"></a><span id="l35.561"> </span>
<a href="#l35.562"></a><span id="l35.562" class="difflineminus">-nsresult</span>
<a href="#l35.563"></a><span id="l35.563" class="difflineminus">-nsMsgSendLater::CompleteMailFileSend()</span>
<a href="#l35.564"></a><span id="l35.564" class="difflineminus">-{</span>
<a href="#l35.565"></a><span id="l35.565" class="difflineplus">+nsresult nsMsgSendLater::CompleteMailFileSend() {</span>
<a href="#l35.566"></a><span id="l35.566">   // get the identity from the key</span>
<a href="#l35.567"></a><span id="l35.567">   // if no key, or we fail to find the identity</span>
<a href="#l35.568"></a><span id="l35.568">   // use the default identity on the default account</span>
<a href="#l35.569"></a><span id="l35.569">   nsCOMPtr&lt;nsIMsgIdentity&gt; identity;</span>
<a href="#l35.570"></a><span id="l35.570">   nsresult rv = GetIdentityFromKey(mIdentityKey, getter_AddRefs(identity));</span>
<a href="#l35.571"></a><span id="l35.571" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l35.572"></a><span id="l35.572" class="difflineminus">-  if (!identity)</span>
<a href="#l35.573"></a><span id="l35.573" class="difflineminus">-    return NS_ERROR_UNEXPECTED;</span>
<a href="#l35.574"></a><span id="l35.574" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l35.575"></a><span id="l35.575" class="difflineplus">+  if (!identity) return NS_ERROR_UNEXPECTED;</span>
<a href="#l35.576"></a><span id="l35.576"> </span>
<a href="#l35.577"></a><span id="l35.577">   // If for some reason the tmp file didn't get created, we've failed here</span>
<a href="#l35.578"></a><span id="l35.578">   bool created;</span>
<a href="#l35.579"></a><span id="l35.579">   mTempFile-&gt;Exists(&amp;created);</span>
<a href="#l35.580"></a><span id="l35.580" class="difflineminus">-  if (!created)</span>
<a href="#l35.581"></a><span id="l35.581" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l35.582"></a><span id="l35.582" class="difflineplus">+  if (!created) return NS_ERROR_FAILURE;</span>
<a href="#l35.583"></a><span id="l35.583"> </span>
<a href="#l35.584"></a><span id="l35.584" class="difflineminus">-  nsCOMPtr&lt;nsIMsgCompFields&gt; compFields = do_CreateInstance(NS_MSGCOMPFIELDS_CONTRACTID, &amp;rv);</span>
<a href="#l35.585"></a><span id="l35.585" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l35.586"></a><span id="l35.586" class="difflineplus">+  nsCOMPtr&lt;nsIMsgCompFields&gt; compFields =</span>
<a href="#l35.587"></a><span id="l35.587" class="difflineplus">+      do_CreateInstance(NS_MSGCOMPFIELDS_CONTRACTID, &amp;rv);</span>
<a href="#l35.588"></a><span id="l35.588" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l35.589"></a><span id="l35.589"> </span>
<a href="#l35.590"></a><span id="l35.590">   nsCOMPtr&lt;nsIMsgSend&gt; pMsgSend = do_CreateInstance(NS_MSGSEND_CONTRACTID, &amp;rv);</span>
<a href="#l35.591"></a><span id="l35.591" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l35.592"></a><span id="l35.592" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l35.593"></a><span id="l35.593"> </span>
<a href="#l35.594"></a><span id="l35.594">   // Since we have already parsed all of the headers, we are simply going to</span>
<a href="#l35.595"></a><span id="l35.595">   // set the composition fields and move on.</span>
<a href="#l35.596"></a><span id="l35.596">   nsCString author;</span>
<a href="#l35.597"></a><span id="l35.597">   mMessage-&gt;GetAuthor(getter_Copies(author));</span>
<a href="#l35.598"></a><span id="l35.598"> </span>
<a href="#l35.599"></a><span id="l35.599" class="difflineminus">-  nsMsgCompFields * fields = (nsMsgCompFields *)compFields.get();</span>
<a href="#l35.600"></a><span id="l35.600" class="difflineplus">+  nsMsgCompFields *fields = (nsMsgCompFields *)compFields.get();</span>
<a href="#l35.601"></a><span id="l35.601"> </span>
<a href="#l35.602"></a><span id="l35.602">   fields-&gt;SetFrom(author.get());</span>
<a href="#l35.603"></a><span id="l35.603"> </span>
<a href="#l35.604"></a><span id="l35.604" class="difflineminus">-  if (m_to)</span>
<a href="#l35.605"></a><span id="l35.605" class="difflineminus">-  {</span>
<a href="#l35.606"></a><span id="l35.606" class="difflineplus">+  if (m_to) {</span>
<a href="#l35.607"></a><span id="l35.607">     fields-&gt;SetTo(m_to);</span>
<a href="#l35.608"></a><span id="l35.608">   }</span>
<a href="#l35.609"></a><span id="l35.609"> </span>
<a href="#l35.610"></a><span id="l35.610" class="difflineminus">-  if (m_bcc)</span>
<a href="#l35.611"></a><span id="l35.611" class="difflineminus">-  {</span>
<a href="#l35.612"></a><span id="l35.612" class="difflineplus">+  if (m_bcc) {</span>
<a href="#l35.613"></a><span id="l35.613">     fields-&gt;SetBcc(m_bcc);</span>
<a href="#l35.614"></a><span id="l35.614">   }</span>
<a href="#l35.615"></a><span id="l35.615"> </span>
<a href="#l35.616"></a><span id="l35.616" class="difflineminus">-  if (m_fcc)</span>
<a href="#l35.617"></a><span id="l35.617" class="difflineminus">-  {</span>
<a href="#l35.618"></a><span id="l35.618" class="difflineplus">+  if (m_fcc) {</span>
<a href="#l35.619"></a><span id="l35.619">     fields-&gt;SetFcc(m_fcc);</span>
<a href="#l35.620"></a><span id="l35.620">   }</span>
<a href="#l35.621"></a><span id="l35.621"> </span>
<a href="#l35.622"></a><span id="l35.622" class="difflineminus">-  if (m_newsgroups)</span>
<a href="#l35.623"></a><span id="l35.623" class="difflineminus">-    fields-&gt;SetNewsgroups(m_newsgroups);</span>
<a href="#l35.624"></a><span id="l35.624" class="difflineplus">+  if (m_newsgroups) fields-&gt;SetNewsgroups(m_newsgroups);</span>
<a href="#l35.625"></a><span id="l35.625"> </span>
<a href="#l35.626"></a><span id="l35.626"> #if 0</span>
<a href="#l35.627"></a><span id="l35.627">   // needs cleanup. Is this needed?</span>
<a href="#l35.628"></a><span id="l35.628">   if (m_newshost)</span>
<a href="#l35.629"></a><span id="l35.629">     fields-&gt;SetNewspostUrl(m_newshost);</span>
<a href="#l35.630"></a><span id="l35.630"> #endif</span>
<a href="#l35.631"></a><span id="l35.631"> </span>
<a href="#l35.632"></a><span id="l35.632">   // Create the listener for the send operation...</span>
<a href="#l35.633"></a><span id="l35.633">   RefPtr&lt;SendOperationListener&gt; sendListener = new SendOperationListener(this);</span>
<a href="#l35.634"></a><span id="l35.634"> </span>
<a href="#l35.635"></a><span id="l35.635" class="difflineminus">-  rv = pMsgSend-&gt;SendMessageFile(identity,</span>
<a href="#l35.636"></a><span id="l35.636" class="difflineminus">-                                 mAccountKey,</span>
<a href="#l35.637"></a><span id="l35.637" class="difflineminus">-                                 compFields, // nsIMsgCompFields *fields,</span>
<a href="#l35.638"></a><span id="l35.638" class="difflineminus">-                                 mTempFile, // nsIFile *sendFile,</span>
<a href="#l35.639"></a><span id="l35.639" class="difflineminus">-                                 true, // bool deleteSendFileOnCompletion,</span>
<a href="#l35.640"></a><span id="l35.640" class="difflineminus">-                                 false, // bool digest_p,</span>
<a href="#l35.641"></a><span id="l35.641" class="difflineminus">-                                 nsIMsgSend::nsMsgSendUnsent, // nsMsgDeliverMode mode,</span>
<a href="#l35.642"></a><span id="l35.642" class="difflineminus">-                                 nullptr, // nsIMsgDBHdr *msgToReplace,</span>
<a href="#l35.643"></a><span id="l35.643" class="difflineminus">-                                 sendListener,</span>
<a href="#l35.644"></a><span id="l35.644" class="difflineminus">-                                 mFeedback,</span>
<a href="#l35.645"></a><span id="l35.645" class="difflineminus">-                                 nullptr);</span>
<a href="#l35.646"></a><span id="l35.646" class="difflineplus">+  rv = pMsgSend-&gt;SendMessageFile(</span>
<a href="#l35.647"></a><span id="l35.647" class="difflineplus">+      identity, mAccountKey,</span>
<a href="#l35.648"></a><span id="l35.648" class="difflineplus">+      compFields,                   // nsIMsgCompFields *fields,</span>
<a href="#l35.649"></a><span id="l35.649" class="difflineplus">+      mTempFile,                    // nsIFile *sendFile,</span>
<a href="#l35.650"></a><span id="l35.650" class="difflineplus">+      true,                         // bool deleteSendFileOnCompletion,</span>
<a href="#l35.651"></a><span id="l35.651" class="difflineplus">+      false,                        // bool digest_p,</span>
<a href="#l35.652"></a><span id="l35.652" class="difflineplus">+      nsIMsgSend::nsMsgSendUnsent,  // nsMsgDeliverMode mode,</span>
<a href="#l35.653"></a><span id="l35.653" class="difflineplus">+      nullptr,                      // nsIMsgDBHdr *msgToReplace,</span>
<a href="#l35.654"></a><span id="l35.654" class="difflineplus">+      sendListener, mFeedback, nullptr);</span>
<a href="#l35.655"></a><span id="l35.655">   return rv;</span>
<a href="#l35.656"></a><span id="l35.656"> }</span>
<a href="#l35.657"></a><span id="l35.657"> </span>
<a href="#l35.658"></a><span id="l35.658" class="difflineminus">-nsresult</span>
<a href="#l35.659"></a><span id="l35.659" class="difflineminus">-nsMsgSendLater::StartNextMailFileSend(nsresult prevStatus)</span>
<a href="#l35.660"></a><span id="l35.660" class="difflineminus">-{</span>
<a href="#l35.661"></a><span id="l35.661" class="difflineplus">+nsresult nsMsgSendLater::StartNextMailFileSend(nsresult prevStatus) {</span>
<a href="#l35.662"></a><span id="l35.662">   bool hasMoreElements = false;</span>
<a href="#l35.663"></a><span id="l35.663">   if ((!mEnumerator) ||</span>
<a href="#l35.664"></a><span id="l35.664">       NS_FAILED(mEnumerator-&gt;HasMoreElements(&amp;hasMoreElements)) ||</span>
<a href="#l35.665"></a><span id="l35.665" class="difflineminus">-      !hasMoreElements)</span>
<a href="#l35.666"></a><span id="l35.666" class="difflineminus">-  {</span>
<a href="#l35.667"></a><span id="l35.667" class="difflineplus">+      !hasMoreElements) {</span>
<a href="#l35.668"></a><span id="l35.668">     // Notify that this message has finished being sent.</span>
<a href="#l35.669"></a><span id="l35.669" class="difflineminus">-    NotifyListenersOnProgress(mTotalSendCount, mMessagesToSend.Count(), 100, 100);</span>
<a href="#l35.670"></a><span id="l35.670" class="difflineplus">+    NotifyListenersOnProgress(mTotalSendCount, mMessagesToSend.Count(), 100,</span>
<a href="#l35.671"></a><span id="l35.671" class="difflineplus">+                              100);</span>
<a href="#l35.672"></a><span id="l35.672"> </span>
<a href="#l35.673"></a><span id="l35.673">     // EndSendMessages resets everything for us</span>
<a href="#l35.674"></a><span id="l35.674" class="difflineminus">-    EndSendMessages(prevStatus, nullptr, mTotalSendCount, mTotalSentSuccessfully);</span>
<a href="#l35.675"></a><span id="l35.675" class="difflineplus">+    EndSendMessages(prevStatus, nullptr, mTotalSendCount,</span>
<a href="#l35.676"></a><span id="l35.676" class="difflineplus">+                    mTotalSentSuccessfully);</span>
<a href="#l35.677"></a><span id="l35.677"> </span>
<a href="#l35.678"></a><span id="l35.678">     // XXX Should we be releasing references so that we don't hold onto items</span>
<a href="#l35.679"></a><span id="l35.679">     // unnecessarily.</span>
<a href="#l35.680"></a><span id="l35.680">     return NS_OK;</span>
<a href="#l35.681"></a><span id="l35.681">   }</span>
<a href="#l35.682"></a><span id="l35.682"> </span>
<a href="#l35.683"></a><span id="l35.683">   // If we've already sent a message, and are sending more, send out a progress</span>
<a href="#l35.684"></a><span id="l35.684">   // update with 100% for both send and copy as we must have finished by now.</span>
<a href="#l35.685"></a><span id="l35.685">   if (mTotalSendCount)</span>
<a href="#l35.686"></a><span id="l35.686" class="difflineminus">-    NotifyListenersOnProgress(mTotalSendCount, mMessagesToSend.Count(), 100, 100);</span>
<a href="#l35.687"></a><span id="l35.687" class="difflineplus">+    NotifyListenersOnProgress(mTotalSendCount, mMessagesToSend.Count(), 100,</span>
<a href="#l35.688"></a><span id="l35.688" class="difflineplus">+                              100);</span>
<a href="#l35.689"></a><span id="l35.689"> </span>
<a href="#l35.690"></a><span id="l35.690">   nsCOMPtr&lt;nsISupports&gt; currentItem;</span>
<a href="#l35.691"></a><span id="l35.691">   nsresult rv = mEnumerator-&gt;GetNext(getter_AddRefs(currentItem));</span>
<a href="#l35.692"></a><span id="l35.692">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l35.693"></a><span id="l35.693"> </span>
<a href="#l35.694"></a><span id="l35.694">   mMessage = do_QueryInterface(currentItem);</span>
<a href="#l35.695"></a><span id="l35.695" class="difflineminus">-  if (!mMessage)</span>
<a href="#l35.696"></a><span id="l35.696" class="difflineminus">-    return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l35.697"></a><span id="l35.697" class="difflineplus">+  if (!mMessage) return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l35.698"></a><span id="l35.698"> </span>
<a href="#l35.699"></a><span id="l35.699" class="difflineminus">-  if (!mMessageFolder)</span>
<a href="#l35.700"></a><span id="l35.700" class="difflineminus">-    return NS_ERROR_UNEXPECTED;</span>
<a href="#l35.701"></a><span id="l35.701" class="difflineplus">+  if (!mMessageFolder) return NS_ERROR_UNEXPECTED;</span>
<a href="#l35.702"></a><span id="l35.702"> </span>
<a href="#l35.703"></a><span id="l35.703">   nsCString messageURI;</span>
<a href="#l35.704"></a><span id="l35.704">   nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryReferent(mMessageFolder, &amp;rv);</span>
<a href="#l35.705"></a><span id="l35.705">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l35.706"></a><span id="l35.706">   folder-&gt;GetUriForMsg(mMessage, messageURI);</span>
<a href="#l35.707"></a><span id="l35.707"> </span>
<a href="#l35.708"></a><span id="l35.708">   rv = nsMsgCreateTempFile(&quot;nsqmail.tmp&quot;, getter_AddRefs(mTempFile));</span>
<a href="#l35.709"></a><span id="l35.709">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l35.710"></a><span id="l35.710"> </span>
<a href="#l35.711"></a><span id="l35.711">   nsCOMPtr&lt;nsIMsgMessageService&gt; messageService;</span>
<a href="#l35.712"></a><span id="l35.712">   rv = GetMessageServiceFromURI(messageURI, getter_AddRefs(messageService));</span>
<a href="#l35.713"></a><span id="l35.713" class="difflineminus">-  if (NS_FAILED(rv) &amp;&amp; !messageService)</span>
<a href="#l35.714"></a><span id="l35.714" class="difflineminus">-    return NS_ERROR_FACTORY_NOT_LOADED;</span>
<a href="#l35.715"></a><span id="l35.715" class="difflineplus">+  if (NS_FAILED(rv) &amp;&amp; !messageService) return NS_ERROR_FACTORY_NOT_LOADED;</span>
<a href="#l35.716"></a><span id="l35.716"> </span>
<a href="#l35.717"></a><span id="l35.717">   ++mTotalSendCount;</span>
<a href="#l35.718"></a><span id="l35.718"> </span>
<a href="#l35.719"></a><span id="l35.719">   nsCString identityKey;</span>
<a href="#l35.720"></a><span id="l35.720">   rv = mMessage-&gt;GetStringProperty(HEADER_X_MOZILLA_IDENTITY_KEY,</span>
<a href="#l35.721"></a><span id="l35.721">                                    getter_Copies(identityKey));</span>
<a href="#l35.722"></a><span id="l35.722">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l35.723"></a><span id="l35.723"> </span>
<a href="#l35.724"></a><span id="l35.724">   nsCOMPtr&lt;nsIMsgIdentity&gt; identity;</span>
<a href="#l35.725"></a><span id="l35.725">   rv = GetIdentityFromKey(identityKey.get(), getter_AddRefs(identity));</span>
<a href="#l35.726"></a><span id="l35.726">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l35.727"></a><span id="l35.727" class="difflineminus">-  if (!identity)</span>
<a href="#l35.728"></a><span id="l35.728" class="difflineminus">-    return NS_ERROR_UNEXPECTED;</span>
<a href="#l35.729"></a><span id="l35.729" class="difflineplus">+  if (!identity) return NS_ERROR_UNEXPECTED;</span>
<a href="#l35.730"></a><span id="l35.730"> </span>
<a href="#l35.731"></a><span id="l35.731">   // Notify that we're just about to start sending this message</span>
<a href="#l35.732"></a><span id="l35.732">   NotifyListenersOnMessageStartSending(mTotalSendCount, mMessagesToSend.Count(),</span>
<a href="#l35.733"></a><span id="l35.733">                                        identity);</span>
<a href="#l35.734"></a><span id="l35.734"> </span>
<a href="#l35.735"></a><span id="l35.735">   // Setup what we need to parse the data stream correctly</span>
<a href="#l35.736"></a><span id="l35.736">   m_inhead = true;</span>
<a href="#l35.737"></a><span id="l35.737">   m_headersFP = 0;</span>
<a href="#l35.738"></a><span id="l35.738" class="difflineat">@@ -655,71 +576,65 @@ nsMsgSendLater::StartNextMailFileSend(ns</span>
<a href="#l35.739"></a><span id="l35.739">   m_position = 0;</span>
<a href="#l35.740"></a><span id="l35.740">   m_flagsPosition = 0;</span>
<a href="#l35.741"></a><span id="l35.741">   m_headersSize = 0;</span>
<a href="#l35.742"></a><span id="l35.742">   PR_FREEIF(mLeftoverBuffer);</span>
<a href="#l35.743"></a><span id="l35.743"> </span>
<a href="#l35.744"></a><span id="l35.744">   // Now, get our stream listener interface and plug it into the DisplayMessage</span>
<a href="#l35.745"></a><span id="l35.745">   // operation</span>
<a href="#l35.746"></a><span id="l35.746">   nsCOMPtr&lt;nsIURI&gt; dummyNull;</span>
<a href="#l35.747"></a><span id="l35.747" class="difflineminus">-  rv = messageService-&gt;DisplayMessage(messageURI.get(),</span>
<a href="#l35.748"></a><span id="l35.748" class="difflineminus">-                                      static_cast&lt;nsIStreamListener*&gt;(this),</span>
<a href="#l35.749"></a><span id="l35.749" class="difflineminus">-                                      nullptr, nullptr, nullptr,</span>
<a href="#l35.750"></a><span id="l35.750" class="difflineminus">-                                      getter_AddRefs(dummyNull));</span>
<a href="#l35.751"></a><span id="l35.751" class="difflineplus">+  rv = messageService-&gt;DisplayMessage(</span>
<a href="#l35.752"></a><span id="l35.752" class="difflineplus">+      messageURI.get(), static_cast&lt;nsIStreamListener *&gt;(this), nullptr,</span>
<a href="#l35.753"></a><span id="l35.753" class="difflineplus">+      nullptr, nullptr, getter_AddRefs(dummyNull));</span>
<a href="#l35.754"></a><span id="l35.754"> </span>
<a href="#l35.755"></a><span id="l35.755">   return rv;</span>
<a href="#l35.756"></a><span id="l35.756"> }</span>
<a href="#l35.757"></a><span id="l35.757"> </span>
<a href="#l35.758"></a><span id="l35.758"> NS_IMETHODIMP</span>
<a href="#l35.759"></a><span id="l35.759" class="difflineminus">-nsMsgSendLater::GetUnsentMessagesFolder(nsIMsgIdentity *aIdentity, nsIMsgFolder **aFolder)</span>
<a href="#l35.760"></a><span id="l35.760" class="difflineminus">-{</span>
<a href="#l35.761"></a><span id="l35.761" class="difflineplus">+nsMsgSendLater::GetUnsentMessagesFolder(nsIMsgIdentity *aIdentity,</span>
<a href="#l35.762"></a><span id="l35.762" class="difflineplus">+                                        nsIMsgFolder **aFolder) {</span>
<a href="#l35.763"></a><span id="l35.763">   nsresult rv = NS_OK;</span>
<a href="#l35.764"></a><span id="l35.764">   nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryReferent(mMessageFolder);</span>
<a href="#l35.765"></a><span id="l35.765">   if (!folder) {</span>
<a href="#l35.766"></a><span id="l35.766">     nsCString uri;</span>
<a href="#l35.767"></a><span id="l35.767">     GetFolderURIFromUserPrefs(nsIMsgSend::nsMsgQueueForLater, aIdentity, uri);</span>
<a href="#l35.768"></a><span id="l35.768" class="difflineminus">-    rv = LocateMessageFolder(aIdentity, nsIMsgSend::nsMsgQueueForLater, uri.get(), getter_AddRefs(folder));</span>
<a href="#l35.769"></a><span id="l35.769" class="difflineplus">+    rv = LocateMessageFolder(aIdentity, nsIMsgSend::nsMsgQueueForLater,</span>
<a href="#l35.770"></a><span id="l35.770" class="difflineplus">+                             uri.get(), getter_AddRefs(folder));</span>
<a href="#l35.771"></a><span id="l35.771">     mMessageFolder = do_GetWeakReference(folder);</span>
<a href="#l35.772"></a><span id="l35.772" class="difflineminus">-    if (!mMessageFolder)</span>
<a href="#l35.773"></a><span id="l35.773" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l35.774"></a><span id="l35.774" class="difflineplus">+    if (!mMessageFolder) return NS_ERROR_FAILURE;</span>
<a href="#l35.775"></a><span id="l35.775">   }</span>
<a href="#l35.776"></a><span id="l35.776" class="difflineminus">-  if (folder)</span>
<a href="#l35.777"></a><span id="l35.777" class="difflineminus">-    folder.forget(aFolder);</span>
<a href="#l35.778"></a><span id="l35.778" class="difflineplus">+  if (folder) folder.forget(aFolder);</span>
<a href="#l35.779"></a><span id="l35.779">   return rv;</span>
<a href="#l35.780"></a><span id="l35.780"> }</span>
<a href="#l35.781"></a><span id="l35.781"> </span>
<a href="#l35.782"></a><span id="l35.782"> NS_IMETHODIMP</span>
<a href="#l35.783"></a><span id="l35.783" class="difflineminus">-nsMsgSendLater::HasUnsentMessages(nsIMsgIdentity *aIdentity, bool *aResult)</span>
<a href="#l35.784"></a><span id="l35.784" class="difflineminus">-{</span>
<a href="#l35.785"></a><span id="l35.785" class="difflineplus">+nsMsgSendLater::HasUnsentMessages(nsIMsgIdentity *aIdentity, bool *aResult) {</span>
<a href="#l35.786"></a><span id="l35.786">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l35.787"></a><span id="l35.787">   *aResult = false;</span>
<a href="#l35.788"></a><span id="l35.788">   nsresult rv;</span>
<a href="#l35.789"></a><span id="l35.789"> </span>
<a href="#l35.790"></a><span id="l35.790">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l35.791"></a><span id="l35.791" class="difflineminus">-    do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l35.792"></a><span id="l35.792" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l35.793"></a><span id="l35.793">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l35.794"></a><span id="l35.794"> </span>
<a href="#l35.795"></a><span id="l35.795">   nsCOMPtr&lt;nsIArray&gt; accounts;</span>
<a href="#l35.796"></a><span id="l35.796">   accountManager-&gt;GetAccounts(getter_AddRefs(accounts));</span>
<a href="#l35.797"></a><span id="l35.797">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l35.798"></a><span id="l35.798"> </span>
<a href="#l35.799"></a><span id="l35.799">   uint32_t cnt = 0;</span>
<a href="#l35.800"></a><span id="l35.800">   rv = accounts-&gt;GetLength(&amp;cnt);</span>
<a href="#l35.801"></a><span id="l35.801" class="difflineminus">-  if (cnt == 0)</span>
<a href="#l35.802"></a><span id="l35.802" class="difflineminus">-    return NS_OK; // no account set up -&gt; no unsent messages</span>
<a href="#l35.803"></a><span id="l35.803" class="difflineplus">+  if (cnt == 0) return NS_OK;  // no account set up -&gt; no unsent messages</span>
<a href="#l35.804"></a><span id="l35.804"> </span>
<a href="#l35.805"></a><span id="l35.805">   // XXX This code should be set up for multiple unsent folders, however we</span>
<a href="#l35.806"></a><span id="l35.806">   // don't support that at the moment, so for now just assume one folder.</span>
<a href="#l35.807"></a><span id="l35.807" class="difflineminus">-  if (!mMessageFolder)</span>
<a href="#l35.808"></a><span id="l35.808" class="difflineminus">-  {</span>
<a href="#l35.809"></a><span id="l35.809" class="difflineplus">+  if (!mMessageFolder) {</span>
<a href="#l35.810"></a><span id="l35.810">     nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l35.811"></a><span id="l35.811">     rv = GetUnsentMessagesFolder(nullptr, getter_AddRefs(folder));</span>
<a href="#l35.812"></a><span id="l35.812">     // There doesn't have to be a nsMsgQueueForLater flagged folder.</span>
<a href="#l35.813"></a><span id="l35.813" class="difflineminus">-    if (NS_FAILED(rv) || !folder)</span>
<a href="#l35.814"></a><span id="l35.814" class="difflineminus">-      return NS_OK;</span>
<a href="#l35.815"></a><span id="l35.815" class="difflineplus">+    if (NS_FAILED(rv) || !folder) return NS_OK;</span>
<a href="#l35.816"></a><span id="l35.816">   }</span>
<a href="#l35.817"></a><span id="l35.817">   rv = ReparseDBIfNeeded(nullptr);</span>
<a href="#l35.818"></a><span id="l35.818">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l35.819"></a><span id="l35.819"> </span>
<a href="#l35.820"></a><span id="l35.820">   int32_t totalMessages;</span>
<a href="#l35.821"></a><span id="l35.821">   nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryReferent(mMessageFolder, &amp;rv);</span>
<a href="#l35.822"></a><span id="l35.822">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l35.823"></a><span id="l35.823">   rv = folder-&gt;GetTotalMessages(false, &amp;totalMessages);</span>
<a href="#l35.824"></a><span id="l35.824" class="difflineat">@@ -748,182 +663,166 @@ nsMsgSendLater::HasUnsentMessages(nsIMsg</span>
<a href="#l35.825"></a><span id="l35.825"> //            do send operation</span>
<a href="#l35.826"></a><span id="l35.826"> //</span>
<a href="#l35.827"></a><span id="l35.827"> //          when send is complete</span>
<a href="#l35.828"></a><span id="l35.828"> //            Copy from Outbox to FCC folder</span>
<a href="#l35.829"></a><span id="l35.829"> //            Delete from Outbox folder</span>
<a href="#l35.830"></a><span id="l35.830"> //</span>
<a href="#l35.831"></a><span id="l35.831"> //</span>
<a href="#l35.832"></a><span id="l35.832"> NS_IMETHODIMP</span>
<a href="#l35.833"></a><span id="l35.833" class="difflineminus">-nsMsgSendLater::SendUnsentMessages(nsIMsgIdentity *aIdentity)</span>
<a href="#l35.834"></a><span id="l35.834" class="difflineminus">-{</span>
<a href="#l35.835"></a><span id="l35.835" class="difflineplus">+nsMsgSendLater::SendUnsentMessages(nsIMsgIdentity *aIdentity) {</span>
<a href="#l35.836"></a><span id="l35.836">   return InternalSendMessages(true, aIdentity);</span>
<a href="#l35.837"></a><span id="l35.837"> }</span>
<a href="#l35.838"></a><span id="l35.838"> </span>
<a href="#l35.839"></a><span id="l35.839"> // Returns NS_OK if the db is OK, an error otherwise, e.g., we had to reparse.</span>
<a href="#l35.840"></a><span id="l35.840" class="difflineminus">-nsresult nsMsgSendLater::ReparseDBIfNeeded(nsIUrlListener *aListener)</span>
<a href="#l35.841"></a><span id="l35.841" class="difflineminus">-{</span>
<a href="#l35.842"></a><span id="l35.842" class="difflineplus">+nsresult nsMsgSendLater::ReparseDBIfNeeded(nsIUrlListener *aListener) {</span>
<a href="#l35.843"></a><span id="l35.843">   // This will kick off a reparse, if needed. So the next time we check if</span>
<a href="#l35.844"></a><span id="l35.844">   // there are unsent messages, the db will be up to date.</span>
<a href="#l35.845"></a><span id="l35.845">   nsCOMPtr&lt;nsIMsgDatabase&gt; unsentDB;</span>
<a href="#l35.846"></a><span id="l35.846">   nsresult rv;</span>
<a href="#l35.847"></a><span id="l35.847" class="difflineminus">-  nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; locFolder(do_QueryReferent(mMessageFolder, &amp;rv));</span>
<a href="#l35.848"></a><span id="l35.848" class="difflineplus">+  nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; locFolder(</span>
<a href="#l35.849"></a><span id="l35.849" class="difflineplus">+      do_QueryReferent(mMessageFolder, &amp;rv));</span>
<a href="#l35.850"></a><span id="l35.850">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l35.851"></a><span id="l35.851">   return locFolder-&gt;GetDatabaseWithReparse(aListener, nullptr,</span>
<a href="#l35.852"></a><span id="l35.852">                                            getter_AddRefs(unsentDB));</span>
<a href="#l35.853"></a><span id="l35.853"> }</span>
<a href="#l35.854"></a><span id="l35.854"> </span>
<a href="#l35.855"></a><span id="l35.855" class="difflineminus">-nsresult</span>
<a href="#l35.856"></a><span id="l35.856" class="difflineminus">-nsMsgSendLater::InternalSendMessages(bool aUserInitiated,</span>
<a href="#l35.857"></a><span id="l35.857" class="difflineminus">-                                     nsIMsgIdentity *aIdentity)</span>
<a href="#l35.858"></a><span id="l35.858" class="difflineminus">-{</span>
<a href="#l35.859"></a><span id="l35.859" class="difflineminus">-  if (WeAreOffline())</span>
<a href="#l35.860"></a><span id="l35.860" class="difflineminus">-    return NS_MSG_ERROR_OFFLINE;</span>
<a href="#l35.861"></a><span id="l35.861" class="difflineplus">+nsresult nsMsgSendLater::InternalSendMessages(bool aUserInitiated,</span>
<a href="#l35.862"></a><span id="l35.862" class="difflineplus">+                                              nsIMsgIdentity *aIdentity) {</span>
<a href="#l35.863"></a><span id="l35.863" class="difflineplus">+  if (WeAreOffline()) return NS_MSG_ERROR_OFFLINE;</span>
<a href="#l35.864"></a><span id="l35.864"> </span>
<a href="#l35.865"></a><span id="l35.865">   // Protect against being called whilst we're already sending.</span>
<a href="#l35.866"></a><span id="l35.866" class="difflineminus">-  if (mSendingMessages)</span>
<a href="#l35.867"></a><span id="l35.867" class="difflineminus">-  {</span>
<a href="#l35.868"></a><span id="l35.868" class="difflineplus">+  if (mSendingMessages) {</span>
<a href="#l35.869"></a><span id="l35.869">     NS_ERROR(&quot;nsMsgSendLater is already sending messages\n&quot;);</span>
<a href="#l35.870"></a><span id="l35.870">     return NS_ERROR_FAILURE;</span>
<a href="#l35.871"></a><span id="l35.871">   }</span>
<a href="#l35.872"></a><span id="l35.872"> </span>
<a href="#l35.873"></a><span id="l35.873">   nsresult rv;</span>
<a href="#l35.874"></a><span id="l35.874"> </span>
<a href="#l35.875"></a><span id="l35.875">   // XXX This code should be set up for multiple unsent folders, however we</span>
<a href="#l35.876"></a><span id="l35.876">   // don't support that at the moment, so for now just assume one folder.</span>
<a href="#l35.877"></a><span id="l35.877" class="difflineminus">-  if (!mMessageFolder)</span>
<a href="#l35.878"></a><span id="l35.878" class="difflineminus">-  {</span>
<a href="#l35.879"></a><span id="l35.879" class="difflineplus">+  if (!mMessageFolder) {</span>
<a href="#l35.880"></a><span id="l35.880">     nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l35.881"></a><span id="l35.881">     rv = GetUnsentMessagesFolder(nullptr, getter_AddRefs(folder));</span>
<a href="#l35.882"></a><span id="l35.882" class="difflineminus">-    if (NS_FAILED(rv) || !folder)</span>
<a href="#l35.883"></a><span id="l35.883" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l35.884"></a><span id="l35.884" class="difflineplus">+    if (NS_FAILED(rv) || !folder) return NS_ERROR_FAILURE;</span>
<a href="#l35.885"></a><span id="l35.885">   }</span>
<a href="#l35.886"></a><span id="l35.886">   nsCOMPtr&lt;nsIMsgDatabase&gt; unsentDB;</span>
<a href="#l35.887"></a><span id="l35.887">   // Remember these in case we need to reparse the db.</span>
<a href="#l35.888"></a><span id="l35.888">   mUserInitiated = aUserInitiated;</span>
<a href="#l35.889"></a><span id="l35.889">   mIdentity = aIdentity;</span>
<a href="#l35.890"></a><span id="l35.890">   rv = ReparseDBIfNeeded(this);</span>
<a href="#l35.891"></a><span id="l35.891">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l35.892"></a><span id="l35.892" class="difflineminus">-  mIdentity = nullptr; // don't hold onto the identity since we're a service.</span>
<a href="#l35.893"></a><span id="l35.893" class="difflineplus">+  mIdentity = nullptr;  // don't hold onto the identity since we're a service.</span>
<a href="#l35.894"></a><span id="l35.894"> </span>
<a href="#l35.895"></a><span id="l35.895">   nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l35.896"></a><span id="l35.896">   nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryReferent(mMessageFolder, &amp;rv);</span>
<a href="#l35.897"></a><span id="l35.897">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l35.898"></a><span id="l35.898">   rv = folder-&gt;GetMessages(getter_AddRefs(enumerator));</span>
<a href="#l35.899"></a><span id="l35.899">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l35.900"></a><span id="l35.900"> </span>
<a href="#l35.901"></a><span id="l35.901">   // copy all the elements in the enumerator into our isupports array....</span>
<a href="#l35.902"></a><span id="l35.902"> </span>
<a href="#l35.903"></a><span id="l35.903">   nsCOMPtr&lt;nsISupports&gt; currentItem;</span>
<a href="#l35.904"></a><span id="l35.904">   nsCOMPtr&lt;nsIMsgDBHdr&gt; messageHeader;</span>
<a href="#l35.905"></a><span id="l35.905">   bool hasMoreElements = false;</span>
<a href="#l35.906"></a><span id="l35.906" class="difflineminus">-  while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMoreElements)) &amp;&amp; hasMoreElements)</span>
<a href="#l35.907"></a><span id="l35.907" class="difflineminus">-  {</span>
<a href="#l35.908"></a><span id="l35.908" class="difflineplus">+  while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMoreElements)) &amp;&amp;</span>
<a href="#l35.909"></a><span id="l35.909" class="difflineplus">+         hasMoreElements) {</span>
<a href="#l35.910"></a><span id="l35.910">     rv = enumerator-&gt;GetNext(getter_AddRefs(currentItem));</span>
<a href="#l35.911"></a><span id="l35.911" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l35.912"></a><span id="l35.912" class="difflineminus">-    {</span>
<a href="#l35.913"></a><span id="l35.913" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l35.914"></a><span id="l35.914">       messageHeader = do_QueryInterface(currentItem, &amp;rv);</span>
<a href="#l35.915"></a><span id="l35.915" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l35.916"></a><span id="l35.916" class="difflineminus">-      {</span>
<a href="#l35.917"></a><span id="l35.917" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l35.918"></a><span id="l35.918">         if (aUserInitiated)</span>
<a href="#l35.919"></a><span id="l35.919">           // If the user initiated the send, add all messages</span>
<a href="#l35.920"></a><span id="l35.920">           mMessagesToSend.AppendObject(messageHeader);</span>
<a href="#l35.921"></a><span id="l35.921" class="difflineminus">-        else</span>
<a href="#l35.922"></a><span id="l35.922" class="difflineminus">-        {</span>
<a href="#l35.923"></a><span id="l35.923" class="difflineplus">+        else {</span>
<a href="#l35.924"></a><span id="l35.924">           // Else just send those that are NOT marked as Queued.</span>
<a href="#l35.925"></a><span id="l35.925">           uint32_t flags;</span>
<a href="#l35.926"></a><span id="l35.926">           rv = messageHeader-&gt;GetFlags(&amp;flags);</span>
<a href="#l35.927"></a><span id="l35.927">           if (NS_SUCCEEDED(rv) &amp;&amp; !(flags &amp; nsMsgMessageFlags::Queued))</span>
<a href="#l35.928"></a><span id="l35.928">             mMessagesToSend.AppendObject(messageHeader);</span>
<a href="#l35.929"></a><span id="l35.929">         }</span>
<a href="#l35.930"></a><span id="l35.930">       }</span>
<a href="#l35.931"></a><span id="l35.931">     }</span>
<a href="#l35.932"></a><span id="l35.932">   }</span>
<a href="#l35.933"></a><span id="l35.933"> </span>
<a href="#l35.934"></a><span id="l35.934">   // Now get an enumerator for our array.</span>
<a href="#l35.935"></a><span id="l35.935" class="difflineminus">-  rv = NS_NewArrayEnumerator(getter_AddRefs(mEnumerator), mMessagesToSend, NS_GET_IID(nsIMsgDBHdr));</span>
<a href="#l35.936"></a><span id="l35.936" class="difflineplus">+  rv = NS_NewArrayEnumerator(getter_AddRefs(mEnumerator), mMessagesToSend,</span>
<a href="#l35.937"></a><span id="l35.937" class="difflineplus">+                             NS_GET_IID(nsIMsgDBHdr));</span>
<a href="#l35.938"></a><span id="l35.938">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l35.939"></a><span id="l35.939"> </span>
<a href="#l35.940"></a><span id="l35.940">   // We're now sending messages so its time to signal that and reset our counts.</span>
<a href="#l35.941"></a><span id="l35.941">   mSendingMessages = true;</span>
<a href="#l35.942"></a><span id="l35.942">   mTotalSentSuccessfully = 0;</span>
<a href="#l35.943"></a><span id="l35.943">   mTotalSendCount = 0;</span>
<a href="#l35.944"></a><span id="l35.944"> </span>
<a href="#l35.945"></a><span id="l35.945">   // Notify the listeners that we are starting a send.</span>
<a href="#l35.946"></a><span id="l35.946">   NotifyListenersOnStartSending(mMessagesToSend.Count());</span>
<a href="#l35.947"></a><span id="l35.947"> </span>
<a href="#l35.948"></a><span id="l35.948">   return StartNextMailFileSend(NS_OK);</span>
<a href="#l35.949"></a><span id="l35.949"> }</span>
<a href="#l35.950"></a><span id="l35.950"> </span>
<a href="#l35.951"></a><span id="l35.951" class="difflineminus">-nsresult nsMsgSendLater::SetOrigMsgDisposition()</span>
<a href="#l35.952"></a><span id="l35.952" class="difflineminus">-{</span>
<a href="#l35.953"></a><span id="l35.953" class="difflineminus">-  if (!mMessage)</span>
<a href="#l35.954"></a><span id="l35.954" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l35.955"></a><span id="l35.955" class="difflineplus">+nsresult nsMsgSendLater::SetOrigMsgDisposition() {</span>
<a href="#l35.956"></a><span id="l35.956" class="difflineplus">+  if (!mMessage) return NS_ERROR_NULL_POINTER;</span>
<a href="#l35.957"></a><span id="l35.957"> </span>
<a href="#l35.958"></a><span id="l35.958">   // We're finished sending a queued message. We need to look at mMessage</span>
<a href="#l35.959"></a><span id="l35.959">   // and see if we need to set replied/forwarded</span>
<a href="#l35.960"></a><span id="l35.960">   // flags for the original message that this message might be a reply to</span>
<a href="#l35.961"></a><span id="l35.961">   // or forward of.</span>
<a href="#l35.962"></a><span id="l35.962">   nsCString originalMsgURIs;</span>
<a href="#l35.963"></a><span id="l35.963">   nsCString queuedDisposition;</span>
<a href="#l35.964"></a><span id="l35.964" class="difflineminus">-  mMessage-&gt;GetStringProperty(ORIG_URI_PROPERTY, getter_Copies(originalMsgURIs));</span>
<a href="#l35.965"></a><span id="l35.965" class="difflineminus">-  mMessage-&gt;GetStringProperty(QUEUED_DISPOSITION_PROPERTY, getter_Copies(queuedDisposition));</span>
<a href="#l35.966"></a><span id="l35.966" class="difflineminus">-  if (!queuedDisposition.IsEmpty())</span>
<a href="#l35.967"></a><span id="l35.967" class="difflineminus">-  {</span>
<a href="#l35.968"></a><span id="l35.968" class="difflineplus">+  mMessage-&gt;GetStringProperty(ORIG_URI_PROPERTY,</span>
<a href="#l35.969"></a><span id="l35.969" class="difflineplus">+                              getter_Copies(originalMsgURIs));</span>
<a href="#l35.970"></a><span id="l35.970" class="difflineplus">+  mMessage-&gt;GetStringProperty(QUEUED_DISPOSITION_PROPERTY,</span>
<a href="#l35.971"></a><span id="l35.971" class="difflineplus">+                              getter_Copies(queuedDisposition));</span>
<a href="#l35.972"></a><span id="l35.972" class="difflineplus">+  if (!queuedDisposition.IsEmpty()) {</span>
<a href="#l35.973"></a><span id="l35.973">     nsTArray&lt;nsCString&gt; uriArray;</span>
<a href="#l35.974"></a><span id="l35.974">     ParseString(originalMsgURIs, ',', uriArray);</span>
<a href="#l35.975"></a><span id="l35.975" class="difflineminus">-    for (uint32_t i = 0; i &lt; uriArray.Length(); i++)</span>
<a href="#l35.976"></a><span id="l35.976" class="difflineminus">-    {</span>
<a href="#l35.977"></a><span id="l35.977" class="difflineminus">-      nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l35.978"></a><span id="l35.978" class="difflineminus">-      nsresult rv = GetMsgDBHdrFromURI(uriArray[i].get(), getter_AddRefs(msgHdr));</span>
<a href="#l35.979"></a><span id="l35.979" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l35.980"></a><span id="l35.980" class="difflineminus">-      if (msgHdr)</span>
<a href="#l35.981"></a><span id="l35.981" class="difflineminus">-      {</span>
<a href="#l35.982"></a><span id="l35.982" class="difflineplus">+    for (uint32_t i = 0; i &lt; uriArray.Length(); i++) {</span>
<a href="#l35.983"></a><span id="l35.983" class="difflineplus">+      nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l35.984"></a><span id="l35.984" class="difflineplus">+      nsresult rv =</span>
<a href="#l35.985"></a><span id="l35.985" class="difflineplus">+          GetMsgDBHdrFromURI(uriArray[i].get(), getter_AddRefs(msgHdr));</span>
<a href="#l35.986"></a><span id="l35.986" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l35.987"></a><span id="l35.987" class="difflineplus">+      if (msgHdr) {</span>
<a href="#l35.988"></a><span id="l35.988">         // get the folder for the message resource</span>
<a href="#l35.989"></a><span id="l35.989">         nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l35.990"></a><span id="l35.990">         msgHdr-&gt;GetFolder(getter_AddRefs(msgFolder));</span>
<a href="#l35.991"></a><span id="l35.991" class="difflineminus">-        if (msgFolder)</span>
<a href="#l35.992"></a><span id="l35.992" class="difflineminus">-        {</span>
<a href="#l35.993"></a><span id="l35.993" class="difflineminus">-          nsMsgDispositionState dispositionSetting = nsIMsgFolder::nsMsgDispositionState_Replied;</span>
<a href="#l35.994"></a><span id="l35.994" class="difflineplus">+        if (msgFolder) {</span>
<a href="#l35.995"></a><span id="l35.995" class="difflineplus">+          nsMsgDispositionState dispositionSetting =</span>
<a href="#l35.996"></a><span id="l35.996" class="difflineplus">+              nsIMsgFolder::nsMsgDispositionState_Replied;</span>
<a href="#l35.997"></a><span id="l35.997">           if (queuedDisposition.EqualsLiteral(&quot;forwarded&quot;))</span>
<a href="#l35.998"></a><span id="l35.998">             dispositionSetting = nsIMsgFolder::nsMsgDispositionState_Forwarded;</span>
<a href="#l35.999"></a><span id="l35.999"> </span>
<a href="#l35.1000"></a><span id="l35.1000">           msgFolder-&gt;AddMessageDispositionState(msgHdr, dispositionSetting);</span>
<a href="#l35.1001"></a><span id="l35.1001">         }</span>
<a href="#l35.1002"></a><span id="l35.1002">       }</span>
<a href="#l35.1003"></a><span id="l35.1003">     }</span>
<a href="#l35.1004"></a><span id="l35.1004">   }</span>
<a href="#l35.1005"></a><span id="l35.1005">   return NS_OK;</span>
<a href="#l35.1006"></a><span id="l35.1006"> }</span>
<a href="#l35.1007"></a><span id="l35.1007"> </span>
<a href="#l35.1008"></a><span id="l35.1008" class="difflineminus">-nsresult</span>
<a href="#l35.1009"></a><span id="l35.1009" class="difflineminus">-nsMsgSendLater::DeleteCurrentMessage()</span>
<a href="#l35.1010"></a><span id="l35.1010" class="difflineminus">-{</span>
<a href="#l35.1011"></a><span id="l35.1011" class="difflineminus">-  if (!mMessage)</span>
<a href="#l35.1012"></a><span id="l35.1012" class="difflineminus">-  {</span>
<a href="#l35.1013"></a><span id="l35.1013" class="difflineplus">+nsresult nsMsgSendLater::DeleteCurrentMessage() {</span>
<a href="#l35.1014"></a><span id="l35.1014" class="difflineplus">+  if (!mMessage) {</span>
<a href="#l35.1015"></a><span id="l35.1015">     NS_ERROR(&quot;nsMsgSendLater: Attempt to delete an already deleted message&quot;);</span>
<a href="#l35.1016"></a><span id="l35.1016">     return NS_OK;</span>
<a href="#l35.1017"></a><span id="l35.1017">   }</span>
<a href="#l35.1018"></a><span id="l35.1018"> </span>
<a href="#l35.1019"></a><span id="l35.1019">   // Get the composition fields interface</span>
<a href="#l35.1020"></a><span id="l35.1020">   nsCOMPtr&lt;nsIMutableArray&gt; msgArray(do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l35.1021"></a><span id="l35.1021" class="difflineminus">-  if (!msgArray)</span>
<a href="#l35.1022"></a><span id="l35.1022" class="difflineminus">-    return NS_ERROR_FACTORY_NOT_LOADED;</span>
<a href="#l35.1023"></a><span id="l35.1023" class="difflineplus">+  if (!msgArray) return NS_ERROR_FACTORY_NOT_LOADED;</span>
<a href="#l35.1024"></a><span id="l35.1024"> </span>
<a href="#l35.1025"></a><span id="l35.1025" class="difflineminus">-  if (!mMessageFolder)</span>
<a href="#l35.1026"></a><span id="l35.1026" class="difflineminus">-    return NS_ERROR_UNEXPECTED;</span>
<a href="#l35.1027"></a><span id="l35.1027" class="difflineplus">+  if (!mMessageFolder) return NS_ERROR_UNEXPECTED;</span>
<a href="#l35.1028"></a><span id="l35.1028"> </span>
<a href="#l35.1029"></a><span id="l35.1029">   msgArray-&gt;InsertElementAt(mMessage, 0);</span>
<a href="#l35.1030"></a><span id="l35.1030"> </span>
<a href="#l35.1031"></a><span id="l35.1031">   nsresult rv;</span>
<a href="#l35.1032"></a><span id="l35.1032">   nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryReferent(mMessageFolder, &amp;rv);</span>
<a href="#l35.1033"></a><span id="l35.1033">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l35.1034"></a><span id="l35.1034" class="difflineminus">-  rv = folder-&gt;DeleteMessages(msgArray, nullptr, true, false, nullptr, false /*allowUndo*/);</span>
<a href="#l35.1035"></a><span id="l35.1035" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l35.1036"></a><span id="l35.1036" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l35.1037"></a><span id="l35.1037" class="difflineplus">+  rv = folder-&gt;DeleteMessages(msgArray, nullptr, true, false, nullptr,</span>
<a href="#l35.1038"></a><span id="l35.1038" class="difflineplus">+                              false /*allowUndo*/);</span>
<a href="#l35.1039"></a><span id="l35.1039" class="difflineplus">+  if (NS_FAILED(rv)) return NS_ERROR_FAILURE;</span>
<a href="#l35.1040"></a><span id="l35.1040"> </span>
<a href="#l35.1041"></a><span id="l35.1041">   // Null out the message so we don't try and delete it again.</span>
<a href="#l35.1042"></a><span id="l35.1042">   mMessage = nullptr;</span>
<a href="#l35.1043"></a><span id="l35.1043"> </span>
<a href="#l35.1044"></a><span id="l35.1044">   return NS_OK;</span>
<a href="#l35.1045"></a><span id="l35.1045"> }</span>
<a href="#l35.1046"></a><span id="l35.1046"> </span>
<a href="#l35.1047"></a><span id="l35.1047"> //</span>
<a href="#l35.1048"></a><span id="l35.1048" class="difflineat">@@ -931,261 +830,230 @@ nsMsgSendLater::DeleteCurrentMessage()</span>
<a href="#l35.1049"></a><span id="l35.1049"> // any headers which should not be delivered in mail, regardless of whether</span>
<a href="#l35.1050"></a><span id="l35.1050"> // they were present in the queue file.  Such headers include: BCC, FCC,</span>
<a href="#l35.1051"></a><span id="l35.1051"> // Sender, X-Mozilla-Status, X-Mozilla-News-Host, and Content-Length.</span>
<a href="#l35.1052"></a><span id="l35.1052"> // (Content-Length is for the disk file only, and must not be allowed to</span>
<a href="#l35.1053"></a><span id="l35.1053"> // escape onto the network, since it depends on the local linebreak</span>
<a href="#l35.1054"></a><span id="l35.1054"> // representation.  Arguably, we could allow Lines to escape, but it's not</span>
<a href="#l35.1055"></a><span id="l35.1055"> // required by NNTP.)</span>
<a href="#l35.1056"></a><span id="l35.1056"> //</span>
<a href="#l35.1057"></a><span id="l35.1057" class="difflineminus">-nsresult</span>
<a href="#l35.1058"></a><span id="l35.1058" class="difflineminus">-nsMsgSendLater::BuildHeaders()</span>
<a href="#l35.1059"></a><span id="l35.1059" class="difflineminus">-{</span>
<a href="#l35.1060"></a><span id="l35.1060" class="difflineplus">+nsresult nsMsgSendLater::BuildHeaders() {</span>
<a href="#l35.1061"></a><span id="l35.1061">   char *buf = m_headers;</span>
<a href="#l35.1062"></a><span id="l35.1062">   char *buf_end = buf + m_headersFP;</span>
<a href="#l35.1063"></a><span id="l35.1063"> </span>
<a href="#l35.1064"></a><span id="l35.1064">   PR_FREEIF(m_to);</span>
<a href="#l35.1065"></a><span id="l35.1065">   PR_FREEIF(m_bcc);</span>
<a href="#l35.1066"></a><span id="l35.1066">   PR_FREEIF(m_newsgroups);</span>
<a href="#l35.1067"></a><span id="l35.1067">   PR_FREEIF(m_newshost);</span>
<a href="#l35.1068"></a><span id="l35.1068">   PR_FREEIF(m_fcc);</span>
<a href="#l35.1069"></a><span id="l35.1069">   PR_FREEIF(mIdentityKey);</span>
<a href="#l35.1070"></a><span id="l35.1070">   PR_FREEIF(mAccountKey);</span>
<a href="#l35.1071"></a><span id="l35.1071">   m_flags = 0;</span>
<a href="#l35.1072"></a><span id="l35.1072"> </span>
<a href="#l35.1073"></a><span id="l35.1073" class="difflineminus">-  while (buf &lt; buf_end)</span>
<a href="#l35.1074"></a><span id="l35.1074" class="difflineminus">-  {</span>
<a href="#l35.1075"></a><span id="l35.1075" class="difflineplus">+  while (buf &lt; buf_end) {</span>
<a href="#l35.1076"></a><span id="l35.1076">     bool prune_p = false;</span>
<a href="#l35.1077"></a><span id="l35.1077">     bool do_flags_p = false;</span>
<a href="#l35.1078"></a><span id="l35.1078">     char *colon = PL_strchr(buf, ':');</span>
<a href="#l35.1079"></a><span id="l35.1079">     char *end;</span>
<a href="#l35.1080"></a><span id="l35.1080">     char *value = 0;</span>
<a href="#l35.1081"></a><span id="l35.1081">     char **header = 0;</span>
<a href="#l35.1082"></a><span id="l35.1082">     char *header_start = buf;</span>
<a href="#l35.1083"></a><span id="l35.1083"> </span>
<a href="#l35.1084"></a><span id="l35.1084" class="difflineminus">-    if (! colon)</span>
<a href="#l35.1085"></a><span id="l35.1085" class="difflineminus">-      break;</span>
<a href="#l35.1086"></a><span id="l35.1086" class="difflineplus">+    if (!colon) break;</span>
<a href="#l35.1087"></a><span id="l35.1087"> </span>
<a href="#l35.1088"></a><span id="l35.1088">     end = colon;</span>
<a href="#l35.1089"></a><span id="l35.1089" class="difflineminus">-    while (end &gt; buf &amp;&amp; (*end == ' ' || *end == '\t'))</span>
<a href="#l35.1090"></a><span id="l35.1090" class="difflineminus">-      end--;</span>
<a href="#l35.1091"></a><span id="l35.1091" class="difflineplus">+    while (end &gt; buf &amp;&amp; (*end == ' ' || *end == '\t')) end--;</span>
<a href="#l35.1092"></a><span id="l35.1092"> </span>
<a href="#l35.1093"></a><span id="l35.1093" class="difflineminus">-    switch (buf [0])</span>
<a href="#l35.1094"></a><span id="l35.1094" class="difflineminus">-    {</span>
<a href="#l35.1095"></a><span id="l35.1095" class="difflineminus">-    case 'B': case 'b':</span>
<a href="#l35.1096"></a><span id="l35.1096" class="difflineminus">-      if (!PL_strncasecmp (&quot;BCC&quot;, buf, end - buf))</span>
<a href="#l35.1097"></a><span id="l35.1097" class="difflineminus">-      {</span>
<a href="#l35.1098"></a><span id="l35.1098" class="difflineminus">-        header = &amp;m_bcc;</span>
<a href="#l35.1099"></a><span id="l35.1099" class="difflineminus">-        prune_p = true;</span>
<a href="#l35.1100"></a><span id="l35.1100" class="difflineminus">-      }</span>
<a href="#l35.1101"></a><span id="l35.1101" class="difflineminus">-      break;</span>
<a href="#l35.1102"></a><span id="l35.1102" class="difflineminus">-    case 'C': case 'c':</span>
<a href="#l35.1103"></a><span id="l35.1103" class="difflineminus">-      if (!PL_strncasecmp (&quot;CC&quot;, buf, end - buf))</span>
<a href="#l35.1104"></a><span id="l35.1104" class="difflineminus">-      header = &amp;m_to;</span>
<a href="#l35.1105"></a><span id="l35.1105" class="difflineminus">-      else if (!PL_strncasecmp (HEADER_CONTENT_LENGTH, buf, end - buf))</span>
<a href="#l35.1106"></a><span id="l35.1106" class="difflineminus">-      prune_p = true;</span>
<a href="#l35.1107"></a><span id="l35.1107" class="difflineminus">-      break;</span>
<a href="#l35.1108"></a><span id="l35.1108" class="difflineminus">-    case 'F': case 'f':</span>
<a href="#l35.1109"></a><span id="l35.1109" class="difflineminus">-      if (!PL_strncasecmp (&quot;FCC&quot;, buf, end - buf))</span>
<a href="#l35.1110"></a><span id="l35.1110" class="difflineminus">-      {</span>
<a href="#l35.1111"></a><span id="l35.1111" class="difflineminus">-        header = &amp;m_fcc;</span>
<a href="#l35.1112"></a><span id="l35.1112" class="difflineminus">-        prune_p = true;</span>
<a href="#l35.1113"></a><span id="l35.1113" class="difflineminus">-      }</span>
<a href="#l35.1114"></a><span id="l35.1114" class="difflineminus">-      break;</span>
<a href="#l35.1115"></a><span id="l35.1115" class="difflineminus">-    case 'L': case 'l':</span>
<a href="#l35.1116"></a><span id="l35.1116" class="difflineminus">-      if (!PL_strncasecmp (&quot;Lines&quot;, buf, end - buf))</span>
<a href="#l35.1117"></a><span id="l35.1117" class="difflineminus">-      prune_p = true;</span>
<a href="#l35.1118"></a><span id="l35.1118" class="difflineminus">-      break;</span>
<a href="#l35.1119"></a><span id="l35.1119" class="difflineminus">-    case 'N': case 'n':</span>
<a href="#l35.1120"></a><span id="l35.1120" class="difflineminus">-      if (!PL_strncasecmp (&quot;Newsgroups&quot;, buf, end - buf))</span>
<a href="#l35.1121"></a><span id="l35.1121" class="difflineminus">-        header = &amp;m_newsgroups;</span>
<a href="#l35.1122"></a><span id="l35.1122" class="difflineminus">-      break;</span>
<a href="#l35.1123"></a><span id="l35.1123" class="difflineminus">-    case 'S': case 's':</span>
<a href="#l35.1124"></a><span id="l35.1124" class="difflineminus">-      if (!PL_strncasecmp (&quot;Sender&quot;, buf, end - buf))</span>
<a href="#l35.1125"></a><span id="l35.1125" class="difflineminus">-      prune_p = true;</span>
<a href="#l35.1126"></a><span id="l35.1126" class="difflineminus">-      break;</span>
<a href="#l35.1127"></a><span id="l35.1127" class="difflineminus">-    case 'T': case 't':</span>
<a href="#l35.1128"></a><span id="l35.1128" class="difflineminus">-      if (!PL_strncasecmp (&quot;To&quot;, buf, end - buf))</span>
<a href="#l35.1129"></a><span id="l35.1129" class="difflineminus">-      header = &amp;m_to;</span>
<a href="#l35.1130"></a><span id="l35.1130" class="difflineminus">-      break;</span>
<a href="#l35.1131"></a><span id="l35.1131" class="difflineminus">-    case 'X': case 'x':</span>
<a href="#l35.1132"></a><span id="l35.1132" class="difflineminus">-      {</span>
<a href="#l35.1133"></a><span id="l35.1133" class="difflineplus">+    switch (buf[0]) {</span>
<a href="#l35.1134"></a><span id="l35.1134" class="difflineplus">+      case 'B':</span>
<a href="#l35.1135"></a><span id="l35.1135" class="difflineplus">+      case 'b':</span>
<a href="#l35.1136"></a><span id="l35.1136" class="difflineplus">+        if (!PL_strncasecmp(&quot;BCC&quot;, buf, end - buf)) {</span>
<a href="#l35.1137"></a><span id="l35.1137" class="difflineplus">+          header = &amp;m_bcc;</span>
<a href="#l35.1138"></a><span id="l35.1138" class="difflineplus">+          prune_p = true;</span>
<a href="#l35.1139"></a><span id="l35.1139" class="difflineplus">+        }</span>
<a href="#l35.1140"></a><span id="l35.1140" class="difflineplus">+        break;</span>
<a href="#l35.1141"></a><span id="l35.1141" class="difflineplus">+      case 'C':</span>
<a href="#l35.1142"></a><span id="l35.1142" class="difflineplus">+      case 'c':</span>
<a href="#l35.1143"></a><span id="l35.1143" class="difflineplus">+        if (!PL_strncasecmp(&quot;CC&quot;, buf, end - buf))</span>
<a href="#l35.1144"></a><span id="l35.1144" class="difflineplus">+          header = &amp;m_to;</span>
<a href="#l35.1145"></a><span id="l35.1145" class="difflineplus">+        else if (!PL_strncasecmp(HEADER_CONTENT_LENGTH, buf, end - buf))</span>
<a href="#l35.1146"></a><span id="l35.1146" class="difflineplus">+          prune_p = true;</span>
<a href="#l35.1147"></a><span id="l35.1147" class="difflineplus">+        break;</span>
<a href="#l35.1148"></a><span id="l35.1148" class="difflineplus">+      case 'F':</span>
<a href="#l35.1149"></a><span id="l35.1149" class="difflineplus">+      case 'f':</span>
<a href="#l35.1150"></a><span id="l35.1150" class="difflineplus">+        if (!PL_strncasecmp(&quot;FCC&quot;, buf, end - buf)) {</span>
<a href="#l35.1151"></a><span id="l35.1151" class="difflineplus">+          header = &amp;m_fcc;</span>
<a href="#l35.1152"></a><span id="l35.1152" class="difflineplus">+          prune_p = true;</span>
<a href="#l35.1153"></a><span id="l35.1153" class="difflineplus">+        }</span>
<a href="#l35.1154"></a><span id="l35.1154" class="difflineplus">+        break;</span>
<a href="#l35.1155"></a><span id="l35.1155" class="difflineplus">+      case 'L':</span>
<a href="#l35.1156"></a><span id="l35.1156" class="difflineplus">+      case 'l':</span>
<a href="#l35.1157"></a><span id="l35.1157" class="difflineplus">+        if (!PL_strncasecmp(&quot;Lines&quot;, buf, end - buf)) prune_p = true;</span>
<a href="#l35.1158"></a><span id="l35.1158" class="difflineplus">+        break;</span>
<a href="#l35.1159"></a><span id="l35.1159" class="difflineplus">+      case 'N':</span>
<a href="#l35.1160"></a><span id="l35.1160" class="difflineplus">+      case 'n':</span>
<a href="#l35.1161"></a><span id="l35.1161" class="difflineplus">+        if (!PL_strncasecmp(&quot;Newsgroups&quot;, buf, end - buf))</span>
<a href="#l35.1162"></a><span id="l35.1162" class="difflineplus">+          header = &amp;m_newsgroups;</span>
<a href="#l35.1163"></a><span id="l35.1163" class="difflineplus">+        break;</span>
<a href="#l35.1164"></a><span id="l35.1164" class="difflineplus">+      case 'S':</span>
<a href="#l35.1165"></a><span id="l35.1165" class="difflineplus">+      case 's':</span>
<a href="#l35.1166"></a><span id="l35.1166" class="difflineplus">+        if (!PL_strncasecmp(&quot;Sender&quot;, buf, end - buf)) prune_p = true;</span>
<a href="#l35.1167"></a><span id="l35.1167" class="difflineplus">+        break;</span>
<a href="#l35.1168"></a><span id="l35.1168" class="difflineplus">+      case 'T':</span>
<a href="#l35.1169"></a><span id="l35.1169" class="difflineplus">+      case 't':</span>
<a href="#l35.1170"></a><span id="l35.1170" class="difflineplus">+        if (!PL_strncasecmp(&quot;To&quot;, buf, end - buf)) header = &amp;m_to;</span>
<a href="#l35.1171"></a><span id="l35.1171" class="difflineplus">+        break;</span>
<a href="#l35.1172"></a><span id="l35.1172" class="difflineplus">+      case 'X':</span>
<a href="#l35.1173"></a><span id="l35.1173" class="difflineplus">+      case 'x': {</span>
<a href="#l35.1174"></a><span id="l35.1174">         if (buf + strlen(HEADER_X_MOZILLA_STATUS2) == end &amp;&amp;</span>
<a href="#l35.1175"></a><span id="l35.1175" class="difflineminus">-          !PL_strncasecmp(HEADER_X_MOZILLA_STATUS2, buf, end - buf))</span>
<a href="#l35.1176"></a><span id="l35.1176" class="difflineplus">+            !PL_strncasecmp(HEADER_X_MOZILLA_STATUS2, buf, end - buf))</span>
<a href="#l35.1177"></a><span id="l35.1177">           prune_p = true;</span>
<a href="#l35.1178"></a><span id="l35.1178">         else if (buf + strlen(HEADER_X_MOZILLA_STATUS) == end &amp;&amp;</span>
<a href="#l35.1179"></a><span id="l35.1179" class="difflineminus">-          !PL_strncasecmp(HEADER_X_MOZILLA_STATUS, buf, end - buf))</span>
<a href="#l35.1180"></a><span id="l35.1180" class="difflineplus">+                 !PL_strncasecmp(HEADER_X_MOZILLA_STATUS, buf, end - buf))</span>
<a href="#l35.1181"></a><span id="l35.1181">           prune_p = do_flags_p = true;</span>
<a href="#l35.1182"></a><span id="l35.1182">         else if (!PL_strncasecmp(HEADER_X_MOZILLA_DRAFT_INFO, buf, end - buf))</span>
<a href="#l35.1183"></a><span id="l35.1183">           prune_p = true;</span>
<a href="#l35.1184"></a><span id="l35.1184">         else if (!PL_strncasecmp(HEADER_X_MOZILLA_KEYWORDS, buf, end - buf))</span>
<a href="#l35.1185"></a><span id="l35.1185">           prune_p = true;</span>
<a href="#l35.1186"></a><span id="l35.1186" class="difflineminus">-        else if (!PL_strncasecmp(HEADER_X_MOZILLA_NEWSHOST, buf, end - buf))</span>
<a href="#l35.1187"></a><span id="l35.1187" class="difflineminus">-        {</span>
<a href="#l35.1188"></a><span id="l35.1188" class="difflineplus">+        else if (!PL_strncasecmp(HEADER_X_MOZILLA_NEWSHOST, buf, end - buf)) {</span>
<a href="#l35.1189"></a><span id="l35.1189">           prune_p = true;</span>
<a href="#l35.1190"></a><span id="l35.1190">           header = &amp;m_newshost;</span>
<a href="#l35.1191"></a><span id="l35.1191" class="difflineminus">-        }</span>
<a href="#l35.1192"></a><span id="l35.1192" class="difflineminus">-        else if (!PL_strncasecmp(HEADER_X_MOZILLA_IDENTITY_KEY, buf, end - buf))</span>
<a href="#l35.1193"></a><span id="l35.1193" class="difflineminus">-        {</span>
<a href="#l35.1194"></a><span id="l35.1194" class="difflineplus">+        } else if (!PL_strncasecmp(HEADER_X_MOZILLA_IDENTITY_KEY, buf,</span>
<a href="#l35.1195"></a><span id="l35.1195" class="difflineplus">+                                   end - buf)) {</span>
<a href="#l35.1196"></a><span id="l35.1196">           prune_p = true;</span>
<a href="#l35.1197"></a><span id="l35.1197">           header = &amp;mIdentityKey;</span>
<a href="#l35.1198"></a><span id="l35.1198" class="difflineminus">-        }</span>
<a href="#l35.1199"></a><span id="l35.1199" class="difflineminus">-        else if (!PL_strncasecmp(HEADER_X_MOZILLA_ACCOUNT_KEY, buf, end - buf))</span>
<a href="#l35.1200"></a><span id="l35.1200" class="difflineminus">-        {</span>
<a href="#l35.1201"></a><span id="l35.1201" class="difflineplus">+        } else if (!PL_strncasecmp(HEADER_X_MOZILLA_ACCOUNT_KEY, buf,</span>
<a href="#l35.1202"></a><span id="l35.1202" class="difflineplus">+                                   end - buf)) {</span>
<a href="#l35.1203"></a><span id="l35.1203">           prune_p = true;</span>
<a href="#l35.1204"></a><span id="l35.1204">           header = &amp;mAccountKey;</span>
<a href="#l35.1205"></a><span id="l35.1205">         }</span>
<a href="#l35.1206"></a><span id="l35.1206">         break;</span>
<a href="#l35.1207"></a><span id="l35.1207">       }</span>
<a href="#l35.1208"></a><span id="l35.1208">     }</span>
<a href="#l35.1209"></a><span id="l35.1209"> </span>
<a href="#l35.1210"></a><span id="l35.1210">     buf = colon + 1;</span>
<a href="#l35.1211"></a><span id="l35.1211" class="difflineminus">-    while (*buf == ' ' || *buf == '\t')</span>
<a href="#l35.1212"></a><span id="l35.1212" class="difflineminus">-    buf++;</span>
<a href="#l35.1213"></a><span id="l35.1213" class="difflineplus">+    while (*buf == ' ' || *buf == '\t') buf++;</span>
<a href="#l35.1214"></a><span id="l35.1214"> </span>
<a href="#l35.1215"></a><span id="l35.1215">     value = buf;</span>
<a href="#l35.1216"></a><span id="l35.1216"> </span>
<a href="#l35.1217"></a><span id="l35.1217" class="difflineminus">-SEARCH_NEWLINE:</span>
<a href="#l35.1218"></a><span id="l35.1218" class="difflineminus">-    while (*buf != 0 &amp;&amp; *buf != '\r' &amp;&amp; *buf != '\n')</span>
<a href="#l35.1219"></a><span id="l35.1219" class="difflineminus">-      buf++;</span>
<a href="#l35.1220"></a><span id="l35.1220" class="difflineplus">+  SEARCH_NEWLINE:</span>
<a href="#l35.1221"></a><span id="l35.1221" class="difflineplus">+    while (*buf != 0 &amp;&amp; *buf != '\r' &amp;&amp; *buf != '\n') buf++;</span>
<a href="#l35.1222"></a><span id="l35.1222"> </span>
<a href="#l35.1223"></a><span id="l35.1223" class="difflineminus">-    if (buf+1 &gt;= buf_end)</span>
<a href="#l35.1224"></a><span id="l35.1224" class="difflineplus">+    if (buf + 1 &gt;= buf_end)</span>
<a href="#l35.1225"></a><span id="l35.1225">       ;</span>
<a href="#l35.1226"></a><span id="l35.1226">     // If &quot;\r\n &quot; or &quot;\r\n\t&quot; is next, that doesn't terminate the header.</span>
<a href="#l35.1227"></a><span id="l35.1227" class="difflineminus">-    else if (buf+2 &lt; buf_end &amp;&amp;</span>
<a href="#l35.1228"></a><span id="l35.1228" class="difflineminus">-         (buf[0] == '\r'  &amp;&amp; buf[1] == '\n') &amp;&amp;</span>
<a href="#l35.1229"></a><span id="l35.1229" class="difflineminus">-         (buf[2] == ' ' || buf[2] == '\t'))</span>
<a href="#l35.1230"></a><span id="l35.1230" class="difflineminus">-    {</span>
<a href="#l35.1231"></a><span id="l35.1231" class="difflineplus">+    else if (buf + 2 &lt; buf_end &amp;&amp; (buf[0] == '\r' &amp;&amp; buf[1] == '\n') &amp;&amp;</span>
<a href="#l35.1232"></a><span id="l35.1232" class="difflineplus">+             (buf[2] == ' ' || buf[2] == '\t')) {</span>
<a href="#l35.1233"></a><span id="l35.1233">       buf += 3;</span>
<a href="#l35.1234"></a><span id="l35.1234">       goto SEARCH_NEWLINE;</span>
<a href="#l35.1235"></a><span id="l35.1235">     }</span>
<a href="#l35.1236"></a><span id="l35.1236">     // If &quot;\r &quot; or &quot;\r\t&quot; or &quot;\n &quot; or &quot;\n\t&quot; is next, that doesn't terminate</span>
<a href="#l35.1237"></a><span id="l35.1237">     // the header either.</span>
<a href="#l35.1238"></a><span id="l35.1238" class="difflineminus">-    else if ((buf[0] == '\r'  || buf[0] == '\n') &amp;&amp;</span>
<a href="#l35.1239"></a><span id="l35.1239" class="difflineminus">-         (buf[1] == ' ' || buf[1] == '\t'))</span>
<a href="#l35.1240"></a><span id="l35.1240" class="difflineminus">-    {</span>
<a href="#l35.1241"></a><span id="l35.1241" class="difflineplus">+    else if ((buf[0] == '\r' || buf[0] == '\n') &amp;&amp;</span>
<a href="#l35.1242"></a><span id="l35.1242" class="difflineplus">+             (buf[1] == ' ' || buf[1] == '\t')) {</span>
<a href="#l35.1243"></a><span id="l35.1243">       buf += 2;</span>
<a href="#l35.1244"></a><span id="l35.1244">       goto SEARCH_NEWLINE;</span>
<a href="#l35.1245"></a><span id="l35.1245">     }</span>
<a href="#l35.1246"></a><span id="l35.1246"> </span>
<a href="#l35.1247"></a><span id="l35.1247" class="difflineminus">-    if (header)</span>
<a href="#l35.1248"></a><span id="l35.1248" class="difflineminus">-    {</span>
<a href="#l35.1249"></a><span id="l35.1249" class="difflineplus">+    if (header) {</span>
<a href="#l35.1250"></a><span id="l35.1250">       int L = buf - value;</span>
<a href="#l35.1251"></a><span id="l35.1251" class="difflineminus">-      if (*header)</span>
<a href="#l35.1252"></a><span id="l35.1252" class="difflineminus">-      {</span>
<a href="#l35.1253"></a><span id="l35.1253" class="difflineminus">-        char *newh = (char*) PR_Realloc ((*header),</span>
<a href="#l35.1254"></a><span id="l35.1254" class="difflineminus">-                         PL_strlen(*header) + L + 10);</span>
<a href="#l35.1255"></a><span id="l35.1255" class="difflineplus">+      if (*header) {</span>
<a href="#l35.1256"></a><span id="l35.1256" class="difflineplus">+        char *newh = (char *)PR_Realloc((*header), PL_strlen(*header) + L + 10);</span>
<a href="#l35.1257"></a><span id="l35.1257">         if (!newh) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l35.1258"></a><span id="l35.1258">         *header = newh;</span>
<a href="#l35.1259"></a><span id="l35.1259" class="difflineminus">-        newh = (*header) + PL_strlen (*header);</span>
<a href="#l35.1260"></a><span id="l35.1260" class="difflineplus">+        newh = (*header) + PL_strlen(*header);</span>
<a href="#l35.1261"></a><span id="l35.1261">         *newh++ = ',';</span>
<a href="#l35.1262"></a><span id="l35.1262">         *newh++ = ' ';</span>
<a href="#l35.1263"></a><span id="l35.1263">         memcpy(newh, value, L);</span>
<a href="#l35.1264"></a><span id="l35.1264" class="difflineminus">-        newh [L] = 0;</span>
<a href="#l35.1265"></a><span id="l35.1265" class="difflineminus">-      }</span>
<a href="#l35.1266"></a><span id="l35.1266" class="difflineminus">-      else</span>
<a href="#l35.1267"></a><span id="l35.1267" class="difflineminus">-      {</span>
<a href="#l35.1268"></a><span id="l35.1268" class="difflineminus">-        *header = (char *) PR_Malloc(L+1);</span>
<a href="#l35.1269"></a><span id="l35.1269" class="difflineplus">+        newh[L] = 0;</span>
<a href="#l35.1270"></a><span id="l35.1270" class="difflineplus">+      } else {</span>
<a href="#l35.1271"></a><span id="l35.1271" class="difflineplus">+        *header = (char *)PR_Malloc(L + 1);</span>
<a href="#l35.1272"></a><span id="l35.1272">         if (!*header) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l35.1273"></a><span id="l35.1273">         memcpy((*header), value, L);</span>
<a href="#l35.1274"></a><span id="l35.1274">         (*header)[L] = 0;</span>
<a href="#l35.1275"></a><span id="l35.1275">       }</span>
<a href="#l35.1276"></a><span id="l35.1276" class="difflineminus">-    }</span>
<a href="#l35.1277"></a><span id="l35.1277" class="difflineminus">-    else if (do_flags_p)</span>
<a href="#l35.1278"></a><span id="l35.1278" class="difflineminus">-    {</span>
<a href="#l35.1279"></a><span id="l35.1279" class="difflineplus">+    } else if (do_flags_p) {</span>
<a href="#l35.1280"></a><span id="l35.1280">       char *s = value;</span>
<a href="#l35.1281"></a><span id="l35.1281">       PR_ASSERT(*s != ' ' &amp;&amp; *s != '\t');</span>
<a href="#l35.1282"></a><span id="l35.1282">       NS_ASSERTION(MsgIsHex(s, 4), &quot;Expected 4 hex digits for flags.&quot;);</span>
<a href="#l35.1283"></a><span id="l35.1283">       m_flags = MsgUnhex(s, 4);</span>
<a href="#l35.1284"></a><span id="l35.1284">     }</span>
<a href="#l35.1285"></a><span id="l35.1285"> </span>
<a href="#l35.1286"></a><span id="l35.1286" class="difflineminus">-    if (*buf == '\r' || *buf == '\n')</span>
<a href="#l35.1287"></a><span id="l35.1287" class="difflineminus">-    {</span>
<a href="#l35.1288"></a><span id="l35.1288" class="difflineminus">-      if (*buf == '\r' &amp;&amp; buf[1] == '\n')</span>
<a href="#l35.1289"></a><span id="l35.1289" class="difflineminus">-      buf++;</span>
<a href="#l35.1290"></a><span id="l35.1290" class="difflineplus">+    if (*buf == '\r' || *buf == '\n') {</span>
<a href="#l35.1291"></a><span id="l35.1291" class="difflineplus">+      if (*buf == '\r' &amp;&amp; buf[1] == '\n') buf++;</span>
<a href="#l35.1292"></a><span id="l35.1292">       buf++;</span>
<a href="#l35.1293"></a><span id="l35.1293">     }</span>
<a href="#l35.1294"></a><span id="l35.1294"> </span>
<a href="#l35.1295"></a><span id="l35.1295" class="difflineminus">-    if (prune_p)</span>
<a href="#l35.1296"></a><span id="l35.1296" class="difflineminus">-    {</span>
<a href="#l35.1297"></a><span id="l35.1297" class="difflineplus">+    if (prune_p) {</span>
<a href="#l35.1298"></a><span id="l35.1298">       char *to = header_start;</span>
<a href="#l35.1299"></a><span id="l35.1299">       char *from = buf;</span>
<a href="#l35.1300"></a><span id="l35.1300" class="difflineminus">-      while (from &lt; buf_end)</span>
<a href="#l35.1301"></a><span id="l35.1301" class="difflineminus">-      *to++ = *from++;</span>
<a href="#l35.1302"></a><span id="l35.1302" class="difflineplus">+      while (from &lt; buf_end) *to++ = *from++;</span>
<a href="#l35.1303"></a><span id="l35.1303">       buf = header_start;</span>
<a href="#l35.1304"></a><span id="l35.1304">       buf_end = to;</span>
<a href="#l35.1305"></a><span id="l35.1305">       m_headersFP = buf_end - m_headers;</span>
<a href="#l35.1306"></a><span id="l35.1306">     }</span>
<a href="#l35.1307"></a><span id="l35.1307">   }</span>
<a href="#l35.1308"></a><span id="l35.1308"> </span>
<a href="#l35.1309"></a><span id="l35.1309">   m_headers[m_headersFP++] = '\r';</span>
<a href="#l35.1310"></a><span id="l35.1310">   m_headers[m_headersFP++] = '\n';</span>
<a href="#l35.1311"></a><span id="l35.1311"> </span>
<a href="#l35.1312"></a><span id="l35.1312">   // Now we have parsed out all of the headers we need and we</span>
<a href="#l35.1313"></a><span id="l35.1313">   // can proceed.</span>
<a href="#l35.1314"></a><span id="l35.1314">   return NS_OK;</span>
<a href="#l35.1315"></a><span id="l35.1315"> }</span>
<a href="#l35.1316"></a><span id="l35.1316"> </span>
<a href="#l35.1317"></a><span id="l35.1317" class="difflineminus">-nsresult</span>
<a href="#l35.1318"></a><span id="l35.1318" class="difflineminus">-DoGrowBuffer(int32_t desired_size, int32_t element_size, int32_t quantum,</span>
<a href="#l35.1319"></a><span id="l35.1319" class="difflineminus">-            char **buffer, int32_t *size)</span>
<a href="#l35.1320"></a><span id="l35.1320" class="difflineminus">-{</span>
<a href="#l35.1321"></a><span id="l35.1321" class="difflineminus">-  if (*size &lt;= desired_size)</span>
<a href="#l35.1322"></a><span id="l35.1322" class="difflineminus">-  {</span>
<a href="#l35.1323"></a><span id="l35.1323" class="difflineplus">+nsresult DoGrowBuffer(int32_t desired_size, int32_t element_size,</span>
<a href="#l35.1324"></a><span id="l35.1324" class="difflineplus">+                      int32_t quantum, char **buffer, int32_t *size) {</span>
<a href="#l35.1325"></a><span id="l35.1325" class="difflineplus">+  if (*size &lt;= desired_size) {</span>
<a href="#l35.1326"></a><span id="l35.1326">     char *new_buf;</span>
<a href="#l35.1327"></a><span id="l35.1327">     int32_t increment = desired_size - *size;</span>
<a href="#l35.1328"></a><span id="l35.1328" class="difflineminus">-    if (increment &lt; quantum) // always grow by a minimum of N bytes</span>
<a href="#l35.1329"></a><span id="l35.1329" class="difflineplus">+    if (increment &lt; quantum)  // always grow by a minimum of N bytes</span>
<a href="#l35.1330"></a><span id="l35.1330">       increment = quantum;</span>
<a href="#l35.1331"></a><span id="l35.1331"> </span>
<a href="#l35.1332"></a><span id="l35.1332" class="difflineminus">-    new_buf = (*buffer</span>
<a href="#l35.1333"></a><span id="l35.1333" class="difflineminus">-                ? (char *) PR_Realloc (*buffer, (*size + increment)</span>
<a href="#l35.1334"></a><span id="l35.1334" class="difflineminus">-                * (element_size / sizeof(char)))</span>
<a href="#l35.1335"></a><span id="l35.1335" class="difflineminus">-                : (char *) PR_Malloc ((*size + increment)</span>
<a href="#l35.1336"></a><span id="l35.1336" class="difflineminus">-                * (element_size / sizeof(char))));</span>
<a href="#l35.1337"></a><span id="l35.1337" class="difflineminus">-    if (! new_buf)</span>
<a href="#l35.1338"></a><span id="l35.1338" class="difflineminus">-      return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l35.1339"></a><span id="l35.1339" class="difflineplus">+    new_buf =</span>
<a href="#l35.1340"></a><span id="l35.1340" class="difflineplus">+        (*buffer</span>
<a href="#l35.1341"></a><span id="l35.1341" class="difflineplus">+             ? (char *)PR_Realloc(</span>
<a href="#l35.1342"></a><span id="l35.1342" class="difflineplus">+                   *buffer, (*size + increment) * (element_size / sizeof(char)))</span>
<a href="#l35.1343"></a><span id="l35.1343" class="difflineplus">+             : (char *)PR_Malloc((*size + increment) *</span>
<a href="#l35.1344"></a><span id="l35.1344" class="difflineplus">+                                 (element_size / sizeof(char))));</span>
<a href="#l35.1345"></a><span id="l35.1345" class="difflineplus">+    if (!new_buf) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l35.1346"></a><span id="l35.1346">     *buffer = new_buf;</span>
<a href="#l35.1347"></a><span id="l35.1347">     *size += increment;</span>
<a href="#l35.1348"></a><span id="l35.1348">   }</span>
<a href="#l35.1349"></a><span id="l35.1349">   return NS_OK;</span>
<a href="#l35.1350"></a><span id="l35.1350"> }</span>
<a href="#l35.1351"></a><span id="l35.1351"> </span>
<a href="#l35.1352"></a><span id="l35.1352" class="difflineminus">-#define do_grow_headers(desired_size) \</span>
<a href="#l35.1353"></a><span id="l35.1353" class="difflineminus">-  (((desired_size) &gt;= m_headersSize) ? \</span>
<a href="#l35.1354"></a><span id="l35.1354" class="difflineminus">-   DoGrowBuffer ((desired_size), sizeof(char), 1024, \</span>
<a href="#l35.1355"></a><span id="l35.1355" class="difflineminus">-           &amp;m_headers, &amp;m_headersSize) \</span>
<a href="#l35.1356"></a><span id="l35.1356" class="difflineminus">-   : NS_OK)</span>
<a href="#l35.1357"></a><span id="l35.1357" class="difflineplus">+#define do_grow_headers(desired_size)                                 \</span>
<a href="#l35.1358"></a><span id="l35.1358" class="difflineplus">+  (((desired_size) &gt;= m_headersSize)                                  \</span>
<a href="#l35.1359"></a><span id="l35.1359" class="difflineplus">+       ? DoGrowBuffer((desired_size), sizeof(char), 1024, &amp;m_headers, \</span>
<a href="#l35.1360"></a><span id="l35.1360" class="difflineplus">+                      &amp;m_headersSize)                                 \</span>
<a href="#l35.1361"></a><span id="l35.1361" class="difflineplus">+       : NS_OK)</span>
<a href="#l35.1362"></a><span id="l35.1362"> </span>
<a href="#l35.1363"></a><span id="l35.1363" class="difflineminus">-nsresult</span>
<a href="#l35.1364"></a><span id="l35.1364" class="difflineminus">-nsMsgSendLater::DeliverQueuedLine(char *line, int32_t length)</span>
<a href="#l35.1365"></a><span id="l35.1365" class="difflineminus">-{</span>
<a href="#l35.1366"></a><span id="l35.1366" class="difflineplus">+nsresult nsMsgSendLater::DeliverQueuedLine(char *line, int32_t length) {</span>
<a href="#l35.1367"></a><span id="l35.1367">   int32_t flength = length;</span>
<a href="#l35.1368"></a><span id="l35.1368"> </span>
<a href="#l35.1369"></a><span id="l35.1369">   m_bytesRead += length;</span>
<a href="#l35.1370"></a><span id="l35.1370"> </span>
<a href="#l35.1371"></a><span id="l35.1371" class="difflineminus">-// convert existing newline to CRLF</span>
<a href="#l35.1372"></a><span id="l35.1372" class="difflineminus">-// Don't need this because the calling routine is taking care of it.</span>
<a href="#l35.1373"></a><span id="l35.1373" class="difflineminus">-//  if (length &gt; 0 &amp;&amp; (line[length-1] == '\r' ||</span>
<a href="#l35.1374"></a><span id="l35.1374" class="difflineminus">-//     (line[length-1] == '\n' &amp;&amp; (length &lt; 2 || line[length-2] != '\r'))))</span>
<a href="#l35.1375"></a><span id="l35.1375" class="difflineminus">-//  {</span>
<a href="#l35.1376"></a><span id="l35.1376" class="difflineminus">-//    line[length-1] = '\r';</span>
<a href="#l35.1377"></a><span id="l35.1377" class="difflineminus">-//    line[length++] = '\n';</span>
<a href="#l35.1378"></a><span id="l35.1378" class="difflineminus">-//  }</span>
<a href="#l35.1379"></a><span id="l35.1379" class="difflineminus">-//</span>
<a href="#l35.1380"></a><span id="l35.1380" class="difflineplus">+  // convert existing newline to CRLF</span>
<a href="#l35.1381"></a><span id="l35.1381" class="difflineplus">+  // Don't need this because the calling routine is taking care of it.</span>
<a href="#l35.1382"></a><span id="l35.1382" class="difflineplus">+  //  if (length &gt; 0 &amp;&amp; (line[length-1] == '\r' ||</span>
<a href="#l35.1383"></a><span id="l35.1383" class="difflineplus">+  //     (line[length-1] == '\n' &amp;&amp; (length &lt; 2 || line[length-2] != '\r'))))</span>
<a href="#l35.1384"></a><span id="l35.1384" class="difflineplus">+  //  {</span>
<a href="#l35.1385"></a><span id="l35.1385" class="difflineplus">+  //    line[length-1] = '\r';</span>
<a href="#l35.1386"></a><span id="l35.1386" class="difflineplus">+  //    line[length++] = '\n';</span>
<a href="#l35.1387"></a><span id="l35.1387" class="difflineplus">+  //  }</span>
<a href="#l35.1388"></a><span id="l35.1388" class="difflineplus">+  //</span>
<a href="#l35.1389"></a><span id="l35.1389">   //</span>
<a href="#l35.1390"></a><span id="l35.1390">   // We are going to check if we are looking at a &quot;From - &quot; line. If so,</span>
<a href="#l35.1391"></a><span id="l35.1391">   // then just eat it and return NS_OK</span>
<a href="#l35.1392"></a><span id="l35.1392">   //</span>
<a href="#l35.1393"></a><span id="l35.1393" class="difflineminus">-  if (!PL_strncasecmp(line, &quot;From - &quot;, 7))</span>
<a href="#l35.1394"></a><span id="l35.1394" class="difflineminus">-    return NS_OK;</span>
<a href="#l35.1395"></a><span id="l35.1395" class="difflineplus">+  if (!PL_strncasecmp(line, &quot;From - &quot;, 7)) return NS_OK;</span>
<a href="#l35.1396"></a><span id="l35.1396"> </span>
<a href="#l35.1397"></a><span id="l35.1397" class="difflineminus">-  if (m_inhead)</span>
<a href="#l35.1398"></a><span id="l35.1398" class="difflineminus">-  {</span>
<a href="#l35.1399"></a><span id="l35.1399" class="difflineminus">-    if (m_headersPosition == 0)</span>
<a href="#l35.1400"></a><span id="l35.1400" class="difflineminus">-    {</span>
<a href="#l35.1401"></a><span id="l35.1401" class="difflineplus">+  if (m_inhead) {</span>
<a href="#l35.1402"></a><span id="l35.1402" class="difflineplus">+    if (m_headersPosition == 0) {</span>
<a href="#l35.1403"></a><span id="l35.1403">       // This line is the first line in a header block.</span>
<a href="#l35.1404"></a><span id="l35.1404">       // Remember its position.</span>
<a href="#l35.1405"></a><span id="l35.1405">       m_headersPosition = m_position;</span>
<a href="#l35.1406"></a><span id="l35.1406"> </span>
<a href="#l35.1407"></a><span id="l35.1407">       // Also, since we're now processing the headers, clear out the</span>
<a href="#l35.1408"></a><span id="l35.1408">       // slots which we will parse data into, so that the values that</span>
<a href="#l35.1409"></a><span id="l35.1409">       // were used the last time around do not persist.</span>
<a href="#l35.1410"></a><span id="l35.1410"> </span>
<a href="#l35.1411"></a><span id="l35.1411" class="difflineat">@@ -1199,199 +1067,176 @@ nsMsgSendLater::DeliverQueuedLine(char *</span>
<a href="#l35.1412"></a><span id="l35.1412">       PR_FREEIF(m_to);</span>
<a href="#l35.1413"></a><span id="l35.1413">       PR_FREEIF(m_bcc);</span>
<a href="#l35.1414"></a><span id="l35.1414">       PR_FREEIF(m_newsgroups);</span>
<a href="#l35.1415"></a><span id="l35.1415">       PR_FREEIF(m_newshost);</span>
<a href="#l35.1416"></a><span id="l35.1416">       PR_FREEIF(m_fcc);</span>
<a href="#l35.1417"></a><span id="l35.1417">       PR_FREEIF(mIdentityKey);</span>
<a href="#l35.1418"></a><span id="l35.1418">     }</span>
<a href="#l35.1419"></a><span id="l35.1419"> </span>
<a href="#l35.1420"></a><span id="l35.1420" class="difflineminus">-    if (line[0] == '\r' || line[0] == '\n' || line[0] == 0)</span>
<a href="#l35.1421"></a><span id="l35.1421" class="difflineminus">-    {</span>
<a href="#l35.1422"></a><span id="l35.1422" class="difflineplus">+    if (line[0] == '\r' || line[0] == '\n' || line[0] == 0) {</span>
<a href="#l35.1423"></a><span id="l35.1423">       // End of headers.  Now parse them; open the temp file;</span>
<a href="#l35.1424"></a><span id="l35.1424">       // and write the appropriate subset of the headers out.</span>
<a href="#l35.1425"></a><span id="l35.1425">       m_inhead = false;</span>
<a href="#l35.1426"></a><span id="l35.1426"> </span>
<a href="#l35.1427"></a><span id="l35.1427" class="difflineminus">-      nsresult rv = MsgNewBufferedFileOutputStream(getter_AddRefs(mOutFile), mTempFile, -1, 00600);</span>
<a href="#l35.1428"></a><span id="l35.1428" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l35.1429"></a><span id="l35.1429" class="difflineminus">-        return NS_MSG_ERROR_WRITING_FILE;</span>
<a href="#l35.1430"></a><span id="l35.1430" class="difflineplus">+      nsresult rv = MsgNewBufferedFileOutputStream(getter_AddRefs(mOutFile),</span>
<a href="#l35.1431"></a><span id="l35.1431" class="difflineplus">+                                                   mTempFile, -1, 00600);</span>
<a href="#l35.1432"></a><span id="l35.1432" class="difflineplus">+      if (NS_FAILED(rv)) return NS_MSG_ERROR_WRITING_FILE;</span>
<a href="#l35.1433"></a><span id="l35.1433"> </span>
<a href="#l35.1434"></a><span id="l35.1434">       nsresult status = BuildHeaders();</span>
<a href="#l35.1435"></a><span id="l35.1435" class="difflineminus">-      if (NS_FAILED(status))</span>
<a href="#l35.1436"></a><span id="l35.1436" class="difflineminus">-        return status;</span>
<a href="#l35.1437"></a><span id="l35.1437" class="difflineplus">+      if (NS_FAILED(status)) return status;</span>
<a href="#l35.1438"></a><span id="l35.1438"> </span>
<a href="#l35.1439"></a><span id="l35.1439">       uint32_t n;</span>
<a href="#l35.1440"></a><span id="l35.1440">       rv = mOutFile-&gt;Write(m_headers, m_headersFP, &amp;n);</span>
<a href="#l35.1441"></a><span id="l35.1441">       if (NS_FAILED(rv) || n != (uint32_t)m_headersFP)</span>
<a href="#l35.1442"></a><span id="l35.1442">         return NS_MSG_ERROR_WRITING_FILE;</span>
<a href="#l35.1443"></a><span id="l35.1443" class="difflineminus">-    }</span>
<a href="#l35.1444"></a><span id="l35.1444" class="difflineminus">-    else</span>
<a href="#l35.1445"></a><span id="l35.1445" class="difflineminus">-    {</span>
<a href="#l35.1446"></a><span id="l35.1446" class="difflineplus">+    } else {</span>
<a href="#l35.1447"></a><span id="l35.1447">       // Otherwise, this line belongs to a header.  So append it to the</span>
<a href="#l35.1448"></a><span id="l35.1448">       // header data.</span>
<a href="#l35.1449"></a><span id="l35.1449"> </span>
<a href="#l35.1450"></a><span id="l35.1450" class="difflineminus">-      if (!PL_strncasecmp (line, HEADER_X_MOZILLA_STATUS, PL_strlen(HEADER_X_MOZILLA_STATUS)))</span>
<a href="#l35.1451"></a><span id="l35.1451" class="difflineplus">+      if (!PL_strncasecmp(line, HEADER_X_MOZILLA_STATUS,</span>
<a href="#l35.1452"></a><span id="l35.1452" class="difflineplus">+                          PL_strlen(HEADER_X_MOZILLA_STATUS)))</span>
<a href="#l35.1453"></a><span id="l35.1453">         // Notice the position of the flags.</span>
<a href="#l35.1454"></a><span id="l35.1454">         m_flagsPosition = m_position;</span>
<a href="#l35.1455"></a><span id="l35.1455">       else if (m_headersFP == 0)</span>
<a href="#l35.1456"></a><span id="l35.1456">         m_flagsPosition = 0;</span>
<a href="#l35.1457"></a><span id="l35.1457"> </span>
<a href="#l35.1458"></a><span id="l35.1458" class="difflineminus">-      nsresult status = do_grow_headers (length + m_headersFP + 10);</span>
<a href="#l35.1459"></a><span id="l35.1459" class="difflineminus">-      if (NS_FAILED(status))</span>
<a href="#l35.1460"></a><span id="l35.1460" class="difflineminus">-        return status;</span>
<a href="#l35.1461"></a><span id="l35.1461" class="difflineplus">+      nsresult status = do_grow_headers(length + m_headersFP + 10);</span>
<a href="#l35.1462"></a><span id="l35.1462" class="difflineplus">+      if (NS_FAILED(status)) return status;</span>
<a href="#l35.1463"></a><span id="l35.1463"> </span>
<a href="#l35.1464"></a><span id="l35.1464">       memcpy(m_headers + m_headersFP, line, length);</span>
<a href="#l35.1465"></a><span id="l35.1465">       m_headersFP += length;</span>
<a href="#l35.1466"></a><span id="l35.1466">     }</span>
<a href="#l35.1467"></a><span id="l35.1467" class="difflineminus">-  }</span>
<a href="#l35.1468"></a><span id="l35.1468" class="difflineminus">-  else</span>
<a href="#l35.1469"></a><span id="l35.1469" class="difflineminus">-  {</span>
<a href="#l35.1470"></a><span id="l35.1470" class="difflineplus">+  } else {</span>
<a href="#l35.1471"></a><span id="l35.1471">     // This is a body line.  Write it to the file.</span>
<a href="#l35.1472"></a><span id="l35.1472">     PR_ASSERT(mOutFile);</span>
<a href="#l35.1473"></a><span id="l35.1473" class="difflineminus">-    if (mOutFile)</span>
<a href="#l35.1474"></a><span id="l35.1474" class="difflineminus">-    {</span>
<a href="#l35.1475"></a><span id="l35.1475" class="difflineplus">+    if (mOutFile) {</span>
<a href="#l35.1476"></a><span id="l35.1476">       uint32_t wrote;</span>
<a href="#l35.1477"></a><span id="l35.1477">       nsresult rv = mOutFile-&gt;Write(line, length, &amp;wrote);</span>
<a href="#l35.1478"></a><span id="l35.1478" class="difflineminus">-      if (NS_FAILED(rv) || wrote &lt; (uint32_t) length)</span>
<a href="#l35.1479"></a><span id="l35.1479" class="difflineplus">+      if (NS_FAILED(rv) || wrote &lt; (uint32_t)length)</span>
<a href="#l35.1480"></a><span id="l35.1480">         return NS_MSG_ERROR_WRITING_FILE;</span>
<a href="#l35.1481"></a><span id="l35.1481">     }</span>
<a href="#l35.1482"></a><span id="l35.1482">   }</span>
<a href="#l35.1483"></a><span id="l35.1483"> </span>
<a href="#l35.1484"></a><span id="l35.1484">   m_position += flength;</span>
<a href="#l35.1485"></a><span id="l35.1485">   return NS_OK;</span>
<a href="#l35.1486"></a><span id="l35.1486"> }</span>
<a href="#l35.1487"></a><span id="l35.1487"> </span>
<a href="#l35.1488"></a><span id="l35.1488"> NS_IMETHODIMP</span>
<a href="#l35.1489"></a><span id="l35.1489" class="difflineminus">-nsMsgSendLater::AddListener(nsIMsgSendLaterListener *aListener)</span>
<a href="#l35.1490"></a><span id="l35.1490" class="difflineminus">-{</span>
<a href="#l35.1491"></a><span id="l35.1491" class="difflineplus">+nsMsgSendLater::AddListener(nsIMsgSendLaterListener *aListener) {</span>
<a href="#l35.1492"></a><span id="l35.1492">   NS_ENSURE_ARG_POINTER(aListener);</span>
<a href="#l35.1493"></a><span id="l35.1493">   mListenerArray.AppendElement(aListener);</span>
<a href="#l35.1494"></a><span id="l35.1494">   return NS_OK;</span>
<a href="#l35.1495"></a><span id="l35.1495"> }</span>
<a href="#l35.1496"></a><span id="l35.1496"> </span>
<a href="#l35.1497"></a><span id="l35.1497"> NS_IMETHODIMP</span>
<a href="#l35.1498"></a><span id="l35.1498" class="difflineminus">-nsMsgSendLater::RemoveListener(nsIMsgSendLaterListener *aListener)</span>
<a href="#l35.1499"></a><span id="l35.1499" class="difflineminus">-{</span>
<a href="#l35.1500"></a><span id="l35.1500" class="difflineplus">+nsMsgSendLater::RemoveListener(nsIMsgSendLaterListener *aListener) {</span>
<a href="#l35.1501"></a><span id="l35.1501">   NS_ENSURE_ARG_POINTER(aListener);</span>
<a href="#l35.1502"></a><span id="l35.1502">   return mListenerArray.RemoveElement(aListener) ? NS_OK : NS_ERROR_INVALID_ARG;</span>
<a href="#l35.1503"></a><span id="l35.1503"> }</span>
<a href="#l35.1504"></a><span id="l35.1504"> </span>
<a href="#l35.1505"></a><span id="l35.1505"> NS_IMETHODIMP</span>
<a href="#l35.1506"></a><span id="l35.1506" class="difflineminus">-nsMsgSendLater::GetSendingMessages(bool *aResult)</span>
<a href="#l35.1507"></a><span id="l35.1507" class="difflineminus">-{</span>
<a href="#l35.1508"></a><span id="l35.1508" class="difflineplus">+nsMsgSendLater::GetSendingMessages(bool *aResult) {</span>
<a href="#l35.1509"></a><span id="l35.1509">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l35.1510"></a><span id="l35.1510">   *aResult = mSendingMessages;</span>
<a href="#l35.1511"></a><span id="l35.1511">   return NS_OK;</span>
<a href="#l35.1512"></a><span id="l35.1512"> }</span>
<a href="#l35.1513"></a><span id="l35.1513"> </span>
<a href="#l35.1514"></a><span id="l35.1514" class="difflineminus">-#define NOTIFY_LISTENERS(propertyfunc_, params_) \</span>
<a href="#l35.1515"></a><span id="l35.1515" class="difflineminus">-  PR_BEGIN_MACRO                                 \</span>
<a href="#l35.1516"></a><span id="l35.1516" class="difflineminus">-  nsTObserverArray&lt;nsCOMPtr&lt;nsIMsgSendLaterListener&gt; &gt;::ForwardIterator iter(mListenerArray); \</span>
<a href="#l35.1517"></a><span id="l35.1517" class="difflineminus">-  nsCOMPtr&lt;nsIMsgSendLaterListener&gt; listener;    \</span>
<a href="#l35.1518"></a><span id="l35.1518" class="difflineminus">-  while (iter.HasMore()) {                       \</span>
<a href="#l35.1519"></a><span id="l35.1519" class="difflineminus">-    listener = iter.GetNext();                   \</span>
<a href="#l35.1520"></a><span id="l35.1520" class="difflineminus">-    listener-&gt;propertyfunc_ params_;             \</span>
<a href="#l35.1521"></a><span id="l35.1521" class="difflineminus">-  }                                              \</span>
<a href="#l35.1522"></a><span id="l35.1522" class="difflineplus">+#define NOTIFY_LISTENERS(propertyfunc_, params_)                              \</span>
<a href="#l35.1523"></a><span id="l35.1523" class="difflineplus">+  PR_BEGIN_MACRO                                                              \</span>
<a href="#l35.1524"></a><span id="l35.1524" class="difflineplus">+  nsTObserverArray&lt;nsCOMPtr&lt;nsIMsgSendLaterListener&gt; &gt;::ForwardIterator iter( \</span>
<a href="#l35.1525"></a><span id="l35.1525" class="difflineplus">+      mListenerArray);                                                        \</span>
<a href="#l35.1526"></a><span id="l35.1526" class="difflineplus">+  nsCOMPtr&lt;nsIMsgSendLaterListener&gt; listener;                                 \</span>
<a href="#l35.1527"></a><span id="l35.1527" class="difflineplus">+  while (iter.HasMore()) {                                                    \</span>
<a href="#l35.1528"></a><span id="l35.1528" class="difflineplus">+    listener = iter.GetNext();                                                \</span>
<a href="#l35.1529"></a><span id="l35.1529" class="difflineplus">+    listener-&gt;propertyfunc_ params_;                                          \</span>
<a href="#l35.1530"></a><span id="l35.1530" class="difflineplus">+  }                                                                           \</span>
<a href="#l35.1531"></a><span id="l35.1531">   PR_END_MACRO</span>
<a href="#l35.1532"></a><span id="l35.1532"> </span>
<a href="#l35.1533"></a><span id="l35.1533" class="difflineminus">-void</span>
<a href="#l35.1534"></a><span id="l35.1534" class="difflineminus">-nsMsgSendLater::NotifyListenersOnStartSending(uint32_t aTotalMessageCount)</span>
<a href="#l35.1535"></a><span id="l35.1535" class="difflineminus">-{</span>
<a href="#l35.1536"></a><span id="l35.1536" class="difflineplus">+void nsMsgSendLater::NotifyListenersOnStartSending(</span>
<a href="#l35.1537"></a><span id="l35.1537" class="difflineplus">+    uint32_t aTotalMessageCount) {</span>
<a href="#l35.1538"></a><span id="l35.1538">   NOTIFY_LISTENERS(OnStartSending, (aTotalMessageCount));</span>
<a href="#l35.1539"></a><span id="l35.1539"> }</span>
<a href="#l35.1540"></a><span id="l35.1540"> </span>
<a href="#l35.1541"></a><span id="l35.1541" class="difflineminus">-void</span>
<a href="#l35.1542"></a><span id="l35.1542" class="difflineminus">-nsMsgSendLater::NotifyListenersOnMessageStartSending(uint32_t aCurrentMessage,</span>
<a href="#l35.1543"></a><span id="l35.1543" class="difflineminus">-                                                     uint32_t aTotalMessage,</span>
<a href="#l35.1544"></a><span id="l35.1544" class="difflineminus">-                                                     nsIMsgIdentity *aIdentity)</span>
<a href="#l35.1545"></a><span id="l35.1545" class="difflineminus">-{</span>
<a href="#l35.1546"></a><span id="l35.1546" class="difflineminus">-  NOTIFY_LISTENERS(OnMessageStartSending, (aCurrentMessage, aTotalMessage,</span>
<a href="#l35.1547"></a><span id="l35.1547" class="difflineminus">-                                           mMessage, aIdentity));</span>
<a href="#l35.1548"></a><span id="l35.1548" class="difflineplus">+void nsMsgSendLater::NotifyListenersOnMessageStartSending(</span>
<a href="#l35.1549"></a><span id="l35.1549" class="difflineplus">+    uint32_t aCurrentMessage, uint32_t aTotalMessage,</span>
<a href="#l35.1550"></a><span id="l35.1550" class="difflineplus">+    nsIMsgIdentity *aIdentity) {</span>
<a href="#l35.1551"></a><span id="l35.1551" class="difflineplus">+  NOTIFY_LISTENERS(OnMessageStartSending,</span>
<a href="#l35.1552"></a><span id="l35.1552" class="difflineplus">+                   (aCurrentMessage, aTotalMessage, mMessage, aIdentity));</span>
<a href="#l35.1553"></a><span id="l35.1553"> }</span>
<a href="#l35.1554"></a><span id="l35.1554"> </span>
<a href="#l35.1555"></a><span id="l35.1555" class="difflineminus">-void</span>
<a href="#l35.1556"></a><span id="l35.1556" class="difflineminus">-nsMsgSendLater::NotifyListenersOnProgress(uint32_t aCurrentMessage,</span>
<a href="#l35.1557"></a><span id="l35.1557" class="difflineminus">-                                          uint32_t aTotalMessage,</span>
<a href="#l35.1558"></a><span id="l35.1558" class="difflineminus">-                                          uint32_t aSendPercent,</span>
<a href="#l35.1559"></a><span id="l35.1559" class="difflineminus">-                                          uint32_t aCopyPercent)</span>
<a href="#l35.1560"></a><span id="l35.1560" class="difflineminus">-{</span>
<a href="#l35.1561"></a><span id="l35.1561" class="difflineplus">+void nsMsgSendLater::NotifyListenersOnProgress(uint32_t aCurrentMessage,</span>
<a href="#l35.1562"></a><span id="l35.1562" class="difflineplus">+                                               uint32_t aTotalMessage,</span>
<a href="#l35.1563"></a><span id="l35.1563" class="difflineplus">+                                               uint32_t aSendPercent,</span>
<a href="#l35.1564"></a><span id="l35.1564" class="difflineplus">+                                               uint32_t aCopyPercent) {</span>
<a href="#l35.1565"></a><span id="l35.1565">   NOTIFY_LISTENERS(OnMessageSendProgress, (aCurrentMessage, aTotalMessage,</span>
<a href="#l35.1566"></a><span id="l35.1566">                                            aSendPercent, aCopyPercent));</span>
<a href="#l35.1567"></a><span id="l35.1567"> }</span>
<a href="#l35.1568"></a><span id="l35.1568"> </span>
<a href="#l35.1569"></a><span id="l35.1569" class="difflineminus">-void</span>
<a href="#l35.1570"></a><span id="l35.1570" class="difflineminus">-nsMsgSendLater::NotifyListenersOnMessageSendError(uint32_t aCurrentMessage,</span>
<a href="#l35.1571"></a><span id="l35.1571" class="difflineminus">-                                                  nsresult aStatus,</span>
<a href="#l35.1572"></a><span id="l35.1572" class="difflineminus">-                                                  const char16_t *aMsg)</span>
<a href="#l35.1573"></a><span id="l35.1573" class="difflineminus">-{</span>
<a href="#l35.1574"></a><span id="l35.1574" class="difflineminus">-  NOTIFY_LISTENERS(OnMessageSendError, (aCurrentMessage, mMessage,</span>
<a href="#l35.1575"></a><span id="l35.1575" class="difflineminus">-                                        aStatus, aMsg));</span>
<a href="#l35.1576"></a><span id="l35.1576" class="difflineplus">+void nsMsgSendLater::NotifyListenersOnMessageSendError(uint32_t aCurrentMessage,</span>
<a href="#l35.1577"></a><span id="l35.1577" class="difflineplus">+                                                       nsresult aStatus,</span>
<a href="#l35.1578"></a><span id="l35.1578" class="difflineplus">+                                                       const char16_t *aMsg) {</span>
<a href="#l35.1579"></a><span id="l35.1579" class="difflineplus">+  NOTIFY_LISTENERS(OnMessageSendError,</span>
<a href="#l35.1580"></a><span id="l35.1580" class="difflineplus">+                   (aCurrentMessage, mMessage, aStatus, aMsg));</span>
<a href="#l35.1581"></a><span id="l35.1581"> }</span>
<a href="#l35.1582"></a><span id="l35.1582"> </span>
<a href="#l35.1583"></a><span id="l35.1583"> /**</span>
<a href="#l35.1584"></a><span id="l35.1584">  * This function is called to end sending of messages, it resets the send later</span>
<a href="#l35.1585"></a><span id="l35.1585">  * system and notifies the relevant parties that we have finished.</span>
<a href="#l35.1586"></a><span id="l35.1586">  */</span>
<a href="#l35.1587"></a><span id="l35.1587" class="difflineminus">-void</span>
<a href="#l35.1588"></a><span id="l35.1588" class="difflineminus">-nsMsgSendLater::EndSendMessages(nsresult aStatus, const char16_t *aMsg,</span>
<a href="#l35.1589"></a><span id="l35.1589" class="difflineminus">-                                uint32_t aTotalTried, uint32_t aSuccessful)</span>
<a href="#l35.1590"></a><span id="l35.1590" class="difflineminus">-{</span>
<a href="#l35.1591"></a><span id="l35.1591" class="difflineplus">+void nsMsgSendLater::EndSendMessages(nsresult aStatus, const char16_t *aMsg,</span>
<a href="#l35.1592"></a><span id="l35.1592" class="difflineplus">+                                     uint32_t aTotalTried,</span>
<a href="#l35.1593"></a><span id="l35.1593" class="difflineplus">+                                     uint32_t aSuccessful) {</span>
<a href="#l35.1594"></a><span id="l35.1594">   // Catch-all, we may have had an issue sending, so we may not be calling</span>
<a href="#l35.1595"></a><span id="l35.1595">   // StartNextMailFileSend to fully finish the sending. Therefore set</span>
<a href="#l35.1596"></a><span id="l35.1596">   // mSendingMessages to false here so that we don't think we're still trying</span>
<a href="#l35.1597"></a><span id="l35.1597">   // to send messages</span>
<a href="#l35.1598"></a><span id="l35.1598">   mSendingMessages = false;</span>
<a href="#l35.1599"></a><span id="l35.1599"> </span>
<a href="#l35.1600"></a><span id="l35.1600">   // Clear out our array of messages.</span>
<a href="#l35.1601"></a><span id="l35.1601">   mMessagesToSend.Clear();</span>
<a href="#l35.1602"></a><span id="l35.1602"> </span>
<a href="#l35.1603"></a><span id="l35.1603">   nsresult rv;</span>
<a href="#l35.1604"></a><span id="l35.1604">   nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryReferent(mMessageFolder, &amp;rv);</span>
<a href="#l35.1605"></a><span id="l35.1605" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,);</span>
<a href="#l35.1606"></a><span id="l35.1606" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, );</span>
<a href="#l35.1607"></a><span id="l35.1607">   // We don't need to keep hold of the database now we've finished sending.</span>
<a href="#l35.1608"></a><span id="l35.1608">   (void)folder-&gt;SetMsgDatabase(nullptr);</span>
<a href="#l35.1609"></a><span id="l35.1609"> </span>
<a href="#l35.1610"></a><span id="l35.1610">   // or the enumerator, temp file or output stream</span>
<a href="#l35.1611"></a><span id="l35.1611">   mEnumerator = nullptr;</span>
<a href="#l35.1612"></a><span id="l35.1612">   mTempFile = nullptr;</span>
<a href="#l35.1613"></a><span id="l35.1613">   mOutFile = nullptr;</span>
<a href="#l35.1614"></a><span id="l35.1614"> </span>
<a href="#l35.1615"></a><span id="l35.1615">   NOTIFY_LISTENERS(OnStopSending, (aStatus, aMsg, aTotalTried, aSuccessful));</span>
<a href="#l35.1616"></a><span id="l35.1616"> </span>
<a href="#l35.1617"></a><span id="l35.1617">   // If we've got a shutdown listener, notify it that we've finished.</span>
<a href="#l35.1618"></a><span id="l35.1618" class="difflineminus">-  if (mShutdownListener)</span>
<a href="#l35.1619"></a><span id="l35.1619" class="difflineminus">-  {</span>
<a href="#l35.1620"></a><span id="l35.1620" class="difflineplus">+  if (mShutdownListener) {</span>
<a href="#l35.1621"></a><span id="l35.1621">     mShutdownListener-&gt;OnStopRunningUrl(nullptr, NS_OK);</span>
<a href="#l35.1622"></a><span id="l35.1622">     mShutdownListener = nullptr;</span>
<a href="#l35.1623"></a><span id="l35.1623">   }</span>
<a href="#l35.1624"></a><span id="l35.1624"> }</span>
<a href="#l35.1625"></a><span id="l35.1625"> </span>
<a href="#l35.1626"></a><span id="l35.1626"> /**</span>
<a href="#l35.1627"></a><span id="l35.1627">  * Called when the send part of sending a message is finished. This will set up</span>
<a href="#l35.1628"></a><span id="l35.1628">  * for the next step or &quot;end&quot; depending on the status.</span>
<a href="#l35.1629"></a><span id="l35.1629">  *</span>
<a href="#l35.1630"></a><span id="l35.1630">  * @param aStatus  The success or fail result of the send step.</span>
<a href="#l35.1631"></a><span id="l35.1631">  * @return         True if the copy process will continue, false otherwise.</span>
<a href="#l35.1632"></a><span id="l35.1632">  */</span>
<a href="#l35.1633"></a><span id="l35.1633" class="difflineminus">-bool</span>
<a href="#l35.1634"></a><span id="l35.1634" class="difflineminus">-nsMsgSendLater::OnSendStepFinished(nsresult aStatus)</span>
<a href="#l35.1635"></a><span id="l35.1635" class="difflineminus">-{</span>
<a href="#l35.1636"></a><span id="l35.1636" class="difflineminus">-  if (NS_SUCCEEDED(aStatus))</span>
<a href="#l35.1637"></a><span id="l35.1637" class="difflineminus">-  {</span>
<a href="#l35.1638"></a><span id="l35.1638" class="difflineplus">+bool nsMsgSendLater::OnSendStepFinished(nsresult aStatus) {</span>
<a href="#l35.1639"></a><span id="l35.1639" class="difflineplus">+  if (NS_SUCCEEDED(aStatus)) {</span>
<a href="#l35.1640"></a><span id="l35.1640">     SetOrigMsgDisposition();</span>
<a href="#l35.1641"></a><span id="l35.1641">     DeleteCurrentMessage();</span>
<a href="#l35.1642"></a><span id="l35.1642"> </span>
<a href="#l35.1643"></a><span id="l35.1643">     // Send finished, so that is now 100%, copy to proceed...</span>
<a href="#l35.1644"></a><span id="l35.1644">     NotifyListenersOnProgress(mTotalSendCount, mMessagesToSend.Count(), 100, 0);</span>
<a href="#l35.1645"></a><span id="l35.1645"> </span>
<a href="#l35.1646"></a><span id="l35.1646">     ++mTotalSentSuccessfully;</span>
<a href="#l35.1647"></a><span id="l35.1647">     return true;</span>
<a href="#l35.1648"></a><span id="l35.1648" class="difflineminus">-  }</span>
<a href="#l35.1649"></a><span id="l35.1649" class="difflineminus">-  else</span>
<a href="#l35.1650"></a><span id="l35.1650" class="difflineminus">-  {</span>
<a href="#l35.1651"></a><span id="l35.1651" class="difflineplus">+  } else {</span>
<a href="#l35.1652"></a><span id="l35.1652">     // XXX we don't currently get a message string from the send service.</span>
<a href="#l35.1653"></a><span id="l35.1653">     NotifyListenersOnMessageSendError(mTotalSendCount, aStatus, nullptr);</span>
<a href="#l35.1654"></a><span id="l35.1654">     nsresult rv = StartNextMailFileSend(aStatus);</span>
<a href="#l35.1655"></a><span id="l35.1655">     // if this is the last message we're sending, we should report</span>
<a href="#l35.1656"></a><span id="l35.1656">     // the status failure.</span>
<a href="#l35.1657"></a><span id="l35.1657">     if (NS_FAILED(rv))</span>
<a href="#l35.1658"></a><span id="l35.1658">       EndSendMessages(rv, nullptr, mTotalSendCount, mTotalSentSuccessfully);</span>
<a href="#l35.1659"></a><span id="l35.1659">   }</span>
<a href="#l35.1660"></a><span id="l35.1660" class="difflineat">@@ -1399,182 +1244,165 @@ nsMsgSendLater::OnSendStepFinished(nsres</span>
<a href="#l35.1661"></a><span id="l35.1661"> }</span>
<a href="#l35.1662"></a><span id="l35.1662"> </span>
<a href="#l35.1663"></a><span id="l35.1663"> /**</span>
<a href="#l35.1664"></a><span id="l35.1664">  * Called when the copy part of sending a message is finished. This will send</span>
<a href="#l35.1665"></a><span id="l35.1665">  * the next message or handle failure as appropriate.</span>
<a href="#l35.1666"></a><span id="l35.1666">  *</span>
<a href="#l35.1667"></a><span id="l35.1667">  * @param aStatus  The success or fail result of the copy step.</span>
<a href="#l35.1668"></a><span id="l35.1668">  */</span>
<a href="#l35.1669"></a><span id="l35.1669" class="difflineminus">-void</span>
<a href="#l35.1670"></a><span id="l35.1670" class="difflineminus">-nsMsgSendLater::OnCopyStepFinished(nsresult aStatus)</span>
<a href="#l35.1671"></a><span id="l35.1671" class="difflineminus">-{</span>
<a href="#l35.1672"></a><span id="l35.1672" class="difflineplus">+void nsMsgSendLater::OnCopyStepFinished(nsresult aStatus) {</span>
<a href="#l35.1673"></a><span id="l35.1673">   // Regardless of the success of the copy we will still keep trying</span>
<a href="#l35.1674"></a><span id="l35.1674">   // to send the rest...</span>
<a href="#l35.1675"></a><span id="l35.1675">   nsresult rv = StartNextMailFileSend(aStatus);</span>
<a href="#l35.1676"></a><span id="l35.1676">   if (NS_FAILED(rv))</span>
<a href="#l35.1677"></a><span id="l35.1677">     EndSendMessages(rv, nullptr, mTotalSendCount, mTotalSentSuccessfully);</span>
<a href="#l35.1678"></a><span id="l35.1678"> }</span>
<a href="#l35.1679"></a><span id="l35.1679"> </span>
<a href="#l35.1680"></a><span id="l35.1680"> // XXX todo</span>
<a href="#l35.1681"></a><span id="l35.1681"> // maybe this should just live in the account manager?</span>
<a href="#l35.1682"></a><span id="l35.1682" class="difflineminus">-nsresult</span>
<a href="#l35.1683"></a><span id="l35.1683" class="difflineminus">-nsMsgSendLater::GetIdentityFromKey(const char *aKey, nsIMsgIdentity  **aIdentity)</span>
<a href="#l35.1684"></a><span id="l35.1684" class="difflineminus">-{</span>
<a href="#l35.1685"></a><span id="l35.1685" class="difflineplus">+nsresult nsMsgSendLater::GetIdentityFromKey(const char *aKey,</span>
<a href="#l35.1686"></a><span id="l35.1686" class="difflineplus">+                                            nsIMsgIdentity **aIdentity) {</span>
<a href="#l35.1687"></a><span id="l35.1687">   NS_ENSURE_ARG_POINTER(aIdentity);</span>
<a href="#l35.1688"></a><span id="l35.1688"> </span>
<a href="#l35.1689"></a><span id="l35.1689">   nsresult rv;</span>
<a href="#l35.1690"></a><span id="l35.1690">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l35.1691"></a><span id="l35.1691" class="difflineminus">-    do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l35.1692"></a><span id="l35.1692" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l35.1693"></a><span id="l35.1693" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l35.1694"></a><span id="l35.1694" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l35.1695"></a><span id="l35.1695"> </span>
<a href="#l35.1696"></a><span id="l35.1696" class="difflineminus">-  if (aKey)</span>
<a href="#l35.1697"></a><span id="l35.1697" class="difflineminus">-  {</span>
<a href="#l35.1698"></a><span id="l35.1698" class="difflineplus">+  if (aKey) {</span>
<a href="#l35.1699"></a><span id="l35.1699">     nsCOMPtr&lt;nsIArray&gt; identities;</span>
<a href="#l35.1700"></a><span id="l35.1700" class="difflineminus">-    if (NS_SUCCEEDED(accountManager-&gt;GetAllIdentities(getter_AddRefs(identities))))</span>
<a href="#l35.1701"></a><span id="l35.1701" class="difflineminus">-    {</span>
<a href="#l35.1702"></a><span id="l35.1702" class="difflineplus">+    if (NS_SUCCEEDED(</span>
<a href="#l35.1703"></a><span id="l35.1703" class="difflineplus">+            accountManager-&gt;GetAllIdentities(getter_AddRefs(identities)))) {</span>
<a href="#l35.1704"></a><span id="l35.1704">       nsCOMPtr&lt;nsIMsgIdentity&gt; lookupIdentity;</span>
<a href="#l35.1705"></a><span id="l35.1705">       uint32_t count = 0;</span>
<a href="#l35.1706"></a><span id="l35.1706"> </span>
<a href="#l35.1707"></a><span id="l35.1707">       identities-&gt;GetLength(&amp;count);</span>
<a href="#l35.1708"></a><span id="l35.1708" class="difflineminus">-      for (uint32_t i = 0; i &lt; count; i++)</span>
<a href="#l35.1709"></a><span id="l35.1709" class="difflineminus">-      {</span>
<a href="#l35.1710"></a><span id="l35.1710" class="difflineplus">+      for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l35.1711"></a><span id="l35.1711">         lookupIdentity = do_QueryElementAt(identities, i, &amp;rv);</span>
<a href="#l35.1712"></a><span id="l35.1712" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l35.1713"></a><span id="l35.1713" class="difflineminus">-          continue;</span>
<a href="#l35.1714"></a><span id="l35.1714" class="difflineplus">+        if (NS_FAILED(rv)) continue;</span>
<a href="#l35.1715"></a><span id="l35.1715"> </span>
<a href="#l35.1716"></a><span id="l35.1716">         nsCString key;</span>
<a href="#l35.1717"></a><span id="l35.1717">         lookupIdentity-&gt;GetKey(key);</span>
<a href="#l35.1718"></a><span id="l35.1718" class="difflineminus">-        if (key.Equals(aKey))</span>
<a href="#l35.1719"></a><span id="l35.1719" class="difflineminus">-        {</span>
<a href="#l35.1720"></a><span id="l35.1720" class="difflineplus">+        if (key.Equals(aKey)) {</span>
<a href="#l35.1721"></a><span id="l35.1721">           lookupIdentity.forget(aIdentity);</span>
<a href="#l35.1722"></a><span id="l35.1722">           return NS_OK;</span>
<a href="#l35.1723"></a><span id="l35.1723">         }</span>
<a href="#l35.1724"></a><span id="l35.1724">       }</span>
<a href="#l35.1725"></a><span id="l35.1725">     }</span>
<a href="#l35.1726"></a><span id="l35.1726">   }</span>
<a href="#l35.1727"></a><span id="l35.1727"> </span>
<a href="#l35.1728"></a><span id="l35.1728">   // If no aKey, or we failed to find the identity from the key</span>
<a href="#l35.1729"></a><span id="l35.1729">   // use the identity from the default account.</span>
<a href="#l35.1730"></a><span id="l35.1730">   nsCOMPtr&lt;nsIMsgAccount&gt; defaultAccount;</span>
<a href="#l35.1731"></a><span id="l35.1731">   rv = accountManager-&gt;GetDefaultAccount(getter_AddRefs(defaultAccount));</span>
<a href="#l35.1732"></a><span id="l35.1732" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l35.1733"></a><span id="l35.1733" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l35.1734"></a><span id="l35.1734"> </span>
<a href="#l35.1735"></a><span id="l35.1735">   if (defaultAccount)</span>
<a href="#l35.1736"></a><span id="l35.1736">     rv = defaultAccount-&gt;GetDefaultIdentity(aIdentity);</span>
<a href="#l35.1737"></a><span id="l35.1737">   else</span>
<a href="#l35.1738"></a><span id="l35.1738">     *aIdentity = nullptr;</span>
<a href="#l35.1739"></a><span id="l35.1739"> </span>
<a href="#l35.1740"></a><span id="l35.1740">   return rv;</span>
<a href="#l35.1741"></a><span id="l35.1741"> }</span>
<a href="#l35.1742"></a><span id="l35.1742"> </span>
<a href="#l35.1743"></a><span id="l35.1743"> NS_IMETHODIMP</span>
<a href="#l35.1744"></a><span id="l35.1744" class="difflineminus">-nsMsgSendLater::OnItemAdded(nsIMsgFolder *aParentItem, nsISupports *aItem)</span>
<a href="#l35.1745"></a><span id="l35.1745" class="difflineminus">-{</span>
<a href="#l35.1746"></a><span id="l35.1746" class="difflineplus">+nsMsgSendLater::OnItemAdded(nsIMsgFolder *aParentItem, nsISupports *aItem) {</span>
<a href="#l35.1747"></a><span id="l35.1747">   // No need to trigger if timer is already set</span>
<a href="#l35.1748"></a><span id="l35.1748" class="difflineminus">-  if (mTimerSet)</span>
<a href="#l35.1749"></a><span id="l35.1749" class="difflineminus">-    return NS_OK;</span>
<a href="#l35.1750"></a><span id="l35.1750" class="difflineplus">+  if (mTimerSet) return NS_OK;</span>
<a href="#l35.1751"></a><span id="l35.1751"> </span>
<a href="#l35.1752"></a><span id="l35.1752">   // XXX only trigger for non-queued headers</span>
<a href="#l35.1753"></a><span id="l35.1753"> </span>
<a href="#l35.1754"></a><span id="l35.1754">   // Items from this function return NS_OK because the callee won't care about</span>
<a href="#l35.1755"></a><span id="l35.1755">   // the result anyway.</span>
<a href="#l35.1756"></a><span id="l35.1756">   nsresult rv;</span>
<a href="#l35.1757"></a><span id="l35.1757" class="difflineminus">-  if (!mTimer)</span>
<a href="#l35.1758"></a><span id="l35.1758" class="difflineminus">-  {</span>
<a href="#l35.1759"></a><span id="l35.1759" class="difflineplus">+  if (!mTimer) {</span>
<a href="#l35.1760"></a><span id="l35.1760">     mTimer = do_CreateInstance(&quot;@mozilla.org/timer;1&quot;, &amp;rv);</span>
<a href="#l35.1761"></a><span id="l35.1761">     NS_ENSURE_SUCCESS(rv, NS_OK);</span>
<a href="#l35.1762"></a><span id="l35.1762">   }</span>
<a href="#l35.1763"></a><span id="l35.1763"> </span>
<a href="#l35.1764"></a><span id="l35.1764" class="difflineminus">-  rv = mTimer-&gt;Init(static_cast&lt;nsIObserver*&gt;(this), kInitialMessageSendTime,</span>
<a href="#l35.1765"></a><span id="l35.1765" class="difflineplus">+  rv = mTimer-&gt;Init(static_cast&lt;nsIObserver *&gt;(this), kInitialMessageSendTime,</span>
<a href="#l35.1766"></a><span id="l35.1766">                     nsITimer::TYPE_ONE_SHOT);</span>
<a href="#l35.1767"></a><span id="l35.1767">   NS_ENSURE_SUCCESS(rv, NS_OK);</span>
<a href="#l35.1768"></a><span id="l35.1768"> </span>
<a href="#l35.1769"></a><span id="l35.1769">   mTimerSet = true;</span>
<a href="#l35.1770"></a><span id="l35.1770"> </span>
<a href="#l35.1771"></a><span id="l35.1771">   return NS_OK;</span>
<a href="#l35.1772"></a><span id="l35.1772"> }</span>
<a href="#l35.1773"></a><span id="l35.1773"> </span>
<a href="#l35.1774"></a><span id="l35.1774"> NS_IMETHODIMP</span>
<a href="#l35.1775"></a><span id="l35.1775" class="difflineminus">-nsMsgSendLater::OnItemRemoved(nsIMsgFolder *aParentItem, nsISupports *aItem)</span>
<a href="#l35.1776"></a><span id="l35.1776" class="difflineminus">-{</span>
<a href="#l35.1777"></a><span id="l35.1777" class="difflineplus">+nsMsgSendLater::OnItemRemoved(nsIMsgFolder *aParentItem, nsISupports *aItem) {</span>
<a href="#l35.1778"></a><span id="l35.1778">   return NS_OK;</span>
<a href="#l35.1779"></a><span id="l35.1779"> }</span>
<a href="#l35.1780"></a><span id="l35.1780"> </span>
<a href="#l35.1781"></a><span id="l35.1781"> NS_IMETHODIMP</span>
<a href="#l35.1782"></a><span id="l35.1782" class="difflineminus">-nsMsgSendLater::OnItemPropertyChanged(nsIMsgFolder *aItem, const nsACString &amp;aProperty,</span>
<a href="#l35.1783"></a><span id="l35.1783" class="difflineminus">-                                      const char* aOldValue,</span>
<a href="#l35.1784"></a><span id="l35.1784" class="difflineminus">-                                      const char* aNewValue)</span>
<a href="#l35.1785"></a><span id="l35.1785" class="difflineminus">-{</span>
<a href="#l35.1786"></a><span id="l35.1786" class="difflineplus">+nsMsgSendLater::OnItemPropertyChanged(nsIMsgFolder *aItem,</span>
<a href="#l35.1787"></a><span id="l35.1787" class="difflineplus">+                                      const nsACString &amp;aProperty,</span>
<a href="#l35.1788"></a><span id="l35.1788" class="difflineplus">+                                      const char *aOldValue,</span>
<a href="#l35.1789"></a><span id="l35.1789" class="difflineplus">+                                      const char *aNewValue) {</span>
<a href="#l35.1790"></a><span id="l35.1790">   return NS_OK;</span>
<a href="#l35.1791"></a><span id="l35.1791"> }</span>
<a href="#l35.1792"></a><span id="l35.1792"> </span>
<a href="#l35.1793"></a><span id="l35.1793"> NS_IMETHODIMP</span>
<a href="#l35.1794"></a><span id="l35.1794" class="difflineminus">-nsMsgSendLater::OnItemIntPropertyChanged(nsIMsgFolder *aItem, const nsACString &amp;aProperty,</span>
<a href="#l35.1795"></a><span id="l35.1795" class="difflineminus">-                                         int64_t aOldValue, int64_t aNewValue)</span>
<a href="#l35.1796"></a><span id="l35.1796" class="difflineminus">-{</span>
<a href="#l35.1797"></a><span id="l35.1797" class="difflineplus">+nsMsgSendLater::OnItemIntPropertyChanged(nsIMsgFolder *aItem,</span>
<a href="#l35.1798"></a><span id="l35.1798" class="difflineplus">+                                         const nsACString &amp;aProperty,</span>
<a href="#l35.1799"></a><span id="l35.1799" class="difflineplus">+                                         int64_t aOldValue, int64_t aNewValue) {</span>
<a href="#l35.1800"></a><span id="l35.1800">   return NS_OK;</span>
<a href="#l35.1801"></a><span id="l35.1801"> }</span>
<a href="#l35.1802"></a><span id="l35.1802"> </span>
<a href="#l35.1803"></a><span id="l35.1803"> NS_IMETHODIMP</span>
<a href="#l35.1804"></a><span id="l35.1804" class="difflineminus">-nsMsgSendLater::OnItemBoolPropertyChanged(nsIMsgFolder *aItem, const nsACString &amp;aProperty,</span>
<a href="#l35.1805"></a><span id="l35.1805" class="difflineminus">-                                          bool aOldValue, bool aNewValue)</span>
<a href="#l35.1806"></a><span id="l35.1806" class="difflineminus">-{</span>
<a href="#l35.1807"></a><span id="l35.1807" class="difflineplus">+nsMsgSendLater::OnItemBoolPropertyChanged(nsIMsgFolder *aItem,</span>
<a href="#l35.1808"></a><span id="l35.1808" class="difflineplus">+                                          const nsACString &amp;aProperty,</span>
<a href="#l35.1809"></a><span id="l35.1809" class="difflineplus">+                                          bool aOldValue, bool aNewValue) {</span>
<a href="#l35.1810"></a><span id="l35.1810">   return NS_OK;</span>
<a href="#l35.1811"></a><span id="l35.1811"> }</span>
<a href="#l35.1812"></a><span id="l35.1812"> </span>
<a href="#l35.1813"></a><span id="l35.1813"> NS_IMETHODIMP</span>
<a href="#l35.1814"></a><span id="l35.1814"> nsMsgSendLater::OnItemUnicharPropertyChanged(nsIMsgFolder *aItem,</span>
<a href="#l35.1815"></a><span id="l35.1815">                                              const nsACString &amp;aProperty,</span>
<a href="#l35.1816"></a><span id="l35.1816" class="difflineminus">-                                             const char16_t* aOldValue,</span>
<a href="#l35.1817"></a><span id="l35.1817" class="difflineminus">-                                             const char16_t* aNewValue)</span>
<a href="#l35.1818"></a><span id="l35.1818" class="difflineminus">-{</span>
<a href="#l35.1819"></a><span id="l35.1819" class="difflineplus">+                                             const char16_t *aOldValue,</span>
<a href="#l35.1820"></a><span id="l35.1820" class="difflineplus">+                                             const char16_t *aNewValue) {</span>
<a href="#l35.1821"></a><span id="l35.1821">   return NS_OK;</span>
<a href="#l35.1822"></a><span id="l35.1822"> }</span>
<a href="#l35.1823"></a><span id="l35.1823"> </span>
<a href="#l35.1824"></a><span id="l35.1824"> NS_IMETHODIMP</span>
<a href="#l35.1825"></a><span id="l35.1825" class="difflineminus">-nsMsgSendLater::OnItemPropertyFlagChanged(nsIMsgDBHdr *aItem, const nsACString &amp;aProperty,</span>
<a href="#l35.1826"></a><span id="l35.1826" class="difflineminus">-                                          uint32_t aOldValue, uint32_t aNewValue)</span>
<a href="#l35.1827"></a><span id="l35.1827" class="difflineminus">-{</span>
<a href="#l35.1828"></a><span id="l35.1828" class="difflineplus">+nsMsgSendLater::OnItemPropertyFlagChanged(nsIMsgDBHdr *aItem,</span>
<a href="#l35.1829"></a><span id="l35.1829" class="difflineplus">+                                          const nsACString &amp;aProperty,</span>
<a href="#l35.1830"></a><span id="l35.1830" class="difflineplus">+                                          uint32_t aOldValue,</span>
<a href="#l35.1831"></a><span id="l35.1831" class="difflineplus">+                                          uint32_t aNewValue) {</span>
<a href="#l35.1832"></a><span id="l35.1832">   return NS_OK;</span>
<a href="#l35.1833"></a><span id="l35.1833"> }</span>
<a href="#l35.1834"></a><span id="l35.1834"> </span>
<a href="#l35.1835"></a><span id="l35.1835"> NS_IMETHODIMP</span>
<a href="#l35.1836"></a><span id="l35.1836" class="difflineminus">-nsMsgSendLater::OnItemEvent(nsIMsgFolder* aItem, const nsACString &amp;aEvent)</span>
<a href="#l35.1837"></a><span id="l35.1837" class="difflineminus">-{</span>
<a href="#l35.1838"></a><span id="l35.1838" class="difflineplus">+nsMsgSendLater::OnItemEvent(nsIMsgFolder *aItem, const nsACString &amp;aEvent) {</span>
<a href="#l35.1839"></a><span id="l35.1839">   return NS_OK;</span>
<a href="#l35.1840"></a><span id="l35.1840"> }</span>
<a href="#l35.1841"></a><span id="l35.1841"> </span>
<a href="#l35.1842"></a><span id="l35.1842"> NS_IMETHODIMP</span>
<a href="#l35.1843"></a><span id="l35.1843" class="difflineminus">-nsMsgSendLater::GetNeedsToRunTask(bool *aResult)</span>
<a href="#l35.1844"></a><span id="l35.1844" class="difflineminus">-{</span>
<a href="#l35.1845"></a><span id="l35.1845" class="difflineplus">+nsMsgSendLater::GetNeedsToRunTask(bool *aResult) {</span>
<a href="#l35.1846"></a><span id="l35.1846">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l35.1847"></a><span id="l35.1847">   *aResult = mSendingMessages;</span>
<a href="#l35.1848"></a><span id="l35.1848">   return NS_OK;</span>
<a href="#l35.1849"></a><span id="l35.1849"> }</span>
<a href="#l35.1850"></a><span id="l35.1850"> </span>
<a href="#l35.1851"></a><span id="l35.1851"> NS_IMETHODIMP</span>
<a href="#l35.1852"></a><span id="l35.1852"> nsMsgSendLater::DoShutdownTask(nsIUrlListener *aListener, nsIMsgWindow *aWindow,</span>
<a href="#l35.1853"></a><span id="l35.1853" class="difflineminus">-                               bool *aResult)</span>
<a href="#l35.1854"></a><span id="l35.1854" class="difflineminus">-{</span>
<a href="#l35.1855"></a><span id="l35.1855" class="difflineminus">-  if (mTimer)</span>
<a href="#l35.1856"></a><span id="l35.1856" class="difflineminus">-    mTimer-&gt;Cancel();</span>
<a href="#l35.1857"></a><span id="l35.1857" class="difflineplus">+                               bool *aResult) {</span>
<a href="#l35.1858"></a><span id="l35.1858" class="difflineplus">+  if (mTimer) mTimer-&gt;Cancel();</span>
<a href="#l35.1859"></a><span id="l35.1859">   // If we're already sending messages, nothing to do, but save the shutdown</span>
<a href="#l35.1860"></a><span id="l35.1860">   // listener until we've finished.</span>
<a href="#l35.1861"></a><span id="l35.1861" class="difflineminus">-  if (mSendingMessages)</span>
<a href="#l35.1862"></a><span id="l35.1862" class="difflineminus">-  {</span>
<a href="#l35.1863"></a><span id="l35.1863" class="difflineplus">+  if (mSendingMessages) {</span>
<a href="#l35.1864"></a><span id="l35.1864">     mShutdownListener = aListener;</span>
<a href="#l35.1865"></a><span id="l35.1865">     return NS_OK;</span>
<a href="#l35.1866"></a><span id="l35.1866">   }</span>
<a href="#l35.1867"></a><span id="l35.1867">   // Else we have pending messages, we need to throw up a dialog to find out</span>
<a href="#l35.1868"></a><span id="l35.1868">   // if to send them or not.</span>
<a href="#l35.1869"></a><span id="l35.1869"> </span>
<a href="#l35.1870"></a><span id="l35.1870">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l35.1871"></a><span id="l35.1871"> }</span>
<a href="#l35.1872"></a><span id="l35.1872"> </span>
<a href="#l35.1873"></a><span id="l35.1873"> NS_IMETHODIMP</span>
<a href="#l35.1874"></a><span id="l35.1874" class="difflineminus">-nsMsgSendLater::GetCurrentTaskName(nsAString &amp;aResult)</span>
<a href="#l35.1875"></a><span id="l35.1875" class="difflineminus">-{</span>
<a href="#l35.1876"></a><span id="l35.1876" class="difflineplus">+nsMsgSendLater::GetCurrentTaskName(nsAString &amp;aResult) {</span>
<a href="#l35.1877"></a><span id="l35.1877">   // XXX Bug 440794 will localize this, left as non-localized whilst we decide</span>
<a href="#l35.1878"></a><span id="l35.1878">   // on the actual strings and try out the UI.</span>
<a href="#l35.1879"></a><span id="l35.1879">   aResult = NS_LITERAL_STRING(&quot;Sending Messages&quot;);</span>
<a href="#l35.1880"></a><span id="l35.1880">   return NS_OK;</span>
<a href="#l35.1881"></a><span id="l35.1881"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSendLater.h</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSendLater.h</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -15,132 +15,129 @@</span>
<a href="#l36.4"></a><span id="l36.4"> #include &quot;nsTObserverArray.h&quot;</span>
<a href="#l36.5"></a><span id="l36.5"> #include &quot;nsIObserver.h&quot;</span>
<a href="#l36.6"></a><span id="l36.6"> #include &quot;nsITimer.h&quot;</span>
<a href="#l36.7"></a><span id="l36.7"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l36.8"></a><span id="l36.8"> #include &quot;nsIMsgShutdown.h&quot;</span>
<a href="#l36.9"></a><span id="l36.9"> #include &quot;nsIWeakReferenceUtils.h&quot;</span>
<a href="#l36.10"></a><span id="l36.10"> </span>
<a href="#l36.11"></a><span id="l36.11"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineminus">-// This is the listener class for the send operation. We have to create this class</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineminus">-// to listen for message send completion and eventually notify the caller</span>
<a href="#l36.14"></a><span id="l36.14" class="difflineplus">+// This is the listener class for the send operation. We have to create this</span>
<a href="#l36.15"></a><span id="l36.15" class="difflineplus">+// class to listen for message send completion and eventually notify the caller</span>
<a href="#l36.16"></a><span id="l36.16"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l36.17"></a><span id="l36.17"> class nsMsgSendLater;</span>
<a href="#l36.18"></a><span id="l36.18"> </span>
<a href="#l36.19"></a><span id="l36.19"> class SendOperationListener : public nsIMsgSendListener,</span>
<a href="#l36.20"></a><span id="l36.20" class="difflineminus">-                              public nsIMsgCopyServiceListener</span>
<a href="#l36.21"></a><span id="l36.21" class="difflineminus">-{</span>
<a href="#l36.22"></a><span id="l36.22" class="difflineminus">-public:</span>
<a href="#l36.23"></a><span id="l36.23" class="difflineplus">+                              public nsIMsgCopyServiceListener {</span>
<a href="#l36.24"></a><span id="l36.24" class="difflineplus">+ public:</span>
<a href="#l36.25"></a><span id="l36.25">   explicit SendOperationListener(nsMsgSendLater *aSendLater);</span>
<a href="#l36.26"></a><span id="l36.26"> </span>
<a href="#l36.27"></a><span id="l36.27">   NS_DECL_ISUPPORTS</span>
<a href="#l36.28"></a><span id="l36.28">   NS_DECL_NSIMSGSENDLISTENER</span>
<a href="#l36.29"></a><span id="l36.29">   NS_DECL_NSIMSGCOPYSERVICELISTENER</span>
<a href="#l36.30"></a><span id="l36.30"> </span>
<a href="#l36.31"></a><span id="l36.31" class="difflineminus">-private:</span>
<a href="#l36.32"></a><span id="l36.32" class="difflineplus">+ private:</span>
<a href="#l36.33"></a><span id="l36.33">   virtual ~SendOperationListener();</span>
<a href="#l36.34"></a><span id="l36.34">   RefPtr&lt;nsMsgSendLater&gt; mSendLater;</span>
<a href="#l36.35"></a><span id="l36.35"> };</span>
<a href="#l36.36"></a><span id="l36.36"> </span>
<a href="#l36.37"></a><span id="l36.37" class="difflineminus">-class nsMsgSendLater: public nsIMsgSendLater,</span>
<a href="#l36.38"></a><span id="l36.38" class="difflineminus">-                      public nsIFolderListener,</span>
<a href="#l36.39"></a><span id="l36.39" class="difflineminus">-                      public nsIObserver,</span>
<a href="#l36.40"></a><span id="l36.40" class="difflineminus">-                      public nsIUrlListener,</span>
<a href="#l36.41"></a><span id="l36.41" class="difflineminus">-                      public nsIMsgShutdownTask</span>
<a href="#l36.42"></a><span id="l36.42" class="difflineplus">+class nsMsgSendLater : public nsIMsgSendLater,</span>
<a href="#l36.43"></a><span id="l36.43" class="difflineplus">+                       public nsIFolderListener,</span>
<a href="#l36.44"></a><span id="l36.44" class="difflineplus">+                       public nsIObserver,</span>
<a href="#l36.45"></a><span id="l36.45" class="difflineplus">+                       public nsIUrlListener,</span>
<a href="#l36.46"></a><span id="l36.46" class="difflineplus">+                       public nsIMsgShutdownTask</span>
<a href="#l36.47"></a><span id="l36.47"> </span>
<a href="#l36.48"></a><span id="l36.48"> {</span>
<a href="#l36.49"></a><span id="l36.49" class="difflineminus">-public:</span>
<a href="#l36.50"></a><span id="l36.50" class="difflineplus">+ public:</span>
<a href="#l36.51"></a><span id="l36.51">   nsMsgSendLater();</span>
<a href="#l36.52"></a><span id="l36.52">   nsresult Init();</span>
<a href="#l36.53"></a><span id="l36.53"> </span>
<a href="#l36.54"></a><span id="l36.54">   NS_DECL_ISUPPORTS</span>
<a href="#l36.55"></a><span id="l36.55">   NS_DECL_NSIMSGSENDLATER</span>
<a href="#l36.56"></a><span id="l36.56">   NS_DECL_NSIFOLDERLISTENER</span>
<a href="#l36.57"></a><span id="l36.57">   NS_DECL_NSISTREAMLISTENER</span>
<a href="#l36.58"></a><span id="l36.58">   NS_DECL_NSIREQUESTOBSERVER</span>
<a href="#l36.59"></a><span id="l36.59">   NS_DECL_NSIOBSERVER</span>
<a href="#l36.60"></a><span id="l36.60">   NS_DECL_NSIURLLISTENER</span>
<a href="#l36.61"></a><span id="l36.61">   NS_DECL_NSIMSGSHUTDOWNTASK</span>
<a href="#l36.62"></a><span id="l36.62"> </span>
<a href="#l36.63"></a><span id="l36.63">   // Methods needed for implementing interface...</span>
<a href="#l36.64"></a><span id="l36.64" class="difflineminus">-  nsresult                  StartNextMailFileSend(nsresult prevStatus);</span>
<a href="#l36.65"></a><span id="l36.65" class="difflineminus">-  nsresult                  CompleteMailFileSend();</span>
<a href="#l36.66"></a><span id="l36.66" class="difflineplus">+  nsresult StartNextMailFileSend(nsresult prevStatus);</span>
<a href="#l36.67"></a><span id="l36.67" class="difflineplus">+  nsresult CompleteMailFileSend();</span>
<a href="#l36.68"></a><span id="l36.68"> </span>
<a href="#l36.69"></a><span id="l36.69" class="difflineminus">-  nsresult                  DeleteCurrentMessage();</span>
<a href="#l36.70"></a><span id="l36.70" class="difflineminus">-  nsresult                  SetOrigMsgDisposition();</span>
<a href="#l36.71"></a><span id="l36.71" class="difflineplus">+  nsresult DeleteCurrentMessage();</span>
<a href="#l36.72"></a><span id="l36.72" class="difflineplus">+  nsresult SetOrigMsgDisposition();</span>
<a href="#l36.73"></a><span id="l36.73">   // Necessary for creating a valid list of recipients</span>
<a href="#l36.74"></a><span id="l36.74" class="difflineminus">-  nsresult                  BuildHeaders();</span>
<a href="#l36.75"></a><span id="l36.75" class="difflineminus">-  nsresult                  DeliverQueuedLine(char *line, int32_t length);</span>
<a href="#l36.76"></a><span id="l36.76" class="difflineminus">-  nsresult                  RebufferLeftovers(char *startBuf,  uint32_t aLen);</span>
<a href="#l36.77"></a><span id="l36.77" class="difflineminus">-  nsresult                  BuildNewBuffer(const char* aBuf, uint32_t aCount, uint32_t *totalBufSize);</span>
<a href="#l36.78"></a><span id="l36.78" class="difflineplus">+  nsresult BuildHeaders();</span>
<a href="#l36.79"></a><span id="l36.79" class="difflineplus">+  nsresult DeliverQueuedLine(char *line, int32_t length);</span>
<a href="#l36.80"></a><span id="l36.80" class="difflineplus">+  nsresult RebufferLeftovers(char *startBuf, uint32_t aLen);</span>
<a href="#l36.81"></a><span id="l36.81" class="difflineplus">+  nsresult BuildNewBuffer(const char *aBuf, uint32_t aCount,</span>
<a href="#l36.82"></a><span id="l36.82" class="difflineplus">+                          uint32_t *totalBufSize);</span>
<a href="#l36.83"></a><span id="l36.83"> </span>
<a href="#l36.84"></a><span id="l36.84">   // methods for listener array processing...</span>
<a href="#l36.85"></a><span id="l36.85">   void NotifyListenersOnStartSending(uint32_t aTotalMessageCount);</span>
<a href="#l36.86"></a><span id="l36.86">   void NotifyListenersOnMessageStartSending(uint32_t aCurrentMessage,</span>
<a href="#l36.87"></a><span id="l36.87">                                             uint32_t aTotalMessage,</span>
<a href="#l36.88"></a><span id="l36.88">                                             nsIMsgIdentity *aIdentity);</span>
<a href="#l36.89"></a><span id="l36.89">   void NotifyListenersOnProgress(uint32_t aCurrentMessage,</span>
<a href="#l36.90"></a><span id="l36.90" class="difflineminus">-                                 uint32_t aTotalMessage,</span>
<a href="#l36.91"></a><span id="l36.91" class="difflineminus">-                                 uint32_t aSendPercent,</span>
<a href="#l36.92"></a><span id="l36.92" class="difflineplus">+                                 uint32_t aTotalMessage, uint32_t aSendPercent,</span>
<a href="#l36.93"></a><span id="l36.93">                                  uint32_t aCopyPercent);</span>
<a href="#l36.94"></a><span id="l36.94">   void NotifyListenersOnMessageSendError(uint32_t aCurrentMessage,</span>
<a href="#l36.95"></a><span id="l36.95">                                          nsresult aStatus,</span>
<a href="#l36.96"></a><span id="l36.96">                                          const char16_t *aMsg);</span>
<a href="#l36.97"></a><span id="l36.97">   void EndSendMessages(nsresult aStatus, const char16_t *aMsg,</span>
<a href="#l36.98"></a><span id="l36.98">                        uint32_t aTotalTried, uint32_t aSuccessful);</span>
<a href="#l36.99"></a><span id="l36.99"> </span>
<a href="#l36.100"></a><span id="l36.100">   bool OnSendStepFinished(nsresult aStatus);</span>
<a href="#l36.101"></a><span id="l36.101">   void OnCopyStepFinished(nsresult aStatus);</span>
<a href="#l36.102"></a><span id="l36.102"> </span>
<a href="#l36.103"></a><span id="l36.103">   // counters and things for enumeration</span>
<a href="#l36.104"></a><span id="l36.104" class="difflineminus">-  uint32_t                  mTotalSentSuccessfully;</span>
<a href="#l36.105"></a><span id="l36.105" class="difflineminus">-  uint32_t                  mTotalSendCount;</span>
<a href="#l36.106"></a><span id="l36.106" class="difflineplus">+  uint32_t mTotalSentSuccessfully;</span>
<a href="#l36.107"></a><span id="l36.107" class="difflineplus">+  uint32_t mTotalSendCount;</span>
<a href="#l36.108"></a><span id="l36.108">   nsCOMArray&lt;nsIMsgDBHdr&gt; mMessagesToSend;</span>
<a href="#l36.109"></a><span id="l36.109">   nsCOMPtr&lt;nsISimpleEnumerator&gt; mEnumerator;</span>
<a href="#l36.110"></a><span id="l36.110">   nsWeakPtr mMessageFolder;</span>
<a href="#l36.111"></a><span id="l36.111">   nsCOMPtr&lt;nsIMsgStatusFeedback&gt; mFeedback;</span>
<a href="#l36.112"></a><span id="l36.112"> </span>
<a href="#l36.113"></a><span id="l36.113">   // Private Information</span>
<a href="#l36.114"></a><span id="l36.114" class="difflineminus">-private:</span>
<a href="#l36.115"></a><span id="l36.115" class="difflineplus">+ private:</span>
<a href="#l36.116"></a><span id="l36.116">   virtual ~nsMsgSendLater();</span>
<a href="#l36.117"></a><span id="l36.117">   nsresult GetIdentityFromKey(const char *aKey, nsIMsgIdentity **aIdentity);</span>
<a href="#l36.118"></a><span id="l36.118">   nsresult ReparseDBIfNeeded(nsIUrlListener *aListener);</span>
<a href="#l36.119"></a><span id="l36.119" class="difflineminus">-  nsresult InternalSendMessages(bool aUserInitiated,</span>
<a href="#l36.120"></a><span id="l36.120" class="difflineminus">-                                nsIMsgIdentity *aIdentity);</span>
<a href="#l36.121"></a><span id="l36.121" class="difflineplus">+  nsresult InternalSendMessages(bool aUserInitiated, nsIMsgIdentity *aIdentity);</span>
<a href="#l36.122"></a><span id="l36.122"> </span>
<a href="#l36.123"></a><span id="l36.123">   nsTObserverArray&lt;nsCOMPtr&lt;nsIMsgSendLaterListener&gt; &gt; mListenerArray;</span>
<a href="#l36.124"></a><span id="l36.124">   nsCOMPtr&lt;nsIMsgDBHdr&gt; mMessage;</span>
<a href="#l36.125"></a><span id="l36.125">   nsCOMPtr&lt;nsITimer&gt; mTimer;</span>
<a href="#l36.126"></a><span id="l36.126">   bool mTimerSet;</span>
<a href="#l36.127"></a><span id="l36.127">   nsCOMPtr&lt;nsIUrlListener&gt; mShutdownListener;</span>
<a href="#l36.128"></a><span id="l36.128"> </span>
<a href="#l36.129"></a><span id="l36.129">   //</span>
<a href="#l36.130"></a><span id="l36.130">   // File output stuff...</span>
<a href="#l36.131"></a><span id="l36.131">   //</span>
<a href="#l36.132"></a><span id="l36.132" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt;         mTempFile;</span>
<a href="#l36.133"></a><span id="l36.133" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; mTempFile;</span>
<a href="#l36.134"></a><span id="l36.134">   nsCOMPtr&lt;nsIOutputStream&gt; mOutFile;</span>
<a href="#l36.135"></a><span id="l36.135"> </span>
<a href="#l36.136"></a><span id="l36.136">   // For building headers and stream parsing...</span>
<a href="#l36.137"></a><span id="l36.137" class="difflineminus">-  char                      *m_to;</span>
<a href="#l36.138"></a><span id="l36.138" class="difflineminus">-  char                      *m_bcc;</span>
<a href="#l36.139"></a><span id="l36.139" class="difflineminus">-  char                      *m_fcc;</span>
<a href="#l36.140"></a><span id="l36.140" class="difflineminus">-  char                      *m_newsgroups;</span>
<a href="#l36.141"></a><span id="l36.141" class="difflineminus">-  char                      *m_newshost;</span>
<a href="#l36.142"></a><span id="l36.142" class="difflineminus">-  char                      *m_headers;</span>
<a href="#l36.143"></a><span id="l36.143" class="difflineminus">-  int32_t                   m_flags;</span>
<a href="#l36.144"></a><span id="l36.144" class="difflineminus">-  int32_t                   m_headersFP;</span>
<a href="#l36.145"></a><span id="l36.145" class="difflineminus">-  bool                      m_inhead;</span>
<a href="#l36.146"></a><span id="l36.146" class="difflineminus">-  int32_t                   m_headersPosition;</span>
<a href="#l36.147"></a><span id="l36.147" class="difflineminus">-  int32_t                   m_bytesRead;</span>
<a href="#l36.148"></a><span id="l36.148" class="difflineminus">-  int32_t                   m_position;</span>
<a href="#l36.149"></a><span id="l36.149" class="difflineminus">-  int32_t                   m_flagsPosition;</span>
<a href="#l36.150"></a><span id="l36.150" class="difflineminus">-  int32_t                   m_headersSize;</span>
<a href="#l36.151"></a><span id="l36.151" class="difflineminus">-  char                      *mLeftoverBuffer;</span>
<a href="#l36.152"></a><span id="l36.152" class="difflineminus">-  char                      *mIdentityKey;</span>
<a href="#l36.153"></a><span id="l36.153" class="difflineminus">-  char                      *mAccountKey;</span>
<a href="#l36.154"></a><span id="l36.154" class="difflineplus">+  char *m_to;</span>
<a href="#l36.155"></a><span id="l36.155" class="difflineplus">+  char *m_bcc;</span>
<a href="#l36.156"></a><span id="l36.156" class="difflineplus">+  char *m_fcc;</span>
<a href="#l36.157"></a><span id="l36.157" class="difflineplus">+  char *m_newsgroups;</span>
<a href="#l36.158"></a><span id="l36.158" class="difflineplus">+  char *m_newshost;</span>
<a href="#l36.159"></a><span id="l36.159" class="difflineplus">+  char *m_headers;</span>
<a href="#l36.160"></a><span id="l36.160" class="difflineplus">+  int32_t m_flags;</span>
<a href="#l36.161"></a><span id="l36.161" class="difflineplus">+  int32_t m_headersFP;</span>
<a href="#l36.162"></a><span id="l36.162" class="difflineplus">+  bool m_inhead;</span>
<a href="#l36.163"></a><span id="l36.163" class="difflineplus">+  int32_t m_headersPosition;</span>
<a href="#l36.164"></a><span id="l36.164" class="difflineplus">+  int32_t m_bytesRead;</span>
<a href="#l36.165"></a><span id="l36.165" class="difflineplus">+  int32_t m_position;</span>
<a href="#l36.166"></a><span id="l36.166" class="difflineplus">+  int32_t m_flagsPosition;</span>
<a href="#l36.167"></a><span id="l36.167" class="difflineplus">+  int32_t m_headersSize;</span>
<a href="#l36.168"></a><span id="l36.168" class="difflineplus">+  char *mLeftoverBuffer;</span>
<a href="#l36.169"></a><span id="l36.169" class="difflineplus">+  char *mIdentityKey;</span>
<a href="#l36.170"></a><span id="l36.170" class="difflineplus">+  char *mAccountKey;</span>
<a href="#l36.171"></a><span id="l36.171"> </span>
<a href="#l36.172"></a><span id="l36.172">   bool mSendingMessages;</span>
<a href="#l36.173"></a><span id="l36.173">   bool mUserInitiated;</span>
<a href="#l36.174"></a><span id="l36.174">   nsCOMPtr&lt;nsIMsgIdentity&gt; mIdentity;</span>
<a href="#l36.175"></a><span id="l36.175"> };</span>
<a href="#l36.176"></a><span id="l36.176"> </span>
<a href="#l36.177"></a><span id="l36.177" class="difflineminus">-</span>
<a href="#l36.178"></a><span id="l36.178"> #endif /* _nsMsgSendLater_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSendPart.cpp</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSendPart.cpp</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -21,20 +21,20 @@</span>
<a href="#l37.4"></a><span id="l37.4"> #include &quot;nsILineInputStream.h&quot;</span>
<a href="#l37.5"></a><span id="l37.5"> #include &quot;nsComposeStrings.h&quot;</span>
<a href="#l37.6"></a><span id="l37.6"> #include &quot;mozilla/mailnews/MimeEncoder.h&quot;</span>
<a href="#l37.7"></a><span id="l37.7"> </span>
<a href="#l37.8"></a><span id="l37.8"> static char *mime_mailto_stream_read_buffer = 0;</span>
<a href="#l37.9"></a><span id="l37.9"> </span>
<a href="#l37.10"></a><span id="l37.10"> int32_t nsMsgSendPart::M_counter = 0;</span>
<a href="#l37.11"></a><span id="l37.11"> </span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-nsMsgSendPart::nsMsgSendPart(nsIMsgSend* state, const char *part_charset)</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineminus">-{</span>
<a href="#l37.14"></a><span id="l37.14" class="difflineminus">-  PL_strncpy(m_charset_name, (part_charset ? part_charset : &quot;UTF-8&quot;), sizeof(m_charset_name)-1);</span>
<a href="#l37.15"></a><span id="l37.15" class="difflineminus">-  m_charset_name[sizeof(m_charset_name)-1] = '\0';</span>
<a href="#l37.16"></a><span id="l37.16" class="difflineplus">+nsMsgSendPart::nsMsgSendPart(nsIMsgSend *state, const char *part_charset) {</span>
<a href="#l37.17"></a><span id="l37.17" class="difflineplus">+  PL_strncpy(m_charset_name, (part_charset ? part_charset : &quot;UTF-8&quot;),</span>
<a href="#l37.18"></a><span id="l37.18" class="difflineplus">+             sizeof(m_charset_name) - 1);</span>
<a href="#l37.19"></a><span id="l37.19" class="difflineplus">+  m_charset_name[sizeof(m_charset_name) - 1] = '\0';</span>
<a href="#l37.20"></a><span id="l37.20">   m_children = nullptr;</span>
<a href="#l37.21"></a><span id="l37.21">   m_numchildren = 0;</span>
<a href="#l37.22"></a><span id="l37.22">   // if we're not added as a child, the default part number will be &quot;1&quot;.</span>
<a href="#l37.23"></a><span id="l37.23">   m_partNum = &quot;1&quot;;</span>
<a href="#l37.24"></a><span id="l37.24">   SetMimeDeliveryState(state);</span>
<a href="#l37.25"></a><span id="l37.25"> </span>
<a href="#l37.26"></a><span id="l37.26">   m_parent = nullptr;</span>
<a href="#l37.27"></a><span id="l37.27">   m_buffer = nullptr;</span>
<a href="#l37.28"></a><span id="l37.28" class="difflineat">@@ -44,199 +44,162 @@ nsMsgSendPart::nsMsgSendPart(nsIMsgSend*</span>
<a href="#l37.29"></a><span id="l37.29"> </span>
<a href="#l37.30"></a><span id="l37.30">   m_firstBlock = false;</span>
<a href="#l37.31"></a><span id="l37.31">   m_needIntlConversion = false;</span>
<a href="#l37.32"></a><span id="l37.32"> </span>
<a href="#l37.33"></a><span id="l37.33">   m_mainpart = false;</span>
<a href="#l37.34"></a><span id="l37.34">   m_just_hit_CR = false;</span>
<a href="#l37.35"></a><span id="l37.35"> }</span>
<a href="#l37.36"></a><span id="l37.36"> </span>
<a href="#l37.37"></a><span id="l37.37" class="difflineplus">+nsMsgSendPart::~nsMsgSendPart() {</span>
<a href="#l37.38"></a><span id="l37.38" class="difflineplus">+  for (int i = 0; i &lt; m_numchildren; i++) delete m_children[i];</span>
<a href="#l37.39"></a><span id="l37.39"> </span>
<a href="#l37.40"></a><span id="l37.40" class="difflineminus">-nsMsgSendPart::~nsMsgSendPart()</span>
<a href="#l37.41"></a><span id="l37.41" class="difflineminus">-{</span>
<a href="#l37.42"></a><span id="l37.42" class="difflineminus">-  for (int i=0 ; i &lt; m_numchildren; i++)</span>
<a href="#l37.43"></a><span id="l37.43" class="difflineminus">-    delete m_children[i];</span>
<a href="#l37.44"></a><span id="l37.44" class="difflineminus">-</span>
<a href="#l37.45"></a><span id="l37.45" class="difflineminus">-  delete [] m_children;</span>
<a href="#l37.46"></a><span id="l37.46" class="difflineminus">-    PR_FREEIF(m_buffer);</span>
<a href="#l37.47"></a><span id="l37.47" class="difflineplus">+  delete[] m_children;</span>
<a href="#l37.48"></a><span id="l37.48" class="difflineplus">+  PR_FREEIF(m_buffer);</span>
<a href="#l37.49"></a><span id="l37.49">   PR_FREEIF(m_other);</span>
<a href="#l37.50"></a><span id="l37.50">   PR_FREEIF(m_type);</span>
<a href="#l37.51"></a><span id="l37.51"> }</span>
<a href="#l37.52"></a><span id="l37.52"> </span>
<a href="#l37.53"></a><span id="l37.53" class="difflineminus">-nsresult nsMsgSendPart::CopyString(char** dest, const char* src)</span>
<a href="#l37.54"></a><span id="l37.54" class="difflineminus">-{</span>
<a href="#l37.55"></a><span id="l37.55" class="difflineplus">+nsresult nsMsgSendPart::CopyString(char **dest, const char *src) {</span>
<a href="#l37.56"></a><span id="l37.56">   NS_ASSERTION(src, &quot;src null&quot;);</span>
<a href="#l37.57"></a><span id="l37.57"> </span>
<a href="#l37.58"></a><span id="l37.58">   PR_FREEIF(*dest);</span>
<a href="#l37.59"></a><span id="l37.59">   if (!src)</span>
<a href="#l37.60"></a><span id="l37.60">     *dest = PL_strdup(&quot;&quot;);</span>
<a href="#l37.61"></a><span id="l37.61">   else</span>
<a href="#l37.62"></a><span id="l37.62">     *dest = PL_strdup(src);</span>
<a href="#l37.63"></a><span id="l37.63"> </span>
<a href="#l37.64"></a><span id="l37.64" class="difflineminus">-  return *dest? NS_OK : NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l37.65"></a><span id="l37.65" class="difflineplus">+  return *dest ? NS_OK : NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l37.66"></a><span id="l37.66"> }</span>
<a href="#l37.67"></a><span id="l37.67"> </span>
<a href="#l37.68"></a><span id="l37.68" class="difflineminus">-</span>
<a href="#l37.69"></a><span id="l37.69" class="difflineminus">-nsresult nsMsgSendPart::SetFile(nsIFile *file)</span>
<a href="#l37.70"></a><span id="l37.70" class="difflineminus">-{</span>
<a href="#l37.71"></a><span id="l37.71" class="difflineplus">+nsresult nsMsgSendPart::SetFile(nsIFile *file) {</span>
<a href="#l37.72"></a><span id="l37.72">   m_file = file;</span>
<a href="#l37.73"></a><span id="l37.73">   return NS_OK;</span>
<a href="#l37.74"></a><span id="l37.74"> }</span>
<a href="#l37.75"></a><span id="l37.75"> </span>
<a href="#l37.76"></a><span id="l37.76" class="difflineminus">-</span>
<a href="#l37.77"></a><span id="l37.77" class="difflineminus">-nsresult nsMsgSendPart::SetBuffer(const char* buffer)</span>
<a href="#l37.78"></a><span id="l37.78" class="difflineminus">-{</span>
<a href="#l37.79"></a><span id="l37.79" class="difflineplus">+nsresult nsMsgSendPart::SetBuffer(const char *buffer) {</span>
<a href="#l37.80"></a><span id="l37.80">   PR_FREEIF(m_buffer);</span>
<a href="#l37.81"></a><span id="l37.81">   return CopyString(&amp;m_buffer, buffer);</span>
<a href="#l37.82"></a><span id="l37.82"> }</span>
<a href="#l37.83"></a><span id="l37.83"> </span>
<a href="#l37.84"></a><span id="l37.84" class="difflineminus">-</span>
<a href="#l37.85"></a><span id="l37.85" class="difflineminus">-nsresult nsMsgSendPart::SetType(const char* type)</span>
<a href="#l37.86"></a><span id="l37.86" class="difflineminus">-{</span>
<a href="#l37.87"></a><span id="l37.87" class="difflineplus">+nsresult nsMsgSendPart::SetType(const char *type) {</span>
<a href="#l37.88"></a><span id="l37.88">   PR_FREEIF(m_type);</span>
<a href="#l37.89"></a><span id="l37.89">   m_type = PL_strdup(type);</span>
<a href="#l37.90"></a><span id="l37.90">   return m_type ? NS_OK : NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l37.91"></a><span id="l37.91"> }</span>
<a href="#l37.92"></a><span id="l37.92"> </span>
<a href="#l37.93"></a><span id="l37.93" class="difflineminus">-</span>
<a href="#l37.94"></a><span id="l37.94" class="difflineminus">-nsresult nsMsgSendPart::SetOtherHeaders(const char* other)</span>
<a href="#l37.95"></a><span id="l37.95" class="difflineminus">-{</span>
<a href="#l37.96"></a><span id="l37.96" class="difflineplus">+nsresult nsMsgSendPart::SetOtherHeaders(const char *other) {</span>
<a href="#l37.97"></a><span id="l37.97">   return CopyString(&amp;m_other, other);</span>
<a href="#l37.98"></a><span id="l37.98"> }</span>
<a href="#l37.99"></a><span id="l37.99"> </span>
<a href="#l37.100"></a><span id="l37.100" class="difflineminus">-nsresult nsMsgSendPart::SetMimeDeliveryState(nsIMsgSend *state)</span>
<a href="#l37.101"></a><span id="l37.101" class="difflineminus">-{</span>
<a href="#l37.102"></a><span id="l37.102" class="difflineplus">+nsresult nsMsgSendPart::SetMimeDeliveryState(nsIMsgSend *state) {</span>
<a href="#l37.103"></a><span id="l37.103">   m_state = state;</span>
<a href="#l37.104"></a><span id="l37.104" class="difflineminus">-  if (GetNumChildren() &gt; 0)</span>
<a href="#l37.105"></a><span id="l37.105" class="difflineminus">-  {</span>
<a href="#l37.106"></a><span id="l37.106" class="difflineminus">-    for (int i = 0; i &lt; GetNumChildren(); i++)</span>
<a href="#l37.107"></a><span id="l37.107" class="difflineminus">-    {</span>
<a href="#l37.108"></a><span id="l37.108" class="difflineplus">+  if (GetNumChildren() &gt; 0) {</span>
<a href="#l37.109"></a><span id="l37.109" class="difflineplus">+    for (int i = 0; i &lt; GetNumChildren(); i++) {</span>
<a href="#l37.110"></a><span id="l37.110">       nsMsgSendPart *part = GetChild(i);</span>
<a href="#l37.111"></a><span id="l37.111" class="difflineminus">-      if (part)</span>
<a href="#l37.112"></a><span id="l37.112" class="difflineminus">-        part-&gt;SetMimeDeliveryState(state);</span>
<a href="#l37.113"></a><span id="l37.113" class="difflineplus">+      if (part) part-&gt;SetMimeDeliveryState(state);</span>
<a href="#l37.114"></a><span id="l37.114">     }</span>
<a href="#l37.115"></a><span id="l37.115">   }</span>
<a href="#l37.116"></a><span id="l37.116">   return NS_OK;</span>
<a href="#l37.117"></a><span id="l37.117"> }</span>
<a href="#l37.118"></a><span id="l37.118"> </span>
<a href="#l37.119"></a><span id="l37.119" class="difflineminus">-nsresult nsMsgSendPart::AppendOtherHeaders(const char* more)</span>
<a href="#l37.120"></a><span id="l37.120" class="difflineminus">-{</span>
<a href="#l37.121"></a><span id="l37.121" class="difflineminus">-  if (!m_other)</span>
<a href="#l37.122"></a><span id="l37.122" class="difflineminus">-    return SetOtherHeaders(more);</span>
<a href="#l37.123"></a><span id="l37.123" class="difflineplus">+nsresult nsMsgSendPart::AppendOtherHeaders(const char *more) {</span>
<a href="#l37.124"></a><span id="l37.124" class="difflineplus">+  if (!m_other) return SetOtherHeaders(more);</span>
<a href="#l37.125"></a><span id="l37.125"> </span>
<a href="#l37.126"></a><span id="l37.126" class="difflineminus">-  if (!more || !*more)</span>
<a href="#l37.127"></a><span id="l37.127" class="difflineminus">-    return NS_OK;</span>
<a href="#l37.128"></a><span id="l37.128" class="difflineplus">+  if (!more || !*more) return NS_OK;</span>
<a href="#l37.129"></a><span id="l37.129"> </span>
<a href="#l37.130"></a><span id="l37.130" class="difflineminus">-  char* tmp = (char *) PR_Malloc(sizeof(char) * (PL_strlen(m_other) + PL_strlen(more) + 2));</span>
<a href="#l37.131"></a><span id="l37.131" class="difflineminus">-  if (!tmp)</span>
<a href="#l37.132"></a><span id="l37.132" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l37.133"></a><span id="l37.133" class="difflineplus">+  char *tmp = (char *)PR_Malloc(sizeof(char) *</span>
<a href="#l37.134"></a><span id="l37.134" class="difflineplus">+                                (PL_strlen(m_other) + PL_strlen(more) + 2));</span>
<a href="#l37.135"></a><span id="l37.135" class="difflineplus">+  if (!tmp) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l37.136"></a><span id="l37.136"> </span>
<a href="#l37.137"></a><span id="l37.137">   PL_strcpy(tmp, m_other);</span>
<a href="#l37.138"></a><span id="l37.138">   PL_strcat(tmp, more);</span>
<a href="#l37.139"></a><span id="l37.139">   PR_FREEIF(m_other);</span>
<a href="#l37.140"></a><span id="l37.140">   m_other = tmp;</span>
<a href="#l37.141"></a><span id="l37.141"> </span>
<a href="#l37.142"></a><span id="l37.142">   return NS_OK;</span>
<a href="#l37.143"></a><span id="l37.143"> }</span>
<a href="#l37.144"></a><span id="l37.144"> </span>
<a href="#l37.145"></a><span id="l37.145" class="difflineminus">-</span>
<a href="#l37.146"></a><span id="l37.146" class="difflineminus">-nsresult nsMsgSendPart::SetMainPart(bool value)</span>
<a href="#l37.147"></a><span id="l37.147" class="difflineminus">-{</span>
<a href="#l37.148"></a><span id="l37.148" class="difflineplus">+nsresult nsMsgSendPart::SetMainPart(bool value) {</span>
<a href="#l37.149"></a><span id="l37.149">   m_mainpart = value;</span>
<a href="#l37.150"></a><span id="l37.150">   return NS_OK;</span>
<a href="#l37.151"></a><span id="l37.151"> }</span>
<a href="#l37.152"></a><span id="l37.152"> </span>
<a href="#l37.153"></a><span id="l37.153" class="difflineminus">-nsresult nsMsgSendPart::AddChild(nsMsgSendPart* child)</span>
<a href="#l37.154"></a><span id="l37.154" class="difflineminus">-{</span>
<a href="#l37.155"></a><span id="l37.155" class="difflineplus">+nsresult nsMsgSendPart::AddChild(nsMsgSendPart *child) {</span>
<a href="#l37.156"></a><span id="l37.156">   m_numchildren++;</span>
<a href="#l37.157"></a><span id="l37.157" class="difflineminus">-  nsMsgSendPart** tmp = new nsMsgSendPart* [m_numchildren];</span>
<a href="#l37.158"></a><span id="l37.158" class="difflineplus">+  nsMsgSendPart **tmp = new nsMsgSendPart *[m_numchildren];</span>
<a href="#l37.159"></a><span id="l37.159">   if (tmp == nullptr) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l37.160"></a><span id="l37.160" class="difflineminus">-  for (int i=0 ; i&lt;m_numchildren-1 ; i++) {</span>
<a href="#l37.161"></a><span id="l37.161" class="difflineplus">+  for (int i = 0; i &lt; m_numchildren - 1; i++) {</span>
<a href="#l37.162"></a><span id="l37.162">     tmp[i] = m_children[i];</span>
<a href="#l37.163"></a><span id="l37.163">   }</span>
<a href="#l37.164"></a><span id="l37.164" class="difflineminus">-  delete [] m_children;</span>
<a href="#l37.165"></a><span id="l37.165" class="difflineplus">+  delete[] m_children;</span>
<a href="#l37.166"></a><span id="l37.166">   m_children = tmp;</span>
<a href="#l37.167"></a><span id="l37.167">   m_children[m_numchildren - 1] = child;</span>
<a href="#l37.168"></a><span id="l37.168">   child-&gt;m_parent = this;</span>
<a href="#l37.169"></a><span id="l37.169">   nsCString partNum(m_partNum);</span>
<a href="#l37.170"></a><span id="l37.170">   partNum.Append('.');</span>
<a href="#l37.171"></a><span id="l37.171">   partNum.AppendInt(m_numchildren);</span>
<a href="#l37.172"></a><span id="l37.172">   child-&gt;m_partNum = partNum;</span>
<a href="#l37.173"></a><span id="l37.173">   return NS_OK;</span>
<a href="#l37.174"></a><span id="l37.174"> }</span>
<a href="#l37.175"></a><span id="l37.175"> </span>
<a href="#l37.176"></a><span id="l37.176" class="difflineminus">-nsMsgSendPart * nsMsgSendPart::DetachChild(int32_t whichOne)</span>
<a href="#l37.177"></a><span id="l37.177" class="difflineminus">-{</span>
<a href="#l37.178"></a><span id="l37.178" class="difflineplus">+nsMsgSendPart *nsMsgSendPart::DetachChild(int32_t whichOne) {</span>
<a href="#l37.179"></a><span id="l37.179">   nsMsgSendPart *returnValue = nullptr;</span>
<a href="#l37.180"></a><span id="l37.180"> </span>
<a href="#l37.181"></a><span id="l37.181" class="difflineminus">-  NS_ASSERTION(whichOne &gt;= 0 &amp;&amp; whichOne &lt; m_numchildren, &quot;parameter out of range&quot;);</span>
<a href="#l37.182"></a><span id="l37.182" class="difflineminus">-  if (whichOne &gt;= 0 &amp;&amp; whichOne &lt; m_numchildren)</span>
<a href="#l37.183"></a><span id="l37.183" class="difflineminus">-  {</span>
<a href="#l37.184"></a><span id="l37.184" class="difflineplus">+  NS_ASSERTION(whichOne &gt;= 0 &amp;&amp; whichOne &lt; m_numchildren,</span>
<a href="#l37.185"></a><span id="l37.185" class="difflineplus">+               &quot;parameter out of range&quot;);</span>
<a href="#l37.186"></a><span id="l37.186" class="difflineplus">+  if (whichOne &gt;= 0 &amp;&amp; whichOne &lt; m_numchildren) {</span>
<a href="#l37.187"></a><span id="l37.187">     returnValue = m_children[whichOne];</span>
<a href="#l37.188"></a><span id="l37.188"> </span>
<a href="#l37.189"></a><span id="l37.189" class="difflineminus">-    if (m_numchildren &gt; 1)</span>
<a href="#l37.190"></a><span id="l37.190" class="difflineminus">-    {</span>
<a href="#l37.191"></a><span id="l37.191" class="difflineminus">-      nsMsgSendPart** tmp = new nsMsgSendPart* [m_numchildren-1];</span>
<a href="#l37.192"></a><span id="l37.192" class="difflineminus">-      if (tmp != nullptr)</span>
<a href="#l37.193"></a><span id="l37.193" class="difflineminus">-      {</span>
<a href="#l37.194"></a><span id="l37.194" class="difflineplus">+    if (m_numchildren &gt; 1) {</span>
<a href="#l37.195"></a><span id="l37.195" class="difflineplus">+      nsMsgSendPart **tmp = new nsMsgSendPart *[m_numchildren - 1];</span>
<a href="#l37.196"></a><span id="l37.196" class="difflineplus">+      if (tmp != nullptr) {</span>
<a href="#l37.197"></a><span id="l37.197">         // move all the other kids over</span>
<a href="#l37.198"></a><span id="l37.198" class="difflineminus">-        for (int i=0 ; i&lt;m_numchildren-1 ; i++)</span>
<a href="#l37.199"></a><span id="l37.199" class="difflineminus">-        {</span>
<a href="#l37.200"></a><span id="l37.200" class="difflineplus">+        for (int i = 0; i &lt; m_numchildren - 1; i++) {</span>
<a href="#l37.201"></a><span id="l37.201">           if (i &gt;= whichOne)</span>
<a href="#l37.202"></a><span id="l37.202" class="difflineminus">-            tmp[i] = m_children[i+1];</span>
<a href="#l37.203"></a><span id="l37.203" class="difflineplus">+            tmp[i] = m_children[i + 1];</span>
<a href="#l37.204"></a><span id="l37.204">           else</span>
<a href="#l37.205"></a><span id="l37.205">             tmp[i] = m_children[i];</span>
<a href="#l37.206"></a><span id="l37.206">         }</span>
<a href="#l37.207"></a><span id="l37.207" class="difflineminus">-        delete [] m_children;</span>
<a href="#l37.208"></a><span id="l37.208" class="difflineplus">+        delete[] m_children;</span>
<a href="#l37.209"></a><span id="l37.209">         m_children = tmp;</span>
<a href="#l37.210"></a><span id="l37.210">         m_numchildren--;</span>
<a href="#l37.211"></a><span id="l37.211">       }</span>
<a href="#l37.212"></a><span id="l37.212" class="difflineminus">-    }</span>
<a href="#l37.213"></a><span id="l37.213" class="difflineminus">-    else</span>
<a href="#l37.214"></a><span id="l37.214" class="difflineminus">-    {</span>
<a href="#l37.215"></a><span id="l37.215" class="difflineminus">-      delete [] m_children;</span>
<a href="#l37.216"></a><span id="l37.216" class="difflineplus">+    } else {</span>
<a href="#l37.217"></a><span id="l37.217" class="difflineplus">+      delete[] m_children;</span>
<a href="#l37.218"></a><span id="l37.218">       m_children = nullptr;</span>
<a href="#l37.219"></a><span id="l37.219">       m_numchildren = 0;</span>
<a href="#l37.220"></a><span id="l37.220">     }</span>
<a href="#l37.221"></a><span id="l37.221">   }</span>
<a href="#l37.222"></a><span id="l37.222"> </span>
<a href="#l37.223"></a><span id="l37.223" class="difflineminus">-  if (returnValue)</span>
<a href="#l37.224"></a><span id="l37.224" class="difflineminus">-    returnValue-&gt;m_parent = nullptr;</span>
<a href="#l37.225"></a><span id="l37.225" class="difflineplus">+  if (returnValue) returnValue-&gt;m_parent = nullptr;</span>
<a href="#l37.226"></a><span id="l37.226"> </span>
<a href="#l37.227"></a><span id="l37.227">   return returnValue;</span>
<a href="#l37.228"></a><span id="l37.228"> }</span>
<a href="#l37.229"></a><span id="l37.229"> </span>
<a href="#l37.230"></a><span id="l37.230" class="difflineminus">-nsMsgSendPart* nsMsgSendPart::GetChild(int32_t which)</span>
<a href="#l37.231"></a><span id="l37.231" class="difflineminus">-{</span>
<a href="#l37.232"></a><span id="l37.232" class="difflineplus">+nsMsgSendPart *nsMsgSendPart::GetChild(int32_t which) {</span>
<a href="#l37.233"></a><span id="l37.233">   NS_ASSERTION(which &gt;= 0 &amp;&amp; which &lt; m_numchildren, &quot;parameter out of range&quot;);</span>
<a href="#l37.234"></a><span id="l37.234">   if (which &gt;= 0 &amp;&amp; which &lt; m_numchildren) {</span>
<a href="#l37.235"></a><span id="l37.235">     return m_children[which];</span>
<a href="#l37.236"></a><span id="l37.236">   }</span>
<a href="#l37.237"></a><span id="l37.237">   return nullptr;</span>
<a href="#l37.238"></a><span id="l37.238"> }</span>
<a href="#l37.239"></a><span id="l37.239"> </span>
<a href="#l37.240"></a><span id="l37.240" class="difflineminus">-</span>
<a href="#l37.241"></a><span id="l37.241" class="difflineminus">-</span>
<a href="#l37.242"></a><span id="l37.242" class="difflineminus">-nsresult nsMsgSendPart::PushBody(const char* buffer, int32_t length)</span>
<a href="#l37.243"></a><span id="l37.243" class="difflineminus">-{</span>
<a href="#l37.244"></a><span id="l37.244" class="difflineplus">+nsresult nsMsgSendPart::PushBody(const char *buffer, int32_t length) {</span>
<a href="#l37.245"></a><span id="l37.245">   nsresult status = NS_OK;</span>
<a href="#l37.246"></a><span id="l37.246" class="difflineminus">-  const char* encoded_data = buffer;</span>
<a href="#l37.247"></a><span id="l37.247" class="difflineplus">+  const char *encoded_data = buffer;</span>
<a href="#l37.248"></a><span id="l37.248"> </span>
<a href="#l37.249"></a><span id="l37.249" class="difflineminus">-  if (m_encoder)</span>
<a href="#l37.250"></a><span id="l37.250" class="difflineminus">-  {</span>
<a href="#l37.251"></a><span id="l37.251" class="difflineplus">+  if (m_encoder) {</span>
<a href="#l37.252"></a><span id="l37.252">     status = m_encoder-&gt;Write(encoded_data, length);</span>
<a href="#l37.253"></a><span id="l37.253" class="difflineminus">-  }</span>
<a href="#l37.254"></a><span id="l37.254" class="difflineminus">-  else</span>
<a href="#l37.255"></a><span id="l37.255" class="difflineminus">-  {</span>
<a href="#l37.256"></a><span id="l37.256" class="difflineplus">+  } else {</span>
<a href="#l37.257"></a><span id="l37.257">     // Merely translate all linebreaks to CRLF.</span>
<a href="#l37.258"></a><span id="l37.258">     const char *in = encoded_data;</span>
<a href="#l37.259"></a><span id="l37.259">     const char *end = in + length;</span>
<a href="#l37.260"></a><span id="l37.260">     char *buffer, *out;</span>
<a href="#l37.261"></a><span id="l37.261"> </span>
<a href="#l37.262"></a><span id="l37.262" class="difflineminus">-</span>
<a href="#l37.263"></a><span id="l37.263">     buffer = mime_get_stream_write_buffer();</span>
<a href="#l37.264"></a><span id="l37.264">     // XXX -1 is not a valid nsresult</span>
<a href="#l37.265"></a><span id="l37.265">     NS_ENSURE_TRUE(buffer, static_cast&lt;nsresult&gt;(-1));</span>
<a href="#l37.266"></a><span id="l37.266"> </span>
<a href="#l37.267"></a><span id="l37.267">     NS_ASSERTION(encoded_data != buffer, &quot;encoded_data == buffer&quot;);</span>
<a href="#l37.268"></a><span id="l37.268">     out = buffer;</span>
<a href="#l37.269"></a><span id="l37.269"> </span>
<a href="#l37.270"></a><span id="l37.270">     for (; in &lt; end; in++) {</span>
<a href="#l37.271"></a><span id="l37.271" class="difflineat">@@ -249,34 +212,30 @@ nsresult nsMsgSendPart::PushBody(const c</span>
<a href="#l37.272"></a><span id="l37.272">           continue;</span>
<a href="#l37.273"></a><span id="l37.273">         }</span>
<a href="#l37.274"></a><span id="l37.274">       }</span>
<a href="#l37.275"></a><span id="l37.275">       if (*in == '\r' || *in == '\n') {</span>
<a href="#l37.276"></a><span id="l37.276">         /* Write out the newline. */</span>
<a href="#l37.277"></a><span id="l37.277">         *out++ = '\r';</span>
<a href="#l37.278"></a><span id="l37.278">         *out++ = '\n';</span>
<a href="#l37.279"></a><span id="l37.279"> </span>
<a href="#l37.280"></a><span id="l37.280" class="difflineminus">-        status = mime_write_message_body(m_state, buffer,</span>
<a href="#l37.281"></a><span id="l37.281" class="difflineminus">-          out - buffer);</span>
<a href="#l37.282"></a><span id="l37.282" class="difflineplus">+        status = mime_write_message_body(m_state, buffer, out - buffer);</span>
<a href="#l37.283"></a><span id="l37.283">         if (NS_FAILED(status)) return status;</span>
<a href="#l37.284"></a><span id="l37.284">         out = buffer;</span>
<a href="#l37.285"></a><span id="l37.285"> </span>
<a href="#l37.286"></a><span id="l37.286">         if (*in == '\r') {</span>
<a href="#l37.287"></a><span id="l37.287">           m_just_hit_CR = true;</span>
<a href="#l37.288"></a><span id="l37.288">         }</span>
<a href="#l37.289"></a><span id="l37.289"> </span>
<a href="#l37.290"></a><span id="l37.290">         out = buffer;</span>
<a href="#l37.291"></a><span id="l37.291">       } else {</span>
<a href="#l37.292"></a><span id="l37.292" class="difflineminus">-</span>
<a href="#l37.293"></a><span id="l37.293" class="difflineminus">-      /*  Fix for bug #95985. We can't assume that all lines are shorter</span>
<a href="#l37.294"></a><span id="l37.294" class="difflineminus">-      than 4096 chars (MIME_BUFFER_SIZE), so we need to test</span>
<a href="#l37.295"></a><span id="l37.295" class="difflineminus">-      for this here. sfraser.</span>
<a href="#l37.296"></a><span id="l37.296" class="difflineminus">-        */</span>
<a href="#l37.297"></a><span id="l37.297" class="difflineminus">-        if (out - buffer &gt;= MIME_BUFFER_SIZE)</span>
<a href="#l37.298"></a><span id="l37.298" class="difflineminus">-        {</span>
<a href="#l37.299"></a><span id="l37.299" class="difflineplus">+        // Fix for bug #95985. We can't assume that all lines are shorter</span>
<a href="#l37.300"></a><span id="l37.300" class="difflineplus">+        // than 4096 chars (MIME_BUFFER_SIZE), so we need to test</span>
<a href="#l37.301"></a><span id="l37.301" class="difflineplus">+        // for this here. sfraser.</span>
<a href="#l37.302"></a><span id="l37.302" class="difflineplus">+        if (out - buffer &gt;= MIME_BUFFER_SIZE) {</span>
<a href="#l37.303"></a><span id="l37.303">           status = mime_write_message_body(m_state, buffer, out - buffer);</span>
<a href="#l37.304"></a><span id="l37.304">           if (NS_FAILED(status)) return status;</span>
<a href="#l37.305"></a><span id="l37.305"> </span>
<a href="#l37.306"></a><span id="l37.306">           out = buffer;</span>
<a href="#l37.307"></a><span id="l37.307">         }</span>
<a href="#l37.308"></a><span id="l37.308"> </span>
<a href="#l37.309"></a><span id="l37.309">         *out++ = *in;</span>
<a href="#l37.310"></a><span id="l37.310">       }</span>
<a href="#l37.311"></a><span id="l37.311" class="difflineat">@@ -286,494 +245,441 @@ nsresult nsMsgSendPart::PushBody(const c</span>
<a href="#l37.312"></a><span id="l37.312">     if (out &gt; buffer) {</span>
<a href="#l37.313"></a><span id="l37.313">       status = mime_write_message_body(m_state, buffer, out - buffer);</span>
<a href="#l37.314"></a><span id="l37.314">       if (NS_FAILED(status)) return status;</span>
<a href="#l37.315"></a><span id="l37.315">       out = buffer;</span>
<a href="#l37.316"></a><span id="l37.316">     }</span>
<a href="#l37.317"></a><span id="l37.317">   }</span>
<a href="#l37.318"></a><span id="l37.318"> </span>
<a href="#l37.319"></a><span id="l37.319">   if (encoded_data &amp;&amp; encoded_data != buffer) {</span>
<a href="#l37.320"></a><span id="l37.320" class="difflineminus">-    PR_Free((char *) encoded_data);</span>
<a href="#l37.321"></a><span id="l37.321" class="difflineplus">+    PR_Free((char *)encoded_data);</span>
<a href="#l37.322"></a><span id="l37.322">   }</span>
<a href="#l37.323"></a><span id="l37.323"> </span>
<a href="#l37.324"></a><span id="l37.324">   return status;</span>
<a href="#l37.325"></a><span id="l37.325"> }</span>
<a href="#l37.326"></a><span id="l37.326"> </span>
<a href="#l37.327"></a><span id="l37.327" class="difflineminus">-</span>
<a href="#l37.328"></a><span id="l37.328"> /* Partition the headers into those which apply to the message as a whole;</span>
<a href="#l37.329"></a><span id="l37.329"> those which apply to the message's contents; and the Content-Type header</span>
<a href="#l37.330"></a><span id="l37.330"> itself.  (This relies on the fact that all body-related headers begin with</span>
<a href="#l37.331"></a><span id="l37.331"> &quot;Content-&quot;.)</span>
<a href="#l37.332"></a><span id="l37.332"> </span>
<a href="#l37.333"></a><span id="l37.333">   (How many header parsers are in this program now?)</span>
<a href="#l37.334"></a><span id="l37.334">   */</span>
<a href="#l37.335"></a><span id="l37.335" class="difflineminus">-static nsresult</span>
<a href="#l37.336"></a><span id="l37.336" class="difflineminus">-divide_content_headers(const char *headers,</span>
<a href="#l37.337"></a><span id="l37.337" class="difflineminus">-                        char **message_headers,</span>
<a href="#l37.338"></a><span id="l37.338" class="difflineminus">-                        char **content_headers,</span>
<a href="#l37.339"></a><span id="l37.339" class="difflineminus">-                        char **content_type_header)</span>
<a href="#l37.340"></a><span id="l37.340" class="difflineminus">-{</span>
<a href="#l37.341"></a><span id="l37.341" class="difflineminus">-    const char *tail;</span>
<a href="#l37.342"></a><span id="l37.342" class="difflineminus">-    char *message_tail, *content_tail, *type_tail;</span>
<a href="#l37.343"></a><span id="l37.343" class="difflineminus">-    int L = 0;</span>
<a href="#l37.344"></a><span id="l37.344" class="difflineminus">-    if (headers)</span>
<a href="#l37.345"></a><span id="l37.345" class="difflineminus">-      L = PL_strlen(headers);</span>
<a href="#l37.346"></a><span id="l37.346" class="difflineplus">+static nsresult divide_content_headers(const char *headers,</span>
<a href="#l37.347"></a><span id="l37.347" class="difflineplus">+                                       char **message_headers,</span>
<a href="#l37.348"></a><span id="l37.348" class="difflineplus">+                                       char **content_headers,</span>
<a href="#l37.349"></a><span id="l37.349" class="difflineplus">+                                       char **content_type_header) {</span>
<a href="#l37.350"></a><span id="l37.350" class="difflineplus">+  const char *tail;</span>
<a href="#l37.351"></a><span id="l37.351" class="difflineplus">+  char *message_tail, *content_tail, *type_tail;</span>
<a href="#l37.352"></a><span id="l37.352" class="difflineplus">+  int L = 0;</span>
<a href="#l37.353"></a><span id="l37.353" class="difflineplus">+  if (headers) L = PL_strlen(headers);</span>
<a href="#l37.354"></a><span id="l37.354"> </span>
<a href="#l37.355"></a><span id="l37.355" class="difflineminus">-    if (L == 0)</span>
<a href="#l37.356"></a><span id="l37.356" class="difflineminus">-      return NS_OK;</span>
<a href="#l37.357"></a><span id="l37.357" class="difflineplus">+  if (L == 0) return NS_OK;</span>
<a href="#l37.358"></a><span id="l37.358" class="difflineplus">+</span>
<a href="#l37.359"></a><span id="l37.359" class="difflineplus">+  *message_headers = (char *)PR_Malloc(L + 1);</span>
<a href="#l37.360"></a><span id="l37.360" class="difflineplus">+  if (!*message_headers) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l37.361"></a><span id="l37.361" class="difflineplus">+</span>
<a href="#l37.362"></a><span id="l37.362" class="difflineplus">+  *content_headers = (char *)PR_Malloc(L + 1);</span>
<a href="#l37.363"></a><span id="l37.363" class="difflineplus">+  if (!*content_headers) {</span>
<a href="#l37.364"></a><span id="l37.364" class="difflineplus">+    PR_Free(*message_headers);</span>
<a href="#l37.365"></a><span id="l37.365" class="difflineplus">+    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l37.366"></a><span id="l37.366" class="difflineplus">+  }</span>
<a href="#l37.367"></a><span id="l37.367"> </span>
<a href="#l37.368"></a><span id="l37.368" class="difflineminus">-    *message_headers = (char *)PR_Malloc(L+1);</span>
<a href="#l37.369"></a><span id="l37.369" class="difflineminus">-    if (!*message_headers)</span>
<a href="#l37.370"></a><span id="l37.370" class="difflineminus">-      return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l37.371"></a><span id="l37.371" class="difflineplus">+  *content_type_header = (char *)PR_Malloc(L + 1);</span>
<a href="#l37.372"></a><span id="l37.372" class="difflineplus">+  if (!*content_type_header) {</span>
<a href="#l37.373"></a><span id="l37.373" class="difflineplus">+    PR_Free(*message_headers);</span>
<a href="#l37.374"></a><span id="l37.374" class="difflineplus">+    PR_Free(*content_headers);</span>
<a href="#l37.375"></a><span id="l37.375" class="difflineplus">+    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l37.376"></a><span id="l37.376" class="difflineplus">+  }</span>
<a href="#l37.377"></a><span id="l37.377" class="difflineplus">+</span>
<a href="#l37.378"></a><span id="l37.378" class="difflineplus">+  message_tail = *message_headers;</span>
<a href="#l37.379"></a><span id="l37.379" class="difflineplus">+  content_tail = *content_headers;</span>
<a href="#l37.380"></a><span id="l37.380" class="difflineplus">+  type_tail = *content_type_header;</span>
<a href="#l37.381"></a><span id="l37.381" class="difflineplus">+  tail = headers;</span>
<a href="#l37.382"></a><span id="l37.382"> </span>
<a href="#l37.383"></a><span id="l37.383" class="difflineminus">-    *content_headers = (char *)PR_Malloc(L+1);</span>
<a href="#l37.384"></a><span id="l37.384" class="difflineminus">-    if (!*content_headers) {</span>
<a href="#l37.385"></a><span id="l37.385" class="difflineminus">-      PR_Free(*message_headers);</span>
<a href="#l37.386"></a><span id="l37.386" class="difflineminus">-      return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l37.387"></a><span id="l37.387" class="difflineminus">-    }</span>
<a href="#l37.388"></a><span id="l37.388" class="difflineminus">-</span>
<a href="#l37.389"></a><span id="l37.389" class="difflineminus">-    *content_type_header = (char *)PR_Malloc(L+1);</span>
<a href="#l37.390"></a><span id="l37.390" class="difflineminus">-    if (!*content_type_header) {</span>
<a href="#l37.391"></a><span id="l37.391" class="difflineminus">-      PR_Free(*message_headers);</span>
<a href="#l37.392"></a><span id="l37.392" class="difflineminus">-      PR_Free(*content_headers);</span>
<a href="#l37.393"></a><span id="l37.393" class="difflineminus">-      return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l37.394"></a><span id="l37.394" class="difflineplus">+  while (*tail) {</span>
<a href="#l37.395"></a><span id="l37.395" class="difflineplus">+    const char *head = tail;</span>
<a href="#l37.396"></a><span id="l37.396" class="difflineplus">+    char **out;</span>
<a href="#l37.397"></a><span id="l37.397" class="difflineplus">+    while (true) {</span>
<a href="#l37.398"></a><span id="l37.398" class="difflineplus">+      /* Loop until we reach a newline that is not followed by whitespace.</span>
<a href="#l37.399"></a><span id="l37.399" class="difflineplus">+       */</span>
<a href="#l37.400"></a><span id="l37.400" class="difflineplus">+      if (tail[0] == 0 ||</span>
<a href="#l37.401"></a><span id="l37.401" class="difflineplus">+          ((tail[0] == '\r' || tail[0] == '\n') &amp;&amp;</span>
<a href="#l37.402"></a><span id="l37.402" class="difflineplus">+           !(tail[1] == ' ' || tail[1] == '\t' || tail[1] == '\n'))) {</span>
<a href="#l37.403"></a><span id="l37.403" class="difflineplus">+        /* Swallow the whole newline. */</span>
<a href="#l37.404"></a><span id="l37.404" class="difflineplus">+        if (tail[0] == '\r' &amp;&amp; tail[1] == '\n') tail++;</span>
<a href="#l37.405"></a><span id="l37.405" class="difflineplus">+        if (*tail) tail++;</span>
<a href="#l37.406"></a><span id="l37.406" class="difflineplus">+        break;</span>
<a href="#l37.407"></a><span id="l37.407" class="difflineplus">+      }</span>
<a href="#l37.408"></a><span id="l37.408" class="difflineplus">+      tail++;</span>
<a href="#l37.409"></a><span id="l37.409">     }</span>
<a href="#l37.410"></a><span id="l37.410"> </span>
<a href="#l37.411"></a><span id="l37.411" class="difflineminus">-    message_tail = *message_headers;</span>
<a href="#l37.412"></a><span id="l37.412" class="difflineminus">-    content_tail = *content_headers;</span>
<a href="#l37.413"></a><span id="l37.413" class="difflineminus">-    type_tail    = *content_type_header;</span>
<a href="#l37.414"></a><span id="l37.414" class="difflineminus">-    tail = headers;</span>
<a href="#l37.415"></a><span id="l37.415" class="difflineplus">+    /* Decide which block this header goes into.</span>
<a href="#l37.416"></a><span id="l37.416" class="difflineplus">+     */</span>
<a href="#l37.417"></a><span id="l37.417" class="difflineplus">+    if (!PL_strncasecmp(head, &quot;Content-Type:&quot;, 13))</span>
<a href="#l37.418"></a><span id="l37.418" class="difflineplus">+      out = &amp;type_tail;</span>
<a href="#l37.419"></a><span id="l37.419" class="difflineplus">+    else if (!PL_strncasecmp(head, &quot;Content-&quot;, 8))</span>
<a href="#l37.420"></a><span id="l37.420" class="difflineplus">+      out = &amp;content_tail;</span>
<a href="#l37.421"></a><span id="l37.421" class="difflineplus">+    else</span>
<a href="#l37.422"></a><span id="l37.422" class="difflineplus">+      out = &amp;message_tail;</span>
<a href="#l37.423"></a><span id="l37.423"> </span>
<a href="#l37.424"></a><span id="l37.424" class="difflineminus">-    while (*tail)</span>
<a href="#l37.425"></a><span id="l37.425" class="difflineminus">-    {</span>
<a href="#l37.426"></a><span id="l37.426" class="difflineminus">-      const char *head = tail;</span>
<a href="#l37.427"></a><span id="l37.427" class="difflineminus">-      char **out;</span>
<a href="#l37.428"></a><span id="l37.428" class="difflineminus">-      while(true) {</span>
<a href="#l37.429"></a><span id="l37.429" class="difflineminus">-      /* Loop until we reach a newline that is not followed by whitespace.</span>
<a href="#l37.430"></a><span id="l37.430" class="difflineminus">-        */</span>
<a href="#l37.431"></a><span id="l37.431" class="difflineminus">-        if (tail[0] == 0 ||</span>
<a href="#l37.432"></a><span id="l37.432" class="difflineminus">-          ((tail[0] == '\r' || tail[0] == '\n') &amp;&amp;</span>
<a href="#l37.433"></a><span id="l37.433" class="difflineminus">-          !(tail[1] == ' ' || tail[1] == '\t' || tail[1] == '\n')))</span>
<a href="#l37.434"></a><span id="l37.434" class="difflineminus">-        {</span>
<a href="#l37.435"></a><span id="l37.435" class="difflineminus">-          /* Swallow the whole newline. */</span>
<a href="#l37.436"></a><span id="l37.436" class="difflineminus">-          if (tail[0] == '\r' &amp;&amp; tail[1] == '\n')</span>
<a href="#l37.437"></a><span id="l37.437" class="difflineminus">-            tail++;</span>
<a href="#l37.438"></a><span id="l37.438" class="difflineminus">-          if (*tail)</span>
<a href="#l37.439"></a><span id="l37.439" class="difflineminus">-            tail++;</span>
<a href="#l37.440"></a><span id="l37.440" class="difflineminus">-          break;</span>
<a href="#l37.441"></a><span id="l37.441" class="difflineminus">-        }</span>
<a href="#l37.442"></a><span id="l37.442" class="difflineminus">-        tail++;</span>
<a href="#l37.443"></a><span id="l37.443" class="difflineminus">-      }</span>
<a href="#l37.444"></a><span id="l37.444" class="difflineplus">+    memcpy(*out, head, (tail - head));</span>
<a href="#l37.445"></a><span id="l37.445" class="difflineplus">+    *out += (tail - head);</span>
<a href="#l37.446"></a><span id="l37.446" class="difflineplus">+  }</span>
<a href="#l37.447"></a><span id="l37.447"> </span>
<a href="#l37.448"></a><span id="l37.448" class="difflineminus">-      /* Decide which block this header goes into.</span>
<a href="#l37.449"></a><span id="l37.449" class="difflineminus">-      */</span>
<a href="#l37.450"></a><span id="l37.450" class="difflineminus">-      if (!PL_strncasecmp(head, &quot;Content-Type:&quot;, 13))</span>
<a href="#l37.451"></a><span id="l37.451" class="difflineminus">-        out = &amp;type_tail;</span>
<a href="#l37.452"></a><span id="l37.452" class="difflineminus">-      else</span>
<a href="#l37.453"></a><span id="l37.453" class="difflineminus">-        if (!PL_strncasecmp(head, &quot;Content-&quot;, 8))</span>
<a href="#l37.454"></a><span id="l37.454" class="difflineminus">-          out = &amp;content_tail;</span>
<a href="#l37.455"></a><span id="l37.455" class="difflineminus">-        else</span>
<a href="#l37.456"></a><span id="l37.456" class="difflineminus">-          out = &amp;message_tail;</span>
<a href="#l37.457"></a><span id="l37.457" class="difflineplus">+  *message_tail = 0;</span>
<a href="#l37.458"></a><span id="l37.458" class="difflineplus">+  *content_tail = 0;</span>
<a href="#l37.459"></a><span id="l37.459" class="difflineplus">+  *type_tail = 0;</span>
<a href="#l37.460"></a><span id="l37.460"> </span>
<a href="#l37.461"></a><span id="l37.461" class="difflineminus">-      memcpy(*out, head, (tail-head));</span>
<a href="#l37.462"></a><span id="l37.462" class="difflineminus">-      *out += (tail-head);</span>
<a href="#l37.463"></a><span id="l37.463" class="difflineminus">-    }</span>
<a href="#l37.464"></a><span id="l37.464" class="difflineplus">+  if (!**message_headers) {</span>
<a href="#l37.465"></a><span id="l37.465" class="difflineplus">+    PR_Free(*message_headers);</span>
<a href="#l37.466"></a><span id="l37.466" class="difflineplus">+    *message_headers = 0;</span>
<a href="#l37.467"></a><span id="l37.467" class="difflineplus">+  }</span>
<a href="#l37.468"></a><span id="l37.468"> </span>
<a href="#l37.469"></a><span id="l37.469" class="difflineminus">-    *message_tail = 0;</span>
<a href="#l37.470"></a><span id="l37.470" class="difflineminus">-    *content_tail = 0;</span>
<a href="#l37.471"></a><span id="l37.471" class="difflineminus">-    *type_tail = 0;</span>
<a href="#l37.472"></a><span id="l37.472" class="difflineminus">-</span>
<a href="#l37.473"></a><span id="l37.473" class="difflineminus">-    if (!**message_headers) {</span>
<a href="#l37.474"></a><span id="l37.474" class="difflineminus">-      PR_Free(*message_headers);</span>
<a href="#l37.475"></a><span id="l37.475" class="difflineminus">-      *message_headers = 0;</span>
<a href="#l37.476"></a><span id="l37.476" class="difflineminus">-    }</span>
<a href="#l37.477"></a><span id="l37.477" class="difflineplus">+  if (!**content_headers) {</span>
<a href="#l37.478"></a><span id="l37.478" class="difflineplus">+    PR_Free(*content_headers);</span>
<a href="#l37.479"></a><span id="l37.479" class="difflineplus">+    *content_headers = 0;</span>
<a href="#l37.480"></a><span id="l37.480" class="difflineplus">+  }</span>
<a href="#l37.481"></a><span id="l37.481"> </span>
<a href="#l37.482"></a><span id="l37.482" class="difflineminus">-    if (!**content_headers) {</span>
<a href="#l37.483"></a><span id="l37.483" class="difflineminus">-      PR_Free(*content_headers);</span>
<a href="#l37.484"></a><span id="l37.484" class="difflineminus">-      *content_headers = 0;</span>
<a href="#l37.485"></a><span id="l37.485" class="difflineminus">-    }</span>
<a href="#l37.486"></a><span id="l37.486" class="difflineminus">-</span>
<a href="#l37.487"></a><span id="l37.487" class="difflineminus">-    if (!**content_type_header) {</span>
<a href="#l37.488"></a><span id="l37.488" class="difflineminus">-      PR_Free(*content_type_header);</span>
<a href="#l37.489"></a><span id="l37.489" class="difflineminus">-      *content_type_header = 0;</span>
<a href="#l37.490"></a><span id="l37.490" class="difflineminus">-    }</span>
<a href="#l37.491"></a><span id="l37.491" class="difflineplus">+  if (!**content_type_header) {</span>
<a href="#l37.492"></a><span id="l37.492" class="difflineplus">+    PR_Free(*content_type_header);</span>
<a href="#l37.493"></a><span id="l37.493" class="difflineplus">+    *content_type_header = 0;</span>
<a href="#l37.494"></a><span id="l37.494" class="difflineplus">+  }</span>
<a href="#l37.495"></a><span id="l37.495"> </span>
<a href="#l37.496"></a><span id="l37.496"> #ifdef DEBUG</span>
<a href="#l37.497"></a><span id="l37.497" class="difflineminus">-    // ### mwelch Because of the extreme difficulty we've had with</span>
<a href="#l37.498"></a><span id="l37.498" class="difflineminus">-    //      duplicate part headers, I'm going to put in an</span>
<a href="#l37.499"></a><span id="l37.499" class="difflineminus">-    //      ASSERT here which makes sure that no duplicate</span>
<a href="#l37.500"></a><span id="l37.500" class="difflineminus">-    //      Content-Type or Content-Transfer-Encoding headers</span>
<a href="#l37.501"></a><span id="l37.501" class="difflineminus">-    //      leave here undetected.</span>
<a href="#l37.502"></a><span id="l37.502" class="difflineminus">-    const char* tmp;</span>
<a href="#l37.503"></a><span id="l37.503" class="difflineminus">-    if (*content_type_header) {</span>
<a href="#l37.504"></a><span id="l37.504" class="difflineminus">-      tmp = PL_strstr(*content_type_header, &quot;Content-Type&quot;);</span>
<a href="#l37.505"></a><span id="l37.505" class="difflineminus">-      if (tmp) {</span>
<a href="#l37.506"></a><span id="l37.506" class="difflineminus">-        tmp++; // get past the first occurrence</span>
<a href="#l37.507"></a><span id="l37.507" class="difflineminus">-        NS_ASSERTION(!PL_strstr(tmp, &quot;Content-Type&quot;), &quot;Content-part already present&quot;);</span>
<a href="#l37.508"></a><span id="l37.508" class="difflineminus">-      }</span>
<a href="#l37.509"></a><span id="l37.509" class="difflineplus">+  // ### mwelch Because of the extreme difficulty we've had with</span>
<a href="#l37.510"></a><span id="l37.510" class="difflineplus">+  //      duplicate part headers, I'm going to put in an</span>
<a href="#l37.511"></a><span id="l37.511" class="difflineplus">+  //      ASSERT here which makes sure that no duplicate</span>
<a href="#l37.512"></a><span id="l37.512" class="difflineplus">+  //      Content-Type or Content-Transfer-Encoding headers</span>
<a href="#l37.513"></a><span id="l37.513" class="difflineplus">+  //      leave here undetected.</span>
<a href="#l37.514"></a><span id="l37.514" class="difflineplus">+  const char *tmp;</span>
<a href="#l37.515"></a><span id="l37.515" class="difflineplus">+  if (*content_type_header) {</span>
<a href="#l37.516"></a><span id="l37.516" class="difflineplus">+    tmp = PL_strstr(*content_type_header, &quot;Content-Type&quot;);</span>
<a href="#l37.517"></a><span id="l37.517" class="difflineplus">+    if (tmp) {</span>
<a href="#l37.518"></a><span id="l37.518" class="difflineplus">+      tmp++;  // get past the first occurrence</span>
<a href="#l37.519"></a><span id="l37.519" class="difflineplus">+      NS_ASSERTION(!PL_strstr(tmp, &quot;Content-Type&quot;),</span>
<a href="#l37.520"></a><span id="l37.520" class="difflineplus">+                   &quot;Content-part already present&quot;);</span>
<a href="#l37.521"></a><span id="l37.521">     }</span>
<a href="#l37.522"></a><span id="l37.522" class="difflineplus">+  }</span>
<a href="#l37.523"></a><span id="l37.523"> </span>
<a href="#l37.524"></a><span id="l37.524" class="difflineminus">-    if (*content_headers) {</span>
<a href="#l37.525"></a><span id="l37.525" class="difflineminus">-      tmp = PL_strstr(*content_headers, &quot;Content-Transfer-Encoding&quot;);</span>
<a href="#l37.526"></a><span id="l37.526" class="difflineminus">-      if (tmp) {</span>
<a href="#l37.527"></a><span id="l37.527" class="difflineminus">-        tmp++; // get past the first occurrence</span>
<a href="#l37.528"></a><span id="l37.528" class="difflineminus">-        NS_ASSERTION(!PL_strstr(tmp, &quot;Content-Transfer-Encoding&quot;), &quot;Content-Transfert already present&quot;);</span>
<a href="#l37.529"></a><span id="l37.529" class="difflineminus">-      }</span>
<a href="#l37.530"></a><span id="l37.530" class="difflineplus">+  if (*content_headers) {</span>
<a href="#l37.531"></a><span id="l37.531" class="difflineplus">+    tmp = PL_strstr(*content_headers, &quot;Content-Transfer-Encoding&quot;);</span>
<a href="#l37.532"></a><span id="l37.532" class="difflineplus">+    if (tmp) {</span>
<a href="#l37.533"></a><span id="l37.533" class="difflineplus">+      tmp++;  // get past the first occurrence</span>
<a href="#l37.534"></a><span id="l37.534" class="difflineplus">+      NS_ASSERTION(!PL_strstr(tmp, &quot;Content-Transfer-Encoding&quot;),</span>
<a href="#l37.535"></a><span id="l37.535" class="difflineplus">+                   &quot;Content-Transfert already present&quot;);</span>
<a href="#l37.536"></a><span id="l37.536">     }</span>
<a href="#l37.537"></a><span id="l37.537" class="difflineminus">-#endif // DEBUG</span>
<a href="#l37.538"></a><span id="l37.538" class="difflineplus">+  }</span>
<a href="#l37.539"></a><span id="l37.539" class="difflineplus">+#endif  // DEBUG</span>
<a href="#l37.540"></a><span id="l37.540"> </span>
<a href="#l37.541"></a><span id="l37.541" class="difflineminus">-    return NS_OK;</span>
<a href="#l37.542"></a><span id="l37.542" class="difflineplus">+  return NS_OK;</span>
<a href="#l37.543"></a><span id="l37.543"> }</span>
<a href="#l37.544"></a><span id="l37.544"> </span>
<a href="#l37.545"></a><span id="l37.545" class="difflineminus">-#define     SKIP_EMPTY_PART   1966</span>
<a href="#l37.546"></a><span id="l37.546" class="difflineplus">+#define SKIP_EMPTY_PART 1966</span>
<a href="#l37.547"></a><span id="l37.547"> </span>
<a href="#l37.548"></a><span id="l37.548" class="difflineminus">-nsresult</span>
<a href="#l37.549"></a><span id="l37.549" class="difflineminus">-nsMsgSendPart::Write()</span>
<a href="#l37.550"></a><span id="l37.550" class="difflineminus">-{</span>
<a href="#l37.551"></a><span id="l37.551" class="difflineplus">+nsresult nsMsgSendPart::Write() {</span>
<a href="#l37.552"></a><span id="l37.552">   nsresult status = NS_OK;</span>
<a href="#l37.553"></a><span id="l37.553" class="difflineminus">-  char    *separator = nullptr;</span>
<a href="#l37.554"></a><span id="l37.554" class="difflineminus">-  bool    needToWriteCRLFAfterEncodedBody  = false;</span>
<a href="#l37.555"></a><span id="l37.555" class="difflineplus">+  char *separator = nullptr;</span>
<a href="#l37.556"></a><span id="l37.556" class="difflineplus">+  bool needToWriteCRLFAfterEncodedBody = false;</span>
<a href="#l37.557"></a><span id="l37.557"> </span>
<a href="#l37.558"></a><span id="l37.558" class="difflineminus">-#define PUSHLEN(str, length)                  \</span>
<a href="#l37.559"></a><span id="l37.559" class="difflineminus">-  do {                            \</span>
<a href="#l37.560"></a><span id="l37.560" class="difflineplus">+#define PUSHLEN(str, length)                                \</span>
<a href="#l37.561"></a><span id="l37.561" class="difflineplus">+  do {                                                      \</span>
<a href="#l37.562"></a><span id="l37.562">     status = mime_write_message_body(m_state, str, length); \</span>
<a href="#l37.563"></a><span id="l37.563" class="difflineminus">-    if (NS_FAILED(status)) goto FAIL;                \</span>
<a href="#l37.564"></a><span id="l37.564" class="difflineminus">-  } while (0)                         \</span>
<a href="#l37.565"></a><span id="l37.565" class="difflineplus">+    if (NS_FAILED(status)) goto FAIL;                       \</span>
<a href="#l37.566"></a><span id="l37.566" class="difflineplus">+  } while (0)</span>
<a href="#l37.567"></a><span id="l37.567"> </span>
<a href="#l37.568"></a><span id="l37.568"> #define PUSH(str) PUSHLEN(str, PL_strlen(str))</span>
<a href="#l37.569"></a><span id="l37.569"> </span>
<a href="#l37.570"></a><span id="l37.570">   // rhp: Suppress the output of parts that are empty!</span>
<a href="#l37.571"></a><span id="l37.571" class="difflineminus">-  if ( (m_parent) &amp;&amp;</span>
<a href="#l37.572"></a><span id="l37.572" class="difflineminus">-       (m_numchildren == 0) &amp;&amp;</span>
<a href="#l37.573"></a><span id="l37.573" class="difflineminus">-       ( (!m_buffer) || (!*m_buffer) ) &amp;&amp;</span>
<a href="#l37.574"></a><span id="l37.574" class="difflineminus">-       (!m_file) &amp;&amp;</span>
<a href="#l37.575"></a><span id="l37.575" class="difflineminus">-       (!m_mainpart) )</span>
<a href="#l37.576"></a><span id="l37.576" class="difflineplus">+  if ((m_parent) &amp;&amp; (m_numchildren == 0) &amp;&amp; ((!m_buffer) || (!*m_buffer)) &amp;&amp;</span>
<a href="#l37.577"></a><span id="l37.577" class="difflineplus">+      (!m_file) &amp;&amp; (!m_mainpart))</span>
<a href="#l37.578"></a><span id="l37.578">     // XXX SKIP_EMPTY_PART (= 1966) is not a valid nsresult</span>
<a href="#l37.579"></a><span id="l37.579">     return static_cast&lt;nsresult&gt;(SKIP_EMPTY_PART);</span>
<a href="#l37.580"></a><span id="l37.580"> </span>
<a href="#l37.581"></a><span id="l37.581" class="difflineminus">-  if (m_mainpart &amp;&amp; m_type &amp;&amp; PL_strcmp(m_type, TEXT_HTML) == 0)</span>
<a href="#l37.582"></a><span id="l37.582" class="difflineminus">-  {</span>
<a href="#l37.583"></a><span id="l37.583" class="difflineminus">-    if (m_file)</span>
<a href="#l37.584"></a><span id="l37.584" class="difflineminus">-    {</span>
<a href="#l37.585"></a><span id="l37.585" class="difflineplus">+  if (m_mainpart &amp;&amp; m_type &amp;&amp; PL_strcmp(m_type, TEXT_HTML) == 0) {</span>
<a href="#l37.586"></a><span id="l37.586" class="difflineplus">+    if (m_file) {</span>
<a href="#l37.587"></a><span id="l37.587">       // The &quot;insert HTML links&quot; code requires a memory buffer,</span>
<a href="#l37.588"></a><span id="l37.588">       // so read the file into memory.</span>
<a href="#l37.589"></a><span id="l37.589">       NS_ASSERTION(m_buffer == nullptr, &quot;not-null buffer&quot;);</span>
<a href="#l37.590"></a><span id="l37.590" class="difflineminus">-      int32_t           length = 0;</span>
<a href="#l37.591"></a><span id="l37.591" class="difflineplus">+      int32_t length = 0;</span>
<a href="#l37.592"></a><span id="l37.592">       int64_t fileSize;</span>
<a href="#l37.593"></a><span id="l37.593" class="difflineminus">-      if (NS_SUCCEEDED(m_file-&gt;GetFileSize(&amp;fileSize)))</span>
<a href="#l37.594"></a><span id="l37.594" class="difflineminus">-          length = fileSize;</span>
<a href="#l37.595"></a><span id="l37.595" class="difflineplus">+      if (NS_SUCCEEDED(m_file-&gt;GetFileSize(&amp;fileSize))) length = fileSize;</span>
<a href="#l37.596"></a><span id="l37.596"> </span>
<a href="#l37.597"></a><span id="l37.597" class="difflineminus">-      m_buffer = (char *) PR_Malloc(sizeof(char) * (length + 1));</span>
<a href="#l37.598"></a><span id="l37.598" class="difflineminus">-      if (m_buffer)</span>
<a href="#l37.599"></a><span id="l37.599" class="difflineminus">-      {</span>
<a href="#l37.600"></a><span id="l37.600" class="difflineplus">+      m_buffer = (char *)PR_Malloc(sizeof(char) * (length + 1));</span>
<a href="#l37.601"></a><span id="l37.601" class="difflineplus">+      if (m_buffer) {</span>
<a href="#l37.602"></a><span id="l37.602">         nsCOMPtr&lt;nsIInputStream&gt; inputFile;</span>
<a href="#l37.603"></a><span id="l37.603" class="difflineminus">-        nsresult rv = NS_NewLocalFileInputStream(getter_AddRefs(inputFile), m_file);</span>
<a href="#l37.604"></a><span id="l37.604" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l37.605"></a><span id="l37.605" class="difflineminus">-        {</span>
<a href="#l37.606"></a><span id="l37.606" class="difflineplus">+        nsresult rv =</span>
<a href="#l37.607"></a><span id="l37.607" class="difflineplus">+            NS_NewLocalFileInputStream(getter_AddRefs(inputFile), m_file);</span>
<a href="#l37.608"></a><span id="l37.608" class="difflineplus">+        if (NS_SUCCEEDED(rv)) {</span>
<a href="#l37.609"></a><span id="l37.609">           uint32_t bytesRead;</span>
<a href="#l37.610"></a><span id="l37.610">           rv = inputFile-&gt;Read(m_buffer, length, &amp;bytesRead);</span>
<a href="#l37.611"></a><span id="l37.611">           inputFile-&gt;Close();</span>
<a href="#l37.612"></a><span id="l37.612">           m_buffer[length] = '\0';</span>
<a href="#l37.613"></a><span id="l37.613" class="difflineminus">-        }</span>
<a href="#l37.614"></a><span id="l37.614" class="difflineminus">-        else</span>
<a href="#l37.615"></a><span id="l37.615" class="difflineplus">+        } else</span>
<a href="#l37.616"></a><span id="l37.616">           PR_Free(m_buffer);</span>
<a href="#l37.617"></a><span id="l37.617">       }</span>
<a href="#l37.618"></a><span id="l37.618">     }</span>
<a href="#l37.619"></a><span id="l37.619">   }</span>
<a href="#l37.620"></a><span id="l37.620"> </span>
<a href="#l37.621"></a><span id="l37.621">   if (m_parent &amp;&amp; m_parent-&gt;m_type &amp;&amp;</span>
<a href="#l37.622"></a><span id="l37.622" class="difflineminus">-        !PL_strcasecmp(m_parent-&gt;m_type, MULTIPART_DIGEST) &amp;&amp;</span>
<a href="#l37.623"></a><span id="l37.623" class="difflineminus">-        m_type &amp;&amp;</span>
<a href="#l37.624"></a><span id="l37.624" class="difflineminus">-        (!PL_strcasecmp(m_type, MESSAGE_RFC822) ||</span>
<a href="#l37.625"></a><span id="l37.625" class="difflineminus">-        !PL_strcasecmp(m_type, MESSAGE_NEWS)))</span>
<a href="#l37.626"></a><span id="l37.626" class="difflineminus">-  {</span>
<a href="#l37.627"></a><span id="l37.627" class="difflineplus">+      !PL_strcasecmp(m_parent-&gt;m_type, MULTIPART_DIGEST) &amp;&amp; m_type &amp;&amp;</span>
<a href="#l37.628"></a><span id="l37.628" class="difflineplus">+      (!PL_strcasecmp(m_type, MESSAGE_RFC822) ||</span>
<a href="#l37.629"></a><span id="l37.629" class="difflineplus">+       !PL_strcasecmp(m_type, MESSAGE_NEWS))) {</span>
<a href="#l37.630"></a><span id="l37.630">     // If we're in a multipart/digest, and this document is of type</span>
<a href="#l37.631"></a><span id="l37.631">     // message/rfc822, then it's appropriate to emit no headers.</span>
<a href="#l37.632"></a><span id="l37.632">     //</span>
<a href="#l37.633"></a><span id="l37.633" class="difflineminus">-  }</span>
<a href="#l37.634"></a><span id="l37.634" class="difflineminus">-  else</span>
<a href="#l37.635"></a><span id="l37.635" class="difflineminus">-  {</span>
<a href="#l37.636"></a><span id="l37.636" class="difflineplus">+  } else {</span>
<a href="#l37.637"></a><span id="l37.637">     char *message_headers = 0;</span>
<a href="#l37.638"></a><span id="l37.638">     char *content_headers = 0;</span>
<a href="#l37.639"></a><span id="l37.639">     char *content_type_header = 0;</span>
<a href="#l37.640"></a><span id="l37.640" class="difflineminus">-    status = divide_content_headers(m_other,</span>
<a href="#l37.641"></a><span id="l37.641" class="difflineminus">-                                    &amp;message_headers,</span>
<a href="#l37.642"></a><span id="l37.642" class="difflineminus">-                                    &amp;content_headers,</span>
<a href="#l37.643"></a><span id="l37.643" class="difflineplus">+    status = divide_content_headers(m_other, &amp;message_headers, &amp;content_headers,</span>
<a href="#l37.644"></a><span id="l37.644">                                     &amp;content_type_header);</span>
<a href="#l37.645"></a><span id="l37.645" class="difflineminus">-    if (NS_FAILED(status))</span>
<a href="#l37.646"></a><span id="l37.646" class="difflineminus">-      goto FAIL;</span>
<a href="#l37.647"></a><span id="l37.647" class="difflineplus">+    if (NS_FAILED(status)) goto FAIL;</span>
<a href="#l37.648"></a><span id="l37.648"> </span>
<a href="#l37.649"></a><span id="l37.649" class="difflineminus">-      /* First, write out all of the headers that refer to the message</span>
<a href="#l37.650"></a><span id="l37.650" class="difflineminus">-      itself (From, Subject, MIME-Version, etc.)</span>
<a href="#l37.651"></a><span id="l37.651" class="difflineminus">-    */</span>
<a href="#l37.652"></a><span id="l37.652" class="difflineminus">-    if (message_headers)</span>
<a href="#l37.653"></a><span id="l37.653" class="difflineminus">-    {</span>
<a href="#l37.654"></a><span id="l37.654" class="difflineplus">+    // First, write out all of the headers that refer to the message</span>
<a href="#l37.655"></a><span id="l37.655" class="difflineplus">+    // itself (From, Subject, MIME-Version, etc.)</span>
<a href="#l37.656"></a><span id="l37.656" class="difflineplus">+    if (message_headers) {</span>
<a href="#l37.657"></a><span id="l37.657">       PUSH(message_headers);</span>
<a href="#l37.658"></a><span id="l37.658">       PR_Free(message_headers);</span>
<a href="#l37.659"></a><span id="l37.659">       message_headers = 0;</span>
<a href="#l37.660"></a><span id="l37.660">     }</span>
<a href="#l37.661"></a><span id="l37.661"> </span>
<a href="#l37.662"></a><span id="l37.662" class="difflineminus">-    /* Now allow the crypto library to (potentially) insert some text</span>
<a href="#l37.663"></a><span id="l37.663" class="difflineminus">-       (it may want to wrap the body in an envelope.)           */</span>
<a href="#l37.664"></a><span id="l37.664" class="difflineplus">+    // Now allow the crypto library to (potentially) insert some text</span>
<a href="#l37.665"></a><span id="l37.665" class="difflineplus">+    // (it may want to wrap the body in an envelope.)</span>
<a href="#l37.666"></a><span id="l37.666">     if (!m_parent) {</span>
<a href="#l37.667"></a><span id="l37.667">       status = m_state-&gt;BeginCryptoEncapsulation();</span>
<a href="#l37.668"></a><span id="l37.668">       if (NS_FAILED(status)) goto FAIL;</span>
<a href="#l37.669"></a><span id="l37.669">     }</span>
<a href="#l37.670"></a><span id="l37.670"> </span>
<a href="#l37.671"></a><span id="l37.671">     /* Now make sure there's a Content-Type header.</span>
<a href="#l37.672"></a><span id="l37.672" class="difflineminus">-    */</span>
<a href="#l37.673"></a><span id="l37.673" class="difflineminus">-    if (!content_type_header)</span>
<a href="#l37.674"></a><span id="l37.674" class="difflineminus">-    {</span>
<a href="#l37.675"></a><span id="l37.675" class="difflineplus">+     */</span>
<a href="#l37.676"></a><span id="l37.676" class="difflineplus">+    if (!content_type_header) {</span>
<a href="#l37.677"></a><span id="l37.677">       NS_ASSERTION(m_type &amp;&amp; *m_type, &quot;null ptr&quot;);</span>
<a href="#l37.678"></a><span id="l37.678">       bool needsCharset = mime_type_needs_charset(m_type ? m_type : TEXT_PLAIN);</span>
<a href="#l37.679"></a><span id="l37.679" class="difflineminus">-      if (needsCharset)</span>
<a href="#l37.680"></a><span id="l37.680" class="difflineminus">-      {</span>
<a href="#l37.681"></a><span id="l37.681" class="difflineminus">-        content_type_header = PR_smprintf(&quot;Content-Type: %s; charset=%s&quot; CRLF,</span>
<a href="#l37.682"></a><span id="l37.682" class="difflineminus">-                                          (m_type ? m_type : TEXT_PLAIN), m_charset_name);</span>
<a href="#l37.683"></a><span id="l37.683" class="difflineminus">-      }</span>
<a href="#l37.684"></a><span id="l37.684" class="difflineminus">-      else</span>
<a href="#l37.685"></a><span id="l37.685" class="difflineplus">+      if (needsCharset) {</span>
<a href="#l37.686"></a><span id="l37.686" class="difflineplus">+        content_type_header =</span>
<a href="#l37.687"></a><span id="l37.687" class="difflineplus">+            PR_smprintf(&quot;Content-Type: %s; charset=%s&quot; CRLF,</span>
<a href="#l37.688"></a><span id="l37.688" class="difflineplus">+                        (m_type ? m_type : TEXT_PLAIN), m_charset_name);</span>
<a href="#l37.689"></a><span id="l37.689" class="difflineplus">+      } else</span>
<a href="#l37.690"></a><span id="l37.690">         content_type_header = PR_smprintf(&quot;Content-Type: %s&quot; CRLF,</span>
<a href="#l37.691"></a><span id="l37.691">                                           (m_type ? m_type : TEXT_PLAIN));</span>
<a href="#l37.692"></a><span id="l37.692" class="difflineminus">-      if (!content_type_header)</span>
<a href="#l37.693"></a><span id="l37.693" class="difflineminus">-      {</span>
<a href="#l37.694"></a><span id="l37.694" class="difflineminus">-        if (content_headers)</span>
<a href="#l37.695"></a><span id="l37.695" class="difflineminus">-          PR_Free(content_headers);</span>
<a href="#l37.696"></a><span id="l37.696" class="difflineplus">+      if (!content_type_header) {</span>
<a href="#l37.697"></a><span id="l37.697" class="difflineplus">+        if (content_headers) PR_Free(content_headers);</span>
<a href="#l37.698"></a><span id="l37.698">         status = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l37.699"></a><span id="l37.699">         goto FAIL;</span>
<a href="#l37.700"></a><span id="l37.700">       }</span>
<a href="#l37.701"></a><span id="l37.701">     }</span>
<a href="#l37.702"></a><span id="l37.702"> </span>
<a href="#l37.703"></a><span id="l37.703">     /* If this is a compound object, tack a boundary string onto the</span>
<a href="#l37.704"></a><span id="l37.704">     Content-Type header. this</span>
<a href="#l37.705"></a><span id="l37.705">     */</span>
<a href="#l37.706"></a><span id="l37.706" class="difflineminus">-    if (m_numchildren &gt; 0)</span>
<a href="#l37.707"></a><span id="l37.707" class="difflineminus">-    {</span>
<a href="#l37.708"></a><span id="l37.708" class="difflineplus">+    if (m_numchildren &gt; 0) {</span>
<a href="#l37.709"></a><span id="l37.709">       int L;</span>
<a href="#l37.710"></a><span id="l37.710">       char *ct2;</span>
<a href="#l37.711"></a><span id="l37.711">       NS_ASSERTION(m_type, &quot;null ptr&quot;);</span>
<a href="#l37.712"></a><span id="l37.712"> </span>
<a href="#l37.713"></a><span id="l37.713" class="difflineminus">-      if (!separator)</span>
<a href="#l37.714"></a><span id="l37.714" class="difflineminus">-      {</span>
<a href="#l37.715"></a><span id="l37.715" class="difflineplus">+      if (!separator) {</span>
<a href="#l37.716"></a><span id="l37.716">         separator = mime_make_separator(&quot;&quot;);</span>
<a href="#l37.717"></a><span id="l37.717" class="difflineminus">-        if (!separator)</span>
<a href="#l37.718"></a><span id="l37.718" class="difflineminus">-        {</span>
<a href="#l37.719"></a><span id="l37.719" class="difflineplus">+        if (!separator) {</span>
<a href="#l37.720"></a><span id="l37.720">           status = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l37.721"></a><span id="l37.721">           goto FAIL;</span>
<a href="#l37.722"></a><span id="l37.722">         }</span>
<a href="#l37.723"></a><span id="l37.723">       }</span>
<a href="#l37.724"></a><span id="l37.724"> </span>
<a href="#l37.725"></a><span id="l37.725">       L = PL_strlen(content_type_header);</span>
<a href="#l37.726"></a><span id="l37.726"> </span>
<a href="#l37.727"></a><span id="l37.727" class="difflineminus">-      if (content_type_header[L-1] == '\n')</span>
<a href="#l37.728"></a><span id="l37.728" class="difflineminus">-        content_type_header[--L] = 0;</span>
<a href="#l37.729"></a><span id="l37.729" class="difflineminus">-      if (content_type_header[L-1] == '\r')</span>
<a href="#l37.730"></a><span id="l37.730" class="difflineminus">-        content_type_header[--L] = 0;</span>
<a href="#l37.731"></a><span id="l37.731" class="difflineplus">+      if (content_type_header[L - 1] == '\n') content_type_header[--L] = 0;</span>
<a href="#l37.732"></a><span id="l37.732" class="difflineplus">+      if (content_type_header[L - 1] == '\r') content_type_header[--L] = 0;</span>
<a href="#l37.733"></a><span id="l37.733"> </span>
<a href="#l37.734"></a><span id="l37.734" class="difflineminus">-      ct2 = PR_smprintf(&quot;%s;\r\n boundary=\&quot;%s\&quot;&quot; CRLF, content_type_header, separator);</span>
<a href="#l37.735"></a><span id="l37.735" class="difflineplus">+      ct2 = PR_smprintf(&quot;%s;\r\n boundary=\&quot;%s\&quot;&quot; CRLF, content_type_header,</span>
<a href="#l37.736"></a><span id="l37.736" class="difflineplus">+                        separator);</span>
<a href="#l37.737"></a><span id="l37.737">       PR_Free(content_type_header);</span>
<a href="#l37.738"></a><span id="l37.738" class="difflineminus">-      if (!ct2)</span>
<a href="#l37.739"></a><span id="l37.739" class="difflineminus">-      {</span>
<a href="#l37.740"></a><span id="l37.740" class="difflineminus">-        if (content_headers)</span>
<a href="#l37.741"></a><span id="l37.741" class="difflineminus">-          PR_Free(content_headers);</span>
<a href="#l37.742"></a><span id="l37.742" class="difflineplus">+      if (!ct2) {</span>
<a href="#l37.743"></a><span id="l37.743" class="difflineplus">+        if (content_headers) PR_Free(content_headers);</span>
<a href="#l37.744"></a><span id="l37.744">         status = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l37.745"></a><span id="l37.745">         goto FAIL;</span>
<a href="#l37.746"></a><span id="l37.746">       }</span>
<a href="#l37.747"></a><span id="l37.747"> </span>
<a href="#l37.748"></a><span id="l37.748">       content_type_header = ct2;</span>
<a href="#l37.749"></a><span id="l37.749">     }</span>
<a href="#l37.750"></a><span id="l37.750"> </span>
<a href="#l37.751"></a><span id="l37.751">     // Now write out the Content-Type header...</span>
<a href="#l37.752"></a><span id="l37.752">     NS_ASSERTION(content_type_header &amp;&amp; *content_type_header, &quot;null ptr&quot;);</span>
<a href="#l37.753"></a><span id="l37.753">     PUSH(content_type_header);</span>
<a href="#l37.754"></a><span id="l37.754">     PR_Free(content_type_header);</span>
<a href="#l37.755"></a><span id="l37.755">     content_type_header = 0;</span>
<a href="#l37.756"></a><span id="l37.756"> </span>
<a href="#l37.757"></a><span id="l37.757">     /* ...followed by all of the other headers that refer to the body of</span>
<a href="#l37.758"></a><span id="l37.758">     the message (Content-Transfer-Encoding, Content-Dispositon, etc.)</span>
<a href="#l37.759"></a><span id="l37.759">     */</span>
<a href="#l37.760"></a><span id="l37.760" class="difflineminus">-    if (content_headers)</span>
<a href="#l37.761"></a><span id="l37.761" class="difflineminus">-    {</span>
<a href="#l37.762"></a><span id="l37.762" class="difflineplus">+    if (content_headers) {</span>
<a href="#l37.763"></a><span id="l37.763">       PUSH(content_headers);</span>
<a href="#l37.764"></a><span id="l37.764">       PR_Free(content_headers);</span>
<a href="#l37.765"></a><span id="l37.765">       content_headers = 0;</span>
<a href="#l37.766"></a><span id="l37.766">     }</span>
<a href="#l37.767"></a><span id="l37.767">   }</span>
<a href="#l37.768"></a><span id="l37.768"> </span>
<a href="#l37.769"></a><span id="l37.769" class="difflineminus">-  PUSH(CRLF);         // A blank line, to mark the end of headers.</span>
<a href="#l37.770"></a><span id="l37.770" class="difflineplus">+  PUSH(CRLF);  // A blank line, to mark the end of headers.</span>
<a href="#l37.771"></a><span id="l37.771"> </span>
<a href="#l37.772"></a><span id="l37.772">   m_firstBlock = true;</span>
<a href="#l37.773"></a><span id="l37.773">   /* only convert if we need to tag charset */</span>
<a href="#l37.774"></a><span id="l37.774">   m_needIntlConversion = mime_type_needs_charset(m_type);</span>
<a href="#l37.775"></a><span id="l37.775"> </span>
<a href="#l37.776"></a><span id="l37.776" class="difflineminus">-  if (m_buffer)</span>
<a href="#l37.777"></a><span id="l37.777" class="difflineminus">-  {</span>
<a href="#l37.778"></a><span id="l37.778" class="difflineplus">+  if (m_buffer) {</span>
<a href="#l37.779"></a><span id="l37.779">     status = PushBody(m_buffer, PL_strlen(m_buffer));</span>
<a href="#l37.780"></a><span id="l37.780" class="difflineminus">-    if (NS_FAILED(status))</span>
<a href="#l37.781"></a><span id="l37.781" class="difflineminus">-      goto FAIL;</span>
<a href="#l37.782"></a><span id="l37.782" class="difflineminus">-  }</span>
<a href="#l37.783"></a><span id="l37.783" class="difflineminus">-  else if (m_file)</span>
<a href="#l37.784"></a><span id="l37.784" class="difflineminus">-  {</span>
<a href="#l37.785"></a><span id="l37.785" class="difflineplus">+    if (NS_FAILED(status)) goto FAIL;</span>
<a href="#l37.786"></a><span id="l37.786" class="difflineplus">+  } else if (m_file) {</span>
<a href="#l37.787"></a><span id="l37.787">     nsCOMPtr&lt;nsIInputStream&gt; inputStream;</span>
<a href="#l37.788"></a><span id="l37.788" class="difflineminus">-    nsresult rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream), m_file);</span>
<a href="#l37.789"></a><span id="l37.789" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l37.790"></a><span id="l37.790" class="difflineminus">-    {</span>
<a href="#l37.791"></a><span id="l37.791" class="difflineplus">+    nsresult rv =</span>
<a href="#l37.792"></a><span id="l37.792" class="difflineplus">+        NS_NewLocalFileInputStream(getter_AddRefs(inputStream), m_file);</span>
<a href="#l37.793"></a><span id="l37.793" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l37.794"></a><span id="l37.794">       // mysteriously disappearing?</span>
<a href="#l37.795"></a><span id="l37.795">       nsCOMPtr&lt;nsIMsgSendReport&gt; sendReport;</span>
<a href="#l37.796"></a><span id="l37.796">       m_state-&gt;GetSendReport(getter_AddRefs(sendReport));</span>
<a href="#l37.797"></a><span id="l37.797" class="difflineminus">-      if (sendReport)</span>
<a href="#l37.798"></a><span id="l37.798" class="difflineminus">-      {</span>
<a href="#l37.799"></a><span id="l37.799" class="difflineplus">+      if (sendReport) {</span>
<a href="#l37.800"></a><span id="l37.800">         nsAutoString error_msg;</span>
<a href="#l37.801"></a><span id="l37.801">         nsMsgBuildMessageWithTmpFile(m_file, error_msg);</span>
<a href="#l37.802"></a><span id="l37.802" class="difflineminus">-        sendReport-&gt;SetMessage(nsIMsgSendReport::process_Current, error_msg.get(), false);</span>
<a href="#l37.803"></a><span id="l37.803" class="difflineplus">+        sendReport-&gt;SetMessage(nsIMsgSendReport::process_Current,</span>
<a href="#l37.804"></a><span id="l37.804" class="difflineplus">+                               error_msg.get(), false);</span>
<a href="#l37.805"></a><span id="l37.805">       }</span>
<a href="#l37.806"></a><span id="l37.806">       status = NS_MSG_UNABLE_TO_OPEN_TMP_FILE;</span>
<a href="#l37.807"></a><span id="l37.807">       goto FAIL;</span>
<a href="#l37.808"></a><span id="l37.808">     }</span>
<a href="#l37.809"></a><span id="l37.809"> </span>
<a href="#l37.810"></a><span id="l37.810">     nsCString curLine;</span>
<a href="#l37.811"></a><span id="l37.811">     bool more = true;</span>
<a href="#l37.812"></a><span id="l37.812"> </span>
<a href="#l37.813"></a><span id="l37.813">     /* Kludge to avoid having to allocate memory on the toy computers... */</span>
<a href="#l37.814"></a><span id="l37.814" class="difflineminus">-    if (!mime_mailto_stream_read_buffer)</span>
<a href="#l37.815"></a><span id="l37.815" class="difflineminus">-    {</span>
<a href="#l37.816"></a><span id="l37.816" class="difflineminus">-      mime_mailto_stream_read_buffer = (char *) PR_Malloc(MIME_BUFFER_SIZE);</span>
<a href="#l37.817"></a><span id="l37.817" class="difflineminus">-      if (!mime_mailto_stream_read_buffer)</span>
<a href="#l37.818"></a><span id="l37.818" class="difflineminus">-      {</span>
<a href="#l37.819"></a><span id="l37.819" class="difflineplus">+    if (!mime_mailto_stream_read_buffer) {</span>
<a href="#l37.820"></a><span id="l37.820" class="difflineplus">+      mime_mailto_stream_read_buffer = (char *)PR_Malloc(MIME_BUFFER_SIZE);</span>
<a href="#l37.821"></a><span id="l37.821" class="difflineplus">+      if (!mime_mailto_stream_read_buffer) {</span>
<a href="#l37.822"></a><span id="l37.822">         status = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l37.823"></a><span id="l37.823">         goto FAIL;</span>
<a href="#l37.824"></a><span id="l37.824">       }</span>
<a href="#l37.825"></a><span id="l37.825">     }</span>
<a href="#l37.826"></a><span id="l37.826"> </span>
<a href="#l37.827"></a><span id="l37.827" class="difflineminus">-    char    *buffer = mime_mailto_stream_read_buffer;</span>
<a href="#l37.828"></a><span id="l37.828" class="difflineminus">-    if (m_strip_sensitive_headers)</span>
<a href="#l37.829"></a><span id="l37.829" class="difflineminus">-    {</span>
<a href="#l37.830"></a><span id="l37.830" class="difflineplus">+    char *buffer = mime_mailto_stream_read_buffer;</span>
<a href="#l37.831"></a><span id="l37.831" class="difflineplus">+    if (m_strip_sensitive_headers) {</span>
<a href="#l37.832"></a><span id="l37.832">       // We are attaching a message, so we should be careful to</span>
<a href="#l37.833"></a><span id="l37.833">       // strip out certain sensitive internal header fields.</span>
<a href="#l37.834"></a><span id="l37.834">       bool skipping = false;</span>
<a href="#l37.835"></a><span id="l37.835">       nsAutoPtr&lt;nsLineBuffer&lt;char&gt; &gt; lineBuffer(new nsLineBuffer&lt;char&gt;);</span>
<a href="#l37.836"></a><span id="l37.836">       NS_ENSURE_TRUE(lineBuffer, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l37.837"></a><span id="l37.837"> </span>
<a href="#l37.838"></a><span id="l37.838" class="difflineminus">-      while (more)</span>
<a href="#l37.839"></a><span id="l37.839" class="difflineminus">-      {</span>
<a href="#l37.840"></a><span id="l37.840" class="difflineplus">+      while (more) {</span>
<a href="#l37.841"></a><span id="l37.841">         // NS_ReadLine doesn't return line termination chars.</span>
<a href="#l37.842"></a><span id="l37.842">         rv = NS_ReadLine(inputStream.get(), lineBuffer.get(), curLine, &amp;more);</span>
<a href="#l37.843"></a><span id="l37.843"> </span>
<a href="#l37.844"></a><span id="l37.844">         curLine.Append(CRLF);</span>
<a href="#l37.845"></a><span id="l37.845"> </span>
<a href="#l37.846"></a><span id="l37.846" class="difflineminus">-        char *line = (char *) curLine.get();</span>
<a href="#l37.847"></a><span id="l37.847" class="difflineplus">+        char *line = (char *)curLine.get();</span>
<a href="#l37.848"></a><span id="l37.848">         if (skipping) {</span>
<a href="#l37.849"></a><span id="l37.849">           if (*line == ' ' || *line == '\t')</span>
<a href="#l37.850"></a><span id="l37.850">             continue;</span>
<a href="#l37.851"></a><span id="l37.851">           else</span>
<a href="#l37.852"></a><span id="l37.852">             skipping = false;</span>
<a href="#l37.853"></a><span id="l37.853">         }</span>
<a href="#l37.854"></a><span id="l37.854"> </span>
<a href="#l37.855"></a><span id="l37.855">         if (!PL_strncasecmp(line, &quot;From -&quot;, 6) ||</span>
<a href="#l37.856"></a><span id="l37.856">             !PL_strncasecmp(line, &quot;BCC:&quot;, 4) ||</span>
<a href="#l37.857"></a><span id="l37.857">             !PL_strncasecmp(line, &quot;FCC:&quot;, 4) ||</span>
<a href="#l37.858"></a><span id="l37.858" class="difflineminus">-            !PL_strncasecmp(line, CONTENT_LENGTH &quot;:&quot;, CONTENT_LENGTH_LEN+1) ||</span>
<a href="#l37.859"></a><span id="l37.859" class="difflineplus">+            !PL_strncasecmp(line, CONTENT_LENGTH &quot;:&quot;, CONTENT_LENGTH_LEN + 1) ||</span>
<a href="#l37.860"></a><span id="l37.860">             !PL_strncasecmp(line, &quot;Lines:&quot;, 6) ||</span>
<a href="#l37.861"></a><span id="l37.861">             !PL_strncasecmp(line, &quot;Status:&quot;, 7) ||</span>
<a href="#l37.862"></a><span id="l37.862" class="difflineminus">-            !PL_strncasecmp(line, X_MOZILLA_STATUS &quot;:&quot;, X_MOZILLA_STATUS_LEN+1) ||</span>
<a href="#l37.863"></a><span id="l37.863" class="difflineminus">-            !PL_strncasecmp(line, X_MOZILLA_STATUS2 &quot;:&quot;, X_MOZILLA_STATUS2_LEN+1) ||</span>
<a href="#l37.864"></a><span id="l37.864" class="difflineminus">-            !PL_strncasecmp(line, X_MOZILLA_DRAFT_INFO &quot;:&quot;, X_MOZILLA_DRAFT_INFO_LEN+1) ||</span>
<a href="#l37.865"></a><span id="l37.865" class="difflineminus">-            !PL_strncasecmp(line, X_MOZILLA_NEWSHOST &quot;:&quot;, X_MOZILLA_NEWSHOST_LEN+1) ||</span>
<a href="#l37.866"></a><span id="l37.866" class="difflineminus">-            !PL_strncasecmp(line, X_UIDL &quot;:&quot;, X_UIDL_LEN+1) ||</span>
<a href="#l37.867"></a><span id="l37.867" class="difflineplus">+            !PL_strncasecmp(line, X_MOZILLA_STATUS &quot;:&quot;,</span>
<a href="#l37.868"></a><span id="l37.868" class="difflineplus">+                            X_MOZILLA_STATUS_LEN + 1) ||</span>
<a href="#l37.869"></a><span id="l37.869" class="difflineplus">+            !PL_strncasecmp(line, X_MOZILLA_STATUS2 &quot;:&quot;,</span>
<a href="#l37.870"></a><span id="l37.870" class="difflineplus">+                            X_MOZILLA_STATUS2_LEN + 1) ||</span>
<a href="#l37.871"></a><span id="l37.871" class="difflineplus">+            !PL_strncasecmp(line, X_MOZILLA_DRAFT_INFO &quot;:&quot;,</span>
<a href="#l37.872"></a><span id="l37.872" class="difflineplus">+                            X_MOZILLA_DRAFT_INFO_LEN + 1) ||</span>
<a href="#l37.873"></a><span id="l37.873" class="difflineplus">+            !PL_strncasecmp(line, X_MOZILLA_NEWSHOST &quot;:&quot;,</span>
<a href="#l37.874"></a><span id="l37.874" class="difflineplus">+                            X_MOZILLA_NEWSHOST_LEN + 1) ||</span>
<a href="#l37.875"></a><span id="l37.875" class="difflineplus">+            !PL_strncasecmp(line, X_UIDL &quot;:&quot;, X_UIDL_LEN + 1) ||</span>
<a href="#l37.876"></a><span id="l37.876">             !PL_strncasecmp(line, &quot;X-VM-&quot;, 5)) /* hi Kyle */</span>
<a href="#l37.877"></a><span id="l37.877">         {</span>
<a href="#l37.878"></a><span id="l37.878">           skipping = true;</span>
<a href="#l37.879"></a><span id="l37.879">           continue;</span>
<a href="#l37.880"></a><span id="l37.880">         }</span>
<a href="#l37.881"></a><span id="l37.881"> </span>
<a href="#l37.882"></a><span id="l37.882">         PUSH(line);</span>
<a href="#l37.883"></a><span id="l37.883"> </span>
<a href="#l37.884"></a><span id="l37.884">         if (curLine.Length() == 2) {</span>
<a href="#l37.885"></a><span id="l37.885" class="difflineminus">-          nsCOMPtr &lt;nsISeekableStream&gt; seekableStream = do_QueryInterface(inputStream);</span>
<a href="#l37.886"></a><span id="l37.886" class="difflineplus">+          nsCOMPtr&lt;nsISeekableStream&gt; seekableStream =</span>
<a href="#l37.887"></a><span id="l37.887" class="difflineplus">+              do_QueryInterface(inputStream);</span>
<a href="#l37.888"></a><span id="l37.888">           // seek back the amount of data left in the line buffer...</span>
<a href="#l37.889"></a><span id="l37.889" class="difflineminus">-          seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_CUR, lineBuffer-&gt;start - lineBuffer-&gt;end);</span>
<a href="#l37.890"></a><span id="l37.890" class="difflineplus">+          seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_CUR,</span>
<a href="#l37.891"></a><span id="l37.891" class="difflineplus">+                               lineBuffer-&gt;start - lineBuffer-&gt;end);</span>
<a href="#l37.892"></a><span id="l37.892">           break;  // Now can do normal reads for the body.</span>
<a href="#l37.893"></a><span id="l37.893">         }</span>
<a href="#l37.894"></a><span id="l37.894">       }</span>
<a href="#l37.895"></a><span id="l37.895">       lineBuffer = nullptr;</span>
<a href="#l37.896"></a><span id="l37.896">     }</span>
<a href="#l37.897"></a><span id="l37.897"> </span>
<a href="#l37.898"></a><span id="l37.898" class="difflineminus">-    while (NS_SUCCEEDED(status))</span>
<a href="#l37.899"></a><span id="l37.899" class="difflineminus">-    {</span>
<a href="#l37.900"></a><span id="l37.900" class="difflineplus">+    while (NS_SUCCEEDED(status)) {</span>
<a href="#l37.901"></a><span id="l37.901">       uint32_t bytesRead;</span>
<a href="#l37.902"></a><span id="l37.902">       nsresult rv = inputStream-&gt;Read(buffer, MIME_BUFFER_SIZE, &amp;bytesRead);</span>
<a href="#l37.903"></a><span id="l37.903" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l37.904"></a><span id="l37.904" class="difflineminus">-      {</span>
<a href="#l37.905"></a><span id="l37.905" class="difflineplus">+      if (NS_FAILED(rv)) {</span>
<a href="#l37.906"></a><span id="l37.906">         nsCOMPtr&lt;nsIMsgSendReport&gt; sendReport;</span>
<a href="#l37.907"></a><span id="l37.907">         m_state-&gt;GetSendReport(getter_AddRefs(sendReport));</span>
<a href="#l37.908"></a><span id="l37.908" class="difflineminus">-        if (sendReport)</span>
<a href="#l37.909"></a><span id="l37.909" class="difflineminus">-        {</span>
<a href="#l37.910"></a><span id="l37.910" class="difflineplus">+        if (sendReport) {</span>
<a href="#l37.911"></a><span id="l37.911">           nsAutoString error_msg;</span>
<a href="#l37.912"></a><span id="l37.912">           nsMsgBuildMessageWithFile(m_file, error_msg);</span>
<a href="#l37.913"></a><span id="l37.913" class="difflineminus">-          sendReport-&gt;SetMessage(nsIMsgSendReport::process_Current, error_msg.get(), false);</span>
<a href="#l37.914"></a><span id="l37.914" class="difflineplus">+          sendReport-&gt;SetMessage(nsIMsgSendReport::process_Current,</span>
<a href="#l37.915"></a><span id="l37.915" class="difflineplus">+                                 error_msg.get(), false);</span>
<a href="#l37.916"></a><span id="l37.916">           status = NS_MSG_UNABLE_TO_OPEN_FILE;</span>
<a href="#l37.917"></a><span id="l37.917">           goto FAIL;</span>
<a href="#l37.918"></a><span id="l37.918">         }</span>
<a href="#l37.919"></a><span id="l37.919">       }</span>
<a href="#l37.920"></a><span id="l37.920">       status = PushBody(buffer, bytesRead);</span>
<a href="#l37.921"></a><span id="l37.921" class="difflineminus">-      if (NS_FAILED(status))</span>
<a href="#l37.922"></a><span id="l37.922" class="difflineminus">-        goto FAIL;</span>
<a href="#l37.923"></a><span id="l37.923" class="difflineminus">-      if (bytesRead &lt; MIME_BUFFER_SIZE)</span>
<a href="#l37.924"></a><span id="l37.924" class="difflineminus">-        break;</span>
<a href="#l37.925"></a><span id="l37.925" class="difflineplus">+      if (NS_FAILED(status)) goto FAIL;</span>
<a href="#l37.926"></a><span id="l37.926" class="difflineplus">+      if (bytesRead &lt; MIME_BUFFER_SIZE) break;</span>
<a href="#l37.927"></a><span id="l37.927">     }</span>
<a href="#l37.928"></a><span id="l37.928">   }</span>
<a href="#l37.929"></a><span id="l37.929"> </span>
<a href="#l37.930"></a><span id="l37.930" class="difflineminus">-  if (m_encoder)</span>
<a href="#l37.931"></a><span id="l37.931" class="difflineminus">-  {</span>
<a href="#l37.932"></a><span id="l37.932" class="difflineplus">+  if (m_encoder) {</span>
<a href="#l37.933"></a><span id="l37.933">     nsresult rv = m_encoder-&gt;Flush();</span>
<a href="#l37.934"></a><span id="l37.934">     m_encoder = nullptr;</span>
<a href="#l37.935"></a><span id="l37.935">     needToWriteCRLFAfterEncodedBody = !m_parent;</span>
<a href="#l37.936"></a><span id="l37.936" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l37.937"></a><span id="l37.937" class="difflineminus">-    {</span>
<a href="#l37.938"></a><span id="l37.938" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l37.939"></a><span id="l37.939">       // XXX -1 is not a valid nsresult</span>
<a href="#l37.940"></a><span id="l37.940">       status = static_cast&lt;nsresult&gt;(-1);</span>
<a href="#l37.941"></a><span id="l37.941">       goto FAIL;</span>
<a href="#l37.942"></a><span id="l37.942">     }</span>
<a href="#l37.943"></a><span id="l37.943">   }</span>
<a href="#l37.944"></a><span id="l37.944"> </span>
<a href="#l37.945"></a><span id="l37.945">   //</span>
<a href="#l37.946"></a><span id="l37.946">   // Ok, from here we loop and drive the the output of all children</span>
<a href="#l37.947"></a><span id="l37.947">   // for this message.</span>
<a href="#l37.948"></a><span id="l37.948">   //</span>
<a href="#l37.949"></a><span id="l37.949" class="difflineminus">-  if (m_numchildren &gt; 0)</span>
<a href="#l37.950"></a><span id="l37.950" class="difflineminus">-  {</span>
<a href="#l37.951"></a><span id="l37.951" class="difflineminus">-    bool    writeSeparator = true;</span>
<a href="#l37.952"></a><span id="l37.952" class="difflineplus">+  if (m_numchildren &gt; 0) {</span>
<a href="#l37.953"></a><span id="l37.953" class="difflineplus">+    bool writeSeparator = true;</span>
<a href="#l37.954"></a><span id="l37.954"> </span>
<a href="#l37.955"></a><span id="l37.955" class="difflineminus">-    for (int i = 0 ; i &lt; m_numchildren ; i ++)</span>
<a href="#l37.956"></a><span id="l37.956" class="difflineminus">-    {</span>
<a href="#l37.957"></a><span id="l37.957" class="difflineminus">-      if (writeSeparator)</span>
<a href="#l37.958"></a><span id="l37.958" class="difflineminus">-      {</span>
<a href="#l37.959"></a><span id="l37.959" class="difflineplus">+    for (int i = 0; i &lt; m_numchildren; i++) {</span>
<a href="#l37.960"></a><span id="l37.960" class="difflineplus">+      if (writeSeparator) {</span>
<a href="#l37.961"></a><span id="l37.961">         PUSH(CRLF);</span>
<a href="#l37.962"></a><span id="l37.962">         PUSH(&quot;--&quot;);</span>
<a href="#l37.963"></a><span id="l37.963"> </span>
<a href="#l37.964"></a><span id="l37.964">         PUSH(separator);</span>
<a href="#l37.965"></a><span id="l37.965">         PUSH(CRLF);</span>
<a href="#l37.966"></a><span id="l37.966">       }</span>
<a href="#l37.967"></a><span id="l37.967"> </span>
<a href="#l37.968"></a><span id="l37.968">       status = m_children[i]-&gt;Write();</span>
<a href="#l37.969"></a><span id="l37.969" class="difflineminus">-      if (NS_FAILED(status))</span>
<a href="#l37.970"></a><span id="l37.970" class="difflineminus">-        goto FAIL;</span>
<a href="#l37.971"></a><span id="l37.971" class="difflineplus">+      if (NS_FAILED(status)) goto FAIL;</span>
<a href="#l37.972"></a><span id="l37.972"> </span>
<a href="#l37.973"></a><span id="l37.973">       // XXX SKIP_EMPTY_PART (= 1966) is not a valid nsresult</span>
<a href="#l37.974"></a><span id="l37.974">       if (status == static_cast&lt;nsresult&gt;(SKIP_EMPTY_PART))</span>
<a href="#l37.975"></a><span id="l37.975">         writeSeparator = false;</span>
<a href="#l37.976"></a><span id="l37.976">       else</span>
<a href="#l37.977"></a><span id="l37.977">         writeSeparator = true;</span>
<a href="#l37.978"></a><span id="l37.978">     }</span>
<a href="#l37.979"></a><span id="l37.979"> </span>
<a href="#l37.980"></a><span id="l37.980">     PUSH(CRLF);</span>
<a href="#l37.981"></a><span id="l37.981">     PUSH(&quot;--&quot;);</span>
<a href="#l37.982"></a><span id="l37.982">     PUSH(separator);</span>
<a href="#l37.983"></a><span id="l37.983">     PUSH(&quot;--&quot;);</span>
<a href="#l37.984"></a><span id="l37.984">     PUSH(CRLF);</span>
<a href="#l37.985"></a><span id="l37.985" class="difflineminus">-  }</span>
<a href="#l37.986"></a><span id="l37.986" class="difflineminus">-  else if (needToWriteCRLFAfterEncodedBody)</span>
<a href="#l37.987"></a><span id="l37.987" class="difflineplus">+  } else if (needToWriteCRLFAfterEncodedBody)</span>
<a href="#l37.988"></a><span id="l37.988">     PUSH(CRLF);</span>
<a href="#l37.989"></a><span id="l37.989"> </span>
<a href="#l37.990"></a><span id="l37.990"> FAIL:</span>
<a href="#l37.991"></a><span id="l37.991">   PR_FREEIF(separator);</span>
<a href="#l37.992"></a><span id="l37.992">   return status;</span>
<a href="#l37.993"></a><span id="l37.993"> }</span>
<a href="#l37.994"></a><span id="l37.994" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSendPart.h</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSendPart.h</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -9,93 +9,91 @@</span>
<a href="#l38.4"></a><span id="l38.4"> #include &quot;msgCore.h&quot;</span>
<a href="#l38.5"></a><span id="l38.5"> #include &quot;prprf.h&quot; /* should be defined into msgCore.h? */</span>
<a href="#l38.6"></a><span id="l38.6"> #include &quot;nsMsgSend.h&quot;</span>
<a href="#l38.7"></a><span id="l38.7"> </span>
<a href="#l38.8"></a><span id="l38.8"> namespace mozilla {</span>
<a href="#l38.9"></a><span id="l38.9"> namespace mailnews {</span>
<a href="#l38.10"></a><span id="l38.10"> class MimeEncoder;</span>
<a href="#l38.11"></a><span id="l38.11"> }</span>
<a href="#l38.12"></a><span id="l38.12" class="difflineminus">-}</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineplus">+}  // namespace mozilla</span>
<a href="#l38.14"></a><span id="l38.14"> </span>
<a href="#l38.15"></a><span id="l38.15" class="difflineminus">-typedef int (*MSG_SendPartWriteFunc)(const char* line, int32_t size,</span>
<a href="#l38.16"></a><span id="l38.16" class="difflineminus">-                                     bool isheader, void* closure);</span>
<a href="#l38.17"></a><span id="l38.17" class="difflineplus">+typedef int (*MSG_SendPartWriteFunc)(const char *line, int32_t size,</span>
<a href="#l38.18"></a><span id="l38.18" class="difflineplus">+                                     bool isheader, void *closure);</span>
<a href="#l38.19"></a><span id="l38.19"> </span>
<a href="#l38.20"></a><span id="l38.20"> class nsMsgSendPart {</span>
<a href="#l38.21"></a><span id="l38.21">   typedef mozilla::mailnews::MimeEncoder MimeEncoder;</span>
<a href="#l38.22"></a><span id="l38.22" class="difflineminus">-public:</span>
<a href="#l38.23"></a><span id="l38.23" class="difflineminus">-    explicit nsMsgSendPart(nsIMsgSend* state, const char *part_charset = NULL);</span>
<a href="#l38.24"></a><span id="l38.24" class="difflineminus">-    virtual ~nsMsgSendPart();  // Note that the destructor also destroys</span>
<a href="#l38.25"></a><span id="l38.25" class="difflineminus">-                               // any children that were added.</span>
<a href="#l38.26"></a><span id="l38.26"> </span>
<a href="#l38.27"></a><span id="l38.27" class="difflineminus">-    virtual nsresult  Write();</span>
<a href="#l38.28"></a><span id="l38.28" class="difflineplus">+ public:</span>
<a href="#l38.29"></a><span id="l38.29" class="difflineplus">+  explicit nsMsgSendPart(nsIMsgSend *state, const char *part_charset = NULL);</span>
<a href="#l38.30"></a><span id="l38.30" class="difflineplus">+  virtual ~nsMsgSendPart();  // Note that the destructor also destroys</span>
<a href="#l38.31"></a><span id="l38.31" class="difflineplus">+                             // any children that were added.</span>
<a href="#l38.32"></a><span id="l38.32"> </span>
<a href="#l38.33"></a><span id="l38.33" class="difflineminus">-    virtual nsresult    SetFile(nsIFile *filename);</span>
<a href="#l38.34"></a><span id="l38.34" class="difflineminus">-    const nsIFile       *GetFile() {return m_file;}</span>
<a href="#l38.35"></a><span id="l38.35" class="difflineplus">+  virtual nsresult Write();</span>
<a href="#l38.36"></a><span id="l38.36" class="difflineplus">+</span>
<a href="#l38.37"></a><span id="l38.37" class="difflineplus">+  virtual nsresult SetFile(nsIFile *filename);</span>
<a href="#l38.38"></a><span id="l38.38" class="difflineplus">+  const nsIFile *GetFile() { return m_file; }</span>
<a href="#l38.39"></a><span id="l38.39"> </span>
<a href="#l38.40"></a><span id="l38.40" class="difflineminus">-    virtual nsresult  SetBuffer(const char* buffer);</span>
<a href="#l38.41"></a><span id="l38.41" class="difflineminus">-    const char        *GetBuffer() {return m_buffer;}</span>
<a href="#l38.42"></a><span id="l38.42" class="difflineplus">+  virtual nsresult SetBuffer(const char *buffer);</span>
<a href="#l38.43"></a><span id="l38.43" class="difflineplus">+  const char *GetBuffer() { return m_buffer; }</span>
<a href="#l38.44"></a><span id="l38.44"> </span>
<a href="#l38.45"></a><span id="l38.45" class="difflineminus">-    virtual nsresult  SetType(const char* type);</span>
<a href="#l38.46"></a><span id="l38.46" class="difflineminus">-    const char        *GetType() {return m_type;}</span>
<a href="#l38.47"></a><span id="l38.47" class="difflineplus">+  virtual nsresult SetType(const char *type);</span>
<a href="#l38.48"></a><span id="l38.48" class="difflineplus">+  const char *GetType() { return m_type; }</span>
<a href="#l38.49"></a><span id="l38.49"> </span>
<a href="#l38.50"></a><span id="l38.50" class="difflineminus">-    const char        *GetCharsetName() {return m_charset_name;}</span>
<a href="#l38.51"></a><span id="l38.51" class="difflineplus">+  const char *GetCharsetName() { return m_charset_name; }</span>
<a href="#l38.52"></a><span id="l38.52"> </span>
<a href="#l38.53"></a><span id="l38.53" class="difflineminus">-    virtual nsresult  SetOtherHeaders(const char* other);</span>
<a href="#l38.54"></a><span id="l38.54" class="difflineminus">-    const char        *SetOtherHeaders() {return m_other;}</span>
<a href="#l38.55"></a><span id="l38.55" class="difflineminus">-    virtual nsresult  AppendOtherHeaders(const char* moreother);</span>
<a href="#l38.56"></a><span id="l38.56" class="difflineplus">+  virtual nsresult SetOtherHeaders(const char *other);</span>
<a href="#l38.57"></a><span id="l38.57" class="difflineplus">+  const char *SetOtherHeaders() { return m_other; }</span>
<a href="#l38.58"></a><span id="l38.58" class="difflineplus">+  virtual nsresult AppendOtherHeaders(const char *moreother);</span>
<a href="#l38.59"></a><span id="l38.59"> </span>
<a href="#l38.60"></a><span id="l38.60" class="difflineminus">-    virtual nsresult  SetMimeDeliveryState(nsIMsgSend* state);</span>
<a href="#l38.61"></a><span id="l38.61" class="difflineplus">+  virtual nsresult SetMimeDeliveryState(nsIMsgSend *state);</span>
<a href="#l38.62"></a><span id="l38.62"> </span>
<a href="#l38.63"></a><span id="l38.63">   // Note that the nsMsgSendPart class will take over ownership of the</span>
<a href="#l38.64"></a><span id="l38.64">   // MimeEncoderData* object, deleting it when it chooses.  (This is</span>
<a href="#l38.65"></a><span id="l38.65">   // necessary because deleting these objects is the only current way to</span>
<a href="#l38.66"></a><span id="l38.66">   // flush out the data in them.)</span>
<a href="#l38.67"></a><span id="l38.67" class="difflineminus">-  void                SetEncoder(MimeEncoder* encoder) {m_encoder = encoder;}</span>
<a href="#l38.68"></a><span id="l38.68" class="difflineminus">-  MimeEncoder         *GetEncoder() {return m_encoder;}</span>
<a href="#l38.69"></a><span id="l38.69" class="difflineplus">+  void SetEncoder(MimeEncoder *encoder) { m_encoder = encoder; }</span>
<a href="#l38.70"></a><span id="l38.70" class="difflineplus">+  MimeEncoder *GetEncoder() { return m_encoder; }</span>
<a href="#l38.71"></a><span id="l38.71"> </span>
<a href="#l38.72"></a><span id="l38.72" class="difflineminus">-  void                SetStripSensitiveHeaders(bool value)</span>
<a href="#l38.73"></a><span id="l38.73" class="difflineminus">-                      {</span>
<a href="#l38.74"></a><span id="l38.74" class="difflineminus">-                        m_strip_sensitive_headers = value;</span>
<a href="#l38.75"></a><span id="l38.75" class="difflineminus">-                      }</span>
<a href="#l38.76"></a><span id="l38.76" class="difflineminus">-  bool                GetStripSensitiveHeaders() {return m_strip_sensitive_headers;}</span>
<a href="#l38.77"></a><span id="l38.77" class="difflineplus">+  void SetStripSensitiveHeaders(bool value) {</span>
<a href="#l38.78"></a><span id="l38.78" class="difflineplus">+    m_strip_sensitive_headers = value;</span>
<a href="#l38.79"></a><span id="l38.79" class="difflineplus">+  }</span>
<a href="#l38.80"></a><span id="l38.80" class="difflineplus">+  bool GetStripSensitiveHeaders() { return m_strip_sensitive_headers; }</span>
<a href="#l38.81"></a><span id="l38.81"> </span>
<a href="#l38.82"></a><span id="l38.82" class="difflineminus">-  virtual nsresult    AddChild(nsMsgSendPart* child);</span>
<a href="#l38.83"></a><span id="l38.83" class="difflineplus">+  virtual nsresult AddChild(nsMsgSendPart *child);</span>
<a href="#l38.84"></a><span id="l38.84"> </span>
<a href="#l38.85"></a><span id="l38.85" class="difflineminus">-  int32_t             GetNumChildren() {return m_numchildren;}</span>
<a href="#l38.86"></a><span id="l38.86" class="difflineminus">-  nsMsgSendPart       *GetChild(int32_t which);</span>
<a href="#l38.87"></a><span id="l38.87" class="difflineminus">-  nsMsgSendPart       *DetachChild(int32_t which);</span>
<a href="#l38.88"></a><span id="l38.88" class="difflineplus">+  int32_t GetNumChildren() { return m_numchildren; }</span>
<a href="#l38.89"></a><span id="l38.89" class="difflineplus">+  nsMsgSendPart *GetChild(int32_t which);</span>
<a href="#l38.90"></a><span id="l38.90" class="difflineplus">+  nsMsgSendPart *DetachChild(int32_t which);</span>
<a href="#l38.91"></a><span id="l38.91"> </span>
<a href="#l38.92"></a><span id="l38.92" class="difflineminus">-  virtual nsresult    SetMainPart(bool value);</span>
<a href="#l38.93"></a><span id="l38.93" class="difflineminus">-  bool                IsMainPart()</span>
<a href="#l38.94"></a><span id="l38.94" class="difflineminus">-                      {</span>
<a href="#l38.95"></a><span id="l38.95" class="difflineminus">-                        return m_mainpart;</span>
<a href="#l38.96"></a><span id="l38.96" class="difflineminus">-                      }</span>
<a href="#l38.97"></a><span id="l38.97" class="difflineminus">-  nsCString           m_partNum;</span>
<a href="#l38.98"></a><span id="l38.98" class="difflineminus">-protected:</span>
<a href="#l38.99"></a><span id="l38.99" class="difflineminus">-  nsresult            CopyString(char** dest, const char* src);</span>
<a href="#l38.100"></a><span id="l38.100" class="difflineminus">-  nsresult            PushBody(const char* buffer, int32_t length);</span>
<a href="#l38.101"></a><span id="l38.101" class="difflineplus">+  virtual nsresult SetMainPart(bool value);</span>
<a href="#l38.102"></a><span id="l38.102" class="difflineplus">+  bool IsMainPart() { return m_mainpart; }</span>
<a href="#l38.103"></a><span id="l38.103" class="difflineplus">+  nsCString m_partNum;</span>
<a href="#l38.104"></a><span id="l38.104" class="difflineplus">+</span>
<a href="#l38.105"></a><span id="l38.105" class="difflineplus">+ protected:</span>
<a href="#l38.106"></a><span id="l38.106" class="difflineplus">+  nsresult CopyString(char **dest, const char *src);</span>
<a href="#l38.107"></a><span id="l38.107" class="difflineplus">+  nsresult PushBody(const char *buffer, int32_t length);</span>
<a href="#l38.108"></a><span id="l38.108"> </span>
<a href="#l38.109"></a><span id="l38.109">   nsCOMPtr&lt;nsIMsgSend&gt; m_state;</span>
<a href="#l38.110"></a><span id="l38.110" class="difflineminus">-  nsMsgSendPart       *m_parent;</span>
<a href="#l38.111"></a><span id="l38.111" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt;   m_file;</span>
<a href="#l38.112"></a><span id="l38.112" class="difflineminus">-  char                *m_buffer;</span>
<a href="#l38.113"></a><span id="l38.113" class="difflineminus">-  char                *m_type;</span>
<a href="#l38.114"></a><span id="l38.114" class="difflineminus">-  char                *m_other;</span>
<a href="#l38.115"></a><span id="l38.115" class="difflineminus">-  char                m_charset_name[64+1];        // charset name associated with this part</span>
<a href="#l38.116"></a><span id="l38.116" class="difflineminus">-  bool                m_strip_sensitive_headers;</span>
<a href="#l38.117"></a><span id="l38.117" class="difflineplus">+  nsMsgSendPart *m_parent;</span>
<a href="#l38.118"></a><span id="l38.118" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; m_file;</span>
<a href="#l38.119"></a><span id="l38.119" class="difflineplus">+  char *m_buffer;</span>
<a href="#l38.120"></a><span id="l38.120" class="difflineplus">+  char *m_type;</span>
<a href="#l38.121"></a><span id="l38.121" class="difflineplus">+  char *m_other;</span>
<a href="#l38.122"></a><span id="l38.122" class="difflineplus">+  char m_charset_name[64 + 1];  // charset name associated with this part</span>
<a href="#l38.123"></a><span id="l38.123" class="difflineplus">+  bool m_strip_sensitive_headers;</span>
<a href="#l38.124"></a><span id="l38.124">   nsAutoPtr&lt;MimeEncoder&gt; m_encoder;</span>
<a href="#l38.125"></a><span id="l38.125"> </span>
<a href="#l38.126"></a><span id="l38.126" class="difflineminus">-  nsMsgSendPart       **m_children;</span>
<a href="#l38.127"></a><span id="l38.127" class="difflineminus">-  int32_t             m_numchildren;</span>
<a href="#l38.128"></a><span id="l38.128" class="difflineplus">+  nsMsgSendPart **m_children;</span>
<a href="#l38.129"></a><span id="l38.129" class="difflineplus">+  int32_t m_numchildren;</span>
<a href="#l38.130"></a><span id="l38.130"> </span>
<a href="#l38.131"></a><span id="l38.131">   // Data used while actually writing.</span>
<a href="#l38.132"></a><span id="l38.132" class="difflineminus">-  bool                m_firstBlock;</span>
<a href="#l38.133"></a><span id="l38.133" class="difflineminus">-  bool                m_needIntlConversion;</span>
<a href="#l38.134"></a><span id="l38.134" class="difflineplus">+  bool m_firstBlock;</span>
<a href="#l38.135"></a><span id="l38.135" class="difflineplus">+  bool m_needIntlConversion;</span>
<a href="#l38.136"></a><span id="l38.136"> </span>
<a href="#l38.137"></a><span id="l38.137" class="difflineminus">-  bool                m_mainpart;</span>
<a href="#l38.138"></a><span id="l38.138" class="difflineplus">+  bool m_mainpart;</span>
<a href="#l38.139"></a><span id="l38.139"> </span>
<a href="#l38.140"></a><span id="l38.140" class="difflineminus">-  bool                m_just_hit_CR;</span>
<a href="#l38.141"></a><span id="l38.141" class="difflineplus">+  bool m_just_hit_CR;</span>
<a href="#l38.142"></a><span id="l38.142"> </span>
<a href="#l38.143"></a><span id="l38.143" class="difflineminus">-  static int32_t      M_counter;</span>
<a href="#l38.144"></a><span id="l38.144" class="difflineplus">+  static int32_t M_counter;</span>
<a href="#l38.145"></a><span id="l38.145"> };</span>
<a href="#l38.146"></a><span id="l38.146"> </span>
<a href="#l38.147"></a><span id="l38.147"> #endif /* _MsgSendPart_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSendReport.cpp</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSendReport.cpp</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -12,321 +12,292 @@</span>
<a href="#l39.4"></a><span id="l39.4"> #include &quot;nsError.h&quot;</span>
<a href="#l39.5"></a><span id="l39.5"> #include &quot;nsComposeStrings.h&quot;</span>
<a href="#l39.6"></a><span id="l39.6"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l39.7"></a><span id="l39.7"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l39.8"></a><span id="l39.8"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l39.9"></a><span id="l39.9"> </span>
<a href="#l39.10"></a><span id="l39.10"> NS_IMPL_ISUPPORTS(nsMsgProcessReport, nsIMsgProcessReport)</span>
<a href="#l39.11"></a><span id="l39.11"> </span>
<a href="#l39.12"></a><span id="l39.12" class="difflineminus">-nsMsgProcessReport::nsMsgProcessReport()</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineminus">-{</span>
<a href="#l39.14"></a><span id="l39.14" class="difflineminus">-  Reset();</span>
<a href="#l39.15"></a><span id="l39.15" class="difflineminus">-}</span>
<a href="#l39.16"></a><span id="l39.16" class="difflineplus">+nsMsgProcessReport::nsMsgProcessReport() { Reset(); }</span>
<a href="#l39.17"></a><span id="l39.17"> </span>
<a href="#l39.18"></a><span id="l39.18" class="difflineminus">-nsMsgProcessReport::~nsMsgProcessReport()</span>
<a href="#l39.19"></a><span id="l39.19" class="difflineminus">-{</span>
<a href="#l39.20"></a><span id="l39.20" class="difflineminus">-}</span>
<a href="#l39.21"></a><span id="l39.21" class="difflineplus">+nsMsgProcessReport::~nsMsgProcessReport() {}</span>
<a href="#l39.22"></a><span id="l39.22"> </span>
<a href="#l39.23"></a><span id="l39.23"> /* attribute boolean proceeded; */</span>
<a href="#l39.24"></a><span id="l39.24" class="difflineminus">-NS_IMETHODIMP nsMsgProcessReport::GetProceeded(bool *aProceeded)</span>
<a href="#l39.25"></a><span id="l39.25" class="difflineminus">-{</span>
<a href="#l39.26"></a><span id="l39.26" class="difflineplus">+NS_IMETHODIMP nsMsgProcessReport::GetProceeded(bool *aProceeded) {</span>
<a href="#l39.27"></a><span id="l39.27">   NS_ENSURE_ARG_POINTER(aProceeded);</span>
<a href="#l39.28"></a><span id="l39.28">   *aProceeded = mProceeded;</span>
<a href="#l39.29"></a><span id="l39.29">   return NS_OK;</span>
<a href="#l39.30"></a><span id="l39.30"> }</span>
<a href="#l39.31"></a><span id="l39.31" class="difflineminus">-NS_IMETHODIMP nsMsgProcessReport::SetProceeded(bool aProceeded)</span>
<a href="#l39.32"></a><span id="l39.32" class="difflineminus">-{</span>
<a href="#l39.33"></a><span id="l39.33" class="difflineplus">+NS_IMETHODIMP nsMsgProcessReport::SetProceeded(bool aProceeded) {</span>
<a href="#l39.34"></a><span id="l39.34">   mProceeded = aProceeded;</span>
<a href="#l39.35"></a><span id="l39.35">   return NS_OK;</span>
<a href="#l39.36"></a><span id="l39.36"> }</span>
<a href="#l39.37"></a><span id="l39.37"> </span>
<a href="#l39.38"></a><span id="l39.38"> /* attribute nsresult error; */</span>
<a href="#l39.39"></a><span id="l39.39" class="difflineminus">-NS_IMETHODIMP nsMsgProcessReport::GetError(nsresult *aError)</span>
<a href="#l39.40"></a><span id="l39.40" class="difflineminus">-{</span>
<a href="#l39.41"></a><span id="l39.41" class="difflineplus">+NS_IMETHODIMP nsMsgProcessReport::GetError(nsresult *aError) {</span>
<a href="#l39.42"></a><span id="l39.42">   NS_ENSURE_ARG_POINTER(aError);</span>
<a href="#l39.43"></a><span id="l39.43">   *aError = mError;</span>
<a href="#l39.44"></a><span id="l39.44">   return NS_OK;</span>
<a href="#l39.45"></a><span id="l39.45"> }</span>
<a href="#l39.46"></a><span id="l39.46" class="difflineminus">-NS_IMETHODIMP nsMsgProcessReport::SetError(nsresult aError)</span>
<a href="#l39.47"></a><span id="l39.47" class="difflineminus">-{</span>
<a href="#l39.48"></a><span id="l39.48" class="difflineplus">+NS_IMETHODIMP nsMsgProcessReport::SetError(nsresult aError) {</span>
<a href="#l39.49"></a><span id="l39.49">   mError = aError;</span>
<a href="#l39.50"></a><span id="l39.50">   return NS_OK;</span>
<a href="#l39.51"></a><span id="l39.51"> }</span>
<a href="#l39.52"></a><span id="l39.52"> </span>
<a href="#l39.53"></a><span id="l39.53"> /* attribute wstring message; */</span>
<a href="#l39.54"></a><span id="l39.54" class="difflineminus">-NS_IMETHODIMP nsMsgProcessReport::GetMessage(char16_t * *aMessage)</span>
<a href="#l39.55"></a><span id="l39.55" class="difflineminus">-{</span>
<a href="#l39.56"></a><span id="l39.56" class="difflineplus">+NS_IMETHODIMP nsMsgProcessReport::GetMessage(char16_t **aMessage) {</span>
<a href="#l39.57"></a><span id="l39.57">   NS_ENSURE_ARG_POINTER(aMessage);</span>
<a href="#l39.58"></a><span id="l39.58">   *aMessage = ToNewUnicode(mMessage);</span>
<a href="#l39.59"></a><span id="l39.59">   return NS_OK;</span>
<a href="#l39.60"></a><span id="l39.60"> }</span>
<a href="#l39.61"></a><span id="l39.61" class="difflineminus">-NS_IMETHODIMP nsMsgProcessReport::SetMessage(const char16_t * aMessage)</span>
<a href="#l39.62"></a><span id="l39.62" class="difflineminus">-{</span>
<a href="#l39.63"></a><span id="l39.63" class="difflineplus">+NS_IMETHODIMP nsMsgProcessReport::SetMessage(const char16_t *aMessage) {</span>
<a href="#l39.64"></a><span id="l39.64">   mMessage = aMessage;</span>
<a href="#l39.65"></a><span id="l39.65">   return NS_OK;</span>
<a href="#l39.66"></a><span id="l39.66"> }</span>
<a href="#l39.67"></a><span id="l39.67"> </span>
<a href="#l39.68"></a><span id="l39.68"> /* void Reset (); */</span>
<a href="#l39.69"></a><span id="l39.69" class="difflineminus">-NS_IMETHODIMP nsMsgProcessReport::Reset()</span>
<a href="#l39.70"></a><span id="l39.70" class="difflineminus">-{</span>
<a href="#l39.71"></a><span id="l39.71" class="difflineplus">+NS_IMETHODIMP nsMsgProcessReport::Reset() {</span>
<a href="#l39.72"></a><span id="l39.72">   mProceeded = false;</span>
<a href="#l39.73"></a><span id="l39.73">   mError = NS_OK;</span>
<a href="#l39.74"></a><span id="l39.74">   mMessage.Truncate();</span>
<a href="#l39.75"></a><span id="l39.75"> </span>
<a href="#l39.76"></a><span id="l39.76">   return NS_OK;</span>
<a href="#l39.77"></a><span id="l39.77"> }</span>
<a href="#l39.78"></a><span id="l39.78"> </span>
<a href="#l39.79"></a><span id="l39.79" class="difflineminus">-</span>
<a href="#l39.80"></a><span id="l39.80"> NS_IMPL_ISUPPORTS(nsMsgSendReport, nsIMsgSendReport)</span>
<a href="#l39.81"></a><span id="l39.81"> </span>
<a href="#l39.82"></a><span id="l39.82" class="difflineminus">-nsMsgSendReport::nsMsgSendReport()</span>
<a href="#l39.83"></a><span id="l39.83" class="difflineminus">-{</span>
<a href="#l39.84"></a><span id="l39.84" class="difflineplus">+nsMsgSendReport::nsMsgSendReport() {</span>
<a href="#l39.85"></a><span id="l39.85">   uint32_t i;</span>
<a href="#l39.86"></a><span id="l39.86" class="difflineminus">-  for (i = 0; i &lt;= SEND_LAST_PROCESS; i ++)</span>
<a href="#l39.87"></a><span id="l39.87" class="difflineplus">+  for (i = 0; i &lt;= SEND_LAST_PROCESS; i++)</span>
<a href="#l39.88"></a><span id="l39.88">     mProcessReport[i] = new nsMsgProcessReport();</span>
<a href="#l39.89"></a><span id="l39.89"> </span>
<a href="#l39.90"></a><span id="l39.90">   Reset();</span>
<a href="#l39.91"></a><span id="l39.91"> }</span>
<a href="#l39.92"></a><span id="l39.92"> </span>
<a href="#l39.93"></a><span id="l39.93" class="difflineminus">-nsMsgSendReport::~nsMsgSendReport()</span>
<a href="#l39.94"></a><span id="l39.94" class="difflineminus">-{</span>
<a href="#l39.95"></a><span id="l39.95" class="difflineplus">+nsMsgSendReport::~nsMsgSendReport() {</span>
<a href="#l39.96"></a><span id="l39.96">   uint32_t i;</span>
<a href="#l39.97"></a><span id="l39.97" class="difflineminus">-  for (i = 0; i &lt;= SEND_LAST_PROCESS; i ++)</span>
<a href="#l39.98"></a><span id="l39.98" class="difflineminus">-    mProcessReport[i] = nullptr;</span>
<a href="#l39.99"></a><span id="l39.99" class="difflineplus">+  for (i = 0; i &lt;= SEND_LAST_PROCESS; i++) mProcessReport[i] = nullptr;</span>
<a href="#l39.100"></a><span id="l39.100"> }</span>
<a href="#l39.101"></a><span id="l39.101"> </span>
<a href="#l39.102"></a><span id="l39.102"> /* attribute long currentProcess; */</span>
<a href="#l39.103"></a><span id="l39.103" class="difflineminus">-NS_IMETHODIMP nsMsgSendReport::GetCurrentProcess(int32_t *aCurrentProcess)</span>
<a href="#l39.104"></a><span id="l39.104" class="difflineminus">-{</span>
<a href="#l39.105"></a><span id="l39.105" class="difflineplus">+NS_IMETHODIMP nsMsgSendReport::GetCurrentProcess(int32_t *aCurrentProcess) {</span>
<a href="#l39.106"></a><span id="l39.106">   NS_ENSURE_ARG_POINTER(aCurrentProcess);</span>
<a href="#l39.107"></a><span id="l39.107">   *aCurrentProcess = mCurrentProcess;</span>
<a href="#l39.108"></a><span id="l39.108">   return NS_OK;</span>
<a href="#l39.109"></a><span id="l39.109"> }</span>
<a href="#l39.110"></a><span id="l39.110" class="difflineminus">-NS_IMETHODIMP nsMsgSendReport::SetCurrentProcess(int32_t aCurrentProcess)</span>
<a href="#l39.111"></a><span id="l39.111" class="difflineminus">-{</span>
<a href="#l39.112"></a><span id="l39.112" class="difflineplus">+NS_IMETHODIMP nsMsgSendReport::SetCurrentProcess(int32_t aCurrentProcess) {</span>
<a href="#l39.113"></a><span id="l39.113">   if (aCurrentProcess &lt; 0 || aCurrentProcess &gt; SEND_LAST_PROCESS)</span>
<a href="#l39.114"></a><span id="l39.114">     return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l39.115"></a><span id="l39.115"> </span>
<a href="#l39.116"></a><span id="l39.116">   mCurrentProcess = aCurrentProcess;</span>
<a href="#l39.117"></a><span id="l39.117">   if (mProcessReport[mCurrentProcess])</span>
<a href="#l39.118"></a><span id="l39.118">     mProcessReport[mCurrentProcess]-&gt;SetProceeded(true);</span>
<a href="#l39.119"></a><span id="l39.119"> </span>
<a href="#l39.120"></a><span id="l39.120">   return NS_OK;</span>
<a href="#l39.121"></a><span id="l39.121"> }</span>
<a href="#l39.122"></a><span id="l39.122"> </span>
<a href="#l39.123"></a><span id="l39.123"> /* attribute long deliveryMode; */</span>
<a href="#l39.124"></a><span id="l39.124" class="difflineminus">-NS_IMETHODIMP nsMsgSendReport::GetDeliveryMode(int32_t *aDeliveryMode)</span>
<a href="#l39.125"></a><span id="l39.125" class="difflineminus">-{</span>
<a href="#l39.126"></a><span id="l39.126" class="difflineplus">+NS_IMETHODIMP nsMsgSendReport::GetDeliveryMode(int32_t *aDeliveryMode) {</span>
<a href="#l39.127"></a><span id="l39.127">   NS_ENSURE_ARG_POINTER(aDeliveryMode);</span>
<a href="#l39.128"></a><span id="l39.128">   *aDeliveryMode = mDeliveryMode;</span>
<a href="#l39.129"></a><span id="l39.129">   return NS_OK;</span>
<a href="#l39.130"></a><span id="l39.130"> }</span>
<a href="#l39.131"></a><span id="l39.131" class="difflineminus">-NS_IMETHODIMP nsMsgSendReport::SetDeliveryMode(int32_t aDeliveryMode)</span>
<a href="#l39.132"></a><span id="l39.132" class="difflineminus">-{</span>
<a href="#l39.133"></a><span id="l39.133" class="difflineplus">+NS_IMETHODIMP nsMsgSendReport::SetDeliveryMode(int32_t aDeliveryMode) {</span>
<a href="#l39.134"></a><span id="l39.134">   mDeliveryMode = aDeliveryMode;</span>
<a href="#l39.135"></a><span id="l39.135">   return NS_OK;</span>
<a href="#l39.136"></a><span id="l39.136"> }</span>
<a href="#l39.137"></a><span id="l39.137"> </span>
<a href="#l39.138"></a><span id="l39.138"> /* void Reset (); */</span>
<a href="#l39.139"></a><span id="l39.139" class="difflineminus">-NS_IMETHODIMP nsMsgSendReport::Reset()</span>
<a href="#l39.140"></a><span id="l39.140" class="difflineminus">-{</span>
<a href="#l39.141"></a><span id="l39.141" class="difflineplus">+NS_IMETHODIMP nsMsgSendReport::Reset() {</span>
<a href="#l39.142"></a><span id="l39.142">   uint32_t i;</span>
<a href="#l39.143"></a><span id="l39.143" class="difflineminus">-  for (i = 0; i &lt;= SEND_LAST_PROCESS; i ++)</span>
<a href="#l39.144"></a><span id="l39.144" class="difflineminus">-    if (mProcessReport[i])</span>
<a href="#l39.145"></a><span id="l39.145" class="difflineminus">-      mProcessReport[i]-&gt;Reset();</span>
<a href="#l39.146"></a><span id="l39.146" class="difflineplus">+  for (i = 0; i &lt;= SEND_LAST_PROCESS; i++)</span>
<a href="#l39.147"></a><span id="l39.147" class="difflineplus">+    if (mProcessReport[i]) mProcessReport[i]-&gt;Reset();</span>
<a href="#l39.148"></a><span id="l39.148"> </span>
<a href="#l39.149"></a><span id="l39.149">   mCurrentProcess = 0;</span>
<a href="#l39.150"></a><span id="l39.150">   mDeliveryMode = 0;</span>
<a href="#l39.151"></a><span id="l39.151">   mAlreadyDisplayReport = false;</span>
<a href="#l39.152"></a><span id="l39.152"> </span>
<a href="#l39.153"></a><span id="l39.153">   return NS_OK;</span>
<a href="#l39.154"></a><span id="l39.154"> }</span>
<a href="#l39.155"></a><span id="l39.155"> </span>
<a href="#l39.156"></a><span id="l39.156"> /* void setProceeded (in long process, in boolean proceeded); */</span>
<a href="#l39.157"></a><span id="l39.157" class="difflineminus">-NS_IMETHODIMP nsMsgSendReport::SetProceeded(int32_t process, bool proceeded)</span>
<a href="#l39.158"></a><span id="l39.158" class="difflineminus">-{</span>
<a href="#l39.159"></a><span id="l39.159" class="difflineplus">+NS_IMETHODIMP nsMsgSendReport::SetProceeded(int32_t process, bool proceeded) {</span>
<a href="#l39.160"></a><span id="l39.160">   if (process &lt; process_Current || process &gt; SEND_LAST_PROCESS)</span>
<a href="#l39.161"></a><span id="l39.161">     return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l39.162"></a><span id="l39.162"> </span>
<a href="#l39.163"></a><span id="l39.163" class="difflineminus">-  if (process == process_Current)</span>
<a href="#l39.164"></a><span id="l39.164" class="difflineminus">-    process = mCurrentProcess;</span>
<a href="#l39.165"></a><span id="l39.165" class="difflineplus">+  if (process == process_Current) process = mCurrentProcess;</span>
<a href="#l39.166"></a><span id="l39.166"> </span>
<a href="#l39.167"></a><span id="l39.167" class="difflineminus">-  if (!mProcessReport[process])</span>
<a href="#l39.168"></a><span id="l39.168" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l39.169"></a><span id="l39.169" class="difflineplus">+  if (!mProcessReport[process]) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l39.170"></a><span id="l39.170"> </span>
<a href="#l39.171"></a><span id="l39.171">   return mProcessReport[process]-&gt;SetProceeded(proceeded);</span>
<a href="#l39.172"></a><span id="l39.172"> }</span>
<a href="#l39.173"></a><span id="l39.173"> </span>
<a href="#l39.174"></a><span id="l39.174" class="difflineminus">-/* void setError (in long process, in nsresult error, in boolean overwriteError); */</span>
<a href="#l39.175"></a><span id="l39.175" class="difflineminus">-NS_IMETHODIMP nsMsgSendReport::SetError(int32_t process, nsresult newError, bool overwriteError)</span>
<a href="#l39.176"></a><span id="l39.176" class="difflineminus">-{</span>
<a href="#l39.177"></a><span id="l39.177" class="difflineplus">+/* void setError (in long process, in nsresult error, in boolean</span>
<a href="#l39.178"></a><span id="l39.178" class="difflineplus">+ * overwriteError); */</span>
<a href="#l39.179"></a><span id="l39.179" class="difflineplus">+NS_IMETHODIMP nsMsgSendReport::SetError(int32_t process, nsresult newError,</span>
<a href="#l39.180"></a><span id="l39.180" class="difflineplus">+                                        bool overwriteError) {</span>
<a href="#l39.181"></a><span id="l39.181">   if (process &lt; process_Current || process &gt; SEND_LAST_PROCESS)</span>
<a href="#l39.182"></a><span id="l39.182">     return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l39.183"></a><span id="l39.183"> </span>
<a href="#l39.184"></a><span id="l39.184" class="difflineminus">-  if (process == process_Current)</span>
<a href="#l39.185"></a><span id="l39.185" class="difflineminus">-  {</span>
<a href="#l39.186"></a><span id="l39.186" class="difflineplus">+  if (process == process_Current) {</span>
<a href="#l39.187"></a><span id="l39.187">     if (mCurrentProcess == process_Current)</span>
<a href="#l39.188"></a><span id="l39.188">       // We don't know what we're currently trying to do</span>
<a href="#l39.189"></a><span id="l39.189">       return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l39.190"></a><span id="l39.190"> </span>
<a href="#l39.191"></a><span id="l39.191">     process = mCurrentProcess;</span>
<a href="#l39.192"></a><span id="l39.192">   }</span>
<a href="#l39.193"></a><span id="l39.193"> </span>
<a href="#l39.194"></a><span id="l39.194" class="difflineminus">-  if (!mProcessReport[process])</span>
<a href="#l39.195"></a><span id="l39.195" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l39.196"></a><span id="l39.196" class="difflineplus">+  if (!mProcessReport[process]) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l39.197"></a><span id="l39.197"> </span>
<a href="#l39.198"></a><span id="l39.198">   nsresult currError = NS_OK;</span>
<a href="#l39.199"></a><span id="l39.199">   mProcessReport[process]-&gt;GetError(&amp;currError);</span>
<a href="#l39.200"></a><span id="l39.200">   if (overwriteError || NS_SUCCEEDED(currError))</span>
<a href="#l39.201"></a><span id="l39.201">     return mProcessReport[process]-&gt;SetError(newError);</span>
<a href="#l39.202"></a><span id="l39.202">   else</span>
<a href="#l39.203"></a><span id="l39.203">     return NS_OK;</span>
<a href="#l39.204"></a><span id="l39.204"> }</span>
<a href="#l39.205"></a><span id="l39.205"> </span>
<a href="#l39.206"></a><span id="l39.206" class="difflineminus">-/* void setMessage (in long process, in wstring message, in boolean overwriteMessage); */</span>
<a href="#l39.207"></a><span id="l39.207" class="difflineminus">-NS_IMETHODIMP nsMsgSendReport::SetMessage(int32_t process, const char16_t *message, bool overwriteMessage)</span>
<a href="#l39.208"></a><span id="l39.208" class="difflineminus">-{</span>
<a href="#l39.209"></a><span id="l39.209" class="difflineplus">+/* void setMessage (in long process, in wstring message, in boolean</span>
<a href="#l39.210"></a><span id="l39.210" class="difflineplus">+ * overwriteMessage); */</span>
<a href="#l39.211"></a><span id="l39.211" class="difflineplus">+NS_IMETHODIMP nsMsgSendReport::SetMessage(int32_t process,</span>
<a href="#l39.212"></a><span id="l39.212" class="difflineplus">+                                          const char16_t *message,</span>
<a href="#l39.213"></a><span id="l39.213" class="difflineplus">+                                          bool overwriteMessage) {</span>
<a href="#l39.214"></a><span id="l39.214">   if (process &lt; process_Current || process &gt; SEND_LAST_PROCESS)</span>
<a href="#l39.215"></a><span id="l39.215">     return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l39.216"></a><span id="l39.216"> </span>
<a href="#l39.217"></a><span id="l39.217" class="difflineminus">-  if (process == process_Current)</span>
<a href="#l39.218"></a><span id="l39.218" class="difflineminus">-  {</span>
<a href="#l39.219"></a><span id="l39.219" class="difflineplus">+  if (process == process_Current) {</span>
<a href="#l39.220"></a><span id="l39.220">     if (mCurrentProcess == process_Current)</span>
<a href="#l39.221"></a><span id="l39.221">       // We don't know what we're currently trying to do</span>
<a href="#l39.222"></a><span id="l39.222">       return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l39.223"></a><span id="l39.223"> </span>
<a href="#l39.224"></a><span id="l39.224">     process = mCurrentProcess;</span>
<a href="#l39.225"></a><span id="l39.225">   }</span>
<a href="#l39.226"></a><span id="l39.226"> </span>
<a href="#l39.227"></a><span id="l39.227" class="difflineminus">-  if (!mProcessReport[process])</span>
<a href="#l39.228"></a><span id="l39.228" class="difflineminus">-    return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l39.229"></a><span id="l39.229" class="difflineplus">+  if (!mProcessReport[process]) return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l39.230"></a><span id="l39.230"> </span>
<a href="#l39.231"></a><span id="l39.231">   nsString currMessage;</span>
<a href="#l39.232"></a><span id="l39.232">   mProcessReport[process]-&gt;GetMessage(getter_Copies(currMessage));</span>
<a href="#l39.233"></a><span id="l39.233">   if (overwriteMessage || currMessage.IsEmpty())</span>
<a href="#l39.234"></a><span id="l39.234">     return mProcessReport[process]-&gt;SetMessage(message);</span>
<a href="#l39.235"></a><span id="l39.235">   else</span>
<a href="#l39.236"></a><span id="l39.236">     return NS_OK;</span>
<a href="#l39.237"></a><span id="l39.237"> }</span>
<a href="#l39.238"></a><span id="l39.238"> </span>
<a href="#l39.239"></a><span id="l39.239"> /* nsIMsgProcessReport getProcessReport (in long process); */</span>
<a href="#l39.240"></a><span id="l39.240" class="difflineminus">-NS_IMETHODIMP nsMsgSendReport::GetProcessReport(int32_t process, nsIMsgProcessReport **_retval)</span>
<a href="#l39.241"></a><span id="l39.241" class="difflineminus">-{</span>
<a href="#l39.242"></a><span id="l39.242" class="difflineplus">+NS_IMETHODIMP nsMsgSendReport::GetProcessReport(int32_t process,</span>
<a href="#l39.243"></a><span id="l39.243" class="difflineplus">+                                                nsIMsgProcessReport **_retval) {</span>
<a href="#l39.244"></a><span id="l39.244">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l39.245"></a><span id="l39.245">   if (process &lt; process_Current || process &gt; SEND_LAST_PROCESS)</span>
<a href="#l39.246"></a><span id="l39.246">     return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l39.247"></a><span id="l39.247"> </span>
<a href="#l39.248"></a><span id="l39.248" class="difflineminus">-  if (process == process_Current)</span>
<a href="#l39.249"></a><span id="l39.249" class="difflineminus">-  {</span>
<a href="#l39.250"></a><span id="l39.250" class="difflineplus">+  if (process == process_Current) {</span>
<a href="#l39.251"></a><span id="l39.251">     if (mCurrentProcess == process_Current)</span>
<a href="#l39.252"></a><span id="l39.252">       // We don't know what we're currently trying to do</span>
<a href="#l39.253"></a><span id="l39.253">       return NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l39.254"></a><span id="l39.254"> </span>
<a href="#l39.255"></a><span id="l39.255">     process = mCurrentProcess;</span>
<a href="#l39.256"></a><span id="l39.256">   }</span>
<a href="#l39.257"></a><span id="l39.257"> </span>
<a href="#l39.258"></a><span id="l39.258">   NS_IF_ADDREF(*_retval = mProcessReport[process]);</span>
<a href="#l39.259"></a><span id="l39.259">   return NS_OK;</span>
<a href="#l39.260"></a><span id="l39.260"> }</span>
<a href="#l39.261"></a><span id="l39.261"> </span>
<a href="#l39.262"></a><span id="l39.262" class="difflineminus">-/* nsresult displayReport (in nsIPrompt prompt, in boolean showErrorOnly, in boolean dontShowReportTwice); */</span>
<a href="#l39.263"></a><span id="l39.263" class="difflineminus">-NS_IMETHODIMP nsMsgSendReport::DisplayReport(nsIPrompt *prompt, bool showErrorOnly, bool dontShowReportTwice, nsresult *_retval)</span>
<a href="#l39.264"></a><span id="l39.264" class="difflineminus">-{</span>
<a href="#l39.265"></a><span id="l39.265" class="difflineplus">+/* nsresult displayReport (in nsIPrompt prompt, in boolean showErrorOnly, in</span>
<a href="#l39.266"></a><span id="l39.266" class="difflineplus">+ * boolean dontShowReportTwice); */</span>
<a href="#l39.267"></a><span id="l39.267" class="difflineplus">+NS_IMETHODIMP nsMsgSendReport::DisplayReport(nsIPrompt *prompt,</span>
<a href="#l39.268"></a><span id="l39.268" class="difflineplus">+                                             bool showErrorOnly,</span>
<a href="#l39.269"></a><span id="l39.269" class="difflineplus">+                                             bool dontShowReportTwice,</span>
<a href="#l39.270"></a><span id="l39.270" class="difflineplus">+                                             nsresult *_retval) {</span>
<a href="#l39.271"></a><span id="l39.271">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l39.272"></a><span id="l39.272"> </span>
<a href="#l39.273"></a><span id="l39.273">   NS_ENSURE_TRUE(mCurrentProcess &gt;= 0 &amp;&amp; mCurrentProcess &lt;= SEND_LAST_PROCESS,</span>
<a href="#l39.274"></a><span id="l39.274">                  NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l39.275"></a><span id="l39.275"> </span>
<a href="#l39.276"></a><span id="l39.276">   nsresult currError = NS_OK;</span>
<a href="#l39.277"></a><span id="l39.277">   mProcessReport[mCurrentProcess]-&gt;GetError(&amp;currError);</span>
<a href="#l39.278"></a><span id="l39.278">   *_retval = currError;</span>
<a href="#l39.279"></a><span id="l39.279"> </span>
<a href="#l39.280"></a><span id="l39.280" class="difflineminus">-  if (dontShowReportTwice &amp;&amp; mAlreadyDisplayReport)</span>
<a href="#l39.281"></a><span id="l39.281" class="difflineminus">-    return NS_OK;</span>
<a href="#l39.282"></a><span id="l39.282" class="difflineplus">+  if (dontShowReportTwice &amp;&amp; mAlreadyDisplayReport) return NS_OK;</span>
<a href="#l39.283"></a><span id="l39.283"> </span>
<a href="#l39.284"></a><span id="l39.284" class="difflineminus">-  if (showErrorOnly &amp;&amp; NS_SUCCEEDED(currError))</span>
<a href="#l39.285"></a><span id="l39.285" class="difflineminus">-    return NS_OK;</span>
<a href="#l39.286"></a><span id="l39.286" class="difflineplus">+  if (showErrorOnly &amp;&amp; NS_SUCCEEDED(currError)) return NS_OK;</span>
<a href="#l39.287"></a><span id="l39.287"> </span>
<a href="#l39.288"></a><span id="l39.288">   nsString currMessage;</span>
<a href="#l39.289"></a><span id="l39.289">   mProcessReport[mCurrentProcess]-&gt;GetMessage(getter_Copies(currMessage));</span>
<a href="#l39.290"></a><span id="l39.290"> </span>
<a href="#l39.291"></a><span id="l39.291" class="difflineminus">-  nsresult rv; // don't step on currError.</span>
<a href="#l39.292"></a><span id="l39.292" class="difflineplus">+  nsresult rv;  // don't step on currError.</span>
<a href="#l39.293"></a><span id="l39.293">   nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l39.294"></a><span id="l39.294" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l39.295"></a><span id="l39.295" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l39.296"></a><span id="l39.296">   NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l39.297"></a><span id="l39.297">   nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l39.298"></a><span id="l39.298" class="difflineminus">-  rv = bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/messengercompose/composeMsgs.properties&quot;, getter_AddRefs(bundle));</span>
<a href="#l39.299"></a><span id="l39.299" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l39.300"></a><span id="l39.300" class="difflineminus">-  {</span>
<a href="#l39.301"></a><span id="l39.301" class="difflineminus">-    //TODO need to display a generic hardcoded message</span>
<a href="#l39.302"></a><span id="l39.302" class="difflineplus">+  rv = bundleService-&gt;CreateBundle(</span>
<a href="#l39.303"></a><span id="l39.303" class="difflineplus">+      &quot;chrome://messenger/locale/messengercompose/composeMsgs.properties&quot;,</span>
<a href="#l39.304"></a><span id="l39.304" class="difflineplus">+      getter_AddRefs(bundle));</span>
<a href="#l39.305"></a><span id="l39.305" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l39.306"></a><span id="l39.306" class="difflineplus">+    // TODO need to display a generic hardcoded message</span>
<a href="#l39.307"></a><span id="l39.307">     mAlreadyDisplayReport = true;</span>
<a href="#l39.308"></a><span id="l39.308">     return NS_OK;</span>
<a href="#l39.309"></a><span id="l39.309">   }</span>
<a href="#l39.310"></a><span id="l39.310"> </span>
<a href="#l39.311"></a><span id="l39.311">   nsString dialogTitle;</span>
<a href="#l39.312"></a><span id="l39.312">   nsString dialogMessage;</span>
<a href="#l39.313"></a><span id="l39.313"> </span>
<a href="#l39.314"></a><span id="l39.314" class="difflineminus">-  if (NS_SUCCEEDED(currError))</span>
<a href="#l39.315"></a><span id="l39.315" class="difflineminus">-  {</span>
<a href="#l39.316"></a><span id="l39.316" class="difflineminus">-    //TODO display a success error message</span>
<a href="#l39.317"></a><span id="l39.317" class="difflineplus">+  if (NS_SUCCEEDED(currError)) {</span>
<a href="#l39.318"></a><span id="l39.318" class="difflineplus">+    // TODO display a success error message</span>
<a href="#l39.319"></a><span id="l39.319">     return NS_OK;</span>
<a href="#l39.320"></a><span id="l39.320">   }</span>
<a href="#l39.321"></a><span id="l39.321"> </span>
<a href="#l39.322"></a><span id="l39.322" class="difflineminus">-  //Do we have an explanation of the error? if no, try to build one...</span>
<a href="#l39.323"></a><span id="l39.323" class="difflineminus">-  if (currMessage.IsEmpty())</span>
<a href="#l39.324"></a><span id="l39.324" class="difflineminus">-  {</span>
<a href="#l39.325"></a><span id="l39.325" class="difflineplus">+  // Do we have an explanation of the error? if no, try to build one...</span>
<a href="#l39.326"></a><span id="l39.326" class="difflineplus">+  if (currMessage.IsEmpty()) {</span>
<a href="#l39.327"></a><span id="l39.327"> #ifdef __GNUC__</span>
<a href="#l39.328"></a><span id="l39.328"> // Temporary workaround until bug 783526 is fixed.</span>
<a href="#l39.329"></a><span id="l39.329" class="difflineminus">-#pragma GCC diagnostic push</span>
<a href="#l39.330"></a><span id="l39.330" class="difflineminus">-#pragma GCC diagnostic ignored &quot;-Wswitch&quot;</span>
<a href="#l39.331"></a><span id="l39.331" class="difflineplus">+#  pragma GCC diagnostic push</span>
<a href="#l39.332"></a><span id="l39.332" class="difflineplus">+#  pragma GCC diagnostic ignored &quot;-Wswitch&quot;</span>
<a href="#l39.333"></a><span id="l39.333"> #endif</span>
<a href="#l39.334"></a><span id="l39.334" class="difflineminus">-    switch (currError)</span>
<a href="#l39.335"></a><span id="l39.335" class="difflineminus">-    {</span>
<a href="#l39.336"></a><span id="l39.336" class="difflineplus">+    switch (currError) {</span>
<a href="#l39.337"></a><span id="l39.337">       case NS_BINDING_ABORTED:</span>
<a href="#l39.338"></a><span id="l39.338">       case NS_MSG_UNABLE_TO_SEND_LATER:</span>
<a href="#l39.339"></a><span id="l39.339">       case NS_MSG_UNABLE_TO_SAVE_DRAFT:</span>
<a href="#l39.340"></a><span id="l39.340">       case NS_MSG_UNABLE_TO_SAVE_TEMPLATE:</span>
<a href="#l39.341"></a><span id="l39.341" class="difflineminus">-        //Ignore, don't need to repeat ourself.</span>
<a href="#l39.342"></a><span id="l39.342" class="difflineplus">+        // Ignore, don't need to repeat ourself.</span>
<a href="#l39.343"></a><span id="l39.343">         break;</span>
<a href="#l39.344"></a><span id="l39.344">       default:</span>
<a href="#l39.345"></a><span id="l39.345" class="difflineminus">-        const char* errorString = errorStringNameForErrorCode(currError);</span>
<a href="#l39.346"></a><span id="l39.346" class="difflineplus">+        const char *errorString = errorStringNameForErrorCode(currError);</span>
<a href="#l39.347"></a><span id="l39.347">         nsMsgGetMessageByName(errorString, currMessage);</span>
<a href="#l39.348"></a><span id="l39.348">         break;</span>
<a href="#l39.349"></a><span id="l39.349">     }</span>
<a href="#l39.350"></a><span id="l39.350"> #ifdef __GNUC__</span>
<a href="#l39.351"></a><span id="l39.351" class="difflineminus">-#pragma GCC diagnostic pop</span>
<a href="#l39.352"></a><span id="l39.352" class="difflineplus">+#  pragma GCC diagnostic pop</span>
<a href="#l39.353"></a><span id="l39.353"> #endif</span>
<a href="#l39.354"></a><span id="l39.354">   }</span>
<a href="#l39.355"></a><span id="l39.355"> </span>
<a href="#l39.356"></a><span id="l39.356" class="difflineminus">-  if (mDeliveryMode == nsIMsgCompDeliverMode::Now || mDeliveryMode == nsIMsgCompDeliverMode::SendUnsent)</span>
<a href="#l39.357"></a><span id="l39.357" class="difflineminus">-  {</span>
<a href="#l39.358"></a><span id="l39.358" class="difflineminus">-    // SMTP is taking care of it's own error message and will return NS_ERROR_BUT_DONT_SHOW_ALERT as error code.</span>
<a href="#l39.359"></a><span id="l39.359" class="difflineminus">-    // In that case, we must not show an alert ourself.</span>
<a href="#l39.360"></a><span id="l39.360" class="difflineminus">-    if (currError == NS_ERROR_BUT_DONT_SHOW_ALERT)</span>
<a href="#l39.361"></a><span id="l39.361" class="difflineminus">-    {</span>
<a href="#l39.362"></a><span id="l39.362" class="difflineplus">+  if (mDeliveryMode == nsIMsgCompDeliverMode::Now ||</span>
<a href="#l39.363"></a><span id="l39.363" class="difflineplus">+      mDeliveryMode == nsIMsgCompDeliverMode::SendUnsent) {</span>
<a href="#l39.364"></a><span id="l39.364" class="difflineplus">+    // SMTP is taking care of it's own error message and will return</span>
<a href="#l39.365"></a><span id="l39.365" class="difflineplus">+    // NS_ERROR_BUT_DONT_SHOW_ALERT as error code. In that case, we must not</span>
<a href="#l39.366"></a><span id="l39.366" class="difflineplus">+    // show an alert ourself.</span>
<a href="#l39.367"></a><span id="l39.367" class="difflineplus">+    if (currError == NS_ERROR_BUT_DONT_SHOW_ALERT) {</span>
<a href="#l39.368"></a><span id="l39.368">       mAlreadyDisplayReport = true;</span>
<a href="#l39.369"></a><span id="l39.369">       return NS_OK;</span>
<a href="#l39.370"></a><span id="l39.370">     }</span>
<a href="#l39.371"></a><span id="l39.371"> </span>
<a href="#l39.372"></a><span id="l39.372">     bundle-&gt;GetStringFromName(&quot;sendMessageErrorTitle&quot;, dialogTitle);</span>
<a href="#l39.373"></a><span id="l39.373"> </span>
<a href="#l39.374"></a><span id="l39.374" class="difflineminus">-    const char* preStrName = &quot;sendFailed&quot;;</span>
<a href="#l39.375"></a><span id="l39.375" class="difflineplus">+    const char *preStrName = &quot;sendFailed&quot;;</span>
<a href="#l39.376"></a><span id="l39.376">     bool askToGoBackToCompose = false;</span>
<a href="#l39.377"></a><span id="l39.377" class="difflineminus">-    switch (mCurrentProcess)</span>
<a href="#l39.378"></a><span id="l39.378" class="difflineminus">-    {</span>
<a href="#l39.379"></a><span id="l39.379" class="difflineminus">-      case process_BuildMessage :</span>
<a href="#l39.380"></a><span id="l39.380" class="difflineplus">+    switch (mCurrentProcess) {</span>
<a href="#l39.381"></a><span id="l39.381" class="difflineplus">+      case process_BuildMessage:</span>
<a href="#l39.382"></a><span id="l39.382">         preStrName = &quot;sendFailed&quot;;</span>
<a href="#l39.383"></a><span id="l39.383">         askToGoBackToCompose = false;</span>
<a href="#l39.384"></a><span id="l39.384">         break;</span>
<a href="#l39.385"></a><span id="l39.385" class="difflineminus">-      case process_NNTP :</span>
<a href="#l39.386"></a><span id="l39.386" class="difflineplus">+      case process_NNTP:</span>
<a href="#l39.387"></a><span id="l39.387">         preStrName = &quot;sendFailed&quot;;</span>
<a href="#l39.388"></a><span id="l39.388">         askToGoBackToCompose = false;</span>
<a href="#l39.389"></a><span id="l39.389">         break;</span>
<a href="#l39.390"></a><span id="l39.390" class="difflineminus">-      case process_SMTP :</span>
<a href="#l39.391"></a><span id="l39.391" class="difflineplus">+      case process_SMTP:</span>
<a href="#l39.392"></a><span id="l39.392">         bool nntpProceeded;</span>
<a href="#l39.393"></a><span id="l39.393">         mProcessReport[process_NNTP]-&gt;GetProceeded(&amp;nntpProceeded);</span>
<a href="#l39.394"></a><span id="l39.394">         if (nntpProceeded)</span>
<a href="#l39.395"></a><span id="l39.395">           preStrName = &quot;sendFailedButNntpOk&quot;;</span>
<a href="#l39.396"></a><span id="l39.396">         else</span>
<a href="#l39.397"></a><span id="l39.397">           preStrName = &quot;sendFailed&quot;;</span>
<a href="#l39.398"></a><span id="l39.398">         askToGoBackToCompose = false;</span>
<a href="#l39.399"></a><span id="l39.399">         break;</span>
<a href="#l39.400"></a><span id="l39.400" class="difflineat">@@ -336,56 +307,48 @@ NS_IMETHODIMP nsMsgSendReport::DisplayRe</span>
<a href="#l39.401"></a><span id="l39.401">         break;</span>
<a href="#l39.402"></a><span id="l39.402">       case process_FCC:</span>
<a href="#l39.403"></a><span id="l39.403">         preStrName = &quot;failedCopyOperation&quot;;</span>
<a href="#l39.404"></a><span id="l39.404">         askToGoBackToCompose = (mDeliveryMode == nsIMsgCompDeliverMode::Now);</span>
<a href="#l39.405"></a><span id="l39.405">         break;</span>
<a href="#l39.406"></a><span id="l39.406">     }</span>
<a href="#l39.407"></a><span id="l39.407">     bundle-&gt;GetStringFromName(preStrName, dialogMessage);</span>
<a href="#l39.408"></a><span id="l39.408"> </span>
<a href="#l39.409"></a><span id="l39.409" class="difflineminus">-    //Do we already have an error message?</span>
<a href="#l39.410"></a><span id="l39.410" class="difflineminus">-    if (!askToGoBackToCompose &amp;&amp; currMessage.IsEmpty())</span>
<a href="#l39.411"></a><span id="l39.411" class="difflineminus">-    {</span>
<a href="#l39.412"></a><span id="l39.412" class="difflineminus">-      //we don't have an error description but we can put a generic explanation</span>
<a href="#l39.413"></a><span id="l39.413" class="difflineplus">+    // Do we already have an error message?</span>
<a href="#l39.414"></a><span id="l39.414" class="difflineplus">+    if (!askToGoBackToCompose &amp;&amp; currMessage.IsEmpty()) {</span>
<a href="#l39.415"></a><span id="l39.415" class="difflineplus">+      // we don't have an error description but we can put a generic explanation</span>
<a href="#l39.416"></a><span id="l39.416">       bundle-&gt;GetStringFromName(&quot;genericFailureExplanation&quot;, currMessage);</span>
<a href="#l39.417"></a><span id="l39.417">     }</span>
<a href="#l39.418"></a><span id="l39.418"> </span>
<a href="#l39.419"></a><span id="l39.419" class="difflineminus">-    if (!currMessage.IsEmpty())</span>
<a href="#l39.420"></a><span id="l39.420" class="difflineminus">-    {</span>
<a href="#l39.421"></a><span id="l39.421" class="difflineminus">-      //Don't need to repeat ourself!</span>
<a href="#l39.422"></a><span id="l39.422" class="difflineminus">-      if (!currMessage.Equals(dialogMessage))</span>
<a href="#l39.423"></a><span id="l39.423" class="difflineminus">-      {</span>
<a href="#l39.424"></a><span id="l39.424" class="difflineminus">-        if (!dialogMessage.IsEmpty())</span>
<a href="#l39.425"></a><span id="l39.425" class="difflineminus">-          dialogMessage.Append(char16_t('\n'));</span>
<a href="#l39.426"></a><span id="l39.426" class="difflineplus">+    if (!currMessage.IsEmpty()) {</span>
<a href="#l39.427"></a><span id="l39.427" class="difflineplus">+      // Don't need to repeat ourself!</span>
<a href="#l39.428"></a><span id="l39.428" class="difflineplus">+      if (!currMessage.Equals(dialogMessage)) {</span>
<a href="#l39.429"></a><span id="l39.429" class="difflineplus">+        if (!dialogMessage.IsEmpty()) dialogMessage.Append(char16_t('\n'));</span>
<a href="#l39.430"></a><span id="l39.430">         dialogMessage.Append(currMessage);</span>
<a href="#l39.431"></a><span id="l39.431">       }</span>
<a href="#l39.432"></a><span id="l39.432">     }</span>
<a href="#l39.433"></a><span id="l39.433"> </span>
<a href="#l39.434"></a><span id="l39.434" class="difflineminus">-    if (askToGoBackToCompose)</span>
<a href="#l39.435"></a><span id="l39.435" class="difflineminus">-    {</span>
<a href="#l39.436"></a><span id="l39.436" class="difflineplus">+    if (askToGoBackToCompose) {</span>
<a href="#l39.437"></a><span id="l39.437">       bool oopsGiveMeBackTheComposeWindow = true;</span>
<a href="#l39.438"></a><span id="l39.438">       nsString text1;</span>
<a href="#l39.439"></a><span id="l39.439">       bundle-&gt;GetStringFromName(&quot;returnToComposeWindowQuestion&quot;, text1);</span>
<a href="#l39.440"></a><span id="l39.440" class="difflineminus">-      if (!dialogMessage.IsEmpty())</span>
<a href="#l39.441"></a><span id="l39.441" class="difflineminus">-        dialogMessage.AppendLiteral(&quot;\n&quot;);</span>
<a href="#l39.442"></a><span id="l39.442" class="difflineplus">+      if (!dialogMessage.IsEmpty()) dialogMessage.AppendLiteral(&quot;\n&quot;);</span>
<a href="#l39.443"></a><span id="l39.443">       dialogMessage.Append(text1);</span>
<a href="#l39.444"></a><span id="l39.444" class="difflineminus">-      nsMsgAskBooleanQuestionByString(prompt, dialogMessage.get(), &amp;oopsGiveMeBackTheComposeWindow, dialogTitle.get());</span>
<a href="#l39.445"></a><span id="l39.445" class="difflineminus">-      if (!oopsGiveMeBackTheComposeWindow)</span>
<a href="#l39.446"></a><span id="l39.446" class="difflineminus">-        *_retval = NS_OK;</span>
<a href="#l39.447"></a><span id="l39.447" class="difflineminus">-    }</span>
<a href="#l39.448"></a><span id="l39.448" class="difflineminus">-    else</span>
<a href="#l39.449"></a><span id="l39.449" class="difflineminus">-      nsMsgDisplayMessageByString(prompt, dialogMessage.get(), dialogTitle.get());</span>
<a href="#l39.450"></a><span id="l39.450" class="difflineminus">-  }</span>
<a href="#l39.451"></a><span id="l39.451" class="difflineminus">-  else</span>
<a href="#l39.452"></a><span id="l39.452" class="difflineminus">-  {</span>
<a href="#l39.453"></a><span id="l39.453" class="difflineminus">-    const char* title;</span>
<a href="#l39.454"></a><span id="l39.454" class="difflineminus">-    const char* messageName;</span>
<a href="#l39.455"></a><span id="l39.455" class="difflineplus">+      nsMsgAskBooleanQuestionByString(prompt, dialogMessage.get(),</span>
<a href="#l39.456"></a><span id="l39.456" class="difflineplus">+                                      &amp;oopsGiveMeBackTheComposeWindow,</span>
<a href="#l39.457"></a><span id="l39.457" class="difflineplus">+                                      dialogTitle.get());</span>
<a href="#l39.458"></a><span id="l39.458" class="difflineplus">+      if (!oopsGiveMeBackTheComposeWindow) *_retval = NS_OK;</span>
<a href="#l39.459"></a><span id="l39.459" class="difflineplus">+    } else</span>
<a href="#l39.460"></a><span id="l39.460" class="difflineplus">+      nsMsgDisplayMessageByString(prompt, dialogMessage.get(),</span>
<a href="#l39.461"></a><span id="l39.461" class="difflineplus">+                                  dialogTitle.get());</span>
<a href="#l39.462"></a><span id="l39.462" class="difflineplus">+  } else {</span>
<a href="#l39.463"></a><span id="l39.463" class="difflineplus">+    const char *title;</span>
<a href="#l39.464"></a><span id="l39.464" class="difflineplus">+    const char *messageName;</span>
<a href="#l39.465"></a><span id="l39.465"> </span>
<a href="#l39.466"></a><span id="l39.466" class="difflineminus">-    switch (mDeliveryMode)</span>
<a href="#l39.467"></a><span id="l39.467" class="difflineminus">-    {</span>
<a href="#l39.468"></a><span id="l39.468" class="difflineplus">+    switch (mDeliveryMode) {</span>
<a href="#l39.469"></a><span id="l39.469">       case nsIMsgCompDeliverMode::Later:</span>
<a href="#l39.470"></a><span id="l39.470">         title = &quot;sendLaterErrorTitle&quot;;</span>
<a href="#l39.471"></a><span id="l39.471">         messageName = &quot;unableToSendLater&quot;;</span>
<a href="#l39.472"></a><span id="l39.472">         break;</span>
<a href="#l39.473"></a><span id="l39.473"> </span>
<a href="#l39.474"></a><span id="l39.474">       case nsIMsgCompDeliverMode::AutoSaveAsDraft:</span>
<a href="#l39.475"></a><span id="l39.475">       case nsIMsgCompDeliverMode::SaveAsDraft:</span>
<a href="#l39.476"></a><span id="l39.476">         title = &quot;saveDraftErrorTitle&quot;;</span>
<a href="#l39.477"></a><span id="l39.477" class="difflineat">@@ -402,28 +365,24 @@ NS_IMETHODIMP nsMsgSendReport::DisplayRe</span>
<a href="#l39.478"></a><span id="l39.478">         title = &quot;sendMessageErrorTitle&quot;;</span>
<a href="#l39.479"></a><span id="l39.479">         messageName = &quot;sendFailed&quot;;</span>
<a href="#l39.480"></a><span id="l39.480">         break;</span>
<a href="#l39.481"></a><span id="l39.481">     }</span>
<a href="#l39.482"></a><span id="l39.482"> </span>
<a href="#l39.483"></a><span id="l39.483">     bundle-&gt;GetStringFromName(title, dialogTitle);</span>
<a href="#l39.484"></a><span id="l39.484">     bundle-&gt;GetStringFromName(messageName, dialogMessage);</span>
<a href="#l39.485"></a><span id="l39.485"> </span>
<a href="#l39.486"></a><span id="l39.486" class="difflineminus">-    //Do we have an error message...</span>
<a href="#l39.487"></a><span id="l39.487" class="difflineminus">-    if (currMessage.IsEmpty())</span>
<a href="#l39.488"></a><span id="l39.488" class="difflineminus">-    {</span>
<a href="#l39.489"></a><span id="l39.489" class="difflineminus">-      //we don't have an error description but we can put a generic explanation</span>
<a href="#l39.490"></a><span id="l39.490" class="difflineplus">+    // Do we have an error message...</span>
<a href="#l39.491"></a><span id="l39.491" class="difflineplus">+    if (currMessage.IsEmpty()) {</span>
<a href="#l39.492"></a><span id="l39.492" class="difflineplus">+      // we don't have an error description but we can put a generic explanation</span>
<a href="#l39.493"></a><span id="l39.493">       bundle-&gt;GetStringFromName(&quot;genericFailureExplanation&quot;, currMessage);</span>
<a href="#l39.494"></a><span id="l39.494">     }</span>
<a href="#l39.495"></a><span id="l39.495"> </span>
<a href="#l39.496"></a><span id="l39.496" class="difflineminus">-    if (!currMessage.IsEmpty())</span>
<a href="#l39.497"></a><span id="l39.497" class="difflineminus">-    {</span>
<a href="#l39.498"></a><span id="l39.498" class="difflineminus">-      if (!dialogMessage.IsEmpty())</span>
<a href="#l39.499"></a><span id="l39.499" class="difflineminus">-        dialogMessage.Append(char16_t('\n'));</span>
<a href="#l39.500"></a><span id="l39.500" class="difflineplus">+    if (!currMessage.IsEmpty()) {</span>
<a href="#l39.501"></a><span id="l39.501" class="difflineplus">+      if (!dialogMessage.IsEmpty()) dialogMessage.Append(char16_t('\n'));</span>
<a href="#l39.502"></a><span id="l39.502">       dialogMessage.Append(currMessage);</span>
<a href="#l39.503"></a><span id="l39.503">     }</span>
<a href="#l39.504"></a><span id="l39.504">     nsMsgDisplayMessageByString(prompt, dialogMessage.get(), dialogTitle.get());</span>
<a href="#l39.505"></a><span id="l39.505">   }</span>
<a href="#l39.506"></a><span id="l39.506"> </span>
<a href="#l39.507"></a><span id="l39.507">   mAlreadyDisplayReport = true;</span>
<a href="#l39.508"></a><span id="l39.508">   return NS_OK;</span>
<a href="#l39.509"></a><span id="l39.509"> }</span>
<a href="#l39.510"></a><span id="l39.510" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSendReport.h</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSendReport.h</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -5,42 +5,39 @@</span>
<a href="#l40.4"></a><span id="l40.4"> </span>
<a href="#l40.5"></a><span id="l40.5"> #ifndef __nsMsgSendReport_h__</span>
<a href="#l40.6"></a><span id="l40.6"> #define __nsMsgSendReport_h__</span>
<a href="#l40.7"></a><span id="l40.7"> </span>
<a href="#l40.8"></a><span id="l40.8"> #include &quot;nsIMsgSendReport.h&quot;</span>
<a href="#l40.9"></a><span id="l40.9"> #include &quot;nsString.h&quot;</span>
<a href="#l40.10"></a><span id="l40.10"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l40.11"></a><span id="l40.11"> </span>
<a href="#l40.12"></a><span id="l40.12" class="difflineminus">-class nsMsgProcessReport : public nsIMsgProcessReport</span>
<a href="#l40.13"></a><span id="l40.13" class="difflineminus">-{</span>
<a href="#l40.14"></a><span id="l40.14" class="difflineminus">-public:</span>
<a href="#l40.15"></a><span id="l40.15" class="difflineplus">+class nsMsgProcessReport : public nsIMsgProcessReport {</span>
<a href="#l40.16"></a><span id="l40.16" class="difflineplus">+ public:</span>
<a href="#l40.17"></a><span id="l40.17">   NS_DECL_ISUPPORTS</span>
<a href="#l40.18"></a><span id="l40.18">   NS_DECL_NSIMSGPROCESSREPORT</span>
<a href="#l40.19"></a><span id="l40.19"> </span>
<a href="#l40.20"></a><span id="l40.20">   nsMsgProcessReport();</span>
<a href="#l40.21"></a><span id="l40.21"> </span>
<a href="#l40.22"></a><span id="l40.22" class="difflineminus">-private:</span>
<a href="#l40.23"></a><span id="l40.23" class="difflineplus">+ private:</span>
<a href="#l40.24"></a><span id="l40.24">   virtual ~nsMsgProcessReport();</span>
<a href="#l40.25"></a><span id="l40.25" class="difflineminus">-  bool      mProceeded;</span>
<a href="#l40.26"></a><span id="l40.26" class="difflineminus">-  nsresult  mError;</span>
<a href="#l40.27"></a><span id="l40.27" class="difflineminus">-  nsString  mMessage;</span>
<a href="#l40.28"></a><span id="l40.28" class="difflineplus">+  bool mProceeded;</span>
<a href="#l40.29"></a><span id="l40.29" class="difflineplus">+  nsresult mError;</span>
<a href="#l40.30"></a><span id="l40.30" class="difflineplus">+  nsString mMessage;</span>
<a href="#l40.31"></a><span id="l40.31"> };</span>
<a href="#l40.32"></a><span id="l40.32"> </span>
<a href="#l40.33"></a><span id="l40.33" class="difflineminus">-</span>
<a href="#l40.34"></a><span id="l40.34" class="difflineminus">-class nsMsgSendReport : public nsIMsgSendReport</span>
<a href="#l40.35"></a><span id="l40.35" class="difflineminus">-{</span>
<a href="#l40.36"></a><span id="l40.36" class="difflineminus">-public:</span>
<a href="#l40.37"></a><span id="l40.37" class="difflineplus">+class nsMsgSendReport : public nsIMsgSendReport {</span>
<a href="#l40.38"></a><span id="l40.38" class="difflineplus">+ public:</span>
<a href="#l40.39"></a><span id="l40.39">   NS_DECL_ISUPPORTS</span>
<a href="#l40.40"></a><span id="l40.40">   NS_DECL_NSIMSGSENDREPORT</span>
<a href="#l40.41"></a><span id="l40.41"> </span>
<a href="#l40.42"></a><span id="l40.42">   nsMsgSendReport();</span>
<a href="#l40.43"></a><span id="l40.43"> </span>
<a href="#l40.44"></a><span id="l40.44" class="difflineminus">-private:</span>
<a href="#l40.45"></a><span id="l40.45" class="difflineplus">+ private:</span>
<a href="#l40.46"></a><span id="l40.46">   virtual ~nsMsgSendReport();</span>
<a href="#l40.47"></a><span id="l40.47" class="difflineminus">-  #define SEND_LAST_PROCESS  process_FCC</span>
<a href="#l40.48"></a><span id="l40.48" class="difflineplus">+#define SEND_LAST_PROCESS process_FCC</span>
<a href="#l40.49"></a><span id="l40.49">   nsCOMPtr&lt;nsIMsgProcessReport&gt; mProcessReport[SEND_LAST_PROCESS + 1];</span>
<a href="#l40.50"></a><span id="l40.50">   int32_t mDeliveryMode;</span>
<a href="#l40.51"></a><span id="l40.51">   int32_t mCurrentProcess;</span>
<a href="#l40.52"></a><span id="l40.52">   bool mAlreadyDisplayReport;</span>
<a href="#l40.53"></a><span id="l40.53"> };</span>
<a href="#l40.54"></a><span id="l40.54"> </span>
<a href="#l40.55"></a><span id="l40.55"> #endif</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

