<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 6825:1afa1ca536e6f71d431d3cd8fdec4a6251de6b9a</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 1afa1ca536e6f71d431d3cd8fdec4a6251de6b9a" />
<meta property="og:url" content="/comm-central/rev/1afa1ca536e6f71d431d3cd8fdec4a6251de6b9a" />
<meta property="og:description" content="Fix bug 618058 - Improve CalDAV WebDAV sync robustness and scalability. r=philipp" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 1afa1ca536e6f71d431d3cd8fdec4a6251de6b9a 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/1afa1ca536e6f71d431d3cd8fdec4a6251de6b9a">shortlog</a> |
<a href="/comm-central/log/1afa1ca536e6f71d431d3cd8fdec4a6251de6b9a">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/1afa1ca536e6f71d431d3cd8fdec4a6251de6b9a">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/1afa1ca536e6f71d431d3cd8fdec4a6251de6b9a">files</a> |
changeset |
<a href="/comm-central/raw-rev/1afa1ca536e6f71d431d3cd8fdec4a6251de6b9a">raw</a>  | <a href="/comm-central/archive/1afa1ca536e6f71d431d3cd8fdec4a6251de6b9a.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=618058">bug 618058</a> - Improve CalDAV WebDAV sync robustness and scalability. r=philipp
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#83;&#105;&#109;&#111;&#110;&#32;&#86;&#97;&#105;&#108;&#108;&#97;&#110;&#99;&#111;&#117;&#114;&#116;&#32;&#60;&#110;&#111;&#109;&#105;&#115;&#118;&#97;&#105;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 13 Dec 2010 16:01:27 +0100</td></tr>

<tr>
 <td>changeset 6825</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/1afa1ca536e6f71d431d3cd8fdec4a6251de6b9a">1afa1ca536e6f71d431d3cd8fdec4a6251de6b9a</a></td>
</tr>



<tr>
<td>parent 6824</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/75c93fbd10fe705c58a2e284ad81117cac93f039">75c93fbd10fe705c58a2e284ad81117cac93f039</a>
</td>
</tr>

<tr>
<td>child 6826</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/873e68c06d96764fcbc8b1ffc90f2dc62c1a82f5">873e68c06d96764fcbc8b1ffc90f2dc62c1a82f5</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=1afa1ca536e6f71d431d3cd8fdec4a6251de6b9a">5233</a></td></tr>
<tr><td>push user</td><td>mozilla@kewis.ch</td></tr>
<tr><td>push date</td><td class="date age">Mon, 13 Dec 2010 15:18:47 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@1afa1ca536e6 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=1afa1ca536e6f71d431d3cd8fdec4a6251de6b9a">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=1afa1ca536e6f71d431d3cd8fdec4a6251de6b9a&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1afa1ca536e6f71d431d3cd8fdec4a6251de6b9a&newProject=comm-central&newRevision=75c93fbd10fe705c58a2e284ad81117cac93f039&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1afa1ca536e6f71d431d3cd8fdec4a6251de6b9a&newProject=comm-central&newRevision=75c93fbd10fe705c58a2e284ad81117cac93f039&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1afa1ca536e6f71d431d3cd8fdec4a6251de6b9a&newProject=comm-central&newRevision=75c93fbd10fe705c58a2e284ad81117cac93f039&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28philipp%29&revcount=50">philipp</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=618058">618058</a></td></tr>




</table></div>

<div class="page_body description">Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=618058">bug 618058</a> - Improve CalDAV WebDAV sync robustness and scalability. r=philipp</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1afa1ca536e6f71d431d3cd8fdec4a6251de6b9a/calendar/providers/caldav/calDavCalendar.js">calendar/providers/caldav/calDavCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1afa1ca536e6f71d431d3cd8fdec4a6251de6b9a/calendar/providers/caldav/calDavCalendar.js">file</a> |
<a href="/comm-central/annotate/1afa1ca536e6f71d431d3cd8fdec4a6251de6b9a/calendar/providers/caldav/calDavCalendar.js">annotate</a> |
<a href="/comm-central/diff/1afa1ca536e6f71d431d3cd8fdec4a6251de6b9a/calendar/providers/caldav/calDavCalendar.js">diff</a> |
<a href="/comm-central/comparison/1afa1ca536e6f71d431d3cd8fdec4a6251de6b9a/calendar/providers/caldav/calDavCalendar.js">comparison</a> |
<a href="/comm-central/log/1afa1ca536e6f71d431d3cd8fdec4a6251de6b9a/calendar/providers/caldav/calDavCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1afa1ca536e6f71d431d3cd8fdec4a6251de6b9a/calendar/providers/caldav/calDavRequestHandlers.js">calendar/providers/caldav/calDavRequestHandlers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1afa1ca536e6f71d431d3cd8fdec4a6251de6b9a/calendar/providers/caldav/calDavRequestHandlers.js">file</a> |
<a href="/comm-central/annotate/1afa1ca536e6f71d431d3cd8fdec4a6251de6b9a/calendar/providers/caldav/calDavRequestHandlers.js">annotate</a> |
<a href="/comm-central/diff/1afa1ca536e6f71d431d3cd8fdec4a6251de6b9a/calendar/providers/caldav/calDavRequestHandlers.js">diff</a> |
<a href="/comm-central/comparison/1afa1ca536e6f71d431d3cd8fdec4a6251de6b9a/calendar/providers/caldav/calDavRequestHandlers.js">comparison</a> |
<a href="/comm-central/log/1afa1ca536e6f71d431d3cd8fdec4a6251de6b9a/calendar/providers/caldav/calDavRequestHandlers.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -366,21 +366,16 @@ calDavCalendar.prototype = {</span>
<a href="#l1.4"></a><span id="l1.4">     mTargetCalendar: null,</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6">     // Contains the last valid synctoken returned</span>
<a href="#l1.7"></a><span id="l1.7">     // from the server with Webdav Sync enabled servers</span>
<a href="#l1.8"></a><span id="l1.8">     mWebdavSyncToken: null,</span>
<a href="#l1.9"></a><span id="l1.9">     // Indicates that the server supports Webdav Sync</span>
<a href="#l1.10"></a><span id="l1.10">     // see: http://tools.ietf.org/html/draft-daboo-webdav-sync</span>
<a href="#l1.11"></a><span id="l1.11">     mHasWebdavSyncSupport: false,</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    // By default, assume that the server can return the calendar-data</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-    // property on a sync request, if not supported (ie: Apple Server),</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-    // a subsequent multiget needs to be sent to the server to retrieve</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-    // the calendar-data property.</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-    mHasWebdavSyncCalendarDataSupport: true,</span>
<a href="#l1.17"></a><span id="l1.17"> </span>
<a href="#l1.18"></a><span id="l1.18">     get authRealm() {</span>
<a href="#l1.19"></a><span id="l1.19">         return this.mAuthRealm;</span>
<a href="#l1.20"></a><span id="l1.20">     },</span>
<a href="#l1.21"></a><span id="l1.21"> </span>
<a href="#l1.22"></a><span id="l1.22">     /**</span>
<a href="#l1.23"></a><span id="l1.23">      * Builds a correctly encoded nsIURI based on the baseUri and the insert</span>
<a href="#l1.24"></a><span id="l1.24">      * string. The returned uri is basically the baseURI + aInsertString</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/providers/caldav/calDavRequestHandlers.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/providers/caldav/calDavRequestHandlers.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -366,35 +366,24 @@ webDavSyncHandler.prototype = {</span>
<a href="#l2.4"></a><span id="l2.4">             // check if maybe our calendar has become available</span>
<a href="#l2.5"></a><span id="l2.5">             this.calendar.checkDavResourceType(this.changeLogListener);</span>
<a href="#l2.6"></a><span id="l2.6">             return;</span>
<a href="#l2.7"></a><span id="l2.7">         }</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9">         let C = new Namespace(&quot;C&quot;, &quot;urn:ietf:params:xml:ns:caldav&quot;);</span>
<a href="#l2.10"></a><span id="l2.10">         let D = new Namespace(&quot;D&quot;, &quot;DAV:&quot;);</span>
<a href="#l2.11"></a><span id="l2.11">         default xml namespace = D;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-        let queryXml;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-        if (this.calendar.mHasWebdavSyncCalendarDataSupport) {</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-          queryXml = &lt;sync-collection xmlns:C={C}&gt;</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-            &lt;sync-token/&gt;</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-            &lt;prop&gt;</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-              &lt;getcontenttype/&gt;</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">-              &lt;getetag/&gt;</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-              &lt;C:calendar-data/&gt;</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineminus">-            &lt;/prop&gt;</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">-          &lt;/sync-collection&gt;;</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineminus">-        } else {</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineminus">-          queryXml = &lt;sync-collection&gt;</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+        let queryXml =</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+          &lt;sync-collection&gt;</span>
<a href="#l2.26"></a><span id="l2.26">             &lt;sync-token/&gt;</span>
<a href="#l2.27"></a><span id="l2.27">             &lt;prop&gt;</span>
<a href="#l2.28"></a><span id="l2.28">               &lt;getcontenttype/&gt;</span>
<a href="#l2.29"></a><span id="l2.29">               &lt;getetag/&gt;</span>
<a href="#l2.30"></a><span id="l2.30">             &lt;/prop&gt;</span>
<a href="#l2.31"></a><span id="l2.31">           &lt;/sync-collection&gt;;</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-        }</span>
<a href="#l2.33"></a><span id="l2.33"> </span>
<a href="#l2.34"></a><span id="l2.34">         if (this.calendar.mWebdavSyncToken &amp;&amp; this.calendar.mWebdavSyncToken.length &gt; 0) {</span>
<a href="#l2.35"></a><span id="l2.35">             queryXml.D::[&quot;sync-token&quot;] = this.calendar.mWebdavSyncToken;</span>
<a href="#l2.36"></a><span id="l2.36">         }</span>
<a href="#l2.37"></a><span id="l2.37"> </span>
<a href="#l2.38"></a><span id="l2.38">         let queryString = xmlHeader + queryXml.toXMLString();</span>
<a href="#l2.39"></a><span id="l2.39">         let requestUri = this.calendar.makeUri(null, this.baseUri);</span>
<a href="#l2.40"></a><span id="l2.40"> </span>
<a href="#l2.41"></a><span id="l2.41" class="difflineat">@@ -434,17 +423,17 @@ webDavSyncHandler.prototype = {</span>
<a href="#l2.42"></a><span id="l2.42">         // Invalidate sync token with 4xx errors that could indicate the</span>
<a href="#l2.43"></a><span id="l2.43">         // sync token has become invalid and do a refresh</span>
<a href="#l2.44"></a><span id="l2.44">         else if (this.calendar.mWebdavSyncToken != null &amp;&amp;</span>
<a href="#l2.45"></a><span id="l2.45">                  responseStatus &gt;= 400 &amp;&amp;</span>
<a href="#l2.46"></a><span id="l2.46">                  responseStatus &lt;= 499) {</span>
<a href="#l2.47"></a><span id="l2.47">             cal.LOG(&quot;CalDAV: Reseting sync token because server returned status code: &quot; + responseStatus);</span>
<a href="#l2.48"></a><span id="l2.48">             this._reader = null;</span>
<a href="#l2.49"></a><span id="l2.49">             this.calendar.mWebdavSyncToken=null;</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-            this.calendar.mTargetCalendar.deleteMetaData(&quot;sync-token&quot;);</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+            this.calendar.mTargetCalendar.deleteMetaData(&quot;webdav-sync-token&quot;);</span>
<a href="#l2.52"></a><span id="l2.52">             this.calendar.safeRefresh(this.changeLogListener);</span>
<a href="#l2.53"></a><span id="l2.53">         } else {</span>
<a href="#l2.54"></a><span id="l2.54">             cal.WARN(&quot;CalDAV: Error doing webdav sync: &quot; + responseStatus);</span>
<a href="#l2.55"></a><span id="l2.55">             this.calendar.reportDavError(Components.interfaces.calIErrors.DAV_REPORT_ERROR);</span>
<a href="#l2.56"></a><span id="l2.56">             if (this.calendar.isCached &amp;&amp; this.changeLogListener) {</span>
<a href="#l2.57"></a><span id="l2.57">                 this.changeLogListener.onResult({ status: Components.results.NS_ERROR_FAILURE },</span>
<a href="#l2.58"></a><span id="l2.58">                                                 Components.results.NS_ERROR_FAILURE);</span>
<a href="#l2.59"></a><span id="l2.59">             }</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineat">@@ -512,30 +501,29 @@ webDavSyncHandler.prototype = {</span>
<a href="#l2.61"></a><span id="l2.61">             return;</span>
<a href="#l2.62"></a><span id="l2.62">         }</span>
<a href="#l2.63"></a><span id="l2.63"> </span>
<a href="#l2.64"></a><span id="l2.64">         if (this.calendar.mWebdavSyncToken == null) {</span>
<a href="#l2.65"></a><span id="l2.65">             // null token means reset or first refresh indicating we did</span>
<a href="#l2.66"></a><span id="l2.66">             // a full sync; remove local items that were not returned in this full</span>
<a href="#l2.67"></a><span id="l2.67">             // sync</span>
<a href="#l2.68"></a><span id="l2.68">             for (let path in this.calendar.mPathIndex) {</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineminus">-                if (!this.itemsReported[path] &amp;&amp;</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-                    path.substr(0, this.baseUri.path.length) == this.baseUri.path) {</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+                if (!this.itemsReported[path]) {</span>
<a href="#l2.72"></a><span id="l2.72">                     this.calendar.deleteTargetCalendarItem(path);</span>
<a href="#l2.73"></a><span id="l2.73">                 }</span>
<a href="#l2.74"></a><span id="l2.74">             }</span>
<a href="#l2.75"></a><span id="l2.75">         }</span>
<a href="#l2.76"></a><span id="l2.76">         if (this.calendar.isCached) {</span>
<a href="#l2.77"></a><span id="l2.77">             this.calendar.superCalendar.endBatch();</span>
<a href="#l2.78"></a><span id="l2.78">         }</span>
<a href="#l2.79"></a><span id="l2.79"> </span>
<a href="#l2.80"></a><span id="l2.80">         if (!this.itemsNeedFetching.length) {</span>
<a href="#l2.81"></a><span id="l2.81">             if (this.newSyncToken) {</span>
<a href="#l2.82"></a><span id="l2.82">                 this.calendar.mWebdavSyncToken = this.newSyncToken;</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineminus">-                this.calendar.mTargetCalendar.setMetaData(&quot;sync-token&quot;,</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineplus">+                this.calendar.mTargetCalendar.setMetaData(&quot;webdav-sync-token&quot;,</span>
<a href="#l2.85"></a><span id="l2.85">                                                           this.newSyncToken);</span>
<a href="#l2.86"></a><span id="l2.86">                 cal.LOG(&quot;CalDAV: New webdav-sync Token: &quot; + this.calendar.mWebdavSyncToken);</span>
<a href="#l2.87"></a><span id="l2.87">             }</span>
<a href="#l2.88"></a><span id="l2.88">             this.calendar.finalizeUpdatedItems(this.changeLogListener,</span>
<a href="#l2.89"></a><span id="l2.89">                                                this.baseUri);</span>
<a href="#l2.90"></a><span id="l2.90">         } else {</span>
<a href="#l2.91"></a><span id="l2.91">             let multiget = new multigetSyncHandler(this.itemsNeedFetching,</span>
<a href="#l2.92"></a><span id="l2.92">                                                    this.calendar,</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineat">@@ -562,17 +550,16 @@ webDavSyncHandler.prototype = {</span>
<a href="#l2.94"></a><span id="l2.94">                 if (this.isInPropStat) {</span>
<a href="#l2.95"></a><span id="l2.95">                     this.tag = &quot;propstat_&quot; + aLocalName;</span>
<a href="#l2.96"></a><span id="l2.96">                 }</span>
<a href="#l2.97"></a><span id="l2.97">                 else {</span>
<a href="#l2.98"></a><span id="l2.98">                     this.tag = aLocalName;</span>
<a href="#l2.99"></a><span id="l2.99">                 }</span>
<a href="#l2.100"></a><span id="l2.100">                 this.currentResponse[this.tag] = &quot;&quot;;</span>
<a href="#l2.101"></a><span id="l2.101">                 break;</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineminus">-            case &quot;calendar-data&quot;:</span>
<a href="#l2.103"></a><span id="l2.103">             case &quot;href&quot;:</span>
<a href="#l2.104"></a><span id="l2.104">             case &quot;getetag&quot;:</span>
<a href="#l2.105"></a><span id="l2.105">             case &quot;getcontenttype&quot;:</span>
<a href="#l2.106"></a><span id="l2.106">             case &quot;sync-token&quot;:</span>
<a href="#l2.107"></a><span id="l2.107">                 this.tag = aLocalName.replace(/-/g,'');</span>
<a href="#l2.108"></a><span id="l2.108">                 this.currentResponse[this.tag ] = &quot;&quot;;</span>
<a href="#l2.109"></a><span id="l2.109">                 break;</span>
<a href="#l2.110"></a><span id="l2.110">         }</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineat">@@ -614,29 +601,17 @@ webDavSyncHandler.prototype = {</span>
<a href="#l2.112"></a><span id="l2.112">                             r.status.indexOf(&quot; 204&quot;) ||  // draft 0, 1 and 2 needed it so treat no status</span>
<a href="#l2.113"></a><span id="l2.113">                             r.status.indexOf(&quot; 201&quot;))) { // and status 201 and 204 the same</span>
<a href="#l2.114"></a><span id="l2.114">                     this.itemsReported[r.href] = r.getetag;</span>
<a href="#l2.115"></a><span id="l2.115">                     let itemId = this.calendar.mPathIndex[r.href];</span>
<a href="#l2.116"></a><span id="l2.116">                     let oldEtag = (itemId &amp;&amp; this.calendar.mItemInfoCache[itemId].etag);</span>
<a href="#l2.117"></a><span id="l2.117"> </span>
<a href="#l2.118"></a><span id="l2.118">                     if (!oldEtag || oldEtag != r.getetag) {</span>
<a href="#l2.119"></a><span id="l2.119">                         // Etag mismatch, getting new/updated item.</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineminus">-                        if (r.calendardata &amp;&amp; r.calendardata.length) {</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineminus">-                            this.changeCount++;</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineminus">-                            this.calendar.addTargetCalendarItem(r.href,</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineminus">-                                                                r.calendardata,</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineminus">-                                                                this.baseUri,</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineminus">-                                                                r.getetag,</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineminus">-                                                                null);</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineminus">-                        } else {</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineminus">-                            if (this.calendar.mHasWebdavSyncCalendarDataSupport) {</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineminus">-                                this.calendar.mHasWebdavSyncCalendarDataSupport = false;</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineminus">-                            }</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineminus">-                            this.itemsNeedFetching.push(r.href);</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineminus">-                        }</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineplus">+                        this.itemsNeedFetching.push(r.href);</span>
<a href="#l2.134"></a><span id="l2.134">                     }</span>
<a href="#l2.135"></a><span id="l2.135">                 // If the response element is still not handled, log an error</span>
<a href="#l2.136"></a><span id="l2.136">                 // only if the content-type is text/calendar or the</span>
<a href="#l2.137"></a><span id="l2.137">                 // response status is different than 404 not found.</span>
<a href="#l2.138"></a><span id="l2.138">                 // We don't care about response elements</span>
<a href="#l2.139"></a><span id="l2.139">                 // on non-calendar resources or whose status is not indicating</span>
<a href="#l2.140"></a><span id="l2.140">                 // a deleted resource.</span>
<a href="#l2.141"></a><span id="l2.141">                 } else if ((r.getcontenttype &amp;&amp;</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineat">@@ -791,17 +766,17 @@ multigetSyncHandler.prototype = {</span>
<a href="#l2.143"></a><span id="l2.143">         if (this.unhandledErrors) {</span>
<a href="#l2.144"></a><span id="l2.144">             this.calendar.superCalendar.endBatch();</span>
<a href="#l2.145"></a><span id="l2.145">             this.calendar.notifyGetFailed(&quot;multiget error&quot;, this.listener, this.changeLogListener);</span>
<a href="#l2.146"></a><span id="l2.146">             return;</span>
<a href="#l2.147"></a><span id="l2.147">         }</span>
<a href="#l2.148"></a><span id="l2.148">         if (this.itemsNeedFetching.length == 0) {</span>
<a href="#l2.149"></a><span id="l2.149">             if (this.newSyncToken) {</span>
<a href="#l2.150"></a><span id="l2.150">                 this.calendar.mWebdavSyncToken = this.newSyncToken;</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineminus">-                this.calendar.mTargetCalendar.setMetaData(&quot;sync-token&quot;, this.newSyncToken);</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineplus">+                this.calendar.mTargetCalendar.setMetaData(&quot;webdav-sync-token&quot;, this.newSyncToken);</span>
<a href="#l2.153"></a><span id="l2.153">               cal.LOG(&quot;CalDAV: New webdav-sync Token: &quot; + this.calendar.mWebdavSyncToken);</span>
<a href="#l2.154"></a><span id="l2.154">             }</span>
<a href="#l2.155"></a><span id="l2.155"> </span>
<a href="#l2.156"></a><span id="l2.156">             this.calendar.finalizeUpdatedItems(this.changeLogListener,</span>
<a href="#l2.157"></a><span id="l2.157">                                                this.baseUri);</span>
<a href="#l2.158"></a><span id="l2.158">         }</span>
<a href="#l2.159"></a><span id="l2.159">         if (!this._reader) {</span>
<a href="#l2.160"></a><span id="l2.160">             // No reader means there was a request error. The error is already</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

