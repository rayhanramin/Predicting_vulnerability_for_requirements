<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 25879:e8578ad1d60bf7956d6623058e3a857cb7a8e6a2</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ e8578ad1d60bf7956d6623058e3a857cb7a8e6a2" />
<meta property="og:url" content="/comm-central/rev/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2" />
<meta property="og:description" content="Bug 1518656 - Lint remaining parts of Mozmill extension; r=aceman" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / e8578ad1d60bf7956d6623058e3a857cb7a8e6a2 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2">shortlog</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2">files</a> |
changeset |
<a href="/comm-central/raw-rev/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2">raw</a>  | <a href="/comm-central/archive/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1518656">Bug 1518656</a> - Lint remaining parts of Mozmill extension; r=aceman
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 18 Feb 2019 15:30:33 +1300</td></tr>

<tr>
 <td>changeset 25879</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2">e8578ad1d60bf7956d6623058e3a857cb7a8e6a2</a></td>
</tr>



<tr>
<td>parent 25878</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/59888b1b19fbd67946637b9ef00baf750e2647fa">59888b1b19fbd67946637b9ef00baf750e2647fa</a>
</td>
</tr>

<tr>
<td>child 25880</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/02142f15a54b241643de8b1cd0bfb38907032a48">02142f15a54b241643de8b1cd0bfb38907032a48</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=e8578ad1d60bf7956d6623058e3a857cb7a8e6a2">15523</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Mon, 18 Feb 2019 02:31:36 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@8dbf6b5932f3 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=8dbf6b5932f323d2262ece8b608bc3961ed9b264">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=8dbf6b5932f323d2262ece8b608bc3961ed9b264&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=8dbf6b5932f323d2262ece8b608bc3961ed9b264&newProject=comm-central&newRevision=59888b1b19fbd67946637b9ef00baf750e2647fa&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=8dbf6b5932f323d2262ece8b608bc3961ed9b264&newProject=comm-central&newRevision=59888b1b19fbd67946637b9ef00baf750e2647fa&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=8dbf6b5932f323d2262ece8b608bc3961ed9b264&newProject=comm-central&newRevision=59888b1b19fbd67946637b9ef00baf750e2647fa&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28aceman%29&revcount=50">aceman</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1518656">1518656</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1518656">Bug 1518656</a> - Lint remaining parts of Mozmill extension; r=aceman</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/calendar/test/mozmill/invitations/test-imip-bar-eml.js">calendar/test/mozmill/invitations/test-imip-bar-eml.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/calendar/test/mozmill/invitations/test-imip-bar-eml.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/calendar/test/mozmill/invitations/test-imip-bar-eml.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/calendar/test/mozmill/invitations/test-imip-bar-eml.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/calendar/test/mozmill/invitations/test-imip-bar-eml.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/calendar/test/mozmill/invitations/test-imip-bar-eml.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/calendar/test/mozmill/shared-modules/test-calendar-utils.js">calendar/test/mozmill/shared-modules/test-calendar-utils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/calendar/test/mozmill/shared-modules/test-calendar-utils.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/calendar/test/mozmill/shared-modules/test-calendar-utils.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/calendar/test/mozmill/shared-modules/test-calendar-utils.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/calendar/test/mozmill/shared-modules/test-calendar-utils.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/calendar/test/mozmill/shared-modules/test-calendar-utils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/calendar/test/mozmill/shared-modules/test-item-editing-helpers.js">calendar/test/mozmill/shared-modules/test-item-editing-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/calendar/test/mozmill/shared-modules/test-item-editing-helpers.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/calendar/test/mozmill/shared-modules/test-item-editing-helpers.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/calendar/test/mozmill/shared-modules/test-item-editing-helpers.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/calendar/test/mozmill/shared-modules/test-item-editing-helpers.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/calendar/test/mozmill/shared-modules/test-item-editing-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/account/test-ab-whitelist.js">mail/test/mozmill/account/test-ab-whitelist.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/account/test-ab-whitelist.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/account/test-ab-whitelist.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/account/test-ab-whitelist.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/account/test-ab-whitelist.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/account/test-ab-whitelist.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/account/test-account-port-setting.js">mail/test/mozmill/account/test-account-port-setting.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/account/test-account-port-setting.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/account/test-account-port-setting.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/account/test-account-port-setting.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/account/test-account-port-setting.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/account/test-account-port-setting.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/account/test-account-settings-infrastructure.js">mail/test/mozmill/account/test-account-settings-infrastructure.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/account/test-account-settings-infrastructure.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/account/test-account-settings-infrastructure.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/account/test-account-settings-infrastructure.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/account/test-account-settings-infrastructure.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/account/test-account-settings-infrastructure.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/account/test-account-values.js">mail/test/mozmill/account/test-account-values.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/account/test-account-values.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/account/test-account-values.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/account/test-account-values.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/account/test-account-values.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/account/test-account-values.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/account/test-archive-options.js">mail/test/mozmill/account/test-archive-options.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/account/test-archive-options.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/account/test-archive-options.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/account/test-archive-options.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/account/test-archive-options.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/account/test-archive-options.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/account/test-mail-account-setup-wizard.js">mail/test/mozmill/account/test-mail-account-setup-wizard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/account/test-mail-account-setup-wizard.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/account/test-mail-account-setup-wizard.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/account/test-mail-account-setup-wizard.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/account/test-mail-account-setup-wizard.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/account/test-mail-account-setup-wizard.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/account/test-retest-config.js">mail/test/mozmill/account/test-retest-config.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/account/test-retest-config.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/account/test-retest-config.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/account/test-retest-config.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/account/test-retest-config.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/account/test-retest-config.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/attachment/test-attachment-events.js">mail/test/mozmill/attachment/test-attachment-events.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/attachment/test-attachment-events.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/attachment/test-attachment-events.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/attachment/test-attachment-events.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/attachment/test-attachment-events.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/attachment/test-attachment-events.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/attachment/test-attachment-in-plain-msg.js">mail/test/mozmill/attachment/test-attachment-in-plain-msg.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/attachment/test-attachment-in-plain-msg.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/attachment/test-attachment-in-plain-msg.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/attachment/test-attachment-in-plain-msg.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/attachment/test-attachment-in-plain-msg.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/attachment/test-attachment-in-plain-msg.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/attachment/test-attachment-menus.js">mail/test/mozmill/attachment/test-attachment-menus.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/attachment/test-attachment-menus.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/attachment/test-attachment-menus.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/attachment/test-attachment-menus.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/attachment/test-attachment-menus.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/attachment/test-attachment-menus.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/attachment/test-attachment-size.js">mail/test/mozmill/attachment/test-attachment-size.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/attachment/test-attachment-size.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/attachment/test-attachment-size.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/attachment/test-attachment-size.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/attachment/test-attachment-size.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/attachment/test-attachment-size.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/attachment/test-attachment.js">mail/test/mozmill/attachment/test-attachment.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/attachment/test-attachment.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/attachment/test-attachment.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/attachment/test-attachment.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/attachment/test-attachment.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/attachment/test-attachment.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-attachment.js">mail/test/mozmill/composition/test-attachment.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-attachment.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-attachment.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-attachment.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-attachment.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-attachment.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-base64-display.js">mail/test/mozmill/composition/test-base64-display.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-base64-display.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-base64-display.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-base64-display.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-base64-display.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-base64-display.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-blocked-content.js">mail/test/mozmill/composition/test-blocked-content.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-blocked-content.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-blocked-content.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-blocked-content.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-blocked-content.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-blocked-content.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-charset-edit.js">mail/test/mozmill/composition/test-charset-edit.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-charset-edit.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-charset-edit.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-charset-edit.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-charset-edit.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-charset-edit.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-cp932-display.js">mail/test/mozmill/composition/test-cp932-display.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-cp932-display.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-cp932-display.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-cp932-display.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-cp932-display.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-cp932-display.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-eml-actions.js">mail/test/mozmill/composition/test-eml-actions.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-eml-actions.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-eml-actions.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-eml-actions.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-eml-actions.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-eml-actions.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-forward-rfc822-attach.js">mail/test/mozmill/composition/test-forward-rfc822-attach.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-forward-rfc822-attach.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-forward-rfc822-attach.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-forward-rfc822-attach.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-forward-rfc822-attach.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-forward-rfc822-attach.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-forward-utf8.js">mail/test/mozmill/composition/test-forward-utf8.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-forward-utf8.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-forward-utf8.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-forward-utf8.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-forward-utf8.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-forward-utf8.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-forwarded-eml-actions.js">mail/test/mozmill/composition/test-forwarded-eml-actions.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-forwarded-eml-actions.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-forwarded-eml-actions.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-forwarded-eml-actions.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-forwarded-eml-actions.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-forwarded-eml-actions.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-image-display.js">mail/test/mozmill/composition/test-image-display.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-image-display.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-image-display.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-image-display.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-image-display.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-image-display.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-image-insertion-dialog.js">mail/test/mozmill/composition/test-image-insertion-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-image-insertion-dialog.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-image-insertion-dialog.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-image-insertion-dialog.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-image-insertion-dialog.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-image-insertion-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-multipart-related.js">mail/test/mozmill/composition/test-multipart-related.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-multipart-related.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-multipart-related.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-multipart-related.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-multipart-related.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-multipart-related.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-reply-format-flowed.js">mail/test/mozmill/composition/test-reply-format-flowed.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-reply-format-flowed.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-reply-format-flowed.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-reply-format-flowed.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-reply-format-flowed.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-reply-format-flowed.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-reply-multipart-charset.js">mail/test/mozmill/composition/test-reply-multipart-charset.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-reply-multipart-charset.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-reply-multipart-charset.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-reply-multipart-charset.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-reply-multipart-charset.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-reply-multipart-charset.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-send-button.js">mail/test/mozmill/composition/test-send-button.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-send-button.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-send-button.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-send-button.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-send-button.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-send-button.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-send-format.js">mail/test/mozmill/composition/test-send-format.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-send-format.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-send-format.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-send-format.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-send-format.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/composition/test-send-format.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/content-policy/test-general-content-policy.js">mail/test/mozmill/content-policy/test-general-content-policy.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/content-policy/test-general-content-policy.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/content-policy/test-general-content-policy.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/content-policy/test-general-content-policy.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/content-policy/test-general-content-policy.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/content-policy/test-general-content-policy.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/content-policy/test-view-source.js">mail/test/mozmill/content-policy/test-view-source.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/content-policy/test-view-source.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/content-policy/test-view-source.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/content-policy/test-view-source.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/content-policy/test-view-source.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/content-policy/test-view-source.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/content-tabs/test-addons-mgr.js">mail/test/mozmill/content-tabs/test-addons-mgr.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/content-tabs/test-addons-mgr.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/content-tabs/test-addons-mgr.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/content-tabs/test-addons-mgr.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/content-tabs/test-addons-mgr.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/content-tabs/test-addons-mgr.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/content-tabs/test-content-tab.js">mail/test/mozmill/content-tabs/test-content-tab.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/content-tabs/test-content-tab.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/content-tabs/test-content-tab.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/content-tabs/test-content-tab.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/content-tabs/test-content-tab.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/content-tabs/test-content-tab.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/content-tabs/test-install-xpi.js">mail/test/mozmill/content-tabs/test-install-xpi.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/content-tabs/test-install-xpi.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/content-tabs/test-install-xpi.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/content-tabs/test-install-xpi.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/content-tabs/test-install-xpi.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/content-tabs/test-install-xpi.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/content-tabs/test-lwthemes.js">mail/test/mozmill/content-tabs/test-lwthemes.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/content-tabs/test-lwthemes.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/content-tabs/test-lwthemes.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/content-tabs/test-lwthemes.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/content-tabs/test-lwthemes.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/content-tabs/test-lwthemes.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/downloads/test-about-downloads.js">mail/test/mozmill/downloads/test-about-downloads.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/downloads/test-about-downloads.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/downloads/test-about-downloads.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/downloads/test-about-downloads.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/downloads/test-about-downloads.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/downloads/test-about-downloads.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/folder-display/test-columns.js">mail/test/mozmill/folder-display/test-columns.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/folder-display/test-columns.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/folder-display/test-columns.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/folder-display/test-columns.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/folder-display/test-columns.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/folder-display/test-columns.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/folder-display/test-right-click-middle-click-messages.js">mail/test/mozmill/folder-display/test-right-click-middle-click-messages.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/folder-display/test-right-click-middle-click-messages.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/folder-display/test-right-click-middle-click-messages.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/folder-display/test-right-click-middle-click-messages.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/folder-display/test-right-click-middle-click-messages.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/folder-display/test-right-click-middle-click-messages.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/folder-widget/test-message-filters.js">mail/test/mozmill/folder-widget/test-message-filters.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/folder-widget/test-message-filters.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/folder-widget/test-message-filters.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/folder-widget/test-message-filters.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/folder-widget/test-message-filters.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/folder-widget/test-message-filters.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/instrumentation/test-instrument-setup.js">mail/test/mozmill/instrumentation/test-instrument-setup.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/instrumentation/test-instrument-setup.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/instrumentation/test-instrument-setup.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/instrumentation/test-instrument-setup.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/instrumentation/test-instrument-setup.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/instrumentation/test-instrument-setup.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/junk-commands/test-junk-commands.js">mail/test/mozmill/junk-commands/test-junk-commands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/junk-commands/test-junk-commands.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/junk-commands/test-junk-commands.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/junk-commands/test-junk-commands.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/junk-commands/test-junk-commands.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/junk-commands/test-junk-commands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-header/test-header-toolbar.js">mail/test/mozmill/message-header/test-header-toolbar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-header/test-header-toolbar.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-header/test-header-toolbar.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-header/test-header-toolbar.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-header/test-header-toolbar.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-header/test-header-toolbar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-header/test-message-header.js">mail/test/mozmill/message-header/test-message-header.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-header/test-message-header.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-header/test-message-header.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-header/test-message-header.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-header/test-message-header.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-header/test-message-header.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-header/test-phishing-bar.js">mail/test/mozmill/message-header/test-phishing-bar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-header/test-phishing-bar.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-header/test-phishing-bar.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-header/test-phishing-bar.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-header/test-phishing-bar.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-header/test-phishing-bar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-reader/test-bug594646.js">mail/test/mozmill/message-reader/test-bug594646.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-reader/test-bug594646.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-reader/test-bug594646.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-reader/test-bug594646.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-reader/test-bug594646.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-reader/test-bug594646.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-window/test-autohide-menubar.js">mail/test/mozmill/message-window/test-autohide-menubar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-window/test-autohide-menubar.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-window/test-autohide-menubar.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-window/test-autohide-menubar.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-window/test-autohide-menubar.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-window/test-autohide-menubar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-window/test-commands.js">mail/test/mozmill/message-window/test-commands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-window/test-commands.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-window/test-commands.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-window/test-commands.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-window/test-commands.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-window/test-commands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-window/test-eml-subject.js">mail/test/mozmill/message-window/test-eml-subject.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-window/test-eml-subject.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-window/test-eml-subject.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-window/test-eml-subject.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-window/test-eml-subject.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-window/test-eml-subject.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-window/test-vcard-actions.js">mail/test/mozmill/message-window/test-vcard-actions.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-window/test-vcard-actions.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-window/test-vcard-actions.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-window/test-vcard-actions.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-window/test-vcard-actions.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-window/test-vcard-actions.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-window/test-view-plaintext.js">mail/test/mozmill/message-window/test-view-plaintext.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-window/test-view-plaintext.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-window/test-view-plaintext.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-window/test-view-plaintext.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-window/test-view-plaintext.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/message-window/test-view-plaintext.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/newmailaccount/test-newmailaccount.js">mail/test/mozmill/newmailaccount/test-newmailaccount.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/newmailaccount/test-newmailaccount.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/newmailaccount/test-newmailaccount.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/newmailaccount/test-newmailaccount.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/newmailaccount/test-newmailaccount.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/newmailaccount/test-newmailaccount.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/runtest.py">mail/test/mozmill/runtest.py</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/runtest.py">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/runtest.py">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/runtest.py">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/runtest.py">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/runtest.py">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/session-store/test-session-store.js">mail/test/mozmill/session-store/test-session-store.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/session-store/test-session-store.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/session-store/test-session-store.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/session-store/test-session-store.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/session-store/test-session-store.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/session-store/test-session-store.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-account-manager-helpers.js">mail/test/mozmill/shared-modules/test-account-manager-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-account-manager-helpers.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-account-manager-helpers.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-account-manager-helpers.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-account-manager-helpers.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-account-manager-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">mail/test/mozmill/shared-modules/test-cloudfile-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-cloudfile-hightail-helpers.js">mail/test/mozmill/shared-modules/test-cloudfile-hightail-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-cloudfile-hightail-helpers.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-cloudfile-hightail-helpers.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-cloudfile-hightail-helpers.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-cloudfile-hightail-helpers.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-cloudfile-hightail-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-compose-helpers.js">mail/test/mozmill/shared-modules/test-compose-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-compose-helpers.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-compose-helpers.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-compose-helpers.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-compose-helpers.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-compose-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-content-tab-helpers.js">mail/test/mozmill/shared-modules/test-content-tab-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-content-tab-helpers.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-content-tab-helpers.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-content-tab-helpers.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-content-tab-helpers.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-content-tab-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-customization-helpers.js">mail/test/mozmill/shared-modules/test-customization-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-customization-helpers.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-customization-helpers.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-customization-helpers.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-customization-helpers.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-customization-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-dom-helpers.js">mail/test/mozmill/shared-modules/test-dom-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-dom-helpers.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-dom-helpers.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-dom-helpers.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-dom-helpers.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-dom-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">mail/test/mozmill/shared-modules/test-folder-display-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-junk-helpers.js">mail/test/mozmill/shared-modules/test-junk-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-junk-helpers.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-junk-helpers.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-junk-helpers.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-junk-helpers.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-junk-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-message-helpers.js">mail/test/mozmill/shared-modules/test-message-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-message-helpers.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-message-helpers.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-message-helpers.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-message-helpers.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-message-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-mouse-event-helpers.js">mail/test/mozmill/shared-modules/test-mouse-event-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-mouse-event-helpers.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-mouse-event-helpers.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-mouse-event-helpers.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-mouse-event-helpers.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-mouse-event-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-newmailaccount-helpers.js">mail/test/mozmill/shared-modules/test-newmailaccount-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-newmailaccount-helpers.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-newmailaccount-helpers.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-newmailaccount-helpers.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-newmailaccount-helpers.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-newmailaccount-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-pref-window-helpers.js">mail/test/mozmill/shared-modules/test-pref-window-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-pref-window-helpers.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-pref-window-helpers.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-pref-window-helpers.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-pref-window-helpers.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-pref-window-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-window-helpers.js">mail/test/mozmill/shared-modules/test-window-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-window-helpers.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-window-helpers.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-window-helpers.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-window-helpers.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/shared-modules/test-window-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/tabmail/test-tabmail-dragndrop.js">mail/test/mozmill/tabmail/test-tabmail-dragndrop.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/tabmail/test-tabmail-dragndrop.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/tabmail/test-tabmail-dragndrop.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/tabmail/test-tabmail-dragndrop.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/tabmail/test-tabmail-dragndrop.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/mozmill/tabmail/test-tabmail-dragndrop.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/__init__.py">mail/test/resources/mozmill/mozmill/__init__.py</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/__init__.py">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/__init__.py">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/__init__.py">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/__init__.py">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/__init__.py">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/controller.js">mail/test/resources/mozmill/mozmill/extension/content/modules/controller.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/controller.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/controller.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/controller.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/controller.jsm">mail/test/resources/mozmill/mozmill/extension/content/modules/controller.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/controller.jsm">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/controller.jsm">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/controller.jsm">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/controller.jsm">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/controller.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/elementslib.js">mail/test/resources/mozmill/mozmill/extension/content/modules/elementslib.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/elementslib.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/elementslib.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/elementslib.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/elementslib.jsm">mail/test/resources/mozmill/mozmill/extension/content/modules/elementslib.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/elementslib.jsm">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/elementslib.jsm">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/elementslib.jsm">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/elementslib.jsm">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/elementslib.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/events.js">mail/test/resources/mozmill/mozmill/extension/content/modules/events.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/events.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/events.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/events.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/events.jsm">mail/test/resources/mozmill/mozmill/extension/content/modules/events.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/events.jsm">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/events.jsm">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/events.jsm">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/events.jsm">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/events.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/frame.js">mail/test/resources/mozmill/mozmill/extension/content/modules/frame.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/frame.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/frame.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/frame.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/frame.jsm">mail/test/resources/mozmill/mozmill/extension/content/modules/frame.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/frame.jsm">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/frame.jsm">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/frame.jsm">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/frame.jsm">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/frame.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/init.js">mail/test/resources/mozmill/mozmill/extension/content/modules/init.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/init.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/init.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/init.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/init.jsm">mail/test/resources/mozmill/mozmill/extension/content/modules/init.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/init.jsm">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/init.jsm">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/init.jsm">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/init.jsm">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/init.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/inspection.js">mail/test/resources/mozmill/mozmill/extension/content/modules/inspection.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/inspection.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/inspection.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/inspection.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/jum.js">mail/test/resources/mozmill/mozmill/extension/content/modules/jum.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/jum.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/jum.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/jum.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/jum.jsm">mail/test/resources/mozmill/mozmill/extension/content/modules/jum.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/jum.jsm">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/jum.jsm">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/jum.jsm">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/jum.jsm">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/jum.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/mozmill.js">mail/test/resources/mozmill/mozmill/extension/content/modules/mozmill.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/mozmill.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/mozmill.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/mozmill.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/mozmill.jsm">mail/test/resources/mozmill/mozmill/extension/content/modules/mozmill.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/mozmill.jsm">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/mozmill.jsm">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/mozmill.jsm">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/mozmill.jsm">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/mozmill.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/utils.js">mail/test/resources/mozmill/mozmill/extension/content/modules/utils.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/utils.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/utils.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/utils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/utils.jsm">mail/test/resources/mozmill/mozmill/extension/content/modules/utils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/utils.jsm">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/utils.jsm">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/utils.jsm">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/utils.jsm">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/modules/utils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/overlay.js">mail/test/resources/mozmill/mozmill/extension/content/overlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/overlay.js">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/overlay.js">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/overlay.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/overlay.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/overlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/EventUtils.js">mail/test/resources/mozmill/mozmill/extension/content/stdlib/EventUtils.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/EventUtils.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/EventUtils.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/EventUtils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/EventUtils.jsm">mail/test/resources/mozmill/mozmill/extension/content/stdlib/EventUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/EventUtils.jsm">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/EventUtils.jsm">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/EventUtils.jsm">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/EventUtils.jsm">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/EventUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/arrays.js">mail/test/resources/mozmill/mozmill/extension/content/stdlib/arrays.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/arrays.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/arrays.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/arrays.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/arrays.jsm">mail/test/resources/mozmill/mozmill/extension/content/stdlib/arrays.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/arrays.jsm">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/arrays.jsm">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/arrays.jsm">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/arrays.jsm">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/arrays.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/dom.js">mail/test/resources/mozmill/mozmill/extension/content/stdlib/dom.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/dom.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/dom.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/dom.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/dom.jsm">mail/test/resources/mozmill/mozmill/extension/content/stdlib/dom.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/dom.jsm">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/dom.jsm">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/dom.jsm">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/dom.jsm">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/dom.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/httpd.js">mail/test/resources/mozmill/mozmill/extension/content/stdlib/httpd.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/httpd.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/httpd.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/httpd.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/httpd.jsm">mail/test/resources/mozmill/mozmill/extension/content/stdlib/httpd.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/httpd.jsm">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/httpd.jsm">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/httpd.jsm">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/httpd.jsm">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/httpd.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/json2.js">mail/test/resources/mozmill/mozmill/extension/content/stdlib/json2.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/json2.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/json2.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/json2.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/objects.js">mail/test/resources/mozmill/mozmill/extension/content/stdlib/objects.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/objects.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/objects.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/objects.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/os.js">mail/test/resources/mozmill/mozmill/extension/content/stdlib/os.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/os.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/os.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/os.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/os.jsm">mail/test/resources/mozmill/mozmill/extension/content/stdlib/os.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/os.jsm">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/os.jsm">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/os.jsm">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/os.jsm">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/os.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/securable-module.js">mail/test/resources/mozmill/mozmill/extension/content/stdlib/securable-module.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/securable-module.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/securable-module.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/securable-module.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/securable-module.jsm">mail/test/resources/mozmill/mozmill/extension/content/stdlib/securable-module.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/securable-module.jsm">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/securable-module.jsm">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/securable-module.jsm">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/securable-module.jsm">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/securable-module.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/strings.js">mail/test/resources/mozmill/mozmill/extension/content/stdlib/strings.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/strings.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/strings.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/strings.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/strings.jsm">mail/test/resources/mozmill/mozmill/extension/content/stdlib/strings.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/strings.jsm">file</a> |
<a href="/comm-central/annotate/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/strings.jsm">annotate</a> |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/strings.jsm">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/strings.jsm">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/strings.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/withs.js">mail/test/resources/mozmill/mozmill/extension/content/stdlib/withs.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/withs.js">diff</a> |
<a href="/comm-central/comparison/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/withs.js">comparison</a> |
<a href="/comm-central/log/e8578ad1d60bf7956d6623058e3a857cb7a8e6a2/mail/test/resources/mozmill/mozmill/extension/content/stdlib/withs.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/test/mozmill/invitations/test-imip-bar-eml.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/test/mozmill/invitations/test-imip-bar-eml.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -8,18 +8,17 @@</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5"> // make -C calendar/test/mozmill SOLO_TEST=invitations/test-imip-bar-eml.js mozmill-one</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> var MODULE_NAME = &quot;testInvitations&quot;;</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l1.10"></a><span id="l1.10"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;, &quot;notificationbox-helpers&quot;];</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-var os = {};</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.js&quot;, os);</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16"> function setupModule(module) {</span>
<a href="#l1.17"></a><span id="l1.17">     for (let dep of MODULE_REQUIRES) {</span>
<a href="#l1.18"></a><span id="l1.18">         collector.getModule(dep).installInto(module);</span>
<a href="#l1.19"></a><span id="l1.19">     }</span>
<a href="#l1.20"></a><span id="l1.20"> }</span>
<a href="#l1.21"></a><span id="l1.21"> </span>
<a href="#l1.22"></a><span id="l1.22"> /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/test/mozmill/shared-modules/test-calendar-utils.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/test/mozmill/shared-modules/test-calendar-utils.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -2,22 +2,17 @@</span>
<a href="#l2.4"></a><span id="l2.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.5"></a><span id="l2.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7"> var MODULE_NAME = &quot;calendar-utils&quot;;</span>
<a href="#l2.8"></a><span id="l2.8"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l2.9"></a><span id="l2.9"> var MODULE_REQUIRES = [&quot;window-helpers&quot;, &quot;folder-display-helpers&quot;, &quot;pref-window-helpers&quot;];</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-var os = {};</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.js&quot;, os);</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-var frame = {};</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-ChromeUtils.import(&quot;chrome://mozmill/content/modules/frame.js&quot;, frame);</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-var utils = {};</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.js&quot;, utils);</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.jsm&quot;);</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20"> var SHORT_SLEEP = 100;</span>
<a href="#l2.21"></a><span id="l2.21"> var MID_SLEEP = 500;</span>
<a href="#l2.22"></a><span id="l2.22"> var TIMEOUT_MODAL_DIALOG = 30000;</span>
<a href="#l2.23"></a><span id="l2.23"> var TIMEOUT_MONTHCHANGE = 10000;</span>
<a href="#l2.24"></a><span id="l2.24"> var CALENDARNAME = &quot;Mozmill&quot;;</span>
<a href="#l2.25"></a><span id="l2.25"> </span>
<a href="#l2.26"></a><span id="l2.26"> // These are used in EventBox lookup.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/test/mozmill/shared-modules/test-item-editing-helpers.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/test/mozmill/shared-modules/test-item-editing-helpers.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,18 +1,16 @@</span>
<a href="#l3.4"></a><span id="l3.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.5"></a><span id="l3.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.6"></a><span id="l3.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8"> var MODULE_NAME = &quot;item-editing-helpers&quot;;</span>
<a href="#l3.9"></a><span id="l3.9"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l3.10"></a><span id="l3.10"> var MODULE_REQUIRES = [&quot;calendar-utils&quot;, &quot;window-helpers&quot;];</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-var EventUtils = {};</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/EventUtils.js&quot;, EventUtils);</span>
<a href="#l3.14"></a><span id="l3.14"> var { cal } = ChromeUtils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l3.15"></a><span id="l3.15"> </span>
<a href="#l3.16"></a><span id="l3.16"> var SHORT_SLEEP, TIMEOUT_MODAL_DIALOG;</span>
<a href="#l3.17"></a><span id="l3.17"> var helpersForController, menulistSelect;</span>
<a href="#l3.18"></a><span id="l3.18"> var plan_for_modal_dialog, wait_for_modal_dialog;</span>
<a href="#l3.19"></a><span id="l3.19"> </span>
<a href="#l3.20"></a><span id="l3.20"> function setupModule(module) {</span>
<a href="#l3.21"></a><span id="l3.21">     controller = mozmill.getMail3PaneController();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/test/mozmill/account/test-ab-whitelist.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/test/mozmill/account/test-ab-whitelist.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -5,19 +5,19 @@</span>
<a href="#l4.4"></a><span id="l4.4"> &quot;use strict&quot;;</span>
<a href="#l4.5"></a><span id="l4.5"> </span>
<a href="#l4.6"></a><span id="l4.6"> var MODULE_NAME = &quot;test-ab-whitelist&quot;;</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l4.9"></a><span id="l4.9"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;,</span>
<a href="#l4.10"></a><span id="l4.10">                        &quot;account-manager-helpers&quot;, &quot;keyboard-helpers&quot; ];</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-var mozmill = ChromeUtils.import(&quot;chrome://mozmill/content/modules/mozmill.js&quot;);</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-var controller = ChromeUtils.import(&quot;chrome://mozmill/content/modules/controller.js&quot;);</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+var mozmill = ChromeUtils.import(&quot;chrome://mozmill/content/modules/mozmill.jsm&quot;);</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+var controller = ChromeUtils.import(&quot;chrome://mozmill/content/modules/controller.jsm&quot;);</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l4.18"></a><span id="l4.18"> </span>
<a href="#l4.19"></a><span id="l4.19"> var gOldWhiteList = null;</span>
<a href="#l4.20"></a><span id="l4.20"> var gKeyString = null;</span>
<a href="#l4.21"></a><span id="l4.21"> </span>
<a href="#l4.22"></a><span id="l4.22"> var gAccount = null;</span>
<a href="#l4.23"></a><span id="l4.23"> </span>
<a href="#l4.24"></a><span id="l4.24"> function setupModule(module) {</span>
<a href="#l4.25"></a><span id="l4.25">   let wh = collector.getModule(&quot;window-helpers&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/test/mozmill/account/test-account-port-setting.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/test/mozmill/account/test-account-port-setting.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -5,17 +5,17 @@</span>
<a href="#l5.4"></a><span id="l5.4"> &quot;use strict&quot;;</span>
<a href="#l5.5"></a><span id="l5.5"> </span>
<a href="#l5.6"></a><span id="l5.6"> var MODULE_NAME = &quot;test-account-port-setting&quot;;</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l5.9"></a><span id="l5.9"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;,</span>
<a href="#l5.10"></a><span id="l5.10">                        &quot;account-manager-helpers&quot;, &quot;keyboard-helpers&quot; ];</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l5.14"></a><span id="l5.14"> </span>
<a href="#l5.15"></a><span id="l5.15"> var PORT_NUMBERS_TO_TEST =</span>
<a href="#l5.16"></a><span id="l5.16">   [</span>
<a href="#l5.17"></a><span id="l5.17">     &quot;110&quot;, // The original port number. We don't input this though.</span>
<a href="#l5.18"></a><span id="l5.18">     &quot;456&quot;, // Random port number.</span>
<a href="#l5.19"></a><span id="l5.19">     &quot;995&quot;, // The SSL port number.</span>
<a href="#l5.20"></a><span id="l5.20">     &quot;110&quot;  // Back to the original.</span>
<a href="#l5.21"></a><span id="l5.21">   ];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/test/mozmill/account/test-account-settings-infrastructure.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/test/mozmill/account/test-account-settings-infrastructure.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -13,17 +13,17 @@</span>
<a href="#l6.4"></a><span id="l6.4"> &quot;use strict&quot;;</span>
<a href="#l6.5"></a><span id="l6.5"> </span>
<a href="#l6.6"></a><span id="l6.6"> var MODULE_NAME = &quot;test-account-settings-infrastructure&quot;;</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l6.9"></a><span id="l6.9"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;,</span>
<a href="#l6.10"></a><span id="l6.10">                          &quot;account-manager-helpers&quot;];</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l6.14"></a><span id="l6.14"> </span>
<a href="#l6.15"></a><span id="l6.15"> var gPopAccount, gImapAccount, gOriginalAccountCount;</span>
<a href="#l6.16"></a><span id="l6.16"> </span>
<a href="#l6.17"></a><span id="l6.17"> function setupModule(module) {</span>
<a href="#l6.18"></a><span id="l6.18">   collector.getModule(&quot;window-helpers&quot;).installInto(module);</span>
<a href="#l6.19"></a><span id="l6.19">   collector.getModule(&quot;folder-display-helpers&quot;).installInto(module);</span>
<a href="#l6.20"></a><span id="l6.20">   collector.getModule(&quot;account-manager-helpers&quot;).installInto(module);</span>
<a href="#l6.21"></a><span id="l6.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/test/mozmill/account/test-account-values.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/test/mozmill/account/test-account-values.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -10,17 +10,17 @@</span>
<a href="#l7.4"></a><span id="l7.4"> &quot;use strict&quot;;</span>
<a href="#l7.5"></a><span id="l7.5"> </span>
<a href="#l7.6"></a><span id="l7.6"> var MODULE_NAME = &quot;test-account-values&quot;;</span>
<a href="#l7.7"></a><span id="l7.7"> </span>
<a href="#l7.8"></a><span id="l7.8"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l7.9"></a><span id="l7.9"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;,</span>
<a href="#l7.10"></a><span id="l7.10">                        &quot;account-manager-helpers&quot;, &quot;keyboard-helpers&quot;];</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l7.14"></a><span id="l7.14"> </span>
<a href="#l7.15"></a><span id="l7.15"> var gPopAccount, gOriginalAccountCount;</span>
<a href="#l7.16"></a><span id="l7.16"> </span>
<a href="#l7.17"></a><span id="l7.17"> function setupModule(module) {</span>
<a href="#l7.18"></a><span id="l7.18">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l7.19"></a><span id="l7.19">     collector.getModule(lib).installInto(module);</span>
<a href="#l7.20"></a><span id="l7.20">   }</span>
<a href="#l7.21"></a><span id="l7.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/test/mozmill/account/test-archive-options.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/test/mozmill/account/test-archive-options.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -5,19 +5,19 @@</span>
<a href="#l8.4"></a><span id="l8.4"> &quot;use strict&quot;;</span>
<a href="#l8.5"></a><span id="l8.5"> </span>
<a href="#l8.6"></a><span id="l8.6"> var MODULE_NAME = &quot;test-archive-options&quot;;</span>
<a href="#l8.7"></a><span id="l8.7"> </span>
<a href="#l8.8"></a><span id="l8.8"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l8.9"></a><span id="l8.9"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;,</span>
<a href="#l8.10"></a><span id="l8.10">                        &quot;account-manager-helpers&quot;];</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-var mozmill = ChromeUtils.import(&quot;chrome://mozmill/content/modules/mozmill.js&quot;);</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-var controller = ChromeUtils.import(&quot;chrome://mozmill/content/modules/controller.js&quot;);</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+var mozmill = ChromeUtils.import(&quot;chrome://mozmill/content/modules/mozmill.jsm&quot;);</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+var controller = ChromeUtils.import(&quot;chrome://mozmill/content/modules/controller.jsm&quot;);</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l8.18"></a><span id="l8.18"> </span>
<a href="#l8.19"></a><span id="l8.19"> var defaultIdentity;</span>
<a href="#l8.20"></a><span id="l8.20"> </span>
<a href="#l8.21"></a><span id="l8.21"> function setupModule(module) {</span>
<a href="#l8.22"></a><span id="l8.22">   let wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l8.23"></a><span id="l8.23">   wh.installInto(module);</span>
<a href="#l8.24"></a><span id="l8.24">   let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l8.25"></a><span id="l8.25">   fdh.installInto(module);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/test/mozmill/account/test-mail-account-setup-wizard.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/test/mozmill/account/test-mail-account-setup-wizard.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -8,17 +8,17 @@ var MODULE_NAME = &quot;test-mail-account-set</span>
<a href="#l9.4"></a><span id="l9.4"> </span>
<a href="#l9.5"></a><span id="l9.5"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l9.6"></a><span id="l9.6"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;,</span>
<a href="#l9.7"></a><span id="l9.7">                        &quot;account-manager-helpers&quot;, &quot;keyboard-helpers&quot;];</span>
<a href="#l9.8"></a><span id="l9.8"> </span>
<a href="#l9.9"></a><span id="l9.9"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l9.10"></a><span id="l9.10"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l9.14"></a><span id="l9.14"> </span>
<a href="#l9.15"></a><span id="l9.15"> var user = {</span>
<a href="#l9.16"></a><span id="l9.16">   name: &quot;Yamato Nadeshiko&quot;,</span>
<a href="#l9.17"></a><span id="l9.17">   email: &quot;yamato.nadeshiko@example.com&quot;,</span>
<a href="#l9.18"></a><span id="l9.18">   password: &quot;abc12345&quot;,</span>
<a href="#l9.19"></a><span id="l9.19">   incomingHost: &quot;testin.example.com&quot;,</span>
<a href="#l9.20"></a><span id="l9.20">   outgoingHost: &quot;testout.example.com&quot;,</span>
<a href="#l9.21"></a><span id="l9.21"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/test/mozmill/account/test-retest-config.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/test/mozmill/account/test-retest-config.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -5,17 +5,17 @@</span>
<a href="#l10.4"></a><span id="l10.4"> &quot;use strict&quot;;</span>
<a href="#l10.5"></a><span id="l10.5"> </span>
<a href="#l10.6"></a><span id="l10.6"> var MODULE_NAME = &quot;test-retest-config&quot;;</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l10.9"></a><span id="l10.9"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;,</span>
<a href="#l10.10"></a><span id="l10.10">                        &quot;keyboard-helpers&quot;, &quot;account-manager-helpers&quot;];</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l10.14"></a><span id="l10.14"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l10.15"></a><span id="l10.15"> </span>
<a href="#l10.16"></a><span id="l10.16"> var user = {</span>
<a href="#l10.17"></a><span id="l10.17">   name: &quot;test&quot;,</span>
<a href="#l10.18"></a><span id="l10.18">   email: &quot;test@momo.invalid&quot;,</span>
<a href="#l10.19"></a><span id="l10.19">   altEmail: &quot;test2@momo.invalid&quot;</span>
<a href="#l10.20"></a><span id="l10.20"> };</span>
<a href="#l10.21"></a><span id="l10.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/test/mozmill/attachment/test-attachment-events.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/test/mozmill/attachment/test-attachment-events.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -13,17 +13,17 @@ var MODULE_NAME = 'test-attachment-event</span>
<a href="#l11.4"></a><span id="l11.4"> var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l11.5"></a><span id="l11.5"> var MODULE_REQUIRES = ['folder-display-helpers',</span>
<a href="#l11.6"></a><span id="l11.6">                        'compose-helpers',</span>
<a href="#l11.7"></a><span id="l11.7">                        'window-helpers',</span>
<a href="#l11.8"></a><span id="l11.8">                        'attachment-helpers',</span>
<a href="#l11.9"></a><span id="l11.9">                        'observer-helpers',</span>
<a href="#l11.10"></a><span id="l11.10">                        'prompt-helpers'];</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.js&quot;);</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l11.14"></a><span id="l11.14"> </span>
<a href="#l11.15"></a><span id="l11.15"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l11.16"></a><span id="l11.16"> var {fixIterator} = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l11.17"></a><span id="l11.17"> </span>
<a href="#l11.18"></a><span id="l11.18"> var kAttachmentsAdded = &quot;attachments-added&quot;;</span>
<a href="#l11.19"></a><span id="l11.19"> var kAttachmentsRemoved = &quot;attachments-removed&quot;;</span>
<a href="#l11.20"></a><span id="l11.20"> var kAttachmentRenamed = &quot;attachment-renamed&quot;;</span>
<a href="#l11.21"></a><span id="l11.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/test/mozmill/attachment/test-attachment-in-plain-msg.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/test/mozmill/attachment/test-attachment-in-plain-msg.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -7,17 +7,17 @@</span>
<a href="#l12.4"></a><span id="l12.4"> &quot;use strict&quot;;</span>
<a href="#l12.5"></a><span id="l12.5"> </span>
<a href="#l12.6"></a><span id="l12.6"> var MODULE_NAME = &quot;test-attachment-in-plain-msg&quot;;</span>
<a href="#l12.7"></a><span id="l12.7"> </span>
<a href="#l12.8"></a><span id="l12.8"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l12.9"></a><span id="l12.9"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;,</span>
<a href="#l12.10"></a><span id="l12.10">                        &quot;dom-helpers&quot;];</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.js&quot;);</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l12.14"></a><span id="l12.14"> </span>
<a href="#l12.15"></a><span id="l12.15"> function setupModule(module) {</span>
<a href="#l12.16"></a><span id="l12.16">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l12.17"></a><span id="l12.17">     collector.getModule(lib).installInto(module);</span>
<a href="#l12.18"></a><span id="l12.18">   }</span>
<a href="#l12.19"></a><span id="l12.19"> }</span>
<a href="#l12.20"></a><span id="l12.20"> </span>
<a href="#l12.21"></a><span id="l12.21"> /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mail/test/mozmill/attachment/test-attachment-menus.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mail/test/mozmill/attachment/test-attachment-menus.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -9,18 +9,18 @@ var MODULE_NAME = &quot;test-attachment-menus</span>
<a href="#l13.4"></a><span id="l13.4"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l13.5"></a><span id="l13.5"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;,</span>
<a href="#l13.6"></a><span id="l13.6">                        &quot;attachment-helpers&quot;];</span>
<a href="#l13.7"></a><span id="l13.7"> </span>
<a href="#l13.8"></a><span id="l13.8"> var folder;</span>
<a href="#l13.9"></a><span id="l13.9"> var messenger;</span>
<a href="#l13.10"></a><span id="l13.10"> var epsilon;</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.js&quot;);</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l13.16"></a><span id="l13.16"> </span>
<a href="#l13.17"></a><span id="l13.17"> var textAttachment =</span>
<a href="#l13.18"></a><span id="l13.18">   &quot;Can't make the frug contest, Helen; stomach's upset. I'll fix you, &quot; +</span>
<a href="#l13.19"></a><span id="l13.19">   &quot;Ubik! Ubik drops you back in the thick of things fast. Taken as &quot; +</span>
<a href="#l13.20"></a><span id="l13.20">   &quot;directed, Ubik speeds relief to head and stomach. Remember: Ubik is &quot; +</span>
<a href="#l13.21"></a><span id="l13.21">   &quot;only seconds away. Avoid prolonged use.&quot;;</span>
<a href="#l13.22"></a><span id="l13.22"> </span>
<a href="#l13.23"></a><span id="l13.23"> var detachedName = &quot;./attachment.txt&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mail/test/mozmill/attachment/test-attachment-size.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mail/test/mozmill/attachment/test-attachment-size.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -9,17 +9,17 @@ var MODULE_NAME = 'test-attachment-size'</span>
<a href="#l14.4"></a><span id="l14.4"> var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l14.5"></a><span id="l14.5"> var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers',</span>
<a href="#l14.6"></a><span id="l14.6">                        'attachment-helpers'];</span>
<a href="#l14.7"></a><span id="l14.7"> </span>
<a href="#l14.8"></a><span id="l14.8"> var folder;</span>
<a href="#l14.9"></a><span id="l14.9"> var messenger;</span>
<a href="#l14.10"></a><span id="l14.10"> var epsilon;</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.js&quot;);</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l14.14"></a><span id="l14.14"> </span>
<a href="#l14.15"></a><span id="l14.15"> var textAttachment =</span>
<a href="#l14.16"></a><span id="l14.16">   &quot;Can't make the frug contest, Helen; stomach's upset. I'll fix you, &quot; +</span>
<a href="#l14.17"></a><span id="l14.17">   &quot;Ubik! Ubik drops you back in the thick of things fast. Taken as &quot; +</span>
<a href="#l14.18"></a><span id="l14.18">   &quot;directed, Ubik speeds relief to head and stomach. Remember: Ubik is &quot; +</span>
<a href="#l14.19"></a><span id="l14.19">   &quot;only seconds away. Avoid prolonged use.&quot;;</span>
<a href="#l14.20"></a><span id="l14.20"> </span>
<a href="#l14.21"></a><span id="l14.21"> var binaryAttachment = textAttachment;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mail/test/mozmill/attachment/test-attachment.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mail/test/mozmill/attachment/test-attachment.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -9,18 +9,18 @@</span>
<a href="#l15.4"></a><span id="l15.4"> &quot;use strict&quot;;</span>
<a href="#l15.5"></a><span id="l15.5"> </span>
<a href="#l15.6"></a><span id="l15.6"> var MODULE_NAME = 'test-attachment';</span>
<a href="#l15.7"></a><span id="l15.7"> </span>
<a href="#l15.8"></a><span id="l15.8"> var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l15.9"></a><span id="l15.9"> var MODULE_REQUIRES = ['folder-display-helpers', 'compose-helpers',</span>
<a href="#l15.10"></a><span id="l15.10">                        'window-helpers'];</span>
<a href="#l15.11"></a><span id="l15.11"> </span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-var EventUtils = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/EventUtils.js&quot;);</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+var EventUtils = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/EventUtils.jsm&quot;);</span>
<a href="#l15.16"></a><span id="l15.16"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l15.17"></a><span id="l15.17"> </span>
<a href="#l15.18"></a><span id="l15.18"> var folder;</span>
<a href="#l15.19"></a><span id="l15.19"> var messages;</span>
<a href="#l15.20"></a><span id="l15.20"> </span>
<a href="#l15.21"></a><span id="l15.21"> var textAttachment =</span>
<a href="#l15.22"></a><span id="l15.22">   &quot;One of these days... people like me will rise up and overthrow you, and &quot; +</span>
<a href="#l15.23"></a><span id="l15.23">   &quot;the end of tyranny by the homeostatic machine will have arrived. The day &quot; +</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-attachment.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-attachment.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -3,31 +3,31 @@</span>
<a href="#l16.4"></a><span id="l16.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l16.5"></a><span id="l16.5"> </span>
<a href="#l16.6"></a><span id="l16.6"> /**</span>
<a href="#l16.7"></a><span id="l16.7">  * Tests attachment handling functionality of the message compose window.</span>
<a href="#l16.8"></a><span id="l16.8">  */</span>
<a href="#l16.9"></a><span id="l16.9"> </span>
<a href="#l16.10"></a><span id="l16.10"> &quot;use strict&quot;;</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l16.14"></a><span id="l16.14"> </span>
<a href="#l16.15"></a><span id="l16.15"> var MODULE_NAME = 'test-attachment';</span>
<a href="#l16.16"></a><span id="l16.16"> </span>
<a href="#l16.17"></a><span id="l16.17"> var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l16.18"></a><span id="l16.18"> var MODULE_REQUIRES = ['folder-display-helpers', 'compose-helpers',</span>
<a href="#l16.19"></a><span id="l16.19">                        'window-helpers'];</span>
<a href="#l16.20"></a><span id="l16.20"> </span>
<a href="#l16.21"></a><span id="l16.21"> var messenger;</span>
<a href="#l16.22"></a><span id="l16.22"> var folder;</span>
<a href="#l16.23"></a><span id="l16.23"> var epsilon;</span>
<a href="#l16.24"></a><span id="l16.24"> var isWindows;</span>
<a href="#l16.25"></a><span id="l16.25"> var filePrefix;</span>
<a href="#l16.26"></a><span id="l16.26"> </span>
<a href="#l16.27"></a><span id="l16.27" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.js&quot;);</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineplus">+var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l16.29"></a><span id="l16.29"> var {AppConstants} = ChromeUtils.import(&quot;resource://gre/modules/AppConstants.jsm&quot;);</span>
<a href="#l16.30"></a><span id="l16.30"> </span>
<a href="#l16.31"></a><span id="l16.31"> var rawAttachment =</span>
<a href="#l16.32"></a><span id="l16.32">   &quot;Can't make the frug contest, Helen; stomach's upset. I'll fix you, &quot; +</span>
<a href="#l16.33"></a><span id="l16.33">   &quot;Ubik! Ubik drops you back in the thick of things fast. Taken as &quot; +</span>
<a href="#l16.34"></a><span id="l16.34">   &quot;directed, Ubik speeds relief to head and stomach. Remember: Ubik is &quot; +</span>
<a href="#l16.35"></a><span id="l16.35">   &quot;only seconds away. Avoid prolonged use.&quot;;</span>
<a href="#l16.36"></a><span id="l16.36"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-base64-display.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-base64-display.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -10,17 +10,17 @@</span>
<a href="#l17.4"></a><span id="l17.4"> </span>
<a href="#l17.5"></a><span id="l17.5"> &quot;use strict&quot;;</span>
<a href="#l17.6"></a><span id="l17.6"> </span>
<a href="#l17.7"></a><span id="l17.7"> var MODULE_NAME = &quot;test-base64-display.js&quot;;</span>
<a href="#l17.8"></a><span id="l17.8"> </span>
<a href="#l17.9"></a><span id="l17.9"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l17.10"></a><span id="l17.10"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.js&quot;);</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l17.14"></a><span id="l17.14"> </span>
<a href="#l17.15"></a><span id="l17.15"> function setupModule(module) {</span>
<a href="#l17.16"></a><span id="l17.16">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l17.17"></a><span id="l17.17">     collector.getModule(lib).installInto(module);</span>
<a href="#l17.18"></a><span id="l17.18">   }</span>
<a href="#l17.19"></a><span id="l17.19"> }</span>
<a href="#l17.20"></a><span id="l17.20"> </span>
<a href="#l17.21"></a><span id="l17.21"> function test_base64_display() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-blocked-content.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-blocked-content.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -15,17 +15,17 @@ var MODULE_NAME = &quot;test-blocked-content&quot;</span>
<a href="#l18.4"></a><span id="l18.4"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l18.5"></a><span id="l18.5"> var MODULE_REQUIRES = [</span>
<a href="#l18.6"></a><span id="l18.6">   &quot;folder-display-helpers&quot;,</span>
<a href="#l18.7"></a><span id="l18.7">    &quot;window-helpers&quot;,</span>
<a href="#l18.8"></a><span id="l18.8">    &quot;compose-helpers&quot;,</span>
<a href="#l18.9"></a><span id="l18.9">    &quot;notificationbox-helpers&quot;</span>
<a href="#l18.10"></a><span id="l18.10"> ];</span>
<a href="#l18.11"></a><span id="l18.11"> </span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.js&quot;);</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l18.14"></a><span id="l18.14"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l18.15"></a><span id="l18.15"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l18.16"></a><span id="l18.16"> var {OS} = ChromeUtils.import(&quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l18.17"></a><span id="l18.17"> </span>
<a href="#l18.18"></a><span id="l18.18"> var gOutboxFolder;</span>
<a href="#l18.19"></a><span id="l18.19"> </span>
<a href="#l18.20"></a><span id="l18.20"> var kBoxId = &quot;attachmentNotificationBox&quot;;</span>
<a href="#l18.21"></a><span id="l18.21"> var kNotificationId = &quot;blockedContent&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-charset-edit.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-charset-edit.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -12,22 +12,22 @@</span>
<a href="#l19.4"></a><span id="l19.4"> &quot;use strict&quot;;</span>
<a href="#l19.5"></a><span id="l19.5"> </span>
<a href="#l19.6"></a><span id="l19.6"> var MODULE_NAME = &quot;test-charset-edit&quot;;</span>
<a href="#l19.7"></a><span id="l19.7"> </span>
<a href="#l19.8"></a><span id="l19.8"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l19.9"></a><span id="l19.9"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;compose-helpers&quot;,</span>
<a href="#l19.10"></a><span id="l19.10">                        &quot;window-helpers&quot;, &quot;notificationbox-helpers&quot;];</span>
<a href="#l19.11"></a><span id="l19.11"> </span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.js&quot;);</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l19.14"></a><span id="l19.14"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l19.15"></a><span id="l19.15"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l19.16"></a><span id="l19.16"> var {MimeParser} = ChromeUtils.import(&quot;resource:///modules/mimeParser.jsm&quot;);</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineminus">-var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineminus">-var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.js&quot;);</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineplus">+var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineplus">+var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.jsm&quot;);</span>
<a href="#l19.21"></a><span id="l19.21"> </span>
<a href="#l19.22"></a><span id="l19.22"> var gDrafts;</span>
<a href="#l19.23"></a><span id="l19.23"> </span>
<a href="#l19.24"></a><span id="l19.24"> function setupModule(module) {</span>
<a href="#l19.25"></a><span id="l19.25">   for (let req of MODULE_REQUIRES) {</span>
<a href="#l19.26"></a><span id="l19.26">     collector.getModule(req).installInto(module);</span>
<a href="#l19.27"></a><span id="l19.27">   }</span>
<a href="#l19.28"></a><span id="l19.28"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-cp932-display.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-cp932-display.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -10,17 +10,17 @@</span>
<a href="#l20.4"></a><span id="l20.4"> </span>
<a href="#l20.5"></a><span id="l20.5"> &quot;use strict&quot;;</span>
<a href="#l20.6"></a><span id="l20.6"> </span>
<a href="#l20.7"></a><span id="l20.7"> var MODULE_NAME = &quot;test-cp932-display.js&quot;;</span>
<a href="#l20.8"></a><span id="l20.8"> </span>
<a href="#l20.9"></a><span id="l20.9"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l20.10"></a><span id="l20.10"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l20.11"></a><span id="l20.11"> </span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.js&quot;);</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l20.14"></a><span id="l20.14"> </span>
<a href="#l20.15"></a><span id="l20.15"> function setupModule(module) {</span>
<a href="#l20.16"></a><span id="l20.16">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l20.17"></a><span id="l20.17">     collector.getModule(lib).installInto(module);</span>
<a href="#l20.18"></a><span id="l20.18">   }</span>
<a href="#l20.19"></a><span id="l20.19"> }</span>
<a href="#l20.20"></a><span id="l20.20"> </span>
<a href="#l20.21"></a><span id="l20.21"> function test_cp932_display() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-eml-actions.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-eml-actions.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -10,19 +10,19 @@</span>
<a href="#l21.4"></a><span id="l21.4"> </span>
<a href="#l21.5"></a><span id="l21.5"> &quot;use strict&quot;;</span>
<a href="#l21.6"></a><span id="l21.6"> </span>
<a href="#l21.7"></a><span id="l21.7"> var MODULE_NAME = &quot;test-eml-actions&quot;;</span>
<a href="#l21.8"></a><span id="l21.8"> </span>
<a href="#l21.9"></a><span id="l21.9"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l21.10"></a><span id="l21.10"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;, &quot;compose-helpers&quot;];</span>
<a href="#l21.11"></a><span id="l21.11"> </span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.js&quot;);</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l21.14"></a><span id="l21.14"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineminus">-var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineplus">+var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l21.17"></a><span id="l21.17"> </span>
<a href="#l21.18"></a><span id="l21.18"> var gDrafts;</span>
<a href="#l21.19"></a><span id="l21.19"> </span>
<a href="#l21.20"></a><span id="l21.20"> function setupModule(module) {</span>
<a href="#l21.21"></a><span id="l21.21">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l21.22"></a><span id="l21.22">     collector.getModule(lib).installInto(module);</span>
<a href="#l21.23"></a><span id="l21.23">   }</span>
<a href="#l21.24"></a><span id="l21.24"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-forward-rfc822-attach.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-forward-rfc822-attach.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -13,17 +13,17 @@</span>
<a href="#l22.4"></a><span id="l22.4"> </span>
<a href="#l22.5"></a><span id="l22.5"> var MODULE_NAME = &quot;test-forward-rfc822-attach&quot;;</span>
<a href="#l22.6"></a><span id="l22.6"> </span>
<a href="#l22.7"></a><span id="l22.7"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l22.8"></a><span id="l22.8"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;compose-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l22.9"></a><span id="l22.9"> </span>
<a href="#l22.10"></a><span id="l22.10"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l22.11"></a><span id="l22.11"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.js&quot;);</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l22.14"></a><span id="l22.14"> </span>
<a href="#l22.15"></a><span id="l22.15"> var gDrafts;</span>
<a href="#l22.16"></a><span id="l22.16"> </span>
<a href="#l22.17"></a><span id="l22.17"> function setupModule(module) {</span>
<a href="#l22.18"></a><span id="l22.18">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l22.19"></a><span id="l22.19">     collector.getModule(lib).installInto(module);</span>
<a href="#l22.20"></a><span id="l22.20">   }</span>
<a href="#l22.21"></a><span id="l22.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-forward-utf8.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-forward-utf8.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -12,18 +12,18 @@</span>
<a href="#l23.4"></a><span id="l23.4"> </span>
<a href="#l23.5"></a><span id="l23.5"> var MODULE_NAME = &quot;test-forward-utf8&quot;;</span>
<a href="#l23.6"></a><span id="l23.6"> </span>
<a href="#l23.7"></a><span id="l23.7"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l23.8"></a><span id="l23.8"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;compose-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l23.9"></a><span id="l23.9"> </span>
<a href="#l23.10"></a><span id="l23.10"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l23.11"></a><span id="l23.11"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.js&quot;);</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineplus">+var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineplus">+var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l23.16"></a><span id="l23.16"> </span>
<a href="#l23.17"></a><span id="l23.17"> var folderToSendFrom;</span>
<a href="#l23.18"></a><span id="l23.18"> </span>
<a href="#l23.19"></a><span id="l23.19"> function setupModule(module) {</span>
<a href="#l23.20"></a><span id="l23.20">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l23.21"></a><span id="l23.21">     collector.getModule(lib).installInto(module);</span>
<a href="#l23.22"></a><span id="l23.22">   }</span>
<a href="#l23.23"></a><span id="l23.23"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-forwarded-eml-actions.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-forwarded-eml-actions.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -13,17 +13,17 @@</span>
<a href="#l24.4"></a><span id="l24.4"> </span>
<a href="#l24.5"></a><span id="l24.5"> var MODULE_NAME = &quot;test-forwarded-eml-actions&quot;;</span>
<a href="#l24.6"></a><span id="l24.6"> </span>
<a href="#l24.7"></a><span id="l24.7"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l24.8"></a><span id="l24.8"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;,</span>
<a href="#l24.9"></a><span id="l24.9">                          &quot;compose-helpers&quot;];</span>
<a href="#l24.10"></a><span id="l24.10"> </span>
<a href="#l24.11"></a><span id="l24.11"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l24.14"></a><span id="l24.14"> </span>
<a href="#l24.15"></a><span id="l24.15"> var folder;</span>
<a href="#l24.16"></a><span id="l24.16"> </span>
<a href="#l24.17"></a><span id="l24.17"> var msgsubject = &quot;mail client suggestions&quot;;</span>
<a href="#l24.18"></a><span id="l24.18"> var msgbodyA = &quot;know of a good email client?&quot;;</span>
<a href="#l24.19"></a><span id="l24.19"> var msgbodyB = &quot;hi, i think you may know of an email client to recommend?&quot;;</span>
<a href="#l24.20"></a><span id="l24.20"> </span>
<a href="#l24.21"></a><span id="l24.21"> var setupModule = function(module) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-image-display.js</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-image-display.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -11,18 +11,18 @@</span>
<a href="#l25.4"></a><span id="l25.4"> &quot;use strict&quot;;</span>
<a href="#l25.5"></a><span id="l25.5"> </span>
<a href="#l25.6"></a><span id="l25.6"> var MODULE_NAME = &quot;test-image-display&quot;;</span>
<a href="#l25.7"></a><span id="l25.7"> </span>
<a href="#l25.8"></a><span id="l25.8"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l25.9"></a><span id="l25.9"> var MODULE_REQUIRES = [ &quot;folder-display-helpers&quot;, &quot;window-helpers&quot;,</span>
<a href="#l25.10"></a><span id="l25.10">                         &quot;compose-helpers&quot; ];</span>
<a href="#l25.11"></a><span id="l25.11"> </span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.js&quot;);</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">-var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineplus">+var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineplus">+var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l25.16"></a><span id="l25.16"> var {IOUtils} = ChromeUtils.import(&quot;resource:///modules/IOUtils.js&quot;);</span>
<a href="#l25.17"></a><span id="l25.17"> </span>
<a href="#l25.18"></a><span id="l25.18"> var gImageFolder;</span>
<a href="#l25.19"></a><span id="l25.19"> </span>
<a href="#l25.20"></a><span id="l25.20"> function setupModule(module) {</span>
<a href="#l25.21"></a><span id="l25.21">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l25.22"></a><span id="l25.22">     collector.getModule(lib).installInto(module);</span>
<a href="#l25.23"></a><span id="l25.23">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-image-insertion-dialog.js</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-image-insertion-dialog.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -3,17 +3,17 @@</span>
<a href="#l26.4"></a><span id="l26.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l26.5"></a><span id="l26.5"> </span>
<a href="#l26.6"></a><span id="l26.6"> /**</span>
<a href="#l26.7"></a><span id="l26.7">  * Tests the image insertion dialog functionality.</span>
<a href="#l26.8"></a><span id="l26.8">  */</span>
<a href="#l26.9"></a><span id="l26.9"> </span>
<a href="#l26.10"></a><span id="l26.10"> &quot;use strict&quot;;</span>
<a href="#l26.11"></a><span id="l26.11"> </span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l26.14"></a><span id="l26.14"> </span>
<a href="#l26.15"></a><span id="l26.15"> var MODULE_NAME = &quot;test-image-insertion-dialog&quot;;</span>
<a href="#l26.16"></a><span id="l26.16"> </span>
<a href="#l26.17"></a><span id="l26.17"> var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l26.18"></a><span id="l26.18"> var MODULE_REQUIRES = ['folder-display-helpers', 'compose-helpers',</span>
<a href="#l26.19"></a><span id="l26.19">                        'window-helpers', 'keyboard-helpers'];</span>
<a href="#l26.20"></a><span id="l26.20"> </span>
<a href="#l26.21"></a><span id="l26.21"> var fdh, ch, wh, kh;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-multipart-related.js</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-multipart-related.js</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -10,22 +10,22 @@</span>
<a href="#l27.4"></a><span id="l27.4"> </span>
<a href="#l27.5"></a><span id="l27.5"> &quot;use strict&quot;;</span>
<a href="#l27.6"></a><span id="l27.6"> </span>
<a href="#l27.7"></a><span id="l27.7"> var MODULE_NAME = &quot;test-multipart-related&quot;;</span>
<a href="#l27.8"></a><span id="l27.8"> </span>
<a href="#l27.9"></a><span id="l27.9"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l27.10"></a><span id="l27.10"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;, &quot;compose-helpers&quot;];</span>
<a href="#l27.11"></a><span id="l27.11"> </span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.js&quot;);</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineplus">+var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l27.14"></a><span id="l27.14"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l27.15"></a><span id="l27.15"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l27.16"></a><span id="l27.16"> var {MimeParser} = ChromeUtils.import(&quot;resource:///modules/mimeParser.jsm&quot;);</span>
<a href="#l27.17"></a><span id="l27.17" class="difflineminus">-var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l27.18"></a><span id="l27.18" class="difflineminus">-var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.js&quot;);</span>
<a href="#l27.19"></a><span id="l27.19" class="difflineplus">+var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l27.20"></a><span id="l27.20" class="difflineplus">+var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.jsm&quot;);</span>
<a href="#l27.21"></a><span id="l27.21"> </span>
<a href="#l27.22"></a><span id="l27.22"> var gDrafts;</span>
<a href="#l27.23"></a><span id="l27.23"> </span>
<a href="#l27.24"></a><span id="l27.24"> function setupModule(module) {</span>
<a href="#l27.25"></a><span id="l27.25">   for (let req of MODULE_REQUIRES) {</span>
<a href="#l27.26"></a><span id="l27.26">     collector.getModule(req).installInto(module);</span>
<a href="#l27.27"></a><span id="l27.27">   }</span>
<a href="#l27.28"></a><span id="l27.28">   gDrafts = get_special_folder(Ci.nsMsgFolderFlags.Drafts, true);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-reply-format-flowed.js</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-reply-format-flowed.js</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -13,17 +13,17 @@</span>
<a href="#l28.4"></a><span id="l28.4"> var MODULE_NAME = &quot;test-reply-format-flowed&quot;;</span>
<a href="#l28.5"></a><span id="l28.5"> </span>
<a href="#l28.6"></a><span id="l28.6"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l28.7"></a><span id="l28.7"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;compose-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l28.8"></a><span id="l28.8"> </span>
<a href="#l28.9"></a><span id="l28.9"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l28.10"></a><span id="l28.10"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l28.11"></a><span id="l28.11"> </span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.js&quot;);</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineplus">+var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l28.14"></a><span id="l28.14"> </span>
<a href="#l28.15"></a><span id="l28.15"> var gDrafts;</span>
<a href="#l28.16"></a><span id="l28.16"> </span>
<a href="#l28.17"></a><span id="l28.17"> function setupModule(module) {</span>
<a href="#l28.18"></a><span id="l28.18">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l28.19"></a><span id="l28.19">     collector.getModule(lib).installInto(module);</span>
<a href="#l28.20"></a><span id="l28.20">   }</span>
<a href="#l28.21"></a><span id="l28.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-reply-multipart-charset.js</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-reply-multipart-charset.js</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -24,18 +24,18 @@</span>
<a href="#l29.4"></a><span id="l29.4"> </span>
<a href="#l29.5"></a><span id="l29.5"> &quot;use strict&quot;;</span>
<a href="#l29.6"></a><span id="l29.6"> </span>
<a href="#l29.7"></a><span id="l29.7"> var MODULE_NAME = &quot;test-reply-multipart-charset&quot;;</span>
<a href="#l29.8"></a><span id="l29.8"> </span>
<a href="#l29.9"></a><span id="l29.9"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l29.10"></a><span id="l29.10"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;compose-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l29.11"></a><span id="l29.11"> </span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.js&quot;);</span>
<a href="#l29.14"></a><span id="l29.14" class="difflineplus">+var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l29.15"></a><span id="l29.15" class="difflineplus">+var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l29.16"></a><span id="l29.16"> </span>
<a href="#l29.17"></a><span id="l29.17"> var folderToStoreMessages;</span>
<a href="#l29.18"></a><span id="l29.18"> </span>
<a href="#l29.19"></a><span id="l29.19"> function setupModule(module) {</span>
<a href="#l29.20"></a><span id="l29.20">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l29.21"></a><span id="l29.21">     collector.getModule(lib).installInto(module);</span>
<a href="#l29.22"></a><span id="l29.22">   }</span>
<a href="#l29.23"></a><span id="l29.23"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-send-button.js</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-send-button.js</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -9,17 +9,17 @@</span>
<a href="#l30.4"></a><span id="l30.4"> &quot;use strict&quot;;</span>
<a href="#l30.5"></a><span id="l30.5"> </span>
<a href="#l30.6"></a><span id="l30.6"> var MODULE_NAME = &quot;test-send-button&quot;;</span>
<a href="#l30.7"></a><span id="l30.7"> </span>
<a href="#l30.8"></a><span id="l30.8"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l30.9"></a><span id="l30.9"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;compose-helpers&quot;,</span>
<a href="#l30.10"></a><span id="l30.10">                          &quot;window-helpers&quot;, &quot;address-book-helpers&quot;];</span>
<a href="#l30.11"></a><span id="l30.11"> </span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineplus">+var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l30.14"></a><span id="l30.14"> </span>
<a href="#l30.15"></a><span id="l30.15"> var account = null;</span>
<a href="#l30.16"></a><span id="l30.16"> </span>
<a href="#l30.17"></a><span id="l30.17"> var setupModule = function (module) {</span>
<a href="#l30.18"></a><span id="l30.18">   collector.getModule(&quot;folder-display-helpers&quot;).installInto(module);</span>
<a href="#l30.19"></a><span id="l30.19">   collector.getModule(&quot;compose-helpers&quot;).installInto(module);</span>
<a href="#l30.20"></a><span id="l30.20">   collector.getModule(&quot;window-helpers&quot;).installInto(module);</span>
<a href="#l30.21"></a><span id="l30.21">   collector.getModule(&quot;address-book-helpers&quot;).installInto(module);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-send-format.js</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-send-format.js</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -11,17 +11,17 @@</span>
<a href="#l31.4"></a><span id="l31.4"> </span>
<a href="#l31.5"></a><span id="l31.5"> &quot;use strict&quot;;</span>
<a href="#l31.6"></a><span id="l31.6"> </span>
<a href="#l31.7"></a><span id="l31.7"> var MODULE_NAME = &quot;test-send-format&quot;;</span>
<a href="#l31.8"></a><span id="l31.8"> </span>
<a href="#l31.9"></a><span id="l31.9"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l31.10"></a><span id="l31.10"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;compose-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l31.11"></a><span id="l31.11"> </span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.js&quot;);</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineplus">+var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l31.14"></a><span id="l31.14"> </span>
<a href="#l31.15"></a><span id="l31.15"> const nsIMsgCompConvertible = Ci.nsIMsgCompConvertible;</span>
<a href="#l31.16"></a><span id="l31.16"> </span>
<a href="#l31.17"></a><span id="l31.17"> function setupModule(module) {</span>
<a href="#l31.18"></a><span id="l31.18">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l31.19"></a><span id="l31.19">     collector.getModule(lib).installInto(module);</span>
<a href="#l31.20"></a><span id="l31.20">   }</span>
<a href="#l31.21"></a><span id="l31.21"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mail/test/mozmill/content-policy/test-general-content-policy.js</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mail/test/mozmill/content-policy/test-general-content-policy.js</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -24,18 +24,18 @@</span>
<a href="#l32.4"></a><span id="l32.4"> var MODULE_NAME = 'test-general-content-policy';</span>
<a href="#l32.5"></a><span id="l32.5"> </span>
<a href="#l32.6"></a><span id="l32.6"> var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l32.7"></a><span id="l32.7"> var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers',</span>
<a href="#l32.8"></a><span id="l32.8">                          'compose-helpers', 'content-tab-helpers',</span>
<a href="#l32.9"></a><span id="l32.9">                          'keyboard-helpers',</span>
<a href="#l32.10"></a><span id="l32.10">                          'notificationbox-helpers'];</span>
<a href="#l32.11"></a><span id="l32.11"> </span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.js&quot;);</span>
<a href="#l32.14"></a><span id="l32.14" class="difflineplus">+var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l32.15"></a><span id="l32.15" class="difflineplus">+var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l32.16"></a><span id="l32.16"> </span>
<a href="#l32.17"></a><span id="l32.17"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l32.18"></a><span id="l32.18"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l32.19"></a><span id="l32.19"> </span>
<a href="#l32.20"></a><span id="l32.20"> var folder = null;</span>
<a href="#l32.21"></a><span id="l32.21"> var gMsgNo = 0;</span>
<a href="#l32.22"></a><span id="l32.22"> </span>
<a href="#l32.23"></a><span id="l32.23"> // RELATIVE_ROOT messes with the collector, so we have to bring the path back</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/mail/test/mozmill/content-policy/test-view-source.js</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/mail/test/mozmill/content-policy/test-view-source.js</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -10,17 +10,17 @@</span>
<a href="#l33.4"></a><span id="l33.4"> </span>
<a href="#l33.5"></a><span id="l33.5"> &quot;use strict&quot;;</span>
<a href="#l33.6"></a><span id="l33.6"> </span>
<a href="#l33.7"></a><span id="l33.7"> var MODULE_NAME = &quot;test-view-source&quot;;</span>
<a href="#l33.8"></a><span id="l33.8"> </span>
<a href="#l33.9"></a><span id="l33.9"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l33.10"></a><span id="l33.10"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l33.11"></a><span id="l33.11"> </span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l33.14"></a><span id="l33.14"> </span>
<a href="#l33.15"></a><span id="l33.15"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l33.16"></a><span id="l33.16"> </span>
<a href="#l33.17"></a><span id="l33.17"> var folder = null;</span>
<a href="#l33.18"></a><span id="l33.18"> </span>
<a href="#l33.19"></a><span id="l33.19"> function setupModule(module) {</span>
<a href="#l33.20"></a><span id="l33.20">   for (let dep of MODULE_REQUIRES) {</span>
<a href="#l33.21"></a><span id="l33.21">     collector.getModule(dep).installInto(module);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/mail/test/mozmill/content-tabs/test-addons-mgr.js</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/mail/test/mozmill/content-tabs/test-addons-mgr.js</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -7,17 +7,17 @@</span>
<a href="#l34.4"></a><span id="l34.4"> &quot;use strict&quot;;</span>
<a href="#l34.5"></a><span id="l34.5"> </span>
<a href="#l34.6"></a><span id="l34.6"> var MODULE_NAME = &quot;test-addons-mgr&quot;;</span>
<a href="#l34.7"></a><span id="l34.7"> </span>
<a href="#l34.8"></a><span id="l34.8"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l34.9"></a><span id="l34.9"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;content-tab-helpers&quot;,</span>
<a href="#l34.10"></a><span id="l34.10">                        &quot;window-helpers&quot;];</span>
<a href="#l34.11"></a><span id="l34.11"> </span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineplus">+var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l34.14"></a><span id="l34.14"> </span>
<a href="#l34.15"></a><span id="l34.15"> function setupModule(module) {</span>
<a href="#l34.16"></a><span id="l34.16">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l34.17"></a><span id="l34.17">     collector.getModule(lib).installInto(module);</span>
<a href="#l34.18"></a><span id="l34.18">   }</span>
<a href="#l34.19"></a><span id="l34.19"> }</span>
<a href="#l34.20"></a><span id="l34.20"> </span>
<a href="#l34.21"></a><span id="l34.21"> function test_open_addons_with_url() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/mail/test/mozmill/content-tabs/test-content-tab.js</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/mail/test/mozmill/content-tabs/test-content-tab.js</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -5,19 +5,19 @@</span>
<a href="#l35.4"></a><span id="l35.4"> &quot;use strict&quot;;</span>
<a href="#l35.5"></a><span id="l35.5"> </span>
<a href="#l35.6"></a><span id="l35.6"> var MODULE_NAME = 'test-content-tab';</span>
<a href="#l35.7"></a><span id="l35.7"> </span>
<a href="#l35.8"></a><span id="l35.8"> var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l35.9"></a><span id="l35.9"> var MODULE_REQUIRES = ['folder-display-helpers', 'content-tab-helpers',</span>
<a href="#l35.10"></a><span id="l35.10">                        'dom-helpers', 'window-helpers'];</span>
<a href="#l35.11"></a><span id="l35.11"> </span>
<a href="#l35.12"></a><span id="l35.12" class="difflineminus">-var controller = ChromeUtils.import(&quot;chrome://mozmill/content/modules/controller.js&quot;);</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineminus">-var mozmill = ChromeUtils.import(&quot;chrome://mozmill/content/modules/mozmill.js&quot;);</span>
<a href="#l35.14"></a><span id="l35.14" class="difflineminus">-var elementslib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l35.15"></a><span id="l35.15" class="difflineplus">+var controller = ChromeUtils.import(&quot;chrome://mozmill/content/modules/controller.jsm&quot;);</span>
<a href="#l35.16"></a><span id="l35.16" class="difflineplus">+var mozmill = ChromeUtils.import(&quot;chrome://mozmill/content/modules/mozmill.jsm&quot;);</span>
<a href="#l35.17"></a><span id="l35.17" class="difflineplus">+var elementslib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l35.18"></a><span id="l35.18"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l35.19"></a><span id="l35.19"> </span>
<a href="#l35.20"></a><span id="l35.20"> // RELATIVE_ROOT messes with the collector, so we have to bring the path back</span>
<a href="#l35.21"></a><span id="l35.21"> // so we get the right path for the resources.</span>
<a href="#l35.22"></a><span id="l35.22"> // Note: this one adds to '' as we need to make sure that favicon.ico is in the</span>
<a href="#l35.23"></a><span id="l35.23"> // root directory.</span>
<a href="#l35.24"></a><span id="l35.24"> var url = collector.addHttpResource('../content-tabs/html', '');</span>
<a href="#l35.25"></a><span id="l35.25"> var whatsUrl = url + &quot;whatsnew.html&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/mail/test/mozmill/content-tabs/test-install-xpi.js</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/mail/test/mozmill/content-tabs/test-install-xpi.js</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -5,19 +5,19 @@</span>
<a href="#l36.4"></a><span id="l36.4"> &quot;use strict&quot;;</span>
<a href="#l36.5"></a><span id="l36.5"> </span>
<a href="#l36.6"></a><span id="l36.6"> var MODULE_NAME = 'test-install-xpi';</span>
<a href="#l36.7"></a><span id="l36.7"> </span>
<a href="#l36.8"></a><span id="l36.8"> var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l36.9"></a><span id="l36.9"> var MODULE_REQUIRES = ['window-helpers', 'folder-display-helpers',</span>
<a href="#l36.10"></a><span id="l36.10">                        'content-tab-helpers'];</span>
<a href="#l36.11"></a><span id="l36.11"> </span>
<a href="#l36.12"></a><span id="l36.12" class="difflineminus">-var controller = ChromeUtils.import(&quot;chrome://mozmill/content/modules/controller.js&quot;);</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineminus">-var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l36.14"></a><span id="l36.14" class="difflineminus">-var mozmill = ChromeUtils.import(&quot;chrome://mozmill/content/modules/mozmill.js&quot;);</span>
<a href="#l36.15"></a><span id="l36.15" class="difflineplus">+var controller = ChromeUtils.import(&quot;chrome://mozmill/content/modules/controller.jsm&quot;);</span>
<a href="#l36.16"></a><span id="l36.16" class="difflineplus">+var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l36.17"></a><span id="l36.17" class="difflineplus">+var mozmill = ChromeUtils.import(&quot;chrome://mozmill/content/modules/mozmill.jsm&quot;);</span>
<a href="#l36.18"></a><span id="l36.18"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l36.19"></a><span id="l36.19"> </span>
<a href="#l36.20"></a><span id="l36.20"> // RELATIVE_ROOT messes with the collector, so we have to bring the path back</span>
<a href="#l36.21"></a><span id="l36.21"> // so we get the right path for the resources.</span>
<a href="#l36.22"></a><span id="l36.22"> var url = collector.addHttpResource('../content-tabs/html', 'content-tabs');</span>
<a href="#l36.23"></a><span id="l36.23"> </span>
<a href="#l36.24"></a><span id="l36.24"> var gDocument;</span>
<a href="#l36.25"></a><span id="l36.25"> var gNewTab;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/mail/test/mozmill/content-tabs/test-lwthemes.js</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/mail/test/mozmill/content-tabs/test-lwthemes.js</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -9,17 +9,17 @@</span>
<a href="#l37.4"></a><span id="l37.4"> </span>
<a href="#l37.5"></a><span id="l37.5"> &quot;use strict&quot;;</span>
<a href="#l37.6"></a><span id="l37.6"> </span>
<a href="#l37.7"></a><span id="l37.7"> var MODULE_NAME = &quot;test-lwthemes&quot;;</span>
<a href="#l37.8"></a><span id="l37.8"> </span>
<a href="#l37.9"></a><span id="l37.9"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l37.10"></a><span id="l37.10"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;content-tab-helpers&quot;];</span>
<a href="#l37.11"></a><span id="l37.11"> </span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineplus">+var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l37.14"></a><span id="l37.14"> </span>
<a href="#l37.15"></a><span id="l37.15"> var gNewTab;</span>
<a href="#l37.16"></a><span id="l37.16"> </span>
<a href="#l37.17"></a><span id="l37.17"> // RELATIVE_ROOT messes with the collector, so we have to bring the path back</span>
<a href="#l37.18"></a><span id="l37.18"> // so we get the right path for the resources.</span>
<a href="#l37.19"></a><span id="l37.19"> var url = collector.addHttpResource('../content-tabs/html', 'content');</span>
<a href="#l37.20"></a><span id="l37.20"> </span>
<a href="#l37.21"></a><span id="l37.21"> function setupModule(module) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/mail/test/mozmill/downloads/test-about-downloads.js</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/mail/test/mozmill/downloads/test-about-downloads.js</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -15,17 +15,17 @@ var MODULE_NAME = &quot;test-about-downloads&quot;</span>
<a href="#l38.4"></a><span id="l38.4"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l38.5"></a><span id="l38.5"> var MODULE_REQUIRES = [ 'attachment-helpers',</span>
<a href="#l38.6"></a><span id="l38.6">                         'content-tab-helpers',</span>
<a href="#l38.7"></a><span id="l38.7">                         'dom-helpers',</span>
<a href="#l38.8"></a><span id="l38.8">                         'folder-display-helpers',</span>
<a href="#l38.9"></a><span id="l38.9">                         'prompt-helpers',</span>
<a href="#l38.10"></a><span id="l38.10">                         'window-helpers' ];</span>
<a href="#l38.11"></a><span id="l38.11"> </span>
<a href="#l38.12"></a><span id="l38.12" class="difflineminus">-var elementslib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineplus">+var elementslib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l38.14"></a><span id="l38.14"> var downloads = ChromeUtils.import(&quot;resource://gre/modules/Downloads.jsm&quot;);</span>
<a href="#l38.15"></a><span id="l38.15"> </span>
<a href="#l38.16"></a><span id="l38.16"> var downloadsTab;</span>
<a href="#l38.17"></a><span id="l38.17"> </span>
<a href="#l38.18"></a><span id="l38.18"> var attachmentFileNames = [</span>
<a href="#l38.19"></a><span id="l38.19">   &quot;Attachment#1.txt&quot;,</span>
<a href="#l38.20"></a><span id="l38.20">   &quot;Attachment#2.txt&quot;,</span>
<a href="#l38.21"></a><span id="l38.21">   &quot;Attachment#3.txt&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-columns.js</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-columns.js</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -1,15 +1,15 @@</span>
<a href="#l39.4"></a><span id="l39.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l39.5"></a><span id="l39.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l39.6"></a><span id="l39.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l39.7"></a><span id="l39.7"> </span>
<a href="#l39.8"></a><span id="l39.8"> &quot;use strict&quot;;</span>
<a href="#l39.9"></a><span id="l39.9"> </span>
<a href="#l39.10"></a><span id="l39.10" class="difflineminus">-var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l39.11"></a><span id="l39.11" class="difflineplus">+var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l39.12"></a><span id="l39.12"> </span>
<a href="#l39.13"></a><span id="l39.13"> // needed to zero inter-folder processing delay</span>
<a href="#l39.14"></a><span id="l39.14"> var {MailUtils} = ChromeUtils.import(&quot;resource:///modules/MailUtils.jsm&quot;);</span>
<a href="#l39.15"></a><span id="l39.15"> </span>
<a href="#l39.16"></a><span id="l39.16"> /*</span>
<a href="#l39.17"></a><span id="l39.17">  * Test column default logic and persistence logic.  Persistence comes in both</span>
<a href="#l39.18"></a><span id="l39.18">  *  tab-switching (because of the multiplexed implementation) and</span>
<a href="#l39.19"></a><span id="l39.19">  *  folder-switching forms.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-right-click-middle-click-messages.js</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-right-click-middle-click-messages.js</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -8,17 +8,17 @@</span>
<a href="#l40.4"></a><span id="l40.4"> </span>
<a href="#l40.5"></a><span id="l40.5"> &quot;use strict&quot;;</span>
<a href="#l40.6"></a><span id="l40.6"> </span>
<a href="#l40.7"></a><span id="l40.7"> var MODULE_NAME = 'test-right-click-middle-click-messages';</span>
<a href="#l40.8"></a><span id="l40.8"> </span>
<a href="#l40.9"></a><span id="l40.9"> var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l40.10"></a><span id="l40.10"> var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers'];</span>
<a href="#l40.11"></a><span id="l40.11"> </span>
<a href="#l40.12"></a><span id="l40.12" class="difflineminus">-var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l40.13"></a><span id="l40.13" class="difflineplus">+var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l40.14"></a><span id="l40.14"> </span>
<a href="#l40.15"></a><span id="l40.15"> var folder, threadedFolder;</span>
<a href="#l40.16"></a><span id="l40.16"> </span>
<a href="#l40.17"></a><span id="l40.17"> /**</span>
<a href="#l40.18"></a><span id="l40.18">  * The number of messages in the thread we use to test.</span>
<a href="#l40.19"></a><span id="l40.19">  */</span>
<a href="#l40.20"></a><span id="l40.20"> var NUM_MESSAGES_IN_THREAD = 6;</span>
<a href="#l40.21"></a><span id="l40.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/mail/test/mozmill/folder-widget/test-message-filters.js</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/mail/test/mozmill/folder-widget/test-message-filters.js</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -10,17 +10,17 @@</span>
<a href="#l41.4"></a><span id="l41.4"> </span>
<a href="#l41.5"></a><span id="l41.5"> var MODULE_NAME = &quot;test-message-filters&quot;;</span>
<a href="#l41.6"></a><span id="l41.6"> </span>
<a href="#l41.7"></a><span id="l41.7"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l41.8"></a><span id="l41.8"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;,</span>
<a href="#l41.9"></a><span id="l41.9">                        &quot;nntp-helpers&quot;, &quot;address-book-helpers&quot;,</span>
<a href="#l41.10"></a><span id="l41.10">                        &quot;prompt-helpers&quot;];</span>
<a href="#l41.11"></a><span id="l41.11"> </span>
<a href="#l41.12"></a><span id="l41.12" class="difflineminus">-var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineplus">+var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l41.14"></a><span id="l41.14"> var folderA;</span>
<a href="#l41.15"></a><span id="l41.15"> </span>
<a href="#l41.16"></a><span id="l41.16"> function setupModule(module)</span>
<a href="#l41.17"></a><span id="l41.17"> {</span>
<a href="#l41.18"></a><span id="l41.18">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l41.19"></a><span id="l41.19">     collector.getModule(lib).installInto(module);</span>
<a href="#l41.20"></a><span id="l41.20">   }</span>
<a href="#l41.21"></a><span id="l41.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1" class="difflineminus">--- a/mail/test/mozmill/instrumentation/test-instrument-setup.js</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineplus">+++ b/mail/test/mozmill/instrumentation/test-instrument-setup.js</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineat">@@ -5,17 +5,17 @@</span>
<a href="#l42.4"></a><span id="l42.4"> &quot;use strict&quot;;</span>
<a href="#l42.5"></a><span id="l42.5"> </span>
<a href="#l42.6"></a><span id="l42.6"> var MODULE_NAME = &quot;test-instrument-setup&quot;;</span>
<a href="#l42.7"></a><span id="l42.7"> </span>
<a href="#l42.8"></a><span id="l42.8"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l42.9"></a><span id="l42.9"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;,</span>
<a href="#l42.10"></a><span id="l42.10">                        &quot;keyboard-helpers&quot; ];</span>
<a href="#l42.11"></a><span id="l42.11"> </span>
<a href="#l42.12"></a><span id="l42.12" class="difflineminus">-var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineplus">+var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l42.14"></a><span id="l42.14"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l42.15"></a><span id="l42.15"> </span>
<a href="#l42.16"></a><span id="l42.16"> var user = {</span>
<a href="#l42.17"></a><span id="l42.17">   name: &quot;Roger Sterling&quot;,</span>
<a href="#l42.18"></a><span id="l42.18">   email: &quot;roger.sterling@example.com&quot;,</span>
<a href="#l42.19"></a><span id="l42.19">   incomingHost: &quot;testin.example.com&quot;,</span>
<a href="#l42.20"></a><span id="l42.20">   outgoingHost: &quot;testout.example.com&quot;,</span>
<a href="#l42.21"></a><span id="l42.21"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1" class="difflineminus">--- a/mail/test/mozmill/junk-commands/test-junk-commands.js</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineplus">+++ b/mail/test/mozmill/junk-commands/test-junk-commands.js</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineat">@@ -4,17 +4,17 @@</span>
<a href="#l43.4"></a><span id="l43.4"> </span>
<a href="#l43.5"></a><span id="l43.5"> &quot;use strict&quot;;</span>
<a href="#l43.6"></a><span id="l43.6"> </span>
<a href="#l43.7"></a><span id="l43.7"> var MODULE_NAME = 'test-junk-commands';</span>
<a href="#l43.8"></a><span id="l43.8"> </span>
<a href="#l43.9"></a><span id="l43.9"> var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l43.10"></a><span id="l43.10"> var MODULE_REQUIRES = ['folder-display-helpers', 'junk-helpers'];</span>
<a href="#l43.11"></a><span id="l43.11"> </span>
<a href="#l43.12"></a><span id="l43.12" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.js&quot;);</span>
<a href="#l43.13"></a><span id="l43.13" class="difflineplus">+var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l43.14"></a><span id="l43.14"> </span>
<a href="#l43.15"></a><span id="l43.15"> // One folder's enough</span>
<a href="#l43.16"></a><span id="l43.16"> var folder = null;</span>
<a href="#l43.17"></a><span id="l43.17"> </span>
<a href="#l43.18"></a><span id="l43.18"> function setupModule(module) {</span>
<a href="#l43.19"></a><span id="l43.19">   let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l43.20"></a><span id="l43.20">   fdh.installInto(module);</span>
<a href="#l43.21"></a><span id="l43.21">   let jh = collector.getModule('junk-helpers');</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1" class="difflineminus">--- a/mail/test/mozmill/message-header/test-header-toolbar.js</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineplus">+++ b/mail/test/mozmill/message-header/test-header-toolbar.js</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineat">@@ -10,17 +10,17 @@</span>
<a href="#l44.4"></a><span id="l44.4"> </span>
<a href="#l44.5"></a><span id="l44.5"> var MODULE_NAME = 'test-header-toolbar';</span>
<a href="#l44.6"></a><span id="l44.6"> </span>
<a href="#l44.7"></a><span id="l44.7"> var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l44.8"></a><span id="l44.8"> var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers',</span>
<a href="#l44.9"></a><span id="l44.9">                        'address-book-helpers', 'mouse-event-helpers',</span>
<a href="#l44.10"></a><span id="l44.10">                        'customization-helpers'];</span>
<a href="#l44.11"></a><span id="l44.11"> </span>
<a href="#l44.12"></a><span id="l44.12" class="difflineminus">-var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l44.13"></a><span id="l44.13" class="difflineplus">+var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l44.14"></a><span id="l44.14"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l44.15"></a><span id="l44.15"> </span>
<a href="#l44.16"></a><span id="l44.16"> var folder;</span>
<a href="#l44.17"></a><span id="l44.17"> var gCDHelper ;</span>
<a href="#l44.18"></a><span id="l44.18"> var originalPaneLayout;</span>
<a href="#l44.19"></a><span id="l44.19"> var kPaneLayout = &quot;mail.pane_config.dynamic&quot;;</span>
<a href="#l44.20"></a><span id="l44.20"> </span>
<a href="#l44.21"></a><span id="l44.21"> function setupModule(module) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1" class="difflineminus">--- a/mail/test/mozmill/message-header/test-message-header.js</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineplus">+++ b/mail/test/mozmill/message-header/test-message-header.js</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineat">@@ -12,17 +12,17 @@</span>
<a href="#l45.4"></a><span id="l45.4"> &quot;use strict&quot;;</span>
<a href="#l45.5"></a><span id="l45.5"> </span>
<a href="#l45.6"></a><span id="l45.6"> var MODULE_NAME = 'test-message-header';</span>
<a href="#l45.7"></a><span id="l45.7"> </span>
<a href="#l45.8"></a><span id="l45.8"> var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l45.9"></a><span id="l45.9"> var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers',</span>
<a href="#l45.10"></a><span id="l45.10">                        'address-book-helpers', 'dom-helpers'];</span>
<a href="#l45.11"></a><span id="l45.11"> </span>
<a href="#l45.12"></a><span id="l45.12" class="difflineminus">-var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l45.13"></a><span id="l45.13" class="difflineplus">+var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l45.14"></a><span id="l45.14"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l45.15"></a><span id="l45.15"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l45.16"></a><span id="l45.16"> </span>
<a href="#l45.17"></a><span id="l45.17"> var folder, folderMore;</span>
<a href="#l45.18"></a><span id="l45.18"> var gInterestingMessage;</span>
<a href="#l45.19"></a><span id="l45.19"> </span>
<a href="#l45.20"></a><span id="l45.20"> /**</span>
<a href="#l45.21"></a><span id="l45.21">  * Wraps a call to querySelector in an elib.Elem.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1" class="difflineminus">--- a/mail/test/mozmill/message-header/test-phishing-bar.js</span>
<a href="#l46.2"></a><span id="l46.2" class="difflineplus">+++ b/mail/test/mozmill/message-header/test-phishing-bar.js</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineat">@@ -11,17 +11,17 @@</span>
<a href="#l46.4"></a><span id="l46.4"> &quot;use strict&quot;;</span>
<a href="#l46.5"></a><span id="l46.5"> </span>
<a href="#l46.6"></a><span id="l46.6"> var MODULE_NAME = &quot;test-phishing-bar&quot;;</span>
<a href="#l46.7"></a><span id="l46.7"> </span>
<a href="#l46.8"></a><span id="l46.8"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l46.9"></a><span id="l46.9"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;,</span>
<a href="#l46.10"></a><span id="l46.10">                          &quot;window-helpers&quot;, &quot;notificationbox-helpers&quot;];</span>
<a href="#l46.11"></a><span id="l46.11"> </span>
<a href="#l46.12"></a><span id="l46.12" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.js&quot;);</span>
<a href="#l46.13"></a><span id="l46.13" class="difflineplus">+var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l46.14"></a><span id="l46.14"> </span>
<a href="#l46.15"></a><span id="l46.15"> var folder;</span>
<a href="#l46.16"></a><span id="l46.16"> </span>
<a href="#l46.17"></a><span id="l46.17"> var kBoxId = &quot;msgNotificationBar&quot;;</span>
<a href="#l46.18"></a><span id="l46.18"> var kNotificationValue = &quot;maybeScam&quot;;</span>
<a href="#l46.19"></a><span id="l46.19"> </span>
<a href="#l46.20"></a><span id="l46.20"> function setupModule(module) {</span>
<a href="#l46.21"></a><span id="l46.21">   for (let dep of MODULE_REQUIRES) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1" class="difflineminus">--- a/mail/test/mozmill/message-reader/test-bug594646.js</span>
<a href="#l47.2"></a><span id="l47.2" class="difflineplus">+++ b/mail/test/mozmill/message-reader/test-bug594646.js</span>
<a href="#l47.3"></a><span id="l47.3" class="difflineat">@@ -11,17 +11,17 @@</span>
<a href="#l47.4"></a><span id="l47.4"> </span>
<a href="#l47.5"></a><span id="l47.5"> &quot;use strict&quot;;</span>
<a href="#l47.6"></a><span id="l47.6"> </span>
<a href="#l47.7"></a><span id="l47.7"> var MODULE_NAME = &quot;test-bug594646&quot;;</span>
<a href="#l47.8"></a><span id="l47.8"> </span>
<a href="#l47.9"></a><span id="l47.9"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l47.10"></a><span id="l47.10"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l47.11"></a><span id="l47.11"> </span>
<a href="#l47.12"></a><span id="l47.12" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.js&quot;);</span>
<a href="#l47.13"></a><span id="l47.13" class="difflineplus">+var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l47.14"></a><span id="l47.14"> </span>
<a href="#l47.15"></a><span id="l47.15"> var gReferenceTextContent;</span>
<a href="#l47.16"></a><span id="l47.16"> </span>
<a href="#l47.17"></a><span id="l47.17"> function setupModule(module) {</span>
<a href="#l47.18"></a><span id="l47.18">   collector.getModule(&quot;folder-display-helpers&quot;).installInto(module);</span>
<a href="#l47.19"></a><span id="l47.19">   collector.getModule(&quot;window-helpers&quot;).installInto(module);</span>
<a href="#l47.20"></a><span id="l47.20">   gReferenceTextContent = extract_eml_body_textcontent(&quot;./bug594646_reference.eml&quot;);</span>
<a href="#l47.21"></a><span id="l47.21"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l48.1"></a><span id="l48.1" class="difflineminus">--- a/mail/test/mozmill/message-window/test-autohide-menubar.js</span>
<a href="#l48.2"></a><span id="l48.2" class="difflineplus">+++ b/mail/test/mozmill/message-window/test-autohide-menubar.js</span>
<a href="#l48.3"></a><span id="l48.3" class="difflineat">@@ -8,17 +8,17 @@</span>
<a href="#l48.4"></a><span id="l48.4"> &quot;use strict&quot;;</span>
<a href="#l48.5"></a><span id="l48.5"> </span>
<a href="#l48.6"></a><span id="l48.6"> var MODULE_NAME = &quot;test-autohide-menubar&quot;;</span>
<a href="#l48.7"></a><span id="l48.7"> </span>
<a href="#l48.8"></a><span id="l48.8"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l48.9"></a><span id="l48.9"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;address-book-helpers&quot;,</span>
<a href="#l48.10"></a><span id="l48.10">                        &quot;compose-helpers&quot;];</span>
<a href="#l48.11"></a><span id="l48.11"> </span>
<a href="#l48.12"></a><span id="l48.12" class="difflineminus">-var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l48.13"></a><span id="l48.13" class="difflineplus">+var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l48.14"></a><span id="l48.14"> </span>
<a href="#l48.15"></a><span id="l48.15"> var menuFolder;</span>
<a href="#l48.16"></a><span id="l48.16"> var menuState;</span>
<a href="#l48.17"></a><span id="l48.17"> </span>
<a href="#l48.18"></a><span id="l48.18"> function setupModule(module) {</span>
<a href="#l48.19"></a><span id="l48.19">   let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l48.20"></a><span id="l48.20">   fdh.installInto(module);</span>
<a href="#l48.21"></a><span id="l48.21">   let abh = collector.getModule(&quot;address-book-helpers&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l49.1"></a><span id="l49.1" class="difflineminus">--- a/mail/test/mozmill/message-window/test-commands.js</span>
<a href="#l49.2"></a><span id="l49.2" class="difflineplus">+++ b/mail/test/mozmill/message-window/test-commands.js</span>
<a href="#l49.3"></a><span id="l49.3" class="difflineat">@@ -5,18 +5,18 @@</span>
<a href="#l49.4"></a><span id="l49.4"> &quot;use strict&quot;;</span>
<a href="#l49.5"></a><span id="l49.5"> </span>
<a href="#l49.6"></a><span id="l49.6"> var MODULE_NAME = &quot;test-commands&quot;;</span>
<a href="#l49.7"></a><span id="l49.7"> </span>
<a href="#l49.8"></a><span id="l49.8"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l49.9"></a><span id="l49.9"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l49.10"></a><span id="l49.10"> </span>
<a href="#l49.11"></a><span id="l49.11"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l49.12"></a><span id="l49.12" class="difflineminus">-var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l49.13"></a><span id="l49.13" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.js&quot;);</span>
<a href="#l49.14"></a><span id="l49.14" class="difflineplus">+var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l49.15"></a><span id="l49.15" class="difflineplus">+var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l49.16"></a><span id="l49.16"> </span>
<a href="#l49.17"></a><span id="l49.17"> var folder1, folder2;</span>
<a href="#l49.18"></a><span id="l49.18"> </span>
<a href="#l49.19"></a><span id="l49.19"> var setupModule = function(module) {</span>
<a href="#l49.20"></a><span id="l49.20">   let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l49.21"></a><span id="l49.21">   fdh.installInto(module);</span>
<a href="#l49.22"></a><span id="l49.22">   let wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l49.23"></a><span id="l49.23">   wh.installInto(module);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l50.1"></a><span id="l50.1" class="difflineminus">--- a/mail/test/mozmill/message-window/test-eml-subject.js</span>
<a href="#l50.2"></a><span id="l50.2" class="difflineplus">+++ b/mail/test/mozmill/message-window/test-eml-subject.js</span>
<a href="#l50.3"></a><span id="l50.3" class="difflineat">@@ -8,17 +8,17 @@</span>
<a href="#l50.4"></a><span id="l50.4"> </span>
<a href="#l50.5"></a><span id="l50.5"> &quot;use strict&quot;;</span>
<a href="#l50.6"></a><span id="l50.6"> </span>
<a href="#l50.7"></a><span id="l50.7"> var MODULE_NAME = &quot;test-eml-subject&quot;;</span>
<a href="#l50.8"></a><span id="l50.8"> </span>
<a href="#l50.9"></a><span id="l50.9"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l50.10"></a><span id="l50.10"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l50.11"></a><span id="l50.11"> </span>
<a href="#l50.12"></a><span id="l50.12" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.js&quot;);</span>
<a href="#l50.13"></a><span id="l50.13" class="difflineplus">+var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l50.14"></a><span id="l50.14"> var {StringBundle} = ChromeUtils.import(&quot;resource:///modules/StringBundle.js&quot;);</span>
<a href="#l50.15"></a><span id="l50.15"> var {AppConstants} = ChromeUtils.import(&quot;resource://gre/modules/AppConstants.jsm&quot;);</span>
<a href="#l50.16"></a><span id="l50.16"> </span>
<a href="#l50.17"></a><span id="l50.17"> var setupModule = function(module) {</span>
<a href="#l50.18"></a><span id="l50.18">   let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l50.19"></a><span id="l50.19">   fdh.installInto(module);</span>
<a href="#l50.20"></a><span id="l50.20">   let wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l50.21"></a><span id="l50.21">   wh.installInto(module);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l51.1"></a><span id="l51.1" class="difflineminus">--- a/mail/test/mozmill/message-window/test-vcard-actions.js</span>
<a href="#l51.2"></a><span id="l51.2" class="difflineplus">+++ b/mail/test/mozmill/message-window/test-vcard-actions.js</span>
<a href="#l51.3"></a><span id="l51.3" class="difflineat">@@ -11,17 +11,17 @@</span>
<a href="#l51.4"></a><span id="l51.4"> &quot;use strict&quot;;</span>
<a href="#l51.5"></a><span id="l51.5"> </span>
<a href="#l51.6"></a><span id="l51.6"> var MODULE_NAME = &quot;test-vcard-actions&quot;;</span>
<a href="#l51.7"></a><span id="l51.7"> </span>
<a href="#l51.8"></a><span id="l51.8"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l51.9"></a><span id="l51.9"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;,</span>
<a href="#l51.10"></a><span id="l51.10">                        &quot;address-book-helpers&quot;];</span>
<a href="#l51.11"></a><span id="l51.11"> </span>
<a href="#l51.12"></a><span id="l51.12" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.js&quot;);</span>
<a href="#l51.13"></a><span id="l51.13" class="difflineplus">+var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l51.14"></a><span id="l51.14"> </span>
<a href="#l51.15"></a><span id="l51.15"> function setupModule(module) {</span>
<a href="#l51.16"></a><span id="l51.16">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l51.17"></a><span id="l51.17">     collector.getModule(lib).installInto(module);</span>
<a href="#l51.18"></a><span id="l51.18">   }</span>
<a href="#l51.19"></a><span id="l51.19"> }</span>
<a href="#l51.20"></a><span id="l51.20"> </span>
<a href="#l51.21"></a><span id="l51.21"> /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l52.1"></a><span id="l52.1" class="difflineminus">--- a/mail/test/mozmill/message-window/test-view-plaintext.js</span>
<a href="#l52.2"></a><span id="l52.2" class="difflineplus">+++ b/mail/test/mozmill/message-window/test-view-plaintext.js</span>
<a href="#l52.3"></a><span id="l52.3" class="difflineat">@@ -11,17 +11,17 @@</span>
<a href="#l52.4"></a><span id="l52.4"> &quot;use strict&quot;;</span>
<a href="#l52.5"></a><span id="l52.5"> </span>
<a href="#l52.6"></a><span id="l52.6"> var MODULE_NAME = &quot;test-view-plaintext&quot;;</span>
<a href="#l52.7"></a><span id="l52.7"> </span>
<a href="#l52.8"></a><span id="l52.8"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l52.9"></a><span id="l52.9"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l52.10"></a><span id="l52.10"> </span>
<a href="#l52.11"></a><span id="l52.11"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l52.12"></a><span id="l52.12" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.js&quot;);</span>
<a href="#l52.13"></a><span id="l52.13" class="difflineplus">+var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l52.14"></a><span id="l52.14"> </span>
<a href="#l52.15"></a><span id="l52.15"> function setupModule(module) {</span>
<a href="#l52.16"></a><span id="l52.16">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l52.17"></a><span id="l52.17">     collector.getModule(lib).installInto(module);</span>
<a href="#l52.18"></a><span id="l52.18">   }</span>
<a href="#l52.19"></a><span id="l52.19"> }</span>
<a href="#l52.20"></a><span id="l52.20"> </span>
<a href="#l52.21"></a><span id="l52.21"> /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l53.1"></a><span id="l53.1" class="difflineminus">--- a/mail/test/mozmill/newmailaccount/test-newmailaccount.js</span>
<a href="#l53.2"></a><span id="l53.2" class="difflineplus">+++ b/mail/test/mozmill/newmailaccount/test-newmailaccount.js</span>
<a href="#l53.3"></a><span id="l53.3" class="difflineat">@@ -13,20 +13,20 @@ var MODULE_NAME = 'test-newmailaccount';</span>
<a href="#l53.4"></a><span id="l53.4"> var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l53.5"></a><span id="l53.5"> var MODULE_REQUIRES = ['folder-display-helpers',</span>
<a href="#l53.6"></a><span id="l53.6">                        'content-tab-helpers',</span>
<a href="#l53.7"></a><span id="l53.7">                        'window-helpers',</span>
<a href="#l53.8"></a><span id="l53.8">                        'newmailaccount-helpers',</span>
<a href="#l53.9"></a><span id="l53.9">                        'keyboard-helpers',</span>
<a href="#l53.10"></a><span id="l53.10">                        'dom-helpers'];</span>
<a href="#l53.11"></a><span id="l53.11"> </span>
<a href="#l53.12"></a><span id="l53.12" class="difflineminus">-var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l53.13"></a><span id="l53.13" class="difflineplus">+var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l53.14"></a><span id="l53.14"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l53.15"></a><span id="l53.15"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l53.16"></a><span id="l53.16" class="difflineminus">-var {HttpServer} = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/httpd.js&quot;);</span>
<a href="#l53.17"></a><span id="l53.17" class="difflineplus">+var {HttpServer} = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/httpd.jsm&quot;);</span>
<a href="#l53.18"></a><span id="l53.18"> </span>
<a href="#l53.19"></a><span id="l53.19"> // RELATIVE_ROOT messes with the collector, so we have to bring the path back</span>
<a href="#l53.20"></a><span id="l53.20"> // so we get the right path for the resources.</span>
<a href="#l53.21"></a><span id="l53.21"> var url = collector.addHttpResource('../newmailaccount/html', '');</span>
<a href="#l53.22"></a><span id="l53.22"> var kProvisionerUrl = &quot;chrome://messenger/content/newmailaccount/accountProvisioner.xhtml&quot;;</span>
<a href="#l53.23"></a><span id="l53.23"> var kProvisionerEnabledPref = &quot;mail.provider.enabled&quot;;</span>
<a href="#l53.24"></a><span id="l53.24"> var kSuggestFromNamePref = &quot;mail.provider.suggestFromName&quot;;</span>
<a href="#l53.25"></a><span id="l53.25"> var kProviderListPref = &quot;mail.provider.providerList&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l54.1"></a><span id="l54.1" class="difflineminus">--- a/mail/test/mozmill/runtest.py</span>
<a href="#l54.2"></a><span id="l54.2" class="difflineplus">+++ b/mail/test/mozmill/runtest.py</span>
<a href="#l54.3"></a><span id="l54.3" class="difflineat">@@ -314,17 +314,17 @@ class ThunderTestMozmill(mozmill.MozMill</span>
<a href="#l54.4"></a><span id="l54.4">                     subprocess.check_call([self.VNC_SERVER_PATH,</span>
<a href="#l54.5"></a><span id="l54.5">                                            '-kill', ':99'])</span>
<a href="#l54.6"></a><span id="l54.6">             except Exception, ex:</span>
<a href="#l54.7"></a><span id="l54.7">                 print '!!! Exception during killing VNC server:', ex</span>
<a href="#l54.8"></a><span id="l54.8"> </span>
<a href="#l54.9"></a><span id="l54.9"> </span>
<a href="#l54.10"></a><span id="l54.10"> def monkeypatched_15_run_tests(self, tests, sleeptime=0):</span>
<a href="#l54.11"></a><span id="l54.11">     frame = mozmill.jsbridge.JSObject(self.bridge,</span>
<a href="#l54.12"></a><span id="l54.12" class="difflineminus">-                &quot;ChromeUtils.import('chrome://mozmill/content/modules/frame.js')&quot;)</span>
<a href="#l54.13"></a><span id="l54.13" class="difflineplus">+                &quot;ChromeUtils.import('chrome://mozmill/content/modules/frame.jsm')&quot;)</span>
<a href="#l54.14"></a><span id="l54.14">     sleep(sleeptime)</span>
<a href="#l54.15"></a><span id="l54.15"> </span>
<a href="#l54.16"></a><span id="l54.16">     # transfer persisted data</span>
<a href="#l54.17"></a><span id="l54.17">     frame.persisted = self.persisted</span>
<a href="#l54.18"></a><span id="l54.18"> </span>
<a href="#l54.19"></a><span id="l54.19">     frame.registerModule(&quot;testing-common&quot;, TESTING_MODULES_DIR)</span>
<a href="#l54.20"></a><span id="l54.20"> </span>
<a href="#l54.21"></a><span id="l54.21">     if len(tests) == 1 and not os.path.isdir(tests[0]):</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l55.1"></a><span id="l55.1" class="difflineminus">--- a/mail/test/mozmill/session-store/test-session-store.js</span>
<a href="#l55.2"></a><span id="l55.2" class="difflineplus">+++ b/mail/test/mozmill/session-store/test-session-store.js</span>
<a href="#l55.3"></a><span id="l55.3" class="difflineat">@@ -9,17 +9,17 @@</span>
<a href="#l55.4"></a><span id="l55.4"> </span>
<a href="#l55.5"></a><span id="l55.5"> &quot;use strict&quot;;</span>
<a href="#l55.6"></a><span id="l55.6"> </span>
<a href="#l55.7"></a><span id="l55.7"> var MODULE_NAME = &quot;test-session-store&quot;;</span>
<a href="#l55.8"></a><span id="l55.8"> </span>
<a href="#l55.9"></a><span id="l55.9"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l55.10"></a><span id="l55.10"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l55.11"></a><span id="l55.11"> </span>
<a href="#l55.12"></a><span id="l55.12" class="difflineminus">-var controller = ChromeUtils.import(&quot;chrome://mozmill/content/modules/controller.js&quot;);</span>
<a href="#l55.13"></a><span id="l55.13" class="difflineplus">+var controller = ChromeUtils.import(&quot;chrome://mozmill/content/modules/controller.jsm&quot;);</span>
<a href="#l55.14"></a><span id="l55.14"> </span>
<a href="#l55.15"></a><span id="l55.15"> var {IOUtils} = ChromeUtils.import(&quot;resource:///modules/IOUtils.js&quot;);</span>
<a href="#l55.16"></a><span id="l55.16"> var {FileUtils} = ChromeUtils.import(&quot;resource://gre/modules/FileUtils.jsm&quot;);</span>
<a href="#l55.17"></a><span id="l55.17"> var {SessionStoreManager} = ChromeUtils.import(&quot;resource:///modules/SessionStoreManager.jsm&quot;);</span>
<a href="#l55.18"></a><span id="l55.18"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l55.19"></a><span id="l55.19"> </span>
<a href="#l55.20"></a><span id="l55.20"> var folderA, folderB;</span>
<a href="#l55.21"></a><span id="l55.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l56.1"></a><span id="l56.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-account-manager-helpers.js</span>
<a href="#l56.2"></a><span id="l56.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-account-manager-helpers.js</span>
<a href="#l56.3"></a><span id="l56.3" class="difflineat">@@ -5,18 +5,18 @@</span>
<a href="#l56.4"></a><span id="l56.4"> &quot;use strict&quot;;</span>
<a href="#l56.5"></a><span id="l56.5"> </span>
<a href="#l56.6"></a><span id="l56.6"> var MODULE_NAME = &quot;account-manager-helpers&quot;;</span>
<a href="#l56.7"></a><span id="l56.7"> </span>
<a href="#l56.8"></a><span id="l56.8"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l56.9"></a><span id="l56.9"> // we need this for the main controller</span>
<a href="#l56.10"></a><span id="l56.10"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l56.11"></a><span id="l56.11"> </span>
<a href="#l56.12"></a><span id="l56.12" class="difflineminus">-var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.js&quot;);</span>
<a href="#l56.13"></a><span id="l56.13" class="difflineminus">-var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l56.14"></a><span id="l56.14" class="difflineplus">+var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.jsm&quot;);</span>
<a href="#l56.15"></a><span id="l56.15" class="difflineplus">+var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l56.16"></a><span id="l56.16"> </span>
<a href="#l56.17"></a><span id="l56.17"> var wh, fdh, mc;</span>
<a href="#l56.18"></a><span id="l56.18"> </span>
<a href="#l56.19"></a><span id="l56.19"> function setupModule() {</span>
<a href="#l56.20"></a><span id="l56.20">   fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l56.21"></a><span id="l56.21">   mc = fdh.mc;</span>
<a href="#l56.22"></a><span id="l56.22">   wh = collector.getModule('window-helpers');</span>
<a href="#l56.23"></a><span id="l56.23"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l57.1"></a><span id="l57.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js</span>
<a href="#l57.2"></a><span id="l57.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js</span>
<a href="#l57.3"></a><span id="l57.3" class="difflineat">@@ -6,17 +6,17 @@</span>
<a href="#l57.4"></a><span id="l57.4"> </span>
<a href="#l57.5"></a><span id="l57.5"> var MODULE_NAME = &quot;cloudfile-helpers&quot;;</span>
<a href="#l57.6"></a><span id="l57.6"> </span>
<a href="#l57.7"></a><span id="l57.7"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l57.8"></a><span id="l57.8"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;mock-object-helpers&quot;];</span>
<a href="#l57.9"></a><span id="l57.9"> </span>
<a href="#l57.10"></a><span id="l57.10"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l57.11"></a><span id="l57.11"> var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l57.12"></a><span id="l57.12" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.js&quot;);</span>
<a href="#l57.13"></a><span id="l57.13" class="difflineplus">+var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l57.14"></a><span id="l57.14"> </span>
<a href="#l57.15"></a><span id="l57.15"> var kMockContractIDPrefix = &quot;@mozilla.org/mail/mockCloudFile;1?id=&quot;;</span>
<a href="#l57.16"></a><span id="l57.16"> </span>
<a href="#l57.17"></a><span id="l57.17"> var kDefaults = {</span>
<a href="#l57.18"></a><span id="l57.18">   iconClass: &quot;chrome://messenger/skin/icons/box-logo.png&quot;,</span>
<a href="#l57.19"></a><span id="l57.19">   accountKey: null,</span>
<a href="#l57.20"></a><span id="l57.20">   settingsURL: &quot;&quot;,</span>
<a href="#l57.21"></a><span id="l57.21">   managementURL: &quot;&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l58.1"></a><span id="l58.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-cloudfile-hightail-helpers.js</span>
<a href="#l58.2"></a><span id="l58.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-cloudfile-hightail-helpers.js</span>
<a href="#l58.3"></a><span id="l58.3" class="difflineat">@@ -1,17 +1,17 @@</span>
<a href="#l58.4"></a><span id="l58.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l58.5"></a><span id="l58.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l58.6"></a><span id="l58.6">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l58.7"></a><span id="l58.7"> </span>
<a href="#l58.8"></a><span id="l58.8"> &quot;use strict&quot;;</span>
<a href="#l58.9"></a><span id="l58.9"> </span>
<a href="#l58.10"></a><span id="l58.10"> var MODULE_NAME = &quot;cloudfile-hightail-helpers&quot;;</span>
<a href="#l58.11"></a><span id="l58.11"> </span>
<a href="#l58.12"></a><span id="l58.12" class="difflineminus">-var {HttpServer} = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/httpd.js&quot;);</span>
<a href="#l58.13"></a><span id="l58.13" class="difflineplus">+var {HttpServer} = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/httpd.jsm&quot;);</span>
<a href="#l58.14"></a><span id="l58.14"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l58.15"></a><span id="l58.15"> var {cloudFileAccounts} = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.js&quot;);</span>
<a href="#l58.16"></a><span id="l58.16"> </span>
<a href="#l58.17"></a><span id="l58.17"> var kDefaultServerPort = 4444;</span>
<a href="#l58.18"></a><span id="l58.18"> var kServerRoot = &quot;http://localhost:&quot; + kDefaultServerPort;</span>
<a href="#l58.19"></a><span id="l58.19"> var kServerPath = &quot;&quot;;</span>
<a href="#l58.20"></a><span id="l58.20"> var kServerURL = kServerRoot + kServerPath;</span>
<a href="#l58.21"></a><span id="l58.21"> var kAuthPath = &quot;/dpi/v1/auth&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l59.1"></a><span id="l59.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-compose-helpers.js</span>
<a href="#l59.2"></a><span id="l59.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-compose-helpers.js</span>
<a href="#l59.3"></a><span id="l59.3" class="difflineat">@@ -7,18 +7,18 @@</span>
<a href="#l59.4"></a><span id="l59.4"> var MODULE_NAME = &quot;compose-helpers&quot;;</span>
<a href="#l59.5"></a><span id="l59.5"> </span>
<a href="#l59.6"></a><span id="l59.6"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l59.7"></a><span id="l59.7"> // we need this for the main controller</span>
<a href="#l59.8"></a><span id="l59.8"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;,</span>
<a href="#l59.9"></a><span id="l59.9">                          &quot;window-helpers&quot;,</span>
<a href="#l59.10"></a><span id="l59.10">                          &quot;dom-helpers&quot;];</span>
<a href="#l59.11"></a><span id="l59.11"> </span>
<a href="#l59.12"></a><span id="l59.12" class="difflineminus">-var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l59.13"></a><span id="l59.13" class="difflineminus">-var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.js&quot;);</span>
<a href="#l59.14"></a><span id="l59.14" class="difflineplus">+var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l59.15"></a><span id="l59.15" class="difflineplus">+var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.jsm&quot;);</span>
<a href="#l59.16"></a><span id="l59.16"> </span>
<a href="#l59.17"></a><span id="l59.17"> var kTextNodeType = 3;</span>
<a href="#l59.18"></a><span id="l59.18"> </span>
<a href="#l59.19"></a><span id="l59.19"> var folderDisplayHelper;</span>
<a href="#l59.20"></a><span id="l59.20"> var mc;</span>
<a href="#l59.21"></a><span id="l59.21"> var windowHelper, domHelper;</span>
<a href="#l59.22"></a><span id="l59.22"> </span>
<a href="#l59.23"></a><span id="l59.23"> function setupModule() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l60.1"></a><span id="l60.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-content-tab-helpers.js</span>
<a href="#l60.2"></a><span id="l60.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-content-tab-helpers.js</span>
<a href="#l60.3"></a><span id="l60.3" class="difflineat">@@ -7,18 +7,18 @@</span>
<a href="#l60.4"></a><span id="l60.4"> var MODULE_NAME = &quot;content-tab-helpers&quot;;</span>
<a href="#l60.5"></a><span id="l60.5"> </span>
<a href="#l60.6"></a><span id="l60.6"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l60.7"></a><span id="l60.7"> // we need this for the main controller</span>
<a href="#l60.8"></a><span id="l60.8"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;,</span>
<a href="#l60.9"></a><span id="l60.9">                          &quot;window-helpers&quot;,</span>
<a href="#l60.10"></a><span id="l60.10">                          &quot;mock-object-helpers&quot;];</span>
<a href="#l60.11"></a><span id="l60.11"> </span>
<a href="#l60.12"></a><span id="l60.12" class="difflineminus">-var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l60.13"></a><span id="l60.13" class="difflineminus">-var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.js&quot;);</span>
<a href="#l60.14"></a><span id="l60.14" class="difflineplus">+var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l60.15"></a><span id="l60.15" class="difflineplus">+var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.jsm&quot;);</span>
<a href="#l60.16"></a><span id="l60.16"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l60.17"></a><span id="l60.17"> </span>
<a href="#l60.18"></a><span id="l60.18"> var NORMAL_TIMEOUT = 6000;</span>
<a href="#l60.19"></a><span id="l60.19"> var FAST_TIMEOUT = 1000;</span>
<a href="#l60.20"></a><span id="l60.20"> var FAST_INTERVAL = 100;</span>
<a href="#l60.21"></a><span id="l60.21"> var EXT_PROTOCOL_SVC_CID = &quot;@mozilla.org/uriloader/external-protocol-service;1&quot;;</span>
<a href="#l60.22"></a><span id="l60.22"> </span>
<a href="#l60.23"></a><span id="l60.23"> var folderDisplayHelper;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l61.1"></a><span id="l61.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-customization-helpers.js</span>
<a href="#l61.2"></a><span id="l61.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-customization-helpers.js</span>
<a href="#l61.3"></a><span id="l61.3" class="difflineat">@@ -5,17 +5,17 @@</span>
<a href="#l61.4"></a><span id="l61.4"> &quot;use strict&quot;;</span>
<a href="#l61.5"></a><span id="l61.5"> </span>
<a href="#l61.6"></a><span id="l61.6"> var MODULE_NAME = &quot;customization-helpers&quot;;</span>
<a href="#l61.7"></a><span id="l61.7"> </span>
<a href="#l61.8"></a><span id="l61.8"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l61.9"></a><span id="l61.9"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l61.10"></a><span id="l61.10"> </span>
<a href="#l61.11"></a><span id="l61.11"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l61.12"></a><span id="l61.12" class="difflineminus">-var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l61.13"></a><span id="l61.13" class="difflineplus">+var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l61.14"></a><span id="l61.14"> </span>
<a href="#l61.15"></a><span id="l61.15"> var USE_SHEET_PREF = &quot;toolbar.customization.usesheet&quot;;</span>
<a href="#l61.16"></a><span id="l61.16"> </span>
<a href="#l61.17"></a><span id="l61.17"> var wh, fdh;</span>
<a href="#l61.18"></a><span id="l61.18"> </span>
<a href="#l61.19"></a><span id="l61.19"> function setupModule() {</span>
<a href="#l61.20"></a><span id="l61.20">   fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l61.21"></a><span id="l61.21">   wh = collector.getModule('window-helpers');</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l62.1"></a><span id="l62.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-dom-helpers.js</span>
<a href="#l62.2"></a><span id="l62.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-dom-helpers.js</span>
<a href="#l62.3"></a><span id="l62.3" class="difflineat">@@ -5,17 +5,17 @@</span>
<a href="#l62.4"></a><span id="l62.4"> &quot;use strict&quot;;</span>
<a href="#l62.5"></a><span id="l62.5"> </span>
<a href="#l62.6"></a><span id="l62.6"> var MODULE_NAME = &quot;dom-helpers&quot;;</span>
<a href="#l62.7"></a><span id="l62.7"> </span>
<a href="#l62.8"></a><span id="l62.8"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l62.9"></a><span id="l62.9"> // we need this for the main controller</span>
<a href="#l62.10"></a><span id="l62.10"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;];</span>
<a href="#l62.11"></a><span id="l62.11"> </span>
<a href="#l62.12"></a><span id="l62.12" class="difflineminus">-var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l62.13"></a><span id="l62.13" class="difflineplus">+var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l62.14"></a><span id="l62.14"> </span>
<a href="#l62.15"></a><span id="l62.15"> var NORMAL_TIMEOUT = 6000;</span>
<a href="#l62.16"></a><span id="l62.16"> var FAST_TIMEOUT = 1000;</span>
<a href="#l62.17"></a><span id="l62.17"> var FAST_INTERVAL = 100;</span>
<a href="#l62.18"></a><span id="l62.18"> </span>
<a href="#l62.19"></a><span id="l62.19"> var folderDisplayHelper;</span>
<a href="#l62.20"></a><span id="l62.20"> var mc;</span>
<a href="#l62.21"></a><span id="l62.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l63.1"></a><span id="l63.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-folder-display-helpers.js</span>
<a href="#l63.2"></a><span id="l63.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-folder-display-helpers.js</span>
<a href="#l63.3"></a><span id="l63.3" class="difflineat">@@ -5,21 +5,21 @@</span>
<a href="#l63.4"></a><span id="l63.4"> &quot;use strict&quot;;</span>
<a href="#l63.5"></a><span id="l63.5"> </span>
<a href="#l63.6"></a><span id="l63.6"> var MODULE_NAME = &quot;folder-display-helpers&quot;;</span>
<a href="#l63.7"></a><span id="l63.7"> </span>
<a href="#l63.8"></a><span id="l63.8"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l63.9"></a><span id="l63.9"> // we need window-helpers for augment_controller</span>
<a href="#l63.10"></a><span id="l63.10"> var MODULE_REQUIRES = [&quot;window-helpers&quot;];</span>
<a href="#l63.11"></a><span id="l63.11"> </span>
<a href="#l63.12"></a><span id="l63.12" class="difflineminus">-var EventUtils = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/EventUtils.js&quot;);</span>
<a href="#l63.13"></a><span id="l63.13" class="difflineminus">-var controller = ChromeUtils.import(&quot;chrome://mozmill/content/modules/controller.js&quot;);</span>
<a href="#l63.14"></a><span id="l63.14" class="difflineminus">-var frame = ChromeUtils.import(&quot;chrome://mozmill/content/modules/frame.js&quot;);</span>
<a href="#l63.15"></a><span id="l63.15" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.js&quot;);</span>
<a href="#l63.16"></a><span id="l63.16" class="difflineminus">-var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.js&quot;);</span>
<a href="#l63.17"></a><span id="l63.17" class="difflineplus">+var EventUtils = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/EventUtils.jsm&quot;);</span>
<a href="#l63.18"></a><span id="l63.18" class="difflineplus">+var controller = ChromeUtils.import(&quot;chrome://mozmill/content/modules/controller.jsm&quot;);</span>
<a href="#l63.19"></a><span id="l63.19" class="difflineplus">+var frame = ChromeUtils.import(&quot;chrome://mozmill/content/modules/frame.jsm&quot;);</span>
<a href="#l63.20"></a><span id="l63.20" class="difflineplus">+var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l63.21"></a><span id="l63.21" class="difflineplus">+var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.jsm&quot;);</span>
<a href="#l63.22"></a><span id="l63.22"> </span>
<a href="#l63.23"></a><span id="l63.23"> var {Log4Moz} = ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l63.24"></a><span id="l63.24"> </span>
<a href="#l63.25"></a><span id="l63.25"> var nsMsgViewIndex_None = 0xffffffff;</span>
<a href="#l63.26"></a><span id="l63.26"> var {MailConsts} = ChromeUtils.import(&quot;resource:///modules/MailConsts.jsm&quot;);</span>
<a href="#l63.27"></a><span id="l63.27"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l63.28"></a><span id="l63.28"> var {MailUtils} = ChromeUtils.import(&quot;resource:///modules/MailUtils.jsm&quot;);</span>
<a href="#l63.29"></a><span id="l63.29"> var {MailViewManager, MailViewConstants} = ChromeUtils.import(&quot;resource:///modules/MailViewManager.jsm&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l64.1"></a><span id="l64.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-junk-helpers.js</span>
<a href="#l64.2"></a><span id="l64.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-junk-helpers.js</span>
<a href="#l64.3"></a><span id="l64.3" class="difflineat">@@ -5,18 +5,18 @@</span>
<a href="#l64.4"></a><span id="l64.4"> &quot;use strict&quot;;</span>
<a href="#l64.5"></a><span id="l64.5"> </span>
<a href="#l64.6"></a><span id="l64.6"> var MODULE_NAME = &quot;junk-helpers&quot;;</span>
<a href="#l64.7"></a><span id="l64.7"> </span>
<a href="#l64.8"></a><span id="l64.8"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l64.9"></a><span id="l64.9"> // we need this for the main controller</span>
<a href="#l64.10"></a><span id="l64.10"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;];</span>
<a href="#l64.11"></a><span id="l64.11"> </span>
<a href="#l64.12"></a><span id="l64.12" class="difflineminus">-var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l64.13"></a><span id="l64.13" class="difflineminus">-var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.js&quot;);</span>
<a href="#l64.14"></a><span id="l64.14" class="difflineplus">+var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l64.15"></a><span id="l64.15" class="difflineplus">+var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.jsm&quot;);</span>
<a href="#l64.16"></a><span id="l64.16"> </span>
<a href="#l64.17"></a><span id="l64.17"> var folderDisplayHelper;</span>
<a href="#l64.18"></a><span id="l64.18"> var mc;</span>
<a href="#l64.19"></a><span id="l64.19"> </span>
<a href="#l64.20"></a><span id="l64.20"> // logHelper (and therefore folderDisplayHelper) exports</span>
<a href="#l64.21"></a><span id="l64.21"> var mark_failure;</span>
<a href="#l64.22"></a><span id="l64.22"> </span>
<a href="#l64.23"></a><span id="l64.23"> function setupModule() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l65.1"></a><span id="l65.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-message-helpers.js</span>
<a href="#l65.2"></a><span id="l65.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-message-helpers.js</span>
<a href="#l65.3"></a><span id="l65.3" class="difflineat">@@ -5,18 +5,18 @@</span>
<a href="#l65.4"></a><span id="l65.4"> /*</span>
<a href="#l65.5"></a><span id="l65.5">  * Helpers to deal with message (nsIMsgDBHdr) parsing.</span>
<a href="#l65.6"></a><span id="l65.6">  */</span>
<a href="#l65.7"></a><span id="l65.7"> </span>
<a href="#l65.8"></a><span id="l65.8"> &quot;use strict&quot;;</span>
<a href="#l65.9"></a><span id="l65.9"> </span>
<a href="#l65.10"></a><span id="l65.10"> var MODULE_NAME = &quot;message-helpers&quot;;</span>
<a href="#l65.11"></a><span id="l65.11"> </span>
<a href="#l65.12"></a><span id="l65.12" class="difflineminus">-var frame = ChromeUtils.import(&quot;chrome://mozmill/content/modules/frame.js&quot;);</span>
<a href="#l65.13"></a><span id="l65.13" class="difflineminus">-var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.js&quot;);</span>
<a href="#l65.14"></a><span id="l65.14" class="difflineplus">+var frame = ChromeUtils.import(&quot;chrome://mozmill/content/modules/frame.jsm&quot;);</span>
<a href="#l65.15"></a><span id="l65.15" class="difflineplus">+var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.jsm&quot;);</span>
<a href="#l65.16"></a><span id="l65.16"> </span>
<a href="#l65.17"></a><span id="l65.17"> var {MsgHdrToMimeMessage} = ChromeUtils.import(&quot;resource:///modules/gloda/mimemsg.js&quot;);</span>
<a href="#l65.18"></a><span id="l65.18"> </span>
<a href="#l65.19"></a><span id="l65.19"> function installInto(module) {</span>
<a href="#l65.20"></a><span id="l65.20">   module.to_mime_message = to_mime_message;</span>
<a href="#l65.21"></a><span id="l65.21"> }</span>
<a href="#l65.22"></a><span id="l65.22"> </span>
<a href="#l65.23"></a><span id="l65.23"> /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l66.1"></a><span id="l66.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-mouse-event-helpers.js</span>
<a href="#l66.2"></a><span id="l66.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-mouse-event-helpers.js</span>
<a href="#l66.3"></a><span id="l66.3" class="difflineat">@@ -4,17 +4,17 @@</span>
<a href="#l66.4"></a><span id="l66.4"> </span>
<a href="#l66.5"></a><span id="l66.5"> &quot;use strict&quot;;</span>
<a href="#l66.6"></a><span id="l66.6"> </span>
<a href="#l66.7"></a><span id="l66.7"> var MODULE_NAME = &quot;mouse-event-helpers&quot;;</span>
<a href="#l66.8"></a><span id="l66.8"> </span>
<a href="#l66.9"></a><span id="l66.9"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l66.10"></a><span id="l66.10"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;];</span>
<a href="#l66.11"></a><span id="l66.11"> </span>
<a href="#l66.12"></a><span id="l66.12" class="difflineminus">-var EventUtils = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/EventUtils.js&quot;);</span>
<a href="#l66.13"></a><span id="l66.13" class="difflineplus">+var EventUtils = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/EventUtils.jsm&quot;);</span>
<a href="#l66.14"></a><span id="l66.14"> </span>
<a href="#l66.15"></a><span id="l66.15"> var fdh;</span>
<a href="#l66.16"></a><span id="l66.16"> </span>
<a href="#l66.17"></a><span id="l66.17"> function setupModule() {</span>
<a href="#l66.18"></a><span id="l66.18">   fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l66.19"></a><span id="l66.19"> }</span>
<a href="#l66.20"></a><span id="l66.20"> </span>
<a href="#l66.21"></a><span id="l66.21"> function installInto(module) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l67.1"></a><span id="l67.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-newmailaccount-helpers.js</span>
<a href="#l67.2"></a><span id="l67.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-newmailaccount-helpers.js</span>
<a href="#l67.3"></a><span id="l67.3" class="difflineat">@@ -5,17 +5,17 @@</span>
<a href="#l67.4"></a><span id="l67.4"> &quot;use strict&quot;;</span>
<a href="#l67.5"></a><span id="l67.5"> </span>
<a href="#l67.6"></a><span id="l67.6"> var MODULE_NAME = &quot;newmailaccount-helpers&quot;;</span>
<a href="#l67.7"></a><span id="l67.7"> </span>
<a href="#l67.8"></a><span id="l67.8"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l67.9"></a><span id="l67.9"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;keyboard-helpers&quot;,</span>
<a href="#l67.10"></a><span id="l67.10">                        &quot;dom-helpers&quot;];</span>
<a href="#l67.11"></a><span id="l67.11"> </span>
<a href="#l67.12"></a><span id="l67.12" class="difflineminus">-var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l67.13"></a><span id="l67.13" class="difflineplus">+var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l67.14"></a><span id="l67.14"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l67.15"></a><span id="l67.15"> var {fixIterator} = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l67.16"></a><span id="l67.16"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l67.17"></a><span id="l67.17"> </span>
<a href="#l67.18"></a><span id="l67.18"> var mc, fdh, kbh, dh;</span>
<a href="#l67.19"></a><span id="l67.19"> </span>
<a href="#l67.20"></a><span id="l67.20"> function setupModule(module) {</span>
<a href="#l67.21"></a><span id="l67.21">   fdh = collector.getModule('folder-display-helpers');</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l68.1"></a><span id="l68.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-pref-window-helpers.js</span>
<a href="#l68.2"></a><span id="l68.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-pref-window-helpers.js</span>
<a href="#l68.3"></a><span id="l68.3" class="difflineat">@@ -9,17 +9,17 @@</span>
<a href="#l68.4"></a><span id="l68.4"> </span>
<a href="#l68.5"></a><span id="l68.5"> &quot;use strict&quot;;</span>
<a href="#l68.6"></a><span id="l68.6"> </span>
<a href="#l68.7"></a><span id="l68.7"> var MODULE_NAME = &quot;pref-window-helpers&quot;;</span>
<a href="#l68.8"></a><span id="l68.8"> </span>
<a href="#l68.9"></a><span id="l68.9"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l68.10"></a><span id="l68.10"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;content-tab-helpers&quot;];</span>
<a href="#l68.11"></a><span id="l68.11"> </span>
<a href="#l68.12"></a><span id="l68.12" class="difflineminus">-var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.js&quot;);</span>
<a href="#l68.13"></a><span id="l68.13" class="difflineplus">+var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.jsm&quot;);</span>
<a href="#l68.14"></a><span id="l68.14"> </span>
<a href="#l68.15"></a><span id="l68.15"> var fdh;</span>
<a href="#l68.16"></a><span id="l68.16"> var cth;</span>
<a href="#l68.17"></a><span id="l68.17"> </span>
<a href="#l68.18"></a><span id="l68.18"> function setupModule() {</span>
<a href="#l68.19"></a><span id="l68.19">   fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l68.20"></a><span id="l68.20">   cth = collector.getModule(&quot;content-tab-helpers&quot;);</span>
<a href="#l68.21"></a><span id="l68.21"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l69.1"></a><span id="l69.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-window-helpers.js</span>
<a href="#l69.2"></a><span id="l69.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-window-helpers.js</span>
<a href="#l69.3"></a><span id="l69.3" class="difflineat">@@ -5,21 +5,20 @@</span>
<a href="#l69.4"></a><span id="l69.4"> &quot;use strict&quot;;</span>
<a href="#l69.5"></a><span id="l69.5"> </span>
<a href="#l69.6"></a><span id="l69.6"> var MODULE_NAME = &quot;window-helpers&quot;;</span>
<a href="#l69.7"></a><span id="l69.7"> </span>
<a href="#l69.8"></a><span id="l69.8"> var {fixIterator} = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l69.9"></a><span id="l69.9"> var {NetUtil} = ChromeUtils.import(&quot;resource://gre/modules/NetUtil.jsm&quot;);</span>
<a href="#l69.10"></a><span id="l69.10"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l69.11"></a><span id="l69.11"> </span>
<a href="#l69.12"></a><span id="l69.12" class="difflineminus">-var mozmill = ChromeUtils.import(&quot;chrome://mozmill/content/modules/mozmill.js&quot;);</span>
<a href="#l69.13"></a><span id="l69.13" class="difflineminus">-var controller = ChromeUtils.import(&quot;chrome://mozmill/content/modules/controller.js&quot;);</span>
<a href="#l69.14"></a><span id="l69.14" class="difflineminus">-var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l69.15"></a><span id="l69.15" class="difflineminus">-var frame = ChromeUtils.import(&quot;chrome://mozmill/content/modules/frame.js&quot;);</span>
<a href="#l69.16"></a><span id="l69.16" class="difflineminus">-var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.js&quot;);</span>
<a href="#l69.17"></a><span id="l69.17" class="difflineplus">+var controller = ChromeUtils.import(&quot;chrome://mozmill/content/modules/controller.jsm&quot;);</span>
<a href="#l69.18"></a><span id="l69.18" class="difflineplus">+var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l69.19"></a><span id="l69.19" class="difflineplus">+var frame = ChromeUtils.import(&quot;chrome://mozmill/content/modules/frame.jsm&quot;);</span>
<a href="#l69.20"></a><span id="l69.20" class="difflineplus">+var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.jsm&quot;);</span>
<a href="#l69.21"></a><span id="l69.21"> </span>
<a href="#l69.22"></a><span id="l69.22"> /**</span>
<a href="#l69.23"></a><span id="l69.23">  * Timeout to use when waiting for the first window ever to load.  This is</span>
<a href="#l69.24"></a><span id="l69.24">  *  long because we are basically waiting for the entire app startup process.</span>
<a href="#l69.25"></a><span id="l69.25">  */</span>
<a href="#l69.26"></a><span id="l69.26"> var FIRST_WINDOW_EVER_TIMEOUT_MS = 30000;</span>
<a href="#l69.27"></a><span id="l69.27"> /**</span>
<a href="#l69.28"></a><span id="l69.28">  * Interval to check if the window has shown up for the first window ever to</span>
<a href="#l69.29"></a><span id="l69.29" class="difflineat">@@ -191,17 +190,17 @@ var WindowWatcher = {</span>
<a href="#l69.30"></a><span id="l69.30">       return;</span>
<a href="#l69.31"></a><span id="l69.31"> </span>
<a href="#l69.32"></a><span id="l69.32">     // Add ourselves as an nsIWindowMediatorListener so we can here about when</span>
<a href="#l69.33"></a><span id="l69.33">     //  windows get registered with the window mediator.  Because this</span>
<a href="#l69.34"></a><span id="l69.34">     //  generally happens</span>
<a href="#l69.35"></a><span id="l69.35">     // Another possible means of getting this info would be to observe</span>
<a href="#l69.36"></a><span id="l69.36">     //  &quot;xul-window-visible&quot;, but it provides no context and may still require</span>
<a href="#l69.37"></a><span id="l69.37">     //  polling anyways.</span>
<a href="#l69.38"></a><span id="l69.38" class="difflineminus">-    mozmill.wm.addListener(this);</span>
<a href="#l69.39"></a><span id="l69.39" class="difflineplus">+    Services.wm.addListener(this);</span>
<a href="#l69.40"></a><span id="l69.40"> </span>
<a href="#l69.41"></a><span id="l69.41">     this._inited = true;</span>
<a href="#l69.42"></a><span id="l69.42">   },</span>
<a href="#l69.43"></a><span id="l69.43"> </span>
<a href="#l69.44"></a><span id="l69.44">   /**</span>
<a href="#l69.45"></a><span id="l69.45">    * Track the windowtypes we are waiting on.  Keys are windowtypes.  When</span>
<a href="#l69.46"></a><span id="l69.46">    *  watching for new windows, values are initially null, and are set to an</span>
<a href="#l69.47"></a><span id="l69.47">    *  nsIXULWindow when we actually find the window.  When watching for closing</span>
<a href="#l69.48"></a><span id="l69.48" class="difflineat">@@ -225,19 +224,18 @@ var WindowWatcher = {</span>
<a href="#l69.49"></a><span id="l69.49">   planForAlreadyOpenWindow:</span>
<a href="#l69.50"></a><span id="l69.50">       function WindowWatcher_planForAlreadyOpenWindow(aWindowType) {</span>
<a href="#l69.51"></a><span id="l69.51">     this.waitingList.set(aWindowType, null);</span>
<a href="#l69.52"></a><span id="l69.52">     // We need to iterate over all the XUL windows and consider them all.</span>
<a href="#l69.53"></a><span id="l69.53">     //  We can't pass the window type because the window might not have a</span>
<a href="#l69.54"></a><span id="l69.54">     //  window type yet.</span>
<a href="#l69.55"></a><span id="l69.55">     // because this iterates from old to new, this does the right thing in that</span>
<a href="#l69.56"></a><span id="l69.56">     //  side-effects of consider will pick the most recent window.</span>
<a href="#l69.57"></a><span id="l69.57" class="difflineminus">-    for (let xulWindow of fixIterator(</span>
<a href="#l69.58"></a><span id="l69.58" class="difflineminus">-                                 mozmill.wm.getXULWindowEnumerator(null),</span>
<a href="#l69.59"></a><span id="l69.59" class="difflineminus">-                                 Ci.nsIXULWindow)) {</span>
<a href="#l69.60"></a><span id="l69.60" class="difflineplus">+    for (let xulWindow of fixIterator(Services.wm.getXULWindowEnumerator(null),</span>
<a href="#l69.61"></a><span id="l69.61" class="difflineplus">+                                      Ci.nsIXULWindow)) {</span>
<a href="#l69.62"></a><span id="l69.62">       if (!this.consider(xulWindow))</span>
<a href="#l69.63"></a><span id="l69.63">         this.monitoringList.push(xulWindow);</span>
<a href="#l69.64"></a><span id="l69.64">     }</span>
<a href="#l69.65"></a><span id="l69.65">   },</span>
<a href="#l69.66"></a><span id="l69.66"> </span>
<a href="#l69.67"></a><span id="l69.67">   /**</span>
<a href="#l69.68"></a><span id="l69.68">    * The current windowType we are waiting to open.  This is mainly a means of</span>
<a href="#l69.69"></a><span id="l69.69">    *  communicating the desired window type to monitorize without having to</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l70.1"></a><span id="l70.1" class="difflineminus">--- a/mail/test/mozmill/tabmail/test-tabmail-dragndrop.js</span>
<a href="#l70.2"></a><span id="l70.2" class="difflineplus">+++ b/mail/test/mozmill/tabmail/test-tabmail-dragndrop.js</span>
<a href="#l70.3"></a><span id="l70.3" class="difflineat">@@ -1,15 +1,15 @@</span>
<a href="#l70.4"></a><span id="l70.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l70.5"></a><span id="l70.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l70.6"></a><span id="l70.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l70.7"></a><span id="l70.7"> </span>
<a href="#l70.8"></a><span id="l70.8"> &quot;use strict&quot;;</span>
<a href="#l70.9"></a><span id="l70.9"> </span>
<a href="#l70.10"></a><span id="l70.10" class="difflineminus">-var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l70.11"></a><span id="l70.11" class="difflineplus">+var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l70.12"></a><span id="l70.12"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l70.13"></a><span id="l70.13"> </span>
<a href="#l70.14"></a><span id="l70.14"> /*</span>
<a href="#l70.15"></a><span id="l70.15">  * Test rearanging tabs via drag'n'drop.</span>
<a href="#l70.16"></a><span id="l70.16">  */</span>
<a href="#l70.17"></a><span id="l70.17"> </span>
<a href="#l70.18"></a><span id="l70.18"> var MODULE_NAME = &quot;test-tabmail-dragndrop&quot;;</span>
<a href="#l70.19"></a><span id="l70.19"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l71.1"></a><span id="l71.1" class="difflineminus">--- a/mail/test/resources/mozmill/mozmill/__init__.py</span>
<a href="#l71.2"></a><span id="l71.2" class="difflineplus">+++ b/mail/test/resources/mozmill/mozmill/__init__.py</span>
<a href="#l71.3"></a><span id="l71.3" class="difflineat">@@ -62,17 +62,17 @@ import mozrunner</span>
<a href="#l71.4"></a><span id="l71.4"> </span>
<a href="#l71.5"></a><span id="l71.5"> from time import sleep</span>
<a href="#l71.6"></a><span id="l71.6"> </span>
<a href="#l71.7"></a><span id="l71.7"> logger = logging.getLogger('mozmill')</span>
<a href="#l71.8"></a><span id="l71.8"> basedir = os.path.abspath(os.path.dirname(__file__))</span>
<a href="#l71.9"></a><span id="l71.9"> </span>
<a href="#l71.10"></a><span id="l71.10"> extension_path = os.path.join(basedir, 'extension')</span>
<a href="#l71.11"></a><span id="l71.11"> </span>
<a href="#l71.12"></a><span id="l71.12" class="difflineminus">-mozmillModuleJs = &quot;ChromeUtils.import('chrome://mozmill/content/modules/mozmill.js')&quot;</span>
<a href="#l71.13"></a><span id="l71.13" class="difflineplus">+mozmillModuleJs = &quot;ChromeUtils.import('chrome://mozmill/content/modules/mozmill.jsm')&quot;</span>
<a href="#l71.14"></a><span id="l71.14"> </span>
<a href="#l71.15"></a><span id="l71.15"> try:</span>
<a href="#l71.16"></a><span id="l71.16">     import pkg_resources</span>
<a href="#l71.17"></a><span id="l71.17">     version = pkg_resources.get_distribution('mozmill').version</span>
<a href="#l71.18"></a><span id="l71.18"> except:</span>
<a href="#l71.19"></a><span id="l71.19">     # pkg_resources not available</span>
<a href="#l71.20"></a><span id="l71.20">     version = None</span>
<a href="#l71.21"></a><span id="l71.21"> </span>
<a href="#l71.22"></a><span id="l71.22" class="difflineat">@@ -194,24 +194,16 @@ class MozMill(object):</span>
<a href="#l71.23"></a><span id="l71.23">             return False</span>
<a href="#l71.24"></a><span id="l71.24">         self.endTest_listener({</span>
<a href="#l71.25"></a><span id="l71.25">             &quot;name&quot;: method,</span>
<a href="#l71.26"></a><span id="l71.26">             &quot;failed&quot;: 0,</span>
<a href="#l71.27"></a><span id="l71.27">             &quot;filename&quot;: python_callbacks_module.__file__</span>
<a href="#l71.28"></a><span id="l71.28">         })</span>
<a href="#l71.29"></a><span id="l71.29">         return True</span>
<a href="#l71.30"></a><span id="l71.30"> </span>
<a href="#l71.31"></a><span id="l71.31" class="difflineminus">-    def firePythonCallback_listener(self, obj):</span>
<a href="#l71.32"></a><span id="l71.32" class="difflineminus">-        callback_file = &quot;%s_callbacks.py&quot; % os.path.splitext(obj['filename'])[0]</span>
<a href="#l71.33"></a><span id="l71.33" class="difflineminus">-        if os.path.isfile(callback_file):</span>
<a href="#l71.34"></a><span id="l71.34" class="difflineminus">-            python_callbacks_module = imp.load_source('callbacks', callback_file)</span>
<a href="#l71.35"></a><span id="l71.35" class="difflineminus">-        else:</span>
<a href="#l71.36"></a><span id="l71.36" class="difflineminus">-            raise Exception(&quot;No valid callback file&quot;)</span>
<a href="#l71.37"></a><span id="l71.37" class="difflineminus">-        self.fire_python_callback(obj['method'], obj['arg'], python_callbacks_module)</span>
<a href="#l71.38"></a><span id="l71.38" class="difflineminus">-</span>
<a href="#l71.39"></a><span id="l71.39">     def create_network(self):</span>
<a href="#l71.40"></a><span id="l71.40"> </span>
<a href="#l71.41"></a><span id="l71.41">         # get the bridge and the back-channel</span>
<a href="#l71.42"></a><span id="l71.42">         self.back_channel, self.bridge = jsbridge.wait_and_create_network(&quot;127.0.0.1&quot;,</span>
<a href="#l71.43"></a><span id="l71.43">                                                                           self.jsbridge_port)</span>
<a href="#l71.44"></a><span id="l71.44"> </span>
<a href="#l71.45"></a><span id="l71.45">         # set a timeout on jsbridge actions in order to ensure termination</span>
<a href="#l71.46"></a><span id="l71.46">         self.back_channel.timeout = self.bridge.timeout = self.jsbridge_timeout</span>
<a href="#l71.47"></a><span id="l71.47" class="difflineat">@@ -227,17 +219,16 @@ class MozMill(object):</span>
<a href="#l71.48"></a><span id="l71.48">         if not profile:</span>
<a href="#l71.49"></a><span id="l71.49">             profile = self.profile_class(addons=[jsbridge.extension_path, extension_path])</span>
<a href="#l71.50"></a><span id="l71.50">         self.profile = profile</span>
<a href="#l71.51"></a><span id="l71.51"> </span>
<a href="#l71.52"></a><span id="l71.52">         if not runner:</span>
<a href="#l71.53"></a><span id="l71.53">             runner = self.runner_class(profile=self.profile,</span>
<a href="#l71.54"></a><span id="l71.54">                                        cmdargs=[&quot;-jsbridge&quot;, str(self.jsbridge_port)])</span>
<a href="#l71.55"></a><span id="l71.55"> </span>
<a href="#l71.56"></a><span id="l71.56" class="difflineminus">-        self.add_listener(self.firePythonCallback_listener, eventType='mozmill.firePythonCallback')</span>
<a href="#l71.57"></a><span id="l71.57">         self.runner = runner</span>
<a href="#l71.58"></a><span id="l71.58">         self.endRunnerCalled = False</span>
<a href="#l71.59"></a><span id="l71.59"> </span>
<a href="#l71.60"></a><span id="l71.60">         self.runner.start()</span>
<a href="#l71.61"></a><span id="l71.61">         self.create_network()</span>
<a href="#l71.62"></a><span id="l71.62">         self.appinfo = self.get_appinfo(self.bridge)</span>
<a href="#l71.63"></a><span id="l71.63"> </span>
<a href="#l71.64"></a><span id="l71.64">         # set the starttime for the tests</span>
<a href="#l71.65"></a><span id="l71.65" class="difflineat">@@ -273,17 +264,17 @@ class MozMill(object):</span>
<a href="#l71.66"></a><span id="l71.66">         - test : test files or directories to run</span>
<a href="#l71.67"></a><span id="l71.67">         - sleeptime : initial time to sleep [s] (not sure why the default is 4)</span>
<a href="#l71.68"></a><span id="l71.68">         &quot;&quot;&quot;</span>
<a href="#l71.69"></a><span id="l71.69"> </span>
<a href="#l71.70"></a><span id="l71.70">         tests = self.find_tests(tests)</span>
<a href="#l71.71"></a><span id="l71.71">         self.tests.extend(tests)</span>
<a href="#l71.72"></a><span id="l71.72"> </span>
<a href="#l71.73"></a><span id="l71.73">         frame = jsbridge.JSObject(self.bridge,</span>
<a href="#l71.74"></a><span id="l71.74" class="difflineminus">-                                  &quot;ChromeUtils.import('chrome://mozmill/content/modules/frame.js')&quot;)</span>
<a href="#l71.75"></a><span id="l71.75" class="difflineplus">+                                  &quot;ChromeUtils.import('chrome://mozmill/content/modules/frame.jsm')&quot;)</span>
<a href="#l71.76"></a><span id="l71.76">         sleep(sleeptime)</span>
<a href="#l71.77"></a><span id="l71.77"> </span>
<a href="#l71.78"></a><span id="l71.78">         # transfer persisted data</span>
<a href="#l71.79"></a><span id="l71.79">         frame.persisted = self.persisted</span>
<a href="#l71.80"></a><span id="l71.80"> </span>
<a href="#l71.81"></a><span id="l71.81">         # run the test files</span>
<a href="#l71.82"></a><span id="l71.82">         for test in tests:</span>
<a href="#l71.83"></a><span id="l71.83">             frame.runTestFile(test)</span>
<a href="#l71.84"></a><span id="l71.84" class="difflineat">@@ -563,38 +554,31 @@ class MozMillRestart(MozMill):</span>
<a href="#l71.85"></a><span id="l71.85">             profile = self.profile_class(addons=[jsbridge.extension_path, extension_path])</span>
<a href="#l71.86"></a><span id="l71.86">         self.profile = profile</span>
<a href="#l71.87"></a><span id="l71.87"> </span>
<a href="#l71.88"></a><span id="l71.88">         if not runner:</span>
<a href="#l71.89"></a><span id="l71.89">             runner = self.runner_class(profile=self.profile,</span>
<a href="#l71.90"></a><span id="l71.90">                                        cmdargs=[&quot;-jsbridge&quot;, str(self.jsbridge_port)])</span>
<a href="#l71.91"></a><span id="l71.91">         self.runner = runner</span>
<a href="#l71.92"></a><span id="l71.92">         self.endRunnerCalled = False</span>
<a href="#l71.93"></a><span id="l71.93" class="difflineminus">-        self.add_listener(self.firePythonCallback_listener, eventType='mozmill.firePythonCallback')</span>
<a href="#l71.94"></a><span id="l71.94"> </span>
<a href="#l71.95"></a><span id="l71.95">         # set the starttime for the tests</span>
<a href="#l71.96"></a><span id="l71.96">         # XXX assumes run_tests will be called soon after (currently true)</span>
<a href="#l71.97"></a><span id="l71.97">         self.starttime = datetime.utcnow()</span>
<a href="#l71.98"></a><span id="l71.98"> </span>
<a href="#l71.99"></a><span id="l71.99" class="difflineminus">-    def firePythonCallback_listener(self, obj):</span>
<a href="#l71.100"></a><span id="l71.100" class="difflineminus">-        if obj['fire_now']:</span>
<a href="#l71.101"></a><span id="l71.101" class="difflineminus">-            self.fire_python_callback(obj['method'], obj['arg'], self.python_callbacks_module)</span>
<a href="#l71.102"></a><span id="l71.102" class="difflineminus">-        else:</span>
<a href="#l71.103"></a><span id="l71.103" class="difflineminus">-            self.python_callbacks.append(obj)</span>
<a href="#l71.104"></a><span id="l71.104" class="difflineminus">-</span>
<a href="#l71.105"></a><span id="l71.105">     def start_runner(self):</span>
<a href="#l71.106"></a><span id="l71.106"> </span>
<a href="#l71.107"></a><span id="l71.107">         # if user_restart we don't need to start the browser back up</span>
<a href="#l71.108"></a><span id="l71.108">         if self.currentShutdownMode != self.shutdownModes.user_restart:</span>
<a href="#l71.109"></a><span id="l71.109">             self.runner.start()</span>
<a href="#l71.110"></a><span id="l71.110"> </span>
<a href="#l71.111"></a><span id="l71.111">         self.create_network()</span>
<a href="#l71.112"></a><span id="l71.112">         self.appinfo = self.get_appinfo(self.bridge)</span>
<a href="#l71.113"></a><span id="l71.113">         frame = jsbridge.JSObject(self.bridge,</span>
<a href="#l71.114"></a><span id="l71.114" class="difflineminus">-                                  &quot;ChromeUtils.import('chrome://mozmill/content/modules/frame.js')&quot;)</span>
<a href="#l71.115"></a><span id="l71.115" class="difflineplus">+                                  &quot;ChromeUtils.import('chrome://mozmill/content/modules/frame.jsm')&quot;)</span>
<a href="#l71.116"></a><span id="l71.116">         return frame</span>
<a href="#l71.117"></a><span id="l71.117"> </span>
<a href="#l71.118"></a><span id="l71.118">     def run_dir(self, test_dir, sleeptime=0):</span>
<a href="#l71.119"></a><span id="l71.119">         &quot;&quot;&quot;run a directory of restart tests resetting the profile per directory&quot;&quot;&quot;</span>
<a href="#l71.120"></a><span id="l71.120"> </span>
<a href="#l71.121"></a><span id="l71.121">         # TODO:  document this behaviour!</span>
<a href="#l71.122"></a><span id="l71.122">         if os.path.isfile(os.path.join(test_dir, 'testPre.js')):</span>
<a href="#l71.123"></a><span id="l71.123">             pre_test = os.path.join(test_dir, 'testPre.js')</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l72.1"></a><span id="l72.1">rename from mail/test/resources/mozmill/mozmill/extension/content/modules/controller.js</span>
<a href="#l72.2"></a><span id="l72.2">rename to mail/test/resources/mozmill/mozmill/extension/content/modules/controller.jsm</span>
<a href="#l72.3"></a><span id="l72.3" class="difflineminus">--- a/mail/test/resources/mozmill/mozmill/extension/content/modules/controller.js</span>
<a href="#l72.4"></a><span id="l72.4" class="difflineplus">+++ b/mail/test/resources/mozmill/mozmill/extension/content/modules/controller.jsm</span>
<a href="#l72.5"></a><span id="l72.5" class="difflineat">@@ -36,109 +36,99 @@</span>
<a href="#l72.6"></a><span id="l72.6"> // the provisions above, a recipient may use your version of this file under</span>
<a href="#l72.7"></a><span id="l72.7"> // the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l72.8"></a><span id="l72.8"> //</span>
<a href="#l72.9"></a><span id="l72.9"> // ***** END LICENSE BLOCK *****</span>
<a href="#l72.10"></a><span id="l72.10"> </span>
<a href="#l72.11"></a><span id="l72.11"> var EXPORTED_SYMBOLS = [&quot;MozMillController&quot;, &quot;MozMillAsyncTest&quot;,</span>
<a href="#l72.12"></a><span id="l72.12">                         &quot;globalEventRegistry&quot;, &quot;sleep&quot;, &quot;windowMap&quot;];</span>
<a href="#l72.13"></a><span id="l72.13"> </span>
<a href="#l72.14"></a><span id="l72.14" class="difflineminus">-var EventUtils = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/EventUtils.js&quot;);</span>
<a href="#l72.15"></a><span id="l72.15" class="difflineplus">+var EventUtils = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/EventUtils.jsm&quot;);</span>
<a href="#l72.16"></a><span id="l72.16"> </span>
<a href="#l72.17"></a><span id="l72.17" class="difflineminus">-var events = ChromeUtils.import(&quot;chrome://mozmill/content/modules/events.js&quot;);</span>
<a href="#l72.18"></a><span id="l72.18" class="difflineminus">-var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.js&quot;);</span>
<a href="#l72.19"></a><span id="l72.19" class="difflineminus">-var elementslib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l72.20"></a><span id="l72.20" class="difflineminus">-var frame = ChromeUtils.import(&quot;chrome://mozmill/content/modules/frame.js&quot;);</span>
<a href="#l72.21"></a><span id="l72.21" class="difflineminus">-</span>
<a href="#l72.22"></a><span id="l72.22" class="difflineminus">-var hwindow = Cc[&quot;@mozilla.org/appshell/appShellService;1&quot;]</span>
<a href="#l72.23"></a><span id="l72.23" class="difflineminus">-                .getService(Ci.nsIAppShellService)</span>
<a href="#l72.24"></a><span id="l72.24" class="difflineminus">-                .hiddenDOMWindow;</span>
<a href="#l72.25"></a><span id="l72.25" class="difflineminus">-var aConsoleService = Cc[&quot;@mozilla.org/consoleservice;1&quot;].</span>
<a href="#l72.26"></a><span id="l72.26" class="difflineminus">-     getService(Ci.nsIConsoleService);</span>
<a href="#l72.27"></a><span id="l72.27" class="difflineplus">+var events = ChromeUtils.import(&quot;chrome://mozmill/content/modules/events.jsm&quot;);</span>
<a href="#l72.28"></a><span id="l72.28" class="difflineplus">+var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.jsm&quot;);</span>
<a href="#l72.29"></a><span id="l72.29" class="difflineplus">+var elementslib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l72.30"></a><span id="l72.30" class="difflineplus">+var frame = ChromeUtils.import(&quot;chrome://mozmill/content/modules/frame.jsm&quot;);</span>
<a href="#l72.31"></a><span id="l72.31"> </span>
<a href="#l72.32"></a><span id="l72.32"> // The window map which is used to store information e.g. loaded state of each</span>
<a href="#l72.33"></a><span id="l72.33"> // open chrome and content window.</span>
<a href="#l72.34"></a><span id="l72.34"> var windowMap = {</span>
<a href="#l72.35"></a><span id="l72.35" class="difflineminus">-  _windows : { },</span>
<a href="#l72.36"></a><span id="l72.36" class="difflineplus">+  _windows: {},</span>
<a href="#l72.37"></a><span id="l72.37"> </span>
<a href="#l72.38"></a><span id="l72.38" class="difflineminus">-  contains : function (aWindowId) {</span>
<a href="#l72.39"></a><span id="l72.39" class="difflineplus">+  contains(aWindowId) {</span>
<a href="#l72.40"></a><span id="l72.40">     return (aWindowId in this._windows);</span>
<a href="#l72.41"></a><span id="l72.41">   },</span>
<a href="#l72.42"></a><span id="l72.42"> </span>
<a href="#l72.43"></a><span id="l72.43" class="difflineminus">-  getValue : function (aWindowId, aProperty) {</span>
<a href="#l72.44"></a><span id="l72.44" class="difflineplus">+  getValue(aWindowId, aProperty) {</span>
<a href="#l72.45"></a><span id="l72.45">     if (!this.contains(aWindowId)) {</span>
<a href="#l72.46"></a><span id="l72.46">       return undefined;</span>
<a href="#l72.47"></a><span id="l72.47" class="difflineminus">-    } else {</span>
<a href="#l72.48"></a><span id="l72.48" class="difflineminus">-      var win = this._windows[aWindowId];</span>
<a href="#l72.49"></a><span id="l72.49" class="difflineplus">+    }</span>
<a href="#l72.50"></a><span id="l72.50"> </span>
<a href="#l72.51"></a><span id="l72.51" class="difflineminus">-      return (aProperty in win) ? win[aProperty]</span>
<a href="#l72.52"></a><span id="l72.52" class="difflineminus">-                                : undefined;</span>
<a href="#l72.53"></a><span id="l72.53" class="difflineminus">-    }</span>
<a href="#l72.54"></a><span id="l72.54" class="difflineplus">+    var win = this._windows[aWindowId];</span>
<a href="#l72.55"></a><span id="l72.55" class="difflineplus">+    return (aProperty in win) ? win[aProperty] : undefined;</span>
<a href="#l72.56"></a><span id="l72.56">   },</span>
<a href="#l72.57"></a><span id="l72.57"> </span>
<a href="#l72.58"></a><span id="l72.58" class="difflineminus">-  remove : function (aWindowId) {</span>
<a href="#l72.59"></a><span id="l72.59" class="difflineplus">+  remove(aWindowId) {</span>
<a href="#l72.60"></a><span id="l72.60">     if (this.contains(aWindowId))</span>
<a href="#l72.61"></a><span id="l72.61">       delete this._windows[aWindowId];</span>
<a href="#l72.62"></a><span id="l72.62">     // dump(&quot;* current map: &quot; + JSON.stringify(this._windows) + &quot;\n&quot;);</span>
<a href="#l72.63"></a><span id="l72.63">   },</span>
<a href="#l72.64"></a><span id="l72.64"> </span>
<a href="#l72.65"></a><span id="l72.65" class="difflineminus">-  update : function (aWindowId, aProperty, aValue) {</span>
<a href="#l72.66"></a><span id="l72.66" class="difflineplus">+  update(aWindowId, aProperty, aValue) {</span>
<a href="#l72.67"></a><span id="l72.67">     if (!this.contains(aWindowId))</span>
<a href="#l72.68"></a><span id="l72.68">       this._windows[aWindowId] = { };</span>
<a href="#l72.69"></a><span id="l72.69"> </span>
<a href="#l72.70"></a><span id="l72.70">     this._windows[aWindowId][aProperty] = aValue;</span>
<a href="#l72.71"></a><span id="l72.71">     // dump(&quot;* current map: &quot; + JSON.stringify(this._windows) + &quot;\n&quot;);</span>
<a href="#l72.72"></a><span id="l72.72" class="difflineminus">-  }</span>
<a href="#l72.73"></a><span id="l72.73" class="difflineminus">-}</span>
<a href="#l72.74"></a><span id="l72.74" class="difflineplus">+  },</span>
<a href="#l72.75"></a><span id="l72.75" class="difflineplus">+};</span>
<a href="#l72.76"></a><span id="l72.76"> </span>
<a href="#l72.77"></a><span id="l72.77"> </span>
<a href="#l72.78"></a><span id="l72.78"> // Declare most used utils functions in the controller namespace</span>
<a href="#l72.79"></a><span id="l72.79"> var sleep = utils.sleep;</span>
<a href="#l72.80"></a><span id="l72.80"> var assert = utils.assert;</span>
<a href="#l72.81"></a><span id="l72.81" class="difflineminus">-var waitFor = utils.waitFor;</span>
<a href="#l72.82"></a><span id="l72.82"> </span>
<a href="#l72.83"></a><span id="l72.83" class="difflineminus">-var waitForEvents = function() {}</span>
<a href="#l72.84"></a><span id="l72.84" class="difflineplus">+var waitForEvents = function() {};</span>
<a href="#l72.85"></a><span id="l72.85"> </span>
<a href="#l72.86"></a><span id="l72.86"> waitForEvents.prototype = {</span>
<a href="#l72.87"></a><span id="l72.87">   /**</span>
<a href="#l72.88"></a><span id="l72.88">    *  Initialize list of events for given node</span>
<a href="#l72.89"></a><span id="l72.89">    */</span>
<a href="#l72.90"></a><span id="l72.90" class="difflineminus">-  init : function waitForEvents_init(node, events) {</span>
<a href="#l72.91"></a><span id="l72.91" class="difflineplus">+  init(node, events) {</span>
<a href="#l72.92"></a><span id="l72.92">     if (node.getNode != undefined)</span>
<a href="#l72.93"></a><span id="l72.93">       node = node.getNode();</span>
<a href="#l72.94"></a><span id="l72.94"> </span>
<a href="#l72.95"></a><span id="l72.95">     this.events = events;</span>
<a href="#l72.96"></a><span id="l72.96">     this.node = node;</span>
<a href="#l72.97"></a><span id="l72.97">     node.firedEvents = {};</span>
<a href="#l72.98"></a><span id="l72.98">     this.registry = {};</span>
<a href="#l72.99"></a><span id="l72.99"> </span>
<a href="#l72.100"></a><span id="l72.100">     for (var e of events) {</span>
<a href="#l72.101"></a><span id="l72.101">       var listener = function(event) {</span>
<a href="#l72.102"></a><span id="l72.102">         this.firedEvents[event.type] = true;</span>
<a href="#l72.103"></a><span id="l72.103" class="difflineminus">-      }</span>
<a href="#l72.104"></a><span id="l72.104" class="difflineplus">+      };</span>
<a href="#l72.105"></a><span id="l72.105">       this.registry[e] = listener;</span>
<a href="#l72.106"></a><span id="l72.106">       this.registry[e].result = false;</span>
<a href="#l72.107"></a><span id="l72.107">       this.node.addEventListener(e, this.registry[e], true);</span>
<a href="#l72.108"></a><span id="l72.108">     }</span>
<a href="#l72.109"></a><span id="l72.109">   },</span>
<a href="#l72.110"></a><span id="l72.110"> </span>
<a href="#l72.111"></a><span id="l72.111">   /**</span>
<a href="#l72.112"></a><span id="l72.112">    * Wait until all assigned events have been fired</span>
<a href="#l72.113"></a><span id="l72.113">    */</span>
<a href="#l72.114"></a><span id="l72.114" class="difflineminus">-  wait : function waitForEvents_wait(timeout, interval)</span>
<a href="#l72.115"></a><span id="l72.115" class="difflineminus">-  {</span>
<a href="#l72.116"></a><span id="l72.116" class="difflineplus">+  wait(timeout, interval) {</span>
<a href="#l72.117"></a><span id="l72.117">     for (var e in this.registry) {</span>
<a href="#l72.118"></a><span id="l72.118">       utils.waitFor(() =&gt; {</span>
<a href="#l72.119"></a><span id="l72.119" class="difflineminus">-        return this.node.firedEvents[e] == true;</span>
<a href="#l72.120"></a><span id="l72.120" class="difflineminus">-      }, &quot;Timeout happened before event '&quot; + e +&quot;' was fired.&quot;, timeout, interval);</span>
<a href="#l72.121"></a><span id="l72.121" class="difflineplus">+        return this.node.firedEvents[e];</span>
<a href="#l72.122"></a><span id="l72.122" class="difflineplus">+      }, &quot;Timeout happened before event '&quot; + e + &quot;' was fired.&quot;, timeout, interval);</span>
<a href="#l72.123"></a><span id="l72.123"> </span>
<a href="#l72.124"></a><span id="l72.124">       this.node.removeEventListener(e, this.registry[e], true);</span>
<a href="#l72.125"></a><span id="l72.125">     }</span>
<a href="#l72.126"></a><span id="l72.126" class="difflineminus">-  }</span>
<a href="#l72.127"></a><span id="l72.127" class="difflineminus">-}</span>
<a href="#l72.128"></a><span id="l72.128" class="difflineplus">+  },</span>
<a href="#l72.129"></a><span id="l72.129" class="difflineplus">+};</span>
<a href="#l72.130"></a><span id="l72.130"> </span>
<a href="#l72.131"></a><span id="l72.131"> </span>
<a href="#l72.132"></a><span id="l72.132"> /**</span>
<a href="#l72.133"></a><span id="l72.133">  * Class to handle menus and context menus</span>
<a href="#l72.134"></a><span id="l72.134">  *</span>
<a href="#l72.135"></a><span id="l72.135">  * @constructor</span>
<a href="#l72.136"></a><span id="l72.136">  * @param {MozMillController} controller</span>
<a href="#l72.137"></a><span id="l72.137">  *        Mozmill controller of the window under test</span>
<a href="#l72.138"></a><span id="l72.138" class="difflineat">@@ -153,32 +143,31 @@ var Menu = function(controller, menuSele</span>
<a href="#l72.139"></a><span id="l72.139">   this._menu = null;</span>
<a href="#l72.140"></a><span id="l72.140"> </span>
<a href="#l72.141"></a><span id="l72.141">   document = document || controller.window.document;</span>
<a href="#l72.142"></a><span id="l72.142">   var node = document.querySelector(menuSelector);</span>
<a href="#l72.143"></a><span id="l72.143">   if (node) {</span>
<a href="#l72.144"></a><span id="l72.144">     // We don't unwrap nodes automatically yet (Bug 573185)</span>
<a href="#l72.145"></a><span id="l72.145">     node = node.wrappedJSObject || node;</span>
<a href="#l72.146"></a><span id="l72.146">     this._menu = new elementslib.Elem(node);</span>
<a href="#l72.147"></a><span id="l72.147" class="difflineminus">-  }</span>
<a href="#l72.148"></a><span id="l72.148" class="difflineminus">-  else {</span>
<a href="#l72.149"></a><span id="l72.149" class="difflineplus">+  } else {</span>
<a href="#l72.150"></a><span id="l72.150">     throw new Error(&quot;Menu element '&quot; + menuSelector + &quot;' not found.&quot;);</span>
<a href="#l72.151"></a><span id="l72.151">   }</span>
<a href="#l72.152"></a><span id="l72.152" class="difflineminus">-}</span>
<a href="#l72.153"></a><span id="l72.153" class="difflineplus">+};</span>
<a href="#l72.154"></a><span id="l72.154"> </span>
<a href="#l72.155"></a><span id="l72.155"> Menu.prototype = {</span>
<a href="#l72.156"></a><span id="l72.156"> </span>
<a href="#l72.157"></a><span id="l72.157">   /**</span>
<a href="#l72.158"></a><span id="l72.158">    * Open and populate the menu</span>
<a href="#l72.159"></a><span id="l72.159">    *</span>
<a href="#l72.160"></a><span id="l72.160">    * @param {ElemBase} contextElement</span>
<a href="#l72.161"></a><span id="l72.161">    *        Element whose context menu has to be opened</span>
<a href="#l72.162"></a><span id="l72.162">    * @returns {Menu} The Menu instance</span>
<a href="#l72.163"></a><span id="l72.163">    */</span>
<a href="#l72.164"></a><span id="l72.164" class="difflineminus">-  open : function(contextElement) {</span>
<a href="#l72.165"></a><span id="l72.165" class="difflineplus">+  open(contextElement) {</span>
<a href="#l72.166"></a><span id="l72.166">     // We have to open the context menu</span>
<a href="#l72.167"></a><span id="l72.167">     var menu = this._menu.getNode();</span>
<a href="#l72.168"></a><span id="l72.168">     if ((menu.localName == &quot;popup&quot; || menu.localName == &quot;menupopup&quot;) &amp;&amp;</span>
<a href="#l72.169"></a><span id="l72.169">         contextElement &amp;&amp; contextElement.exists()) {</span>
<a href="#l72.170"></a><span id="l72.170">       this._controller.rightClick(contextElement);</span>
<a href="#l72.171"></a><span id="l72.171">       this._controller.waitFor(function() {</span>
<a href="#l72.172"></a><span id="l72.172">         return menu.state == &quot;open&quot;;</span>
<a href="#l72.173"></a><span id="l72.173">       }, &quot;Context menu has been opened.&quot;);</span>
<a href="#l72.174"></a><span id="l72.174" class="difflineat">@@ -190,17 +179,17 @@ Menu.prototype = {</span>
<a href="#l72.175"></a><span id="l72.175">     return this;</span>
<a href="#l72.176"></a><span id="l72.176">   },</span>
<a href="#l72.177"></a><span id="l72.177"> </span>
<a href="#l72.178"></a><span id="l72.178">   /**</span>
<a href="#l72.179"></a><span id="l72.179">    * Close the menu</span>
<a href="#l72.180"></a><span id="l72.180">    *</span>
<a href="#l72.181"></a><span id="l72.181">    * @returns {Menu} The Menu instance</span>
<a href="#l72.182"></a><span id="l72.182">    */</span>
<a href="#l72.183"></a><span id="l72.183" class="difflineminus">-  close : function() {</span>
<a href="#l72.184"></a><span id="l72.184" class="difflineplus">+  close() {</span>
<a href="#l72.185"></a><span id="l72.185">     var menu = this._menu.getNode();</span>
<a href="#l72.186"></a><span id="l72.186"> </span>
<a href="#l72.187"></a><span id="l72.187">     this._controller.keypress(this._menu, &quot;VK_ESCAPE&quot;, {});</span>
<a href="#l72.188"></a><span id="l72.188">     this._controller.waitFor(function() {</span>
<a href="#l72.189"></a><span id="l72.189">       return menu.state == &quot;closed&quot;;</span>
<a href="#l72.190"></a><span id="l72.190">     }, &quot;Context menu has been closed.&quot;);</span>
<a href="#l72.191"></a><span id="l72.191"> </span>
<a href="#l72.192"></a><span id="l72.192">     return this;</span>
<a href="#l72.193"></a><span id="l72.193" class="difflineat">@@ -209,17 +198,17 @@ Menu.prototype = {</span>
<a href="#l72.194"></a><span id="l72.194">   /**</span>
<a href="#l72.195"></a><span id="l72.195">    * Retrieve the specified menu entry</span>
<a href="#l72.196"></a><span id="l72.196">    *</span>
<a href="#l72.197"></a><span id="l72.197">    * @param {string} itemSelector</span>
<a href="#l72.198"></a><span id="l72.198">    *        jQuery like selector string of the menu item</span>
<a href="#l72.199"></a><span id="l72.199">    * @returns {ElemBase} Menu element</span>
<a href="#l72.200"></a><span id="l72.200">    * @throws Error If menu element has not been found</span>
<a href="#l72.201"></a><span id="l72.201">    */</span>
<a href="#l72.202"></a><span id="l72.202" class="difflineminus">-  getItem : function(itemSelector) {</span>
<a href="#l72.203"></a><span id="l72.203" class="difflineplus">+  getItem(itemSelector) {</span>
<a href="#l72.204"></a><span id="l72.204">     var node = this._menu.getNode().querySelector(itemSelector);</span>
<a href="#l72.205"></a><span id="l72.205"> </span>
<a href="#l72.206"></a><span id="l72.206">     if (!node) {</span>
<a href="#l72.207"></a><span id="l72.207">       throw new Error(&quot;Menu entry '&quot; + itemSelector + &quot;' not found.&quot;);</span>
<a href="#l72.208"></a><span id="l72.208">     }</span>
<a href="#l72.209"></a><span id="l72.209"> </span>
<a href="#l72.210"></a><span id="l72.210">     return new elementslib.Elem(node);</span>
<a href="#l72.211"></a><span id="l72.211">   },</span>
<a href="#l72.212"></a><span id="l72.212" class="difflineat">@@ -227,80 +216,80 @@ Menu.prototype = {</span>
<a href="#l72.213"></a><span id="l72.213">   /**</span>
<a href="#l72.214"></a><span id="l72.214">    * Click the specified menu entry</span>
<a href="#l72.215"></a><span id="l72.215">    *</span>
<a href="#l72.216"></a><span id="l72.216">    * @param {string} itemSelector</span>
<a href="#l72.217"></a><span id="l72.217">    *        jQuery like selector string of the menu item</span>
<a href="#l72.218"></a><span id="l72.218">    *</span>
<a href="#l72.219"></a><span id="l72.219">    * @returns {Menu} The Menu instance</span>
<a href="#l72.220"></a><span id="l72.220">    */</span>
<a href="#l72.221"></a><span id="l72.221" class="difflineminus">-  click : function(itemSelector) {</span>
<a href="#l72.222"></a><span id="l72.222" class="difflineplus">+  click(itemSelector) {</span>
<a href="#l72.223"></a><span id="l72.223">     this._controller.click(this.getItem(itemSelector));</span>
<a href="#l72.224"></a><span id="l72.224"> </span>
<a href="#l72.225"></a><span id="l72.225">     return this;</span>
<a href="#l72.226"></a><span id="l72.226">   },</span>
<a href="#l72.227"></a><span id="l72.227"> </span>
<a href="#l72.228"></a><span id="l72.228">   /**</span>
<a href="#l72.229"></a><span id="l72.229">    * Synthesize a keypress against the menu</span>
<a href="#l72.230"></a><span id="l72.230">    *</span>
<a href="#l72.231"></a><span id="l72.231">    * @param {string} key</span>
<a href="#l72.232"></a><span id="l72.232">    *        Key to press</span>
<a href="#l72.233"></a><span id="l72.233">    * @param {object} modifier</span>
<a href="#l72.234"></a><span id="l72.234">    *        Key modifiers</span>
<a href="#l72.235"></a><span id="l72.235">    * @see MozMillController#keypress</span>
<a href="#l72.236"></a><span id="l72.236">    *</span>
<a href="#l72.237"></a><span id="l72.237">    * @returns {Menu} The Menu instance</span>
<a href="#l72.238"></a><span id="l72.238">    */</span>
<a href="#l72.239"></a><span id="l72.239" class="difflineminus">-  keypress : function(key, modifier) {</span>
<a href="#l72.240"></a><span id="l72.240" class="difflineplus">+  keypress(key, modifier) {</span>
<a href="#l72.241"></a><span id="l72.241">     this._controller.keypress(this._menu, key, modifier);</span>
<a href="#l72.242"></a><span id="l72.242"> </span>
<a href="#l72.243"></a><span id="l72.243">     return this;</span>
<a href="#l72.244"></a><span id="l72.244">   },</span>
<a href="#l72.245"></a><span id="l72.245"> </span>
<a href="#l72.246"></a><span id="l72.246">   /**</span>
<a href="#l72.247"></a><span id="l72.247">    * Opens the context menu, click the specified entry and</span>
<a href="#l72.248"></a><span id="l72.248">    * make sure that the menu has been closed.</span>
<a href="#l72.249"></a><span id="l72.249">    *</span>
<a href="#l72.250"></a><span id="l72.250">    * @param {string} itemSelector</span>
<a href="#l72.251"></a><span id="l72.251">    *        jQuery like selector string of the element</span>
<a href="#l72.252"></a><span id="l72.252">    * @param {ElemBase} contextElement</span>
<a href="#l72.253"></a><span id="l72.253">    *        Element whose context menu has to be opened</span>
<a href="#l72.254"></a><span id="l72.254">    *</span>
<a href="#l72.255"></a><span id="l72.255">    * @returns {Menu} The Menu instance</span>
<a href="#l72.256"></a><span id="l72.256">    */</span>
<a href="#l72.257"></a><span id="l72.257" class="difflineminus">-  select : function(itemSelector, contextElement) {</span>
<a href="#l72.258"></a><span id="l72.258" class="difflineplus">+  select(itemSelector, contextElement) {</span>
<a href="#l72.259"></a><span id="l72.259">     this.open(contextElement);</span>
<a href="#l72.260"></a><span id="l72.260">     this.click(itemSelector);</span>
<a href="#l72.261"></a><span id="l72.261">     this.close();</span>
<a href="#l72.262"></a><span id="l72.262">   },</span>
<a href="#l72.263"></a><span id="l72.263"> </span>
<a href="#l72.264"></a><span id="l72.264">   /**</span>
<a href="#l72.265"></a><span id="l72.265">    * Recursive function which iterates through all menu elements and</span>
<a href="#l72.266"></a><span id="l72.266">    * populates the menus with dynamic menu entries.</span>
<a href="#l72.267"></a><span id="l72.267">    *</span>
<a href="#l72.268"></a><span id="l72.268">    * @param {node} menu</span>
<a href="#l72.269"></a><span id="l72.269">    *        Top menu node whose elements have to be populated</span>
<a href="#l72.270"></a><span id="l72.270">    */</span>
<a href="#l72.271"></a><span id="l72.271" class="difflineminus">-  _buildMenu : function(menu) {</span>
<a href="#l72.272"></a><span id="l72.272" class="difflineplus">+  _buildMenu(menu) {</span>
<a href="#l72.273"></a><span id="l72.273">     var items = menu ? menu.childNodes : [];</span>
<a href="#l72.274"></a><span id="l72.274"> </span>
<a href="#l72.275"></a><span id="l72.275">     Array.from(items).forEach(function(item) {</span>
<a href="#l72.276"></a><span id="l72.276">       // When we have a menu node, fake a click onto it to populate</span>
<a href="#l72.277"></a><span id="l72.277">       // the sub menu with dynamic entries</span>
<a href="#l72.278"></a><span id="l72.278">       if (item.tagName == &quot;menu&quot;) {</span>
<a href="#l72.279"></a><span id="l72.279">         var popup = item.querySelector(&quot;menupopup&quot;);</span>
<a href="#l72.280"></a><span id="l72.280">         if (popup) {</span>
<a href="#l72.281"></a><span id="l72.281">           if (popup.allowevents) {</span>
<a href="#l72.282"></a><span id="l72.282">             events.fakeOpenPopup(this._controller.window, popup);</span>
<a href="#l72.283"></a><span id="l72.283">           }</span>
<a href="#l72.284"></a><span id="l72.284">           this._buildMenu(popup);</span>
<a href="#l72.285"></a><span id="l72.285">         }</span>
<a href="#l72.286"></a><span id="l72.286">       }</span>
<a href="#l72.287"></a><span id="l72.287">     }, this);</span>
<a href="#l72.288"></a><span id="l72.288" class="difflineminus">-  }</span>
<a href="#l72.289"></a><span id="l72.289" class="difflineplus">+  },</span>
<a href="#l72.290"></a><span id="l72.290"> };</span>
<a href="#l72.291"></a><span id="l72.291"> </span>
<a href="#l72.292"></a><span id="l72.292"> /**</span>
<a href="#l72.293"></a><span id="l72.293">  * Deprecated - Has to be removed with Mozmill 2.0</span>
<a href="#l72.294"></a><span id="l72.294">  */</span>
<a href="#l72.295"></a><span id="l72.295"> var MenuTree = function(aWindow, aMenu) {</span>
<a href="#l72.296"></a><span id="l72.296">   var items = aMenu ? aMenu.childNodes : null;</span>
<a href="#l72.297"></a><span id="l72.297">   if (!items) {</span>
<a href="#l72.298"></a><span id="l72.298" class="difflineat">@@ -332,32 +321,31 @@ var MenuTree = function(aWindow, aMenu) </span>
<a href="#l72.299"></a><span id="l72.299">       this[label] = entry;</span>
<a href="#l72.300"></a><span id="l72.300"> </span>
<a href="#l72.301"></a><span id="l72.301">       if (node.id)</span>
<a href="#l72.302"></a><span id="l72.302">         this[node.id] = this[label];</span>
<a href="#l72.303"></a><span id="l72.303">     }</span>
<a href="#l72.304"></a><span id="l72.304">   }</span>
<a href="#l72.305"></a><span id="l72.305"> };</span>
<a href="#l72.306"></a><span id="l72.306"> </span>
<a href="#l72.307"></a><span id="l72.307" class="difflineminus">-var MozMillController = function (window) {</span>
<a href="#l72.308"></a><span id="l72.308" class="difflineplus">+var MozMillController = function(window) {</span>
<a href="#l72.309"></a><span id="l72.309">   this.window = window;</span>
<a href="#l72.310"></a><span id="l72.310"> </span>
<a href="#l72.311"></a><span id="l72.311" class="difflineminus">-  this.mozmillModule =</span>
<a href="#l72.312"></a><span id="l72.312" class="difflineminus">-    ChromeUtils.import(&quot;chrome://mozmill/content/modules/mozmill.js&quot;);</span>
<a href="#l72.313"></a><span id="l72.313" class="difflineplus">+  this.mozmillModule = ChromeUtils.import(&quot;chrome://mozmill/content/modules/mozmill.jsm&quot;);</span>
<a href="#l72.314"></a><span id="l72.314"> </span>
<a href="#l72.315"></a><span id="l72.315">   utils.waitFor(function() {</span>
<a href="#l72.316"></a><span id="l72.316">     return window != null &amp;&amp; this.isLoaded();</span>
<a href="#l72.317"></a><span id="l72.317">   }, &quot;controller(): Window could not be initialized.&quot;, undefined, undefined, this);</span>
<a href="#l72.318"></a><span id="l72.318"> </span>
<a href="#l72.319"></a><span id="l72.319" class="difflineminus">-  if ( controllerAdditions[window.document.documentElement.getAttribute('windowtype')] != undefined ) {</span>
<a href="#l72.320"></a><span id="l72.320" class="difflineplus">+  if (controllerAdditions[window.document.documentElement.getAttribute(&quot;windowtype&quot;)] != undefined) {</span>
<a href="#l72.321"></a><span id="l72.321">     this.prototype = new utils.Copy(this.prototype);</span>
<a href="#l72.322"></a><span id="l72.322" class="difflineminus">-    controllerAdditions[window.document.documentElement.getAttribute('windowtype')](this);</span>
<a href="#l72.323"></a><span id="l72.323" class="difflineminus">-    this.windowtype = window.document.documentElement.getAttribute('windowtype');</span>
<a href="#l72.324"></a><span id="l72.324" class="difflineplus">+    controllerAdditions[window.document.documentElement.getAttribute(&quot;windowtype&quot;)](this);</span>
<a href="#l72.325"></a><span id="l72.325" class="difflineplus">+    this.windowtype = window.document.documentElement.getAttribute(&quot;windowtype&quot;);</span>
<a href="#l72.326"></a><span id="l72.326">   }</span>
<a href="#l72.327"></a><span id="l72.327" class="difflineminus">-}</span>
<a href="#l72.328"></a><span id="l72.328" class="difflineplus">+};</span>
<a href="#l72.329"></a><span id="l72.329"> </span>
<a href="#l72.330"></a><span id="l72.330"> MozMillController.prototype.sleep = utils.sleep;</span>
<a href="#l72.331"></a><span id="l72.331"> </span>
<a href="#l72.332"></a><span id="l72.332"> /**</span>
<a href="#l72.333"></a><span id="l72.333">  * Synthesize a keypress event on the given element</span>
<a href="#l72.334"></a><span id="l72.334">  *</span>
<a href="#l72.335"></a><span id="l72.335">  * @param {ElemBase} aTarget</span>
<a href="#l72.336"></a><span id="l72.336">  *        Element which will receive the keypress event</span>
<a href="#l72.337"></a><span id="l72.337" class="difflineat">@@ -381,69 +369,66 @@ MozMillController.prototype.sleep = util</span>
<a href="#l72.338"></a><span id="l72.338">  *        Elements: target     - Element which should receive the event</span>
<a href="#l72.339"></a><span id="l72.339">  *                               [optional - default: current element]</span>
<a href="#l72.340"></a><span id="l72.340">  *                  type       - Type of the expected key event</span>
<a href="#l72.341"></a><span id="l72.341">  */</span>
<a href="#l72.342"></a><span id="l72.342"> MozMillController.prototype.keypress = function(aTarget, aKey, aModifiers, aExpectedEvent) {</span>
<a href="#l72.343"></a><span id="l72.343">   var element = (aTarget == null) ? this.window : aTarget.getNode();</span>
<a href="#l72.344"></a><span id="l72.344">   if (!element) {</span>
<a href="#l72.345"></a><span id="l72.345">     throw new Error(&quot;Could not find element &quot; + aTarget.getInfo());</span>
<a href="#l72.346"></a><span id="l72.346" class="difflineminus">-    return false;</span>
<a href="#l72.347"></a><span id="l72.347">   }</span>
<a href="#l72.348"></a><span id="l72.348"> </span>
<a href="#l72.349"></a><span id="l72.349" class="difflineminus">-  events.triggerKeyEvent(element, 'keypress', aKey, aModifiers, aExpectedEvent);</span>
<a href="#l72.350"></a><span id="l72.350" class="difflineplus">+  events.triggerKeyEvent(element, &quot;keypress&quot;, aKey, aModifiers, aExpectedEvent);</span>
<a href="#l72.351"></a><span id="l72.351"> </span>
<a href="#l72.352"></a><span id="l72.352" class="difflineminus">-  frame.events.pass({'function':'Controller.keypress()'});</span>
<a href="#l72.353"></a><span id="l72.353" class="difflineplus">+  frame.events.pass({&quot;function&quot;: &quot;Controller.keypress()&quot;});</span>
<a href="#l72.354"></a><span id="l72.354">   return true;</span>
<a href="#l72.355"></a><span id="l72.355" class="difflineminus">-}</span>
<a href="#l72.356"></a><span id="l72.356" class="difflineplus">+};</span>
<a href="#l72.357"></a><span id="l72.357"> </span>
<a href="#l72.358"></a><span id="l72.358"> /**</span>
<a href="#l72.359"></a><span id="l72.359">  * Synthesize keypress events for each character on the given element</span>
<a href="#l72.360"></a><span id="l72.360">  *</span>
<a href="#l72.361"></a><span id="l72.361">  * @param {ElemBase} aTarget</span>
<a href="#l72.362"></a><span id="l72.362">  *        Element which will receive the type event</span>
<a href="#l72.363"></a><span id="l72.363">  * @param {string} aText</span>
<a href="#l72.364"></a><span id="l72.364">  *        The text to send as single keypress events</span>
<a href="#l72.365"></a><span id="l72.365">  * @param {object} aExpectedEvent</span>
<a href="#l72.366"></a><span id="l72.366">  *        Information about the expected event to occur</span>
<a href="#l72.367"></a><span id="l72.367">  *        Elements: target     - Element which should receive the event</span>
<a href="#l72.368"></a><span id="l72.368">  *                               [optional - default: current element]</span>
<a href="#l72.369"></a><span id="l72.369">  *                  type       - Type of the expected key event</span>
<a href="#l72.370"></a><span id="l72.370">  */</span>
<a href="#l72.371"></a><span id="l72.371" class="difflineminus">-MozMillController.prototype.type = function (aTarget, aText, aExpectedEvent) {</span>
<a href="#l72.372"></a><span id="l72.372" class="difflineplus">+MozMillController.prototype.type = function(aTarget, aText, aExpectedEvent) {</span>
<a href="#l72.373"></a><span id="l72.373">   var element = (aTarget == null) ? this.window : aTarget.getNode();</span>
<a href="#l72.374"></a><span id="l72.374">   if (!element) {</span>
<a href="#l72.375"></a><span id="l72.375">     throw new Error(&quot;could not find element &quot; + aTarget.getInfo());</span>
<a href="#l72.376"></a><span id="l72.376" class="difflineminus">-    return false;</span>
<a href="#l72.377"></a><span id="l72.377">   }</span>
<a href="#l72.378"></a><span id="l72.378"> </span>
<a href="#l72.379"></a><span id="l72.379">   Array.from(aText).forEach(function(letter) {</span>
<a href="#l72.380"></a><span id="l72.380" class="difflineminus">-    events.triggerKeyEvent(element, 'keypress', letter, {}, aExpectedEvent);</span>
<a href="#l72.381"></a><span id="l72.381" class="difflineplus">+    events.triggerKeyEvent(element, &quot;keypress&quot;, letter, {}, aExpectedEvent);</span>
<a href="#l72.382"></a><span id="l72.382">   });</span>
<a href="#l72.383"></a><span id="l72.383"> </span>
<a href="#l72.384"></a><span id="l72.384" class="difflineminus">-  frame.events.pass({'function':'Controller.type()'});</span>
<a href="#l72.385"></a><span id="l72.385" class="difflineplus">+  frame.events.pass({&quot;function&quot;: &quot;Controller.type()&quot;});</span>
<a href="#l72.386"></a><span id="l72.386">   return true;</span>
<a href="#l72.387"></a><span id="l72.387" class="difflineminus">-}</span>
<a href="#l72.388"></a><span id="l72.388" class="difflineplus">+};</span>
<a href="#l72.389"></a><span id="l72.389"> </span>
<a href="#l72.390"></a><span id="l72.390"> // Open the specified url in the current tab</span>
<a href="#l72.391"></a><span id="l72.391" class="difflineminus">-MozMillController.prototype.open = function(url)</span>
<a href="#l72.392"></a><span id="l72.392" class="difflineminus">-{</span>
<a href="#l72.393"></a><span id="l72.393" class="difflineminus">-  switch(this.mozmillModule.Application) {</span>
<a href="#l72.394"></a><span id="l72.394" class="difflineplus">+MozMillController.prototype.open = function(url) {</span>
<a href="#l72.395"></a><span id="l72.395" class="difflineplus">+  switch (this.mozmillModule.Application) {</span>
<a href="#l72.396"></a><span id="l72.396">     case &quot;Firefox&quot;:</span>
<a href="#l72.397"></a><span id="l72.397">       this.window.gBrowser.loadURI(url);</span>
<a href="#l72.398"></a><span id="l72.398">       break;</span>
<a href="#l72.399"></a><span id="l72.399">     case &quot;SeaMonkey&quot;:</span>
<a href="#l72.400"></a><span id="l72.400">       this.window.getBrowser().loadURI(url);</span>
<a href="#l72.401"></a><span id="l72.401">       break;</span>
<a href="#l72.402"></a><span id="l72.402">     default:</span>
<a href="#l72.403"></a><span id="l72.403">       throw new Error(&quot;MozMillController.open not supported.&quot;);</span>
<a href="#l72.404"></a><span id="l72.404">   }</span>
<a href="#l72.405"></a><span id="l72.405"> </span>
<a href="#l72.406"></a><span id="l72.406" class="difflineminus">-  frame.events.pass({'function':'Controller.open()'});</span>
<a href="#l72.407"></a><span id="l72.407" class="difflineminus">-}</span>
<a href="#l72.408"></a><span id="l72.408" class="difflineplus">+  frame.events.pass({&quot;function&quot;: &quot;Controller.open()&quot;});</span>
<a href="#l72.409"></a><span id="l72.409" class="difflineplus">+};</span>
<a href="#l72.410"></a><span id="l72.410"> </span>
<a href="#l72.411"></a><span id="l72.411"> /**</span>
<a href="#l72.412"></a><span id="l72.412">  * Synthesize a general mouse event on the given element</span>
<a href="#l72.413"></a><span id="l72.413">  *</span>
<a href="#l72.414"></a><span id="l72.414">  * @param {ElemBase} aTarget</span>
<a href="#l72.415"></a><span id="l72.415">  *        Element which will receive the mouse event</span>
<a href="#l72.416"></a><span id="l72.416">  * @param {number} aOffsetX</span>
<a href="#l72.417"></a><span id="l72.417">  *        Relative x offset in the elements bounds to click on</span>
<a href="#l72.418"></a><span id="l72.418" class="difflineat">@@ -471,17 +456,16 @@ MozMillController.prototype.open = funct</span>
<a href="#l72.419"></a><span id="l72.419">  * @param {object} aExpectedEvent</span>
<a href="#l72.420"></a><span id="l72.420">  *        Information about the expected event to occur</span>
<a href="#l72.421"></a><span id="l72.421">  *        Elements: target     - Element which should receive the event</span>
<a href="#l72.422"></a><span id="l72.422">  *                               [optional - default: current element]</span>
<a href="#l72.423"></a><span id="l72.423">  *                  type       - Type of the expected mouse event</span>
<a href="#l72.424"></a><span id="l72.424">  */</span>
<a href="#l72.425"></a><span id="l72.425"> MozMillController.prototype.mouseEvent = function(aTarget, aOffsetX, aOffsetY,</span>
<a href="#l72.426"></a><span id="l72.426">                                                   aEvent, aExpectedEvent) {</span>
<a href="#l72.427"></a><span id="l72.427" class="difflineminus">-</span>
<a href="#l72.428"></a><span id="l72.428">   var element = aTarget.getNode();</span>
<a href="#l72.429"></a><span id="l72.429">   if (!element) {</span>
<a href="#l72.430"></a><span id="l72.430">     throw new Error(&quot;mouseEvent: could not find element &quot; +</span>
<a href="#l72.431"></a><span id="l72.431">                     aTarget.getInfo());</span>
<a href="#l72.432"></a><span id="l72.432">   }</span>
<a href="#l72.433"></a><span id="l72.433"> </span>
<a href="#l72.434"></a><span id="l72.434">   // If no offset is given we will use the center of the element to click on.</span>
<a href="#l72.435"></a><span id="l72.435">   var rect = element.getBoundingClientRect();</span>
<a href="#l72.436"></a><span id="l72.436" class="difflineat">@@ -504,800 +488,764 @@ MozMillController.prototype.mouseEvent =</span>
<a href="#l72.437"></a><span id="l72.437">     if (!target) {</span>
<a href="#l72.438"></a><span id="l72.438">       throw new Error(&quot;mouseEvent: could not find element &quot; +</span>
<a href="#l72.439"></a><span id="l72.439">                       aExpectedEvent.target.getInfo());</span>
<a href="#l72.440"></a><span id="l72.440">     }</span>
<a href="#l72.441"></a><span id="l72.441"> </span>
<a href="#l72.442"></a><span id="l72.442">     EventUtils.synthesizeMouseExpectEvent(element, aOffsetX, aOffsetY, aEvent,</span>
<a href="#l72.443"></a><span id="l72.443">                                           target, aExpectedEvent.event,</span>
<a href="#l72.444"></a><span id="l72.444">                                           &quot;controller.mouseEvent()&quot;,</span>
<a href="#l72.445"></a><span id="l72.445" class="difflineminus">-                                          element.ownerDocument.defaultView);</span>
<a href="#l72.446"></a><span id="l72.446" class="difflineplus">+                                          element.ownerGlobal);</span>
<a href="#l72.447"></a><span id="l72.447">   } else {</span>
<a href="#l72.448"></a><span id="l72.448" class="difflineminus">-    EventUtils.synthesizeMouse(element, aOffsetX, aOffsetY, aEvent,</span>
<a href="#l72.449"></a><span id="l72.449" class="difflineminus">-                               element.ownerDocument.defaultView);</span>
<a href="#l72.450"></a><span id="l72.450" class="difflineplus">+    EventUtils.synthesizeMouse(element, aOffsetX, aOffsetY, aEvent, element.ownerGlobal);</span>
<a href="#l72.451"></a><span id="l72.451">   }</span>
<a href="#l72.452"></a><span id="l72.452"> </span>
<a href="#l72.453"></a><span id="l72.453">   sleep(0);</span>
<a href="#l72.454"></a><span id="l72.454" class="difflineminus">-}</span>
<a href="#l72.455"></a><span id="l72.455" class="difflineplus">+};</span>
<a href="#l72.456"></a><span id="l72.456"> </span>
<a href="#l72.457"></a><span id="l72.457"> /**</span>
<a href="#l72.458"></a><span id="l72.458">  * Synthesize a mouse click event on the given element</span>
<a href="#l72.459"></a><span id="l72.459">  */</span>
<a href="#l72.460"></a><span id="l72.460"> MozMillController.prototype.click = function(elem, left, top, expectedEvent) {</span>
<a href="#l72.461"></a><span id="l72.461" class="difflineminus">-  var element = elem.getNode()</span>
<a href="#l72.462"></a><span id="l72.462" class="difflineplus">+  var element = elem.getNode();</span>
<a href="#l72.463"></a><span id="l72.463"> </span>
<a href="#l72.464"></a><span id="l72.464">   // Handle menu items differently</span>
<a href="#l72.465"></a><span id="l72.465">   if (element &amp;&amp; element.tagName == &quot;menuitem&quot;) {</span>
<a href="#l72.466"></a><span id="l72.466">     element.click();</span>
<a href="#l72.467"></a><span id="l72.467">   } else {</span>
<a href="#l72.468"></a><span id="l72.468">     this.mouseEvent(elem, left, top, {}, expectedEvent);</span>
<a href="#l72.469"></a><span id="l72.469">   }</span>
<a href="#l72.470"></a><span id="l72.470"> </span>
<a href="#l72.471"></a><span id="l72.471" class="difflineminus">-  frame.events.pass({'function':'controller.click()'});</span>
<a href="#l72.472"></a><span id="l72.472" class="difflineminus">-}</span>
<a href="#l72.473"></a><span id="l72.473" class="difflineplus">+  frame.events.pass({&quot;function&quot;: &quot;controller.click()&quot;});</span>
<a href="#l72.474"></a><span id="l72.474" class="difflineplus">+};</span>
<a href="#l72.475"></a><span id="l72.475"> </span>
<a href="#l72.476"></a><span id="l72.476"> /**</span>
<a href="#l72.477"></a><span id="l72.477">  * Synthesize a double click on the given element</span>
<a href="#l72.478"></a><span id="l72.478">  */</span>
<a href="#l72.479"></a><span id="l72.479"> MozMillController.prototype.doubleClick = function(elem, left, top, expectedEvent) {</span>
<a href="#l72.480"></a><span id="l72.480">   this.mouseEvent(elem, left, top, {clickCount: 2}, expectedEvent);</span>
<a href="#l72.481"></a><span id="l72.481"> </span>
<a href="#l72.482"></a><span id="l72.482" class="difflineminus">-  frame.events.pass({'function':'controller.doubleClick()'});</span>
<a href="#l72.483"></a><span id="l72.483" class="difflineplus">+  frame.events.pass({&quot;function&quot;: &quot;controller.doubleClick()&quot;});</span>
<a href="#l72.484"></a><span id="l72.484">   return true;</span>
<a href="#l72.485"></a><span id="l72.485" class="difflineminus">-}</span>
<a href="#l72.486"></a><span id="l72.486" class="difflineplus">+};</span>
<a href="#l72.487"></a><span id="l72.487"> </span>
<a href="#l72.488"></a><span id="l72.488"> /**</span>
<a href="#l72.489"></a><span id="l72.489">  * Synthesize a mouse down event on the given element</span>
<a href="#l72.490"></a><span id="l72.490">  */</span>
<a href="#l72.491"></a><span id="l72.491" class="difflineminus">-MozMillController.prototype.mouseDown = function (elem, button, left, top, expectedEvent) {</span>
<a href="#l72.492"></a><span id="l72.492" class="difflineminus">-  this.mouseEvent(elem, left, top, {button: button, type: &quot;mousedown&quot;}, expectedEvent);</span>
<a href="#l72.493"></a><span id="l72.493" class="difflineplus">+MozMillController.prototype.mouseDown = function(elem, button, left, top, expectedEvent) {</span>
<a href="#l72.494"></a><span id="l72.494" class="difflineplus">+  this.mouseEvent(elem, left, top, {button, type: &quot;mousedown&quot;}, expectedEvent);</span>
<a href="#l72.495"></a><span id="l72.495"> </span>
<a href="#l72.496"></a><span id="l72.496" class="difflineminus">-  frame.events.pass({'function':'controller.mouseDown()'});</span>
<a href="#l72.497"></a><span id="l72.497" class="difflineplus">+  frame.events.pass({&quot;function&quot;: &quot;controller.mouseDown()&quot;});</span>
<a href="#l72.498"></a><span id="l72.498">   return true;</span>
<a href="#l72.499"></a><span id="l72.499"> };</span>
<a href="#l72.500"></a><span id="l72.500"> </span>
<a href="#l72.501"></a><span id="l72.501"> /**</span>
<a href="#l72.502"></a><span id="l72.502">  * Synthesize a mouse out event on the given element</span>
<a href="#l72.503"></a><span id="l72.503">  */</span>
<a href="#l72.504"></a><span id="l72.504" class="difflineminus">-MozMillController.prototype.mouseOut = function (elem, button, left, top, expectedEvent) {</span>
<a href="#l72.505"></a><span id="l72.505" class="difflineminus">-  this.mouseEvent(elem, left, top, {button: button, type: &quot;mouseout&quot;}, expectedEvent);</span>
<a href="#l72.506"></a><span id="l72.506" class="difflineplus">+MozMillController.prototype.mouseOut = function(elem, button, left, top, expectedEvent) {</span>
<a href="#l72.507"></a><span id="l72.507" class="difflineplus">+  this.mouseEvent(elem, left, top, {button, type: &quot;mouseout&quot;}, expectedEvent);</span>
<a href="#l72.508"></a><span id="l72.508"> </span>
<a href="#l72.509"></a><span id="l72.509" class="difflineminus">-  frame.events.pass({'function':'controller.mouseOut()'});</span>
<a href="#l72.510"></a><span id="l72.510" class="difflineplus">+  frame.events.pass({&quot;function&quot;: &quot;controller.mouseOut()&quot;});</span>
<a href="#l72.511"></a><span id="l72.511">   return true;</span>
<a href="#l72.512"></a><span id="l72.512"> };</span>
<a href="#l72.513"></a><span id="l72.513"> </span>
<a href="#l72.514"></a><span id="l72.514"> /**</span>
<a href="#l72.515"></a><span id="l72.515">  * Synthesize a mouse over event on the given element</span>
<a href="#l72.516"></a><span id="l72.516">  */</span>
<a href="#l72.517"></a><span id="l72.517" class="difflineminus">-MozMillController.prototype.mouseOver = function (elem, button, left, top, expectedEvent) {</span>
<a href="#l72.518"></a><span id="l72.518" class="difflineminus">-  this.mouseEvent(elem, left, top, {button: button, type: &quot;mouseover&quot;}, expectedEvent);</span>
<a href="#l72.519"></a><span id="l72.519" class="difflineplus">+MozMillController.prototype.mouseOver = function(elem, button, left, top, expectedEvent) {</span>
<a href="#l72.520"></a><span id="l72.520" class="difflineplus">+  this.mouseEvent(elem, left, top, {button, type: &quot;mouseover&quot;}, expectedEvent);</span>
<a href="#l72.521"></a><span id="l72.521"> </span>
<a href="#l72.522"></a><span id="l72.522" class="difflineminus">-  frame.events.pass({'function':'controller.mouseOver()'});</span>
<a href="#l72.523"></a><span id="l72.523" class="difflineplus">+  frame.events.pass({&quot;function&quot;: &quot;controller.mouseOver()&quot;});</span>
<a href="#l72.524"></a><span id="l72.524">   return true;</span>
<a href="#l72.525"></a><span id="l72.525"> };</span>
<a href="#l72.526"></a><span id="l72.526"> </span>
<a href="#l72.527"></a><span id="l72.527"> /**</span>
<a href="#l72.528"></a><span id="l72.528">  * Synthesize a mouse up event on the given element</span>
<a href="#l72.529"></a><span id="l72.529">  */</span>
<a href="#l72.530"></a><span id="l72.530" class="difflineminus">-MozMillController.prototype.mouseUp = function (elem, button, left, top, expectedEvent) {</span>
<a href="#l72.531"></a><span id="l72.531" class="difflineminus">-  this.mouseEvent(elem, left, top, {button: button, type: &quot;mouseup&quot;}, expectedEvent);</span>
<a href="#l72.532"></a><span id="l72.532" class="difflineplus">+MozMillController.prototype.mouseUp = function(elem, button, left, top, expectedEvent) {</span>
<a href="#l72.533"></a><span id="l72.533" class="difflineplus">+  this.mouseEvent(elem, left, top, {button, type: &quot;mouseup&quot;}, expectedEvent);</span>
<a href="#l72.534"></a><span id="l72.534"> </span>
<a href="#l72.535"></a><span id="l72.535" class="difflineminus">-  frame.events.pass({'function':'controller.mouseUp()'});</span>
<a href="#l72.536"></a><span id="l72.536" class="difflineplus">+  frame.events.pass({&quot;function&quot;: &quot;controller.mouseUp()&quot;});</span>
<a href="#l72.537"></a><span id="l72.537">   return true;</span>
<a href="#l72.538"></a><span id="l72.538"> };</span>
<a href="#l72.539"></a><span id="l72.539"> </span>
<a href="#l72.540"></a><span id="l72.540"> /**</span>
<a href="#l72.541"></a><span id="l72.541">  * Synthesize a mouse middle click event on the given element</span>
<a href="#l72.542"></a><span id="l72.542">  */</span>
<a href="#l72.543"></a><span id="l72.543"> MozMillController.prototype.middleClick = function(elem, left, top, expectedEvent) {</span>
<a href="#l72.544"></a><span id="l72.544">   this.mouseEvent(elem, left, top, {button: 1}, expectedEvent);</span>
<a href="#l72.545"></a><span id="l72.545"> </span>
<a href="#l72.546"></a><span id="l72.546" class="difflineminus">-  frame.events.pass({'function':'controller.middleClick()'});</span>
<a href="#l72.547"></a><span id="l72.547" class="difflineplus">+  frame.events.pass({&quot;function&quot;: &quot;controller.middleClick()&quot;});</span>
<a href="#l72.548"></a><span id="l72.548">   return true;</span>
<a href="#l72.549"></a><span id="l72.549" class="difflineminus">-}</span>
<a href="#l72.550"></a><span id="l72.550" class="difflineplus">+};</span>
<a href="#l72.551"></a><span id="l72.551"> </span>
<a href="#l72.552"></a><span id="l72.552"> /**</span>
<a href="#l72.553"></a><span id="l72.553">  * Synthesize a mouse right click event on the given element</span>
<a href="#l72.554"></a><span id="l72.554">  */</span>
<a href="#l72.555"></a><span id="l72.555"> MozMillController.prototype.rightClick = function(elem, left, top, expectedEvent) {</span>
<a href="#l72.556"></a><span id="l72.556" class="difflineminus">-  this.mouseEvent(elem, left, top, {type : &quot;contextmenu&quot;, button: 2 }, expectedEvent);</span>
<a href="#l72.557"></a><span id="l72.557" class="difflineplus">+  this.mouseEvent(elem, left, top, {type: &quot;contextmenu&quot;, button: 2}, expectedEvent);</span>
<a href="#l72.558"></a><span id="l72.558"> </span>
<a href="#l72.559"></a><span id="l72.559" class="difflineminus">-  frame.events.pass({'function':'controller.rightClick()'});</span>
<a href="#l72.560"></a><span id="l72.560" class="difflineplus">+  frame.events.pass({&quot;function&quot;: &quot;controller.rightClick()&quot;});</span>
<a href="#l72.561"></a><span id="l72.561">   return true;</span>
<a href="#l72.562"></a><span id="l72.562" class="difflineminus">-}</span>
<a href="#l72.563"></a><span id="l72.563" class="difflineplus">+};</span>
<a href="#l72.564"></a><span id="l72.564"> </span>
<a href="#l72.565"></a><span id="l72.565"> /**</span>
<a href="#l72.566"></a><span id="l72.566">  * Synthesize a mouse right click event on the given element (deprecated)</span>
<a href="#l72.567"></a><span id="l72.567">  */</span>
<a href="#l72.568"></a><span id="l72.568" class="difflineminus">-MozMillController.prototype.rightclick = function(...aArgs){</span>
<a href="#l72.569"></a><span id="l72.569" class="difflineminus">-  frame.log({function:'rightclick - Deprecation Warning', message:'Controller.rightclick should be renamed to Controller.rightClick'});</span>
<a href="#l72.570"></a><span id="l72.570" class="difflineplus">+MozMillController.prototype.rightclick = function(...aArgs) {</span>
<a href="#l72.571"></a><span id="l72.571" class="difflineplus">+  frame.log({function: &quot;rightclick - Deprecation Warning&quot;, message: &quot;Controller.rightclick should be renamed to Controller.rightClick&quot;});</span>
<a href="#l72.572"></a><span id="l72.572">   this.rightClick(...aArgs);</span>
<a href="#l72.573"></a><span id="l72.573" class="difflineminus">-}</span>
<a href="#l72.574"></a><span id="l72.574" class="difflineplus">+};</span>
<a href="#l72.575"></a><span id="l72.575"> </span>
<a href="#l72.576"></a><span id="l72.576"> /**</span>
<a href="#l72.577"></a><span id="l72.577">  * Enable/Disable a checkbox depending on the target state</span>
<a href="#l72.578"></a><span id="l72.578">  */</span>
<a href="#l72.579"></a><span id="l72.579"> MozMillController.prototype.check = function(el, state) {</span>
<a href="#l72.580"></a><span id="l72.580">   var result = false;</span>
<a href="#l72.581"></a><span id="l72.581">   var element = el.getNode();</span>
<a href="#l72.582"></a><span id="l72.582"> </span>
<a href="#l72.583"></a><span id="l72.583">   if (!element) {</span>
<a href="#l72.584"></a><span id="l72.584">     throw new Error(&quot;could not find element &quot; + el.getInfo());</span>
<a href="#l72.585"></a><span id="l72.585" class="difflineminus">-    return false;</span>
<a href="#l72.586"></a><span id="l72.586" class="difflineminus">-  }</span>
<a href="#l72.587"></a><span id="l72.587" class="difflineminus">-</span>
<a href="#l72.588"></a><span id="l72.588" class="difflineminus">-  // If we have a XUL element, unwrap its XPCNativeWrapper</span>
<a href="#l72.589"></a><span id="l72.589" class="difflineminus">-  if (element.namespaceURI == &quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;) {</span>
<a href="#l72.590"></a><span id="l72.590" class="difflineminus">-    element = utils.unwrapNode(element);</span>
<a href="#l72.591"></a><span id="l72.591">   }</span>
<a href="#l72.592"></a><span id="l72.592"> </span>
<a href="#l72.593"></a><span id="l72.593">   state = (typeof(state) == &quot;boolean&quot;) ? state : false;</span>
<a href="#l72.594"></a><span id="l72.594">   if (state != element.checked) {</span>
<a href="#l72.595"></a><span id="l72.595">     this.click(el);</span>
<a href="#l72.596"></a><span id="l72.596">     this.waitFor(function() {</span>
<a href="#l72.597"></a><span id="l72.597">       return element.checked == state;</span>
<a href="#l72.598"></a><span id="l72.598">     }, &quot;Checkbox &quot; + el.getInfo() + &quot; could not be checked/unchecked&quot;, 500);</span>
<a href="#l72.599"></a><span id="l72.599"> </span>
<a href="#l72.600"></a><span id="l72.600">     result = true;</span>
<a href="#l72.601"></a><span id="l72.601">   }</span>
<a href="#l72.602"></a><span id="l72.602"> </span>
<a href="#l72.603"></a><span id="l72.603" class="difflineminus">-  frame.events.pass({'function':'Controller.check(' + el.getInfo() + ', state: ' + state + ')'});</span>
<a href="#l72.604"></a><span id="l72.604" class="difflineplus">+  frame.events.pass({&quot;function&quot;: &quot;Controller.check(&quot; + el.getInfo() + &quot;, state: &quot; + state + &quot;)&quot;});</span>
<a href="#l72.605"></a><span id="l72.605">   return result;</span>
<a href="#l72.606"></a><span id="l72.606" class="difflineminus">-}</span>
<a href="#l72.607"></a><span id="l72.607" class="difflineplus">+};</span>
<a href="#l72.608"></a><span id="l72.608"> </span>
<a href="#l72.609"></a><span id="l72.609"> /**</span>
<a href="#l72.610"></a><span id="l72.610">  * Select the given radio button</span>
<a href="#l72.611"></a><span id="l72.611">  */</span>
<a href="#l72.612"></a><span id="l72.612" class="difflineminus">-MozMillController.prototype.radio = function(el)</span>
<a href="#l72.613"></a><span id="l72.613" class="difflineminus">-{</span>
<a href="#l72.614"></a><span id="l72.614" class="difflineplus">+MozMillController.prototype.radio = function(el) {</span>
<a href="#l72.615"></a><span id="l72.615">   var element = el.getNode();</span>
<a href="#l72.616"></a><span id="l72.616">   if (!element) {</span>
<a href="#l72.617"></a><span id="l72.617">     throw new Error(&quot;could not find element &quot; + el.getInfo());</span>
<a href="#l72.618"></a><span id="l72.618" class="difflineminus">-    return false;</span>
<a href="#l72.619"></a><span id="l72.619">   }</span>
<a href="#l72.620"></a><span id="l72.620"> </span>
<a href="#l72.621"></a><span id="l72.621">   this.click(el);</span>
<a href="#l72.622"></a><span id="l72.622">   this.waitFor(function() {</span>
<a href="#l72.623"></a><span id="l72.623" class="difflineminus">-    // If we have a XUL element, unwrap its XPCNativeWrapper</span>
<a href="#l72.624"></a><span id="l72.624" class="difflineminus">-    if (element.namespaceURI == &quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;) {</span>
<a href="#l72.625"></a><span id="l72.625" class="difflineminus">-      element = utils.unwrapNode(element);</span>
<a href="#l72.626"></a><span id="l72.626" class="difflineminus">-      return element.selected == true;</span>
<a href="#l72.627"></a><span id="l72.627" class="difflineminus">-    }</span>
<a href="#l72.628"></a><span id="l72.628" class="difflineminus">-    return element.checked == true;</span>
<a href="#l72.629"></a><span id="l72.629" class="difflineplus">+    return element.checked || element.selected;</span>
<a href="#l72.630"></a><span id="l72.630">   }, &quot;Radio button &quot; + el.getInfo() + &quot; could not be selected&quot;, 500);</span>
<a href="#l72.631"></a><span id="l72.631"> </span>
<a href="#l72.632"></a><span id="l72.632" class="difflineminus">-  frame.events.pass({'function':'Controller.radio(' + el.getInfo() + ')'});</span>
<a href="#l72.633"></a><span id="l72.633" class="difflineplus">+  frame.events.pass({&quot;function&quot;: &quot;Controller.radio(&quot; + el.getInfo() + &quot;)&quot;});</span>
<a href="#l72.634"></a><span id="l72.634">   return true;</span>
<a href="#l72.635"></a><span id="l72.635" class="difflineminus">-}</span>
<a href="#l72.636"></a><span id="l72.636" class="difflineplus">+};</span>
<a href="#l72.637"></a><span id="l72.637"> </span>
<a href="#l72.638"></a><span id="l72.638"> /**</span>
<a href="#l72.639"></a><span id="l72.639">  * Checks if the specified window has been loaded</span>
<a href="#l72.640"></a><span id="l72.640">  *</span>
<a href="#l72.641"></a><span id="l72.641">  * @param {DOMWindow} [window=this.window] Window object to check for loaded state</span>
<a href="#l72.642"></a><span id="l72.642">  */</span>
<a href="#l72.643"></a><span id="l72.643" class="difflineminus">-MozMillController.prototype.isLoaded = function (window) {</span>
<a href="#l72.644"></a><span id="l72.644" class="difflineplus">+MozMillController.prototype.isLoaded = function(window) {</span>
<a href="#l72.645"></a><span id="l72.645">   var win = window || this.window;</span>
<a href="#l72.646"></a><span id="l72.646"> </span>
<a href="#l72.647"></a><span id="l72.647">   var id = utils.getWindowId(win);</span>
<a href="#l72.648"></a><span id="l72.648">   return windowMap.contains(id) &amp;&amp; windowMap.getValue(id, &quot;loaded&quot;);</span>
<a href="#l72.649"></a><span id="l72.649" class="difflineminus">-}</span>
<a href="#l72.650"></a><span id="l72.650" class="difflineplus">+};</span>
<a href="#l72.651"></a><span id="l72.651"> </span>
<a href="#l72.652"></a><span id="l72.652" class="difflineminus">-MozMillController.prototype.waitFor = function(callback, message, timeout,</span>
<a href="#l72.653"></a><span id="l72.653" class="difflineminus">-                                               interval, thisObject) {</span>
<a href="#l72.654"></a><span id="l72.654" class="difflineplus">+MozMillController.prototype.waitFor = function(callback, message, timeout, interval, thisObject) {</span>
<a href="#l72.655"></a><span id="l72.655">   utils.waitFor(callback, message, timeout, interval, thisObject);</span>
<a href="#l72.656"></a><span id="l72.656"> </span>
<a href="#l72.657"></a><span id="l72.657" class="difflineminus">-  frame.events.pass({'function':'controller.waitFor()'});</span>
<a href="#l72.658"></a><span id="l72.658" class="difflineminus">-}</span>
<a href="#l72.659"></a><span id="l72.659" class="difflineplus">+  frame.events.pass({&quot;function&quot;: &quot;controller.waitFor()&quot;});</span>
<a href="#l72.660"></a><span id="l72.660" class="difflineplus">+};</span>
<a href="#l72.661"></a><span id="l72.661"> </span>
<a href="#l72.662"></a><span id="l72.662"> MozMillController.prototype.waitForElement = function(elem, timeout, interval) {</span>
<a href="#l72.663"></a><span id="l72.663">   this.waitFor(function() {</span>
<a href="#l72.664"></a><span id="l72.664">     return elem.exists();</span>
<a href="#l72.665"></a><span id="l72.665">   }, &quot;Timeout exceeded for waitForElement &quot; + elem.getInfo(), timeout, interval);</span>
<a href="#l72.666"></a><span id="l72.666"> </span>
<a href="#l72.667"></a><span id="l72.667" class="difflineminus">-  frame.events.pass({'function':'Controller.waitForElement()'});</span>
<a href="#l72.668"></a><span id="l72.668" class="difflineminus">-}</span>
<a href="#l72.669"></a><span id="l72.669" class="difflineplus">+  frame.events.pass({&quot;function&quot;: &quot;Controller.waitForElement()&quot;});</span>
<a href="#l72.670"></a><span id="l72.670" class="difflineplus">+};</span>
<a href="#l72.671"></a><span id="l72.671"> </span>
<a href="#l72.672"></a><span id="l72.672"> MozMillController.prototype.waitForElementNotPresent = function(elem, timeout, interval) {</span>
<a href="#l72.673"></a><span id="l72.673">   this.waitFor(function() {</span>
<a href="#l72.674"></a><span id="l72.674">     return !elem.exists();</span>
<a href="#l72.675"></a><span id="l72.675">   }, &quot;Timeout exceeded for waitForElementNotPresent &quot; + elem.getInfo(), timeout, interval);</span>
<a href="#l72.676"></a><span id="l72.676"> </span>
<a href="#l72.677"></a><span id="l72.677" class="difflineminus">-  frame.events.pass({'function':'Controller.waitForElementNotPresent()'});</span>
<a href="#l72.678"></a><span id="l72.678" class="difflineminus">-}</span>
<a href="#l72.679"></a><span id="l72.679" class="difflineplus">+  frame.events.pass({&quot;function&quot;: &quot;Controller.waitForElementNotPresent()&quot;});</span>
<a href="#l72.680"></a><span id="l72.680" class="difflineplus">+};</span>
<a href="#l72.681"></a><span id="l72.681"> </span>
<a href="#l72.682"></a><span id="l72.682"> MozMillController.prototype.__defineGetter__(&quot;waitForEvents&quot;, function() {</span>
<a href="#l72.683"></a><span id="l72.683">   if (this._waitForEvents == undefined)</span>
<a href="#l72.684"></a><span id="l72.684">     this._waitForEvents = new waitForEvents();</span>
<a href="#l72.685"></a><span id="l72.685">   return this._waitForEvents;</span>
<a href="#l72.686"></a><span id="l72.686"> });</span>
<a href="#l72.687"></a><span id="l72.687"> </span>
<a href="#l72.688"></a><span id="l72.688"> /**</span>
<a href="#l72.689"></a><span id="l72.689">  * Wrapper function to create a new instance of a menu</span>
<a href="#l72.690"></a><span id="l72.690">  * @see Menu</span>
<a href="#l72.691"></a><span id="l72.691">  */</span>
<a href="#l72.692"></a><span id="l72.692" class="difflineminus">-MozMillController.prototype.getMenu = function (menuSelector, document) {</span>
<a href="#l72.693"></a><span id="l72.693" class="difflineplus">+MozMillController.prototype.getMenu = function(menuSelector, document) {</span>
<a href="#l72.694"></a><span id="l72.694">   return new Menu(this, menuSelector, document);</span>
<a href="#l72.695"></a><span id="l72.695"> };</span>
<a href="#l72.696"></a><span id="l72.696"> </span>
<a href="#l72.697"></a><span id="l72.697"> MozMillController.prototype.__defineGetter__(&quot;mainMenu&quot;, function() {</span>
<a href="#l72.698"></a><span id="l72.698">   return this.getMenu(&quot;menubar&quot;);</span>
<a href="#l72.699"></a><span id="l72.699"> });</span>
<a href="#l72.700"></a><span id="l72.700"> </span>
<a href="#l72.701"></a><span id="l72.701"> MozMillController.prototype.__defineGetter__(&quot;menus&quot;, function() {</span>
<a href="#l72.702"></a><span id="l72.702" class="difflineminus">-  frame.log({'property': 'controller.menus - DEPRECATED',</span>
<a href="#l72.703"></a><span id="l72.703" class="difflineminus">-             'message': 'Use controller.mainMenu instead.'});</span>
<a href="#l72.704"></a><span id="l72.704" class="difflineplus">+  frame.log({</span>
<a href="#l72.705"></a><span id="l72.705" class="difflineplus">+    &quot;property&quot;: &quot;controller.menus - DEPRECATED&quot;,</span>
<a href="#l72.706"></a><span id="l72.706" class="difflineplus">+    &quot;message&quot;: &quot;Use controller.mainMenu instead.&quot;,</span>
<a href="#l72.707"></a><span id="l72.707" class="difflineplus">+  });</span>
<a href="#l72.708"></a><span id="l72.708"> </span>
<a href="#l72.709"></a><span id="l72.709">   var menubar = this.window.document.querySelector(&quot;menubar&quot;);</span>
<a href="#l72.710"></a><span id="l72.710">   return new MenuTree(this.window, menubar);</span>
<a href="#l72.711"></a><span id="l72.711"> });</span>
<a href="#l72.712"></a><span id="l72.712"> </span>
<a href="#l72.713"></a><span id="l72.713" class="difflineminus">-MozMillController.prototype.waitForImage = function (elem, timeout, interval) {</span>
<a href="#l72.714"></a><span id="l72.714" class="difflineplus">+MozMillController.prototype.waitForImage = function(elem, timeout, interval) {</span>
<a href="#l72.715"></a><span id="l72.715">   this.waitFor(function() {</span>
<a href="#l72.716"></a><span id="l72.716" class="difflineminus">-    return elem.getNode().complete == true;</span>
<a href="#l72.717"></a><span id="l72.717" class="difflineplus">+    return elem.getNode().complete;</span>
<a href="#l72.718"></a><span id="l72.718">   }, &quot;timeout exceeded for waitForImage &quot; + elem.getInfo(), timeout, interval);</span>
<a href="#l72.719"></a><span id="l72.719"> </span>
<a href="#l72.720"></a><span id="l72.720" class="difflineminus">-  frame.events.pass({'function':'Controller.waitForImage()'});</span>
<a href="#l72.721"></a><span id="l72.721" class="difflineminus">-}</span>
<a href="#l72.722"></a><span id="l72.722" class="difflineplus">+  frame.events.pass({&quot;function&quot;: &quot;Controller.waitForImage()&quot;});</span>
<a href="#l72.723"></a><span id="l72.723" class="difflineplus">+};</span>
<a href="#l72.724"></a><span id="l72.724"> </span>
<a href="#l72.725"></a><span id="l72.725" class="difflineminus">-MozMillController.prototype.waitThenClick = function (elem, timeout, interval) {</span>
<a href="#l72.726"></a><span id="l72.726" class="difflineplus">+MozMillController.prototype.waitThenClick = function(elem, timeout, interval) {</span>
<a href="#l72.727"></a><span id="l72.727">   this.waitForElement(elem, timeout, interval);</span>
<a href="#l72.728"></a><span id="l72.728">   this.click(elem);</span>
<a href="#l72.729"></a><span id="l72.729" class="difflineminus">-}</span>
<a href="#l72.730"></a><span id="l72.730" class="difflineplus">+};</span>
<a href="#l72.731"></a><span id="l72.731"> </span>
<a href="#l72.732"></a><span id="l72.732" class="difflineminus">-MozMillController.prototype.fireEvent = function (name, obj) {</span>
<a href="#l72.733"></a><span id="l72.733" class="difflineplus">+MozMillController.prototype.fireEvent = function(name, obj) {</span>
<a href="#l72.734"></a><span id="l72.734">   if (name == &quot;userShutdown&quot;) {</span>
<a href="#l72.735"></a><span id="l72.735">     frame.events.toggleUserShutdown();</span>
<a href="#l72.736"></a><span id="l72.736">   }</span>
<a href="#l72.737"></a><span id="l72.737">   frame.events.fireEvent(name, obj);</span>
<a href="#l72.738"></a><span id="l72.738" class="difflineminus">-}</span>
<a href="#l72.739"></a><span id="l72.739" class="difflineplus">+};</span>
<a href="#l72.740"></a><span id="l72.740"> </span>
<a href="#l72.741"></a><span id="l72.741" class="difflineminus">-MozMillController.prototype.startUserShutdown = function (timeout, restart) {</span>
<a href="#l72.742"></a><span id="l72.742" class="difflineplus">+MozMillController.prototype.startUserShutdown = function(timeout, restart) {</span>
<a href="#l72.743"></a><span id="l72.743">   // 0 = default shutdown, 1 = user shutdown, 2 = user restart</span>
<a href="#l72.744"></a><span id="l72.744" class="difflineminus">-  this.fireEvent('userShutdown', restart ? 2 : 1);</span>
<a href="#l72.745"></a><span id="l72.745" class="difflineminus">-  this.window.setTimeout(this.fireEvent, timeout, 'userShutdown', 0);</span>
<a href="#l72.746"></a><span id="l72.746" class="difflineminus">-}</span>
<a href="#l72.747"></a><span id="l72.747" class="difflineplus">+  this.fireEvent(&quot;userShutdown&quot;, restart ? 2 : 1);</span>
<a href="#l72.748"></a><span id="l72.748" class="difflineplus">+  this.window.setTimeout(this.fireEvent, timeout, &quot;userShutdown&quot;, 0);</span>
<a href="#l72.749"></a><span id="l72.749" class="difflineplus">+};</span>
<a href="#l72.750"></a><span id="l72.750"> </span>
<a href="#l72.751"></a><span id="l72.751"> /* Select the specified option and trigger the relevant events of the element.*/</span>
<a href="#l72.752"></a><span id="l72.752" class="difflineminus">-MozMillController.prototype.select = function (el, indx, option, value) {</span>
<a href="#l72.753"></a><span id="l72.753" class="difflineplus">+MozMillController.prototype.select = function(el, indx, option, value) {</span>
<a href="#l72.754"></a><span id="l72.754">   var element = el.getNode();</span>
<a href="#l72.755"></a><span id="l72.755" class="difflineminus">-  if (!element){</span>
<a href="#l72.756"></a><span id="l72.756" class="difflineplus">+  if (!element) {</span>
<a href="#l72.757"></a><span id="l72.757">     throw new Error(&quot;Could not find element &quot; + el.getInfo());</span>
<a href="#l72.758"></a><span id="l72.758" class="difflineminus">-    return false;</span>
<a href="#l72.759"></a><span id="l72.759">   }</span>
<a href="#l72.760"></a><span id="l72.760"> </span>
<a href="#l72.761"></a><span id="l72.761" class="difflineminus">-  //if we have a select drop down</span>
<a href="#l72.762"></a><span id="l72.762" class="difflineminus">-  if (element.localName.toLowerCase() == &quot;select&quot;){</span>
<a href="#l72.763"></a><span id="l72.763" class="difflineminus">-    var item = null;</span>
<a href="#l72.764"></a><span id="l72.764" class="difflineplus">+  // if we have a select drop down</span>
<a href="#l72.765"></a><span id="l72.765" class="difflineplus">+  if (element.localName.toLowerCase() == &quot;select&quot;) {</span>
<a href="#l72.766"></a><span id="l72.766" class="difflineplus">+    let item = null;</span>
<a href="#l72.767"></a><span id="l72.767"> </span>
<a href="#l72.768"></a><span id="l72.768">     // The selected item should be set via its index</span>
<a href="#l72.769"></a><span id="l72.769">     if (indx != undefined) {</span>
<a href="#l72.770"></a><span id="l72.770">       // Resetting a menulist has to be handled separately</span>
<a href="#l72.771"></a><span id="l72.771">       if (indx == -1) {</span>
<a href="#l72.772"></a><span id="l72.772" class="difflineminus">-        events.triggerEvent(element, 'focus', false);</span>
<a href="#l72.773"></a><span id="l72.773" class="difflineplus">+        events.triggerEvent(element, &quot;focus&quot;, false);</span>
<a href="#l72.774"></a><span id="l72.774">         element.selectedIndex = indx;</span>
<a href="#l72.775"></a><span id="l72.775" class="difflineminus">-        events.triggerEvent(element, 'change', true);</span>
<a href="#l72.776"></a><span id="l72.776" class="difflineplus">+        events.triggerEvent(element, &quot;change&quot;, true);</span>
<a href="#l72.777"></a><span id="l72.777"> </span>
<a href="#l72.778"></a><span id="l72.778" class="difflineminus">-     frame.events.pass({'function':'Controller.select()'});</span>
<a href="#l72.779"></a><span id="l72.779" class="difflineminus">-     return true;</span>
<a href="#l72.780"></a><span id="l72.780" class="difflineminus">-      } else {</span>
<a href="#l72.781"></a><span id="l72.781" class="difflineminus">-        item = element.options.item(indx);</span>
<a href="#l72.782"></a><span id="l72.782" class="difflineminus">-    }</span>
<a href="#l72.783"></a><span id="l72.783" class="difflineplus">+        frame.events.pass({&quot;function&quot;: &quot;Controller.select()&quot;});</span>
<a href="#l72.784"></a><span id="l72.784" class="difflineplus">+        return true;</span>
<a href="#l72.785"></a><span id="l72.785" class="difflineplus">+      }</span>
<a href="#l72.786"></a><span id="l72.786" class="difflineplus">+      item = element.options.item(indx);</span>
<a href="#l72.787"></a><span id="l72.787">     } else {</span>
<a href="#l72.788"></a><span id="l72.788" class="difflineminus">-      for (var i = 0; i &lt; element.options.length; i++) {</span>
<a href="#l72.789"></a><span id="l72.789" class="difflineminus">-        var entry = element.options.item(i);</span>
<a href="#l72.790"></a><span id="l72.790" class="difflineplus">+      for (let i = 0; i &lt; element.options.length; i++) {</span>
<a href="#l72.791"></a><span id="l72.791" class="difflineplus">+        let entry = element.options.item(i);</span>
<a href="#l72.792"></a><span id="l72.792">         if (option != undefined &amp;&amp; entry.innerHTML == option ||</span>
<a href="#l72.793"></a><span id="l72.793">             value != undefined &amp;&amp; entry.value == value) {</span>
<a href="#l72.794"></a><span id="l72.794">           item = entry;</span>
<a href="#l72.795"></a><span id="l72.795" class="difflineminus">-         break;</span>
<a href="#l72.796"></a><span id="l72.796" class="difflineminus">-       }</span>
<a href="#l72.797"></a><span id="l72.797" class="difflineminus">-     }</span>
<a href="#l72.798"></a><span id="l72.798" class="difflineminus">-           }</span>
<a href="#l72.799"></a><span id="l72.799" class="difflineplus">+          break;</span>
<a href="#l72.800"></a><span id="l72.800" class="difflineplus">+        }</span>
<a href="#l72.801"></a><span id="l72.801" class="difflineplus">+      }</span>
<a href="#l72.802"></a><span id="l72.802" class="difflineplus">+    }</span>
<a href="#l72.803"></a><span id="l72.803"> </span>
<a href="#l72.804"></a><span id="l72.804">     // Click the item</span>
<a href="#l72.805"></a><span id="l72.805">     try {</span>
<a href="#l72.806"></a><span id="l72.806">       // EventUtils.synthesizeMouse doesn't work.</span>
<a href="#l72.807"></a><span id="l72.807" class="difflineminus">-      events.triggerEvent(element, 'focus', false);</span>
<a href="#l72.808"></a><span id="l72.808" class="difflineplus">+      events.triggerEvent(element, &quot;focus&quot;, false);</span>
<a href="#l72.809"></a><span id="l72.809">       item.selected = true;</span>
<a href="#l72.810"></a><span id="l72.810" class="difflineminus">-           events.triggerEvent(element, 'change', true);</span>
<a href="#l72.811"></a><span id="l72.811" class="difflineplus">+      events.triggerEvent(element, &quot;change&quot;, true);</span>
<a href="#l72.812"></a><span id="l72.812"> </span>
<a href="#l72.813"></a><span id="l72.813" class="difflineminus">-      frame.events.pass({'function':'Controller.select()'});</span>
<a href="#l72.814"></a><span id="l72.814" class="difflineplus">+      frame.events.pass({&quot;function&quot;: &quot;Controller.select()&quot;});</span>
<a href="#l72.815"></a><span id="l72.815">       return true;</span>
<a href="#l72.816"></a><span id="l72.816">     } catch (ex) {</span>
<a href="#l72.817"></a><span id="l72.817">       throw new Error(&quot;No item selected for element &quot; + el.getInfo());</span>
<a href="#l72.818"></a><span id="l72.818" class="difflineminus">-     return false;</span>
<a href="#l72.819"></a><span id="l72.819" class="difflineminus">-   }</span>
<a href="#l72.820"></a><span id="l72.820" class="difflineminus">-  }</span>
<a href="#l72.821"></a><span id="l72.821" class="difflineminus">-  //if we have a xul menulist select accordingly</span>
<a href="#l72.822"></a><span id="l72.822" class="difflineminus">-  else if (element.localName.toLowerCase() == &quot;menulist&quot;) {</span>
<a href="#l72.823"></a><span id="l72.823" class="difflineplus">+    }</span>
<a href="#l72.824"></a><span id="l72.824" class="difflineplus">+  } else if (element.localName.toLowerCase() == &quot;menulist&quot;) {</span>
<a href="#l72.825"></a><span id="l72.825" class="difflineplus">+    // if we have a xul menulist select accordingly</span>
<a href="#l72.826"></a><span id="l72.826">     var ownerDoc = element.ownerDocument;</span>
<a href="#l72.827"></a><span id="l72.827" class="difflineminus">-    // Unwrap the XUL element's XPCNativeWrapper</span>
<a href="#l72.828"></a><span id="l72.828" class="difflineminus">-    if (element.namespaceURI.toLowerCase() == &quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;) {</span>
<a href="#l72.829"></a><span id="l72.829" class="difflineminus">-      element = utils.unwrapNode(element);</span>
<a href="#l72.830"></a><span id="l72.830" class="difflineminus">-    }</span>
<a href="#l72.831"></a><span id="l72.831" class="difflineminus">-</span>
<a href="#l72.832"></a><span id="l72.832" class="difflineminus">-    var item = null;</span>
<a href="#l72.833"></a><span id="l72.833" class="difflineplus">+    let item = null;</span>
<a href="#l72.834"></a><span id="l72.834"> </span>
<a href="#l72.835"></a><span id="l72.835">     if (indx != undefined) {</span>
<a href="#l72.836"></a><span id="l72.836">       if (indx == -1) {</span>
<a href="#l72.837"></a><span id="l72.837" class="difflineminus">-        events.triggerEvent(element, 'focus', false);</span>
<a href="#l72.838"></a><span id="l72.838" class="difflineplus">+        events.triggerEvent(element, &quot;focus&quot;, false);</span>
<a href="#l72.839"></a><span id="l72.839">         element.selectedIndex = indx;</span>
<a href="#l72.840"></a><span id="l72.840" class="difflineminus">-        events.triggerEvent(element, 'change', true);</span>
<a href="#l72.841"></a><span id="l72.841" class="difflineplus">+        events.triggerEvent(element, &quot;change&quot;, true);</span>
<a href="#l72.842"></a><span id="l72.842"> </span>
<a href="#l72.843"></a><span id="l72.843" class="difflineminus">-        frame.events.pass({'function':'Controller.select()'});</span>
<a href="#l72.844"></a><span id="l72.844" class="difflineplus">+        frame.events.pass({&quot;function&quot;: &quot;Controller.select()&quot;});</span>
<a href="#l72.845"></a><span id="l72.845">         return true;</span>
<a href="#l72.846"></a><span id="l72.846" class="difflineminus">-      } else {</span>
<a href="#l72.847"></a><span id="l72.847" class="difflineminus">-        item = element.getItemAtIndex(indx);</span>
<a href="#l72.848"></a><span id="l72.848">       }</span>
<a href="#l72.849"></a><span id="l72.849" class="difflineplus">+      item = element.getItemAtIndex(indx);</span>
<a href="#l72.850"></a><span id="l72.850">     } else {</span>
<a href="#l72.851"></a><span id="l72.851" class="difflineminus">-      for (var i = 0; i &lt; element.itemCount; i++) {</span>
<a href="#l72.852"></a><span id="l72.852" class="difflineminus">-        var entry = element.getItemAtIndex(i);</span>
<a href="#l72.853"></a><span id="l72.853" class="difflineplus">+      for (let i = 0; i &lt; element.itemCount; i++) {</span>
<a href="#l72.854"></a><span id="l72.854" class="difflineplus">+        let entry = element.getItemAtIndex(i);</span>
<a href="#l72.855"></a><span id="l72.855">         if (option != undefined &amp;&amp; entry.label == option ||</span>
<a href="#l72.856"></a><span id="l72.856">             value != undefined &amp;&amp; entry.value == value) {</span>
<a href="#l72.857"></a><span id="l72.857">           item = entry;</span>
<a href="#l72.858"></a><span id="l72.858">           break;</span>
<a href="#l72.859"></a><span id="l72.859">         }</span>
<a href="#l72.860"></a><span id="l72.860">       }</span>
<a href="#l72.861"></a><span id="l72.861">     }</span>
<a href="#l72.862"></a><span id="l72.862"> </span>
<a href="#l72.863"></a><span id="l72.863">     // Click the item</span>
<a href="#l72.864"></a><span id="l72.864">     try {</span>
<a href="#l72.865"></a><span id="l72.865">       EventUtils.synthesizeMouse(element, 1, 1, {}, ownerDoc.defaultView);</span>
<a href="#l72.866"></a><span id="l72.866">       this.sleep(0);</span>
<a href="#l72.867"></a><span id="l72.867"> </span>
<a href="#l72.868"></a><span id="l72.868">       // Scroll down until item is visible</span>
<a href="#l72.869"></a><span id="l72.869" class="difflineminus">-      for (var i = s = element.selectedIndex; i &lt;= element.itemCount + s; ++i) {</span>
<a href="#l72.870"></a><span id="l72.870" class="difflineminus">-        var entry = element.getItemAtIndex((i + 1) % element.itemCount);</span>
<a href="#l72.871"></a><span id="l72.871" class="difflineplus">+      let i, s;</span>
<a href="#l72.872"></a><span id="l72.872" class="difflineplus">+      for (i = s = element.selectedIndex; i &lt;= element.itemCount + s; ++i) {</span>
<a href="#l72.873"></a><span id="l72.873" class="difflineplus">+        let entry = element.getItemAtIndex((i + 1) % element.itemCount);</span>
<a href="#l72.874"></a><span id="l72.874">         EventUtils.synthesizeKey(&quot;VK_DOWN&quot;, {}, ownerDoc.defaultView);</span>
<a href="#l72.875"></a><span id="l72.875">         if (entry.label == item.label) {</span>
<a href="#l72.876"></a><span id="l72.876">           break;</span>
<a href="#l72.877"></a><span id="l72.877" class="difflineplus">+        } else if (entry.label == &quot;&quot;) {</span>
<a href="#l72.878"></a><span id="l72.878" class="difflineplus">+          i += 1;</span>
<a href="#l72.879"></a><span id="l72.879">         }</span>
<a href="#l72.880"></a><span id="l72.880" class="difflineminus">-        else if (entry.label == &quot;&quot;) i += 1;</span>
<a href="#l72.881"></a><span id="l72.881">       }</span>
<a href="#l72.882"></a><span id="l72.882"> </span>
<a href="#l72.883"></a><span id="l72.883">       EventUtils.synthesizeMouse(item, 1, 1, {}, ownerDoc.defaultView);</span>
<a href="#l72.884"></a><span id="l72.884">       this.sleep(0);</span>
<a href="#l72.885"></a><span id="l72.885"> </span>
<a href="#l72.886"></a><span id="l72.886" class="difflineminus">-      frame.events.pass({'function':'Controller.select()'});</span>
<a href="#l72.887"></a><span id="l72.887" class="difflineplus">+      frame.events.pass({&quot;function&quot;: &quot;Controller.select()&quot;});</span>
<a href="#l72.888"></a><span id="l72.888">       return true;</span>
<a href="#l72.889"></a><span id="l72.889">     } catch (ex) {</span>
<a href="#l72.890"></a><span id="l72.890" class="difflineminus">-      throw new Error('No item selected for element ' + el.getInfo());</span>
<a href="#l72.891"></a><span id="l72.891" class="difflineminus">-      return false;</span>
<a href="#l72.892"></a><span id="l72.892" class="difflineplus">+      throw new Error(&quot;No item selected for element &quot; + el.getInfo());</span>
<a href="#l72.893"></a><span id="l72.893">     }</span>
<a href="#l72.894"></a><span id="l72.894">   }</span>
<a href="#l72.895"></a><span id="l72.895" class="difflineplus">+  return false;</span>
<a href="#l72.896"></a><span id="l72.896"> };</span>
<a href="#l72.897"></a><span id="l72.897"> </span>
<a href="#l72.898"></a><span id="l72.898" class="difflineminus">-//Browser navigation functions</span>
<a href="#l72.899"></a><span id="l72.899" class="difflineminus">-MozMillController.prototype.goBack = function(){</span>
<a href="#l72.900"></a><span id="l72.900" class="difflineminus">-  //this.window.focus();</span>
<a href="#l72.901"></a><span id="l72.901" class="difflineplus">+// Browser navigation functions</span>
<a href="#l72.902"></a><span id="l72.902" class="difflineplus">+MozMillController.prototype.goBack = function() {</span>
<a href="#l72.903"></a><span id="l72.903" class="difflineplus">+  // this.window.focus();</span>
<a href="#l72.904"></a><span id="l72.904">   this.window.content.history.back();</span>
<a href="#l72.905"></a><span id="l72.905" class="difflineminus">-  frame.events.pass({'function':'Controller.goBack()'});</span>
<a href="#l72.906"></a><span id="l72.906" class="difflineplus">+  frame.events.pass({&quot;function&quot;: &quot;Controller.goBack()&quot;});</span>
<a href="#l72.907"></a><span id="l72.907">   return true;</span>
<a href="#l72.908"></a><span id="l72.908" class="difflineminus">-}</span>
<a href="#l72.909"></a><span id="l72.909" class="difflineminus">-MozMillController.prototype.goForward = function(){</span>
<a href="#l72.910"></a><span id="l72.910" class="difflineminus">-  //this.window.focus();</span>
<a href="#l72.911"></a><span id="l72.911" class="difflineplus">+};</span>
<a href="#l72.912"></a><span id="l72.912" class="difflineplus">+MozMillController.prototype.goForward = function() {</span>
<a href="#l72.913"></a><span id="l72.913" class="difflineplus">+  // this.window.focus();</span>
<a href="#l72.914"></a><span id="l72.914">   this.window.content.history.forward();</span>
<a href="#l72.915"></a><span id="l72.915" class="difflineminus">-  frame.events.pass({'function':'Controller.goForward()'});</span>
<a href="#l72.916"></a><span id="l72.916" class="difflineplus">+  frame.events.pass({&quot;function&quot;: &quot;Controller.goForward()&quot;});</span>
<a href="#l72.917"></a><span id="l72.917">   return true;</span>
<a href="#l72.918"></a><span id="l72.918" class="difflineminus">-}</span>
<a href="#l72.919"></a><span id="l72.919" class="difflineminus">-MozMillController.prototype.refresh = function(){</span>
<a href="#l72.920"></a><span id="l72.920" class="difflineminus">-  //this.window.focus();</span>
<a href="#l72.921"></a><span id="l72.921" class="difflineplus">+};</span>
<a href="#l72.922"></a><span id="l72.922" class="difflineplus">+MozMillController.prototype.refresh = function() {</span>
<a href="#l72.923"></a><span id="l72.923" class="difflineplus">+  // this.window.focus();</span>
<a href="#l72.924"></a><span id="l72.924">   this.window.content.location.reload(true);</span>
<a href="#l72.925"></a><span id="l72.925" class="difflineminus">-  frame.events.pass({'function':'Controller.refresh()'});</span>
<a href="#l72.926"></a><span id="l72.926" class="difflineplus">+  frame.events.pass({&quot;function&quot;: &quot;Controller.refresh()&quot;});</span>
<a href="#l72.927"></a><span id="l72.927">   return true;</span>
<a href="#l72.928"></a><span id="l72.928" class="difflineminus">-}</span>
<a href="#l72.929"></a><span id="l72.929" class="difflineplus">+};</span>
<a href="#l72.930"></a><span id="l72.930"> </span>
<a href="#l72.931"></a><span id="l72.931" class="difflineminus">-MozMillController.prototype.assertText = function (el, text) {</span>
<a href="#l72.932"></a><span id="l72.932" class="difflineminus">-  //this.window.focus();</span>
<a href="#l72.933"></a><span id="l72.933" class="difflineplus">+MozMillController.prototype.assertText = function(el, text) {</span>
<a href="#l72.934"></a><span id="l72.934" class="difflineplus">+  // this.window.focus();</span>
<a href="#l72.935"></a><span id="l72.935">   var n = el.getNode();</span>
<a href="#l72.936"></a><span id="l72.936"> </span>
<a href="#l72.937"></a><span id="l72.937" class="difflineminus">-  if (n &amp;&amp; n.innerHTML == text){</span>
<a href="#l72.938"></a><span id="l72.938" class="difflineminus">-    frame.events.pass({'function':'Controller.assertText()'});</span>
<a href="#l72.939"></a><span id="l72.939" class="difflineplus">+  if (n &amp;&amp; n.innerHTML == text) {</span>
<a href="#l72.940"></a><span id="l72.940" class="difflineplus">+    frame.events.pass({&quot;function&quot;: &quot;Controller.assertText()&quot;});</span>
<a href="#l72.941"></a><span id="l72.941">     return true;</span>
<a href="#l72.942"></a><span id="l72.942" class="difflineminus">-   }</span>
<a href="#l72.943"></a><span id="l72.943" class="difflineplus">+  }</span>
<a href="#l72.944"></a><span id="l72.944"> </span>
<a href="#l72.945"></a><span id="l72.945" class="difflineminus">-  throw new Error(&quot;could not validate element &quot; + el.getInfo()+&quot; with text &quot;+ text);</span>
<a href="#l72.946"></a><span id="l72.946" class="difflineminus">-  return false;</span>
<a href="#l72.947"></a><span id="l72.947" class="difflineminus">-</span>
<a href="#l72.948"></a><span id="l72.948" class="difflineplus">+  throw new Error(&quot;could not validate element &quot; + el.getInfo() + &quot; with text &quot; + text);</span>
<a href="#l72.949"></a><span id="l72.949"> };</span>
<a href="#l72.950"></a><span id="l72.950"> </span>
<a href="#l72.951"></a><span id="l72.951" class="difflineminus">-//Assert that a specified node exists</span>
<a href="#l72.952"></a><span id="l72.952" class="difflineminus">-MozMillController.prototype.assertNode = function (el) {</span>
<a href="#l72.953"></a><span id="l72.953" class="difflineminus">-  //this.window.focus();</span>
<a href="#l72.954"></a><span id="l72.954" class="difflineplus">+// Assert that a specified node exists</span>
<a href="#l72.955"></a><span id="l72.955" class="difflineplus">+MozMillController.prototype.assertNode = function(el) {</span>
<a href="#l72.956"></a><span id="l72.956" class="difflineplus">+  // this.window.focus();</span>
<a href="#l72.957"></a><span id="l72.957">   var element = el.getNode();</span>
<a href="#l72.958"></a><span id="l72.958" class="difflineminus">-  if (!element){</span>
<a href="#l72.959"></a><span id="l72.959" class="difflineplus">+  if (!element) {</span>
<a href="#l72.960"></a><span id="l72.960">     throw new Error(&quot;could not find element &quot; + el.getInfo());</span>
<a href="#l72.961"></a><span id="l72.961" class="difflineminus">-    return false;</span>
<a href="#l72.962"></a><span id="l72.962">   }</span>
<a href="#l72.963"></a><span id="l72.963" class="difflineminus">-  frame.events.pass({'function':'Controller.assertNode()'});</span>
<a href="#l72.964"></a><span id="l72.964" class="difflineplus">+  frame.events.pass({&quot;function&quot;: &quot;Controller.assertNode()&quot;});</span>
<a href="#l72.965"></a><span id="l72.965">   return true;</span>
<a href="#l72.966"></a><span id="l72.966"> };</span>
<a href="#l72.967"></a><span id="l72.967"> </span>
<a href="#l72.968"></a><span id="l72.968"> // Assert that a specified node doesn't exist</span>
<a href="#l72.969"></a><span id="l72.969" class="difflineminus">-MozMillController.prototype.assertNodeNotExist = function (el) {</span>
<a href="#l72.970"></a><span id="l72.970" class="difflineminus">-  //this.window.focus();</span>
<a href="#l72.971"></a><span id="l72.971" class="difflineplus">+MozMillController.prototype.assertNodeNotExist = function(el) {</span>
<a href="#l72.972"></a><span id="l72.972" class="difflineplus">+  // this.window.focus();</span>
<a href="#l72.973"></a><span id="l72.973">   try {</span>
<a href="#l72.974"></a><span id="l72.974">     var element = el.getNode();</span>
<a href="#l72.975"></a><span id="l72.975" class="difflineminus">-  } catch(err){</span>
<a href="#l72.976"></a><span id="l72.976" class="difflineminus">-    frame.events.pass({'function':'Controller.assertNodeNotExist()'});</span>
<a href="#l72.977"></a><span id="l72.977" class="difflineplus">+  } catch (err) {</span>
<a href="#l72.978"></a><span id="l72.978" class="difflineplus">+    frame.events.pass({&quot;function&quot;: &quot;Controller.assertNodeNotExist()&quot;});</span>
<a href="#l72.979"></a><span id="l72.979">     return true;</span>
<a href="#l72.980"></a><span id="l72.980">   }</span>
<a href="#l72.981"></a><span id="l72.981"> </span>
<a href="#l72.982"></a><span id="l72.982">   if (element) {</span>
<a href="#l72.983"></a><span id="l72.983">     throw new Error(&quot;Unexpectedly found element &quot; + el.getInfo());</span>
<a href="#l72.984"></a><span id="l72.984" class="difflineminus">-    return false;</span>
<a href="#l72.985"></a><span id="l72.985" class="difflineminus">-  } else {</span>
<a href="#l72.986"></a><span id="l72.986" class="difflineminus">-    frame.events.pass({'function':'Controller.assertNodeNotExist()'});</span>
<a href="#l72.987"></a><span id="l72.987" class="difflineminus">-    return true;</span>
<a href="#l72.988"></a><span id="l72.988">   }</span>
<a href="#l72.989"></a><span id="l72.989" class="difflineplus">+  frame.events.pass({&quot;function&quot;: &quot;Controller.assertNodeNotExist()&quot;});</span>
<a href="#l72.990"></a><span id="l72.990" class="difflineplus">+  return true;</span>
<a href="#l72.991"></a><span id="l72.991"> };</span>
<a href="#l72.992"></a><span id="l72.992"> </span>
<a href="#l72.993"></a><span id="l72.993" class="difflineminus">-//Assert that a form element contains the expected value</span>
<a href="#l72.994"></a><span id="l72.994" class="difflineminus">-MozMillController.prototype.assertValue = function (el, value) {</span>
<a href="#l72.995"></a><span id="l72.995" class="difflineminus">-  //this.window.focus();</span>
<a href="#l72.996"></a><span id="l72.996" class="difflineplus">+// Assert that a form element contains the expected value</span>
<a href="#l72.997"></a><span id="l72.997" class="difflineplus">+MozMillController.prototype.assertValue = function(el, value) {</span>
<a href="#l72.998"></a><span id="l72.998" class="difflineplus">+  // this.window.focus();</span>
<a href="#l72.999"></a><span id="l72.999">   var n = el.getNode();</span>
<a href="#l72.1000"></a><span id="l72.1000"> </span>
<a href="#l72.1001"></a><span id="l72.1001" class="difflineminus">-  if (n &amp;&amp; n.value == value){</span>
<a href="#l72.1002"></a><span id="l72.1002" class="difflineminus">-    frame.events.pass({'function':'Controller.assertValue()'});</span>
<a href="#l72.1003"></a><span id="l72.1003" class="difflineplus">+  if (n &amp;&amp; n.value == value) {</span>
<a href="#l72.1004"></a><span id="l72.1004" class="difflineplus">+    frame.events.pass({&quot;function&quot;: &quot;Controller.assertValue()&quot;});</span>
<a href="#l72.1005"></a><span id="l72.1005">     return true;</span>
<a href="#l72.1006"></a><span id="l72.1006">   }</span>
<a href="#l72.1007"></a><span id="l72.1007" class="difflineminus">-  throw new Error(&quot;could not validate element &quot; + el.getInfo()+&quot; with value &quot;+ value);</span>
<a href="#l72.1008"></a><span id="l72.1008" class="difflineminus">-  return false;</span>
<a href="#l72.1009"></a><span id="l72.1009" class="difflineplus">+  throw new Error(&quot;could not validate element &quot; + el.getInfo() + &quot; with value &quot; + value);</span>
<a href="#l72.1010"></a><span id="l72.1010"> };</span>
<a href="#l72.1011"></a><span id="l72.1011"> </span>
<a href="#l72.1012"></a><span id="l72.1012"> /**</span>
<a href="#l72.1013"></a><span id="l72.1013">  * Check if the callback function evaluates to true</span>
<a href="#l72.1014"></a><span id="l72.1014">  */</span>
<a href="#l72.1015"></a><span id="l72.1015" class="difflineminus">-MozMillController.prototype.assert = function(callback, message, thisObject)</span>
<a href="#l72.1016"></a><span id="l72.1016" class="difflineminus">-{</span>
<a href="#l72.1017"></a><span id="l72.1017" class="difflineplus">+MozMillController.prototype.assert = function(callback, message, thisObject) {</span>
<a href="#l72.1018"></a><span id="l72.1018">   utils.assert(callback, message, thisObject);</span>
<a href="#l72.1019"></a><span id="l72.1019"> </span>
<a href="#l72.1020"></a><span id="l72.1020" class="difflineminus">-  frame.events.pass({'function': &quot;: controller.assert('&quot; + callback + &quot;')&quot;});</span>
<a href="#l72.1021"></a><span id="l72.1021" class="difflineplus">+  frame.events.pass({&quot;function&quot;: &quot;: controller.assert('&quot; + callback + &quot;')&quot;});</span>
<a href="#l72.1022"></a><span id="l72.1022">   return true;</span>
<a href="#l72.1023"></a><span id="l72.1023" class="difflineminus">-}</span>
<a href="#l72.1024"></a><span id="l72.1024" class="difflineplus">+};</span>
<a href="#l72.1025"></a><span id="l72.1025"> </span>
<a href="#l72.1026"></a><span id="l72.1026"> // Assert that the result of a Javascript expression is true</span>
<a href="#l72.1027"></a><span id="l72.1027"> MozMillController.prototype.assertJS = function(expression, subject) {</span>
<a href="#l72.1028"></a><span id="l72.1028">   assert(function() {</span>
<a href="#l72.1029"></a><span id="l72.1029" class="difflineminus">-    return eval(expression)</span>
<a href="#l72.1030"></a><span id="l72.1030" class="difflineplus">+    return eval(expression); // eslint-disable-line no-eval</span>
<a href="#l72.1031"></a><span id="l72.1031">   }, &quot;controller.assertJS: Failed for '&quot; + expression + &quot;'&quot;);</span>
<a href="#l72.1032"></a><span id="l72.1032"> </span>
<a href="#l72.1033"></a><span id="l72.1033" class="difflineminus">-  frame.events.pass({'function': &quot;controller.assertJS('&quot; + expression + &quot;')&quot;});</span>
<a href="#l72.1034"></a><span id="l72.1034" class="difflineplus">+  frame.events.pass({&quot;function&quot;: &quot;controller.assertJS('&quot; + expression + &quot;')&quot;});</span>
<a href="#l72.1035"></a><span id="l72.1035">   return true;</span>
<a href="#l72.1036"></a><span id="l72.1036" class="difflineminus">-}</span>
<a href="#l72.1037"></a><span id="l72.1037" class="difflineplus">+};</span>
<a href="#l72.1038"></a><span id="l72.1038"> </span>
<a href="#l72.1039"></a><span id="l72.1039" class="difflineminus">-//Assert that a provided value is selected in a select element</span>
<a href="#l72.1040"></a><span id="l72.1040" class="difflineminus">-MozMillController.prototype.assertSelected = function (el, value) {</span>
<a href="#l72.1041"></a><span id="l72.1041" class="difflineminus">-  //this.window.focus();</span>
<a href="#l72.1042"></a><span id="l72.1042" class="difflineplus">+// Assert that a provided value is selected in a select element</span>
<a href="#l72.1043"></a><span id="l72.1043" class="difflineplus">+MozMillController.prototype.assertSelected = function(el, value) {</span>
<a href="#l72.1044"></a><span id="l72.1044" class="difflineplus">+  // this.window.focus();</span>
<a href="#l72.1045"></a><span id="l72.1045">   var n = el.getNode();</span>
<a href="#l72.1046"></a><span id="l72.1046">   var validator = value;</span>
<a href="#l72.1047"></a><span id="l72.1047"> </span>
<a href="#l72.1048"></a><span id="l72.1048" class="difflineminus">-  if (n &amp;&amp; n.options[n.selectedIndex].value == validator){</span>
<a href="#l72.1049"></a><span id="l72.1049" class="difflineminus">-    frame.events.pass({'function':'Controller.assertSelected()'});</span>
<a href="#l72.1050"></a><span id="l72.1050" class="difflineplus">+  if (n &amp;&amp; n.options[n.selectedIndex].value == validator) {</span>
<a href="#l72.1051"></a><span id="l72.1051" class="difflineplus">+    frame.events.pass({&quot;function&quot;: &quot;Controller.assertSelected()&quot;});</span>
<a href="#l72.1052"></a><span id="l72.1052">     return true;</span>
<a href="#l72.1053"></a><span id="l72.1053" class="difflineminus">-    }</span>
<a href="#l72.1054"></a><span id="l72.1054" class="difflineminus">-  throw new Error(&quot;could not assert value for element &quot; + el.getInfo()+&quot; with value &quot;+ value);</span>
<a href="#l72.1055"></a><span id="l72.1055" class="difflineminus">-  return false;</span>
<a href="#l72.1056"></a><span id="l72.1056" class="difflineplus">+  }</span>
<a href="#l72.1057"></a><span id="l72.1057" class="difflineplus">+  throw new Error(&quot;could not assert value for element &quot; + el.getInfo() + &quot; with value &quot; + value);</span>
<a href="#l72.1058"></a><span id="l72.1058"> };</span>
<a href="#l72.1059"></a><span id="l72.1059"> </span>
<a href="#l72.1060"></a><span id="l72.1060" class="difflineminus">-//Assert that a provided checkbox is checked</span>
<a href="#l72.1061"></a><span id="l72.1061" class="difflineminus">-MozMillController.prototype.assertChecked = function (el) {</span>
<a href="#l72.1062"></a><span id="l72.1062" class="difflineminus">-  //this.window.focus();</span>
<a href="#l72.1063"></a><span id="l72.1063" class="difflineplus">+// Assert that a provided checkbox is checked</span>
<a href="#l72.1064"></a><span id="l72.1064" class="difflineplus">+MozMillController.prototype.assertChecked = function(el) {</span>
<a href="#l72.1065"></a><span id="l72.1065" class="difflineplus">+  // this.window.focus();</span>
<a href="#l72.1066"></a><span id="l72.1066">   var element = el.getNode();</span>
<a href="#l72.1067"></a><span id="l72.1067"> </span>
<a href="#l72.1068"></a><span id="l72.1068" class="difflineminus">-  if (element &amp;&amp; element.checked == true){</span>
<a href="#l72.1069"></a><span id="l72.1069" class="difflineminus">-    frame.events.pass({'function':'Controller.assertChecked()'});</span>
<a href="#l72.1070"></a><span id="l72.1070" class="difflineplus">+  if (element &amp;&amp; element.checked) {</span>
<a href="#l72.1071"></a><span id="l72.1071" class="difflineplus">+    frame.events.pass({&quot;function&quot;: &quot;Controller.assertChecked()&quot;});</span>
<a href="#l72.1072"></a><span id="l72.1072">     return true;</span>
<a href="#l72.1073"></a><span id="l72.1073" class="difflineminus">-    }</span>
<a href="#l72.1074"></a><span id="l72.1074" class="difflineplus">+  }</span>
<a href="#l72.1075"></a><span id="l72.1075">   throw new Error(&quot;assert failed for checked element &quot; + el.getInfo());</span>
<a href="#l72.1076"></a><span id="l72.1076" class="difflineminus">-  return false;</span>
<a href="#l72.1077"></a><span id="l72.1077"> };</span>
<a href="#l72.1078"></a><span id="l72.1078"> </span>
<a href="#l72.1079"></a><span id="l72.1079"> // Assert that a provided checkbox is not checked</span>
<a href="#l72.1080"></a><span id="l72.1080" class="difflineminus">-MozMillController.prototype.assertNotChecked = function (el) {</span>
<a href="#l72.1081"></a><span id="l72.1081" class="difflineplus">+MozMillController.prototype.assertNotChecked = function(el) {</span>
<a href="#l72.1082"></a><span id="l72.1082">   var element = el.getNode();</span>
<a href="#l72.1083"></a><span id="l72.1083"> </span>
<a href="#l72.1084"></a><span id="l72.1084">   if (!element) {</span>
<a href="#l72.1085"></a><span id="l72.1085">     throw new Error(&quot;Could not find element&quot; + el.getInfo());</span>
<a href="#l72.1086"></a><span id="l72.1086">   }</span>
<a href="#l72.1087"></a><span id="l72.1087"> </span>
<a href="#l72.1088"></a><span id="l72.1088" class="difflineminus">-  if (!element.hasAttribute(&quot;checked&quot;) || element.checked != true){</span>
<a href="#l72.1089"></a><span id="l72.1089" class="difflineminus">-    frame.events.pass({'function':'Controller.assertNotChecked()'});</span>
<a href="#l72.1090"></a><span id="l72.1090" class="difflineplus">+  if (!element.hasAttribute(&quot;checked&quot;) || !element.checked) {</span>
<a href="#l72.1091"></a><span id="l72.1091" class="difflineplus">+    frame.events.pass({&quot;function&quot;: &quot;Controller.assertNotChecked()&quot;});</span>
<a href="#l72.1092"></a><span id="l72.1092">     return true;</span>
<a href="#l72.1093"></a><span id="l72.1093" class="difflineminus">-    }</span>
<a href="#l72.1094"></a><span id="l72.1094" class="difflineplus">+  }</span>
<a href="#l72.1095"></a><span id="l72.1095">   throw new Error(&quot;assert failed for not checked element &quot; + el.getInfo());</span>
<a href="#l72.1096"></a><span id="l72.1096" class="difflineminus">-  return false;</span>
<a href="#l72.1097"></a><span id="l72.1097"> };</span>
<a href="#l72.1098"></a><span id="l72.1098"> </span>
<a href="#l72.1099"></a><span id="l72.1099"> /**</span>
<a href="#l72.1100"></a><span id="l72.1100">  * Assert that an element's javascript property exists or has a particular value</span>
<a href="#l72.1101"></a><span id="l72.1101">  *</span>
<a href="#l72.1102"></a><span id="l72.1102">  * if val is undefined, will return true if the property exists.</span>
<a href="#l72.1103"></a><span id="l72.1103">  * if val is specified, will return true if the property exists and has the correct value</span>
<a href="#l72.1104"></a><span id="l72.1104">  */</span>
<a href="#l72.1105"></a><span id="l72.1105"> MozMillController.prototype.assertJSProperty = function(el, attrib, val) {</span>
<a href="#l72.1106"></a><span id="l72.1106">   var element = el.getNode();</span>
<a href="#l72.1107"></a><span id="l72.1107" class="difflineminus">-  if (!element){</span>
<a href="#l72.1108"></a><span id="l72.1108" class="difflineplus">+  if (!element) {</span>
<a href="#l72.1109"></a><span id="l72.1109">     throw new Error(&quot;could not find element &quot; + el.getInfo());</span>
<a href="#l72.1110"></a><span id="l72.1110" class="difflineminus">-    return false;</span>
<a href="#l72.1111"></a><span id="l72.1111">   }</span>
<a href="#l72.1112"></a><span id="l72.1112">   var value = element[attrib];</span>
<a href="#l72.1113"></a><span id="l72.1113">   var res = (value !== undefined &amp;&amp; (val === undefined ? true : String(value) == String(val)));</span>
<a href="#l72.1114"></a><span id="l72.1114">   if (res) {</span>
<a href="#l72.1115"></a><span id="l72.1115" class="difflineminus">-    frame.events.pass({'function':'Controller.assertJSProperty(&quot;' + el.getInfo() + '&quot;) : ' + val});</span>
<a href="#l72.1116"></a><span id="l72.1116" class="difflineplus">+    frame.events.pass({&quot;function&quot;: 'Controller.assertJSProperty(&quot;' + el.getInfo() + '&quot;) : ' + val});</span>
<a href="#l72.1117"></a><span id="l72.1117">   } else {</span>
<a href="#l72.1118"></a><span id="l72.1118">     throw new Error(&quot;Controller.assertJSProperty(&quot; + el.getInfo() + &quot;) : &quot; +</span>
<a href="#l72.1119"></a><span id="l72.1119">                      (val === undefined ? &quot;property '&quot; + attrib + &quot;' doesn't exist&quot; : val + &quot; == &quot; + value));</span>
<a href="#l72.1120"></a><span id="l72.1120">   }</span>
<a href="#l72.1121"></a><span id="l72.1121">   return res;</span>
<a href="#l72.1122"></a><span id="l72.1122"> };</span>
<a href="#l72.1123"></a><span id="l72.1123"> </span>
<a href="#l72.1124"></a><span id="l72.1124"> /**</span>
<a href="#l72.1125"></a><span id="l72.1125">  * Assert that an element's javascript property doesn't exist or doesn't have a particular value</span>
<a href="#l72.1126"></a><span id="l72.1126">  *</span>
<a href="#l72.1127"></a><span id="l72.1127">  * if val is undefined, will return true if the property doesn't exist.</span>
<a href="#l72.1128"></a><span id="l72.1128">  * if val is specified, will return true if the property doesn't exist or doesn't have the specified value</span>
<a href="#l72.1129"></a><span id="l72.1129">  */</span>
<a href="#l72.1130"></a><span id="l72.1130"> MozMillController.prototype.assertNotJSProperty = function(el, attrib, val) {</span>
<a href="#l72.1131"></a><span id="l72.1131">   var element = el.getNode();</span>
<a href="#l72.1132"></a><span id="l72.1132" class="difflineminus">-  if (!element){</span>
<a href="#l72.1133"></a><span id="l72.1133" class="difflineplus">+  if (!element) {</span>
<a href="#l72.1134"></a><span id="l72.1134">     throw new Error(&quot;could not find element &quot; + el.getInfo());</span>
<a href="#l72.1135"></a><span id="l72.1135" class="difflineminus">-    return false;</span>
<a href="#l72.1136"></a><span id="l72.1136">   }</span>
<a href="#l72.1137"></a><span id="l72.1137">   var value = element[attrib];</span>
<a href="#l72.1138"></a><span id="l72.1138">   var res = (val === undefined ? value === undefined : String(value) != String(val));</span>
<a href="#l72.1139"></a><span id="l72.1139">   if (res) {</span>
<a href="#l72.1140"></a><span id="l72.1140" class="difflineminus">-    frame.events.pass({'function':'Controller.assertNotProperty(&quot;' + el.getInfo() + '&quot;) : ' + val});</span>
<a href="#l72.1141"></a><span id="l72.1141" class="difflineplus">+    frame.events.pass({&quot;function&quot;: 'Controller.assertNotProperty(&quot;' + el.getInfo() + '&quot;) : ' + val});</span>
<a href="#l72.1142"></a><span id="l72.1142">   } else {</span>
<a href="#l72.1143"></a><span id="l72.1143">     throw new Error(&quot;Controller.assertNotJSProperty(&quot; + el.getInfo() + &quot;) : &quot; +</span>
<a href="#l72.1144"></a><span id="l72.1144">                      (val === undefined ? &quot;property '&quot; + attrib + &quot;' exists&quot; : val + &quot; != &quot; + value));</span>
<a href="#l72.1145"></a><span id="l72.1145">   }</span>
<a href="#l72.1146"></a><span id="l72.1146">   return res;</span>
<a href="#l72.1147"></a><span id="l72.1147"> };</span>
<a href="#l72.1148"></a><span id="l72.1148"> </span>
<a href="#l72.1149"></a><span id="l72.1149"> /**</span>
<a href="#l72.1150"></a><span id="l72.1150">  * Assert that an element's dom property exists or has a particular value</span>
<a href="#l72.1151"></a><span id="l72.1151">  *</span>
<a href="#l72.1152"></a><span id="l72.1152">  * if val is undefined, will return true if the property exists.</span>
<a href="#l72.1153"></a><span id="l72.1153">  * if val is specified, will return true if the property exists and has the correct value</span>
<a href="#l72.1154"></a><span id="l72.1154">  */</span>
<a href="#l72.1155"></a><span id="l72.1155"> MozMillController.prototype.assertDOMProperty = function(el, attrib, val) {</span>
<a href="#l72.1156"></a><span id="l72.1156">   var element = el.getNode();</span>
<a href="#l72.1157"></a><span id="l72.1157" class="difflineminus">-  if (!element){</span>
<a href="#l72.1158"></a><span id="l72.1158" class="difflineplus">+  if (!element) {</span>
<a href="#l72.1159"></a><span id="l72.1159">     throw new Error(&quot;could not find element &quot; + el.getInfo());</span>
<a href="#l72.1160"></a><span id="l72.1160" class="difflineminus">-    return false;</span>
<a href="#l72.1161"></a><span id="l72.1161">   }</span>
<a href="#l72.1162"></a><span id="l72.1162">   var value, res = element.hasAttribute(attrib);</span>
<a href="#l72.1163"></a><span id="l72.1163">   if (res &amp;&amp; val !== undefined) {</span>
<a href="#l72.1164"></a><span id="l72.1164">     value = element.getAttribute(attrib);</span>
<a href="#l72.1165"></a><span id="l72.1165">     res = (String(value) == String(val));</span>
<a href="#l72.1166"></a><span id="l72.1166">   }</span>
<a href="#l72.1167"></a><span id="l72.1167"> </span>
<a href="#l72.1168"></a><span id="l72.1168">   if (res) {</span>
<a href="#l72.1169"></a><span id="l72.1169" class="difflineminus">-    frame.events.pass({'function':'Controller.assertDOMProperty(&quot;' + el.getInfo() + '&quot;) : ' + val});</span>
<a href="#l72.1170"></a><span id="l72.1170" class="difflineplus">+    frame.events.pass({&quot;function&quot;: 'Controller.assertDOMProperty(&quot;' + el.getInfo() + '&quot;) : ' + val});</span>
<a href="#l72.1171"></a><span id="l72.1171">   } else {</span>
<a href="#l72.1172"></a><span id="l72.1172">     throw new Error(&quot;Controller.assertDOMProperty(&quot; + el.getInfo() + &quot;) : &quot; +</span>
<a href="#l72.1173"></a><span id="l72.1173">                      (val === undefined ? &quot;property '&quot; + attrib + &quot;' doesn't exist&quot; : val + &quot; == &quot; + value));</span>
<a href="#l72.1174"></a><span id="l72.1174">   }</span>
<a href="#l72.1175"></a><span id="l72.1175">   return res;</span>
<a href="#l72.1176"></a><span id="l72.1176"> };</span>
<a href="#l72.1177"></a><span id="l72.1177"> </span>
<a href="#l72.1178"></a><span id="l72.1178"> /**</span>
<a href="#l72.1179"></a><span id="l72.1179">  * Assert that an element's dom property doesn't exist or doesn't have a particular value</span>
<a href="#l72.1180"></a><span id="l72.1180">  *</span>
<a href="#l72.1181"></a><span id="l72.1181">  * if val is undefined, will return true if the property doesn't exist.</span>
<a href="#l72.1182"></a><span id="l72.1182">  * if val is specified, will return true if the property doesn't exist or doesn't have the specified value</span>
<a href="#l72.1183"></a><span id="l72.1183">  */</span>
<a href="#l72.1184"></a><span id="l72.1184"> MozMillController.prototype.assertNotDOMProperty = function(el, attrib, val) {</span>
<a href="#l72.1185"></a><span id="l72.1185">   var element = el.getNode();</span>
<a href="#l72.1186"></a><span id="l72.1186" class="difflineminus">-  if (!element){</span>
<a href="#l72.1187"></a><span id="l72.1187" class="difflineplus">+  if (!element) {</span>
<a href="#l72.1188"></a><span id="l72.1188">     throw new Error(&quot;could not find element &quot; + el.getInfo());</span>
<a href="#l72.1189"></a><span id="l72.1189" class="difflineminus">-    return false;</span>
<a href="#l72.1190"></a><span id="l72.1190">   }</span>
<a href="#l72.1191"></a><span id="l72.1191">   var value, res = element.hasAttribute(attrib);</span>
<a href="#l72.1192"></a><span id="l72.1192">   if (res &amp;&amp; val !== undefined) {</span>
<a href="#l72.1193"></a><span id="l72.1193">     value = element.getAttribute(attrib);</span>
<a href="#l72.1194"></a><span id="l72.1194">     res = (String(value) == String(val));</span>
<a href="#l72.1195"></a><span id="l72.1195">   }</span>
<a href="#l72.1196"></a><span id="l72.1196">   if (!res) {</span>
<a href="#l72.1197"></a><span id="l72.1197" class="difflineminus">-    frame.events.pass({'function':'Controller.assertNotDOMProperty(&quot;' + el.getInfo() + '&quot;) : ' + val});</span>
<a href="#l72.1198"></a><span id="l72.1198" class="difflineplus">+    frame.events.pass({&quot;function&quot;: 'Controller.assertNotDOMProperty(&quot;' + el.getInfo() + '&quot;) : ' + val});</span>
<a href="#l72.1199"></a><span id="l72.1199">   } else {</span>
<a href="#l72.1200"></a><span id="l72.1200">     throw new Error(&quot;Controller.assertNotDOMProperty(&quot; + el.getInfo() + &quot;) : &quot; +</span>
<a href="#l72.1201"></a><span id="l72.1201">                      (val == undefined ? &quot;property '&quot; + attrib + &quot;' exists&quot; : val + &quot; == &quot; + value));</span>
<a href="#l72.1202"></a><span id="l72.1202">   }</span>
<a href="#l72.1203"></a><span id="l72.1203">   return !res;</span>
<a href="#l72.1204"></a><span id="l72.1204"> };</span>
<a href="#l72.1205"></a><span id="l72.1205"> </span>
<a href="#l72.1206"></a><span id="l72.1206"> // deprecated - Use assertNotJSProperty or assertNotDOMProperty instead</span>
<a href="#l72.1207"></a><span id="l72.1207"> MozMillController.prototype.assertProperty = function(el, attrib, val) {</span>
<a href="#l72.1208"></a><span id="l72.1208" class="difflineminus">-  frame.log({'function':'controller.assertProperty() - DEPRECATED',</span>
<a href="#l72.1209"></a><span id="l72.1209" class="difflineminus">-                      'message':'assertProperty(el, attrib, val) is deprecated. Use assertJSProperty(el, attrib, val) or assertDOMProperty(el, attrib, val) instead'});</span>
<a href="#l72.1210"></a><span id="l72.1210" class="difflineplus">+  frame.log({</span>
<a href="#l72.1211"></a><span id="l72.1211" class="difflineplus">+    function: &quot;controller.assertProperty() - DEPRECATED&quot;,</span>
<a href="#l72.1212"></a><span id="l72.1212" class="difflineplus">+    message: &quot;assertProperty(el, attrib, val) is deprecated. Use assertJSProperty(el, attrib, val) or assertDOMProperty(el, attrib, val) instead&quot;,</span>
<a href="#l72.1213"></a><span id="l72.1213" class="difflineplus">+  });</span>
<a href="#l72.1214"></a><span id="l72.1214">   return this.assertJSProperty(el, attrib, val);</span>
<a href="#l72.1215"></a><span id="l72.1215"> };</span>
<a href="#l72.1216"></a><span id="l72.1216"> </span>
<a href="#l72.1217"></a><span id="l72.1217"> // deprecated - Use assertNotJSProperty or assertNotDOMProperty instead</span>
<a href="#l72.1218"></a><span id="l72.1218"> MozMillController.prototype.assertPropertyNotExist = function(el, attrib) {</span>
<a href="#l72.1219"></a><span id="l72.1219" class="difflineminus">-  frame.log({'function':'controller.assertPropertyNotExist() - DEPRECATED',</span>
<a href="#l72.1220"></a><span id="l72.1220" class="difflineminus">-                   'message':'assertPropertyNotExist(el, attrib) is deprecated. Use assertNotJSProperty(el, attrib) or assertNotDOMProperty(el, attrib) instead'});</span>
<a href="#l72.1221"></a><span id="l72.1221" class="difflineplus">+  frame.log({</span>
<a href="#l72.1222"></a><span id="l72.1222" class="difflineplus">+    function: &quot;controller.assertPropertyNotExist() - DEPRECATED&quot;,</span>
<a href="#l72.1223"></a><span id="l72.1223" class="difflineplus">+    message: &quot;assertPropertyNotExist(el, attrib) is deprecated. Use assertNotJSProperty(el, attrib) or assertNotDOMProperty(el, attrib) instead&quot;,</span>
<a href="#l72.1224"></a><span id="l72.1224" class="difflineplus">+  });</span>
<a href="#l72.1225"></a><span id="l72.1225">   return this.assertNotJSProperty(el, attrib);</span>
<a href="#l72.1226"></a><span id="l72.1226"> };</span>
<a href="#l72.1227"></a><span id="l72.1227"> </span>
<a href="#l72.1228"></a><span id="l72.1228"> // Assert that a specified image has actually loaded</span>
<a href="#l72.1229"></a><span id="l72.1229"> // The Safari workaround results in additional requests</span>
<a href="#l72.1230"></a><span id="l72.1230"> // for broken images (in Safari only) but works reliably</span>
<a href="#l72.1231"></a><span id="l72.1231" class="difflineminus">-MozMillController.prototype.assertImageLoaded = function (el) {</span>
<a href="#l72.1232"></a><span id="l72.1232" class="difflineminus">-  //this.window.focus();</span>
<a href="#l72.1233"></a><span id="l72.1233" class="difflineplus">+MozMillController.prototype.assertImageLoaded = function(el) {</span>
<a href="#l72.1234"></a><span id="l72.1234" class="difflineplus">+  // this.window.focus();</span>
<a href="#l72.1235"></a><span id="l72.1235">   var img = el.getNode();</span>
<a href="#l72.1236"></a><span id="l72.1236" class="difflineminus">-  if (!img || img.tagName != 'IMG') {</span>
<a href="#l72.1237"></a><span id="l72.1237" class="difflineminus">-    throw new Error('Controller.assertImageLoaded() failed.')</span>
<a href="#l72.1238"></a><span id="l72.1238" class="difflineminus">-    return false;</span>
<a href="#l72.1239"></a><span id="l72.1239" class="difflineplus">+  if (!img || img.tagName != &quot;IMG&quot;) {</span>
<a href="#l72.1240"></a><span id="l72.1240" class="difflineplus">+    throw new Error(&quot;Controller.assertImageLoaded() failed.&quot;);</span>
<a href="#l72.1241"></a><span id="l72.1241">   }</span>
<a href="#l72.1242"></a><span id="l72.1242">   var comp = img.complete;</span>
<a href="#l72.1243"></a><span id="l72.1243">   var ret = null; // Return value</span>
<a href="#l72.1244"></a><span id="l72.1244"> </span>
<a href="#l72.1245"></a><span id="l72.1245">   // Workaround for Safari -- it only supports the</span>
<a href="#l72.1246"></a><span id="l72.1246">   // complete attrib on script-created images</span>
<a href="#l72.1247"></a><span id="l72.1247" class="difflineminus">-  if (typeof comp == 'undefined') {</span>
<a href="#l72.1248"></a><span id="l72.1248" class="difflineminus">-    test = new Image();</span>
<a href="#l72.1249"></a><span id="l72.1249" class="difflineplus">+  if (typeof comp == &quot;undefined&quot;) {</span>
<a href="#l72.1250"></a><span id="l72.1250" class="difflineplus">+    let test = new Image();</span>
<a href="#l72.1251"></a><span id="l72.1251">     // If the original image was successfully loaded,</span>
<a href="#l72.1252"></a><span id="l72.1252">     // src for new one should be pulled from cache</span>
<a href="#l72.1253"></a><span id="l72.1253">     test.src = img.src;</span>
<a href="#l72.1254"></a><span id="l72.1254">     comp = test.complete;</span>
<a href="#l72.1255"></a><span id="l72.1255">   }</span>
<a href="#l72.1256"></a><span id="l72.1256"> </span>
<a href="#l72.1257"></a><span id="l72.1257">   // Check the complete attrib. Note the strict</span>
<a href="#l72.1258"></a><span id="l72.1258">   // equality check -- we don't want undefined, null, etc.</span>
<a href="#l72.1259"></a><span id="l72.1259">   // --------------------------</span>
<a href="#l72.1260"></a><span id="l72.1260">   // False -- Img failed to load in IE/Safari, or is</span>
<a href="#l72.1261"></a><span id="l72.1261">   // still trying to load in FF</span>
<a href="#l72.1262"></a><span id="l72.1262">   if (comp === false) {</span>
<a href="#l72.1263"></a><span id="l72.1263">     ret = false;</span>
<a href="#l72.1264"></a><span id="l72.1264" class="difflineminus">-  }</span>
<a href="#l72.1265"></a><span id="l72.1265" class="difflineminus">-  // True, but image has no size -- image failed to</span>
<a href="#l72.1266"></a><span id="l72.1266" class="difflineminus">-  // load in FF</span>
<a href="#l72.1267"></a><span id="l72.1267" class="difflineminus">-  else if (comp === true &amp;&amp; img.naturalWidth == 0) {</span>
<a href="#l72.1268"></a><span id="l72.1268" class="difflineplus">+  } else if (comp === true &amp;&amp; img.naturalWidth == 0) {</span>
<a href="#l72.1269"></a><span id="l72.1269" class="difflineplus">+    // True, but image has no size -- image failed to</span>
<a href="#l72.1270"></a><span id="l72.1270" class="difflineplus">+    // load in FF</span>
<a href="#l72.1271"></a><span id="l72.1271">     ret = false;</span>
<a href="#l72.1272"></a><span id="l72.1272" class="difflineminus">-  }</span>
<a href="#l72.1273"></a><span id="l72.1273" class="difflineminus">-  // Otherwise all we can do is assume everything's</span>
<a href="#l72.1274"></a><span id="l72.1274" class="difflineminus">-  // hunky-dory</span>
<a href="#l72.1275"></a><span id="l72.1275" class="difflineminus">-  else {</span>
<a href="#l72.1276"></a><span id="l72.1276" class="difflineplus">+  } else {</span>
<a href="#l72.1277"></a><span id="l72.1277" class="difflineplus">+    // Otherwise all we can do is assume everything's</span>
<a href="#l72.1278"></a><span id="l72.1278" class="difflineplus">+    // hunky-dory</span>
<a href="#l72.1279"></a><span id="l72.1279">     ret = true;</span>
<a href="#l72.1280"></a><span id="l72.1280">   }</span>
<a href="#l72.1281"></a><span id="l72.1281">   if (ret) {</span>
<a href="#l72.1282"></a><span id="l72.1282" class="difflineminus">-    frame.events.pass({'function':'Controller.assertImageLoaded'});</span>
<a href="#l72.1283"></a><span id="l72.1283" class="difflineplus">+    frame.events.pass({&quot;function&quot;: &quot;Controller.assertImageLoaded&quot;});</span>
<a href="#l72.1284"></a><span id="l72.1284">   } else {</span>
<a href="#l72.1285"></a><span id="l72.1285" class="difflineminus">-    throw new Error('Controller.assertImageLoaded() failed.')</span>
<a href="#l72.1286"></a><span id="l72.1286" class="difflineplus">+    throw new Error(&quot;Controller.assertImageLoaded() failed.&quot;);</span>
<a href="#l72.1287"></a><span id="l72.1287">   }</span>
<a href="#l72.1288"></a><span id="l72.1288"> </span>
<a href="#l72.1289"></a><span id="l72.1289">   return ret;</span>
<a href="#l72.1290"></a><span id="l72.1290"> };</span>
<a href="#l72.1291"></a><span id="l72.1291"> </span>
<a href="#l72.1292"></a><span id="l72.1292" class="difflineminus">-//Drag one eleent to the top x,y coords of another specified element</span>
<a href="#l72.1293"></a><span id="l72.1293" class="difflineminus">-MozMillController.prototype.mouseMove = function (doc, start, dest) {</span>
<a href="#l72.1294"></a><span id="l72.1294" class="difflineminus">-  //if one of these elements couldn't be looked up</span>
<a href="#l72.1295"></a><span id="l72.1295" class="difflineminus">-  if (typeof start != 'object'){</span>
<a href="#l72.1296"></a><span id="l72.1296" class="difflineplus">+// Drag one eleent to the top x,y coords of another specified element</span>
<a href="#l72.1297"></a><span id="l72.1297" class="difflineplus">+MozMillController.prototype.mouseMove = function(doc, start, dest) {</span>
<a href="#l72.1298"></a><span id="l72.1298" class="difflineplus">+  // if one of these elements couldn't be looked up</span>
<a href="#l72.1299"></a><span id="l72.1299" class="difflineplus">+  if (typeof start != &quot;object&quot;) {</span>
<a href="#l72.1300"></a><span id="l72.1300">     throw new Error(&quot;received bad coordinates&quot;);</span>
<a href="#l72.1301"></a><span id="l72.1301" class="difflineminus">-    return false;</span>
<a href="#l72.1302"></a><span id="l72.1302">   }</span>
<a href="#l72.1303"></a><span id="l72.1303" class="difflineminus">-  if (typeof dest != 'object'){</span>
<a href="#l72.1304"></a><span id="l72.1304" class="difflineplus">+  if (typeof dest != &quot;object&quot;) {</span>
<a href="#l72.1305"></a><span id="l72.1305">     throw new Error(&quot;received bad coordinates&quot;);</span>
<a href="#l72.1306"></a><span id="l72.1306" class="difflineminus">-    return false;</span>
<a href="#l72.1307"></a><span id="l72.1307">   }</span>
<a href="#l72.1308"></a><span id="l72.1308"> </span>
<a href="#l72.1309"></a><span id="l72.1309" class="difflineminus">-  //Do the initial move to the drag element position</span>
<a href="#l72.1310"></a><span id="l72.1310" class="difflineminus">-  events.triggerMouseEvent(doc.body, 'mousemove', true, start[0], start[1]);</span>
<a href="#l72.1311"></a><span id="l72.1311" class="difflineminus">-  events.triggerMouseEvent(doc.body, 'mousemove', true, dest[0], dest[1]);</span>
<a href="#l72.1312"></a><span id="l72.1312" class="difflineminus">-  frame.events.pass({'function':'Controller.mouseMove()'});</span>
<a href="#l72.1313"></a><span id="l72.1313" class="difflineplus">+  // Do the initial move to the drag element position</span>
<a href="#l72.1314"></a><span id="l72.1314" class="difflineplus">+  events.triggerMouseEvent(doc.body, &quot;mousemove&quot;, true, start[0], start[1]);</span>
<a href="#l72.1315"></a><span id="l72.1315" class="difflineplus">+  events.triggerMouseEvent(doc.body, &quot;mousemove&quot;, true, dest[0], dest[1]);</span>
<a href="#l72.1316"></a><span id="l72.1316" class="difflineplus">+  frame.events.pass({&quot;function&quot;: &quot;Controller.mouseMove()&quot;});</span>
<a href="#l72.1317"></a><span id="l72.1317">   return true;</span>
<a href="#l72.1318"></a><span id="l72.1318" class="difflineminus">-}</span>
<a href="#l72.1319"></a><span id="l72.1319" class="difflineplus">+};</span>
<a href="#l72.1320"></a><span id="l72.1320"> </span>
<a href="#l72.1321"></a><span id="l72.1321"> // Drag an element to the specified offset on another element, firing mouse and drag events</span>
<a href="#l72.1322"></a><span id="l72.1322"> //  win must be the window both elements are in. Adapted from EventUtils' synthesizeDrop()</span>
<a href="#l72.1323"></a><span id="l72.1323" class="difflineminus">-MozMillController.prototype.dragToElement = function(src, dest, offsetX,</span>
<a href="#l72.1324"></a><span id="l72.1324" class="difflineminus">-    offsetY, aWindow, dropEffect, dragData) {</span>
<a href="#l72.1325"></a><span id="l72.1325" class="difflineminus">-  srcElement = src.getNode();</span>
<a href="#l72.1326"></a><span id="l72.1326" class="difflineminus">-  destElement = dest.getNode();</span>
<a href="#l72.1327"></a><span id="l72.1327" class="difflineminus">-  aWindow = aWindow || srcElement.ownerDocument.defaultView;</span>
<a href="#l72.1328"></a><span id="l72.1328" class="difflineplus">+MozMillController.prototype.dragToElement = function(src, dest, offsetX, offsetY,</span>
<a href="#l72.1329"></a><span id="l72.1329" class="difflineplus">+                                                     aWindow, dropEffect, dragData) {</span>
<a href="#l72.1330"></a><span id="l72.1330" class="difflineplus">+  let srcElement = src.getNode();</span>
<a href="#l72.1331"></a><span id="l72.1331" class="difflineplus">+  let destElement = dest.getNode();</span>
<a href="#l72.1332"></a><span id="l72.1332" class="difflineplus">+  aWindow = aWindow || srcElement.ownerGlobal;</span>
<a href="#l72.1333"></a><span id="l72.1333">   offsetX = offsetX || 20;</span>
<a href="#l72.1334"></a><span id="l72.1334">   offsetY = offsetY || 20;</span>
<a href="#l72.1335"></a><span id="l72.1335"> </span>
<a href="#l72.1336"></a><span id="l72.1336">   var dataTransfer;</span>
<a href="#l72.1337"></a><span id="l72.1337"> </span>
<a href="#l72.1338"></a><span id="l72.1338">   var trapDrag = function(event) {</span>
<a href="#l72.1339"></a><span id="l72.1339">     dataTransfer = event.dataTransfer;</span>
<a href="#l72.1340"></a><span id="l72.1340" class="difflineminus">-    if(!dragData)</span>
<a href="#l72.1341"></a><span id="l72.1341" class="difflineplus">+    if (!dragData)</span>
<a href="#l72.1342"></a><span id="l72.1342">       return;</span>
<a href="#l72.1343"></a><span id="l72.1343"> </span>
<a href="#l72.1344"></a><span id="l72.1344">     for (var i = 0; i &lt; dragData.length; i++) {</span>
<a href="#l72.1345"></a><span id="l72.1345">       var item = dragData[i];</span>
<a href="#l72.1346"></a><span id="l72.1346">       for (var j = 0; j &lt; item.length; j++) {</span>
<a href="#l72.1347"></a><span id="l72.1347">         dataTransfer.mozSetDataAt(item[j].type, item[j].data, i);</span>
<a href="#l72.1348"></a><span id="l72.1348">       }</span>
<a href="#l72.1349"></a><span id="l72.1349">     }</span>
<a href="#l72.1350"></a><span id="l72.1350">     dataTransfer.dropEffect = dropEffect || &quot;move&quot;;</span>
<a href="#l72.1351"></a><span id="l72.1351">     event.preventDefault();</span>
<a href="#l72.1352"></a><span id="l72.1352">     event.stopPropagation();</span>
<a href="#l72.1353"></a><span id="l72.1353" class="difflineminus">-  }</span>
<a href="#l72.1354"></a><span id="l72.1354" class="difflineplus">+  };</span>
<a href="#l72.1355"></a><span id="l72.1355"> </span>
<a href="#l72.1356"></a><span id="l72.1356">   aWindow.addEventListener(&quot;dragstart&quot;, trapDrag, true);</span>
<a href="#l72.1357"></a><span id="l72.1357">   EventUtils.synthesizeMouse(srcElement, 2, 2, { type: &quot;mousedown&quot; }, aWindow);</span>
<a href="#l72.1358"></a><span id="l72.1358">   EventUtils.synthesizeMouse(srcElement, 11, 11, { type: &quot;mousemove&quot; }, aWindow);</span>
<a href="#l72.1359"></a><span id="l72.1359">   EventUtils.synthesizeMouse(srcElement, offsetX, offsetY, { type: &quot;mousemove&quot; }, aWindow);</span>
<a href="#l72.1360"></a><span id="l72.1360">   aWindow.removeEventListener(&quot;dragstart&quot;, trapDrag, true);</span>
<a href="#l72.1361"></a><span id="l72.1361"> </span>
<a href="#l72.1362"></a><span id="l72.1362">   var event = aWindow.document.createEvent(&quot;DragEvent&quot;);</span>
<a href="#l72.1363"></a><span id="l72.1363">   event.initDragEvent(&quot;dragenter&quot;, true, true, aWindow, 0, 0, 0, 0, 0, false, false, false, false, 0, null, dataTransfer);</span>
<a href="#l72.1364"></a><span id="l72.1364">   destElement.dispatchEvent(event);</span>
<a href="#l72.1365"></a><span id="l72.1365"> </span>
<a href="#l72.1366"></a><span id="l72.1366" class="difflineminus">-  var event = aWindow.document.createEvent(&quot;DragEvent&quot;);</span>
<a href="#l72.1367"></a><span id="l72.1367" class="difflineplus">+  event = aWindow.document.createEvent(&quot;DragEvent&quot;);</span>
<a href="#l72.1368"></a><span id="l72.1368">   event.initDragEvent(&quot;dragover&quot;, true, true, aWindow, 0, 0, 0, 0, 0, false, false, false, false, 0, null, dataTransfer);</span>
<a href="#l72.1369"></a><span id="l72.1369">   if (destElement.dispatchEvent(event)) {</span>
<a href="#l72.1370"></a><span id="l72.1370">     EventUtils.synthesizeMouse(destElement, offsetX, offsetY, { type: &quot;mouseup&quot; }, aWindow);</span>
<a href="#l72.1371"></a><span id="l72.1371">     return &quot;none&quot;;</span>
<a href="#l72.1372"></a><span id="l72.1372">   }</span>
<a href="#l72.1373"></a><span id="l72.1373"> </span>
<a href="#l72.1374"></a><span id="l72.1374">   event = aWindow.document.createEvent(&quot;DragEvent&quot;);</span>
<a href="#l72.1375"></a><span id="l72.1375">   event.initDragEvent(&quot;drop&quot;, true, true, aWindow, 0, 0, 0, 0, 0, false, false, false, false, 0, null, dataTransfer);</span>
<a href="#l72.1376"></a><span id="l72.1376">   destElement.dispatchEvent(event);</span>
<a href="#l72.1377"></a><span id="l72.1377">   EventUtils.synthesizeMouse(destElement, offsetX, offsetY, { type: &quot;mouseup&quot; }, aWindow);</span>
<a href="#l72.1378"></a><span id="l72.1378"> </span>
<a href="#l72.1379"></a><span id="l72.1379">   return dataTransfer.dropEffect;</span>
<a href="#l72.1380"></a><span id="l72.1380" class="difflineminus">-}</span>
<a href="#l72.1381"></a><span id="l72.1381" class="difflineplus">+};</span>
<a href="#l72.1382"></a><span id="l72.1382"> </span>
<a href="#l72.1383"></a><span id="l72.1383"> function preferencesAdditions(controller) {</span>
<a href="#l72.1384"></a><span id="l72.1384" class="difflineminus">-  var mainTabs = controller.window.document.getAnonymousElementByAttribute(controller.window.document.documentElement, 'anonid', 'selector');</span>
<a href="#l72.1385"></a><span id="l72.1385" class="difflineplus">+  var mainTabs = controller.window.document.getAnonymousElementByAttribute(controller.window.document.documentElement, &quot;anonid&quot;, &quot;selector&quot;);</span>
<a href="#l72.1386"></a><span id="l72.1386">   controller.tabs = {};</span>
<a href="#l72.1387"></a><span id="l72.1387">   for (var i = 0; i &lt; mainTabs.childNodes.length; i++) {</span>
<a href="#l72.1388"></a><span id="l72.1388">     var node  = mainTabs.childNodes[i];</span>
<a href="#l72.1389"></a><span id="l72.1389" class="difflineminus">-    var obj = {'button':node}</span>
<a href="#l72.1390"></a><span id="l72.1390" class="difflineplus">+    var obj = {&quot;button&quot;: node};</span>
<a href="#l72.1391"></a><span id="l72.1391">     controller.tabs[i] = obj;</span>
<a href="#l72.1392"></a><span id="l72.1392" class="difflineminus">-    var label = node.attributes.item('label').value.replace('pane', '');</span>
<a href="#l72.1393"></a><span id="l72.1393" class="difflineplus">+    var label = node.attributes.item(&quot;label&quot;).value.replace(&quot;pane&quot;, &quot;&quot;);</span>
<a href="#l72.1394"></a><span id="l72.1394">     controller.tabs[label] = obj;</span>
<a href="#l72.1395"></a><span id="l72.1395">   }</span>
<a href="#l72.1396"></a><span id="l72.1396" class="difflineminus">-  controller.prototype.__defineGetter__(&quot;activeTabButton&quot;,</span>
<a href="#l72.1397"></a><span id="l72.1397" class="difflineminus">-    function () {return mainTabs.getElementsByAttribute('selected', true)[0];</span>
<a href="#l72.1398"></a><span id="l72.1398" class="difflineminus">-  })</span>
<a href="#l72.1399"></a><span id="l72.1399" class="difflineplus">+  controller.prototype.__defineGetter__(&quot;activeTabButton&quot;, function() {</span>
<a href="#l72.1400"></a><span id="l72.1400" class="difflineplus">+    return mainTabs.getElementsByAttribute(&quot;selected&quot;, true)[0];</span>
<a href="#l72.1401"></a><span id="l72.1401" class="difflineplus">+  });</span>
<a href="#l72.1402"></a><span id="l72.1402"> }</span>
<a href="#l72.1403"></a><span id="l72.1403"> </span>
<a href="#l72.1404"></a><span id="l72.1404" class="difflineminus">-function Tabs (controller) {</span>
<a href="#l72.1405"></a><span id="l72.1405" class="difflineplus">+function Tabs(controller) {</span>
<a href="#l72.1406"></a><span id="l72.1406">   this.controller = controller;</span>
<a href="#l72.1407"></a><span id="l72.1407"> }</span>
<a href="#l72.1408"></a><span id="l72.1408"> Tabs.prototype.getTab = function(index) {</span>
<a href="#l72.1409"></a><span id="l72.1409">   return this.controller.window.gBrowser.browsers[index].contentDocument;</span>
<a href="#l72.1410"></a><span id="l72.1410" class="difflineminus">-}</span>
<a href="#l72.1411"></a><span id="l72.1411" class="difflineplus">+};</span>
<a href="#l72.1412"></a><span id="l72.1412"> Tabs.prototype.__defineGetter__(&quot;activeTab&quot;, function() {</span>
<a href="#l72.1413"></a><span id="l72.1413">   return this.controller.window.gBrowser.selectedBrowser.contentDocument;</span>
<a href="#l72.1414"></a><span id="l72.1414" class="difflineminus">-})</span>
<a href="#l72.1415"></a><span id="l72.1415" class="difflineplus">+});</span>
<a href="#l72.1416"></a><span id="l72.1416"> Tabs.prototype.selectTab = function(index) {</span>
<a href="#l72.1417"></a><span id="l72.1417">   // GO in to tab manager and grab the tab by index and call focus.</span>
<a href="#l72.1418"></a><span id="l72.1418" class="difflineminus">-}</span>
<a href="#l72.1419"></a><span id="l72.1419" class="difflineminus">-Tabs.prototype.findWindow = function (doc) {</span>
<a href="#l72.1420"></a><span id="l72.1420" class="difflineplus">+};</span>
<a href="#l72.1421"></a><span id="l72.1421" class="difflineplus">+Tabs.prototype.findWindow = function(doc) {</span>
<a href="#l72.1422"></a><span id="l72.1422">   for (var i = 0; i &lt;= (this.controller.window.frames.length - 1); i++) {</span>
<a href="#l72.1423"></a><span id="l72.1423">     if (this.controller.window.frames[i].document == doc) {</span>
<a href="#l72.1424"></a><span id="l72.1424">       return this.controller.window.frames[i];</span>
<a href="#l72.1425"></a><span id="l72.1425">     }</span>
<a href="#l72.1426"></a><span id="l72.1426">   }</span>
<a href="#l72.1427"></a><span id="l72.1427">   throw new Error(&quot;Cannot find window for document. Doc title == &quot; + doc.title);</span>
<a href="#l72.1428"></a><span id="l72.1428" class="difflineminus">-}</span>
<a href="#l72.1429"></a><span id="l72.1429" class="difflineplus">+};</span>
<a href="#l72.1430"></a><span id="l72.1430"> Tabs.prototype.getTabWindow = function(index) {</span>
<a href="#l72.1431"></a><span id="l72.1431">   return this.findWindow(this.getTab(index));</span>
<a href="#l72.1432"></a><span id="l72.1432" class="difflineminus">-}</span>
<a href="#l72.1433"></a><span id="l72.1433" class="difflineminus">-Tabs.prototype.__defineGetter__(&quot;activeTabWindow&quot;, function () {</span>
<a href="#l72.1434"></a><span id="l72.1434" class="difflineplus">+};</span>
<a href="#l72.1435"></a><span id="l72.1435" class="difflineplus">+Tabs.prototype.__defineGetter__(&quot;activeTabWindow&quot;, function() {</span>
<a href="#l72.1436"></a><span id="l72.1436">   return this.findWindow(this.activeTab);</span>
<a href="#l72.1437"></a><span id="l72.1437" class="difflineminus">-})</span>
<a href="#l72.1438"></a><span id="l72.1438" class="difflineminus">-Tabs.prototype.__defineGetter__(&quot;length&quot;, function () {</span>
<a href="#l72.1439"></a><span id="l72.1439" class="difflineplus">+});</span>
<a href="#l72.1440"></a><span id="l72.1440" class="difflineplus">+Tabs.prototype.__defineGetter__(&quot;length&quot;, function() {</span>
<a href="#l72.1441"></a><span id="l72.1441">   return this.controller.window.gBrowser.browsers.length;</span>
<a href="#l72.1442"></a><span id="l72.1442" class="difflineminus">-})</span>
<a href="#l72.1443"></a><span id="l72.1443" class="difflineplus">+});</span>
<a href="#l72.1444"></a><span id="l72.1444"> Tabs.prototype.__defineGetter__(&quot;activeTabIndex&quot;, function() {</span>
<a href="#l72.1445"></a><span id="l72.1445">   return this.controller.window.gBrowser.tabContainer.selectedIndex;</span>
<a href="#l72.1446"></a><span id="l72.1446" class="difflineminus">-})</span>
<a href="#l72.1447"></a><span id="l72.1447" class="difflineplus">+});</span>
<a href="#l72.1448"></a><span id="l72.1448"> Tabs.prototype.selectTabIndex = function(i) {</span>
<a href="#l72.1449"></a><span id="l72.1449">   this.controller.window.gBrowser.selectTabAtIndex(i);</span>
<a href="#l72.1450"></a><span id="l72.1450" class="difflineminus">-}</span>
<a href="#l72.1451"></a><span id="l72.1451" class="difflineplus">+};</span>
<a href="#l72.1452"></a><span id="l72.1452"> </span>
<a href="#l72.1453"></a><span id="l72.1453" class="difflineminus">-function browserAdditions (controller) {</span>
<a href="#l72.1454"></a><span id="l72.1454" class="difflineplus">+function browserAdditions(controller) {</span>
<a href="#l72.1455"></a><span id="l72.1455">   controller.tabs = new Tabs(controller);</span>
<a href="#l72.1456"></a><span id="l72.1456"> </span>
<a href="#l72.1457"></a><span id="l72.1457">   controller.waitForPageLoad = function(aDocument, aTimeout, aInterval) {</span>
<a href="#l72.1458"></a><span id="l72.1458">     var timeout = aTimeout || 30000;</span>
<a href="#l72.1459"></a><span id="l72.1459">     var win = null;</span>
<a href="#l72.1460"></a><span id="l72.1460"> </span>
<a href="#l72.1461"></a><span id="l72.1461">     // If a user tries to do waitForPageLoad(2000), this will assign the</span>
<a href="#l72.1462"></a><span id="l72.1462">     // interval the first arg which is most likely what they were expecting</span>
<a href="#l72.1463"></a><span id="l72.1463" class="difflineat">@@ -1309,51 +1257,48 @@ function browserAdditions (controller) {</span>
<a href="#l72.1464"></a><span id="l72.1464">         &quot;defaultView&quot; in aDocument)</span>
<a href="#l72.1465"></a><span id="l72.1465">       win = aDocument.defaultView;</span>
<a href="#l72.1466"></a><span id="l72.1466"> </span>
<a href="#l72.1467"></a><span id="l72.1467">     // If no document has been specified, fallback to the default view of the</span>
<a href="#l72.1468"></a><span id="l72.1468">     // currently selected tab browser</span>
<a href="#l72.1469"></a><span id="l72.1469">     win = win || this.window.gBrowser.selectedBrowser.contentWindow;</span>
<a href="#l72.1470"></a><span id="l72.1470"> </span>
<a href="#l72.1471"></a><span id="l72.1471">     // Wait until the content in the tab has been loaded</span>
<a href="#l72.1472"></a><span id="l72.1472" class="difflineminus">-    this.waitFor(function () {</span>
<a href="#l72.1473"></a><span id="l72.1473" class="difflineplus">+    this.waitFor(function() {</span>
<a href="#l72.1474"></a><span id="l72.1474">       return this.isLoaded(win);</span>
<a href="#l72.1475"></a><span id="l72.1475" class="difflineminus">-    }, &quot;controller.waitForPageLoad(): Timeout waiting for page loaded.&quot;,</span>
<a href="#l72.1476"></a><span id="l72.1476" class="difflineminus">-       timeout, aInterval, this);</span>
<a href="#l72.1477"></a><span id="l72.1477" class="difflineplus">+    }, &quot;controller.waitForPageLoad(): Timeout waiting for page loaded.&quot;, timeout, aInterval, this);</span>
<a href="#l72.1478"></a><span id="l72.1478"> </span>
<a href="#l72.1479"></a><span id="l72.1479" class="difflineminus">-    frame.events.pass({'function':'controller.waitForPageLoad()'});</span>
<a href="#l72.1480"></a><span id="l72.1480" class="difflineminus">-  }</span>
<a href="#l72.1481"></a><span id="l72.1481" class="difflineplus">+    frame.events.pass({&quot;function&quot;: &quot;controller.waitForPageLoad()&quot;});</span>
<a href="#l72.1482"></a><span id="l72.1482" class="difflineplus">+  };</span>
<a href="#l72.1483"></a><span id="l72.1483"> }</span>
<a href="#l72.1484"></a><span id="l72.1484"> </span>
<a href="#l72.1485"></a><span id="l72.1485"> var controllerAdditions = {</span>
<a href="#l72.1486"></a><span id="l72.1486" class="difflineminus">-  'Browser:Preferences':preferencesAdditions,</span>
<a href="#l72.1487"></a><span id="l72.1487" class="difflineminus">-  'navigator:browser'  :browserAdditions,</span>
<a href="#l72.1488"></a><span id="l72.1488" class="difflineminus">-}</span>
<a href="#l72.1489"></a><span id="l72.1489" class="difflineplus">+  &quot;Browser:Preferences&quot;: preferencesAdditions,</span>
<a href="#l72.1490"></a><span id="l72.1490" class="difflineplus">+  &quot;navigator:browser&quot;: browserAdditions,</span>
<a href="#l72.1491"></a><span id="l72.1491" class="difflineplus">+};</span>
<a href="#l72.1492"></a><span id="l72.1492"> </span>
<a href="#l72.1493"></a><span id="l72.1493" class="difflineminus">-var withs = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/withs.js&quot;);</span>
<a href="#l72.1494"></a><span id="l72.1494" class="difflineminus">-</span>
<a href="#l72.1495"></a><span id="l72.1495" class="difflineminus">-var MozMillAsyncTest = function (timeout) {</span>
<a href="#l72.1496"></a><span id="l72.1496" class="difflineplus">+var MozMillAsyncTest = function(timeout) {</span>
<a href="#l72.1497"></a><span id="l72.1497">   if (timeout == undefined) {</span>
<a href="#l72.1498"></a><span id="l72.1498">     this.timeout = 6000;</span>
<a href="#l72.1499"></a><span id="l72.1499">   } else {</span>
<a href="#l72.1500"></a><span id="l72.1500">     this.timeout = timeout;</span>
<a href="#l72.1501"></a><span id="l72.1501">   }</span>
<a href="#l72.1502"></a><span id="l72.1502">   this._done = false;</span>
<a href="#l72.1503"></a><span id="l72.1503">   this._mozmillasynctest = true;</span>
<a href="#l72.1504"></a><span id="l72.1504" class="difflineminus">-}</span>
<a href="#l72.1505"></a><span id="l72.1505" class="difflineplus">+};</span>
<a href="#l72.1506"></a><span id="l72.1506"> </span>
<a href="#l72.1507"></a><span id="l72.1507" class="difflineminus">-MozMillAsyncTest.prototype.run = function () {</span>
<a href="#l72.1508"></a><span id="l72.1508" class="difflineplus">+MozMillAsyncTest.prototype.run = function() {</span>
<a href="#l72.1509"></a><span id="l72.1509">   for (var i in this) {</span>
<a href="#l72.1510"></a><span id="l72.1510" class="difflineminus">-    if (withs.startsWith(i, 'test') &amp;&amp; typeof(this[i]) == 'function') {</span>
<a href="#l72.1511"></a><span id="l72.1511" class="difflineplus">+    if (i.startsWith(&quot;test&quot;) &amp;&amp; typeof(this[i]) == &quot;function&quot;) {</span>
<a href="#l72.1512"></a><span id="l72.1512">       this[i]();</span>
<a href="#l72.1513"></a><span id="l72.1513">     }</span>
<a href="#l72.1514"></a><span id="l72.1514">   }</span>
<a href="#l72.1515"></a><span id="l72.1515"> </span>
<a href="#l72.1516"></a><span id="l72.1516">   utils.waitFor(function() {</span>
<a href="#l72.1517"></a><span id="l72.1517" class="difflineminus">-    return this._done == true;</span>
<a href="#l72.1518"></a><span id="l72.1518" class="difflineplus">+    return this._done;</span>
<a href="#l72.1519"></a><span id="l72.1519">   }, () =&gt; (&quot;MozMillAsyncTest timed out. Done is &quot; + this._done), 500, 100);</span>
<a href="#l72.1520"></a><span id="l72.1520"> </span>
<a href="#l72.1521"></a><span id="l72.1521">   return true;</span>
<a href="#l72.1522"></a><span id="l72.1522" class="difflineminus">-}</span>
<a href="#l72.1523"></a><span id="l72.1523" class="difflineplus">+};</span>
<a href="#l72.1524"></a><span id="l72.1524"> </span>
<a href="#l72.1525"></a><span id="l72.1525" class="difflineminus">-MozMillAsyncTest.prototype.finish = function () {</span>
<a href="#l72.1526"></a><span id="l72.1526" class="difflineplus">+MozMillAsyncTest.prototype.finish = function() {</span>
<a href="#l72.1527"></a><span id="l72.1527">   this._done = true;</span>
<a href="#l72.1528"></a><span id="l72.1528" class="difflineminus">-}</span>
<a href="#l72.1529"></a><span id="l72.1529" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l73.1"></a><span id="l73.1">rename from mail/test/resources/mozmill/mozmill/extension/content/modules/elementslib.js</span>
<a href="#l73.2"></a><span id="l73.2">rename to mail/test/resources/mozmill/mozmill/extension/content/modules/elementslib.jsm</span>
<a href="#l73.3"></a><span id="l73.3" class="difflineminus">--- a/mail/test/resources/mozmill/mozmill/extension/content/modules/elementslib.js</span>
<a href="#l73.4"></a><span id="l73.4" class="difflineplus">+++ b/mail/test/resources/mozmill/mozmill/extension/content/modules/elementslib.jsm</span>
<a href="#l73.5"></a><span id="l73.5" class="difflineat">@@ -31,319 +31,299 @@</span>
<a href="#l73.6"></a><span id="l73.6"> // use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l73.7"></a><span id="l73.7"> // decision by deleting the provisions above and replace them with the notice</span>
<a href="#l73.8"></a><span id="l73.8"> // and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l73.9"></a><span id="l73.9"> // the provisions above, a recipient may use your version of this file under</span>
<a href="#l73.10"></a><span id="l73.10"> // the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l73.11"></a><span id="l73.11"> //</span>
<a href="#l73.12"></a><span id="l73.12"> // ***** END LICENSE BLOCK *****</span>
<a href="#l73.13"></a><span id="l73.13"> </span>
<a href="#l73.14"></a><span id="l73.14" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;Elem&quot;, &quot;ID&quot;, &quot;Link&quot;, &quot;XPath&quot;, &quot;Selector&quot;, &quot;Name&quot;, &quot;Anon&quot;, &quot;AnonXPath&quot;,</span>
<a href="#l73.15"></a><span id="l73.15" class="difflineminus">-                        &quot;Lookup&quot;, &quot;_byID&quot;, &quot;_byName&quot;, &quot;_byAttrib&quot;, &quot;_byAnonAttrib&quot;,</span>
<a href="#l73.16"></a><span id="l73.16" class="difflineminus">-                       ];</span>
<a href="#l73.17"></a><span id="l73.17" class="difflineplus">+var EXPORTED_SYMBOLS = [</span>
<a href="#l73.18"></a><span id="l73.18" class="difflineplus">+  &quot;Elem&quot;, &quot;ID&quot;, &quot;Link&quot;, &quot;XPath&quot;, &quot;Selector&quot;, &quot;Name&quot;, &quot;Anon&quot;, &quot;AnonXPath&quot;,</span>
<a href="#l73.19"></a><span id="l73.19" class="difflineplus">+  &quot;Lookup&quot;, &quot;_byID&quot;, &quot;_byName&quot;, &quot;_byAttrib&quot;, &quot;_byAnonAttrib&quot;,</span>
<a href="#l73.20"></a><span id="l73.20" class="difflineplus">+];</span>
<a href="#l73.21"></a><span id="l73.21"> </span>
<a href="#l73.22"></a><span id="l73.22" class="difflineminus">-var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.js&quot;);</span>
<a href="#l73.23"></a><span id="l73.23" class="difflineminus">-var strings = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/strings.js&quot;);</span>
<a href="#l73.24"></a><span id="l73.24" class="difflineminus">-var arrays = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/arrays.js&quot;);</span>
<a href="#l73.25"></a><span id="l73.25" class="difflineminus">-var json2 = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/json2.js&quot;);</span>
<a href="#l73.26"></a><span id="l73.26" class="difflineminus">-var withs = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/withs.js&quot;);</span>
<a href="#l73.27"></a><span id="l73.27" class="difflineminus">-var dom = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/dom.js&quot;);</span>
<a href="#l73.28"></a><span id="l73.28" class="difflineminus">-var objects = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/objects.js&quot;);</span>
<a href="#l73.29"></a><span id="l73.29" class="difflineplus">+var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.jsm&quot;);</span>
<a href="#l73.30"></a><span id="l73.30" class="difflineplus">+var strings = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/strings.jsm&quot;);</span>
<a href="#l73.31"></a><span id="l73.31"> </span>
<a href="#l73.32"></a><span id="l73.32" class="difflineminus">-var countQuotes = function(str){</span>
<a href="#l73.33"></a><span id="l73.33" class="difflineplus">+var countQuotes = function(str) {</span>
<a href="#l73.34"></a><span id="l73.34">   var count = 0;</span>
<a href="#l73.35"></a><span id="l73.35">   var i = 0;</span>
<a href="#l73.36"></a><span id="l73.36" class="difflineminus">-  while(i &lt; str.length) {</span>
<a href="#l73.37"></a><span id="l73.37" class="difflineplus">+  while (i &lt; str.length) {</span>
<a href="#l73.38"></a><span id="l73.38">     i = str.indexOf('&quot;', i);</span>
<a href="#l73.39"></a><span id="l73.39">     if (i != -1) {</span>
<a href="#l73.40"></a><span id="l73.40">       count++;</span>
<a href="#l73.41"></a><span id="l73.41">       i++;</span>
<a href="#l73.42"></a><span id="l73.42">     } else {</span>
<a href="#l73.43"></a><span id="l73.43">       break;</span>
<a href="#l73.44"></a><span id="l73.44">     }</span>
<a href="#l73.45"></a><span id="l73.45">   }</span>
<a href="#l73.46"></a><span id="l73.46">   return count;</span>
<a href="#l73.47"></a><span id="l73.47" class="difflineminus">-}</span>
<a href="#l73.48"></a><span id="l73.48" class="difflineminus">-var smartSplit = function (str) {</span>
<a href="#l73.49"></a><span id="l73.49" class="difflineplus">+};</span>
<a href="#l73.50"></a><span id="l73.50" class="difflineplus">+var smartSplit = function(str) {</span>
<a href="#l73.51"></a><span id="l73.51">   // Note: I would love it if someone good with regular expressions</span>
<a href="#l73.52"></a><span id="l73.52">   // could just replace this function with a good regex</span>
<a href="#l73.53"></a><span id="l73.53"> </span>
<a href="#l73.54"></a><span id="l73.54">   // Ensure we have an even number of quotes</span>
<a href="#l73.55"></a><span id="l73.55">   if (countQuotes(str) % 2 != 0) {</span>
<a href="#l73.56"></a><span id="l73.56" class="difflineminus">-    throw new Error (&quot;Invalid Lookup Expression&quot;);</span>
<a href="#l73.57"></a><span id="l73.57" class="difflineplus">+    throw new Error(&quot;Invalid Lookup Expression&quot;);</span>
<a href="#l73.58"></a><span id="l73.58">   }</span>
<a href="#l73.59"></a><span id="l73.59"> </span>
<a href="#l73.60"></a><span id="l73.60">   var repls = [];</span>
<a href="#l73.61"></a><span id="l73.61" class="difflineminus">-  while ((str.indexOf('&quot;') != -1) &amp;&amp; i &lt;= str.length) {</span>
<a href="#l73.62"></a><span id="l73.62" class="difflineminus">-    var i = str.indexOf('&quot;');</span>
<a href="#l73.63"></a><span id="l73.63" class="difflineminus">-    var s = str.slice(i, str.indexOf('&quot;', i + 1) +1)</span>
<a href="#l73.64"></a><span id="l73.64" class="difflineminus">-    str = str.replace(s, '%$^'+repls.length);</span>
<a href="#l73.65"></a><span id="l73.65" class="difflineminus">-    repls.push(s)</span>
<a href="#l73.66"></a><span id="l73.66" class="difflineplus">+  let i = 0;</span>
<a href="#l73.67"></a><span id="l73.67" class="difflineplus">+  while (str.includes('&quot;') &amp;&amp; i &lt;= str.length) {</span>
<a href="#l73.68"></a><span id="l73.68" class="difflineplus">+    i = str.indexOf('&quot;');</span>
<a href="#l73.69"></a><span id="l73.69" class="difflineplus">+    let s = str.slice(i, str.indexOf('&quot;', i + 1) + 1);</span>
<a href="#l73.70"></a><span id="l73.70" class="difflineplus">+    str = str.replace(s, &quot;%$^&quot; + repls.length);</span>
<a href="#l73.71"></a><span id="l73.71" class="difflineplus">+    repls.push(s);</span>
<a href="#l73.72"></a><span id="l73.72">   }</span>
<a href="#l73.73"></a><span id="l73.73"> </span>
<a href="#l73.74"></a><span id="l73.74" class="difflineminus">-  var split = str.split('/');</span>
<a href="#l73.75"></a><span id="l73.75" class="difflineplus">+  var split = str.split(&quot;/&quot;);</span>
<a href="#l73.76"></a><span id="l73.76">   var rindex = 0;</span>
<a href="#l73.77"></a><span id="l73.77" class="difflineminus">-  for (var i in split) {</span>
<a href="#l73.78"></a><span id="l73.78" class="difflineminus">-    while (split[i].indexOf('%$^') != -1) {</span>
<a href="#l73.79"></a><span id="l73.79" class="difflineminus">-      var s = split[i];</span>
<a href="#l73.80"></a><span id="l73.80" class="difflineplus">+  for (let i in split) {</span>
<a href="#l73.81"></a><span id="l73.81" class="difflineplus">+    while (split[i].includes(&quot;%$^&quot;)) {</span>
<a href="#l73.82"></a><span id="l73.82" class="difflineplus">+      let s = split[i];</span>
<a href="#l73.83"></a><span id="l73.83">       var si = rindex;</span>
<a href="#l73.84"></a><span id="l73.84" class="difflineminus">-      split[i] = s.replace('%$^'+si, repls[si]);</span>
<a href="#l73.85"></a><span id="l73.85" class="difflineplus">+      split[i] = s.replace(&quot;%$^&quot; + si, repls[si]);</span>
<a href="#l73.86"></a><span id="l73.86">       rindex++;</span>
<a href="#l73.87"></a><span id="l73.87">     }</span>
<a href="#l73.88"></a><span id="l73.88">   }</span>
<a href="#l73.89"></a><span id="l73.89">   return split;</span>
<a href="#l73.90"></a><span id="l73.90" class="difflineminus">-}</span>
<a href="#l73.91"></a><span id="l73.91" class="difflineplus">+};</span>
<a href="#l73.92"></a><span id="l73.92"> </span>
<a href="#l73.93"></a><span id="l73.93"> </span>
<a href="#l73.94"></a><span id="l73.94" class="difflineminus">-var ElemBase = function(){</span>
<a href="#l73.95"></a><span id="l73.95" class="difflineplus">+var ElemBase = function() {</span>
<a href="#l73.96"></a><span id="l73.96">   this.isElement = true;</span>
<a href="#l73.97"></a><span id="l73.97" class="difflineminus">-}</span>
<a href="#l73.98"></a><span id="l73.98" class="difflineplus">+};</span>
<a href="#l73.99"></a><span id="l73.99"> ElemBase.prototype.exists = function() {</span>
<a href="#l73.100"></a><span id="l73.100" class="difflineminus">-  if (this.getNode()){ return true; }</span>
<a href="#l73.101"></a><span id="l73.101" class="difflineminus">-  else{ return false; }</span>
<a href="#l73.102"></a><span id="l73.102" class="difflineminus">-}</span>
<a href="#l73.103"></a><span id="l73.103" class="difflineplus">+  return !!this.getNode();</span>
<a href="#l73.104"></a><span id="l73.104" class="difflineplus">+};</span>
<a href="#l73.105"></a><span id="l73.105"> ElemBase.prototype.nodeSearch = function(doc, func, string) {</span>
<a href="#l73.106"></a><span id="l73.106" class="difflineminus">-    var win = doc.defaultView;</span>
<a href="#l73.107"></a><span id="l73.107" class="difflineminus">-    var e = null;</span>
<a href="#l73.108"></a><span id="l73.108" class="difflineminus">-    var element = null;</span>
<a href="#l73.109"></a><span id="l73.109" class="difflineminus">-    //inline function to recursively find the element in the DOM, cross frame.</span>
<a href="#l73.110"></a><span id="l73.110" class="difflineminus">-    var search = function(win, func, string) {</span>
<a href="#l73.111"></a><span id="l73.111" class="difflineminus">-     if (win == null)</span>
<a href="#l73.112"></a><span id="l73.112" class="difflineminus">-       return;</span>
<a href="#l73.113"></a><span id="l73.113" class="difflineplus">+  var win = doc.defaultView;</span>
<a href="#l73.114"></a><span id="l73.114" class="difflineplus">+  var e = null;</span>
<a href="#l73.115"></a><span id="l73.115" class="difflineplus">+  var element = null;</span>
<a href="#l73.116"></a><span id="l73.116" class="difflineplus">+  // inline function to recursively find the element in the DOM, cross frame.</span>
<a href="#l73.117"></a><span id="l73.117" class="difflineplus">+  var search = function(win, func, string) {</span>
<a href="#l73.118"></a><span id="l73.118" class="difflineplus">+    if (win == null)</span>
<a href="#l73.119"></a><span id="l73.119" class="difflineplus">+      return;</span>
<a href="#l73.120"></a><span id="l73.120"> </span>
<a href="#l73.121"></a><span id="l73.121" class="difflineminus">-     //do the lookup in the current window</span>
<a href="#l73.122"></a><span id="l73.122" class="difflineminus">-     try {</span>
<a href="#l73.123"></a><span id="l73.123" class="difflineminus">-       element = func.call(win, string);</span>
<a href="#l73.124"></a><span id="l73.124" class="difflineminus">-     }</span>
<a href="#l73.125"></a><span id="l73.125" class="difflineminus">-     catch(err) { }</span>
<a href="#l73.126"></a><span id="l73.126" class="difflineplus">+    // do the lookup in the current window</span>
<a href="#l73.127"></a><span id="l73.127" class="difflineplus">+    try {</span>
<a href="#l73.128"></a><span id="l73.128" class="difflineplus">+      element = func.call(win, string);</span>
<a href="#l73.129"></a><span id="l73.129" class="difflineplus">+    } catch (err) {}</span>
<a href="#l73.130"></a><span id="l73.130"> </span>
<a href="#l73.131"></a><span id="l73.131" class="difflineminus">-      if (!element || (element.length == 0)) {</span>
<a href="#l73.132"></a><span id="l73.132" class="difflineminus">-        var frames = win.frames;</span>
<a href="#l73.133"></a><span id="l73.133" class="difflineminus">-        for (var i=0; i &lt; frames.length; i++) {</span>
<a href="#l73.134"></a><span id="l73.134" class="difflineminus">-          search(frames[i], func, string);</span>
<a href="#l73.135"></a><span id="l73.135" class="difflineminus">-        }</span>
<a href="#l73.136"></a><span id="l73.136" class="difflineminus">-     }</span>
<a href="#l73.137"></a><span id="l73.137" class="difflineminus">-     else { e = element; }</span>
<a href="#l73.138"></a><span id="l73.138" class="difflineminus">-    };</span>
<a href="#l73.139"></a><span id="l73.139" class="difflineplus">+    if (!element || (element.length == 0)) {</span>
<a href="#l73.140"></a><span id="l73.140" class="difflineplus">+      var frames = win.frames;</span>
<a href="#l73.141"></a><span id="l73.141" class="difflineplus">+      for (var i = 0; i &lt; frames.length; i++) {</span>
<a href="#l73.142"></a><span id="l73.142" class="difflineplus">+        search(frames[i], func, string);</span>
<a href="#l73.143"></a><span id="l73.143" class="difflineplus">+      }</span>
<a href="#l73.144"></a><span id="l73.144" class="difflineplus">+    } else {</span>
<a href="#l73.145"></a><span id="l73.145" class="difflineplus">+      e = element;</span>
<a href="#l73.146"></a><span id="l73.146" class="difflineplus">+    }</span>
<a href="#l73.147"></a><span id="l73.147" class="difflineplus">+  };</span>
<a href="#l73.148"></a><span id="l73.148"> </span>
<a href="#l73.149"></a><span id="l73.149" class="difflineminus">-    search(win, func, string);</span>
<a href="#l73.150"></a><span id="l73.150" class="difflineplus">+  search(win, func, string);</span>
<a href="#l73.151"></a><span id="l73.151"> </span>
<a href="#l73.152"></a><span id="l73.152" class="difflineminus">-    return e;</span>
<a href="#l73.153"></a><span id="l73.153" class="difflineminus">-}</span>
<a href="#l73.154"></a><span id="l73.154" class="difflineplus">+  return e;</span>
<a href="#l73.155"></a><span id="l73.155" class="difflineplus">+};</span>
<a href="#l73.156"></a><span id="l73.156"> </span>
<a href="#l73.157"></a><span id="l73.157"> var Elem = function(node) {</span>
<a href="#l73.158"></a><span id="l73.158">   this.node = node;</span>
<a href="#l73.159"></a><span id="l73.159">   return this;</span>
<a href="#l73.160"></a><span id="l73.160" class="difflineminus">-}</span>
<a href="#l73.161"></a><span id="l73.161" class="difflineplus">+};</span>
<a href="#l73.162"></a><span id="l73.162"> Elem.prototype = new utils.Copy(ElemBase.prototype);</span>
<a href="#l73.163"></a><span id="l73.163" class="difflineminus">-Elem.prototype.getNode = function () { return this.node; };</span>
<a href="#l73.164"></a><span id="l73.164" class="difflineminus">-Elem.prototype.getInfo = function () { return 'Elem instance.'; };</span>
<a href="#l73.165"></a><span id="l73.165" class="difflineplus">+Elem.prototype.getNode = function() {</span>
<a href="#l73.166"></a><span id="l73.166" class="difflineplus">+  return this.node;</span>
<a href="#l73.167"></a><span id="l73.167" class="difflineplus">+};</span>
<a href="#l73.168"></a><span id="l73.168" class="difflineplus">+Elem.prototype.getInfo = function() {</span>
<a href="#l73.169"></a><span id="l73.169" class="difflineplus">+  return &quot;Elem instance.&quot;;</span>
<a href="#l73.170"></a><span id="l73.170" class="difflineplus">+};</span>
<a href="#l73.171"></a><span id="l73.171"> </span>
<a href="#l73.172"></a><span id="l73.172"> </span>
<a href="#l73.173"></a><span id="l73.173"> var Selector = function(_document, selector) {</span>
<a href="#l73.174"></a><span id="l73.174">   if (_document == undefined || selector == undefined) {</span>
<a href="#l73.175"></a><span id="l73.175" class="difflineminus">-    throw new Error('Selector constructor did not receive enough arguments.');</span>
<a href="#l73.176"></a><span id="l73.176" class="difflineplus">+    throw new Error(&quot;Selector constructor did not receive enough arguments.&quot;);</span>
<a href="#l73.177"></a><span id="l73.177">   }</span>
<a href="#l73.178"></a><span id="l73.178">   this._view = _document.defaultView;</span>
<a href="#l73.179"></a><span id="l73.179">   this.selector = selector;</span>
<a href="#l73.180"></a><span id="l73.180">   return this;</span>
<a href="#l73.181"></a><span id="l73.181" class="difflineminus">-}</span>
<a href="#l73.182"></a><span id="l73.182" class="difflineplus">+};</span>
<a href="#l73.183"></a><span id="l73.183"> Selector.prototype = new utils.Copy(ElemBase.prototype);</span>
<a href="#l73.184"></a><span id="l73.184" class="difflineminus">-Selector.prototype.getInfo = function () {</span>
<a href="#l73.185"></a><span id="l73.185" class="difflineplus">+Selector.prototype.getInfo = function() {</span>
<a href="#l73.186"></a><span id="l73.186">   return &quot;Selector: &quot; + this.selector;</span>
<a href="#l73.187"></a><span id="l73.187" class="difflineminus">-}</span>
<a href="#l73.188"></a><span id="l73.188" class="difflineminus">-Selector.prototype.getNodeForDocument = function (s) {</span>
<a href="#l73.189"></a><span id="l73.189" class="difflineplus">+};</span>
<a href="#l73.190"></a><span id="l73.190" class="difflineplus">+Selector.prototype.getNodeForDocument = function(s) {</span>
<a href="#l73.191"></a><span id="l73.191">   return this.document.querySelectorAll(s);</span>
<a href="#l73.192"></a><span id="l73.192" class="difflineminus">-}</span>
<a href="#l73.193"></a><span id="l73.193" class="difflineminus">-Selector.prototype.getNode = function (index) {</span>
<a href="#l73.194"></a><span id="l73.194" class="difflineplus">+};</span>
<a href="#l73.195"></a><span id="l73.195" class="difflineplus">+Selector.prototype.getNode = function(index) {</span>
<a href="#l73.196"></a><span id="l73.196">   var nodes = this.nodeSearch(this._view.document, this.getNodeForDocument, this.selector);</span>
<a href="#l73.197"></a><span id="l73.197">   return nodes ? nodes[index || 0] : null;</span>
<a href="#l73.198"></a><span id="l73.198" class="difflineminus">-}</span>
<a href="#l73.199"></a><span id="l73.199" class="difflineplus">+};</span>
<a href="#l73.200"></a><span id="l73.200"> </span>
<a href="#l73.201"></a><span id="l73.201"> </span>
<a href="#l73.202"></a><span id="l73.202"> var ID = function(_document, nodeID) {</span>
<a href="#l73.203"></a><span id="l73.203">   if (_document == undefined || nodeID == undefined) {</span>
<a href="#l73.204"></a><span id="l73.204" class="difflineminus">-    throw new Error('ID constructor did not receive enough arguments.');</span>
<a href="#l73.205"></a><span id="l73.205" class="difflineplus">+    throw new Error(&quot;ID constructor did not receive enough arguments.&quot;);</span>
<a href="#l73.206"></a><span id="l73.206">   }</span>
<a href="#l73.207"></a><span id="l73.207">   this._view = _document.defaultView;</span>
<a href="#l73.208"></a><span id="l73.208">   this.nodeID = nodeID;</span>
<a href="#l73.209"></a><span id="l73.209">   return this;</span>
<a href="#l73.210"></a><span id="l73.210" class="difflineminus">-}</span>
<a href="#l73.211"></a><span id="l73.211" class="difflineplus">+};</span>
<a href="#l73.212"></a><span id="l73.212"> ID.prototype = new utils.Copy(ElemBase.prototype);</span>
<a href="#l73.213"></a><span id="l73.213" class="difflineminus">-ID.prototype.getInfo = function () {</span>
<a href="#l73.214"></a><span id="l73.214" class="difflineplus">+ID.prototype.getInfo = function() {</span>
<a href="#l73.215"></a><span id="l73.215">   return &quot;ID: &quot; + this.nodeID;</span>
<a href="#l73.216"></a><span id="l73.216" class="difflineminus">-}</span>
<a href="#l73.217"></a><span id="l73.217" class="difflineminus">-ID.prototype.getNodeForDocument = function (s) {</span>
<a href="#l73.218"></a><span id="l73.218" class="difflineplus">+};</span>
<a href="#l73.219"></a><span id="l73.219" class="difflineplus">+ID.prototype.getNodeForDocument = function(s) {</span>
<a href="#l73.220"></a><span id="l73.220">   return this.document.getElementById(s);</span>
<a href="#l73.221"></a><span id="l73.221" class="difflineminus">-}</span>
<a href="#l73.222"></a><span id="l73.222" class="difflineminus">-ID.prototype.getNode = function () {</span>
<a href="#l73.223"></a><span id="l73.223" class="difflineplus">+};</span>
<a href="#l73.224"></a><span id="l73.224" class="difflineplus">+ID.prototype.getNode = function() {</span>
<a href="#l73.225"></a><span id="l73.225">   return this.nodeSearch(this._view.document, this.getNodeForDocument, this.nodeID);</span>
<a href="#l73.226"></a><span id="l73.226" class="difflineminus">-}</span>
<a href="#l73.227"></a><span id="l73.227" class="difflineplus">+};</span>
<a href="#l73.228"></a><span id="l73.228"> </span>
<a href="#l73.229"></a><span id="l73.229"> var Link = function(_document, linkName) {</span>
<a href="#l73.230"></a><span id="l73.230">   if (_document == undefined || linkName == undefined) {</span>
<a href="#l73.231"></a><span id="l73.231" class="difflineminus">-    throw new Error('Link constructor did not receive enough arguments.');</span>
<a href="#l73.232"></a><span id="l73.232" class="difflineplus">+    throw new Error(&quot;Link constructor did not receive enough arguments.&quot;);</span>
<a href="#l73.233"></a><span id="l73.233">   }</span>
<a href="#l73.234"></a><span id="l73.234">   this._view = _document.defaultView;</span>
<a href="#l73.235"></a><span id="l73.235">   this.linkName = linkName;</span>
<a href="#l73.236"></a><span id="l73.236">   return this;</span>
<a href="#l73.237"></a><span id="l73.237" class="difflineminus">-}</span>
<a href="#l73.238"></a><span id="l73.238" class="difflineplus">+};</span>
<a href="#l73.239"></a><span id="l73.239"> Link.prototype = new utils.Copy(ElemBase.prototype);</span>
<a href="#l73.240"></a><span id="l73.240" class="difflineminus">-Link.prototype.getInfo = function () {</span>
<a href="#l73.241"></a><span id="l73.241" class="difflineplus">+Link.prototype.getInfo = function() {</span>
<a href="#l73.242"></a><span id="l73.242">   return &quot;Link: &quot; + this.linkName;</span>
<a href="#l73.243"></a><span id="l73.243" class="difflineminus">-}</span>
<a href="#l73.244"></a><span id="l73.244" class="difflineminus">-Link.prototype.getNodeForDocument = function (linkName) {</span>
<a href="#l73.245"></a><span id="l73.245" class="difflineminus">-  var getText = function(el){</span>
<a href="#l73.246"></a><span id="l73.246" class="difflineminus">-    var text = &quot;&quot;;</span>
<a href="#l73.247"></a><span id="l73.247" class="difflineminus">-    if (el.nodeType == 3){ //textNode</span>
<a href="#l73.248"></a><span id="l73.248" class="difflineminus">-      if (el.data != undefined){</span>
<a href="#l73.249"></a><span id="l73.249" class="difflineminus">-        text = el.data;</span>
<a href="#l73.250"></a><span id="l73.250" class="difflineminus">-      }</span>
<a href="#l73.251"></a><span id="l73.251" class="difflineminus">-      else{ text = el.innerHTML; }</span>
<a href="#l73.252"></a><span id="l73.252" class="difflineminus">-      text = text.replace(/n|r|t/g, &quot; &quot;);</span>
<a href="#l73.253"></a><span id="l73.253" class="difflineminus">-    }</span>
<a href="#l73.254"></a><span id="l73.254" class="difflineminus">-    if (el.nodeType == 1){ //elementNode</span>
<a href="#l73.255"></a><span id="l73.255" class="difflineminus">-        for (var i = 0; i &lt; el.childNodes.length; i++) {</span>
<a href="#l73.256"></a><span id="l73.256" class="difflineminus">-            var child = el.childNodes.item(i);</span>
<a href="#l73.257"></a><span id="l73.257" class="difflineminus">-            text += getText(child);</span>
<a href="#l73.258"></a><span id="l73.258" class="difflineminus">-        }</span>
<a href="#l73.259"></a><span id="l73.259" class="difflineminus">-        if (el.tagName == &quot;P&quot; || el.tagName == &quot;BR&quot; ||</span>
<a href="#l73.260"></a><span id="l73.260" class="difflineminus">-          el.tagName == &quot;HR&quot; || el.tagName == &quot;DIV&quot;) {</span>
<a href="#l73.261"></a><span id="l73.261" class="difflineminus">-          text += &quot;n&quot;;</span>
<a href="#l73.262"></a><span id="l73.262" class="difflineminus">-        }</span>
<a href="#l73.263"></a><span id="l73.263" class="difflineminus">-    }</span>
<a href="#l73.264"></a><span id="l73.264" class="difflineminus">-    return text;</span>
<a href="#l73.265"></a><span id="l73.265" class="difflineminus">-  }</span>
<a href="#l73.266"></a><span id="l73.266" class="difflineminus">-</span>
<a href="#l73.267"></a><span id="l73.267" class="difflineminus">-  //sometimes the windows won't have this function</span>
<a href="#l73.268"></a><span id="l73.268" class="difflineminus">-  try { var links = this.document.getElementsByTagName('a'); }</span>
<a href="#l73.269"></a><span id="l73.269" class="difflineminus">-  catch(err){ // ADD LOG LINE mresults.write('Error: '+ err, 'lightred');</span>
<a href="#l73.270"></a><span id="l73.270" class="difflineplus">+};</span>
<a href="#l73.271"></a><span id="l73.271" class="difflineplus">+Link.prototype.getNodeForDocument = function(linkName) {</span>
<a href="#l73.272"></a><span id="l73.272" class="difflineplus">+  // sometimes the windows won't have this function</span>
<a href="#l73.273"></a><span id="l73.273" class="difflineplus">+  try {</span>
<a href="#l73.274"></a><span id="l73.274" class="difflineplus">+    var links = this.document.getElementsByTagName(&quot;a&quot;);</span>
<a href="#l73.275"></a><span id="l73.275" class="difflineplus">+  } catch (err) { // ADD LOG LINE mresults.write('Error: '+ err, 'lightred');</span>
<a href="#l73.276"></a><span id="l73.276">   }</span>
<a href="#l73.277"></a><span id="l73.277">   for (var i = 0; i &lt; links.length; i++) {</span>
<a href="#l73.278"></a><span id="l73.278">     var el = links[i];</span>
<a href="#l73.279"></a><span id="l73.279" class="difflineminus">-    //if (getText(el).indexOf(this.linkName) != -1) {</span>
<a href="#l73.280"></a><span id="l73.280" class="difflineminus">-    if (el.innerHTML.indexOf(linkName) != -1){</span>
<a href="#l73.281"></a><span id="l73.281" class="difflineplus">+    if (el.innerHTML.includes(linkName)) {</span>
<a href="#l73.282"></a><span id="l73.282">       return el;</span>
<a href="#l73.283"></a><span id="l73.283">     }</span>
<a href="#l73.284"></a><span id="l73.284">   }</span>
<a href="#l73.285"></a><span id="l73.285">   return null;</span>
<a href="#l73.286"></a><span id="l73.286" class="difflineminus">-}</span>
<a href="#l73.287"></a><span id="l73.287" class="difflineplus">+};</span>
<a href="#l73.288"></a><span id="l73.288"> </span>
<a href="#l73.289"></a><span id="l73.289" class="difflineminus">-Link.prototype.getNode = function () {</span>
<a href="#l73.290"></a><span id="l73.290" class="difflineplus">+Link.prototype.getNode = function() {</span>
<a href="#l73.291"></a><span id="l73.291">   return this.nodeSearch(this._view.document, this.getNodeForDocument, this.linkName);</span>
<a href="#l73.292"></a><span id="l73.292" class="difflineminus">-}</span>
<a href="#l73.293"></a><span id="l73.293" class="difflineplus">+};</span>
<a href="#l73.294"></a><span id="l73.294"> </span>
<a href="#l73.295"></a><span id="l73.295"> var XPath = function(_document, expr) {</span>
<a href="#l73.296"></a><span id="l73.296">   if (_document == undefined || expr == undefined) {</span>
<a href="#l73.297"></a><span id="l73.297" class="difflineminus">-    throw new Error('XPath constructor did not receive enough arguments.');</span>
<a href="#l73.298"></a><span id="l73.298" class="difflineplus">+    throw new Error(&quot;XPath constructor did not receive enough arguments.&quot;);</span>
<a href="#l73.299"></a><span id="l73.299">   }</span>
<a href="#l73.300"></a><span id="l73.300">   this._view = _document.defaultView;</span>
<a href="#l73.301"></a><span id="l73.301">   this.expr = expr;</span>
<a href="#l73.302"></a><span id="l73.302">   return this;</span>
<a href="#l73.303"></a><span id="l73.303" class="difflineminus">-}</span>
<a href="#l73.304"></a><span id="l73.304" class="difflineplus">+};</span>
<a href="#l73.305"></a><span id="l73.305"> XPath.prototype = new utils.Copy(ElemBase.prototype);</span>
<a href="#l73.306"></a><span id="l73.306" class="difflineminus">-XPath.prototype.getInfo = function () {</span>
<a href="#l73.307"></a><span id="l73.307" class="difflineplus">+XPath.prototype.getInfo = function() {</span>
<a href="#l73.308"></a><span id="l73.308">   return &quot;XPath: &quot; + this.expr;</span>
<a href="#l73.309"></a><span id="l73.309" class="difflineminus">-}</span>
<a href="#l73.310"></a><span id="l73.310" class="difflineminus">-XPath.prototype.getNodeForDocument = function (s) {</span>
<a href="#l73.311"></a><span id="l73.311" class="difflineplus">+};</span>
<a href="#l73.312"></a><span id="l73.312" class="difflineplus">+XPath.prototype.getNodeForDocument = function(s) {</span>
<a href="#l73.313"></a><span id="l73.313">   var aNode = this.document;</span>
<a href="#l73.314"></a><span id="l73.314">   var aExpr = s;</span>
<a href="#l73.315"></a><span id="l73.315">   var xpe = null;</span>
<a href="#l73.316"></a><span id="l73.316"> </span>
<a href="#l73.317"></a><span id="l73.317">   if (this.document.defaultView == null) {</span>
<a href="#l73.318"></a><span id="l73.318" class="difflineminus">-    xpe = new getMethodInWindows('XPathEvaluator')();</span>
<a href="#l73.319"></a><span id="l73.319" class="difflineplus">+    xpe = new utils.getMethodInWindows(&quot;XPathEvaluator&quot;)();</span>
<a href="#l73.320"></a><span id="l73.320">   } else {</span>
<a href="#l73.321"></a><span id="l73.321">     xpe = new this.document.defaultView.XPathEvaluator();</span>
<a href="#l73.322"></a><span id="l73.322">   }</span>
<a href="#l73.323"></a><span id="l73.323">   var nsResolver = xpe.createNSResolver(aNode.ownerDocument == null ?</span>
<a href="#l73.324"></a><span id="l73.324">     aNode.documentElement : aNode.ownerDocument.documentElement);</span>
<a href="#l73.325"></a><span id="l73.325">   var result = xpe.evaluate(aExpr, aNode, nsResolver, 0, null);</span>
<a href="#l73.326"></a><span id="l73.326">   var found = [];</span>
<a href="#l73.327"></a><span id="l73.327" class="difflineminus">-  var res;</span>
<a href="#l73.328"></a><span id="l73.328" class="difflineminus">-  while (res = result.iterateNext())</span>
<a href="#l73.329"></a><span id="l73.329" class="difflineplus">+  var res = result.iterateNext();</span>
<a href="#l73.330"></a><span id="l73.330" class="difflineplus">+  while (res) {</span>
<a href="#l73.331"></a><span id="l73.331">     found.push(res);</span>
<a href="#l73.332"></a><span id="l73.332" class="difflineplus">+    res = result.iterateNext();</span>
<a href="#l73.333"></a><span id="l73.333" class="difflineplus">+  }</span>
<a href="#l73.334"></a><span id="l73.334">   return found[0];</span>
<a href="#l73.335"></a><span id="l73.335" class="difflineminus">-}</span>
<a href="#l73.336"></a><span id="l73.336" class="difflineplus">+};</span>
<a href="#l73.337"></a><span id="l73.337"> </span>
<a href="#l73.338"></a><span id="l73.338" class="difflineminus">-XPath.prototype.getNode = function () {</span>
<a href="#l73.339"></a><span id="l73.339" class="difflineplus">+XPath.prototype.getNode = function() {</span>
<a href="#l73.340"></a><span id="l73.340">   return this.nodeSearch(this._view.document, this.getNodeForDocument, this.expr);</span>
<a href="#l73.341"></a><span id="l73.341" class="difflineminus">-}</span>
<a href="#l73.342"></a><span id="l73.342" class="difflineplus">+};</span>
<a href="#l73.343"></a><span id="l73.343"> </span>
<a href="#l73.344"></a><span id="l73.344"> var Name = function(_document, nName) {</span>
<a href="#l73.345"></a><span id="l73.345">   if (_document == undefined || nName == undefined) {</span>
<a href="#l73.346"></a><span id="l73.346" class="difflineminus">-    throw new Error('Name constructor did not receive enough arguments.');</span>
<a href="#l73.347"></a><span id="l73.347" class="difflineplus">+    throw new Error(&quot;Name constructor did not receive enough arguments.&quot;);</span>
<a href="#l73.348"></a><span id="l73.348">   }</span>
<a href="#l73.349"></a><span id="l73.349">   this._view = _document.defaultView;</span>
<a href="#l73.350"></a><span id="l73.350">   this.nName = nName;</span>
<a href="#l73.351"></a><span id="l73.351">   return this;</span>
<a href="#l73.352"></a><span id="l73.352" class="difflineminus">-}</span>
<a href="#l73.353"></a><span id="l73.353" class="difflineplus">+};</span>
<a href="#l73.354"></a><span id="l73.354"> Name.prototype = new utils.Copy(ElemBase.prototype);</span>
<a href="#l73.355"></a><span id="l73.355" class="difflineminus">-Name.prototype.getInfo = function () {</span>
<a href="#l73.356"></a><span id="l73.356" class="difflineplus">+Name.prototype.getInfo = function() {</span>
<a href="#l73.357"></a><span id="l73.357">   return &quot;Name: &quot; + this.nName;</span>
<a href="#l73.358"></a><span id="l73.358" class="difflineminus">-}</span>
<a href="#l73.359"></a><span id="l73.359" class="difflineminus">-Name.prototype.getNodeForDocument = function (s) {</span>
<a href="#l73.360"></a><span id="l73.360" class="difflineminus">-  try{</span>
<a href="#l73.361"></a><span id="l73.361" class="difflineplus">+};</span>
<a href="#l73.362"></a><span id="l73.362" class="difflineplus">+Name.prototype.getNodeForDocument = function(s) {</span>
<a href="#l73.363"></a><span id="l73.363" class="difflineplus">+  try {</span>
<a href="#l73.364"></a><span id="l73.364">     var els = this.document.getElementsByName(s);</span>
<a href="#l73.365"></a><span id="l73.365" class="difflineminus">-    if (els.length &gt; 0) { return els[0]; }</span>
<a href="#l73.366"></a><span id="l73.366" class="difflineminus">-  }</span>
<a href="#l73.367"></a><span id="l73.367" class="difflineminus">-  catch(err){};</span>
<a href="#l73.368"></a><span id="l73.368" class="difflineplus">+    if (els.length &gt; 0) {</span>
<a href="#l73.369"></a><span id="l73.369" class="difflineplus">+      return els[0];</span>
<a href="#l73.370"></a><span id="l73.370" class="difflineplus">+    }</span>
<a href="#l73.371"></a><span id="l73.371" class="difflineplus">+  } catch (err) {}</span>
<a href="#l73.372"></a><span id="l73.372">   return null;</span>
<a href="#l73.373"></a><span id="l73.373" class="difflineminus">-}</span>
<a href="#l73.374"></a><span id="l73.374" class="difflineplus">+};</span>
<a href="#l73.375"></a><span id="l73.375"> </span>
<a href="#l73.376"></a><span id="l73.376" class="difflineminus">-Name.prototype.getNode = function () {</span>
<a href="#l73.377"></a><span id="l73.377" class="difflineplus">+Name.prototype.getNode = function() {</span>
<a href="#l73.378"></a><span id="l73.378">   return this.nodeSearch(this._view.document, this.getNodeForDocument, this.nName);</span>
<a href="#l73.379"></a><span id="l73.379" class="difflineminus">-}</span>
<a href="#l73.380"></a><span id="l73.380" class="difflineplus">+};</span>
<a href="#l73.381"></a><span id="l73.381"> </span>
<a href="#l73.382"></a><span id="l73.382"> </span>
<a href="#l73.383"></a><span id="l73.383" class="difflineminus">-function Lookup (_document, expression) {</span>
<a href="#l73.384"></a><span id="l73.384" class="difflineplus">+function Lookup(_document, expression) {</span>
<a href="#l73.385"></a><span id="l73.385">   if (_document == undefined || expression == undefined) {</span>
<a href="#l73.386"></a><span id="l73.386" class="difflineminus">-    throw new Error('Lookup constructor did not receive enough arguments.');</span>
<a href="#l73.387"></a><span id="l73.387" class="difflineplus">+    throw new Error(&quot;Lookup constructor did not receive enough arguments.&quot;);</span>
<a href="#l73.388"></a><span id="l73.388">   }</span>
<a href="#l73.389"></a><span id="l73.389">   this._view = _document.defaultView;</span>
<a href="#l73.390"></a><span id="l73.390">   this.expression = expression;</span>
<a href="#l73.391"></a><span id="l73.391"> }</span>
<a href="#l73.392"></a><span id="l73.392"> Lookup.prototype = new utils.Copy(ElemBase.prototype);</span>
<a href="#l73.393"></a><span id="l73.393" class="difflineminus">-var _returnResult = function (results) {</span>
<a href="#l73.394"></a><span id="l73.394" class="difflineplus">+var _returnResult = function(results) {</span>
<a href="#l73.395"></a><span id="l73.395">   if (results.length == 0) {</span>
<a href="#l73.396"></a><span id="l73.396" class="difflineminus">-    return null</span>
<a href="#l73.397"></a><span id="l73.397" class="difflineplus">+    return null;</span>
<a href="#l73.398"></a><span id="l73.398">   } else if (results.length == 1) {</span>
<a href="#l73.399"></a><span id="l73.399">     return results[0];</span>
<a href="#l73.400"></a><span id="l73.400" class="difflineminus">-  } else {</span>
<a href="#l73.401"></a><span id="l73.401" class="difflineminus">-    return results;</span>
<a href="#l73.402"></a><span id="l73.402">   }</span>
<a href="#l73.403"></a><span id="l73.403" class="difflineminus">-}</span>
<a href="#l73.404"></a><span id="l73.404" class="difflineminus">-var _forChildren = function (element, name, value) {</span>
<a href="#l73.405"></a><span id="l73.405" class="difflineplus">+  return results;</span>
<a href="#l73.406"></a><span id="l73.406" class="difflineplus">+};</span>
<a href="#l73.407"></a><span id="l73.407" class="difflineplus">+var _forChildren = function(element, name, value) {</span>
<a href="#l73.408"></a><span id="l73.408">   var results = [];</span>
<a href="#l73.409"></a><span id="l73.409">   var nodes = Array.from(element.childNodes).filter(e =&gt; e);</span>
<a href="#l73.410"></a><span id="l73.410">   for (var i in nodes) {</span>
<a href="#l73.411"></a><span id="l73.411">     var n = nodes[i];</span>
<a href="#l73.412"></a><span id="l73.412">     if (n[name] == value) {</span>
<a href="#l73.413"></a><span id="l73.413">       results.push(n);</span>
<a href="#l73.414"></a><span id="l73.414">     }</span>
<a href="#l73.415"></a><span id="l73.415">   }</span>
<a href="#l73.416"></a><span id="l73.416">   return results;</span>
<a href="#l73.417"></a><span id="l73.417" class="difflineminus">-}</span>
<a href="#l73.418"></a><span id="l73.418" class="difflineminus">-var _forAnonChildren = function (_document, element, name, value) {</span>
<a href="#l73.419"></a><span id="l73.419" class="difflineplus">+};</span>
<a href="#l73.420"></a><span id="l73.420" class="difflineplus">+var _forAnonChildren = function(_document, element, name, value) {</span>
<a href="#l73.421"></a><span id="l73.421">   var results = [];</span>
<a href="#l73.422"></a><span id="l73.422">   var nodes = Array.from(_document.getAnonymousNodes(element) || []).filter(e =&gt; e);</span>
<a href="#l73.423"></a><span id="l73.423" class="difflineminus">-  for (var i in nodes ) {</span>
<a href="#l73.424"></a><span id="l73.424" class="difflineplus">+  for (var i in nodes) {</span>
<a href="#l73.425"></a><span id="l73.425">     var n = nodes[i];</span>
<a href="#l73.426"></a><span id="l73.426">     if (n[name] == value) {</span>
<a href="#l73.427"></a><span id="l73.427">       results.push(n);</span>
<a href="#l73.428"></a><span id="l73.428">     }</span>
<a href="#l73.429"></a><span id="l73.429">   }</span>
<a href="#l73.430"></a><span id="l73.430">   return results;</span>
<a href="#l73.431"></a><span id="l73.431" class="difflineminus">-}</span>
<a href="#l73.432"></a><span id="l73.432" class="difflineminus">-var _byID = function (_document, parent, value) {</span>
<a href="#l73.433"></a><span id="l73.433" class="difflineminus">-  return _returnResult(_forChildren(parent, 'id', value));</span>
<a href="#l73.434"></a><span id="l73.434" class="difflineminus">-}</span>
<a href="#l73.435"></a><span id="l73.435" class="difflineminus">-var _byName = function (_document, parent, value) {</span>
<a href="#l73.436"></a><span id="l73.436" class="difflineminus">-  return _returnResult(_forChildren(parent, 'tagName', value));</span>
<a href="#l73.437"></a><span id="l73.437" class="difflineminus">-}</span>
<a href="#l73.438"></a><span id="l73.438" class="difflineminus">-var _byAttrib = function (parent, attributes) {</span>
<a href="#l73.439"></a><span id="l73.439" class="difflineplus">+};</span>
<a href="#l73.440"></a><span id="l73.440" class="difflineplus">+var _byID = function(_document, parent, value) {</span>
<a href="#l73.441"></a><span id="l73.441" class="difflineplus">+  return _returnResult(_forChildren(parent, &quot;id&quot;, value));</span>
<a href="#l73.442"></a><span id="l73.442" class="difflineplus">+};</span>
<a href="#l73.443"></a><span id="l73.443" class="difflineplus">+var _byName = function(_document, parent, value) {</span>
<a href="#l73.444"></a><span id="l73.444" class="difflineplus">+  return _returnResult(_forChildren(parent, &quot;tagName&quot;, value));</span>
<a href="#l73.445"></a><span id="l73.445" class="difflineplus">+};</span>
<a href="#l73.446"></a><span id="l73.446" class="difflineplus">+var _byAttrib = function(parent, attributes) {</span>
<a href="#l73.447"></a><span id="l73.447">   var results = [];</span>
<a href="#l73.448"></a><span id="l73.448"> </span>
<a href="#l73.449"></a><span id="l73.449">   var nodes = parent.childNodes;</span>
<a href="#l73.450"></a><span id="l73.450">   for (var i in nodes) {</span>
<a href="#l73.451"></a><span id="l73.451">     var n = nodes[i];</span>
<a href="#l73.452"></a><span id="l73.452">     var requirementPass = 0;</span>
<a href="#l73.453"></a><span id="l73.453">     var requirementLength = 0;</span>
<a href="#l73.454"></a><span id="l73.454">     for (var a in attributes) {</span>
<a href="#l73.455"></a><span id="l73.455" class="difflineat">@@ -355,148 +335,147 @@ var _byAttrib = function (parent, attrib</span>
<a href="#l73.456"></a><span id="l73.456">       } catch (err) {</span>
<a href="#l73.457"></a><span id="l73.457">         // Workaround any bugs in custom attribute crap in XUL elements</span>
<a href="#l73.458"></a><span id="l73.458">       }</span>
<a href="#l73.459"></a><span id="l73.459">     }</span>
<a href="#l73.460"></a><span id="l73.460">     if (requirementPass == requirementLength) {</span>
<a href="#l73.461"></a><span id="l73.461">       results.push(n);</span>
<a href="#l73.462"></a><span id="l73.462">     }</span>
<a href="#l73.463"></a><span id="l73.463">   }</span>
<a href="#l73.464"></a><span id="l73.464" class="difflineminus">-  if (results.length == 0) {</span>
<a href="#l73.465"></a><span id="l73.465" class="difflineminus">-  }</span>
<a href="#l73.466"></a><span id="l73.466" class="difflineminus">-  return _returnResult(results)</span>
<a href="#l73.467"></a><span id="l73.467" class="difflineminus">-}</span>
<a href="#l73.468"></a><span id="l73.468" class="difflineminus">-var _byAnonAttrib = function (_document, parent, attributes) {</span>
<a href="#l73.469"></a><span id="l73.469" class="difflineplus">+  return _returnResult(results);</span>
<a href="#l73.470"></a><span id="l73.470" class="difflineplus">+};</span>
<a href="#l73.471"></a><span id="l73.471" class="difflineplus">+var _byAnonAttrib = function(_document, parent, attributes) {</span>
<a href="#l73.472"></a><span id="l73.472">   var results = [];</span>
<a href="#l73.473"></a><span id="l73.473"> </span>
<a href="#l73.474"></a><span id="l73.474" class="difflineminus">-  if (objects.getLength(attributes) == 1) {</span>
<a href="#l73.475"></a><span id="l73.475" class="difflineminus">-    for (var i in attributes) {var k = i; var v = attributes[i]; }</span>
<a href="#l73.476"></a><span id="l73.476" class="difflineminus">-    var result = _document.getAnonymousElementByAttribute(parent, k, v)</span>
<a href="#l73.477"></a><span id="l73.477" class="difflineplus">+  if (Object.keys(attributes).length == 1) {</span>
<a href="#l73.478"></a><span id="l73.478" class="difflineplus">+    for (var i in attributes) {</span>
<a href="#l73.479"></a><span id="l73.479" class="difflineplus">+      var k = i; var v = attributes[i];</span>
<a href="#l73.480"></a><span id="l73.480" class="difflineplus">+    }</span>
<a href="#l73.481"></a><span id="l73.481" class="difflineplus">+    var result = _document.getAnonymousElementByAttribute(parent, k, v);</span>
<a href="#l73.482"></a><span id="l73.482">     if (result) {</span>
<a href="#l73.483"></a><span id="l73.483">       return result;</span>
<a href="#l73.484"></a><span id="l73.484" class="difflineminus">-</span>
<a href="#l73.485"></a><span id="l73.485">     }</span>
<a href="#l73.486"></a><span id="l73.486">   }</span>
<a href="#l73.487"></a><span id="l73.487">   var nodes = Array.from(_document.getAnonymousNodes(parent) || []).filter(n =&gt; n.getAttribute);</span>
<a href="#l73.488"></a><span id="l73.488" class="difflineminus">-  function resultsForNodes (nodes) {</span>
<a href="#l73.489"></a><span id="l73.489" class="difflineplus">+  function resultsForNodes(nodes) {</span>
<a href="#l73.490"></a><span id="l73.490">     for (var i in nodes) {</span>
<a href="#l73.491"></a><span id="l73.491">       var n = nodes[i];</span>
<a href="#l73.492"></a><span id="l73.492">       var requirementPass = 0;</span>
<a href="#l73.493"></a><span id="l73.493">       var requirementLength = 0;</span>
<a href="#l73.494"></a><span id="l73.494">       for (var a in attributes) {</span>
<a href="#l73.495"></a><span id="l73.495">         requirementLength++;</span>
<a href="#l73.496"></a><span id="l73.496">         if (n.getAttribute(a) == attributes[a]) {</span>
<a href="#l73.497"></a><span id="l73.497">           requirementPass++;</span>
<a href="#l73.498"></a><span id="l73.498">         }</span>
<a href="#l73.499"></a><span id="l73.499">       }</span>
<a href="#l73.500"></a><span id="l73.500">       if (requirementPass == requirementLength) {</span>
<a href="#l73.501"></a><span id="l73.501">         results.push(n);</span>
<a href="#l73.502"></a><span id="l73.502">       }</span>
<a href="#l73.503"></a><span id="l73.503">     }</span>
<a href="#l73.504"></a><span id="l73.504">   }</span>
<a href="#l73.505"></a><span id="l73.505" class="difflineminus">-  resultsForNodes(nodes)</span>
<a href="#l73.506"></a><span id="l73.506" class="difflineplus">+  resultsForNodes(nodes);</span>
<a href="#l73.507"></a><span id="l73.507">   if (results.length == 0) {</span>
<a href="#l73.508"></a><span id="l73.508">     resultsForNodes(Array.from(parent.childNodes).filter(n =&gt; n != undefined &amp;&amp; n.getAttribute));</span>
<a href="#l73.509"></a><span id="l73.509">   }</span>
<a href="#l73.510"></a><span id="l73.510" class="difflineminus">-  return _returnResult(results)</span>
<a href="#l73.511"></a><span id="l73.511" class="difflineminus">-}</span>
<a href="#l73.512"></a><span id="l73.512" class="difflineminus">-var _byIndex = function (_document, parent, i) {</span>
<a href="#l73.513"></a><span id="l73.513" class="difflineplus">+  return _returnResult(results);</span>
<a href="#l73.514"></a><span id="l73.514" class="difflineplus">+};</span>
<a href="#l73.515"></a><span id="l73.515" class="difflineplus">+var _byIndex = function(_document, parent, i) {</span>
<a href="#l73.516"></a><span id="l73.516">   return parent.childNodes[i];</span>
<a href="#l73.517"></a><span id="l73.517" class="difflineminus">-}</span>
<a href="#l73.518"></a><span id="l73.518" class="difflineminus">-var _anonByName = function (_document, parent, value) {</span>
<a href="#l73.519"></a><span id="l73.519" class="difflineminus">-  return _returnResult(_forAnonChildren(_document, parent, 'tagName', value));</span>
<a href="#l73.520"></a><span id="l73.520" class="difflineminus">-}</span>
<a href="#l73.521"></a><span id="l73.521" class="difflineminus">-var _anonByAttrib = function (_document, parent, value) {</span>
<a href="#l73.522"></a><span id="l73.522" class="difflineplus">+};</span>
<a href="#l73.523"></a><span id="l73.523" class="difflineplus">+var _anonByName = function(_document, parent, value) {</span>
<a href="#l73.524"></a><span id="l73.524" class="difflineplus">+  return _returnResult(_forAnonChildren(_document, parent, &quot;tagName&quot;, value));</span>
<a href="#l73.525"></a><span id="l73.525" class="difflineplus">+};</span>
<a href="#l73.526"></a><span id="l73.526" class="difflineplus">+var _anonByAttrib = function(_document, parent, value) {</span>
<a href="#l73.527"></a><span id="l73.527">   return _byAnonAttrib(_document, parent, value);</span>
<a href="#l73.528"></a><span id="l73.528" class="difflineminus">-}</span>
<a href="#l73.529"></a><span id="l73.529" class="difflineminus">-var _anonByIndex = function (_document, parent, i) {</span>
<a href="#l73.530"></a><span id="l73.530" class="difflineplus">+};</span>
<a href="#l73.531"></a><span id="l73.531" class="difflineplus">+var _anonByIndex = function(_document, parent, i) {</span>
<a href="#l73.532"></a><span id="l73.532">   return _document.getAnonymousNodes(parent)[i];</span>
<a href="#l73.533"></a><span id="l73.533" class="difflineminus">-}</span>
<a href="#l73.534"></a><span id="l73.534" class="difflineplus">+};</span>
<a href="#l73.535"></a><span id="l73.535"> </span>
<a href="#l73.536"></a><span id="l73.536" class="difflineminus">-Lookup.prototype.getInfo = function () {</span>
<a href="#l73.537"></a><span id="l73.537" class="difflineminus">-  return &quot;Lookup: &quot;+ this.expression;</span>
<a href="#l73.538"></a><span id="l73.538" class="difflineminus">-}</span>
<a href="#l73.539"></a><span id="l73.539" class="difflineminus">-Lookup.prototype.exists = function () {</span>
<a href="#l73.540"></a><span id="l73.540" class="difflineplus">+Lookup.prototype.getInfo = function() {</span>
<a href="#l73.541"></a><span id="l73.541" class="difflineplus">+  return &quot;Lookup: &quot; + this.expression;</span>
<a href="#l73.542"></a><span id="l73.542" class="difflineplus">+};</span>
<a href="#l73.543"></a><span id="l73.543" class="difflineplus">+Lookup.prototype.exists = function() {</span>
<a href="#l73.544"></a><span id="l73.544">   try {</span>
<a href="#l73.545"></a><span id="l73.545">     var e = this.getNode();</span>
<a href="#l73.546"></a><span id="l73.546">   } catch (ex) {</span>
<a href="#l73.547"></a><span id="l73.547">     return false;</span>
<a href="#l73.548"></a><span id="l73.548">   }</span>
<a href="#l73.549"></a><span id="l73.549">   if (e) {</span>
<a href="#l73.550"></a><span id="l73.550">     return true;</span>
<a href="#l73.551"></a><span id="l73.551">   }</span>
<a href="#l73.552"></a><span id="l73.552">   return false;</span>
<a href="#l73.553"></a><span id="l73.553" class="difflineminus">-}</span>
<a href="#l73.554"></a><span id="l73.554" class="difflineminus">-Lookup.prototype.getNode = function () {</span>
<a href="#l73.555"></a><span id="l73.555" class="difflineminus">-  var expSplit = smartSplit(this.expression).filter(e =&gt; e != '');</span>
<a href="#l73.556"></a><span id="l73.556" class="difflineminus">-  expSplit.unshift(this._view.document)</span>
<a href="#l73.557"></a><span id="l73.557" class="difflineplus">+};</span>
<a href="#l73.558"></a><span id="l73.558" class="difflineplus">+Lookup.prototype.getNode = function() {</span>
<a href="#l73.559"></a><span id="l73.559" class="difflineplus">+  var expSplit = smartSplit(this.expression).filter(e =&gt; e != &quot;&quot;);</span>
<a href="#l73.560"></a><span id="l73.560" class="difflineplus">+  expSplit.unshift(this._view.document);</span>
<a href="#l73.561"></a><span id="l73.561">   var _document = this._view.document;</span>
<a href="#l73.562"></a><span id="l73.562" class="difflineminus">-  var nCases = {'id':_byID, 'name':_byName, 'attrib':_byAttrib, 'index':_byIndex};</span>
<a href="#l73.563"></a><span id="l73.563" class="difflineminus">-  var aCases = {'name':_anonByName, 'attrib':_anonByAttrib, 'index':_anonByIndex};</span>
<a href="#l73.564"></a><span id="l73.564" class="difflineminus">-  var reduceLookup = function (parent, exp) {</span>
<a href="#l73.565"></a><span id="l73.565" class="difflineplus">+  var nCases = {&quot;id&quot;: _byID, &quot;name&quot;: _byName, &quot;attrib&quot;: _byAttrib, &quot;index&quot;: _byIndex};</span>
<a href="#l73.566"></a><span id="l73.566" class="difflineplus">+  var aCases = {&quot;name&quot;: _anonByName, &quot;attrib&quot;: _anonByAttrib, &quot;index&quot;: _anonByIndex};</span>
<a href="#l73.567"></a><span id="l73.567" class="difflineplus">+  var reduceLookup = function(parent, exp) {</span>
<a href="#l73.568"></a><span id="l73.568">     // Handle case where only index is provided</span>
<a href="#l73.569"></a><span id="l73.569">     var cases = nCases;</span>
<a href="#l73.570"></a><span id="l73.570"> </span>
<a href="#l73.571"></a><span id="l73.571">     // Handle ending index before any of the expression gets mangled</span>
<a href="#l73.572"></a><span id="l73.572" class="difflineminus">-    if (withs.endsWith(exp, ']')) {</span>
<a href="#l73.573"></a><span id="l73.573" class="difflineminus">-      var expIndex = json2.JSON.parse(strings.vslice(exp, '[', ']'));</span>
<a href="#l73.574"></a><span id="l73.574" class="difflineplus">+    if (exp.endsWith(&quot;]&quot;)) {</span>
<a href="#l73.575"></a><span id="l73.575" class="difflineplus">+      var expIndex = JSON.parse(strings.vslice(exp, &quot;[&quot;, &quot;]&quot;));</span>
<a href="#l73.576"></a><span id="l73.576">     }</span>
<a href="#l73.577"></a><span id="l73.577">     // Handle anon</span>
<a href="#l73.578"></a><span id="l73.578" class="difflineminus">-    if (withs.startsWith(exp, 'anon')) {</span>
<a href="#l73.579"></a><span id="l73.579" class="difflineminus">-      var exp = strings.vslice(exp, '(', ')');</span>
<a href="#l73.580"></a><span id="l73.580" class="difflineminus">-      var cases = aCases;</span>
<a href="#l73.581"></a><span id="l73.581" class="difflineplus">+    if (exp.startsWith(&quot;anon&quot;)) {</span>
<a href="#l73.582"></a><span id="l73.582" class="difflineplus">+      exp = strings.vslice(exp, &quot;(&quot;, &quot;)&quot;);</span>
<a href="#l73.583"></a><span id="l73.583" class="difflineplus">+      cases = aCases;</span>
<a href="#l73.584"></a><span id="l73.584">     }</span>
<a href="#l73.585"></a><span id="l73.585" class="difflineminus">-    if (withs.startsWith(exp, '[')) {</span>
<a href="#l73.586"></a><span id="l73.586" class="difflineplus">+    if (exp.startsWith(&quot;[&quot;)) {</span>
<a href="#l73.587"></a><span id="l73.587" class="difflineplus">+      let obj;</span>
<a href="#l73.588"></a><span id="l73.588">       try {</span>
<a href="#l73.589"></a><span id="l73.589" class="difflineminus">-        var obj = json2.JSON.parse(strings.vslice(exp, '[', ']'))</span>
<a href="#l73.590"></a><span id="l73.590" class="difflineplus">+        obj = JSON.parse(strings.vslice(exp, &quot;[&quot;, &quot;]&quot;));</span>
<a href="#l73.591"></a><span id="l73.591">       } catch (err) {</span>
<a href="#l73.592"></a><span id="l73.592" class="difflineminus">-        throw new Error(err+'. String to be parsed was || '+strings.vslice(exp, '[', ']')+' ||');</span>
<a href="#l73.593"></a><span id="l73.593" class="difflineplus">+        throw new Error(err + &quot;. String to be parsed was || &quot; + strings.vslice(exp, &quot;[&quot;, &quot;]&quot;) + &quot; ||&quot;);</span>
<a href="#l73.594"></a><span id="l73.594">       }</span>
<a href="#l73.595"></a><span id="l73.595" class="difflineminus">-      var r = cases['index'](_document, parent, obj);</span>
<a href="#l73.596"></a><span id="l73.596" class="difflineplus">+      var r = cases.index(_document, parent, obj);</span>
<a href="#l73.597"></a><span id="l73.597">       if (r == null) {</span>
<a href="#l73.598"></a><span id="l73.598" class="difflineminus">-        throw new Error('Expression &quot;'+exp+'&quot; returned null. Anonymous == '+(cases == aCases));</span>
<a href="#l73.599"></a><span id="l73.599" class="difflineplus">+        throw new Error('Expression &quot;' + exp + '&quot; returned null. Anonymous == ' + (cases == aCases));</span>
<a href="#l73.600"></a><span id="l73.600">       }</span>
<a href="#l73.601"></a><span id="l73.601">       return r;</span>
<a href="#l73.602"></a><span id="l73.602">     }</span>
<a href="#l73.603"></a><span id="l73.603"> </span>
<a href="#l73.604"></a><span id="l73.604">     for (var c in cases) {</span>
<a href="#l73.605"></a><span id="l73.605" class="difflineminus">-      if (withs.startsWith(exp, c)) {</span>
<a href="#l73.606"></a><span id="l73.606" class="difflineplus">+      if (exp.startsWith(c)) {</span>
<a href="#l73.607"></a><span id="l73.607" class="difflineplus">+        let obj;</span>
<a href="#l73.608"></a><span id="l73.608">         try {</span>
<a href="#l73.609"></a><span id="l73.609" class="difflineminus">-          var obj = json2.JSON.parse(strings.vslice(exp, '(', ')'))</span>
<a href="#l73.610"></a><span id="l73.610" class="difflineminus">-        } catch(err) {</span>
<a href="#l73.611"></a><span id="l73.611" class="difflineminus">-           throw new Error(err+'. String to be parsed was || '+strings.vslice(exp, '(', ')')+'  ||');</span>
<a href="#l73.612"></a><span id="l73.612" class="difflineplus">+          obj = JSON.parse(strings.vslice(exp, &quot;(&quot;, &quot;)&quot;));</span>
<a href="#l73.613"></a><span id="l73.613" class="difflineplus">+        } catch (err) {</span>
<a href="#l73.614"></a><span id="l73.614" class="difflineplus">+          throw new Error(err + &quot;. String to be parsed was || &quot; + strings.vslice(exp, &quot;(&quot;, &quot;)&quot;) + &quot;  ||&quot;);</span>
<a href="#l73.615"></a><span id="l73.615">         }</span>
<a href="#l73.616"></a><span id="l73.616">         var result = cases[c](_document, parent, obj);</span>
<a href="#l73.617"></a><span id="l73.617">       }</span>
<a href="#l73.618"></a><span id="l73.618">     }</span>
<a href="#l73.619"></a><span id="l73.619"> </span>
<a href="#l73.620"></a><span id="l73.620">     if (!result) {</span>
<a href="#l73.621"></a><span id="l73.621" class="difflineminus">-      if ( withs.startsWith(exp, '{') ) {</span>
<a href="#l73.622"></a><span id="l73.622" class="difflineplus">+      if (exp.startsWith(&quot;{&quot;)) {</span>
<a href="#l73.623"></a><span id="l73.623" class="difflineplus">+        let obj;</span>
<a href="#l73.624"></a><span id="l73.624">         try {</span>
<a href="#l73.625"></a><span id="l73.625" class="difflineminus">-          var obj = json2.JSON.parse(exp)</span>
<a href="#l73.626"></a><span id="l73.626" class="difflineminus">-        } catch(err) {</span>
<a href="#l73.627"></a><span id="l73.627" class="difflineminus">-          throw new Error(err+'. String to be parsed was || '+exp+' ||');</span>
<a href="#l73.628"></a><span id="l73.628" class="difflineplus">+          obj = JSON.parse(exp);</span>
<a href="#l73.629"></a><span id="l73.629" class="difflineplus">+        } catch (err) {</span>
<a href="#l73.630"></a><span id="l73.630" class="difflineplus">+          throw new Error(err + &quot;. String to be parsed was || &quot; + exp + &quot; ||&quot;);</span>
<a href="#l73.631"></a><span id="l73.631">         }</span>
<a href="#l73.632"></a><span id="l73.632"> </span>
<a href="#l73.633"></a><span id="l73.633">         if (cases == aCases) {</span>
<a href="#l73.634"></a><span id="l73.634" class="difflineminus">-          var result = _anonByAttrib(_document, parent, obj)</span>
<a href="#l73.635"></a><span id="l73.635" class="difflineplus">+          result = _anonByAttrib(_document, parent, obj);</span>
<a href="#l73.636"></a><span id="l73.636">         } else {</span>
<a href="#l73.637"></a><span id="l73.637" class="difflineminus">-          var result = _byAttrib(parent, obj)</span>
<a href="#l73.638"></a><span id="l73.638" class="difflineplus">+          result = _byAttrib(parent, obj);</span>
<a href="#l73.639"></a><span id="l73.639">         }</span>
<a href="#l73.640"></a><span id="l73.640">       }</span>
<a href="#l73.641"></a><span id="l73.641">       if (!result) {</span>
<a href="#l73.642"></a><span id="l73.642" class="difflineminus">-        throw new Error('Expression &quot;'+exp+'&quot; returned null. Anonymous == '+(cases == aCases));</span>
<a href="#l73.643"></a><span id="l73.643" class="difflineplus">+        throw new Error('Expression &quot;' + exp + '&quot; returned null. Anonymous == ' + (cases == aCases));</span>
<a href="#l73.644"></a><span id="l73.644">       }</span>
<a href="#l73.645"></a><span id="l73.645">     }</span>
<a href="#l73.646"></a><span id="l73.646"> </span>
<a href="#l73.647"></a><span id="l73.647">     // Final return</span>
<a href="#l73.648"></a><span id="l73.648">     if (expIndex) {</span>
<a href="#l73.649"></a><span id="l73.649">       // TODO: Check length and raise error</span>
<a href="#l73.650"></a><span id="l73.650">       return result[expIndex];</span>
<a href="#l73.651"></a><span id="l73.651" class="difflineminus">-    } else {</span>
<a href="#l73.652"></a><span id="l73.652" class="difflineminus">-      // TODO: Check length and raise error</span>
<a href="#l73.653"></a><span id="l73.653" class="difflineminus">-      return result;</span>
<a href="#l73.654"></a><span id="l73.654">     }</span>
<a href="#l73.655"></a><span id="l73.655" class="difflineminus">-    // Maybe we should cause an exception here</span>
<a href="#l73.656"></a><span id="l73.656" class="difflineminus">-    return false</span>
<a href="#l73.657"></a><span id="l73.657" class="difflineminus">-  }</span>
<a href="#l73.658"></a><span id="l73.658" class="difflineplus">+    // TODO: Check length and raise error</span>
<a href="#l73.659"></a><span id="l73.659" class="difflineplus">+    return result;</span>
<a href="#l73.660"></a><span id="l73.660" class="difflineplus">+  };</span>
<a href="#l73.661"></a><span id="l73.661">   return expSplit.reduce(reduceLookup);</span>
<a href="#l73.662"></a><span id="l73.662" class="difflineminus">-}</span>
<a href="#l73.663"></a><span id="l73.663" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l74.1"></a><span id="l74.1">rename from mail/test/resources/mozmill/mozmill/extension/content/modules/events.js</span>
<a href="#l74.2"></a><span id="l74.2">rename to mail/test/resources/mozmill/mozmill/extension/content/modules/events.jsm</span>
<a href="#l74.3"></a><span id="l74.3" class="difflineminus">--- a/mail/test/resources/mozmill/mozmill/extension/content/modules/events.js</span>
<a href="#l74.4"></a><span id="l74.4" class="difflineplus">+++ b/mail/test/resources/mozmill/mozmill/extension/content/modules/events.jsm</span>
<a href="#l74.5"></a><span id="l74.5" class="difflineat">@@ -35,21 +35,21 @@</span>
<a href="#l74.6"></a><span id="l74.6"> // the provisions above, a recipient may use your version of this file under</span>
<a href="#l74.7"></a><span id="l74.7"> // the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l74.8"></a><span id="l74.8"> //</span>
<a href="#l74.9"></a><span id="l74.9"> // ***** END LICENSE BLOCK *****</span>
<a href="#l74.10"></a><span id="l74.10"> </span>
<a href="#l74.11"></a><span id="l74.11"> var EXPORTED_SYMBOLS = [&quot;createEventObject&quot;, &quot;triggerEvent&quot;, &quot;getKeyCodeFromKeySequence&quot;,</span>
<a href="#l74.12"></a><span id="l74.12">                         &quot;triggerKeyEvent&quot;, &quot;triggerMouseEvent&quot;, &quot;fakeOpenPopup&quot;];</span>
<a href="#l74.13"></a><span id="l74.13"> </span>
<a href="#l74.14"></a><span id="l74.14" class="difflineminus">-var EventUtils = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/EventUtils.js&quot;)</span>
<a href="#l74.15"></a><span id="l74.15" class="difflineplus">+var EventUtils = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/EventUtils.jsm&quot;);</span>
<a href="#l74.16"></a><span id="l74.16"> </span>
<a href="#l74.17"></a><span id="l74.17" class="difflineminus">-var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.js&quot;);</span>
<a href="#l74.18"></a><span id="l74.18" class="difflineplus">+var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.jsm&quot;);</span>
<a href="#l74.19"></a><span id="l74.19"> </span>
<a href="#l74.20"></a><span id="l74.20" class="difflineminus">-// var logging = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/logging.js&quot;);</span>
<a href="#l74.21"></a><span id="l74.21" class="difflineplus">+// var logging = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/logging.jsm&quot;);</span>
<a href="#l74.22"></a><span id="l74.22"> </span>
<a href="#l74.23"></a><span id="l74.23"> // var eventsLogger = logging.getLogger('eventsLogger');</span>
<a href="#l74.24"></a><span id="l74.24"> </span>
<a href="#l74.25"></a><span id="l74.25"> var createEventObject = function(element, controlKeyDown, altKeyDown, shiftKeyDown, metaKeyDown) {</span>
<a href="#l74.26"></a><span id="l74.26">   var evt = element.ownerDocument.createEventObject();</span>
<a href="#l74.27"></a><span id="l74.27">   evt.shiftKey = shiftKeyDown;</span>
<a href="#l74.28"></a><span id="l74.28">   evt.metaKey = metaKeyDown;</span>
<a href="#l74.29"></a><span id="l74.29">   evt.altKey = altKeyDown;</span>
<a href="#l74.30"></a><span id="l74.30" class="difflineat">@@ -68,66 +68,62 @@ var createEventObject = function(element</span>
<a href="#l74.31"></a><span id="l74.31"> function fakeOpenPopup(aWindow, aPopup) {</span>
<a href="#l74.32"></a><span id="l74.32">   var popupEvent = aWindow.document.createEvent(&quot;MouseEvent&quot;);</span>
<a href="#l74.33"></a><span id="l74.33">   popupEvent.initMouseEvent(&quot;popupshowing&quot;, true, true, aWindow, 0,</span>
<a href="#l74.34"></a><span id="l74.34">                             0, 0, 0, 0, false, false, false, false,</span>
<a href="#l74.35"></a><span id="l74.35">                             0, null);</span>
<a href="#l74.36"></a><span id="l74.36">   aPopup.dispatchEvent(popupEvent);</span>
<a href="#l74.37"></a><span id="l74.37"> }</span>
<a href="#l74.38"></a><span id="l74.38"> </span>
<a href="#l74.39"></a><span id="l74.39" class="difflineminus">-    /* Fire an event in a browser-compatible manner */</span>
<a href="#l74.40"></a><span id="l74.40" class="difflineplus">+/* Fire an event in a browser-compatible manner */</span>
<a href="#l74.41"></a><span id="l74.41"> var triggerEvent = function(element, eventType, canBubble, controlKeyDown, altKeyDown, shiftKeyDown, metaKeyDown) {</span>
<a href="#l74.42"></a><span id="l74.42" class="difflineminus">-  canBubble = (typeof(canBubble) == undefined) ? true: canBubble;</span>
<a href="#l74.43"></a><span id="l74.43" class="difflineminus">-  var evt = element.ownerDocument.createEvent('HTMLEvents');</span>
<a href="#l74.44"></a><span id="l74.44" class="difflineplus">+  canBubble = (typeof(canBubble) == undefined) ? true : canBubble;</span>
<a href="#l74.45"></a><span id="l74.45" class="difflineplus">+  var evt = element.ownerDocument.createEvent(&quot;HTMLEvents&quot;);</span>
<a href="#l74.46"></a><span id="l74.46"> </span>
<a href="#l74.47"></a><span id="l74.47">   evt.shiftKey = shiftKeyDown;</span>
<a href="#l74.48"></a><span id="l74.48">   evt.metaKey = metaKeyDown;</span>
<a href="#l74.49"></a><span id="l74.49">   evt.altKey = altKeyDown;</span>
<a href="#l74.50"></a><span id="l74.50">   evt.ctrlKey = controlKeyDown;</span>
<a href="#l74.51"></a><span id="l74.51"> </span>
<a href="#l74.52"></a><span id="l74.52">   evt.initEvent(eventType, canBubble, true);</span>
<a href="#l74.53"></a><span id="l74.53">   element.dispatchEvent(evt);</span>
<a href="#l74.54"></a><span id="l74.54" class="difflineminus">-</span>
<a href="#l74.55"></a><span id="l74.55"> };</span>
<a href="#l74.56"></a><span id="l74.56"> </span>
<a href="#l74.57"></a><span id="l74.57"> var getKeyCodeFromKeySequence = function(keySequence) {</span>
<a href="#l74.58"></a><span id="l74.58" class="difflineminus">-</span>
<a href="#l74.59"></a><span id="l74.59">   var match = /^\\(\d{1,3})$/.exec(keySequence);</span>
<a href="#l74.60"></a><span id="l74.60">   if (match != null) {</span>
<a href="#l74.61"></a><span id="l74.61" class="difflineminus">-      return match[1];</span>
<a href="#l74.62"></a><span id="l74.62" class="difflineminus">-</span>
<a href="#l74.63"></a><span id="l74.63" class="difflineplus">+    return match[1];</span>
<a href="#l74.64"></a><span id="l74.64">   }</span>
<a href="#l74.65"></a><span id="l74.65">   match = /^.$/.exec(keySequence);</span>
<a href="#l74.66"></a><span id="l74.66">   if (match != null) {</span>
<a href="#l74.67"></a><span id="l74.67" class="difflineminus">-      return match[0].charCodeAt(0);</span>
<a href="#l74.68"></a><span id="l74.68" class="difflineminus">-</span>
<a href="#l74.69"></a><span id="l74.69" class="difflineplus">+    return match[0].charCodeAt(0);</span>
<a href="#l74.70"></a><span id="l74.70">   }</span>
<a href="#l74.71"></a><span id="l74.71">   // this is for backward compatibility with existing tests</span>
<a href="#l74.72"></a><span id="l74.72">   // 1 digit ascii codes will break however because they are used for the digit chars</span>
<a href="#l74.73"></a><span id="l74.73">   match = /^\d{2,3}$/.exec(keySequence);</span>
<a href="#l74.74"></a><span id="l74.74">   if (match != null) {</span>
<a href="#l74.75"></a><span id="l74.75" class="difflineminus">-      return match[0];</span>
<a href="#l74.76"></a><span id="l74.76" class="difflineminus">-</span>
<a href="#l74.77"></a><span id="l74.77" class="difflineplus">+    return match[0];</span>
<a href="#l74.78"></a><span id="l74.78">   }</span>
<a href="#l74.79"></a><span id="l74.79" class="difflineminus">-  if (keySequence != null){</span>
<a href="#l74.80"></a><span id="l74.80" class="difflineplus">+  if (keySequence != null) {</span>
<a href="#l74.81"></a><span id="l74.81">     // eventsLogger.error(&quot;invalid keySequence &quot;+String(keySequence));</span>
<a href="#l74.82"></a><span id="l74.82">   }</span>
<a href="#l74.83"></a><span id="l74.83">   // mozmill.results.writeResult(&quot;invalid keySequence&quot;);</span>
<a href="#l74.84"></a><span id="l74.84" class="difflineminus">-}</span>
<a href="#l74.85"></a><span id="l74.85" class="difflineplus">+  throw new Error(&quot;Should never reach here&quot;);</span>
<a href="#l74.86"></a><span id="l74.86" class="difflineplus">+};</span>
<a href="#l74.87"></a><span id="l74.87"> </span>
<a href="#l74.88"></a><span id="l74.88"> var triggerKeyEvent = function(element, eventType, aKey, modifiers, expectedEvent) {</span>
<a href="#l74.89"></a><span id="l74.89">   // get the window and send focus event</span>
<a href="#l74.90"></a><span id="l74.90" class="difflineminus">-  var win = element.ownerDocument ? element.ownerDocument.defaultView : element;</span>
<a href="#l74.91"></a><span id="l74.91" class="difflineplus">+  var win = element.ownerDocument ? element.ownerGlobal : element;</span>
<a href="#l74.92"></a><span id="l74.92">   win.focus();</span>
<a href="#l74.93"></a><span id="l74.93">   utils.sleep(5);</span>
<a href="#l74.94"></a><span id="l74.94"> </span>
<a href="#l74.95"></a><span id="l74.95">   // If we have an element check if it needs to be focused</span>
<a href="#l74.96"></a><span id="l74.96">   if (element.ownerDocument) {</span>
<a href="#l74.97"></a><span id="l74.97">     var focusedElement = utils.getChromeWindow(win).document.commandDispatcher.focusedElement;</span>
<a href="#l74.98"></a><span id="l74.98" class="difflineminus">-    for (var node = focusedElement; node &amp;&amp; node != element; )</span>
<a href="#l74.99"></a><span id="l74.99" class="difflineplus">+    for (var node = focusedElement; node &amp;&amp; node != element;)</span>
<a href="#l74.100"></a><span id="l74.100">       node = node.parentNode;</span>
<a href="#l74.101"></a><span id="l74.101"> </span>
<a href="#l74.102"></a><span id="l74.102">     // Only focus the element when it's not focused yet</span>
<a href="#l74.103"></a><span id="l74.103">     if (!node)</span>
<a href="#l74.104"></a><span id="l74.104">       element.focus();</span>
<a href="#l74.105"></a><span id="l74.105">   }</span>
<a href="#l74.106"></a><span id="l74.106"> </span>
<a href="#l74.107"></a><span id="l74.107">   if (expectedEvent) {</span>
<a href="#l74.108"></a><span id="l74.108" class="difflineat">@@ -143,42 +139,38 @@ var triggerKeyEvent = function(element, </span>
<a href="#l74.109"></a><span id="l74.109">     }</span>
<a href="#l74.110"></a><span id="l74.110"> </span>
<a href="#l74.111"></a><span id="l74.111">     EventUtils.synthesizeKeyExpectEvent(aKey, modifiers, target,</span>
<a href="#l74.112"></a><span id="l74.112">                                         expectedEvent.type,</span>
<a href="#l74.113"></a><span id="l74.113">                                         &quot;events.triggerKeyEvent()&quot;, win);</span>
<a href="#l74.114"></a><span id="l74.114">   } else {</span>
<a href="#l74.115"></a><span id="l74.115">     EventUtils.synthesizeKey(aKey, modifiers, win);</span>
<a href="#l74.116"></a><span id="l74.116">   }</span>
<a href="#l74.117"></a><span id="l74.117" class="difflineminus">-}</span>
<a href="#l74.118"></a><span id="l74.118" class="difflineplus">+};</span>
<a href="#l74.119"></a><span id="l74.119"> </span>
<a href="#l74.120"></a><span id="l74.120" class="difflineminus">-    /* Fire a mouse event in a browser-compatible manner */</span>
<a href="#l74.121"></a><span id="l74.121" class="difflineplus">+/* Fire a mouse event in a browser-compatible manner */</span>
<a href="#l74.122"></a><span id="l74.122"> var triggerMouseEvent = function(element, eventType, canBubble, clientX, clientY, controlKeyDown, altKeyDown, shiftKeyDown, metaKeyDown) {</span>
<a href="#l74.123"></a><span id="l74.123" class="difflineminus">-</span>
<a href="#l74.124"></a><span id="l74.124" class="difflineminus">-  clientX = clientX ? clientX: 0;</span>
<a href="#l74.125"></a><span id="l74.125" class="difflineminus">-  clientY = clientY ? clientY: 0;</span>
<a href="#l74.126"></a><span id="l74.126" class="difflineplus">+  clientX = clientX ? clientX : 0;</span>
<a href="#l74.127"></a><span id="l74.127" class="difflineplus">+  clientY = clientY ? clientY : 0;</span>
<a href="#l74.128"></a><span id="l74.128"> </span>
<a href="#l74.129"></a><span id="l74.129">   // Fixing this - make the mouse understand where it is on the screen, needed</span>
<a href="#l74.130"></a><span id="l74.130">   // for double click.</span>
<a href="#l74.131"></a><span id="l74.131">   var screenX = element.boxObject.screenX ? element.boxObject.screenX : 0;</span>
<a href="#l74.132"></a><span id="l74.132" class="difflineminus">-  var screenY = element.boxObject.screenY ? element.boxObject.screenY : 0;;</span>
<a href="#l74.133"></a><span id="l74.133" class="difflineplus">+  var screenY = element.boxObject.screenY ? element.boxObject.screenY : 0;</span>
<a href="#l74.134"></a><span id="l74.134"> </span>
<a href="#l74.135"></a><span id="l74.135" class="difflineminus">-  canBubble = (typeof(canBubble) == undefined) ? true: canBubble;</span>
<a href="#l74.136"></a><span id="l74.136" class="difflineplus">+  canBubble = (typeof(canBubble) == undefined) ? true : canBubble;</span>
<a href="#l74.137"></a><span id="l74.137"> </span>
<a href="#l74.138"></a><span id="l74.138" class="difflineminus">-  var evt = element.ownerDocument.defaultView.document.createEvent('MouseEvents');</span>
<a href="#l74.139"></a><span id="l74.139" class="difflineplus">+  var evt = element.ownerGlobal.document.createEvent(&quot;MouseEvents&quot;);</span>
<a href="#l74.140"></a><span id="l74.140">   if (evt.initMouseEvent) {</span>
<a href="#l74.141"></a><span id="l74.141" class="difflineminus">-      //LOG.info(&quot;element has initMouseEvent&quot;);</span>
<a href="#l74.142"></a><span id="l74.142" class="difflineminus">-      //Safari</span>
<a href="#l74.143"></a><span id="l74.143" class="difflineminus">-      evt.initMouseEvent(eventType, canBubble, true, element.ownerDocument.defaultView, 1, screenX, screenY, clientX, clientY, controlKeyDown, altKeyDown, shiftKeyDown, metaKeyDown, 0, null)</span>
<a href="#l74.144"></a><span id="l74.144" class="difflineminus">-</span>
<a href="#l74.145"></a><span id="l74.145" class="difflineplus">+    // LOG.info(&quot;element has initMouseEvent&quot;);</span>
<a href="#l74.146"></a><span id="l74.146" class="difflineplus">+    // Safari</span>
<a href="#l74.147"></a><span id="l74.147" class="difflineplus">+    evt.initMouseEvent(eventType, canBubble, true, element.ownerGlobal, 1, screenX, screenY, clientX, clientY, controlKeyDown, altKeyDown, shiftKeyDown, metaKeyDown, 0, null);</span>
<a href="#l74.148"></a><span id="l74.148" class="difflineplus">+  } else {</span>
<a href="#l74.149"></a><span id="l74.149" class="difflineplus">+    // LOG.warn(&quot;element doesn't have initMouseEvent; firing an event which should -- but doesn't -- have other mouse-event related attributes here, as well as controlKeyDown, altKeyDown, shiftKeyDown, metaKeyDown&quot;);</span>
<a href="#l74.150"></a><span id="l74.150" class="difflineplus">+    evt.initEvent(eventType, canBubble, true);</span>
<a href="#l74.151"></a><span id="l74.151" class="difflineplus">+    evt.shiftKey = shiftKeyDown;</span>
<a href="#l74.152"></a><span id="l74.152" class="difflineplus">+    evt.metaKey = metaKeyDown;</span>
<a href="#l74.153"></a><span id="l74.153" class="difflineplus">+    evt.altKey = altKeyDown;</span>
<a href="#l74.154"></a><span id="l74.154" class="difflineplus">+    evt.ctrlKey = controlKeyDown;</span>
<a href="#l74.155"></a><span id="l74.155">   }</span>
<a href="#l74.156"></a><span id="l74.156" class="difflineminus">-  else {</span>
<a href="#l74.157"></a><span id="l74.157" class="difflineminus">-      //LOG.warn(&quot;element doesn't have initMouseEvent; firing an event which should -- but doesn't -- have other mouse-event related attributes here, as well as controlKeyDown, altKeyDown, shiftKeyDown, metaKeyDown&quot;);</span>
<a href="#l74.158"></a><span id="l74.158" class="difflineminus">-      evt.initEvent(eventType, canBubble, true);</span>
<a href="#l74.159"></a><span id="l74.159" class="difflineminus">-      evt.shiftKey = shiftKeyDown;</span>
<a href="#l74.160"></a><span id="l74.160" class="difflineminus">-      evt.metaKey = metaKeyDown;</span>
<a href="#l74.161"></a><span id="l74.161" class="difflineminus">-      evt.altKey = altKeyDown;</span>
<a href="#l74.162"></a><span id="l74.162" class="difflineminus">-      evt.ctrlKey = controlKeyDown;</span>
<a href="#l74.163"></a><span id="l74.163" class="difflineminus">-</span>
<a href="#l74.164"></a><span id="l74.164" class="difflineminus">-  }</span>
<a href="#l74.165"></a><span id="l74.165" class="difflineminus">-  //Used by safari</span>
<a href="#l74.166"></a><span id="l74.166" class="difflineplus">+  // Used by safari</span>
<a href="#l74.167"></a><span id="l74.167">   element.dispatchEvent(evt);</span>
<a href="#l74.168"></a><span id="l74.168" class="difflineminus">-}</span>
<a href="#l74.169"></a><span id="l74.169" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l75.1"></a><span id="l75.1">rename from mail/test/resources/mozmill/mozmill/extension/content/modules/frame.js</span>
<a href="#l75.2"></a><span id="l75.2">rename to mail/test/resources/mozmill/mozmill/extension/content/modules/frame.jsm</span>
<a href="#l75.3"></a><span id="l75.3" class="difflineminus">--- a/mail/test/resources/mozmill/mozmill/extension/content/modules/frame.js</span>
<a href="#l75.4"></a><span id="l75.4" class="difflineplus">+++ b/mail/test/resources/mozmill/mozmill/extension/content/modules/frame.jsm</span>
<a href="#l75.5"></a><span id="l75.5" class="difflineat">@@ -30,38 +30,26 @@</span>
<a href="#l75.6"></a><span id="l75.6"> // use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l75.7"></a><span id="l75.7"> // decision by deleting the provisions above and replace them with the notice</span>
<a href="#l75.8"></a><span id="l75.8"> // and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l75.9"></a><span id="l75.9"> // the provisions above, a recipient may use your version of this file under</span>
<a href="#l75.10"></a><span id="l75.10"> // the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l75.11"></a><span id="l75.11"> //</span>
<a href="#l75.12"></a><span id="l75.12"> // ***** END LICENSE BLOCK *****</span>
<a href="#l75.13"></a><span id="l75.13"> </span>
<a href="#l75.14"></a><span id="l75.14" class="difflineminus">-var EXPORTED_SYMBOLS = ['loadFile','register_function','Collector','Runner','events',</span>
<a href="#l75.15"></a><span id="l75.15" class="difflineminus">-                        'jsbridge', 'runTestDirectory', 'runTestFile', 'log', 'getThread',</span>
<a href="#l75.16"></a><span id="l75.16" class="difflineminus">-                        'timers', 'persisted', 'registerModule'];</span>
<a href="#l75.17"></a><span id="l75.17" class="difflineminus">-</span>
<a href="#l75.18"></a><span id="l75.18" class="difflineminus">-var {HttpServer} = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/httpd.js&quot;);</span>
<a href="#l75.19"></a><span id="l75.19" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;loadFile&quot;, &quot;register_function&quot;, &quot;Collector&quot;, &quot;Runner&quot;, &quot;events&quot;,</span>
<a href="#l75.20"></a><span id="l75.20" class="difflineplus">+                        &quot;jsbridge&quot;, &quot;runTestDirectory&quot;, &quot;runTestFile&quot;, &quot;log&quot;, &quot;getThread&quot;,</span>
<a href="#l75.21"></a><span id="l75.21" class="difflineplus">+                        &quot;timers&quot;, &quot;persisted&quot;, &quot;registerModule&quot;];</span>
<a href="#l75.22"></a><span id="l75.22"> </span>
<a href="#l75.23"></a><span id="l75.23" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.js&quot;);</span>
<a href="#l75.24"></a><span id="l75.24" class="difflineminus">-var strings = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/strings.js&quot;);</span>
<a href="#l75.25"></a><span id="l75.25" class="difflineminus">-var arrays = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/arrays.js&quot;);</span>
<a href="#l75.26"></a><span id="l75.26" class="difflineminus">-var withs = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/withs.js&quot;);</span>
<a href="#l75.27"></a><span id="l75.27" class="difflineminus">-var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.js&quot;);</span>
<a href="#l75.28"></a><span id="l75.28" class="difflineminus">-var securableModule =</span>
<a href="#l75.29"></a><span id="l75.29" class="difflineminus">-  ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/securable-module.js&quot;);</span>
<a href="#l75.30"></a><span id="l75.30" class="difflineplus">+var {HttpServer} = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/httpd.jsm&quot;);</span>
<a href="#l75.31"></a><span id="l75.31"> </span>
<a href="#l75.32"></a><span id="l75.32" class="difflineminus">-var aConsoleService = Cc[&quot;@mozilla.org/consoleservice;1&quot;].</span>
<a href="#l75.33"></a><span id="l75.33" class="difflineminus">-     getService(Ci.nsIConsoleService);</span>
<a href="#l75.34"></a><span id="l75.34" class="difflineminus">-var ios = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l75.35"></a><span id="l75.35" class="difflineminus">-            .getService(Ci.nsIIOService);</span>
<a href="#l75.36"></a><span id="l75.36" class="difflineminus">-var loader = Cc[&quot;@mozilla.org/moz/jssubscript-loader;1&quot;]</span>
<a href="#l75.37"></a><span id="l75.37" class="difflineminus">-                    .getService(Ci.mozIJSSubScriptLoader);</span>
<a href="#l75.38"></a><span id="l75.38" class="difflineminus">-var uuidgen = Cc[&quot;@mozilla.org/uuid-generator;1&quot;]</span>
<a href="#l75.39"></a><span id="l75.39" class="difflineminus">-                    .getService(Ci.nsIUUIDGenerator);</span>
<a href="#l75.40"></a><span id="l75.40" class="difflineplus">+var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l75.41"></a><span id="l75.41" class="difflineplus">+var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.jsm&quot;);</span>
<a href="#l75.42"></a><span id="l75.42" class="difflineplus">+var securableModule =</span>
<a href="#l75.43"></a><span id="l75.43" class="difflineplus">+  ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/securable-module.jsm&quot;);</span>
<a href="#l75.44"></a><span id="l75.44"> </span>
<a href="#l75.45"></a><span id="l75.45"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l75.46"></a><span id="l75.46"> var systemPrincipal = Services.scriptSecurityManager.getSystemPrincipal();</span>
<a href="#l75.47"></a><span id="l75.47"> </span>
<a href="#l75.48"></a><span id="l75.48"> var backstage = this;</span>
<a href="#l75.49"></a><span id="l75.49"> </span>
<a href="#l75.50"></a><span id="l75.50"> var registeredFunctions = {};</span>
<a href="#l75.51"></a><span id="l75.51"> </span>
<a href="#l75.52"></a><span id="l75.52" class="difflineat">@@ -74,90 +62,88 @@ var arrayRemove = function(array, from, </span>
<a href="#l75.53"></a><span id="l75.53">   array.length = from &lt; 0 ? array.length + from : from;</span>
<a href="#l75.54"></a><span id="l75.54">   return array.push.apply(array, rest);</span>
<a href="#l75.55"></a><span id="l75.55"> };</span>
<a href="#l75.56"></a><span id="l75.56"> </span>
<a href="#l75.57"></a><span id="l75.57"> var mozmill = undefined;</span>
<a href="#l75.58"></a><span id="l75.58"> var elementslib = undefined;</span>
<a href="#l75.59"></a><span id="l75.59"> var modules = undefined;</span>
<a href="#l75.60"></a><span id="l75.60"> </span>
<a href="#l75.61"></a><span id="l75.61" class="difflineminus">-var loadTestResources = function () {</span>
<a href="#l75.62"></a><span id="l75.62" class="difflineplus">+var loadTestResources = function() {</span>
<a href="#l75.63"></a><span id="l75.63">   if (mozmill == undefined) {</span>
<a href="#l75.64"></a><span id="l75.64" class="difflineminus">-    mozmill = ChromeUtils.import(&quot;chrome://mozmill/content/modules/mozmill.js&quot;);</span>
<a href="#l75.65"></a><span id="l75.65" class="difflineplus">+    mozmill = ChromeUtils.import(&quot;chrome://mozmill/content/modules/mozmill.jsm&quot;);</span>
<a href="#l75.66"></a><span id="l75.66">   }</span>
<a href="#l75.67"></a><span id="l75.67">   if (elementslib == undefined) {</span>
<a href="#l75.68"></a><span id="l75.68" class="difflineminus">-    elementslib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l75.69"></a><span id="l75.69" class="difflineplus">+    elementslib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l75.70"></a><span id="l75.70">   }</span>
<a href="#l75.71"></a><span id="l75.71" class="difflineminus">-}</span>
<a href="#l75.72"></a><span id="l75.72" class="difflineplus">+};</span>
<a href="#l75.73"></a><span id="l75.73"> </span>
<a href="#l75.74"></a><span id="l75.74"> var loadFile = function(path, collector) {</span>
<a href="#l75.75"></a><span id="l75.75" class="difflineminus">-  var file = Cc[&quot;@mozilla.org/file/local;1&quot;]</span>
<a href="#l75.76"></a><span id="l75.76" class="difflineminus">-               .createInstance(Ci.nsIFile);</span>
<a href="#l75.77"></a><span id="l75.77" class="difflineplus">+  var file = Cc[&quot;@mozilla.org/file/local;1&quot;].createInstance(Ci.nsIFile);</span>
<a href="#l75.78"></a><span id="l75.78">   file.initWithPath(path);</span>
<a href="#l75.79"></a><span id="l75.79" class="difflineminus">-  var uri = ios.newFileURI(file).spec;</span>
<a href="#l75.80"></a><span id="l75.80" class="difflineplus">+  var uri = Services.io.newFileURI(file).spec;</span>
<a href="#l75.81"></a><span id="l75.81"> </span>
<a href="#l75.82"></a><span id="l75.82">   var module = new Cu.Sandbox(systemPrincipal, { wantGlobalProperties: [&quot;ChromeUtils&quot;] });</span>
<a href="#l75.83"></a><span id="l75.83">   module.registeredFunctions = registeredFunctions;</span>
<a href="#l75.84"></a><span id="l75.84" class="difflineminus">-  module.collector = collector</span>
<a href="#l75.85"></a><span id="l75.85" class="difflineplus">+  module.collector = collector;</span>
<a href="#l75.86"></a><span id="l75.86">   loadTestResources();</span>
<a href="#l75.87"></a><span id="l75.87">   module.mozmill = mozmill;</span>
<a href="#l75.88"></a><span id="l75.88">   module.elementslib = elementslib;</span>
<a href="#l75.89"></a><span id="l75.89">   module.persisted = persisted;</span>
<a href="#l75.90"></a><span id="l75.90">   module.Cc = Cc;</span>
<a href="#l75.91"></a><span id="l75.91">   module.Ci = Ci;</span>
<a href="#l75.92"></a><span id="l75.92">   module.Cu = Cu;</span>
<a href="#l75.93"></a><span id="l75.93" class="difflineminus">-  module.require = function (mod) {</span>
<a href="#l75.94"></a><span id="l75.94" class="difflineplus">+  module.require = function(mod) {</span>
<a href="#l75.95"></a><span id="l75.95">     var loader = new securableModule.Loader({</span>
<a href="#l75.96"></a><span id="l75.96" class="difflineminus">-      rootPaths: [ios.newFileURI(file.parent).spec],</span>
<a href="#l75.97"></a><span id="l75.97" class="difflineplus">+      rootPaths: [Services.io.newFileURI(file.parent).spec],</span>
<a href="#l75.98"></a><span id="l75.98">       defaultPrincipal: &quot;system&quot;,</span>
<a href="#l75.99"></a><span id="l75.99" class="difflineminus">-      globals : { mozmill, elementslib, persisted, Cc, Ci, Cu }</span>
<a href="#l75.100"></a><span id="l75.100" class="difflineplus">+      globals: { mozmill, elementslib, persisted, Cc, Ci, Cu },</span>
<a href="#l75.101"></a><span id="l75.101">     });</span>
<a href="#l75.102"></a><span id="l75.102">     if (modules != undefined) {</span>
<a href="#l75.103"></a><span id="l75.103" class="difflineminus">-        loader.modules = modules;</span>
<a href="#l75.104"></a><span id="l75.104" class="difflineplus">+      loader.modules = modules;</span>
<a href="#l75.105"></a><span id="l75.105">     }</span>
<a href="#l75.106"></a><span id="l75.106">     var retval = loader.require(mod);</span>
<a href="#l75.107"></a><span id="l75.107">     modules = loader.modules;</span>
<a href="#l75.108"></a><span id="l75.108">     return retval;</span>
<a href="#l75.109"></a><span id="l75.109" class="difflineminus">-  }</span>
<a href="#l75.110"></a><span id="l75.110" class="difflineplus">+  };</span>
<a href="#l75.111"></a><span id="l75.111"> </span>
<a href="#l75.112"></a><span id="l75.112">   if (collector != undefined) {</span>
<a href="#l75.113"></a><span id="l75.113">     collector.current_file = file;</span>
<a href="#l75.114"></a><span id="l75.114">     collector.current_path = path;</span>
<a href="#l75.115"></a><span id="l75.115">   }</span>
<a href="#l75.116"></a><span id="l75.116">   try {</span>
<a href="#l75.117"></a><span id="l75.117" class="difflineminus">-    loader.loadSubScript(uri, module, &quot;UTF-8&quot;);</span>
<a href="#l75.118"></a><span id="l75.118" class="difflineplus">+    Services.scriptloader.loadSubScript(uri, module, &quot;UTF-8&quot;);</span>
<a href="#l75.119"></a><span id="l75.119">   } catch (e) {</span>
<a href="#l75.120"></a><span id="l75.120" class="difflineminus">-    events.fail({'exception' : e});</span>
<a href="#l75.121"></a><span id="l75.121" class="difflineplus">+    events.fail({&quot;exception&quot;: e});</span>
<a href="#l75.122"></a><span id="l75.122"> </span>
<a href="#l75.123"></a><span id="l75.123">     var obj = {</span>
<a href="#l75.124"></a><span id="l75.124" class="difflineminus">-      'filename': path,</span>
<a href="#l75.125"></a><span id="l75.125" class="difflineminus">-      'passed': 0,</span>
<a href="#l75.126"></a><span id="l75.126" class="difflineminus">-      'failed': 1,</span>
<a href="#l75.127"></a><span id="l75.127" class="difflineminus">-      'passes': [ ],</span>
<a href="#l75.128"></a><span id="l75.128" class="difflineminus">-      'fails' : [{'exception' : {</span>
<a href="#l75.129"></a><span id="l75.129" class="difflineminus">-                     message: e.message,</span>
<a href="#l75.130"></a><span id="l75.130" class="difflineminus">-                     filename: e.filename,</span>
<a href="#l75.131"></a><span id="l75.131" class="difflineminus">-                     lineNumber: e.lineNumber}}],</span>
<a href="#l75.132"></a><span id="l75.132" class="difflineminus">-      'name'  : '&lt;TOP_LEVEL&gt;'</span>
<a href="#l75.133"></a><span id="l75.133" class="difflineplus">+      filename: path,</span>
<a href="#l75.134"></a><span id="l75.134" class="difflineplus">+      passed: 0,</span>
<a href="#l75.135"></a><span id="l75.135" class="difflineplus">+      failed: 1,</span>
<a href="#l75.136"></a><span id="l75.136" class="difflineplus">+      passes: [ ],</span>
<a href="#l75.137"></a><span id="l75.137" class="difflineplus">+      fails: [{</span>
<a href="#l75.138"></a><span id="l75.138" class="difflineplus">+        exception: {</span>
<a href="#l75.139"></a><span id="l75.139" class="difflineplus">+          message: e.message,</span>
<a href="#l75.140"></a><span id="l75.140" class="difflineplus">+          filename: e.filename,</span>
<a href="#l75.141"></a><span id="l75.141" class="difflineplus">+          lineNumber: e.lineNumber,</span>
<a href="#l75.142"></a><span id="l75.142" class="difflineplus">+        },</span>
<a href="#l75.143"></a><span id="l75.143" class="difflineplus">+      }],</span>
<a href="#l75.144"></a><span id="l75.144" class="difflineplus">+      name: &quot;&lt;TOP_LEVEL&gt;&quot;,</span>
<a href="#l75.145"></a><span id="l75.145">     };</span>
<a href="#l75.146"></a><span id="l75.146" class="difflineminus">-    events.fireEvent('endTest', obj);</span>
<a href="#l75.147"></a><span id="l75.147" class="difflineplus">+    events.fireEvent(&quot;endTest&quot;, obj);</span>
<a href="#l75.148"></a><span id="l75.148">   }</span>
<a href="#l75.149"></a><span id="l75.149"> </span>
<a href="#l75.150"></a><span id="l75.150">   module.__file__ = path;</span>
<a href="#l75.151"></a><span id="l75.151">   module.__uri__ = uri;</span>
<a href="#l75.152"></a><span id="l75.152">   return module;</span>
<a href="#l75.153"></a><span id="l75.153" class="difflineminus">-}</span>
<a href="#l75.154"></a><span id="l75.154" class="difflineplus">+};</span>
<a href="#l75.155"></a><span id="l75.155"> </span>
<a href="#l75.156"></a><span id="l75.156" class="difflineminus">-function registerFunction (name, func) {</span>
<a href="#l75.157"></a><span id="l75.157" class="difflineminus">-  registeredFunctions[name] = func;</span>
<a href="#l75.158"></a><span id="l75.158" class="difflineminus">-}</span>
<a href="#l75.159"></a><span id="l75.159" class="difflineminus">-</span>
<a href="#l75.160"></a><span id="l75.160" class="difflineminus">-function stateChangeBase (possibilities, restrictions, target, cmeta, v) {</span>
<a href="#l75.161"></a><span id="l75.161" class="difflineplus">+function stateChangeBase(possibilities, restrictions, target, cmeta, v) {</span>
<a href="#l75.162"></a><span id="l75.162">   if (possibilities) {</span>
<a href="#l75.163"></a><span id="l75.163" class="difflineminus">-    if (!arrays.inArray(possibilities, v)) {</span>
<a href="#l75.164"></a><span id="l75.164" class="difflineplus">+    if (!possibilities.includes(v)) {</span>
<a href="#l75.165"></a><span id="l75.165">       // TODO Error value not in this.poss</span>
<a href="#l75.166"></a><span id="l75.166">       return;</span>
<a href="#l75.167"></a><span id="l75.167">     }</span>
<a href="#l75.168"></a><span id="l75.168">   }</span>
<a href="#l75.169"></a><span id="l75.169">   if (restrictions) {</span>
<a href="#l75.170"></a><span id="l75.170">     for (var i in restrictions) {</span>
<a href="#l75.171"></a><span id="l75.171">       var r = restrictions[i];</span>
<a href="#l75.172"></a><span id="l75.172">       if (!r(v)) {</span>
<a href="#l75.173"></a><span id="l75.173" class="difflineat">@@ -169,275 +155,287 @@ function stateChangeBase (possibilities,</span>
<a href="#l75.174"></a><span id="l75.174">   // Fire jsbridge notification, logging notification, listener notifications</span>
<a href="#l75.175"></a><span id="l75.175">   events[target] = v;</span>
<a href="#l75.176"></a><span id="l75.176">   events.fireEvent(cmeta, target);</span>
<a href="#l75.177"></a><span id="l75.177"> }</span>
<a href="#l75.178"></a><span id="l75.178"> </span>
<a href="#l75.179"></a><span id="l75.179"> var timers = [];</span>
<a href="#l75.180"></a><span id="l75.180"> </span>
<a href="#l75.181"></a><span id="l75.181"> var events = {</span>
<a href="#l75.182"></a><span id="l75.182" class="difflineminus">-  'currentState' : null,</span>
<a href="#l75.183"></a><span id="l75.183" class="difflineminus">-  'currentModule': null,</span>
<a href="#l75.184"></a><span id="l75.184" class="difflineminus">-  'currentTest'  : null,</span>
<a href="#l75.185"></a><span id="l75.185" class="difflineminus">-  'userShutdown' : false,</span>
<a href="#l75.186"></a><span id="l75.186" class="difflineminus">-  'appQuit'      : false,</span>
<a href="#l75.187"></a><span id="l75.187" class="difflineminus">-  'listeners'    : {},</span>
<a href="#l75.188"></a><span id="l75.188" class="difflineminus">-}</span>
<a href="#l75.189"></a><span id="l75.189" class="difflineminus">-events.setState = function (v) {</span>
<a href="#l75.190"></a><span id="l75.190" class="difflineminus">-   return stateChangeBase(['dependencies', 'setupModule', 'teardownModule',</span>
<a href="#l75.191"></a><span id="l75.191" class="difflineminus">-                           'setupTest', 'teardownTest', 'test', 'collection'],</span>
<a href="#l75.192"></a><span id="l75.192" class="difflineminus">-                           null, 'currentState', 'setState', v);</span>
<a href="#l75.193"></a><span id="l75.193" class="difflineminus">-}</span>
<a href="#l75.194"></a><span id="l75.194" class="difflineminus">-events.toggleUserShutdown = function (){</span>
<a href="#l75.195"></a><span id="l75.195" class="difflineplus">+  currentState: null,</span>
<a href="#l75.196"></a><span id="l75.196" class="difflineplus">+  currentModule: null,</span>
<a href="#l75.197"></a><span id="l75.197" class="difflineplus">+  currentTest: null,</span>
<a href="#l75.198"></a><span id="l75.198" class="difflineplus">+  userShutdown: false,</span>
<a href="#l75.199"></a><span id="l75.199" class="difflineplus">+  appQuit: false,</span>
<a href="#l75.200"></a><span id="l75.200" class="difflineplus">+  listeners: {},</span>
<a href="#l75.201"></a><span id="l75.201" class="difflineplus">+};</span>
<a href="#l75.202"></a><span id="l75.202" class="difflineplus">+events.setState = function(v) {</span>
<a href="#l75.203"></a><span id="l75.203" class="difflineplus">+  return stateChangeBase([</span>
<a href="#l75.204"></a><span id="l75.204" class="difflineplus">+    &quot;dependencies&quot;,</span>
<a href="#l75.205"></a><span id="l75.205" class="difflineplus">+    &quot;setupModule&quot;,</span>
<a href="#l75.206"></a><span id="l75.206" class="difflineplus">+    &quot;teardownModule&quot;,</span>
<a href="#l75.207"></a><span id="l75.207" class="difflineplus">+    &quot;setupTest&quot;,</span>
<a href="#l75.208"></a><span id="l75.208" class="difflineplus">+    &quot;teardownTest&quot;,</span>
<a href="#l75.209"></a><span id="l75.209" class="difflineplus">+    &quot;test&quot;,</span>
<a href="#l75.210"></a><span id="l75.210" class="difflineplus">+    &quot;collection&quot;,</span>
<a href="#l75.211"></a><span id="l75.211" class="difflineplus">+  ], null, &quot;currentState&quot;, &quot;setState&quot;, v);</span>
<a href="#l75.212"></a><span id="l75.212" class="difflineplus">+};</span>
<a href="#l75.213"></a><span id="l75.213" class="difflineplus">+events.toggleUserShutdown = function() {</span>
<a href="#l75.214"></a><span id="l75.214">   if (this.userShutdown) {</span>
<a href="#l75.215"></a><span id="l75.215" class="difflineminus">-    this.fail({'function':'frame.events.toggleUserShutdown', 'message':'Shutdown expected but none detected before timeout'});</span>
<a href="#l75.216"></a><span id="l75.216" class="difflineplus">+    this.fail({</span>
<a href="#l75.217"></a><span id="l75.217" class="difflineplus">+      function: &quot;frame.events.toggleUserShutdown&quot;,</span>
<a href="#l75.218"></a><span id="l75.218" class="difflineplus">+      message: &quot;Shutdown expected but none detected before timeout&quot;,</span>
<a href="#l75.219"></a><span id="l75.219" class="difflineplus">+    });</span>
<a href="#l75.220"></a><span id="l75.220">   }</span>
<a href="#l75.221"></a><span id="l75.221">   this.userShutdown = (!this.userShutdown);</span>
<a href="#l75.222"></a><span id="l75.222" class="difflineminus">-}</span>
<a href="#l75.223"></a><span id="l75.223" class="difflineminus">-events.isUserShutdown = function () {</span>
<a href="#l75.224"></a><span id="l75.224" class="difflineplus">+};</span>
<a href="#l75.225"></a><span id="l75.225" class="difflineplus">+events.isUserShutdown = function() {</span>
<a href="#l75.226"></a><span id="l75.226">   return this.userShutdown;</span>
<a href="#l75.227"></a><span id="l75.227" class="difflineminus">-}</span>
<a href="#l75.228"></a><span id="l75.228" class="difflineminus">-events.setTest = function (test, invokedFromIDE) {</span>
<a href="#l75.229"></a><span id="l75.229" class="difflineplus">+};</span>
<a href="#l75.230"></a><span id="l75.230" class="difflineplus">+events.setTest = function(test, invokedFromIDE) {</span>
<a href="#l75.231"></a><span id="l75.231">   test.__passes__ = [];</span>
<a href="#l75.232"></a><span id="l75.232">   test.__fails__ = [];</span>
<a href="#l75.233"></a><span id="l75.233">   test.__invokedFromIDE__ = invokedFromIDE;</span>
<a href="#l75.234"></a><span id="l75.234">   events.currentTest = test;</span>
<a href="#l75.235"></a><span id="l75.235" class="difflineminus">-  var obj = {'filename':events.currentModule.__file__,</span>
<a href="#l75.236"></a><span id="l75.236" class="difflineminus">-             'name':test.__name__,</span>
<a href="#l75.237"></a><span id="l75.237" class="difflineminus">-            }</span>
<a href="#l75.238"></a><span id="l75.238" class="difflineminus">-  events.fireEvent('setTest', obj);</span>
<a href="#l75.239"></a><span id="l75.239" class="difflineminus">-}</span>
<a href="#l75.240"></a><span id="l75.240" class="difflineminus">-events.endTest = function (test) {</span>
<a href="#l75.241"></a><span id="l75.241" class="difflineminus">-  test.status = 'done';</span>
<a href="#l75.242"></a><span id="l75.242" class="difflineplus">+  var obj = {</span>
<a href="#l75.243"></a><span id="l75.243" class="difflineplus">+    filename: events.currentModule.__file__,</span>
<a href="#l75.244"></a><span id="l75.244" class="difflineplus">+    name: test.__name__,</span>
<a href="#l75.245"></a><span id="l75.245" class="difflineplus">+  };</span>
<a href="#l75.246"></a><span id="l75.246" class="difflineplus">+  events.fireEvent(&quot;setTest&quot;, obj);</span>
<a href="#l75.247"></a><span id="l75.247" class="difflineplus">+};</span>
<a href="#l75.248"></a><span id="l75.248" class="difflineplus">+events.endTest = function(test) {</span>
<a href="#l75.249"></a><span id="l75.249" class="difflineplus">+  test.status = &quot;done&quot;;</span>
<a href="#l75.250"></a><span id="l75.250">   events.currentTest = null;</span>
<a href="#l75.251"></a><span id="l75.251" class="difflineminus">-  var obj = {'filename':events.currentModule.__file__,</span>
<a href="#l75.252"></a><span id="l75.252" class="difflineminus">-         'passed':test.__passes__.length,</span>
<a href="#l75.253"></a><span id="l75.253" class="difflineminus">-         'failed':test.__fails__.length,</span>
<a href="#l75.254"></a><span id="l75.254" class="difflineminus">-         'passes':test.__passes__,</span>
<a href="#l75.255"></a><span id="l75.255" class="difflineminus">-         'fails' :test.__fails__,</span>
<a href="#l75.256"></a><span id="l75.256" class="difflineminus">-         'name'  :test.__name__,</span>
<a href="#l75.257"></a><span id="l75.257" class="difflineminus">-         }</span>
<a href="#l75.258"></a><span id="l75.258" class="difflineplus">+  var obj = {</span>
<a href="#l75.259"></a><span id="l75.259" class="difflineplus">+    filename: events.currentModule.__file__,</span>
<a href="#l75.260"></a><span id="l75.260" class="difflineplus">+    passed: test.__passes__.length,</span>
<a href="#l75.261"></a><span id="l75.261" class="difflineplus">+    failed: test.__fails__.length,</span>
<a href="#l75.262"></a><span id="l75.262" class="difflineplus">+    passes: test.__passes__,</span>
<a href="#l75.263"></a><span id="l75.263" class="difflineplus">+    fails: test.__fails__,</span>
<a href="#l75.264"></a><span id="l75.264" class="difflineplus">+    name: test.__name__,</span>
<a href="#l75.265"></a><span id="l75.265" class="difflineplus">+  };</span>
<a href="#l75.266"></a><span id="l75.266">   if (test.skipped) {</span>
<a href="#l75.267"></a><span id="l75.267" class="difflineminus">-    obj['skipped'] = true;</span>
<a href="#l75.268"></a><span id="l75.268" class="difflineplus">+    obj.skipped = true;</span>
<a href="#l75.269"></a><span id="l75.269">     obj.skipped_reason = test.skipped_reason;</span>
<a href="#l75.270"></a><span id="l75.270">   }</span>
<a href="#l75.271"></a><span id="l75.271">   if (test.meta) {</span>
<a href="#l75.272"></a><span id="l75.272">     obj.meta = test.meta;</span>
<a href="#l75.273"></a><span id="l75.273">   }</span>
<a href="#l75.274"></a><span id="l75.274" class="difflineminus">-  events.fireEvent('endTest', obj);</span>
<a href="#l75.275"></a><span id="l75.275" class="difflineminus">-}</span>
<a href="#l75.276"></a><span id="l75.276" class="difflineminus">-events.setModule = function (v) {</span>
<a href="#l75.277"></a><span id="l75.277" class="difflineminus">-  return stateChangeBase( null, [function (v) {return (v.__file__ != undefined)}],</span>
<a href="#l75.278"></a><span id="l75.278" class="difflineminus">-                          'currentModule', 'setModule', v);</span>
<a href="#l75.279"></a><span id="l75.279" class="difflineminus">-}</span>
<a href="#l75.280"></a><span id="l75.280" class="difflineminus">-events.pass = function (obj) {</span>
<a href="#l75.281"></a><span id="l75.281" class="difflineplus">+  events.fireEvent(&quot;endTest&quot;, obj);</span>
<a href="#l75.282"></a><span id="l75.282" class="difflineplus">+};</span>
<a href="#l75.283"></a><span id="l75.283" class="difflineplus">+events.setModule = function(v) {</span>
<a href="#l75.284"></a><span id="l75.284" class="difflineplus">+  return stateChangeBase(null, [</span>
<a href="#l75.285"></a><span id="l75.285" class="difflineplus">+    function(v) {</span>
<a href="#l75.286"></a><span id="l75.286" class="difflineplus">+      return (v.__file__ != undefined);</span>
<a href="#l75.287"></a><span id="l75.287" class="difflineplus">+    },</span>
<a href="#l75.288"></a><span id="l75.288" class="difflineplus">+  ], &quot;currentModule&quot;, &quot;setModule&quot;, v);</span>
<a href="#l75.289"></a><span id="l75.289" class="difflineplus">+};</span>
<a href="#l75.290"></a><span id="l75.290" class="difflineplus">+events.pass = function(obj) {</span>
<a href="#l75.291"></a><span id="l75.291">   if (events.currentTest) {</span>
<a href="#l75.292"></a><span id="l75.292">     events.currentTest.__passes__.push(obj);</span>
<a href="#l75.293"></a><span id="l75.293">   }</span>
<a href="#l75.294"></a><span id="l75.294">   for (var timer of timers) {</span>
<a href="#l75.295"></a><span id="l75.295" class="difflineminus">-    timer.actions.push(</span>
<a href="#l75.296"></a><span id="l75.296" class="difflineminus">-      {&quot;currentTest&quot;:events.currentModule.__file__+&quot;::&quot;+events.currentTest.__name__, &quot;obj&quot;:obj,</span>
<a href="#l75.297"></a><span id="l75.297" class="difflineminus">-       &quot;result&quot;:&quot;pass&quot;}</span>
<a href="#l75.298"></a><span id="l75.298" class="difflineminus">-    );</span>
<a href="#l75.299"></a><span id="l75.299" class="difflineplus">+    timer.actions.push({</span>
<a href="#l75.300"></a><span id="l75.300" class="difflineplus">+      currentTest: events.currentModule.__file__ + &quot;::&quot; + events.currentTest.__name__,</span>
<a href="#l75.301"></a><span id="l75.301" class="difflineplus">+      obj,</span>
<a href="#l75.302"></a><span id="l75.302" class="difflineplus">+      result: &quot;pass&quot;,</span>
<a href="#l75.303"></a><span id="l75.303" class="difflineplus">+    });</span>
<a href="#l75.304"></a><span id="l75.304">   }</span>
<a href="#l75.305"></a><span id="l75.305" class="difflineminus">-  events.fireEvent('pass', obj);</span>
<a href="#l75.306"></a><span id="l75.306" class="difflineminus">-}</span>
<a href="#l75.307"></a><span id="l75.307" class="difflineminus">-events.fail = function (obj) {</span>
<a href="#l75.308"></a><span id="l75.308" class="difflineplus">+  events.fireEvent(&quot;pass&quot;, obj);</span>
<a href="#l75.309"></a><span id="l75.309" class="difflineplus">+};</span>
<a href="#l75.310"></a><span id="l75.310" class="difflineplus">+events.fail = function(obj) {</span>
<a href="#l75.311"></a><span id="l75.311">   var error = obj.exception;</span>
<a href="#l75.312"></a><span id="l75.312" class="difflineminus">-  if(error) {</span>
<a href="#l75.313"></a><span id="l75.313" class="difflineplus">+  if (error) {</span>
<a href="#l75.314"></a><span id="l75.314">     // Error objects aren't enumerable https://bugzilla.mozilla.org/show_bug.cgi?id=637207</span>
<a href="#l75.315"></a><span id="l75.315">     obj.exception = {</span>
<a href="#l75.316"></a><span id="l75.316">       name: error.name,</span>
<a href="#l75.317"></a><span id="l75.317">       message: error.message,</span>
<a href="#l75.318"></a><span id="l75.318">       lineNumber: error.lineNumber,</span>
<a href="#l75.319"></a><span id="l75.319">       fileName: error.fileName,</span>
<a href="#l75.320"></a><span id="l75.320" class="difflineminus">-      stack: error.stack</span>
<a href="#l75.321"></a><span id="l75.321" class="difflineplus">+      stack: error.stack,</span>
<a href="#l75.322"></a><span id="l75.322">     };</span>
<a href="#l75.323"></a><span id="l75.323">   }</span>
<a href="#l75.324"></a><span id="l75.324">   // a low level event, such as a keystroke, fails</span>
<a href="#l75.325"></a><span id="l75.325">   if (events.currentTest) {</span>
<a href="#l75.326"></a><span id="l75.326">     events.currentTest.__fails__.push(obj);</span>
<a href="#l75.327"></a><span id="l75.327">   }</span>
<a href="#l75.328"></a><span id="l75.328" class="difflineminus">-  for (var time of timers) {</span>
<a href="#l75.329"></a><span id="l75.329" class="difflineminus">-    timer.actions.push(</span>
<a href="#l75.330"></a><span id="l75.330" class="difflineminus">-      {&quot;currentTest&quot;:events.currentModule.__file__+&quot;::&quot;+events.currentTest.__name__, &quot;obj&quot;:obj,</span>
<a href="#l75.331"></a><span id="l75.331" class="difflineminus">-       &quot;result&quot;:&quot;fail&quot;}</span>
<a href="#l75.332"></a><span id="l75.332" class="difflineminus">-    );</span>
<a href="#l75.333"></a><span id="l75.333" class="difflineplus">+  for (var timer of timers) {</span>
<a href="#l75.334"></a><span id="l75.334" class="difflineplus">+    timer.actions.push({</span>
<a href="#l75.335"></a><span id="l75.335" class="difflineplus">+      currentTest: events.currentModule.__file__ + &quot;::&quot; + events.currentTest.__name__,</span>
<a href="#l75.336"></a><span id="l75.336" class="difflineplus">+      obj,</span>
<a href="#l75.337"></a><span id="l75.337" class="difflineplus">+      result: &quot;fail&quot;,</span>
<a href="#l75.338"></a><span id="l75.338" class="difflineplus">+    });</span>
<a href="#l75.339"></a><span id="l75.339">   }</span>
<a href="#l75.340"></a><span id="l75.340" class="difflineminus">-  events.fireEvent('fail', obj);</span>
<a href="#l75.341"></a><span id="l75.341" class="difflineminus">-}</span>
<a href="#l75.342"></a><span id="l75.342" class="difflineminus">-events.skip = function (reason) {</span>
<a href="#l75.343"></a><span id="l75.343" class="difflineplus">+  events.fireEvent(&quot;fail&quot;, obj);</span>
<a href="#l75.344"></a><span id="l75.344" class="difflineplus">+};</span>
<a href="#l75.345"></a><span id="l75.345" class="difflineplus">+events.skip = function(reason) {</span>
<a href="#l75.346"></a><span id="l75.346">   events.currentTest.skipped = true;</span>
<a href="#l75.347"></a><span id="l75.347">   events.currentTest.skipped_reason = reason;</span>
<a href="#l75.348"></a><span id="l75.348">   for (var timer of timers) {</span>
<a href="#l75.349"></a><span id="l75.349" class="difflineminus">-    timer.actions.push(</span>
<a href="#l75.350"></a><span id="l75.350" class="difflineminus">-      {&quot;currentTest&quot;:events.currentModule.__file__+&quot;::&quot;+events.currentTest.__name__, &quot;obj&quot;:reason,</span>
<a href="#l75.351"></a><span id="l75.351" class="difflineminus">-       &quot;result&quot;:&quot;skip&quot;}</span>
<a href="#l75.352"></a><span id="l75.352" class="difflineminus">-    );</span>
<a href="#l75.353"></a><span id="l75.353" class="difflineplus">+    timer.actions.push({</span>
<a href="#l75.354"></a><span id="l75.354" class="difflineplus">+      currentTest: events.currentModule.__file__ + &quot;::&quot; + events.currentTest.__name__,</span>
<a href="#l75.355"></a><span id="l75.355" class="difflineplus">+      obj: reason,</span>
<a href="#l75.356"></a><span id="l75.356" class="difflineplus">+      result: &quot;skip&quot;,</span>
<a href="#l75.357"></a><span id="l75.357" class="difflineplus">+    });</span>
<a href="#l75.358"></a><span id="l75.358">   }</span>
<a href="#l75.359"></a><span id="l75.359" class="difflineminus">-  events.fireEvent('skip', reason);</span>
<a href="#l75.360"></a><span id="l75.360" class="difflineminus">-}</span>
<a href="#l75.361"></a><span id="l75.361" class="difflineminus">-events.fireEvent = function (name, obj) {</span>
<a href="#l75.362"></a><span id="l75.362" class="difflineminus">-  if (events.currentTest &amp;&amp; name == &quot;firePythonCallback&quot; &amp;&amp; events.currentTest.__invokedFromIDE__) {</span>
<a href="#l75.363"></a><span id="l75.363" class="difflineminus">-    throw new Error(&quot;tests that use firePythonCallback cannot be run from the IDE\n&quot;);</span>
<a href="#l75.364"></a><span id="l75.364" class="difflineminus">-  }</span>
<a href="#l75.365"></a><span id="l75.365" class="difflineplus">+  events.fireEvent(&quot;skip&quot;, reason);</span>
<a href="#l75.366"></a><span id="l75.366" class="difflineplus">+};</span>
<a href="#l75.367"></a><span id="l75.367" class="difflineplus">+events.fireEvent = function(name, obj) {</span>
<a href="#l75.368"></a><span id="l75.368">   if (this.listeners[name]) {</span>
<a href="#l75.369"></a><span id="l75.369">     for (var i in this.listeners[name]) {</span>
<a href="#l75.370"></a><span id="l75.370">       this.listeners[name][i](obj);</span>
<a href="#l75.371"></a><span id="l75.371">     }</span>
<a href="#l75.372"></a><span id="l75.372">   }</span>
<a href="#l75.373"></a><span id="l75.373">   for (var listener of this.globalListeners) {</span>
<a href="#l75.374"></a><span id="l75.374">     listener(name, obj);</span>
<a href="#l75.375"></a><span id="l75.375">   }</span>
<a href="#l75.376"></a><span id="l75.376" class="difflineminus">-}</span>
<a href="#l75.377"></a><span id="l75.377" class="difflineplus">+};</span>
<a href="#l75.378"></a><span id="l75.378"> events.globalListeners = [];</span>
<a href="#l75.379"></a><span id="l75.379" class="difflineminus">-events.addListener = function (name, listener) {</span>
<a href="#l75.380"></a><span id="l75.380" class="difflineplus">+events.addListener = function(name, listener) {</span>
<a href="#l75.381"></a><span id="l75.381">   if (this.listeners[name]) {</span>
<a href="#l75.382"></a><span id="l75.382">     this.listeners[name].push(listener);</span>
<a href="#l75.383"></a><span id="l75.383" class="difflineminus">-  } else if (name =='') {</span>
<a href="#l75.384"></a><span id="l75.384" class="difflineminus">-    this.globalListeners.push(listener)</span>
<a href="#l75.385"></a><span id="l75.385" class="difflineplus">+  } else if (name == &quot;&quot;) {</span>
<a href="#l75.386"></a><span id="l75.386" class="difflineplus">+    this.globalListeners.push(listener);</span>
<a href="#l75.387"></a><span id="l75.387">   } else {</span>
<a href="#l75.388"></a><span id="l75.388">     this.listeners[name] = [listener];</span>
<a href="#l75.389"></a><span id="l75.389">   }</span>
<a href="#l75.390"></a><span id="l75.390" class="difflineminus">-}</span>
<a href="#l75.391"></a><span id="l75.391" class="difflineplus">+};</span>
<a href="#l75.392"></a><span id="l75.392"> events.removeListener = function(listener) {</span>
<a href="#l75.393"></a><span id="l75.393">   for (var listenerIndex in this.listeners) {</span>
<a href="#l75.394"></a><span id="l75.394">     var e = this.listeners[listenerIndex];</span>
<a href="#l75.395"></a><span id="l75.395" class="difflineminus">-    for (var i in e){</span>
<a href="#l75.396"></a><span id="l75.396" class="difflineplus">+    for (let i in e) {</span>
<a href="#l75.397"></a><span id="l75.397">       if (e[i] == listener) {</span>
<a href="#l75.398"></a><span id="l75.398">         this.listeners[listenerIndex] = arrayRemove(e, i);</span>
<a href="#l75.399"></a><span id="l75.399">       }</span>
<a href="#l75.400"></a><span id="l75.400">     }</span>
<a href="#l75.401"></a><span id="l75.401">   }</span>
<a href="#l75.402"></a><span id="l75.402" class="difflineminus">-  for (var i in this.globalListeners) {</span>
<a href="#l75.403"></a><span id="l75.403" class="difflineplus">+  for (let i in this.globalListeners) {</span>
<a href="#l75.404"></a><span id="l75.404">     if (this.globalListeners[i] == listener) {</span>
<a href="#l75.405"></a><span id="l75.405">       this.globalListeners = arrayRemove(this.globalListeners, i);</span>
<a href="#l75.406"></a><span id="l75.406">     }</span>
<a href="#l75.407"></a><span id="l75.407">   }</span>
<a href="#l75.408"></a><span id="l75.408" class="difflineminus">-}</span>
<a href="#l75.409"></a><span id="l75.409" class="difflineplus">+};</span>
<a href="#l75.410"></a><span id="l75.410"> </span>
<a href="#l75.411"></a><span id="l75.411" class="difflineminus">-var log = function (obj) {</span>
<a href="#l75.412"></a><span id="l75.412" class="difflineminus">-  events.fireEvent('log', obj);</span>
<a href="#l75.413"></a><span id="l75.413" class="difflineminus">-}</span>
<a href="#l75.414"></a><span id="l75.414" class="difflineplus">+var log = function(obj) {</span>
<a href="#l75.415"></a><span id="l75.415" class="difflineplus">+  events.fireEvent(&quot;log&quot;, obj);</span>
<a href="#l75.416"></a><span id="l75.416" class="difflineplus">+};</span>
<a href="#l75.417"></a><span id="l75.417"> </span>
<a href="#l75.418"></a><span id="l75.418" class="difflineplus">+var jsbridge;</span>
<a href="#l75.419"></a><span id="l75.419"> try {</span>
<a href="#l75.420"></a><span id="l75.420" class="difflineminus">-  var jsbridge = ChromeUtils.import(&quot;chrome://jsbridge/content/modules/events.js&quot;);</span>
<a href="#l75.421"></a><span id="l75.421" class="difflineminus">-} catch(err) {</span>
<a href="#l75.422"></a><span id="l75.422" class="difflineminus">-  var jsbridge = null;</span>
<a href="#l75.423"></a><span id="l75.423" class="difflineminus">-</span>
<a href="#l75.424"></a><span id="l75.424" class="difflineminus">-  aConsoleService.logStringMessage(&quot;jsbridge not available.&quot;);</span>
<a href="#l75.425"></a><span id="l75.425" class="difflineplus">+  jsbridge = ChromeUtils.import(&quot;chrome://jsbridge/content/modules/events.js&quot;);</span>
<a href="#l75.426"></a><span id="l75.426" class="difflineplus">+} catch (err) {</span>
<a href="#l75.427"></a><span id="l75.427" class="difflineplus">+  jsbridge = null;</span>
<a href="#l75.428"></a><span id="l75.428" class="difflineplus">+  Services.console.logStringMessage(&quot;jsbridge not available.&quot;);</span>
<a href="#l75.429"></a><span id="l75.429"> }</span>
<a href="#l75.430"></a><span id="l75.430"> </span>
<a href="#l75.431"></a><span id="l75.431"> if (jsbridge) {</span>
<a href="#l75.432"></a><span id="l75.432" class="difflineminus">-  events.addListener('', function (name, obj) {jsbridge.fireEvent('mozmill.'+name, obj)} );</span>
<a href="#l75.433"></a><span id="l75.433" class="difflineplus">+  events.addListener(&quot;&quot;, function(name, obj) {</span>
<a href="#l75.434"></a><span id="l75.434" class="difflineplus">+    jsbridge.fireEvent(&quot;mozmill.&quot; + name, obj);</span>
<a href="#l75.435"></a><span id="l75.435" class="difflineplus">+  });</span>
<a href="#l75.436"></a><span id="l75.436"> }</span>
<a href="#l75.437"></a><span id="l75.437"> </span>
<a href="#l75.438"></a><span id="l75.438" class="difflineminus">-function Collector () {</span>
<a href="#l75.439"></a><span id="l75.439" class="difflineplus">+function Collector() {</span>
<a href="#l75.440"></a><span id="l75.440">   this.test_modules_by_filename = {};</span>
<a href="#l75.441"></a><span id="l75.441">   this.test_modules_by_name = {};</span>
<a href="#l75.442"></a><span id="l75.442">   this.requirements_run = {};</span>
<a href="#l75.443"></a><span id="l75.443">   this.all_requirements = [];</span>
<a href="#l75.444"></a><span id="l75.444">   this.loaded_directories = [];</span>
<a href="#l75.445"></a><span id="l75.445">   this.testing = [];</span>
<a href="#l75.446"></a><span id="l75.446">   this.httpd_started = false;</span>
<a href="#l75.447"></a><span id="l75.447">   this.http_port = 43336;</span>
<a href="#l75.448"></a><span id="l75.448" class="difflineminus">-  // var logging = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/logging.js&quot;);</span>
<a href="#l75.449"></a><span id="l75.449" class="difflineplus">+  // var logging = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/logging.jsm&quot;);</span>
<a href="#l75.450"></a><span id="l75.450">   // this.logger = new logging.Logger('Collector');</span>
<a href="#l75.451"></a><span id="l75.451"> }</span>
<a href="#l75.452"></a><span id="l75.452"> </span>
<a href="#l75.453"></a><span id="l75.453" class="difflineminus">-Collector.prototype.getModule = function (name) {</span>
<a href="#l75.454"></a><span id="l75.454" class="difflineplus">+Collector.prototype.getModule = function(name) {</span>
<a href="#l75.455"></a><span id="l75.455">   return this.test_modules_by_name[name];</span>
<a href="#l75.456"></a><span id="l75.456" class="difflineminus">-}</span>
<a href="#l75.457"></a><span id="l75.457" class="difflineplus">+};</span>
<a href="#l75.458"></a><span id="l75.458"> </span>
<a href="#l75.459"></a><span id="l75.459" class="difflineminus">-Collector.prototype.getServer = function (port, basePath) {</span>
<a href="#l75.460"></a><span id="l75.460" class="difflineplus">+Collector.prototype.getServer = function(port, basePath) {</span>
<a href="#l75.461"></a><span id="l75.461">   if (basePath) {</span>
<a href="#l75.462"></a><span id="l75.462" class="difflineminus">-    var lp = Cc[&quot;@mozilla.org/file/local;1&quot;]</span>
<a href="#l75.463"></a><span id="l75.463" class="difflineminus">-             .createInstance(Ci.nsIFile);</span>
<a href="#l75.464"></a><span id="l75.464" class="difflineplus">+    var lp = Cc[&quot;@mozilla.org/file/local;1&quot;].createInstance(Ci.nsIFile);</span>
<a href="#l75.465"></a><span id="l75.465">     lp.initWithPath(basePath);</span>
<a href="#l75.466"></a><span id="l75.466">   }</span>
<a href="#l75.467"></a><span id="l75.467"> </span>
<a href="#l75.468"></a><span id="l75.468">   var srv = new HttpServer();</span>
<a href="#l75.469"></a><span id="l75.469">   if (lp) {</span>
<a href="#l75.470"></a><span id="l75.470">     srv.registerDirectory(&quot;/&quot;, lp);</span>
<a href="#l75.471"></a><span id="l75.471">   }</span>
<a href="#l75.472"></a><span id="l75.472"> </span>
<a href="#l75.473"></a><span id="l75.473">   srv.registerContentType(&quot;sjs&quot;, &quot;sjs&quot;);</span>
<a href="#l75.474"></a><span id="l75.474">   srv.identity.setPrimary(&quot;http&quot;, &quot;localhost&quot;, port);</span>
<a href="#l75.475"></a><span id="l75.475">   srv._port = port;</span>
<a href="#l75.476"></a><span id="l75.476"> </span>
<a href="#l75.477"></a><span id="l75.477">   return srv;</span>
<a href="#l75.478"></a><span id="l75.478" class="difflineminus">-}</span>
<a href="#l75.479"></a><span id="l75.479" class="difflineplus">+};</span>
<a href="#l75.480"></a><span id="l75.480"> </span>
<a href="#l75.481"></a><span id="l75.481" class="difflineminus">-Collector.prototype.startHttpd = function () {</span>
<a href="#l75.482"></a><span id="l75.482" class="difflineplus">+Collector.prototype.startHttpd = function() {</span>
<a href="#l75.483"></a><span id="l75.483">   while (this.httpd == undefined) {</span>
<a href="#l75.484"></a><span id="l75.484">     try {</span>
<a href="#l75.485"></a><span id="l75.485">       var http_server = this.getServer(this.http_port);</span>
<a href="#l75.486"></a><span id="l75.486">       http_server.start(this.http_port);</span>
<a href="#l75.487"></a><span id="l75.487">       this.httpd = http_server;</span>
<a href="#l75.488"></a><span id="l75.488">     } catch (e) {</span>
<a href="#l75.489"></a><span id="l75.489">       // Failure most likely due to port conflict</span>
<a href="#l75.490"></a><span id="l75.490">       this.http_port++;</span>
<a href="#l75.491"></a><span id="l75.491">     }</span>
<a href="#l75.492"></a><span id="l75.492">   }</span>
<a href="#l75.493"></a><span id="l75.493" class="difflineminus">-}</span>
<a href="#l75.494"></a><span id="l75.494" class="difflineplus">+};</span>
<a href="#l75.495"></a><span id="l75.495"> </span>
<a href="#l75.496"></a><span id="l75.496" class="difflineminus">-Collector.prototype.stopHttpd = function () {</span>
<a href="#l75.497"></a><span id="l75.497" class="difflineplus">+Collector.prototype.stopHttpd = function() {</span>
<a href="#l75.498"></a><span id="l75.498">   if (this.httpd) {</span>
<a href="#l75.499"></a><span id="l75.499" class="difflineminus">-    this.httpd.stop(function(){});  // Callback needed to pause execution until the server has been properly shutdown</span>
<a href="#l75.500"></a><span id="l75.500" class="difflineplus">+    this.httpd.stop(function() {});  // Callback needed to pause execution until the server has been properly shutdown</span>
<a href="#l75.501"></a><span id="l75.501">     this.httpd = null;</span>
<a href="#l75.502"></a><span id="l75.502">   }</span>
<a href="#l75.503"></a><span id="l75.503" class="difflineminus">-}</span>
<a href="#l75.504"></a><span id="l75.504" class="difflineplus">+};</span>
<a href="#l75.505"></a><span id="l75.505"> </span>
<a href="#l75.506"></a><span id="l75.506" class="difflineminus">-Collector.prototype.addHttpResource = function (directory, ns) {</span>
<a href="#l75.507"></a><span id="l75.507" class="difflineplus">+Collector.prototype.addHttpResource = function(directory, ns) {</span>
<a href="#l75.508"></a><span id="l75.508">   if (!this.httpd) {</span>
<a href="#l75.509"></a><span id="l75.509">     this.startHttpd();</span>
<a href="#l75.510"></a><span id="l75.510">   }</span>
<a href="#l75.511"></a><span id="l75.511"> </span>
<a href="#l75.512"></a><span id="l75.512">   if (!ns) {</span>
<a href="#l75.513"></a><span id="l75.513" class="difflineminus">-    ns = '/';</span>
<a href="#l75.514"></a><span id="l75.514" class="difflineplus">+    ns = &quot;/&quot;;</span>
<a href="#l75.515"></a><span id="l75.515">   } else {</span>
<a href="#l75.516"></a><span id="l75.516" class="difflineminus">-    ns = '/' + ns + '/';</span>
<a href="#l75.517"></a><span id="l75.517" class="difflineplus">+    ns = &quot;/&quot; + ns + &quot;/&quot;;</span>
<a href="#l75.518"></a><span id="l75.518">   }</span>
<a href="#l75.519"></a><span id="l75.519"> </span>
<a href="#l75.520"></a><span id="l75.520" class="difflineminus">-  var lp = Cc[&quot;@mozilla.org/file/local;1&quot;].</span>
<a href="#l75.521"></a><span id="l75.521" class="difflineminus">-           createInstance(Ci.nsIFile);</span>
<a href="#l75.522"></a><span id="l75.522" class="difflineplus">+  var lp = Cc[&quot;@mozilla.org/file/local;1&quot;].createInstance(Ci.nsIFile);</span>
<a href="#l75.523"></a><span id="l75.523">   lp.initWithPath(os.abspath(directory, this.current_file));</span>
<a href="#l75.524"></a><span id="l75.524">   this.httpd.registerDirectory(ns, lp);</span>
<a href="#l75.525"></a><span id="l75.525"> </span>
<a href="#l75.526"></a><span id="l75.526" class="difflineminus">-  return 'http://localhost:' + this.http_port + ns</span>
<a href="#l75.527"></a><span id="l75.527" class="difflineminus">-}</span>
<a href="#l75.528"></a><span id="l75.528" class="difflineplus">+  return &quot;http://localhost:&quot; + this.http_port + ns;</span>
<a href="#l75.529"></a><span id="l75.529" class="difflineplus">+};</span>
<a href="#l75.530"></a><span id="l75.530"> </span>
<a href="#l75.531"></a><span id="l75.531" class="difflineminus">-Collector.prototype.initTestModule = function (filename) {</span>
<a href="#l75.532"></a><span id="l75.532" class="difflineplus">+Collector.prototype.initTestModule = function(filename) {</span>
<a href="#l75.533"></a><span id="l75.533">   var test_module = loadFile(filename, this);</span>
<a href="#l75.534"></a><span id="l75.534">   test_module.__tests__ = [];</span>
<a href="#l75.535"></a><span id="l75.535">   for (var i in test_module) {</span>
<a href="#l75.536"></a><span id="l75.536">     if (test_module[i] == null) {</span>
<a href="#l75.537"></a><span id="l75.537">       // do nothing</span>
<a href="#l75.538"></a><span id="l75.538" class="difflineminus">-    }</span>
<a href="#l75.539"></a><span id="l75.539" class="difflineminus">-    else if (typeof(test_module[i]) == &quot;function&quot;) {</span>
<a href="#l75.540"></a><span id="l75.540" class="difflineplus">+    } else if (typeof(test_module[i]) == &quot;function&quot;) {</span>
<a href="#l75.541"></a><span id="l75.541">       if (i == &quot;setupTest&quot;) {</span>
<a href="#l75.542"></a><span id="l75.542">         test_module[i].__name__ = i;</span>
<a href="#l75.543"></a><span id="l75.543">         test_module.__setupTest__ = test_module[i];</span>
<a href="#l75.544"></a><span id="l75.544">       } else if (i == &quot;setupModule&quot;) {</span>
<a href="#l75.545"></a><span id="l75.545">         test_module[i].__name__ = i;</span>
<a href="#l75.546"></a><span id="l75.546">         test_module.__setupModule__ = test_module[i];</span>
<a href="#l75.547"></a><span id="l75.547">       } else if (i == &quot;teardownTest&quot;) {</span>
<a href="#l75.548"></a><span id="l75.548">         test_module[i].__name__ = i;</span>
<a href="#l75.549"></a><span id="l75.549">         test_module.__teardownTest__ = test_module[i];</span>
<a href="#l75.550"></a><span id="l75.550">       } else if (i == &quot;teardownModule&quot;) {</span>
<a href="#l75.551"></a><span id="l75.551">         test_module[i].__name__ = i;</span>
<a href="#l75.552"></a><span id="l75.552">         test_module.__teardownModule__ = test_module[i];</span>
<a href="#l75.553"></a><span id="l75.553" class="difflineminus">-      } else if (withs.startsWith(i, &quot;test&quot;)) {</span>
<a href="#l75.554"></a><span id="l75.554" class="difflineplus">+      } else if (i.startsWith(&quot;test&quot;)) {</span>
<a href="#l75.555"></a><span id="l75.555">         test_module[i].__name__ = i;</span>
<a href="#l75.556"></a><span id="l75.556">         test_module.__tests__.push(test_module[i]);</span>
<a href="#l75.557"></a><span id="l75.557">       }</span>
<a href="#l75.558"></a><span id="l75.558" class="difflineminus">-    } else if (typeof(test_module[i]) == 'object' &amp;&amp;</span>
<a href="#l75.559"></a><span id="l75.559" class="difflineminus">-               test_module[i]._mozmillasynctest == true) {</span>
<a href="#l75.560"></a><span id="l75.560" class="difflineminus">-        test_module[i].__name__ = i;</span>
<a href="#l75.561"></a><span id="l75.561" class="difflineminus">-        test_module.__tests__.push(test_module[i]);</span>
<a href="#l75.562"></a><span id="l75.562" class="difflineplus">+    } else if (typeof(test_module[i]) == &quot;object&quot; &amp;&amp; test_module[i]._mozmillasynctest) {</span>
<a href="#l75.563"></a><span id="l75.563" class="difflineplus">+      test_module[i].__name__ = i;</span>
<a href="#l75.564"></a><span id="l75.564" class="difflineplus">+      test_module.__tests__.push(test_module[i]);</span>
<a href="#l75.565"></a><span id="l75.565">     }</span>
<a href="#l75.566"></a><span id="l75.566">     if (i == &quot;RELATIVE_ROOT&quot;) {</span>
<a href="#l75.567"></a><span id="l75.567">       test_module.__root_path__ = os.abspath(test_module[i], os.getFileForPath(filename));</span>
<a href="#l75.568"></a><span id="l75.568">     }</span>
<a href="#l75.569"></a><span id="l75.569">     if (i == &quot;MODULE_REQUIRES&quot;) {</span>
<a href="#l75.570"></a><span id="l75.570">       test_module.__requirements__ = test_module[i];</span>
<a href="#l75.571"></a><span id="l75.571">       this.all_requirements.push.apply(backstage, test_module[i]);</span>
<a href="#l75.572"></a><span id="l75.572">     }</span>
<a href="#l75.573"></a><span id="l75.573" class="difflineat">@@ -449,279 +447,247 @@ Collector.prototype.initTestModule = fun</span>
<a href="#l75.574"></a><span id="l75.574"> </span>
<a href="#l75.575"></a><span id="l75.575">   if (test_module.MODULE_REQUIRES != undefined &amp;&amp; test_module.RELATIVE_ROOT == undefined) {</span>
<a href="#l75.576"></a><span id="l75.576">     for (var t of test_module.__tests__) {</span>
<a href="#l75.577"></a><span id="l75.577">       t.__force_skip__ = &quot;RELATIVE ROOT is not defined and test requires another module.&quot;;</span>
<a href="#l75.578"></a><span id="l75.578">     }</span>
<a href="#l75.579"></a><span id="l75.579">   }</span>
<a href="#l75.580"></a><span id="l75.580"> </span>
<a href="#l75.581"></a><span id="l75.581">   test_module.collector = this;</span>
<a href="#l75.582"></a><span id="l75.582" class="difflineminus">-  test_module.status = 'loaded';</span>
<a href="#l75.583"></a><span id="l75.583" class="difflineplus">+  test_module.status = &quot;loaded&quot;;</span>
<a href="#l75.584"></a><span id="l75.584">   this.test_modules_by_filename[filename] = test_module;</span>
<a href="#l75.585"></a><span id="l75.585"> </span>
<a href="#l75.586"></a><span id="l75.586">   return test_module;</span>
<a href="#l75.587"></a><span id="l75.587" class="difflineminus">-}</span>
<a href="#l75.588"></a><span id="l75.588" class="difflineplus">+};</span>
<a href="#l75.589"></a><span id="l75.589"> </span>
<a href="#l75.590"></a><span id="l75.590" class="difflineminus">-Collector.prototype.initTestDirectory = function (directory) {</span>
<a href="#l75.591"></a><span id="l75.591" class="difflineplus">+Collector.prototype.initTestDirectory = function(directory) {</span>
<a href="#l75.592"></a><span id="l75.592">   var r = this;</span>
<a href="#l75.593"></a><span id="l75.593">   function recursiveModuleLoader(dfile) {</span>
<a href="#l75.594"></a><span id="l75.594">     r.loaded_directories.push(directory);</span>
<a href="#l75.595"></a><span id="l75.595">     var dfiles = os.listDirectory(dfile);</span>
<a href="#l75.596"></a><span id="l75.596">     for (var i in dfiles) {</span>
<a href="#l75.597"></a><span id="l75.597">       var f = dfiles[i];</span>
<a href="#l75.598"></a><span id="l75.598" class="difflineminus">-      if ( f.isDirectory() &amp;&amp;</span>
<a href="#l75.599"></a><span id="l75.599" class="difflineminus">-           !withs.startsWith(f.leafName, '.') &amp;&amp;</span>
<a href="#l75.600"></a><span id="l75.600" class="difflineminus">-           withs.startsWith(f.leafName, &quot;test&quot;) &amp;&amp;</span>
<a href="#l75.601"></a><span id="l75.601" class="difflineminus">-           !arrays.inArray(r.loaded_directories, f.path) ) {</span>
<a href="#l75.602"></a><span id="l75.602" class="difflineplus">+      if (f.isDirectory() &amp;&amp;</span>
<a href="#l75.603"></a><span id="l75.603" class="difflineplus">+          !f.leafName.startsWith(&quot;.&quot;) &amp;&amp;</span>
<a href="#l75.604"></a><span id="l75.604" class="difflineplus">+          f.leafName.startsWith(&quot;test&quot;) &amp;&amp;</span>
<a href="#l75.605"></a><span id="l75.605" class="difflineplus">+          !r.loaded_directories.includes(f.path)) {</span>
<a href="#l75.606"></a><span id="l75.606">         recursiveModuleLoader(os.getFileForPath(f.path));</span>
<a href="#l75.607"></a><span id="l75.607" class="difflineminus">-      } else if ( withs.startsWith(f.leafName, &quot;test&quot;) &amp;&amp;</span>
<a href="#l75.608"></a><span id="l75.608" class="difflineminus">-                  withs.endsWith(f.leafName, &quot;.js&quot;)    &amp;&amp;</span>
<a href="#l75.609"></a><span id="l75.609" class="difflineminus">-                  !arrays.inArray(r.test_modules_by_filename, f.path) ) {</span>
<a href="#l75.610"></a><span id="l75.610" class="difflineplus">+      } else if (f.leafName.startsWith(&quot;test&quot;) &amp;&amp;</span>
<a href="#l75.611"></a><span id="l75.611" class="difflineplus">+                 f.leafName.endsWith(&quot;.js&quot;) &amp;&amp;</span>
<a href="#l75.612"></a><span id="l75.612" class="difflineplus">+                 !(f.path in r.test_modules_by_filename)) {</span>
<a href="#l75.613"></a><span id="l75.613">         r.initTestModule(f.path);</span>
<a href="#l75.614"></a><span id="l75.614">       }</span>
<a href="#l75.615"></a><span id="l75.615">       r.testing.push(f.path);</span>
<a href="#l75.616"></a><span id="l75.616">     }</span>
<a href="#l75.617"></a><span id="l75.617">   }</span>
<a href="#l75.618"></a><span id="l75.618">   recursiveModuleLoader(os.getFileForPath(directory));</span>
<a href="#l75.619"></a><span id="l75.619" class="difflineminus">-}</span>
<a href="#l75.620"></a><span id="l75.620" class="difflineplus">+};</span>
<a href="#l75.621"></a><span id="l75.621"> </span>
<a href="#l75.622"></a><span id="l75.622"> // Observer which gets notified when the application quits</span>
<a href="#l75.623"></a><span id="l75.623"> function AppQuitObserver() {</span>
<a href="#l75.624"></a><span id="l75.624">   this.register();</span>
<a href="#l75.625"></a><span id="l75.625"> }</span>
<a href="#l75.626"></a><span id="l75.626"> AppQuitObserver.prototype = {</span>
<a href="#l75.627"></a><span id="l75.627" class="difflineminus">-  observe: function(subject, topic, data) {</span>
<a href="#l75.628"></a><span id="l75.628" class="difflineplus">+  observe(subject, topic, data) {</span>
<a href="#l75.629"></a><span id="l75.629">     events.appQuit = true;</span>
<a href="#l75.630"></a><span id="l75.630">   },</span>
<a href="#l75.631"></a><span id="l75.631" class="difflineminus">-  register: function() {</span>
<a href="#l75.632"></a><span id="l75.632" class="difflineminus">-    var obsService = Cc[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l75.633"></a><span id="l75.633" class="difflineminus">-                     .getService(Ci.nsIObserverService);</span>
<a href="#l75.634"></a><span id="l75.634" class="difflineminus">-    obsService.addObserver(this, &quot;quit-application&quot;);</span>
<a href="#l75.635"></a><span id="l75.635" class="difflineplus">+  register() {</span>
<a href="#l75.636"></a><span id="l75.636" class="difflineplus">+    Services.obs.addObserver(this, &quot;quit-application&quot;);</span>
<a href="#l75.637"></a><span id="l75.637">   },</span>
<a href="#l75.638"></a><span id="l75.638" class="difflineminus">-  unregister: function() {</span>
<a href="#l75.639"></a><span id="l75.639" class="difflineminus">-    var obsService = Cc[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l75.640"></a><span id="l75.640" class="difflineminus">-                     .getService(Ci.nsIObserverService);</span>
<a href="#l75.641"></a><span id="l75.641" class="difflineminus">-    obsService.removeObserver(this, &quot;quit-application&quot;);</span>
<a href="#l75.642"></a><span id="l75.642" class="difflineminus">-  }</span>
<a href="#l75.643"></a><span id="l75.643" class="difflineminus">-}</span>
<a href="#l75.644"></a><span id="l75.644" class="difflineplus">+  unregister() {</span>
<a href="#l75.645"></a><span id="l75.645" class="difflineplus">+    Services.obs.removeObserver(this, &quot;quit-application&quot;);</span>
<a href="#l75.646"></a><span id="l75.646" class="difflineplus">+  },</span>
<a href="#l75.647"></a><span id="l75.647" class="difflineplus">+};</span>
<a href="#l75.648"></a><span id="l75.648"> </span>
<a href="#l75.649"></a><span id="l75.649"> </span>
<a href="#l75.650"></a><span id="l75.650" class="difflineminus">-function Runner (collector, invokedFromIDE) {</span>
<a href="#l75.651"></a><span id="l75.651" class="difflineplus">+function Runner(collector, invokedFromIDE) {</span>
<a href="#l75.652"></a><span id="l75.652">   this.collector = collector;</span>
<a href="#l75.653"></a><span id="l75.653" class="difflineminus">-  this.invokedFromIDE = invokedFromIDE</span>
<a href="#l75.654"></a><span id="l75.654" class="difflineminus">-  events.fireEvent('startRunner', true);</span>
<a href="#l75.655"></a><span id="l75.655" class="difflineminus">-  // var logging = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/logging.js&quot;);</span>
<a href="#l75.656"></a><span id="l75.656" class="difflineplus">+  this.invokedFromIDE = invokedFromIDE;</span>
<a href="#l75.657"></a><span id="l75.657" class="difflineplus">+  events.fireEvent(&quot;startRunner&quot;, true);</span>
<a href="#l75.658"></a><span id="l75.658" class="difflineplus">+  // var logging = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/logging.jsm&quot;);</span>
<a href="#l75.659"></a><span id="l75.659">   // this.logger = new logging.Logger('Runner');</span>
<a href="#l75.660"></a><span id="l75.660" class="difflineminus">-  var m = ChromeUtils.import(&quot;chrome://mozmill/content/modules/mozmill.js&quot;);</span>
<a href="#l75.661"></a><span id="l75.661" class="difflineplus">+  var m = ChromeUtils.import(&quot;chrome://mozmill/content/modules/mozmill.jsm&quot;);</span>
<a href="#l75.662"></a><span id="l75.662">   this.platform = m.platform;</span>
<a href="#l75.663"></a><span id="l75.663"> }</span>
<a href="#l75.664"></a><span id="l75.664" class="difflineminus">-Runner.prototype.runTestDirectory = function (directory) {</span>
<a href="#l75.665"></a><span id="l75.665" class="difflineplus">+Runner.prototype.runTestDirectory = function(directory) {</span>
<a href="#l75.666"></a><span id="l75.666">   this.collector.initTestDirectory(directory);</span>
<a href="#l75.667"></a><span id="l75.667"> </span>
<a href="#l75.668"></a><span id="l75.668">   for (var i in this.collector.test_modules_by_filename) {</span>
<a href="#l75.669"></a><span id="l75.669">     var test = this.collector.test_modules_by_filename[i];</span>
<a href="#l75.670"></a><span id="l75.670" class="difflineminus">-    if (test.status != 'done') {</span>
<a href="#l75.671"></a><span id="l75.671" class="difflineplus">+    if (test.status != &quot;done&quot;) {</span>
<a href="#l75.672"></a><span id="l75.672">       this.runTestModule(test);</span>
<a href="#l75.673"></a><span id="l75.673">     }</span>
<a href="#l75.674"></a><span id="l75.674">   }</span>
<a href="#l75.675"></a><span id="l75.675" class="difflineminus">-}</span>
<a href="#l75.676"></a><span id="l75.676" class="difflineminus">-Runner.prototype.runTestFile = function (filename) {</span>
<a href="#l75.677"></a><span id="l75.677" class="difflineplus">+};</span>
<a href="#l75.678"></a><span id="l75.678" class="difflineplus">+Runner.prototype.runTestFile = function(filename) {</span>
<a href="#l75.679"></a><span id="l75.679">   // if ( !arrays.inArray(this.test_modules_by_filename, directory) ) {</span>
<a href="#l75.680"></a><span id="l75.680">   //   this.collector.initTestModule(directory);</span>
<a href="#l75.681"></a><span id="l75.681">   // }</span>
<a href="#l75.682"></a><span id="l75.682">   this.collector.initTestModule(filename);</span>
<a href="#l75.683"></a><span id="l75.683">   this.runTestModule(this.collector.test_modules_by_filename[filename]);</span>
<a href="#l75.684"></a><span id="l75.684" class="difflineminus">-}</span>
<a href="#l75.685"></a><span id="l75.685" class="difflineminus">-Runner.prototype.end = function () {</span>
<a href="#l75.686"></a><span id="l75.686" class="difflineplus">+};</span>
<a href="#l75.687"></a><span id="l75.687" class="difflineplus">+Runner.prototype.end = function() {</span>
<a href="#l75.688"></a><span id="l75.688">   try {</span>
<a href="#l75.689"></a><span id="l75.689" class="difflineminus">-    events.fireEvent('persist', persisted);</span>
<a href="#l75.690"></a><span id="l75.690" class="difflineminus">-  } catch(e) {</span>
<a href="#l75.691"></a><span id="l75.691" class="difflineminus">-    events.fireEvent('error', &quot;persist serialization failed.&quot;);</span>
<a href="#l75.692"></a><span id="l75.692" class="difflineplus">+    events.fireEvent(&quot;persist&quot;, persisted);</span>
<a href="#l75.693"></a><span id="l75.693" class="difflineplus">+  } catch (e) {</span>
<a href="#l75.694"></a><span id="l75.694" class="difflineplus">+    events.fireEvent(&quot;error&quot;, &quot;persist serialization failed.&quot;);</span>
<a href="#l75.695"></a><span id="l75.695">   }</span>
<a href="#l75.696"></a><span id="l75.696">   this.collector.stopHttpd();</span>
<a href="#l75.697"></a><span id="l75.697" class="difflineminus">-  events.fireEvent('endRunner', true);</span>
<a href="#l75.698"></a><span id="l75.698" class="difflineminus">-}</span>
<a href="#l75.699"></a><span id="l75.699" class="difflineminus">-Runner.prototype.getDependencies = function (module) {</span>
<a href="#l75.700"></a><span id="l75.700" class="difflineminus">-  events.setState('dependencies');</span>
<a href="#l75.701"></a><span id="l75.701" class="difflineminus">-  var alldeps = [];</span>
<a href="#l75.702"></a><span id="l75.702" class="difflineminus">-  function recursiveGetDeps (mod) {</span>
<a href="#l75.703"></a><span id="l75.703" class="difflineminus">-    for (var i in mod.__dependencies__) {</span>
<a href="#l75.704"></a><span id="l75.704" class="difflineminus">-      var m = mod.dependencies[i];</span>
<a href="#l75.705"></a><span id="l75.705" class="difflineminus">-      if ( !arrays.inArray(this.test_modules_by_name, m) ) {</span>
<a href="#l75.706"></a><span id="l75.706" class="difflineminus">-        // TODO: Raise Error that this dependency cannot be resolved.</span>
<a href="#l75.707"></a><span id="l75.707" class="difflineminus">-      } else {</span>
<a href="#l75.708"></a><span id="l75.708" class="difflineminus">-        recursiveGetDeps(this.test_modules_by_name[m]);</span>
<a href="#l75.709"></a><span id="l75.709" class="difflineminus">-        alldeps.push(m);</span>
<a href="#l75.710"></a><span id="l75.710" class="difflineminus">-      }</span>
<a href="#l75.711"></a><span id="l75.711" class="difflineminus">-    }</span>
<a href="#l75.712"></a><span id="l75.712" class="difflineminus">-  }</span>
<a href="#l75.713"></a><span id="l75.713" class="difflineplus">+  events.fireEvent(&quot;endRunner&quot;, true);</span>
<a href="#l75.714"></a><span id="l75.714" class="difflineplus">+};</span>
<a href="#l75.715"></a><span id="l75.715"> </span>
<a href="#l75.716"></a><span id="l75.716" class="difflineminus">-  return alldeps;</span>
<a href="#l75.717"></a><span id="l75.717" class="difflineminus">-}</span>
<a href="#l75.718"></a><span id="l75.718" class="difflineminus">-</span>
<a href="#l75.719"></a><span id="l75.719" class="difflineminus">-Runner.prototype.wrapper = function (func, arg) {</span>
<a href="#l75.720"></a><span id="l75.720" class="difflineminus">-  thread = Cc[&quot;@mozilla.org/thread-manager;1&quot;]</span>
<a href="#l75.721"></a><span id="l75.721" class="difflineminus">-             .getService(Ci.nsIThreadManager)</span>
<a href="#l75.722"></a><span id="l75.722" class="difflineminus">-             .currentThread;</span>
<a href="#l75.723"></a><span id="l75.723" class="difflineplus">+Runner.prototype.wrapper = function(func, arg) {</span>
<a href="#l75.724"></a><span id="l75.724" class="difflineplus">+  thread = Services.tm.currentThread;</span>
<a href="#l75.725"></a><span id="l75.725"> </span>
<a href="#l75.726"></a><span id="l75.726">   if (func.EXCLUDED_PLATFORMS != undefined) {</span>
<a href="#l75.727"></a><span id="l75.727" class="difflineminus">-    if (arrays.inArray(func.EXCLUDED_PLATFORMS, this.platform)) {</span>
<a href="#l75.728"></a><span id="l75.728" class="difflineplus">+    if (func.EXCLUDED_PLATFORMS.includes(this.platform)) {</span>
<a href="#l75.729"></a><span id="l75.729">       events.skip(&quot;Platform exclusion&quot;);</span>
<a href="#l75.730"></a><span id="l75.730">       return;</span>
<a href="#l75.731"></a><span id="l75.731">     }</span>
<a href="#l75.732"></a><span id="l75.732">   }</span>
<a href="#l75.733"></a><span id="l75.733">   if (func.__force_skip__ != undefined) {</span>
<a href="#l75.734"></a><span id="l75.734">     events.skip(func.__force_skip__);</span>
<a href="#l75.735"></a><span id="l75.735">     return;</span>
<a href="#l75.736"></a><span id="l75.736">   }</span>
<a href="#l75.737"></a><span id="l75.737">   try {</span>
<a href="#l75.738"></a><span id="l75.738">     if (arg) {</span>
<a href="#l75.739"></a><span id="l75.739">       func(arg);</span>
<a href="#l75.740"></a><span id="l75.740" class="difflineplus">+    } else if (func._mozmillasynctest) {</span>
<a href="#l75.741"></a><span id="l75.741" class="difflineplus">+      func.run();</span>
<a href="#l75.742"></a><span id="l75.742">     } else {</span>
<a href="#l75.743"></a><span id="l75.743" class="difflineminus">-      if (func._mozmillasynctest == true) {</span>
<a href="#l75.744"></a><span id="l75.744" class="difflineminus">-        func.run();</span>
<a href="#l75.745"></a><span id="l75.745" class="difflineminus">-      } else {</span>
<a href="#l75.746"></a><span id="l75.746" class="difflineminus">-        func();</span>
<a href="#l75.747"></a><span id="l75.747" class="difflineminus">-      }</span>
<a href="#l75.748"></a><span id="l75.748" class="difflineplus">+      func();</span>
<a href="#l75.749"></a><span id="l75.749">     }</span>
<a href="#l75.750"></a><span id="l75.750">     // If a shutdown was expected but the application hasn't quit, throw a failure</span>
<a href="#l75.751"></a><span id="l75.751">     if (events.isUserShutdown()) {</span>
<a href="#l75.752"></a><span id="l75.752">       utils.sleep(500);  // Prevents race condition between mozrunner hard process kill and normal FFx shutdown</span>
<a href="#l75.753"></a><span id="l75.753">       if (!events.appQuit) {</span>
<a href="#l75.754"></a><span id="l75.754" class="difflineminus">-        events.fail({'function':'Runner.wrapper', 'message':'Shutdown expected but none detected before end of test'});</span>
<a href="#l75.755"></a><span id="l75.755" class="difflineplus">+        events.fail({&quot;function&quot;: &quot;Runner.wrapper&quot;, &quot;message&quot;: &quot;Shutdown expected but none detected before end of test&quot;});</span>
<a href="#l75.756"></a><span id="l75.756">       }</span>
<a href="#l75.757"></a><span id="l75.757">     }</span>
<a href="#l75.758"></a><span id="l75.758">   } catch (e) {</span>
<a href="#l75.759"></a><span id="l75.759" class="difflineminus">-    if (func._mozmillasynctest == true) {</span>
<a href="#l75.760"></a><span id="l75.760" class="difflineplus">+    if (func._mozmillasynctest) {</span>
<a href="#l75.761"></a><span id="l75.761">       func = {</span>
<a href="#l75.762"></a><span id="l75.762" class="difflineminus">-              'filename':events.currentModule.__file__,</span>
<a href="#l75.763"></a><span id="l75.763" class="difflineminus">-              'name':func.__name__</span>
<a href="#l75.764"></a><span id="l75.764" class="difflineminus">-             }</span>
<a href="#l75.765"></a><span id="l75.765" class="difflineplus">+        filename: events.currentModule.__file__,</span>
<a href="#l75.766"></a><span id="l75.766" class="difflineplus">+        name: func.__name__,</span>
<a href="#l75.767"></a><span id="l75.767" class="difflineplus">+      };</span>
<a href="#l75.768"></a><span id="l75.768">     }</span>
<a href="#l75.769"></a><span id="l75.769">     // Allow the exception if a user shutdown was expected</span>
<a href="#l75.770"></a><span id="l75.770">     if (!events.isUserShutdown()) {</span>
<a href="#l75.771"></a><span id="l75.771" class="difflineminus">-      events.fail({'exception': e, 'test':func})</span>
<a href="#l75.772"></a><span id="l75.772" class="difflineplus">+      events.fail({&quot;exception&quot;: e, &quot;test&quot;: func});</span>
<a href="#l75.773"></a><span id="l75.773">       Cu.reportError(e);</span>
<a href="#l75.774"></a><span id="l75.774">     }</span>
<a href="#l75.775"></a><span id="l75.775">   }</span>
<a href="#l75.776"></a><span id="l75.776" class="difflineminus">-}</span>
<a href="#l75.777"></a><span id="l75.777" class="difflineplus">+};</span>
<a href="#l75.778"></a><span id="l75.778"> </span>
<a href="#l75.779"></a><span id="l75.779" class="difflineminus">-Runner.prototype._runTestModule = function (module) {</span>
<a href="#l75.780"></a><span id="l75.780" class="difflineplus">+Runner.prototype._runTestModule = function(module) {</span>
<a href="#l75.781"></a><span id="l75.781">   if (module.__requirements__ != undefined &amp;&amp; module.__force_skip__ == undefined) {</span>
<a href="#l75.782"></a><span id="l75.782">     for (var req of module.__requirements__) {</span>
<a href="#l75.783"></a><span id="l75.783">       module[req] = this.collector.getModule(req);</span>
<a href="#l75.784"></a><span id="l75.784">     }</span>
<a href="#l75.785"></a><span id="l75.785">   }</span>
<a href="#l75.786"></a><span id="l75.786"> </span>
<a href="#l75.787"></a><span id="l75.787">   var attrs = [];</span>
<a href="#l75.788"></a><span id="l75.788" class="difflineminus">-  for (var i in module) {</span>
<a href="#l75.789"></a><span id="l75.789" class="difflineplus">+  for (let i in module) {</span>
<a href="#l75.790"></a><span id="l75.790">     attrs.push(i);</span>
<a href="#l75.791"></a><span id="l75.791">   }</span>
<a href="#l75.792"></a><span id="l75.792"> </span>
<a href="#l75.793"></a><span id="l75.793">   events.setModule(module);</span>
<a href="#l75.794"></a><span id="l75.794">   var observer = new AppQuitObserver();</span>
<a href="#l75.795"></a><span id="l75.795" class="difflineplus">+  var setupModulePassed, setupTestPassed;</span>
<a href="#l75.796"></a><span id="l75.796"> </span>
<a href="#l75.797"></a><span id="l75.797" class="difflineminus">-  module.__status__ = 'running';</span>
<a href="#l75.798"></a><span id="l75.798" class="difflineplus">+  module.__status__ = &quot;running&quot;;</span>
<a href="#l75.799"></a><span id="l75.799">   if (module.__setupModule__) {</span>
<a href="#l75.800"></a><span id="l75.800" class="difflineminus">-    events.setState('setupModule');</span>
<a href="#l75.801"></a><span id="l75.801" class="difflineplus">+    events.setState(&quot;setupModule&quot;);</span>
<a href="#l75.802"></a><span id="l75.802">     events.setTest(module.__setupModule__);</span>
<a href="#l75.803"></a><span id="l75.803">     this.wrapper(module.__setupModule__, module);</span>
<a href="#l75.804"></a><span id="l75.804" class="difflineminus">-    var setupModulePassed = (events.currentTest.__fails__.length == 0 &amp;&amp; !events.currentTest.skipped);</span>
<a href="#l75.805"></a><span id="l75.805" class="difflineplus">+    setupModulePassed = (events.currentTest.__fails__.length == 0 &amp;&amp; !events.currentTest.skipped);</span>
<a href="#l75.806"></a><span id="l75.806">     events.endTest(module.__setupModule__);</span>
<a href="#l75.807"></a><span id="l75.807">   } else {</span>
<a href="#l75.808"></a><span id="l75.808" class="difflineminus">-    var setupModulePassed = true;</span>
<a href="#l75.809"></a><span id="l75.809" class="difflineplus">+    setupModulePassed = true;</span>
<a href="#l75.810"></a><span id="l75.810">   }</span>
<a href="#l75.811"></a><span id="l75.811">   if (setupModulePassed) {</span>
<a href="#l75.812"></a><span id="l75.812" class="difflineminus">-    for (var i in module.__tests__) {</span>
<a href="#l75.813"></a><span id="l75.813" class="difflineplus">+    for (let i in module.__tests__) {</span>
<a href="#l75.814"></a><span id="l75.814">       events.appQuit = false;</span>
<a href="#l75.815"></a><span id="l75.815" class="difflineminus">-      var test = module.__tests__[i];</span>
<a href="#l75.816"></a><span id="l75.816" class="difflineplus">+      let test = module.__tests__[i];</span>
<a href="#l75.817"></a><span id="l75.817"> </span>
<a href="#l75.818"></a><span id="l75.818">       // TODO: introduce per-test timeout:</span>
<a href="#l75.819"></a><span id="l75.819">       // https://bugzilla.mozilla.org/show_bug.cgi?id=574871</span>
<a href="#l75.820"></a><span id="l75.820"> </span>
<a href="#l75.821"></a><span id="l75.821">       if (module.__setupTest__) {</span>
<a href="#l75.822"></a><span id="l75.822" class="difflineminus">-        events.setState('setupTest');</span>
<a href="#l75.823"></a><span id="l75.823" class="difflineplus">+        events.setState(&quot;setupTest&quot;);</span>
<a href="#l75.824"></a><span id="l75.824">         events.setTest(module.__setupTest__);</span>
<a href="#l75.825"></a><span id="l75.825">         this.wrapper(module.__setupTest__, test);</span>
<a href="#l75.826"></a><span id="l75.826" class="difflineminus">-        var setupTestPassed = (events.currentTest.__fails__.length == 0 &amp;&amp; !events.currentTest.skipped);</span>
<a href="#l75.827"></a><span id="l75.827" class="difflineplus">+        setupTestPassed = (events.currentTest.__fails__.length == 0 &amp;&amp; !events.currentTest.skipped);</span>
<a href="#l75.828"></a><span id="l75.828">         events.endTest(module.__setupTest__);</span>
<a href="#l75.829"></a><span id="l75.829">       } else {</span>
<a href="#l75.830"></a><span id="l75.830" class="difflineminus">-        var setupTestPassed = true;</span>
<a href="#l75.831"></a><span id="l75.831" class="difflineplus">+        setupTestPassed = true;</span>
<a href="#l75.832"></a><span id="l75.832">       }</span>
<a href="#l75.833"></a><span id="l75.833" class="difflineminus">-      events.setState('test');</span>
<a href="#l75.834"></a><span id="l75.834" class="difflineplus">+      events.setState(&quot;test&quot;);</span>
<a href="#l75.835"></a><span id="l75.835">       events.setTest(test, this.invokedFromIDE);</span>
<a href="#l75.836"></a><span id="l75.836">       if (setupTestPassed) {</span>
<a href="#l75.837"></a><span id="l75.837">         this.wrapper(test);</span>
<a href="#l75.838"></a><span id="l75.838">       } else {</span>
<a href="#l75.839"></a><span id="l75.839">         events.skip(&quot;setupTest failed.&quot;);</span>
<a href="#l75.840"></a><span id="l75.840">       }</span>
<a href="#l75.841"></a><span id="l75.841">       if (module.__teardownTest__) {</span>
<a href="#l75.842"></a><span id="l75.842" class="difflineminus">-        events.setState('teardownTest');</span>
<a href="#l75.843"></a><span id="l75.843" class="difflineplus">+        events.setState(&quot;teardownTest&quot;);</span>
<a href="#l75.844"></a><span id="l75.844">         events.setTest(module.__teardownTest__);</span>
<a href="#l75.845"></a><span id="l75.845">         this.wrapper(module.__teardownTest__, test);</span>
<a href="#l75.846"></a><span id="l75.846">         events.endTest(module.__teardownTest__);</span>
<a href="#l75.847"></a><span id="l75.847">       }</span>
<a href="#l75.848"></a><span id="l75.848" class="difflineminus">-      events.endTest(test)</span>
<a href="#l75.849"></a><span id="l75.849" class="difflineplus">+      events.endTest(test);</span>
<a href="#l75.850"></a><span id="l75.850">     }</span>
<a href="#l75.851"></a><span id="l75.851">   } else {</span>
<a href="#l75.852"></a><span id="l75.852" class="difflineminus">-    for (var test of module.__tests__) {</span>
<a href="#l75.853"></a><span id="l75.853" class="difflineplus">+    for (let test of module.__tests__) {</span>
<a href="#l75.854"></a><span id="l75.854">       events.setTest(test);</span>
<a href="#l75.855"></a><span id="l75.855">       events.skip(&quot;setupModule failed.&quot;);</span>
<a href="#l75.856"></a><span id="l75.856">       events.endTest(test);</span>
<a href="#l75.857"></a><span id="l75.857">     }</span>
<a href="#l75.858"></a><span id="l75.858">   }</span>
<a href="#l75.859"></a><span id="l75.859">   if (module.__teardownModule__) {</span>
<a href="#l75.860"></a><span id="l75.860" class="difflineminus">-    events.setState('teardownModule');</span>
<a href="#l75.861"></a><span id="l75.861" class="difflineplus">+    events.setState(&quot;teardownModule&quot;);</span>
<a href="#l75.862"></a><span id="l75.862">     events.setTest(module.__teardownModule__);</span>
<a href="#l75.863"></a><span id="l75.863">     this.wrapper(module.__teardownModule__, module);</span>
<a href="#l75.864"></a><span id="l75.864">     events.endTest(module.__teardownModule__);</span>
<a href="#l75.865"></a><span id="l75.865">   }</span>
<a href="#l75.866"></a><span id="l75.866"> </span>
<a href="#l75.867"></a><span id="l75.867">   observer.unregister();</span>
<a href="#l75.868"></a><span id="l75.868"> </span>
<a href="#l75.869"></a><span id="l75.869" class="difflineminus">-  module.__status__ = 'done';</span>
<a href="#l75.870"></a><span id="l75.870" class="difflineminus">-}</span>
<a href="#l75.871"></a><span id="l75.871" class="difflineplus">+  module.__status__ = &quot;done&quot;;</span>
<a href="#l75.872"></a><span id="l75.872" class="difflineplus">+};</span>
<a href="#l75.873"></a><span id="l75.873"> </span>
<a href="#l75.874"></a><span id="l75.874" class="difflineminus">-Runner.prototype.runTestModule = function (module) {</span>
<a href="#l75.875"></a><span id="l75.875" class="difflineplus">+Runner.prototype.runTestModule = function(module) {</span>
<a href="#l75.876"></a><span id="l75.876">   if (module.__requirements__ != undefined &amp;&amp; module.__force_skip__ == undefined) {</span>
<a href="#l75.877"></a><span id="l75.877" class="difflineminus">-    if (!arrays.inArray(this.collector.loaded_directories, module.__root_path__)) {</span>
<a href="#l75.878"></a><span id="l75.878" class="difflineplus">+    if (!this.collector.loaded_directories.includes(module.__root_path__)) {</span>
<a href="#l75.879"></a><span id="l75.879">       if (module.__root_path__ != undefined) {</span>
<a href="#l75.880"></a><span id="l75.880">         this.collector.initTestDirectory(module.__root_path__);</span>
<a href="#l75.881"></a><span id="l75.881">       }</span>
<a href="#l75.882"></a><span id="l75.882">     }</span>
<a href="#l75.883"></a><span id="l75.883" class="difflineminus">-    var deps = this.getDependencies(module);</span>
<a href="#l75.884"></a><span id="l75.884" class="difflineminus">-    for (var i in deps) {</span>
<a href="#l75.885"></a><span id="l75.885" class="difflineminus">-      var dep = deps[i];</span>
<a href="#l75.886"></a><span id="l75.886" class="difflineminus">-      if (dep.status != 'done') {</span>
<a href="#l75.887"></a><span id="l75.887" class="difflineminus">-        this._runTestModule(dep);</span>
<a href="#l75.888"></a><span id="l75.888" class="difflineminus">-      }</span>
<a href="#l75.889"></a><span id="l75.889" class="difflineminus">-    }</span>
<a href="#l75.890"></a><span id="l75.890">   }</span>
<a href="#l75.891"></a><span id="l75.891">   this._runTestModule(module);</span>
<a href="#l75.892"></a><span id="l75.892" class="difflineminus">-}</span>
<a href="#l75.893"></a><span id="l75.893" class="difflineplus">+};</span>
<a href="#l75.894"></a><span id="l75.894"> </span>
<a href="#l75.895"></a><span id="l75.895"> </span>
<a href="#l75.896"></a><span id="l75.896" class="difflineminus">-var runTestDirectory = function (dir, invokedFromIDE) {</span>
<a href="#l75.897"></a><span id="l75.897" class="difflineplus">+var runTestDirectory = function(dir, invokedFromIDE) {</span>
<a href="#l75.898"></a><span id="l75.898">   var runner = new Runner(new Collector(), invokedFromIDE);</span>
<a href="#l75.899"></a><span id="l75.899">   runner.runTestDirectory(dir);</span>
<a href="#l75.900"></a><span id="l75.900">   runner.end();</span>
<a href="#l75.901"></a><span id="l75.901">   return true;</span>
<a href="#l75.902"></a><span id="l75.902" class="difflineminus">-}</span>
<a href="#l75.903"></a><span id="l75.903" class="difflineminus">-var runTestFile = function (filename, invokedFromIDE) {</span>
<a href="#l75.904"></a><span id="l75.904" class="difflineplus">+};</span>
<a href="#l75.905"></a><span id="l75.905" class="difflineplus">+var runTestFile = function(filename, invokedFromIDE) {</span>
<a href="#l75.906"></a><span id="l75.906">   var runner = new Runner(new Collector(), invokedFromIDE);</span>
<a href="#l75.907"></a><span id="l75.907">   runner.runTestFile(filename);</span>
<a href="#l75.908"></a><span id="l75.908">   runner.end();</span>
<a href="#l75.909"></a><span id="l75.909">   return true;</span>
<a href="#l75.910"></a><span id="l75.910" class="difflineminus">-}</span>
<a href="#l75.911"></a><span id="l75.911" class="difflineplus">+};</span>
<a href="#l75.912"></a><span id="l75.912"> </span>
<a href="#l75.913"></a><span id="l75.913" class="difflineminus">-var getThread = function () {</span>
<a href="#l75.914"></a><span id="l75.914" class="difflineplus">+var getThread = function() {</span>
<a href="#l75.915"></a><span id="l75.915">   return thread;</span>
<a href="#l75.916"></a><span id="l75.916" class="difflineminus">-}</span>
<a href="#l75.917"></a><span id="l75.917" class="difflineplus">+};</span>
<a href="#l75.918"></a><span id="l75.918"> </span>
<a href="#l75.919"></a><span id="l75.919"> function registerModule(name, path) {</span>
<a href="#l75.920"></a><span id="l75.920">   let protocolHandler = Services.io.getProtocolHandler(&quot;resource&quot;)</span>
<a href="#l75.921"></a><span id="l75.921">                                 .QueryInterface(Ci.nsIResProtocolHandler);</span>
<a href="#l75.922"></a><span id="l75.922"> </span>
<a href="#l75.923"></a><span id="l75.923" class="difflineminus">-  let modulesFile = Cc[&quot;@mozilla.org/file/local;1&quot;]</span>
<a href="#l75.924"></a><span id="l75.924" class="difflineminus">-                      .createInstance(Ci.nsIFile);</span>
<a href="#l75.925"></a><span id="l75.925" class="difflineplus">+  let modulesFile = Cc[&quot;@mozilla.org/file/local;1&quot;].createInstance(Ci.nsIFile);</span>
<a href="#l75.926"></a><span id="l75.926">   modulesFile.initWithPath(path);</span>
<a href="#l75.927"></a><span id="l75.927" class="difflineminus">-  protocolHandler.setSubstitution(name, ios.newFileURI(modulesFile));</span>
<a href="#l75.928"></a><span id="l75.928" class="difflineplus">+  protocolHandler.setSubstitution(name, Services.io.newFileURI(modulesFile));</span>
<a href="#l75.929"></a><span id="l75.929"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l76.1"></a><span id="l76.1">rename from mail/test/resources/mozmill/mozmill/extension/content/modules/init.js</span>
<a href="#l76.2"></a><span id="l76.2">rename to mail/test/resources/mozmill/mozmill/extension/content/modules/init.jsm</span>
<a href="#l76.3"></a><span id="l76.3" class="difflineminus">--- a/mail/test/resources/mozmill/mozmill/extension/content/modules/init.js</span>
<a href="#l76.4"></a><span id="l76.4" class="difflineplus">+++ b/mail/test/resources/mozmill/mozmill/extension/content/modules/init.jsm</span>
<a href="#l76.5"></a><span id="l76.5" class="difflineat">@@ -34,62 +34,64 @@</span>
<a href="#l76.6"></a><span id="l76.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l76.7"></a><span id="l76.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l76.8"></a><span id="l76.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l76.9"></a><span id="l76.9">  *</span>
<a href="#l76.10"></a><span id="l76.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l76.11"></a><span id="l76.11"> </span>
<a href="#l76.12"></a><span id="l76.12"> var EXPORTED_SYMBOLS = [&quot;mozmill&quot;];</span>
<a href="#l76.13"></a><span id="l76.13"> </span>
<a href="#l76.14"></a><span id="l76.14" class="difflineminus">-var controller = ChromeUtils.import(&quot;chrome://mozmill/content/modules/controller.js&quot;);</span>
<a href="#l76.15"></a><span id="l76.15" class="difflineminus">-var mozmill = ChromeUtils.import(&quot;chrome://mozmill/content/modules/mozmill.js&quot;);</span>
<a href="#l76.16"></a><span id="l76.16" class="difflineminus">-var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.js&quot;);</span>
<a href="#l76.17"></a><span id="l76.17" class="difflineplus">+const {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l76.18"></a><span id="l76.18" class="difflineplus">+</span>
<a href="#l76.19"></a><span id="l76.19" class="difflineplus">+const controller = ChromeUtils.import(&quot;chrome://mozmill/content/modules/controller.jsm&quot;);</span>
<a href="#l76.20"></a><span id="l76.20" class="difflineplus">+const mozmill = ChromeUtils.import(&quot;chrome://mozmill/content/modules/mozmill.jsm&quot;);</span>
<a href="#l76.21"></a><span id="l76.21" class="difflineplus">+const utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.jsm&quot;);</span>
<a href="#l76.22"></a><span id="l76.22"> </span>
<a href="#l76.23"></a><span id="l76.23"> </span>
<a href="#l76.24"></a><span id="l76.24"> // Observer when a new top-level window is ready</span>
<a href="#l76.25"></a><span id="l76.25"> var windowReadyObserver = {</span>
<a href="#l76.26"></a><span id="l76.26" class="difflineminus">-  observe: function (subject, topic, data) {</span>
<a href="#l76.27"></a><span id="l76.27" class="difflineplus">+  observe(subject, topic, data) {</span>
<a href="#l76.28"></a><span id="l76.28">     attachEventListeners(subject);</span>
<a href="#l76.29"></a><span id="l76.29" class="difflineminus">-  }</span>
<a href="#l76.30"></a><span id="l76.30" class="difflineplus">+  },</span>
<a href="#l76.31"></a><span id="l76.31"> };</span>
<a href="#l76.32"></a><span id="l76.32"> </span>
<a href="#l76.33"></a><span id="l76.33"> </span>
<a href="#l76.34"></a><span id="l76.34"> // Observer when a top-level window is closed</span>
<a href="#l76.35"></a><span id="l76.35"> var windowCloseObserver = {</span>
<a href="#l76.36"></a><span id="l76.36" class="difflineminus">-  observe: function (subject, topic, data) {</span>
<a href="#l76.37"></a><span id="l76.37" class="difflineplus">+  observe(subject, topic, data) {</span>
<a href="#l76.38"></a><span id="l76.38">     controller.windowMap.remove(utils.getWindowId(subject));</span>
<a href="#l76.39"></a><span id="l76.39" class="difflineminus">-  }</span>
<a href="#l76.40"></a><span id="l76.40" class="difflineplus">+  },</span>
<a href="#l76.41"></a><span id="l76.41"> };</span>
<a href="#l76.42"></a><span id="l76.42"> </span>
<a href="#l76.43"></a><span id="l76.43"> </span>
<a href="#l76.44"></a><span id="l76.44"> /**</span>
<a href="#l76.45"></a><span id="l76.45">  * Attach event listeners</span>
<a href="#l76.46"></a><span id="l76.46">  */</span>
<a href="#l76.47"></a><span id="l76.47"> function attachEventListeners(aWindow) {</span>
<a href="#l76.48"></a><span id="l76.48" class="difflineminus">-  aWindow.addEventListener(&quot;load&quot;, function (event) {</span>
<a href="#l76.49"></a><span id="l76.49" class="difflineplus">+  aWindow.addEventListener(&quot;load&quot;, function(event) {</span>
<a href="#l76.50"></a><span id="l76.50">     controller.windowMap.update(utils.getWindowId(aWindow), &quot;loaded&quot;, true);</span>
<a href="#l76.51"></a><span id="l76.51"> </span>
<a href="#l76.52"></a><span id="l76.52">     if (&quot;gBrowser&quot; in aWindow) {</span>
<a href="#l76.53"></a><span id="l76.53">       // Page is ready</span>
<a href="#l76.54"></a><span id="l76.54" class="difflineminus">-      aWindow.gBrowser.addEventListener(&quot;load&quot;, function (event) {</span>
<a href="#l76.55"></a><span id="l76.55" class="difflineplus">+      aWindow.gBrowser.addEventListener(&quot;load&quot;, function(event) {</span>
<a href="#l76.56"></a><span id="l76.56">         var doc = event.originalTarget;</span>
<a href="#l76.57"></a><span id="l76.57"> </span>
<a href="#l76.58"></a><span id="l76.58">         // Only update the flag if we have a document as target</span>
<a href="#l76.59"></a><span id="l76.59">         if (&quot;defaultView&quot; in doc) {</span>
<a href="#l76.60"></a><span id="l76.60">           var id = utils.getWindowId(doc.defaultView);</span>
<a href="#l76.61"></a><span id="l76.61">           controller.windowMap.update(id, &quot;loaded&quot;, true);</span>
<a href="#l76.62"></a><span id="l76.62">           // dump(&quot;*** load event: &quot; + id + &quot;, &quot; + doc.location + &quot;, baseURI=&quot; + doc.baseURI + &quot;\n&quot;);</span>
<a href="#l76.63"></a><span id="l76.63">         }</span>
<a href="#l76.64"></a><span id="l76.64">       }, true);</span>
<a href="#l76.65"></a><span id="l76.65"> </span>
<a href="#l76.66"></a><span id="l76.66">       // Note: Error pages will never fire a &quot;load&quot; event. For those we</span>
<a href="#l76.67"></a><span id="l76.67">       // have to wait for the &quot;DOMContentLoaded&quot; event. That's the final state.</span>
<a href="#l76.68"></a><span id="l76.68">       // Error pages will always have a baseURI starting with</span>
<a href="#l76.69"></a><span id="l76.69">       // &quot;about:&quot; followed by &quot;error&quot; or &quot;blocked&quot;.</span>
<a href="#l76.70"></a><span id="l76.70" class="difflineminus">-      aWindow.gBrowser.addEventListener(&quot;DOMContentLoaded&quot;, function (event) {</span>
<a href="#l76.71"></a><span id="l76.71" class="difflineplus">+      aWindow.gBrowser.addEventListener(&quot;DOMContentLoaded&quot;, function(event) {</span>
<a href="#l76.72"></a><span id="l76.72">         var doc = event.originalTarget;</span>
<a href="#l76.73"></a><span id="l76.73"> </span>
<a href="#l76.74"></a><span id="l76.74">         var errorRegex = /about:.+(error)|(blocked)\?/;</span>
<a href="#l76.75"></a><span id="l76.75">         if (errorRegex.exec(doc.baseURI)) {</span>
<a href="#l76.76"></a><span id="l76.76">           // Wait about 1s to be sure the DOM is ready</span>
<a href="#l76.77"></a><span id="l76.77">           mozmill.utils.sleep(1000);</span>
<a href="#l76.78"></a><span id="l76.78"> </span>
<a href="#l76.79"></a><span id="l76.79">           // Only update the flag if we have a document as target</span>
<a href="#l76.80"></a><span id="l76.80" class="difflineat">@@ -97,47 +99,44 @@ function attachEventListeners(aWindow) {</span>
<a href="#l76.81"></a><span id="l76.81">             var id = utils.getWindowId(doc.defaultView);</span>
<a href="#l76.82"></a><span id="l76.82">             controller.windowMap.update(id, &quot;loaded&quot;, true);</span>
<a href="#l76.83"></a><span id="l76.83">             // dump(&quot;*** load event: &quot; + id + &quot;, &quot; + doc.location + &quot;, baseURI=&quot; + doc.baseURI + &quot;\n&quot;);</span>
<a href="#l76.84"></a><span id="l76.84">           }</span>
<a href="#l76.85"></a><span id="l76.85">         }</span>
<a href="#l76.86"></a><span id="l76.86">       }, true);</span>
<a href="#l76.87"></a><span id="l76.87"> </span>
<a href="#l76.88"></a><span id="l76.88">       // Page is about to get unloaded</span>
<a href="#l76.89"></a><span id="l76.89" class="difflineminus">-      aWindow.gBrowser.addEventListener(&quot;beforeunload&quot;, function (event) {</span>
<a href="#l76.90"></a><span id="l76.90" class="difflineplus">+      aWindow.gBrowser.addEventListener(&quot;beforeunload&quot;, function(event) {</span>
<a href="#l76.91"></a><span id="l76.91">         var doc = event.originalTarget;</span>
<a href="#l76.92"></a><span id="l76.92"> </span>
<a href="#l76.93"></a><span id="l76.93">         // Only update the flag if we have a document as target</span>
<a href="#l76.94"></a><span id="l76.94">         if (&quot;defaultView&quot; in doc) {</span>
<a href="#l76.95"></a><span id="l76.95">           var id = utils.getWindowId(doc.defaultView);</span>
<a href="#l76.96"></a><span id="l76.96">           controller.windowMap.update(id, &quot;loaded&quot;, false);</span>
<a href="#l76.97"></a><span id="l76.97">           // dump(&quot;*** beforeunload event: &quot; + id + &quot;, &quot; + doc.location + &quot;, baseURI=&quot; + doc.baseURI + &quot;\n&quot;);</span>
<a href="#l76.98"></a><span id="l76.98">         }</span>
<a href="#l76.99"></a><span id="l76.99">       }, true);</span>
<a href="#l76.100"></a><span id="l76.100">     }</span>
<a href="#l76.101"></a><span id="l76.101" class="difflineminus">-  }, false);</span>
<a href="#l76.102"></a><span id="l76.102" class="difflineplus">+  });</span>
<a href="#l76.103"></a><span id="l76.103"> }</span>
<a href="#l76.104"></a><span id="l76.104"> </span>
<a href="#l76.105"></a><span id="l76.105"> /**</span>
<a href="#l76.106"></a><span id="l76.106">  * Initialize Mozmill</span>
<a href="#l76.107"></a><span id="l76.107">  */</span>
<a href="#l76.108"></a><span id="l76.108"> function initialize() {</span>
<a href="#l76.109"></a><span id="l76.109">   // Activate observer for new top level windows</span>
<a href="#l76.110"></a><span id="l76.110" class="difflineminus">-  var observerService = Cc[&quot;@mozilla.org/observer-service;1&quot;].</span>
<a href="#l76.111"></a><span id="l76.111" class="difflineminus">-                        getService(Ci.nsIObserverService);</span>
<a href="#l76.112"></a><span id="l76.112" class="difflineminus">-  observerService.addObserver(windowReadyObserver, &quot;toplevel-window-ready&quot;);</span>
<a href="#l76.113"></a><span id="l76.113" class="difflineminus">-  observerService.addObserver(windowCloseObserver, &quot;outer-window-destroyed&quot;);</span>
<a href="#l76.114"></a><span id="l76.114" class="difflineplus">+  Services.obs.addObserver(windowReadyObserver, &quot;toplevel-window-ready&quot;);</span>
<a href="#l76.115"></a><span id="l76.115" class="difflineplus">+  Services.obs.addObserver(windowCloseObserver, &quot;outer-window-destroyed&quot;);</span>
<a href="#l76.116"></a><span id="l76.116"> </span>
<a href="#l76.117"></a><span id="l76.117">   // Attach event listeners to all open windows</span>
<a href="#l76.118"></a><span id="l76.118" class="difflineminus">-  var enumerator = Cc[&quot;@mozilla.org/appshell/window-mediator;1&quot;].</span>
<a href="#l76.119"></a><span id="l76.119" class="difflineminus">-                   getService(Ci.nsIWindowMediator).getEnumerator(&quot;&quot;);</span>
<a href="#l76.120"></a><span id="l76.120" class="difflineplus">+  var enumerator = Services.wm.getEnumerator(&quot;&quot;);</span>
<a href="#l76.121"></a><span id="l76.121">   while (enumerator.hasMoreElements()) {</span>
<a href="#l76.122"></a><span id="l76.122">     var win = enumerator.getNext();</span>
<a href="#l76.123"></a><span id="l76.123">     attachEventListeners(win);</span>
<a href="#l76.124"></a><span id="l76.124"> </span>
<a href="#l76.125"></a><span id="l76.125">     // For windows or dialogs already open we have to explicitly set the property</span>
<a href="#l76.126"></a><span id="l76.126">     // otherwise windows which load really quick on startup never gets the</span>
<a href="#l76.127"></a><span id="l76.127">     // property set and we fail to create the controller</span>
<a href="#l76.128"></a><span id="l76.128">     controller.windowMap.update(utils.getWindowId(win), &quot;loaded&quot;, true);</span>
<a href="#l76.129"></a><span id="l76.129" class="difflineminus">-  };</span>
<a href="#l76.130"></a><span id="l76.130" class="difflineplus">+  }</span>
<a href="#l76.131"></a><span id="l76.131"> }</span>
<a href="#l76.132"></a><span id="l76.132"> </span>
<a href="#l76.133"></a><span id="l76.133"> initialize();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l77.1"></a><span id="l77.1">deleted file mode 100644</span>
<a href="#l77.2"></a><span id="l77.2" class="difflineminus">--- a/mail/test/resources/mozmill/mozmill/extension/content/modules/inspection.js</span>
<a href="#l77.3"></a><span id="l77.3" class="difflineplus">+++ /dev/null</span>
<a href="#l77.4"></a><span id="l77.4" class="difflineat">@@ -1,394 +0,0 @@</span>
<a href="#l77.5"></a><span id="l77.5" class="difflineminus">-// ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l77.6"></a><span id="l77.6" class="difflineminus">-// Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l77.7"></a><span id="l77.7" class="difflineminus">-//</span>
<a href="#l77.8"></a><span id="l77.8" class="difflineminus">-// The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l77.9"></a><span id="l77.9" class="difflineminus">-// 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l77.10"></a><span id="l77.10" class="difflineminus">-// the License. You may obtain a copy of the License at</span>
<a href="#l77.11"></a><span id="l77.11" class="difflineminus">-// http://www.mozilla.org/MPL/</span>
<a href="#l77.12"></a><span id="l77.12" class="difflineminus">-//</span>
<a href="#l77.13"></a><span id="l77.13" class="difflineminus">-// Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l77.14"></a><span id="l77.14" class="difflineminus">-// WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l77.15"></a><span id="l77.15" class="difflineminus">-// for the specific language governing rights and limitations under the</span>
<a href="#l77.16"></a><span id="l77.16" class="difflineminus">-// License.</span>
<a href="#l77.17"></a><span id="l77.17" class="difflineminus">-//</span>
<a href="#l77.18"></a><span id="l77.18" class="difflineminus">-// The Original Code is Mozilla Corporation Code.</span>
<a href="#l77.19"></a><span id="l77.19" class="difflineminus">-//</span>
<a href="#l77.20"></a><span id="l77.20" class="difflineminus">-// The Initial Developer of the Original Code is</span>
<a href="#l77.21"></a><span id="l77.21" class="difflineminus">-// Mikeal Rogers.</span>
<a href="#l77.22"></a><span id="l77.22" class="difflineminus">-// Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l77.23"></a><span id="l77.23" class="difflineminus">-// the Initial Developer. All Rights Reserved.</span>
<a href="#l77.24"></a><span id="l77.24" class="difflineminus">-//</span>
<a href="#l77.25"></a><span id="l77.25" class="difflineminus">-// Contributor(s):</span>
<a href="#l77.26"></a><span id="l77.26" class="difflineminus">-//  Mikeal Rogers &lt;mikeal.rogers@gmail.com&gt;</span>
<a href="#l77.27"></a><span id="l77.27" class="difflineminus">-//</span>
<a href="#l77.28"></a><span id="l77.28" class="difflineminus">-// Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l77.29"></a><span id="l77.29" class="difflineminus">-// either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l77.30"></a><span id="l77.30" class="difflineminus">-// the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l77.31"></a><span id="l77.31" class="difflineminus">-// in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l77.32"></a><span id="l77.32" class="difflineminus">-// of those above. If you wish to allow use of your version of this file only</span>
<a href="#l77.33"></a><span id="l77.33" class="difflineminus">-// under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l77.34"></a><span id="l77.34" class="difflineminus">-// use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l77.35"></a><span id="l77.35" class="difflineminus">-// decision by deleting the provisions above and replace them with the notice</span>
<a href="#l77.36"></a><span id="l77.36" class="difflineminus">-// and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l77.37"></a><span id="l77.37" class="difflineminus">-// the provisions above, a recipient may use your version of this file under</span>
<a href="#l77.38"></a><span id="l77.38" class="difflineminus">-// the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l77.39"></a><span id="l77.39" class="difflineminus">-//</span>
<a href="#l77.40"></a><span id="l77.40" class="difflineminus">-// ***** END LICENSE BLOCK *****</span>
<a href="#l77.41"></a><span id="l77.41" class="difflineminus">-</span>
<a href="#l77.42"></a><span id="l77.42" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;inspectElement&quot;]</span>
<a href="#l77.43"></a><span id="l77.43" class="difflineminus">-</span>
<a href="#l77.44"></a><span id="l77.44" class="difflineminus">-var elementslib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l77.45"></a><span id="l77.45" class="difflineminus">-var mozmill = ChromeUtils.import(&quot;chrome://mozmill/content/modules/mozmill.js&quot;);</span>
<a href="#l77.46"></a><span id="l77.46" class="difflineminus">-var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.js&quot;);</span>
<a href="#l77.47"></a><span id="l77.47" class="difflineminus">-</span>
<a href="#l77.48"></a><span id="l77.48" class="difflineminus">-var arrays = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/arrays.js&quot;);</span>
<a href="#l77.49"></a><span id="l77.49" class="difflineminus">-var dom = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/dom.js&quot;);</span>
<a href="#l77.50"></a><span id="l77.50" class="difflineminus">-var objects = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/objects.js&quot;);</span>
<a href="#l77.51"></a><span id="l77.51" class="difflineminus">-var json2 = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/json2.js&quot;);</span>
<a href="#l77.52"></a><span id="l77.52" class="difflineminus">-var withs = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/withs.js&quot;);</span>
<a href="#l77.53"></a><span id="l77.53" class="difflineminus">-</span>
<a href="#l77.54"></a><span id="l77.54" class="difflineminus">-var wm = Cc[&quot;@mozilla.org/appshell/window-mediator;1&quot;]</span>
<a href="#l77.55"></a><span id="l77.55" class="difflineminus">-           .getService(Ci.nsIWindowMediator);</span>
<a href="#l77.56"></a><span id="l77.56" class="difflineminus">-</span>
<a href="#l77.57"></a><span id="l77.57" class="difflineminus">-var isNotAnonymous = function (elem, result) {</span>
<a href="#l77.58"></a><span id="l77.58" class="difflineminus">-  if (result == undefined) {</span>
<a href="#l77.59"></a><span id="l77.59" class="difflineminus">-    var result = true;</span>
<a href="#l77.60"></a><span id="l77.60" class="difflineminus">-  }</span>
<a href="#l77.61"></a><span id="l77.61" class="difflineminus">-  if ( elem.parentNode ) {</span>
<a href="#l77.62"></a><span id="l77.62" class="difflineminus">-    var p = elem.parentNode;</span>
<a href="#l77.63"></a><span id="l77.63" class="difflineminus">-    return isNotAnonymous(p, result == arrays.inArray(p.childNodes, elem) == true);</span>
<a href="#l77.64"></a><span id="l77.64" class="difflineminus">-  } else {</span>
<a href="#l77.65"></a><span id="l77.65" class="difflineminus">-    return result;</span>
<a href="#l77.66"></a><span id="l77.66" class="difflineminus">-  }</span>
<a href="#l77.67"></a><span id="l77.67" class="difflineminus">-}</span>
<a href="#l77.68"></a><span id="l77.68" class="difflineminus">-</span>
<a href="#l77.69"></a><span id="l77.69" class="difflineminus">-var elemIsAnonymous = function (elem) {</span>
<a href="#l77.70"></a><span id="l77.70" class="difflineminus">-  if (elem.getAttribute('anonid') || !arrays.inArray(elem.parentNode.childNodes, elem)) {</span>
<a href="#l77.71"></a><span id="l77.71" class="difflineminus">-    return true;</span>
<a href="#l77.72"></a><span id="l77.72" class="difflineminus">-  }</span>
<a href="#l77.73"></a><span id="l77.73" class="difflineminus">-  return false;</span>
<a href="#l77.74"></a><span id="l77.74" class="difflineminus">-}</span>
<a href="#l77.75"></a><span id="l77.75" class="difflineminus">-</span>
<a href="#l77.76"></a><span id="l77.76" class="difflineminus">-var getXPath = function (node, path) {</span>
<a href="#l77.77"></a><span id="l77.77" class="difflineminus">-  path = path || [];</span>
<a href="#l77.78"></a><span id="l77.78" class="difflineminus">-</span>
<a href="#l77.79"></a><span id="l77.79" class="difflineminus">-  if(node.parentNode) {</span>
<a href="#l77.80"></a><span id="l77.80" class="difflineminus">-    path = getXPath(node.parentNode, path);</span>
<a href="#l77.81"></a><span id="l77.81" class="difflineminus">-  }</span>
<a href="#l77.82"></a><span id="l77.82" class="difflineminus">-</span>
<a href="#l77.83"></a><span id="l77.83" class="difflineminus">-  if(node.previousSibling) {</span>
<a href="#l77.84"></a><span id="l77.84" class="difflineminus">-    var count = 1;</span>
<a href="#l77.85"></a><span id="l77.85" class="difflineminus">-    var sibling = node.previousSibling</span>
<a href="#l77.86"></a><span id="l77.86" class="difflineminus">-    do {</span>
<a href="#l77.87"></a><span id="l77.87" class="difflineminus">-      if(sibling.nodeType == 1 &amp;&amp; sibling.nodeName == node.nodeName) {count++;}</span>
<a href="#l77.88"></a><span id="l77.88" class="difflineminus">-      sibling = sibling.previousSibling;</span>
<a href="#l77.89"></a><span id="l77.89" class="difflineminus">-    } while(sibling);</span>
<a href="#l77.90"></a><span id="l77.90" class="difflineminus">-    if(count == 1) {count = null;}</span>
<a href="#l77.91"></a><span id="l77.91" class="difflineminus">-  } else if(node.nextSibling) {</span>
<a href="#l77.92"></a><span id="l77.92" class="difflineminus">-    var sibling = node.nextSibling;</span>
<a href="#l77.93"></a><span id="l77.93" class="difflineminus">-    do {</span>
<a href="#l77.94"></a><span id="l77.94" class="difflineminus">-      if(sibling.nodeType == 1 &amp;&amp; sibling.nodeName == node.nodeName) {</span>
<a href="#l77.95"></a><span id="l77.95" class="difflineminus">-        var count = 1;</span>
<a href="#l77.96"></a><span id="l77.96" class="difflineminus">-        sibling = null;</span>
<a href="#l77.97"></a><span id="l77.97" class="difflineminus">-      } else {</span>
<a href="#l77.98"></a><span id="l77.98" class="difflineminus">-        var count = null;</span>
<a href="#l77.99"></a><span id="l77.99" class="difflineminus">-        sibling = sibling.previousSibling;</span>
<a href="#l77.100"></a><span id="l77.100" class="difflineminus">-      }</span>
<a href="#l77.101"></a><span id="l77.101" class="difflineminus">-    } while(sibling);</span>
<a href="#l77.102"></a><span id="l77.102" class="difflineminus">-  }</span>
<a href="#l77.103"></a><span id="l77.103" class="difflineminus">-</span>
<a href="#l77.104"></a><span id="l77.104" class="difflineminus">-  if(node.nodeType == 1) {</span>
<a href="#l77.105"></a><span id="l77.105" class="difflineminus">- //   if ($('absXpaths').checked){</span>
<a href="#l77.106"></a><span id="l77.106" class="difflineminus">-      path.push(node.nodeName.toLowerCase() + (node.id ? &quot;[@id='&quot;+node.id+&quot;']&quot; : count &gt; 0 ? &quot;[&quot;+count+&quot;]&quot; : ''));</span>
<a href="#l77.107"></a><span id="l77.107" class="difflineminus">-  //  }</span>
<a href="#l77.108"></a><span id="l77.108" class="difflineminus">-  //  else{</span>
<a href="#l77.109"></a><span id="l77.109" class="difflineminus">-  //    path.push(node.nodeName.toLowerCase() + (node.id ? &quot;&quot; : count &gt; 0 ? &quot;[&quot;+count+&quot;]&quot; : ''));</span>
<a href="#l77.110"></a><span id="l77.110" class="difflineminus">-  //  }</span>
<a href="#l77.111"></a><span id="l77.111" class="difflineminus">-  }</span>
<a href="#l77.112"></a><span id="l77.112" class="difflineminus">-  return path;</span>
<a href="#l77.113"></a><span id="l77.113" class="difflineminus">-};</span>
<a href="#l77.114"></a><span id="l77.114" class="difflineminus">-</span>
<a href="#l77.115"></a><span id="l77.115" class="difflineminus">-function getXSPath(node){</span>
<a href="#l77.116"></a><span id="l77.116" class="difflineminus">-  var xpArray = getXPath(node);</span>
<a href="#l77.117"></a><span id="l77.117" class="difflineminus">-  var stringXpath = xpArray.join('/');</span>
<a href="#l77.118"></a><span id="l77.118" class="difflineminus">-  stringXpath = '/'+stringXpath;</span>
<a href="#l77.119"></a><span id="l77.119" class="difflineminus">-  stringXpath = stringXpath.replace('//','/');</span>
<a href="#l77.120"></a><span id="l77.120" class="difflineminus">-  return stringXpath;</span>
<a href="#l77.121"></a><span id="l77.121" class="difflineminus">-}</span>
<a href="#l77.122"></a><span id="l77.122" class="difflineminus">-function getXULXpath (el, xml) {</span>
<a href="#l77.123"></a><span id="l77.123" class="difflineminus">-  var xpath = '';</span>
<a href="#l77.124"></a><span id="l77.124" class="difflineminus">-  var pos, tempitem2;</span>
<a href="#l77.125"></a><span id="l77.125" class="difflineminus">-</span>
<a href="#l77.126"></a><span id="l77.126" class="difflineminus">-  while(el !== xml.documentElement) {</span>
<a href="#l77.127"></a><span id="l77.127" class="difflineminus">-    pos = 0;</span>
<a href="#l77.128"></a><span id="l77.128" class="difflineminus">-    tempitem2 = el;</span>
<a href="#l77.129"></a><span id="l77.129" class="difflineminus">-    while(tempitem2) {</span>
<a href="#l77.130"></a><span id="l77.130" class="difflineminus">-      if (tempitem2.nodeType === 1 &amp;&amp; tempitem2.nodeName === el.nodeName) {</span>
<a href="#l77.131"></a><span id="l77.131" class="difflineminus">-        // If it is ELEMENT_NODE of the same name</span>
<a href="#l77.132"></a><span id="l77.132" class="difflineminus">-        pos += 1;</span>
<a href="#l77.133"></a><span id="l77.133" class="difflineminus">-      }</span>
<a href="#l77.134"></a><span id="l77.134" class="difflineminus">-      tempitem2 = tempitem2.previousSibling;</span>
<a href="#l77.135"></a><span id="l77.135" class="difflineminus">-    }</span>
<a href="#l77.136"></a><span id="l77.136" class="difflineminus">-</span>
<a href="#l77.137"></a><span id="l77.137" class="difflineminus">-    xpath = &quot;*[name()='&quot;+el.nodeName+&quot;' and namespace-uri()='&quot;+(el.namespaceURI===null?'':el.namespaceURI)+&quot;'][&quot;+pos+']'+'/'+xpath;</span>
<a href="#l77.138"></a><span id="l77.138" class="difflineminus">-</span>
<a href="#l77.139"></a><span id="l77.139" class="difflineminus">-    el = el.parentNode;</span>
<a href="#l77.140"></a><span id="l77.140" class="difflineminus">-  }</span>
<a href="#l77.141"></a><span id="l77.141" class="difflineminus">-  xpath = '/*'+&quot;[name()='&quot;+xml.documentElement.nodeName+&quot;' and namespace-uri()='&quot;+(el.namespaceURI===null?'':el.namespaceURI)+&quot;']&quot;+'/'+xpath;</span>
<a href="#l77.142"></a><span id="l77.142" class="difflineminus">-  xpath = xpath.replace(/\/$/, '');</span>
<a href="#l77.143"></a><span id="l77.143" class="difflineminus">-  return xpath;</span>
<a href="#l77.144"></a><span id="l77.144" class="difflineminus">-}</span>
<a href="#l77.145"></a><span id="l77.145" class="difflineminus">-</span>
<a href="#l77.146"></a><span id="l77.146" class="difflineminus">-var getDocument = function (elem) {</span>
<a href="#l77.147"></a><span id="l77.147" class="difflineminus">-  while (elem.parentNode) {</span>
<a href="#l77.148"></a><span id="l77.148" class="difflineminus">-    var elem = elem.parentNode;</span>
<a href="#l77.149"></a><span id="l77.149" class="difflineminus">-  }</span>
<a href="#l77.150"></a><span id="l77.150" class="difflineminus">-  return elem;</span>
<a href="#l77.151"></a><span id="l77.151" class="difflineminus">-}</span>
<a href="#l77.152"></a><span id="l77.152" class="difflineminus">-</span>
<a href="#l77.153"></a><span id="l77.153" class="difflineminus">-var getTopWindow = function(doc) {</span>
<a href="#l77.154"></a><span id="l77.154" class="difflineminus">-  return utils.getChromeWindow(doc.defaultView);</span>
<a href="#l77.155"></a><span id="l77.155" class="difflineminus">-}</span>
<a href="#l77.156"></a><span id="l77.156" class="difflineminus">-</span>
<a href="#l77.157"></a><span id="l77.157" class="difflineminus">-var attributeToIgnore = ['focus', 'focused', 'selected', 'select', 'flex', // General Omissions</span>
<a href="#l77.158"></a><span id="l77.158" class="difflineminus">-                         'linkedpanel', 'last-tab', 'afterselected', // From Tabs UI, thanks Farhad</span>
<a href="#l77.159"></a><span id="l77.159" class="difflineminus">-                         'style', // Gets set dynamically all the time, also effected by dx display code</span>
<a href="#l77.160"></a><span id="l77.160" class="difflineminus">-                         ];</span>
<a href="#l77.161"></a><span id="l77.161" class="difflineminus">-</span>
<a href="#l77.162"></a><span id="l77.162" class="difflineminus">-var getUniqueAttributesReduction = function (attributes, node) {</span>
<a href="#l77.163"></a><span id="l77.163" class="difflineminus">-  for (var i in attributes) {</span>
<a href="#l77.164"></a><span id="l77.164" class="difflineminus">-    if ( node.getAttribute(i) == attributes[i] || arrays.inArray(attributeToIgnore, i) || arrays.inArray(attributeToIgnore, attributes[i]) || i == 'id') {</span>
<a href="#l77.165"></a><span id="l77.165" class="difflineminus">-      delete attributes[i];</span>
<a href="#l77.166"></a><span id="l77.166" class="difflineminus">-    }</span>
<a href="#l77.167"></a><span id="l77.167" class="difflineminus">-  }</span>
<a href="#l77.168"></a><span id="l77.168" class="difflineminus">-  return attributes;</span>
<a href="#l77.169"></a><span id="l77.169" class="difflineminus">-}</span>
<a href="#l77.170"></a><span id="l77.170" class="difflineminus">-</span>
<a href="#l77.171"></a><span id="l77.171" class="difflineminus">-var getLookupExpression = function (_document, elem) {</span>
<a href="#l77.172"></a><span id="l77.172" class="difflineminus">-  expArray = [];</span>
<a href="#l77.173"></a><span id="l77.173" class="difflineminus">-  while ( elem.parentNode ) {</span>
<a href="#l77.174"></a><span id="l77.174" class="difflineminus">-    var exp = getLookupForElem(_document, elem);</span>
<a href="#l77.175"></a><span id="l77.175" class="difflineminus">-    expArray.push(exp);</span>
<a href="#l77.176"></a><span id="l77.176" class="difflineminus">-    var elem = elem.parentNode;</span>
<a href="#l77.177"></a><span id="l77.177" class="difflineminus">-  }</span>
<a href="#l77.178"></a><span id="l77.178" class="difflineminus">-  expArray.reverse();</span>
<a href="#l77.179"></a><span id="l77.179" class="difflineminus">-  return '/' + expArray.join('/');</span>
<a href="#l77.180"></a><span id="l77.180" class="difflineminus">-}</span>
<a href="#l77.181"></a><span id="l77.181" class="difflineminus">-</span>
<a href="#l77.182"></a><span id="l77.182" class="difflineminus">-var getLookupForElem = function (_document, elem) {</span>
<a href="#l77.183"></a><span id="l77.183" class="difflineminus">-  if ( !elemIsAnonymous(elem) ) {</span>
<a href="#l77.184"></a><span id="l77.184" class="difflineminus">-    if (elem.id != &quot;&quot; &amp;&amp; !withs.startsWith(elem.id, 'panel')) {</span>
<a href="#l77.185"></a><span id="l77.185" class="difflineminus">-      identifier = {'name':'id', 'value':elem.id};</span>
<a href="#l77.186"></a><span id="l77.186" class="difflineminus">-    } else if ((elem.name != &quot;&quot;) &amp;&amp; (typeof(elem.name) != &quot;undefined&quot;)) {</span>
<a href="#l77.187"></a><span id="l77.187" class="difflineminus">-      identifier = {'name':'name', 'value':elem.name};</span>
<a href="#l77.188"></a><span id="l77.188" class="difflineminus">-    } else {</span>
<a href="#l77.189"></a><span id="l77.189" class="difflineminus">-      identifier = null;</span>
<a href="#l77.190"></a><span id="l77.190" class="difflineminus">-    }</span>
<a href="#l77.191"></a><span id="l77.191" class="difflineminus">-</span>
<a href="#l77.192"></a><span id="l77.192" class="difflineminus">-    if (identifier) {</span>
<a href="#l77.193"></a><span id="l77.193" class="difflineminus">-      var result = {'id':elementslib._byID, 'name':elementslib._byName}[identifier.name](_document, elem.parentNode, identifier.value);</span>
<a href="#l77.194"></a><span id="l77.194" class="difflineminus">-      if ( typeof(result != 'array') ) {</span>
<a href="#l77.195"></a><span id="l77.195" class="difflineminus">-        return identifier.name+'('+json2.JSON.stringify(identifier.value)+')';</span>
<a href="#l77.196"></a><span id="l77.196" class="difflineminus">-      }</span>
<a href="#l77.197"></a><span id="l77.197" class="difflineminus">-    }</span>
<a href="#l77.198"></a><span id="l77.198" class="difflineminus">-</span>
<a href="#l77.199"></a><span id="l77.199" class="difflineminus">-    // At this point there is either no identifier or it returns multiple</span>
<a href="#l77.200"></a><span id="l77.200" class="difflineminus">-    var parse = Array.from(elem.parentNode.childNodes).</span>
<a href="#l77.201"></a><span id="l77.201" class="difflineminus">-      filter(n =&gt; n.getAttribute &amp;&amp; n != elem);</span>
<a href="#l77.202"></a><span id="l77.202" class="difflineminus">-    parse.unshift(dom.getAttributes(elem));</span>
<a href="#l77.203"></a><span id="l77.203" class="difflineminus">-    var uniqueAttributes = parse.reduce(getUniqueAttributesReduction);</span>
<a href="#l77.204"></a><span id="l77.204" class="difflineminus">-</span>
<a href="#l77.205"></a><span id="l77.205" class="difflineminus">-    if (!result) {</span>
<a href="#l77.206"></a><span id="l77.206" class="difflineminus">-      var result = elementslib._byAttrib(elem.parentNode, uniqueAttributes);</span>
<a href="#l77.207"></a><span id="l77.207" class="difflineminus">-    }</span>
<a href="#l77.208"></a><span id="l77.208" class="difflineminus">-</span>
<a href="#l77.209"></a><span id="l77.209" class="difflineminus">-    if (!identifier &amp;&amp; typeof(result) == 'array' ) {</span>
<a href="#l77.210"></a><span id="l77.210" class="difflineminus">-      return json2.JSON.stringify(uniqueAttributes) + '['+arrays.indexOf(result, elem)+']'</span>
<a href="#l77.211"></a><span id="l77.211" class="difflineminus">-    } else {</span>
<a href="#l77.212"></a><span id="l77.212" class="difflineminus">-      var aresult = elementslib._byAttrib(elem.parentNode, uniqueAttributes);</span>
<a href="#l77.213"></a><span id="l77.213" class="difflineminus">-      if ( typeof(aresult != 'array') ) {</span>
<a href="#l77.214"></a><span id="l77.214" class="difflineminus">-        if (objects.getLength(uniqueAttributes) == 0) {</span>
<a href="#l77.215"></a><span id="l77.215" class="difflineminus">-          return '['+arrays.indexOf(elem.parentNode.childNodes, elem)+']'</span>
<a href="#l77.216"></a><span id="l77.216" class="difflineminus">-        }</span>
<a href="#l77.217"></a><span id="l77.217" class="difflineminus">-        return json2.JSON.stringify(uniqueAttributes)</span>
<a href="#l77.218"></a><span id="l77.218" class="difflineminus">-      } else if ( result.length &gt; aresult.length ) {</span>
<a href="#l77.219"></a><span id="l77.219" class="difflineminus">-        return json2.JSON.stringify(uniqueAttributes) + '['+arrays.indexOf(aresult, elem)+']'</span>
<a href="#l77.220"></a><span id="l77.220" class="difflineminus">-      } else {</span>
<a href="#l77.221"></a><span id="l77.221" class="difflineminus">-        return identifier.name+'('+json2.JSON.stringify(identifier.value)+')' + '['+arrays.indexOf(result, elem)+']'</span>
<a href="#l77.222"></a><span id="l77.222" class="difflineminus">-      }</span>
<a href="#l77.223"></a><span id="l77.223" class="difflineminus">-    }</span>
<a href="#l77.224"></a><span id="l77.224" class="difflineminus">-</span>
<a href="#l77.225"></a><span id="l77.225" class="difflineminus">-  } else {</span>
<a href="#l77.226"></a><span id="l77.226" class="difflineminus">-    // Handle Anonymous Nodes</span>
<a href="#l77.227"></a><span id="l77.227" class="difflineminus">-    var parse = Array.from(_document.getAnonymousNodes(elem.parentNode) || []).</span>
<a href="#l77.228"></a><span id="l77.228" class="difflineminus">-      filter(n =&gt; n.getAttribute &amp;&amp; n != elem);</span>
<a href="#l77.229"></a><span id="l77.229" class="difflineminus">-    parse.unshift(dom.getAttributes(elem));</span>
<a href="#l77.230"></a><span id="l77.230" class="difflineminus">-    var uniqueAttributes = parse.reduce(getUniqueAttributesReduction);</span>
<a href="#l77.231"></a><span id="l77.231" class="difflineminus">-    if (uniqueAttributes.anonid &amp;&amp; typeof(elementslib._byAnonAttrib(_document,</span>
<a href="#l77.232"></a><span id="l77.232" class="difflineminus">-        elem.parentNode, {'anonid':uniqueAttributes.anonid})) != 'array') {</span>
<a href="#l77.233"></a><span id="l77.233" class="difflineminus">-      uniqueAttributes = {'anonid':uniqueAttributes.anonid};</span>
<a href="#l77.234"></a><span id="l77.234" class="difflineminus">-    }</span>
<a href="#l77.235"></a><span id="l77.235" class="difflineminus">-</span>
<a href="#l77.236"></a><span id="l77.236" class="difflineminus">-    if (objects.getLength(uniqueAttributes) == 0) {</span>
<a href="#l77.237"></a><span id="l77.237" class="difflineminus">-      return 'anon(['+arrays.indexOf(_document.getAnonymousNodes(elem.parentNode), elem)+'])';</span>
<a href="#l77.238"></a><span id="l77.238" class="difflineminus">-    } else if (arrays.inArray(uniqueAttributes, 'anonid')) {</span>
<a href="#l77.239"></a><span id="l77.239" class="difflineminus">-      return 'anon({&quot;anonid&quot;:&quot;'+uniqueAttributes['anonid']+'&quot;})';</span>
<a href="#l77.240"></a><span id="l77.240" class="difflineminus">-    } else {</span>
<a href="#l77.241"></a><span id="l77.241" class="difflineminus">-      return 'anon('+json2.JSON.stringify(uniqueAttributes)+')';</span>
<a href="#l77.242"></a><span id="l77.242" class="difflineminus">-    }</span>
<a href="#l77.243"></a><span id="l77.243" class="difflineminus">-</span>
<a href="#l77.244"></a><span id="l77.244" class="difflineminus">-  }</span>
<a href="#l77.245"></a><span id="l77.245" class="difflineminus">-  return 'broken '+elemIsAnonymous(elem)</span>
<a href="#l77.246"></a><span id="l77.246" class="difflineminus">-}</span>
<a href="#l77.247"></a><span id="l77.247" class="difflineminus">-</span>
<a href="#l77.248"></a><span id="l77.248" class="difflineminus">-var removeHTMLTags = function(str){</span>
<a href="#l77.249"></a><span id="l77.249" class="difflineminus">-  str = str.replace(/&amp;(lt|gt);/g, function (strMatch, p1) {</span>
<a href="#l77.250"></a><span id="l77.250" class="difflineminus">-          return (p1 == &quot;lt&quot;)? &quot;&lt;&quot; : &quot;&gt;&quot;;</span>
<a href="#l77.251"></a><span id="l77.251" class="difflineminus">-        });</span>
<a href="#l77.252"></a><span id="l77.252" class="difflineminus">-  var strTagStrippedText = str.replace(/&lt;\/?[^&gt;]+(&gt;|$)/g, &quot;&quot;);</span>
<a href="#l77.253"></a><span id="l77.253" class="difflineminus">-  strTagStrippedText = strTagStrippedText.replace(/&amp;nbsp;/g,&quot;&quot;);</span>
<a href="#l77.254"></a><span id="l77.254" class="difflineminus">-  return strTagStrippedText;</span>
<a href="#l77.255"></a><span id="l77.255" class="difflineminus">-}</span>
<a href="#l77.256"></a><span id="l77.256" class="difflineminus">-</span>
<a href="#l77.257"></a><span id="l77.257" class="difflineminus">-var isMagicAnonymousDiv = function (_document, node) {</span>
<a href="#l77.258"></a><span id="l77.258" class="difflineminus">-  if (node.getAttribute &amp;&amp; node.getAttribute('class') == 'anonymous-div') {</span>
<a href="#l77.259"></a><span id="l77.259" class="difflineminus">-    if (!arrays.inArray(node.parentNode.childNodes, node) &amp;&amp; (_document.getAnonymousNodes(node) == null ||</span>
<a href="#l77.260"></a><span id="l77.260" class="difflineminus">-        !arrays.inArray(_document.getAnonymousNodes(node), node) ) ) {</span>
<a href="#l77.261"></a><span id="l77.261" class="difflineminus">-          return true;</span>
<a href="#l77.262"></a><span id="l77.262" class="difflineminus">-        }</span>
<a href="#l77.263"></a><span id="l77.263" class="difflineminus">-  }</span>
<a href="#l77.264"></a><span id="l77.264" class="difflineminus">-  return false;</span>
<a href="#l77.265"></a><span id="l77.265" class="difflineminus">-}</span>
<a href="#l77.266"></a><span id="l77.266" class="difflineminus">-</span>
<a href="#l77.267"></a><span id="l77.267" class="difflineminus">-var copyToClipboard = function(str){</span>
<a href="#l77.268"></a><span id="l77.268" class="difflineminus">-  const gClipboardHelper = Cc[&quot;@mozilla.org/widget/clipboardhelper;1&quot;] .getService(Ci.nsIClipboardHelper);</span>
<a href="#l77.269"></a><span id="l77.269" class="difflineminus">-  gClipboardHelper.copyString(str);</span>
<a href="#l77.270"></a><span id="l77.270" class="difflineminus">-}</span>
<a href="#l77.271"></a><span id="l77.271" class="difflineminus">-</span>
<a href="#l77.272"></a><span id="l77.272" class="difflineminus">-var getControllerAndDocument = function (_document, _window) {</span>
<a href="#l77.273"></a><span id="l77.273" class="difflineminus">-  var windowtype = _window.document.documentElement.getAttribute('windowtype');</span>
<a href="#l77.274"></a><span id="l77.274" class="difflineminus">-  var controllerString, documentString, activeTab;</span>
<a href="#l77.275"></a><span id="l77.275" class="difflineminus">-</span>
<a href="#l77.276"></a><span id="l77.276" class="difflineminus">-  // TODO replace with object based cases</span>
<a href="#l77.277"></a><span id="l77.277" class="difflineminus">-  switch(windowtype) {</span>
<a href="#l77.278"></a><span id="l77.278" class="difflineminus">-    case 'navigator:browser':</span>
<a href="#l77.279"></a><span id="l77.279" class="difflineminus">-      controllerString = 'mozmill.getBrowserController()';</span>
<a href="#l77.280"></a><span id="l77.280" class="difflineminus">-      activeTab = mozmill.getBrowserController().tabs.activeTab;</span>
<a href="#l77.281"></a><span id="l77.281" class="difflineminus">-      break;</span>
<a href="#l77.282"></a><span id="l77.282" class="difflineminus">-    case 'Browser:Preferences':</span>
<a href="#l77.283"></a><span id="l77.283" class="difflineminus">-      controllerString = 'mozmill.getPreferencesController()';</span>
<a href="#l77.284"></a><span id="l77.284" class="difflineminus">-      break;</span>
<a href="#l77.285"></a><span id="l77.285" class="difflineminus">-    case 'Extension:Manager':</span>
<a href="#l77.286"></a><span id="l77.286" class="difflineminus">-      controllerString = 'mozmill.getAddonsController()';</span>
<a href="#l77.287"></a><span id="l77.287" class="difflineminus">-      break;</span>
<a href="#l77.288"></a><span id="l77.288" class="difflineminus">-    default:</span>
<a href="#l77.289"></a><span id="l77.289" class="difflineminus">-      if(windowtype)</span>
<a href="#l77.290"></a><span id="l77.290" class="difflineminus">-        controllerString = 'new mozmill.controller.MozMillController(mozmill.utils.getWindowByType(&quot;' + windowtype + '&quot;))';</span>
<a href="#l77.291"></a><span id="l77.291" class="difflineminus">-      else if(_window.document.title)</span>
<a href="#l77.292"></a><span id="l77.292" class="difflineminus">-        controllerString = 'new mozmill.controller.MozMillController(mozmill.utils.getWindowByTitle(&quot;'+_window.document.title+'&quot;))';</span>
<a href="#l77.293"></a><span id="l77.293" class="difflineminus">-      else</span>
<a href="#l77.294"></a><span id="l77.294" class="difflineminus">-        controllerString = 'Cannot find window';</span>
<a href="#l77.295"></a><span id="l77.295" class="difflineminus">-      break;</span>
<a href="#l77.296"></a><span id="l77.296" class="difflineminus">-  }</span>
<a href="#l77.297"></a><span id="l77.297" class="difflineminus">-</span>
<a href="#l77.298"></a><span id="l77.298" class="difflineminus">-  if(activeTab == _document) {</span>
<a href="#l77.299"></a><span id="l77.299" class="difflineminus">-    documentString = 'controller.tabs.activeTab';</span>
<a href="#l77.300"></a><span id="l77.300" class="difflineminus">-  } else if(activeTab == _document.defaultView.top.document) {</span>
<a href="#l77.301"></a><span id="l77.301" class="difflineminus">-    // if this document is from an iframe in the active tab</span>
<a href="#l77.302"></a><span id="l77.302" class="difflineminus">-    var stub = getDocumentStub(_document, activeTab.defaultView);</span>
<a href="#l77.303"></a><span id="l77.303" class="difflineminus">-    documentString = 'controller.tabs.activeTab.defaultView' + stub;</span>
<a href="#l77.304"></a><span id="l77.304" class="difflineminus">-  } else {</span>
<a href="#l77.305"></a><span id="l77.305" class="difflineminus">-    var stub = getDocumentStub(_document, _window);</span>
<a href="#l77.306"></a><span id="l77.306" class="difflineminus">-    if(stub)</span>
<a href="#l77.307"></a><span id="l77.307" class="difflineminus">-      documentString = 'controller.window' + stub;</span>
<a href="#l77.308"></a><span id="l77.308" class="difflineminus">-    else</span>
<a href="#l77.309"></a><span id="l77.309" class="difflineminus">-      documentString = 'Cannot find document';</span>
<a href="#l77.310"></a><span id="l77.310" class="difflineminus">-  }</span>
<a href="#l77.311"></a><span id="l77.311" class="difflineminus">-  return {'controllerString':controllerString, 'documentString':documentString}</span>
<a href="#l77.312"></a><span id="l77.312" class="difflineminus">-}</span>
<a href="#l77.313"></a><span id="l77.313" class="difflineminus">-</span>
<a href="#l77.314"></a><span id="l77.314" class="difflineminus">-getDocumentStub = function( _document, _window) {</span>
<a href="#l77.315"></a><span id="l77.315" class="difflineminus">-  if(_window.document == _document)</span>
<a href="#l77.316"></a><span id="l77.316" class="difflineminus">-    return '.document';</span>
<a href="#l77.317"></a><span id="l77.317" class="difflineminus">-  for(var i = 0; i &lt; _window.frames.length; i++) {</span>
<a href="#l77.318"></a><span id="l77.318" class="difflineminus">-    var stub = getDocumentStub(_document, _window.frames[i]);</span>
<a href="#l77.319"></a><span id="l77.319" class="difflineminus">-    if (stub)</span>
<a href="#l77.320"></a><span id="l77.320" class="difflineminus">-      return '.frames['+i+']' + stub;</span>
<a href="#l77.321"></a><span id="l77.321" class="difflineminus">-  }</span>
<a href="#l77.322"></a><span id="l77.322" class="difflineminus">-  return '';</span>
<a href="#l77.323"></a><span id="l77.323" class="difflineminus">-}</span>
<a href="#l77.324"></a><span id="l77.324" class="difflineminus">-</span>
<a href="#l77.325"></a><span id="l77.325" class="difflineminus">-var inspectElement = function(e){</span>
<a href="#l77.326"></a><span id="l77.326" class="difflineminus">-  if (e.originalTarget != undefined) {</span>
<a href="#l77.327"></a><span id="l77.327" class="difflineminus">-    target = e.originalTarget;</span>
<a href="#l77.328"></a><span id="l77.328" class="difflineminus">-  } else {</span>
<a href="#l77.329"></a><span id="l77.329" class="difflineminus">-    target = e.target;</span>
<a href="#l77.330"></a><span id="l77.330" class="difflineminus">-  }</span>
<a href="#l77.331"></a><span id="l77.331" class="difflineminus">-</span>
<a href="#l77.332"></a><span id="l77.332" class="difflineminus">-  //Element highlighting</span>
<a href="#l77.333"></a><span id="l77.333" class="difflineminus">-  try {</span>
<a href="#l77.334"></a><span id="l77.334" class="difflineminus">-    if (this.lastEvent)</span>
<a href="#l77.335"></a><span id="l77.335" class="difflineminus">-      this.lastEvent.target.style.outline = &quot;&quot;;</span>
<a href="#l77.336"></a><span id="l77.336" class="difflineminus">-  } catch(err) {}</span>
<a href="#l77.337"></a><span id="l77.337" class="difflineminus">-</span>
<a href="#l77.338"></a><span id="l77.338" class="difflineminus">-  this.lastEvent = e;</span>
<a href="#l77.339"></a><span id="l77.339" class="difflineminus">-</span>
<a href="#l77.340"></a><span id="l77.340" class="difflineminus">-  try {</span>
<a href="#l77.341"></a><span id="l77.341" class="difflineminus">-     e.target.style.outline = &quot;1px solid darkblue&quot;;</span>
<a href="#l77.342"></a><span id="l77.342" class="difflineminus">-  } catch(err){}</span>
<a href="#l77.343"></a><span id="l77.343" class="difflineminus">-</span>
<a href="#l77.344"></a><span id="l77.344" class="difflineminus">-  var _document = getDocument(target);</span>
<a href="#l77.345"></a><span id="l77.345" class="difflineminus">-</span>
<a href="#l77.346"></a><span id="l77.346" class="difflineminus">-</span>
<a href="#l77.347"></a><span id="l77.347" class="difflineminus">-  if (isMagicAnonymousDiv(_document, target)) {</span>
<a href="#l77.348"></a><span id="l77.348" class="difflineminus">-    target = target.parentNode;</span>
<a href="#l77.349"></a><span id="l77.349" class="difflineminus">-  }</span>
<a href="#l77.350"></a><span id="l77.350" class="difflineminus">-</span>
<a href="#l77.351"></a><span id="l77.351" class="difflineminus">-  var windowtype = _document.documentElement.getAttribute('windowtype');</span>
<a href="#l77.352"></a><span id="l77.352" class="difflineminus">-  var _window = getTopWindow(_document);</span>
<a href="#l77.353"></a><span id="l77.353" class="difflineminus">-  r = getControllerAndDocument(_document, _window);</span>
<a href="#l77.354"></a><span id="l77.354" class="difflineminus">-</span>
<a href="#l77.355"></a><span id="l77.355" class="difflineminus">-  // displayText = &quot;Controller: &quot; + r.controllerString + '\n\n';</span>
<a href="#l77.356"></a><span id="l77.356" class="difflineminus">-  if ( isNotAnonymous(target) ) {</span>
<a href="#l77.357"></a><span id="l77.357" class="difflineminus">-    // Logic for which identifier to use is duplicated above</span>
<a href="#l77.358"></a><span id="l77.358" class="difflineminus">-    if (target.id != &quot;&quot; &amp;&amp; !withs.startsWith(target.id, 'panel')) {</span>
<a href="#l77.359"></a><span id="l77.359" class="difflineminus">-      elemText = &quot;new elementslib.ID(&quot;+ r.documentString + ', &quot;' + target.id + '&quot;)';</span>
<a href="#l77.360"></a><span id="l77.360" class="difflineminus">-      var telem = new elementslib.ID(_document, target.id);</span>
<a href="#l77.361"></a><span id="l77.361" class="difflineminus">-    } else if ((target.name != &quot;&quot;) &amp;&amp; (typeof(target.name) != &quot;undefined&quot;)) {</span>
<a href="#l77.362"></a><span id="l77.362" class="difflineminus">-      elemText = &quot;new elementslib.Name(&quot;+ r.documentString + ', &quot;' + target.name + '&quot;)';</span>
<a href="#l77.363"></a><span id="l77.363" class="difflineminus">-      var telem = new elementslib.Name(_document, target.name);</span>
<a href="#l77.364"></a><span id="l77.364" class="difflineminus">-    } else if (target.nodeName == &quot;A&quot;) {</span>
<a href="#l77.365"></a><span id="l77.365" class="difflineminus">-      var linkText = removeHTMLTags(target.innerHTML);</span>
<a href="#l77.366"></a><span id="l77.366" class="difflineminus">-      elemText = &quot;new elementslib.Link(&quot;+ r.documentString + ', &quot;' + linkText + '&quot;)';</span>
<a href="#l77.367"></a><span id="l77.367" class="difflineminus">-      var telem = new elementslib.Link(_document, linkText);</span>
<a href="#l77.368"></a><span id="l77.368" class="difflineminus">-    }</span>
<a href="#l77.369"></a><span id="l77.369" class="difflineminus">-  }</span>
<a href="#l77.370"></a><span id="l77.370" class="difflineminus">-  // Fallback on XPath</span>
<a href="#l77.371"></a><span id="l77.371" class="difflineminus">-  if (telem == undefined || telem.getNode() != target) {</span>
<a href="#l77.372"></a><span id="l77.372" class="difflineminus">-    if (windowtype == null) {</span>
<a href="#l77.373"></a><span id="l77.373" class="difflineminus">-      var stringXpath = getXSPath(target);</span>
<a href="#l77.374"></a><span id="l77.374" class="difflineminus">-    } else {</span>
<a href="#l77.375"></a><span id="l77.375" class="difflineminus">-      var stringXpath = getXULXpath(target, _document);</span>
<a href="#l77.376"></a><span id="l77.376" class="difflineminus">-    }</span>
<a href="#l77.377"></a><span id="l77.377" class="difflineminus">-    var telem = new elementslib.XPath(_document, stringXpath);</span>
<a href="#l77.378"></a><span id="l77.378" class="difflineminus">-    if ( telem.getNode() == target ) {</span>
<a href="#l77.379"></a><span id="l77.379" class="difflineminus">-      elemText = &quot;new elementslib.XPath(&quot;+ r.documentString + ', &quot;' + stringXpath + '&quot;)';</span>
<a href="#l77.380"></a><span id="l77.380" class="difflineminus">-    }</span>
<a href="#l77.381"></a><span id="l77.381" class="difflineminus">-  }</span>
<a href="#l77.382"></a><span id="l77.382" class="difflineminus">-  // Fallback to Lookup</span>
<a href="#l77.383"></a><span id="l77.383" class="difflineminus">-  if (telem == undefined || telem.getNode() != target) {</span>
<a href="#l77.384"></a><span id="l77.384" class="difflineminus">-    var exp = getLookupExpression(_document, target);</span>
<a href="#l77.385"></a><span id="l77.385" class="difflineminus">-    elemText = &quot;new elementslib.Lookup(&quot;+ r.documentString + &quot;, '&quot; + exp + &quot;')&quot;;</span>
<a href="#l77.386"></a><span id="l77.386" class="difflineminus">-    var telem = new elementslib.Lookup(_document, exp);</span>
<a href="#l77.387"></a><span id="l77.387" class="difflineminus">-  }</span>
<a href="#l77.388"></a><span id="l77.388" class="difflineminus">-</span>
<a href="#l77.389"></a><span id="l77.389" class="difflineminus">-  return {'validation':( target == telem.getNode() ),</span>
<a href="#l77.390"></a><span id="l77.390" class="difflineminus">-          'elementText':elemText,</span>
<a href="#l77.391"></a><span id="l77.391" class="difflineminus">-          'elementType':telem.constructor.name,</span>
<a href="#l77.392"></a><span id="l77.392" class="difflineminus">-          'controllerText':r.controllerString,</span>
<a href="#l77.393"></a><span id="l77.393" class="difflineminus">-          'documentString':r.documentString,</span>
<a href="#l77.394"></a><span id="l77.394" class="difflineminus">-          }</span>
<a href="#l77.395"></a><span id="l77.395" class="difflineminus">-}</span>
<a href="#l77.396"></a><span id="l77.396" class="difflineminus">-</span>
<a href="#l77.397"></a><span id="l77.397" class="difflineminus">-</span>
<a href="#l77.398"></a><span id="l77.398" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l78.1"></a><span id="l78.1">rename from mail/test/resources/mozmill/mozmill/extension/content/modules/jum.js</span>
<a href="#l78.2"></a><span id="l78.2">rename to mail/test/resources/mozmill/mozmill/extension/content/modules/jum.jsm</span>
<a href="#l78.3"></a><span id="l78.3" class="difflineminus">--- a/mail/test/resources/mozmill/mozmill/extension/content/modules/jum.js</span>
<a href="#l78.4"></a><span id="l78.4" class="difflineplus">+++ b/mail/test/resources/mozmill/mozmill/extension/content/modules/jum.jsm</span>
<a href="#l78.5"></a><span id="l78.5" class="difflineat">@@ -34,160 +34,203 @@</span>
<a href="#l78.6"></a><span id="l78.6"> // the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l78.7"></a><span id="l78.7"> //</span>
<a href="#l78.8"></a><span id="l78.8"> // ***** END LICENSE BLOCK *****</span>
<a href="#l78.9"></a><span id="l78.9"> </span>
<a href="#l78.10"></a><span id="l78.10"> var EXPORTED_SYMBOLS = [&quot;assert&quot;, &quot;assertTrue&quot;, &quot;assertFalse&quot;, &quot;assertEquals&quot;, &quot;assertNotEquals&quot;,</span>
<a href="#l78.11"></a><span id="l78.11">                         &quot;assertNull&quot;, &quot;assertNotNull&quot;, &quot;assertUndefined&quot;, &quot;assertNotUndefined&quot;,</span>
<a href="#l78.12"></a><span id="l78.12">                         &quot;assertNaN&quot;, &quot;assertNotNaN&quot;, &quot;fail&quot;, &quot;pass&quot;];</span>
<a href="#l78.13"></a><span id="l78.13"> </span>
<a href="#l78.14"></a><span id="l78.14" class="difflineminus">-var frame = ChromeUtils.import(&quot;chrome://mozmill/content/modules/frame.js&quot;);</span>
<a href="#l78.15"></a><span id="l78.15" class="difflineplus">+var frame = ChromeUtils.import(&quot;chrome://mozmill/content/modules/frame.jsm&quot;);</span>
<a href="#l78.16"></a><span id="l78.16"> </span>
<a href="#l78.17"></a><span id="l78.17" class="difflineminus">-var ifJSONable = function (v) {</span>
<a href="#l78.18"></a><span id="l78.18" class="difflineminus">-  if (typeof(v) == 'function') {</span>
<a href="#l78.19"></a><span id="l78.19" class="difflineplus">+var ifJSONable = function(v) {</span>
<a href="#l78.20"></a><span id="l78.20" class="difflineplus">+  if (typeof(v) == &quot;function&quot;) {</span>
<a href="#l78.21"></a><span id="l78.21">     return undefined;</span>
<a href="#l78.22"></a><span id="l78.22" class="difflineminus">-  } else {</span>
<a href="#l78.23"></a><span id="l78.23" class="difflineminus">-    return v;</span>
<a href="#l78.24"></a><span id="l78.24">   }</span>
<a href="#l78.25"></a><span id="l78.25" class="difflineminus">-}</span>
<a href="#l78.26"></a><span id="l78.26" class="difflineplus">+  return v;</span>
<a href="#l78.27"></a><span id="l78.27" class="difflineplus">+};</span>
<a href="#l78.28"></a><span id="l78.28"> </span>
<a href="#l78.29"></a><span id="l78.29" class="difflineminus">-var assert = function (booleanValue, comment) {</span>
<a href="#l78.30"></a><span id="l78.30" class="difflineplus">+var assert = function(booleanValue, comment) {</span>
<a href="#l78.31"></a><span id="l78.31">   if (booleanValue) {</span>
<a href="#l78.32"></a><span id="l78.32" class="difflineminus">-    frame.events.pass({'function':'jum.assert', 'value':ifJSONable(booleanValue), 'comment':comment});</span>
<a href="#l78.33"></a><span id="l78.33" class="difflineplus">+    frame.events.pass({</span>
<a href="#l78.34"></a><span id="l78.34" class="difflineplus">+      function: &quot;jum.assert&quot;,</span>
<a href="#l78.35"></a><span id="l78.35" class="difflineplus">+      value: ifJSONable(booleanValue),</span>
<a href="#l78.36"></a><span id="l78.36" class="difflineplus">+      comment,</span>
<a href="#l78.37"></a><span id="l78.37" class="difflineplus">+    });</span>
<a href="#l78.38"></a><span id="l78.38">     return true;</span>
<a href="#l78.39"></a><span id="l78.39">   }</span>
<a href="#l78.40"></a><span id="l78.40">   reportFail(&quot;jum.assert(&quot; + ifJSONable(booleanValue) + &quot;) - &quot; + comment);</span>
<a href="#l78.41"></a><span id="l78.41">   return false;</span>
<a href="#l78.42"></a><span id="l78.42" class="difflineminus">-}</span>
<a href="#l78.43"></a><span id="l78.43" class="difflineplus">+};</span>
<a href="#l78.44"></a><span id="l78.44"> </span>
<a href="#l78.45"></a><span id="l78.45" class="difflineminus">-var assertTrue = function (booleanValue, comment) {</span>
<a href="#l78.46"></a><span id="l78.46" class="difflineminus">-  if (typeof(booleanValue) != 'boolean') {</span>
<a href="#l78.47"></a><span id="l78.47" class="difflineplus">+var assertTrue = function(booleanValue, comment) {</span>
<a href="#l78.48"></a><span id="l78.48" class="difflineplus">+  if (typeof(booleanValue) != &quot;boolean&quot;) {</span>
<a href="#l78.49"></a><span id="l78.49">     reportFail(&quot;jum.assertTrue(&quot; + ifJSONable(booleanValue) + &quot;) &quot; +</span>
<a href="#l78.50"></a><span id="l78.50">       &quot;Bad argument, value type &quot; + typeof(booleanValue) + &quot; isn't boolean - &quot; + comment);</span>
<a href="#l78.51"></a><span id="l78.51" class="difflineminus">-      return false;</span>
<a href="#l78.52"></a><span id="l78.52" class="difflineplus">+    return false;</span>
<a href="#l78.53"></a><span id="l78.53">   }</span>
<a href="#l78.54"></a><span id="l78.54"> </span>
<a href="#l78.55"></a><span id="l78.55">   if (booleanValue) {</span>
<a href="#l78.56"></a><span id="l78.56" class="difflineminus">-    frame.events.pass({'function':'jum.assertTrue', 'value':ifJSONable(booleanValue),</span>
<a href="#l78.57"></a><span id="l78.57" class="difflineminus">-                       'comment':comment});</span>
<a href="#l78.58"></a><span id="l78.58" class="difflineplus">+    frame.events.pass({</span>
<a href="#l78.59"></a><span id="l78.59" class="difflineplus">+      function: &quot;jum.assertTrue&quot;,</span>
<a href="#l78.60"></a><span id="l78.60" class="difflineplus">+      value: ifJSONable(booleanValue),</span>
<a href="#l78.61"></a><span id="l78.61" class="difflineplus">+      comment,</span>
<a href="#l78.62"></a><span id="l78.62" class="difflineplus">+    });</span>
<a href="#l78.63"></a><span id="l78.63">     return true;</span>
<a href="#l78.64"></a><span id="l78.64">   }</span>
<a href="#l78.65"></a><span id="l78.65">   reportFail(&quot;jum.assertTrue(&quot; + ifJSONable(booleanValue) + &quot;) - &quot; + comment);</span>
<a href="#l78.66"></a><span id="l78.66">   return false;</span>
<a href="#l78.67"></a><span id="l78.67" class="difflineminus">-}</span>
<a href="#l78.68"></a><span id="l78.68" class="difflineplus">+};</span>
<a href="#l78.69"></a><span id="l78.69"> </span>
<a href="#l78.70"></a><span id="l78.70" class="difflineminus">-var assertFalse = function (booleanValue, comment) {</span>
<a href="#l78.71"></a><span id="l78.71" class="difflineminus">-  if (typeof(booleanValue) != 'boolean') {</span>
<a href="#l78.72"></a><span id="l78.72" class="difflineplus">+var assertFalse = function(booleanValue, comment) {</span>
<a href="#l78.73"></a><span id="l78.73" class="difflineplus">+  if (typeof(booleanValue) != &quot;boolean&quot;) {</span>
<a href="#l78.74"></a><span id="l78.74">     reportFail(&quot;jum.assertFalse(&quot; + ifJSONable(booleanValue) + &quot;) &quot; +</span>
<a href="#l78.75"></a><span id="l78.75">       &quot;Bad argument, value type &quot; + typeof(booleanValue) + &quot; isn't boolean - &quot; + comment);</span>
<a href="#l78.76"></a><span id="l78.76">     return false;</span>
<a href="#l78.77"></a><span id="l78.77">   }</span>
<a href="#l78.78"></a><span id="l78.78"> </span>
<a href="#l78.79"></a><span id="l78.79">   if (!booleanValue) {</span>
<a href="#l78.80"></a><span id="l78.80" class="difflineminus">-    frame.events.pass({'function':'jum.assertFalse', 'value':ifJSONable(booleanValue),</span>
<a href="#l78.81"></a><span id="l78.81" class="difflineminus">-                       'comment':comment});</span>
<a href="#l78.82"></a><span id="l78.82" class="difflineplus">+    frame.events.pass({</span>
<a href="#l78.83"></a><span id="l78.83" class="difflineplus">+      function: &quot;jum.assertFalse&quot;,</span>
<a href="#l78.84"></a><span id="l78.84" class="difflineplus">+      value: ifJSONable(booleanValue),</span>
<a href="#l78.85"></a><span id="l78.85" class="difflineplus">+      comment,</span>
<a href="#l78.86"></a><span id="l78.86" class="difflineplus">+    });</span>
<a href="#l78.87"></a><span id="l78.87">     return true;</span>
<a href="#l78.88"></a><span id="l78.88">   }</span>
<a href="#l78.89"></a><span id="l78.89">   reportFail(&quot;jum.assertFalse(&quot; + ifJSONable(booleanValue) + &quot;) - &quot; + comment);</span>
<a href="#l78.90"></a><span id="l78.90">   return false;</span>
<a href="#l78.91"></a><span id="l78.91" class="difflineminus">-}</span>
<a href="#l78.92"></a><span id="l78.92" class="difflineplus">+};</span>
<a href="#l78.93"></a><span id="l78.93"> </span>
<a href="#l78.94"></a><span id="l78.94" class="difflineminus">-var assertEquals = function (value1, value2, comment) {</span>
<a href="#l78.95"></a><span id="l78.95" class="difflineplus">+var assertEquals = function(value1, value2, comment) {</span>
<a href="#l78.96"></a><span id="l78.96">   if (value1 == value2) {</span>
<a href="#l78.97"></a><span id="l78.97" class="difflineminus">-    frame.events.pass({'function':'jum.assertEquals', 'comment':comment,</span>
<a href="#l78.98"></a><span id="l78.98" class="difflineminus">-                       'value1':ifJSONable(value1), 'value2':ifJSONable(value2)});</span>
<a href="#l78.99"></a><span id="l78.99" class="difflineplus">+    frame.events.pass({</span>
<a href="#l78.100"></a><span id="l78.100" class="difflineplus">+      function: &quot;jum.assertEquals&quot;,</span>
<a href="#l78.101"></a><span id="l78.101" class="difflineplus">+      comment,</span>
<a href="#l78.102"></a><span id="l78.102" class="difflineplus">+      value1: ifJSONable(value1),</span>
<a href="#l78.103"></a><span id="l78.103" class="difflineplus">+      value2: ifJSONable(value2),</span>
<a href="#l78.104"></a><span id="l78.104" class="difflineplus">+    });</span>
<a href="#l78.105"></a><span id="l78.105">     return true;</span>
<a href="#l78.106"></a><span id="l78.106">   }</span>
<a href="#l78.107"></a><span id="l78.107">   reportFail(&quot;jum.assertEquals(&quot; + ifJSONable(value1) + &quot;, &quot; +</span>
<a href="#l78.108"></a><span id="l78.108">     ifJSONable(value2) + &quot;) - &quot; + comment);</span>
<a href="#l78.109"></a><span id="l78.109">   return false;</span>
<a href="#l78.110"></a><span id="l78.110" class="difflineminus">-}</span>
<a href="#l78.111"></a><span id="l78.111" class="difflineplus">+};</span>
<a href="#l78.112"></a><span id="l78.112"> </span>
<a href="#l78.113"></a><span id="l78.113" class="difflineminus">-var assertNotEquals = function (value1, value2, comment) {</span>
<a href="#l78.114"></a><span id="l78.114" class="difflineplus">+var assertNotEquals = function(value1, value2, comment) {</span>
<a href="#l78.115"></a><span id="l78.115">   if (value1 != value2) {</span>
<a href="#l78.116"></a><span id="l78.116" class="difflineminus">-    frame.events.pass({'function':'jum.assertNotEquals', 'comment':comment,</span>
<a href="#l78.117"></a><span id="l78.117" class="difflineminus">-                       'value1':ifJSONable(value1), 'value2':ifJSONable(value2)});</span>
<a href="#l78.118"></a><span id="l78.118" class="difflineplus">+    frame.events.pass({</span>
<a href="#l78.119"></a><span id="l78.119" class="difflineplus">+      function: &quot;jum.assertNotEquals&quot;,</span>
<a href="#l78.120"></a><span id="l78.120" class="difflineplus">+      comment,</span>
<a href="#l78.121"></a><span id="l78.121" class="difflineplus">+      value1: ifJSONable(value1),</span>
<a href="#l78.122"></a><span id="l78.122" class="difflineplus">+      value2: ifJSONable(value2),</span>
<a href="#l78.123"></a><span id="l78.123" class="difflineplus">+    });</span>
<a href="#l78.124"></a><span id="l78.124">     return true;</span>
<a href="#l78.125"></a><span id="l78.125">   }</span>
<a href="#l78.126"></a><span id="l78.126">   reportFail(&quot;jum.assertNotEquals(&quot; + ifJSONable(value1) + &quot;, &quot; +</span>
<a href="#l78.127"></a><span id="l78.127">       ifJSONable(value2) + &quot;) - &quot; + comment);</span>
<a href="#l78.128"></a><span id="l78.128">   return false;</span>
<a href="#l78.129"></a><span id="l78.129" class="difflineminus">-}</span>
<a href="#l78.130"></a><span id="l78.130" class="difflineplus">+};</span>
<a href="#l78.131"></a><span id="l78.131"> </span>
<a href="#l78.132"></a><span id="l78.132" class="difflineminus">-var assertNull = function (value, comment) {</span>
<a href="#l78.133"></a><span id="l78.133" class="difflineplus">+var assertNull = function(value, comment) {</span>
<a href="#l78.134"></a><span id="l78.134">   if (value == null) {</span>
<a href="#l78.135"></a><span id="l78.135" class="difflineminus">-    frame.events.pass({'function':'jum.assertNull', 'comment':comment,</span>
<a href="#l78.136"></a><span id="l78.136" class="difflineminus">-                       'value':ifJSONable(value)});</span>
<a href="#l78.137"></a><span id="l78.137" class="difflineplus">+    frame.events.pass({</span>
<a href="#l78.138"></a><span id="l78.138" class="difflineplus">+      function: &quot;jum.assertNull&quot;,</span>
<a href="#l78.139"></a><span id="l78.139" class="difflineplus">+      comment,</span>
<a href="#l78.140"></a><span id="l78.140" class="difflineplus">+      value: ifJSONable(value),</span>
<a href="#l78.141"></a><span id="l78.141" class="difflineplus">+    });</span>
<a href="#l78.142"></a><span id="l78.142">     return true;</span>
<a href="#l78.143"></a><span id="l78.143">   }</span>
<a href="#l78.144"></a><span id="l78.144" class="difflineminus">-  reportFail(&quot;jum.assertNull(&quot; + ifJSONable(booleanValue) + &quot;) - &quot; + comment);</span>
<a href="#l78.145"></a><span id="l78.145" class="difflineplus">+  reportFail(&quot;jum.assertNull(&quot; + ifJSONable(value) + &quot;) - &quot; + comment);</span>
<a href="#l78.146"></a><span id="l78.146">   return false;</span>
<a href="#l78.147"></a><span id="l78.147" class="difflineminus">-}</span>
<a href="#l78.148"></a><span id="l78.148" class="difflineplus">+};</span>
<a href="#l78.149"></a><span id="l78.149"> </span>
<a href="#l78.150"></a><span id="l78.150" class="difflineminus">-var assertNotNull = function (value, comment) {</span>
<a href="#l78.151"></a><span id="l78.151" class="difflineplus">+var assertNotNull = function(value, comment) {</span>
<a href="#l78.152"></a><span id="l78.152">   if (value != null) {</span>
<a href="#l78.153"></a><span id="l78.153" class="difflineminus">-    frame.events.pass({'function':'jum.assertNotNull', 'comment':comment,</span>
<a href="#l78.154"></a><span id="l78.154" class="difflineminus">-                       'value':ifJSONable(value)});</span>
<a href="#l78.155"></a><span id="l78.155" class="difflineplus">+    frame.events.pass({</span>
<a href="#l78.156"></a><span id="l78.156" class="difflineplus">+      function: &quot;jum.assertNotNull&quot;,</span>
<a href="#l78.157"></a><span id="l78.157" class="difflineplus">+      comment,</span>
<a href="#l78.158"></a><span id="l78.158" class="difflineplus">+      value: ifJSONable(value),</span>
<a href="#l78.159"></a><span id="l78.159" class="difflineplus">+    });</span>
<a href="#l78.160"></a><span id="l78.160">     return true;</span>
<a href="#l78.161"></a><span id="l78.161">   }</span>
<a href="#l78.162"></a><span id="l78.162" class="difflineminus">-  reportFail(&quot;jum.assertNotNull(&quot; + ifJSONable(booleanValue) + &quot;) - &quot; + comment);</span>
<a href="#l78.163"></a><span id="l78.163" class="difflineplus">+  reportFail(&quot;jum.assertNotNull(&quot; + ifJSONable(value) + &quot;) - &quot; + comment);</span>
<a href="#l78.164"></a><span id="l78.164">   return false;</span>
<a href="#l78.165"></a><span id="l78.165" class="difflineminus">-}</span>
<a href="#l78.166"></a><span id="l78.166" class="difflineplus">+};</span>
<a href="#l78.167"></a><span id="l78.167"> </span>
<a href="#l78.168"></a><span id="l78.168" class="difflineminus">-var assertUndefined = function (value, comment) {</span>
<a href="#l78.169"></a><span id="l78.169" class="difflineplus">+var assertUndefined = function(value, comment) {</span>
<a href="#l78.170"></a><span id="l78.170">   if (value == undefined) {</span>
<a href="#l78.171"></a><span id="l78.171" class="difflineminus">-    frame.events.pass({'function':'jum.assertUndefined', 'comment':comment,</span>
<a href="#l78.172"></a><span id="l78.172" class="difflineminus">-                       'value':ifJSONable(value)});</span>
<a href="#l78.173"></a><span id="l78.173" class="difflineplus">+    frame.events.pass({</span>
<a href="#l78.174"></a><span id="l78.174" class="difflineplus">+      function: &quot;jum.assertUndefined&quot;,</span>
<a href="#l78.175"></a><span id="l78.175" class="difflineplus">+      comment,</span>
<a href="#l78.176"></a><span id="l78.176" class="difflineplus">+      value: ifJSONable(value),</span>
<a href="#l78.177"></a><span id="l78.177" class="difflineplus">+    });</span>
<a href="#l78.178"></a><span id="l78.178">     return true;</span>
<a href="#l78.179"></a><span id="l78.179">   }</span>
<a href="#l78.180"></a><span id="l78.180" class="difflineminus">-  reportFail(&quot;jum.assertUndefined(&quot; + ifJSONable(booleanValue) + &quot;) - &quot; + comment);</span>
<a href="#l78.181"></a><span id="l78.181" class="difflineplus">+  reportFail(&quot;jum.assertUndefined(&quot; + ifJSONable(value) + &quot;) - &quot; + comment);</span>
<a href="#l78.182"></a><span id="l78.182">   return false;</span>
<a href="#l78.183"></a><span id="l78.183" class="difflineminus">-}</span>
<a href="#l78.184"></a><span id="l78.184" class="difflineplus">+};</span>
<a href="#l78.185"></a><span id="l78.185"> </span>
<a href="#l78.186"></a><span id="l78.186" class="difflineminus">-var assertNotUndefined = function (value, comment) {</span>
<a href="#l78.187"></a><span id="l78.187" class="difflineplus">+var assertNotUndefined = function(value, comment) {</span>
<a href="#l78.188"></a><span id="l78.188">   if (value != undefined) {</span>
<a href="#l78.189"></a><span id="l78.189" class="difflineminus">-    frame.events.pass({'function':'jum.assertNotUndefined', 'comment':comment,</span>
<a href="#l78.190"></a><span id="l78.190" class="difflineminus">-                       'value':ifJSONable(value)});</span>
<a href="#l78.191"></a><span id="l78.191" class="difflineplus">+    frame.events.pass({</span>
<a href="#l78.192"></a><span id="l78.192" class="difflineplus">+      function: &quot;jum.assertNotUndefined&quot;,</span>
<a href="#l78.193"></a><span id="l78.193" class="difflineplus">+      comment,</span>
<a href="#l78.194"></a><span id="l78.194" class="difflineplus">+      value: ifJSONable(value),</span>
<a href="#l78.195"></a><span id="l78.195" class="difflineplus">+    });</span>
<a href="#l78.196"></a><span id="l78.196">     return true;</span>
<a href="#l78.197"></a><span id="l78.197">   }</span>
<a href="#l78.198"></a><span id="l78.198" class="difflineminus">-  reportFail(&quot;jum.assertNotUndefined(&quot; + ifJSONable(booleanValue) + &quot;) - &quot; + comment);</span>
<a href="#l78.199"></a><span id="l78.199" class="difflineplus">+  reportFail(&quot;jum.assertNotUndefined(&quot; + ifJSONable(value) + &quot;) - &quot; + comment);</span>
<a href="#l78.200"></a><span id="l78.200">   return false;</span>
<a href="#l78.201"></a><span id="l78.201" class="difflineminus">-}</span>
<a href="#l78.202"></a><span id="l78.202" class="difflineplus">+};</span>
<a href="#l78.203"></a><span id="l78.203"> </span>
<a href="#l78.204"></a><span id="l78.204" class="difflineminus">-var assertNaN = function (value, comment) {</span>
<a href="#l78.205"></a><span id="l78.205" class="difflineplus">+var assertNaN = function(value, comment) {</span>
<a href="#l78.206"></a><span id="l78.206">   if (isNaN(value)) {</span>
<a href="#l78.207"></a><span id="l78.207" class="difflineminus">-    frame.events.pass({'function':'jum.assertNaN', 'comment':comment,</span>
<a href="#l78.208"></a><span id="l78.208" class="difflineminus">-                       'value':ifJSONable(value)});</span>
<a href="#l78.209"></a><span id="l78.209" class="difflineplus">+    frame.events.pass({</span>
<a href="#l78.210"></a><span id="l78.210" class="difflineplus">+      function: &quot;jum.assertNaN&quot;,</span>
<a href="#l78.211"></a><span id="l78.211" class="difflineplus">+      comment,</span>
<a href="#l78.212"></a><span id="l78.212" class="difflineplus">+      value: ifJSONable(value),</span>
<a href="#l78.213"></a><span id="l78.213" class="difflineplus">+    });</span>
<a href="#l78.214"></a><span id="l78.214">     return true;</span>
<a href="#l78.215"></a><span id="l78.215">   }</span>
<a href="#l78.216"></a><span id="l78.216" class="difflineminus">-  reportFail(&quot;jum.assertNaN(&quot; + ifJSONable(booleanValue) + &quot;) - &quot; + comment);</span>
<a href="#l78.217"></a><span id="l78.217" class="difflineplus">+  reportFail(&quot;jum.assertNaN(&quot; + ifJSONable(value) + &quot;) - &quot; + comment);</span>
<a href="#l78.218"></a><span id="l78.218">   return false;</span>
<a href="#l78.219"></a><span id="l78.219" class="difflineminus">-}</span>
<a href="#l78.220"></a><span id="l78.220" class="difflineplus">+};</span>
<a href="#l78.221"></a><span id="l78.221"> </span>
<a href="#l78.222"></a><span id="l78.222" class="difflineminus">-var assertNotNaN = function (value, comment) {</span>
<a href="#l78.223"></a><span id="l78.223" class="difflineplus">+var assertNotNaN = function(value, comment) {</span>
<a href="#l78.224"></a><span id="l78.224">   if (!isNaN(value)) {</span>
<a href="#l78.225"></a><span id="l78.225" class="difflineminus">-    frame.events.pass({'function':'jum.assertNotNaN', 'comment':comment,</span>
<a href="#l78.226"></a><span id="l78.226" class="difflineminus">-                       'value':ifJSONable(value)});</span>
<a href="#l78.227"></a><span id="l78.227" class="difflineplus">+    frame.events.pass({</span>
<a href="#l78.228"></a><span id="l78.228" class="difflineplus">+      function: &quot;jum.assertNotNaN&quot;,</span>
<a href="#l78.229"></a><span id="l78.229" class="difflineplus">+      comment,</span>
<a href="#l78.230"></a><span id="l78.230" class="difflineplus">+      value: ifJSONable(value),</span>
<a href="#l78.231"></a><span id="l78.231" class="difflineplus">+    });</span>
<a href="#l78.232"></a><span id="l78.232">     return true;</span>
<a href="#l78.233"></a><span id="l78.233">   }</span>
<a href="#l78.234"></a><span id="l78.234" class="difflineminus">-  reportFail(&quot;jum.assertNotNaN(&quot; + ifJSONable(booleanValue) + &quot;) - &quot; + comment);</span>
<a href="#l78.235"></a><span id="l78.235" class="difflineplus">+  reportFail(&quot;jum.assertNotNaN(&quot; + ifJSONable(value) + &quot;) - &quot; + comment);</span>
<a href="#l78.236"></a><span id="l78.236">   return false;</span>
<a href="#l78.237"></a><span id="l78.237" class="difflineminus">-}</span>
<a href="#l78.238"></a><span id="l78.238" class="difflineplus">+};</span>
<a href="#l78.239"></a><span id="l78.239"> </span>
<a href="#l78.240"></a><span id="l78.240"> var reportFail = function(comment) {</span>
<a href="#l78.241"></a><span id="l78.241">   try {</span>
<a href="#l78.242"></a><span id="l78.242">     throw new Error(comment || &quot;&quot;);</span>
<a href="#l78.243"></a><span id="l78.243" class="difflineminus">-  } catch(e) {</span>
<a href="#l78.244"></a><span id="l78.244" class="difflineminus">-    frame.events.fail({'assertion': e});</span>
<a href="#l78.245"></a><span id="l78.245" class="difflineplus">+  } catch (e) {</span>
<a href="#l78.246"></a><span id="l78.246" class="difflineplus">+    frame.events.fail({</span>
<a href="#l78.247"></a><span id="l78.247" class="difflineplus">+      assertion: e,</span>
<a href="#l78.248"></a><span id="l78.248" class="difflineplus">+    });</span>
<a href="#l78.249"></a><span id="l78.249">   }</span>
<a href="#l78.250"></a><span id="l78.250" class="difflineminus">-}</span>
<a href="#l78.251"></a><span id="l78.251" class="difflineplus">+};</span>
<a href="#l78.252"></a><span id="l78.252"> </span>
<a href="#l78.253"></a><span id="l78.253" class="difflineminus">-var fail = function (comment) {</span>
<a href="#l78.254"></a><span id="l78.254" class="difflineminus">-  frame.events.fail({'function':'jum.fail', 'comment':comment});</span>
<a href="#l78.255"></a><span id="l78.255" class="difflineplus">+var fail = function(comment) {</span>
<a href="#l78.256"></a><span id="l78.256" class="difflineplus">+  frame.events.fail({</span>
<a href="#l78.257"></a><span id="l78.257" class="difflineplus">+    function: &quot;jum.fail&quot;,</span>
<a href="#l78.258"></a><span id="l78.258" class="difflineplus">+    comment,</span>
<a href="#l78.259"></a><span id="l78.259" class="difflineplus">+  });</span>
<a href="#l78.260"></a><span id="l78.260">   return false;</span>
<a href="#l78.261"></a><span id="l78.261" class="difflineminus">-}</span>
<a href="#l78.262"></a><span id="l78.262" class="difflineplus">+};</span>
<a href="#l78.263"></a><span id="l78.263"> </span>
<a href="#l78.264"></a><span id="l78.264" class="difflineminus">-var pass = function (comment) {</span>
<a href="#l78.265"></a><span id="l78.265" class="difflineminus">-  frame.events.pass({'function':'jum.pass', 'comment':comment});</span>
<a href="#l78.266"></a><span id="l78.266" class="difflineplus">+var pass = function(comment) {</span>
<a href="#l78.267"></a><span id="l78.267" class="difflineplus">+  frame.events.pass({</span>
<a href="#l78.268"></a><span id="l78.268" class="difflineplus">+    function: &quot;jum.pass&quot;,</span>
<a href="#l78.269"></a><span id="l78.269" class="difflineplus">+    comment,</span>
<a href="#l78.270"></a><span id="l78.270" class="difflineplus">+  });</span>
<a href="#l78.271"></a><span id="l78.271">   return true;</span>
<a href="#l78.272"></a><span id="l78.272" class="difflineminus">-}</span>
<a href="#l78.273"></a><span id="l78.273" class="difflineplus">+};</span>
<a href="#l78.274"></a><span id="l78.274"> </span>
<a href="#l78.275"></a><span id="l78.275"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l79.1"></a><span id="l79.1">rename from mail/test/resources/mozmill/mozmill/extension/content/modules/mozmill.js</span>
<a href="#l79.2"></a><span id="l79.2">rename to mail/test/resources/mozmill/mozmill/extension/content/modules/mozmill.jsm</span>
<a href="#l79.3"></a><span id="l79.3" class="difflineminus">--- a/mail/test/resources/mozmill/mozmill/extension/content/modules/mozmill.js</span>
<a href="#l79.4"></a><span id="l79.4" class="difflineplus">+++ b/mail/test/resources/mozmill/mozmill/extension/content/modules/mozmill.jsm</span>
<a href="#l79.5"></a><span id="l79.5" class="difflineat">@@ -38,180 +38,149 @@</span>
<a href="#l79.6"></a><span id="l79.6"> </span>
<a href="#l79.7"></a><span id="l79.7"> var EXPORTED_SYMBOLS = [&quot;controller&quot;, &quot;events&quot;, &quot;utils&quot;, &quot;elementslib&quot;, &quot;os&quot;,</span>
<a href="#l79.8"></a><span id="l79.8">                         &quot;getBrowserController&quot;, &quot;newBrowserController&quot;,</span>
<a href="#l79.9"></a><span id="l79.9">                         &quot;getAddonsController&quot;, &quot;getPreferencesController&quot;,</span>
<a href="#l79.10"></a><span id="l79.10">                         &quot;newMail3PaneController&quot;, &quot;getMail3PaneController&quot;,</span>
<a href="#l79.11"></a><span id="l79.11">                         &quot;wm&quot;, &quot;platform&quot;, &quot;getAddrbkController&quot;,</span>
<a href="#l79.12"></a><span id="l79.12">                         &quot;getMsgComposeController&quot;, &quot;getDownloadsController&quot;,</span>
<a href="#l79.13"></a><span id="l79.13">                         &quot;Application&quot;, &quot;MozMillAsyncTest&quot;, &quot;cleanQuit&quot;,</span>
<a href="#l79.14"></a><span id="l79.14" class="difflineminus">-                        &quot;getPlacesController&quot;, 'isMac', 'isLinux', 'isWindows',</span>
<a href="#l79.15"></a><span id="l79.15" class="difflineminus">-                        &quot;appInfo&quot;, &quot;locale&quot;</span>
<a href="#l79.16"></a><span id="l79.16" class="difflineplus">+                        &quot;getPlacesController&quot;, &quot;isMac&quot;, &quot;isLinux&quot;, &quot;isWindows&quot;,</span>
<a href="#l79.17"></a><span id="l79.17" class="difflineplus">+                        &quot;appInfo&quot;, &quot;locale&quot;,</span>
<a href="#l79.18"></a><span id="l79.18">                        ];</span>
<a href="#l79.19"></a><span id="l79.19"> </span>
<a href="#l79.20"></a><span id="l79.20" class="difflineminus">-var controller = ChromeUtils.import(&quot;chrome://mozmill/content/modules/controller.js&quot;);</span>
<a href="#l79.21"></a><span id="l79.21" class="difflineminus">-var events = ChromeUtils.import(&quot;chrome://mozmill/content/modules/events.js&quot;);</span>
<a href="#l79.22"></a><span id="l79.22" class="difflineminus">-var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.js&quot;);</span>
<a href="#l79.23"></a><span id="l79.23" class="difflineminus">-var elementslib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.js&quot;);</span>
<a href="#l79.24"></a><span id="l79.24" class="difflineminus">-var frame = ChromeUtils.import(&quot;chrome://mozmill/content/modules/frame.js&quot;);</span>
<a href="#l79.25"></a><span id="l79.25" class="difflineplus">+const {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l79.26"></a><span id="l79.26"> </span>
<a href="#l79.27"></a><span id="l79.27" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.js&quot;);</span>
<a href="#l79.28"></a><span id="l79.28" class="difflineminus">-var withs = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/withs.js&quot;);</span>
<a href="#l79.29"></a><span id="l79.29" class="difflineplus">+var controller = ChromeUtils.import(&quot;chrome://mozmill/content/modules/controller.jsm&quot;);</span>
<a href="#l79.30"></a><span id="l79.30" class="difflineplus">+var events = ChromeUtils.import(&quot;chrome://mozmill/content/modules/events.jsm&quot;);</span>
<a href="#l79.31"></a><span id="l79.31" class="difflineplus">+var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.jsm&quot;);</span>
<a href="#l79.32"></a><span id="l79.32" class="difflineplus">+var elementslib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l79.33"></a><span id="l79.33" class="difflineplus">+var frame = ChromeUtils.import(&quot;chrome://mozmill/content/modules/frame.jsm&quot;);</span>
<a href="#l79.34"></a><span id="l79.34" class="difflineplus">+</span>
<a href="#l79.35"></a><span id="l79.35" class="difflineplus">+var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l79.36"></a><span id="l79.36"> </span>
<a href="#l79.37"></a><span id="l79.37"> var platform = os.getPlatform();</span>
<a href="#l79.38"></a><span id="l79.38"> </span>
<a href="#l79.39"></a><span id="l79.39"> var isMac = false;</span>
<a href="#l79.40"></a><span id="l79.40"> var isWindows = false;</span>
<a href="#l79.41"></a><span id="l79.41"> var isLinux = false;</span>
<a href="#l79.42"></a><span id="l79.42"> </span>
<a href="#l79.43"></a><span id="l79.43" class="difflineminus">-if (platform == &quot;darwin&quot;){</span>
<a href="#l79.44"></a><span id="l79.44" class="difflineplus">+if (platform == &quot;darwin&quot;) {</span>
<a href="#l79.45"></a><span id="l79.45">   isMac = true;</span>
<a href="#l79.46"></a><span id="l79.46"> }</span>
<a href="#l79.47"></a><span id="l79.47" class="difflineminus">-if (platform == &quot;winnt&quot;){</span>
<a href="#l79.48"></a><span id="l79.48" class="difflineplus">+if (platform == &quot;winnt&quot;) {</span>
<a href="#l79.49"></a><span id="l79.49">   isWindows = true;</span>
<a href="#l79.50"></a><span id="l79.50"> }</span>
<a href="#l79.51"></a><span id="l79.51" class="difflineminus">-if (platform == &quot;linux&quot;){</span>
<a href="#l79.52"></a><span id="l79.52" class="difflineplus">+if (platform == &quot;linux&quot;) {</span>
<a href="#l79.53"></a><span id="l79.53">   isLinux = true;</span>
<a href="#l79.54"></a><span id="l79.54"> }</span>
<a href="#l79.55"></a><span id="l79.55"> </span>
<a href="#l79.56"></a><span id="l79.56" class="difflineminus">-var wm = Cc[&quot;@mozilla.org/appshell/window-mediator;1&quot;]</span>
<a href="#l79.57"></a><span id="l79.57" class="difflineminus">-           .getService(Ci.nsIWindowMediator);</span>
<a href="#l79.58"></a><span id="l79.58" class="difflineminus">-</span>
<a href="#l79.59"></a><span id="l79.59" class="difflineminus">-var appInfo = Cc[&quot;@mozilla.org/xre/app-info;1&quot;]</span>
<a href="#l79.60"></a><span id="l79.60" class="difflineminus">-               .getService(Ci.nsIXULAppInfo);</span>
<a href="#l79.61"></a><span id="l79.61" class="difflineplus">+var appInfo = Services.appinfo;</span>
<a href="#l79.62"></a><span id="l79.62"> </span>
<a href="#l79.63"></a><span id="l79.63"> var locale = Cc[&quot;@mozilla.org/chrome/chrome-registry;1&quot;]</span>
<a href="#l79.64"></a><span id="l79.64">                .getService(Ci.nsIXULChromeRegistry)</span>
<a href="#l79.65"></a><span id="l79.65">                .getSelectedLocale(&quot;global&quot;);</span>
<a href="#l79.66"></a><span id="l79.66"> </span>
<a href="#l79.67"></a><span id="l79.67" class="difflineminus">-var aConsoleService = Cc[&quot;@mozilla.org/consoleservice;1&quot;].</span>
<a href="#l79.68"></a><span id="l79.68" class="difflineminus">-    getService(Ci.nsIConsoleService);</span>
<a href="#l79.69"></a><span id="l79.69" class="difflineminus">-</span>
<a href="#l79.70"></a><span id="l79.70" class="difflineminus">-</span>
<a href="#l79.71"></a><span id="l79.71"> var applicationDictionary = {</span>
<a href="#l79.72"></a><span id="l79.72" class="difflineminus">-  &quot;{718e30fb-e89b-41dd-9da7-e25a45638b28}&quot;: &quot;Sunbird&quot;,</span>
<a href="#l79.73"></a><span id="l79.73">   &quot;{92650c4d-4b8e-4d2a-b7eb-24ecf4f6b63a}&quot;: &quot;SeaMonkey&quot;,</span>
<a href="#l79.74"></a><span id="l79.74" class="difflineminus">-  &quot;{ec8030f7-c20a-464f-9b0e-13a3a9e97384}&quot;: &quot;Firefox&quot;,</span>
<a href="#l79.75"></a><span id="l79.75" class="difflineminus">-  &quot;{3550f703-e582-4d05-9a08-453d09bdfdc6}&quot;: 'Thunderbird',</span>
<a href="#l79.76"></a><span id="l79.76" class="difflineminus">-}</span>
<a href="#l79.77"></a><span id="l79.77" class="difflineminus">-</span>
<a href="#l79.78"></a><span id="l79.78" class="difflineplus">+  &quot;{3550f703-e582-4d05-9a08-453d09bdfdc6}&quot;: &quot;Thunderbird&quot;,</span>
<a href="#l79.79"></a><span id="l79.79" class="difflineplus">+};</span>
<a href="#l79.80"></a><span id="l79.80"> var Application = applicationDictionary[appInfo.ID];</span>
<a href="#l79.81"></a><span id="l79.81"> </span>
<a href="#l79.82"></a><span id="l79.82" class="difflineminus">-if (Application == undefined) {</span>
<a href="#l79.83"></a><span id="l79.83" class="difflineminus">-  // Default to Firefox</span>
<a href="#l79.84"></a><span id="l79.84" class="difflineminus">-  var Application = 'Firefox';</span>
<a href="#l79.85"></a><span id="l79.85" class="difflineminus">-}</span>
<a href="#l79.86"></a><span id="l79.86" class="difflineminus">-</span>
<a href="#l79.87"></a><span id="l79.87" class="difflineminus">-function cleanQuit () {</span>
<a href="#l79.88"></a><span id="l79.88" class="difflineminus">-  utils.getMethodInWindows('goQuitApplication')();</span>
<a href="#l79.89"></a><span id="l79.89" class="difflineplus">+function cleanQuit() {</span>
<a href="#l79.90"></a><span id="l79.90" class="difflineplus">+  utils.getMethodInWindows(&quot;goQuitApplication&quot;)();</span>
<a href="#l79.91"></a><span id="l79.91"> }</span>
<a href="#l79.92"></a><span id="l79.92"> </span>
<a href="#l79.93"></a><span id="l79.93" class="difflineminus">-function addHttpResource (directory, namespace) {</span>
<a href="#l79.94"></a><span id="l79.94" class="difflineminus">-  return 'http://localhost:4545/'+namespace;</span>
<a href="#l79.95"></a><span id="l79.95" class="difflineplus">+function newBrowserController() {</span>
<a href="#l79.96"></a><span id="l79.96" class="difflineplus">+  return new controller.MozMillController(utils.getMethodInWindows(&quot;OpenBrowserWindow&quot;)());</span>
<a href="#l79.97"></a><span id="l79.97"> }</span>
<a href="#l79.98"></a><span id="l79.98"> </span>
<a href="#l79.99"></a><span id="l79.99" class="difflineminus">-function newBrowserController () {</span>
<a href="#l79.100"></a><span id="l79.100" class="difflineminus">-  return new controller.MozMillController(utils.getMethodInWindows('OpenBrowserWindow')());</span>
<a href="#l79.101"></a><span id="l79.101" class="difflineminus">-}</span>
<a href="#l79.102"></a><span id="l79.102" class="difflineminus">-</span>
<a href="#l79.103"></a><span id="l79.103" class="difflineminus">-function getBrowserController () {</span>
<a href="#l79.104"></a><span id="l79.104" class="difflineminus">-  var browserWindow = wm.getMostRecentWindow(&quot;navigator:browser&quot;);</span>
<a href="#l79.105"></a><span id="l79.105" class="difflineplus">+function getBrowserController() {</span>
<a href="#l79.106"></a><span id="l79.106" class="difflineplus">+  var browserWindow = Services.wm.getMostRecentWindow(&quot;navigator:browser&quot;);</span>
<a href="#l79.107"></a><span id="l79.107">   if (browserWindow == null) {</span>
<a href="#l79.108"></a><span id="l79.108">     return newBrowserController();</span>
<a href="#l79.109"></a><span id="l79.109">   }</span>
<a href="#l79.110"></a><span id="l79.110" class="difflineminus">-  else {</span>
<a href="#l79.111"></a><span id="l79.111" class="difflineminus">-    return new controller.MozMillController(browserWindow);</span>
<a href="#l79.112"></a><span id="l79.112" class="difflineminus">-  }</span>
<a href="#l79.113"></a><span id="l79.113" class="difflineplus">+</span>
<a href="#l79.114"></a><span id="l79.114" class="difflineplus">+  return new controller.MozMillController(browserWindow);</span>
<a href="#l79.115"></a><span id="l79.115"> }</span>
<a href="#l79.116"></a><span id="l79.116"> </span>
<a href="#l79.117"></a><span id="l79.117" class="difflineminus">-function getPlacesController () {</span>
<a href="#l79.118"></a><span id="l79.118" class="difflineminus">-  utils.getMethodInWindows('PlacesCommandHook').showPlacesOrganizer('AllBookmarks');</span>
<a href="#l79.119"></a><span id="l79.119" class="difflineminus">-  return new controller.MozMillController(wm.getMostRecentWindow(''));</span>
<a href="#l79.120"></a><span id="l79.120" class="difflineplus">+function getPlacesController() {</span>
<a href="#l79.121"></a><span id="l79.121" class="difflineplus">+  utils.getMethodInWindows(&quot;PlacesCommandHook&quot;).showPlacesOrganizer(&quot;AllBookmarks&quot;);</span>
<a href="#l79.122"></a><span id="l79.122" class="difflineplus">+  return new controller.MozMillController(Services.wm.getMostRecentWindow(&quot;&quot;));</span>
<a href="#l79.123"></a><span id="l79.123"> }</span>
<a href="#l79.124"></a><span id="l79.124"> </span>
<a href="#l79.125"></a><span id="l79.125" class="difflineminus">-function getAddonsController () {</span>
<a href="#l79.126"></a><span id="l79.126" class="difflineminus">-  if (Application == 'SeaMonkey') {</span>
<a href="#l79.127"></a><span id="l79.127" class="difflineminus">-    utils.getMethodInWindows('toEM')();</span>
<a href="#l79.128"></a><span id="l79.128" class="difflineminus">-  } else if (Application == 'Thunderbird') {</span>
<a href="#l79.129"></a><span id="l79.129" class="difflineminus">-    utils.getMethodInWindows('openAddonsMgr')();</span>
<a href="#l79.130"></a><span id="l79.130" class="difflineminus">-  } else if (Application == 'Sunbird') {</span>
<a href="#l79.131"></a><span id="l79.131" class="difflineminus">-    utils.getMethodInWindows('goOpenAddons')();</span>
<a href="#l79.132"></a><span id="l79.132" class="difflineplus">+function getAddonsController() {</span>
<a href="#l79.133"></a><span id="l79.133" class="difflineplus">+  if (Application == &quot;SeaMonkey&quot;) {</span>
<a href="#l79.134"></a><span id="l79.134" class="difflineplus">+    utils.getMethodInWindows(&quot;toEM&quot;)();</span>
<a href="#l79.135"></a><span id="l79.135" class="difflineplus">+  } else if (Application == &quot;Thunderbird&quot;) {</span>
<a href="#l79.136"></a><span id="l79.136" class="difflineplus">+    utils.getMethodInWindows(&quot;openAddonsMgr&quot;)();</span>
<a href="#l79.137"></a><span id="l79.137">   } else {</span>
<a href="#l79.138"></a><span id="l79.138" class="difflineminus">-    utils.getMethodInWindows('BrowserOpenAddonsMgr')();</span>
<a href="#l79.139"></a><span id="l79.139" class="difflineplus">+    utils.getMethodInWindows(&quot;BrowserOpenAddonsMgr&quot;)();</span>
<a href="#l79.140"></a><span id="l79.140">   }</span>
<a href="#l79.141"></a><span id="l79.141" class="difflineminus">-  return new controller.MozMillController(wm.getMostRecentWindow(''));</span>
<a href="#l79.142"></a><span id="l79.142" class="difflineplus">+  return new controller.MozMillController(Services.wm.getMostRecentWindow(&quot;&quot;));</span>
<a href="#l79.143"></a><span id="l79.143"> }</span>
<a href="#l79.144"></a><span id="l79.144"> </span>
<a href="#l79.145"></a><span id="l79.145"> function getDownloadsController() {</span>
<a href="#l79.146"></a><span id="l79.146" class="difflineminus">-  utils.getMethodInWindows('BrowserDownloadsUI')();</span>
<a href="#l79.147"></a><span id="l79.147" class="difflineminus">-  return new controller.MozMillController(wm.getMostRecentWindow(''));</span>
<a href="#l79.148"></a><span id="l79.148" class="difflineplus">+  utils.getMethodInWindows(&quot;BrowserDownloadsUI&quot;)();</span>
<a href="#l79.149"></a><span id="l79.149" class="difflineplus">+  return new controller.MozMillController(Services.wm.getMostRecentWindow(&quot;&quot;));</span>
<a href="#l79.150"></a><span id="l79.150"> }</span>
<a href="#l79.151"></a><span id="l79.151"> </span>
<a href="#l79.152"></a><span id="l79.152"> function getPreferencesController() {</span>
<a href="#l79.153"></a><span id="l79.153" class="difflineminus">-  if (Application == 'Thunderbird') {</span>
<a href="#l79.154"></a><span id="l79.154" class="difflineminus">-    utils.getMethodInWindows('openOptionsDialog')();</span>
<a href="#l79.155"></a><span id="l79.155" class="difflineplus">+  if (Application == &quot;Thunderbird&quot;) {</span>
<a href="#l79.156"></a><span id="l79.156" class="difflineplus">+    utils.getMethodInWindows(&quot;openOptionsDialog&quot;)();</span>
<a href="#l79.157"></a><span id="l79.157">   } else {</span>
<a href="#l79.158"></a><span id="l79.158" class="difflineminus">-    utils.getMethodInWindows('openPreferences')();</span>
<a href="#l79.159"></a><span id="l79.159" class="difflineplus">+    utils.getMethodInWindows(&quot;openPreferences&quot;)();</span>
<a href="#l79.160"></a><span id="l79.160">   }</span>
<a href="#l79.161"></a><span id="l79.161">   // utils.sleep(1000)</span>
<a href="#l79.162"></a><span id="l79.162" class="difflineminus">-  return new controller.MozMillController(wm.getMostRecentWindow(''));</span>
<a href="#l79.163"></a><span id="l79.163" class="difflineplus">+  return new controller.MozMillController(Services.wm.getMostRecentWindow(&quot;&quot;));</span>
<a href="#l79.164"></a><span id="l79.164"> }</span>
<a href="#l79.165"></a><span id="l79.165"> </span>
<a href="#l79.166"></a><span id="l79.166"> // Thunderbird functions</span>
<a href="#l79.167"></a><span id="l79.167" class="difflineminus">-function newMail3PaneController () {</span>
<a href="#l79.168"></a><span id="l79.168" class="difflineminus">-  return new controller.MozMillController(utils.getMethodInWindows('toMessengerWindow')());</span>
<a href="#l79.169"></a><span id="l79.169" class="difflineplus">+function newMail3PaneController() {</span>
<a href="#l79.170"></a><span id="l79.170" class="difflineplus">+  return new controller.MozMillController(utils.getMethodInWindows(&quot;toMessengerWindow&quot;)());</span>
<a href="#l79.171"></a><span id="l79.171"> }</span>
<a href="#l79.172"></a><span id="l79.172"> </span>
<a href="#l79.173"></a><span id="l79.173" class="difflineminus">-function getMail3PaneController () {</span>
<a href="#l79.174"></a><span id="l79.174" class="difflineminus">-  var mail3PaneWindow = wm.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l79.175"></a><span id="l79.175" class="difflineplus">+function getMail3PaneController() {</span>
<a href="#l79.176"></a><span id="l79.176" class="difflineplus">+  var mail3PaneWindow = Services.wm.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l79.177"></a><span id="l79.177">   if (mail3PaneWindow == null) {</span>
<a href="#l79.178"></a><span id="l79.178">     return newMail3PaneController();</span>
<a href="#l79.179"></a><span id="l79.179">   }</span>
<a href="#l79.180"></a><span id="l79.180" class="difflineminus">-  else {</span>
<a href="#l79.181"></a><span id="l79.181" class="difflineminus">-    return new controller.MozMillController(mail3PaneWindow);</span>
<a href="#l79.182"></a><span id="l79.182" class="difflineminus">-  }</span>
<a href="#l79.183"></a><span id="l79.183" class="difflineplus">+</span>
<a href="#l79.184"></a><span id="l79.184" class="difflineplus">+  return new controller.MozMillController(mail3PaneWindow);</span>
<a href="#l79.185"></a><span id="l79.185"> }</span>
<a href="#l79.186"></a><span id="l79.186"> </span>
<a href="#l79.187"></a><span id="l79.187"> // Thunderbird - Address book window</span>
<a href="#l79.188"></a><span id="l79.188" class="difflineminus">-function newAddrbkController () {</span>
<a href="#l79.189"></a><span id="l79.189" class="difflineplus">+function newAddrbkController() {</span>
<a href="#l79.190"></a><span id="l79.190">   utils.getMethodInWindows(&quot;toAddressBook&quot;)();</span>
<a href="#l79.191"></a><span id="l79.191">   utils.sleep(2000);</span>
<a href="#l79.192"></a><span id="l79.192" class="difflineminus">-  var addyWin = wm.getMostRecentWindow(&quot;mail:addressbook&quot;);</span>
<a href="#l79.193"></a><span id="l79.193" class="difflineplus">+  var addyWin = Services.wm.getMostRecentWindow(&quot;mail:addressbook&quot;);</span>
<a href="#l79.194"></a><span id="l79.194">   return new controller.MozMillController(addyWin);</span>
<a href="#l79.195"></a><span id="l79.195"> }</span>
<a href="#l79.196"></a><span id="l79.196"> </span>
<a href="#l79.197"></a><span id="l79.197" class="difflineminus">-function getAddrbkController () {</span>
<a href="#l79.198"></a><span id="l79.198" class="difflineminus">-  var addrbkWindow = wm.getMostRecentWindow(&quot;mail:addressbook&quot;);</span>
<a href="#l79.199"></a><span id="l79.199" class="difflineplus">+function getAddrbkController() {</span>
<a href="#l79.200"></a><span id="l79.200" class="difflineplus">+  var addrbkWindow = Services.wm.getMostRecentWindow(&quot;mail:addressbook&quot;);</span>
<a href="#l79.201"></a><span id="l79.201">   if (addrbkWindow == null) {</span>
<a href="#l79.202"></a><span id="l79.202">     return newAddrbkController();</span>
<a href="#l79.203"></a><span id="l79.203">   }</span>
<a href="#l79.204"></a><span id="l79.204" class="difflineminus">-  else {</span>
<a href="#l79.205"></a><span id="l79.205" class="difflineminus">-    return new controller.MozMillController(addrbkWindow);</span>
<a href="#l79.206"></a><span id="l79.206" class="difflineminus">-  }</span>
<a href="#l79.207"></a><span id="l79.207" class="difflineplus">+</span>
<a href="#l79.208"></a><span id="l79.208" class="difflineplus">+  return new controller.MozMillController(addrbkWindow);</span>
<a href="#l79.209"></a><span id="l79.209"> }</span>
<a href="#l79.210"></a><span id="l79.210"> </span>
<a href="#l79.211"></a><span id="l79.211"> var MozMillAsyncTest = controller.MozMillAsyncTest;</span>
<a href="#l79.212"></a><span id="l79.212"> </span>
<a href="#l79.213"></a><span id="l79.213" class="difflineminus">-function firePythonCallback (method, obj) {</span>
<a href="#l79.214"></a><span id="l79.214" class="difflineminus">-  frame.events.fireEvent(&quot;firePythonCallback&quot;, {&quot;method&quot;:method, &quot;arg&quot;:obj, &quot;fire_now&quot;:true, &quot;filename&quot;:frame.events.currentModule.__file__});</span>
<a href="#l79.215"></a><span id="l79.215" class="difflineminus">-}</span>
<a href="#l79.216"></a><span id="l79.216" class="difflineminus">-function firePythonCallbackAfterRestart(method, obj) {</span>
<a href="#l79.217"></a><span id="l79.217" class="difflineminus">-  frame.events.fireEvent(&quot;firePythonCallback&quot;, {&quot;method&quot;:method, &quot;arg&quot;:obj, &quot;fire_now&quot;:false, &quot;filename&quot;:frame.events.currentModule.__file__});</span>
<a href="#l79.218"></a><span id="l79.218" class="difflineminus">-}</span>
<a href="#l79.219"></a><span id="l79.219" class="difflineminus">-</span>
<a href="#l79.220"></a><span id="l79.220" class="difflineminus">-function timer (name) {</span>
<a href="#l79.221"></a><span id="l79.221" class="difflineplus">+function timer(name) {</span>
<a href="#l79.222"></a><span id="l79.222">   this.name = name;</span>
<a href="#l79.223"></a><span id="l79.223">   this.timers = {};</span>
<a href="#l79.224"></a><span id="l79.224">   frame.timers.push(this);</span>
<a href="#l79.225"></a><span id="l79.225">   this.actions = [];</span>
<a href="#l79.226"></a><span id="l79.226"> }</span>
<a href="#l79.227"></a><span id="l79.227" class="difflineminus">-timer.prototype.start = function (name) {</span>
<a href="#l79.228"></a><span id="l79.228" class="difflineplus">+timer.prototype.start = function(name) {</span>
<a href="#l79.229"></a><span id="l79.229">   this.timers[name].startTime = (new Date).getTime();</span>
<a href="#l79.230"></a><span id="l79.230" class="difflineminus">-}</span>
<a href="#l79.231"></a><span id="l79.231" class="difflineminus">-timer.prototype.stop = function (name) {</span>
<a href="#l79.232"></a><span id="l79.232" class="difflineplus">+};</span>
<a href="#l79.233"></a><span id="l79.233" class="difflineplus">+timer.prototype.stop = function(name) {</span>
<a href="#l79.234"></a><span id="l79.234">   var t = this.timers[name];</span>
<a href="#l79.235"></a><span id="l79.235">   t.endTime = (new Date).getTime();</span>
<a href="#l79.236"></a><span id="l79.236">   t.totalTime = (t.endTime - t.startTime);</span>
<a href="#l79.237"></a><span id="l79.237" class="difflineminus">-}</span>
<a href="#l79.238"></a><span id="l79.238" class="difflineminus">-timer.prototype.end = function () {</span>
<a href="#l79.239"></a><span id="l79.239" class="difflineplus">+};</span>
<a href="#l79.240"></a><span id="l79.240" class="difflineplus">+timer.prototype.end = function() {</span>
<a href="#l79.241"></a><span id="l79.241">   frame.events.fireEvent(&quot;timer&quot;, this);</span>
<a href="#l79.242"></a><span id="l79.242">   frame.timers.remove(this);</span>
<a href="#l79.243"></a><span id="l79.243" class="difflineminus">-}</span>
<a href="#l79.244"></a><span id="l79.244" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l80.1"></a><span id="l80.1">rename from mail/test/resources/mozmill/mozmill/extension/content/modules/utils.js</span>
<a href="#l80.2"></a><span id="l80.2">rename to mail/test/resources/mozmill/mozmill/extension/content/modules/utils.jsm</span>
<a href="#l80.3"></a><span id="l80.3" class="difflineminus">--- a/mail/test/resources/mozmill/mozmill/extension/content/modules/utils.js</span>
<a href="#l80.4"></a><span id="l80.4" class="difflineplus">+++ b/mail/test/resources/mozmill/mozmill/extension/content/modules/utils.jsm</span>
<a href="#l80.5"></a><span id="l80.5" class="difflineat">@@ -38,71 +38,66 @@</span>
<a href="#l80.6"></a><span id="l80.6"> // ***** END LICENSE BLOCK *****</span>
<a href="#l80.7"></a><span id="l80.7"> </span>
<a href="#l80.8"></a><span id="l80.8"> var EXPORTED_SYMBOLS = [&quot;openFile&quot;, &quot;saveFile&quot;, &quot;saveAsFile&quot;, &quot;genBoiler&quot;,</span>
<a href="#l80.9"></a><span id="l80.9">                         &quot;getFile&quot;, &quot;Copy&quot;, &quot;getChromeWindow&quot;, &quot;getWindows&quot;, &quot;runEditor&quot;,</span>
<a href="#l80.10"></a><span id="l80.10">                         &quot;runFile&quot;, &quot;getWindowByTitle&quot;, &quot;getWindowByType&quot;, &quot;getWindowId&quot;,</span>
<a href="#l80.11"></a><span id="l80.11">                         &quot;tempfile&quot;, &quot;getMethodInWindows&quot;, &quot;getPreference&quot;, &quot;setPreference&quot;,</span>
<a href="#l80.12"></a><span id="l80.12">                         &quot;sleep&quot;, &quot;assert&quot;, &quot;unwrapNode&quot;, &quot;TimeoutError&quot;, &quot;waitFor&quot;];</span>
<a href="#l80.13"></a><span id="l80.13"> </span>
<a href="#l80.14"></a><span id="l80.14" class="difflineminus">-var hwindow = Cc[&quot;@mozilla.org/appshell/appShellService;1&quot;]</span>
<a href="#l80.15"></a><span id="l80.15" class="difflineminus">-              .getService(Ci.nsIAppShellService)</span>
<a href="#l80.16"></a><span id="l80.16" class="difflineminus">-              .hiddenDOMWindow;</span>
<a href="#l80.17"></a><span id="l80.17" class="difflineplus">+const {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l80.18"></a><span id="l80.18"> </span>
<a href="#l80.19"></a><span id="l80.19" class="difflineminus">-var uuidgen = Cc[&quot;@mozilla.org/uuid-generator;1&quot;]</span>
<a href="#l80.20"></a><span id="l80.20" class="difflineminus">-    .getService(Ci.nsIUUIDGenerator);</span>
<a href="#l80.21"></a><span id="l80.21" class="difflineplus">+var hwindow = Services.appShell.hiddenDOMWindow;</span>
<a href="#l80.22"></a><span id="l80.22" class="difflineplus">+var uuidgen = Cc[&quot;@mozilla.org/uuid-generator;1&quot;].getService(Ci.nsIUUIDGenerator);</span>
<a href="#l80.23"></a><span id="l80.23"> </span>
<a href="#l80.24"></a><span id="l80.24" class="difflineminus">-function Copy (obj) {</span>
<a href="#l80.25"></a><span id="l80.25" class="difflineplus">+function Copy(obj) {</span>
<a href="#l80.26"></a><span id="l80.26">   for (var n in obj) {</span>
<a href="#l80.27"></a><span id="l80.27">     this[n] = obj[n];</span>
<a href="#l80.28"></a><span id="l80.28">   }</span>
<a href="#l80.29"></a><span id="l80.29"> }</span>
<a href="#l80.30"></a><span id="l80.30"> </span>
<a href="#l80.31"></a><span id="l80.31"> function getChromeWindow(aWindow) {</span>
<a href="#l80.32"></a><span id="l80.32">   return aWindow.docShell.rootTreeItem.domWindow;</span>
<a href="#l80.33"></a><span id="l80.33"> }</span>
<a href="#l80.34"></a><span id="l80.34"> </span>
<a href="#l80.35"></a><span id="l80.35"> function getWindows(type) {</span>
<a href="#l80.36"></a><span id="l80.36">   if (type == undefined) {</span>
<a href="#l80.37"></a><span id="l80.37" class="difflineminus">-      type = &quot;&quot;;</span>
<a href="#l80.38"></a><span id="l80.38" class="difflineplus">+    type = &quot;&quot;;</span>
<a href="#l80.39"></a><span id="l80.39">   }</span>
<a href="#l80.40"></a><span id="l80.40" class="difflineminus">-  var windows = []</span>
<a href="#l80.41"></a><span id="l80.41" class="difflineminus">-  var enumerator = Cc[&quot;@mozilla.org/appshell/window-mediator;1&quot;]</span>
<a href="#l80.42"></a><span id="l80.42" class="difflineminus">-                     .getService(Ci.nsIWindowMediator)</span>
<a href="#l80.43"></a><span id="l80.43" class="difflineminus">-                     .getEnumerator(type);</span>
<a href="#l80.44"></a><span id="l80.44" class="difflineminus">-  while(enumerator.hasMoreElements()) {</span>
<a href="#l80.45"></a><span id="l80.45" class="difflineplus">+  var windows = [];</span>
<a href="#l80.46"></a><span id="l80.46" class="difflineplus">+  var enumerator = Services.wm.getEnumerator(type);</span>
<a href="#l80.47"></a><span id="l80.47" class="difflineplus">+  while (enumerator.hasMoreElements()) {</span>
<a href="#l80.48"></a><span id="l80.48">     windows.push(enumerator.getNext());</span>
<a href="#l80.49"></a><span id="l80.49">   }</span>
<a href="#l80.50"></a><span id="l80.50">   if (type == &quot;&quot;) {</span>
<a href="#l80.51"></a><span id="l80.51">     windows.push(hwindow);</span>
<a href="#l80.52"></a><span id="l80.52">   }</span>
<a href="#l80.53"></a><span id="l80.53">   return windows;</span>
<a href="#l80.54"></a><span id="l80.54"> }</span>
<a href="#l80.55"></a><span id="l80.55"> </span>
<a href="#l80.56"></a><span id="l80.56" class="difflineminus">-function getMethodInWindows (methodName) {</span>
<a href="#l80.57"></a><span id="l80.57" class="difflineplus">+function getMethodInWindows(methodName) {</span>
<a href="#l80.58"></a><span id="l80.58">   for (var w of getWindows()) {</span>
<a href="#l80.59"></a><span id="l80.59">     if (w[methodName] != undefined) {</span>
<a href="#l80.60"></a><span id="l80.60">       return w[methodName];</span>
<a href="#l80.61"></a><span id="l80.61">     }</span>
<a href="#l80.62"></a><span id="l80.62">   }</span>
<a href="#l80.63"></a><span id="l80.63">   throw new Error(&quot;Method with name: '&quot; + methodName + &quot;' is not in any open window.&quot;);</span>
<a href="#l80.64"></a><span id="l80.64"> }</span>
<a href="#l80.65"></a><span id="l80.65"> </span>
<a href="#l80.66"></a><span id="l80.66"> function getWindowByTitle(title) {</span>
<a href="#l80.67"></a><span id="l80.67">   for (var w of getWindows()) {</span>
<a href="#l80.68"></a><span id="l80.68">     if (w.document.title &amp;&amp; w.document.title == title) {</span>
<a href="#l80.69"></a><span id="l80.69">       return w;</span>
<a href="#l80.70"></a><span id="l80.70">     }</span>
<a href="#l80.71"></a><span id="l80.71">   }</span>
<a href="#l80.72"></a><span id="l80.72" class="difflineplus">+  return null;</span>
<a href="#l80.73"></a><span id="l80.73"> }</span>
<a href="#l80.74"></a><span id="l80.74"> </span>
<a href="#l80.75"></a><span id="l80.75"> function getWindowByType(type) {</span>
<a href="#l80.76"></a><span id="l80.76" class="difflineminus">-  var wm = Cc[&quot;@mozilla.org/appshell/window-mediator;1&quot;]</span>
<a href="#l80.77"></a><span id="l80.77" class="difflineminus">-           .getService(Ci.nsIWindowMediator);</span>
<a href="#l80.78"></a><span id="l80.78" class="difflineminus">-  return wm.getMostRecentWindow(type);</span>
<a href="#l80.79"></a><span id="l80.79" class="difflineplus">+  return Services.wm.getMostRecentWindow(type);</span>
<a href="#l80.80"></a><span id="l80.80"> }</span>
<a href="#l80.81"></a><span id="l80.81"> </span>
<a href="#l80.82"></a><span id="l80.82"> /**</span>
<a href="#l80.83"></a><span id="l80.83">  * Retrieve the outer window id for the given window</span>
<a href="#l80.84"></a><span id="l80.84">  **/</span>
<a href="#l80.85"></a><span id="l80.85"> function getWindowId(aWindow) {</span>
<a href="#l80.86"></a><span id="l80.86">   try {</span>
<a href="#l80.87"></a><span id="l80.87">     // Normally we can retrieve the id via window utils</span>
<a href="#l80.88"></a><span id="l80.88" class="difflineat">@@ -110,195 +105,179 @@ function getWindowId(aWindow) {</span>
<a href="#l80.89"></a><span id="l80.89">   } catch (e) {</span>
<a href="#l80.90"></a><span id="l80.90">     // ... but for observer notifications we need another interface</span>
<a href="#l80.91"></a><span id="l80.91">     return aWindow.QueryInterface(Ci.nsISupportsPRUint64).data;</span>
<a href="#l80.92"></a><span id="l80.92">   }</span>
<a href="#l80.93"></a><span id="l80.93"> }</span>
<a href="#l80.94"></a><span id="l80.94"> </span>
<a href="#l80.95"></a><span id="l80.95"> function tempfile(appention) {</span>
<a href="#l80.96"></a><span id="l80.96">   if (appention == undefined) {</span>
<a href="#l80.97"></a><span id="l80.97" class="difflineminus">-    var appention = &quot;mozmill.utils.tempfile&quot;</span>
<a href="#l80.98"></a><span id="l80.98" class="difflineplus">+    appention = &quot;mozmill.utils.tempfile&quot;;</span>
<a href="#l80.99"></a><span id="l80.99">   }</span>
<a href="#l80.100"></a><span id="l80.100" class="difflineminus">-  var tempfile = Cc[&quot;@mozilla.org/file/directory_service;1&quot;].getService(Ci.nsIProperties).get(&quot;TmpD&quot;, Ci.nsIFile);</span>
<a href="#l80.101"></a><span id="l80.101" class="difflineminus">-  tempfile.append(uuidgen.generateUUID().toString().replace('-', '').replace('{', '').replace('}',''))</span>
<a href="#l80.102"></a><span id="l80.102" class="difflineplus">+  var tempfile = Services.dirsvc.get(&quot;TmpD&quot;, Ci.nsIFile);</span>
<a href="#l80.103"></a><span id="l80.103" class="difflineplus">+  tempfile.append(uuidgen.generateUUID().toString().replace(&quot;-&quot;, &quot;&quot;).replace(&quot;{&quot;, &quot;&quot;).replace(&quot;}&quot;, &quot;&quot;));</span>
<a href="#l80.104"></a><span id="l80.104">   tempfile.create(Ci.nsIFile.DIRECTORY_TYPE, 0o777);</span>
<a href="#l80.105"></a><span id="l80.105">   tempfile.append(appention);</span>
<a href="#l80.106"></a><span id="l80.106">   tempfile.createUnique(Ci.nsIFile.NORMAL_FILE_TYPE, 0o666);</span>
<a href="#l80.107"></a><span id="l80.107">   // do whatever you need to the created file</span>
<a href="#l80.108"></a><span id="l80.108" class="difflineminus">-  return tempfile.clone()</span>
<a href="#l80.109"></a><span id="l80.109" class="difflineplus">+  return tempfile.clone();</span>
<a href="#l80.110"></a><span id="l80.110"> }</span>
<a href="#l80.111"></a><span id="l80.111"> </span>
<a href="#l80.112"></a><span id="l80.112" class="difflineminus">-var checkChrome = function() {</span>
<a href="#l80.113"></a><span id="l80.113" class="difflineminus">-   var loc = window.document.location.href;</span>
<a href="#l80.114"></a><span id="l80.114" class="difflineminus">-   try {</span>
<a href="#l80.115"></a><span id="l80.115" class="difflineminus">-       loc = window.top.document.location.href;</span>
<a href="#l80.116"></a><span id="l80.116" class="difflineminus">-   } catch (e) {}</span>
<a href="#l80.117"></a><span id="l80.117" class="difflineminus">-</span>
<a href="#l80.118"></a><span id="l80.118" class="difflineminus">-   if (/^chrome:\/\//.test(loc)) { return true; }</span>
<a href="#l80.119"></a><span id="l80.119" class="difflineminus">-   else { return false; }</span>
<a href="#l80.120"></a><span id="l80.120" class="difflineminus">-}</span>
<a href="#l80.121"></a><span id="l80.121" class="difflineminus">-</span>
<a href="#l80.122"></a><span id="l80.122" class="difflineminus">-var runFile = function(w) {</span>
<a href="#l80.123"></a><span id="l80.123" class="difflineplus">+function runFile(w) {</span>
<a href="#l80.124"></a><span id="l80.124">   var nsIFilePicker = Ci.nsIFilePicker;</span>
<a href="#l80.125"></a><span id="l80.125">   var fp = Cc[&quot;@mozilla.org/filepicker;1&quot;].createInstance(nsIFilePicker);</span>
<a href="#l80.126"></a><span id="l80.126">   fp.init(w, &quot;Select a File&quot;, nsIFilePicker.modeOpen);</span>
<a href="#l80.127"></a><span id="l80.127" class="difflineminus">-  fp.appendFilter(&quot;JavaScript Files&quot;,&quot;*.js&quot;);</span>
<a href="#l80.128"></a><span id="l80.128" class="difflineplus">+  fp.appendFilter(&quot;JavaScript Files&quot;, &quot;*.js&quot;);</span>
<a href="#l80.129"></a><span id="l80.129">   fp.open(rv =&gt; {</span>
<a href="#l80.130"></a><span id="l80.130">     if (rv != nsIFilePicker.returnOK || !fp.files) {</span>
<a href="#l80.131"></a><span id="l80.131">       return;</span>
<a href="#l80.132"></a><span id="l80.132">     }</span>
<a href="#l80.133"></a><span id="l80.133">     let thefile = fp.file;</span>
<a href="#l80.134"></a><span id="l80.134" class="difflineminus">-    //create the paramObj with a files array attrib</span>
<a href="#l80.135"></a><span id="l80.135" class="difflineplus">+    // create the paramObj with a files array attrib</span>
<a href="#l80.136"></a><span id="l80.136">     var paramObj = {};</span>
<a href="#l80.137"></a><span id="l80.137">     paramObj.files = [];</span>
<a href="#l80.138"></a><span id="l80.138">     paramObj.files.push(thefile.path);</span>
<a href="#l80.139"></a><span id="l80.139"> </span>
<a href="#l80.140"></a><span id="l80.140" class="difflineminus">-   //Move focus to output tab</span>
<a href="#l80.141"></a><span id="l80.141" class="difflineminus">-   //w.document.getElementById('mmtabs').setAttribute(&quot;selectedIndex&quot;, 2);</span>
<a href="#l80.142"></a><span id="l80.142" class="difflineminus">-   //send it into the JS test framework to run the file</span>
<a href="#l80.143"></a><span id="l80.143" class="difflineminus">-   // jstest.runFromFile(thefile.path);</span>
<a href="#l80.144"></a><span id="l80.144" class="difflineplus">+    // Move focus to output tab</span>
<a href="#l80.145"></a><span id="l80.145" class="difflineplus">+    // w.document.getElementById('mmtabs').setAttribute(&quot;selectedIndex&quot;, 2);</span>
<a href="#l80.146"></a><span id="l80.146" class="difflineplus">+    // send it into the JS test framework to run the file</span>
<a href="#l80.147"></a><span id="l80.147" class="difflineplus">+    // jstest.runFromFile(thefile.path);</span>
<a href="#l80.148"></a><span id="l80.148">   });</span>
<a href="#l80.149"></a><span id="l80.149" class="difflineminus">-};</span>
<a href="#l80.150"></a><span id="l80.150" class="difflineplus">+}</span>
<a href="#l80.151"></a><span id="l80.151"> </span>
<a href="#l80.152"></a><span id="l80.152" class="difflineminus">- var saveFile = function(w, content, filename){</span>
<a href="#l80.153"></a><span id="l80.153" class="difflineminus">-   var file = Cc[&quot;@mozilla.org/file/local;1&quot;]</span>
<a href="#l80.154"></a><span id="l80.154" class="difflineminus">-                .createInstance(Ci.nsIFile);</span>
<a href="#l80.155"></a><span id="l80.155" class="difflineminus">-   file.initWithPath(filename);</span>
<a href="#l80.156"></a><span id="l80.156" class="difflineplus">+function saveFile(w, content, filename) {</span>
<a href="#l80.157"></a><span id="l80.157" class="difflineplus">+  var file = Cc[&quot;@mozilla.org/file/local;1&quot;].createInstance(Ci.nsIFile);</span>
<a href="#l80.158"></a><span id="l80.158" class="difflineplus">+  file.initWithPath(filename);</span>
<a href="#l80.159"></a><span id="l80.159"> </span>
<a href="#l80.160"></a><span id="l80.160" class="difflineminus">-   // file is nsIFile, data is a string</span>
<a href="#l80.161"></a><span id="l80.161" class="difflineminus">-   var foStream = Cc[&quot;@mozilla.org/network/file-output-stream;1&quot;]</span>
<a href="#l80.162"></a><span id="l80.162" class="difflineminus">-                    .createInstance(Ci.nsIFileOutputStream);</span>
<a href="#l80.163"></a><span id="l80.163" class="difflineplus">+  // file is nsIFile, data is a string</span>
<a href="#l80.164"></a><span id="l80.164" class="difflineplus">+  var foStream = Cc[&quot;@mozilla.org/network/file-output-stream;1&quot;].createInstance(Ci.nsIFileOutputStream);</span>
<a href="#l80.165"></a><span id="l80.165"> </span>
<a href="#l80.166"></a><span id="l80.166" class="difflineminus">-   // use 0x02 | 0x10 to open file for appending.</span>
<a href="#l80.167"></a><span id="l80.167" class="difflineminus">-   foStream.init(file, 0x02 | 0x08 | 0x20, 0o666, 0);</span>
<a href="#l80.168"></a><span id="l80.168" class="difflineminus">-   // write, create, truncate</span>
<a href="#l80.169"></a><span id="l80.169" class="difflineminus">-   // In a c file operation, we have no need to set file mode with or operation,</span>
<a href="#l80.170"></a><span id="l80.170" class="difflineminus">-   // directly using &quot;r&quot; or &quot;w&quot; usually.</span>
<a href="#l80.171"></a><span id="l80.171" class="difflineplus">+  // use 0x02 | 0x10 to open file for appending.</span>
<a href="#l80.172"></a><span id="l80.172" class="difflineplus">+  foStream.init(file, 0x02 | 0x08 | 0x20, 0o666, 0);</span>
<a href="#l80.173"></a><span id="l80.173" class="difflineplus">+  // write, create, truncate</span>
<a href="#l80.174"></a><span id="l80.174" class="difflineplus">+  // In a c file operation, we have no need to set file mode with or operation,</span>
<a href="#l80.175"></a><span id="l80.175" class="difflineplus">+  // directly using &quot;r&quot; or &quot;w&quot; usually.</span>
<a href="#l80.176"></a><span id="l80.176"> </span>
<a href="#l80.177"></a><span id="l80.177" class="difflineminus">-   foStream.write(content, content.length);</span>
<a href="#l80.178"></a><span id="l80.178" class="difflineminus">-   foStream.close();</span>
<a href="#l80.179"></a><span id="l80.179" class="difflineminus">- };</span>
<a href="#l80.180"></a><span id="l80.180" class="difflineplus">+  foStream.write(content, content.length);</span>
<a href="#l80.181"></a><span id="l80.181" class="difflineplus">+  foStream.close();</span>
<a href="#l80.182"></a><span id="l80.182" class="difflineplus">+}</span>
<a href="#l80.183"></a><span id="l80.183"> </span>
<a href="#l80.184"></a><span id="l80.184" class="difflineminus">-  var saveAsFile = function(w, content) {</span>
<a href="#l80.185"></a><span id="l80.185" class="difflineminus">-    var nsIFilePicker = Ci.nsIFilePicker;</span>
<a href="#l80.186"></a><span id="l80.186" class="difflineminus">-    var fp = Cc[&quot;@mozilla.org/filepicker;1&quot;].createInstance(nsIFilePicker);</span>
<a href="#l80.187"></a><span id="l80.187" class="difflineminus">-    fp.init(w, &quot;Select a File&quot;, nsIFilePicker.modeSave);</span>
<a href="#l80.188"></a><span id="l80.188" class="difflineminus">-    fp.appendFilter(&quot;JavaScript Files&quot;,&quot;*.js&quot;);</span>
<a href="#l80.189"></a><span id="l80.189" class="difflineminus">-</span>
<a href="#l80.190"></a><span id="l80.190" class="difflineminus">-    return new Promise(resolve =&gt; {</span>
<a href="#l80.191"></a><span id="l80.191" class="difflineminus">-      fp.open(rv =&gt; {</span>
<a href="#l80.192"></a><span id="l80.192" class="difflineminus">-        if ((rv != nsIFilePicker.returnOK &amp;&amp; rv != nsIFilePicker.returnReplace) || !fp.file) {</span>
<a href="#l80.193"></a><span id="l80.193" class="difflineminus">-          resolve(null)</span>
<a href="#l80.194"></a><span id="l80.194" class="difflineminus">-          return;</span>
<a href="#l80.195"></a><span id="l80.195" class="difflineminus">-        }</span>
<a href="#l80.196"></a><span id="l80.196" class="difflineminus">-        var thefile = fp.file;</span>
<a href="#l80.197"></a><span id="l80.197" class="difflineplus">+function saveAsFile(w, content) {</span>
<a href="#l80.198"></a><span id="l80.198" class="difflineplus">+  var nsIFilePicker = Ci.nsIFilePicker;</span>
<a href="#l80.199"></a><span id="l80.199" class="difflineplus">+  var fp = Cc[&quot;@mozilla.org/filepicker;1&quot;].createInstance(nsIFilePicker);</span>
<a href="#l80.200"></a><span id="l80.200" class="difflineplus">+  fp.init(w, &quot;Select a File&quot;, nsIFilePicker.modeSave);</span>
<a href="#l80.201"></a><span id="l80.201" class="difflineplus">+  fp.appendFilter(&quot;JavaScript Files&quot;, &quot;*.js&quot;);</span>
<a href="#l80.202"></a><span id="l80.202"> </span>
<a href="#l80.203"></a><span id="l80.203" class="difflineminus">-        // forcing the user to save as a .js file</span>
<a href="#l80.204"></a><span id="l80.204" class="difflineminus">-        if (thefile.path.indexOf(&quot;.js&quot;) == -1) {</span>
<a href="#l80.205"></a><span id="l80.205" class="difflineminus">-          // define the file interface</span>
<a href="#l80.206"></a><span id="l80.206" class="difflineminus">-          var file = Cc[&quot;@mozilla.org/file/local;1&quot;]</span>
<a href="#l80.207"></a><span id="l80.207" class="difflineminus">-                              .createInstance(Ci.nsIFile);</span>
<a href="#l80.208"></a><span id="l80.208" class="difflineminus">-          // point it at the file we want to get at</span>
<a href="#l80.209"></a><span id="l80.209" class="difflineminus">-          file.initWithPath(thefile.path+&quot;.js&quot;);</span>
<a href="#l80.210"></a><span id="l80.210" class="difflineminus">-          var thefile = file;</span>
<a href="#l80.211"></a><span id="l80.211" class="difflineminus">-        }</span>
<a href="#l80.212"></a><span id="l80.212" class="difflineplus">+  return new Promise(resolve =&gt; {</span>
<a href="#l80.213"></a><span id="l80.213" class="difflineplus">+    fp.open(rv =&gt; {</span>
<a href="#l80.214"></a><span id="l80.214" class="difflineplus">+      if ((rv != nsIFilePicker.returnOK &amp;&amp; rv != nsIFilePicker.returnReplace) || !fp.file) {</span>
<a href="#l80.215"></a><span id="l80.215" class="difflineplus">+        resolve(null);</span>
<a href="#l80.216"></a><span id="l80.216" class="difflineplus">+        return;</span>
<a href="#l80.217"></a><span id="l80.217" class="difflineplus">+      }</span>
<a href="#l80.218"></a><span id="l80.218" class="difflineplus">+      var thefile = fp.file;</span>
<a href="#l80.219"></a><span id="l80.219"> </span>
<a href="#l80.220"></a><span id="l80.220" class="difflineminus">-        // file is nsIFile, data is a string</span>
<a href="#l80.221"></a><span id="l80.221" class="difflineminus">-        var foStream = Cc[&quot;@mozilla.org/network/file-output-stream;1&quot;]</span>
<a href="#l80.222"></a><span id="l80.222" class="difflineminus">-                               .createInstance(Ci.nsIFileOutputStream);</span>
<a href="#l80.223"></a><span id="l80.223" class="difflineplus">+      // forcing the user to save as a .js file</span>
<a href="#l80.224"></a><span id="l80.224" class="difflineplus">+      if (!thefile.path.includes(&quot;.js&quot;)) {</span>
<a href="#l80.225"></a><span id="l80.225" class="difflineplus">+        // define the file interface</span>
<a href="#l80.226"></a><span id="l80.226" class="difflineplus">+        var file = Cc[&quot;@mozilla.org/file/local;1&quot;].createInstance(Ci.nsIFile);</span>
<a href="#l80.227"></a><span id="l80.227" class="difflineplus">+        // point it at the file we want to get at</span>
<a href="#l80.228"></a><span id="l80.228" class="difflineplus">+        file.initWithPath(thefile.path + &quot;.js&quot;);</span>
<a href="#l80.229"></a><span id="l80.229" class="difflineplus">+        thefile = file;</span>
<a href="#l80.230"></a><span id="l80.230" class="difflineplus">+      }</span>
<a href="#l80.231"></a><span id="l80.231" class="difflineplus">+</span>
<a href="#l80.232"></a><span id="l80.232" class="difflineplus">+      // file is nsIFile, data is a string</span>
<a href="#l80.233"></a><span id="l80.233" class="difflineplus">+      var foStream = Cc[&quot;@mozilla.org/network/file-output-stream;1&quot;]</span>
<a href="#l80.234"></a><span id="l80.234" class="difflineplus">+                       .createInstance(Ci.nsIFileOutputStream);</span>
<a href="#l80.235"></a><span id="l80.235"> </span>
<a href="#l80.236"></a><span id="l80.236" class="difflineminus">-        // use 0x02 | 0x10 to open file for appending.</span>
<a href="#l80.237"></a><span id="l80.237" class="difflineminus">-        foStream.init(thefile, 0x02 | 0x08 | 0x20, 0o666, 0);</span>
<a href="#l80.238"></a><span id="l80.238" class="difflineminus">-        // write, create, truncate</span>
<a href="#l80.239"></a><span id="l80.239" class="difflineminus">-        // In a c file operation, we have no need to set file mode with or operation,</span>
<a href="#l80.240"></a><span id="l80.240" class="difflineminus">-        // directly using &quot;r&quot; or &quot;w&quot; usually.</span>
<a href="#l80.241"></a><span id="l80.241" class="difflineminus">-        foStream.write(content, content.length);</span>
<a href="#l80.242"></a><span id="l80.242" class="difflineminus">-        foStream.close();</span>
<a href="#l80.243"></a><span id="l80.243" class="difflineminus">-        resolve(thefile.path);</span>
<a href="#l80.244"></a><span id="l80.244" class="difflineminus">-      });</span>
<a href="#l80.245"></a><span id="l80.245" class="difflineplus">+      // use 0x02 | 0x10 to open file for appending.</span>
<a href="#l80.246"></a><span id="l80.246" class="difflineplus">+      foStream.init(thefile, 0x02 | 0x08 | 0x20, 0o666, 0);</span>
<a href="#l80.247"></a><span id="l80.247" class="difflineplus">+      // write, create, truncate</span>
<a href="#l80.248"></a><span id="l80.248" class="difflineplus">+      // In a c file operation, we have no need to set file mode with or operation,</span>
<a href="#l80.249"></a><span id="l80.249" class="difflineplus">+      // directly using &quot;r&quot; or &quot;w&quot; usually.</span>
<a href="#l80.250"></a><span id="l80.250" class="difflineplus">+      foStream.write(content, content.length);</span>
<a href="#l80.251"></a><span id="l80.251" class="difflineplus">+      foStream.close();</span>
<a href="#l80.252"></a><span id="l80.252" class="difflineplus">+      resolve(thefile.path);</span>
<a href="#l80.253"></a><span id="l80.253">     });</span>
<a href="#l80.254"></a><span id="l80.254" class="difflineminus">-  };</span>
<a href="#l80.255"></a><span id="l80.255" class="difflineplus">+  });</span>
<a href="#l80.256"></a><span id="l80.256" class="difflineplus">+}</span>
<a href="#l80.257"></a><span id="l80.257"> </span>
<a href="#l80.258"></a><span id="l80.258" class="difflineminus">-  var openFile = function(w) {</span>
<a href="#l80.259"></a><span id="l80.259" class="difflineminus">-    //define the interface</span>
<a href="#l80.260"></a><span id="l80.260" class="difflineminus">-    var nsIFilePicker = Ci.nsIFilePicker;</span>
<a href="#l80.261"></a><span id="l80.261" class="difflineminus">-    var fp = Cc[&quot;@mozilla.org/filepicker;1&quot;].createInstance(nsIFilePicker);</span>
<a href="#l80.262"></a><span id="l80.262" class="difflineminus">-    //define the file picker window</span>
<a href="#l80.263"></a><span id="l80.263" class="difflineminus">-    fp.init(w, &quot;Select a File&quot;, nsIFilePicker.modeOpen);</span>
<a href="#l80.264"></a><span id="l80.264" class="difflineminus">-    fp.appendFilter(&quot;JavaScript Files&quot;,&quot;*.js&quot;);</span>
<a href="#l80.265"></a><span id="l80.265" class="difflineminus">-    return new Promise(resolve =&gt; {</span>
<a href="#l80.266"></a><span id="l80.266" class="difflineminus">-      //show the window</span>
<a href="#l80.267"></a><span id="l80.267" class="difflineminus">-      fp.open(rv =&gt; {</span>
<a href="#l80.268"></a><span id="l80.268" class="difflineminus">-        if (rv != nsIFilePicker.returnOK || !fp.file) {</span>
<a href="#l80.269"></a><span id="l80.269" class="difflineminus">-          resolve(null);</span>
<a href="#l80.270"></a><span id="l80.270" class="difflineminus">-          return;</span>
<a href="#l80.271"></a><span id="l80.271" class="difflineminus">-        }</span>
<a href="#l80.272"></a><span id="l80.272" class="difflineminus">-        var thefile = fp.file;</span>
<a href="#l80.273"></a><span id="l80.273" class="difflineminus">-        //create the paramObj with a files array attrib</span>
<a href="#l80.274"></a><span id="l80.274" class="difflineminus">-        var data = getFile(thefile.path);</span>
<a href="#l80.275"></a><span id="l80.275" class="difflineminus">-        resolve({path:thefile.path, data:data});</span>
<a href="#l80.276"></a><span id="l80.276" class="difflineminus">-      });</span>
<a href="#l80.277"></a><span id="l80.277" class="difflineplus">+function openFile(w) {</span>
<a href="#l80.278"></a><span id="l80.278" class="difflineplus">+  // define the interface</span>
<a href="#l80.279"></a><span id="l80.279" class="difflineplus">+  var nsIFilePicker = Ci.nsIFilePicker;</span>
<a href="#l80.280"></a><span id="l80.280" class="difflineplus">+  var fp = Cc[&quot;@mozilla.org/filepicker;1&quot;].createInstance(nsIFilePicker);</span>
<a href="#l80.281"></a><span id="l80.281" class="difflineplus">+  // define the file picker window</span>
<a href="#l80.282"></a><span id="l80.282" class="difflineplus">+  fp.init(w, &quot;Select a File&quot;, nsIFilePicker.modeOpen);</span>
<a href="#l80.283"></a><span id="l80.283" class="difflineplus">+  fp.appendFilter(&quot;JavaScript Files&quot;, &quot;*.js&quot;);</span>
<a href="#l80.284"></a><span id="l80.284" class="difflineplus">+  return new Promise(resolve =&gt; {</span>
<a href="#l80.285"></a><span id="l80.285" class="difflineplus">+    // show the window</span>
<a href="#l80.286"></a><span id="l80.286" class="difflineplus">+    fp.open(rv =&gt; {</span>
<a href="#l80.287"></a><span id="l80.287" class="difflineplus">+      if (rv != nsIFilePicker.returnOK || !fp.file) {</span>
<a href="#l80.288"></a><span id="l80.288" class="difflineplus">+        resolve(null);</span>
<a href="#l80.289"></a><span id="l80.289" class="difflineplus">+        return;</span>
<a href="#l80.290"></a><span id="l80.290" class="difflineplus">+      }</span>
<a href="#l80.291"></a><span id="l80.291" class="difflineplus">+      var thefile = fp.file;</span>
<a href="#l80.292"></a><span id="l80.292" class="difflineplus">+      // create the paramObj with a files array attrib</span>
<a href="#l80.293"></a><span id="l80.293" class="difflineplus">+      var data = getFile(thefile.path);</span>
<a href="#l80.294"></a><span id="l80.294" class="difflineplus">+      resolve({path: thefile.path, data});</span>
<a href="#l80.295"></a><span id="l80.295">     });</span>
<a href="#l80.296"></a><span id="l80.296" class="difflineminus">-  };</span>
<a href="#l80.297"></a><span id="l80.297" class="difflineplus">+  });</span>
<a href="#l80.298"></a><span id="l80.298" class="difflineplus">+}</span>
<a href="#l80.299"></a><span id="l80.299"> </span>
<a href="#l80.300"></a><span id="l80.300" class="difflineminus">- var getFile = function(path){</span>
<a href="#l80.301"></a><span id="l80.301" class="difflineminus">-   //define the file interface</span>
<a href="#l80.302"></a><span id="l80.302" class="difflineminus">-   var file = Cc[&quot;@mozilla.org/file/local;1&quot;]</span>
<a href="#l80.303"></a><span id="l80.303" class="difflineminus">-                .createInstance(Ci.nsIFile);</span>
<a href="#l80.304"></a><span id="l80.304" class="difflineminus">-   //point it at the file we want to get at</span>
<a href="#l80.305"></a><span id="l80.305" class="difflineminus">-   file.initWithPath(path);</span>
<a href="#l80.306"></a><span id="l80.306" class="difflineminus">-   // define file stream interfaces</span>
<a href="#l80.307"></a><span id="l80.307" class="difflineminus">-   var data = &quot;&quot;;</span>
<a href="#l80.308"></a><span id="l80.308" class="difflineminus">-   var fstream = Cc[&quot;@mozilla.org/network/file-input-stream;1&quot;]</span>
<a href="#l80.309"></a><span id="l80.309" class="difflineminus">-                   .createInstance(Ci.nsIFileInputStream);</span>
<a href="#l80.310"></a><span id="l80.310" class="difflineminus">-   var sstream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;]</span>
<a href="#l80.311"></a><span id="l80.311" class="difflineminus">-                   .createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l80.312"></a><span id="l80.312" class="difflineminus">-   fstream.init(file, -1, 0, 0);</span>
<a href="#l80.313"></a><span id="l80.313" class="difflineminus">-   sstream.init(fstream);</span>
<a href="#l80.314"></a><span id="l80.314" class="difflineplus">+function getFile(path) {</span>
<a href="#l80.315"></a><span id="l80.315" class="difflineplus">+  // define the file interface</span>
<a href="#l80.316"></a><span id="l80.316" class="difflineplus">+  var file = Cc[&quot;@mozilla.org/file/local;1&quot;].createInstance(Ci.nsIFile);</span>
<a href="#l80.317"></a><span id="l80.317" class="difflineplus">+  // point it at the file we want to get at</span>
<a href="#l80.318"></a><span id="l80.318" class="difflineplus">+  file.initWithPath(path);</span>
<a href="#l80.319"></a><span id="l80.319" class="difflineplus">+  // define file stream interfaces</span>
<a href="#l80.320"></a><span id="l80.320" class="difflineplus">+  var data = &quot;&quot;;</span>
<a href="#l80.321"></a><span id="l80.321" class="difflineplus">+  var fstream = Cc[&quot;@mozilla.org/network/file-input-stream;1&quot;]</span>
<a href="#l80.322"></a><span id="l80.322" class="difflineplus">+                  .createInstance(Ci.nsIFileInputStream);</span>
<a href="#l80.323"></a><span id="l80.323" class="difflineplus">+  var sstream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;]</span>
<a href="#l80.324"></a><span id="l80.324" class="difflineplus">+                  .createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l80.325"></a><span id="l80.325" class="difflineplus">+  fstream.init(file, -1, 0, 0);</span>
<a href="#l80.326"></a><span id="l80.326" class="difflineplus">+  sstream.init(fstream);</span>
<a href="#l80.327"></a><span id="l80.327"> </span>
<a href="#l80.328"></a><span id="l80.328" class="difflineminus">-   //pull the contents of the file out</span>
<a href="#l80.329"></a><span id="l80.329" class="difflineminus">-   var str = sstream.read(4096);</span>
<a href="#l80.330"></a><span id="l80.330" class="difflineminus">-   while (str.length &gt; 0) {</span>
<a href="#l80.331"></a><span id="l80.331" class="difflineminus">-     data += str;</span>
<a href="#l80.332"></a><span id="l80.332" class="difflineminus">-     str = sstream.read(4096);</span>
<a href="#l80.333"></a><span id="l80.333" class="difflineminus">-   }</span>
<a href="#l80.334"></a><span id="l80.334" class="difflineplus">+  // pull the contents of the file out</span>
<a href="#l80.335"></a><span id="l80.335" class="difflineplus">+  var str = sstream.read(4096);</span>
<a href="#l80.336"></a><span id="l80.336" class="difflineplus">+  while (str.length &gt; 0) {</span>
<a href="#l80.337"></a><span id="l80.337" class="difflineplus">+    data += str;</span>
<a href="#l80.338"></a><span id="l80.338" class="difflineplus">+    str = sstream.read(4096);</span>
<a href="#l80.339"></a><span id="l80.339" class="difflineplus">+  }</span>
<a href="#l80.340"></a><span id="l80.340"> </span>
<a href="#l80.341"></a><span id="l80.341" class="difflineminus">-   sstream.close();</span>
<a href="#l80.342"></a><span id="l80.342" class="difflineminus">-   fstream.close();</span>
<a href="#l80.343"></a><span id="l80.343" class="difflineplus">+  sstream.close();</span>
<a href="#l80.344"></a><span id="l80.344" class="difflineplus">+  fstream.close();</span>
<a href="#l80.345"></a><span id="l80.345"> </span>
<a href="#l80.346"></a><span id="l80.346" class="difflineminus">-   //data = data.replace(/\r|\n|\r\n/g, &quot;&quot;);</span>
<a href="#l80.347"></a><span id="l80.347" class="difflineminus">-   return data;</span>
<a href="#l80.348"></a><span id="l80.348" class="difflineminus">- };</span>
<a href="#l80.349"></a><span id="l80.349" class="difflineplus">+  // data = data.replace(/\r|\n|\r\n/g, &quot;&quot;);</span>
<a href="#l80.350"></a><span id="l80.350" class="difflineplus">+  return data;</span>
<a href="#l80.351"></a><span id="l80.351" class="difflineplus">+}</span>
<a href="#l80.352"></a><span id="l80.352"> </span>
<a href="#l80.353"></a><span id="l80.353"> /**</span>
<a href="#l80.354"></a><span id="l80.354">  * Called to get the state of an individual preference.</span>
<a href="#l80.355"></a><span id="l80.355">  *</span>
<a href="#l80.356"></a><span id="l80.356">  * @param aPrefName     string The preference to get the state of.</span>
<a href="#l80.357"></a><span id="l80.357">  * @param aDefaultValue any    The default value if preference was not found.</span>
<a href="#l80.358"></a><span id="l80.358">  *</span>
<a href="#l80.359"></a><span id="l80.359">  * @returns any The value of the requested preference</span>
<a href="#l80.360"></a><span id="l80.360">  *</span>
<a href="#l80.361"></a><span id="l80.361">  * @see setPref</span>
<a href="#l80.362"></a><span id="l80.362">  * Code by Henrik Skupin: &lt;hskupin@gmail.com&gt;</span>
<a href="#l80.363"></a><span id="l80.363">  */</span>
<a href="#l80.364"></a><span id="l80.364"> function getPreference(aPrefName, aDefaultValue) {</span>
<a href="#l80.365"></a><span id="l80.365">   try {</span>
<a href="#l80.366"></a><span id="l80.366" class="difflineminus">-    var branch = Cc[&quot;@mozilla.org/preferences-service;1&quot;].</span>
<a href="#l80.367"></a><span id="l80.367" class="difflineminus">-                 getService(Ci.nsIPrefBranch);</span>
<a href="#l80.368"></a><span id="l80.368">     switch (typeof aDefaultValue) {</span>
<a href="#l80.369"></a><span id="l80.369" class="difflineminus">-      case ('boolean'):</span>
<a href="#l80.370"></a><span id="l80.370" class="difflineminus">-        return branch.getBoolPref(aPrefName);</span>
<a href="#l80.371"></a><span id="l80.371" class="difflineminus">-      case ('string'):</span>
<a href="#l80.372"></a><span id="l80.372" class="difflineminus">-        return branch.getCharPref(aPrefName);</span>
<a href="#l80.373"></a><span id="l80.373" class="difflineminus">-      case ('number'):</span>
<a href="#l80.374"></a><span id="l80.374" class="difflineminus">-        return branch.getIntPref(aPrefName);</span>
<a href="#l80.375"></a><span id="l80.375" class="difflineplus">+      case (&quot;boolean&quot;):</span>
<a href="#l80.376"></a><span id="l80.376" class="difflineplus">+        return Services.prefs.getBoolPref(aPrefName);</span>
<a href="#l80.377"></a><span id="l80.377" class="difflineplus">+      case (&quot;string&quot;):</span>
<a href="#l80.378"></a><span id="l80.378" class="difflineplus">+        return Services.prefs.getCharPref(aPrefName);</span>
<a href="#l80.379"></a><span id="l80.379" class="difflineplus">+      case (&quot;number&quot;):</span>
<a href="#l80.380"></a><span id="l80.380" class="difflineplus">+        return Services.prefs.getIntPref(aPrefName);</span>
<a href="#l80.381"></a><span id="l80.381">       default:</span>
<a href="#l80.382"></a><span id="l80.382" class="difflineminus">-        return branch.getComplexValue(aPrefName);</span>
<a href="#l80.383"></a><span id="l80.383" class="difflineplus">+        return Services.prefs.getComplexValue(aPrefName);</span>
<a href="#l80.384"></a><span id="l80.384">     }</span>
<a href="#l80.385"></a><span id="l80.385" class="difflineminus">-  } catch(e) {</span>
<a href="#l80.386"></a><span id="l80.386" class="difflineplus">+  } catch (e) {</span>
<a href="#l80.387"></a><span id="l80.387">     return aDefaultValue;</span>
<a href="#l80.388"></a><span id="l80.388">   }</span>
<a href="#l80.389"></a><span id="l80.389"> }</span>
<a href="#l80.390"></a><span id="l80.390"> </span>
<a href="#l80.391"></a><span id="l80.391"> /**</span>
<a href="#l80.392"></a><span id="l80.392">  * Called to set the state of an individual preference.</span>
<a href="#l80.393"></a><span id="l80.393">  *</span>
<a href="#l80.394"></a><span id="l80.394">  * @param aPrefName string The preference to set the state of.</span>
<a href="#l80.395"></a><span id="l80.395" class="difflineat">@@ -306,53 +285,52 @@ function getPreference(aPrefName, aDefau</span>
<a href="#l80.396"></a><span id="l80.396">  *</span>
<a href="#l80.397"></a><span id="l80.397">  * @returns boolean Returns true if value was successfully set.</span>
<a href="#l80.398"></a><span id="l80.398">  *</span>
<a href="#l80.399"></a><span id="l80.399">  * @see getPref</span>
<a href="#l80.400"></a><span id="l80.400">  * Code by Henrik Skupin: &lt;hskupin@gmail.com&gt;</span>
<a href="#l80.401"></a><span id="l80.401">  */</span>
<a href="#l80.402"></a><span id="l80.402"> function setPreference(aName, aValue) {</span>
<a href="#l80.403"></a><span id="l80.403">   try {</span>
<a href="#l80.404"></a><span id="l80.404" class="difflineminus">-    var branch = Cc[&quot;@mozilla.org/preferences-service;1&quot;].</span>
<a href="#l80.405"></a><span id="l80.405" class="difflineminus">-                 getService(Ci.nsIPrefBranch);</span>
<a href="#l80.406"></a><span id="l80.406">     switch (typeof aValue) {</span>
<a href="#l80.407"></a><span id="l80.407" class="difflineminus">-      case ('boolean'):</span>
<a href="#l80.408"></a><span id="l80.408" class="difflineminus">-        branch.setBoolPref(aName, aValue);</span>
<a href="#l80.409"></a><span id="l80.409" class="difflineplus">+      case (&quot;boolean&quot;):</span>
<a href="#l80.410"></a><span id="l80.410" class="difflineplus">+        Services.prefs.setBoolPref(aName, aValue);</span>
<a href="#l80.411"></a><span id="l80.411">         break;</span>
<a href="#l80.412"></a><span id="l80.412" class="difflineminus">-      case ('string'):</span>
<a href="#l80.413"></a><span id="l80.413" class="difflineminus">-        branch.setCharPref(aName, aValue);</span>
<a href="#l80.414"></a><span id="l80.414" class="difflineplus">+      case (&quot;string&quot;):</span>
<a href="#l80.415"></a><span id="l80.415" class="difflineplus">+        Services.prefs.setCharPref(aName, aValue);</span>
<a href="#l80.416"></a><span id="l80.416">         break;</span>
<a href="#l80.417"></a><span id="l80.417" class="difflineminus">-      case ('number'):</span>
<a href="#l80.418"></a><span id="l80.418" class="difflineminus">-        branch.setIntPref(aName, aValue);</span>
<a href="#l80.419"></a><span id="l80.419" class="difflineplus">+      case (&quot;number&quot;):</span>
<a href="#l80.420"></a><span id="l80.420" class="difflineplus">+        Services.prefs.setIntPref(aName, aValue);</span>
<a href="#l80.421"></a><span id="l80.421">         break;</span>
<a href="#l80.422"></a><span id="l80.422">       default:</span>
<a href="#l80.423"></a><span id="l80.423" class="difflineminus">-        branch.setComplexValue(aName, aValue);</span>
<a href="#l80.424"></a><span id="l80.424" class="difflineplus">+        Services.prefs.setComplexValue(aName, aValue);</span>
<a href="#l80.425"></a><span id="l80.425">     }</span>
<a href="#l80.426"></a><span id="l80.426" class="difflineminus">-  } catch(e) {</span>
<a href="#l80.427"></a><span id="l80.427" class="difflineplus">+  } catch (e) {</span>
<a href="#l80.428"></a><span id="l80.428">     return false;</span>
<a href="#l80.429"></a><span id="l80.429">   }</span>
<a href="#l80.430"></a><span id="l80.430"> </span>
<a href="#l80.431"></a><span id="l80.431">   return true;</span>
<a href="#l80.432"></a><span id="l80.432"> }</span>
<a href="#l80.433"></a><span id="l80.433"> </span>
<a href="#l80.434"></a><span id="l80.434"> /**</span>
<a href="#l80.435"></a><span id="l80.435">  * Sleep for the given amount of milliseconds</span>
<a href="#l80.436"></a><span id="l80.436">  *</span>
<a href="#l80.437"></a><span id="l80.437">  * @param {number} milliseconds</span>
<a href="#l80.438"></a><span id="l80.438">  *        Sleeps the given number of milliseconds</span>
<a href="#l80.439"></a><span id="l80.439">  */</span>
<a href="#l80.440"></a><span id="l80.440"> function sleep(milliseconds) {</span>
<a href="#l80.441"></a><span id="l80.441">   // We basically just call this once after the specified number of milliseconds</span>
<a href="#l80.442"></a><span id="l80.442">   var timeup = false;</span>
<a href="#l80.443"></a><span id="l80.443" class="difflineminus">-  function wait() { timeup = true; }</span>
<a href="#l80.444"></a><span id="l80.444" class="difflineplus">+  function wait() {</span>
<a href="#l80.445"></a><span id="l80.445" class="difflineplus">+    timeup = true;</span>
<a href="#l80.446"></a><span id="l80.446" class="difflineplus">+  }</span>
<a href="#l80.447"></a><span id="l80.447">   hwindow.setTimeout(wait, milliseconds);</span>
<a href="#l80.448"></a><span id="l80.448"> </span>
<a href="#l80.449"></a><span id="l80.449" class="difflineminus">-  var thread = Cc[&quot;@mozilla.org/thread-manager;1&quot;].</span>
<a href="#l80.450"></a><span id="l80.450" class="difflineminus">-               getService().currentThread;</span>
<a href="#l80.451"></a><span id="l80.451" class="difflineminus">-  while(!timeup) {</span>
<a href="#l80.452"></a><span id="l80.452" class="difflineplus">+  var thread = Services.tm.currentThread;</span>
<a href="#l80.453"></a><span id="l80.453" class="difflineplus">+  while (!timeup) {</span>
<a href="#l80.454"></a><span id="l80.454">     thread.processNextEvent(true);</span>
<a href="#l80.455"></a><span id="l80.455">   }</span>
<a href="#l80.456"></a><span id="l80.456"> }</span>
<a href="#l80.457"></a><span id="l80.457"> </span>
<a href="#l80.458"></a><span id="l80.458"> /**</span>
<a href="#l80.459"></a><span id="l80.459">  * Check if the callback function evaluates to true</span>
<a href="#l80.460"></a><span id="l80.460">  */</span>
<a href="#l80.461"></a><span id="l80.461"> function assert(callback, message, thisObject) {</span>
<a href="#l80.462"></a><span id="l80.462" class="difflineat">@@ -361,54 +339,32 @@ function assert(callback, message, thisO</span>
<a href="#l80.463"></a><span id="l80.463">   if (!result) {</span>
<a href="#l80.464"></a><span id="l80.464">     throw new Error(message || &quot;assert: Failed for '&quot; + callback + &quot;'&quot;);</span>
<a href="#l80.465"></a><span id="l80.465">   }</span>
<a href="#l80.466"></a><span id="l80.466"> </span>
<a href="#l80.467"></a><span id="l80.467">   return true;</span>
<a href="#l80.468"></a><span id="l80.468"> }</span>
<a href="#l80.469"></a><span id="l80.469"> </span>
<a href="#l80.470"></a><span id="l80.470"> /**</span>
<a href="#l80.471"></a><span id="l80.471" class="difflineminus">- * Unwraps a node which is wrapped into a XPCNativeWrapper or XrayWrapper</span>
<a href="#l80.472"></a><span id="l80.472" class="difflineminus">- *</span>
<a href="#l80.473"></a><span id="l80.473" class="difflineminus">- * @param {DOMnode} Wrapped DOM node</span>
<a href="#l80.474"></a><span id="l80.474" class="difflineminus">- * @returns {DOMNode} Unwrapped DOM node</span>
<a href="#l80.475"></a><span id="l80.475" class="difflineminus">- */</span>
<a href="#l80.476"></a><span id="l80.476" class="difflineminus">-</span>
<a href="#l80.477"></a><span id="l80.477" class="difflineminus">-function unwrapNode(aNode) {</span>
<a href="#l80.478"></a><span id="l80.478" class="difflineminus">-  var node = aNode;</span>
<a href="#l80.479"></a><span id="l80.479" class="difflineminus">-  if (node) {</span>
<a href="#l80.480"></a><span id="l80.480" class="difflineminus">-    // unwrap is not available on older branches (3.5 and 3.6) - Bug 533596</span>
<a href="#l80.481"></a><span id="l80.481" class="difflineminus">-    if (&quot;unwrap&quot; in XPCNativeWrapper) {</span>
<a href="#l80.482"></a><span id="l80.482" class="difflineminus">-      node = XPCNativeWrapper.unwrap(node);</span>
<a href="#l80.483"></a><span id="l80.483" class="difflineminus">-    }</span>
<a href="#l80.484"></a><span id="l80.484" class="difflineminus">-    else if (node.wrappedJSObject != null) {</span>
<a href="#l80.485"></a><span id="l80.485" class="difflineminus">-      node = node.wrappedJSObject;</span>
<a href="#l80.486"></a><span id="l80.486" class="difflineminus">-    }</span>
<a href="#l80.487"></a><span id="l80.487" class="difflineminus">-  }</span>
<a href="#l80.488"></a><span id="l80.488" class="difflineminus">-  return node;</span>
<a href="#l80.489"></a><span id="l80.489" class="difflineminus">-}</span>
<a href="#l80.490"></a><span id="l80.490" class="difflineminus">-</span>
<a href="#l80.491"></a><span id="l80.491" class="difflineminus">-</span>
<a href="#l80.492"></a><span id="l80.492" class="difflineminus">-/**</span>
<a href="#l80.493"></a><span id="l80.493">  * TimeoutError</span>
<a href="#l80.494"></a><span id="l80.494">  *</span>
<a href="#l80.495"></a><span id="l80.495">  * Error object used for timeouts</span>
<a href="#l80.496"></a><span id="l80.496">  */</span>
<a href="#l80.497"></a><span id="l80.497"> function TimeoutError(message, fileName, lineNumber) {</span>
<a href="#l80.498"></a><span id="l80.498">   var err = new Error();</span>
<a href="#l80.499"></a><span id="l80.499">   if (err.stack) {</span>
<a href="#l80.500"></a><span id="l80.500">     this.stack = err.stack;</span>
<a href="#l80.501"></a><span id="l80.501">   }</span>
<a href="#l80.502"></a><span id="l80.502">   this.message = message === undefined ? err.message : message;</span>
<a href="#l80.503"></a><span id="l80.503">   this.fileName = fileName === undefined ? err.fileName : fileName;</span>
<a href="#l80.504"></a><span id="l80.504">   this.lineNumber = lineNumber === undefined ? err.lineNumber : lineNumber;</span>
<a href="#l80.505"></a><span id="l80.505" class="difflineminus">-};</span>
<a href="#l80.506"></a><span id="l80.506" class="difflineplus">+}</span>
<a href="#l80.507"></a><span id="l80.507"> TimeoutError.prototype = new Error();</span>
<a href="#l80.508"></a><span id="l80.508"> TimeoutError.prototype.constructor = TimeoutError;</span>
<a href="#l80.509"></a><span id="l80.509" class="difflineminus">-TimeoutError.prototype.name = 'TimeoutError';</span>
<a href="#l80.510"></a><span id="l80.510" class="difflineplus">+TimeoutError.prototype.name = &quot;TimeoutError&quot;;</span>
<a href="#l80.511"></a><span id="l80.511"> </span>
<a href="#l80.512"></a><span id="l80.512"> /**</span>
<a href="#l80.513"></a><span id="l80.513">  * Waits for the callback evaluates to true</span>
<a href="#l80.514"></a><span id="l80.514">  *</span>
<a href="#l80.515"></a><span id="l80.515">  * @param callback    Function that returns true when the waiting thould end.</span>
<a href="#l80.516"></a><span id="l80.516">  * @param message {string or function}  A message to throw if the callback didn't</span>
<a href="#l80.517"></a><span id="l80.517">  *                                      succeed until the timeout. Use a function</span>
<a href="#l80.518"></a><span id="l80.518">  *                                      if the message is to show some object state</span>
<a href="#l80.519"></a><span id="l80.519" class="difflineat">@@ -424,20 +380,19 @@ function waitFor(callback, message, time</span>
<a href="#l80.520"></a><span id="l80.520">   var self = {counter: 0, result: callback.call(thisObject)};</span>
<a href="#l80.521"></a><span id="l80.521"> </span>
<a href="#l80.522"></a><span id="l80.522">   function wait() {</span>
<a href="#l80.523"></a><span id="l80.523">     self.counter += interval;</span>
<a href="#l80.524"></a><span id="l80.524">     self.result = callback.call(thisObject);</span>
<a href="#l80.525"></a><span id="l80.525">   }</span>
<a href="#l80.526"></a><span id="l80.526"> </span>
<a href="#l80.527"></a><span id="l80.527">   var timeoutInterval = hwindow.setInterval(wait, interval);</span>
<a href="#l80.528"></a><span id="l80.528" class="difflineminus">-  var thread = Cc[&quot;@mozilla.org/thread-manager;1&quot;].</span>
<a href="#l80.529"></a><span id="l80.529" class="difflineminus">-               getService().currentThread;</span>
<a href="#l80.530"></a><span id="l80.530" class="difflineplus">+  var thread = Services.tm.currentThread;</span>
<a href="#l80.531"></a><span id="l80.531"> </span>
<a href="#l80.532"></a><span id="l80.532" class="difflineminus">-  while((self.result != true) &amp;&amp; (self.counter &lt; timeout))  {</span>
<a href="#l80.533"></a><span id="l80.533" class="difflineplus">+  while (!self.result &amp;&amp; (self.counter &lt; timeout)) {</span>
<a href="#l80.534"></a><span id="l80.534">     thread.processNextEvent(true);</span>
<a href="#l80.535"></a><span id="l80.535">   }</span>
<a href="#l80.536"></a><span id="l80.536"> </span>
<a href="#l80.537"></a><span id="l80.537">   hwindow.clearInterval(timeoutInterval);</span>
<a href="#l80.538"></a><span id="l80.538"> </span>
<a href="#l80.539"></a><span id="l80.539">   if (self.counter &gt;= timeout) {</span>
<a href="#l80.540"></a><span id="l80.540">     let messageText;</span>
<a href="#l80.541"></a><span id="l80.541">     if (message) {</span>
<a href="#l80.542"></a><span id="l80.542" class="difflineat">@@ -449,69 +404,8 @@ function waitFor(callback, message, time</span>
<a href="#l80.543"></a><span id="l80.543">       messageText = &quot;waitFor: Timeout exceeded for '&quot; + callback + &quot;'&quot;;</span>
<a href="#l80.544"></a><span id="l80.544">     }</span>
<a href="#l80.545"></a><span id="l80.545"> </span>
<a href="#l80.546"></a><span id="l80.546">     throw new TimeoutError(messageText);</span>
<a href="#l80.547"></a><span id="l80.547">   }</span>
<a href="#l80.548"></a><span id="l80.548"> </span>
<a href="#l80.549"></a><span id="l80.549">   return true;</span>
<a href="#l80.550"></a><span id="l80.550"> }</span>
<a href="#l80.551"></a><span id="l80.551" class="difflineminus">-</span>
<a href="#l80.552"></a><span id="l80.552" class="difflineminus">-</span>
<a href="#l80.553"></a><span id="l80.553" class="difflineminus">- //</span>
<a href="#l80.554"></a><span id="l80.554" class="difflineminus">- // //Function to start the running of jsTests</span>
<a href="#l80.555"></a><span id="l80.555" class="difflineminus">- // var jsTests = function (paramObj) {</span>
<a href="#l80.556"></a><span id="l80.556" class="difflineminus">- //     //Setup needed variables</span>
<a href="#l80.557"></a><span id="l80.557" class="difflineminus">- //     mozmill.jsTest.actions.loadActions();</span>
<a href="#l80.558"></a><span id="l80.558" class="difflineminus">- //     var wm = mozmill.jsTest.actions;</span>
<a href="#l80.559"></a><span id="l80.559" class="difflineminus">- //     var testFiles = paramObj.files;</span>
<a href="#l80.560"></a><span id="l80.560" class="difflineminus">- //     if (!testFiles.length) {</span>
<a href="#l80.561"></a><span id="l80.561" class="difflineminus">- //       throw new Error('No JavaScript tests to run.');</span>
<a href="#l80.562"></a><span id="l80.562" class="difflineminus">- //     }</span>
<a href="#l80.563"></a><span id="l80.563" class="difflineminus">- //     var _j = mozmill.jsTest;</span>
<a href="#l80.564"></a><span id="l80.564" class="difflineminus">- //     //mozmill.MozMillController.stopLoop();</span>
<a href="#l80.565"></a><span id="l80.565" class="difflineminus">- //</span>
<a href="#l80.566"></a><span id="l80.566" class="difflineminus">- //     //Timing the suite</span>
<a href="#l80.567"></a><span id="l80.567" class="difflineminus">- //     var jsSuiteSummary = new TimeObj();</span>
<a href="#l80.568"></a><span id="l80.568" class="difflineminus">- //     jsSuiteSummary.setName('jsSummary');</span>
<a href="#l80.569"></a><span id="l80.569" class="difflineminus">- //     jsSuiteSummary.startTime();</span>
<a href="#l80.570"></a><span id="l80.570" class="difflineminus">- //     _j.jsSuiteSummary = jsSuiteSummary;</span>
<a href="#l80.571"></a><span id="l80.571" class="difflineminus">- //</span>
<a href="#l80.572"></a><span id="l80.572" class="difflineminus">- //     _j.run(paramObj);</span>
<a href="#l80.573"></a><span id="l80.573" class="difflineminus">- // };</span>
<a href="#l80.574"></a><span id="l80.574" class="difflineminus">- //</span>
<a href="#l80.575"></a><span id="l80.575" class="difflineminus">- // //Commands function to hande the test results of the js tests</span>
<a href="#l80.576"></a><span id="l80.576" class="difflineminus">- // var jsTestResults = function () {</span>
<a href="#l80.577"></a><span id="l80.577" class="difflineminus">- //   var _j = mozmill.jsTest;</span>
<a href="#l80.578"></a><span id="l80.578" class="difflineminus">- //   var jsSuiteSummary = _j.jsSuiteSummary;</span>
<a href="#l80.579"></a><span id="l80.579" class="difflineminus">- //   var s = '';</span>
<a href="#l80.580"></a><span id="l80.580" class="difflineminus">- //   s += 'Number of tests run: ' + _j.testCount + '\n';</span>
<a href="#l80.581"></a><span id="l80.581" class="difflineminus">- //   s += '\nNumber of tests failures: ' + _j.testFailureCount;</span>
<a href="#l80.582"></a><span id="l80.582" class="difflineminus">- //   if (_j.testFailureCount &gt; 0) {</span>
<a href="#l80.583"></a><span id="l80.583" class="difflineminus">- //     s += 'Test failures:&lt;br/&gt;';</span>
<a href="#l80.584"></a><span id="l80.584" class="difflineminus">- //     var fails = _j.testFailures;</span>
<a href="#l80.585"></a><span id="l80.585" class="difflineminus">- //     for (var i = 0; i &lt; fails.length; i++) {</span>
<a href="#l80.586"></a><span id="l80.586" class="difflineminus">- //       var fail = fails[i];</span>
<a href="#l80.587"></a><span id="l80.587" class="difflineminus">- //       var msg = fail.message;</span>
<a href="#l80.588"></a><span id="l80.588" class="difflineminus">- //       // Escape angle brackets for display in HTML</span>
<a href="#l80.589"></a><span id="l80.589" class="difflineminus">- //       msg = msg.replace(/&lt;/g, '&amp;lt;');</span>
<a href="#l80.590"></a><span id="l80.590" class="difflineminus">- //       msg = msg.replace(/&gt;/g, '&amp;gt;');</span>
<a href="#l80.591"></a><span id="l80.591" class="difflineminus">- //       s += msg + '&lt;br/&gt;';</span>
<a href="#l80.592"></a><span id="l80.592" class="difflineminus">- //     }</span>
<a href="#l80.593"></a><span id="l80.593" class="difflineminus">- //   };</span>
<a href="#l80.594"></a><span id="l80.594" class="difflineminus">- //</span>
<a href="#l80.595"></a><span id="l80.595" class="difflineminus">- //   jsSuiteSummary.endTime();</span>
<a href="#l80.596"></a><span id="l80.596" class="difflineminus">- //   var result = !(_j.testFailureCount &gt; 0);</span>
<a href="#l80.597"></a><span id="l80.597" class="difflineminus">- //</span>
<a href="#l80.598"></a><span id="l80.598" class="difflineminus">- //   if (result){</span>
<a href="#l80.599"></a><span id="l80.599" class="difflineminus">- //      mozmill.results.writeResult(s, 'lightgreen');</span>
<a href="#l80.600"></a><span id="l80.600" class="difflineminus">- //    }</span>
<a href="#l80.601"></a><span id="l80.601" class="difflineminus">- //    else{</span>
<a href="#l80.602"></a><span id="l80.602" class="difflineminus">- //      mozmill.results.writeResult(s, 'lightred');</span>
<a href="#l80.603"></a><span id="l80.603" class="difflineminus">- //    }</span>
<a href="#l80.604"></a><span id="l80.604" class="difflineminus">- //   //mozmill.results.writeResult(s);</span>
<a href="#l80.605"></a><span id="l80.605" class="difflineminus">- //   //We want the summary to have a concept of success/failure</span>
<a href="#l80.606"></a><span id="l80.606" class="difflineminus">- //   var result = !(_j.testFailureCount &gt; 0);</span>
<a href="#l80.607"></a><span id="l80.607" class="difflineminus">- //   var method = 'JS Test Suite Completion';</span>
<a href="#l80.608"></a><span id="l80.608" class="difflineminus">- //   //mozmill.jsTest.sendJSReport(method, result, null, jsSuiteSummary);</span>
<a href="#l80.609"></a><span id="l80.609" class="difflineminus">- //   // Fire the polling loop back up</span>
<a href="#l80.610"></a><span id="l80.610" class="difflineminus">- //   //mozmill.MozMillController.continueLoop();</span>
<a href="#l80.611"></a><span id="l80.611" class="difflineminus">- // };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l81.1"></a><span id="l81.1" class="difflineminus">--- a/mail/test/resources/mozmill/mozmill/extension/content/overlay.js</span>
<a href="#l81.2"></a><span id="l81.2" class="difflineplus">+++ b/mail/test/resources/mozmill/mozmill/extension/content/overlay.js</span>
<a href="#l81.3"></a><span id="l81.3" class="difflineat">@@ -31,17 +31,17 @@</span>
<a href="#l81.4"></a><span id="l81.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l81.5"></a><span id="l81.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l81.6"></a><span id="l81.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l81.7"></a><span id="l81.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l81.8"></a><span id="l81.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l81.9"></a><span id="l81.9">  *</span>
<a href="#l81.10"></a><span id="l81.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l81.11"></a><span id="l81.11"> </span>
<a href="#l81.12"></a><span id="l81.12" class="difflineminus">-var mozmillInit = ChromeUtils.import(&quot;chrome://mozmill/content/modules/init.js&quot;);</span>
<a href="#l81.13"></a><span id="l81.13" class="difflineplus">+var mozmillInit = ChromeUtils.import(&quot;chrome://mozmill/content/modules/init.jsm&quot;);</span>
<a href="#l81.14"></a><span id="l81.14"> </span>
<a href="#l81.15"></a><span id="l81.15"> var MozMill = {</span>
<a href="#l81.16"></a><span id="l81.16">   onLoad() {</span>
<a href="#l81.17"></a><span id="l81.17">     this.initialized = true;</span>
<a href="#l81.18"></a><span id="l81.18">   },</span>
<a href="#l81.19"></a><span id="l81.19"> };</span>
<a href="#l81.20"></a><span id="l81.20"> </span>
<a href="#l81.21"></a><span id="l81.21"> window.addEventListener(&quot;load&quot;, function(e) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l82.1"></a><span id="l82.1">rename from mail/test/resources/mozmill/mozmill/extension/content/stdlib/EventUtils.js</span>
<a href="#l82.2"></a><span id="l82.2">rename to mail/test/resources/mozmill/mozmill/extension/content/stdlib/EventUtils.jsm</span>
<a href="#l82.3"></a><span id="l82.3" class="difflineminus">--- a/mail/test/resources/mozmill/mozmill/extension/content/stdlib/EventUtils.js</span>
<a href="#l82.4"></a><span id="l82.4" class="difflineplus">+++ b/mail/test/resources/mozmill/mozmill/extension/content/stdlib/EventUtils.jsm</span>
<a href="#l82.5"></a><span id="l82.5" class="difflineat">@@ -1,205 +1,36 @@</span>
<a href="#l82.6"></a><span id="l82.6"> // Export all available functions for Mozmill</span>
<a href="#l82.7"></a><span id="l82.7" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;sendMouseEvent&quot;, &quot;sendChar&quot;, &quot;sendString&quot;, &quot;sendKey&quot;,</span>
<a href="#l82.8"></a><span id="l82.8" class="difflineminus">-                        &quot;synthesizeMouse&quot;, &quot;synthesizeMouseScroll&quot;, &quot;synthesizeKey&quot;,</span>
<a href="#l82.9"></a><span id="l82.9" class="difflineminus">-                        &quot;synthesizeMouseExpectEvent&quot;, &quot;synthesizeKeyExpectEvent&quot;,</span>
<a href="#l82.10"></a><span id="l82.10" class="difflineminus">-                        &quot;synthesizeDragStart&quot;, &quot;synthesizeDrop&quot;, &quot;synthesizeText&quot;,</span>
<a href="#l82.11"></a><span id="l82.11" class="difflineminus">-                        &quot;disableNonTestMouseEvents&quot;, &quot;synthesizeComposition&quot;,</span>
<a href="#l82.12"></a><span id="l82.12" class="difflineminus">-                        &quot;synthesizeQuerySelectedText&quot;, &quot;synthesizeQueryTextContent&quot;,</span>
<a href="#l82.13"></a><span id="l82.13" class="difflineminus">-                        &quot;synthesizeQueryCaretRect&quot;, &quot;synthesizeQueryTextRect&quot;,</span>
<a href="#l82.14"></a><span id="l82.14" class="difflineminus">-                        &quot;synthesizeQueryEditorRect&quot;, &quot;synthesizeCharAtPoint&quot;,</span>
<a href="#l82.15"></a><span id="l82.15" class="difflineminus">-                        &quot;synthesizeSelectionSet&quot;];</span>
<a href="#l82.16"></a><span id="l82.16" class="difflineminus">-</span>
<a href="#l82.17"></a><span id="l82.17" class="difflineminus">-/**</span>
<a href="#l82.18"></a><span id="l82.18" class="difflineminus">- * EventUtils provides some utility methods for creating and sending DOM events.</span>
<a href="#l82.19"></a><span id="l82.19" class="difflineminus">- * Current methods:</span>
<a href="#l82.20"></a><span id="l82.20" class="difflineminus">- *  sendMouseEvent</span>
<a href="#l82.21"></a><span id="l82.21" class="difflineminus">- *  sendChar</span>
<a href="#l82.22"></a><span id="l82.22" class="difflineminus">- *  sendString</span>
<a href="#l82.23"></a><span id="l82.23" class="difflineminus">- *  sendKey</span>
<a href="#l82.24"></a><span id="l82.24" class="difflineminus">- */</span>
<a href="#l82.25"></a><span id="l82.25" class="difflineminus">-</span>
<a href="#l82.26"></a><span id="l82.26" class="difflineminus">-/**</span>
<a href="#l82.27"></a><span id="l82.27" class="difflineminus">- * Send a mouse event to the node aTarget (aTarget can be an id, or an</span>
<a href="#l82.28"></a><span id="l82.28" class="difflineminus">- * actual node) . The &quot;event&quot; passed in to aEvent is just a JavaScript</span>
<a href="#l82.29"></a><span id="l82.29" class="difflineminus">- * object with the properties set that the real mouse event object should</span>
<a href="#l82.30"></a><span id="l82.30" class="difflineminus">- * have. This includes the type of the mouse event.</span>
<a href="#l82.31"></a><span id="l82.31" class="difflineminus">- * E.g. to send an click event to the node with id 'node' you might do this:</span>
<a href="#l82.32"></a><span id="l82.32" class="difflineminus">- *</span>
<a href="#l82.33"></a><span id="l82.33" class="difflineminus">- * sendMouseEvent({type:'click'}, 'node');</span>
<a href="#l82.34"></a><span id="l82.34" class="difflineminus">- */</span>
<a href="#l82.35"></a><span id="l82.35" class="difflineminus">-function sendMouseEvent(aEvent, aTarget, aWindow) {</span>
<a href="#l82.36"></a><span id="l82.36" class="difflineminus">-  if (['click', 'mousedown', 'mouseup', 'mouseover', 'mouseout'].indexOf(aEvent.type) == -1) {</span>
<a href="#l82.37"></a><span id="l82.37" class="difflineminus">-    throw new Error(&quot;sendMouseEvent doesn't know about event type '&quot; + aEvent.type + &quot;'&quot;);</span>
<a href="#l82.38"></a><span id="l82.38" class="difflineminus">-  }</span>
<a href="#l82.39"></a><span id="l82.39" class="difflineminus">-</span>
<a href="#l82.40"></a><span id="l82.40" class="difflineminus">-  if (!aWindow) {</span>
<a href="#l82.41"></a><span id="l82.41" class="difflineminus">-    aWindow = window;</span>
<a href="#l82.42"></a><span id="l82.42" class="difflineminus">-  }</span>
<a href="#l82.43"></a><span id="l82.43" class="difflineminus">-</span>
<a href="#l82.44"></a><span id="l82.44" class="difflineminus">-  if (!(aTarget instanceof Element)) {</span>
<a href="#l82.45"></a><span id="l82.45" class="difflineminus">-    aTarget = aWindow.document.getElementById(aTarget);</span>
<a href="#l82.46"></a><span id="l82.46" class="difflineminus">-  }</span>
<a href="#l82.47"></a><span id="l82.47" class="difflineminus">-</span>
<a href="#l82.48"></a><span id="l82.48" class="difflineminus">-  var event = aWindow.document.createEvent('MouseEvent');</span>
<a href="#l82.49"></a><span id="l82.49" class="difflineminus">-</span>
<a href="#l82.50"></a><span id="l82.50" class="difflineminus">-  var typeArg          = aEvent.type;</span>
<a href="#l82.51"></a><span id="l82.51" class="difflineminus">-  var canBubbleArg     = true;</span>
<a href="#l82.52"></a><span id="l82.52" class="difflineminus">-  var cancelableArg    = true;</span>
<a href="#l82.53"></a><span id="l82.53" class="difflineminus">-  var viewArg          = aWindow;</span>
<a href="#l82.54"></a><span id="l82.54" class="difflineminus">-  var detailArg        = aEvent.detail        || (aEvent.type == 'click'     ||</span>
<a href="#l82.55"></a><span id="l82.55" class="difflineminus">-                                                  aEvent.type == 'mousedown' ||</span>
<a href="#l82.56"></a><span id="l82.56" class="difflineminus">-                                                  aEvent.type == 'mouseup' ? 1 : 0);</span>
<a href="#l82.57"></a><span id="l82.57" class="difflineminus">-  var screenXArg       = aEvent.screenX       || 0;</span>
<a href="#l82.58"></a><span id="l82.58" class="difflineminus">-  var screenYArg       = aEvent.screenY       || 0;</span>
<a href="#l82.59"></a><span id="l82.59" class="difflineminus">-  var clientXArg       = aEvent.clientX       || 0;</span>
<a href="#l82.60"></a><span id="l82.60" class="difflineminus">-  var clientYArg       = aEvent.clientY       || 0;</span>
<a href="#l82.61"></a><span id="l82.61" class="difflineminus">-  var ctrlKeyArg       = aEvent.ctrlKey       || false;</span>
<a href="#l82.62"></a><span id="l82.62" class="difflineminus">-  var altKeyArg        = aEvent.altKey        || false;</span>
<a href="#l82.63"></a><span id="l82.63" class="difflineminus">-  var shiftKeyArg      = aEvent.shiftKey      || false;</span>
<a href="#l82.64"></a><span id="l82.64" class="difflineminus">-  var metaKeyArg       = aEvent.metaKey       || false;</span>
<a href="#l82.65"></a><span id="l82.65" class="difflineminus">-  var buttonArg        = aEvent.button        || 0;</span>
<a href="#l82.66"></a><span id="l82.66" class="difflineminus">-  var relatedTargetArg = aEvent.relatedTarget || null;</span>
<a href="#l82.67"></a><span id="l82.67" class="difflineminus">-</span>
<a href="#l82.68"></a><span id="l82.68" class="difflineminus">-  event.initMouseEvent(typeArg, canBubbleArg, cancelableArg, viewArg, detailArg,</span>
<a href="#l82.69"></a><span id="l82.69" class="difflineminus">-                       screenXArg, screenYArg, clientXArg, clientYArg,</span>
<a href="#l82.70"></a><span id="l82.70" class="difflineminus">-                       ctrlKeyArg, altKeyArg, shiftKeyArg, metaKeyArg,</span>
<a href="#l82.71"></a><span id="l82.71" class="difflineminus">-                       buttonArg, relatedTargetArg);</span>
<a href="#l82.72"></a><span id="l82.72" class="difflineminus">-</span>
<a href="#l82.73"></a><span id="l82.73" class="difflineminus">-  aTarget.dispatchEvent(event);</span>
<a href="#l82.74"></a><span id="l82.74" class="difflineminus">-}</span>
<a href="#l82.75"></a><span id="l82.75" class="difflineplus">+var EXPORTED_SYMBOLS = [</span>
<a href="#l82.76"></a><span id="l82.76" class="difflineplus">+  &quot;synthesizeMouse&quot;,</span>
<a href="#l82.77"></a><span id="l82.77" class="difflineplus">+  &quot;synthesizeMouseScroll&quot;,</span>
<a href="#l82.78"></a><span id="l82.78" class="difflineplus">+  &quot;synthesizeKey&quot;,</span>
<a href="#l82.79"></a><span id="l82.79" class="difflineplus">+  &quot;synthesizeMouseExpectEvent&quot;,</span>
<a href="#l82.80"></a><span id="l82.80" class="difflineplus">+];</span>
<a href="#l82.81"></a><span id="l82.81"> </span>
<a href="#l82.82"></a><span id="l82.82" class="difflineminus">-/**</span>
<a href="#l82.83"></a><span id="l82.83" class="difflineminus">- * Send the char aChar to the node with id aTarget.  If aTarget is not</span>
<a href="#l82.84"></a><span id="l82.84" class="difflineminus">- * provided, use &quot;target&quot;.  This method handles casing of chars (sends the</span>
<a href="#l82.85"></a><span id="l82.85" class="difflineminus">- * right charcode, and sends a shift key for uppercase chars).  No other</span>
<a href="#l82.86"></a><span id="l82.86" class="difflineminus">- * modifiers are handled at this point.</span>
<a href="#l82.87"></a><span id="l82.87" class="difflineminus">- *</span>
<a href="#l82.88"></a><span id="l82.88" class="difflineminus">- * For now this method only works for English letters (lower and upper case)</span>
<a href="#l82.89"></a><span id="l82.89" class="difflineminus">- * and the digits 0-9.</span>
<a href="#l82.90"></a><span id="l82.90" class="difflineminus">- *</span>
<a href="#l82.91"></a><span id="l82.91" class="difflineminus">- * Returns true if the keypress event was accepted (no calls to preventDefault</span>
<a href="#l82.92"></a><span id="l82.92" class="difflineminus">- * or anything like that), false otherwise.</span>
<a href="#l82.93"></a><span id="l82.93" class="difflineminus">- */</span>
<a href="#l82.94"></a><span id="l82.94" class="difflineminus">-function sendChar(aChar, aTarget) {</span>
<a href="#l82.95"></a><span id="l82.95" class="difflineminus">-  // DOM event charcodes match ASCII (JS charcodes) for a-zA-Z0-9.</span>
<a href="#l82.96"></a><span id="l82.96" class="difflineminus">-  var hasShift = (aChar == aChar.toUpperCase());</span>
<a href="#l82.97"></a><span id="l82.97" class="difflineminus">-  var charCode = aChar.charCodeAt(0);</span>
<a href="#l82.98"></a><span id="l82.98" class="difflineminus">-  var keyCode = charCode;</span>
<a href="#l82.99"></a><span id="l82.99" class="difflineminus">-  if (!hasShift) {</span>
<a href="#l82.100"></a><span id="l82.100" class="difflineminus">-    // For lowercase letters, the keyCode is actually 32 less than the charCode</span>
<a href="#l82.101"></a><span id="l82.101" class="difflineminus">-    keyCode -= 0x20;</span>
<a href="#l82.102"></a><span id="l82.102" class="difflineminus">-  }</span>
<a href="#l82.103"></a><span id="l82.103" class="difflineminus">-</span>
<a href="#l82.104"></a><span id="l82.104" class="difflineminus">-  return __doEventDispatch(aTarget, charCode, keyCode, hasShift);</span>
<a href="#l82.105"></a><span id="l82.105" class="difflineminus">-}</span>
<a href="#l82.106"></a><span id="l82.106" class="difflineminus">-</span>
<a href="#l82.107"></a><span id="l82.107" class="difflineminus">-/**</span>
<a href="#l82.108"></a><span id="l82.108" class="difflineminus">- * Send the string aStr to the node with id aTarget.  If aTarget is not</span>
<a href="#l82.109"></a><span id="l82.109" class="difflineminus">- * provided, use &quot;target&quot;.</span>
<a href="#l82.110"></a><span id="l82.110" class="difflineminus">- *</span>
<a href="#l82.111"></a><span id="l82.111" class="difflineminus">- * For now this method only works for English letters (lower and upper case)</span>
<a href="#l82.112"></a><span id="l82.112" class="difflineminus">- * and the digits 0-9.</span>
<a href="#l82.113"></a><span id="l82.113" class="difflineminus">- */</span>
<a href="#l82.114"></a><span id="l82.114" class="difflineminus">-function sendString(aStr, aTarget) {</span>
<a href="#l82.115"></a><span id="l82.115" class="difflineminus">-  for (var i = 0; i &lt; aStr.length; ++i) {</span>
<a href="#l82.116"></a><span id="l82.116" class="difflineminus">-    sendChar(aStr.charAt(i), aTarget);</span>
<a href="#l82.117"></a><span id="l82.117" class="difflineminus">-  }</span>
<a href="#l82.118"></a><span id="l82.118" class="difflineminus">-}</span>
<a href="#l82.119"></a><span id="l82.119" class="difflineminus">-</span>
<a href="#l82.120"></a><span id="l82.120" class="difflineminus">-/**</span>
<a href="#l82.121"></a><span id="l82.121" class="difflineminus">- * Send the non-character key aKey to the node with id aTarget. If aTarget is</span>
<a href="#l82.122"></a><span id="l82.122" class="difflineminus">- * not provided, use &quot;target&quot;.</span>
<a href="#l82.123"></a><span id="l82.123" class="difflineminus">- * The name of the key should be the part that comes after &quot;DOM_VK_&quot; in the</span>
<a href="#l82.124"></a><span id="l82.124" class="difflineminus">- *   KeyEvent constant name for this key.</span>
<a href="#l82.125"></a><span id="l82.125" class="difflineminus">- * No modifiers are handled at this point.</span>
<a href="#l82.126"></a><span id="l82.126" class="difflineminus">- *</span>
<a href="#l82.127"></a><span id="l82.127" class="difflineminus">- * Returns true if the keypress event was accepted (no calls to preventDefault</span>
<a href="#l82.128"></a><span id="l82.128" class="difflineminus">- * or anything like that), false otherwise.</span>
<a href="#l82.129"></a><span id="l82.129" class="difflineminus">- */</span>
<a href="#l82.130"></a><span id="l82.130" class="difflineminus">-function sendKey(aKey, aTarget, aWindow) {</span>
<a href="#l82.131"></a><span id="l82.131" class="difflineminus">-  if (!aWindow)</span>
<a href="#l82.132"></a><span id="l82.132" class="difflineminus">-    aWindow = window;</span>
<a href="#l82.133"></a><span id="l82.133" class="difflineminus">-</span>
<a href="#l82.134"></a><span id="l82.134" class="difflineminus">-  var keyName = &quot;DOM_VK_&quot; + aKey.toUpperCase();</span>
<a href="#l82.135"></a><span id="l82.135" class="difflineminus">-</span>
<a href="#l82.136"></a><span id="l82.136" class="difflineminus">-  if (!_getKeyboardEvent(aWindow)[keyName]) {</span>
<a href="#l82.137"></a><span id="l82.137" class="difflineminus">-    throw &quot;Unknown key: &quot; + keyName;</span>
<a href="#l82.138"></a><span id="l82.138" class="difflineminus">-  }</span>
<a href="#l82.139"></a><span id="l82.139" class="difflineminus">-</span>
<a href="#l82.140"></a><span id="l82.140" class="difflineminus">-  return __doEventDispatch(aTarget, 0, _getKeyboardEvent(aWindow)[keyName], false);</span>
<a href="#l82.141"></a><span id="l82.141" class="difflineminus">-}</span>
<a href="#l82.142"></a><span id="l82.142" class="difflineminus">-</span>
<a href="#l82.143"></a><span id="l82.143" class="difflineminus">-/**</span>
<a href="#l82.144"></a><span id="l82.144" class="difflineminus">- * Actually perform event dispatch given a charCode, keyCode, and boolean for</span>
<a href="#l82.145"></a><span id="l82.145" class="difflineminus">- * whether &quot;shift&quot; was pressed.  Send the event to the node with id aTarget.  If</span>
<a href="#l82.146"></a><span id="l82.146" class="difflineminus">- * aTarget is not provided, use &quot;target&quot;.</span>
<a href="#l82.147"></a><span id="l82.147" class="difflineminus">- *</span>
<a href="#l82.148"></a><span id="l82.148" class="difflineminus">- * Returns true if the keypress event was accepted (no calls to preventDefault</span>
<a href="#l82.149"></a><span id="l82.149" class="difflineminus">- * or anything like that), false otherwise.</span>
<a href="#l82.150"></a><span id="l82.150" class="difflineminus">- */</span>
<a href="#l82.151"></a><span id="l82.151" class="difflineminus">-function __doEventDispatch(aTarget, aCharCode, aKeyCode, aHasShift) {</span>
<a href="#l82.152"></a><span id="l82.152" class="difflineminus">-  if (aTarget === undefined) {</span>
<a href="#l82.153"></a><span id="l82.153" class="difflineminus">-    aTarget = &quot;target&quot;;</span>
<a href="#l82.154"></a><span id="l82.154" class="difflineminus">-  }</span>
<a href="#l82.155"></a><span id="l82.155" class="difflineminus">-</span>
<a href="#l82.156"></a><span id="l82.156" class="difflineminus">-  var event = document.createEvent(&quot;KeyEvents&quot;);</span>
<a href="#l82.157"></a><span id="l82.157" class="difflineminus">-  event.initKeyEvent(&quot;keydown&quot;, true, true, document.defaultView,</span>
<a href="#l82.158"></a><span id="l82.158" class="difflineminus">-                     false, false, aHasShift, false,</span>
<a href="#l82.159"></a><span id="l82.159" class="difflineminus">-                     aKeyCode, 0);</span>
<a href="#l82.160"></a><span id="l82.160" class="difflineminus">-  var accepted = $(aTarget).dispatchEvent(event);</span>
<a href="#l82.161"></a><span id="l82.161" class="difflineminus">-</span>
<a href="#l82.162"></a><span id="l82.162" class="difflineminus">-  // Preventing the default keydown action also prevents the default</span>
<a href="#l82.163"></a><span id="l82.163" class="difflineminus">-  // keypress action.</span>
<a href="#l82.164"></a><span id="l82.164" class="difflineminus">-  event = document.createEvent(&quot;KeyEvents&quot;);</span>
<a href="#l82.165"></a><span id="l82.165" class="difflineminus">-  if (aCharCode) {</span>
<a href="#l82.166"></a><span id="l82.166" class="difflineminus">-    event.initKeyEvent(&quot;keypress&quot;, true, true, document.defaultView,</span>
<a href="#l82.167"></a><span id="l82.167" class="difflineminus">-                       false, false, aHasShift, false,</span>
<a href="#l82.168"></a><span id="l82.168" class="difflineminus">-                       0, aCharCode);</span>
<a href="#l82.169"></a><span id="l82.169" class="difflineminus">-  } else {</span>
<a href="#l82.170"></a><span id="l82.170" class="difflineminus">-    event.initKeyEvent(&quot;keypress&quot;, true, true, document.defaultView,</span>
<a href="#l82.171"></a><span id="l82.171" class="difflineminus">-                       false, false, aHasShift, false,</span>
<a href="#l82.172"></a><span id="l82.172" class="difflineminus">-                       aKeyCode, 0);</span>
<a href="#l82.173"></a><span id="l82.173" class="difflineminus">-  }</span>
<a href="#l82.174"></a><span id="l82.174" class="difflineminus">-  if (!accepted) {</span>
<a href="#l82.175"></a><span id="l82.175" class="difflineminus">-    event.preventDefault();</span>
<a href="#l82.176"></a><span id="l82.176" class="difflineminus">-  }</span>
<a href="#l82.177"></a><span id="l82.177" class="difflineminus">-  accepted = $(aTarget).dispatchEvent(event);</span>
<a href="#l82.178"></a><span id="l82.178" class="difflineminus">-</span>
<a href="#l82.179"></a><span id="l82.179" class="difflineminus">-  // Always send keyup</span>
<a href="#l82.180"></a><span id="l82.180" class="difflineminus">-  var event = document.createEvent(&quot;KeyEvents&quot;);</span>
<a href="#l82.181"></a><span id="l82.181" class="difflineminus">-  event.initKeyEvent(&quot;keyup&quot;, true, true, document.defaultView,</span>
<a href="#l82.182"></a><span id="l82.182" class="difflineminus">-                     false, false, aHasShift, false,</span>
<a href="#l82.183"></a><span id="l82.183" class="difflineminus">-                     aKeyCode, 0);</span>
<a href="#l82.184"></a><span id="l82.184" class="difflineminus">-  $(aTarget).dispatchEvent(event);</span>
<a href="#l82.185"></a><span id="l82.185" class="difflineminus">-  return accepted;</span>
<a href="#l82.186"></a><span id="l82.186" class="difflineminus">-}</span>
<a href="#l82.187"></a><span id="l82.187" class="difflineplus">+const {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l82.188"></a><span id="l82.188"> </span>
<a href="#l82.189"></a><span id="l82.189"> /**</span>
<a href="#l82.190"></a><span id="l82.190">  * Parse the key modifier flags from aEvent. Used to share code between</span>
<a href="#l82.191"></a><span id="l82.191">  * synthesizeMouse and synthesizeKey.</span>
<a href="#l82.192"></a><span id="l82.192">  */</span>
<a href="#l82.193"></a><span id="l82.193" class="difflineminus">-function _parseModifiers(aEvent)</span>
<a href="#l82.194"></a><span id="l82.194" class="difflineminus">-{</span>
<a href="#l82.195"></a><span id="l82.195" class="difflineminus">-  var hwindow = Cc[&quot;@mozilla.org/appshell/appShellService;1&quot;]</span>
<a href="#l82.196"></a><span id="l82.196" class="difflineminus">-                  .getService(Ci.nsIAppShellService)</span>
<a href="#l82.197"></a><span id="l82.197" class="difflineminus">-                  .hiddenDOMWindow;</span>
<a href="#l82.198"></a><span id="l82.198" class="difflineplus">+function _parseModifiers(aEvent) {</span>
<a href="#l82.199"></a><span id="l82.199" class="difflineplus">+  var hwindow = Services.appShell.hiddenDOMWindow;</span>
<a href="#l82.200"></a><span id="l82.200"> </span>
<a href="#l82.201"></a><span id="l82.201">   var mval = 0;</span>
<a href="#l82.202"></a><span id="l82.202">   if (aEvent.shiftKey)</span>
<a href="#l82.203"></a><span id="l82.203">     mval |= Ci.nsIDOMWindowUtils.MODIFIER_SHIFT;</span>
<a href="#l82.204"></a><span id="l82.204">   if (aEvent.ctrlKey)</span>
<a href="#l82.205"></a><span id="l82.205">     mval |= Ci.nsIDOMWindowUtils.MODIFIER_CONTROL;</span>
<a href="#l82.206"></a><span id="l82.206">   if (aEvent.altKey)</span>
<a href="#l82.207"></a><span id="l82.207">     mval |= Ci.nsIDOMWindowUtils.MODIFIER_ALT;</span>
<a href="#l82.208"></a><span id="l82.208">   if (aEvent.metaKey)</span>
<a href="#l82.209"></a><span id="l82.209">     mval |= Ci.nsIDOMWindowUtils.MODIFIER_META;</span>
<a href="#l82.210"></a><span id="l82.210">   if (aEvent.accelKey)</span>
<a href="#l82.211"></a><span id="l82.211" class="difflineminus">-    mval |= (hwindow.navigator.platform.indexOf(&quot;Mac&quot;) &gt;= 0) ?</span>
<a href="#l82.212"></a><span id="l82.212" class="difflineplus">+    mval |= (hwindow.navigator.platform.includes(&quot;Mac&quot;)) ?</span>
<a href="#l82.213"></a><span id="l82.213">       Ci.nsIDOMWindowUtils.MODIFIER_META :</span>
<a href="#l82.214"></a><span id="l82.214">       Ci.nsIDOMWindowUtils.MODIFIER_CONTROL;</span>
<a href="#l82.215"></a><span id="l82.215"> </span>
<a href="#l82.216"></a><span id="l82.216">   return mval;</span>
<a href="#l82.217"></a><span id="l82.217"> }</span>
<a href="#l82.218"></a><span id="l82.218"> </span>
<a href="#l82.219"></a><span id="l82.219"> /**</span>
<a href="#l82.220"></a><span id="l82.220">  * Synthesize a mouse event on a target. The actual client point is determined</span>
<a href="#l82.221"></a><span id="l82.221" class="difflineat">@@ -209,36 +40,31 @@ function _parseModifiers(aEvent)</span>
<a href="#l82.222"></a><span id="l82.222">  * aEvent is an object which may contain the properties:</span>
<a href="#l82.223"></a><span id="l82.223">  *   shiftKey, ctrlKey, altKey, metaKey, accessKey, clickCount, button, type</span>
<a href="#l82.224"></a><span id="l82.224">  *</span>
<a href="#l82.225"></a><span id="l82.225">  * If the type is specified, an mouse event of that type is fired. Otherwise,</span>
<a href="#l82.226"></a><span id="l82.226">  * a mousedown followed by a mouse up is performed.</span>
<a href="#l82.227"></a><span id="l82.227">  *</span>
<a href="#l82.228"></a><span id="l82.228">  * aWindow is optional, and defaults to the current window object.</span>
<a href="#l82.229"></a><span id="l82.229">  */</span>
<a href="#l82.230"></a><span id="l82.230" class="difflineminus">-function synthesizeMouse(aTarget, aOffsetX, aOffsetY, aEvent, aWindow)</span>
<a href="#l82.231"></a><span id="l82.231" class="difflineminus">-{</span>
<a href="#l82.232"></a><span id="l82.232" class="difflineminus">-  if (!aWindow)</span>
<a href="#l82.233"></a><span id="l82.233" class="difflineminus">-    aWindow = window;</span>
<a href="#l82.234"></a><span id="l82.234" class="difflineminus">-</span>
<a href="#l82.235"></a><span id="l82.235" class="difflineplus">+function synthesizeMouse(aTarget, aOffsetX, aOffsetY, aEvent, aWindow) {</span>
<a href="#l82.236"></a><span id="l82.236">   var utils = aWindow.windowUtils;</span>
<a href="#l82.237"></a><span id="l82.237">   if (utils) {</span>
<a href="#l82.238"></a><span id="l82.238">     var button = aEvent.button || 0;</span>
<a href="#l82.239"></a><span id="l82.239">     var clickCount = aEvent.clickCount || 1;</span>
<a href="#l82.240"></a><span id="l82.240">     var modifiers = _parseModifiers(aEvent);</span>
<a href="#l82.241"></a><span id="l82.241"> </span>
<a href="#l82.242"></a><span id="l82.242">     var rect = aTarget.getBoundingClientRect();</span>
<a href="#l82.243"></a><span id="l82.243"> </span>
<a href="#l82.244"></a><span id="l82.244">     var left = rect.left + aOffsetX;</span>
<a href="#l82.245"></a><span id="l82.245">     var top = rect.top + aOffsetY;</span>
<a href="#l82.246"></a><span id="l82.246"> </span>
<a href="#l82.247"></a><span id="l82.247">     if ((&quot;type&quot; in aEvent) &amp;&amp; aEvent.type) {</span>
<a href="#l82.248"></a><span id="l82.248">       utils.sendMouseEvent(aEvent.type, left, top, button, clickCount, modifiers);</span>
<a href="#l82.249"></a><span id="l82.249" class="difflineminus">-    }</span>
<a href="#l82.250"></a><span id="l82.250" class="difflineminus">-    else {</span>
<a href="#l82.251"></a><span id="l82.251" class="difflineplus">+    } else {</span>
<a href="#l82.252"></a><span id="l82.252">       utils.sendMouseEvent(&quot;mousedown&quot;, left, top, button, clickCount, modifiers);</span>
<a href="#l82.253"></a><span id="l82.253">       utils.sendMouseEvent(&quot;mouseup&quot;, left, top, button, clickCount, modifiers);</span>
<a href="#l82.254"></a><span id="l82.254">     }</span>
<a href="#l82.255"></a><span id="l82.255">   }</span>
<a href="#l82.256"></a><span id="l82.256"> }</span>
<a href="#l82.257"></a><span id="l82.257"> </span>
<a href="#l82.258"></a><span id="l82.258"> /**</span>
<a href="#l82.259"></a><span id="l82.259">  * Synthesize a mouse scroll event on a target. The actual client point is determined</span>
<a href="#l82.260"></a><span id="l82.260" class="difflineat">@@ -256,21 +82,17 @@ function synthesizeMouse(aTarget, aOffse</span>
<a href="#l82.261"></a><span id="l82.261">  *</span>
<a href="#l82.262"></a><span id="l82.262">  * 'delta' is the amount to scroll by (can be positive or negative). It must</span>
<a href="#l82.263"></a><span id="l82.263">  * be specified.</span>
<a href="#l82.264"></a><span id="l82.264">  *</span>
<a href="#l82.265"></a><span id="l82.265">  * 'hasPixels' specifies whether kHasPixels should be set in the scrollFlags.</span>
<a href="#l82.266"></a><span id="l82.266">  *</span>
<a href="#l82.267"></a><span id="l82.267">  * aWindow is optional, and defaults to the current window object.</span>
<a href="#l82.268"></a><span id="l82.268">  */</span>
<a href="#l82.269"></a><span id="l82.269" class="difflineminus">-function synthesizeMouseScroll(aTarget, aOffsetX, aOffsetY, aEvent, aWindow)</span>
<a href="#l82.270"></a><span id="l82.270" class="difflineminus">-{</span>
<a href="#l82.271"></a><span id="l82.271" class="difflineminus">-  if (!aWindow)</span>
<a href="#l82.272"></a><span id="l82.272" class="difflineminus">-    aWindow = window;</span>
<a href="#l82.273"></a><span id="l82.273" class="difflineminus">-</span>
<a href="#l82.274"></a><span id="l82.274" class="difflineplus">+function synthesizeMouseScroll(aTarget, aOffsetX, aOffsetY, aEvent, aWindow) {</span>
<a href="#l82.275"></a><span id="l82.275">   var utils = aWindow.windowUtils;</span>
<a href="#l82.276"></a><span id="l82.276">   if (utils) {</span>
<a href="#l82.277"></a><span id="l82.277">     // See nsMouseScrollFlags in nsGUIEvent.h</span>
<a href="#l82.278"></a><span id="l82.278">     const kIsVertical = 0x02;</span>
<a href="#l82.279"></a><span id="l82.279">     const kIsHorizontal = 0x04;</span>
<a href="#l82.280"></a><span id="l82.280">     const kHasPixels = 0x08;</span>
<a href="#l82.281"></a><span id="l82.281"> </span>
<a href="#l82.282"></a><span id="l82.282">     var button = aEvent.button || 0;</span>
<a href="#l82.283"></a><span id="l82.283" class="difflineat">@@ -325,30 +147,29 @@ function synthesizeMouseScroll(aTarget, </span>
<a href="#l82.284"></a><span id="l82.284">  *        Note that if some of these values are false, they are ignored (i.e.,</span>
<a href="#l82.285"></a><span id="l82.285">  *        not inactivated with this function).</span>
<a href="#l82.286"></a><span id="l82.286">  *  - keyCode: Must be 0 - 255 (0xFF). If this is specified explicitly,</span>
<a href="#l82.287"></a><span id="l82.287">  *             .keyCode value is initialized with this value.</span>
<a href="#l82.288"></a><span id="l82.288">  *</span>
<a href="#l82.289"></a><span id="l82.289">  * aWindow is optional, and defaults to the current window object.</span>
<a href="#l82.290"></a><span id="l82.290">  * aCallback is optional, use the callback for receiving notifications of TIP.</span>
<a href="#l82.291"></a><span id="l82.291">  */</span>
<a href="#l82.292"></a><span id="l82.292" class="difflineminus">-function synthesizeKey(aKey, aEvent, aWindow, aCallback)</span>
<a href="#l82.293"></a><span id="l82.293" class="difflineminus">-{</span>
<a href="#l82.294"></a><span id="l82.294" class="difflineplus">+function synthesizeKey(aKey, aEvent, aWindow, aCallback) {</span>
<a href="#l82.295"></a><span id="l82.295">   var TIP = _getTIP(aWindow, aCallback);</span>
<a href="#l82.296"></a><span id="l82.296">   if (!TIP) {</span>
<a href="#l82.297"></a><span id="l82.297">     return;</span>
<a href="#l82.298"></a><span id="l82.298">   }</span>
<a href="#l82.299"></a><span id="l82.299">   var KeyboardEvent = _getKeyboardEvent(aWindow);</span>
<a href="#l82.300"></a><span id="l82.300">   var modifiers = _emulateToActivateModifiers(TIP, aEvent, aWindow);</span>
<a href="#l82.301"></a><span id="l82.301">   var keyEventDict = _createKeyboardEventDictionary(aKey, aEvent, aWindow);</span>
<a href="#l82.302"></a><span id="l82.302">   var keyEvent = new KeyboardEvent(&quot;&quot;, keyEventDict.dictionary);</span>
<a href="#l82.303"></a><span id="l82.303">   var dispatchKeydown =</span>
<a href="#l82.304"></a><span id="l82.304">     !(&quot;type&quot; in aEvent) || aEvent.type === &quot;keydown&quot; || !aEvent.type;</span>
<a href="#l82.305"></a><span id="l82.305">   var dispatchKeyup =</span>
<a href="#l82.306"></a><span id="l82.306" class="difflineminus">-    !(&quot;type&quot; in aEvent) || aEvent.type === &quot;keyup&quot;   || !aEvent.type;</span>
<a href="#l82.307"></a><span id="l82.307" class="difflineplus">+    !(&quot;type&quot; in aEvent) || aEvent.type === &quot;keyup&quot; || !aEvent.type;</span>
<a href="#l82.308"></a><span id="l82.308"> </span>
<a href="#l82.309"></a><span id="l82.309">   try {</span>
<a href="#l82.310"></a><span id="l82.310">     if (dispatchKeydown) {</span>
<a href="#l82.311"></a><span id="l82.311">       TIP.keydown(keyEvent, keyEventDict.flags);</span>
<a href="#l82.312"></a><span id="l82.312">       if (&quot;repeat&quot; in aEvent &amp;&amp; aEvent.repeat &gt; 1) {</span>
<a href="#l82.313"></a><span id="l82.313">         keyEventDict.dictionary.repeat = true;</span>
<a href="#l82.314"></a><span id="l82.314">         var repeatedKeyEvent = new KeyboardEvent(&quot;&quot;, keyEventDict.dictionary);</span>
<a href="#l82.315"></a><span id="l82.315">         for (var i = 1; i &lt; aEvent.repeat; i++) {</span>
<a href="#l82.316"></a><span id="l82.316" class="difflineat">@@ -366,48 +187,46 @@ function synthesizeKey(aKey, aEvent, aWi</span>
<a href="#l82.317"></a><span id="l82.317"> </span>
<a href="#l82.318"></a><span id="l82.318"> var _gSeenEvent = false;</span>
<a href="#l82.319"></a><span id="l82.319"> </span>
<a href="#l82.320"></a><span id="l82.320"> /**</span>
<a href="#l82.321"></a><span id="l82.321">  * Indicate that an event with an original target of aExpectedTarget and</span>
<a href="#l82.322"></a><span id="l82.322">  * a type of aExpectedEvent is expected to be fired, or not expected to</span>
<a href="#l82.323"></a><span id="l82.323">  * be fired.</span>
<a href="#l82.324"></a><span id="l82.324">  */</span>
<a href="#l82.325"></a><span id="l82.325" class="difflineminus">-function _expectEvent(aExpectedTarget, aExpectedEvent, aTestName)</span>
<a href="#l82.326"></a><span id="l82.326" class="difflineminus">-{</span>
<a href="#l82.327"></a><span id="l82.327" class="difflineplus">+function _expectEvent(aExpectedTarget, aExpectedEvent, aTestName) {</span>
<a href="#l82.328"></a><span id="l82.328">   if (!aExpectedTarget || !aExpectedEvent)</span>
<a href="#l82.329"></a><span id="l82.329">     return null;</span>
<a href="#l82.330"></a><span id="l82.330"> </span>
<a href="#l82.331"></a><span id="l82.331">   _gSeenEvent = false;</span>
<a href="#l82.332"></a><span id="l82.332"> </span>
<a href="#l82.333"></a><span id="l82.333">   var type = (aExpectedEvent.charAt(0) == &quot;!&quot;) ?</span>
<a href="#l82.334"></a><span id="l82.334">              aExpectedEvent.substring(1) : aExpectedEvent;</span>
<a href="#l82.335"></a><span id="l82.335">   var eventHandler = function(event) {</span>
<a href="#l82.336"></a><span id="l82.336">     var epassed = (!_gSeenEvent &amp;&amp; event.originalTarget == aExpectedTarget &amp;&amp;</span>
<a href="#l82.337"></a><span id="l82.337">                    event.type == type);</span>
<a href="#l82.338"></a><span id="l82.338">     if (!epassed)</span>
<a href="#l82.339"></a><span id="l82.339">       throw new Error(aTestName + &quot; &quot; + type + &quot; event target &quot; +</span>
<a href="#l82.340"></a><span id="l82.340">                       (_gSeenEvent ? &quot;twice&quot; : &quot;&quot;));</span>
<a href="#l82.341"></a><span id="l82.341">     _gSeenEvent = true;</span>
<a href="#l82.342"></a><span id="l82.342">   };</span>
<a href="#l82.343"></a><span id="l82.343"> </span>
<a href="#l82.344"></a><span id="l82.344" class="difflineminus">-  aExpectedTarget.addEventListener(type, eventHandler, false);</span>
<a href="#l82.345"></a><span id="l82.345" class="difflineplus">+  aExpectedTarget.addEventListener(type, eventHandler);</span>
<a href="#l82.346"></a><span id="l82.346">   return eventHandler;</span>
<a href="#l82.347"></a><span id="l82.347"> }</span>
<a href="#l82.348"></a><span id="l82.348"> </span>
<a href="#l82.349"></a><span id="l82.349"> /**</span>
<a href="#l82.350"></a><span id="l82.350">  * Check if the event was fired or not. The event handler aEventHandler</span>
<a href="#l82.351"></a><span id="l82.351">  * will be removed.</span>
<a href="#l82.352"></a><span id="l82.352">  */</span>
<a href="#l82.353"></a><span id="l82.353" class="difflineminus">-function _checkExpectedEvent(aExpectedTarget, aExpectedEvent, aEventHandler, aTestName)</span>
<a href="#l82.354"></a><span id="l82.354" class="difflineminus">-{</span>
<a href="#l82.355"></a><span id="l82.355" class="difflineplus">+function _checkExpectedEvent(aExpectedTarget, aExpectedEvent, aEventHandler, aTestName) {</span>
<a href="#l82.356"></a><span id="l82.356">   if (aEventHandler) {</span>
<a href="#l82.357"></a><span id="l82.357">     var expectEvent = (aExpectedEvent.charAt(0) != &quot;!&quot;);</span>
<a href="#l82.358"></a><span id="l82.358">     var type = expectEvent ? aExpectedEvent : aExpectedEvent.substring(1);</span>
<a href="#l82.359"></a><span id="l82.359" class="difflineminus">-    aExpectedTarget.removeEventListener(type, aEventHandler, false);</span>
<a href="#l82.360"></a><span id="l82.360" class="difflineplus">+    aExpectedTarget.removeEventListener(type, aEventHandler);</span>
<a href="#l82.361"></a><span id="l82.361">     var desc = type + &quot; event&quot;;</span>
<a href="#l82.362"></a><span id="l82.362">     if (expectEvent)</span>
<a href="#l82.363"></a><span id="l82.363">       desc += &quot; not&quot;;</span>
<a href="#l82.364"></a><span id="l82.364">     if (_gSeenEvent != expectEvent)</span>
<a href="#l82.365"></a><span id="l82.365">       throw new Error(aTestName + &quot;: &quot; + desc + &quot; fired.&quot;);</span>
<a href="#l82.366"></a><span id="l82.366">   }</span>
<a href="#l82.367"></a><span id="l82.367"> </span>
<a href="#l82.368"></a><span id="l82.368">   _gSeenEvent = false;</span>
<a href="#l82.369"></a><span id="l82.369" class="difflineat">@@ -424,483 +243,60 @@ function _checkExpectedEvent(aExpectedTa</span>
<a href="#l82.370"></a><span id="l82.370">  * To test that an event is not fired, use an expected type preceded by an</span>
<a href="#l82.371"></a><span id="l82.371">  * exclamation mark, such as '!select'. This might be used to test that a</span>
<a href="#l82.372"></a><span id="l82.372">  * click on a disabled element doesn't fire certain events for instance.</span>
<a href="#l82.373"></a><span id="l82.373">  *</span>
<a href="#l82.374"></a><span id="l82.374">  * aWindow is optional, and defaults to the current window object.</span>
<a href="#l82.375"></a><span id="l82.375">  */</span>
<a href="#l82.376"></a><span id="l82.376"> function synthesizeMouseExpectEvent(aTarget, aOffsetX, aOffsetY, aEvent,</span>
<a href="#l82.377"></a><span id="l82.377">                                     aExpectedTarget, aExpectedEvent, aTestName,</span>
<a href="#l82.378"></a><span id="l82.378" class="difflineminus">-                                    aWindow)</span>
<a href="#l82.379"></a><span id="l82.379" class="difflineminus">-{</span>
<a href="#l82.380"></a><span id="l82.380" class="difflineplus">+                                    aWindow) {</span>
<a href="#l82.381"></a><span id="l82.381">   var eventHandler = _expectEvent(aExpectedTarget, aExpectedEvent, aTestName);</span>
<a href="#l82.382"></a><span id="l82.382">   synthesizeMouse(aTarget, aOffsetX, aOffsetY, aEvent, aWindow);</span>
<a href="#l82.383"></a><span id="l82.383">   _checkExpectedEvent(aExpectedTarget, aExpectedEvent, eventHandler, aTestName);</span>
<a href="#l82.384"></a><span id="l82.384"> }</span>
<a href="#l82.385"></a><span id="l82.385"> </span>
<a href="#l82.386"></a><span id="l82.386"> /**</span>
<a href="#l82.387"></a><span id="l82.387" class="difflineminus">- * Similar to synthesizeKey except that a test is performed to see if an</span>
<a href="#l82.388"></a><span id="l82.388" class="difflineminus">- * event is fired at the right target as a result.</span>
<a href="#l82.389"></a><span id="l82.389" class="difflineminus">- *</span>
<a href="#l82.390"></a><span id="l82.390" class="difflineminus">- * aExpectedTarget - the expected originalTarget of the event.</span>
<a href="#l82.391"></a><span id="l82.391" class="difflineminus">- * aExpectedEvent - the expected type of the event, such as 'select'.</span>
<a href="#l82.392"></a><span id="l82.392" class="difflineminus">- * aTestName - the test name when outputting results</span>
<a href="#l82.393"></a><span id="l82.393" class="difflineminus">- *</span>
<a href="#l82.394"></a><span id="l82.394" class="difflineminus">- * To test that an event is not fired, use an expected type preceded by an</span>
<a href="#l82.395"></a><span id="l82.395" class="difflineminus">- * exclamation mark, such as '!select'.</span>
<a href="#l82.396"></a><span id="l82.396" class="difflineminus">- *</span>
<a href="#l82.397"></a><span id="l82.397" class="difflineminus">- * aWindow is optional, and defaults to the current window object.</span>
<a href="#l82.398"></a><span id="l82.398" class="difflineminus">- */</span>
<a href="#l82.399"></a><span id="l82.399" class="difflineminus">-function synthesizeKeyExpectEvent(key, aEvent, aExpectedTarget, aExpectedEvent,</span>
<a href="#l82.400"></a><span id="l82.400" class="difflineminus">-                                  aTestName, aWindow)</span>
<a href="#l82.401"></a><span id="l82.401" class="difflineminus">-{</span>
<a href="#l82.402"></a><span id="l82.402" class="difflineminus">-  var eventHandler = _expectEvent(aExpectedTarget, aExpectedEvent, aTestName);</span>
<a href="#l82.403"></a><span id="l82.403" class="difflineminus">-  synthesizeKey(key, aEvent, aWindow);</span>
<a href="#l82.404"></a><span id="l82.404" class="difflineminus">-  _checkExpectedEvent(aExpectedTarget, aExpectedEvent, eventHandler, aTestName);</span>
<a href="#l82.405"></a><span id="l82.405" class="difflineminus">-}</span>
<a href="#l82.406"></a><span id="l82.406" class="difflineminus">-</span>
<a href="#l82.407"></a><span id="l82.407" class="difflineminus">-/**</span>
<a href="#l82.408"></a><span id="l82.408" class="difflineminus">- * Emulate a dragstart event.</span>
<a href="#l82.409"></a><span id="l82.409" class="difflineminus">- *  element - element to fire the dragstart event on</span>
<a href="#l82.410"></a><span id="l82.410" class="difflineminus">- *  expectedDragData - the data you expect the data transfer to contain afterwards</span>
<a href="#l82.411"></a><span id="l82.411" class="difflineminus">- *                      This data is in the format:</span>
<a href="#l82.412"></a><span id="l82.412" class="difflineminus">- *                         [ [ {type: value, data: value, test: function}, ... ], ... ]</span>
<a href="#l82.413"></a><span id="l82.413" class="difflineminus">- *                     can be null</span>
<a href="#l82.414"></a><span id="l82.414" class="difflineminus">- *  aWindow - optional; defaults to the current window object.</span>
<a href="#l82.415"></a><span id="l82.415" class="difflineminus">- *  x - optional; initial x coordinate</span>
<a href="#l82.416"></a><span id="l82.416" class="difflineminus">- *  y - optional; initial y coordinate</span>
<a href="#l82.417"></a><span id="l82.417" class="difflineminus">- * Returns null if data matches.</span>
<a href="#l82.418"></a><span id="l82.418" class="difflineminus">- * Returns the event.dataTransfer if data does not match</span>
<a href="#l82.419"></a><span id="l82.419" class="difflineminus">- *</span>
<a href="#l82.420"></a><span id="l82.420" class="difflineminus">- * eqTest is an optional function if comparison can't be done with x == y;</span>
<a href="#l82.421"></a><span id="l82.421" class="difflineminus">- *   function (actualData, expectedData) {return boolean}</span>
<a href="#l82.422"></a><span id="l82.422" class="difflineminus">- *   @param actualData from dataTransfer</span>
<a href="#l82.423"></a><span id="l82.423" class="difflineminus">- *   @param expectedData from expectedDragData</span>
<a href="#l82.424"></a><span id="l82.424" class="difflineminus">- * see bug 462172 for example of use</span>
<a href="#l82.425"></a><span id="l82.425" class="difflineminus">- *</span>
<a href="#l82.426"></a><span id="l82.426" class="difflineminus">- */</span>
<a href="#l82.427"></a><span id="l82.427" class="difflineminus">-function synthesizeDragStart(element, expectedDragData, aWindow, x, y)</span>
<a href="#l82.428"></a><span id="l82.428" class="difflineminus">-{</span>
<a href="#l82.429"></a><span id="l82.429" class="difflineminus">-  if (!aWindow)</span>
<a href="#l82.430"></a><span id="l82.430" class="difflineminus">-    aWindow = window;</span>
<a href="#l82.431"></a><span id="l82.431" class="difflineminus">-  x = x || 2;</span>
<a href="#l82.432"></a><span id="l82.432" class="difflineminus">-  y = y || 2;</span>
<a href="#l82.433"></a><span id="l82.433" class="difflineminus">-  const step = 9;</span>
<a href="#l82.434"></a><span id="l82.434" class="difflineminus">-</span>
<a href="#l82.435"></a><span id="l82.435" class="difflineminus">-  var result = &quot;trapDrag was not called&quot;;</span>
<a href="#l82.436"></a><span id="l82.436" class="difflineminus">-  var trapDrag = function(event) {</span>
<a href="#l82.437"></a><span id="l82.437" class="difflineminus">-    try {</span>
<a href="#l82.438"></a><span id="l82.438" class="difflineminus">-      var dataTransfer = event.dataTransfer;</span>
<a href="#l82.439"></a><span id="l82.439" class="difflineminus">-      result = null;</span>
<a href="#l82.440"></a><span id="l82.440" class="difflineminus">-      if (!dataTransfer)</span>
<a href="#l82.441"></a><span id="l82.441" class="difflineminus">-        throw &quot;no dataTransfer&quot;;</span>
<a href="#l82.442"></a><span id="l82.442" class="difflineminus">-      if (expectedDragData == null ||</span>
<a href="#l82.443"></a><span id="l82.443" class="difflineminus">-          dataTransfer.mozItemCount != expectedDragData.length)</span>
<a href="#l82.444"></a><span id="l82.444" class="difflineminus">-        throw dataTransfer;</span>
<a href="#l82.445"></a><span id="l82.445" class="difflineminus">-      for (var i = 0; i &lt; dataTransfer.mozItemCount; i++) {</span>
<a href="#l82.446"></a><span id="l82.446" class="difflineminus">-        var dtTypes = dataTransfer.mozTypesAt(i);</span>
<a href="#l82.447"></a><span id="l82.447" class="difflineminus">-        if (dtTypes.length != expectedDragData[i].length)</span>
<a href="#l82.448"></a><span id="l82.448" class="difflineminus">-          throw dataTransfer;</span>
<a href="#l82.449"></a><span id="l82.449" class="difflineminus">-        for (var j = 0; j &lt; dtTypes.length; j++) {</span>
<a href="#l82.450"></a><span id="l82.450" class="difflineminus">-          if (dtTypes[j] != expectedDragData[i][j].type)</span>
<a href="#l82.451"></a><span id="l82.451" class="difflineminus">-            throw dataTransfer;</span>
<a href="#l82.452"></a><span id="l82.452" class="difflineminus">-          var dtData = dataTransfer.mozGetDataAt(dtTypes[j],i);</span>
<a href="#l82.453"></a><span id="l82.453" class="difflineminus">-          if (expectedDragData[i][j].eqTest) {</span>
<a href="#l82.454"></a><span id="l82.454" class="difflineminus">-            if (!expectedDragData[i][j].eqTest(dtData, expectedDragData[i][j].data))</span>
<a href="#l82.455"></a><span id="l82.455" class="difflineminus">-              throw dataTransfer;</span>
<a href="#l82.456"></a><span id="l82.456" class="difflineminus">-          }</span>
<a href="#l82.457"></a><span id="l82.457" class="difflineminus">-          else if (expectedDragData[i][j].data != dtData)</span>
<a href="#l82.458"></a><span id="l82.458" class="difflineminus">-            throw dataTransfer;</span>
<a href="#l82.459"></a><span id="l82.459" class="difflineminus">-        }</span>
<a href="#l82.460"></a><span id="l82.460" class="difflineminus">-      }</span>
<a href="#l82.461"></a><span id="l82.461" class="difflineminus">-    } catch(ex) {</span>
<a href="#l82.462"></a><span id="l82.462" class="difflineminus">-      result = ex;</span>
<a href="#l82.463"></a><span id="l82.463" class="difflineminus">-    }</span>
<a href="#l82.464"></a><span id="l82.464" class="difflineminus">-    event.preventDefault();</span>
<a href="#l82.465"></a><span id="l82.465" class="difflineminus">-    event.stopPropagation();</span>
<a href="#l82.466"></a><span id="l82.466" class="difflineminus">-  }</span>
<a href="#l82.467"></a><span id="l82.467" class="difflineminus">-  aWindow.addEventListener(&quot;dragstart&quot;, trapDrag, false);</span>
<a href="#l82.468"></a><span id="l82.468" class="difflineminus">-  synthesizeMouse(element, x, y, { type: &quot;mousedown&quot; }, aWindow);</span>
<a href="#l82.469"></a><span id="l82.469" class="difflineminus">-  x += step; y += step;</span>
<a href="#l82.470"></a><span id="l82.470" class="difflineminus">-  synthesizeMouse(element, x, y, { type: &quot;mousemove&quot; }, aWindow);</span>
<a href="#l82.471"></a><span id="l82.471" class="difflineminus">-  x += step; y += step;</span>
<a href="#l82.472"></a><span id="l82.472" class="difflineminus">-  synthesizeMouse(element, x, y, { type: &quot;mousemove&quot; }, aWindow);</span>
<a href="#l82.473"></a><span id="l82.473" class="difflineminus">-  aWindow.removeEventListener(&quot;dragstart&quot;, trapDrag, false);</span>
<a href="#l82.474"></a><span id="l82.474" class="difflineminus">-  synthesizeMouse(element, x, y, { type: &quot;mouseup&quot; }, aWindow);</span>
<a href="#l82.475"></a><span id="l82.475" class="difflineminus">-  return result;</span>
<a href="#l82.476"></a><span id="l82.476" class="difflineminus">-}</span>
<a href="#l82.477"></a><span id="l82.477" class="difflineminus">-</span>
<a href="#l82.478"></a><span id="l82.478" class="difflineminus">-/**</span>
<a href="#l82.479"></a><span id="l82.479" class="difflineminus">- * Emulate a drop by emulating a dragstart and firing events dragenter, dragover, and drop.</span>
<a href="#l82.480"></a><span id="l82.480" class="difflineminus">- *  srcElement - the element to use to start the drag, usually the same as destElement</span>
<a href="#l82.481"></a><span id="l82.481" class="difflineminus">- *               but if destElement isn't suitable to start a drag on pass a suitable</span>
<a href="#l82.482"></a><span id="l82.482" class="difflineminus">- *               element for srcElement</span>
<a href="#l82.483"></a><span id="l82.483" class="difflineminus">- *  destElement - the element to fire the dragover, dragleave and drop events</span>
<a href="#l82.484"></a><span id="l82.484" class="difflineminus">- *  dragData - the data to supply for the data transfer</span>
<a href="#l82.485"></a><span id="l82.485" class="difflineminus">- *                     This data is in the format:</span>
<a href="#l82.486"></a><span id="l82.486" class="difflineminus">- *                       [ [ {type: value, data: value}, ...], ... ]</span>
<a href="#l82.487"></a><span id="l82.487" class="difflineminus">- *  dropEffect - the drop effect to set during the dragstart event, or 'move' if null</span>
<a href="#l82.488"></a><span id="l82.488" class="difflineminus">- *  aWindow - optional; defaults to the current window object.</span>
<a href="#l82.489"></a><span id="l82.489" class="difflineminus">- *</span>
<a href="#l82.490"></a><span id="l82.490" class="difflineminus">- * Returns the drop effect that was desired.</span>
<a href="#l82.491"></a><span id="l82.491" class="difflineminus">- */</span>
<a href="#l82.492"></a><span id="l82.492" class="difflineminus">-function synthesizeDrop(srcElement, destElement, dragData, dropEffect, aWindow)</span>
<a href="#l82.493"></a><span id="l82.493" class="difflineminus">-{</span>
<a href="#l82.494"></a><span id="l82.494" class="difflineminus">-  if (!aWindow)</span>
<a href="#l82.495"></a><span id="l82.495" class="difflineminus">-    aWindow = window;</span>
<a href="#l82.496"></a><span id="l82.496" class="difflineminus">-</span>
<a href="#l82.497"></a><span id="l82.497" class="difflineminus">-  var dataTransfer;</span>
<a href="#l82.498"></a><span id="l82.498" class="difflineminus">-  var trapDrag = function(event) {</span>
<a href="#l82.499"></a><span id="l82.499" class="difflineminus">-    dataTransfer = event.dataTransfer;</span>
<a href="#l82.500"></a><span id="l82.500" class="difflineminus">-    for (var i = 0; i &lt; dragData.length; i++) {</span>
<a href="#l82.501"></a><span id="l82.501" class="difflineminus">-      var item = dragData[i];</span>
<a href="#l82.502"></a><span id="l82.502" class="difflineminus">-      for (var j = 0; j &lt; item.length; j++) {</span>
<a href="#l82.503"></a><span id="l82.503" class="difflineminus">-        dataTransfer.mozSetDataAt(item[j].type, item[j].data, i);</span>
<a href="#l82.504"></a><span id="l82.504" class="difflineminus">-      }</span>
<a href="#l82.505"></a><span id="l82.505" class="difflineminus">-    }</span>
<a href="#l82.506"></a><span id="l82.506" class="difflineminus">-    dataTransfer.dropEffect = dropEffect || &quot;move&quot;;</span>
<a href="#l82.507"></a><span id="l82.507" class="difflineminus">-    event.preventDefault();</span>
<a href="#l82.508"></a><span id="l82.508" class="difflineminus">-    event.stopPropagation();</span>
<a href="#l82.509"></a><span id="l82.509" class="difflineminus">-  }</span>
<a href="#l82.510"></a><span id="l82.510" class="difflineminus">-</span>
<a href="#l82.511"></a><span id="l82.511" class="difflineminus">-  // need to use real mouse action</span>
<a href="#l82.512"></a><span id="l82.512" class="difflineminus">-  aWindow.addEventListener(&quot;dragstart&quot;, trapDrag, true);</span>
<a href="#l82.513"></a><span id="l82.513" class="difflineminus">-  synthesizeMouse(srcElement, 2, 2, { type: &quot;mousedown&quot; }, aWindow);</span>
<a href="#l82.514"></a><span id="l82.514" class="difflineminus">-  synthesizeMouse(srcElement, 11, 11, { type: &quot;mousemove&quot; }, aWindow);</span>
<a href="#l82.515"></a><span id="l82.515" class="difflineminus">-  synthesizeMouse(srcElement, 20, 20, { type: &quot;mousemove&quot; }, aWindow);</span>
<a href="#l82.516"></a><span id="l82.516" class="difflineminus">-  aWindow.removeEventListener(&quot;dragstart&quot;, trapDrag, true);</span>
<a href="#l82.517"></a><span id="l82.517" class="difflineminus">-</span>
<a href="#l82.518"></a><span id="l82.518" class="difflineminus">-  event = aWindow.document.createEvent(&quot;DragEvent&quot;);</span>
<a href="#l82.519"></a><span id="l82.519" class="difflineminus">-  event.initDragEvent(&quot;dragenter&quot;, true, true, aWindow, 0, 0, 0, 0, 0, false, false, false, false, 0, null, dataTransfer);</span>
<a href="#l82.520"></a><span id="l82.520" class="difflineminus">-  destElement.dispatchEvent(event);</span>
<a href="#l82.521"></a><span id="l82.521" class="difflineminus">-</span>
<a href="#l82.522"></a><span id="l82.522" class="difflineminus">-  var event = aWindow.document.createEvent(&quot;DragEvent&quot;);</span>
<a href="#l82.523"></a><span id="l82.523" class="difflineminus">-  event.initDragEvent(&quot;dragover&quot;, true, true, aWindow, 0, 0, 0, 0, 0, false, false, false, false, 0, null, dataTransfer);</span>
<a href="#l82.524"></a><span id="l82.524" class="difflineminus">-  if (destElement.dispatchEvent(event)) {</span>
<a href="#l82.525"></a><span id="l82.525" class="difflineminus">-    synthesizeMouse(destElement, 20, 20, { type: &quot;mouseup&quot; }, aWindow);</span>
<a href="#l82.526"></a><span id="l82.526" class="difflineminus">-    return &quot;none&quot;;</span>
<a href="#l82.527"></a><span id="l82.527" class="difflineminus">-  }</span>
<a href="#l82.528"></a><span id="l82.528" class="difflineminus">-</span>
<a href="#l82.529"></a><span id="l82.529" class="difflineminus">-  if (dataTransfer.dropEffect != &quot;none&quot;) {</span>
<a href="#l82.530"></a><span id="l82.530" class="difflineminus">-    event = aWindow.document.createEvent(&quot;DragEvent&quot;);</span>
<a href="#l82.531"></a><span id="l82.531" class="difflineminus">-    event.initDragEvent(&quot;drop&quot;, true, true, aWindow, 0, 0, 0, 0, 0, false, false, false, false, 0, null, dataTransfer);</span>
<a href="#l82.532"></a><span id="l82.532" class="difflineminus">-    destElement.dispatchEvent(event);</span>
<a href="#l82.533"></a><span id="l82.533" class="difflineminus">-  }</span>
<a href="#l82.534"></a><span id="l82.534" class="difflineminus">-  synthesizeMouse(destElement, 20, 20, { type: &quot;mouseup&quot; }, aWindow);</span>
<a href="#l82.535"></a><span id="l82.535" class="difflineminus">-</span>
<a href="#l82.536"></a><span id="l82.536" class="difflineminus">-  return dataTransfer.dropEffect;</span>
<a href="#l82.537"></a><span id="l82.537" class="difflineminus">-}</span>
<a href="#l82.538"></a><span id="l82.538" class="difflineminus">-</span>
<a href="#l82.539"></a><span id="l82.539" class="difflineminus">-function disableNonTestMouseEvents(aDisable)</span>
<a href="#l82.540"></a><span id="l82.540" class="difflineminus">-{</span>
<a href="#l82.541"></a><span id="l82.541" class="difflineminus">-  var utils = window.windowUtils;</span>
<a href="#l82.542"></a><span id="l82.542" class="difflineminus">-  if (utils)</span>
<a href="#l82.543"></a><span id="l82.543" class="difflineminus">-    utils.disableNonTestMouseEvents(aDisable);</span>
<a href="#l82.544"></a><span id="l82.544" class="difflineminus">-}</span>
<a href="#l82.545"></a><span id="l82.545" class="difflineminus">-</span>
<a href="#l82.546"></a><span id="l82.546" class="difflineminus">-function _getDOMWindowUtils(aWindow)</span>
<a href="#l82.547"></a><span id="l82.547" class="difflineminus">-{</span>
<a href="#l82.548"></a><span id="l82.548" class="difflineminus">-  if (!aWindow) {</span>
<a href="#l82.549"></a><span id="l82.549" class="difflineminus">-    aWindow = window;</span>
<a href="#l82.550"></a><span id="l82.550" class="difflineminus">-  }</span>
<a href="#l82.551"></a><span id="l82.551" class="difflineminus">-  return aWindow.windowUtils;</span>
<a href="#l82.552"></a><span id="l82.552" class="difflineminus">-}</span>
<a href="#l82.553"></a><span id="l82.553" class="difflineminus">-</span>
<a href="#l82.554"></a><span id="l82.554" class="difflineminus">-/**</span>
<a href="#l82.555"></a><span id="l82.555" class="difflineminus">- * Synthesize a composition event.</span>
<a href="#l82.556"></a><span id="l82.556" class="difflineminus">- *</span>
<a href="#l82.557"></a><span id="l82.557" class="difflineminus">- * @param aIsCompositionStart  If true, this synthesize compositionstart event.</span>
<a href="#l82.558"></a><span id="l82.558" class="difflineminus">- *                             Otherwise, compositionend event.</span>
<a href="#l82.559"></a><span id="l82.559" class="difflineminus">- * @param aWindow              Optional (If null, current |window| will be used)</span>
<a href="#l82.560"></a><span id="l82.560" class="difflineminus">- */</span>
<a href="#l82.561"></a><span id="l82.561" class="difflineminus">-function synthesizeComposition(aIsCompositionStart, aWindow)</span>
<a href="#l82.562"></a><span id="l82.562" class="difflineminus">-{</span>
<a href="#l82.563"></a><span id="l82.563" class="difflineminus">-  var utils = _getDOMWindowUtils(aWindow);</span>
<a href="#l82.564"></a><span id="l82.564" class="difflineminus">-  if (!utils) {</span>
<a href="#l82.565"></a><span id="l82.565" class="difflineminus">-    return;</span>
<a href="#l82.566"></a><span id="l82.566" class="difflineminus">-  }</span>
<a href="#l82.567"></a><span id="l82.567" class="difflineminus">-</span>
<a href="#l82.568"></a><span id="l82.568" class="difflineminus">-  utils.sendCompositionEvent(aIsCompositionStart ?</span>
<a href="#l82.569"></a><span id="l82.569" class="difflineminus">-                               &quot;compositionstart&quot; : &quot;compositionend&quot;);</span>
<a href="#l82.570"></a><span id="l82.570" class="difflineminus">-}</span>
<a href="#l82.571"></a><span id="l82.571" class="difflineminus">-</span>
<a href="#l82.572"></a><span id="l82.572" class="difflineminus">-/**</span>
<a href="#l82.573"></a><span id="l82.573" class="difflineminus">- * Synthesize a text event.</span>
<a href="#l82.574"></a><span id="l82.574" class="difflineminus">- *</span>
<a href="#l82.575"></a><span id="l82.575" class="difflineminus">- * @param aEvent   The text event's information, this has |composition|</span>
<a href="#l82.576"></a><span id="l82.576" class="difflineminus">- *                 and |caret| members.  |composition| has |string| and</span>
<a href="#l82.577"></a><span id="l82.577" class="difflineminus">- *                 |clauses| members.  |clauses| must be array object.  Each</span>
<a href="#l82.578"></a><span id="l82.578" class="difflineminus">- *                 object has |length| and |attr|.  And |caret| has |start| and</span>
<a href="#l82.579"></a><span id="l82.579" class="difflineminus">- *                 |length|.  See the following tree image.</span>
<a href="#l82.580"></a><span id="l82.580" class="difflineminus">- *</span>
<a href="#l82.581"></a><span id="l82.581" class="difflineminus">- *                 aEvent</span>
<a href="#l82.582"></a><span id="l82.582" class="difflineminus">- *                   +-- composition</span>
<a href="#l82.583"></a><span id="l82.583" class="difflineminus">- *                   |     +-- string</span>
<a href="#l82.584"></a><span id="l82.584" class="difflineminus">- *                   |     +-- clauses[]</span>
<a href="#l82.585"></a><span id="l82.585" class="difflineminus">- *                   |           +-- length</span>
<a href="#l82.586"></a><span id="l82.586" class="difflineminus">- *                   |           +-- attr</span>
<a href="#l82.587"></a><span id="l82.587" class="difflineminus">- *                   +-- caret</span>
<a href="#l82.588"></a><span id="l82.588" class="difflineminus">- *                         +-- start</span>
<a href="#l82.589"></a><span id="l82.589" class="difflineminus">- *                         +-- length</span>
<a href="#l82.590"></a><span id="l82.590" class="difflineminus">- *</span>
<a href="#l82.591"></a><span id="l82.591" class="difflineminus">- *                 Set the composition string to |composition.string|.  Set its</span>
<a href="#l82.592"></a><span id="l82.592" class="difflineminus">- *                 clauses information to the |clauses| array.</span>
<a href="#l82.593"></a><span id="l82.593" class="difflineminus">- *</span>
<a href="#l82.594"></a><span id="l82.594" class="difflineminus">- *                 When it's composing, set the each clauses' length to the</span>
<a href="#l82.595"></a><span id="l82.595" class="difflineminus">- *                 |composition.clauses[n].length|.  The sum of the all length</span>
<a href="#l82.596"></a><span id="l82.596" class="difflineminus">- *                 values must be same as the length of |composition.string|.</span>
<a href="#l82.597"></a><span id="l82.597" class="difflineminus">- *                 Set nsIDOMWindowUtils.COMPOSITION_ATTR_* to the</span>
<a href="#l82.598"></a><span id="l82.598" class="difflineminus">- *                 |composition.clauses[n].attr|.</span>
<a href="#l82.599"></a><span id="l82.599" class="difflineminus">- *</span>
<a href="#l82.600"></a><span id="l82.600" class="difflineminus">- *                 When it's not composing, set 0 to the</span>
<a href="#l82.601"></a><span id="l82.601" class="difflineminus">- *                 |composition.clauses[0].length| and</span>
<a href="#l82.602"></a><span id="l82.602" class="difflineminus">- *                 |composition.clauses[0].attr|.</span>
<a href="#l82.603"></a><span id="l82.603" class="difflineminus">- *</span>
<a href="#l82.604"></a><span id="l82.604" class="difflineminus">- *                 Set caret position to the |caret.start|. It's offset from</span>
<a href="#l82.605"></a><span id="l82.605" class="difflineminus">- *                 the start of the composition string.  Set caret length to</span>
<a href="#l82.606"></a><span id="l82.606" class="difflineminus">- *                 |caret.length|.  If it's larger than 0, it should be wide</span>
<a href="#l82.607"></a><span id="l82.607" class="difflineminus">- *                 caret.  However, current nsEditor doesn't support wide</span>
<a href="#l82.608"></a><span id="l82.608" class="difflineminus">- *                 caret, therefore, you should always set 0 now.</span>
<a href="#l82.609"></a><span id="l82.609" class="difflineminus">- *</span>
<a href="#l82.610"></a><span id="l82.610" class="difflineminus">- * @param aWindow  Optional (If null, current |window| will be used)</span>
<a href="#l82.611"></a><span id="l82.611" class="difflineminus">- */</span>
<a href="#l82.612"></a><span id="l82.612" class="difflineminus">-function synthesizeText(aEvent, aWindow)</span>
<a href="#l82.613"></a><span id="l82.613" class="difflineminus">-{</span>
<a href="#l82.614"></a><span id="l82.614" class="difflineminus">-  var utils = _getDOMWindowUtils(aWindow);</span>
<a href="#l82.615"></a><span id="l82.615" class="difflineminus">-  if (!utils) {</span>
<a href="#l82.616"></a><span id="l82.616" class="difflineminus">-    return;</span>
<a href="#l82.617"></a><span id="l82.617" class="difflineminus">-  }</span>
<a href="#l82.618"></a><span id="l82.618" class="difflineminus">-</span>
<a href="#l82.619"></a><span id="l82.619" class="difflineminus">-  if (!aEvent.composition || !aEvent.composition.clauses ||</span>
<a href="#l82.620"></a><span id="l82.620" class="difflineminus">-      !aEvent.composition.clauses[0]) {</span>
<a href="#l82.621"></a><span id="l82.621" class="difflineminus">-    return;</span>
<a href="#l82.622"></a><span id="l82.622" class="difflineminus">-  }</span>
<a href="#l82.623"></a><span id="l82.623" class="difflineminus">-</span>
<a href="#l82.624"></a><span id="l82.624" class="difflineminus">-  var firstClauseLength = aEvent.composition.clauses[0].length;</span>
<a href="#l82.625"></a><span id="l82.625" class="difflineminus">-  var firstClauseAttr   = aEvent.composition.clauses[0].attr;</span>
<a href="#l82.626"></a><span id="l82.626" class="difflineminus">-  var secondClauseLength = 0;</span>
<a href="#l82.627"></a><span id="l82.627" class="difflineminus">-  var secondClauseAttr = 0;</span>
<a href="#l82.628"></a><span id="l82.628" class="difflineminus">-  var thirdClauseLength = 0;</span>
<a href="#l82.629"></a><span id="l82.629" class="difflineminus">-  var thirdClauseAttr = 0;</span>
<a href="#l82.630"></a><span id="l82.630" class="difflineminus">-  if (aEvent.composition.clauses[1]) {</span>
<a href="#l82.631"></a><span id="l82.631" class="difflineminus">-    secondClauseLength = aEvent.composition.clauses[1].length;</span>
<a href="#l82.632"></a><span id="l82.632" class="difflineminus">-    secondClauseAttr   = aEvent.composition.clauses[1].attr;</span>
<a href="#l82.633"></a><span id="l82.633" class="difflineminus">-    if (aEvent.composition.clauses[2]) {</span>
<a href="#l82.634"></a><span id="l82.634" class="difflineminus">-      thirdClauseLength = aEvent.composition.clauses[2].length;</span>
<a href="#l82.635"></a><span id="l82.635" class="difflineminus">-      thirdClauseAttr   = aEvent.composition.clauses[2].attr;</span>
<a href="#l82.636"></a><span id="l82.636" class="difflineminus">-    }</span>
<a href="#l82.637"></a><span id="l82.637" class="difflineminus">-  }</span>
<a href="#l82.638"></a><span id="l82.638" class="difflineminus">-</span>
<a href="#l82.639"></a><span id="l82.639" class="difflineminus">-  var caretStart = -1;</span>
<a href="#l82.640"></a><span id="l82.640" class="difflineminus">-  var caretLength = 0;</span>
<a href="#l82.641"></a><span id="l82.641" class="difflineminus">-  if (aEvent.caret) {</span>
<a href="#l82.642"></a><span id="l82.642" class="difflineminus">-    caretStart = aEvent.caret.start;</span>
<a href="#l82.643"></a><span id="l82.643" class="difflineminus">-    caretLength = aEvent.caret.length;</span>
<a href="#l82.644"></a><span id="l82.644" class="difflineminus">-  }</span>
<a href="#l82.645"></a><span id="l82.645" class="difflineminus">-</span>
<a href="#l82.646"></a><span id="l82.646" class="difflineminus">-  utils.sendTextEvent(aEvent.composition.string,</span>
<a href="#l82.647"></a><span id="l82.647" class="difflineminus">-                      firstClauseLength, firstClauseAttr,</span>
<a href="#l82.648"></a><span id="l82.648" class="difflineminus">-                      secondClauseLength, secondClauseAttr,</span>
<a href="#l82.649"></a><span id="l82.649" class="difflineminus">-                      thirdClauseLength, thirdClauseAttr,</span>
<a href="#l82.650"></a><span id="l82.650" class="difflineminus">-                      caretStart, caretLength);</span>
<a href="#l82.651"></a><span id="l82.651" class="difflineminus">-}</span>
<a href="#l82.652"></a><span id="l82.652" class="difflineminus">-</span>
<a href="#l82.653"></a><span id="l82.653" class="difflineminus">-/**</span>
<a href="#l82.654"></a><span id="l82.654" class="difflineminus">- * Synthesize a query selected text event.</span>
<a href="#l82.655"></a><span id="l82.655" class="difflineminus">- *</span>
<a href="#l82.656"></a><span id="l82.656" class="difflineminus">- * @param aWindow  Optional (If null, current |window| will be used)</span>
<a href="#l82.657"></a><span id="l82.657" class="difflineminus">- * @return         An nsIQueryContentEventResult object.  If this failed,</span>
<a href="#l82.658"></a><span id="l82.658" class="difflineminus">- *                 the result might be null.</span>
<a href="#l82.659"></a><span id="l82.659" class="difflineminus">- */</span>
<a href="#l82.660"></a><span id="l82.660" class="difflineminus">-function synthesizeQuerySelectedText(aWindow)</span>
<a href="#l82.661"></a><span id="l82.661" class="difflineminus">-{</span>
<a href="#l82.662"></a><span id="l82.662" class="difflineminus">-  var utils = _getDOMWindowUtils(aWindow);</span>
<a href="#l82.663"></a><span id="l82.663" class="difflineminus">-  if (!utils) {</span>
<a href="#l82.664"></a><span id="l82.664" class="difflineminus">-    return null;</span>
<a href="#l82.665"></a><span id="l82.665" class="difflineminus">-  }</span>
<a href="#l82.666"></a><span id="l82.666" class="difflineminus">-</span>
<a href="#l82.667"></a><span id="l82.667" class="difflineminus">-  return utils.sendQueryContentEvent(utils.QUERY_SELECTED_TEXT, 0, 0, 0, 0);</span>
<a href="#l82.668"></a><span id="l82.668" class="difflineminus">-}</span>
<a href="#l82.669"></a><span id="l82.669" class="difflineminus">-</span>
<a href="#l82.670"></a><span id="l82.670" class="difflineminus">-/**</span>
<a href="#l82.671"></a><span id="l82.671" class="difflineminus">- * Synthesize a query text content event.</span>
<a href="#l82.672"></a><span id="l82.672" class="difflineminus">- *</span>
<a href="#l82.673"></a><span id="l82.673" class="difflineminus">- * @param aOffset  The character offset.  0 means the first character in the</span>
<a href="#l82.674"></a><span id="l82.674" class="difflineminus">- *                 selection root.</span>
<a href="#l82.675"></a><span id="l82.675" class="difflineminus">- * @param aLength  The length of getting text.  If the length is too long,</span>
<a href="#l82.676"></a><span id="l82.676" class="difflineminus">- *                 the extra length is ignored.</span>
<a href="#l82.677"></a><span id="l82.677" class="difflineminus">- * @param aWindow  Optional (If null, current |window| will be used)</span>
<a href="#l82.678"></a><span id="l82.678" class="difflineminus">- * @return         An nsIQueryContentEventResult object.  If this failed,</span>
<a href="#l82.679"></a><span id="l82.679" class="difflineminus">- *                 the result might be null.</span>
<a href="#l82.680"></a><span id="l82.680" class="difflineminus">- */</span>
<a href="#l82.681"></a><span id="l82.681" class="difflineminus">-function synthesizeQueryTextContent(aOffset, aLength, aWindow)</span>
<a href="#l82.682"></a><span id="l82.682" class="difflineminus">-{</span>
<a href="#l82.683"></a><span id="l82.683" class="difflineminus">-  var utils = _getDOMWindowUtils(aWindow);</span>
<a href="#l82.684"></a><span id="l82.684" class="difflineminus">-  if (!utils) {</span>
<a href="#l82.685"></a><span id="l82.685" class="difflineminus">-    return null;</span>
<a href="#l82.686"></a><span id="l82.686" class="difflineminus">-  }</span>
<a href="#l82.687"></a><span id="l82.687" class="difflineminus">-</span>
<a href="#l82.688"></a><span id="l82.688" class="difflineminus">-  return utils.sendQueryContentEvent(utils.QUERY_TEXT_CONTENT,</span>
<a href="#l82.689"></a><span id="l82.689" class="difflineminus">-                                     aOffset, aLength, 0, 0);</span>
<a href="#l82.690"></a><span id="l82.690" class="difflineminus">-}</span>
<a href="#l82.691"></a><span id="l82.691" class="difflineminus">-</span>
<a href="#l82.692"></a><span id="l82.692" class="difflineminus">-/**</span>
<a href="#l82.693"></a><span id="l82.693" class="difflineminus">- * Synthesize a query caret rect event.</span>
<a href="#l82.694"></a><span id="l82.694" class="difflineminus">- *</span>
<a href="#l82.695"></a><span id="l82.695" class="difflineminus">- * @param aOffset  The caret offset.  0 means left side of the first character</span>
<a href="#l82.696"></a><span id="l82.696" class="difflineminus">- *                 in the selection root.</span>
<a href="#l82.697"></a><span id="l82.697" class="difflineminus">- * @param aWindow  Optional (If null, current |window| will be used)</span>
<a href="#l82.698"></a><span id="l82.698" class="difflineminus">- * @return         An nsIQueryContentEventResult object.  If this failed,</span>
<a href="#l82.699"></a><span id="l82.699" class="difflineminus">- *                 the result might be null.</span>
<a href="#l82.700"></a><span id="l82.700" class="difflineminus">- */</span>
<a href="#l82.701"></a><span id="l82.701" class="difflineminus">-function synthesizeQueryCaretRect(aOffset, aWindow)</span>
<a href="#l82.702"></a><span id="l82.702" class="difflineminus">-{</span>
<a href="#l82.703"></a><span id="l82.703" class="difflineminus">-  var utils = _getDOMWindowUtils(aWindow);</span>
<a href="#l82.704"></a><span id="l82.704" class="difflineminus">-  if (!utils) {</span>
<a href="#l82.705"></a><span id="l82.705" class="difflineminus">-    return null;</span>
<a href="#l82.706"></a><span id="l82.706" class="difflineminus">-  }</span>
<a href="#l82.707"></a><span id="l82.707" class="difflineminus">-</span>
<a href="#l82.708"></a><span id="l82.708" class="difflineminus">-  return utils.sendQueryContentEvent(utils.QUERY_CARET_RECT,</span>
<a href="#l82.709"></a><span id="l82.709" class="difflineminus">-                                     aOffset, 0, 0, 0);</span>
<a href="#l82.710"></a><span id="l82.710" class="difflineminus">-}</span>
<a href="#l82.711"></a><span id="l82.711" class="difflineminus">-</span>
<a href="#l82.712"></a><span id="l82.712" class="difflineminus">-/**</span>
<a href="#l82.713"></a><span id="l82.713" class="difflineminus">- * Synthesize a query text rect event.</span>
<a href="#l82.714"></a><span id="l82.714" class="difflineminus">- *</span>
<a href="#l82.715"></a><span id="l82.715" class="difflineminus">- * @param aOffset  The character offset.  0 means the first character in the</span>
<a href="#l82.716"></a><span id="l82.716" class="difflineminus">- *                 selection root.</span>
<a href="#l82.717"></a><span id="l82.717" class="difflineminus">- * @param aLength  The length of the text.  If the length is too long,</span>
<a href="#l82.718"></a><span id="l82.718" class="difflineminus">- *                 the extra length is ignored.</span>
<a href="#l82.719"></a><span id="l82.719" class="difflineminus">- * @param aWindow  Optional (If null, current |window| will be used)</span>
<a href="#l82.720"></a><span id="l82.720" class="difflineminus">- * @return         An nsIQueryContentEventResult object.  If this failed,</span>
<a href="#l82.721"></a><span id="l82.721" class="difflineminus">- *                 the result might be null.</span>
<a href="#l82.722"></a><span id="l82.722" class="difflineminus">- */</span>
<a href="#l82.723"></a><span id="l82.723" class="difflineminus">-function synthesizeQueryTextRect(aOffset, aLength, aWindow)</span>
<a href="#l82.724"></a><span id="l82.724" class="difflineminus">-{</span>
<a href="#l82.725"></a><span id="l82.725" class="difflineminus">-  var utils = _getDOMWindowUtils(aWindow);</span>
<a href="#l82.726"></a><span id="l82.726" class="difflineminus">-  if (!utils) {</span>
<a href="#l82.727"></a><span id="l82.727" class="difflineminus">-    return null;</span>
<a href="#l82.728"></a><span id="l82.728" class="difflineminus">-  }</span>
<a href="#l82.729"></a><span id="l82.729" class="difflineminus">-</span>
<a href="#l82.730"></a><span id="l82.730" class="difflineminus">-  return utils.sendQueryContentEvent(utils.QUERY_TEXT_RECT,</span>
<a href="#l82.731"></a><span id="l82.731" class="difflineminus">-                                     aOffset, aLength, 0, 0);</span>
<a href="#l82.732"></a><span id="l82.732" class="difflineminus">-}</span>
<a href="#l82.733"></a><span id="l82.733" class="difflineminus">-</span>
<a href="#l82.734"></a><span id="l82.734" class="difflineminus">-/**</span>
<a href="#l82.735"></a><span id="l82.735" class="difflineminus">- * Synthesize a query editor rect event.</span>
<a href="#l82.736"></a><span id="l82.736" class="difflineminus">- *</span>
<a href="#l82.737"></a><span id="l82.737" class="difflineminus">- * @param aWindow  Optional (If null, current |window| will be used)</span>
<a href="#l82.738"></a><span id="l82.738" class="difflineminus">- * @return         An nsIQueryContentEventResult object.  If this failed,</span>
<a href="#l82.739"></a><span id="l82.739" class="difflineminus">- *                 the result might be null.</span>
<a href="#l82.740"></a><span id="l82.740" class="difflineminus">- */</span>
<a href="#l82.741"></a><span id="l82.741" class="difflineminus">-function synthesizeQueryEditorRect(aWindow)</span>
<a href="#l82.742"></a><span id="l82.742" class="difflineminus">-{</span>
<a href="#l82.743"></a><span id="l82.743" class="difflineminus">-  var utils = _getDOMWindowUtils(aWindow);</span>
<a href="#l82.744"></a><span id="l82.744" class="difflineminus">-  if (!utils) {</span>
<a href="#l82.745"></a><span id="l82.745" class="difflineminus">-    return null;</span>
<a href="#l82.746"></a><span id="l82.746" class="difflineminus">-  }</span>
<a href="#l82.747"></a><span id="l82.747" class="difflineminus">-</span>
<a href="#l82.748"></a><span id="l82.748" class="difflineminus">-  return utils.sendQueryContentEvent(utils.QUERY_EDITOR_RECT, 0, 0, 0, 0);</span>
<a href="#l82.749"></a><span id="l82.749" class="difflineminus">-}</span>
<a href="#l82.750"></a><span id="l82.750" class="difflineminus">-</span>
<a href="#l82.751"></a><span id="l82.751" class="difflineminus">-/**</span>
<a href="#l82.752"></a><span id="l82.752" class="difflineminus">- * Synthesize a character at point event.</span>
<a href="#l82.753"></a><span id="l82.753" class="difflineminus">- *</span>
<a href="#l82.754"></a><span id="l82.754" class="difflineminus">- * @param aX, aY   The offset in the client area of the DOM window.</span>
<a href="#l82.755"></a><span id="l82.755" class="difflineminus">- * @param aWindow  Optional (If null, current |window| will be used)</span>
<a href="#l82.756"></a><span id="l82.756" class="difflineminus">- * @return         An nsIQueryContentEventResult object.  If this failed,</span>
<a href="#l82.757"></a><span id="l82.757" class="difflineminus">- *                 the result might be null.</span>
<a href="#l82.758"></a><span id="l82.758" class="difflineminus">- */</span>
<a href="#l82.759"></a><span id="l82.759" class="difflineminus">-function synthesizeCharAtPoint(aX, aY, aWindow)</span>
<a href="#l82.760"></a><span id="l82.760" class="difflineminus">-{</span>
<a href="#l82.761"></a><span id="l82.761" class="difflineminus">-  var utils = _getDOMWindowUtils(aWindow);</span>
<a href="#l82.762"></a><span id="l82.762" class="difflineminus">-  if (!utils) {</span>
<a href="#l82.763"></a><span id="l82.763" class="difflineminus">-    return null;</span>
<a href="#l82.764"></a><span id="l82.764" class="difflineminus">-  }</span>
<a href="#l82.765"></a><span id="l82.765" class="difflineminus">-</span>
<a href="#l82.766"></a><span id="l82.766" class="difflineminus">-  return utils.sendQueryContentEvent(utils.QUERY_CHARACTER_AT_POINT,</span>
<a href="#l82.767"></a><span id="l82.767" class="difflineminus">-                                     0, 0, aX, aY);</span>
<a href="#l82.768"></a><span id="l82.768" class="difflineminus">-}</span>
<a href="#l82.769"></a><span id="l82.769" class="difflineminus">-</span>
<a href="#l82.770"></a><span id="l82.770" class="difflineminus">-/**</span>
<a href="#l82.771"></a><span id="l82.771" class="difflineminus">- * Synthesize a selection set event.</span>
<a href="#l82.772"></a><span id="l82.772" class="difflineminus">- *</span>
<a href="#l82.773"></a><span id="l82.773" class="difflineminus">- * @param aOffset  The character offset.  0 means the first character in the</span>
<a href="#l82.774"></a><span id="l82.774" class="difflineminus">- *                 selection root.</span>
<a href="#l82.775"></a><span id="l82.775" class="difflineminus">- * @param aLength  The length of the text.  If the length is too long,</span>
<a href="#l82.776"></a><span id="l82.776" class="difflineminus">- *                 the extra length is ignored.</span>
<a href="#l82.777"></a><span id="l82.777" class="difflineminus">- * @param aReverse If true, the selection is from |aOffset + aLength| to</span>
<a href="#l82.778"></a><span id="l82.778" class="difflineminus">- *                 |aOffset|.  Otherwise, from |aOffset| to |aOffset + aLength|.</span>
<a href="#l82.779"></a><span id="l82.779" class="difflineminus">- * @param aWindow  Optional (If null, current |window| will be used)</span>
<a href="#l82.780"></a><span id="l82.780" class="difflineminus">- * @return         True, if succeeded.  Otherwise false.</span>
<a href="#l82.781"></a><span id="l82.781" class="difflineminus">- */</span>
<a href="#l82.782"></a><span id="l82.782" class="difflineminus">-function synthesizeSelectionSet(aOffset, aLength, aReverse, aWindow)</span>
<a href="#l82.783"></a><span id="l82.783" class="difflineminus">-{</span>
<a href="#l82.784"></a><span id="l82.784" class="difflineminus">-  var utils = _getDOMWindowUtils(aWindow);</span>
<a href="#l82.785"></a><span id="l82.785" class="difflineminus">-  if (!utils) {</span>
<a href="#l82.786"></a><span id="l82.786" class="difflineminus">-    return false;</span>
<a href="#l82.787"></a><span id="l82.787" class="difflineminus">-  }</span>
<a href="#l82.788"></a><span id="l82.788" class="difflineminus">-</span>
<a href="#l82.789"></a><span id="l82.789" class="difflineminus">-  return utils.sendSelectionSetEvent(aOffset, aLength, aReverse);</span>
<a href="#l82.790"></a><span id="l82.790" class="difflineminus">-}</span>
<a href="#l82.791"></a><span id="l82.791" class="difflineminus">-</span>
<a href="#l82.792"></a><span id="l82.792" class="difflineminus">-/**</span>
<a href="#l82.793"></a><span id="l82.793">  * The functions that follow were copied from</span>
<a href="#l82.794"></a><span id="l82.794">  * mozilla-central/testing/mochitest/tests/SimpleTest/EventUtils.js</span>
<a href="#l82.795"></a><span id="l82.795">  */</span>
<a href="#l82.796"></a><span id="l82.796"> </span>
<a href="#l82.797"></a><span id="l82.797"> var TIPMap = new WeakMap();</span>
<a href="#l82.798"></a><span id="l82.798"> </span>
<a href="#l82.799"></a><span id="l82.799" class="difflineminus">-function _getTIP(aWindow, aCallback)</span>
<a href="#l82.800"></a><span id="l82.800" class="difflineminus">-{</span>
<a href="#l82.801"></a><span id="l82.801" class="difflineminus">-  if (!aWindow) {</span>
<a href="#l82.802"></a><span id="l82.802" class="difflineminus">-    aWindow = window;</span>
<a href="#l82.803"></a><span id="l82.803" class="difflineminus">-  }</span>
<a href="#l82.804"></a><span id="l82.804" class="difflineplus">+function _getTIP(aWindow, aCallback) {</span>
<a href="#l82.805"></a><span id="l82.805">   var tip;</span>
<a href="#l82.806"></a><span id="l82.806">   if (TIPMap.has(aWindow)) {</span>
<a href="#l82.807"></a><span id="l82.807">     tip = TIPMap.get(aWindow);</span>
<a href="#l82.808"></a><span id="l82.808">   } else {</span>
<a href="#l82.809"></a><span id="l82.809">     tip =</span>
<a href="#l82.810"></a><span id="l82.810">       Cc[&quot;@mozilla.org/text-input-processor;1&quot;].</span>
<a href="#l82.811"></a><span id="l82.811">         createInstance(Ci.nsITextInputProcessor);</span>
<a href="#l82.812"></a><span id="l82.812">     TIPMap.set(aWindow, tip);</span>
<a href="#l82.813"></a><span id="l82.813">   }</span>
<a href="#l82.814"></a><span id="l82.814">   if (!tip.beginInputTransactionForTests(aWindow, aCallback)) {</span>
<a href="#l82.815"></a><span id="l82.815">     tip = null;</span>
<a href="#l82.816"></a><span id="l82.816">     TIPMap.delete(aWindow);</span>
<a href="#l82.817"></a><span id="l82.817">   }</span>
<a href="#l82.818"></a><span id="l82.818">   return tip;</span>
<a href="#l82.819"></a><span id="l82.819"> }</span>
<a href="#l82.820"></a><span id="l82.820"> </span>
<a href="#l82.821"></a><span id="l82.821" class="difflineminus">-function _getKeyboardEvent(aWindow)</span>
<a href="#l82.822"></a><span id="l82.822" class="difflineminus">-{</span>
<a href="#l82.823"></a><span id="l82.823" class="difflineplus">+function _getKeyboardEvent(aWindow) {</span>
<a href="#l82.824"></a><span id="l82.824">   if (typeof KeyboardEvent != &quot;undefined&quot;) {</span>
<a href="#l82.825"></a><span id="l82.825">     try {</span>
<a href="#l82.826"></a><span id="l82.826">       // See if the object can be instantiated; sometimes this yields</span>
<a href="#l82.827"></a><span id="l82.827">       // 'TypeError: can't access dead object' or 'KeyboardEvent is not a constructor'.</span>
<a href="#l82.828"></a><span id="l82.828">       new KeyboardEvent(&quot;&quot;, {});</span>
<a href="#l82.829"></a><span id="l82.829">       return KeyboardEvent;</span>
<a href="#l82.830"></a><span id="l82.830">     } catch (ex) {}</span>
<a href="#l82.831"></a><span id="l82.831">   }</span>
<a href="#l82.832"></a><span id="l82.832" class="difflineminus">-  if (typeof content != &quot;undefined&quot; &amp;&amp; (&quot;KeyboardEvent&quot; in content)) {</span>
<a href="#l82.833"></a><span id="l82.833" class="difflineminus">-    return content.KeyboardEvent;</span>
<a href="#l82.834"></a><span id="l82.834" class="difflineminus">-  }</span>
<a href="#l82.835"></a><span id="l82.835">   return aWindow.KeyboardEvent;</span>
<a href="#l82.836"></a><span id="l82.836"> }</span>
<a href="#l82.837"></a><span id="l82.837"> </span>
<a href="#l82.838"></a><span id="l82.838" class="difflineminus">-function _getNavigator(aWindow)</span>
<a href="#l82.839"></a><span id="l82.839" class="difflineminus">-{</span>
<a href="#l82.840"></a><span id="l82.840" class="difflineminus">-  if (typeof navigator != &quot;undefined&quot;) {</span>
<a href="#l82.841"></a><span id="l82.841" class="difflineminus">-    return navigator;</span>
<a href="#l82.842"></a><span id="l82.842" class="difflineminus">-  }</span>
<a href="#l82.843"></a><span id="l82.843" class="difflineminus">-  return aWindow.navigator;</span>
<a href="#l82.844"></a><span id="l82.844" class="difflineminus">-}</span>
<a href="#l82.845"></a><span id="l82.845" class="difflineminus">-</span>
<a href="#l82.846"></a><span id="l82.846" class="difflineminus">-function _guessKeyNameFromKeyCode(aKeyCode, aWindow)</span>
<a href="#l82.847"></a><span id="l82.847" class="difflineminus">-{</span>
<a href="#l82.848"></a><span id="l82.848" class="difflineplus">+/* eslint-disable complexity */</span>
<a href="#l82.849"></a><span id="l82.849" class="difflineplus">+function _guessKeyNameFromKeyCode(aKeyCode, aWindow) {</span>
<a href="#l82.850"></a><span id="l82.850">   var KeyboardEvent = _getKeyboardEvent(aWindow);</span>
<a href="#l82.851"></a><span id="l82.851">   switch (aKeyCode) {</span>
<a href="#l82.852"></a><span id="l82.852">     case KeyboardEvent.DOM_VK_CANCEL:</span>
<a href="#l82.853"></a><span id="l82.853">       return &quot;Cancel&quot;;</span>
<a href="#l82.854"></a><span id="l82.854">     case KeyboardEvent.DOM_VK_HELP:</span>
<a href="#l82.855"></a><span id="l82.855">       return &quot;Help&quot;;</span>
<a href="#l82.856"></a><span id="l82.856">     case KeyboardEvent.DOM_VK_BACK_SPACE:</span>
<a href="#l82.857"></a><span id="l82.857">       return &quot;Backspace&quot;;</span>
<a href="#l82.858"></a><span id="l82.858" class="difflineat">@@ -1035,16 +431,17 @@ function _guessKeyNameFromKeyCode(aKeyCo</span>
<a href="#l82.859"></a><span id="l82.859">     case KeyboardEvent.DOM_VK_EREOF:</span>
<a href="#l82.860"></a><span id="l82.860">       return &quot;EraseEof&quot;;</span>
<a href="#l82.861"></a><span id="l82.861">     case KeyboardEvent.DOM_VK_PLAY:</span>
<a href="#l82.862"></a><span id="l82.862">       return &quot;Play&quot;;</span>
<a href="#l82.863"></a><span id="l82.863">     default:</span>
<a href="#l82.864"></a><span id="l82.864">       return &quot;Unidentified&quot;;</span>
<a href="#l82.865"></a><span id="l82.865">   }</span>
<a href="#l82.866"></a><span id="l82.866"> }</span>
<a href="#l82.867"></a><span id="l82.867" class="difflineplus">+/* eslint-enable complexity */</span>
<a href="#l82.868"></a><span id="l82.868"> </span>
<a href="#l82.869"></a><span id="l82.869"> function _createKeyboardEventDictionary(aKey, aKeyEvent, aWindow) {</span>
<a href="#l82.870"></a><span id="l82.870">   var result = { dictionary: null, flags: 0 };</span>
<a href="#l82.871"></a><span id="l82.871">   var keyCodeIsDefined = &quot;keyCode&quot; in aKeyEvent;</span>
<a href="#l82.872"></a><span id="l82.872">   var keyCode =</span>
<a href="#l82.873"></a><span id="l82.873">     (keyCodeIsDefined &amp;&amp; aKeyEvent.keyCode &gt;= 0 &amp;&amp; aKeyEvent.keyCode &lt;= 255) ?</span>
<a href="#l82.874"></a><span id="l82.874">       aKeyEvent.keyCode : 0;</span>
<a href="#l82.875"></a><span id="l82.875">   var keyName = &quot;Unidentified&quot;;</span>
<a href="#l82.876"></a><span id="l82.876" class="difflineat">@@ -1072,179 +469,177 @@ function _createKeyboardEventDictionary(</span>
<a href="#l82.877"></a><span id="l82.877">   if (locationIsDefined &amp;&amp; aKeyEvent.location === 0) {</span>
<a href="#l82.878"></a><span id="l82.878">     result.flags |= Ci.nsITextInputProcessor.KEY_KEEP_KEY_LOCATION_STANDARD;</span>
<a href="#l82.879"></a><span id="l82.879">   }</span>
<a href="#l82.880"></a><span id="l82.880">   result.dictionary = {</span>
<a href="#l82.881"></a><span id="l82.881">     key: keyName,</span>
<a href="#l82.882"></a><span id="l82.882">     code: &quot;code&quot; in aKeyEvent ? aKeyEvent.code : &quot;&quot;,</span>
<a href="#l82.883"></a><span id="l82.883">     location: locationIsDefined ? aKeyEvent.location : 0,</span>
<a href="#l82.884"></a><span id="l82.884">     repeat: &quot;repeat&quot; in aKeyEvent ? aKeyEvent.repeat === true : false,</span>
<a href="#l82.885"></a><span id="l82.885" class="difflineminus">-    keyCode: keyCode,</span>
<a href="#l82.886"></a><span id="l82.886" class="difflineplus">+    keyCode,</span>
<a href="#l82.887"></a><span id="l82.887">   };</span>
<a href="#l82.888"></a><span id="l82.888">   return result;</span>
<a href="#l82.889"></a><span id="l82.889"> }</span>
<a href="#l82.890"></a><span id="l82.890"> </span>
<a href="#l82.891"></a><span id="l82.891" class="difflineminus">-function _emulateToActivateModifiers(aTIP, aKeyEvent, aWindow)</span>
<a href="#l82.892"></a><span id="l82.892" class="difflineminus">-{</span>
<a href="#l82.893"></a><span id="l82.893" class="difflineplus">+function _emulateToActivateModifiers(aTIP, aKeyEvent, aWindow) {</span>
<a href="#l82.894"></a><span id="l82.894">   if (!aKeyEvent) {</span>
<a href="#l82.895"></a><span id="l82.895">     return null;</span>
<a href="#l82.896"></a><span id="l82.896">   }</span>
<a href="#l82.897"></a><span id="l82.897">   var KeyboardEvent = _getKeyboardEvent(aWindow);</span>
<a href="#l82.898"></a><span id="l82.898" class="difflineminus">-  var navigator = _getNavigator(aWindow);</span>
<a href="#l82.899"></a><span id="l82.899"> </span>
<a href="#l82.900"></a><span id="l82.900">   var modifiers = {</span>
<a href="#l82.901"></a><span id="l82.901">     normal: [</span>
<a href="#l82.902"></a><span id="l82.902">       { key: &quot;Alt&quot;,        attr: &quot;altKey&quot; },</span>
<a href="#l82.903"></a><span id="l82.903">       { key: &quot;AltGraph&quot;,   attr: &quot;altGraphKey&quot; },</span>
<a href="#l82.904"></a><span id="l82.904">       { key: &quot;Control&quot;,    attr: &quot;ctrlKey&quot; },</span>
<a href="#l82.905"></a><span id="l82.905">       { key: &quot;Fn&quot;,         attr: &quot;fnKey&quot; },</span>
<a href="#l82.906"></a><span id="l82.906">       { key: &quot;Meta&quot;,       attr: &quot;metaKey&quot; },</span>
<a href="#l82.907"></a><span id="l82.907">       { key: &quot;OS&quot;,         attr: &quot;osKey&quot; },</span>
<a href="#l82.908"></a><span id="l82.908">       { key: &quot;Shift&quot;,      attr: &quot;shiftKey&quot; },</span>
<a href="#l82.909"></a><span id="l82.909">       { key: &quot;Symbol&quot;,     attr: &quot;symbolKey&quot; },</span>
<a href="#l82.910"></a><span id="l82.910" class="difflineminus">-      { key: aWindow.navigator.platform.indexOf(&quot;Mac&quot;) &gt;= 0 ? &quot;Meta&quot; : &quot;Control&quot;,</span>
<a href="#l82.911"></a><span id="l82.911" class="difflineplus">+      { key: aWindow.navigator.platform.includes(&quot;Mac&quot;) ? &quot;Meta&quot; : &quot;Control&quot;,</span>
<a href="#l82.912"></a><span id="l82.912">                            attr: &quot;accelKey&quot; },</span>
<a href="#l82.913"></a><span id="l82.913">     ],</span>
<a href="#l82.914"></a><span id="l82.914">     lockable: [</span>
<a href="#l82.915"></a><span id="l82.915">       { key: &quot;CapsLock&quot;,   attr: &quot;capsLockKey&quot; },</span>
<a href="#l82.916"></a><span id="l82.916">       { key: &quot;FnLock&quot;,     attr: &quot;fnLockKey&quot; },</span>
<a href="#l82.917"></a><span id="l82.917">       { key: &quot;NumLock&quot;,    attr: &quot;numLockKey&quot; },</span>
<a href="#l82.918"></a><span id="l82.918">       { key: &quot;ScrollLock&quot;, attr: &quot;scrollLockKey&quot; },</span>
<a href="#l82.919"></a><span id="l82.919">       { key: &quot;SymbolLock&quot;, attr: &quot;symbolLockKey&quot; },</span>
<a href="#l82.920"></a><span id="l82.920" class="difflineminus">-    ]</span>
<a href="#l82.921"></a><span id="l82.921" class="difflineminus">-  }</span>
<a href="#l82.922"></a><span id="l82.922" class="difflineplus">+    ],</span>
<a href="#l82.923"></a><span id="l82.923" class="difflineplus">+  };</span>
<a href="#l82.924"></a><span id="l82.924"> </span>
<a href="#l82.925"></a><span id="l82.925" class="difflineminus">-  for (var i = 0; i &lt; modifiers.normal.length; i++) {</span>
<a href="#l82.926"></a><span id="l82.926" class="difflineplus">+  for (let i = 0; i &lt; modifiers.normal.length; i++) {</span>
<a href="#l82.927"></a><span id="l82.927">     if (!aKeyEvent[modifiers.normal[i].attr]) {</span>
<a href="#l82.928"></a><span id="l82.928">       continue;</span>
<a href="#l82.929"></a><span id="l82.929">     }</span>
<a href="#l82.930"></a><span id="l82.930">     if (aTIP.getModifierState(modifiers.normal[i].key)) {</span>
<a href="#l82.931"></a><span id="l82.931">       continue; // already activated.</span>
<a href="#l82.932"></a><span id="l82.932">     }</span>
<a href="#l82.933"></a><span id="l82.933" class="difflineminus">-    var event = new KeyboardEvent(&quot;&quot;, { key: modifiers.normal[i].key });</span>
<a href="#l82.934"></a><span id="l82.934" class="difflineplus">+    let event = new KeyboardEvent(&quot;&quot;, { key: modifiers.normal[i].key });</span>
<a href="#l82.935"></a><span id="l82.935">     aTIP.keydown(event,</span>
<a href="#l82.936"></a><span id="l82.936">       aTIP.KEY_NON_PRINTABLE_KEY | aTIP.KEY_DONT_DISPATCH_MODIFIER_KEY_EVENT);</span>
<a href="#l82.937"></a><span id="l82.937">     modifiers.normal[i].activated = true;</span>
<a href="#l82.938"></a><span id="l82.938">   }</span>
<a href="#l82.939"></a><span id="l82.939" class="difflineminus">-  for (var i = 0; i &lt; modifiers.lockable.length; i++) {</span>
<a href="#l82.940"></a><span id="l82.940" class="difflineplus">+  for (let i = 0; i &lt; modifiers.lockable.length; i++) {</span>
<a href="#l82.941"></a><span id="l82.941">     if (!aKeyEvent[modifiers.lockable[i].attr]) {</span>
<a href="#l82.942"></a><span id="l82.942">       continue;</span>
<a href="#l82.943"></a><span id="l82.943">     }</span>
<a href="#l82.944"></a><span id="l82.944">     if (aTIP.getModifierState(modifiers.lockable[i].key)) {</span>
<a href="#l82.945"></a><span id="l82.945">       continue; // already activated.</span>
<a href="#l82.946"></a><span id="l82.946">     }</span>
<a href="#l82.947"></a><span id="l82.947" class="difflineminus">-    var event = new KeyboardEvent(&quot;&quot;, { key: modifiers.lockable[i].key });</span>
<a href="#l82.948"></a><span id="l82.948" class="difflineplus">+    let event = new KeyboardEvent(&quot;&quot;, { key: modifiers.lockable[i].key });</span>
<a href="#l82.949"></a><span id="l82.949">     aTIP.keydown(event,</span>
<a href="#l82.950"></a><span id="l82.950">       aTIP.KEY_NON_PRINTABLE_KEY | aTIP.KEY_DONT_DISPATCH_MODIFIER_KEY_EVENT);</span>
<a href="#l82.951"></a><span id="l82.951">     aTIP.keyup(event,</span>
<a href="#l82.952"></a><span id="l82.952">       aTIP.KEY_NON_PRINTABLE_KEY | aTIP.KEY_DONT_DISPATCH_MODIFIER_KEY_EVENT);</span>
<a href="#l82.953"></a><span id="l82.953">     modifiers.lockable[i].activated = true;</span>
<a href="#l82.954"></a><span id="l82.954">   }</span>
<a href="#l82.955"></a><span id="l82.955">   return modifiers;</span>
<a href="#l82.956"></a><span id="l82.956"> }</span>
<a href="#l82.957"></a><span id="l82.957"> </span>
<a href="#l82.958"></a><span id="l82.958" class="difflineminus">-function _emulateToInactivateModifiers(aTIP, aModifiers, aWindow)</span>
<a href="#l82.959"></a><span id="l82.959" class="difflineminus">-{</span>
<a href="#l82.960"></a><span id="l82.960" class="difflineplus">+function _emulateToInactivateModifiers(aTIP, aModifiers, aWindow) {</span>
<a href="#l82.961"></a><span id="l82.961">   if (!aModifiers) {</span>
<a href="#l82.962"></a><span id="l82.962">     return;</span>
<a href="#l82.963"></a><span id="l82.963">   }</span>
<a href="#l82.964"></a><span id="l82.964">   var KeyboardEvent = _getKeyboardEvent(aWindow);</span>
<a href="#l82.965"></a><span id="l82.965" class="difflineminus">-  for (var i = 0; i &lt; aModifiers.normal.length; i++) {</span>
<a href="#l82.966"></a><span id="l82.966" class="difflineplus">+  for (let i = 0; i &lt; aModifiers.normal.length; i++) {</span>
<a href="#l82.967"></a><span id="l82.967">     if (!aModifiers.normal[i].activated) {</span>
<a href="#l82.968"></a><span id="l82.968">       continue;</span>
<a href="#l82.969"></a><span id="l82.969">     }</span>
<a href="#l82.970"></a><span id="l82.970" class="difflineminus">-    var event = new KeyboardEvent(&quot;&quot;, { key: aModifiers.normal[i].key });</span>
<a href="#l82.971"></a><span id="l82.971" class="difflineplus">+    let event = new KeyboardEvent(&quot;&quot;, { key: aModifiers.normal[i].key });</span>
<a href="#l82.972"></a><span id="l82.972">     aTIP.keyup(event,</span>
<a href="#l82.973"></a><span id="l82.973">       aTIP.KEY_NON_PRINTABLE_KEY | aTIP.KEY_DONT_DISPATCH_MODIFIER_KEY_EVENT);</span>
<a href="#l82.974"></a><span id="l82.974">   }</span>
<a href="#l82.975"></a><span id="l82.975" class="difflineminus">-  for (var i = 0; i &lt; aModifiers.lockable.length; i++) {</span>
<a href="#l82.976"></a><span id="l82.976" class="difflineplus">+  for (let i = 0; i &lt; aModifiers.lockable.length; i++) {</span>
<a href="#l82.977"></a><span id="l82.977">     if (!aModifiers.lockable[i].activated) {</span>
<a href="#l82.978"></a><span id="l82.978">       continue;</span>
<a href="#l82.979"></a><span id="l82.979">     }</span>
<a href="#l82.980"></a><span id="l82.980">     if (!aTIP.getModifierState(aModifiers.lockable[i].key)) {</span>
<a href="#l82.981"></a><span id="l82.981">       continue; // who already inactivated this?</span>
<a href="#l82.982"></a><span id="l82.982">     }</span>
<a href="#l82.983"></a><span id="l82.983" class="difflineminus">-    var event = new KeyboardEvent(&quot;&quot;, { key: aModifiers.lockable[i].key });</span>
<a href="#l82.984"></a><span id="l82.984" class="difflineplus">+    let event = new KeyboardEvent(&quot;&quot;, { key: aModifiers.lockable[i].key });</span>
<a href="#l82.985"></a><span id="l82.985">     aTIP.keydown(event,</span>
<a href="#l82.986"></a><span id="l82.986">       aTIP.KEY_NON_PRINTABLE_KEY | aTIP.KEY_DONT_DISPATCH_MODIFIER_KEY_EVENT);</span>
<a href="#l82.987"></a><span id="l82.987">     aTIP.keyup(event,</span>
<a href="#l82.988"></a><span id="l82.988">       aTIP.KEY_NON_PRINTABLE_KEY | aTIP.KEY_DONT_DISPATCH_MODIFIER_KEY_EVENT);</span>
<a href="#l82.989"></a><span id="l82.989">   }</span>
<a href="#l82.990"></a><span id="l82.990"> }</span>
<a href="#l82.991"></a><span id="l82.991"> </span>
<a href="#l82.992"></a><span id="l82.992" class="difflineminus">-function _computeKeyCodeFromChar(aChar, aWindow)</span>
<a href="#l82.993"></a><span id="l82.993" class="difflineminus">-{</span>
<a href="#l82.994"></a><span id="l82.994" class="difflineplus">+/* eslint-disable complexity */</span>
<a href="#l82.995"></a><span id="l82.995" class="difflineplus">+function _computeKeyCodeFromChar(aChar, aWindow) {</span>
<a href="#l82.996"></a><span id="l82.996">   if (aChar.length != 1) {</span>
<a href="#l82.997"></a><span id="l82.997">     return 0;</span>
<a href="#l82.998"></a><span id="l82.998">   }</span>
<a href="#l82.999"></a><span id="l82.999">   var KeyEvent = _getKeyboardEvent(aWindow);</span>
<a href="#l82.1000"></a><span id="l82.1000" class="difflineminus">-  if (aChar &gt;= 'a' &amp;&amp; aChar &lt;= 'z') {</span>
<a href="#l82.1001"></a><span id="l82.1001" class="difflineminus">-    return KeyEvent.DOM_VK_A + aChar.charCodeAt(0) - 'a'.charCodeAt(0);</span>
<a href="#l82.1002"></a><span id="l82.1002" class="difflineplus">+  if (aChar &gt;= &quot;a&quot; &amp;&amp; aChar &lt;= &quot;z&quot;) {</span>
<a href="#l82.1003"></a><span id="l82.1003" class="difflineplus">+    return KeyEvent.DOM_VK_A + aChar.charCodeAt(0) - &quot;a&quot;.charCodeAt(0);</span>
<a href="#l82.1004"></a><span id="l82.1004">   }</span>
<a href="#l82.1005"></a><span id="l82.1005" class="difflineminus">-  if (aChar &gt;= 'A' &amp;&amp; aChar &lt;= 'Z') {</span>
<a href="#l82.1006"></a><span id="l82.1006" class="difflineminus">-    return KeyEvent.DOM_VK_A + aChar.charCodeAt(0) - 'A'.charCodeAt(0);</span>
<a href="#l82.1007"></a><span id="l82.1007" class="difflineplus">+  if (aChar &gt;= &quot;A&quot; &amp;&amp; aChar &lt;= &quot;Z&quot;) {</span>
<a href="#l82.1008"></a><span id="l82.1008" class="difflineplus">+    return KeyEvent.DOM_VK_A + aChar.charCodeAt(0) - &quot;A&quot;.charCodeAt(0);</span>
<a href="#l82.1009"></a><span id="l82.1009">   }</span>
<a href="#l82.1010"></a><span id="l82.1010" class="difflineminus">-  if (aChar &gt;= '0' &amp;&amp; aChar &lt;= '9') {</span>
<a href="#l82.1011"></a><span id="l82.1011" class="difflineminus">-    return KeyEvent.DOM_VK_0 + aChar.charCodeAt(0) - '0'.charCodeAt(0);</span>
<a href="#l82.1012"></a><span id="l82.1012" class="difflineplus">+  if (aChar &gt;= &quot;0&quot; &amp;&amp; aChar &lt;= &quot;9&quot;) {</span>
<a href="#l82.1013"></a><span id="l82.1013" class="difflineplus">+    return KeyEvent.DOM_VK_0 + aChar.charCodeAt(0) - &quot;0&quot;.charCodeAt(0);</span>
<a href="#l82.1014"></a><span id="l82.1014">   }</span>
<a href="#l82.1015"></a><span id="l82.1015">   // returns US keyboard layout's keycode</span>
<a href="#l82.1016"></a><span id="l82.1016">   switch (aChar) {</span>
<a href="#l82.1017"></a><span id="l82.1017" class="difflineminus">-    case '~':</span>
<a href="#l82.1018"></a><span id="l82.1018" class="difflineminus">-    case '`':</span>
<a href="#l82.1019"></a><span id="l82.1019" class="difflineplus">+    case &quot;~&quot;:</span>
<a href="#l82.1020"></a><span id="l82.1020" class="difflineplus">+    case &quot;`&quot;:</span>
<a href="#l82.1021"></a><span id="l82.1021">       return KeyEvent.DOM_VK_BACK_QUOTE;</span>
<a href="#l82.1022"></a><span id="l82.1022" class="difflineminus">-    case '!':</span>
<a href="#l82.1023"></a><span id="l82.1023" class="difflineplus">+    case &quot;!&quot;:</span>
<a href="#l82.1024"></a><span id="l82.1024">       return KeyEvent.DOM_VK_1;</span>
<a href="#l82.1025"></a><span id="l82.1025" class="difflineminus">-    case '@':</span>
<a href="#l82.1026"></a><span id="l82.1026" class="difflineplus">+    case &quot;@&quot;:</span>
<a href="#l82.1027"></a><span id="l82.1027">       return KeyEvent.DOM_VK_2;</span>
<a href="#l82.1028"></a><span id="l82.1028" class="difflineminus">-    case '#':</span>
<a href="#l82.1029"></a><span id="l82.1029" class="difflineplus">+    case &quot;#&quot;:</span>
<a href="#l82.1030"></a><span id="l82.1030">       return KeyEvent.DOM_VK_3;</span>
<a href="#l82.1031"></a><span id="l82.1031" class="difflineminus">-    case '$':</span>
<a href="#l82.1032"></a><span id="l82.1032" class="difflineplus">+    case &quot;$&quot;:</span>
<a href="#l82.1033"></a><span id="l82.1033">       return KeyEvent.DOM_VK_4;</span>
<a href="#l82.1034"></a><span id="l82.1034" class="difflineminus">-    case '%':</span>
<a href="#l82.1035"></a><span id="l82.1035" class="difflineplus">+    case &quot;%&quot;:</span>
<a href="#l82.1036"></a><span id="l82.1036">       return KeyEvent.DOM_VK_5;</span>
<a href="#l82.1037"></a><span id="l82.1037" class="difflineminus">-    case '^':</span>
<a href="#l82.1038"></a><span id="l82.1038" class="difflineplus">+    case &quot;^&quot;:</span>
<a href="#l82.1039"></a><span id="l82.1039">       return KeyEvent.DOM_VK_6;</span>
<a href="#l82.1040"></a><span id="l82.1040" class="difflineminus">-    case '&amp;':</span>
<a href="#l82.1041"></a><span id="l82.1041" class="difflineplus">+    case &quot;&amp;&quot;:</span>
<a href="#l82.1042"></a><span id="l82.1042">       return KeyEvent.DOM_VK_7;</span>
<a href="#l82.1043"></a><span id="l82.1043" class="difflineminus">-    case '*':</span>
<a href="#l82.1044"></a><span id="l82.1044" class="difflineplus">+    case &quot;*&quot;:</span>
<a href="#l82.1045"></a><span id="l82.1045">       return KeyEvent.DOM_VK_8;</span>
<a href="#l82.1046"></a><span id="l82.1046" class="difflineminus">-    case '(':</span>
<a href="#l82.1047"></a><span id="l82.1047" class="difflineplus">+    case &quot;(&quot;:</span>
<a href="#l82.1048"></a><span id="l82.1048">       return KeyEvent.DOM_VK_9;</span>
<a href="#l82.1049"></a><span id="l82.1049" class="difflineminus">-    case ')':</span>
<a href="#l82.1050"></a><span id="l82.1050" class="difflineplus">+    case &quot;)&quot;:</span>
<a href="#l82.1051"></a><span id="l82.1051">       return KeyEvent.DOM_VK_0;</span>
<a href="#l82.1052"></a><span id="l82.1052" class="difflineminus">-    case '-':</span>
<a href="#l82.1053"></a><span id="l82.1053" class="difflineminus">-    case '_':</span>
<a href="#l82.1054"></a><span id="l82.1054" class="difflineplus">+    case &quot;-&quot;:</span>
<a href="#l82.1055"></a><span id="l82.1055" class="difflineplus">+    case &quot;_&quot;:</span>
<a href="#l82.1056"></a><span id="l82.1056">       return KeyEvent.DOM_VK_SUBTRACT;</span>
<a href="#l82.1057"></a><span id="l82.1057" class="difflineminus">-    case '+':</span>
<a href="#l82.1058"></a><span id="l82.1058" class="difflineminus">-    case '=':</span>
<a href="#l82.1059"></a><span id="l82.1059" class="difflineplus">+    case &quot;+&quot;:</span>
<a href="#l82.1060"></a><span id="l82.1060" class="difflineplus">+    case &quot;=&quot;:</span>
<a href="#l82.1061"></a><span id="l82.1061">       return KeyEvent.DOM_VK_EQUALS;</span>
<a href="#l82.1062"></a><span id="l82.1062" class="difflineminus">-    case '{':</span>
<a href="#l82.1063"></a><span id="l82.1063" class="difflineminus">-    case '[':</span>
<a href="#l82.1064"></a><span id="l82.1064" class="difflineplus">+    case &quot;{&quot;:</span>
<a href="#l82.1065"></a><span id="l82.1065" class="difflineplus">+    case &quot;[&quot;:</span>
<a href="#l82.1066"></a><span id="l82.1066">       return KeyEvent.DOM_VK_OPEN_BRACKET;</span>
<a href="#l82.1067"></a><span id="l82.1067" class="difflineminus">-    case '}':</span>
<a href="#l82.1068"></a><span id="l82.1068" class="difflineminus">-    case ']':</span>
<a href="#l82.1069"></a><span id="l82.1069" class="difflineplus">+    case &quot;}&quot;:</span>
<a href="#l82.1070"></a><span id="l82.1070" class="difflineplus">+    case &quot;]&quot;:</span>
<a href="#l82.1071"></a><span id="l82.1071">       return KeyEvent.DOM_VK_CLOSE_BRACKET;</span>
<a href="#l82.1072"></a><span id="l82.1072" class="difflineminus">-    case '|':</span>
<a href="#l82.1073"></a><span id="l82.1073" class="difflineminus">-    case '\\':</span>
<a href="#l82.1074"></a><span id="l82.1074" class="difflineplus">+    case &quot;|&quot;:</span>
<a href="#l82.1075"></a><span id="l82.1075" class="difflineplus">+    case &quot;\\&quot;:</span>
<a href="#l82.1076"></a><span id="l82.1076">       return KeyEvent.DOM_VK_BACK_SLASH;</span>
<a href="#l82.1077"></a><span id="l82.1077" class="difflineminus">-    case ':':</span>
<a href="#l82.1078"></a><span id="l82.1078" class="difflineminus">-    case ';':</span>
<a href="#l82.1079"></a><span id="l82.1079" class="difflineplus">+    case &quot;:&quot;:</span>
<a href="#l82.1080"></a><span id="l82.1080" class="difflineplus">+    case &quot;;&quot;:</span>
<a href="#l82.1081"></a><span id="l82.1081">       return KeyEvent.DOM_VK_SEMICOLON;</span>
<a href="#l82.1082"></a><span id="l82.1082" class="difflineminus">-    case '\'':</span>
<a href="#l82.1083"></a><span id="l82.1083" class="difflineplus">+    case &quot;'&quot;:</span>
<a href="#l82.1084"></a><span id="l82.1084">     case '&quot;':</span>
<a href="#l82.1085"></a><span id="l82.1085">       return KeyEvent.DOM_VK_QUOTE;</span>
<a href="#l82.1086"></a><span id="l82.1086" class="difflineminus">-    case '&lt;':</span>
<a href="#l82.1087"></a><span id="l82.1087" class="difflineminus">-    case ',':</span>
<a href="#l82.1088"></a><span id="l82.1088" class="difflineplus">+    case &quot;&lt;&quot;:</span>
<a href="#l82.1089"></a><span id="l82.1089" class="difflineplus">+    case &quot;,&quot;:</span>
<a href="#l82.1090"></a><span id="l82.1090">       return KeyEvent.DOM_VK_COMMA;</span>
<a href="#l82.1091"></a><span id="l82.1091" class="difflineminus">-    case '&gt;':</span>
<a href="#l82.1092"></a><span id="l82.1092" class="difflineminus">-    case '.':</span>
<a href="#l82.1093"></a><span id="l82.1093" class="difflineplus">+    case &quot;&gt;&quot;:</span>
<a href="#l82.1094"></a><span id="l82.1094" class="difflineplus">+    case &quot;.&quot;:</span>
<a href="#l82.1095"></a><span id="l82.1095">       return KeyEvent.DOM_VK_PERIOD;</span>
<a href="#l82.1096"></a><span id="l82.1096" class="difflineminus">-    case '?':</span>
<a href="#l82.1097"></a><span id="l82.1097" class="difflineminus">-    case '/':</span>
<a href="#l82.1098"></a><span id="l82.1098" class="difflineplus">+    case &quot;?&quot;:</span>
<a href="#l82.1099"></a><span id="l82.1099" class="difflineplus">+    case &quot;/&quot;:</span>
<a href="#l82.1100"></a><span id="l82.1100">       return KeyEvent.DOM_VK_SLASH;</span>
<a href="#l82.1101"></a><span id="l82.1101" class="difflineminus">-    case '\n':</span>
<a href="#l82.1102"></a><span id="l82.1102" class="difflineplus">+    case &quot;\n&quot;:</span>
<a href="#l82.1103"></a><span id="l82.1103">       return KeyEvent.DOM_VK_RETURN;</span>
<a href="#l82.1104"></a><span id="l82.1104" class="difflineminus">-    case ' ':</span>
<a href="#l82.1105"></a><span id="l82.1105" class="difflineplus">+    case &quot; &quot;:</span>
<a href="#l82.1106"></a><span id="l82.1106">       return KeyEvent.DOM_VK_SPACE;</span>
<a href="#l82.1107"></a><span id="l82.1107">     default:</span>
<a href="#l82.1108"></a><span id="l82.1108">       return 0;</span>
<a href="#l82.1109"></a><span id="l82.1109">   }</span>
<a href="#l82.1110"></a><span id="l82.1110"> }</span>
<a href="#l82.1111"></a><span id="l82.1111" class="difflineplus">+/* eslint-enable complexity */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l83.1"></a><span id="l83.1">rename from mail/test/resources/mozmill/mozmill/extension/content/stdlib/arrays.js</span>
<a href="#l83.2"></a><span id="l83.2">rename to mail/test/resources/mozmill/mozmill/extension/content/stdlib/arrays.jsm</span>
<a href="#l83.3"></a><span id="l83.3" class="difflineminus">--- a/mail/test/resources/mozmill/mozmill/extension/content/stdlib/arrays.js</span>
<a href="#l83.4"></a><span id="l83.4" class="difflineplus">+++ b/mail/test/resources/mozmill/mozmill/extension/content/stdlib/arrays.jsm</span>
<a href="#l83.5"></a><span id="l83.5" class="difflineat">@@ -30,62 +30,29 @@</span>
<a href="#l83.6"></a><span id="l83.6"> // use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l83.7"></a><span id="l83.7"> // decision by deleting the provisions above and replace them with the notice</span>
<a href="#l83.8"></a><span id="l83.8"> // and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l83.9"></a><span id="l83.9"> // the provisions above, a recipient may use your version of this file under</span>
<a href="#l83.10"></a><span id="l83.10"> // the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l83.11"></a><span id="l83.11"> //</span>
<a href="#l83.12"></a><span id="l83.12"> // ***** END LICENSE BLOCK *****</span>
<a href="#l83.13"></a><span id="l83.13"> </span>
<a href="#l83.14"></a><span id="l83.14" class="difflineminus">-var EXPORTED_SYMBOLS = ['inArray', 'getSet', 'indexOf', 'rindexOf', 'compare'];</span>
<a href="#l83.15"></a><span id="l83.15" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;getSet&quot;, &quot;compare&quot;];</span>
<a href="#l83.16"></a><span id="l83.16"> </span>
<a href="#l83.17"></a><span id="l83.17" class="difflineminus">-function inArray (array, value) {</span>
<a href="#l83.18"></a><span id="l83.18" class="difflineminus">-  for (var i in array) {</span>
<a href="#l83.19"></a><span id="l83.19" class="difflineminus">-    if (value == array[i]) {</span>
<a href="#l83.20"></a><span id="l83.20" class="difflineminus">-      return true;</span>
<a href="#l83.21"></a><span id="l83.21" class="difflineminus">-    }</span>
<a href="#l83.22"></a><span id="l83.22" class="difflineminus">-  }</span>
<a href="#l83.23"></a><span id="l83.23" class="difflineminus">-  return false;</span>
<a href="#l83.24"></a><span id="l83.24" class="difflineminus">-}</span>
<a href="#l83.25"></a><span id="l83.25" class="difflineminus">-</span>
<a href="#l83.26"></a><span id="l83.26" class="difflineminus">-function getSet (array) {</span>
<a href="#l83.27"></a><span id="l83.27" class="difflineplus">+function getSet(array) {</span>
<a href="#l83.28"></a><span id="l83.28">   var narray = [];</span>
<a href="#l83.29"></a><span id="l83.29">   for (var i in array) {</span>
<a href="#l83.30"></a><span id="l83.30" class="difflineminus">-    if ( !inArray(narray, array[i]) ) {</span>
<a href="#l83.31"></a><span id="l83.31" class="difflineplus">+    if (!narray.includes(array[i])) {</span>
<a href="#l83.32"></a><span id="l83.32">       narray.push(array[i]);</span>
<a href="#l83.33"></a><span id="l83.33">     }</span>
<a href="#l83.34"></a><span id="l83.34">   }</span>
<a href="#l83.35"></a><span id="l83.35">   return narray;</span>
<a href="#l83.36"></a><span id="l83.36"> }</span>
<a href="#l83.37"></a><span id="l83.37"> </span>
<a href="#l83.38"></a><span id="l83.38" class="difflineminus">-function indexOf (array, v, offset) {</span>
<a href="#l83.39"></a><span id="l83.39" class="difflineminus">-  for (var i in array) {</span>
<a href="#l83.40"></a><span id="l83.40" class="difflineminus">-    if (offset == undefined || i &gt;= offset) {</span>
<a href="#l83.41"></a><span id="l83.41" class="difflineminus">-      if ( !isNaN(i) &amp;&amp; array[i] == v) {</span>
<a href="#l83.42"></a><span id="l83.42" class="difflineminus">-        return new Number(i);</span>
<a href="#l83.43"></a><span id="l83.43" class="difflineminus">-      }</span>
<a href="#l83.44"></a><span id="l83.44" class="difflineminus">-    }</span>
<a href="#l83.45"></a><span id="l83.45" class="difflineminus">-  }</span>
<a href="#l83.46"></a><span id="l83.46" class="difflineminus">-  return -1;</span>
<a href="#l83.47"></a><span id="l83.47" class="difflineminus">-}</span>
<a href="#l83.48"></a><span id="l83.48" class="difflineminus">-</span>
<a href="#l83.49"></a><span id="l83.49" class="difflineminus">-function rindexOf (array, v) {</span>
<a href="#l83.50"></a><span id="l83.50" class="difflineminus">-  var l = array.length - 1;</span>
<a href="#l83.51"></a><span id="l83.51" class="difflineminus">-  for (var i in array) {</span>
<a href="#l83.52"></a><span id="l83.52" class="difflineminus">-    if (!isNaN(i)) {</span>
<a href="#l83.53"></a><span id="l83.53" class="difflineminus">-      i = new Number(i);</span>
<a href="#l83.54"></a><span id="l83.54" class="difflineminus">-    }</span>
<a href="#l83.55"></a><span id="l83.55" class="difflineminus">-    if (!isNaN(i) &amp;&amp; array[l - i] == v) {</span>
<a href="#l83.56"></a><span id="l83.56" class="difflineminus">-      return l - i;</span>
<a href="#l83.57"></a><span id="l83.57" class="difflineminus">-    }</span>
<a href="#l83.58"></a><span id="l83.58" class="difflineminus">-  }</span>
<a href="#l83.59"></a><span id="l83.59" class="difflineminus">-  return -1;</span>
<a href="#l83.60"></a><span id="l83.60" class="difflineminus">-}</span>
<a href="#l83.61"></a><span id="l83.61" class="difflineminus">-</span>
<a href="#l83.62"></a><span id="l83.62" class="difflineminus">-function compare (array, carray) {</span>
<a href="#l83.63"></a><span id="l83.63" class="difflineplus">+function compare(array, carray) {</span>
<a href="#l83.64"></a><span id="l83.64">   if (array.length != carray.length) {</span>
<a href="#l83.65"></a><span id="l83.65">     return false;</span>
<a href="#l83.66"></a><span id="l83.66">   }</span>
<a href="#l83.67"></a><span id="l83.67">   for (var i in array) {</span>
<a href="#l83.68"></a><span id="l83.68">     if (array[i] != carray[i]) {</span>
<a href="#l83.69"></a><span id="l83.69">       return false;</span>
<a href="#l83.70"></a><span id="l83.70">     }</span>
<a href="#l83.71"></a><span id="l83.71">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l84.1"></a><span id="l84.1">rename from mail/test/resources/mozmill/mozmill/extension/content/stdlib/dom.js</span>
<a href="#l84.2"></a><span id="l84.2">rename to mail/test/resources/mozmill/mozmill/extension/content/stdlib/dom.jsm</span>
<a href="#l84.3"></a><span id="l84.3" class="difflineminus">--- a/mail/test/resources/mozmill/mozmill/extension/content/stdlib/dom.js</span>
<a href="#l84.4"></a><span id="l84.4" class="difflineplus">+++ b/mail/test/resources/mozmill/mozmill/extension/content/stdlib/dom.jsm</span>
<a href="#l84.5"></a><span id="l84.5" class="difflineat">@@ -30,25 +30,23 @@</span>
<a href="#l84.6"></a><span id="l84.6"> // use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l84.7"></a><span id="l84.7"> // decision by deleting the provisions above and replace them with the notice</span>
<a href="#l84.8"></a><span id="l84.8"> // and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l84.9"></a><span id="l84.9"> // the provisions above, a recipient may use your version of this file under</span>
<a href="#l84.10"></a><span id="l84.10"> // the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l84.11"></a><span id="l84.11"> //</span>
<a href="#l84.12"></a><span id="l84.12"> // ***** END LICENSE BLOCK *****</span>
<a href="#l84.13"></a><span id="l84.13"> </span>
<a href="#l84.14"></a><span id="l84.14" class="difflineminus">-var EXPORTED_SYMBOLS = ['getAttributes'];</span>
<a href="#l84.15"></a><span id="l84.15" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;getAttributes&quot;];</span>
<a href="#l84.16"></a><span id="l84.16"> </span>
<a href="#l84.17"></a><span id="l84.17" class="difflineminus">-</span>
<a href="#l84.18"></a><span id="l84.18" class="difflineminus">-var getAttributes = function (node) {</span>
<a href="#l84.19"></a><span id="l84.19" class="difflineplus">+function getAttributes(node) {</span>
<a href="#l84.20"></a><span id="l84.20">   var attributes = {};</span>
<a href="#l84.21"></a><span id="l84.21">   for (var i in node.attributes) {</span>
<a href="#l84.22"></a><span id="l84.22" class="difflineminus">-    if ( !isNaN(i) ) {</span>
<a href="#l84.23"></a><span id="l84.23" class="difflineplus">+    if (!isNaN(i)) {</span>
<a href="#l84.24"></a><span id="l84.24">       try {</span>
<a href="#l84.25"></a><span id="l84.25">         var attr = node.attributes[i];</span>
<a href="#l84.26"></a><span id="l84.26">         attributes[attr.name] = attr.value;</span>
<a href="#l84.27"></a><span id="l84.27">       } catch (err) {</span>
<a href="#l84.28"></a><span id="l84.28">       }</span>
<a href="#l84.29"></a><span id="l84.29">     }</span>
<a href="#l84.30"></a><span id="l84.30">   }</span>
<a href="#l84.31"></a><span id="l84.31">   return attributes;</span>
<a href="#l84.32"></a><span id="l84.32"> }</span>
<a href="#l84.33"></a><span id="l84.33" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l85.1"></a><span id="l85.1">rename from mail/test/resources/mozmill/mozmill/extension/content/stdlib/httpd.js</span>
<a href="#l85.2"></a><span id="l85.2">rename to mail/test/resources/mozmill/mozmill/extension/content/stdlib/httpd.jsm</span>
<a href="#l85.3"></a><span id="l85.3" class="difflineminus">--- a/mail/test/resources/mozmill/mozmill/extension/content/stdlib/httpd.js</span>
<a href="#l85.4"></a><span id="l85.4" class="difflineplus">+++ b/mail/test/resources/mozmill/mozmill/extension/content/stdlib/httpd.jsm</span>
<a href="#l85.5"></a><span id="l85.5" class="difflineat">@@ -1,18 +1,16 @@</span>
<a href="#l85.6"></a><span id="l85.6"> /* -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l85.7"></a><span id="l85.7"> /* vim:set ts=2 sw=2 sts=2 et: */</span>
<a href="#l85.8"></a><span id="l85.8"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l85.9"></a><span id="l85.9">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l85.10"></a><span id="l85.10">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l85.11"></a><span id="l85.11"> </span>
<a href="#l85.12"></a><span id="l85.12"> /*</span>
<a href="#l85.13"></a><span id="l85.13" class="difflineminus">- * An implementation of an HTTP server both as a loadable script and as an XPCOM</span>
<a href="#l85.14"></a><span id="l85.14" class="difflineminus">- * component.  See the accompanying README file for user documentation on</span>
<a href="#l85.15"></a><span id="l85.15" class="difflineminus">- * httpd.js.</span>
<a href="#l85.16"></a><span id="l85.16" class="difflineplus">+ * An implementation of an HTTP server.</span>
<a href="#l85.17"></a><span id="l85.17">  */</span>
<a href="#l85.18"></a><span id="l85.18"> </span>
<a href="#l85.19"></a><span id="l85.19"> this.EXPORTED_SYMBOLS = [</span>
<a href="#l85.20"></a><span id="l85.20">   &quot;HTTP_400&quot;,</span>
<a href="#l85.21"></a><span id="l85.21">   &quot;HTTP_401&quot;,</span>
<a href="#l85.22"></a><span id="l85.22">   &quot;HTTP_402&quot;,</span>
<a href="#l85.23"></a><span id="l85.23">   &quot;HTTP_403&quot;,</span>
<a href="#l85.24"></a><span id="l85.24">   &quot;HTTP_404&quot;,</span>
<a href="#l85.25"></a><span id="l85.25" class="difflineat">@@ -33,17 +31,17 @@ this.EXPORTED_SYMBOLS = [</span>
<a href="#l85.26"></a><span id="l85.26">   &quot;HTTP_502&quot;,</span>
<a href="#l85.27"></a><span id="l85.27">   &quot;HTTP_503&quot;,</span>
<a href="#l85.28"></a><span id="l85.28">   &quot;HTTP_504&quot;,</span>
<a href="#l85.29"></a><span id="l85.29">   &quot;HTTP_505&quot;,</span>
<a href="#l85.30"></a><span id="l85.30">   &quot;HttpError&quot;,</span>
<a href="#l85.31"></a><span id="l85.31">   &quot;HttpServer&quot;,</span>
<a href="#l85.32"></a><span id="l85.32"> ];</span>
<a href="#l85.33"></a><span id="l85.33"> </span>
<a href="#l85.34"></a><span id="l85.34" class="difflineminus">-var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l85.35"></a><span id="l85.35" class="difflineplus">+const {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l85.36"></a><span id="l85.36"> </span>
<a href="#l85.37"></a><span id="l85.37"> var CC = Components.Constructor;</span>
<a href="#l85.38"></a><span id="l85.38"> </span>
<a href="#l85.39"></a><span id="l85.39"> var PR_UINT32_MAX = Math.pow(2, 32) - 1;</span>
<a href="#l85.40"></a><span id="l85.40"> </span>
<a href="#l85.41"></a><span id="l85.41"> /** True if debugging output is enabled, false otherwise. */</span>
<a href="#l85.42"></a><span id="l85.42"> var DEBUG = false; // non-const *only* so tweakable in server tests</span>
<a href="#l85.43"></a><span id="l85.43"> </span>
<a href="#l85.44"></a><span id="l85.44" class="difflineat">@@ -53,43 +51,40 @@ var DEBUG_TIMESTAMP = false; // non-cons</span>
<a href="#l85.45"></a><span id="l85.45"> var gGlobalObject = this;</span>
<a href="#l85.46"></a><span id="l85.46"> </span>
<a href="#l85.47"></a><span id="l85.47"> /**</span>
<a href="#l85.48"></a><span id="l85.48">  * Asserts that the given condition holds.  If it doesn't, the given message is</span>
<a href="#l85.49"></a><span id="l85.49">  * dumped, a stack trace is printed, and an exception is thrown to attempt to</span>
<a href="#l85.50"></a><span id="l85.50">  * stop execution (which unfortunately must rely upon the exception not being</span>
<a href="#l85.51"></a><span id="l85.51">  * accidentally swallowed by the code that uses it).</span>
<a href="#l85.52"></a><span id="l85.52">  */</span>
<a href="#l85.53"></a><span id="l85.53" class="difflineminus">-function NS_ASSERT(cond, msg)</span>
<a href="#l85.54"></a><span id="l85.54" class="difflineminus">-{</span>
<a href="#l85.55"></a><span id="l85.55" class="difflineminus">-  if (DEBUG &amp;&amp; !cond)</span>
<a href="#l85.56"></a><span id="l85.56" class="difflineminus">-  {</span>
<a href="#l85.57"></a><span id="l85.57" class="difflineplus">+function NS_ASSERT(cond, msg) {</span>
<a href="#l85.58"></a><span id="l85.58" class="difflineplus">+  if (DEBUG &amp;&amp; !cond) {</span>
<a href="#l85.59"></a><span id="l85.59">     dumpn(&quot;###!!!&quot;);</span>
<a href="#l85.60"></a><span id="l85.60">     dumpn(&quot;###!!! ASSERTION&quot; + (msg ? &quot;: &quot; + msg : &quot;!&quot;));</span>
<a href="#l85.61"></a><span id="l85.61">     dumpn(&quot;###!!! Stack follows:&quot;);</span>
<a href="#l85.62"></a><span id="l85.62"> </span>
<a href="#l85.63"></a><span id="l85.63">     var stack = new Error().stack.split(/\n/);</span>
<a href="#l85.64"></a><span id="l85.64" class="difflineminus">-    dumpn(stack.map(function(val) { return &quot;###!!!   &quot; + val; }).join(&quot;\n&quot;));</span>
<a href="#l85.65"></a><span id="l85.65" class="difflineplus">+    dumpn(stack.map(function(val) {</span>
<a href="#l85.66"></a><span id="l85.66" class="difflineplus">+      return &quot;###!!!   &quot; + val;</span>
<a href="#l85.67"></a><span id="l85.67" class="difflineplus">+    }).join(&quot;\n&quot;));</span>
<a href="#l85.68"></a><span id="l85.68"> </span>
<a href="#l85.69"></a><span id="l85.69">     throw Cr.NS_ERROR_ABORT;</span>
<a href="#l85.70"></a><span id="l85.70">   }</span>
<a href="#l85.71"></a><span id="l85.71"> }</span>
<a href="#l85.72"></a><span id="l85.72"> </span>
<a href="#l85.73"></a><span id="l85.73"> /** Constructs an HTTP error object. */</span>
<a href="#l85.74"></a><span id="l85.74" class="difflineminus">-function HttpError(code, description)</span>
<a href="#l85.75"></a><span id="l85.75" class="difflineminus">-{</span>
<a href="#l85.76"></a><span id="l85.76" class="difflineplus">+function HttpError(code, description) {</span>
<a href="#l85.77"></a><span id="l85.77">   this.code = code;</span>
<a href="#l85.78"></a><span id="l85.78">   this.description = description;</span>
<a href="#l85.79"></a><span id="l85.79"> }</span>
<a href="#l85.80"></a><span id="l85.80" class="difflineminus">-HttpError.prototype =</span>
<a href="#l85.81"></a><span id="l85.81" class="difflineminus">-{</span>
<a href="#l85.82"></a><span id="l85.82" class="difflineminus">-  toString: function()</span>
<a href="#l85.83"></a><span id="l85.83" class="difflineminus">-  {</span>
<a href="#l85.84"></a><span id="l85.84" class="difflineplus">+HttpError.prototype = {</span>
<a href="#l85.85"></a><span id="l85.85" class="difflineplus">+  toString() {</span>
<a href="#l85.86"></a><span id="l85.86">     return this.code + &quot; &quot; + this.description;</span>
<a href="#l85.87"></a><span id="l85.87" class="difflineminus">-  }</span>
<a href="#l85.88"></a><span id="l85.88" class="difflineplus">+  },</span>
<a href="#l85.89"></a><span id="l85.89"> };</span>
<a href="#l85.90"></a><span id="l85.90"> </span>
<a href="#l85.91"></a><span id="l85.91"> /**</span>
<a href="#l85.92"></a><span id="l85.92">  * Errors thrown to trigger specific HTTP server responses.</span>
<a href="#l85.93"></a><span id="l85.93">  */</span>
<a href="#l85.94"></a><span id="l85.94"> var HTTP_400 = new HttpError(400, &quot;Bad Request&quot;);</span>
<a href="#l85.95"></a><span id="l85.95"> var HTTP_401 = new HttpError(401, &quot;Unauthorized&quot;);</span>
<a href="#l85.96"></a><span id="l85.96"> var HTTP_402 = new HttpError(402, &quot;Payment Required&quot;);</span>
<a href="#l85.97"></a><span id="l85.97" class="difflineat">@@ -111,27 +106,25 @@ var HTTP_417 = new HttpError(417, &quot;Expec</span>
<a href="#l85.98"></a><span id="l85.98"> var HTTP_500 = new HttpError(500, &quot;Internal Server Error&quot;);</span>
<a href="#l85.99"></a><span id="l85.99"> var HTTP_501 = new HttpError(501, &quot;Not Implemented&quot;);</span>
<a href="#l85.100"></a><span id="l85.100"> var HTTP_502 = new HttpError(502, &quot;Bad Gateway&quot;);</span>
<a href="#l85.101"></a><span id="l85.101"> var HTTP_503 = new HttpError(503, &quot;Service Unavailable&quot;);</span>
<a href="#l85.102"></a><span id="l85.102"> var HTTP_504 = new HttpError(504, &quot;Gateway Timeout&quot;);</span>
<a href="#l85.103"></a><span id="l85.103"> var HTTP_505 = new HttpError(505, &quot;HTTP Version Not Supported&quot;);</span>
<a href="#l85.104"></a><span id="l85.104"> </span>
<a href="#l85.105"></a><span id="l85.105"> /** Creates a hash with fields corresponding to the values in arr. */</span>
<a href="#l85.106"></a><span id="l85.106" class="difflineminus">-function array2obj(arr)</span>
<a href="#l85.107"></a><span id="l85.107" class="difflineminus">-{</span>
<a href="#l85.108"></a><span id="l85.108" class="difflineplus">+function array2obj(arr) {</span>
<a href="#l85.109"></a><span id="l85.109">   var obj = {};</span>
<a href="#l85.110"></a><span id="l85.110">   for (var i = 0; i &lt; arr.length; i++)</span>
<a href="#l85.111"></a><span id="l85.111">     obj[arr[i]] = arr[i];</span>
<a href="#l85.112"></a><span id="l85.112">   return obj;</span>
<a href="#l85.113"></a><span id="l85.113"> }</span>
<a href="#l85.114"></a><span id="l85.114"> </span>
<a href="#l85.115"></a><span id="l85.115"> /** Returns an array of the integers x through y, inclusive. */</span>
<a href="#l85.116"></a><span id="l85.116" class="difflineminus">-function range(x, y)</span>
<a href="#l85.117"></a><span id="l85.117" class="difflineminus">-{</span>
<a href="#l85.118"></a><span id="l85.118" class="difflineplus">+function range(x, y) {</span>
<a href="#l85.119"></a><span id="l85.119">   var arr = [];</span>
<a href="#l85.120"></a><span id="l85.120">   for (var i = x; i &lt;= y; i++)</span>
<a href="#l85.121"></a><span id="l85.121">     arr.push(i);</span>
<a href="#l85.122"></a><span id="l85.122">   return arr;</span>
<a href="#l85.123"></a><span id="l85.123"> }</span>
<a href="#l85.124"></a><span id="l85.124"> </span>
<a href="#l85.125"></a><span id="l85.125"> /** An object (hash) whose fields are the numbers of all HTTP error codes. */</span>
<a href="#l85.126"></a><span id="l85.126"> var HTTP_ERROR_CODES = array2obj(range(400, 417).concat(range(500, 505)));</span>
<a href="#l85.127"></a><span id="l85.127" class="difflineat">@@ -156,23 +149,20 @@ var HEADERS_SUFFIX = HIDDEN_CHAR + &quot;head</span>
<a href="#l85.128"></a><span id="l85.128"> </span>
<a href="#l85.129"></a><span id="l85.129"> /** Type used to denote SJS scripts for CGI-like functionality. */</span>
<a href="#l85.130"></a><span id="l85.130"> var SJS_TYPE = &quot;sjs&quot;;</span>
<a href="#l85.131"></a><span id="l85.131"> </span>
<a href="#l85.132"></a><span id="l85.132"> /** Base for relative timestamps produced by dumpn(). */</span>
<a href="#l85.133"></a><span id="l85.133"> var firstStamp = 0;</span>
<a href="#l85.134"></a><span id="l85.134"> </span>
<a href="#l85.135"></a><span id="l85.135"> /** dump(str) with a trailing &quot;\n&quot; -- only outputs if DEBUG. */</span>
<a href="#l85.136"></a><span id="l85.136" class="difflineminus">-function dumpn(str)</span>
<a href="#l85.137"></a><span id="l85.137" class="difflineminus">-{</span>
<a href="#l85.138"></a><span id="l85.138" class="difflineminus">-  if (DEBUG)</span>
<a href="#l85.139"></a><span id="l85.139" class="difflineminus">-  {</span>
<a href="#l85.140"></a><span id="l85.140" class="difflineplus">+function dumpn(str) {</span>
<a href="#l85.141"></a><span id="l85.141" class="difflineplus">+  if (DEBUG) {</span>
<a href="#l85.142"></a><span id="l85.142">     var prefix = &quot;HTTPD-INFO | &quot;;</span>
<a href="#l85.143"></a><span id="l85.143" class="difflineminus">-    if (DEBUG_TIMESTAMP)</span>
<a href="#l85.144"></a><span id="l85.144" class="difflineminus">-    {</span>
<a href="#l85.145"></a><span id="l85.145" class="difflineplus">+    if (DEBUG_TIMESTAMP) {</span>
<a href="#l85.146"></a><span id="l85.146">       if (firstStamp === 0)</span>
<a href="#l85.147"></a><span id="l85.147">         firstStamp = Date.now();</span>
<a href="#l85.148"></a><span id="l85.148"> </span>
<a href="#l85.149"></a><span id="l85.149">       var elapsed = Date.now() - firstStamp; // milliseconds</span>
<a href="#l85.150"></a><span id="l85.150">       var min = Math.floor(elapsed / 60000);</span>
<a href="#l85.151"></a><span id="l85.151">       var sec = (elapsed % 60000) / 1000;</span>
<a href="#l85.152"></a><span id="l85.152"> </span>
<a href="#l85.153"></a><span id="l85.153">       if (sec &lt; 10)</span>
<a href="#l85.154"></a><span id="l85.154" class="difflineat">@@ -181,39 +171,22 @@ function dumpn(str)</span>
<a href="#l85.155"></a><span id="l85.155">         prefix += min + &quot;:&quot; + sec.toFixed(3) + &quot; | &quot;;</span>
<a href="#l85.156"></a><span id="l85.156">     }</span>
<a href="#l85.157"></a><span id="l85.157"> </span>
<a href="#l85.158"></a><span id="l85.158">     dump(prefix + str + &quot;\n&quot;);</span>
<a href="#l85.159"></a><span id="l85.159">   }</span>
<a href="#l85.160"></a><span id="l85.160"> }</span>
<a href="#l85.161"></a><span id="l85.161"> </span>
<a href="#l85.162"></a><span id="l85.162"> /** Dumps the current JS stack if DEBUG. */</span>
<a href="#l85.163"></a><span id="l85.163" class="difflineminus">-function dumpStack()</span>
<a href="#l85.164"></a><span id="l85.164" class="difflineminus">-{</span>
<a href="#l85.165"></a><span id="l85.165" class="difflineplus">+function dumpStack() {</span>
<a href="#l85.166"></a><span id="l85.166">   // peel off the frames for dumpStack() and Error()</span>
<a href="#l85.167"></a><span id="l85.167">   var stack = new Error().stack.split(/\n/).slice(2);</span>
<a href="#l85.168"></a><span id="l85.168">   stack.forEach(dumpn);</span>
<a href="#l85.169"></a><span id="l85.169"> }</span>
<a href="#l85.170"></a><span id="l85.170"> </span>
<a href="#l85.171"></a><span id="l85.171" class="difflineminus">-</span>
<a href="#l85.172"></a><span id="l85.172" class="difflineminus">-/** The XPCOM thread manager. */</span>
<a href="#l85.173"></a><span id="l85.173" class="difflineminus">-var gThreadManager = null;</span>
<a href="#l85.174"></a><span id="l85.174" class="difflineminus">-</span>
<a href="#l85.175"></a><span id="l85.175" class="difflineminus">-/** The XPCOM prefs service. */</span>
<a href="#l85.176"></a><span id="l85.176" class="difflineminus">-var gRootPrefBranch = null;</span>
<a href="#l85.177"></a><span id="l85.177" class="difflineminus">-function getRootPrefBranch()</span>
<a href="#l85.178"></a><span id="l85.178" class="difflineminus">-{</span>
<a href="#l85.179"></a><span id="l85.179" class="difflineminus">-  if (!gRootPrefBranch)</span>
<a href="#l85.180"></a><span id="l85.180" class="difflineminus">-  {</span>
<a href="#l85.181"></a><span id="l85.181" class="difflineminus">-    gRootPrefBranch = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l85.182"></a><span id="l85.182" class="difflineminus">-                        .getService(Ci.nsIPrefBranch);</span>
<a href="#l85.183"></a><span id="l85.183" class="difflineminus">-  }</span>
<a href="#l85.184"></a><span id="l85.184" class="difflineminus">-  return gRootPrefBranch;</span>
<a href="#l85.185"></a><span id="l85.185" class="difflineminus">-}</span>
<a href="#l85.186"></a><span id="l85.186" class="difflineminus">-</span>
<a href="#l85.187"></a><span id="l85.187"> /**</span>
<a href="#l85.188"></a><span id="l85.188">  * JavaScript constructors for commonly-used classes; precreating these is a</span>
<a href="#l85.189"></a><span id="l85.189">  * speedup over doing the same from base principles.  See the docs at</span>
<a href="#l85.190"></a><span id="l85.190">  * http://developer.mozilla.org/en/docs/Components.Constructor for details.</span>
<a href="#l85.191"></a><span id="l85.191">  */</span>
<a href="#l85.192"></a><span id="l85.192"> var ServerSocket = CC(&quot;@mozilla.org/network/server-socket;1&quot;,</span>
<a href="#l85.193"></a><span id="l85.193">                         &quot;nsIServerSocket&quot;,</span>
<a href="#l85.194"></a><span id="l85.194">                         &quot;init&quot;);</span>
<a href="#l85.195"></a><span id="l85.195" class="difflineat">@@ -245,18 +218,17 @@ var BinaryOutputStream = CC(&quot;@mozilla.or</span>
<a href="#l85.196"></a><span id="l85.196"> /**</span>
<a href="#l85.197"></a><span id="l85.197">  * Returns the RFC 822/1123 representation of a date.</span>
<a href="#l85.198"></a><span id="l85.198">  *</span>
<a href="#l85.199"></a><span id="l85.199">  * @param date : Number</span>
<a href="#l85.200"></a><span id="l85.200">  *   the date, in milliseconds from midnight (00:00:00), January 1, 1970 GMT</span>
<a href="#l85.201"></a><span id="l85.201">  * @returns string</span>
<a href="#l85.202"></a><span id="l85.202">  *   the representation of the given date</span>
<a href="#l85.203"></a><span id="l85.203">  */</span>
<a href="#l85.204"></a><span id="l85.204" class="difflineminus">-function toDateString(date)</span>
<a href="#l85.205"></a><span id="l85.205" class="difflineminus">-{</span>
<a href="#l85.206"></a><span id="l85.206" class="difflineplus">+function toDateString(date) {</span>
<a href="#l85.207"></a><span id="l85.207">   //</span>
<a href="#l85.208"></a><span id="l85.208">   // rfc1123-date = wkday &quot;,&quot; SP date1 SP time SP &quot;GMT&quot;</span>
<a href="#l85.209"></a><span id="l85.209">   // date1        = 2DIGIT SP month SP 4DIGIT</span>
<a href="#l85.210"></a><span id="l85.210">   //                ; day month year (e.g., 02 Jun 1982)</span>
<a href="#l85.211"></a><span id="l85.211">   // time         = 2DIGIT &quot;:&quot; 2DIGIT &quot;:&quot; 2DIGIT</span>
<a href="#l85.212"></a><span id="l85.212">   //                ; 00:00:00 - 23:59:59</span>
<a href="#l85.213"></a><span id="l85.213">   // wkday        = &quot;Mon&quot; | &quot;Tue&quot; | &quot;Wed&quot;</span>
<a href="#l85.214"></a><span id="l85.214">   //              | &quot;Thu&quot; | &quot;Fri&quot; | &quot;Sat&quot; | &quot;Sun&quot;</span>
<a href="#l85.215"></a><span id="l85.215" class="difflineat">@@ -273,18 +245,17 @@ function toDateString(date)</span>
<a href="#l85.216"></a><span id="l85.216">    * Processes a date and returns the encoded UTC time as a string according to</span>
<a href="#l85.217"></a><span id="l85.217">    * the format specified in RFC 2616.</span>
<a href="#l85.218"></a><span id="l85.218">    *</span>
<a href="#l85.219"></a><span id="l85.219">    * @param date : Date</span>
<a href="#l85.220"></a><span id="l85.220">    *   the date to process</span>
<a href="#l85.221"></a><span id="l85.221">    * @returns string</span>
<a href="#l85.222"></a><span id="l85.222">    *   a string of the form &quot;HH:MM:SS&quot;, ranging from &quot;00:00:00&quot; to &quot;23:59:59&quot;</span>
<a href="#l85.223"></a><span id="l85.223">    */</span>
<a href="#l85.224"></a><span id="l85.224" class="difflineminus">-  function toTime(date)</span>
<a href="#l85.225"></a><span id="l85.225" class="difflineminus">-  {</span>
<a href="#l85.226"></a><span id="l85.226" class="difflineplus">+  function toTime(date) {</span>
<a href="#l85.227"></a><span id="l85.227">     var hrs = date.getUTCHours();</span>
<a href="#l85.228"></a><span id="l85.228">     var rv  = (hrs &lt; 10) ? &quot;0&quot; + hrs : hrs;</span>
<a href="#l85.229"></a><span id="l85.229"> </span>
<a href="#l85.230"></a><span id="l85.230">     var mins = date.getUTCMinutes();</span>
<a href="#l85.231"></a><span id="l85.231">     rv += &quot;:&quot;;</span>
<a href="#l85.232"></a><span id="l85.232">     rv += (mins &lt; 10) ? &quot;0&quot; + mins : mins;</span>
<a href="#l85.233"></a><span id="l85.233"> </span>
<a href="#l85.234"></a><span id="l85.234">     var secs = date.getUTCSeconds();</span>
<a href="#l85.235"></a><span id="l85.235" class="difflineat">@@ -298,18 +269,17 @@ function toDateString(date)</span>
<a href="#l85.236"></a><span id="l85.236">    * Processes a date and returns the encoded UTC date as a string according to</span>
<a href="#l85.237"></a><span id="l85.237">    * the date1 format specified in RFC 2616.</span>
<a href="#l85.238"></a><span id="l85.238">    *</span>
<a href="#l85.239"></a><span id="l85.239">    * @param date : Date</span>
<a href="#l85.240"></a><span id="l85.240">    *   the date to process</span>
<a href="#l85.241"></a><span id="l85.241">    * @returns string</span>
<a href="#l85.242"></a><span id="l85.242">    *   a string of the form &quot;HH:MM:SS&quot;, ranging from &quot;00:00:00&quot; to &quot;23:59:59&quot;</span>
<a href="#l85.243"></a><span id="l85.243">    */</span>
<a href="#l85.244"></a><span id="l85.244" class="difflineminus">-  function toDate1(date)</span>
<a href="#l85.245"></a><span id="l85.245" class="difflineminus">-  {</span>
<a href="#l85.246"></a><span id="l85.246" class="difflineplus">+  function toDate1(date) {</span>
<a href="#l85.247"></a><span id="l85.247">     var day = date.getUTCDate();</span>
<a href="#l85.248"></a><span id="l85.248">     var month = date.getUTCMonth();</span>
<a href="#l85.249"></a><span id="l85.249">     var year = date.getUTCFullYear();</span>
<a href="#l85.250"></a><span id="l85.250"> </span>
<a href="#l85.251"></a><span id="l85.251">     var rv = (day &lt; 10) ? &quot;0&quot; + day : day;</span>
<a href="#l85.252"></a><span id="l85.252">     rv += &quot; &quot; + monthStrings[month];</span>
<a href="#l85.253"></a><span id="l85.253">     rv += &quot; &quot; + year;</span>
<a href="#l85.254"></a><span id="l85.254"> </span>
<a href="#l85.255"></a><span id="l85.255" class="difflineat">@@ -320,43 +290,19 @@ function toDateString(date)</span>
<a href="#l85.256"></a><span id="l85.256"> </span>
<a href="#l85.257"></a><span id="l85.257">   const fmtString = &quot;%wkday%, %date1% %time% GMT&quot;;</span>
<a href="#l85.258"></a><span id="l85.258">   var rv = fmtString.replace(&quot;%wkday%&quot;, wkdayStrings[date.getUTCDay()]);</span>
<a href="#l85.259"></a><span id="l85.259">   rv = rv.replace(&quot;%time%&quot;, toTime(date));</span>
<a href="#l85.260"></a><span id="l85.260">   return rv.replace(&quot;%date1%&quot;, toDate1(date));</span>
<a href="#l85.261"></a><span id="l85.261"> }</span>
<a href="#l85.262"></a><span id="l85.262"> </span>
<a href="#l85.263"></a><span id="l85.263"> /**</span>
<a href="#l85.264"></a><span id="l85.264" class="difflineminus">- * Prints out a human-readable representation of the object o and its fields,</span>
<a href="#l85.265"></a><span id="l85.265" class="difflineminus">- * omitting those whose names begin with &quot;_&quot; if showMembers != true (to ignore</span>
<a href="#l85.266"></a><span id="l85.266" class="difflineminus">- * &quot;private&quot; properties exposed via getters/setters).</span>
<a href="#l85.267"></a><span id="l85.267" class="difflineminus">- */</span>
<a href="#l85.268"></a><span id="l85.268" class="difflineminus">-function printObj(o, showMembers)</span>
<a href="#l85.269"></a><span id="l85.269" class="difflineminus">-{</span>
<a href="#l85.270"></a><span id="l85.270" class="difflineminus">-  var s = &quot;******************************\n&quot;;</span>
<a href="#l85.271"></a><span id="l85.271" class="difflineminus">-  s +=    &quot;o = {\n&quot;;</span>
<a href="#l85.272"></a><span id="l85.272" class="difflineminus">-  for (var i in o)</span>
<a href="#l85.273"></a><span id="l85.273" class="difflineminus">-  {</span>
<a href="#l85.274"></a><span id="l85.274" class="difflineminus">-    if (typeof(i) != &quot;string&quot; ||</span>
<a href="#l85.275"></a><span id="l85.275" class="difflineminus">-        (showMembers || (i.length &gt; 0 &amp;&amp; i[0] != &quot;_&quot;)))</span>
<a href="#l85.276"></a><span id="l85.276" class="difflineminus">-      s+= &quot;      &quot; + i + &quot;: &quot; + o[i] + &quot;,\n&quot;;</span>
<a href="#l85.277"></a><span id="l85.277" class="difflineminus">-  }</span>
<a href="#l85.278"></a><span id="l85.278" class="difflineminus">-  s +=    &quot;    };\n&quot;;</span>
<a href="#l85.279"></a><span id="l85.279" class="difflineminus">-  s +=    &quot;******************************&quot;;</span>
<a href="#l85.280"></a><span id="l85.280" class="difflineminus">-  dumpn(s);</span>
<a href="#l85.281"></a><span id="l85.281" class="difflineminus">-}</span>
<a href="#l85.282"></a><span id="l85.282" class="difflineminus">-</span>
<a href="#l85.283"></a><span id="l85.283" class="difflineminus">-/**</span>
<a href="#l85.284"></a><span id="l85.284">  * Instantiates a new HTTP server.</span>
<a href="#l85.285"></a><span id="l85.285">  */</span>
<a href="#l85.286"></a><span id="l85.286" class="difflineminus">-function nsHttpServer()</span>
<a href="#l85.287"></a><span id="l85.287" class="difflineminus">-{</span>
<a href="#l85.288"></a><span id="l85.288" class="difflineminus">-  if (!gThreadManager)</span>
<a href="#l85.289"></a><span id="l85.289" class="difflineminus">-    gThreadManager = Cc[&quot;@mozilla.org/thread-manager;1&quot;].getService();</span>
<a href="#l85.290"></a><span id="l85.290" class="difflineminus">-</span>
<a href="#l85.291"></a><span id="l85.291" class="difflineplus">+function nsHttpServer() {</span>
<a href="#l85.292"></a><span id="l85.292">   /** The port on which this server listens. */</span>
<a href="#l85.293"></a><span id="l85.293">   this._port = undefined;</span>
<a href="#l85.294"></a><span id="l85.294"> </span>
<a href="#l85.295"></a><span id="l85.295">   /** The socket associated with this. */</span>
<a href="#l85.296"></a><span id="l85.296">   this._socket = null;</span>
<a href="#l85.297"></a><span id="l85.297"> </span>
<a href="#l85.298"></a><span id="l85.298">   /** The handler used to process requests to this server. */</span>
<a href="#l85.299"></a><span id="l85.299">   this._handler = new ServerHandler(this);</span>
<a href="#l85.300"></a><span id="l85.300" class="difflineat">@@ -383,70 +329,62 @@ function nsHttpServer()</span>
<a href="#l85.301"></a><span id="l85.301">   this._connectionGen = 0;</span>
<a href="#l85.302"></a><span id="l85.302"> </span>
<a href="#l85.303"></a><span id="l85.303">   /**</span>
<a href="#l85.304"></a><span id="l85.304">    * Hash of all open connections, indexed by connection number at time of</span>
<a href="#l85.305"></a><span id="l85.305">    * creation.</span>
<a href="#l85.306"></a><span id="l85.306">    */</span>
<a href="#l85.307"></a><span id="l85.307">   this._connections = {};</span>
<a href="#l85.308"></a><span id="l85.308"> }</span>
<a href="#l85.309"></a><span id="l85.309" class="difflineminus">-nsHttpServer.prototype =</span>
<a href="#l85.310"></a><span id="l85.310" class="difflineminus">-{</span>
<a href="#l85.311"></a><span id="l85.311" class="difflineplus">+nsHttpServer.prototype = {</span>
<a href="#l85.312"></a><span id="l85.312">   classID: Components.ID(&quot;{54ef6f81-30af-4b1d-ac55-8ba811293e41}&quot;),</span>
<a href="#l85.313"></a><span id="l85.313"> </span>
<a href="#l85.314"></a><span id="l85.314">   // NSISERVERSOCKETLISTENER</span>
<a href="#l85.315"></a><span id="l85.315"> </span>
<a href="#l85.316"></a><span id="l85.316">   /**</span>
<a href="#l85.317"></a><span id="l85.317">    * Processes an incoming request coming in on the given socket and contained</span>
<a href="#l85.318"></a><span id="l85.318">    * in the given transport.</span>
<a href="#l85.319"></a><span id="l85.319">    *</span>
<a href="#l85.320"></a><span id="l85.320">    * @param socket : nsIServerSocket</span>
<a href="#l85.321"></a><span id="l85.321">    *   the socket through which the request was served</span>
<a href="#l85.322"></a><span id="l85.322">    * @param trans : nsISocketTransport</span>
<a href="#l85.323"></a><span id="l85.323">    *   the transport for the request/response</span>
<a href="#l85.324"></a><span id="l85.324">    * @see nsIServerSocketListener.onSocketAccepted</span>
<a href="#l85.325"></a><span id="l85.325">    */</span>
<a href="#l85.326"></a><span id="l85.326" class="difflineminus">-  onSocketAccepted: function(socket, trans)</span>
<a href="#l85.327"></a><span id="l85.327" class="difflineminus">-  {</span>
<a href="#l85.328"></a><span id="l85.328" class="difflineplus">+  onSocketAccepted(socket, trans) {</span>
<a href="#l85.329"></a><span id="l85.329">     dumpn(&quot;*** onSocketAccepted(socket=&quot; + socket + &quot;, trans=&quot; + trans + &quot;)&quot;);</span>
<a href="#l85.330"></a><span id="l85.330"> </span>
<a href="#l85.331"></a><span id="l85.331">     dumpn(&quot;&gt;&gt;&gt; new connection on &quot; + trans.host + &quot;:&quot; + trans.port);</span>
<a href="#l85.332"></a><span id="l85.332"> </span>
<a href="#l85.333"></a><span id="l85.333">     const SEGMENT_SIZE = 8192;</span>
<a href="#l85.334"></a><span id="l85.334">     const SEGMENT_COUNT = 1024;</span>
<a href="#l85.335"></a><span id="l85.335" class="difflineminus">-    try</span>
<a href="#l85.336"></a><span id="l85.336" class="difflineminus">-    {</span>
<a href="#l85.337"></a><span id="l85.337" class="difflineplus">+    try {</span>
<a href="#l85.338"></a><span id="l85.338">       var input = trans.openInputStream(0, SEGMENT_SIZE, SEGMENT_COUNT)</span>
<a href="#l85.339"></a><span id="l85.339">                        .QueryInterface(Ci.nsIAsyncInputStream);</span>
<a href="#l85.340"></a><span id="l85.340">       var output = trans.openOutputStream(0, 0, 0);</span>
<a href="#l85.341"></a><span id="l85.341" class="difflineminus">-    }</span>
<a href="#l85.342"></a><span id="l85.342" class="difflineminus">-    catch (e)</span>
<a href="#l85.343"></a><span id="l85.343" class="difflineminus">-    {</span>
<a href="#l85.344"></a><span id="l85.344" class="difflineplus">+    } catch (e) {</span>
<a href="#l85.345"></a><span id="l85.345">       dumpn(&quot;*** error opening transport streams: &quot; + e);</span>
<a href="#l85.346"></a><span id="l85.346">       trans.close(Cr.NS_BINDING_ABORTED);</span>
<a href="#l85.347"></a><span id="l85.347">       return;</span>
<a href="#l85.348"></a><span id="l85.348">     }</span>
<a href="#l85.349"></a><span id="l85.349"> </span>
<a href="#l85.350"></a><span id="l85.350">     var connectionNumber = ++this._connectionGen;</span>
<a href="#l85.351"></a><span id="l85.351"> </span>
<a href="#l85.352"></a><span id="l85.352" class="difflineminus">-    try</span>
<a href="#l85.353"></a><span id="l85.353" class="difflineminus">-    {</span>
<a href="#l85.354"></a><span id="l85.354" class="difflineplus">+    try {</span>
<a href="#l85.355"></a><span id="l85.355">       var conn = new Connection(input, output, this, socket.port, trans.port,</span>
<a href="#l85.356"></a><span id="l85.356">                                 connectionNumber);</span>
<a href="#l85.357"></a><span id="l85.357">       var reader = new RequestReader(conn);</span>
<a href="#l85.358"></a><span id="l85.358"> </span>
<a href="#l85.359"></a><span id="l85.359">       // XXX add request timeout functionality here!</span>
<a href="#l85.360"></a><span id="l85.360"> </span>
<a href="#l85.361"></a><span id="l85.361">       // Note: must use main thread here, or we might get a GC that will cause</span>
<a href="#l85.362"></a><span id="l85.362">       //       threadsafety assertions.  We really need to fix XPConnect so that</span>
<a href="#l85.363"></a><span id="l85.363">       //       you can actually do things in multi-threaded JS.  :-(</span>
<a href="#l85.364"></a><span id="l85.364" class="difflineminus">-      input.asyncWait(reader, 0, 0, gThreadManager.mainThread);</span>
<a href="#l85.365"></a><span id="l85.365" class="difflineminus">-    }</span>
<a href="#l85.366"></a><span id="l85.366" class="difflineminus">-    catch (e)</span>
<a href="#l85.367"></a><span id="l85.367" class="difflineminus">-    {</span>
<a href="#l85.368"></a><span id="l85.368" class="difflineplus">+      input.asyncWait(reader, 0, 0, Services.tm.mainThread);</span>
<a href="#l85.369"></a><span id="l85.369" class="difflineplus">+    } catch (e) {</span>
<a href="#l85.370"></a><span id="l85.370">       // Assume this connection can't be salvaged and bail on it completely;</span>
<a href="#l85.371"></a><span id="l85.371">       // don't attempt to close it so that we can assert that any connection</span>
<a href="#l85.372"></a><span id="l85.372">       // being closed is in this._connections.</span>
<a href="#l85.373"></a><span id="l85.373">       dumpn(&quot;*** error in initial request-processing stages: &quot; + e);</span>
<a href="#l85.374"></a><span id="l85.374">       trans.close(Cr.NS_BINDING_ABORTED);</span>
<a href="#l85.375"></a><span id="l85.375">       return;</span>
<a href="#l85.376"></a><span id="l85.376">     }</span>
<a href="#l85.377"></a><span id="l85.377"> </span>
<a href="#l85.378"></a><span id="l85.378" class="difflineat">@@ -459,104 +397,92 @@ nsHttpServer.prototype =</span>
<a href="#l85.379"></a><span id="l85.379">    *</span>
<a href="#l85.380"></a><span id="l85.380">    * @param socket : nsIServerSocket</span>
<a href="#l85.381"></a><span id="l85.381">    *   the socket being closed</span>
<a href="#l85.382"></a><span id="l85.382">    * @param status : nsresult</span>
<a href="#l85.383"></a><span id="l85.383">    *   the reason the socket stopped listening (NS_BINDING_ABORTED if the server</span>
<a href="#l85.384"></a><span id="l85.384">    *   was stopped using nsIHttpServer.stop)</span>
<a href="#l85.385"></a><span id="l85.385">    * @see nsIServerSocketListener.onStopListening</span>
<a href="#l85.386"></a><span id="l85.386">    */</span>
<a href="#l85.387"></a><span id="l85.387" class="difflineminus">-  onStopListening: function(socket, status)</span>
<a href="#l85.388"></a><span id="l85.388" class="difflineminus">-  {</span>
<a href="#l85.389"></a><span id="l85.389" class="difflineplus">+  onStopListening(socket, status) {</span>
<a href="#l85.390"></a><span id="l85.390">     dumpn(&quot;&gt;&gt;&gt; shutting down server on port &quot; + socket.port);</span>
<a href="#l85.391"></a><span id="l85.391">     this._socketClosed = true;</span>
<a href="#l85.392"></a><span id="l85.392" class="difflineminus">-    if (!this._hasOpenConnections())</span>
<a href="#l85.393"></a><span id="l85.393" class="difflineminus">-    {</span>
<a href="#l85.394"></a><span id="l85.394" class="difflineplus">+    if (!this._hasOpenConnections()) {</span>
<a href="#l85.395"></a><span id="l85.395">       dumpn(&quot;*** no open connections, notifying async from onStopListening&quot;);</span>
<a href="#l85.396"></a><span id="l85.396"> </span>
<a href="#l85.397"></a><span id="l85.397">       // Notify asynchronously so that any pending teardown in stop() has a</span>
<a href="#l85.398"></a><span id="l85.398">       // chance to run first.</span>
<a href="#l85.399"></a><span id="l85.399">       var self = this;</span>
<a href="#l85.400"></a><span id="l85.400" class="difflineminus">-      var stopEvent =</span>
<a href="#l85.401"></a><span id="l85.401" class="difflineminus">-        {</span>
<a href="#l85.402"></a><span id="l85.402" class="difflineminus">-          run: function()</span>
<a href="#l85.403"></a><span id="l85.403" class="difflineminus">-          {</span>
<a href="#l85.404"></a><span id="l85.404" class="difflineminus">-            dumpn(&quot;*** _notifyStopped async callback&quot;);</span>
<a href="#l85.405"></a><span id="l85.405" class="difflineminus">-            self._notifyStopped();</span>
<a href="#l85.406"></a><span id="l85.406" class="difflineminus">-          }</span>
<a href="#l85.407"></a><span id="l85.407" class="difflineminus">-        };</span>
<a href="#l85.408"></a><span id="l85.408" class="difflineminus">-      gThreadManager.currentThread</span>
<a href="#l85.409"></a><span id="l85.409" class="difflineminus">-                    .dispatch(stopEvent, Ci.nsIThread.DISPATCH_NORMAL);</span>
<a href="#l85.410"></a><span id="l85.410" class="difflineplus">+      var stopEvent = {</span>
<a href="#l85.411"></a><span id="l85.411" class="difflineplus">+        run() {</span>
<a href="#l85.412"></a><span id="l85.412" class="difflineplus">+          dumpn(&quot;*** _notifyStopped async callback&quot;);</span>
<a href="#l85.413"></a><span id="l85.413" class="difflineplus">+          self._notifyStopped();</span>
<a href="#l85.414"></a><span id="l85.414" class="difflineplus">+        },</span>
<a href="#l85.415"></a><span id="l85.415" class="difflineplus">+      };</span>
<a href="#l85.416"></a><span id="l85.416" class="difflineplus">+      Services.tm.currentThread.dispatch(stopEvent, Ci.nsIThread.DISPATCH_NORMAL);</span>
<a href="#l85.417"></a><span id="l85.417">     }</span>
<a href="#l85.418"></a><span id="l85.418">   },</span>
<a href="#l85.419"></a><span id="l85.419"> </span>
<a href="#l85.420"></a><span id="l85.420">   // NSIHTTPSERVER</span>
<a href="#l85.421"></a><span id="l85.421"> </span>
<a href="#l85.422"></a><span id="l85.422">   //</span>
<a href="#l85.423"></a><span id="l85.423">   // see nsIHttpServer.start</span>
<a href="#l85.424"></a><span id="l85.424">   //</span>
<a href="#l85.425"></a><span id="l85.425" class="difflineminus">-  start: function(port)</span>
<a href="#l85.426"></a><span id="l85.426" class="difflineminus">-  {</span>
<a href="#l85.427"></a><span id="l85.427" class="difflineminus">-    this._start(port, &quot;localhost&quot;)</span>
<a href="#l85.428"></a><span id="l85.428" class="difflineplus">+  start(port) {</span>
<a href="#l85.429"></a><span id="l85.429" class="difflineplus">+    this._start(port, &quot;localhost&quot;);</span>
<a href="#l85.430"></a><span id="l85.430">   },</span>
<a href="#l85.431"></a><span id="l85.431"> </span>
<a href="#l85.432"></a><span id="l85.432" class="difflineminus">-  _start: function(port, host)</span>
<a href="#l85.433"></a><span id="l85.433" class="difflineminus">-  {</span>
<a href="#l85.434"></a><span id="l85.434" class="difflineplus">+  _start(port, host) {</span>
<a href="#l85.435"></a><span id="l85.435">     if (this._socket)</span>
<a href="#l85.436"></a><span id="l85.436">       throw Cr.NS_ERROR_ALREADY_INITIALIZED;</span>
<a href="#l85.437"></a><span id="l85.437"> </span>
<a href="#l85.438"></a><span id="l85.438">     this._port = port;</span>
<a href="#l85.439"></a><span id="l85.439">     this._doQuit = this._socketClosed = false;</span>
<a href="#l85.440"></a><span id="l85.440"> </span>
<a href="#l85.441"></a><span id="l85.441">     this._host = host;</span>
<a href="#l85.442"></a><span id="l85.442"> </span>
<a href="#l85.443"></a><span id="l85.443">     // The listen queue needs to be long enough to handle</span>
<a href="#l85.444"></a><span id="l85.444">     // network.http.max-persistent-connections-per-server concurrent connections,</span>
<a href="#l85.445"></a><span id="l85.445">     // plus a safety margin in case some other process is talking to</span>
<a href="#l85.446"></a><span id="l85.446">     // the server as well.</span>
<a href="#l85.447"></a><span id="l85.447" class="difflineminus">-    var prefs = getRootPrefBranch();</span>
<a href="#l85.448"></a><span id="l85.448">     var maxConnections =</span>
<a href="#l85.449"></a><span id="l85.449" class="difflineminus">-      prefs.getIntPref(&quot;network.http.max-persistent-connections-per-server&quot;) + 5;</span>
<a href="#l85.450"></a><span id="l85.450" class="difflineminus">-</span>
<a href="#l85.451"></a><span id="l85.451" class="difflineminus">-    try</span>
<a href="#l85.452"></a><span id="l85.452" class="difflineminus">-    {</span>
<a href="#l85.453"></a><span id="l85.453" class="difflineplus">+      Services.prefs.getIntPref(&quot;network.http.max-persistent-connections-per-server&quot;) + 5;</span>
<a href="#l85.454"></a><span id="l85.454" class="difflineplus">+</span>
<a href="#l85.455"></a><span id="l85.455" class="difflineplus">+    try {</span>
<a href="#l85.456"></a><span id="l85.456">       var loopback = true;</span>
<a href="#l85.457"></a><span id="l85.457">       if (this._host != &quot;127.0.0.1&quot; &amp;&amp; this._host != &quot;localhost&quot;) {</span>
<a href="#l85.458"></a><span id="l85.458" class="difflineminus">-        var loopback = false;</span>
<a href="#l85.459"></a><span id="l85.459" class="difflineplus">+        loopback = false;</span>
<a href="#l85.460"></a><span id="l85.460">       }</span>
<a href="#l85.461"></a><span id="l85.461"> </span>
<a href="#l85.462"></a><span id="l85.462">       var socket = new ServerSocket(this._port,</span>
<a href="#l85.463"></a><span id="l85.463">                                     loopback, // true = localhost, false = everybody</span>
<a href="#l85.464"></a><span id="l85.464">                                     maxConnections);</span>
<a href="#l85.465"></a><span id="l85.465">       dumpn(&quot;&gt;&gt;&gt; listening on port &quot; + socket.port + &quot;, &quot; + maxConnections +</span>
<a href="#l85.466"></a><span id="l85.466">             &quot; pending connections&quot;);</span>
<a href="#l85.467"></a><span id="l85.467">       socket.asyncListen(this);</span>
<a href="#l85.468"></a><span id="l85.468">       this._identity._initialize(port, host, true);</span>
<a href="#l85.469"></a><span id="l85.469">       this._socket = socket;</span>
<a href="#l85.470"></a><span id="l85.470" class="difflineminus">-    }</span>
<a href="#l85.471"></a><span id="l85.471" class="difflineminus">-    catch (e)</span>
<a href="#l85.472"></a><span id="l85.472" class="difflineminus">-    {</span>
<a href="#l85.473"></a><span id="l85.473" class="difflineplus">+    } catch (e) {</span>
<a href="#l85.474"></a><span id="l85.474">       dumpn(&quot;!!! could not start server on port &quot; + port + &quot;: &quot; + e);</span>
<a href="#l85.475"></a><span id="l85.475">       throw Cr.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l85.476"></a><span id="l85.476">     }</span>
<a href="#l85.477"></a><span id="l85.477">   },</span>
<a href="#l85.478"></a><span id="l85.478"> </span>
<a href="#l85.479"></a><span id="l85.479">   //</span>
<a href="#l85.480"></a><span id="l85.480">   // see nsIHttpServer.stop</span>
<a href="#l85.481"></a><span id="l85.481">   //</span>
<a href="#l85.482"></a><span id="l85.482" class="difflineminus">-  stop: function(callback)</span>
<a href="#l85.483"></a><span id="l85.483" class="difflineminus">-  {</span>
<a href="#l85.484"></a><span id="l85.484" class="difflineplus">+  stop(callback) {</span>
<a href="#l85.485"></a><span id="l85.485">     if (!callback)</span>
<a href="#l85.486"></a><span id="l85.486">       throw Cr.NS_ERROR_NULL_POINTER;</span>
<a href="#l85.487"></a><span id="l85.487">     if (!this._socket)</span>
<a href="#l85.488"></a><span id="l85.488">       throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l85.489"></a><span id="l85.489"> </span>
<a href="#l85.490"></a><span id="l85.490" class="difflineminus">-    this._stopCallback = typeof callback === &quot;function&quot;</span>
<a href="#l85.491"></a><span id="l85.491" class="difflineminus">-                       ? callback</span>
<a href="#l85.492"></a><span id="l85.492" class="difflineminus">-                       : function() { callback.onStopped(); };</span>
<a href="#l85.493"></a><span id="l85.493" class="difflineplus">+    this._stopCallback = typeof callback === &quot;function&quot; ? callback : function() {</span>
<a href="#l85.494"></a><span id="l85.494" class="difflineplus">+      callback.onStopped();</span>
<a href="#l85.495"></a><span id="l85.495" class="difflineplus">+    };</span>
<a href="#l85.496"></a><span id="l85.496"> </span>
<a href="#l85.497"></a><span id="l85.497">     dumpn(&quot;&gt;&gt;&gt; stopping listening on port &quot; + this._socket.port);</span>
<a href="#l85.498"></a><span id="l85.498">     this._socket.close();</span>
<a href="#l85.499"></a><span id="l85.499">     this._socket = null;</span>
<a href="#l85.500"></a><span id="l85.500"> </span>
<a href="#l85.501"></a><span id="l85.501">     // We can't have this identity any more, and the port on which we're running</span>
<a href="#l85.502"></a><span id="l85.502">     // this server now could be meaningless the next time around.</span>
<a href="#l85.503"></a><span id="l85.503">     this._identity._teardown();</span>
<a href="#l85.504"></a><span id="l85.504" class="difflineat">@@ -564,213 +490,191 @@ nsHttpServer.prototype =</span>
<a href="#l85.505"></a><span id="l85.505">     this._doQuit = false;</span>
<a href="#l85.506"></a><span id="l85.506"> </span>
<a href="#l85.507"></a><span id="l85.507">     // socket-close notification and pending request completion happen async</span>
<a href="#l85.508"></a><span id="l85.508">   },</span>
<a href="#l85.509"></a><span id="l85.509"> </span>
<a href="#l85.510"></a><span id="l85.510">   //</span>
<a href="#l85.511"></a><span id="l85.511">   // see nsIHttpServer.registerFile</span>
<a href="#l85.512"></a><span id="l85.512">   //</span>
<a href="#l85.513"></a><span id="l85.513" class="difflineminus">-  registerFile: function(path, file)</span>
<a href="#l85.514"></a><span id="l85.514" class="difflineminus">-  {</span>
<a href="#l85.515"></a><span id="l85.515" class="difflineplus">+  registerFile(path, file) {</span>
<a href="#l85.516"></a><span id="l85.516">     if (file &amp;&amp; (!file.exists() || file.isDirectory()))</span>
<a href="#l85.517"></a><span id="l85.517">       throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l85.518"></a><span id="l85.518"> </span>
<a href="#l85.519"></a><span id="l85.519">     this._handler.registerFile(path, file);</span>
<a href="#l85.520"></a><span id="l85.520">   },</span>
<a href="#l85.521"></a><span id="l85.521"> </span>
<a href="#l85.522"></a><span id="l85.522">   //</span>
<a href="#l85.523"></a><span id="l85.523">   // see nsIHttpServer.registerDirectory</span>
<a href="#l85.524"></a><span id="l85.524">   //</span>
<a href="#l85.525"></a><span id="l85.525" class="difflineminus">-  registerDirectory: function(path, directory)</span>
<a href="#l85.526"></a><span id="l85.526" class="difflineminus">-  {</span>
<a href="#l85.527"></a><span id="l85.527" class="difflineplus">+  registerDirectory(path, directory) {</span>
<a href="#l85.528"></a><span id="l85.528">     // XXX true path validation!</span>
<a href="#l85.529"></a><span id="l85.529">     if (path.charAt(0) != &quot;/&quot; ||</span>
<a href="#l85.530"></a><span id="l85.530">         path.charAt(path.length - 1) != &quot;/&quot; ||</span>
<a href="#l85.531"></a><span id="l85.531">         (directory &amp;&amp;</span>
<a href="#l85.532"></a><span id="l85.532">          (!directory.exists() || !directory.isDirectory())))</span>
<a href="#l85.533"></a><span id="l85.533">       throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l85.534"></a><span id="l85.534"> </span>
<a href="#l85.535"></a><span id="l85.535">     // XXX determine behavior of nonexistent /foo/bar when a /foo/bar/ mapping</span>
<a href="#l85.536"></a><span id="l85.536">     //     exists!</span>
<a href="#l85.537"></a><span id="l85.537"> </span>
<a href="#l85.538"></a><span id="l85.538">     this._handler.registerDirectory(path, directory);</span>
<a href="#l85.539"></a><span id="l85.539">   },</span>
<a href="#l85.540"></a><span id="l85.540"> </span>
<a href="#l85.541"></a><span id="l85.541">   //</span>
<a href="#l85.542"></a><span id="l85.542">   // see nsIHttpServer.registerPathHandler</span>
<a href="#l85.543"></a><span id="l85.543">   //</span>
<a href="#l85.544"></a><span id="l85.544" class="difflineminus">-  registerPathHandler: function(path, handler)</span>
<a href="#l85.545"></a><span id="l85.545" class="difflineminus">-  {</span>
<a href="#l85.546"></a><span id="l85.546" class="difflineplus">+  registerPathHandler(path, handler) {</span>
<a href="#l85.547"></a><span id="l85.547">     this._handler.registerPathHandler(path, handler);</span>
<a href="#l85.548"></a><span id="l85.548">   },</span>
<a href="#l85.549"></a><span id="l85.549"> </span>
<a href="#l85.550"></a><span id="l85.550">   //</span>
<a href="#l85.551"></a><span id="l85.551">   // see nsIHttpServer.registerPrefixHandler</span>
<a href="#l85.552"></a><span id="l85.552">   //</span>
<a href="#l85.553"></a><span id="l85.553" class="difflineminus">-  registerPrefixHandler: function(prefix, handler)</span>
<a href="#l85.554"></a><span id="l85.554" class="difflineminus">-  {</span>
<a href="#l85.555"></a><span id="l85.555" class="difflineplus">+  registerPrefixHandler(prefix, handler) {</span>
<a href="#l85.556"></a><span id="l85.556">     this._handler.registerPrefixHandler(prefix, handler);</span>
<a href="#l85.557"></a><span id="l85.557">   },</span>
<a href="#l85.558"></a><span id="l85.558"> </span>
<a href="#l85.559"></a><span id="l85.559">   //</span>
<a href="#l85.560"></a><span id="l85.560">   // see nsIHttpServer.registerErrorHandler</span>
<a href="#l85.561"></a><span id="l85.561">   //</span>
<a href="#l85.562"></a><span id="l85.562" class="difflineminus">-  registerErrorHandler: function(code, handler)</span>
<a href="#l85.563"></a><span id="l85.563" class="difflineminus">-  {</span>
<a href="#l85.564"></a><span id="l85.564" class="difflineplus">+  registerErrorHandler(code, handler) {</span>
<a href="#l85.565"></a><span id="l85.565">     this._handler.registerErrorHandler(code, handler);</span>
<a href="#l85.566"></a><span id="l85.566">   },</span>
<a href="#l85.567"></a><span id="l85.567"> </span>
<a href="#l85.568"></a><span id="l85.568">   //</span>
<a href="#l85.569"></a><span id="l85.569">   // see nsIHttpServer.setIndexHandler</span>
<a href="#l85.570"></a><span id="l85.570">   //</span>
<a href="#l85.571"></a><span id="l85.571" class="difflineminus">-  setIndexHandler: function(handler)</span>
<a href="#l85.572"></a><span id="l85.572" class="difflineminus">-  {</span>
<a href="#l85.573"></a><span id="l85.573" class="difflineplus">+  setIndexHandler(handler) {</span>
<a href="#l85.574"></a><span id="l85.574">     this._handler.setIndexHandler(handler);</span>
<a href="#l85.575"></a><span id="l85.575">   },</span>
<a href="#l85.576"></a><span id="l85.576"> </span>
<a href="#l85.577"></a><span id="l85.577">   //</span>
<a href="#l85.578"></a><span id="l85.578">   // see nsIHttpServer.registerContentType</span>
<a href="#l85.579"></a><span id="l85.579">   //</span>
<a href="#l85.580"></a><span id="l85.580" class="difflineminus">-  registerContentType: function(ext, type)</span>
<a href="#l85.581"></a><span id="l85.581" class="difflineminus">-  {</span>
<a href="#l85.582"></a><span id="l85.582" class="difflineplus">+  registerContentType(ext, type) {</span>
<a href="#l85.583"></a><span id="l85.583">     this._handler.registerContentType(ext, type);</span>
<a href="#l85.584"></a><span id="l85.584">   },</span>
<a href="#l85.585"></a><span id="l85.585"> </span>
<a href="#l85.586"></a><span id="l85.586">   //</span>
<a href="#l85.587"></a><span id="l85.587">   // see nsIHttpServer.serverIdentity</span>
<a href="#l85.588"></a><span id="l85.588">   //</span>
<a href="#l85.589"></a><span id="l85.589" class="difflineminus">-  get identity()</span>
<a href="#l85.590"></a><span id="l85.590" class="difflineminus">-  {</span>
<a href="#l85.591"></a><span id="l85.591" class="difflineplus">+  get identity() {</span>
<a href="#l85.592"></a><span id="l85.592">     return this._identity;</span>
<a href="#l85.593"></a><span id="l85.593">   },</span>
<a href="#l85.594"></a><span id="l85.594"> </span>
<a href="#l85.595"></a><span id="l85.595">   //</span>
<a href="#l85.596"></a><span id="l85.596">   // see nsIHttpServer.getState</span>
<a href="#l85.597"></a><span id="l85.597">   //</span>
<a href="#l85.598"></a><span id="l85.598" class="difflineminus">-  getState: function(path, k)</span>
<a href="#l85.599"></a><span id="l85.599" class="difflineminus">-  {</span>
<a href="#l85.600"></a><span id="l85.600" class="difflineplus">+  getState(path, k) {</span>
<a href="#l85.601"></a><span id="l85.601">     return this._handler._getState(path, k);</span>
<a href="#l85.602"></a><span id="l85.602">   },</span>
<a href="#l85.603"></a><span id="l85.603"> </span>
<a href="#l85.604"></a><span id="l85.604">   //</span>
<a href="#l85.605"></a><span id="l85.605">   // see nsIHttpServer.setState</span>
<a href="#l85.606"></a><span id="l85.606">   //</span>
<a href="#l85.607"></a><span id="l85.607" class="difflineminus">-  setState: function(path, k, v)</span>
<a href="#l85.608"></a><span id="l85.608" class="difflineminus">-  {</span>
<a href="#l85.609"></a><span id="l85.609" class="difflineplus">+  setState(path, k, v) {</span>
<a href="#l85.610"></a><span id="l85.610">     return this._handler._setState(path, k, v);</span>
<a href="#l85.611"></a><span id="l85.611">   },</span>
<a href="#l85.612"></a><span id="l85.612"> </span>
<a href="#l85.613"></a><span id="l85.613">   //</span>
<a href="#l85.614"></a><span id="l85.614">   // see nsIHttpServer.getSharedState</span>
<a href="#l85.615"></a><span id="l85.615">   //</span>
<a href="#l85.616"></a><span id="l85.616" class="difflineminus">-  getSharedState: function(k)</span>
<a href="#l85.617"></a><span id="l85.617" class="difflineminus">-  {</span>
<a href="#l85.618"></a><span id="l85.618" class="difflineplus">+  getSharedState(k) {</span>
<a href="#l85.619"></a><span id="l85.619">     return this._handler._getSharedState(k);</span>
<a href="#l85.620"></a><span id="l85.620">   },</span>
<a href="#l85.621"></a><span id="l85.621"> </span>
<a href="#l85.622"></a><span id="l85.622">   //</span>
<a href="#l85.623"></a><span id="l85.623">   // see nsIHttpServer.setSharedState</span>
<a href="#l85.624"></a><span id="l85.624">   //</span>
<a href="#l85.625"></a><span id="l85.625" class="difflineminus">-  setSharedState: function(k, v)</span>
<a href="#l85.626"></a><span id="l85.626" class="difflineminus">-  {</span>
<a href="#l85.627"></a><span id="l85.627" class="difflineplus">+  setSharedState(k, v) {</span>
<a href="#l85.628"></a><span id="l85.628">     return this._handler._setSharedState(k, v);</span>
<a href="#l85.629"></a><span id="l85.629">   },</span>
<a href="#l85.630"></a><span id="l85.630"> </span>
<a href="#l85.631"></a><span id="l85.631">   //</span>
<a href="#l85.632"></a><span id="l85.632">   // see nsIHttpServer.getObjectState</span>
<a href="#l85.633"></a><span id="l85.633">   //</span>
<a href="#l85.634"></a><span id="l85.634" class="difflineminus">-  getObjectState: function(k)</span>
<a href="#l85.635"></a><span id="l85.635" class="difflineminus">-  {</span>
<a href="#l85.636"></a><span id="l85.636" class="difflineplus">+  getObjectState(k) {</span>
<a href="#l85.637"></a><span id="l85.637">     return this._handler._getObjectState(k);</span>
<a href="#l85.638"></a><span id="l85.638">   },</span>
<a href="#l85.639"></a><span id="l85.639"> </span>
<a href="#l85.640"></a><span id="l85.640">   //</span>
<a href="#l85.641"></a><span id="l85.641">   // see nsIHttpServer.setObjectState</span>
<a href="#l85.642"></a><span id="l85.642">   //</span>
<a href="#l85.643"></a><span id="l85.643" class="difflineminus">-  setObjectState: function(k, v)</span>
<a href="#l85.644"></a><span id="l85.644" class="difflineminus">-  {</span>
<a href="#l85.645"></a><span id="l85.645" class="difflineplus">+  setObjectState(k, v) {</span>
<a href="#l85.646"></a><span id="l85.646">     return this._handler._setObjectState(k, v);</span>
<a href="#l85.647"></a><span id="l85.647">   },</span>
<a href="#l85.648"></a><span id="l85.648"> </span>
<a href="#l85.649"></a><span id="l85.649"> </span>
<a href="#l85.650"></a><span id="l85.650">   // NSISUPPORTS</span>
<a href="#l85.651"></a><span id="l85.651"> </span>
<a href="#l85.652"></a><span id="l85.652">   //</span>
<a href="#l85.653"></a><span id="l85.653">   // see nsISupports.QueryInterface</span>
<a href="#l85.654"></a><span id="l85.654">   //</span>
<a href="#l85.655"></a><span id="l85.655" class="difflineminus">-  QueryInterface: ChromeUtils.generateQI([&quot;nsIHttpServer&quot;,</span>
<a href="#l85.656"></a><span id="l85.656" class="difflineminus">-                                          &quot;nsIServerSocketListener&quot;]),</span>
<a href="#l85.657"></a><span id="l85.657" class="difflineplus">+  QueryInterface: ChromeUtils.generateQI([&quot;nsIHttpServer&quot;, &quot;nsIServerSocketListener&quot;]),</span>
<a href="#l85.658"></a><span id="l85.658"> </span>
<a href="#l85.659"></a><span id="l85.659"> </span>
<a href="#l85.660"></a><span id="l85.660">   // NON-XPCOM PUBLIC API</span>
<a href="#l85.661"></a><span id="l85.661"> </span>
<a href="#l85.662"></a><span id="l85.662">   /**</span>
<a href="#l85.663"></a><span id="l85.663">    * Returns true iff this server is not running (and is not in the process of</span>
<a href="#l85.664"></a><span id="l85.664">    * serving any requests still to be processed when the server was last</span>
<a href="#l85.665"></a><span id="l85.665">    * stopped after being run).</span>
<a href="#l85.666"></a><span id="l85.666">    */</span>
<a href="#l85.667"></a><span id="l85.667" class="difflineminus">-  isStopped: function()</span>
<a href="#l85.668"></a><span id="l85.668" class="difflineminus">-  {</span>
<a href="#l85.669"></a><span id="l85.669" class="difflineplus">+  isStopped() {</span>
<a href="#l85.670"></a><span id="l85.670">     return this._socketClosed &amp;&amp; !this._hasOpenConnections();</span>
<a href="#l85.671"></a><span id="l85.671">   },</span>
<a href="#l85.672"></a><span id="l85.672"> </span>
<a href="#l85.673"></a><span id="l85.673">   // PRIVATE IMPLEMENTATION</span>
<a href="#l85.674"></a><span id="l85.674"> </span>
<a href="#l85.675"></a><span id="l85.675">   /** True if this server has any open connections to it, false otherwise. */</span>
<a href="#l85.676"></a><span id="l85.676" class="difflineminus">-  _hasOpenConnections: function()</span>
<a href="#l85.677"></a><span id="l85.677" class="difflineminus">-  {</span>
<a href="#l85.678"></a><span id="l85.678" class="difflineplus">+  _hasOpenConnections() {</span>
<a href="#l85.679"></a><span id="l85.679">     //</span>
<a href="#l85.680"></a><span id="l85.680">     // If we have any open connections, they're tracked as numeric properties on</span>
<a href="#l85.681"></a><span id="l85.681">     // |this._connections|.  The non-standard __count__ property could be used</span>
<a href="#l85.682"></a><span id="l85.682">     // to check whether there are any properties, but standard-wise, even</span>
<a href="#l85.683"></a><span id="l85.683">     // looking forward to ES5, there's no less ugly yet still O(1) way to do</span>
<a href="#l85.684"></a><span id="l85.684">     // this.</span>
<a href="#l85.685"></a><span id="l85.685">     //</span>
<a href="#l85.686"></a><span id="l85.686">     for (var n in this._connections)</span>
<a href="#l85.687"></a><span id="l85.687">       return true;</span>
<a href="#l85.688"></a><span id="l85.688">     return false;</span>
<a href="#l85.689"></a><span id="l85.689">   },</span>
<a href="#l85.690"></a><span id="l85.690"> </span>
<a href="#l85.691"></a><span id="l85.691">   /** Calls the server-stopped callback provided when stop() was called. */</span>
<a href="#l85.692"></a><span id="l85.692" class="difflineminus">-  _notifyStopped: function()</span>
<a href="#l85.693"></a><span id="l85.693" class="difflineminus">-  {</span>
<a href="#l85.694"></a><span id="l85.694" class="difflineplus">+  _notifyStopped() {</span>
<a href="#l85.695"></a><span id="l85.695">     NS_ASSERT(this._stopCallback !== null, &quot;double-notifying?&quot;);</span>
<a href="#l85.696"></a><span id="l85.696">     NS_ASSERT(!this._hasOpenConnections(), &quot;should be done serving by now&quot;);</span>
<a href="#l85.697"></a><span id="l85.697"> </span>
<a href="#l85.698"></a><span id="l85.698">     //</span>
<a href="#l85.699"></a><span id="l85.699">     // NB: We have to grab this now, null out the member, *then* call the</span>
<a href="#l85.700"></a><span id="l85.700">     //     callback here, or otherwise the callback could (indirectly) futz with</span>
<a href="#l85.701"></a><span id="l85.701">     //     this._stopCallback by starting and immediately stopping this, at</span>
<a href="#l85.702"></a><span id="l85.702">     //     which point we'd be nulling out a field we no longer have a right to</span>
<a href="#l85.703"></a><span id="l85.703">     //     modify.</span>
<a href="#l85.704"></a><span id="l85.704">     //</span>
<a href="#l85.705"></a><span id="l85.705">     var callback = this._stopCallback;</span>
<a href="#l85.706"></a><span id="l85.706">     this._stopCallback = null;</span>
<a href="#l85.707"></a><span id="l85.707" class="difflineminus">-    try</span>
<a href="#l85.708"></a><span id="l85.708" class="difflineminus">-    {</span>
<a href="#l85.709"></a><span id="l85.709" class="difflineplus">+    try {</span>
<a href="#l85.710"></a><span id="l85.710">       if (typeof callback === &quot;function&quot;)</span>
<a href="#l85.711"></a><span id="l85.711">         callback();</span>
<a href="#l85.712"></a><span id="l85.712" class="difflineminus">-    }</span>
<a href="#l85.713"></a><span id="l85.713" class="difflineminus">-    catch (e)</span>
<a href="#l85.714"></a><span id="l85.714" class="difflineminus">-    {</span>
<a href="#l85.715"></a><span id="l85.715" class="difflineplus">+    } catch (e) {</span>
<a href="#l85.716"></a><span id="l85.716">       // not throwing because this is specified as being usually (but not</span>
<a href="#l85.717"></a><span id="l85.717">       // always) asynchronous</span>
<a href="#l85.718"></a><span id="l85.718">       dump(&quot;!!! error running onStopped callback: &quot; + e + &quot;\n&quot;);</span>
<a href="#l85.719"></a><span id="l85.719">     }</span>
<a href="#l85.720"></a><span id="l85.720">   },</span>
<a href="#l85.721"></a><span id="l85.721"> </span>
<a href="#l85.722"></a><span id="l85.722">   /**</span>
<a href="#l85.723"></a><span id="l85.723">    * Notifies this server that the given connection has been closed.</span>
<a href="#l85.724"></a><span id="l85.724">    *</span>
<a href="#l85.725"></a><span id="l85.725">    * @param connection : Connection</span>
<a href="#l85.726"></a><span id="l85.726">    *   the connection that was closed</span>
<a href="#l85.727"></a><span id="l85.727">    */</span>
<a href="#l85.728"></a><span id="l85.728" class="difflineminus">-  _connectionClosed: function(connection)</span>
<a href="#l85.729"></a><span id="l85.729" class="difflineminus">-  {</span>
<a href="#l85.730"></a><span id="l85.730" class="difflineplus">+  _connectionClosed(connection) {</span>
<a href="#l85.731"></a><span id="l85.731">     NS_ASSERT(connection.number in this._connections,</span>
<a href="#l85.732"></a><span id="l85.732">               &quot;closing a connection &quot; + this + &quot; that we never added to the &quot; +</span>
<a href="#l85.733"></a><span id="l85.733">               &quot;set of open connections?&quot;);</span>
<a href="#l85.734"></a><span id="l85.734">     NS_ASSERT(this._connections[connection.number] === connection,</span>
<a href="#l85.735"></a><span id="l85.735">               &quot;connection number mismatch?  &quot; +</span>
<a href="#l85.736"></a><span id="l85.736">               this._connections[connection.number]);</span>
<a href="#l85.737"></a><span id="l85.737">     delete this._connections[connection.number];</span>
<a href="#l85.738"></a><span id="l85.738"> </span>
<a href="#l85.739"></a><span id="l85.739" class="difflineat">@@ -781,69 +685,65 @@ nsHttpServer.prototype =</span>
<a href="#l85.740"></a><span id="l85.740">     // mochitests. We can't rely on xpcshell doing an automated GC, as that</span>
<a href="#l85.741"></a><span id="l85.741">     // would interfere with testing GC stuff...</span>
<a href="#l85.742"></a><span id="l85.742">     Cu.forceGC();</span>
<a href="#l85.743"></a><span id="l85.743">   },</span>
<a href="#l85.744"></a><span id="l85.744"> </span>
<a href="#l85.745"></a><span id="l85.745">   /**</span>
<a href="#l85.746"></a><span id="l85.746">    * Requests that the server be shut down when possible.</span>
<a href="#l85.747"></a><span id="l85.747">    */</span>
<a href="#l85.748"></a><span id="l85.748" class="difflineminus">-  _requestQuit: function()</span>
<a href="#l85.749"></a><span id="l85.749" class="difflineminus">-  {</span>
<a href="#l85.750"></a><span id="l85.750" class="difflineplus">+  _requestQuit() {</span>
<a href="#l85.751"></a><span id="l85.751">     dumpn(&quot;&gt;&gt;&gt; requesting a quit&quot;);</span>
<a href="#l85.752"></a><span id="l85.752">     dumpStack();</span>
<a href="#l85.753"></a><span id="l85.753">     this._doQuit = true;</span>
<a href="#l85.754"></a><span id="l85.754" class="difflineminus">-  }</span>
<a href="#l85.755"></a><span id="l85.755" class="difflineplus">+  },</span>
<a href="#l85.756"></a><span id="l85.756"> };</span>
<a href="#l85.757"></a><span id="l85.757"> </span>
<a href="#l85.758"></a><span id="l85.758"> var HttpServer = nsHttpServer;</span>
<a href="#l85.759"></a><span id="l85.759"> </span>
<a href="#l85.760"></a><span id="l85.760"> //</span>
<a href="#l85.761"></a><span id="l85.761"> // RFC 2396 section 3.2.2:</span>
<a href="#l85.762"></a><span id="l85.762"> //</span>
<a href="#l85.763"></a><span id="l85.763"> // host        = hostname | IPv4address</span>
<a href="#l85.764"></a><span id="l85.764"> // hostname    = *( domainlabel &quot;.&quot; ) toplabel [ &quot;.&quot; ]</span>
<a href="#l85.765"></a><span id="l85.765"> // domainlabel = alphanum | alphanum *( alphanum | &quot;-&quot; ) alphanum</span>
<a href="#l85.766"></a><span id="l85.766"> // toplabel    = alpha | alpha *( alphanum | &quot;-&quot; ) alphanum</span>
<a href="#l85.767"></a><span id="l85.767"> // IPv4address = 1*digit &quot;.&quot; 1*digit &quot;.&quot; 1*digit &quot;.&quot; 1*digit</span>
<a href="#l85.768"></a><span id="l85.768"> //</span>
<a href="#l85.769"></a><span id="l85.769"> </span>
<a href="#l85.770"></a><span id="l85.770" class="difflineminus">-var HOST_REGEX =</span>
<a href="#l85.771"></a><span id="l85.771" class="difflineminus">-  new RegExp(&quot;^(?:&quot; +</span>
<a href="#l85.772"></a><span id="l85.772" class="difflineminus">-               // *( domainlabel &quot;.&quot; )</span>
<a href="#l85.773"></a><span id="l85.773" class="difflineminus">-               &quot;(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\\.)*&quot; +</span>
<a href="#l85.774"></a><span id="l85.774" class="difflineminus">-               // toplabel</span>
<a href="#l85.775"></a><span id="l85.775" class="difflineminus">-               &quot;[a-z](?:[a-z0-9-]*[a-z0-9])?&quot; +</span>
<a href="#l85.776"></a><span id="l85.776" class="difflineminus">-             &quot;|&quot; +</span>
<a href="#l85.777"></a><span id="l85.777" class="difflineminus">-               // IPv4 address</span>
<a href="#l85.778"></a><span id="l85.778" class="difflineminus">-               &quot;\\d+\\.\\d+\\.\\d+\\.\\d+&quot; +</span>
<a href="#l85.779"></a><span id="l85.779" class="difflineminus">-             &quot;)$&quot;,</span>
<a href="#l85.780"></a><span id="l85.780" class="difflineminus">-             &quot;i&quot;);</span>
<a href="#l85.781"></a><span id="l85.781" class="difflineplus">+var HOST_REGEX = new RegExp(&quot;^(?:&quot; +</span>
<a href="#l85.782"></a><span id="l85.782" class="difflineplus">+  // *( domainlabel &quot;.&quot; )</span>
<a href="#l85.783"></a><span id="l85.783" class="difflineplus">+  &quot;(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\\.)*&quot; +</span>
<a href="#l85.784"></a><span id="l85.784" class="difflineplus">+  // toplabel</span>
<a href="#l85.785"></a><span id="l85.785" class="difflineplus">+  &quot;[a-z](?:[a-z0-9-]*[a-z0-9])?&quot; +</span>
<a href="#l85.786"></a><span id="l85.786" class="difflineplus">+  &quot;|&quot; +</span>
<a href="#l85.787"></a><span id="l85.787" class="difflineplus">+  // IPv4 address</span>
<a href="#l85.788"></a><span id="l85.788" class="difflineplus">+  &quot;\\d+\\.\\d+\\.\\d+\\.\\d+&quot; +</span>
<a href="#l85.789"></a><span id="l85.789" class="difflineplus">+  &quot;)$&quot;, &quot;i&quot;);</span>
<a href="#l85.790"></a><span id="l85.790"> </span>
<a href="#l85.791"></a><span id="l85.791"> </span>
<a href="#l85.792"></a><span id="l85.792"> /**</span>
<a href="#l85.793"></a><span id="l85.793">  * Represents the identity of a server.  An identity consists of a set of</span>
<a href="#l85.794"></a><span id="l85.794">  * (scheme, host, port) tuples denoted as locations (allowing a single server to</span>
<a href="#l85.795"></a><span id="l85.795">  * serve multiple sites or to be used behind both HTTP and HTTPS proxies for any</span>
<a href="#l85.796"></a><span id="l85.796">  * host/port).  Any incoming request must be to one of these locations, or it</span>
<a href="#l85.797"></a><span id="l85.797">  * will be rejected with an HTTP 400 error.  One location, denoted as the</span>
<a href="#l85.798"></a><span id="l85.798">  * primary location, is the location assigned in contexts where a location</span>
<a href="#l85.799"></a><span id="l85.799">  * cannot otherwise be endogenously derived, such as for HTTP/1.0 requests.</span>
<a href="#l85.800"></a><span id="l85.800">  *</span>
<a href="#l85.801"></a><span id="l85.801">  * A single identity may contain at most one location per unique host/port pair;</span>
<a href="#l85.802"></a><span id="l85.802">  * other than that, no restrictions are placed upon what locations may</span>
<a href="#l85.803"></a><span id="l85.803">  * constitute an identity.</span>
<a href="#l85.804"></a><span id="l85.804">  */</span>
<a href="#l85.805"></a><span id="l85.805" class="difflineminus">-function ServerIdentity()</span>
<a href="#l85.806"></a><span id="l85.806" class="difflineminus">-{</span>
<a href="#l85.807"></a><span id="l85.807" class="difflineplus">+function ServerIdentity() {</span>
<a href="#l85.808"></a><span id="l85.808">   /** The scheme of the primary location. */</span>
<a href="#l85.809"></a><span id="l85.809">   this._primaryScheme = &quot;http&quot;;</span>
<a href="#l85.810"></a><span id="l85.810"> </span>
<a href="#l85.811"></a><span id="l85.811">   /** The hostname of the primary location. */</span>
<a href="#l85.812"></a><span id="l85.812" class="difflineminus">-  this._primaryHost = &quot;127.0.0.1&quot;</span>
<a href="#l85.813"></a><span id="l85.813" class="difflineplus">+  this._primaryHost = &quot;127.0.0.1&quot;;</span>
<a href="#l85.814"></a><span id="l85.814"> </span>
<a href="#l85.815"></a><span id="l85.815">   /** The port number of the primary location. */</span>
<a href="#l85.816"></a><span id="l85.816">   this._primaryPort = -1;</span>
<a href="#l85.817"></a><span id="l85.817"> </span>
<a href="#l85.818"></a><span id="l85.818">   /**</span>
<a href="#l85.819"></a><span id="l85.819">    * The current port number for the corresponding server, stored so that a new</span>
<a href="#l85.820"></a><span id="l85.820">    * primary location can always be set if the current one is removed.</span>
<a href="#l85.821"></a><span id="l85.821">    */</span>
<a href="#l85.822"></a><span id="l85.822" class="difflineat">@@ -858,122 +758,112 @@ function ServerIdentity()</span>
<a href="#l85.823"></a><span id="l85.823">    *     &quot;xexample.org&quot;: { 80: &quot;http&quot; }</span>
<a href="#l85.824"></a><span id="l85.824">    *   }</span>
<a href="#l85.825"></a><span id="l85.825">    *</span>
<a href="#l85.826"></a><span id="l85.826">    * Note the &quot;x&quot; prefix on hostnames, which prevents collisions with special</span>
<a href="#l85.827"></a><span id="l85.827">    * JS names like &quot;prototype&quot;.</span>
<a href="#l85.828"></a><span id="l85.828">    */</span>
<a href="#l85.829"></a><span id="l85.829">   this._locations = { &quot;xlocalhost&quot;: {} };</span>
<a href="#l85.830"></a><span id="l85.830"> }</span>
<a href="#l85.831"></a><span id="l85.831" class="difflineminus">-ServerIdentity.prototype =</span>
<a href="#l85.832"></a><span id="l85.832" class="difflineminus">-{</span>
<a href="#l85.833"></a><span id="l85.833" class="difflineplus">+ServerIdentity.prototype = {</span>
<a href="#l85.834"></a><span id="l85.834">   // NSIHTTPSERVERIDENTITY</span>
<a href="#l85.835"></a><span id="l85.835"> </span>
<a href="#l85.836"></a><span id="l85.836">   //</span>
<a href="#l85.837"></a><span id="l85.837">   // see nsIHttpServerIdentity.primaryScheme</span>
<a href="#l85.838"></a><span id="l85.838">   //</span>
<a href="#l85.839"></a><span id="l85.839" class="difflineminus">-  get primaryScheme()</span>
<a href="#l85.840"></a><span id="l85.840" class="difflineminus">-  {</span>
<a href="#l85.841"></a><span id="l85.841" class="difflineplus">+  get primaryScheme() {</span>
<a href="#l85.842"></a><span id="l85.842">     if (this._primaryPort === -1)</span>
<a href="#l85.843"></a><span id="l85.843">       throw Cr.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l85.844"></a><span id="l85.844">     return this._primaryScheme;</span>
<a href="#l85.845"></a><span id="l85.845">   },</span>
<a href="#l85.846"></a><span id="l85.846"> </span>
<a href="#l85.847"></a><span id="l85.847">   //</span>
<a href="#l85.848"></a><span id="l85.848">   // see nsIHttpServerIdentity.primaryHost</span>
<a href="#l85.849"></a><span id="l85.849">   //</span>
<a href="#l85.850"></a><span id="l85.850" class="difflineminus">-  get primaryHost()</span>
<a href="#l85.851"></a><span id="l85.851" class="difflineminus">-  {</span>
<a href="#l85.852"></a><span id="l85.852" class="difflineplus">+  get primaryHost() {</span>
<a href="#l85.853"></a><span id="l85.853">     if (this._primaryPort === -1)</span>
<a href="#l85.854"></a><span id="l85.854">       throw Cr.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l85.855"></a><span id="l85.855">     return this._primaryHost;</span>
<a href="#l85.856"></a><span id="l85.856">   },</span>
<a href="#l85.857"></a><span id="l85.857"> </span>
<a href="#l85.858"></a><span id="l85.858">   //</span>
<a href="#l85.859"></a><span id="l85.859">   // see nsIHttpServerIdentity.primaryPort</span>
<a href="#l85.860"></a><span id="l85.860">   //</span>
<a href="#l85.861"></a><span id="l85.861" class="difflineminus">-  get primaryPort()</span>
<a href="#l85.862"></a><span id="l85.862" class="difflineminus">-  {</span>
<a href="#l85.863"></a><span id="l85.863" class="difflineplus">+  get primaryPort() {</span>
<a href="#l85.864"></a><span id="l85.864">     if (this._primaryPort === -1)</span>
<a href="#l85.865"></a><span id="l85.865">       throw Cr.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l85.866"></a><span id="l85.866">     return this._primaryPort;</span>
<a href="#l85.867"></a><span id="l85.867">   },</span>
<a href="#l85.868"></a><span id="l85.868"> </span>
<a href="#l85.869"></a><span id="l85.869">   //</span>
<a href="#l85.870"></a><span id="l85.870">   // see nsIHttpServerIdentity.add</span>
<a href="#l85.871"></a><span id="l85.871">   //</span>
<a href="#l85.872"></a><span id="l85.872" class="difflineminus">-  add: function(scheme, host, port)</span>
<a href="#l85.873"></a><span id="l85.873" class="difflineminus">-  {</span>
<a href="#l85.874"></a><span id="l85.874" class="difflineplus">+  add(scheme, host, port) {</span>
<a href="#l85.875"></a><span id="l85.875">     this._validate(scheme, host, port);</span>
<a href="#l85.876"></a><span id="l85.876"> </span>
<a href="#l85.877"></a><span id="l85.877">     var entry = this._locations[&quot;x&quot; + host];</span>
<a href="#l85.878"></a><span id="l85.878">     if (!entry)</span>
<a href="#l85.879"></a><span id="l85.879">       this._locations[&quot;x&quot; + host] = entry = {};</span>
<a href="#l85.880"></a><span id="l85.880"> </span>
<a href="#l85.881"></a><span id="l85.881">     entry[port] = scheme;</span>
<a href="#l85.882"></a><span id="l85.882">   },</span>
<a href="#l85.883"></a><span id="l85.883"> </span>
<a href="#l85.884"></a><span id="l85.884">   //</span>
<a href="#l85.885"></a><span id="l85.885">   // see nsIHttpServerIdentity.remove</span>
<a href="#l85.886"></a><span id="l85.886">   //</span>
<a href="#l85.887"></a><span id="l85.887" class="difflineminus">-  remove: function(scheme, host, port)</span>
<a href="#l85.888"></a><span id="l85.888" class="difflineminus">-  {</span>
<a href="#l85.889"></a><span id="l85.889" class="difflineplus">+  remove(scheme, host, port) {</span>
<a href="#l85.890"></a><span id="l85.890">     this._validate(scheme, host, port);</span>
<a href="#l85.891"></a><span id="l85.891"> </span>
<a href="#l85.892"></a><span id="l85.892">     var entry = this._locations[&quot;x&quot; + host];</span>
<a href="#l85.893"></a><span id="l85.893">     if (!entry)</span>
<a href="#l85.894"></a><span id="l85.894">       return false;</span>
<a href="#l85.895"></a><span id="l85.895"> </span>
<a href="#l85.896"></a><span id="l85.896">     var present = port in entry;</span>
<a href="#l85.897"></a><span id="l85.897">     delete entry[port];</span>
<a href="#l85.898"></a><span id="l85.898"> </span>
<a href="#l85.899"></a><span id="l85.899">     if (this._primaryScheme == scheme &amp;&amp;</span>
<a href="#l85.900"></a><span id="l85.900">         this._primaryHost == host &amp;&amp;</span>
<a href="#l85.901"></a><span id="l85.901">         this._primaryPort == port &amp;&amp;</span>
<a href="#l85.902"></a><span id="l85.902" class="difflineminus">-        this._defaultPort !== -1)</span>
<a href="#l85.903"></a><span id="l85.903" class="difflineminus">-    {</span>
<a href="#l85.904"></a><span id="l85.904" class="difflineplus">+        this._defaultPort !== -1) {</span>
<a href="#l85.905"></a><span id="l85.905">       // Always keep at least one identity in existence at any time, unless</span>
<a href="#l85.906"></a><span id="l85.906">       // we're in the process of shutting down (the last condition above).</span>
<a href="#l85.907"></a><span id="l85.907">       this._primaryPort = -1;</span>
<a href="#l85.908"></a><span id="l85.908">       this._initialize(this._defaultPort, host, false);</span>
<a href="#l85.909"></a><span id="l85.909">     }</span>
<a href="#l85.910"></a><span id="l85.910"> </span>
<a href="#l85.911"></a><span id="l85.911">     return present;</span>
<a href="#l85.912"></a><span id="l85.912">   },</span>
<a href="#l85.913"></a><span id="l85.913"> </span>
<a href="#l85.914"></a><span id="l85.914">   //</span>
<a href="#l85.915"></a><span id="l85.915">   // see nsIHttpServerIdentity.has</span>
<a href="#l85.916"></a><span id="l85.916">   //</span>
<a href="#l85.917"></a><span id="l85.917" class="difflineminus">-  has: function(scheme, host, port)</span>
<a href="#l85.918"></a><span id="l85.918" class="difflineminus">-  {</span>
<a href="#l85.919"></a><span id="l85.919" class="difflineplus">+  has(scheme, host, port) {</span>
<a href="#l85.920"></a><span id="l85.920">     this._validate(scheme, host, port);</span>
<a href="#l85.921"></a><span id="l85.921"> </span>
<a href="#l85.922"></a><span id="l85.922">     return &quot;x&quot; + host in this._locations &amp;&amp;</span>
<a href="#l85.923"></a><span id="l85.923">            scheme === this._locations[&quot;x&quot; + host][port];</span>
<a href="#l85.924"></a><span id="l85.924">   },</span>
<a href="#l85.925"></a><span id="l85.925"> </span>
<a href="#l85.926"></a><span id="l85.926">   //</span>
<a href="#l85.927"></a><span id="l85.927">   // see nsIHttpServerIdentity.has</span>
<a href="#l85.928"></a><span id="l85.928">   //</span>
<a href="#l85.929"></a><span id="l85.929" class="difflineminus">-  getScheme: function(host, port)</span>
<a href="#l85.930"></a><span id="l85.930" class="difflineminus">-  {</span>
<a href="#l85.931"></a><span id="l85.931" class="difflineplus">+  getScheme(host, port) {</span>
<a href="#l85.932"></a><span id="l85.932">     this._validate(&quot;http&quot;, host, port);</span>
<a href="#l85.933"></a><span id="l85.933"> </span>
<a href="#l85.934"></a><span id="l85.934">     var entry = this._locations[&quot;x&quot; + host];</span>
<a href="#l85.935"></a><span id="l85.935">     if (!entry)</span>
<a href="#l85.936"></a><span id="l85.936">       return &quot;&quot;;</span>
<a href="#l85.937"></a><span id="l85.937"> </span>
<a href="#l85.938"></a><span id="l85.938">     return entry[port] || &quot;&quot;;</span>
<a href="#l85.939"></a><span id="l85.939">   },</span>
<a href="#l85.940"></a><span id="l85.940"> </span>
<a href="#l85.941"></a><span id="l85.941">   //</span>
<a href="#l85.942"></a><span id="l85.942">   // see nsIHttpServerIdentity.setPrimary</span>
<a href="#l85.943"></a><span id="l85.943">   //</span>
<a href="#l85.944"></a><span id="l85.944" class="difflineminus">-  setPrimary: function(scheme, host, port)</span>
<a href="#l85.945"></a><span id="l85.945" class="difflineminus">-  {</span>
<a href="#l85.946"></a><span id="l85.946" class="difflineplus">+  setPrimary(scheme, host, port) {</span>
<a href="#l85.947"></a><span id="l85.947">     this._validate(scheme, host, port);</span>
<a href="#l85.948"></a><span id="l85.948"> </span>
<a href="#l85.949"></a><span id="l85.949">     this.add(scheme, host, port);</span>
<a href="#l85.950"></a><span id="l85.950"> </span>
<a href="#l85.951"></a><span id="l85.951">     this._primaryScheme = scheme;</span>
<a href="#l85.952"></a><span id="l85.952">     this._primaryHost = host;</span>
<a href="#l85.953"></a><span id="l85.953">     this._primaryPort = port;</span>
<a href="#l85.954"></a><span id="l85.954">   },</span>
<a href="#l85.955"></a><span id="l85.955" class="difflineat">@@ -988,18 +878,17 @@ ServerIdentity.prototype =</span>
<a href="#l85.956"></a><span id="l85.956"> </span>
<a href="#l85.957"></a><span id="l85.957"> </span>
<a href="#l85.958"></a><span id="l85.958">   // PRIVATE IMPLEMENTATION</span>
<a href="#l85.959"></a><span id="l85.959"> </span>
<a href="#l85.960"></a><span id="l85.960">   /**</span>
<a href="#l85.961"></a><span id="l85.961">    * Initializes the primary name for the corresponding server, based on the</span>
<a href="#l85.962"></a><span id="l85.962">    * provided port number.</span>
<a href="#l85.963"></a><span id="l85.963">    */</span>
<a href="#l85.964"></a><span id="l85.964" class="difflineminus">-  _initialize: function(port, host, addSecondaryDefault)</span>
<a href="#l85.965"></a><span id="l85.965" class="difflineminus">-  {</span>
<a href="#l85.966"></a><span id="l85.966" class="difflineplus">+  _initialize(port, host, addSecondaryDefault) {</span>
<a href="#l85.967"></a><span id="l85.967">     this._host = host;</span>
<a href="#l85.968"></a><span id="l85.968">     if (this._primaryPort !== -1)</span>
<a href="#l85.969"></a><span id="l85.969">       this.add(&quot;http&quot;, host, port);</span>
<a href="#l85.970"></a><span id="l85.970">     else</span>
<a href="#l85.971"></a><span id="l85.971">       this.setPrimary(&quot;http&quot;, &quot;localhost&quot;, port);</span>
<a href="#l85.972"></a><span id="l85.972">     this._defaultPort = port;</span>
<a href="#l85.973"></a><span id="l85.973"> </span>
<a href="#l85.974"></a><span id="l85.974">     // Only add this if we're being called at server startup</span>
<a href="#l85.975"></a><span id="l85.975" class="difflineat">@@ -1007,70 +896,62 @@ ServerIdentity.prototype =</span>
<a href="#l85.976"></a><span id="l85.976">       this.add(&quot;http&quot;, &quot;127.0.0.1&quot;, port);</span>
<a href="#l85.977"></a><span id="l85.977">   },</span>
<a href="#l85.978"></a><span id="l85.978"> </span>
<a href="#l85.979"></a><span id="l85.979">   /**</span>
<a href="#l85.980"></a><span id="l85.980">    * Called at server shutdown time, unsets the primary location only if it was</span>
<a href="#l85.981"></a><span id="l85.981">    * the default-assigned location and removes the default location from the</span>
<a href="#l85.982"></a><span id="l85.982">    * set of locations used.</span>
<a href="#l85.983"></a><span id="l85.983">    */</span>
<a href="#l85.984"></a><span id="l85.984" class="difflineminus">-  _teardown: function()</span>
<a href="#l85.985"></a><span id="l85.985" class="difflineminus">-  {</span>
<a href="#l85.986"></a><span id="l85.986" class="difflineplus">+  _teardown() {</span>
<a href="#l85.987"></a><span id="l85.987">     if (this._host != &quot;127.0.0.1&quot;) {</span>
<a href="#l85.988"></a><span id="l85.988">       // Not the default primary location, nothing special to do here</span>
<a href="#l85.989"></a><span id="l85.989">       this.remove(&quot;http&quot;, &quot;127.0.0.1&quot;, this._defaultPort);</span>
<a href="#l85.990"></a><span id="l85.990">     }</span>
<a href="#l85.991"></a><span id="l85.991"> </span>
<a href="#l85.992"></a><span id="l85.992">     // This is a *very* tricky bit of reasoning here; make absolutely sure the</span>
<a href="#l85.993"></a><span id="l85.993">     // tests for this code pass before you commit changes to it.</span>
<a href="#l85.994"></a><span id="l85.994">     if (this._primaryScheme == &quot;http&quot; &amp;&amp;</span>
<a href="#l85.995"></a><span id="l85.995">         this._primaryHost == this._host &amp;&amp;</span>
<a href="#l85.996"></a><span id="l85.996" class="difflineminus">-        this._primaryPort == this._defaultPort)</span>
<a href="#l85.997"></a><span id="l85.997" class="difflineminus">-    {</span>
<a href="#l85.998"></a><span id="l85.998" class="difflineplus">+        this._primaryPort == this._defaultPort) {</span>
<a href="#l85.999"></a><span id="l85.999">       // Make sure we don't trigger the readding logic in .remove(), then remove</span>
<a href="#l85.1000"></a><span id="l85.1000">       // the default location.</span>
<a href="#l85.1001"></a><span id="l85.1001">       var port = this._defaultPort;</span>
<a href="#l85.1002"></a><span id="l85.1002">       this._defaultPort = -1;</span>
<a href="#l85.1003"></a><span id="l85.1003">       this.remove(&quot;http&quot;, this._host, port);</span>
<a href="#l85.1004"></a><span id="l85.1004"> </span>
<a href="#l85.1005"></a><span id="l85.1005">       // Ensure a server start triggers the setPrimary() path in ._initialize()</span>
<a href="#l85.1006"></a><span id="l85.1006">       this._primaryPort = -1;</span>
<a href="#l85.1007"></a><span id="l85.1007" class="difflineminus">-    }</span>
<a href="#l85.1008"></a><span id="l85.1008" class="difflineminus">-    else</span>
<a href="#l85.1009"></a><span id="l85.1009" class="difflineminus">-    {</span>
<a href="#l85.1010"></a><span id="l85.1010" class="difflineplus">+    } else {</span>
<a href="#l85.1011"></a><span id="l85.1011">       // No reason not to remove directly as it's not our primary location</span>
<a href="#l85.1012"></a><span id="l85.1012">       this.remove(&quot;http&quot;, this._host, this._defaultPort);</span>
<a href="#l85.1013"></a><span id="l85.1013">     }</span>
<a href="#l85.1014"></a><span id="l85.1014">   },</span>
<a href="#l85.1015"></a><span id="l85.1015"> </span>
<a href="#l85.1016"></a><span id="l85.1016">   /**</span>
<a href="#l85.1017"></a><span id="l85.1017">    * Ensures scheme, host, and port are all valid with respect to RFC 2396.</span>
<a href="#l85.1018"></a><span id="l85.1018">    *</span>
<a href="#l85.1019"></a><span id="l85.1019">    * @throws NS_ERROR_ILLEGAL_VALUE</span>
<a href="#l85.1020"></a><span id="l85.1020">    *   if any argument doesn't match the corresponding production</span>
<a href="#l85.1021"></a><span id="l85.1021">    */</span>
<a href="#l85.1022"></a><span id="l85.1022" class="difflineminus">-  _validate: function(scheme, host, port)</span>
<a href="#l85.1023"></a><span id="l85.1023" class="difflineminus">-  {</span>
<a href="#l85.1024"></a><span id="l85.1024" class="difflineminus">-    if (scheme !== &quot;http&quot; &amp;&amp; scheme !== &quot;https&quot;)</span>
<a href="#l85.1025"></a><span id="l85.1025" class="difflineminus">-    {</span>
<a href="#l85.1026"></a><span id="l85.1026" class="difflineplus">+  _validate(scheme, host, port) {</span>
<a href="#l85.1027"></a><span id="l85.1027" class="difflineplus">+    if (scheme !== &quot;http&quot; &amp;&amp; scheme !== &quot;https&quot;) {</span>
<a href="#l85.1028"></a><span id="l85.1028">       dumpn(&quot;*** server only supports http/https schemes: '&quot; + scheme + &quot;'&quot;);</span>
<a href="#l85.1029"></a><span id="l85.1029">       dumpStack();</span>
<a href="#l85.1030"></a><span id="l85.1030">       throw Cr.NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l85.1031"></a><span id="l85.1031">     }</span>
<a href="#l85.1032"></a><span id="l85.1032" class="difflineminus">-    if (!HOST_REGEX.test(host))</span>
<a href="#l85.1033"></a><span id="l85.1033" class="difflineminus">-    {</span>
<a href="#l85.1034"></a><span id="l85.1034" class="difflineplus">+    if (!HOST_REGEX.test(host)) {</span>
<a href="#l85.1035"></a><span id="l85.1035">       dumpn(&quot;*** unexpected host: '&quot; + host + &quot;'&quot;);</span>
<a href="#l85.1036"></a><span id="l85.1036">       throw Cr.NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l85.1037"></a><span id="l85.1037">     }</span>
<a href="#l85.1038"></a><span id="l85.1038" class="difflineminus">-    if (port &lt; 0 || port &gt; 65535)</span>
<a href="#l85.1039"></a><span id="l85.1039" class="difflineminus">-    {</span>
<a href="#l85.1040"></a><span id="l85.1040" class="difflineplus">+    if (port &lt; 0 || port &gt; 65535) {</span>
<a href="#l85.1041"></a><span id="l85.1041">       dumpn(&quot;*** unexpected port: '&quot; + port + &quot;'&quot;);</span>
<a href="#l85.1042"></a><span id="l85.1042">       throw Cr.NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l85.1043"></a><span id="l85.1043">     }</span>
<a href="#l85.1044"></a><span id="l85.1044" class="difflineminus">-  }</span>
<a href="#l85.1045"></a><span id="l85.1045" class="difflineplus">+  },</span>
<a href="#l85.1046"></a><span id="l85.1046"> };</span>
<a href="#l85.1047"></a><span id="l85.1047"> </span>
<a href="#l85.1048"></a><span id="l85.1048"> </span>
<a href="#l85.1049"></a><span id="l85.1049"> /**</span>
<a href="#l85.1050"></a><span id="l85.1050">  * Represents a connection to the server (and possibly in the future the thread</span>
<a href="#l85.1051"></a><span id="l85.1051">  * on which the connection is processed).</span>
<a href="#l85.1052"></a><span id="l85.1052">  *</span>
<a href="#l85.1053"></a><span id="l85.1053">  * @param input : nsIInputStream</span>
<a href="#l85.1054"></a><span id="l85.1054" class="difflineat">@@ -1081,18 +962,17 @@ ServerIdentity.prototype =</span>
<a href="#l85.1055"></a><span id="l85.1055">  *   the server handling the connection</span>
<a href="#l85.1056"></a><span id="l85.1056">  * @param port : int</span>
<a href="#l85.1057"></a><span id="l85.1057">  *   the port on which the server is running</span>
<a href="#l85.1058"></a><span id="l85.1058">  * @param outgoingPort : int</span>
<a href="#l85.1059"></a><span id="l85.1059">  *   the outgoing port used by this connection</span>
<a href="#l85.1060"></a><span id="l85.1060">  * @param number : uint</span>
<a href="#l85.1061"></a><span id="l85.1061">  *   a serial number used to uniquely identify this connection</span>
<a href="#l85.1062"></a><span id="l85.1062">  */</span>
<a href="#l85.1063"></a><span id="l85.1063" class="difflineminus">-function Connection(input, output, server, port, outgoingPort, number)</span>
<a href="#l85.1064"></a><span id="l85.1064" class="difflineminus">-{</span>
<a href="#l85.1065"></a><span id="l85.1065" class="difflineplus">+function Connection(input, output, server, port, outgoingPort, number) {</span>
<a href="#l85.1066"></a><span id="l85.1066">   dumpn(&quot;*** opening new connection &quot; + number + &quot; on port &quot; + outgoingPort);</span>
<a href="#l85.1067"></a><span id="l85.1067"> </span>
<a href="#l85.1068"></a><span id="l85.1068">   /** Stream of incoming data. */</span>
<a href="#l85.1069"></a><span id="l85.1069">   this.input = input;</span>
<a href="#l85.1070"></a><span id="l85.1070"> </span>
<a href="#l85.1071"></a><span id="l85.1071">   /** Stream for outgoing data. */</span>
<a href="#l85.1072"></a><span id="l85.1072">   this.output = output;</span>
<a href="#l85.1073"></a><span id="l85.1073"> </span>
<a href="#l85.1074"></a><span id="l85.1074" class="difflineat">@@ -1112,21 +992,19 @@ function Connection(input, output, serve</span>
<a href="#l85.1075"></a><span id="l85.1075">    * The request for which a response is being generated, null if the</span>
<a href="#l85.1076"></a><span id="l85.1076">    * incoming request has not been fully received or if it had errors.</span>
<a href="#l85.1077"></a><span id="l85.1077">    */</span>
<a href="#l85.1078"></a><span id="l85.1078">   this.request = null;</span>
<a href="#l85.1079"></a><span id="l85.1079"> </span>
<a href="#l85.1080"></a><span id="l85.1080">   /** State variables for debugging. */</span>
<a href="#l85.1081"></a><span id="l85.1081">   this._closed = this._processed = false;</span>
<a href="#l85.1082"></a><span id="l85.1082"> }</span>
<a href="#l85.1083"></a><span id="l85.1083" class="difflineminus">-Connection.prototype =</span>
<a href="#l85.1084"></a><span id="l85.1084" class="difflineminus">-{</span>
<a href="#l85.1085"></a><span id="l85.1085" class="difflineplus">+Connection.prototype = {</span>
<a href="#l85.1086"></a><span id="l85.1086">   /** Closes this connection's input/output streams. */</span>
<a href="#l85.1087"></a><span id="l85.1087" class="difflineminus">-  close: function()</span>
<a href="#l85.1088"></a><span id="l85.1088" class="difflineminus">-  {</span>
<a href="#l85.1089"></a><span id="l85.1089" class="difflineplus">+  close() {</span>
<a href="#l85.1090"></a><span id="l85.1090">     dumpn(&quot;*** closing connection &quot; + this.number +</span>
<a href="#l85.1091"></a><span id="l85.1091">           &quot; on port &quot; + this._outgoingPort);</span>
<a href="#l85.1092"></a><span id="l85.1092"> </span>
<a href="#l85.1093"></a><span id="l85.1093">     this.input.close();</span>
<a href="#l85.1094"></a><span id="l85.1094">     this.output.close();</span>
<a href="#l85.1095"></a><span id="l85.1095">     this._closed = true;</span>
<a href="#l85.1096"></a><span id="l85.1096"> </span>
<a href="#l85.1097"></a><span id="l85.1097">     var server = this.server;</span>
<a href="#l85.1098"></a><span id="l85.1098" class="difflineat">@@ -1139,18 +1017,17 @@ Connection.prototype =</span>
<a href="#l85.1099"></a><span id="l85.1099"> </span>
<a href="#l85.1100"></a><span id="l85.1100">   /**</span>
<a href="#l85.1101"></a><span id="l85.1101">    * Initiates processing of this connection, using the data in the given</span>
<a href="#l85.1102"></a><span id="l85.1102">    * request.</span>
<a href="#l85.1103"></a><span id="l85.1103">    *</span>
<a href="#l85.1104"></a><span id="l85.1104">    * @param request : Request</span>
<a href="#l85.1105"></a><span id="l85.1105">    *   the request which should be processed</span>
<a href="#l85.1106"></a><span id="l85.1106">    */</span>
<a href="#l85.1107"></a><span id="l85.1107" class="difflineminus">-  process: function(request)</span>
<a href="#l85.1108"></a><span id="l85.1108" class="difflineminus">-  {</span>
<a href="#l85.1109"></a><span id="l85.1109" class="difflineplus">+  process(request) {</span>
<a href="#l85.1110"></a><span id="l85.1110">     NS_ASSERT(!this._closed &amp;&amp; !this._processed);</span>
<a href="#l85.1111"></a><span id="l85.1111"> </span>
<a href="#l85.1112"></a><span id="l85.1112">     this._processed = true;</span>
<a href="#l85.1113"></a><span id="l85.1113"> </span>
<a href="#l85.1114"></a><span id="l85.1114">     this.request = request;</span>
<a href="#l85.1115"></a><span id="l85.1115">     this.server._handler.handleResponse(this);</span>
<a href="#l85.1116"></a><span id="l85.1116">   },</span>
<a href="#l85.1117"></a><span id="l85.1117"> </span>
<a href="#l85.1118"></a><span id="l85.1118" class="difflineat">@@ -1159,39 +1036,36 @@ Connection.prototype =</span>
<a href="#l85.1119"></a><span id="l85.1119">    * given HTTP error code.</span>
<a href="#l85.1120"></a><span id="l85.1120">    *</span>
<a href="#l85.1121"></a><span id="l85.1121">    * @param code : uint</span>
<a href="#l85.1122"></a><span id="l85.1122">    *   an HTTP code, so in the range [0, 1000)</span>
<a href="#l85.1123"></a><span id="l85.1123">    * @param request : Request</span>
<a href="#l85.1124"></a><span id="l85.1124">    *   incomplete data about the incoming request (since there were errors</span>
<a href="#l85.1125"></a><span id="l85.1125">    *   during its processing</span>
<a href="#l85.1126"></a><span id="l85.1126">    */</span>
<a href="#l85.1127"></a><span id="l85.1127" class="difflineminus">-  processError: function(code, request)</span>
<a href="#l85.1128"></a><span id="l85.1128" class="difflineminus">-  {</span>
<a href="#l85.1129"></a><span id="l85.1129" class="difflineplus">+  processError(code, request) {</span>
<a href="#l85.1130"></a><span id="l85.1130">     NS_ASSERT(!this._closed &amp;&amp; !this._processed);</span>
<a href="#l85.1131"></a><span id="l85.1131"> </span>
<a href="#l85.1132"></a><span id="l85.1132">     this._processed = true;</span>
<a href="#l85.1133"></a><span id="l85.1133">     this.request = request;</span>
<a href="#l85.1134"></a><span id="l85.1134">     this.server._handler.handleError(code, this);</span>
<a href="#l85.1135"></a><span id="l85.1135">   },</span>
<a href="#l85.1136"></a><span id="l85.1136"> </span>
<a href="#l85.1137"></a><span id="l85.1137">   /** Converts this to a string for debugging purposes. */</span>
<a href="#l85.1138"></a><span id="l85.1138" class="difflineminus">-  toString: function()</span>
<a href="#l85.1139"></a><span id="l85.1139" class="difflineminus">-  {</span>
<a href="#l85.1140"></a><span id="l85.1140" class="difflineplus">+  toString() {</span>
<a href="#l85.1141"></a><span id="l85.1141">     return &quot;&lt;Connection(&quot; + this.number +</span>
<a href="#l85.1142"></a><span id="l85.1142" class="difflineminus">-           (this.request ? &quot;, &quot; + this.request.path : &quot;&quot;) +&quot;): &quot; +</span>
<a href="#l85.1143"></a><span id="l85.1143" class="difflineplus">+           (this.request ? &quot;, &quot; + this.request.path : &quot;&quot;) + &quot;): &quot; +</span>
<a href="#l85.1144"></a><span id="l85.1144">            (this._closed ? &quot;closed&quot; : &quot;open&quot;) + &quot;&gt;&quot;;</span>
<a href="#l85.1145"></a><span id="l85.1145" class="difflineminus">-  }</span>
<a href="#l85.1146"></a><span id="l85.1146" class="difflineplus">+  },</span>
<a href="#l85.1147"></a><span id="l85.1147"> };</span>
<a href="#l85.1148"></a><span id="l85.1148"> </span>
<a href="#l85.1149"></a><span id="l85.1149"> </span>
<a href="#l85.1150"></a><span id="l85.1150"> </span>
<a href="#l85.1151"></a><span id="l85.1151"> /** Returns an array of count bytes from the given input stream. */</span>
<a href="#l85.1152"></a><span id="l85.1152" class="difflineminus">-function readBytes(inputStream, count)</span>
<a href="#l85.1153"></a><span id="l85.1153" class="difflineminus">-{</span>
<a href="#l85.1154"></a><span id="l85.1154" class="difflineplus">+function readBytes(inputStream, count) {</span>
<a href="#l85.1155"></a><span id="l85.1155">   return new BinaryInputStream(inputStream).readByteArray(count);</span>
<a href="#l85.1156"></a><span id="l85.1156"> }</span>
<a href="#l85.1157"></a><span id="l85.1157"> </span>
<a href="#l85.1158"></a><span id="l85.1158"> </span>
<a href="#l85.1159"></a><span id="l85.1159"> </span>
<a href="#l85.1160"></a><span id="l85.1160"> /** Request reader processing states; see RequestReader for details. */</span>
<a href="#l85.1161"></a><span id="l85.1161"> var READER_IN_REQUEST_LINE = 0;</span>
<a href="#l85.1162"></a><span id="l85.1162"> var READER_IN_HEADERS      = 1;</span>
<a href="#l85.1163"></a><span id="l85.1163" class="difflineat">@@ -1212,18 +1086,17 @@ var READER_FINISHED        = 3;</span>
<a href="#l85.1164"></a><span id="l85.1164">  * into a Request object.  Once the status line and headers have been processed,</span>
<a href="#l85.1165"></a><span id="l85.1165">  * we start processing the body of the request into the Request.  Finally, when</span>
<a href="#l85.1166"></a><span id="l85.1166">  * the entire body has been read, we create a Response and hand it off to the</span>
<a href="#l85.1167"></a><span id="l85.1167">  * ServerHandler to be given to the appropriate request handler.</span>
<a href="#l85.1168"></a><span id="l85.1168">  *</span>
<a href="#l85.1169"></a><span id="l85.1169">  * @param connection : Connection</span>
<a href="#l85.1170"></a><span id="l85.1170">  *   the connection for the request being read</span>
<a href="#l85.1171"></a><span id="l85.1171">  */</span>
<a href="#l85.1172"></a><span id="l85.1172" class="difflineminus">-function RequestReader(connection)</span>
<a href="#l85.1173"></a><span id="l85.1173" class="difflineminus">-{</span>
<a href="#l85.1174"></a><span id="l85.1174" class="difflineplus">+function RequestReader(connection) {</span>
<a href="#l85.1175"></a><span id="l85.1175">   /** Connection metadata for this request. */</span>
<a href="#l85.1176"></a><span id="l85.1176">   this._connection = connection;</span>
<a href="#l85.1177"></a><span id="l85.1177"> </span>
<a href="#l85.1178"></a><span id="l85.1178">   /**</span>
<a href="#l85.1179"></a><span id="l85.1179">    * A container providing line-by-line access to the raw bytes that make up the</span>
<a href="#l85.1180"></a><span id="l85.1180">    * data which has been read from the connection but has not yet been acted</span>
<a href="#l85.1181"></a><span id="l85.1181">    * upon (by passing it to the request handler or by extracting request</span>
<a href="#l85.1182"></a><span id="l85.1182">    * metadata from it).</span>
<a href="#l85.1183"></a><span id="l85.1183" class="difflineat">@@ -1247,65 +1120,57 @@ function RequestReader(connection)</span>
<a href="#l85.1184"></a><span id="l85.1184">    * Used to preserve state if we run out of line data midway through a</span>
<a href="#l85.1185"></a><span id="l85.1185">    * multi-line header.  _lastHeaderName stores the name of the header, while</span>
<a href="#l85.1186"></a><span id="l85.1186">    * _lastHeaderValue stores the value we've seen so far for the header.</span>
<a href="#l85.1187"></a><span id="l85.1187">    *</span>
<a href="#l85.1188"></a><span id="l85.1188">    * These fields are always either both undefined or both strings.</span>
<a href="#l85.1189"></a><span id="l85.1189">    */</span>
<a href="#l85.1190"></a><span id="l85.1190">   this._lastHeaderName = this._lastHeaderValue = undefined;</span>
<a href="#l85.1191"></a><span id="l85.1191"> }</span>
<a href="#l85.1192"></a><span id="l85.1192" class="difflineminus">-RequestReader.prototype =</span>
<a href="#l85.1193"></a><span id="l85.1193" class="difflineminus">-{</span>
<a href="#l85.1194"></a><span id="l85.1194" class="difflineplus">+RequestReader.prototype = {</span>
<a href="#l85.1195"></a><span id="l85.1195">   // NSIINPUTSTREAMCALLBACK</span>
<a href="#l85.1196"></a><span id="l85.1196"> </span>
<a href="#l85.1197"></a><span id="l85.1197">   /**</span>
<a href="#l85.1198"></a><span id="l85.1198">    * Called when more data from the incoming request is available.  This method</span>
<a href="#l85.1199"></a><span id="l85.1199">    * then reads the available data from input and deals with that data as</span>
<a href="#l85.1200"></a><span id="l85.1200">    * necessary, depending upon the syntax of already-downloaded data.</span>
<a href="#l85.1201"></a><span id="l85.1201">    *</span>
<a href="#l85.1202"></a><span id="l85.1202">    * @param input : nsIAsyncInputStream</span>
<a href="#l85.1203"></a><span id="l85.1203">    *   the stream of incoming data from the connection</span>
<a href="#l85.1204"></a><span id="l85.1204">    */</span>
<a href="#l85.1205"></a><span id="l85.1205" class="difflineminus">-  onInputStreamReady: function(input)</span>
<a href="#l85.1206"></a><span id="l85.1206" class="difflineminus">-  {</span>
<a href="#l85.1207"></a><span id="l85.1207" class="difflineplus">+  onInputStreamReady(input) {</span>
<a href="#l85.1208"></a><span id="l85.1208">     dumpn(&quot;*** onInputStreamReady(input=&quot; + input + &quot;) on thread &quot; +</span>
<a href="#l85.1209"></a><span id="l85.1209" class="difflineminus">-          gThreadManager.currentThread + &quot; (main is &quot; +</span>
<a href="#l85.1210"></a><span id="l85.1210" class="difflineminus">-          gThreadManager.mainThread + &quot;)&quot;);</span>
<a href="#l85.1211"></a><span id="l85.1211" class="difflineplus">+          Services.tm.currentThread + &quot; (main is &quot; + Services.tm.mainThread + &quot;)&quot;);</span>
<a href="#l85.1212"></a><span id="l85.1212">     dumpn(&quot;*** this._state == &quot; + this._state);</span>
<a href="#l85.1213"></a><span id="l85.1213"> </span>
<a href="#l85.1214"></a><span id="l85.1214">     // Handle cases where we get more data after a request error has been</span>
<a href="#l85.1215"></a><span id="l85.1215">     // discovered but *before* we can close the connection.</span>
<a href="#l85.1216"></a><span id="l85.1216">     var data = this._data;</span>
<a href="#l85.1217"></a><span id="l85.1217">     if (!data)</span>
<a href="#l85.1218"></a><span id="l85.1218">       return;</span>
<a href="#l85.1219"></a><span id="l85.1219"> </span>
<a href="#l85.1220"></a><span id="l85.1220" class="difflineminus">-    try</span>
<a href="#l85.1221"></a><span id="l85.1221" class="difflineminus">-    {</span>
<a href="#l85.1222"></a><span id="l85.1222" class="difflineplus">+    try {</span>
<a href="#l85.1223"></a><span id="l85.1223">       data.appendBytes(readBytes(input, input.available()));</span>
<a href="#l85.1224"></a><span id="l85.1224" class="difflineminus">-    }</span>
<a href="#l85.1225"></a><span id="l85.1225" class="difflineminus">-    catch (e)</span>
<a href="#l85.1226"></a><span id="l85.1226" class="difflineminus">-    {</span>
<a href="#l85.1227"></a><span id="l85.1227" class="difflineminus">-      if (streamClosed(e))</span>
<a href="#l85.1228"></a><span id="l85.1228" class="difflineminus">-      {</span>
<a href="#l85.1229"></a><span id="l85.1229" class="difflineplus">+    } catch (e) {</span>
<a href="#l85.1230"></a><span id="l85.1230" class="difflineplus">+      if (streamClosed(e)) {</span>
<a href="#l85.1231"></a><span id="l85.1231">         dumpn(&quot;*** WARNING: unexpected error when reading from socket; will &quot; +</span>
<a href="#l85.1232"></a><span id="l85.1232">               &quot;be treated as if the input stream had been closed&quot;);</span>
<a href="#l85.1233"></a><span id="l85.1233">         dumpn(&quot;*** WARNING: actual error was: &quot; + e);</span>
<a href="#l85.1234"></a><span id="l85.1234">       }</span>
<a href="#l85.1235"></a><span id="l85.1235"> </span>
<a href="#l85.1236"></a><span id="l85.1236">       // We've lost a race -- input has been closed, but we're still expecting</span>
<a href="#l85.1237"></a><span id="l85.1237">       // to read more data.  available() will throw in this case, and since</span>
<a href="#l85.1238"></a><span id="l85.1238">       // we're dead in the water now, destroy the connection.</span>
<a href="#l85.1239"></a><span id="l85.1239">       dumpn(&quot;*** onInputStreamReady called on a closed input, destroying &quot; +</span>
<a href="#l85.1240"></a><span id="l85.1240">             &quot;connection&quot;);</span>
<a href="#l85.1241"></a><span id="l85.1241">       this._connection.close();</span>
<a href="#l85.1242"></a><span id="l85.1242">       return;</span>
<a href="#l85.1243"></a><span id="l85.1243">     }</span>
<a href="#l85.1244"></a><span id="l85.1244"> </span>
<a href="#l85.1245"></a><span id="l85.1245" class="difflineminus">-    switch (this._state)</span>
<a href="#l85.1246"></a><span id="l85.1246" class="difflineminus">-    {</span>
<a href="#l85.1247"></a><span id="l85.1247" class="difflineplus">+    switch (this._state) {</span>
<a href="#l85.1248"></a><span id="l85.1248">       default:</span>
<a href="#l85.1249"></a><span id="l85.1249">         NS_ASSERT(false, &quot;invalid state: &quot; + this._state);</span>
<a href="#l85.1250"></a><span id="l85.1250">         break;</span>
<a href="#l85.1251"></a><span id="l85.1251"> </span>
<a href="#l85.1252"></a><span id="l85.1252">       case READER_IN_REQUEST_LINE:</span>
<a href="#l85.1253"></a><span id="l85.1253">         if (!this._processRequestLine())</span>
<a href="#l85.1254"></a><span id="l85.1254">           break;</span>
<a href="#l85.1255"></a><span id="l85.1255">         /* fall through */</span>
<a href="#l85.1256"></a><span id="l85.1256" class="difflineat">@@ -1315,226 +1180,200 @@ RequestReader.prototype =</span>
<a href="#l85.1257"></a><span id="l85.1257">           break;</span>
<a href="#l85.1258"></a><span id="l85.1258">         /* fall through */</span>
<a href="#l85.1259"></a><span id="l85.1259"> </span>
<a href="#l85.1260"></a><span id="l85.1260">       case READER_IN_BODY:</span>
<a href="#l85.1261"></a><span id="l85.1261">         this._processBody();</span>
<a href="#l85.1262"></a><span id="l85.1262">     }</span>
<a href="#l85.1263"></a><span id="l85.1263"> </span>
<a href="#l85.1264"></a><span id="l85.1264">     if (this._state != READER_FINISHED)</span>
<a href="#l85.1265"></a><span id="l85.1265" class="difflineminus">-      input.asyncWait(this, 0, 0, gThreadManager.currentThread);</span>
<a href="#l85.1266"></a><span id="l85.1266" class="difflineplus">+      input.asyncWait(this, 0, 0, Services.tm.currentThread);</span>
<a href="#l85.1267"></a><span id="l85.1267">   },</span>
<a href="#l85.1268"></a><span id="l85.1268"> </span>
<a href="#l85.1269"></a><span id="l85.1269">   //</span>
<a href="#l85.1270"></a><span id="l85.1270">   // see nsISupports.QueryInterface</span>
<a href="#l85.1271"></a><span id="l85.1271">   //</span>
<a href="#l85.1272"></a><span id="l85.1272">   QueryInterface: ChromeUtils.generateQI([&quot;nsIInputStreamCallback&quot;]),</span>
<a href="#l85.1273"></a><span id="l85.1273"> </span>
<a href="#l85.1274"></a><span id="l85.1274"> </span>
<a href="#l85.1275"></a><span id="l85.1275">   // PRIVATE API</span>
<a href="#l85.1276"></a><span id="l85.1276"> </span>
<a href="#l85.1277"></a><span id="l85.1277">   /**</span>
<a href="#l85.1278"></a><span id="l85.1278">    * Processes unprocessed, downloaded data as a request line.</span>
<a href="#l85.1279"></a><span id="l85.1279">    *</span>
<a href="#l85.1280"></a><span id="l85.1280">    * @returns boolean</span>
<a href="#l85.1281"></a><span id="l85.1281">    *   true iff the request line has been fully processed</span>
<a href="#l85.1282"></a><span id="l85.1282">    */</span>
<a href="#l85.1283"></a><span id="l85.1283" class="difflineminus">-  _processRequestLine: function()</span>
<a href="#l85.1284"></a><span id="l85.1284" class="difflineminus">-  {</span>
<a href="#l85.1285"></a><span id="l85.1285" class="difflineplus">+  _processRequestLine() {</span>
<a href="#l85.1286"></a><span id="l85.1286">     NS_ASSERT(this._state == READER_IN_REQUEST_LINE);</span>
<a href="#l85.1287"></a><span id="l85.1287"> </span>
<a href="#l85.1288"></a><span id="l85.1288">     // Servers SHOULD ignore any empty line(s) received where a Request-Line</span>
<a href="#l85.1289"></a><span id="l85.1289">     // is expected (section 4.1).</span>
<a href="#l85.1290"></a><span id="l85.1290">     var data = this._data;</span>
<a href="#l85.1291"></a><span id="l85.1291">     var line = {};</span>
<a href="#l85.1292"></a><span id="l85.1292">     var readSuccess;</span>
<a href="#l85.1293"></a><span id="l85.1293">     while ((readSuccess = data.readLine(line)) &amp;&amp; line.value == &quot;&quot;)</span>
<a href="#l85.1294"></a><span id="l85.1294">       dumpn(&quot;*** ignoring beginning blank line...&quot;);</span>
<a href="#l85.1295"></a><span id="l85.1295"> </span>
<a href="#l85.1296"></a><span id="l85.1296">     // if we don't have a full line, wait until we do</span>
<a href="#l85.1297"></a><span id="l85.1297">     if (!readSuccess)</span>
<a href="#l85.1298"></a><span id="l85.1298">       return false;</span>
<a href="#l85.1299"></a><span id="l85.1299"> </span>
<a href="#l85.1300"></a><span id="l85.1300">     // we have the first non-blank line</span>
<a href="#l85.1301"></a><span id="l85.1301" class="difflineminus">-    try</span>
<a href="#l85.1302"></a><span id="l85.1302" class="difflineminus">-    {</span>
<a href="#l85.1303"></a><span id="l85.1303" class="difflineplus">+    try {</span>
<a href="#l85.1304"></a><span id="l85.1304">       this._parseRequestLine(line.value);</span>
<a href="#l85.1305"></a><span id="l85.1305">       this._state = READER_IN_HEADERS;</span>
<a href="#l85.1306"></a><span id="l85.1306">       return true;</span>
<a href="#l85.1307"></a><span id="l85.1307" class="difflineminus">-    }</span>
<a href="#l85.1308"></a><span id="l85.1308" class="difflineminus">-    catch (e)</span>
<a href="#l85.1309"></a><span id="l85.1309" class="difflineminus">-    {</span>
<a href="#l85.1310"></a><span id="l85.1310" class="difflineplus">+    } catch (e) {</span>
<a href="#l85.1311"></a><span id="l85.1311">       this._handleError(e);</span>
<a href="#l85.1312"></a><span id="l85.1312">       return false;</span>
<a href="#l85.1313"></a><span id="l85.1313">     }</span>
<a href="#l85.1314"></a><span id="l85.1314">   },</span>
<a href="#l85.1315"></a><span id="l85.1315"> </span>
<a href="#l85.1316"></a><span id="l85.1316">   /**</span>
<a href="#l85.1317"></a><span id="l85.1317">    * Processes stored data, assuming it is either at the beginning or in</span>
<a href="#l85.1318"></a><span id="l85.1318">    * the middle of processing request headers.</span>
<a href="#l85.1319"></a><span id="l85.1319">    *</span>
<a href="#l85.1320"></a><span id="l85.1320">    * @returns boolean</span>
<a href="#l85.1321"></a><span id="l85.1321">    *   true iff header data in the request has been fully processed</span>
<a href="#l85.1322"></a><span id="l85.1322">    */</span>
<a href="#l85.1323"></a><span id="l85.1323" class="difflineminus">-  _processHeaders: function()</span>
<a href="#l85.1324"></a><span id="l85.1324" class="difflineminus">-  {</span>
<a href="#l85.1325"></a><span id="l85.1325" class="difflineplus">+  _processHeaders() {</span>
<a href="#l85.1326"></a><span id="l85.1326">     NS_ASSERT(this._state == READER_IN_HEADERS);</span>
<a href="#l85.1327"></a><span id="l85.1327"> </span>
<a href="#l85.1328"></a><span id="l85.1328">     // XXX things to fix here:</span>
<a href="#l85.1329"></a><span id="l85.1329">     //</span>
<a href="#l85.1330"></a><span id="l85.1330">     // - need to support RFC 2047-encoded non-US-ASCII characters</span>
<a href="#l85.1331"></a><span id="l85.1331"> </span>
<a href="#l85.1332"></a><span id="l85.1332" class="difflineminus">-    try</span>
<a href="#l85.1333"></a><span id="l85.1333" class="difflineminus">-    {</span>
<a href="#l85.1334"></a><span id="l85.1334" class="difflineplus">+    try {</span>
<a href="#l85.1335"></a><span id="l85.1335">       var done = this._parseHeaders();</span>
<a href="#l85.1336"></a><span id="l85.1336" class="difflineminus">-      if (done)</span>
<a href="#l85.1337"></a><span id="l85.1337" class="difflineminus">-      {</span>
<a href="#l85.1338"></a><span id="l85.1338" class="difflineplus">+      if (done) {</span>
<a href="#l85.1339"></a><span id="l85.1339">         var request = this._metadata;</span>
<a href="#l85.1340"></a><span id="l85.1340"> </span>
<a href="#l85.1341"></a><span id="l85.1341">         // XXX this is wrong for requests with transfer-encodings applied to</span>
<a href="#l85.1342"></a><span id="l85.1342">         //     them, particularly chunked (which by its nature can have no</span>
<a href="#l85.1343"></a><span id="l85.1343">         //     meaningful Content-Length header)!</span>
<a href="#l85.1344"></a><span id="l85.1344">         this._contentLength = request.hasHeader(&quot;Content-Length&quot;)</span>
<a href="#l85.1345"></a><span id="l85.1345">                             ? parseInt(request.getHeader(&quot;Content-Length&quot;), 10)</span>
<a href="#l85.1346"></a><span id="l85.1346">                             : 0;</span>
<a href="#l85.1347"></a><span id="l85.1347">         dumpn(&quot;_processHeaders, Content-length=&quot; + this._contentLength);</span>
<a href="#l85.1348"></a><span id="l85.1348"> </span>
<a href="#l85.1349"></a><span id="l85.1349">         this._state = READER_IN_BODY;</span>
<a href="#l85.1350"></a><span id="l85.1350">       }</span>
<a href="#l85.1351"></a><span id="l85.1351">       return done;</span>
<a href="#l85.1352"></a><span id="l85.1352" class="difflineminus">-    }</span>
<a href="#l85.1353"></a><span id="l85.1353" class="difflineminus">-    catch (e)</span>
<a href="#l85.1354"></a><span id="l85.1354" class="difflineminus">-    {</span>
<a href="#l85.1355"></a><span id="l85.1355" class="difflineplus">+    } catch (e) {</span>
<a href="#l85.1356"></a><span id="l85.1356">       this._handleError(e);</span>
<a href="#l85.1357"></a><span id="l85.1357">       return false;</span>
<a href="#l85.1358"></a><span id="l85.1358">     }</span>
<a href="#l85.1359"></a><span id="l85.1359">   },</span>
<a href="#l85.1360"></a><span id="l85.1360"> </span>
<a href="#l85.1361"></a><span id="l85.1361">   /**</span>
<a href="#l85.1362"></a><span id="l85.1362">    * Processes stored data, assuming it is either at the beginning or in</span>
<a href="#l85.1363"></a><span id="l85.1363">    * the middle of processing the request body.</span>
<a href="#l85.1364"></a><span id="l85.1364">    *</span>
<a href="#l85.1365"></a><span id="l85.1365">    * @returns boolean</span>
<a href="#l85.1366"></a><span id="l85.1366">    *   true iff the request body has been fully processed</span>
<a href="#l85.1367"></a><span id="l85.1367">    */</span>
<a href="#l85.1368"></a><span id="l85.1368" class="difflineminus">-  _processBody: function()</span>
<a href="#l85.1369"></a><span id="l85.1369" class="difflineminus">-  {</span>
<a href="#l85.1370"></a><span id="l85.1370" class="difflineplus">+  _processBody() {</span>
<a href="#l85.1371"></a><span id="l85.1371">     NS_ASSERT(this._state == READER_IN_BODY);</span>
<a href="#l85.1372"></a><span id="l85.1372"> </span>
<a href="#l85.1373"></a><span id="l85.1373">     // XXX handle chunked transfer-coding request bodies!</span>
<a href="#l85.1374"></a><span id="l85.1374"> </span>
<a href="#l85.1375"></a><span id="l85.1375" class="difflineminus">-    try</span>
<a href="#l85.1376"></a><span id="l85.1376" class="difflineminus">-    {</span>
<a href="#l85.1377"></a><span id="l85.1377" class="difflineminus">-      if (this._contentLength &gt; 0)</span>
<a href="#l85.1378"></a><span id="l85.1378" class="difflineminus">-      {</span>
<a href="#l85.1379"></a><span id="l85.1379" class="difflineplus">+    try {</span>
<a href="#l85.1380"></a><span id="l85.1380" class="difflineplus">+      if (this._contentLength &gt; 0) {</span>
<a href="#l85.1381"></a><span id="l85.1381">         var data = this._data.purge();</span>
<a href="#l85.1382"></a><span id="l85.1382">         var count = Math.min(data.length, this._contentLength);</span>
<a href="#l85.1383"></a><span id="l85.1383">         dumpn(&quot;*** loading data=&quot; + data + &quot; len=&quot; + data.length +</span>
<a href="#l85.1384"></a><span id="l85.1384">               &quot; excess=&quot; + (data.length - count));</span>
<a href="#l85.1385"></a><span id="l85.1385"> </span>
<a href="#l85.1386"></a><span id="l85.1386">         var bos = new BinaryOutputStream(this._metadata._bodyOutputStream);</span>
<a href="#l85.1387"></a><span id="l85.1387">         bos.writeByteArray(data, count);</span>
<a href="#l85.1388"></a><span id="l85.1388">         this._contentLength -= count;</span>
<a href="#l85.1389"></a><span id="l85.1389">       }</span>
<a href="#l85.1390"></a><span id="l85.1390"> </span>
<a href="#l85.1391"></a><span id="l85.1391">       dumpn(&quot;*** remaining body data len=&quot; + this._contentLength);</span>
<a href="#l85.1392"></a><span id="l85.1392" class="difflineminus">-      if (this._contentLength == 0)</span>
<a href="#l85.1393"></a><span id="l85.1393" class="difflineminus">-      {</span>
<a href="#l85.1394"></a><span id="l85.1394" class="difflineplus">+      if (this._contentLength == 0) {</span>
<a href="#l85.1395"></a><span id="l85.1395">         this._validateRequest();</span>
<a href="#l85.1396"></a><span id="l85.1396">         this._state = READER_FINISHED;</span>
<a href="#l85.1397"></a><span id="l85.1397">         this._handleResponse();</span>
<a href="#l85.1398"></a><span id="l85.1398">         return true;</span>
<a href="#l85.1399"></a><span id="l85.1399">       }</span>
<a href="#l85.1400"></a><span id="l85.1400"> </span>
<a href="#l85.1401"></a><span id="l85.1401">       return false;</span>
<a href="#l85.1402"></a><span id="l85.1402" class="difflineminus">-    }</span>
<a href="#l85.1403"></a><span id="l85.1403" class="difflineminus">-    catch (e)</span>
<a href="#l85.1404"></a><span id="l85.1404" class="difflineminus">-    {</span>
<a href="#l85.1405"></a><span id="l85.1405" class="difflineplus">+    } catch (e) {</span>
<a href="#l85.1406"></a><span id="l85.1406">       this._handleError(e);</span>
<a href="#l85.1407"></a><span id="l85.1407">       return false;</span>
<a href="#l85.1408"></a><span id="l85.1408">     }</span>
<a href="#l85.1409"></a><span id="l85.1409">   },</span>
<a href="#l85.1410"></a><span id="l85.1410"> </span>
<a href="#l85.1411"></a><span id="l85.1411">   /**</span>
<a href="#l85.1412"></a><span id="l85.1412">    * Does various post-header checks on the data in this request.</span>
<a href="#l85.1413"></a><span id="l85.1413">    *</span>
<a href="#l85.1414"></a><span id="l85.1414">    * @throws : HttpError</span>
<a href="#l85.1415"></a><span id="l85.1415">    *   if the request was malformed in some way</span>
<a href="#l85.1416"></a><span id="l85.1416">    */</span>
<a href="#l85.1417"></a><span id="l85.1417" class="difflineminus">-  _validateRequest: function()</span>
<a href="#l85.1418"></a><span id="l85.1418" class="difflineminus">-  {</span>
<a href="#l85.1419"></a><span id="l85.1419" class="difflineplus">+  _validateRequest() {</span>
<a href="#l85.1420"></a><span id="l85.1420">     NS_ASSERT(this._state == READER_IN_BODY);</span>
<a href="#l85.1421"></a><span id="l85.1421"> </span>
<a href="#l85.1422"></a><span id="l85.1422">     dumpn(&quot;*** _validateRequest&quot;);</span>
<a href="#l85.1423"></a><span id="l85.1423"> </span>
<a href="#l85.1424"></a><span id="l85.1424">     var metadata = this._metadata;</span>
<a href="#l85.1425"></a><span id="l85.1425">     var headers = metadata._headers;</span>
<a href="#l85.1426"></a><span id="l85.1426"> </span>
<a href="#l85.1427"></a><span id="l85.1427">     // 19.6.1.1 -- servers MUST report 400 to HTTP/1.1 requests w/o Host header</span>
<a href="#l85.1428"></a><span id="l85.1428">     var identity = this._connection.server.identity;</span>
<a href="#l85.1429"></a><span id="l85.1429" class="difflineminus">-    if (metadata._httpVersion.atLeast(nsHttpVersion.HTTP_1_1))</span>
<a href="#l85.1430"></a><span id="l85.1430" class="difflineminus">-    {</span>
<a href="#l85.1431"></a><span id="l85.1431" class="difflineminus">-      if (!headers.hasHeader(&quot;Host&quot;))</span>
<a href="#l85.1432"></a><span id="l85.1432" class="difflineminus">-      {</span>
<a href="#l85.1433"></a><span id="l85.1433" class="difflineplus">+    if (metadata._httpVersion.atLeast(nsHttpVersion.HTTP_1_1)) {</span>
<a href="#l85.1434"></a><span id="l85.1434" class="difflineplus">+      if (!headers.hasHeader(&quot;Host&quot;)) {</span>
<a href="#l85.1435"></a><span id="l85.1435">         dumpn(&quot;*** malformed HTTP/1.1 or greater request with no Host header!&quot;);</span>
<a href="#l85.1436"></a><span id="l85.1436">         throw HTTP_400;</span>
<a href="#l85.1437"></a><span id="l85.1437">       }</span>
<a href="#l85.1438"></a><span id="l85.1438"> </span>
<a href="#l85.1439"></a><span id="l85.1439">       // If the Request-URI wasn't absolute, then we need to determine our host.</span>
<a href="#l85.1440"></a><span id="l85.1440">       // We have to determine what scheme was used to access us based on the</span>
<a href="#l85.1441"></a><span id="l85.1441">       // server identity data at this point, because the request just doesn't</span>
<a href="#l85.1442"></a><span id="l85.1442">       // contain enough data on its own to do this, sadly.</span>
<a href="#l85.1443"></a><span id="l85.1443" class="difflineminus">-      if (!metadata._host)</span>
<a href="#l85.1444"></a><span id="l85.1444" class="difflineminus">-      {</span>
<a href="#l85.1445"></a><span id="l85.1445" class="difflineplus">+      if (!metadata._host) {</span>
<a href="#l85.1446"></a><span id="l85.1446">         var host, port;</span>
<a href="#l85.1447"></a><span id="l85.1447">         var hostPort = headers.getHeader(&quot;Host&quot;);</span>
<a href="#l85.1448"></a><span id="l85.1448">         var colon = hostPort.indexOf(&quot;:&quot;);</span>
<a href="#l85.1449"></a><span id="l85.1449" class="difflineminus">-        if (colon &lt; 0)</span>
<a href="#l85.1450"></a><span id="l85.1450" class="difflineminus">-        {</span>
<a href="#l85.1451"></a><span id="l85.1451" class="difflineplus">+        if (colon &lt; 0) {</span>
<a href="#l85.1452"></a><span id="l85.1452">           host = hostPort;</span>
<a href="#l85.1453"></a><span id="l85.1453">           port = &quot;&quot;;</span>
<a href="#l85.1454"></a><span id="l85.1454" class="difflineminus">-        }</span>
<a href="#l85.1455"></a><span id="l85.1455" class="difflineminus">-        else</span>
<a href="#l85.1456"></a><span id="l85.1456" class="difflineminus">-        {</span>
<a href="#l85.1457"></a><span id="l85.1457" class="difflineplus">+        } else {</span>
<a href="#l85.1458"></a><span id="l85.1458">           host = hostPort.substring(0, colon);</span>
<a href="#l85.1459"></a><span id="l85.1459">           port = hostPort.substring(colon + 1);</span>
<a href="#l85.1460"></a><span id="l85.1460">         }</span>
<a href="#l85.1461"></a><span id="l85.1461"> </span>
<a href="#l85.1462"></a><span id="l85.1462">         // NB: We allow an empty port here because, oddly, a colon may be</span>
<a href="#l85.1463"></a><span id="l85.1463">         //     present even without a port number, e.g. &quot;example.com:&quot;; in this</span>
<a href="#l85.1464"></a><span id="l85.1464">         //     case the default port applies.</span>
<a href="#l85.1465"></a><span id="l85.1465" class="difflineminus">-        if (!HOST_REGEX.test(host) || !/^\d*$/.test(port))</span>
<a href="#l85.1466"></a><span id="l85.1466" class="difflineminus">-        {</span>
<a href="#l85.1467"></a><span id="l85.1467" class="difflineplus">+        if (!HOST_REGEX.test(host) || !/^\d*$/.test(port)) {</span>
<a href="#l85.1468"></a><span id="l85.1468">           dumpn(&quot;*** malformed hostname (&quot; + hostPort + &quot;) in Host &quot; +</span>
<a href="#l85.1469"></a><span id="l85.1469">                 &quot;header, 400 time&quot;);</span>
<a href="#l85.1470"></a><span id="l85.1470">           throw HTTP_400;</span>
<a href="#l85.1471"></a><span id="l85.1471">         }</span>
<a href="#l85.1472"></a><span id="l85.1472"> </span>
<a href="#l85.1473"></a><span id="l85.1473">         // If we're not given a port, we're stuck, because we don't know what</span>
<a href="#l85.1474"></a><span id="l85.1474">         // scheme to use to look up the correct port here, in general.  Since</span>
<a href="#l85.1475"></a><span id="l85.1475">         // the HTTPS case requires a tunnel/proxy and thus requires that the</span>
<a href="#l85.1476"></a><span id="l85.1476">         // requested URI be absolute (and thus contain the necessary</span>
<a href="#l85.1477"></a><span id="l85.1477">         // information), let's assume HTTP will prevail and use that.</span>
<a href="#l85.1478"></a><span id="l85.1478">         port = +port || 80;</span>
<a href="#l85.1479"></a><span id="l85.1479"> </span>
<a href="#l85.1480"></a><span id="l85.1480">         var scheme = identity.getScheme(host, port);</span>
<a href="#l85.1481"></a><span id="l85.1481" class="difflineminus">-        if (!scheme)</span>
<a href="#l85.1482"></a><span id="l85.1482" class="difflineminus">-        {</span>
<a href="#l85.1483"></a><span id="l85.1483" class="difflineplus">+        if (!scheme) {</span>
<a href="#l85.1484"></a><span id="l85.1484">           dumpn(&quot;*** unrecognized hostname (&quot; + hostPort + &quot;) in Host &quot; +</span>
<a href="#l85.1485"></a><span id="l85.1485">                 &quot;header, 400 time&quot;);</span>
<a href="#l85.1486"></a><span id="l85.1486">           throw HTTP_400;</span>
<a href="#l85.1487"></a><span id="l85.1487">         }</span>
<a href="#l85.1488"></a><span id="l85.1488"> </span>
<a href="#l85.1489"></a><span id="l85.1489">         metadata._scheme = scheme;</span>
<a href="#l85.1490"></a><span id="l85.1490">         metadata._host = host;</span>
<a href="#l85.1491"></a><span id="l85.1491">         metadata._port = port;</span>
<a href="#l85.1492"></a><span id="l85.1492">       }</span>
<a href="#l85.1493"></a><span id="l85.1493" class="difflineminus">-    }</span>
<a href="#l85.1494"></a><span id="l85.1494" class="difflineminus">-    else</span>
<a href="#l85.1495"></a><span id="l85.1495" class="difflineminus">-    {</span>
<a href="#l85.1496"></a><span id="l85.1496" class="difflineplus">+    } else {</span>
<a href="#l85.1497"></a><span id="l85.1497">       NS_ASSERT(metadata._host === undefined,</span>
<a href="#l85.1498"></a><span id="l85.1498">                 &quot;HTTP/1.0 doesn't allow absolute paths in the request line!&quot;);</span>
<a href="#l85.1499"></a><span id="l85.1499"> </span>
<a href="#l85.1500"></a><span id="l85.1500">       metadata._scheme = identity.primaryScheme;</span>
<a href="#l85.1501"></a><span id="l85.1501">       metadata._host = identity.primaryHost;</span>
<a href="#l85.1502"></a><span id="l85.1502">       metadata._port = identity.primaryPort;</span>
<a href="#l85.1503"></a><span id="l85.1503">     }</span>
<a href="#l85.1504"></a><span id="l85.1504"> </span>
<a href="#l85.1505"></a><span id="l85.1505" class="difflineat">@@ -1546,28 +1385,24 @@ RequestReader.prototype =</span>
<a href="#l85.1506"></a><span id="l85.1506">    * Handles responses in case of error, either in the server or in the request.</span>
<a href="#l85.1507"></a><span id="l85.1507">    *</span>
<a href="#l85.1508"></a><span id="l85.1508">    * @param e</span>
<a href="#l85.1509"></a><span id="l85.1509">    *   the specific error encountered, which is an HttpError in the case where</span>
<a href="#l85.1510"></a><span id="l85.1510">    *   the request is in some way invalid or cannot be fulfilled; if this isn't</span>
<a href="#l85.1511"></a><span id="l85.1511">    *   an HttpError we're going to be paranoid and shut down, because that</span>
<a href="#l85.1512"></a><span id="l85.1512">    *   shouldn't happen, ever</span>
<a href="#l85.1513"></a><span id="l85.1513">    */</span>
<a href="#l85.1514"></a><span id="l85.1514" class="difflineminus">-  _handleError: function(e)</span>
<a href="#l85.1515"></a><span id="l85.1515" class="difflineminus">-  {</span>
<a href="#l85.1516"></a><span id="l85.1516" class="difflineplus">+  _handleError(e) {</span>
<a href="#l85.1517"></a><span id="l85.1517">     // Don't fall back into normal processing!</span>
<a href="#l85.1518"></a><span id="l85.1518">     this._state = READER_FINISHED;</span>
<a href="#l85.1519"></a><span id="l85.1519"> </span>
<a href="#l85.1520"></a><span id="l85.1520">     var server = this._connection.server;</span>
<a href="#l85.1521"></a><span id="l85.1521" class="difflineminus">-    if (e instanceof HttpError)</span>
<a href="#l85.1522"></a><span id="l85.1522" class="difflineminus">-    {</span>
<a href="#l85.1523"></a><span id="l85.1523" class="difflineplus">+    if (e instanceof HttpError) {</span>
<a href="#l85.1524"></a><span id="l85.1524">       var code = e.code;</span>
<a href="#l85.1525"></a><span id="l85.1525" class="difflineminus">-    }</span>
<a href="#l85.1526"></a><span id="l85.1526" class="difflineminus">-    else</span>
<a href="#l85.1527"></a><span id="l85.1527" class="difflineminus">-    {</span>
<a href="#l85.1528"></a><span id="l85.1528" class="difflineplus">+    } else {</span>
<a href="#l85.1529"></a><span id="l85.1529">       dumpn(&quot;!!! UNEXPECTED ERROR: &quot; + e +</span>
<a href="#l85.1530"></a><span id="l85.1530">             (e.lineNumber ? &quot;, line &quot; + e.lineNumber : &quot;&quot;));</span>
<a href="#l85.1531"></a><span id="l85.1531"> </span>
<a href="#l85.1532"></a><span id="l85.1532">       // no idea what happened -- be paranoid and shut down</span>
<a href="#l85.1533"></a><span id="l85.1533">       code = 500;</span>
<a href="#l85.1534"></a><span id="l85.1534">       server._requestQuit();</span>
<a href="#l85.1535"></a><span id="l85.1535">     }</span>
<a href="#l85.1536"></a><span id="l85.1536"> </span>
<a href="#l85.1537"></a><span id="l85.1537" class="difflineat">@@ -1579,18 +1414,17 @@ RequestReader.prototype =</span>
<a href="#l85.1538"></a><span id="l85.1538"> </span>
<a href="#l85.1539"></a><span id="l85.1539">   /**</span>
<a href="#l85.1540"></a><span id="l85.1540">    * Now that we've read the request line and headers, we can actually hand off</span>
<a href="#l85.1541"></a><span id="l85.1541">    * the request to be handled.</span>
<a href="#l85.1542"></a><span id="l85.1542">    *</span>
<a href="#l85.1543"></a><span id="l85.1543">    * This method is called once per request, after the request line and all</span>
<a href="#l85.1544"></a><span id="l85.1544">    * headers and the body, if any, have been received.</span>
<a href="#l85.1545"></a><span id="l85.1545">    */</span>
<a href="#l85.1546"></a><span id="l85.1546" class="difflineminus">-  _handleResponse: function()</span>
<a href="#l85.1547"></a><span id="l85.1547" class="difflineminus">-  {</span>
<a href="#l85.1548"></a><span id="l85.1548" class="difflineplus">+  _handleResponse() {</span>
<a href="#l85.1549"></a><span id="l85.1549">     NS_ASSERT(this._state == READER_FINISHED);</span>
<a href="#l85.1550"></a><span id="l85.1550"> </span>
<a href="#l85.1551"></a><span id="l85.1551">     // We don't need the line-based data any more, so make attempted reuse an</span>
<a href="#l85.1552"></a><span id="l85.1552">     // error.</span>
<a href="#l85.1553"></a><span id="l85.1553">     this._data = null;</span>
<a href="#l85.1554"></a><span id="l85.1554"> </span>
<a href="#l85.1555"></a><span id="l85.1555">     this._connection.process(this._metadata);</span>
<a href="#l85.1556"></a><span id="l85.1556">   },</span>
<a href="#l85.1557"></a><span id="l85.1557" class="difflineat">@@ -1599,122 +1433,99 @@ RequestReader.prototype =</span>
<a href="#l85.1558"></a><span id="l85.1558">   // PARSING</span>
<a href="#l85.1559"></a><span id="l85.1559"> </span>
<a href="#l85.1560"></a><span id="l85.1560">   /**</span>
<a href="#l85.1561"></a><span id="l85.1561">    * Parses the request line for the HTTP request associated with this.</span>
<a href="#l85.1562"></a><span id="l85.1562">    *</span>
<a href="#l85.1563"></a><span id="l85.1563">    * @param line : string</span>
<a href="#l85.1564"></a><span id="l85.1564">    *   the request line</span>
<a href="#l85.1565"></a><span id="l85.1565">    */</span>
<a href="#l85.1566"></a><span id="l85.1566" class="difflineminus">-  _parseRequestLine: function(line)</span>
<a href="#l85.1567"></a><span id="l85.1567" class="difflineminus">-  {</span>
<a href="#l85.1568"></a><span id="l85.1568" class="difflineplus">+  _parseRequestLine(line) {</span>
<a href="#l85.1569"></a><span id="l85.1569">     NS_ASSERT(this._state == READER_IN_REQUEST_LINE);</span>
<a href="#l85.1570"></a><span id="l85.1570"> </span>
<a href="#l85.1571"></a><span id="l85.1571">     dumpn(&quot;*** _parseRequestLine('&quot; + line + &quot;')&quot;);</span>
<a href="#l85.1572"></a><span id="l85.1572"> </span>
<a href="#l85.1573"></a><span id="l85.1573">     var metadata = this._metadata;</span>
<a href="#l85.1574"></a><span id="l85.1574"> </span>
<a href="#l85.1575"></a><span id="l85.1575">     // clients and servers SHOULD accept any amount of SP or HT characters</span>
<a href="#l85.1576"></a><span id="l85.1576">     // between fields, even though only a single SP is required (section 19.3)</span>
<a href="#l85.1577"></a><span id="l85.1577">     var request = line.split(/[ \t]+/);</span>
<a href="#l85.1578"></a><span id="l85.1578" class="difflineminus">-    if (!request || request.length != 3)</span>
<a href="#l85.1579"></a><span id="l85.1579" class="difflineminus">-    {</span>
<a href="#l85.1580"></a><span id="l85.1580" class="difflineplus">+    if (!request || request.length != 3) {</span>
<a href="#l85.1581"></a><span id="l85.1581">       dumpn(&quot;*** No request in line&quot;);</span>
<a href="#l85.1582"></a><span id="l85.1582">       throw HTTP_400;</span>
<a href="#l85.1583"></a><span id="l85.1583">     }</span>
<a href="#l85.1584"></a><span id="l85.1584"> </span>
<a href="#l85.1585"></a><span id="l85.1585">     metadata._method = request[0];</span>
<a href="#l85.1586"></a><span id="l85.1586"> </span>
<a href="#l85.1587"></a><span id="l85.1587">     // get the HTTP version</span>
<a href="#l85.1588"></a><span id="l85.1588">     var ver = request[2];</span>
<a href="#l85.1589"></a><span id="l85.1589">     var match = ver.match(/^HTTP\/(\d+\.\d+)$/);</span>
<a href="#l85.1590"></a><span id="l85.1590" class="difflineminus">-    if (!match)</span>
<a href="#l85.1591"></a><span id="l85.1591" class="difflineminus">-    {</span>
<a href="#l85.1592"></a><span id="l85.1592" class="difflineplus">+    if (!match) {</span>
<a href="#l85.1593"></a><span id="l85.1593">       dumpn(&quot;*** No HTTP version in line&quot;);</span>
<a href="#l85.1594"></a><span id="l85.1594">       throw HTTP_400;</span>
<a href="#l85.1595"></a><span id="l85.1595">     }</span>
<a href="#l85.1596"></a><span id="l85.1596"> </span>
<a href="#l85.1597"></a><span id="l85.1597">     // determine HTTP version</span>
<a href="#l85.1598"></a><span id="l85.1598" class="difflineminus">-    try</span>
<a href="#l85.1599"></a><span id="l85.1599" class="difflineminus">-    {</span>
<a href="#l85.1600"></a><span id="l85.1600" class="difflineplus">+    try {</span>
<a href="#l85.1601"></a><span id="l85.1601">       metadata._httpVersion = new nsHttpVersion(match[1]);</span>
<a href="#l85.1602"></a><span id="l85.1602">       if (!metadata._httpVersion.atLeast(nsHttpVersion.HTTP_1_0))</span>
<a href="#l85.1603"></a><span id="l85.1603">         throw &quot;unsupported HTTP version&quot;;</span>
<a href="#l85.1604"></a><span id="l85.1604" class="difflineminus">-    }</span>
<a href="#l85.1605"></a><span id="l85.1605" class="difflineminus">-    catch (e)</span>
<a href="#l85.1606"></a><span id="l85.1606" class="difflineminus">-    {</span>
<a href="#l85.1607"></a><span id="l85.1607" class="difflineplus">+    } catch (e) {</span>
<a href="#l85.1608"></a><span id="l85.1608">       // we support HTTP/1.0 and HTTP/1.1 only</span>
<a href="#l85.1609"></a><span id="l85.1609">       throw HTTP_501;</span>
<a href="#l85.1610"></a><span id="l85.1610">     }</span>
<a href="#l85.1611"></a><span id="l85.1611"> </span>
<a href="#l85.1612"></a><span id="l85.1612"> </span>
<a href="#l85.1613"></a><span id="l85.1613">     var fullPath = request[1];</span>
<a href="#l85.1614"></a><span id="l85.1614">     var serverIdentity = this._connection.server.identity;</span>
<a href="#l85.1615"></a><span id="l85.1615"> </span>
<a href="#l85.1616"></a><span id="l85.1616">     var scheme, host, port;</span>
<a href="#l85.1617"></a><span id="l85.1617"> </span>
<a href="#l85.1618"></a><span id="l85.1618" class="difflineminus">-    if (fullPath.charAt(0) != &quot;/&quot;)</span>
<a href="#l85.1619"></a><span id="l85.1619" class="difflineminus">-    {</span>
<a href="#l85.1620"></a><span id="l85.1620" class="difflineplus">+    if (fullPath.charAt(0) != &quot;/&quot;) {</span>
<a href="#l85.1621"></a><span id="l85.1621">       // No absolute paths in the request line in HTTP prior to 1.1</span>
<a href="#l85.1622"></a><span id="l85.1622" class="difflineminus">-      if (!metadata._httpVersion.atLeast(nsHttpVersion.HTTP_1_1))</span>
<a href="#l85.1623"></a><span id="l85.1623" class="difflineminus">-      {</span>
<a href="#l85.1624"></a><span id="l85.1624" class="difflineplus">+      if (!metadata._httpVersion.atLeast(nsHttpVersion.HTTP_1_1)) {</span>
<a href="#l85.1625"></a><span id="l85.1625">         dumpn(&quot;*** Metadata version too low&quot;);</span>
<a href="#l85.1626"></a><span id="l85.1626">         throw HTTP_400;</span>
<a href="#l85.1627"></a><span id="l85.1627">       }</span>
<a href="#l85.1628"></a><span id="l85.1628"> </span>
<a href="#l85.1629"></a><span id="l85.1629" class="difflineminus">-      try</span>
<a href="#l85.1630"></a><span id="l85.1630" class="difflineminus">-      {</span>
<a href="#l85.1631"></a><span id="l85.1631" class="difflineminus">-        var uri = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l85.1632"></a><span id="l85.1632" class="difflineminus">-                    .getService(Ci.nsIIOService)</span>
<a href="#l85.1633"></a><span id="l85.1633" class="difflineminus">-                    .newURI(fullPath);</span>
<a href="#l85.1634"></a><span id="l85.1634" class="difflineplus">+      try {</span>
<a href="#l85.1635"></a><span id="l85.1635" class="difflineplus">+        var uri = Services.io.newURI(fullPath);</span>
<a href="#l85.1636"></a><span id="l85.1636">         fullPath = uri.pathQueryRef;</span>
<a href="#l85.1637"></a><span id="l85.1637">         scheme = uri.scheme;</span>
<a href="#l85.1638"></a><span id="l85.1638">         host = metadata._host = uri.asciiHost;</span>
<a href="#l85.1639"></a><span id="l85.1639">         port = uri.port;</span>
<a href="#l85.1640"></a><span id="l85.1640" class="difflineminus">-        if (port === -1)</span>
<a href="#l85.1641"></a><span id="l85.1641" class="difflineminus">-        {</span>
<a href="#l85.1642"></a><span id="l85.1642" class="difflineminus">-          if (scheme === &quot;http&quot;)</span>
<a href="#l85.1643"></a><span id="l85.1643" class="difflineminus">-          {</span>
<a href="#l85.1644"></a><span id="l85.1644" class="difflineplus">+        if (port === -1) {</span>
<a href="#l85.1645"></a><span id="l85.1645" class="difflineplus">+          if (scheme === &quot;http&quot;) {</span>
<a href="#l85.1646"></a><span id="l85.1646">             port = 80;</span>
<a href="#l85.1647"></a><span id="l85.1647" class="difflineminus">-          }</span>
<a href="#l85.1648"></a><span id="l85.1648" class="difflineminus">-          else if (scheme === &quot;https&quot;)</span>
<a href="#l85.1649"></a><span id="l85.1649" class="difflineminus">-          {</span>
<a href="#l85.1650"></a><span id="l85.1650" class="difflineplus">+          } else if (scheme === &quot;https&quot;) {</span>
<a href="#l85.1651"></a><span id="l85.1651">             port = 443;</span>
<a href="#l85.1652"></a><span id="l85.1652" class="difflineminus">-          }</span>
<a href="#l85.1653"></a><span id="l85.1653" class="difflineminus">-          else</span>
<a href="#l85.1654"></a><span id="l85.1654" class="difflineminus">-          {</span>
<a href="#l85.1655"></a><span id="l85.1655" class="difflineplus">+          } else {</span>
<a href="#l85.1656"></a><span id="l85.1656">             dumpn(&quot;*** Unknown scheme: &quot; + scheme);</span>
<a href="#l85.1657"></a><span id="l85.1657">             throw HTTP_400;</span>
<a href="#l85.1658"></a><span id="l85.1658">           }</span>
<a href="#l85.1659"></a><span id="l85.1659">         }</span>
<a href="#l85.1660"></a><span id="l85.1660" class="difflineminus">-      }</span>
<a href="#l85.1661"></a><span id="l85.1661" class="difflineminus">-      catch (e)</span>
<a href="#l85.1662"></a><span id="l85.1662" class="difflineminus">-      {</span>
<a href="#l85.1663"></a><span id="l85.1663" class="difflineplus">+      } catch (e) {</span>
<a href="#l85.1664"></a><span id="l85.1664">         // If the host is not a valid host on the server, the response MUST be a</span>
<a href="#l85.1665"></a><span id="l85.1665">         // 400 (Bad Request) error message (section 5.2).  Alternately, the URI</span>
<a href="#l85.1666"></a><span id="l85.1666">         // is malformed.</span>
<a href="#l85.1667"></a><span id="l85.1667">         dumpn(&quot;*** Threw when dealing with URI: &quot; + e);</span>
<a href="#l85.1668"></a><span id="l85.1668">         throw HTTP_400;</span>
<a href="#l85.1669"></a><span id="l85.1669">       }</span>
<a href="#l85.1670"></a><span id="l85.1670"> </span>
<a href="#l85.1671"></a><span id="l85.1671" class="difflineminus">-      if (!serverIdentity.has(scheme, host, port) || fullPath.charAt(0) != &quot;/&quot;)</span>
<a href="#l85.1672"></a><span id="l85.1672" class="difflineminus">-      {</span>
<a href="#l85.1673"></a><span id="l85.1673" class="difflineplus">+      if (!serverIdentity.has(scheme, host, port) || fullPath.charAt(0) != &quot;/&quot;) {</span>
<a href="#l85.1674"></a><span id="l85.1674">         dumpn(&quot;*** serverIdentity unknown or path does not start with '/'&quot;);</span>
<a href="#l85.1675"></a><span id="l85.1675">         throw HTTP_400;</span>
<a href="#l85.1676"></a><span id="l85.1676">       }</span>
<a href="#l85.1677"></a><span id="l85.1677">     }</span>
<a href="#l85.1678"></a><span id="l85.1678"> </span>
<a href="#l85.1679"></a><span id="l85.1679">     var splitter = fullPath.indexOf(&quot;?&quot;);</span>
<a href="#l85.1680"></a><span id="l85.1680" class="difflineminus">-    if (splitter &lt; 0)</span>
<a href="#l85.1681"></a><span id="l85.1681" class="difflineminus">-    {</span>
<a href="#l85.1682"></a><span id="l85.1682" class="difflineplus">+    if (splitter &lt; 0) {</span>
<a href="#l85.1683"></a><span id="l85.1683">       // _queryString already set in ctor</span>
<a href="#l85.1684"></a><span id="l85.1684">       metadata._path = fullPath;</span>
<a href="#l85.1685"></a><span id="l85.1685" class="difflineminus">-    }</span>
<a href="#l85.1686"></a><span id="l85.1686" class="difflineminus">-    else</span>
<a href="#l85.1687"></a><span id="l85.1687" class="difflineminus">-    {</span>
<a href="#l85.1688"></a><span id="l85.1688" class="difflineplus">+    } else {</span>
<a href="#l85.1689"></a><span id="l85.1689">       metadata._path = fullPath.substring(0, splitter);</span>
<a href="#l85.1690"></a><span id="l85.1690">       metadata._queryString = fullPath.substring(splitter + 1);</span>
<a href="#l85.1691"></a><span id="l85.1691">     }</span>
<a href="#l85.1692"></a><span id="l85.1692"> </span>
<a href="#l85.1693"></a><span id="l85.1693">     metadata._scheme = scheme;</span>
<a href="#l85.1694"></a><span id="l85.1694">     metadata._host = host;</span>
<a href="#l85.1695"></a><span id="l85.1695">     metadata._port = port;</span>
<a href="#l85.1696"></a><span id="l85.1696">   },</span>
<a href="#l85.1697"></a><span id="l85.1697" class="difflineat">@@ -1723,117 +1534,97 @@ RequestReader.prototype =</span>
<a href="#l85.1698"></a><span id="l85.1698">    * Parses all available HTTP headers in this until the header-ending CRLFCRLF,</span>
<a href="#l85.1699"></a><span id="l85.1699">    * adding them to the store of headers in the request.</span>
<a href="#l85.1700"></a><span id="l85.1700">    *</span>
<a href="#l85.1701"></a><span id="l85.1701">    * @throws</span>
<a href="#l85.1702"></a><span id="l85.1702">    *   HTTP_400 if the headers are malformed</span>
<a href="#l85.1703"></a><span id="l85.1703">    * @returns boolean</span>
<a href="#l85.1704"></a><span id="l85.1704">    *   true if all headers have now been processed, false otherwise</span>
<a href="#l85.1705"></a><span id="l85.1705">    */</span>
<a href="#l85.1706"></a><span id="l85.1706" class="difflineminus">-  _parseHeaders: function()</span>
<a href="#l85.1707"></a><span id="l85.1707" class="difflineminus">-  {</span>
<a href="#l85.1708"></a><span id="l85.1708" class="difflineplus">+  _parseHeaders() {</span>
<a href="#l85.1709"></a><span id="l85.1709">     NS_ASSERT(this._state == READER_IN_HEADERS);</span>
<a href="#l85.1710"></a><span id="l85.1710"> </span>
<a href="#l85.1711"></a><span id="l85.1711">     dumpn(&quot;*** _parseHeaders&quot;);</span>
<a href="#l85.1712"></a><span id="l85.1712"> </span>
<a href="#l85.1713"></a><span id="l85.1713">     var data = this._data;</span>
<a href="#l85.1714"></a><span id="l85.1714"> </span>
<a href="#l85.1715"></a><span id="l85.1715">     var headers = this._metadata._headers;</span>
<a href="#l85.1716"></a><span id="l85.1716">     var lastName = this._lastHeaderName;</span>
<a href="#l85.1717"></a><span id="l85.1717">     var lastVal = this._lastHeaderValue;</span>
<a href="#l85.1718"></a><span id="l85.1718"> </span>
<a href="#l85.1719"></a><span id="l85.1719">     var line = {};</span>
<a href="#l85.1720"></a><span id="l85.1720" class="difflineminus">-    while (true)</span>
<a href="#l85.1721"></a><span id="l85.1721" class="difflineminus">-    {</span>
<a href="#l85.1722"></a><span id="l85.1722" class="difflineplus">+    while (true) {</span>
<a href="#l85.1723"></a><span id="l85.1723">       dumpn(&quot;*** Last name: '&quot; + lastName + &quot;'&quot;);</span>
<a href="#l85.1724"></a><span id="l85.1724">       dumpn(&quot;*** Last val: '&quot; + lastVal + &quot;'&quot;);</span>
<a href="#l85.1725"></a><span id="l85.1725">       NS_ASSERT(!((lastVal === undefined) ^ (lastName === undefined)),</span>
<a href="#l85.1726"></a><span id="l85.1726">                 lastName === undefined ?</span>
<a href="#l85.1727"></a><span id="l85.1727">                   &quot;lastVal without lastName?  lastVal: '&quot; + lastVal + &quot;'&quot; :</span>
<a href="#l85.1728"></a><span id="l85.1728">                   &quot;lastName without lastVal?  lastName: '&quot; + lastName + &quot;'&quot;);</span>
<a href="#l85.1729"></a><span id="l85.1729"> </span>
<a href="#l85.1730"></a><span id="l85.1730" class="difflineminus">-      if (!data.readLine(line))</span>
<a href="#l85.1731"></a><span id="l85.1731" class="difflineminus">-      {</span>
<a href="#l85.1732"></a><span id="l85.1732" class="difflineplus">+      if (!data.readLine(line)) {</span>
<a href="#l85.1733"></a><span id="l85.1733">         // save any data we have from the header we might still be processing</span>
<a href="#l85.1734"></a><span id="l85.1734">         this._lastHeaderName = lastName;</span>
<a href="#l85.1735"></a><span id="l85.1735">         this._lastHeaderValue = lastVal;</span>
<a href="#l85.1736"></a><span id="l85.1736">         return false;</span>
<a href="#l85.1737"></a><span id="l85.1737">       }</span>
<a href="#l85.1738"></a><span id="l85.1738"> </span>
<a href="#l85.1739"></a><span id="l85.1739">       var lineText = line.value;</span>
<a href="#l85.1740"></a><span id="l85.1740">       dumpn(&quot;*** Line text: '&quot; + lineText + &quot;'&quot;);</span>
<a href="#l85.1741"></a><span id="l85.1741">       var firstChar = lineText.charAt(0);</span>
<a href="#l85.1742"></a><span id="l85.1742"> </span>
<a href="#l85.1743"></a><span id="l85.1743">       // blank line means end of headers</span>
<a href="#l85.1744"></a><span id="l85.1744" class="difflineminus">-      if (lineText == &quot;&quot;)</span>
<a href="#l85.1745"></a><span id="l85.1745" class="difflineminus">-      {</span>
<a href="#l85.1746"></a><span id="l85.1746" class="difflineplus">+      if (lineText == &quot;&quot;) {</span>
<a href="#l85.1747"></a><span id="l85.1747">         // we're finished with the previous header</span>
<a href="#l85.1748"></a><span id="l85.1748" class="difflineminus">-        if (lastName)</span>
<a href="#l85.1749"></a><span id="l85.1749" class="difflineminus">-        {</span>
<a href="#l85.1750"></a><span id="l85.1750" class="difflineminus">-          try</span>
<a href="#l85.1751"></a><span id="l85.1751" class="difflineminus">-          {</span>
<a href="#l85.1752"></a><span id="l85.1752" class="difflineplus">+        if (lastName) {</span>
<a href="#l85.1753"></a><span id="l85.1753" class="difflineplus">+          try {</span>
<a href="#l85.1754"></a><span id="l85.1754">             headers.setHeader(lastName, lastVal, true);</span>
<a href="#l85.1755"></a><span id="l85.1755" class="difflineminus">-          }</span>
<a href="#l85.1756"></a><span id="l85.1756" class="difflineminus">-          catch (e)</span>
<a href="#l85.1757"></a><span id="l85.1757" class="difflineminus">-          {</span>
<a href="#l85.1758"></a><span id="l85.1758" class="difflineplus">+          } catch (e) {</span>
<a href="#l85.1759"></a><span id="l85.1759">             dumpn(&quot;*** setHeader threw on last header, e == &quot; + e);</span>
<a href="#l85.1760"></a><span id="l85.1760">             throw HTTP_400;</span>
<a href="#l85.1761"></a><span id="l85.1761">           }</span>
<a href="#l85.1762"></a><span id="l85.1762" class="difflineminus">-        }</span>
<a href="#l85.1763"></a><span id="l85.1763" class="difflineminus">-        else</span>
<a href="#l85.1764"></a><span id="l85.1764" class="difflineminus">-        {</span>
<a href="#l85.1765"></a><span id="l85.1765" class="difflineplus">+        } else {</span>
<a href="#l85.1766"></a><span id="l85.1766">           // no headers in request -- valid for HTTP/1.0 requests</span>
<a href="#l85.1767"></a><span id="l85.1767">         }</span>
<a href="#l85.1768"></a><span id="l85.1768"> </span>
<a href="#l85.1769"></a><span id="l85.1769">         // either way, we're done processing headers</span>
<a href="#l85.1770"></a><span id="l85.1770">         this._state = READER_IN_BODY;</span>
<a href="#l85.1771"></a><span id="l85.1771">         return true;</span>
<a href="#l85.1772"></a><span id="l85.1772" class="difflineminus">-      }</span>
<a href="#l85.1773"></a><span id="l85.1773" class="difflineminus">-      else if (firstChar == &quot; &quot; || firstChar == &quot;\t&quot;)</span>
<a href="#l85.1774"></a><span id="l85.1774" class="difflineminus">-      {</span>
<a href="#l85.1775"></a><span id="l85.1775" class="difflineplus">+      } else if (firstChar == &quot; &quot; || firstChar == &quot;\t&quot;) {</span>
<a href="#l85.1776"></a><span id="l85.1776">         // multi-line header if we've already seen a header line</span>
<a href="#l85.1777"></a><span id="l85.1777" class="difflineminus">-        if (!lastName)</span>
<a href="#l85.1778"></a><span id="l85.1778" class="difflineminus">-        {</span>
<a href="#l85.1779"></a><span id="l85.1779" class="difflineplus">+        if (!lastName) {</span>
<a href="#l85.1780"></a><span id="l85.1780">           dumpn(&quot;We don't have a header to continue!&quot;);</span>
<a href="#l85.1781"></a><span id="l85.1781">           throw HTTP_400;</span>
<a href="#l85.1782"></a><span id="l85.1782">         }</span>
<a href="#l85.1783"></a><span id="l85.1783"> </span>
<a href="#l85.1784"></a><span id="l85.1784">         // append this line's text to the value; starts with SP/HT, so no need</span>
<a href="#l85.1785"></a><span id="l85.1785">         // for separating whitespace</span>
<a href="#l85.1786"></a><span id="l85.1786">         lastVal += lineText;</span>
<a href="#l85.1787"></a><span id="l85.1787" class="difflineminus">-      }</span>
<a href="#l85.1788"></a><span id="l85.1788" class="difflineminus">-      else</span>
<a href="#l85.1789"></a><span id="l85.1789" class="difflineminus">-      {</span>
<a href="#l85.1790"></a><span id="l85.1790" class="difflineplus">+      } else {</span>
<a href="#l85.1791"></a><span id="l85.1791">         // we have a new header, so set the old one (if one existed)</span>
<a href="#l85.1792"></a><span id="l85.1792" class="difflineminus">-        if (lastName)</span>
<a href="#l85.1793"></a><span id="l85.1793" class="difflineminus">-        {</span>
<a href="#l85.1794"></a><span id="l85.1794" class="difflineminus">-          try</span>
<a href="#l85.1795"></a><span id="l85.1795" class="difflineminus">-          {</span>
<a href="#l85.1796"></a><span id="l85.1796" class="difflineplus">+        if (lastName) {</span>
<a href="#l85.1797"></a><span id="l85.1797" class="difflineplus">+          try {</span>
<a href="#l85.1798"></a><span id="l85.1798">             headers.setHeader(lastName, lastVal, true);</span>
<a href="#l85.1799"></a><span id="l85.1799" class="difflineminus">-          }</span>
<a href="#l85.1800"></a><span id="l85.1800" class="difflineminus">-          catch (e)</span>
<a href="#l85.1801"></a><span id="l85.1801" class="difflineminus">-          {</span>
<a href="#l85.1802"></a><span id="l85.1802" class="difflineplus">+          } catch (e) {</span>
<a href="#l85.1803"></a><span id="l85.1803">             dumpn(&quot;*** setHeader threw on a header, e == &quot; + e);</span>
<a href="#l85.1804"></a><span id="l85.1804">             throw HTTP_400;</span>
<a href="#l85.1805"></a><span id="l85.1805">           }</span>
<a href="#l85.1806"></a><span id="l85.1806">         }</span>
<a href="#l85.1807"></a><span id="l85.1807"> </span>
<a href="#l85.1808"></a><span id="l85.1808">         var colon = lineText.indexOf(&quot;:&quot;); // first colon must be splitter</span>
<a href="#l85.1809"></a><span id="l85.1809" class="difflineminus">-        if (colon &lt; 1)</span>
<a href="#l85.1810"></a><span id="l85.1810" class="difflineminus">-        {</span>
<a href="#l85.1811"></a><span id="l85.1811" class="difflineplus">+        if (colon &lt; 1) {</span>
<a href="#l85.1812"></a><span id="l85.1812">           dumpn(&quot;*** No colon or missing header field-name&quot;);</span>
<a href="#l85.1813"></a><span id="l85.1813">           throw HTTP_400;</span>
<a href="#l85.1814"></a><span id="l85.1814">         }</span>
<a href="#l85.1815"></a><span id="l85.1815"> </span>
<a href="#l85.1816"></a><span id="l85.1816">         // set header name, value (to be set in the next loop, usually)</span>
<a href="#l85.1817"></a><span id="l85.1817">         lastName = lineText.substring(0, colon);</span>
<a href="#l85.1818"></a><span id="l85.1818">         lastVal = lineText.substring(colon + 1);</span>
<a href="#l85.1819"></a><span id="l85.1819">       } // empty, continuation, start of header</span>
<a href="#l85.1820"></a><span id="l85.1820">     } // while (true)</span>
<a href="#l85.1821"></a><span id="l85.1821" class="difflineminus">-  }</span>
<a href="#l85.1822"></a><span id="l85.1822" class="difflineplus">+  },</span>
<a href="#l85.1823"></a><span id="l85.1823"> };</span>
<a href="#l85.1824"></a><span id="l85.1824"> </span>
<a href="#l85.1825"></a><span id="l85.1825"> </span>
<a href="#l85.1826"></a><span id="l85.1826"> /** The character codes for CR and LF. */</span>
<a href="#l85.1827"></a><span id="l85.1827"> var CR = 0x0D, LF = 0x0A;</span>
<a href="#l85.1828"></a><span id="l85.1828"> </span>
<a href="#l85.1829"></a><span id="l85.1829"> /**</span>
<a href="#l85.1830"></a><span id="l85.1830">  * Calculates the number of characters before the first CRLF pair in array, or</span>
<a href="#l85.1831"></a><span id="l85.1831" class="difflineat">@@ -1844,60 +1635,53 @@ var CR = 0x0D, LF = 0x0A;</span>
<a href="#l85.1832"></a><span id="l85.1832">  *   character; the first CRLF is the lowest index i where</span>
<a href="#l85.1833"></a><span id="l85.1833">  *   |array[i] == &quot;\r&quot;.charCodeAt(0)| and |array[i+1] == &quot;\n&quot;.charCodeAt(0)|,</span>
<a href="#l85.1834"></a><span id="l85.1834">  *   if such an |i| exists, and -1 otherwise</span>
<a href="#l85.1835"></a><span id="l85.1835">  * @param start : uint</span>
<a href="#l85.1836"></a><span id="l85.1836">  *   start index from which to begin searching in array</span>
<a href="#l85.1837"></a><span id="l85.1837">  * @returns int</span>
<a href="#l85.1838"></a><span id="l85.1838">  *   the index of the first CRLF if any were present, -1 otherwise</span>
<a href="#l85.1839"></a><span id="l85.1839">  */</span>
<a href="#l85.1840"></a><span id="l85.1840" class="difflineminus">-function findCRLF(array, start)</span>
<a href="#l85.1841"></a><span id="l85.1841" class="difflineminus">-{</span>
<a href="#l85.1842"></a><span id="l85.1842" class="difflineminus">-  for (var i = array.indexOf(CR, start); i &gt;= 0; i = array.indexOf(CR, i + 1))</span>
<a href="#l85.1843"></a><span id="l85.1843" class="difflineminus">-  {</span>
<a href="#l85.1844"></a><span id="l85.1844" class="difflineplus">+function findCRLF(array, start) {</span>
<a href="#l85.1845"></a><span id="l85.1845" class="difflineplus">+  for (var i = array.indexOf(CR, start); i &gt;= 0; i = array.indexOf(CR, i + 1)) {</span>
<a href="#l85.1846"></a><span id="l85.1846">     if (array[i + 1] == LF)</span>
<a href="#l85.1847"></a><span id="l85.1847">       return i;</span>
<a href="#l85.1848"></a><span id="l85.1848">   }</span>
<a href="#l85.1849"></a><span id="l85.1849">   return -1;</span>
<a href="#l85.1850"></a><span id="l85.1850"> }</span>
<a href="#l85.1851"></a><span id="l85.1851"> </span>
<a href="#l85.1852"></a><span id="l85.1852"> </span>
<a href="#l85.1853"></a><span id="l85.1853"> /**</span>
<a href="#l85.1854"></a><span id="l85.1854">  * A container which provides line-by-line access to the arrays of bytes with</span>
<a href="#l85.1855"></a><span id="l85.1855">  * which it is seeded.</span>
<a href="#l85.1856"></a><span id="l85.1856">  */</span>
<a href="#l85.1857"></a><span id="l85.1857" class="difflineminus">-function LineData()</span>
<a href="#l85.1858"></a><span id="l85.1858" class="difflineminus">-{</span>
<a href="#l85.1859"></a><span id="l85.1859" class="difflineplus">+function LineData() {</span>
<a href="#l85.1860"></a><span id="l85.1860">   /** An array of queued bytes from which to get line-based characters. */</span>
<a href="#l85.1861"></a><span id="l85.1861">   this._data = [];</span>
<a href="#l85.1862"></a><span id="l85.1862"> </span>
<a href="#l85.1863"></a><span id="l85.1863">   /** Start index from which to search for CRLF. */</span>
<a href="#l85.1864"></a><span id="l85.1864">   this._start = 0;</span>
<a href="#l85.1865"></a><span id="l85.1865"> }</span>
<a href="#l85.1866"></a><span id="l85.1866" class="difflineminus">-LineData.prototype =</span>
<a href="#l85.1867"></a><span id="l85.1867" class="difflineminus">-{</span>
<a href="#l85.1868"></a><span id="l85.1868" class="difflineplus">+LineData.prototype = {</span>
<a href="#l85.1869"></a><span id="l85.1869">   /**</span>
<a href="#l85.1870"></a><span id="l85.1870">    * Appends the bytes in the given array to the internal data cache maintained</span>
<a href="#l85.1871"></a><span id="l85.1871">    * by this.</span>
<a href="#l85.1872"></a><span id="l85.1872">    */</span>
<a href="#l85.1873"></a><span id="l85.1873" class="difflineminus">-  appendBytes: function(bytes)</span>
<a href="#l85.1874"></a><span id="l85.1874" class="difflineminus">-  {</span>
<a href="#l85.1875"></a><span id="l85.1875" class="difflineplus">+  appendBytes(bytes) {</span>
<a href="#l85.1876"></a><span id="l85.1876">     var count = bytes.length;</span>
<a href="#l85.1877"></a><span id="l85.1877">     var quantum = 262144; // just above half SpiderMonkey's argument-count limit</span>
<a href="#l85.1878"></a><span id="l85.1878" class="difflineminus">-    if (count &lt; quantum)</span>
<a href="#l85.1879"></a><span id="l85.1879" class="difflineminus">-    {</span>
<a href="#l85.1880"></a><span id="l85.1880" class="difflineplus">+    if (count &lt; quantum) {</span>
<a href="#l85.1881"></a><span id="l85.1881">       Array.prototype.push.apply(this._data, bytes);</span>
<a href="#l85.1882"></a><span id="l85.1882">       return;</span>
<a href="#l85.1883"></a><span id="l85.1883">     }</span>
<a href="#l85.1884"></a><span id="l85.1884"> </span>
<a href="#l85.1885"></a><span id="l85.1885">     // Large numbers of bytes may cause Array.prototype.push to be called with</span>
<a href="#l85.1886"></a><span id="l85.1886">     // more arguments than the JavaScript engine supports.  In that case append</span>
<a href="#l85.1887"></a><span id="l85.1887">     // bytes in fixed-size amounts until all bytes are appended.</span>
<a href="#l85.1888"></a><span id="l85.1888" class="difflineminus">-    for (var start = 0; start &lt; count; start += quantum)</span>
<a href="#l85.1889"></a><span id="l85.1889" class="difflineminus">-    {</span>
<a href="#l85.1890"></a><span id="l85.1890" class="difflineplus">+    for (var start = 0; start &lt; count; start += quantum) {</span>
<a href="#l85.1891"></a><span id="l85.1891">       var slice = bytes.slice(start, Math.min(start + quantum, count));</span>
<a href="#l85.1892"></a><span id="l85.1892">       Array.prototype.push.apply(this._data, slice);</span>
<a href="#l85.1893"></a><span id="l85.1893">     }</span>
<a href="#l85.1894"></a><span id="l85.1894">   },</span>
<a href="#l85.1895"></a><span id="l85.1895"> </span>
<a href="#l85.1896"></a><span id="l85.1896">   /**</span>
<a href="#l85.1897"></a><span id="l85.1897">    * Removes and returns a line of data, delimited by CRLF, from this.</span>
<a href="#l85.1898"></a><span id="l85.1898">    *</span>
<a href="#l85.1899"></a><span id="l85.1899" class="difflineat">@@ -1905,22 +1689,20 @@ LineData.prototype =</span>
<a href="#l85.1900"></a><span id="l85.1900">    *   an object whose &quot;value&quot; property will be set to the first line of text</span>
<a href="#l85.1901"></a><span id="l85.1901">    *   present in this, sans CRLF, if this contains a full CRLF-delimited line</span>
<a href="#l85.1902"></a><span id="l85.1902">    *   of text; if this doesn't contain enough data, the value of the property</span>
<a href="#l85.1903"></a><span id="l85.1903">    *   is undefined</span>
<a href="#l85.1904"></a><span id="l85.1904">    * @returns boolean</span>
<a href="#l85.1905"></a><span id="l85.1905">    *   true if a full line of data could be read from the data in this, false</span>
<a href="#l85.1906"></a><span id="l85.1906">    *   otherwise</span>
<a href="#l85.1907"></a><span id="l85.1907">    */</span>
<a href="#l85.1908"></a><span id="l85.1908" class="difflineminus">-  readLine: function(out)</span>
<a href="#l85.1909"></a><span id="l85.1909" class="difflineminus">-  {</span>
<a href="#l85.1910"></a><span id="l85.1910" class="difflineplus">+  readLine(out) {</span>
<a href="#l85.1911"></a><span id="l85.1911">     var data = this._data;</span>
<a href="#l85.1912"></a><span id="l85.1912">     var length = findCRLF(data, this._start);</span>
<a href="#l85.1913"></a><span id="l85.1913" class="difflineminus">-    if (length &lt; 0)</span>
<a href="#l85.1914"></a><span id="l85.1914" class="difflineminus">-    {</span>
<a href="#l85.1915"></a><span id="l85.1915" class="difflineplus">+    if (length &lt; 0) {</span>
<a href="#l85.1916"></a><span id="l85.1916">       this._start = data.length;</span>
<a href="#l85.1917"></a><span id="l85.1917"> </span>
<a href="#l85.1918"></a><span id="l85.1918">       // But if our data ends in a CR, we have to back up one, because</span>
<a href="#l85.1919"></a><span id="l85.1919">       // the first byte in the next packet might be an LF and if we</span>
<a href="#l85.1920"></a><span id="l85.1920">       // start looking at data.length we won't find it.</span>
<a href="#l85.1921"></a><span id="l85.1921">       if (data.length &gt; 0 &amp;&amp; data[data.length - 1] === CR)</span>
<a href="#l85.1922"></a><span id="l85.1922">         --this._start;</span>
<a href="#l85.1923"></a><span id="l85.1923"> </span>
<a href="#l85.1924"></a><span id="l85.1924" class="difflineat">@@ -1933,125 +1715,118 @@ LineData.prototype =</span>
<a href="#l85.1925"></a><span id="l85.1925">     //</span>
<a href="#l85.1926"></a><span id="l85.1926">     // We have the index of the CR, so remove all the characters, including</span>
<a href="#l85.1927"></a><span id="l85.1927">     // CRLF, from the array with splice, and convert the removed array</span>
<a href="#l85.1928"></a><span id="l85.1928">     // (excluding the trailing CRLF characters) into the corresponding string.</span>
<a href="#l85.1929"></a><span id="l85.1929">     //</span>
<a href="#l85.1930"></a><span id="l85.1930">     var leading = data.splice(0, length + 2);</span>
<a href="#l85.1931"></a><span id="l85.1931">     var quantum = 262144;</span>
<a href="#l85.1932"></a><span id="l85.1932">     var line = &quot;&quot;;</span>
<a href="#l85.1933"></a><span id="l85.1933" class="difflineminus">-    for (var start = 0; start &lt; length; start += quantum)</span>
<a href="#l85.1934"></a><span id="l85.1934" class="difflineminus">-    {</span>
<a href="#l85.1935"></a><span id="l85.1935" class="difflineplus">+    for (var start = 0; start &lt; length; start += quantum) {</span>
<a href="#l85.1936"></a><span id="l85.1936">       var slice = leading.slice(start, Math.min(start + quantum, length));</span>
<a href="#l85.1937"></a><span id="l85.1937">       line += String.fromCharCode.apply(null, slice);</span>
<a href="#l85.1938"></a><span id="l85.1938">     }</span>
<a href="#l85.1939"></a><span id="l85.1939"> </span>
<a href="#l85.1940"></a><span id="l85.1940">     out.value = line;</span>
<a href="#l85.1941"></a><span id="l85.1941">     return true;</span>
<a href="#l85.1942"></a><span id="l85.1942">   },</span>
<a href="#l85.1943"></a><span id="l85.1943"> </span>
<a href="#l85.1944"></a><span id="l85.1944">   /**</span>
<a href="#l85.1945"></a><span id="l85.1945">    * Removes the bytes currently within this and returns them in an array.</span>
<a href="#l85.1946"></a><span id="l85.1946">    *</span>
<a href="#l85.1947"></a><span id="l85.1947">    * @returns Array</span>
<a href="#l85.1948"></a><span id="l85.1948">    *   the bytes within this when this method is called</span>
<a href="#l85.1949"></a><span id="l85.1949">    */</span>
<a href="#l85.1950"></a><span id="l85.1950" class="difflineminus">-  purge: function()</span>
<a href="#l85.1951"></a><span id="l85.1951" class="difflineminus">-  {</span>
<a href="#l85.1952"></a><span id="l85.1952" class="difflineplus">+  purge() {</span>
<a href="#l85.1953"></a><span id="l85.1953">     var data = this._data;</span>
<a href="#l85.1954"></a><span id="l85.1954">     this._data = [];</span>
<a href="#l85.1955"></a><span id="l85.1955">     return data;</span>
<a href="#l85.1956"></a><span id="l85.1956" class="difflineminus">-  }</span>
<a href="#l85.1957"></a><span id="l85.1957" class="difflineplus">+  },</span>
<a href="#l85.1958"></a><span id="l85.1958"> };</span>
<a href="#l85.1959"></a><span id="l85.1959"> </span>
<a href="#l85.1960"></a><span id="l85.1960"> </span>
<a href="#l85.1961"></a><span id="l85.1961"> </span>
<a href="#l85.1962"></a><span id="l85.1962"> /**</span>
<a href="#l85.1963"></a><span id="l85.1963">  * Creates a request-handling function for an nsIHttpRequestHandler object.</span>
<a href="#l85.1964"></a><span id="l85.1964">  */</span>
<a href="#l85.1965"></a><span id="l85.1965" class="difflineminus">-function createHandlerFunc(handler)</span>
<a href="#l85.1966"></a><span id="l85.1966" class="difflineminus">-{</span>
<a href="#l85.1967"></a><span id="l85.1967" class="difflineminus">-  return function(metadata, response) { handler.handle(metadata, response); };</span>
<a href="#l85.1968"></a><span id="l85.1968" class="difflineplus">+function createHandlerFunc(handler) {</span>
<a href="#l85.1969"></a><span id="l85.1969" class="difflineplus">+  return function(metadata, response) {</span>
<a href="#l85.1970"></a><span id="l85.1970" class="difflineplus">+    handler.handle(metadata, response);</span>
<a href="#l85.1971"></a><span id="l85.1971" class="difflineplus">+  };</span>
<a href="#l85.1972"></a><span id="l85.1972"> }</span>
<a href="#l85.1973"></a><span id="l85.1973"> </span>
<a href="#l85.1974"></a><span id="l85.1974"> </span>
<a href="#l85.1975"></a><span id="l85.1975"> /**</span>
<a href="#l85.1976"></a><span id="l85.1976">  * The default handler for directories; writes an HTML response containing a</span>
<a href="#l85.1977"></a><span id="l85.1977">  * slightly-formatted directory listing.</span>
<a href="#l85.1978"></a><span id="l85.1978">  */</span>
<a href="#l85.1979"></a><span id="l85.1979" class="difflineminus">-function defaultIndexHandler(metadata, response)</span>
<a href="#l85.1980"></a><span id="l85.1980" class="difflineminus">-{</span>
<a href="#l85.1981"></a><span id="l85.1981" class="difflineplus">+function defaultIndexHandler(metadata, response) {</span>
<a href="#l85.1982"></a><span id="l85.1982">   response.setHeader(&quot;Content-Type&quot;, &quot;text/html&quot;, false);</span>
<a href="#l85.1983"></a><span id="l85.1983"> </span>
<a href="#l85.1984"></a><span id="l85.1984">   var path = htmlEscape(decodeURI(metadata.path));</span>
<a href="#l85.1985"></a><span id="l85.1985"> </span>
<a href="#l85.1986"></a><span id="l85.1986">   //</span>
<a href="#l85.1987"></a><span id="l85.1987">   // Just do a very basic bit of directory listings -- no need for too much</span>
<a href="#l85.1988"></a><span id="l85.1988">   // fanciness, especially since we don't have a style sheet in which we can</span>
<a href="#l85.1989"></a><span id="l85.1989">   // stick rules (don't want to pollute the default path-space).</span>
<a href="#l85.1990"></a><span id="l85.1990">   //</span>
<a href="#l85.1991"></a><span id="l85.1991"> </span>
<a href="#l85.1992"></a><span id="l85.1992" class="difflineminus">-  var body = '&lt;html&gt;\</span>
<a href="#l85.1993"></a><span id="l85.1993" class="difflineminus">-                &lt;head&gt;\</span>
<a href="#l85.1994"></a><span id="l85.1994" class="difflineminus">-                  &lt;title&gt;' + path + '&lt;/title&gt;\</span>
<a href="#l85.1995"></a><span id="l85.1995" class="difflineminus">-                &lt;/head&gt;\</span>
<a href="#l85.1996"></a><span id="l85.1996" class="difflineminus">-                &lt;body&gt;\</span>
<a href="#l85.1997"></a><span id="l85.1997" class="difflineminus">-                  &lt;h1&gt;' + path + '&lt;/h1&gt;\</span>
<a href="#l85.1998"></a><span id="l85.1998" class="difflineminus">-                  &lt;ol style=&quot;list-style-type: none&quot;&gt;';</span>
<a href="#l85.1999"></a><span id="l85.1999" class="difflineplus">+  var body = `&lt;html&gt;</span>
<a href="#l85.2000"></a><span id="l85.2000" class="difflineplus">+                &lt;head&gt;</span>
<a href="#l85.2001"></a><span id="l85.2001" class="difflineplus">+                  &lt;title&gt;${path}&lt;/title&gt;</span>
<a href="#l85.2002"></a><span id="l85.2002" class="difflineplus">+                &lt;/head&gt;</span>
<a href="#l85.2003"></a><span id="l85.2003" class="difflineplus">+                &lt;body&gt;</span>
<a href="#l85.2004"></a><span id="l85.2004" class="difflineplus">+                  &lt;h1&gt;${path}&lt;/h1&gt;</span>
<a href="#l85.2005"></a><span id="l85.2005" class="difflineplus">+                  &lt;ol style=&quot;list-style-type: none&quot;&gt;`;</span>
<a href="#l85.2006"></a><span id="l85.2006"> </span>
<a href="#l85.2007"></a><span id="l85.2007">   var directory = metadata.getProperty(&quot;directory&quot;);</span>
<a href="#l85.2008"></a><span id="l85.2008">   NS_ASSERT(directory &amp;&amp; directory.isDirectory());</span>
<a href="#l85.2009"></a><span id="l85.2009"> </span>
<a href="#l85.2010"></a><span id="l85.2010">   var fileList = [];</span>
<a href="#l85.2011"></a><span id="l85.2011">   var files = directory.directoryEntries;</span>
<a href="#l85.2012"></a><span id="l85.2012" class="difflineminus">-  while (files.hasMoreElements())</span>
<a href="#l85.2013"></a><span id="l85.2013" class="difflineminus">-  {</span>
<a href="#l85.2014"></a><span id="l85.2014" class="difflineplus">+  while (files.hasMoreElements()) {</span>
<a href="#l85.2015"></a><span id="l85.2015">     var f = files.getNext().QueryInterface(Ci.nsIFile);</span>
<a href="#l85.2016"></a><span id="l85.2016">     var name = f.leafName;</span>
<a href="#l85.2017"></a><span id="l85.2017">     if (!f.isHidden() &amp;&amp;</span>
<a href="#l85.2018"></a><span id="l85.2018">         (name.charAt(name.length - 1) != HIDDEN_CHAR ||</span>
<a href="#l85.2019"></a><span id="l85.2019">          name.charAt(name.length - 2) == HIDDEN_CHAR))</span>
<a href="#l85.2020"></a><span id="l85.2020">       fileList.push(f);</span>
<a href="#l85.2021"></a><span id="l85.2021">   }</span>
<a href="#l85.2022"></a><span id="l85.2022"> </span>
<a href="#l85.2023"></a><span id="l85.2023">   fileList.sort(fileSort);</span>
<a href="#l85.2024"></a><span id="l85.2024"> </span>
<a href="#l85.2025"></a><span id="l85.2025" class="difflineminus">-  for (var i = 0; i &lt; fileList.length; i++)</span>
<a href="#l85.2026"></a><span id="l85.2026" class="difflineminus">-  {</span>
<a href="#l85.2027"></a><span id="l85.2027" class="difflineplus">+  for (var i = 0; i &lt; fileList.length; i++) {</span>
<a href="#l85.2028"></a><span id="l85.2028">     var file = fileList[i];</span>
<a href="#l85.2029"></a><span id="l85.2029" class="difflineminus">-    try</span>
<a href="#l85.2030"></a><span id="l85.2030" class="difflineminus">-    {</span>
<a href="#l85.2031"></a><span id="l85.2031" class="difflineminus">-      var name = file.leafName;</span>
<a href="#l85.2032"></a><span id="l85.2032" class="difflineplus">+    try {</span>
<a href="#l85.2033"></a><span id="l85.2033" class="difflineplus">+      name = file.leafName;</span>
<a href="#l85.2034"></a><span id="l85.2034">       if (name.charAt(name.length - 1) == HIDDEN_CHAR)</span>
<a href="#l85.2035"></a><span id="l85.2035">         name = name.substring(0, name.length - 1);</span>
<a href="#l85.2036"></a><span id="l85.2036">       var sep = file.isDirectory() ? &quot;/&quot; : &quot;&quot;;</span>
<a href="#l85.2037"></a><span id="l85.2037"> </span>
<a href="#l85.2038"></a><span id="l85.2038">       // Note: using &quot; to delimit the attribute here because encodeURIComponent</span>
<a href="#l85.2039"></a><span id="l85.2039">       //       passes through '.</span>
<a href="#l85.2040"></a><span id="l85.2040">       var item = '&lt;li&gt;&lt;a href=&quot;' + encodeURIComponent(name) + sep + '&quot;&gt;' +</span>
<a href="#l85.2041"></a><span id="l85.2041">                    htmlEscape(name) + sep +</span>
<a href="#l85.2042"></a><span id="l85.2042" class="difflineminus">-                 '&lt;/a&gt;&lt;/li&gt;';</span>
<a href="#l85.2043"></a><span id="l85.2043" class="difflineplus">+                 &quot;&lt;/a&gt;&lt;/li&gt;&quot;;</span>
<a href="#l85.2044"></a><span id="l85.2044"> </span>
<a href="#l85.2045"></a><span id="l85.2045">       body += item;</span>
<a href="#l85.2046"></a><span id="l85.2046" class="difflineminus">-    }</span>
<a href="#l85.2047"></a><span id="l85.2047" class="difflineminus">-    catch (e) { /* some file system error, ignore the file */ }</span>
<a href="#l85.2048"></a><span id="l85.2048" class="difflineplus">+    } catch (e) { /* some file system error, ignore the file */ }</span>
<a href="#l85.2049"></a><span id="l85.2049">   }</span>
<a href="#l85.2050"></a><span id="l85.2050"> </span>
<a href="#l85.2051"></a><span id="l85.2051" class="difflineminus">-  body    += '    &lt;/ol&gt;\</span>
<a href="#l85.2052"></a><span id="l85.2052" class="difflineminus">-                &lt;/body&gt;\</span>
<a href="#l85.2053"></a><span id="l85.2053" class="difflineminus">-              &lt;/html&gt;';</span>
<a href="#l85.2054"></a><span id="l85.2054" class="difflineplus">+  body += `       &lt;/ol&gt;</span>
<a href="#l85.2055"></a><span id="l85.2055" class="difflineplus">+                &lt;/body&gt;</span>
<a href="#l85.2056"></a><span id="l85.2056" class="difflineplus">+              &lt;/html&gt;`;</span>
<a href="#l85.2057"></a><span id="l85.2057"> </span>
<a href="#l85.2058"></a><span id="l85.2058">   response.bodyOutputStream.write(body, body.length);</span>
<a href="#l85.2059"></a><span id="l85.2059"> }</span>
<a href="#l85.2060"></a><span id="l85.2060"> </span>
<a href="#l85.2061"></a><span id="l85.2061"> /**</span>
<a href="#l85.2062"></a><span id="l85.2062">  * Sorts a and b (nsIFile objects) into an aesthetically pleasing order.</span>
<a href="#l85.2063"></a><span id="l85.2063">  */</span>
<a href="#l85.2064"></a><span id="l85.2064" class="difflineminus">-function fileSort(a, b)</span>
<a href="#l85.2065"></a><span id="l85.2065" class="difflineminus">-{</span>
<a href="#l85.2066"></a><span id="l85.2066" class="difflineplus">+function fileSort(a, b) {</span>
<a href="#l85.2067"></a><span id="l85.2067">   var dira = a.isDirectory(), dirb = b.isDirectory();</span>
<a href="#l85.2068"></a><span id="l85.2068"> </span>
<a href="#l85.2069"></a><span id="l85.2069">   if (dira &amp;&amp; !dirb)</span>
<a href="#l85.2070"></a><span id="l85.2070">     return -1;</span>
<a href="#l85.2071"></a><span id="l85.2071">   if (dirb &amp;&amp; !dira)</span>
<a href="#l85.2072"></a><span id="l85.2072">     return 1;</span>
<a href="#l85.2073"></a><span id="l85.2073"> </span>
<a href="#l85.2074"></a><span id="l85.2074">   var namea = a.leafName.toLowerCase(), nameb = b.leafName.toLowerCase();</span>
<a href="#l85.2075"></a><span id="l85.2075" class="difflineat">@@ -2066,24 +1841,22 @@ function fileSort(a, b)</span>
<a href="#l85.2076"></a><span id="l85.2076">  * @param path</span>
<a href="#l85.2077"></a><span id="l85.2077">  *   the path to convert</span>
<a href="#l85.2078"></a><span id="l85.2078">  * @param encoded</span>
<a href="#l85.2079"></a><span id="l85.2079">  *   true if the given path should be passed through decodeURI prior to</span>
<a href="#l85.2080"></a><span id="l85.2080">  *   conversion</span>
<a href="#l85.2081"></a><span id="l85.2081">  * @throws URIError</span>
<a href="#l85.2082"></a><span id="l85.2082">  *   if path is incorrectly encoded</span>
<a href="#l85.2083"></a><span id="l85.2083">  */</span>
<a href="#l85.2084"></a><span id="l85.2084" class="difflineminus">-function toInternalPath(path, encoded)</span>
<a href="#l85.2085"></a><span id="l85.2085" class="difflineminus">-{</span>
<a href="#l85.2086"></a><span id="l85.2086" class="difflineplus">+function toInternalPath(path, encoded) {</span>
<a href="#l85.2087"></a><span id="l85.2087">   if (encoded)</span>
<a href="#l85.2088"></a><span id="l85.2088">     path = decodeURI(path);</span>
<a href="#l85.2089"></a><span id="l85.2089"> </span>
<a href="#l85.2090"></a><span id="l85.2090">   var comps = path.split(&quot;/&quot;);</span>
<a href="#l85.2091"></a><span id="l85.2091" class="difflineminus">-  for (var i = 0, sz = comps.length; i &lt; sz; i++)</span>
<a href="#l85.2092"></a><span id="l85.2092" class="difflineminus">-  {</span>
<a href="#l85.2093"></a><span id="l85.2093" class="difflineplus">+  for (var i = 0, sz = comps.length; i &lt; sz; i++) {</span>
<a href="#l85.2094"></a><span id="l85.2094">     var comp = comps[i];</span>
<a href="#l85.2095"></a><span id="l85.2095">     if (comp.charAt(comp.length - 1) == HIDDEN_CHAR)</span>
<a href="#l85.2096"></a><span id="l85.2096">       comps[i] = comp + HIDDEN_CHAR;</span>
<a href="#l85.2097"></a><span id="l85.2097">   }</span>
<a href="#l85.2098"></a><span id="l85.2098">   return comps.join(&quot;/&quot;);</span>
<a href="#l85.2099"></a><span id="l85.2099"> }</span>
<a href="#l85.2100"></a><span id="l85.2100"> </span>
<a href="#l85.2101"></a><span id="l85.2101"> </span>
<a href="#l85.2102"></a><span id="l85.2102" class="difflineat">@@ -2095,107 +1868,95 @@ function toInternalPath(path, encoded)</span>
<a href="#l85.2103"></a><span id="l85.2103">  *   the file on the disk which is to be written</span>
<a href="#l85.2104"></a><span id="l85.2104">  * @param metadata</span>
<a href="#l85.2105"></a><span id="l85.2105">  *   metadata about the incoming request</span>
<a href="#l85.2106"></a><span id="l85.2106">  * @param response</span>
<a href="#l85.2107"></a><span id="l85.2107">  *   the Response to which any specified headers/data should be written</span>
<a href="#l85.2108"></a><span id="l85.2108">  * @throws HTTP_500</span>
<a href="#l85.2109"></a><span id="l85.2109">  *   if an error occurred while processing custom-specified headers</span>
<a href="#l85.2110"></a><span id="l85.2110">  */</span>
<a href="#l85.2111"></a><span id="l85.2111" class="difflineminus">-function maybeAddHeaders(file, metadata, response)</span>
<a href="#l85.2112"></a><span id="l85.2112" class="difflineminus">-{</span>
<a href="#l85.2113"></a><span id="l85.2113" class="difflineplus">+function maybeAddHeaders(file, metadata, response) {</span>
<a href="#l85.2114"></a><span id="l85.2114">   var name = file.leafName;</span>
<a href="#l85.2115"></a><span id="l85.2115">   if (name.charAt(name.length - 1) == HIDDEN_CHAR)</span>
<a href="#l85.2116"></a><span id="l85.2116">     name = name.substring(0, name.length - 1);</span>
<a href="#l85.2117"></a><span id="l85.2117"> </span>
<a href="#l85.2118"></a><span id="l85.2118">   var headerFile = file.parent;</span>
<a href="#l85.2119"></a><span id="l85.2119">   headerFile.append(name + HEADERS_SUFFIX);</span>
<a href="#l85.2120"></a><span id="l85.2120"> </span>
<a href="#l85.2121"></a><span id="l85.2121">   if (!headerFile.exists())</span>
<a href="#l85.2122"></a><span id="l85.2122">     return;</span>
<a href="#l85.2123"></a><span id="l85.2123"> </span>
<a href="#l85.2124"></a><span id="l85.2124">   const PR_RDONLY = 0x01;</span>
<a href="#l85.2125"></a><span id="l85.2125">   var fis = new FileInputStream(headerFile, PR_RDONLY, 0o444,</span>
<a href="#l85.2126"></a><span id="l85.2126">                                 Ci.nsIFileInputStream.CLOSE_ON_EOF);</span>
<a href="#l85.2127"></a><span id="l85.2127"> </span>
<a href="#l85.2128"></a><span id="l85.2128" class="difflineminus">-  try</span>
<a href="#l85.2129"></a><span id="l85.2129" class="difflineminus">-  {</span>
<a href="#l85.2130"></a><span id="l85.2130" class="difflineplus">+  try {</span>
<a href="#l85.2131"></a><span id="l85.2131">     var lis = new ConverterInputStream(fis, &quot;UTF-8&quot;, 1024, 0x0);</span>
<a href="#l85.2132"></a><span id="l85.2132">     lis.QueryInterface(Ci.nsIUnicharLineInputStream);</span>
<a href="#l85.2133"></a><span id="l85.2133"> </span>
<a href="#l85.2134"></a><span id="l85.2134">     var line = {value: &quot;&quot;};</span>
<a href="#l85.2135"></a><span id="l85.2135">     var more = lis.readLine(line);</span>
<a href="#l85.2136"></a><span id="l85.2136"> </span>
<a href="#l85.2137"></a><span id="l85.2137">     if (!more &amp;&amp; line.value == &quot;&quot;)</span>
<a href="#l85.2138"></a><span id="l85.2138">       return;</span>
<a href="#l85.2139"></a><span id="l85.2139"> </span>
<a href="#l85.2140"></a><span id="l85.2140"> </span>
<a href="#l85.2141"></a><span id="l85.2141">     // request line</span>
<a href="#l85.2142"></a><span id="l85.2142"> </span>
<a href="#l85.2143"></a><span id="l85.2143">     var status = line.value;</span>
<a href="#l85.2144"></a><span id="l85.2144" class="difflineminus">-    if (status.indexOf(&quot;HTTP &quot;) == 0)</span>
<a href="#l85.2145"></a><span id="l85.2145" class="difflineminus">-    {</span>
<a href="#l85.2146"></a><span id="l85.2146" class="difflineplus">+    if (status.indexOf(&quot;HTTP &quot;) == 0) {</span>
<a href="#l85.2147"></a><span id="l85.2147">       status = status.substring(5);</span>
<a href="#l85.2148"></a><span id="l85.2148">       var space = status.indexOf(&quot; &quot;);</span>
<a href="#l85.2149"></a><span id="l85.2149">       var code, description;</span>
<a href="#l85.2150"></a><span id="l85.2150" class="difflineminus">-      if (space &lt; 0)</span>
<a href="#l85.2151"></a><span id="l85.2151" class="difflineminus">-      {</span>
<a href="#l85.2152"></a><span id="l85.2152" class="difflineplus">+      if (space &lt; 0) {</span>
<a href="#l85.2153"></a><span id="l85.2153">         code = status;</span>
<a href="#l85.2154"></a><span id="l85.2154">         description = &quot;&quot;;</span>
<a href="#l85.2155"></a><span id="l85.2155" class="difflineminus">-      }</span>
<a href="#l85.2156"></a><span id="l85.2156" class="difflineminus">-      else</span>
<a href="#l85.2157"></a><span id="l85.2157" class="difflineminus">-      {</span>
<a href="#l85.2158"></a><span id="l85.2158" class="difflineplus">+      } else {</span>
<a href="#l85.2159"></a><span id="l85.2159">         code = status.substring(0, space);</span>
<a href="#l85.2160"></a><span id="l85.2160">         description = status.substring(space + 1, status.length);</span>
<a href="#l85.2161"></a><span id="l85.2161">       }</span>
<a href="#l85.2162"></a><span id="l85.2162"> </span>
<a href="#l85.2163"></a><span id="l85.2163">       response.setStatusLine(metadata.httpVersion, parseInt(code, 10), description);</span>
<a href="#l85.2164"></a><span id="l85.2164"> </span>
<a href="#l85.2165"></a><span id="l85.2165">       line.value = &quot;&quot;;</span>
<a href="#l85.2166"></a><span id="l85.2166">       more = lis.readLine(line);</span>
<a href="#l85.2167"></a><span id="l85.2167">     }</span>
<a href="#l85.2168"></a><span id="l85.2168"> </span>
<a href="#l85.2169"></a><span id="l85.2169">     // headers</span>
<a href="#l85.2170"></a><span id="l85.2170" class="difflineminus">-    while (more || line.value != &quot;&quot;)</span>
<a href="#l85.2171"></a><span id="l85.2171" class="difflineminus">-    {</span>
<a href="#l85.2172"></a><span id="l85.2172" class="difflineplus">+    while (more || line.value != &quot;&quot;) {</span>
<a href="#l85.2173"></a><span id="l85.2173">       var header = line.value;</span>
<a href="#l85.2174"></a><span id="l85.2174">       var colon = header.indexOf(&quot;:&quot;);</span>
<a href="#l85.2175"></a><span id="l85.2175"> </span>
<a href="#l85.2176"></a><span id="l85.2176">       response.setHeader(header.substring(0, colon),</span>
<a href="#l85.2177"></a><span id="l85.2177">                          header.substring(colon + 1, header.length),</span>
<a href="#l85.2178"></a><span id="l85.2178">                          false); // allow overriding server-set headers</span>
<a href="#l85.2179"></a><span id="l85.2179"> </span>
<a href="#l85.2180"></a><span id="l85.2180">       line.value = &quot;&quot;;</span>
<a href="#l85.2181"></a><span id="l85.2181">       more = lis.readLine(line);</span>
<a href="#l85.2182"></a><span id="l85.2182">     }</span>
<a href="#l85.2183"></a><span id="l85.2183" class="difflineminus">-  }</span>
<a href="#l85.2184"></a><span id="l85.2184" class="difflineminus">-  catch (e)</span>
<a href="#l85.2185"></a><span id="l85.2185" class="difflineminus">-  {</span>
<a href="#l85.2186"></a><span id="l85.2186" class="difflineplus">+  } catch (e) {</span>
<a href="#l85.2187"></a><span id="l85.2187">     dumpn(&quot;WARNING: error in headers for &quot; + metadata.path + &quot;: &quot; + e);</span>
<a href="#l85.2188"></a><span id="l85.2188">     throw HTTP_500;</span>
<a href="#l85.2189"></a><span id="l85.2189" class="difflineminus">-  }</span>
<a href="#l85.2190"></a><span id="l85.2190" class="difflineminus">-  finally</span>
<a href="#l85.2191"></a><span id="l85.2191" class="difflineminus">-  {</span>
<a href="#l85.2192"></a><span id="l85.2192" class="difflineplus">+  } finally {</span>
<a href="#l85.2193"></a><span id="l85.2193">     fis.close();</span>
<a href="#l85.2194"></a><span id="l85.2194">   }</span>
<a href="#l85.2195"></a><span id="l85.2195"> }</span>
<a href="#l85.2196"></a><span id="l85.2196"> </span>
<a href="#l85.2197"></a><span id="l85.2197"> </span>
<a href="#l85.2198"></a><span id="l85.2198"> /**</span>
<a href="#l85.2199"></a><span id="l85.2199">  * An object which handles requests for a server, executing default and</span>
<a href="#l85.2200"></a><span id="l85.2200">  * overridden behaviors as instructed by the code which uses and manipulates it.</span>
<a href="#l85.2201"></a><span id="l85.2201">  * Default behavior includes the paths / and /trace (diagnostics), with some</span>
<a href="#l85.2202"></a><span id="l85.2202">  * support for HTTP error pages for various codes and fallback to HTTP 500 if</span>
<a href="#l85.2203"></a><span id="l85.2203">  * those codes fail for any reason.</span>
<a href="#l85.2204"></a><span id="l85.2204">  *</span>
<a href="#l85.2205"></a><span id="l85.2205">  * @param server : nsHttpServer</span>
<a href="#l85.2206"></a><span id="l85.2206">  *   the server in which this handler is being used</span>
<a href="#l85.2207"></a><span id="l85.2207">  */</span>
<a href="#l85.2208"></a><span id="l85.2208" class="difflineminus">-function ServerHandler(server)</span>
<a href="#l85.2209"></a><span id="l85.2209" class="difflineminus">-{</span>
<a href="#l85.2210"></a><span id="l85.2210" class="difflineplus">+function ServerHandler(server) {</span>
<a href="#l85.2211"></a><span id="l85.2211">   // FIELDS</span>
<a href="#l85.2212"></a><span id="l85.2212"> </span>
<a href="#l85.2213"></a><span id="l85.2213">   /**</span>
<a href="#l85.2214"></a><span id="l85.2214">    * The nsHttpServer instance associated with this handler.</span>
<a href="#l85.2215"></a><span id="l85.2215">    */</span>
<a href="#l85.2216"></a><span id="l85.2216">   this._server = server;</span>
<a href="#l85.2217"></a><span id="l85.2217"> </span>
<a href="#l85.2218"></a><span id="l85.2218">   /**</span>
<a href="#l85.2219"></a><span id="l85.2219" class="difflineat">@@ -2251,243 +2012,210 @@ function ServerHandler(server)</span>
<a href="#l85.2220"></a><span id="l85.2220">   this._state = {};</span>
<a href="#l85.2221"></a><span id="l85.2221"> </span>
<a href="#l85.2222"></a><span id="l85.2222">   /** Entire-server state storage. */</span>
<a href="#l85.2223"></a><span id="l85.2223">   this._sharedState = {};</span>
<a href="#l85.2224"></a><span id="l85.2224"> </span>
<a href="#l85.2225"></a><span id="l85.2225">   /** Entire-server state storage for nsISupports values. */</span>
<a href="#l85.2226"></a><span id="l85.2226">   this._objectState = {};</span>
<a href="#l85.2227"></a><span id="l85.2227"> }</span>
<a href="#l85.2228"></a><span id="l85.2228" class="difflineminus">-ServerHandler.prototype =</span>
<a href="#l85.2229"></a><span id="l85.2229" class="difflineminus">-{</span>
<a href="#l85.2230"></a><span id="l85.2230" class="difflineplus">+ServerHandler.prototype = {</span>
<a href="#l85.2231"></a><span id="l85.2231">   // PUBLIC API</span>
<a href="#l85.2232"></a><span id="l85.2232"> </span>
<a href="#l85.2233"></a><span id="l85.2233">   /**</span>
<a href="#l85.2234"></a><span id="l85.2234">    * Handles a request to this server, responding to the request appropriately</span>
<a href="#l85.2235"></a><span id="l85.2235">    * and initiating server shutdown if necessary.</span>
<a href="#l85.2236"></a><span id="l85.2236">    *</span>
<a href="#l85.2237"></a><span id="l85.2237">    * This method never throws an exception.</span>
<a href="#l85.2238"></a><span id="l85.2238">    *</span>
<a href="#l85.2239"></a><span id="l85.2239">    * @param connection : Connection</span>
<a href="#l85.2240"></a><span id="l85.2240">    *   the connection for this request</span>
<a href="#l85.2241"></a><span id="l85.2241">    */</span>
<a href="#l85.2242"></a><span id="l85.2242" class="difflineminus">-  handleResponse: function(connection)</span>
<a href="#l85.2243"></a><span id="l85.2243" class="difflineminus">-  {</span>
<a href="#l85.2244"></a><span id="l85.2244" class="difflineplus">+  handleResponse(connection) {</span>
<a href="#l85.2245"></a><span id="l85.2245">     var request = connection.request;</span>
<a href="#l85.2246"></a><span id="l85.2246">     var response = new Response(connection);</span>
<a href="#l85.2247"></a><span id="l85.2247"> </span>
<a href="#l85.2248"></a><span id="l85.2248">     var path = request.path;</span>
<a href="#l85.2249"></a><span id="l85.2249">     dumpn(&quot;*** path == &quot; + path);</span>
<a href="#l85.2250"></a><span id="l85.2250"> </span>
<a href="#l85.2251"></a><span id="l85.2251" class="difflineminus">-    try</span>
<a href="#l85.2252"></a><span id="l85.2252" class="difflineminus">-    {</span>
<a href="#l85.2253"></a><span id="l85.2253" class="difflineminus">-      try</span>
<a href="#l85.2254"></a><span id="l85.2254" class="difflineminus">-      {</span>
<a href="#l85.2255"></a><span id="l85.2255" class="difflineminus">-        if (path in this._overridePaths)</span>
<a href="#l85.2256"></a><span id="l85.2256" class="difflineminus">-        {</span>
<a href="#l85.2257"></a><span id="l85.2257" class="difflineplus">+    try {</span>
<a href="#l85.2258"></a><span id="l85.2258" class="difflineplus">+      try {</span>
<a href="#l85.2259"></a><span id="l85.2259" class="difflineplus">+        if (path in this._overridePaths) {</span>
<a href="#l85.2260"></a><span id="l85.2260">           // explicit paths first, then files based on existing directory mappings,</span>
<a href="#l85.2261"></a><span id="l85.2261">           // then (if the file doesn't exist) built-in server default paths</span>
<a href="#l85.2262"></a><span id="l85.2262">           dumpn(&quot;calling override for &quot; + path);</span>
<a href="#l85.2263"></a><span id="l85.2263">           this._overridePaths[path](request, response);</span>
<a href="#l85.2264"></a><span id="l85.2264" class="difflineminus">-        }</span>
<a href="#l85.2265"></a><span id="l85.2265" class="difflineminus">-        else</span>
<a href="#l85.2266"></a><span id="l85.2266" class="difflineminus">-        {</span>
<a href="#l85.2267"></a><span id="l85.2267" class="difflineplus">+        } else {</span>
<a href="#l85.2268"></a><span id="l85.2268">           var longestPrefix = &quot;&quot;;</span>
<a href="#l85.2269"></a><span id="l85.2269">           for (let prefix in this._overridePrefixes) {</span>
<a href="#l85.2270"></a><span id="l85.2270">             if (prefix.length &gt; longestPrefix.length &amp;&amp;</span>
<a href="#l85.2271"></a><span id="l85.2271" class="difflineminus">-                path.substr(0, prefix.length) == prefix)</span>
<a href="#l85.2272"></a><span id="l85.2272" class="difflineminus">-            {</span>
<a href="#l85.2273"></a><span id="l85.2273" class="difflineplus">+                path.substr(0, prefix.length) == prefix) {</span>
<a href="#l85.2274"></a><span id="l85.2274">               longestPrefix = prefix;</span>
<a href="#l85.2275"></a><span id="l85.2275">             }</span>
<a href="#l85.2276"></a><span id="l85.2276">           }</span>
<a href="#l85.2277"></a><span id="l85.2277" class="difflineminus">-          if (longestPrefix.length &gt; 0)</span>
<a href="#l85.2278"></a><span id="l85.2278" class="difflineminus">-          {</span>
<a href="#l85.2279"></a><span id="l85.2279" class="difflineplus">+          if (longestPrefix.length &gt; 0) {</span>
<a href="#l85.2280"></a><span id="l85.2280">             dumpn(&quot;calling prefix override for &quot; + longestPrefix);</span>
<a href="#l85.2281"></a><span id="l85.2281">             this._overridePrefixes[longestPrefix](request, response);</span>
<a href="#l85.2282"></a><span id="l85.2282" class="difflineminus">-          }</span>
<a href="#l85.2283"></a><span id="l85.2283" class="difflineminus">-          else</span>
<a href="#l85.2284"></a><span id="l85.2284" class="difflineminus">-          {</span>
<a href="#l85.2285"></a><span id="l85.2285" class="difflineplus">+          } else {</span>
<a href="#l85.2286"></a><span id="l85.2286">             this._handleDefault(request, response);</span>
<a href="#l85.2287"></a><span id="l85.2287">           }</span>
<a href="#l85.2288"></a><span id="l85.2288">         }</span>
<a href="#l85.2289"></a><span id="l85.2289" class="difflineminus">-      }</span>
<a href="#l85.2290"></a><span id="l85.2290" class="difflineminus">-      catch (e)</span>
<a href="#l85.2291"></a><span id="l85.2291" class="difflineminus">-      {</span>
<a href="#l85.2292"></a><span id="l85.2292" class="difflineminus">-        if (response.partiallySent())</span>
<a href="#l85.2293"></a><span id="l85.2293" class="difflineminus">-        {</span>
<a href="#l85.2294"></a><span id="l85.2294" class="difflineplus">+      } catch (e) {</span>
<a href="#l85.2295"></a><span id="l85.2295" class="difflineplus">+        if (response.partiallySent()) {</span>
<a href="#l85.2296"></a><span id="l85.2296">           response.abort(e);</span>
<a href="#l85.2297"></a><span id="l85.2297">           return;</span>
<a href="#l85.2298"></a><span id="l85.2298">         }</span>
<a href="#l85.2299"></a><span id="l85.2299"> </span>
<a href="#l85.2300"></a><span id="l85.2300" class="difflineminus">-        if (!(e instanceof HttpError))</span>
<a href="#l85.2301"></a><span id="l85.2301" class="difflineminus">-        {</span>
<a href="#l85.2302"></a><span id="l85.2302" class="difflineplus">+        if (!(e instanceof HttpError)) {</span>
<a href="#l85.2303"></a><span id="l85.2303">           dumpn(&quot;*** unexpected error: e == &quot; + e);</span>
<a href="#l85.2304"></a><span id="l85.2304">           throw HTTP_500;</span>
<a href="#l85.2305"></a><span id="l85.2305">         }</span>
<a href="#l85.2306"></a><span id="l85.2306">         if (e.code !== 404)</span>
<a href="#l85.2307"></a><span id="l85.2307">           throw e;</span>
<a href="#l85.2308"></a><span id="l85.2308"> </span>
<a href="#l85.2309"></a><span id="l85.2309">         dumpn(&quot;*** default: &quot; + (path in this._defaultPaths));</span>
<a href="#l85.2310"></a><span id="l85.2310"> </span>
<a href="#l85.2311"></a><span id="l85.2311">         response = new Response(connection);</span>
<a href="#l85.2312"></a><span id="l85.2312">         if (path in this._defaultPaths)</span>
<a href="#l85.2313"></a><span id="l85.2313">           this._defaultPaths[path](request, response);</span>
<a href="#l85.2314"></a><span id="l85.2314">         else</span>
<a href="#l85.2315"></a><span id="l85.2315">           throw HTTP_404;</span>
<a href="#l85.2316"></a><span id="l85.2316">       }</span>
<a href="#l85.2317"></a><span id="l85.2317" class="difflineminus">-    }</span>
<a href="#l85.2318"></a><span id="l85.2318" class="difflineminus">-    catch (e)</span>
<a href="#l85.2319"></a><span id="l85.2319" class="difflineminus">-    {</span>
<a href="#l85.2320"></a><span id="l85.2320" class="difflineminus">-      if (response.partiallySent())</span>
<a href="#l85.2321"></a><span id="l85.2321" class="difflineminus">-      {</span>
<a href="#l85.2322"></a><span id="l85.2322" class="difflineplus">+    } catch (e) {</span>
<a href="#l85.2323"></a><span id="l85.2323" class="difflineplus">+      if (response.partiallySent()) {</span>
<a href="#l85.2324"></a><span id="l85.2324">         response.abort(e);</span>
<a href="#l85.2325"></a><span id="l85.2325">         return;</span>
<a href="#l85.2326"></a><span id="l85.2326">       }</span>
<a href="#l85.2327"></a><span id="l85.2327"> </span>
<a href="#l85.2328"></a><span id="l85.2328">       var errorCode = &quot;internal&quot;;</span>
<a href="#l85.2329"></a><span id="l85.2329"> </span>
<a href="#l85.2330"></a><span id="l85.2330" class="difflineminus">-      try</span>
<a href="#l85.2331"></a><span id="l85.2331" class="difflineminus">-      {</span>
<a href="#l85.2332"></a><span id="l85.2332" class="difflineplus">+      try {</span>
<a href="#l85.2333"></a><span id="l85.2333">         if (!(e instanceof HttpError))</span>
<a href="#l85.2334"></a><span id="l85.2334">           throw e;</span>
<a href="#l85.2335"></a><span id="l85.2335"> </span>
<a href="#l85.2336"></a><span id="l85.2336">         errorCode = e.code;</span>
<a href="#l85.2337"></a><span id="l85.2337">         dumpn(&quot;*** errorCode == &quot; + errorCode);</span>
<a href="#l85.2338"></a><span id="l85.2338"> </span>
<a href="#l85.2339"></a><span id="l85.2339">         response = new Response(connection);</span>
<a href="#l85.2340"></a><span id="l85.2340">         if (e.customErrorHandling)</span>
<a href="#l85.2341"></a><span id="l85.2341">           e.customErrorHandling(response);</span>
<a href="#l85.2342"></a><span id="l85.2342">         this._handleError(errorCode, request, response);</span>
<a href="#l85.2343"></a><span id="l85.2343">         return;</span>
<a href="#l85.2344"></a><span id="l85.2344" class="difflineminus">-      }</span>
<a href="#l85.2345"></a><span id="l85.2345" class="difflineminus">-      catch (e2)</span>
<a href="#l85.2346"></a><span id="l85.2346" class="difflineminus">-      {</span>
<a href="#l85.2347"></a><span id="l85.2347" class="difflineplus">+      } catch (e2) {</span>
<a href="#l85.2348"></a><span id="l85.2348">         dumpn(&quot;*** error handling &quot; + errorCode + &quot; error: &quot; +</span>
<a href="#l85.2349"></a><span id="l85.2349">               &quot;e2 == &quot; + e2 + &quot;, shutting down server&quot;);</span>
<a href="#l85.2350"></a><span id="l85.2350"> </span>
<a href="#l85.2351"></a><span id="l85.2351">         connection.server._requestQuit();</span>
<a href="#l85.2352"></a><span id="l85.2352">         response.abort(e2);</span>
<a href="#l85.2353"></a><span id="l85.2353">         return;</span>
<a href="#l85.2354"></a><span id="l85.2354">       }</span>
<a href="#l85.2355"></a><span id="l85.2355">     }</span>
<a href="#l85.2356"></a><span id="l85.2356"> </span>
<a href="#l85.2357"></a><span id="l85.2357">     response.complete();</span>
<a href="#l85.2358"></a><span id="l85.2358">   },</span>
<a href="#l85.2359"></a><span id="l85.2359"> </span>
<a href="#l85.2360"></a><span id="l85.2360">   //</span>
<a href="#l85.2361"></a><span id="l85.2361">   // see nsIHttpServer.registerFile</span>
<a href="#l85.2362"></a><span id="l85.2362">   //</span>
<a href="#l85.2363"></a><span id="l85.2363" class="difflineminus">-  registerFile: function(path, file)</span>
<a href="#l85.2364"></a><span id="l85.2364" class="difflineminus">-  {</span>
<a href="#l85.2365"></a><span id="l85.2365" class="difflineminus">-    if (!file)</span>
<a href="#l85.2366"></a><span id="l85.2366" class="difflineminus">-    {</span>
<a href="#l85.2367"></a><span id="l85.2367" class="difflineplus">+  registerFile(path, file) {</span>
<a href="#l85.2368"></a><span id="l85.2368" class="difflineplus">+    if (!file) {</span>
<a href="#l85.2369"></a><span id="l85.2369">       dumpn(&quot;*** unregistering '&quot; + path + &quot;' mapping&quot;);</span>
<a href="#l85.2370"></a><span id="l85.2370">       delete this._overridePaths[path];</span>
<a href="#l85.2371"></a><span id="l85.2371">       return;</span>
<a href="#l85.2372"></a><span id="l85.2372">     }</span>
<a href="#l85.2373"></a><span id="l85.2373"> </span>
<a href="#l85.2374"></a><span id="l85.2374">     dumpn(&quot;*** registering '&quot; + path + &quot;' as mapping to &quot; + file.path);</span>
<a href="#l85.2375"></a><span id="l85.2375">     file = file.clone();</span>
<a href="#l85.2376"></a><span id="l85.2376"> </span>
<a href="#l85.2377"></a><span id="l85.2377">     var self = this;</span>
<a href="#l85.2378"></a><span id="l85.2378">     this._overridePaths[path] =</span>
<a href="#l85.2379"></a><span id="l85.2379" class="difflineminus">-      function(request, response)</span>
<a href="#l85.2380"></a><span id="l85.2380" class="difflineminus">-      {</span>
<a href="#l85.2381"></a><span id="l85.2381" class="difflineplus">+      function(request, response) {</span>
<a href="#l85.2382"></a><span id="l85.2382">         if (!file.exists())</span>
<a href="#l85.2383"></a><span id="l85.2383">           throw HTTP_404;</span>
<a href="#l85.2384"></a><span id="l85.2384"> </span>
<a href="#l85.2385"></a><span id="l85.2385">         response.setStatusLine(request.httpVersion, 200, &quot;OK&quot;);</span>
<a href="#l85.2386"></a><span id="l85.2386">         self._writeFileResponse(request, file, response, 0, file.fileSize);</span>
<a href="#l85.2387"></a><span id="l85.2387">       };</span>
<a href="#l85.2388"></a><span id="l85.2388">   },</span>
<a href="#l85.2389"></a><span id="l85.2389"> </span>
<a href="#l85.2390"></a><span id="l85.2390">   //</span>
<a href="#l85.2391"></a><span id="l85.2391">   // see nsIHttpServer.registerPathHandler</span>
<a href="#l85.2392"></a><span id="l85.2392">   //</span>
<a href="#l85.2393"></a><span id="l85.2393" class="difflineminus">-  registerPathHandler: function(path, handler)</span>
<a href="#l85.2394"></a><span id="l85.2394" class="difflineminus">-  {</span>
<a href="#l85.2395"></a><span id="l85.2395" class="difflineplus">+  registerPathHandler(path, handler) {</span>
<a href="#l85.2396"></a><span id="l85.2396">     // XXX true path validation!</span>
<a href="#l85.2397"></a><span id="l85.2397">     if (path.charAt(0) != &quot;/&quot;)</span>
<a href="#l85.2398"></a><span id="l85.2398">       throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l85.2399"></a><span id="l85.2399"> </span>
<a href="#l85.2400"></a><span id="l85.2400">     this._handlerToField(handler, this._overridePaths, path);</span>
<a href="#l85.2401"></a><span id="l85.2401">   },</span>
<a href="#l85.2402"></a><span id="l85.2402"> </span>
<a href="#l85.2403"></a><span id="l85.2403">   //</span>
<a href="#l85.2404"></a><span id="l85.2404">   // see nsIHttpServer.registerPrefixHandler</span>
<a href="#l85.2405"></a><span id="l85.2405">   //</span>
<a href="#l85.2406"></a><span id="l85.2406" class="difflineminus">-  registerPrefixHandler: function(path, handler)</span>
<a href="#l85.2407"></a><span id="l85.2407" class="difflineminus">-  {</span>
<a href="#l85.2408"></a><span id="l85.2408" class="difflineplus">+  registerPrefixHandler(path, handler) {</span>
<a href="#l85.2409"></a><span id="l85.2409">     // XXX true path validation!</span>
<a href="#l85.2410"></a><span id="l85.2410">     if (path.charAt(0) != &quot;/&quot; || path.charAt(path.length - 1) != &quot;/&quot;)</span>
<a href="#l85.2411"></a><span id="l85.2411">       throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l85.2412"></a><span id="l85.2412"> </span>
<a href="#l85.2413"></a><span id="l85.2413">     this._handlerToField(handler, this._overridePrefixes, path);</span>
<a href="#l85.2414"></a><span id="l85.2414">   },</span>
<a href="#l85.2415"></a><span id="l85.2415"> </span>
<a href="#l85.2416"></a><span id="l85.2416">   //</span>
<a href="#l85.2417"></a><span id="l85.2417">   // see nsIHttpServer.registerDirectory</span>
<a href="#l85.2418"></a><span id="l85.2418">   //</span>
<a href="#l85.2419"></a><span id="l85.2419" class="difflineminus">-  registerDirectory: function(path, directory)</span>
<a href="#l85.2420"></a><span id="l85.2420" class="difflineminus">-  {</span>
<a href="#l85.2421"></a><span id="l85.2421" class="difflineplus">+  registerDirectory(path, directory) {</span>
<a href="#l85.2422"></a><span id="l85.2422">     // strip off leading and trailing '/' so that we can use lastIndexOf when</span>
<a href="#l85.2423"></a><span id="l85.2423">     // determining exactly how a path maps onto a mapped directory --</span>
<a href="#l85.2424"></a><span id="l85.2424">     // conditional is required here to deal with &quot;/&quot;.substring(1, 0) being</span>
<a href="#l85.2425"></a><span id="l85.2425">     // converted to &quot;/&quot;.substring(0, 1) per the JS specification</span>
<a href="#l85.2426"></a><span id="l85.2426">     var key = path.length == 1 ? &quot;&quot; : path.substring(1, path.length - 1);</span>
<a href="#l85.2427"></a><span id="l85.2427"> </span>
<a href="#l85.2428"></a><span id="l85.2428">     // the path-to-directory mapping code requires that the first character not</span>
<a href="#l85.2429"></a><span id="l85.2429">     // be &quot;/&quot;, or it will go into an infinite loop</span>
<a href="#l85.2430"></a><span id="l85.2430">     if (key.charAt(0) == &quot;/&quot;)</span>
<a href="#l85.2431"></a><span id="l85.2431">       throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l85.2432"></a><span id="l85.2432"> </span>
<a href="#l85.2433"></a><span id="l85.2433">     key = toInternalPath(key, false);</span>
<a href="#l85.2434"></a><span id="l85.2434"> </span>
<a href="#l85.2435"></a><span id="l85.2435" class="difflineminus">-    if (directory)</span>
<a href="#l85.2436"></a><span id="l85.2436" class="difflineminus">-    {</span>
<a href="#l85.2437"></a><span id="l85.2437" class="difflineplus">+    if (directory) {</span>
<a href="#l85.2438"></a><span id="l85.2438">       dumpn(&quot;*** mapping '&quot; + path + &quot;' to the location &quot; + directory.path);</span>
<a href="#l85.2439"></a><span id="l85.2439">       this._pathDirectoryMap.put(key, directory);</span>
<a href="#l85.2440"></a><span id="l85.2440" class="difflineminus">-    }</span>
<a href="#l85.2441"></a><span id="l85.2441" class="difflineminus">-    else</span>
<a href="#l85.2442"></a><span id="l85.2442" class="difflineminus">-    {</span>
<a href="#l85.2443"></a><span id="l85.2443" class="difflineplus">+    } else {</span>
<a href="#l85.2444"></a><span id="l85.2444">       dumpn(&quot;*** removing mapping for '&quot; + path + &quot;'&quot;);</span>
<a href="#l85.2445"></a><span id="l85.2445">       this._pathDirectoryMap.put(key, null);</span>
<a href="#l85.2446"></a><span id="l85.2446">     }</span>
<a href="#l85.2447"></a><span id="l85.2447">   },</span>
<a href="#l85.2448"></a><span id="l85.2448"> </span>
<a href="#l85.2449"></a><span id="l85.2449">   //</span>
<a href="#l85.2450"></a><span id="l85.2450">   // see nsIHttpServer.registerErrorHandler</span>
<a href="#l85.2451"></a><span id="l85.2451">   //</span>
<a href="#l85.2452"></a><span id="l85.2452" class="difflineminus">-  registerErrorHandler: function(err, handler)</span>
<a href="#l85.2453"></a><span id="l85.2453" class="difflineminus">-  {</span>
<a href="#l85.2454"></a><span id="l85.2454" class="difflineplus">+  registerErrorHandler(err, handler) {</span>
<a href="#l85.2455"></a><span id="l85.2455">     if (!(err in HTTP_ERROR_CODES))</span>
<a href="#l85.2456"></a><span id="l85.2456">       dumpn(&quot;*** WARNING: registering non-HTTP/1.1 error code &quot; +</span>
<a href="#l85.2457"></a><span id="l85.2457">             &quot;(&quot; + err + &quot;) handler -- was this intentional?&quot;);</span>
<a href="#l85.2458"></a><span id="l85.2458"> </span>
<a href="#l85.2459"></a><span id="l85.2459">     this._handlerToField(handler, this._overrideErrors, err);</span>
<a href="#l85.2460"></a><span id="l85.2460">   },</span>
<a href="#l85.2461"></a><span id="l85.2461"> </span>
<a href="#l85.2462"></a><span id="l85.2462">   //</span>
<a href="#l85.2463"></a><span id="l85.2463">   // see nsIHttpServer.setIndexHandler</span>
<a href="#l85.2464"></a><span id="l85.2464">   //</span>
<a href="#l85.2465"></a><span id="l85.2465" class="difflineminus">-  setIndexHandler: function(handler)</span>
<a href="#l85.2466"></a><span id="l85.2466" class="difflineminus">-  {</span>
<a href="#l85.2467"></a><span id="l85.2467" class="difflineplus">+  setIndexHandler(handler) {</span>
<a href="#l85.2468"></a><span id="l85.2468">     if (!handler)</span>
<a href="#l85.2469"></a><span id="l85.2469">       handler = defaultIndexHandler;</span>
<a href="#l85.2470"></a><span id="l85.2470">     else if (typeof(handler) != &quot;function&quot;)</span>
<a href="#l85.2471"></a><span id="l85.2471">       handler = createHandlerFunc(handler);</span>
<a href="#l85.2472"></a><span id="l85.2472"> </span>
<a href="#l85.2473"></a><span id="l85.2473">     this._indexHandler = handler;</span>
<a href="#l85.2474"></a><span id="l85.2474">   },</span>
<a href="#l85.2475"></a><span id="l85.2475"> </span>
<a href="#l85.2476"></a><span id="l85.2476">   //</span>
<a href="#l85.2477"></a><span id="l85.2477">   // see nsIHttpServer.registerContentType</span>
<a href="#l85.2478"></a><span id="l85.2478">   //</span>
<a href="#l85.2479"></a><span id="l85.2479" class="difflineminus">-  registerContentType: function(ext, type)</span>
<a href="#l85.2480"></a><span id="l85.2480" class="difflineminus">-  {</span>
<a href="#l85.2481"></a><span id="l85.2481" class="difflineplus">+  registerContentType(ext, type) {</span>
<a href="#l85.2482"></a><span id="l85.2482">     if (!type)</span>
<a href="#l85.2483"></a><span id="l85.2483">       delete this._mimeMappings[ext];</span>
<a href="#l85.2484"></a><span id="l85.2484">     else</span>
<a href="#l85.2485"></a><span id="l85.2485">       this._mimeMappings[ext] = headerUtils.normalizeFieldValue(type);</span>
<a href="#l85.2486"></a><span id="l85.2486">   },</span>
<a href="#l85.2487"></a><span id="l85.2487"> </span>
<a href="#l85.2488"></a><span id="l85.2488">   // PRIVATE API</span>
<a href="#l85.2489"></a><span id="l85.2489"> </span>
<a href="#l85.2490"></a><span id="l85.2490" class="difflineat">@@ -2496,18 +2224,17 @@ ServerHandler.prototype =</span>
<a href="#l85.2491"></a><span id="l85.2491">    *</span>
<a href="#l85.2492"></a><span id="l85.2492">    * @param handler</span>
<a href="#l85.2493"></a><span id="l85.2493">    *   a handler, either function or an nsIHttpRequestHandler</span>
<a href="#l85.2494"></a><span id="l85.2494">    * @param dict</span>
<a href="#l85.2495"></a><span id="l85.2495">    *   The object to attach the handler to.</span>
<a href="#l85.2496"></a><span id="l85.2496">    * @param key</span>
<a href="#l85.2497"></a><span id="l85.2497">    *   The field name of the handler.</span>
<a href="#l85.2498"></a><span id="l85.2498">    */</span>
<a href="#l85.2499"></a><span id="l85.2499" class="difflineminus">-  _handlerToField: function(handler, dict, key)</span>
<a href="#l85.2500"></a><span id="l85.2500" class="difflineminus">-  {</span>
<a href="#l85.2501"></a><span id="l85.2501" class="difflineplus">+  _handlerToField(handler, dict, key) {</span>
<a href="#l85.2502"></a><span id="l85.2502">     // for convenience, handler can be a function if this is run from xpcshell</span>
<a href="#l85.2503"></a><span id="l85.2503">     if (typeof(handler) == &quot;function&quot;)</span>
<a href="#l85.2504"></a><span id="l85.2504">       dict[key] = handler;</span>
<a href="#l85.2505"></a><span id="l85.2505">     else if (handler)</span>
<a href="#l85.2506"></a><span id="l85.2506">       dict[key] = createHandlerFunc(handler);</span>
<a href="#l85.2507"></a><span id="l85.2507">     else</span>
<a href="#l85.2508"></a><span id="l85.2508">       delete dict[key];</span>
<a href="#l85.2509"></a><span id="l85.2509">   },</span>
<a href="#l85.2510"></a><span id="l85.2510" class="difflineat">@@ -2520,107 +2247,94 @@ ServerHandler.prototype =</span>
<a href="#l85.2511"></a><span id="l85.2511">    *   metadata for the incoming request</span>
<a href="#l85.2512"></a><span id="l85.2512">    * @param response : Response</span>
<a href="#l85.2513"></a><span id="l85.2513">    *   an uninitialized Response to the given request, to be initialized by a</span>
<a href="#l85.2514"></a><span id="l85.2514">    *   request handler</span>
<a href="#l85.2515"></a><span id="l85.2515">    * @throws HTTP_###</span>
<a href="#l85.2516"></a><span id="l85.2516">    *   if an HTTP error occurred (usually HTTP_404); note that in this case the</span>
<a href="#l85.2517"></a><span id="l85.2517">    *   calling code must handle post-processing of the response</span>
<a href="#l85.2518"></a><span id="l85.2518">    */</span>
<a href="#l85.2519"></a><span id="l85.2519" class="difflineminus">-  _handleDefault: function(metadata, response)</span>
<a href="#l85.2520"></a><span id="l85.2520" class="difflineminus">-  {</span>
<a href="#l85.2521"></a><span id="l85.2521" class="difflineplus">+  _handleDefault(metadata, response) {</span>
<a href="#l85.2522"></a><span id="l85.2522">     dumpn(&quot;*** _handleDefault()&quot;);</span>
<a href="#l85.2523"></a><span id="l85.2523"> </span>
<a href="#l85.2524"></a><span id="l85.2524">     response.setStatusLine(metadata.httpVersion, 200, &quot;OK&quot;);</span>
<a href="#l85.2525"></a><span id="l85.2525"> </span>
<a href="#l85.2526"></a><span id="l85.2526">     var path = metadata.path;</span>
<a href="#l85.2527"></a><span id="l85.2527">     NS_ASSERT(path.charAt(0) == &quot;/&quot;, &quot;invalid path: &lt;&quot; + path + &quot;&gt;&quot;);</span>
<a href="#l85.2528"></a><span id="l85.2528"> </span>
<a href="#l85.2529"></a><span id="l85.2529">     // determine the actual on-disk file; this requires finding the deepest</span>
<a href="#l85.2530"></a><span id="l85.2530">     // path-to-directory mapping in the requested URL</span>
<a href="#l85.2531"></a><span id="l85.2531">     var file = this._getFileForPath(path);</span>
<a href="#l85.2532"></a><span id="l85.2532"> </span>
<a href="#l85.2533"></a><span id="l85.2533">     // the &quot;file&quot; might be a directory, in which case we either serve the</span>
<a href="#l85.2534"></a><span id="l85.2534">     // contained index.html or make the index handler write the response</span>
<a href="#l85.2535"></a><span id="l85.2535" class="difflineminus">-    if (file.exists() &amp;&amp; file.isDirectory())</span>
<a href="#l85.2536"></a><span id="l85.2536" class="difflineminus">-    {</span>
<a href="#l85.2537"></a><span id="l85.2537" class="difflineplus">+    if (file.exists() &amp;&amp; file.isDirectory()) {</span>
<a href="#l85.2538"></a><span id="l85.2538">       file.append(&quot;index.html&quot;); // make configurable?</span>
<a href="#l85.2539"></a><span id="l85.2539" class="difflineminus">-      if (!file.exists() || file.isDirectory())</span>
<a href="#l85.2540"></a><span id="l85.2540" class="difflineminus">-      {</span>
<a href="#l85.2541"></a><span id="l85.2541" class="difflineplus">+      if (!file.exists() || file.isDirectory()) {</span>
<a href="#l85.2542"></a><span id="l85.2542">         metadata._ensurePropertyBag();</span>
<a href="#l85.2543"></a><span id="l85.2543">         metadata._bag.setPropertyAsInterface(&quot;directory&quot;, file.parent);</span>
<a href="#l85.2544"></a><span id="l85.2544">         this._indexHandler(metadata, response);</span>
<a href="#l85.2545"></a><span id="l85.2545">         return;</span>
<a href="#l85.2546"></a><span id="l85.2546">       }</span>
<a href="#l85.2547"></a><span id="l85.2547">     }</span>
<a href="#l85.2548"></a><span id="l85.2548"> </span>
<a href="#l85.2549"></a><span id="l85.2549">     // alternately, the file might not exist</span>
<a href="#l85.2550"></a><span id="l85.2550">     if (!file.exists())</span>
<a href="#l85.2551"></a><span id="l85.2551">       throw HTTP_404;</span>
<a href="#l85.2552"></a><span id="l85.2552"> </span>
<a href="#l85.2553"></a><span id="l85.2553">     var start, end;</span>
<a href="#l85.2554"></a><span id="l85.2554">     if (metadata._httpVersion.atLeast(nsHttpVersion.HTTP_1_1) &amp;&amp;</span>
<a href="#l85.2555"></a><span id="l85.2555">         metadata.hasHeader(&quot;Range&quot;) &amp;&amp;</span>
<a href="#l85.2556"></a><span id="l85.2556" class="difflineminus">-        this._getTypeFromFile(file) !== SJS_TYPE)</span>
<a href="#l85.2557"></a><span id="l85.2557" class="difflineminus">-    {</span>
<a href="#l85.2558"></a><span id="l85.2558" class="difflineplus">+        this._getTypeFromFile(file) !== SJS_TYPE) {</span>
<a href="#l85.2559"></a><span id="l85.2559">       var rangeMatch = metadata.getHeader(&quot;Range&quot;).match(/^bytes=(\d+)?-(\d+)?$/);</span>
<a href="#l85.2560"></a><span id="l85.2560" class="difflineminus">-      if (!rangeMatch)</span>
<a href="#l85.2561"></a><span id="l85.2561" class="difflineminus">-      {</span>
<a href="#l85.2562"></a><span id="l85.2562" class="difflineplus">+      if (!rangeMatch) {</span>
<a href="#l85.2563"></a><span id="l85.2563">         dumpn(&quot;*** Range header bogosity: '&quot; + metadata.getHeader(&quot;Range&quot;) + &quot;'&quot;);</span>
<a href="#l85.2564"></a><span id="l85.2564">         throw HTTP_400;</span>
<a href="#l85.2565"></a><span id="l85.2565">       }</span>
<a href="#l85.2566"></a><span id="l85.2566"> </span>
<a href="#l85.2567"></a><span id="l85.2567">       if (rangeMatch[1] !== undefined)</span>
<a href="#l85.2568"></a><span id="l85.2568">         start = parseInt(rangeMatch[1], 10);</span>
<a href="#l85.2569"></a><span id="l85.2569"> </span>
<a href="#l85.2570"></a><span id="l85.2570">       if (rangeMatch[2] !== undefined)</span>
<a href="#l85.2571"></a><span id="l85.2571">         end = parseInt(rangeMatch[2], 10);</span>
<a href="#l85.2572"></a><span id="l85.2572"> </span>
<a href="#l85.2573"></a><span id="l85.2573" class="difflineminus">-      if (start === undefined &amp;&amp; end === undefined)</span>
<a href="#l85.2574"></a><span id="l85.2574" class="difflineminus">-      {</span>
<a href="#l85.2575"></a><span id="l85.2575" class="difflineplus">+      if (start === undefined &amp;&amp; end === undefined) {</span>
<a href="#l85.2576"></a><span id="l85.2576">         dumpn(&quot;*** More Range header bogosity: '&quot; + metadata.getHeader(&quot;Range&quot;) + &quot;'&quot;);</span>
<a href="#l85.2577"></a><span id="l85.2577">         throw HTTP_400;</span>
<a href="#l85.2578"></a><span id="l85.2578">       }</span>
<a href="#l85.2579"></a><span id="l85.2579"> </span>
<a href="#l85.2580"></a><span id="l85.2580">       // No start given, so the end is really the count of bytes from the</span>
<a href="#l85.2581"></a><span id="l85.2581">       // end of the file.</span>
<a href="#l85.2582"></a><span id="l85.2582" class="difflineminus">-      if (start === undefined)</span>
<a href="#l85.2583"></a><span id="l85.2583" class="difflineminus">-      {</span>
<a href="#l85.2584"></a><span id="l85.2584" class="difflineplus">+      if (start === undefined) {</span>
<a href="#l85.2585"></a><span id="l85.2585">         start = Math.max(0, file.fileSize - end);</span>
<a href="#l85.2586"></a><span id="l85.2586">         end   = file.fileSize - 1;</span>
<a href="#l85.2587"></a><span id="l85.2587">       }</span>
<a href="#l85.2588"></a><span id="l85.2588"> </span>
<a href="#l85.2589"></a><span id="l85.2589">       // start and end are inclusive</span>
<a href="#l85.2590"></a><span id="l85.2590">       if (end === undefined || end &gt;= file.fileSize)</span>
<a href="#l85.2591"></a><span id="l85.2591">         end = file.fileSize - 1;</span>
<a href="#l85.2592"></a><span id="l85.2592"> </span>
<a href="#l85.2593"></a><span id="l85.2593">       if (start !== undefined &amp;&amp; start &gt;= file.fileSize) {</span>
<a href="#l85.2594"></a><span id="l85.2594">         var HTTP_416 = new HttpError(416, &quot;Requested Range Not Satisfiable&quot;);</span>
<a href="#l85.2595"></a><span id="l85.2595" class="difflineminus">-        HTTP_416.customErrorHandling = function(errorResponse)</span>
<a href="#l85.2596"></a><span id="l85.2596" class="difflineminus">-        {</span>
<a href="#l85.2597"></a><span id="l85.2597" class="difflineplus">+        HTTP_416.customErrorHandling = function(errorResponse) {</span>
<a href="#l85.2598"></a><span id="l85.2598">           maybeAddHeaders(file, metadata, errorResponse);</span>
<a href="#l85.2599"></a><span id="l85.2599">         };</span>
<a href="#l85.2600"></a><span id="l85.2600">         throw HTTP_416;</span>
<a href="#l85.2601"></a><span id="l85.2601">       }</span>
<a href="#l85.2602"></a><span id="l85.2602"> </span>
<a href="#l85.2603"></a><span id="l85.2603" class="difflineminus">-      if (end &lt; start)</span>
<a href="#l85.2604"></a><span id="l85.2604" class="difflineminus">-      {</span>
<a href="#l85.2605"></a><span id="l85.2605" class="difflineplus">+      if (end &lt; start) {</span>
<a href="#l85.2606"></a><span id="l85.2606">         response.setStatusLine(metadata.httpVersion, 200, &quot;OK&quot;);</span>
<a href="#l85.2607"></a><span id="l85.2607">         start = 0;</span>
<a href="#l85.2608"></a><span id="l85.2608">         end = file.fileSize - 1;</span>
<a href="#l85.2609"></a><span id="l85.2609" class="difflineminus">-      }</span>
<a href="#l85.2610"></a><span id="l85.2610" class="difflineminus">-      else</span>
<a href="#l85.2611"></a><span id="l85.2611" class="difflineminus">-      {</span>
<a href="#l85.2612"></a><span id="l85.2612" class="difflineplus">+      } else {</span>
<a href="#l85.2613"></a><span id="l85.2613">         response.setStatusLine(metadata.httpVersion, 206, &quot;Partial Content&quot;);</span>
<a href="#l85.2614"></a><span id="l85.2614">         var contentRange = &quot;bytes &quot; + start + &quot;-&quot; + end + &quot;/&quot; + file.fileSize;</span>
<a href="#l85.2615"></a><span id="l85.2615">         response.setHeader(&quot;Content-Range&quot;, contentRange);</span>
<a href="#l85.2616"></a><span id="l85.2616">       }</span>
<a href="#l85.2617"></a><span id="l85.2617" class="difflineminus">-    }</span>
<a href="#l85.2618"></a><span id="l85.2618" class="difflineminus">-    else</span>
<a href="#l85.2619"></a><span id="l85.2619" class="difflineminus">-    {</span>
<a href="#l85.2620"></a><span id="l85.2620" class="difflineplus">+    } else {</span>
<a href="#l85.2621"></a><span id="l85.2621">       start = 0;</span>
<a href="#l85.2622"></a><span id="l85.2622">       end = file.fileSize - 1;</span>
<a href="#l85.2623"></a><span id="l85.2623">     }</span>
<a href="#l85.2624"></a><span id="l85.2624"> </span>
<a href="#l85.2625"></a><span id="l85.2625">     // finally...</span>
<a href="#l85.2626"></a><span id="l85.2626">     dumpn(&quot;*** handling '&quot; + path + &quot;' as mapping to &quot; + file.path + &quot; from &quot; +</span>
<a href="#l85.2627"></a><span id="l85.2627">           start + &quot; to &quot; + end + &quot; inclusive&quot;);</span>
<a href="#l85.2628"></a><span id="l85.2628">     this._writeFileResponse(metadata, file, response, start, end - start + 1);</span>
<a href="#l85.2629"></a><span id="l85.2629" class="difflineat">@@ -2636,190 +2350,151 @@ ServerHandler.prototype =</span>
<a href="#l85.2630"></a><span id="l85.2630">    *   the file which is to be sent in the response</span>
<a href="#l85.2631"></a><span id="l85.2631">    * @param response : Response</span>
<a href="#l85.2632"></a><span id="l85.2632">    *   the response to which the file should be written</span>
<a href="#l85.2633"></a><span id="l85.2633">    * @param offset: uint</span>
<a href="#l85.2634"></a><span id="l85.2634">    *   the byte offset to skip to when writing</span>
<a href="#l85.2635"></a><span id="l85.2635">    * @param count: uint</span>
<a href="#l85.2636"></a><span id="l85.2636">    *   the number of bytes to write</span>
<a href="#l85.2637"></a><span id="l85.2637">    */</span>
<a href="#l85.2638"></a><span id="l85.2638" class="difflineminus">-  _writeFileResponse: function(metadata, file, response, offset, count)</span>
<a href="#l85.2639"></a><span id="l85.2639" class="difflineminus">-  {</span>
<a href="#l85.2640"></a><span id="l85.2640" class="difflineplus">+  _writeFileResponse(metadata, file, response, offset, count) {</span>
<a href="#l85.2641"></a><span id="l85.2641">     const PR_RDONLY = 0x01;</span>
<a href="#l85.2642"></a><span id="l85.2642"> </span>
<a href="#l85.2643"></a><span id="l85.2643">     var type = this._getTypeFromFile(file);</span>
<a href="#l85.2644"></a><span id="l85.2644" class="difflineminus">-    if (type === SJS_TYPE)</span>
<a href="#l85.2645"></a><span id="l85.2645" class="difflineminus">-    {</span>
<a href="#l85.2646"></a><span id="l85.2646" class="difflineminus">-      var fis = new FileInputStream(file, PR_RDONLY, 0o444,</span>
<a href="#l85.2647"></a><span id="l85.2647" class="difflineplus">+    if (type === SJS_TYPE) {</span>
<a href="#l85.2648"></a><span id="l85.2648" class="difflineplus">+      let fis = new FileInputStream(file, PR_RDONLY, 0o444,</span>
<a href="#l85.2649"></a><span id="l85.2649">                                     Ci.nsIFileInputStream.CLOSE_ON_EOF);</span>
<a href="#l85.2650"></a><span id="l85.2650"> </span>
<a href="#l85.2651"></a><span id="l85.2651" class="difflineminus">-      try</span>
<a href="#l85.2652"></a><span id="l85.2652" class="difflineminus">-      {</span>
<a href="#l85.2653"></a><span id="l85.2653" class="difflineplus">+      try {</span>
<a href="#l85.2654"></a><span id="l85.2654">         var sis = new ScriptableInputStream(fis);</span>
<a href="#l85.2655"></a><span id="l85.2655">         var s = Cu.Sandbox(gGlobalObject);</span>
<a href="#l85.2656"></a><span id="l85.2656">         s.importFunction(dump, &quot;dump&quot;);</span>
<a href="#l85.2657"></a><span id="l85.2657"> </span>
<a href="#l85.2658"></a><span id="l85.2658">         // Define a basic key-value state-preservation API across requests, with</span>
<a href="#l85.2659"></a><span id="l85.2659">         // keys initially corresponding to the empty string.</span>
<a href="#l85.2660"></a><span id="l85.2660">         var self = this;</span>
<a href="#l85.2661"></a><span id="l85.2661">         var path = metadata.path;</span>
<a href="#l85.2662"></a><span id="l85.2662" class="difflineminus">-        s.importFunction(function getState(k)</span>
<a href="#l85.2663"></a><span id="l85.2663" class="difflineminus">-        {</span>
<a href="#l85.2664"></a><span id="l85.2664" class="difflineplus">+        s.importFunction(function(k) {</span>
<a href="#l85.2665"></a><span id="l85.2665">           return self._getState(path, k);</span>
<a href="#l85.2666"></a><span id="l85.2666">         });</span>
<a href="#l85.2667"></a><span id="l85.2667" class="difflineminus">-        s.importFunction(function setState(k, v)</span>
<a href="#l85.2668"></a><span id="l85.2668" class="difflineminus">-        {</span>
<a href="#l85.2669"></a><span id="l85.2669" class="difflineplus">+        s.importFunction(function(k, v) {</span>
<a href="#l85.2670"></a><span id="l85.2670">           self._setState(path, k, v);</span>
<a href="#l85.2671"></a><span id="l85.2671">         });</span>
<a href="#l85.2672"></a><span id="l85.2672" class="difflineminus">-        s.importFunction(function getSharedState(k)</span>
<a href="#l85.2673"></a><span id="l85.2673" class="difflineminus">-        {</span>
<a href="#l85.2674"></a><span id="l85.2674" class="difflineplus">+        s.importFunction(function(k) {</span>
<a href="#l85.2675"></a><span id="l85.2675">           return self._getSharedState(k);</span>
<a href="#l85.2676"></a><span id="l85.2676">         });</span>
<a href="#l85.2677"></a><span id="l85.2677" class="difflineminus">-        s.importFunction(function setSharedState(k, v)</span>
<a href="#l85.2678"></a><span id="l85.2678" class="difflineminus">-        {</span>
<a href="#l85.2679"></a><span id="l85.2679" class="difflineplus">+        s.importFunction(function(k, v) {</span>
<a href="#l85.2680"></a><span id="l85.2680">           self._setSharedState(k, v);</span>
<a href="#l85.2681"></a><span id="l85.2681">         });</span>
<a href="#l85.2682"></a><span id="l85.2682" class="difflineminus">-        s.importFunction(function getObjectState(k, callback)</span>
<a href="#l85.2683"></a><span id="l85.2683" class="difflineminus">-        {</span>
<a href="#l85.2684"></a><span id="l85.2684" class="difflineplus">+        s.importFunction(function(k, callback) {</span>
<a href="#l85.2685"></a><span id="l85.2685">           callback(self._getObjectState(k));</span>
<a href="#l85.2686"></a><span id="l85.2686">         });</span>
<a href="#l85.2687"></a><span id="l85.2687" class="difflineminus">-        s.importFunction(function setObjectState(k, v)</span>
<a href="#l85.2688"></a><span id="l85.2688" class="difflineminus">-        {</span>
<a href="#l85.2689"></a><span id="l85.2689" class="difflineplus">+        s.importFunction(function(k, v) {</span>
<a href="#l85.2690"></a><span id="l85.2690">           self._setObjectState(k, v);</span>
<a href="#l85.2691"></a><span id="l85.2691">         });</span>
<a href="#l85.2692"></a><span id="l85.2692" class="difflineminus">-        s.importFunction(function registerPathHandler(p, h)</span>
<a href="#l85.2693"></a><span id="l85.2693" class="difflineminus">-        {</span>
<a href="#l85.2694"></a><span id="l85.2694" class="difflineplus">+        s.importFunction(function(p, h) {</span>
<a href="#l85.2695"></a><span id="l85.2695">           self.registerPathHandler(p, h);</span>
<a href="#l85.2696"></a><span id="l85.2696">         });</span>
<a href="#l85.2697"></a><span id="l85.2697"> </span>
<a href="#l85.2698"></a><span id="l85.2698">         // Make it possible for sjs files to access their location</span>
<a href="#l85.2699"></a><span id="l85.2699">         this._setState(path, &quot;__LOCATION__&quot;, file.path);</span>
<a href="#l85.2700"></a><span id="l85.2700"> </span>
<a href="#l85.2701"></a><span id="l85.2701" class="difflineminus">-        try</span>
<a href="#l85.2702"></a><span id="l85.2702" class="difflineminus">-        {</span>
<a href="#l85.2703"></a><span id="l85.2703" class="difflineplus">+        try {</span>
<a href="#l85.2704"></a><span id="l85.2704">           // Alas, the line number in errors dumped to console when calling the</span>
<a href="#l85.2705"></a><span id="l85.2705">           // request handler is simply an offset from where we load the SJS file.</span>
<a href="#l85.2706"></a><span id="l85.2706">           // Work around this in a reasonably non-fragile way by dynamically</span>
<a href="#l85.2707"></a><span id="l85.2707">           // getting the line number where we evaluate the SJS file.  Don't</span>
<a href="#l85.2708"></a><span id="l85.2708">           // separate these two lines!</span>
<a href="#l85.2709"></a><span id="l85.2709">           var line = new Error().lineNumber;</span>
<a href="#l85.2710"></a><span id="l85.2710">           Cu.evalInSandbox(sis.read(file.fileSize), s);</span>
<a href="#l85.2711"></a><span id="l85.2711" class="difflineminus">-        }</span>
<a href="#l85.2712"></a><span id="l85.2712" class="difflineminus">-        catch (e)</span>
<a href="#l85.2713"></a><span id="l85.2713" class="difflineminus">-        {</span>
<a href="#l85.2714"></a><span id="l85.2714" class="difflineplus">+        } catch (e) {</span>
<a href="#l85.2715"></a><span id="l85.2715">           dumpn(&quot;*** syntax error in SJS at &quot; + file.path + &quot;: &quot; + e);</span>
<a href="#l85.2716"></a><span id="l85.2716">           throw HTTP_500;</span>
<a href="#l85.2717"></a><span id="l85.2717">         }</span>
<a href="#l85.2718"></a><span id="l85.2718"> </span>
<a href="#l85.2719"></a><span id="l85.2719" class="difflineminus">-        try</span>
<a href="#l85.2720"></a><span id="l85.2720" class="difflineminus">-        {</span>
<a href="#l85.2721"></a><span id="l85.2721" class="difflineplus">+        try {</span>
<a href="#l85.2722"></a><span id="l85.2722">           s.handleRequest(metadata, response);</span>
<a href="#l85.2723"></a><span id="l85.2723" class="difflineminus">-        }</span>
<a href="#l85.2724"></a><span id="l85.2724" class="difflineminus">-        catch (e)</span>
<a href="#l85.2725"></a><span id="l85.2725" class="difflineminus">-        {</span>
<a href="#l85.2726"></a><span id="l85.2726" class="difflineplus">+        } catch (e) {</span>
<a href="#l85.2727"></a><span id="l85.2727">           dump(&quot;*** error running SJS at &quot; + file.path + &quot;: &quot; +</span>
<a href="#l85.2728"></a><span id="l85.2728">                e + &quot; on line &quot; +</span>
<a href="#l85.2729"></a><span id="l85.2729">                (e instanceof Error</span>
<a href="#l85.2730"></a><span id="l85.2730">                ? e.lineNumber + &quot; in httpd.js&quot;</span>
<a href="#l85.2731"></a><span id="l85.2731">                : (e.lineNumber - line)) + &quot;\n&quot;);</span>
<a href="#l85.2732"></a><span id="l85.2732">           throw HTTP_500;</span>
<a href="#l85.2733"></a><span id="l85.2733">         }</span>
<a href="#l85.2734"></a><span id="l85.2734" class="difflineminus">-      }</span>
<a href="#l85.2735"></a><span id="l85.2735" class="difflineminus">-      finally</span>
<a href="#l85.2736"></a><span id="l85.2736" class="difflineminus">-      {</span>
<a href="#l85.2737"></a><span id="l85.2737" class="difflineplus">+      } finally {</span>
<a href="#l85.2738"></a><span id="l85.2738">         fis.close();</span>
<a href="#l85.2739"></a><span id="l85.2739">       }</span>
<a href="#l85.2740"></a><span id="l85.2740" class="difflineminus">-    }</span>
<a href="#l85.2741"></a><span id="l85.2741" class="difflineminus">-    else</span>
<a href="#l85.2742"></a><span id="l85.2742" class="difflineminus">-    {</span>
<a href="#l85.2743"></a><span id="l85.2743" class="difflineminus">-      try</span>
<a href="#l85.2744"></a><span id="l85.2744" class="difflineminus">-      {</span>
<a href="#l85.2745"></a><span id="l85.2745" class="difflineplus">+    } else {</span>
<a href="#l85.2746"></a><span id="l85.2746" class="difflineplus">+      try {</span>
<a href="#l85.2747"></a><span id="l85.2747">         response.setHeader(&quot;Last-Modified&quot;,</span>
<a href="#l85.2748"></a><span id="l85.2748">                            toDateString(file.lastModifiedTime),</span>
<a href="#l85.2749"></a><span id="l85.2749">                            false);</span>
<a href="#l85.2750"></a><span id="l85.2750" class="difflineminus">-      }</span>
<a href="#l85.2751"></a><span id="l85.2751" class="difflineminus">-      catch (e) { /* lastModifiedTime threw, ignore */ }</span>
<a href="#l85.2752"></a><span id="l85.2752" class="difflineplus">+      } catch (e) { /* lastModifiedTime threw, ignore */ }</span>
<a href="#l85.2753"></a><span id="l85.2753"> </span>
<a href="#l85.2754"></a><span id="l85.2754">       response.setHeader(&quot;Content-Type&quot;, type, false);</span>
<a href="#l85.2755"></a><span id="l85.2755">       maybeAddHeaders(file, metadata, response);</span>
<a href="#l85.2756"></a><span id="l85.2756">       response.setHeader(&quot;Content-Length&quot;, &quot;&quot; + count, false);</span>
<a href="#l85.2757"></a><span id="l85.2757"> </span>
<a href="#l85.2758"></a><span id="l85.2758" class="difflineminus">-      var fis = new FileInputStream(file, PR_RDONLY, 0o444,</span>
<a href="#l85.2759"></a><span id="l85.2759" class="difflineplus">+      let fis = new FileInputStream(file, PR_RDONLY, 0o444,</span>
<a href="#l85.2760"></a><span id="l85.2760">                                     Ci.nsIFileInputStream.CLOSE_ON_EOF);</span>
<a href="#l85.2761"></a><span id="l85.2761"> </span>
<a href="#l85.2762"></a><span id="l85.2762">       offset = offset || 0;</span>
<a href="#l85.2763"></a><span id="l85.2763">       count  = count || file.fileSize;</span>
<a href="#l85.2764"></a><span id="l85.2764">       NS_ASSERT(offset === 0 || offset &lt; file.fileSize, &quot;bad offset&quot;);</span>
<a href="#l85.2765"></a><span id="l85.2765">       NS_ASSERT(count &gt;= 0, &quot;bad count&quot;);</span>
<a href="#l85.2766"></a><span id="l85.2766">       NS_ASSERT(offset + count &lt;= file.fileSize, &quot;bad total data size&quot;);</span>
<a href="#l85.2767"></a><span id="l85.2767"> </span>
<a href="#l85.2768"></a><span id="l85.2768" class="difflineminus">-      try</span>
<a href="#l85.2769"></a><span id="l85.2769" class="difflineminus">-      {</span>
<a href="#l85.2770"></a><span id="l85.2770" class="difflineminus">-        if (offset !== 0)</span>
<a href="#l85.2771"></a><span id="l85.2771" class="difflineminus">-        {</span>
<a href="#l85.2772"></a><span id="l85.2772" class="difflineplus">+      try {</span>
<a href="#l85.2773"></a><span id="l85.2773" class="difflineplus">+        if (offset !== 0) {</span>
<a href="#l85.2774"></a><span id="l85.2774">           // Seek (or read, if seeking isn't supported) to the correct offset so</span>
<a href="#l85.2775"></a><span id="l85.2775">           // the data sent to the client matches the requested range.</span>
<a href="#l85.2776"></a><span id="l85.2776">           if (fis instanceof Ci.nsISeekableStream)</span>
<a href="#l85.2777"></a><span id="l85.2777">             fis.seek(Ci.nsISeekableStream.NS_SEEK_SET, offset);</span>
<a href="#l85.2778"></a><span id="l85.2778">           else</span>
<a href="#l85.2779"></a><span id="l85.2779">             new ScriptableInputStream(fis).read(offset);</span>
<a href="#l85.2780"></a><span id="l85.2780">         }</span>
<a href="#l85.2781"></a><span id="l85.2781" class="difflineminus">-      }</span>
<a href="#l85.2782"></a><span id="l85.2782" class="difflineminus">-      catch (e)</span>
<a href="#l85.2783"></a><span id="l85.2783" class="difflineminus">-      {</span>
<a href="#l85.2784"></a><span id="l85.2784" class="difflineplus">+      } catch (e) {</span>
<a href="#l85.2785"></a><span id="l85.2785">         fis.close();</span>
<a href="#l85.2786"></a><span id="l85.2786">         throw e;</span>
<a href="#l85.2787"></a><span id="l85.2787">       }</span>
<a href="#l85.2788"></a><span id="l85.2788"> </span>
<a href="#l85.2789"></a><span id="l85.2789" class="difflineminus">-      function writeMore()</span>
<a href="#l85.2790"></a><span id="l85.2790" class="difflineminus">-      {</span>
<a href="#l85.2791"></a><span id="l85.2791" class="difflineminus">-        gThreadManager.currentThread</span>
<a href="#l85.2792"></a><span id="l85.2792" class="difflineminus">-                      .dispatch(writeData, Ci.nsIThread.DISPATCH_NORMAL);</span>
<a href="#l85.2793"></a><span id="l85.2793" class="difflineplus">+      function writeMore() {</span>
<a href="#l85.2794"></a><span id="l85.2794" class="difflineplus">+        Services.tm.currentThread.dispatch(writeData, Ci.nsIThread.DISPATCH_NORMAL);</span>
<a href="#l85.2795"></a><span id="l85.2795">       }</span>
<a href="#l85.2796"></a><span id="l85.2796"> </span>
<a href="#l85.2797"></a><span id="l85.2797">       var input = new BinaryInputStream(fis);</span>
<a href="#l85.2798"></a><span id="l85.2798">       var output = new BinaryOutputStream(response.bodyOutputStream);</span>
<a href="#l85.2799"></a><span id="l85.2799" class="difflineminus">-      var writeData =</span>
<a href="#l85.2800"></a><span id="l85.2800" class="difflineminus">-        {</span>
<a href="#l85.2801"></a><span id="l85.2801" class="difflineminus">-          run: function()</span>
<a href="#l85.2802"></a><span id="l85.2802" class="difflineminus">-          {</span>
<a href="#l85.2803"></a><span id="l85.2803" class="difflineplus">+      var writeData = {</span>
<a href="#l85.2804"></a><span id="l85.2804" class="difflineplus">+          run() {</span>
<a href="#l85.2805"></a><span id="l85.2805">             var chunkSize = Math.min(65536, count);</span>
<a href="#l85.2806"></a><span id="l85.2806">             count -= chunkSize;</span>
<a href="#l85.2807"></a><span id="l85.2807">             NS_ASSERT(count &gt;= 0, &quot;underflow&quot;);</span>
<a href="#l85.2808"></a><span id="l85.2808"> </span>
<a href="#l85.2809"></a><span id="l85.2809" class="difflineminus">-            try</span>
<a href="#l85.2810"></a><span id="l85.2810" class="difflineminus">-            {</span>
<a href="#l85.2811"></a><span id="l85.2811" class="difflineplus">+            try {</span>
<a href="#l85.2812"></a><span id="l85.2812">               var data = input.readByteArray(chunkSize);</span>
<a href="#l85.2813"></a><span id="l85.2813">               NS_ASSERT(data.length === chunkSize,</span>
<a href="#l85.2814"></a><span id="l85.2814">                         &quot;incorrect data returned?  got &quot; + data.length +</span>
<a href="#l85.2815"></a><span id="l85.2815">                         &quot;, expected &quot; + chunkSize);</span>
<a href="#l85.2816"></a><span id="l85.2816">               output.writeByteArray(data, data.length);</span>
<a href="#l85.2817"></a><span id="l85.2817" class="difflineminus">-              if (count === 0)</span>
<a href="#l85.2818"></a><span id="l85.2818" class="difflineminus">-              {</span>
<a href="#l85.2819"></a><span id="l85.2819" class="difflineplus">+              if (count === 0) {</span>
<a href="#l85.2820"></a><span id="l85.2820">                 fis.close();</span>
<a href="#l85.2821"></a><span id="l85.2821">                 response.finish();</span>
<a href="#l85.2822"></a><span id="l85.2822" class="difflineminus">-              }</span>
<a href="#l85.2823"></a><span id="l85.2823" class="difflineminus">-              else</span>
<a href="#l85.2824"></a><span id="l85.2824" class="difflineminus">-              {</span>
<a href="#l85.2825"></a><span id="l85.2825" class="difflineplus">+              } else {</span>
<a href="#l85.2826"></a><span id="l85.2826">                 writeMore();</span>
<a href="#l85.2827"></a><span id="l85.2827">               }</span>
<a href="#l85.2828"></a><span id="l85.2828" class="difflineminus">-            }</span>
<a href="#l85.2829"></a><span id="l85.2829" class="difflineminus">-            catch (e)</span>
<a href="#l85.2830"></a><span id="l85.2830" class="difflineminus">-            {</span>
<a href="#l85.2831"></a><span id="l85.2831" class="difflineminus">-              try</span>
<a href="#l85.2832"></a><span id="l85.2832" class="difflineminus">-              {</span>
<a href="#l85.2833"></a><span id="l85.2833" class="difflineplus">+            } catch (e) {</span>
<a href="#l85.2834"></a><span id="l85.2834" class="difflineplus">+              try {</span>
<a href="#l85.2835"></a><span id="l85.2835">                 fis.close();</span>
<a href="#l85.2836"></a><span id="l85.2836" class="difflineminus">-              }</span>
<a href="#l85.2837"></a><span id="l85.2837" class="difflineminus">-              finally</span>
<a href="#l85.2838"></a><span id="l85.2838" class="difflineminus">-              {</span>
<a href="#l85.2839"></a><span id="l85.2839" class="difflineplus">+              } finally {</span>
<a href="#l85.2840"></a><span id="l85.2840">                 response.finish();</span>
<a href="#l85.2841"></a><span id="l85.2841">               }</span>
<a href="#l85.2842"></a><span id="l85.2842">               throw e;</span>
<a href="#l85.2843"></a><span id="l85.2843">             }</span>
<a href="#l85.2844"></a><span id="l85.2844" class="difflineminus">-          }</span>
<a href="#l85.2845"></a><span id="l85.2845" class="difflineplus">+          },</span>
<a href="#l85.2846"></a><span id="l85.2846">         };</span>
<a href="#l85.2847"></a><span id="l85.2847"> </span>
<a href="#l85.2848"></a><span id="l85.2848">       writeMore();</span>
<a href="#l85.2849"></a><span id="l85.2849"> </span>
<a href="#l85.2850"></a><span id="l85.2850">       // Now that we know copying will start, flag the response as async.</span>
<a href="#l85.2851"></a><span id="l85.2851">       response.processAsync();</span>
<a href="#l85.2852"></a><span id="l85.2852">     }</span>
<a href="#l85.2853"></a><span id="l85.2853">   },</span>
<a href="#l85.2854"></a><span id="l85.2854" class="difflineat">@@ -2830,18 +2505,17 @@ ServerHandler.prototype =</span>
<a href="#l85.2855"></a><span id="l85.2855">    *</span>
<a href="#l85.2856"></a><span id="l85.2856">    * @param path : string</span>
<a href="#l85.2857"></a><span id="l85.2857">    *   the path from which the given state is to be retrieved</span>
<a href="#l85.2858"></a><span id="l85.2858">    * @param k : string</span>
<a href="#l85.2859"></a><span id="l85.2859">    *   the key whose corresponding value is to be returned</span>
<a href="#l85.2860"></a><span id="l85.2860">    * @returns string</span>
<a href="#l85.2861"></a><span id="l85.2861">    *   the corresponding value, which is initially the empty string</span>
<a href="#l85.2862"></a><span id="l85.2862">    */</span>
<a href="#l85.2863"></a><span id="l85.2863" class="difflineminus">-  _getState: function(path, k)</span>
<a href="#l85.2864"></a><span id="l85.2864" class="difflineminus">-  {</span>
<a href="#l85.2865"></a><span id="l85.2865" class="difflineplus">+  _getState(path, k) {</span>
<a href="#l85.2866"></a><span id="l85.2866">     var state = this._state;</span>
<a href="#l85.2867"></a><span id="l85.2867">     if (path in state &amp;&amp; k in state[path])</span>
<a href="#l85.2868"></a><span id="l85.2868">       return state[path][k];</span>
<a href="#l85.2869"></a><span id="l85.2869">     return &quot;&quot;;</span>
<a href="#l85.2870"></a><span id="l85.2870">   },</span>
<a href="#l85.2871"></a><span id="l85.2871"> </span>
<a href="#l85.2872"></a><span id="l85.2872">   /**</span>
<a href="#l85.2873"></a><span id="l85.2873">    * Set the value corresponding to a given key for the given path for SJS state</span>
<a href="#l85.2874"></a><span id="l85.2874" class="difflineat">@@ -2849,18 +2523,17 @@ ServerHandler.prototype =</span>
<a href="#l85.2875"></a><span id="l85.2875">    *</span>
<a href="#l85.2876"></a><span id="l85.2876">    * @param path : string</span>
<a href="#l85.2877"></a><span id="l85.2877">    *   the path from which the given state is to be retrieved</span>
<a href="#l85.2878"></a><span id="l85.2878">    * @param k : string</span>
<a href="#l85.2879"></a><span id="l85.2879">    *   the key whose corresponding value is to be set</span>
<a href="#l85.2880"></a><span id="l85.2880">    * @param v : string</span>
<a href="#l85.2881"></a><span id="l85.2881">    *   the value to be set</span>
<a href="#l85.2882"></a><span id="l85.2882">    */</span>
<a href="#l85.2883"></a><span id="l85.2883" class="difflineminus">-  _setState: function(path, k, v)</span>
<a href="#l85.2884"></a><span id="l85.2884" class="difflineminus">-  {</span>
<a href="#l85.2885"></a><span id="l85.2885" class="difflineplus">+  _setState(path, k, v) {</span>
<a href="#l85.2886"></a><span id="l85.2886">     if (typeof v !== &quot;string&quot;)</span>
<a href="#l85.2887"></a><span id="l85.2887">       throw new Error(&quot;non-string value passed&quot;);</span>
<a href="#l85.2888"></a><span id="l85.2888">     var state = this._state;</span>
<a href="#l85.2889"></a><span id="l85.2889">     if (!(path in state))</span>
<a href="#l85.2890"></a><span id="l85.2890">       state[path] = {};</span>
<a href="#l85.2891"></a><span id="l85.2891">     state[path][k] = v;</span>
<a href="#l85.2892"></a><span id="l85.2892">   },</span>
<a href="#l85.2893"></a><span id="l85.2893"> </span>
<a href="#l85.2894"></a><span id="l85.2894" class="difflineat">@@ -2868,73 +2541,68 @@ ServerHandler.prototype =</span>
<a href="#l85.2895"></a><span id="l85.2895">    * Get the value corresponding to a given key for SJS state preservation</span>
<a href="#l85.2896"></a><span id="l85.2896">    * across requests.</span>
<a href="#l85.2897"></a><span id="l85.2897">    *</span>
<a href="#l85.2898"></a><span id="l85.2898">    * @param k : string</span>
<a href="#l85.2899"></a><span id="l85.2899">    *   the key whose corresponding value is to be returned</span>
<a href="#l85.2900"></a><span id="l85.2900">    * @returns string</span>
<a href="#l85.2901"></a><span id="l85.2901">    *   the corresponding value, which is initially the empty string</span>
<a href="#l85.2902"></a><span id="l85.2902">    */</span>
<a href="#l85.2903"></a><span id="l85.2903" class="difflineminus">-  _getSharedState: function(k)</span>
<a href="#l85.2904"></a><span id="l85.2904" class="difflineminus">-  {</span>
<a href="#l85.2905"></a><span id="l85.2905" class="difflineplus">+  _getSharedState(k) {</span>
<a href="#l85.2906"></a><span id="l85.2906">     var state = this._sharedState;</span>
<a href="#l85.2907"></a><span id="l85.2907">     if (k in state)</span>
<a href="#l85.2908"></a><span id="l85.2908">       return state[k];</span>
<a href="#l85.2909"></a><span id="l85.2909">     return &quot;&quot;;</span>
<a href="#l85.2910"></a><span id="l85.2910">   },</span>
<a href="#l85.2911"></a><span id="l85.2911"> </span>
<a href="#l85.2912"></a><span id="l85.2912">   /**</span>
<a href="#l85.2913"></a><span id="l85.2913">    * Set the value corresponding to a given key for SJS state preservation</span>
<a href="#l85.2914"></a><span id="l85.2914">    * across requests.</span>
<a href="#l85.2915"></a><span id="l85.2915">    *</span>
<a href="#l85.2916"></a><span id="l85.2916">    * @param k : string</span>
<a href="#l85.2917"></a><span id="l85.2917">    *   the key whose corresponding value is to be set</span>
<a href="#l85.2918"></a><span id="l85.2918">    * @param v : string</span>
<a href="#l85.2919"></a><span id="l85.2919">    *   the value to be set</span>
<a href="#l85.2920"></a><span id="l85.2920">    */</span>
<a href="#l85.2921"></a><span id="l85.2921" class="difflineminus">-  _setSharedState: function(k, v)</span>
<a href="#l85.2922"></a><span id="l85.2922" class="difflineminus">-  {</span>
<a href="#l85.2923"></a><span id="l85.2923" class="difflineplus">+  _setSharedState(k, v) {</span>
<a href="#l85.2924"></a><span id="l85.2924">     if (typeof v !== &quot;string&quot;)</span>
<a href="#l85.2925"></a><span id="l85.2925">       throw new Error(&quot;non-string value passed&quot;);</span>
<a href="#l85.2926"></a><span id="l85.2926">     this._sharedState[k] = v;</span>
<a href="#l85.2927"></a><span id="l85.2927">   },</span>
<a href="#l85.2928"></a><span id="l85.2928"> </span>
<a href="#l85.2929"></a><span id="l85.2929">   /**</span>
<a href="#l85.2930"></a><span id="l85.2930">    * Returns the object associated with the given key in the server for SJS</span>
<a href="#l85.2931"></a><span id="l85.2931">    * state preservation across requests.</span>
<a href="#l85.2932"></a><span id="l85.2932">    *</span>
<a href="#l85.2933"></a><span id="l85.2933">    * @param k : string</span>
<a href="#l85.2934"></a><span id="l85.2934">    *  the key whose corresponding object is to be returned</span>
<a href="#l85.2935"></a><span id="l85.2935">    * @returns nsISupports</span>
<a href="#l85.2936"></a><span id="l85.2936">    *  the corresponding object, or null if none was present</span>
<a href="#l85.2937"></a><span id="l85.2937">    */</span>
<a href="#l85.2938"></a><span id="l85.2938" class="difflineminus">-  _getObjectState: function(k)</span>
<a href="#l85.2939"></a><span id="l85.2939" class="difflineminus">-  {</span>
<a href="#l85.2940"></a><span id="l85.2940" class="difflineplus">+  _getObjectState(k) {</span>
<a href="#l85.2941"></a><span id="l85.2941">     if (typeof k !== &quot;string&quot;)</span>
<a href="#l85.2942"></a><span id="l85.2942">       throw new Error(&quot;non-string key passed&quot;);</span>
<a href="#l85.2943"></a><span id="l85.2943">     return this._objectState[k] || null;</span>
<a href="#l85.2944"></a><span id="l85.2944">   },</span>
<a href="#l85.2945"></a><span id="l85.2945"> </span>
<a href="#l85.2946"></a><span id="l85.2946">   /**</span>
<a href="#l85.2947"></a><span id="l85.2947">    * Sets the object associated with the given key in the server for SJS</span>
<a href="#l85.2948"></a><span id="l85.2948">    * state preservation across requests.</span>
<a href="#l85.2949"></a><span id="l85.2949">    *</span>
<a href="#l85.2950"></a><span id="l85.2950">    * @param k : string</span>
<a href="#l85.2951"></a><span id="l85.2951">    *  the key whose corresponding object is to be set</span>
<a href="#l85.2952"></a><span id="l85.2952">    * @param v : nsISupports</span>
<a href="#l85.2953"></a><span id="l85.2953">    *  the object to be associated with the given key; may be null</span>
<a href="#l85.2954"></a><span id="l85.2954">    */</span>
<a href="#l85.2955"></a><span id="l85.2955" class="difflineminus">-  _setObjectState: function(k, v)</span>
<a href="#l85.2956"></a><span id="l85.2956" class="difflineminus">-  {</span>
<a href="#l85.2957"></a><span id="l85.2957" class="difflineplus">+  _setObjectState(k, v) {</span>
<a href="#l85.2958"></a><span id="l85.2958">     if (typeof k !== &quot;string&quot;)</span>
<a href="#l85.2959"></a><span id="l85.2959">       throw new Error(&quot;non-string key passed&quot;);</span>
<a href="#l85.2960"></a><span id="l85.2960">     if (typeof v !== &quot;object&quot;)</span>
<a href="#l85.2961"></a><span id="l85.2961">       throw new Error(&quot;non-object value passed&quot;);</span>
<a href="#l85.2962"></a><span id="l85.2962" class="difflineminus">-    if (v &amp;&amp; !(&quot;QueryInterface&quot; in v))</span>
<a href="#l85.2963"></a><span id="l85.2963" class="difflineminus">-    {</span>
<a href="#l85.2964"></a><span id="l85.2964" class="difflineplus">+    if (v &amp;&amp; !(&quot;QueryInterface&quot; in v)) {</span>
<a href="#l85.2965"></a><span id="l85.2965">       throw new Error(&quot;must pass an nsISupports; use wrappedJSObject to ease &quot; +</span>
<a href="#l85.2966"></a><span id="l85.2966">                       &quot;pain when using the server from JS&quot;);</span>
<a href="#l85.2967"></a><span id="l85.2967">     }</span>
<a href="#l85.2968"></a><span id="l85.2968"> </span>
<a href="#l85.2969"></a><span id="l85.2969">     this._objectState[k] = v;</span>
<a href="#l85.2970"></a><span id="l85.2970">   },</span>
<a href="#l85.2971"></a><span id="l85.2971"> </span>
<a href="#l85.2972"></a><span id="l85.2972">   /**</span>
<a href="#l85.2973"></a><span id="l85.2973" class="difflineat">@@ -2943,34 +2611,29 @@ ServerHandler.prototype =</span>
<a href="#l85.2974"></a><span id="l85.2974">    * asking the global MIME service for a content-type, and finally by failing</span>
<a href="#l85.2975"></a><span id="l85.2975">    * over to application/octet-stream.</span>
<a href="#l85.2976"></a><span id="l85.2976">    *</span>
<a href="#l85.2977"></a><span id="l85.2977">    * @param file : nsIFile</span>
<a href="#l85.2978"></a><span id="l85.2978">    *   the nsIFile for which to get a file type</span>
<a href="#l85.2979"></a><span id="l85.2979">    * @returns string</span>
<a href="#l85.2980"></a><span id="l85.2980">    *   the best content-type which can be determined for the file</span>
<a href="#l85.2981"></a><span id="l85.2981">    */</span>
<a href="#l85.2982"></a><span id="l85.2982" class="difflineminus">-  _getTypeFromFile: function(file)</span>
<a href="#l85.2983"></a><span id="l85.2983" class="difflineminus">-  {</span>
<a href="#l85.2984"></a><span id="l85.2984" class="difflineminus">-    try</span>
<a href="#l85.2985"></a><span id="l85.2985" class="difflineminus">-    {</span>
<a href="#l85.2986"></a><span id="l85.2986" class="difflineplus">+  _getTypeFromFile(file) {</span>
<a href="#l85.2987"></a><span id="l85.2987" class="difflineplus">+    try {</span>
<a href="#l85.2988"></a><span id="l85.2988">       var name = file.leafName;</span>
<a href="#l85.2989"></a><span id="l85.2989">       var dot = name.lastIndexOf(&quot;.&quot;);</span>
<a href="#l85.2990"></a><span id="l85.2990" class="difflineminus">-      if (dot &gt; 0)</span>
<a href="#l85.2991"></a><span id="l85.2991" class="difflineminus">-      {</span>
<a href="#l85.2992"></a><span id="l85.2992" class="difflineplus">+      if (dot &gt; 0) {</span>
<a href="#l85.2993"></a><span id="l85.2993">         var ext = name.slice(dot + 1);</span>
<a href="#l85.2994"></a><span id="l85.2994">         if (ext in this._mimeMappings)</span>
<a href="#l85.2995"></a><span id="l85.2995">           return this._mimeMappings[ext];</span>
<a href="#l85.2996"></a><span id="l85.2996">       }</span>
<a href="#l85.2997"></a><span id="l85.2997">       return Cc[&quot;@mozilla.org/uriloader/external-helper-app-service;1&quot;]</span>
<a href="#l85.2998"></a><span id="l85.2998">                .getService(Ci.nsIMIMEService)</span>
<a href="#l85.2999"></a><span id="l85.2999">                .getTypeFromFile(file);</span>
<a href="#l85.3000"></a><span id="l85.3000" class="difflineminus">-    }</span>
<a href="#l85.3001"></a><span id="l85.3001" class="difflineminus">-    catch (e)</span>
<a href="#l85.3002"></a><span id="l85.3002" class="difflineminus">-    {</span>
<a href="#l85.3003"></a><span id="l85.3003" class="difflineplus">+    } catch (e) {</span>
<a href="#l85.3004"></a><span id="l85.3004">       return &quot;application/octet-stream&quot;;</span>
<a href="#l85.3005"></a><span id="l85.3005">     }</span>
<a href="#l85.3006"></a><span id="l85.3006">   },</span>
<a href="#l85.3007"></a><span id="l85.3007"> </span>
<a href="#l85.3008"></a><span id="l85.3008">   /**</span>
<a href="#l85.3009"></a><span id="l85.3009">    * Returns the nsIFile which corresponds to the path, as determined using</span>
<a href="#l85.3010"></a><span id="l85.3010">    * all registered path-&gt;directory mappings and any paths which are explicitly</span>
<a href="#l85.3011"></a><span id="l85.3011">    * overridden.</span>
<a href="#l85.3012"></a><span id="l85.3012" class="difflineat">@@ -2979,41 +2642,35 @@ ServerHandler.prototype =</span>
<a href="#l85.3013"></a><span id="l85.3013">    *   the server path for which a file should be retrieved, e.g. &quot;/foo/bar&quot;</span>
<a href="#l85.3014"></a><span id="l85.3014">    * @throws HttpError</span>
<a href="#l85.3015"></a><span id="l85.3015">    *   when the correct action is the corresponding HTTP error (i.e., because no</span>
<a href="#l85.3016"></a><span id="l85.3016">    *   mapping was found for a directory in path, the referenced file doesn't</span>
<a href="#l85.3017"></a><span id="l85.3017">    *   exist, etc.)</span>
<a href="#l85.3018"></a><span id="l85.3018">    * @returns nsIFile</span>
<a href="#l85.3019"></a><span id="l85.3019">    *   the file to be sent as the response to a request for the path</span>
<a href="#l85.3020"></a><span id="l85.3020">    */</span>
<a href="#l85.3021"></a><span id="l85.3021" class="difflineminus">-  _getFileForPath: function(path)</span>
<a href="#l85.3022"></a><span id="l85.3022" class="difflineminus">-  {</span>
<a href="#l85.3023"></a><span id="l85.3023" class="difflineplus">+  _getFileForPath(path) {</span>
<a href="#l85.3024"></a><span id="l85.3024">     // decode and add underscores as necessary</span>
<a href="#l85.3025"></a><span id="l85.3025" class="difflineminus">-    try</span>
<a href="#l85.3026"></a><span id="l85.3026" class="difflineminus">-    {</span>
<a href="#l85.3027"></a><span id="l85.3027" class="difflineplus">+    try {</span>
<a href="#l85.3028"></a><span id="l85.3028">       path = toInternalPath(path, true);</span>
<a href="#l85.3029"></a><span id="l85.3029" class="difflineminus">-    }</span>
<a href="#l85.3030"></a><span id="l85.3030" class="difflineminus">-    catch (e)</span>
<a href="#l85.3031"></a><span id="l85.3031" class="difflineminus">-    {</span>
<a href="#l85.3032"></a><span id="l85.3032" class="difflineplus">+    } catch (e) {</span>
<a href="#l85.3033"></a><span id="l85.3033">       dumpn(&quot;*** toInternalPath threw &quot; + e);</span>
<a href="#l85.3034"></a><span id="l85.3034">       throw HTTP_400; // malformed path</span>
<a href="#l85.3035"></a><span id="l85.3035">     }</span>
<a href="#l85.3036"></a><span id="l85.3036"> </span>
<a href="#l85.3037"></a><span id="l85.3037">     // next, get the directory which contains this path</span>
<a href="#l85.3038"></a><span id="l85.3038">     var pathMap = this._pathDirectoryMap;</span>
<a href="#l85.3039"></a><span id="l85.3039"> </span>
<a href="#l85.3040"></a><span id="l85.3040">     // An example progression of tmp for a path &quot;/foo/bar/baz/&quot; might be:</span>
<a href="#l85.3041"></a><span id="l85.3041">     // &quot;foo/bar/baz/&quot;, &quot;foo/bar/baz&quot;, &quot;foo/bar&quot;, &quot;foo&quot;, &quot;&quot;</span>
<a href="#l85.3042"></a><span id="l85.3042">     var tmp = path.substring(1);</span>
<a href="#l85.3043"></a><span id="l85.3043" class="difflineminus">-    while (true)</span>
<a href="#l85.3044"></a><span id="l85.3044" class="difflineminus">-    {</span>
<a href="#l85.3045"></a><span id="l85.3045" class="difflineplus">+    while (true) {</span>
<a href="#l85.3046"></a><span id="l85.3046">       // do we have a match for current head of the path?</span>
<a href="#l85.3047"></a><span id="l85.3047">       var file = pathMap.get(tmp);</span>
<a href="#l85.3048"></a><span id="l85.3048" class="difflineminus">-      if (file)</span>
<a href="#l85.3049"></a><span id="l85.3049" class="difflineminus">-      {</span>
<a href="#l85.3050"></a><span id="l85.3050" class="difflineplus">+      if (file) {</span>
<a href="#l85.3051"></a><span id="l85.3051">         // XXX hack; basically disable showing mapping for /foo/bar/ when the</span>
<a href="#l85.3052"></a><span id="l85.3052">         //     requested path was /foo/bar, because relative links on the page</span>
<a href="#l85.3053"></a><span id="l85.3053">         //     will all be incorrect -- we really need the ability to easily</span>
<a href="#l85.3054"></a><span id="l85.3054">         //     redirect here instead</span>
<a href="#l85.3055"></a><span id="l85.3055">         if (tmp == path.substring(1) &amp;&amp;</span>
<a href="#l85.3056"></a><span id="l85.3056">             tmp.length != 0 &amp;&amp;</span>
<a href="#l85.3057"></a><span id="l85.3057">             tmp.charAt(tmp.length - 1) != &quot;/&quot;)</span>
<a href="#l85.3058"></a><span id="l85.3058">           file = null;</span>
<a href="#l85.3059"></a><span id="l85.3059" class="difflineat">@@ -3039,18 +2696,17 @@ ServerHandler.prototype =</span>
<a href="#l85.3060"></a><span id="l85.3060"> </span>
<a href="#l85.3061"></a><span id="l85.3061">     // Strategy here is to append components individually, making sure we</span>
<a href="#l85.3062"></a><span id="l85.3062">     // never move above the given directory; this allows paths such as</span>
<a href="#l85.3063"></a><span id="l85.3063">     // &quot;&lt;file&gt;/foo/../bar&quot; but prevents paths such as &quot;&lt;file&gt;/../base-sibling&quot;;</span>
<a href="#l85.3064"></a><span id="l85.3064">     // this component-wise approach also means the code works even on platforms</span>
<a href="#l85.3065"></a><span id="l85.3065">     // which don't use &quot;/&quot; as the directory separator, such as Windows</span>
<a href="#l85.3066"></a><span id="l85.3066">     var leafPath = path.substring(tmp.length + 1);</span>
<a href="#l85.3067"></a><span id="l85.3067">     var comps = leafPath.split(&quot;/&quot;);</span>
<a href="#l85.3068"></a><span id="l85.3068" class="difflineminus">-    for (var i = 0, sz = comps.length; i &lt; sz; i++)</span>
<a href="#l85.3069"></a><span id="l85.3069" class="difflineminus">-    {</span>
<a href="#l85.3070"></a><span id="l85.3070" class="difflineplus">+    for (var i = 0, sz = comps.length; i &lt; sz; i++) {</span>
<a href="#l85.3071"></a><span id="l85.3071">       var comp = comps[i];</span>
<a href="#l85.3072"></a><span id="l85.3072"> </span>
<a href="#l85.3073"></a><span id="l85.3073">       if (comp == &quot;..&quot;)</span>
<a href="#l85.3074"></a><span id="l85.3074">         file = file.parent;</span>
<a href="#l85.3075"></a><span id="l85.3075">       else if (comp == &quot;.&quot; || comp == &quot;&quot;)</span>
<a href="#l85.3076"></a><span id="l85.3076">         continue;</span>
<a href="#l85.3077"></a><span id="l85.3077">       else</span>
<a href="#l85.3078"></a><span id="l85.3078">         file.append(comp);</span>
<a href="#l85.3079"></a><span id="l85.3079" class="difflineat">@@ -3066,18 +2722,17 @@ ServerHandler.prototype =</span>
<a href="#l85.3080"></a><span id="l85.3080">    * Writes the error page for the given HTTP error code over the given</span>
<a href="#l85.3081"></a><span id="l85.3081">    * connection.</span>
<a href="#l85.3082"></a><span id="l85.3082">    *</span>
<a href="#l85.3083"></a><span id="l85.3083">    * @param errorCode : uint</span>
<a href="#l85.3084"></a><span id="l85.3084">    *   the HTTP error code to be used</span>
<a href="#l85.3085"></a><span id="l85.3085">    * @param connection : Connection</span>
<a href="#l85.3086"></a><span id="l85.3086">    *   the connection on which the error occurred</span>
<a href="#l85.3087"></a><span id="l85.3087">    */</span>
<a href="#l85.3088"></a><span id="l85.3088" class="difflineminus">-  handleError: function(errorCode, connection)</span>
<a href="#l85.3089"></a><span id="l85.3089" class="difflineminus">-  {</span>
<a href="#l85.3090"></a><span id="l85.3090" class="difflineplus">+  handleError(errorCode, connection) {</span>
<a href="#l85.3091"></a><span id="l85.3091">     var response = new Response(connection);</span>
<a href="#l85.3092"></a><span id="l85.3092"> </span>
<a href="#l85.3093"></a><span id="l85.3093">     dumpn(&quot;*** error in request: &quot; + errorCode);</span>
<a href="#l85.3094"></a><span id="l85.3094"> </span>
<a href="#l85.3095"></a><span id="l85.3095">     this._handleError(errorCode, new Request(connection.port), response);</span>
<a href="#l85.3096"></a><span id="l85.3096">   },</span>
<a href="#l85.3097"></a><span id="l85.3097"> </span>
<a href="#l85.3098"></a><span id="l85.3098">   /**</span>
<a href="#l85.3099"></a><span id="l85.3099" class="difflineat">@@ -3092,45 +2747,39 @@ ServerHandler.prototype =</span>
<a href="#l85.3100"></a><span id="l85.3100">    *   metadata for the request, which will often be incomplete since this is an</span>
<a href="#l85.3101"></a><span id="l85.3101">    *   error</span>
<a href="#l85.3102"></a><span id="l85.3102">    * @param response : Response</span>
<a href="#l85.3103"></a><span id="l85.3103">    *   an uninitialized Response should be initialized when this method</span>
<a href="#l85.3104"></a><span id="l85.3104">    *   completes with information which represents the desired error code in the</span>
<a href="#l85.3105"></a><span id="l85.3105">    *   ideal case or a fallback code in abnormal circumstances (i.e., 500 is a</span>
<a href="#l85.3106"></a><span id="l85.3106">    *   fallback for 505, per HTTP specs)</span>
<a href="#l85.3107"></a><span id="l85.3107">    */</span>
<a href="#l85.3108"></a><span id="l85.3108" class="difflineminus">-  _handleError: function(errorCode, metadata, response)</span>
<a href="#l85.3109"></a><span id="l85.3109" class="difflineminus">-  {</span>
<a href="#l85.3110"></a><span id="l85.3110" class="difflineplus">+  _handleError(errorCode, metadata, response) {</span>
<a href="#l85.3111"></a><span id="l85.3111">     if (!metadata)</span>
<a href="#l85.3112"></a><span id="l85.3112">       throw Cr.NS_ERROR_NULL_POINTER;</span>
<a href="#l85.3113"></a><span id="l85.3113"> </span>
<a href="#l85.3114"></a><span id="l85.3114">     var errorX00 = errorCode - (errorCode % 100);</span>
<a href="#l85.3115"></a><span id="l85.3115"> </span>
<a href="#l85.3116"></a><span id="l85.3116" class="difflineminus">-    try</span>
<a href="#l85.3117"></a><span id="l85.3117" class="difflineminus">-    {</span>
<a href="#l85.3118"></a><span id="l85.3118" class="difflineplus">+    try {</span>
<a href="#l85.3119"></a><span id="l85.3119">       if (!(errorCode in HTTP_ERROR_CODES))</span>
<a href="#l85.3120"></a><span id="l85.3120">         dumpn(&quot;*** WARNING: requested invalid error: &quot; + errorCode);</span>
<a href="#l85.3121"></a><span id="l85.3121"> </span>
<a href="#l85.3122"></a><span id="l85.3122">       // RFC 2616 says that we should try to handle an error by its class if we</span>
<a href="#l85.3123"></a><span id="l85.3123">       // can't otherwise handle it -- if that fails, we revert to handling it as</span>
<a href="#l85.3124"></a><span id="l85.3124">       // a 500 internal server error, and if that fails we throw and shut down</span>
<a href="#l85.3125"></a><span id="l85.3125">       // the server</span>
<a href="#l85.3126"></a><span id="l85.3126"> </span>
<a href="#l85.3127"></a><span id="l85.3127">       // actually handle the error</span>
<a href="#l85.3128"></a><span id="l85.3128" class="difflineminus">-      try</span>
<a href="#l85.3129"></a><span id="l85.3129" class="difflineminus">-      {</span>
<a href="#l85.3130"></a><span id="l85.3130" class="difflineplus">+      try {</span>
<a href="#l85.3131"></a><span id="l85.3131">         if (errorCode in this._overrideErrors)</span>
<a href="#l85.3132"></a><span id="l85.3132">           this._overrideErrors[errorCode](metadata, response);</span>
<a href="#l85.3133"></a><span id="l85.3133">         else</span>
<a href="#l85.3134"></a><span id="l85.3134">           this._defaultErrors[errorCode](metadata, response);</span>
<a href="#l85.3135"></a><span id="l85.3135" class="difflineminus">-      }</span>
<a href="#l85.3136"></a><span id="l85.3136" class="difflineminus">-      catch (e)</span>
<a href="#l85.3137"></a><span id="l85.3137" class="difflineminus">-      {</span>
<a href="#l85.3138"></a><span id="l85.3138" class="difflineminus">-        if (response.partiallySent())</span>
<a href="#l85.3139"></a><span id="l85.3139" class="difflineminus">-        {</span>
<a href="#l85.3140"></a><span id="l85.3140" class="difflineplus">+      } catch (e) {</span>
<a href="#l85.3141"></a><span id="l85.3141" class="difflineplus">+        if (response.partiallySent()) {</span>
<a href="#l85.3142"></a><span id="l85.3142">           response.abort(e);</span>
<a href="#l85.3143"></a><span id="l85.3143">           return;</span>
<a href="#l85.3144"></a><span id="l85.3144">         }</span>
<a href="#l85.3145"></a><span id="l85.3145"> </span>
<a href="#l85.3146"></a><span id="l85.3146">         // don't retry the handler that threw</span>
<a href="#l85.3147"></a><span id="l85.3147">         if (errorX00 == errorCode)</span>
<a href="#l85.3148"></a><span id="l85.3148">           throw HTTP_500;</span>
<a href="#l85.3149"></a><span id="l85.3149"> </span>
<a href="#l85.3150"></a><span id="l85.3150" class="difflineat">@@ -3139,98 +2788,87 @@ ServerHandler.prototype =</span>
<a href="#l85.3151"></a><span id="l85.3151">         response = new Response(response._connection);</span>
<a href="#l85.3152"></a><span id="l85.3152">         if (errorX00 in this._overrideErrors)</span>
<a href="#l85.3153"></a><span id="l85.3153">           this._overrideErrors[errorX00](metadata, response);</span>
<a href="#l85.3154"></a><span id="l85.3154">         else if (errorX00 in this._defaultErrors)</span>
<a href="#l85.3155"></a><span id="l85.3155">           this._defaultErrors[errorX00](metadata, response);</span>
<a href="#l85.3156"></a><span id="l85.3156">         else</span>
<a href="#l85.3157"></a><span id="l85.3157">           throw HTTP_500;</span>
<a href="#l85.3158"></a><span id="l85.3158">       }</span>
<a href="#l85.3159"></a><span id="l85.3159" class="difflineminus">-    }</span>
<a href="#l85.3160"></a><span id="l85.3160" class="difflineminus">-    catch (e)</span>
<a href="#l85.3161"></a><span id="l85.3161" class="difflineminus">-    {</span>
<a href="#l85.3162"></a><span id="l85.3162" class="difflineminus">-      if (response.partiallySent())</span>
<a href="#l85.3163"></a><span id="l85.3163" class="difflineminus">-      {</span>
<a href="#l85.3164"></a><span id="l85.3164" class="difflineplus">+    } catch (e) {</span>
<a href="#l85.3165"></a><span id="l85.3165" class="difflineplus">+      if (response.partiallySent()) {</span>
<a href="#l85.3166"></a><span id="l85.3166">         response.abort();</span>
<a href="#l85.3167"></a><span id="l85.3167">         return;</span>
<a href="#l85.3168"></a><span id="l85.3168">       }</span>
<a href="#l85.3169"></a><span id="l85.3169"> </span>
<a href="#l85.3170"></a><span id="l85.3170">       // we've tried everything possible for a meaningful error -- now try 500</span>
<a href="#l85.3171"></a><span id="l85.3171">       dumpn(&quot;*** error in handling for error code &quot; + errorX00 + &quot;, falling &quot; +</span>
<a href="#l85.3172"></a><span id="l85.3172">             &quot;back to 500...&quot;);</span>
<a href="#l85.3173"></a><span id="l85.3173"> </span>
<a href="#l85.3174"></a><span id="l85.3174" class="difflineminus">-      try</span>
<a href="#l85.3175"></a><span id="l85.3175" class="difflineminus">-      {</span>
<a href="#l85.3176"></a><span id="l85.3176" class="difflineplus">+      try {</span>
<a href="#l85.3177"></a><span id="l85.3177">         response = new Response(response._connection);</span>
<a href="#l85.3178"></a><span id="l85.3178">         if (500 in this._overrideErrors)</span>
<a href="#l85.3179"></a><span id="l85.3179">           this._overrideErrors[500](metadata, response);</span>
<a href="#l85.3180"></a><span id="l85.3180">         else</span>
<a href="#l85.3181"></a><span id="l85.3181">           this._defaultErrors[500](metadata, response);</span>
<a href="#l85.3182"></a><span id="l85.3182" class="difflineminus">-      }</span>
<a href="#l85.3183"></a><span id="l85.3183" class="difflineminus">-      catch (e2)</span>
<a href="#l85.3184"></a><span id="l85.3184" class="difflineminus">-      {</span>
<a href="#l85.3185"></a><span id="l85.3185" class="difflineplus">+      } catch (e2) {</span>
<a href="#l85.3186"></a><span id="l85.3186">         dumpn(&quot;*** multiple errors in default error handlers!&quot;);</span>
<a href="#l85.3187"></a><span id="l85.3187">         dumpn(&quot;*** e == &quot; + e + &quot;, e2 == &quot; + e2);</span>
<a href="#l85.3188"></a><span id="l85.3188">         response.abort(e2);</span>
<a href="#l85.3189"></a><span id="l85.3189">         return;</span>
<a href="#l85.3190"></a><span id="l85.3190">       }</span>
<a href="#l85.3191"></a><span id="l85.3191">     }</span>
<a href="#l85.3192"></a><span id="l85.3192"> </span>
<a href="#l85.3193"></a><span id="l85.3193">     response.complete();</span>
<a href="#l85.3194"></a><span id="l85.3194">   },</span>
<a href="#l85.3195"></a><span id="l85.3195"> </span>
<a href="#l85.3196"></a><span id="l85.3196">   // FIELDS</span>
<a href="#l85.3197"></a><span id="l85.3197"> </span>
<a href="#l85.3198"></a><span id="l85.3198">   /**</span>
<a href="#l85.3199"></a><span id="l85.3199">    * This object contains the default handlers for the various HTTP error codes.</span>
<a href="#l85.3200"></a><span id="l85.3200">    */</span>
<a href="#l85.3201"></a><span id="l85.3201" class="difflineminus">-  _defaultErrors:</span>
<a href="#l85.3202"></a><span id="l85.3202" class="difflineminus">-  {</span>
<a href="#l85.3203"></a><span id="l85.3203" class="difflineminus">-    400: function(metadata, response)</span>
<a href="#l85.3204"></a><span id="l85.3204" class="difflineminus">-    {</span>
<a href="#l85.3205"></a><span id="l85.3205" class="difflineplus">+  _defaultErrors: {</span>
<a href="#l85.3206"></a><span id="l85.3206" class="difflineplus">+    400(metadata, response) {</span>
<a href="#l85.3207"></a><span id="l85.3207">       // none of the data in metadata is reliable, so hard-code everything here</span>
<a href="#l85.3208"></a><span id="l85.3208">       response.setStatusLine(&quot;1.1&quot;, 400, &quot;Bad Request&quot;);</span>
<a href="#l85.3209"></a><span id="l85.3209">       response.setHeader(&quot;Content-Type&quot;, &quot;text/plain&quot;, false);</span>
<a href="#l85.3210"></a><span id="l85.3210"> </span>
<a href="#l85.3211"></a><span id="l85.3211">       var body = &quot;Bad request\n&quot;;</span>
<a href="#l85.3212"></a><span id="l85.3212">       response.bodyOutputStream.write(body, body.length);</span>
<a href="#l85.3213"></a><span id="l85.3213">     },</span>
<a href="#l85.3214"></a><span id="l85.3214" class="difflineminus">-    403: function(metadata, response)</span>
<a href="#l85.3215"></a><span id="l85.3215" class="difflineminus">-    {</span>
<a href="#l85.3216"></a><span id="l85.3216" class="difflineplus">+    403(metadata, response) {</span>
<a href="#l85.3217"></a><span id="l85.3217">       response.setStatusLine(metadata.httpVersion, 403, &quot;Forbidden&quot;);</span>
<a href="#l85.3218"></a><span id="l85.3218">       response.setHeader(&quot;Content-Type&quot;, &quot;text/html&quot;, false);</span>
<a href="#l85.3219"></a><span id="l85.3219"> </span>
<a href="#l85.3220"></a><span id="l85.3220">       var body = &quot;&lt;html&gt;\</span>
<a href="#l85.3221"></a><span id="l85.3221">                     &lt;head&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;\</span>
<a href="#l85.3222"></a><span id="l85.3222">                     &lt;body&gt;\</span>
<a href="#l85.3223"></a><span id="l85.3223">                       &lt;h1&gt;403 Forbidden&lt;/h1&gt;\</span>
<a href="#l85.3224"></a><span id="l85.3224">                     &lt;/body&gt;\</span>
<a href="#l85.3225"></a><span id="l85.3225">                   &lt;/html&gt;&quot;;</span>
<a href="#l85.3226"></a><span id="l85.3226">       response.bodyOutputStream.write(body, body.length);</span>
<a href="#l85.3227"></a><span id="l85.3227">     },</span>
<a href="#l85.3228"></a><span id="l85.3228" class="difflineminus">-    404: function(metadata, response)</span>
<a href="#l85.3229"></a><span id="l85.3229" class="difflineminus">-    {</span>
<a href="#l85.3230"></a><span id="l85.3230" class="difflineplus">+    404(metadata, response) {</span>
<a href="#l85.3231"></a><span id="l85.3231">       response.setStatusLine(metadata.httpVersion, 404, &quot;Not Found&quot;);</span>
<a href="#l85.3232"></a><span id="l85.3232">       response.setHeader(&quot;Content-Type&quot;, &quot;text/html&quot;, false);</span>
<a href="#l85.3233"></a><span id="l85.3233"> </span>
<a href="#l85.3234"></a><span id="l85.3234">       var body = &quot;&lt;html&gt;\</span>
<a href="#l85.3235"></a><span id="l85.3235">                     &lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;\</span>
<a href="#l85.3236"></a><span id="l85.3236">                     &lt;body&gt;\</span>
<a href="#l85.3237"></a><span id="l85.3237">                       &lt;h1&gt;404 Not Found&lt;/h1&gt;\</span>
<a href="#l85.3238"></a><span id="l85.3238">                       &lt;p&gt;\</span>
<a href="#l85.3239"></a><span id="l85.3239">                         &lt;span style='font-family: monospace;'&gt;&quot; +</span>
<a href="#l85.3240"></a><span id="l85.3240">                           htmlEscape(metadata.path) +</span>
<a href="#l85.3241"></a><span id="l85.3241">                        &quot;&lt;/span&gt; was not found.\</span>
<a href="#l85.3242"></a><span id="l85.3242">                       &lt;/p&gt;\</span>
<a href="#l85.3243"></a><span id="l85.3243">                     &lt;/body&gt;\</span>
<a href="#l85.3244"></a><span id="l85.3244">                   &lt;/html&gt;&quot;;</span>
<a href="#l85.3245"></a><span id="l85.3245">       response.bodyOutputStream.write(body, body.length);</span>
<a href="#l85.3246"></a><span id="l85.3246">     },</span>
<a href="#l85.3247"></a><span id="l85.3247" class="difflineminus">-    416: function(metadata, response)</span>
<a href="#l85.3248"></a><span id="l85.3248" class="difflineminus">-    {</span>
<a href="#l85.3249"></a><span id="l85.3249" class="difflineplus">+    416(metadata, response) {</span>
<a href="#l85.3250"></a><span id="l85.3250">       response.setStatusLine(metadata.httpVersion,</span>
<a href="#l85.3251"></a><span id="l85.3251">                             416,</span>
<a href="#l85.3252"></a><span id="l85.3252">                             &quot;Requested Range Not Satisfiable&quot;);</span>
<a href="#l85.3253"></a><span id="l85.3253">       response.setHeader(&quot;Content-Type&quot;, &quot;text/html&quot;, false);</span>
<a href="#l85.3254"></a><span id="l85.3254"> </span>
<a href="#l85.3255"></a><span id="l85.3255">       var body = &quot;&lt;html&gt;\</span>
<a href="#l85.3256"></a><span id="l85.3256">                    &lt;head&gt;\</span>
<a href="#l85.3257"></a><span id="l85.3257">                     &lt;title&gt;416 Requested Range Not Satisfiable&lt;/title&gt;&lt;/head&gt;\</span>
<a href="#l85.3258"></a><span id="l85.3258" class="difflineat">@@ -3238,218 +2876,205 @@ ServerHandler.prototype =</span>
<a href="#l85.3259"></a><span id="l85.3259">                      &lt;h1&gt;416 Requested Range Not Satisfiable&lt;/h1&gt;\</span>
<a href="#l85.3260"></a><span id="l85.3260">                      &lt;p&gt;The byte range was not valid for the\</span>
<a href="#l85.3261"></a><span id="l85.3261">                         requested resource.\</span>
<a href="#l85.3262"></a><span id="l85.3262">                      &lt;/p&gt;\</span>
<a href="#l85.3263"></a><span id="l85.3263">                     &lt;/body&gt;\</span>
<a href="#l85.3264"></a><span id="l85.3264">                   &lt;/html&gt;&quot;;</span>
<a href="#l85.3265"></a><span id="l85.3265">       response.bodyOutputStream.write(body, body.length);</span>
<a href="#l85.3266"></a><span id="l85.3266">     },</span>
<a href="#l85.3267"></a><span id="l85.3267" class="difflineminus">-    500: function(metadata, response)</span>
<a href="#l85.3268"></a><span id="l85.3268" class="difflineminus">-    {</span>
<a href="#l85.3269"></a><span id="l85.3269" class="difflineplus">+    500(metadata, response) {</span>
<a href="#l85.3270"></a><span id="l85.3270">       response.setStatusLine(metadata.httpVersion,</span>
<a href="#l85.3271"></a><span id="l85.3271">                              500,</span>
<a href="#l85.3272"></a><span id="l85.3272">                              &quot;Internal Server Error&quot;);</span>
<a href="#l85.3273"></a><span id="l85.3273">       response.setHeader(&quot;Content-Type&quot;, &quot;text/html&quot;, false);</span>
<a href="#l85.3274"></a><span id="l85.3274"> </span>
<a href="#l85.3275"></a><span id="l85.3275">       var body = &quot;&lt;html&gt;\</span>
<a href="#l85.3276"></a><span id="l85.3276">                     &lt;head&gt;&lt;title&gt;500 Internal Server Error&lt;/title&gt;&lt;/head&gt;\</span>
<a href="#l85.3277"></a><span id="l85.3277">                     &lt;body&gt;\</span>
<a href="#l85.3278"></a><span id="l85.3278">                       &lt;h1&gt;500 Internal Server Error&lt;/h1&gt;\</span>
<a href="#l85.3279"></a><span id="l85.3279">                       &lt;p&gt;Something's broken in this server and\</span>
<a href="#l85.3280"></a><span id="l85.3280">                         needs to be fixed.&lt;/p&gt;\</span>
<a href="#l85.3281"></a><span id="l85.3281">                     &lt;/body&gt;\</span>
<a href="#l85.3282"></a><span id="l85.3282">                   &lt;/html&gt;&quot;;</span>
<a href="#l85.3283"></a><span id="l85.3283">       response.bodyOutputStream.write(body, body.length);</span>
<a href="#l85.3284"></a><span id="l85.3284">     },</span>
<a href="#l85.3285"></a><span id="l85.3285" class="difflineminus">-    501: function(metadata, response)</span>
<a href="#l85.3286"></a><span id="l85.3286" class="difflineminus">-    {</span>
<a href="#l85.3287"></a><span id="l85.3287" class="difflineplus">+    501(metadata, response) {</span>
<a href="#l85.3288"></a><span id="l85.3288">       response.setStatusLine(metadata.httpVersion, 501, &quot;Not Implemented&quot;);</span>
<a href="#l85.3289"></a><span id="l85.3289">       response.setHeader(&quot;Content-Type&quot;, &quot;text/html&quot;, false);</span>
<a href="#l85.3290"></a><span id="l85.3290"> </span>
<a href="#l85.3291"></a><span id="l85.3291">       var body = &quot;&lt;html&gt;\</span>
<a href="#l85.3292"></a><span id="l85.3292">                     &lt;head&gt;&lt;title&gt;501 Not Implemented&lt;/title&gt;&lt;/head&gt;\</span>
<a href="#l85.3293"></a><span id="l85.3293">                     &lt;body&gt;\</span>
<a href="#l85.3294"></a><span id="l85.3294">                       &lt;h1&gt;501 Not Implemented&lt;/h1&gt;\</span>
<a href="#l85.3295"></a><span id="l85.3295">                       &lt;p&gt;This server is not (yet) Apache.&lt;/p&gt;\</span>
<a href="#l85.3296"></a><span id="l85.3296">                     &lt;/body&gt;\</span>
<a href="#l85.3297"></a><span id="l85.3297">                   &lt;/html&gt;&quot;;</span>
<a href="#l85.3298"></a><span id="l85.3298">       response.bodyOutputStream.write(body, body.length);</span>
<a href="#l85.3299"></a><span id="l85.3299">     },</span>
<a href="#l85.3300"></a><span id="l85.3300" class="difflineminus">-    505: function(metadata, response)</span>
<a href="#l85.3301"></a><span id="l85.3301" class="difflineminus">-    {</span>
<a href="#l85.3302"></a><span id="l85.3302" class="difflineplus">+    505(metadata, response) {</span>
<a href="#l85.3303"></a><span id="l85.3303">       response.setStatusLine(&quot;1.1&quot;, 505, &quot;HTTP Version Not Supported&quot;);</span>
<a href="#l85.3304"></a><span id="l85.3304">       response.setHeader(&quot;Content-Type&quot;, &quot;text/html&quot;, false);</span>
<a href="#l85.3305"></a><span id="l85.3305"> </span>
<a href="#l85.3306"></a><span id="l85.3306">       var body = &quot;&lt;html&gt;\</span>
<a href="#l85.3307"></a><span id="l85.3307">                     &lt;head&gt;&lt;title&gt;505 HTTP Version Not Supported&lt;/title&gt;&lt;/head&gt;\</span>
<a href="#l85.3308"></a><span id="l85.3308">                     &lt;body&gt;\</span>
<a href="#l85.3309"></a><span id="l85.3309">                       &lt;h1&gt;505 HTTP Version Not Supported&lt;/h1&gt;\</span>
<a href="#l85.3310"></a><span id="l85.3310">                       &lt;p&gt;This server only supports HTTP/1.0 and HTTP/1.1\</span>
<a href="#l85.3311"></a><span id="l85.3311">                         connections.&lt;/p&gt;\</span>
<a href="#l85.3312"></a><span id="l85.3312">                     &lt;/body&gt;\</span>
<a href="#l85.3313"></a><span id="l85.3313">                   &lt;/html&gt;&quot;;</span>
<a href="#l85.3314"></a><span id="l85.3314">       response.bodyOutputStream.write(body, body.length);</span>
<a href="#l85.3315"></a><span id="l85.3315" class="difflineminus">-    }</span>
<a href="#l85.3316"></a><span id="l85.3316" class="difflineplus">+    },</span>
<a href="#l85.3317"></a><span id="l85.3317">   },</span>
<a href="#l85.3318"></a><span id="l85.3318"> </span>
<a href="#l85.3319"></a><span id="l85.3319">   /**</span>
<a href="#l85.3320"></a><span id="l85.3320">    * Contains handlers for the default set of URIs contained in this server.</span>
<a href="#l85.3321"></a><span id="l85.3321">    */</span>
<a href="#l85.3322"></a><span id="l85.3322" class="difflineminus">-  _defaultPaths:</span>
<a href="#l85.3323"></a><span id="l85.3323" class="difflineminus">-  {</span>
<a href="#l85.3324"></a><span id="l85.3324" class="difflineminus">-    &quot;/&quot;: function(metadata, response)</span>
<a href="#l85.3325"></a><span id="l85.3325" class="difflineminus">-    {</span>
<a href="#l85.3326"></a><span id="l85.3326" class="difflineplus">+  _defaultPaths: {</span>
<a href="#l85.3327"></a><span id="l85.3327" class="difflineplus">+    &quot;/&quot;: function(metadata, response) {</span>
<a href="#l85.3328"></a><span id="l85.3328">       response.setStatusLine(metadata.httpVersion, 200, &quot;OK&quot;);</span>
<a href="#l85.3329"></a><span id="l85.3329">       response.setHeader(&quot;Content-Type&quot;, &quot;text/html&quot;, false);</span>
<a href="#l85.3330"></a><span id="l85.3330"> </span>
<a href="#l85.3331"></a><span id="l85.3331">       var body = &quot;&lt;html&gt;\</span>
<a href="#l85.3332"></a><span id="l85.3332">                     &lt;head&gt;&lt;title&gt;httpd.js&lt;/title&gt;&lt;/head&gt;\</span>
<a href="#l85.3333"></a><span id="l85.3333">                     &lt;body&gt;\</span>
<a href="#l85.3334"></a><span id="l85.3334">                       &lt;h1&gt;httpd.js&lt;/h1&gt;\</span>
<a href="#l85.3335"></a><span id="l85.3335">                       &lt;p&gt;If you're seeing this page, httpd.js is up and\</span>
<a href="#l85.3336"></a><span id="l85.3336">                         serving requests!  Now set a base path and serve some\</span>
<a href="#l85.3337"></a><span id="l85.3337">                         files!&lt;/p&gt;\</span>
<a href="#l85.3338"></a><span id="l85.3338">                     &lt;/body&gt;\</span>
<a href="#l85.3339"></a><span id="l85.3339">                   &lt;/html&gt;&quot;;</span>
<a href="#l85.3340"></a><span id="l85.3340"> </span>
<a href="#l85.3341"></a><span id="l85.3341">       response.bodyOutputStream.write(body, body.length);</span>
<a href="#l85.3342"></a><span id="l85.3342">     },</span>
<a href="#l85.3343"></a><span id="l85.3343"> </span>
<a href="#l85.3344"></a><span id="l85.3344" class="difflineminus">-    &quot;/trace&quot;: function(metadata, response)</span>
<a href="#l85.3345"></a><span id="l85.3345" class="difflineminus">-    {</span>
<a href="#l85.3346"></a><span id="l85.3346" class="difflineplus">+    &quot;/trace&quot;: function(metadata, response) {</span>
<a href="#l85.3347"></a><span id="l85.3347">       response.setStatusLine(metadata.httpVersion, 200, &quot;OK&quot;);</span>
<a href="#l85.3348"></a><span id="l85.3348">       response.setHeader(&quot;Content-Type&quot;, &quot;text/plain&quot;, false);</span>
<a href="#l85.3349"></a><span id="l85.3349"> </span>
<a href="#l85.3350"></a><span id="l85.3350">       var body = &quot;Request-URI: &quot; +</span>
<a href="#l85.3351"></a><span id="l85.3351">                  metadata.scheme + &quot;://&quot; + metadata.host + &quot;:&quot; + metadata.port +</span>
<a href="#l85.3352"></a><span id="l85.3352">                  metadata.path + &quot;\n\n&quot;;</span>
<a href="#l85.3353"></a><span id="l85.3353">       body += &quot;Request (semantically equivalent, slightly reformatted):\n\n&quot;;</span>
<a href="#l85.3354"></a><span id="l85.3354">       body += metadata.method + &quot; &quot; + metadata.path;</span>
<a href="#l85.3355"></a><span id="l85.3355"> </span>
<a href="#l85.3356"></a><span id="l85.3356">       if (metadata.queryString)</span>
<a href="#l85.3357"></a><span id="l85.3357">         body +=  &quot;?&quot; + metadata.queryString;</span>
<a href="#l85.3358"></a><span id="l85.3358"> </span>
<a href="#l85.3359"></a><span id="l85.3359">       body += &quot; HTTP/&quot; + metadata.httpVersion + &quot;\r\n&quot;;</span>
<a href="#l85.3360"></a><span id="l85.3360"> </span>
<a href="#l85.3361"></a><span id="l85.3361">       var headEnum = metadata.headers;</span>
<a href="#l85.3362"></a><span id="l85.3362" class="difflineminus">-      while (headEnum.hasMoreElements())</span>
<a href="#l85.3363"></a><span id="l85.3363" class="difflineminus">-      {</span>
<a href="#l85.3364"></a><span id="l85.3364" class="difflineplus">+      while (headEnum.hasMoreElements()) {</span>
<a href="#l85.3365"></a><span id="l85.3365">         var fieldName = headEnum.getNext()</span>
<a href="#l85.3366"></a><span id="l85.3366">                                 .QueryInterface(Ci.nsISupportsString)</span>
<a href="#l85.3367"></a><span id="l85.3367">                                 .data;</span>
<a href="#l85.3368"></a><span id="l85.3368">         body += fieldName + &quot;: &quot; + metadata.getHeader(fieldName) + &quot;\r\n&quot;;</span>
<a href="#l85.3369"></a><span id="l85.3369">       }</span>
<a href="#l85.3370"></a><span id="l85.3370"> </span>
<a href="#l85.3371"></a><span id="l85.3371">       response.bodyOutputStream.write(body, body.length);</span>
<a href="#l85.3372"></a><span id="l85.3372" class="difflineminus">-    }</span>
<a href="#l85.3373"></a><span id="l85.3373" class="difflineminus">-  }</span>
<a href="#l85.3374"></a><span id="l85.3374" class="difflineplus">+    },</span>
<a href="#l85.3375"></a><span id="l85.3375" class="difflineplus">+  },</span>
<a href="#l85.3376"></a><span id="l85.3376"> };</span>
<a href="#l85.3377"></a><span id="l85.3377"> </span>
<a href="#l85.3378"></a><span id="l85.3378"> </span>
<a href="#l85.3379"></a><span id="l85.3379"> /**</span>
<a href="#l85.3380"></a><span id="l85.3380">  * Maps absolute paths to files on the local file system (as nsIFiles).</span>
<a href="#l85.3381"></a><span id="l85.3381">  */</span>
<a href="#l85.3382"></a><span id="l85.3382" class="difflineminus">-function FileMap()</span>
<a href="#l85.3383"></a><span id="l85.3383" class="difflineminus">-{</span>
<a href="#l85.3384"></a><span id="l85.3384" class="difflineplus">+function FileMap() {</span>
<a href="#l85.3385"></a><span id="l85.3385">   /** Hash which will map paths to nsIFiles. */</span>
<a href="#l85.3386"></a><span id="l85.3386">   this._map = {};</span>
<a href="#l85.3387"></a><span id="l85.3387"> }</span>
<a href="#l85.3388"></a><span id="l85.3388" class="difflineminus">-FileMap.prototype =</span>
<a href="#l85.3389"></a><span id="l85.3389" class="difflineminus">-{</span>
<a href="#l85.3390"></a><span id="l85.3390" class="difflineplus">+FileMap.prototype = {</span>
<a href="#l85.3391"></a><span id="l85.3391">   // PUBLIC API</span>
<a href="#l85.3392"></a><span id="l85.3392"> </span>
<a href="#l85.3393"></a><span id="l85.3393">   /**</span>
<a href="#l85.3394"></a><span id="l85.3394">    * Maps key to a clone of the nsIFile value if value is non-null;</span>
<a href="#l85.3395"></a><span id="l85.3395">    * otherwise, removes any extant mapping for key.</span>
<a href="#l85.3396"></a><span id="l85.3396">    *</span>
<a href="#l85.3397"></a><span id="l85.3397">    * @param key : string</span>
<a href="#l85.3398"></a><span id="l85.3398">    *   string to which a clone of value is mapped</span>
<a href="#l85.3399"></a><span id="l85.3399">    * @param value : nsIFile</span>
<a href="#l85.3400"></a><span id="l85.3400">    *   the file to map to key, or null to remove a mapping</span>
<a href="#l85.3401"></a><span id="l85.3401">    */</span>
<a href="#l85.3402"></a><span id="l85.3402" class="difflineminus">-  put: function(key, value)</span>
<a href="#l85.3403"></a><span id="l85.3403" class="difflineminus">-  {</span>
<a href="#l85.3404"></a><span id="l85.3404" class="difflineplus">+  put(key, value) {</span>
<a href="#l85.3405"></a><span id="l85.3405">     if (value)</span>
<a href="#l85.3406"></a><span id="l85.3406">       this._map[key] = value.clone();</span>
<a href="#l85.3407"></a><span id="l85.3407">     else</span>
<a href="#l85.3408"></a><span id="l85.3408">       delete this._map[key];</span>
<a href="#l85.3409"></a><span id="l85.3409">   },</span>
<a href="#l85.3410"></a><span id="l85.3410"> </span>
<a href="#l85.3411"></a><span id="l85.3411">   /**</span>
<a href="#l85.3412"></a><span id="l85.3412">    * Returns a clone of the nsIFile mapped to key, or null if no such</span>
<a href="#l85.3413"></a><span id="l85.3413">    * mapping exists.</span>
<a href="#l85.3414"></a><span id="l85.3414">    *</span>
<a href="#l85.3415"></a><span id="l85.3415">    * @param key : string</span>
<a href="#l85.3416"></a><span id="l85.3416">    *   key to which the returned file maps</span>
<a href="#l85.3417"></a><span id="l85.3417">    * @returns nsIFile</span>
<a href="#l85.3418"></a><span id="l85.3418">    *   a clone of the mapped file, or null if no mapping exists</span>
<a href="#l85.3419"></a><span id="l85.3419">    */</span>
<a href="#l85.3420"></a><span id="l85.3420" class="difflineminus">-  get: function(key)</span>
<a href="#l85.3421"></a><span id="l85.3421" class="difflineminus">-  {</span>
<a href="#l85.3422"></a><span id="l85.3422" class="difflineplus">+  get(key) {</span>
<a href="#l85.3423"></a><span id="l85.3423">     var val = this._map[key];</span>
<a href="#l85.3424"></a><span id="l85.3424">     return val ? val.clone() : null;</span>
<a href="#l85.3425"></a><span id="l85.3425" class="difflineminus">-  }</span>
<a href="#l85.3426"></a><span id="l85.3426" class="difflineplus">+  },</span>
<a href="#l85.3427"></a><span id="l85.3427"> };</span>
<a href="#l85.3428"></a><span id="l85.3428"> </span>
<a href="#l85.3429"></a><span id="l85.3429"> </span>
<a href="#l85.3430"></a><span id="l85.3430"> // Response CONSTANTS</span>
<a href="#l85.3431"></a><span id="l85.3431"> </span>
<a href="#l85.3432"></a><span id="l85.3432"> // token       = *&lt;any CHAR except CTLs or separators&gt;</span>
<a href="#l85.3433"></a><span id="l85.3433"> // CHAR        = &lt;any US-ASCII character (0-127)&gt;</span>
<a href="#l85.3434"></a><span id="l85.3434"> // CTL         = &lt;any US-ASCII control character (0-31) and DEL (127)&gt;</span>
<a href="#l85.3435"></a><span id="l85.3435"> // separators  = &quot;(&quot; | &quot;)&quot; | &quot;&lt;&quot; | &quot;&gt;&quot; | &quot;@&quot;</span>
<a href="#l85.3436"></a><span id="l85.3436"> //             | &quot;,&quot; | &quot;;&quot; | &quot;:&quot; | &quot;\&quot; | &lt;&quot;&gt;</span>
<a href="#l85.3437"></a><span id="l85.3437"> //             | &quot;/&quot; | &quot;[&quot; | &quot;]&quot; | &quot;?&quot; | &quot;=&quot;</span>
<a href="#l85.3438"></a><span id="l85.3438"> //             | &quot;{&quot; | &quot;}&quot; | SP  | HT</span>
<a href="#l85.3439"></a><span id="l85.3439" class="difflineminus">-var IS_TOKEN_ARRAY =</span>
<a href="#l85.3440"></a><span id="l85.3440" class="difflineminus">-  [0, 0, 0, 0, 0, 0, 0, 0, //   0</span>
<a href="#l85.3441"></a><span id="l85.3441" class="difflineminus">-   0, 0, 0, 0, 0, 0, 0, 0, //   8</span>
<a href="#l85.3442"></a><span id="l85.3442" class="difflineminus">-   0, 0, 0, 0, 0, 0, 0, 0, //  16</span>
<a href="#l85.3443"></a><span id="l85.3443" class="difflineminus">-   0, 0, 0, 0, 0, 0, 0, 0, //  24</span>
<a href="#l85.3444"></a><span id="l85.3444" class="difflineminus">-</span>
<a href="#l85.3445"></a><span id="l85.3445" class="difflineminus">-   0, 1, 0, 1, 1, 1, 1, 1, //  32</span>
<a href="#l85.3446"></a><span id="l85.3446" class="difflineminus">-   0, 0, 1, 1, 0, 1, 1, 0, //  40</span>
<a href="#l85.3447"></a><span id="l85.3447" class="difflineminus">-   1, 1, 1, 1, 1, 1, 1, 1, //  48</span>
<a href="#l85.3448"></a><span id="l85.3448" class="difflineminus">-   1, 1, 0, 0, 0, 0, 0, 0, //  56</span>
<a href="#l85.3449"></a><span id="l85.3449" class="difflineminus">-</span>
<a href="#l85.3450"></a><span id="l85.3450" class="difflineminus">-   0, 1, 1, 1, 1, 1, 1, 1, //  64</span>
<a href="#l85.3451"></a><span id="l85.3451" class="difflineminus">-   1, 1, 1, 1, 1, 1, 1, 1, //  72</span>
<a href="#l85.3452"></a><span id="l85.3452" class="difflineminus">-   1, 1, 1, 1, 1, 1, 1, 1, //  80</span>
<a href="#l85.3453"></a><span id="l85.3453" class="difflineminus">-   1, 1, 1, 0, 0, 0, 1, 1, //  88</span>
<a href="#l85.3454"></a><span id="l85.3454" class="difflineminus">-</span>
<a href="#l85.3455"></a><span id="l85.3455" class="difflineminus">-   1, 1, 1, 1, 1, 1, 1, 1, //  96</span>
<a href="#l85.3456"></a><span id="l85.3456" class="difflineminus">-   1, 1, 1, 1, 1, 1, 1, 1, // 104</span>
<a href="#l85.3457"></a><span id="l85.3457" class="difflineminus">-   1, 1, 1, 1, 1, 1, 1, 1, // 112</span>
<a href="#l85.3458"></a><span id="l85.3458" class="difflineminus">-   1, 1, 1, 0, 1, 0, 1];   // 120</span>
<a href="#l85.3459"></a><span id="l85.3459" class="difflineminus">-</span>
<a href="#l85.3460"></a><span id="l85.3460" class="difflineplus">+var IS_TOKEN_ARRAY = [</span>
<a href="#l85.3461"></a><span id="l85.3461" class="difflineplus">+  0, 0, 0, 0, 0, 0, 0, 0, //   0</span>
<a href="#l85.3462"></a><span id="l85.3462" class="difflineplus">+  0, 0, 0, 0, 0, 0, 0, 0, //   8</span>
<a href="#l85.3463"></a><span id="l85.3463" class="difflineplus">+  0, 0, 0, 0, 0, 0, 0, 0, //  16</span>
<a href="#l85.3464"></a><span id="l85.3464" class="difflineplus">+  0, 0, 0, 0, 0, 0, 0, 0, //  24</span>
<a href="#l85.3465"></a><span id="l85.3465" class="difflineplus">+</span>
<a href="#l85.3466"></a><span id="l85.3466" class="difflineplus">+  0, 1, 0, 1, 1, 1, 1, 1, //  32</span>
<a href="#l85.3467"></a><span id="l85.3467" class="difflineplus">+  0, 0, 1, 1, 0, 1, 1, 0, //  40</span>
<a href="#l85.3468"></a><span id="l85.3468" class="difflineplus">+  1, 1, 1, 1, 1, 1, 1, 1, //  48</span>
<a href="#l85.3469"></a><span id="l85.3469" class="difflineplus">+  1, 1, 0, 0, 0, 0, 0, 0, //  56</span>
<a href="#l85.3470"></a><span id="l85.3470" class="difflineplus">+</span>
<a href="#l85.3471"></a><span id="l85.3471" class="difflineplus">+  0, 1, 1, 1, 1, 1, 1, 1, //  64</span>
<a href="#l85.3472"></a><span id="l85.3472" class="difflineplus">+  1, 1, 1, 1, 1, 1, 1, 1, //  72</span>
<a href="#l85.3473"></a><span id="l85.3473" class="difflineplus">+  1, 1, 1, 1, 1, 1, 1, 1, //  80</span>
<a href="#l85.3474"></a><span id="l85.3474" class="difflineplus">+  1, 1, 1, 0, 0, 0, 1, 1, //  88</span>
<a href="#l85.3475"></a><span id="l85.3475" class="difflineplus">+</span>
<a href="#l85.3476"></a><span id="l85.3476" class="difflineplus">+  1, 1, 1, 1, 1, 1, 1, 1, //  96</span>
<a href="#l85.3477"></a><span id="l85.3477" class="difflineplus">+  1, 1, 1, 1, 1, 1, 1, 1, // 104</span>
<a href="#l85.3478"></a><span id="l85.3478" class="difflineplus">+  1, 1, 1, 1, 1, 1, 1, 1, // 112</span>
<a href="#l85.3479"></a><span id="l85.3479" class="difflineplus">+  1, 1, 1, 0, 1, 0, 1,    // 120</span>
<a href="#l85.3480"></a><span id="l85.3480" class="difflineplus">+];</span>
<a href="#l85.3481"></a><span id="l85.3481"> </span>
<a href="#l85.3482"></a><span id="l85.3482"> /**</span>
<a href="#l85.3483"></a><span id="l85.3483">  * Determines whether the given character code is a CTL.</span>
<a href="#l85.3484"></a><span id="l85.3484">  *</span>
<a href="#l85.3485"></a><span id="l85.3485">  * @param code : uint</span>
<a href="#l85.3486"></a><span id="l85.3486">  *   the character code</span>
<a href="#l85.3487"></a><span id="l85.3487">  * @returns boolean</span>
<a href="#l85.3488"></a><span id="l85.3488">  *   true if code is a CTL, false otherwise</span>
<a href="#l85.3489"></a><span id="l85.3489">  */</span>
<a href="#l85.3490"></a><span id="l85.3490" class="difflineminus">-function isCTL(code)</span>
<a href="#l85.3491"></a><span id="l85.3491" class="difflineminus">-{</span>
<a href="#l85.3492"></a><span id="l85.3492" class="difflineplus">+function isCTL(code) {</span>
<a href="#l85.3493"></a><span id="l85.3493">   return (code &gt;= 0 &amp;&amp; code &lt;= 31) || (code == 127);</span>
<a href="#l85.3494"></a><span id="l85.3494"> }</span>
<a href="#l85.3495"></a><span id="l85.3495"> </span>
<a href="#l85.3496"></a><span id="l85.3496"> /**</span>
<a href="#l85.3497"></a><span id="l85.3497">  * Represents a response to an HTTP request, encapsulating all details of that</span>
<a href="#l85.3498"></a><span id="l85.3498">  * response.  This includes all headers, the HTTP version, status code and</span>
<a href="#l85.3499"></a><span id="l85.3499">  * explanation, and the entity itself.</span>
<a href="#l85.3500"></a><span id="l85.3500">  *</span>
<a href="#l85.3501"></a><span id="l85.3501">  * @param connection : Connection</span>
<a href="#l85.3502"></a><span id="l85.3502">  *   the connection over which this response is to be written</span>
<a href="#l85.3503"></a><span id="l85.3503">  */</span>
<a href="#l85.3504"></a><span id="l85.3504" class="difflineminus">-function Response(connection)</span>
<a href="#l85.3505"></a><span id="l85.3505" class="difflineminus">-{</span>
<a href="#l85.3506"></a><span id="l85.3506" class="difflineplus">+function Response(connection) {</span>
<a href="#l85.3507"></a><span id="l85.3507">   /** The connection over which this response will be written. */</span>
<a href="#l85.3508"></a><span id="l85.3508">   this._connection = connection;</span>
<a href="#l85.3509"></a><span id="l85.3509"> </span>
<a href="#l85.3510"></a><span id="l85.3510">   /**</span>
<a href="#l85.3511"></a><span id="l85.3511">    * The HTTP version of this response; defaults to 1.1 if not set by the</span>
<a href="#l85.3512"></a><span id="l85.3512">    * handler.</span>
<a href="#l85.3513"></a><span id="l85.3513">    */</span>
<a href="#l85.3514"></a><span id="l85.3514">   this._httpVersion = nsHttpVersion.HTTP_1_1;</span>
<a href="#l85.3515"></a><span id="l85.3515" class="difflineat">@@ -3516,78 +3141,69 @@ function Response(connection)</span>
<a href="#l85.3516"></a><span id="l85.3516"> </span>
<a href="#l85.3517"></a><span id="l85.3517">   /**</span>
<a href="#l85.3518"></a><span id="l85.3518">    * True iff powerSeized() has been called on this, signaling that this</span>
<a href="#l85.3519"></a><span id="l85.3519">    * response is to be handled manually by the response handler (which may then</span>
<a href="#l85.3520"></a><span id="l85.3520">    * send arbitrary data in response, even non-HTTP responses).</span>
<a href="#l85.3521"></a><span id="l85.3521">    */</span>
<a href="#l85.3522"></a><span id="l85.3522">   this._powerSeized = false;</span>
<a href="#l85.3523"></a><span id="l85.3523"> }</span>
<a href="#l85.3524"></a><span id="l85.3524" class="difflineminus">-Response.prototype =</span>
<a href="#l85.3525"></a><span id="l85.3525" class="difflineminus">-{</span>
<a href="#l85.3526"></a><span id="l85.3526" class="difflineplus">+Response.prototype = {</span>
<a href="#l85.3527"></a><span id="l85.3527">   // PUBLIC CONSTRUCTION API</span>
<a href="#l85.3528"></a><span id="l85.3528"> </span>
<a href="#l85.3529"></a><span id="l85.3529">   //</span>
<a href="#l85.3530"></a><span id="l85.3530">   // see nsIHttpResponse.bodyOutputStream</span>
<a href="#l85.3531"></a><span id="l85.3531">   //</span>
<a href="#l85.3532"></a><span id="l85.3532" class="difflineminus">-  get bodyOutputStream()</span>
<a href="#l85.3533"></a><span id="l85.3533" class="difflineminus">-  {</span>
<a href="#l85.3534"></a><span id="l85.3534" class="difflineplus">+  get bodyOutputStream() {</span>
<a href="#l85.3535"></a><span id="l85.3535">     if (this._finished)</span>
<a href="#l85.3536"></a><span id="l85.3536">       throw Cr.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l85.3537"></a><span id="l85.3537"> </span>
<a href="#l85.3538"></a><span id="l85.3538" class="difflineminus">-    if (!this._bodyOutputStream)</span>
<a href="#l85.3539"></a><span id="l85.3539" class="difflineminus">-    {</span>
<a href="#l85.3540"></a><span id="l85.3540" class="difflineminus">-      var pipe = new Pipe(true, false, Response.SEGMENT_SIZE, PR_UINT32_MAX,</span>
<a href="#l85.3541"></a><span id="l85.3541" class="difflineminus">-                          null);</span>
<a href="#l85.3542"></a><span id="l85.3542" class="difflineplus">+    if (!this._bodyOutputStream) {</span>
<a href="#l85.3543"></a><span id="l85.3543" class="difflineplus">+      var pipe = new Pipe(true, false, Response.SEGMENT_SIZE, PR_UINT32_MAX, null);</span>
<a href="#l85.3544"></a><span id="l85.3544">       this._bodyOutputStream = pipe.outputStream;</span>
<a href="#l85.3545"></a><span id="l85.3545">       this._bodyInputStream = pipe.inputStream;</span>
<a href="#l85.3546"></a><span id="l85.3546">       if (this._processAsync || this._powerSeized)</span>
<a href="#l85.3547"></a><span id="l85.3547">         this._startAsyncProcessor();</span>
<a href="#l85.3548"></a><span id="l85.3548">     }</span>
<a href="#l85.3549"></a><span id="l85.3549"> </span>
<a href="#l85.3550"></a><span id="l85.3550">     return this._bodyOutputStream;</span>
<a href="#l85.3551"></a><span id="l85.3551">   },</span>
<a href="#l85.3552"></a><span id="l85.3552"> </span>
<a href="#l85.3553"></a><span id="l85.3553">   //</span>
<a href="#l85.3554"></a><span id="l85.3554">   // see nsIHttpResponse.write</span>
<a href="#l85.3555"></a><span id="l85.3555">   //</span>
<a href="#l85.3556"></a><span id="l85.3556" class="difflineminus">-  write: function(data)</span>
<a href="#l85.3557"></a><span id="l85.3557" class="difflineminus">-  {</span>
<a href="#l85.3558"></a><span id="l85.3558" class="difflineplus">+  write(data) {</span>
<a href="#l85.3559"></a><span id="l85.3559">     if (this._finished)</span>
<a href="#l85.3560"></a><span id="l85.3560">       throw Cr.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l85.3561"></a><span id="l85.3561"> </span>
<a href="#l85.3562"></a><span id="l85.3562">     var dataAsString = String(data);</span>
<a href="#l85.3563"></a><span id="l85.3563">     this.bodyOutputStream.write(dataAsString, dataAsString.length);</span>
<a href="#l85.3564"></a><span id="l85.3564">   },</span>
<a href="#l85.3565"></a><span id="l85.3565"> </span>
<a href="#l85.3566"></a><span id="l85.3566">   //</span>
<a href="#l85.3567"></a><span id="l85.3567">   // see nsIHttpResponse.setStatusLine</span>
<a href="#l85.3568"></a><span id="l85.3568">   //</span>
<a href="#l85.3569"></a><span id="l85.3569" class="difflineminus">-  setStatusLine: function(httpVersion, code, description)</span>
<a href="#l85.3570"></a><span id="l85.3570" class="difflineminus">-  {</span>
<a href="#l85.3571"></a><span id="l85.3571" class="difflineplus">+  setStatusLine(httpVersion, code, description) {</span>
<a href="#l85.3572"></a><span id="l85.3572">     if (!this._headers || this._finished || this._powerSeized)</span>
<a href="#l85.3573"></a><span id="l85.3573">       throw Cr.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l85.3574"></a><span id="l85.3574">     this._ensureAlive();</span>
<a href="#l85.3575"></a><span id="l85.3575"> </span>
<a href="#l85.3576"></a><span id="l85.3576">     if (!(code &gt;= 0 &amp;&amp; code &lt; 1000))</span>
<a href="#l85.3577"></a><span id="l85.3577">       throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l85.3578"></a><span id="l85.3578"> </span>
<a href="#l85.3579"></a><span id="l85.3579" class="difflineminus">-    try</span>
<a href="#l85.3580"></a><span id="l85.3580" class="difflineminus">-    {</span>
<a href="#l85.3581"></a><span id="l85.3581" class="difflineplus">+    try {</span>
<a href="#l85.3582"></a><span id="l85.3582">       var httpVer;</span>
<a href="#l85.3583"></a><span id="l85.3583">       // avoid version construction for the most common cases</span>
<a href="#l85.3584"></a><span id="l85.3584">       if (!httpVersion || httpVersion == &quot;1.1&quot;)</span>
<a href="#l85.3585"></a><span id="l85.3585">         httpVer = nsHttpVersion.HTTP_1_1;</span>
<a href="#l85.3586"></a><span id="l85.3586">       else if (httpVersion == &quot;1.0&quot;)</span>
<a href="#l85.3587"></a><span id="l85.3587">         httpVer = nsHttpVersion.HTTP_1_0;</span>
<a href="#l85.3588"></a><span id="l85.3588">       else</span>
<a href="#l85.3589"></a><span id="l85.3589">         httpVer = new nsHttpVersion(httpVersion);</span>
<a href="#l85.3590"></a><span id="l85.3590" class="difflineminus">-    }</span>
<a href="#l85.3591"></a><span id="l85.3591" class="difflineminus">-    catch (e)</span>
<a href="#l85.3592"></a><span id="l85.3592" class="difflineminus">-    {</span>
<a href="#l85.3593"></a><span id="l85.3593" class="difflineplus">+    } catch (e) {</span>
<a href="#l85.3594"></a><span id="l85.3594">       throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l85.3595"></a><span id="l85.3595">     }</span>
<a href="#l85.3596"></a><span id="l85.3596"> </span>
<a href="#l85.3597"></a><span id="l85.3597">     // Reason-Phrase = *&lt;TEXT, excluding CR, LF&gt;</span>
<a href="#l85.3598"></a><span id="l85.3598">     // TEXT          = &lt;any OCTET except CTLs, but including LWS&gt;</span>
<a href="#l85.3599"></a><span id="l85.3599">     //</span>
<a href="#l85.3600"></a><span id="l85.3600">     // XXX this ends up disallowing octets which aren't Unicode, I think -- not</span>
<a href="#l85.3601"></a><span id="l85.3601">     //     much to do if description is IDL'd as string</span>
<a href="#l85.3602"></a><span id="l85.3602" class="difflineat">@@ -3601,30 +3217,28 @@ Response.prototype =</span>
<a href="#l85.3603"></a><span id="l85.3603">     this._httpDescription = description;</span>
<a href="#l85.3604"></a><span id="l85.3604">     this._httpCode = code;</span>
<a href="#l85.3605"></a><span id="l85.3605">     this._httpVersion = httpVer;</span>
<a href="#l85.3606"></a><span id="l85.3606">   },</span>
<a href="#l85.3607"></a><span id="l85.3607"> </span>
<a href="#l85.3608"></a><span id="l85.3608">   //</span>
<a href="#l85.3609"></a><span id="l85.3609">   // see nsIHttpResponse.setHeader</span>
<a href="#l85.3610"></a><span id="l85.3610">   //</span>
<a href="#l85.3611"></a><span id="l85.3611" class="difflineminus">-  setHeader: function(name, value, merge)</span>
<a href="#l85.3612"></a><span id="l85.3612" class="difflineminus">-  {</span>
<a href="#l85.3613"></a><span id="l85.3613" class="difflineplus">+  setHeader(name, value, merge) {</span>
<a href="#l85.3614"></a><span id="l85.3614">     if (!this._headers || this._finished || this._powerSeized)</span>
<a href="#l85.3615"></a><span id="l85.3615">       throw Cr.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l85.3616"></a><span id="l85.3616">     this._ensureAlive();</span>
<a href="#l85.3617"></a><span id="l85.3617"> </span>
<a href="#l85.3618"></a><span id="l85.3618">     this._headers.setHeader(name, value, merge);</span>
<a href="#l85.3619"></a><span id="l85.3619">   },</span>
<a href="#l85.3620"></a><span id="l85.3620"> </span>
<a href="#l85.3621"></a><span id="l85.3621">   //</span>
<a href="#l85.3622"></a><span id="l85.3622">   // see nsIHttpResponse.processAsync</span>
<a href="#l85.3623"></a><span id="l85.3623">   //</span>
<a href="#l85.3624"></a><span id="l85.3624" class="difflineminus">-  processAsync: function()</span>
<a href="#l85.3625"></a><span id="l85.3625" class="difflineminus">-  {</span>
<a href="#l85.3626"></a><span id="l85.3626" class="difflineplus">+  processAsync() {</span>
<a href="#l85.3627"></a><span id="l85.3627">     if (this._finished)</span>
<a href="#l85.3628"></a><span id="l85.3628">       throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l85.3629"></a><span id="l85.3629">     if (this._powerSeized)</span>
<a href="#l85.3630"></a><span id="l85.3630">       throw Cr.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l85.3631"></a><span id="l85.3631">     if (this._processAsync)</span>
<a href="#l85.3632"></a><span id="l85.3632">       return;</span>
<a href="#l85.3633"></a><span id="l85.3633">     this._ensureAlive();</span>
<a href="#l85.3634"></a><span id="l85.3634"> </span>
<a href="#l85.3635"></a><span id="l85.3635" class="difflineat">@@ -3646,18 +3260,17 @@ Response.prototype =</span>
<a href="#l85.3636"></a><span id="l85.3636">      */</span>
<a href="#l85.3637"></a><span id="l85.3637">     if (this._bodyOutputStream &amp;&amp; !this._asyncCopier)</span>
<a href="#l85.3638"></a><span id="l85.3638">       this._startAsyncProcessor();</span>
<a href="#l85.3639"></a><span id="l85.3639">   },</span>
<a href="#l85.3640"></a><span id="l85.3640"> </span>
<a href="#l85.3641"></a><span id="l85.3641">   //</span>
<a href="#l85.3642"></a><span id="l85.3642">   // see nsIHttpResponse.seizePower</span>
<a href="#l85.3643"></a><span id="l85.3643">   //</span>
<a href="#l85.3644"></a><span id="l85.3644" class="difflineminus">-  seizePower: function()</span>
<a href="#l85.3645"></a><span id="l85.3645" class="difflineminus">-  {</span>
<a href="#l85.3646"></a><span id="l85.3646" class="difflineplus">+  seizePower() {</span>
<a href="#l85.3647"></a><span id="l85.3647">     if (this._processAsync)</span>
<a href="#l85.3648"></a><span id="l85.3648">       throw Cr.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l85.3649"></a><span id="l85.3649">     if (this._finished)</span>
<a href="#l85.3650"></a><span id="l85.3650">       throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l85.3651"></a><span id="l85.3651">     if (this._powerSeized)</span>
<a href="#l85.3652"></a><span id="l85.3652">       return;</span>
<a href="#l85.3653"></a><span id="l85.3653">     this._ensureAlive();</span>
<a href="#l85.3654"></a><span id="l85.3654"> </span>
<a href="#l85.3655"></a><span id="l85.3655" class="difflineat">@@ -3666,34 +3279,32 @@ Response.prototype =</span>
<a href="#l85.3656"></a><span id="l85.3656"> </span>
<a href="#l85.3657"></a><span id="l85.3657">     // Purge any already-written data without sending it.  We could as easily</span>
<a href="#l85.3658"></a><span id="l85.3658">     // swap out the streams entirely, but that makes it possible to acquire and</span>
<a href="#l85.3659"></a><span id="l85.3659">     // unknowingly use a stale reference, so we require there only be one of</span>
<a href="#l85.3660"></a><span id="l85.3660">     // each stream ever for any response to avoid this complication.</span>
<a href="#l85.3661"></a><span id="l85.3661">     if (this._asyncCopier)</span>
<a href="#l85.3662"></a><span id="l85.3662">       this._asyncCopier.cancel(Cr.NS_BINDING_ABORTED);</span>
<a href="#l85.3663"></a><span id="l85.3663">     this._asyncCopier = null;</span>
<a href="#l85.3664"></a><span id="l85.3664" class="difflineminus">-    if (this._bodyOutputStream)</span>
<a href="#l85.3665"></a><span id="l85.3665" class="difflineminus">-    {</span>
<a href="#l85.3666"></a><span id="l85.3666" class="difflineplus">+    if (this._bodyOutputStream) {</span>
<a href="#l85.3667"></a><span id="l85.3667">       var input = new BinaryInputStream(this._bodyInputStream);</span>
<a href="#l85.3668"></a><span id="l85.3668">       var avail;</span>
<a href="#l85.3669"></a><span id="l85.3669">       while ((avail = input.available()) &gt; 0)</span>
<a href="#l85.3670"></a><span id="l85.3670">         input.readByteArray(avail);</span>
<a href="#l85.3671"></a><span id="l85.3671">     }</span>
<a href="#l85.3672"></a><span id="l85.3672"> </span>
<a href="#l85.3673"></a><span id="l85.3673">     this._powerSeized = true;</span>
<a href="#l85.3674"></a><span id="l85.3674">     if (this._bodyOutputStream)</span>
<a href="#l85.3675"></a><span id="l85.3675">       this._startAsyncProcessor();</span>
<a href="#l85.3676"></a><span id="l85.3676">   },</span>
<a href="#l85.3677"></a><span id="l85.3677"> </span>
<a href="#l85.3678"></a><span id="l85.3678">   //</span>
<a href="#l85.3679"></a><span id="l85.3679">   // see nsIHttpResponse.finish</span>
<a href="#l85.3680"></a><span id="l85.3680">   //</span>
<a href="#l85.3681"></a><span id="l85.3681" class="difflineminus">-  finish: function()</span>
<a href="#l85.3682"></a><span id="l85.3682" class="difflineminus">-  {</span>
<a href="#l85.3683"></a><span id="l85.3683" class="difflineplus">+  finish() {</span>
<a href="#l85.3684"></a><span id="l85.3684">     if (!this._processAsync &amp;&amp; !this._powerSeized)</span>
<a href="#l85.3685"></a><span id="l85.3685">       throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l85.3686"></a><span id="l85.3686">     if (this._finished)</span>
<a href="#l85.3687"></a><span id="l85.3687">       return;</span>
<a href="#l85.3688"></a><span id="l85.3688"> </span>
<a href="#l85.3689"></a><span id="l85.3689">     dumpn(&quot;*** finishing connection &quot; + this._connection.number);</span>
<a href="#l85.3690"></a><span id="l85.3690">     this._startAsyncProcessor(); // in case bodyOutputStream was never accessed</span>
<a href="#l85.3691"></a><span id="l85.3691">     if (this._bodyOutputStream)</span>
<a href="#l85.3692"></a><span id="l85.3692" class="difflineat">@@ -3710,91 +3321,83 @@ Response.prototype =</span>
<a href="#l85.3693"></a><span id="l85.3693">   QueryInterface: ChromeUtils.generateQI([&quot;nsIHttpResponse&quot;]),</span>
<a href="#l85.3694"></a><span id="l85.3694"> </span>
<a href="#l85.3695"></a><span id="l85.3695"> </span>
<a href="#l85.3696"></a><span id="l85.3696">   // POST-CONSTRUCTION API (not exposed externally)</span>
<a href="#l85.3697"></a><span id="l85.3697"> </span>
<a href="#l85.3698"></a><span id="l85.3698">   /**</span>
<a href="#l85.3699"></a><span id="l85.3699">    * The HTTP version number of this, as a string (e.g. &quot;1.1&quot;).</span>
<a href="#l85.3700"></a><span id="l85.3700">    */</span>
<a href="#l85.3701"></a><span id="l85.3701" class="difflineminus">-  get httpVersion()</span>
<a href="#l85.3702"></a><span id="l85.3702" class="difflineminus">-  {</span>
<a href="#l85.3703"></a><span id="l85.3703" class="difflineplus">+  get httpVersion() {</span>
<a href="#l85.3704"></a><span id="l85.3704">     this._ensureAlive();</span>
<a href="#l85.3705"></a><span id="l85.3705">     return this._httpVersion.toString();</span>
<a href="#l85.3706"></a><span id="l85.3706">   },</span>
<a href="#l85.3707"></a><span id="l85.3707"> </span>
<a href="#l85.3708"></a><span id="l85.3708">   /**</span>
<a href="#l85.3709"></a><span id="l85.3709">    * The HTTP status code of this response, as a string of three characters per</span>
<a href="#l85.3710"></a><span id="l85.3710">    * RFC 2616.</span>
<a href="#l85.3711"></a><span id="l85.3711">    */</span>
<a href="#l85.3712"></a><span id="l85.3712" class="difflineminus">-  get httpCode()</span>
<a href="#l85.3713"></a><span id="l85.3713" class="difflineminus">-  {</span>
<a href="#l85.3714"></a><span id="l85.3714" class="difflineplus">+  get httpCode() {</span>
<a href="#l85.3715"></a><span id="l85.3715">     this._ensureAlive();</span>
<a href="#l85.3716"></a><span id="l85.3716"> </span>
<a href="#l85.3717"></a><span id="l85.3717">     var codeString = (this._httpCode &lt; 10 ? &quot;0&quot; : &quot;&quot;) +</span>
<a href="#l85.3718"></a><span id="l85.3718">                      (this._httpCode &lt; 100 ? &quot;0&quot; : &quot;&quot;) +</span>
<a href="#l85.3719"></a><span id="l85.3719">                      this._httpCode;</span>
<a href="#l85.3720"></a><span id="l85.3720">     return codeString;</span>
<a href="#l85.3721"></a><span id="l85.3721">   },</span>
<a href="#l85.3722"></a><span id="l85.3722"> </span>
<a href="#l85.3723"></a><span id="l85.3723">   /**</span>
<a href="#l85.3724"></a><span id="l85.3724">    * The description of the HTTP status code of this response, or &quot;&quot; if none is</span>
<a href="#l85.3725"></a><span id="l85.3725">    * set.</span>
<a href="#l85.3726"></a><span id="l85.3726">    */</span>
<a href="#l85.3727"></a><span id="l85.3727" class="difflineminus">-  get httpDescription()</span>
<a href="#l85.3728"></a><span id="l85.3728" class="difflineminus">-  {</span>
<a href="#l85.3729"></a><span id="l85.3729" class="difflineplus">+  get httpDescription() {</span>
<a href="#l85.3730"></a><span id="l85.3730">     this._ensureAlive();</span>
<a href="#l85.3731"></a><span id="l85.3731"> </span>
<a href="#l85.3732"></a><span id="l85.3732">     return this._httpDescription;</span>
<a href="#l85.3733"></a><span id="l85.3733">   },</span>
<a href="#l85.3734"></a><span id="l85.3734"> </span>
<a href="#l85.3735"></a><span id="l85.3735">   /**</span>
<a href="#l85.3736"></a><span id="l85.3736">    * The headers in this response, as an nsHttpHeaders object.</span>
<a href="#l85.3737"></a><span id="l85.3737">    */</span>
<a href="#l85.3738"></a><span id="l85.3738" class="difflineminus">-  get headers()</span>
<a href="#l85.3739"></a><span id="l85.3739" class="difflineminus">-  {</span>
<a href="#l85.3740"></a><span id="l85.3740" class="difflineplus">+  get headers() {</span>
<a href="#l85.3741"></a><span id="l85.3741">     this._ensureAlive();</span>
<a href="#l85.3742"></a><span id="l85.3742"> </span>
<a href="#l85.3743"></a><span id="l85.3743">     return this._headers;</span>
<a href="#l85.3744"></a><span id="l85.3744">   },</span>
<a href="#l85.3745"></a><span id="l85.3745"> </span>
<a href="#l85.3746"></a><span id="l85.3746">   //</span>
<a href="#l85.3747"></a><span id="l85.3747">   // see nsHttpHeaders.getHeader</span>
<a href="#l85.3748"></a><span id="l85.3748">   //</span>
<a href="#l85.3749"></a><span id="l85.3749" class="difflineminus">-  getHeader: function(name)</span>
<a href="#l85.3750"></a><span id="l85.3750" class="difflineminus">-  {</span>
<a href="#l85.3751"></a><span id="l85.3751" class="difflineplus">+  getHeader(name) {</span>
<a href="#l85.3752"></a><span id="l85.3752">     this._ensureAlive();</span>
<a href="#l85.3753"></a><span id="l85.3753"> </span>
<a href="#l85.3754"></a><span id="l85.3754">     return this._headers.getHeader(name);</span>
<a href="#l85.3755"></a><span id="l85.3755">   },</span>
<a href="#l85.3756"></a><span id="l85.3756"> </span>
<a href="#l85.3757"></a><span id="l85.3757">   /**</span>
<a href="#l85.3758"></a><span id="l85.3758">    * Determines whether this response may be abandoned in favor of a newly</span>
<a href="#l85.3759"></a><span id="l85.3759">    * constructed response.  A response may be abandoned only if it is not being</span>
<a href="#l85.3760"></a><span id="l85.3760">    * sent asynchronously and if raw control over it has not been taken from the</span>
<a href="#l85.3761"></a><span id="l85.3761">    * server.</span>
<a href="#l85.3762"></a><span id="l85.3762">    *</span>
<a href="#l85.3763"></a><span id="l85.3763">    * @returns boolean</span>
<a href="#l85.3764"></a><span id="l85.3764">    *   true iff no data has been written to the network</span>
<a href="#l85.3765"></a><span id="l85.3765">    */</span>
<a href="#l85.3766"></a><span id="l85.3766" class="difflineminus">-  partiallySent: function()</span>
<a href="#l85.3767"></a><span id="l85.3767" class="difflineminus">-  {</span>
<a href="#l85.3768"></a><span id="l85.3768" class="difflineplus">+  partiallySent() {</span>
<a href="#l85.3769"></a><span id="l85.3769">     dumpn(&quot;*** partiallySent()&quot;);</span>
<a href="#l85.3770"></a><span id="l85.3770">     return this._processAsync || this._powerSeized;</span>
<a href="#l85.3771"></a><span id="l85.3771">   },</span>
<a href="#l85.3772"></a><span id="l85.3772"> </span>
<a href="#l85.3773"></a><span id="l85.3773">   /**</span>
<a href="#l85.3774"></a><span id="l85.3774">    * If necessary, kicks off the remaining request processing needed to be done</span>
<a href="#l85.3775"></a><span id="l85.3775">    * after a request handler performs its initial work upon this response.</span>
<a href="#l85.3776"></a><span id="l85.3776">    */</span>
<a href="#l85.3777"></a><span id="l85.3777" class="difflineminus">-  complete: function()</span>
<a href="#l85.3778"></a><span id="l85.3778" class="difflineminus">-  {</span>
<a href="#l85.3779"></a><span id="l85.3779" class="difflineplus">+  complete() {</span>
<a href="#l85.3780"></a><span id="l85.3780">     dumpn(&quot;*** complete()&quot;);</span>
<a href="#l85.3781"></a><span id="l85.3781" class="difflineminus">-    if (this._processAsync || this._powerSeized)</span>
<a href="#l85.3782"></a><span id="l85.3782" class="difflineminus">-    {</span>
<a href="#l85.3783"></a><span id="l85.3783" class="difflineplus">+    if (this._processAsync || this._powerSeized) {</span>
<a href="#l85.3784"></a><span id="l85.3784">       NS_ASSERT(this._processAsync ^ this._powerSeized,</span>
<a href="#l85.3785"></a><span id="l85.3785">                 &quot;can't both send async and relinquish power&quot;);</span>
<a href="#l85.3786"></a><span id="l85.3786">       return;</span>
<a href="#l85.3787"></a><span id="l85.3787">     }</span>
<a href="#l85.3788"></a><span id="l85.3788"> </span>
<a href="#l85.3789"></a><span id="l85.3789">     NS_ASSERT(!this.partiallySent(), &quot;completing a partially-sent response?&quot;);</span>
<a href="#l85.3790"></a><span id="l85.3790"> </span>
<a href="#l85.3791"></a><span id="l85.3791">     this._startAsyncProcessor();</span>
<a href="#l85.3792"></a><span id="l85.3792" class="difflineat">@@ -3812,57 +3415,51 @@ Response.prototype =</span>
<a href="#l85.3793"></a><span id="l85.3793">    * might be expected to have been generated asynchronously or completely from</span>
<a href="#l85.3794"></a><span id="l85.3794">    * scratch by the handler), we stop processing this response and abruptly</span>
<a href="#l85.3795"></a><span id="l85.3795">    * close the connection.</span>
<a href="#l85.3796"></a><span id="l85.3796">    *</span>
<a href="#l85.3797"></a><span id="l85.3797">    * @param e : Error</span>
<a href="#l85.3798"></a><span id="l85.3798">    *   the exception which precipitated this abort, or null if no such exception</span>
<a href="#l85.3799"></a><span id="l85.3799">    *   was generated</span>
<a href="#l85.3800"></a><span id="l85.3800">    */</span>
<a href="#l85.3801"></a><span id="l85.3801" class="difflineminus">-  abort: function(e)</span>
<a href="#l85.3802"></a><span id="l85.3802" class="difflineminus">-  {</span>
<a href="#l85.3803"></a><span id="l85.3803" class="difflineplus">+  abort(e) {</span>
<a href="#l85.3804"></a><span id="l85.3804">     dumpn(&quot;*** abort(&lt;&quot; + e + &quot;&gt;)&quot;);</span>
<a href="#l85.3805"></a><span id="l85.3805"> </span>
<a href="#l85.3806"></a><span id="l85.3806">     // This response will be ended by the processor if one was created.</span>
<a href="#l85.3807"></a><span id="l85.3807">     var copier = this._asyncCopier;</span>
<a href="#l85.3808"></a><span id="l85.3808" class="difflineminus">-    if (copier)</span>
<a href="#l85.3809"></a><span id="l85.3809" class="difflineminus">-    {</span>
<a href="#l85.3810"></a><span id="l85.3810" class="difflineplus">+    if (copier) {</span>
<a href="#l85.3811"></a><span id="l85.3811">       // We dispatch asynchronously here so that any pending writes of data to</span>
<a href="#l85.3812"></a><span id="l85.3812">       // the connection will be deterministically written.  This makes it easier</span>
<a href="#l85.3813"></a><span id="l85.3813">       // to specify exact behavior, and it makes observable behavior more</span>
<a href="#l85.3814"></a><span id="l85.3814">       // predictable for clients.  Note that the correctness of this depends on</span>
<a href="#l85.3815"></a><span id="l85.3815">       // callbacks in response to _waitToReadData in WriteThroughCopier</span>
<a href="#l85.3816"></a><span id="l85.3816">       // happening asynchronously with respect to the actual writing of data to</span>
<a href="#l85.3817"></a><span id="l85.3817">       // bodyOutputStream, as they currently do; if they happened synchronously,</span>
<a href="#l85.3818"></a><span id="l85.3818">       // an event which ran before this one could write more data to the</span>
<a href="#l85.3819"></a><span id="l85.3819">       // response body before we get around to canceling the copier.  We have</span>
<a href="#l85.3820"></a><span id="l85.3820">       // tests for this in test_seizepower.js, however, and I can't think of a</span>
<a href="#l85.3821"></a><span id="l85.3821">       // way to handle both cases without removing bodyOutputStream access and</span>
<a href="#l85.3822"></a><span id="l85.3822">       // moving its effective write(data, length) method onto Response, which</span>
<a href="#l85.3823"></a><span id="l85.3823">       // would be slower and require more code than this anyway.</span>
<a href="#l85.3824"></a><span id="l85.3824" class="difflineminus">-      gThreadManager.currentThread.dispatch({</span>
<a href="#l85.3825"></a><span id="l85.3825" class="difflineminus">-        run: function()</span>
<a href="#l85.3826"></a><span id="l85.3826" class="difflineminus">-        {</span>
<a href="#l85.3827"></a><span id="l85.3827" class="difflineplus">+      Services.tm.currentThread.dispatch({</span>
<a href="#l85.3828"></a><span id="l85.3828" class="difflineplus">+        run() {</span>
<a href="#l85.3829"></a><span id="l85.3829">           dumpn(&quot;*** canceling copy asynchronously...&quot;);</span>
<a href="#l85.3830"></a><span id="l85.3830">           copier.cancel(Cr.NS_ERROR_UNEXPECTED);</span>
<a href="#l85.3831"></a><span id="l85.3831" class="difflineminus">-        }</span>
<a href="#l85.3832"></a><span id="l85.3832" class="difflineplus">+        },</span>
<a href="#l85.3833"></a><span id="l85.3833">       }, Ci.nsIThread.DISPATCH_NORMAL);</span>
<a href="#l85.3834"></a><span id="l85.3834" class="difflineminus">-    }</span>
<a href="#l85.3835"></a><span id="l85.3835" class="difflineminus">-    else</span>
<a href="#l85.3836"></a><span id="l85.3836" class="difflineminus">-    {</span>
<a href="#l85.3837"></a><span id="l85.3837" class="difflineplus">+    } else {</span>
<a href="#l85.3838"></a><span id="l85.3838">       this.end();</span>
<a href="#l85.3839"></a><span id="l85.3839">     }</span>
<a href="#l85.3840"></a><span id="l85.3840">   },</span>
<a href="#l85.3841"></a><span id="l85.3841"> </span>
<a href="#l85.3842"></a><span id="l85.3842">   /**</span>
<a href="#l85.3843"></a><span id="l85.3843">    * Closes this response's network connection, marks the response as finished,</span>
<a href="#l85.3844"></a><span id="l85.3844">    * and notifies the server handler that the request is done being processed.</span>
<a href="#l85.3845"></a><span id="l85.3845">    */</span>
<a href="#l85.3846"></a><span id="l85.3846" class="difflineminus">-  end: function()</span>
<a href="#l85.3847"></a><span id="l85.3847" class="difflineminus">-  {</span>
<a href="#l85.3848"></a><span id="l85.3848" class="difflineplus">+  end() {</span>
<a href="#l85.3849"></a><span id="l85.3849">     NS_ASSERT(!this._ended, &quot;ending this response twice?!?!&quot;);</span>
<a href="#l85.3850"></a><span id="l85.3850"> </span>
<a href="#l85.3851"></a><span id="l85.3851">     this._connection.close();</span>
<a href="#l85.3852"></a><span id="l85.3852">     if (this._bodyOutputStream)</span>
<a href="#l85.3853"></a><span id="l85.3853">       this._bodyOutputStream.close();</span>
<a href="#l85.3854"></a><span id="l85.3854"> </span>
<a href="#l85.3855"></a><span id="l85.3855">     this._finished = true;</span>
<a href="#l85.3856"></a><span id="l85.3856">     this._ended = true;</span>
<a href="#l85.3857"></a><span id="l85.3857" class="difflineat">@@ -3870,51 +3467,47 @@ Response.prototype =</span>
<a href="#l85.3858"></a><span id="l85.3858"> </span>
<a href="#l85.3859"></a><span id="l85.3859">   // PRIVATE IMPLEMENTATION</span>
<a href="#l85.3860"></a><span id="l85.3860"> </span>
<a href="#l85.3861"></a><span id="l85.3861">   /**</span>
<a href="#l85.3862"></a><span id="l85.3862">    * Sends the status line and headers of this response if they haven't been</span>
<a href="#l85.3863"></a><span id="l85.3863">    * sent and initiates the process of copying data written to this response's</span>
<a href="#l85.3864"></a><span id="l85.3864">    * body to the network.</span>
<a href="#l85.3865"></a><span id="l85.3865">    */</span>
<a href="#l85.3866"></a><span id="l85.3866" class="difflineminus">-  _startAsyncProcessor: function()</span>
<a href="#l85.3867"></a><span id="l85.3867" class="difflineminus">-  {</span>
<a href="#l85.3868"></a><span id="l85.3868" class="difflineplus">+  _startAsyncProcessor() {</span>
<a href="#l85.3869"></a><span id="l85.3869">     dumpn(&quot;*** _startAsyncProcessor()&quot;);</span>
<a href="#l85.3870"></a><span id="l85.3870"> </span>
<a href="#l85.3871"></a><span id="l85.3871">     // Handle cases where we're being called a second time.  The former case</span>
<a href="#l85.3872"></a><span id="l85.3872">     // happens when this is triggered both by complete() and by processAsync(),</span>
<a href="#l85.3873"></a><span id="l85.3873">     // while the latter happens when processAsync() in conjunction with sent</span>
<a href="#l85.3874"></a><span id="l85.3874">     // data causes abort() to be called.</span>
<a href="#l85.3875"></a><span id="l85.3875" class="difflineminus">-    if (this._asyncCopier || this._ended)</span>
<a href="#l85.3876"></a><span id="l85.3876" class="difflineminus">-    {</span>
<a href="#l85.3877"></a><span id="l85.3877" class="difflineplus">+    if (this._asyncCopier || this._ended) {</span>
<a href="#l85.3878"></a><span id="l85.3878">       dumpn(&quot;*** ignoring second call to _startAsyncProcessor&quot;);</span>
<a href="#l85.3879"></a><span id="l85.3879">       return;</span>
<a href="#l85.3880"></a><span id="l85.3880">     }</span>
<a href="#l85.3881"></a><span id="l85.3881"> </span>
<a href="#l85.3882"></a><span id="l85.3882">     // Send headers if they haven't been sent already and should be sent, then</span>
<a href="#l85.3883"></a><span id="l85.3883">     // asynchronously continue to send the body.</span>
<a href="#l85.3884"></a><span id="l85.3884" class="difflineminus">-    if (this._headers &amp;&amp; !this._powerSeized)</span>
<a href="#l85.3885"></a><span id="l85.3885" class="difflineminus">-    {</span>
<a href="#l85.3886"></a><span id="l85.3886" class="difflineplus">+    if (this._headers &amp;&amp; !this._powerSeized) {</span>
<a href="#l85.3887"></a><span id="l85.3887">       this._sendHeaders();</span>
<a href="#l85.3888"></a><span id="l85.3888">       return;</span>
<a href="#l85.3889"></a><span id="l85.3889">     }</span>
<a href="#l85.3890"></a><span id="l85.3890"> </span>
<a href="#l85.3891"></a><span id="l85.3891">     this._headers = null;</span>
<a href="#l85.3892"></a><span id="l85.3892">     this._sendBody();</span>
<a href="#l85.3893"></a><span id="l85.3893">   },</span>
<a href="#l85.3894"></a><span id="l85.3894"> </span>
<a href="#l85.3895"></a><span id="l85.3895">   /**</span>
<a href="#l85.3896"></a><span id="l85.3896">    * Signals that all modifications to the response status line and headers are</span>
<a href="#l85.3897"></a><span id="l85.3897">    * complete and then sends that data over the network to the client.  Once</span>
<a href="#l85.3898"></a><span id="l85.3898">    * this method completes, a different response to the request that resulted</span>
<a href="#l85.3899"></a><span id="l85.3899">    * in this response cannot be sent -- the only possible action in case of</span>
<a href="#l85.3900"></a><span id="l85.3900">    * error is to abort the response and close the connection.</span>
<a href="#l85.3901"></a><span id="l85.3901">    */</span>
<a href="#l85.3902"></a><span id="l85.3902" class="difflineminus">-  _sendHeaders: function()</span>
<a href="#l85.3903"></a><span id="l85.3903" class="difflineminus">-  {</span>
<a href="#l85.3904"></a><span id="l85.3904" class="difflineplus">+  _sendHeaders() {</span>
<a href="#l85.3905"></a><span id="l85.3905">     dumpn(&quot;*** _sendHeaders()&quot;);</span>
<a href="#l85.3906"></a><span id="l85.3906"> </span>
<a href="#l85.3907"></a><span id="l85.3907">     NS_ASSERT(this._headers);</span>
<a href="#l85.3908"></a><span id="l85.3908">     NS_ASSERT(!this._powerSeized);</span>
<a href="#l85.3909"></a><span id="l85.3909"> </span>
<a href="#l85.3910"></a><span id="l85.3910">     // request-line</span>
<a href="#l85.3911"></a><span id="l85.3911">     var statusLine = &quot;HTTP/&quot; + this.httpVersion + &quot; &quot; +</span>
<a href="#l85.3912"></a><span id="l85.3912">                      this.httpCode + &quot; &quot; +</span>
<a href="#l85.3913"></a><span id="l85.3913" class="difflineat">@@ -3929,18 +3522,17 @@ Response.prototype =</span>
<a href="#l85.3914"></a><span id="l85.3914">       headers.setHeader(&quot;Date&quot;, toDateString(Date.now()), false);</span>
<a href="#l85.3915"></a><span id="l85.3915"> </span>
<a href="#l85.3916"></a><span id="l85.3916">     // Any response not being processed asynchronously must have an associated</span>
<a href="#l85.3917"></a><span id="l85.3917">     // Content-Length header for reasons of backwards compatibility with the</span>
<a href="#l85.3918"></a><span id="l85.3918">     // initial server, which fully buffered every response before sending it.</span>
<a href="#l85.3919"></a><span id="l85.3919">     // Beyond that, however, it's good to do this anyway because otherwise it's</span>
<a href="#l85.3920"></a><span id="l85.3920">     // impossible to test behaviors that depend on the presence or absence of a</span>
<a href="#l85.3921"></a><span id="l85.3921">     // Content-Length header.</span>
<a href="#l85.3922"></a><span id="l85.3922" class="difflineminus">-    if (!this._processAsync)</span>
<a href="#l85.3923"></a><span id="l85.3923" class="difflineminus">-    {</span>
<a href="#l85.3924"></a><span id="l85.3924" class="difflineplus">+    if (!this._processAsync) {</span>
<a href="#l85.3925"></a><span id="l85.3925">       dumpn(&quot;*** non-async response, set Content-Length&quot;);</span>
<a href="#l85.3926"></a><span id="l85.3926"> </span>
<a href="#l85.3927"></a><span id="l85.3927">       var bodyStream = this._bodyInputStream;</span>
<a href="#l85.3928"></a><span id="l85.3928">       var avail = bodyStream ? bodyStream.available() : 0;</span>
<a href="#l85.3929"></a><span id="l85.3929"> </span>
<a href="#l85.3930"></a><span id="l85.3930">       // XXX assumes stream will always report the full amount of data available</span>
<a href="#l85.3931"></a><span id="l85.3931">       headers.setHeader(&quot;Content-Length&quot;, &quot;&quot; + avail, false);</span>
<a href="#l85.3932"></a><span id="l85.3932">     }</span>
<a href="#l85.3933"></a><span id="l85.3933" class="difflineat">@@ -3949,18 +3541,17 @@ Response.prototype =</span>
<a href="#l85.3934"></a><span id="l85.3934">     // construct and send response</span>
<a href="#l85.3935"></a><span id="l85.3935">     dumpn(&quot;*** header post-processing completed, sending response head...&quot;);</span>
<a href="#l85.3936"></a><span id="l85.3936"> </span>
<a href="#l85.3937"></a><span id="l85.3937">     // request-line</span>
<a href="#l85.3938"></a><span id="l85.3938">     var preambleData = [statusLine];</span>
<a href="#l85.3939"></a><span id="l85.3939"> </span>
<a href="#l85.3940"></a><span id="l85.3940">     // headers</span>
<a href="#l85.3941"></a><span id="l85.3941">     var headEnum = headers.enumerator;</span>
<a href="#l85.3942"></a><span id="l85.3942" class="difflineminus">-    while (headEnum.hasMoreElements())</span>
<a href="#l85.3943"></a><span id="l85.3943" class="difflineminus">-    {</span>
<a href="#l85.3944"></a><span id="l85.3944" class="difflineplus">+    while (headEnum.hasMoreElements()) {</span>
<a href="#l85.3945"></a><span id="l85.3945">       var fieldName = headEnum.getNext()</span>
<a href="#l85.3946"></a><span id="l85.3946">                               .QueryInterface(Ci.nsISupportsString)</span>
<a href="#l85.3947"></a><span id="l85.3947">                               .data;</span>
<a href="#l85.3948"></a><span id="l85.3948">       var values = headers.getHeaderValues(fieldName);</span>
<a href="#l85.3949"></a><span id="l85.3949">       for (var i = 0, sz = values.length; i &lt; sz; i++)</span>
<a href="#l85.3950"></a><span id="l85.3950">         preambleData.push(fieldName + &quot;: &quot; + values[i] + &quot;\r\n&quot;);</span>
<a href="#l85.3951"></a><span id="l85.3951">     }</span>
<a href="#l85.3952"></a><span id="l85.3952"> </span>
<a href="#l85.3953"></a><span id="l85.3953" class="difflineat">@@ -3968,136 +3559,117 @@ Response.prototype =</span>
<a href="#l85.3954"></a><span id="l85.3954">     preambleData.push(&quot;\r\n&quot;);</span>
<a href="#l85.3955"></a><span id="l85.3955"> </span>
<a href="#l85.3956"></a><span id="l85.3956">     var preamble = preambleData.join(&quot;&quot;);</span>
<a href="#l85.3957"></a><span id="l85.3957"> </span>
<a href="#l85.3958"></a><span id="l85.3958">     var responseHeadPipe = new Pipe(true, false, 0, PR_UINT32_MAX, null);</span>
<a href="#l85.3959"></a><span id="l85.3959">     responseHeadPipe.outputStream.write(preamble, preamble.length);</span>
<a href="#l85.3960"></a><span id="l85.3960"> </span>
<a href="#l85.3961"></a><span id="l85.3961">     var response = this;</span>
<a href="#l85.3962"></a><span id="l85.3962" class="difflineminus">-    var copyObserver =</span>
<a href="#l85.3963"></a><span id="l85.3963" class="difflineminus">-      {</span>
<a href="#l85.3964"></a><span id="l85.3964" class="difflineminus">-        onStartRequest: function(request, cx)</span>
<a href="#l85.3965"></a><span id="l85.3965" class="difflineminus">-        {</span>
<a href="#l85.3966"></a><span id="l85.3966" class="difflineplus">+    var copyObserver = {</span>
<a href="#l85.3967"></a><span id="l85.3967" class="difflineplus">+        onStartRequest(request, cx) {</span>
<a href="#l85.3968"></a><span id="l85.3968">           dumpn(&quot;*** preamble copying started&quot;);</span>
<a href="#l85.3969"></a><span id="l85.3969">         },</span>
<a href="#l85.3970"></a><span id="l85.3970"> </span>
<a href="#l85.3971"></a><span id="l85.3971" class="difflineminus">-        onStopRequest: function(request, cx, statusCode)</span>
<a href="#l85.3972"></a><span id="l85.3972" class="difflineminus">-        {</span>
<a href="#l85.3973"></a><span id="l85.3973" class="difflineplus">+        onStopRequest(request, cx, statusCode) {</span>
<a href="#l85.3974"></a><span id="l85.3974">           dumpn(&quot;*** preamble copying complete &quot; +</span>
<a href="#l85.3975"></a><span id="l85.3975">                 &quot;[status=0x&quot; + statusCode.toString(16) + &quot;]&quot;);</span>
<a href="#l85.3976"></a><span id="l85.3976"> </span>
<a href="#l85.3977"></a><span id="l85.3977" class="difflineminus">-          if (!Components.isSuccessCode(statusCode))</span>
<a href="#l85.3978"></a><span id="l85.3978" class="difflineminus">-          {</span>
<a href="#l85.3979"></a><span id="l85.3979" class="difflineplus">+          if (!Components.isSuccessCode(statusCode)) {</span>
<a href="#l85.3980"></a><span id="l85.3980">             dumpn(&quot;!!! header copying problems: non-success statusCode, &quot; +</span>
<a href="#l85.3981"></a><span id="l85.3981">                   &quot;ending response&quot;);</span>
<a href="#l85.3982"></a><span id="l85.3982"> </span>
<a href="#l85.3983"></a><span id="l85.3983">             response.end();</span>
<a href="#l85.3984"></a><span id="l85.3984" class="difflineminus">-          }</span>
<a href="#l85.3985"></a><span id="l85.3985" class="difflineminus">-          else</span>
<a href="#l85.3986"></a><span id="l85.3986" class="difflineminus">-          {</span>
<a href="#l85.3987"></a><span id="l85.3987" class="difflineplus">+          } else {</span>
<a href="#l85.3988"></a><span id="l85.3988">             response._sendBody();</span>
<a href="#l85.3989"></a><span id="l85.3989">           }</span>
<a href="#l85.3990"></a><span id="l85.3990">         },</span>
<a href="#l85.3991"></a><span id="l85.3991"> </span>
<a href="#l85.3992"></a><span id="l85.3992">         QueryInterface: ChromeUtils.generateQI([&quot;nsIRequestObserver&quot;]),</span>
<a href="#l85.3993"></a><span id="l85.3993">       };</span>
<a href="#l85.3994"></a><span id="l85.3994"> </span>
<a href="#l85.3995"></a><span id="l85.3995" class="difflineminus">-    var headerCopier = this._asyncCopier =</span>
<a href="#l85.3996"></a><span id="l85.3996" class="difflineminus">-      new WriteThroughCopier(responseHeadPipe.inputStream,</span>
<a href="#l85.3997"></a><span id="l85.3997" class="difflineminus">-                             this._connection.output,</span>
<a href="#l85.3998"></a><span id="l85.3998" class="difflineminus">-                             copyObserver, null);</span>
<a href="#l85.3999"></a><span id="l85.3999" class="difflineplus">+    this._asyncCopier = new WriteThroughCopier(responseHeadPipe.inputStream,</span>
<a href="#l85.4000"></a><span id="l85.4000" class="difflineplus">+                                               this._connection.output,</span>
<a href="#l85.4001"></a><span id="l85.4001" class="difflineplus">+                                               copyObserver, null);</span>
<a href="#l85.4002"></a><span id="l85.4002"> </span>
<a href="#l85.4003"></a><span id="l85.4003">     responseHeadPipe.outputStream.close();</span>
<a href="#l85.4004"></a><span id="l85.4004"> </span>
<a href="#l85.4005"></a><span id="l85.4005">     // Forbid setting any more headers or modifying the request line.</span>
<a href="#l85.4006"></a><span id="l85.4006">     this._headers = null;</span>
<a href="#l85.4007"></a><span id="l85.4007">   },</span>
<a href="#l85.4008"></a><span id="l85.4008"> </span>
<a href="#l85.4009"></a><span id="l85.4009">   /**</span>
<a href="#l85.4010"></a><span id="l85.4010">    * Asynchronously writes the body of the response (or the entire response, if</span>
<a href="#l85.4011"></a><span id="l85.4011">    * seizePower() has been called) to the network.</span>
<a href="#l85.4012"></a><span id="l85.4012">    */</span>
<a href="#l85.4013"></a><span id="l85.4013" class="difflineminus">-  _sendBody: function()</span>
<a href="#l85.4014"></a><span id="l85.4014" class="difflineminus">-  {</span>
<a href="#l85.4015"></a><span id="l85.4015" class="difflineplus">+  _sendBody() {</span>
<a href="#l85.4016"></a><span id="l85.4016">     dumpn(&quot;*** _sendBody&quot;);</span>
<a href="#l85.4017"></a><span id="l85.4017"> </span>
<a href="#l85.4018"></a><span id="l85.4018">     NS_ASSERT(!this._headers, &quot;still have headers around but sending body?&quot;);</span>
<a href="#l85.4019"></a><span id="l85.4019"> </span>
<a href="#l85.4020"></a><span id="l85.4020">     // If no body data was written, we're done</span>
<a href="#l85.4021"></a><span id="l85.4021" class="difflineminus">-    if (!this._bodyInputStream)</span>
<a href="#l85.4022"></a><span id="l85.4022" class="difflineminus">-    {</span>
<a href="#l85.4023"></a><span id="l85.4023" class="difflineplus">+    if (!this._bodyInputStream) {</span>
<a href="#l85.4024"></a><span id="l85.4024">       dumpn(&quot;*** empty body, response finished&quot;);</span>
<a href="#l85.4025"></a><span id="l85.4025">       this.end();</span>
<a href="#l85.4026"></a><span id="l85.4026">       return;</span>
<a href="#l85.4027"></a><span id="l85.4027">     }</span>
<a href="#l85.4028"></a><span id="l85.4028"> </span>
<a href="#l85.4029"></a><span id="l85.4029">     var response = this;</span>
<a href="#l85.4030"></a><span id="l85.4030" class="difflineminus">-    var copyObserver =</span>
<a href="#l85.4031"></a><span id="l85.4031" class="difflineminus">-      {</span>
<a href="#l85.4032"></a><span id="l85.4032" class="difflineminus">-        onStartRequest: function(request, context)</span>
<a href="#l85.4033"></a><span id="l85.4033" class="difflineminus">-        {</span>
<a href="#l85.4034"></a><span id="l85.4034" class="difflineplus">+    var copyObserver = {</span>
<a href="#l85.4035"></a><span id="l85.4035" class="difflineplus">+        onStartRequest(request, context) {</span>
<a href="#l85.4036"></a><span id="l85.4036">           dumpn(&quot;*** onStartRequest&quot;);</span>
<a href="#l85.4037"></a><span id="l85.4037">         },</span>
<a href="#l85.4038"></a><span id="l85.4038"> </span>
<a href="#l85.4039"></a><span id="l85.4039" class="difflineminus">-        onStopRequest: function(request, cx, statusCode)</span>
<a href="#l85.4040"></a><span id="l85.4040" class="difflineminus">-        {</span>
<a href="#l85.4041"></a><span id="l85.4041" class="difflineplus">+        onStopRequest(request, cx, statusCode) {</span>
<a href="#l85.4042"></a><span id="l85.4042">           dumpn(&quot;*** onStopRequest [status=0x&quot; + statusCode.toString(16) + &quot;]&quot;);</span>
<a href="#l85.4043"></a><span id="l85.4043"> </span>
<a href="#l85.4044"></a><span id="l85.4044" class="difflineminus">-          if (statusCode === Cr.NS_BINDING_ABORTED)</span>
<a href="#l85.4045"></a><span id="l85.4045" class="difflineminus">-          {</span>
<a href="#l85.4046"></a><span id="l85.4046" class="difflineplus">+          if (statusCode === Cr.NS_BINDING_ABORTED) {</span>
<a href="#l85.4047"></a><span id="l85.4047">             dumpn(&quot;*** terminating copy observer without ending the response&quot;);</span>
<a href="#l85.4048"></a><span id="l85.4048" class="difflineminus">-          }</span>
<a href="#l85.4049"></a><span id="l85.4049" class="difflineminus">-          else</span>
<a href="#l85.4050"></a><span id="l85.4050" class="difflineminus">-          {</span>
<a href="#l85.4051"></a><span id="l85.4051" class="difflineplus">+          } else {</span>
<a href="#l85.4052"></a><span id="l85.4052">             if (!Components.isSuccessCode(statusCode))</span>
<a href="#l85.4053"></a><span id="l85.4053">               dumpn(&quot;*** WARNING: non-success statusCode in onStopRequest&quot;);</span>
<a href="#l85.4054"></a><span id="l85.4054"> </span>
<a href="#l85.4055"></a><span id="l85.4055">             response.end();</span>
<a href="#l85.4056"></a><span id="l85.4056">           }</span>
<a href="#l85.4057"></a><span id="l85.4057">         },</span>
<a href="#l85.4058"></a><span id="l85.4058"> </span>
<a href="#l85.4059"></a><span id="l85.4059">         QueryInterface: ChromeUtils.generateQI([&quot;nsIRequestObserver&quot;]),</span>
<a href="#l85.4060"></a><span id="l85.4060">       };</span>
<a href="#l85.4061"></a><span id="l85.4061"> </span>
<a href="#l85.4062"></a><span id="l85.4062">     dumpn(&quot;*** starting async copier of body data...&quot;);</span>
<a href="#l85.4063"></a><span id="l85.4063">     this._asyncCopier =</span>
<a href="#l85.4064"></a><span id="l85.4064">       new WriteThroughCopier(this._bodyInputStream, this._connection.output,</span>
<a href="#l85.4065"></a><span id="l85.4065" class="difflineminus">-                            copyObserver, null);</span>
<a href="#l85.4066"></a><span id="l85.4066" class="difflineplus">+                             copyObserver, null);</span>
<a href="#l85.4067"></a><span id="l85.4067">   },</span>
<a href="#l85.4068"></a><span id="l85.4068"> </span>
<a href="#l85.4069"></a><span id="l85.4069">   /** Ensures that this hasn't been ended. */</span>
<a href="#l85.4070"></a><span id="l85.4070" class="difflineminus">-  _ensureAlive: function()</span>
<a href="#l85.4071"></a><span id="l85.4071" class="difflineminus">-  {</span>
<a href="#l85.4072"></a><span id="l85.4072" class="difflineplus">+  _ensureAlive() {</span>
<a href="#l85.4073"></a><span id="l85.4073">     NS_ASSERT(!this._ended, &quot;not handling response lifetime correctly&quot;);</span>
<a href="#l85.4074"></a><span id="l85.4074" class="difflineminus">-  }</span>
<a href="#l85.4075"></a><span id="l85.4075" class="difflineplus">+  },</span>
<a href="#l85.4076"></a><span id="l85.4076"> };</span>
<a href="#l85.4077"></a><span id="l85.4077"> </span>
<a href="#l85.4078"></a><span id="l85.4078"> /**</span>
<a href="#l85.4079"></a><span id="l85.4079">  * Size of the segments in the buffer used in storing response data and writing</span>
<a href="#l85.4080"></a><span id="l85.4080">  * it to the socket.</span>
<a href="#l85.4081"></a><span id="l85.4081">  */</span>
<a href="#l85.4082"></a><span id="l85.4082"> Response.SEGMENT_SIZE = 8192;</span>
<a href="#l85.4083"></a><span id="l85.4083"> </span>
<a href="#l85.4084"></a><span id="l85.4084"> /** Serves double duty in WriteThroughCopier implementation. */</span>
<a href="#l85.4085"></a><span id="l85.4085" class="difflineminus">-function notImplemented()</span>
<a href="#l85.4086"></a><span id="l85.4086" class="difflineminus">-{</span>
<a href="#l85.4087"></a><span id="l85.4087" class="difflineplus">+function notImplemented() {</span>
<a href="#l85.4088"></a><span id="l85.4088">   throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l85.4089"></a><span id="l85.4089"> }</span>
<a href="#l85.4090"></a><span id="l85.4090"> </span>
<a href="#l85.4091"></a><span id="l85.4091"> /** Returns true iff the given exception represents stream closure. */</span>
<a href="#l85.4092"></a><span id="l85.4092" class="difflineminus">-function streamClosed(e)</span>
<a href="#l85.4093"></a><span id="l85.4093" class="difflineminus">-{</span>
<a href="#l85.4094"></a><span id="l85.4094" class="difflineplus">+function streamClosed(e) {</span>
<a href="#l85.4095"></a><span id="l85.4095">   return e === Cr.NS_BASE_STREAM_CLOSED ||</span>
<a href="#l85.4096"></a><span id="l85.4096">          (typeof e === &quot;object&quot; &amp;&amp; e.result === Cr.NS_BASE_STREAM_CLOSED);</span>
<a href="#l85.4097"></a><span id="l85.4097"> }</span>
<a href="#l85.4098"></a><span id="l85.4098"> </span>
<a href="#l85.4099"></a><span id="l85.4099"> /** Returns true iff the given exception represents a blocked stream. */</span>
<a href="#l85.4100"></a><span id="l85.4100" class="difflineminus">-function wouldBlock(e)</span>
<a href="#l85.4101"></a><span id="l85.4101" class="difflineminus">-{</span>
<a href="#l85.4102"></a><span id="l85.4102" class="difflineplus">+function wouldBlock(e) {</span>
<a href="#l85.4103"></a><span id="l85.4103">   return e === Cr.NS_BASE_STREAM_WOULD_BLOCK ||</span>
<a href="#l85.4104"></a><span id="l85.4104">          (typeof e === &quot;object&quot; &amp;&amp; e.result === Cr.NS_BASE_STREAM_WOULD_BLOCK);</span>
<a href="#l85.4105"></a><span id="l85.4105"> }</span>
<a href="#l85.4106"></a><span id="l85.4106"> </span>
<a href="#l85.4107"></a><span id="l85.4107"> /**</span>
<a href="#l85.4108"></a><span id="l85.4108">  * Copies data from source to sink as it becomes available, when that data can</span>
<a href="#l85.4109"></a><span id="l85.4109">  * be written to sink without blocking.</span>
<a href="#l85.4110"></a><span id="l85.4110">  *</span>
<a href="#l85.4111"></a><span id="l85.4111" class="difflineat">@@ -4107,18 +3679,17 @@ function wouldBlock(e)</span>
<a href="#l85.4112"></a><span id="l85.4112">  *   the stream to which data is to be copied</span>
<a href="#l85.4113"></a><span id="l85.4113">  * @param observer : nsIRequestObserver</span>
<a href="#l85.4114"></a><span id="l85.4114">  *   an observer which will be notified when the copy starts and finishes</span>
<a href="#l85.4115"></a><span id="l85.4115">  * @param context : nsISupports</span>
<a href="#l85.4116"></a><span id="l85.4116">  *   context passed to observer when notified of start/stop</span>
<a href="#l85.4117"></a><span id="l85.4117">  * @throws NS_ERROR_NULL_POINTER</span>
<a href="#l85.4118"></a><span id="l85.4118">  *   if source, sink, or observer are null</span>
<a href="#l85.4119"></a><span id="l85.4119">  */</span>
<a href="#l85.4120"></a><span id="l85.4120" class="difflineminus">-function WriteThroughCopier(source, sink, observer, context)</span>
<a href="#l85.4121"></a><span id="l85.4121" class="difflineminus">-{</span>
<a href="#l85.4122"></a><span id="l85.4122" class="difflineplus">+function WriteThroughCopier(source, sink, observer, context) {</span>
<a href="#l85.4123"></a><span id="l85.4123">   if (!source || !sink || !observer)</span>
<a href="#l85.4124"></a><span id="l85.4124">     throw Cr.NS_ERROR_NULL_POINTER;</span>
<a href="#l85.4125"></a><span id="l85.4125"> </span>
<a href="#l85.4126"></a><span id="l85.4126">   /** Stream from which data is being read. */</span>
<a href="#l85.4127"></a><span id="l85.4127">   this._source = source;</span>
<a href="#l85.4128"></a><span id="l85.4128"> </span>
<a href="#l85.4129"></a><span id="l85.4129">   /** Stream to which data is being written. */</span>
<a href="#l85.4130"></a><span id="l85.4130">   this._sink = sink;</span>
<a href="#l85.4131"></a><span id="l85.4131" class="difflineat">@@ -4150,50 +3721,45 @@ function WriteThroughCopier(source, sink</span>
<a href="#l85.4132"></a><span id="l85.4132"> </span>
<a href="#l85.4133"></a><span id="l85.4133">   /** Status of this request. */</span>
<a href="#l85.4134"></a><span id="l85.4134">   this.status = Cr.NS_OK;</span>
<a href="#l85.4135"></a><span id="l85.4135"> </span>
<a href="#l85.4136"></a><span id="l85.4136">   /** Arrays of byte strings waiting to be written to output. */</span>
<a href="#l85.4137"></a><span id="l85.4137">   this._pendingData = [];</span>
<a href="#l85.4138"></a><span id="l85.4138"> </span>
<a href="#l85.4139"></a><span id="l85.4139">   // start copying</span>
<a href="#l85.4140"></a><span id="l85.4140" class="difflineminus">-  try</span>
<a href="#l85.4141"></a><span id="l85.4141" class="difflineminus">-  {</span>
<a href="#l85.4142"></a><span id="l85.4142" class="difflineplus">+  try {</span>
<a href="#l85.4143"></a><span id="l85.4143">     observer.onStartRequest(this, context);</span>
<a href="#l85.4144"></a><span id="l85.4144">     this._waitToReadData();</span>
<a href="#l85.4145"></a><span id="l85.4145">     this._waitForSinkClosure();</span>
<a href="#l85.4146"></a><span id="l85.4146" class="difflineminus">-  }</span>
<a href="#l85.4147"></a><span id="l85.4147" class="difflineminus">-  catch (e)</span>
<a href="#l85.4148"></a><span id="l85.4148" class="difflineminus">-  {</span>
<a href="#l85.4149"></a><span id="l85.4149" class="difflineplus">+  } catch (e) {</span>
<a href="#l85.4150"></a><span id="l85.4150">     dumpn(&quot;!!! error starting copy: &quot; + e +</span>
<a href="#l85.4151"></a><span id="l85.4151">           (&quot;lineNumber&quot; in e ? &quot;, line &quot; + e.lineNumber : &quot;&quot;));</span>
<a href="#l85.4152"></a><span id="l85.4152">     dumpn(e.stack);</span>
<a href="#l85.4153"></a><span id="l85.4153">     this.cancel(Cr.NS_ERROR_UNEXPECTED);</span>
<a href="#l85.4154"></a><span id="l85.4154">   }</span>
<a href="#l85.4155"></a><span id="l85.4155"> }</span>
<a href="#l85.4156"></a><span id="l85.4156" class="difflineminus">-WriteThroughCopier.prototype =</span>
<a href="#l85.4157"></a><span id="l85.4157" class="difflineminus">-{</span>
<a href="#l85.4158"></a><span id="l85.4158" class="difflineplus">+WriteThroughCopier.prototype = {</span>
<a href="#l85.4159"></a><span id="l85.4159">   /* nsISupports implementation */</span>
<a href="#l85.4160"></a><span id="l85.4160"> </span>
<a href="#l85.4161"></a><span id="l85.4161">   QueryInterface: ChromeUtils.generateQI([&quot;nsIInputStreamCallback&quot;,</span>
<a href="#l85.4162"></a><span id="l85.4162">                                           &quot;nsIOutputStreamCallback&quot;,</span>
<a href="#l85.4163"></a><span id="l85.4163">                                           &quot;nsIRequest&quot;]),</span>
<a href="#l85.4164"></a><span id="l85.4164"> </span>
<a href="#l85.4165"></a><span id="l85.4165"> </span>
<a href="#l85.4166"></a><span id="l85.4166">   // NSIINPUTSTREAMCALLBACK</span>
<a href="#l85.4167"></a><span id="l85.4167"> </span>
<a href="#l85.4168"></a><span id="l85.4168">   /**</span>
<a href="#l85.4169"></a><span id="l85.4169">    * Receives a more-data-in-input notification and writes the corresponding</span>
<a href="#l85.4170"></a><span id="l85.4170">    * data to the output.</span>
<a href="#l85.4171"></a><span id="l85.4171">    *</span>
<a href="#l85.4172"></a><span id="l85.4172">    * @param input : nsIAsyncInputStream</span>
<a href="#l85.4173"></a><span id="l85.4173">    *   the input stream on whose data we have been waiting</span>
<a href="#l85.4174"></a><span id="l85.4174">    */</span>
<a href="#l85.4175"></a><span id="l85.4175" class="difflineminus">-  onInputStreamReady: function(input)</span>
<a href="#l85.4176"></a><span id="l85.4176" class="difflineminus">-  {</span>
<a href="#l85.4177"></a><span id="l85.4177" class="difflineplus">+  onInputStreamReady(input) {</span>
<a href="#l85.4178"></a><span id="l85.4178">     if (this._source === null)</span>
<a href="#l85.4179"></a><span id="l85.4179">       return;</span>
<a href="#l85.4180"></a><span id="l85.4180"> </span>
<a href="#l85.4181"></a><span id="l85.4181">     dumpn(&quot;*** onInputStreamReady&quot;);</span>
<a href="#l85.4182"></a><span id="l85.4182"> </span>
<a href="#l85.4183"></a><span id="l85.4183">     //</span>
<a href="#l85.4184"></a><span id="l85.4184">     // Ordinarily we'll read a non-zero amount of data from input, queue it up</span>
<a href="#l85.4185"></a><span id="l85.4185">     // to be written and then wait for further callbacks.  The complications in</span>
<a href="#l85.4186"></a><span id="l85.4186" class="difflineat">@@ -4212,125 +3778,109 @@ WriteThroughCopier.prototype =</span>
<a href="#l85.4187"></a><span id="l85.4187">     //     rather than with NS_OK.</span>
<a href="#l85.4188"></a><span id="l85.4188">     //   Some other exception is thrown</span>
<a href="#l85.4189"></a><span id="l85.4189">     //     This is the least kind result.  We don't know what happened, so we</span>
<a href="#l85.4190"></a><span id="l85.4190">     //     act as though the stream closed except that we notify of completion</span>
<a href="#l85.4191"></a><span id="l85.4191">     //     with the result NS_ERROR_UNEXPECTED.</span>
<a href="#l85.4192"></a><span id="l85.4192">     //</span>
<a href="#l85.4193"></a><span id="l85.4193"> </span>
<a href="#l85.4194"></a><span id="l85.4194">     var bytesWanted = 0, bytesConsumed = -1;</span>
<a href="#l85.4195"></a><span id="l85.4195" class="difflineminus">-    try</span>
<a href="#l85.4196"></a><span id="l85.4196" class="difflineminus">-    {</span>
<a href="#l85.4197"></a><span id="l85.4197" class="difflineplus">+    try {</span>
<a href="#l85.4198"></a><span id="l85.4198">       input = new BinaryInputStream(input);</span>
<a href="#l85.4199"></a><span id="l85.4199"> </span>
<a href="#l85.4200"></a><span id="l85.4200">       bytesWanted = Math.min(input.available(), Response.SEGMENT_SIZE);</span>
<a href="#l85.4201"></a><span id="l85.4201">       dumpn(&quot;*** input wanted: &quot; + bytesWanted);</span>
<a href="#l85.4202"></a><span id="l85.4202"> </span>
<a href="#l85.4203"></a><span id="l85.4203" class="difflineminus">-      if (bytesWanted &gt; 0)</span>
<a href="#l85.4204"></a><span id="l85.4204" class="difflineminus">-      {</span>
<a href="#l85.4205"></a><span id="l85.4205" class="difflineplus">+      if (bytesWanted &gt; 0) {</span>
<a href="#l85.4206"></a><span id="l85.4206">         var data = input.readByteArray(bytesWanted);</span>
<a href="#l85.4207"></a><span id="l85.4207">         bytesConsumed = data.length;</span>
<a href="#l85.4208"></a><span id="l85.4208">         this._pendingData.push(String.fromCharCode.apply(String, data));</span>
<a href="#l85.4209"></a><span id="l85.4209">       }</span>
<a href="#l85.4210"></a><span id="l85.4210"> </span>
<a href="#l85.4211"></a><span id="l85.4211">       dumpn(&quot;*** &quot; + bytesConsumed + &quot; bytes read&quot;);</span>
<a href="#l85.4212"></a><span id="l85.4212"> </span>
<a href="#l85.4213"></a><span id="l85.4213">       // Handle the zero-data edge case in the same place as all other edge</span>
<a href="#l85.4214"></a><span id="l85.4214">       // cases are handled.</span>
<a href="#l85.4215"></a><span id="l85.4215">       if (bytesWanted === 0)</span>
<a href="#l85.4216"></a><span id="l85.4216">         throw Cr.NS_BASE_STREAM_CLOSED;</span>
<a href="#l85.4217"></a><span id="l85.4217" class="difflineminus">-    }</span>
<a href="#l85.4218"></a><span id="l85.4218" class="difflineminus">-    catch (e)</span>
<a href="#l85.4219"></a><span id="l85.4219" class="difflineminus">-    {</span>
<a href="#l85.4220"></a><span id="l85.4220" class="difflineminus">-      if (streamClosed(e))</span>
<a href="#l85.4221"></a><span id="l85.4221" class="difflineminus">-      {</span>
<a href="#l85.4222"></a><span id="l85.4222" class="difflineplus">+    } catch (e) {</span>
<a href="#l85.4223"></a><span id="l85.4223" class="difflineplus">+      let ex = e;</span>
<a href="#l85.4224"></a><span id="l85.4224" class="difflineplus">+      if (streamClosed(e)) {</span>
<a href="#l85.4225"></a><span id="l85.4225">         dumpn(&quot;*** input stream closed&quot;);</span>
<a href="#l85.4226"></a><span id="l85.4226" class="difflineminus">-        e = bytesWanted === 0 ? Cr.NS_OK : Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l85.4227"></a><span id="l85.4227" class="difflineplus">+        ex = bytesWanted === 0 ? Cr.NS_OK : Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l85.4228"></a><span id="l85.4228" class="difflineplus">+      } else {</span>
<a href="#l85.4229"></a><span id="l85.4229" class="difflineplus">+        dumpn(&quot;!!! unexpected error reading from input, canceling: &quot; + e);</span>
<a href="#l85.4230"></a><span id="l85.4230" class="difflineplus">+        ex = Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l85.4231"></a><span id="l85.4231">       }</span>
<a href="#l85.4232"></a><span id="l85.4232" class="difflineminus">-      else</span>
<a href="#l85.4233"></a><span id="l85.4233" class="difflineminus">-      {</span>
<a href="#l85.4234"></a><span id="l85.4234" class="difflineminus">-        dumpn(&quot;!!! unexpected error reading from input, canceling: &quot; + e);</span>
<a href="#l85.4235"></a><span id="l85.4235" class="difflineminus">-        e = Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l85.4236"></a><span id="l85.4236" class="difflineminus">-      }</span>
<a href="#l85.4237"></a><span id="l85.4237" class="difflineminus">-</span>
<a href="#l85.4238"></a><span id="l85.4238" class="difflineminus">-      this._doneReadingSource(e);</span>
<a href="#l85.4239"></a><span id="l85.4239" class="difflineplus">+</span>
<a href="#l85.4240"></a><span id="l85.4240" class="difflineplus">+      this._doneReadingSource(ex);</span>
<a href="#l85.4241"></a><span id="l85.4241">       return;</span>
<a href="#l85.4242"></a><span id="l85.4242">     }</span>
<a href="#l85.4243"></a><span id="l85.4243"> </span>
<a href="#l85.4244"></a><span id="l85.4244">     var pendingData = this._pendingData;</span>
<a href="#l85.4245"></a><span id="l85.4245"> </span>
<a href="#l85.4246"></a><span id="l85.4246">     NS_ASSERT(bytesConsumed &gt; 0);</span>
<a href="#l85.4247"></a><span id="l85.4247">     NS_ASSERT(pendingData.length &gt; 0, &quot;no pending data somehow?&quot;);</span>
<a href="#l85.4248"></a><span id="l85.4248" class="difflineminus">-    NS_ASSERT(pendingData[pendingData.length - 1].length &gt; 0,</span>
<a href="#l85.4249"></a><span id="l85.4249" class="difflineminus">-              &quot;buffered zero bytes of data?&quot;);</span>
<a href="#l85.4250"></a><span id="l85.4250" class="difflineplus">+    NS_ASSERT(pendingData[pendingData.length - 1].length &gt; 0, &quot;buffered zero bytes of data?&quot;);</span>
<a href="#l85.4251"></a><span id="l85.4251"> </span>
<a href="#l85.4252"></a><span id="l85.4252">     NS_ASSERT(this._source !== null);</span>
<a href="#l85.4253"></a><span id="l85.4253"> </span>
<a href="#l85.4254"></a><span id="l85.4254">     // Reading has gone great, and we've gotten data to write now.  What if we</span>
<a href="#l85.4255"></a><span id="l85.4255">     // don't have a place to write that data, because output went away just</span>
<a href="#l85.4256"></a><span id="l85.4256">     // before this read?  Drop everything on the floor, including new data, and</span>
<a href="#l85.4257"></a><span id="l85.4257">     // cancel at this point.</span>
<a href="#l85.4258"></a><span id="l85.4258" class="difflineminus">-    if (this._sink === null)</span>
<a href="#l85.4259"></a><span id="l85.4259" class="difflineminus">-    {</span>
<a href="#l85.4260"></a><span id="l85.4260" class="difflineplus">+    if (this._sink === null) {</span>
<a href="#l85.4261"></a><span id="l85.4261">       pendingData.length = 0;</span>
<a href="#l85.4262"></a><span id="l85.4262">       this._doneReadingSource(Cr.NS_ERROR_UNEXPECTED);</span>
<a href="#l85.4263"></a><span id="l85.4263">       return;</span>
<a href="#l85.4264"></a><span id="l85.4264">     }</span>
<a href="#l85.4265"></a><span id="l85.4265"> </span>
<a href="#l85.4266"></a><span id="l85.4266">     // Okay, we've read the data, and we know we have a place to write it.  We</span>
<a href="#l85.4267"></a><span id="l85.4267">     // need to queue up the data to be written, but *only* if none is queued</span>
<a href="#l85.4268"></a><span id="l85.4268">     // already -- if data's already queued, the code that actually writes the</span>
<a href="#l85.4269"></a><span id="l85.4269">     // data will make sure to wait on unconsumed pending data.</span>
<a href="#l85.4270"></a><span id="l85.4270" class="difflineminus">-    try</span>
<a href="#l85.4271"></a><span id="l85.4271" class="difflineminus">-    {</span>
<a href="#l85.4272"></a><span id="l85.4272" class="difflineplus">+    try {</span>
<a href="#l85.4273"></a><span id="l85.4273">       if (pendingData.length === 1)</span>
<a href="#l85.4274"></a><span id="l85.4274">         this._waitToWriteData();</span>
<a href="#l85.4275"></a><span id="l85.4275" class="difflineminus">-    }</span>
<a href="#l85.4276"></a><span id="l85.4276" class="difflineminus">-    catch (e)</span>
<a href="#l85.4277"></a><span id="l85.4277" class="difflineminus">-    {</span>
<a href="#l85.4278"></a><span id="l85.4278" class="difflineplus">+    } catch (e) {</span>
<a href="#l85.4279"></a><span id="l85.4279">       dumpn(&quot;!!! error waiting to write data just read, swallowing and &quot; +</span>
<a href="#l85.4280"></a><span id="l85.4280">             &quot;writing only what we already have: &quot; + e);</span>
<a href="#l85.4281"></a><span id="l85.4281">       this._doneWritingToSink(Cr.NS_ERROR_UNEXPECTED);</span>
<a href="#l85.4282"></a><span id="l85.4282">       return;</span>
<a href="#l85.4283"></a><span id="l85.4283">     }</span>
<a href="#l85.4284"></a><span id="l85.4284"> </span>
<a href="#l85.4285"></a><span id="l85.4285">     // Whee!  We successfully read some data, and it's successfully queued up to</span>
<a href="#l85.4286"></a><span id="l85.4286">     // be written.  All that remains now is to wait for more data to read.</span>
<a href="#l85.4287"></a><span id="l85.4287" class="difflineminus">-    try</span>
<a href="#l85.4288"></a><span id="l85.4288" class="difflineminus">-    {</span>
<a href="#l85.4289"></a><span id="l85.4289" class="difflineplus">+    try {</span>
<a href="#l85.4290"></a><span id="l85.4290">       this._waitToReadData();</span>
<a href="#l85.4291"></a><span id="l85.4291" class="difflineminus">-    }</span>
<a href="#l85.4292"></a><span id="l85.4292" class="difflineminus">-    catch (e)</span>
<a href="#l85.4293"></a><span id="l85.4293" class="difflineminus">-    {</span>
<a href="#l85.4294"></a><span id="l85.4294" class="difflineplus">+    } catch (e) {</span>
<a href="#l85.4295"></a><span id="l85.4295">       dumpn(&quot;!!! error waiting to read more data: &quot; + e);</span>
<a href="#l85.4296"></a><span id="l85.4296">       this._doneReadingSource(Cr.NS_ERROR_UNEXPECTED);</span>
<a href="#l85.4297"></a><span id="l85.4297">     }</span>
<a href="#l85.4298"></a><span id="l85.4298">   },</span>
<a href="#l85.4299"></a><span id="l85.4299"> </span>
<a href="#l85.4300"></a><span id="l85.4300"> </span>
<a href="#l85.4301"></a><span id="l85.4301">   // NSIOUTPUTSTREAMCALLBACK</span>
<a href="#l85.4302"></a><span id="l85.4302"> </span>
<a href="#l85.4303"></a><span id="l85.4303">   /**</span>
<a href="#l85.4304"></a><span id="l85.4304">    * Callback when data may be written to the output stream without blocking, or</span>
<a href="#l85.4305"></a><span id="l85.4305">    * when the output stream has been closed.</span>
<a href="#l85.4306"></a><span id="l85.4306">    *</span>
<a href="#l85.4307"></a><span id="l85.4307">    * @param output : nsIAsyncOutputStream</span>
<a href="#l85.4308"></a><span id="l85.4308">    *   the output stream on whose writability we've been waiting, also known as</span>
<a href="#l85.4309"></a><span id="l85.4309">    *   this._sink</span>
<a href="#l85.4310"></a><span id="l85.4310">    */</span>
<a href="#l85.4311"></a><span id="l85.4311" class="difflineminus">-  onOutputStreamReady: function(output)</span>
<a href="#l85.4312"></a><span id="l85.4312" class="difflineminus">-  {</span>
<a href="#l85.4313"></a><span id="l85.4313" class="difflineplus">+  onOutputStreamReady(output) {</span>
<a href="#l85.4314"></a><span id="l85.4314">     if (this._sink === null)</span>
<a href="#l85.4315"></a><span id="l85.4315">       return;</span>
<a href="#l85.4316"></a><span id="l85.4316"> </span>
<a href="#l85.4317"></a><span id="l85.4317">     dumpn(&quot;*** onOutputStreamReady&quot;);</span>
<a href="#l85.4318"></a><span id="l85.4318"> </span>
<a href="#l85.4319"></a><span id="l85.4319">     var pendingData = this._pendingData;</span>
<a href="#l85.4320"></a><span id="l85.4320" class="difflineminus">-    if (pendingData.length === 0)</span>
<a href="#l85.4321"></a><span id="l85.4321" class="difflineminus">-    {</span>
<a href="#l85.4322"></a><span id="l85.4322" class="difflineplus">+    if (pendingData.length === 0) {</span>
<a href="#l85.4323"></a><span id="l85.4323">       // There's no pending data to write.  The only way this can happen is if</span>
<a href="#l85.4324"></a><span id="l85.4324">       // we're waiting on the output stream's closure, so we can respond to a</span>
<a href="#l85.4325"></a><span id="l85.4325">       // copying failure as quickly as possible (rather than waiting for data to</span>
<a href="#l85.4326"></a><span id="l85.4326">       // be available to read and then fail to be copied).  Therefore, we must</span>
<a href="#l85.4327"></a><span id="l85.4327">       // be done now -- don't bother to attempt to write anything and wrap</span>
<a href="#l85.4328"></a><span id="l85.4328">       // things up.</span>
<a href="#l85.4329"></a><span id="l85.4329">       dumpn(&quot;!!! output stream closed prematurely, ending copy&quot;);</span>
<a href="#l85.4330"></a><span id="l85.4330"> </span>
<a href="#l85.4331"></a><span id="l85.4331" class="difflineat">@@ -4351,123 +3901,107 @@ WriteThroughCopier.prototype =</span>
<a href="#l85.4332"></a><span id="l85.4332">     //   The write failed because the stream was closed</span>
<a href="#l85.4333"></a><span id="l85.4333">     //     Discard pending data that we can no longer write, stop reading, and</span>
<a href="#l85.4334"></a><span id="l85.4334">     //     signal that copying finished.</span>
<a href="#l85.4335"></a><span id="l85.4335">     //   Some other error occurred.</span>
<a href="#l85.4336"></a><span id="l85.4336">     //     Same as if the stream were closed, but notify with the status</span>
<a href="#l85.4337"></a><span id="l85.4337">     //     NS_ERROR_UNEXPECTED so the observer knows something was wonky.</span>
<a href="#l85.4338"></a><span id="l85.4338">     //</span>
<a href="#l85.4339"></a><span id="l85.4339"> </span>
<a href="#l85.4340"></a><span id="l85.4340" class="difflineminus">-    try</span>
<a href="#l85.4341"></a><span id="l85.4341" class="difflineminus">-    {</span>
<a href="#l85.4342"></a><span id="l85.4342" class="difflineplus">+    try {</span>
<a href="#l85.4343"></a><span id="l85.4343">       var quantum = pendingData[0];</span>
<a href="#l85.4344"></a><span id="l85.4344"> </span>
<a href="#l85.4345"></a><span id="l85.4345">       // XXX |quantum| isn't guaranteed to be ASCII, so we're relying on</span>
<a href="#l85.4346"></a><span id="l85.4346">       //     undefined behavior!  We're only using this because writeByteArray</span>
<a href="#l85.4347"></a><span id="l85.4347">       //     is unusably broken for asynchronous output streams; see bug 532834</span>
<a href="#l85.4348"></a><span id="l85.4348">       //     for details.</span>
<a href="#l85.4349"></a><span id="l85.4349">       var bytesWritten = output.write(quantum, quantum.length);</span>
<a href="#l85.4350"></a><span id="l85.4350">       if (bytesWritten === quantum.length)</span>
<a href="#l85.4351"></a><span id="l85.4351">         pendingData.shift();</span>
<a href="#l85.4352"></a><span id="l85.4352">       else</span>
<a href="#l85.4353"></a><span id="l85.4353">         pendingData[0] = quantum.substring(bytesWritten);</span>
<a href="#l85.4354"></a><span id="l85.4354"> </span>
<a href="#l85.4355"></a><span id="l85.4355">       dumpn(&quot;*** wrote &quot; + bytesWritten + &quot; bytes of data&quot;);</span>
<a href="#l85.4356"></a><span id="l85.4356" class="difflineminus">-    }</span>
<a href="#l85.4357"></a><span id="l85.4357" class="difflineminus">-    catch (e)</span>
<a href="#l85.4358"></a><span id="l85.4358" class="difflineminus">-    {</span>
<a href="#l85.4359"></a><span id="l85.4359" class="difflineminus">-      if (wouldBlock(e))</span>
<a href="#l85.4360"></a><span id="l85.4360" class="difflineminus">-      {</span>
<a href="#l85.4361"></a><span id="l85.4361" class="difflineminus">-        NS_ASSERT(pendingData.length &gt; 0,</span>
<a href="#l85.4362"></a><span id="l85.4362" class="difflineminus">-                  &quot;stream-blocking exception with no data to write?&quot;);</span>
<a href="#l85.4363"></a><span id="l85.4363" class="difflineminus">-        NS_ASSERT(pendingData[0].length &gt; 0,</span>
<a href="#l85.4364"></a><span id="l85.4364" class="difflineminus">-                  &quot;stream-blocking exception with empty quantum?&quot;);</span>
<a href="#l85.4365"></a><span id="l85.4365" class="difflineplus">+    } catch (e) {</span>
<a href="#l85.4366"></a><span id="l85.4366" class="difflineplus">+      if (wouldBlock(e)) {</span>
<a href="#l85.4367"></a><span id="l85.4367" class="difflineplus">+        NS_ASSERT(pendingData.length &gt; 0, &quot;stream-blocking exception with no data to write?&quot;);</span>
<a href="#l85.4368"></a><span id="l85.4368" class="difflineplus">+        NS_ASSERT(pendingData[0].length &gt; 0, &quot;stream-blocking exception with empty quantum?&quot;);</span>
<a href="#l85.4369"></a><span id="l85.4369">         this._waitToWriteData();</span>
<a href="#l85.4370"></a><span id="l85.4370">         return;</span>
<a href="#l85.4371"></a><span id="l85.4371">       }</span>
<a href="#l85.4372"></a><span id="l85.4372"> </span>
<a href="#l85.4373"></a><span id="l85.4373">       if (streamClosed(e))</span>
<a href="#l85.4374"></a><span id="l85.4374">         dumpn(&quot;!!! output stream prematurely closed, signaling error...&quot;);</span>
<a href="#l85.4375"></a><span id="l85.4375">       else</span>
<a href="#l85.4376"></a><span id="l85.4376">         dumpn(&quot;!!! unknown error: &quot; + e + &quot;, quantum=&quot; + quantum);</span>
<a href="#l85.4377"></a><span id="l85.4377"> </span>
<a href="#l85.4378"></a><span id="l85.4378">       this._doneWritingToSink(Cr.NS_ERROR_UNEXPECTED);</span>
<a href="#l85.4379"></a><span id="l85.4379">       return;</span>
<a href="#l85.4380"></a><span id="l85.4380">     }</span>
<a href="#l85.4381"></a><span id="l85.4381"> </span>
<a href="#l85.4382"></a><span id="l85.4382">     // The day is ours!  Quantum written, now let's see if we have more data</span>
<a href="#l85.4383"></a><span id="l85.4383">     // still to write.</span>
<a href="#l85.4384"></a><span id="l85.4384" class="difflineminus">-    try</span>
<a href="#l85.4385"></a><span id="l85.4385" class="difflineminus">-    {</span>
<a href="#l85.4386"></a><span id="l85.4386" class="difflineminus">-      if (pendingData.length &gt; 0)</span>
<a href="#l85.4387"></a><span id="l85.4387" class="difflineminus">-      {</span>
<a href="#l85.4388"></a><span id="l85.4388" class="difflineplus">+    try {</span>
<a href="#l85.4389"></a><span id="l85.4389" class="difflineplus">+      if (pendingData.length &gt; 0) {</span>
<a href="#l85.4390"></a><span id="l85.4390">         this._waitToWriteData();</span>
<a href="#l85.4391"></a><span id="l85.4391">         return;</span>
<a href="#l85.4392"></a><span id="l85.4392">       }</span>
<a href="#l85.4393"></a><span id="l85.4393" class="difflineminus">-    }</span>
<a href="#l85.4394"></a><span id="l85.4394" class="difflineminus">-    catch (e)</span>
<a href="#l85.4395"></a><span id="l85.4395" class="difflineminus">-    {</span>
<a href="#l85.4396"></a><span id="l85.4396" class="difflineplus">+    } catch (e) {</span>
<a href="#l85.4397"></a><span id="l85.4397">       dumpn(&quot;!!! unexpected error waiting to write pending data: &quot; + e);</span>
<a href="#l85.4398"></a><span id="l85.4398">       this._doneWritingToSink(Cr.NS_ERROR_UNEXPECTED);</span>
<a href="#l85.4399"></a><span id="l85.4399">       return;</span>
<a href="#l85.4400"></a><span id="l85.4400">     }</span>
<a href="#l85.4401"></a><span id="l85.4401"> </span>
<a href="#l85.4402"></a><span id="l85.4402">     // Okay, we have no more pending data to write -- but might we get more in</span>
<a href="#l85.4403"></a><span id="l85.4403">     // the future?</span>
<a href="#l85.4404"></a><span id="l85.4404" class="difflineminus">-    if (this._source !== null)</span>
<a href="#l85.4405"></a><span id="l85.4405" class="difflineminus">-    {</span>
<a href="#l85.4406"></a><span id="l85.4406" class="difflineplus">+    if (this._source !== null) {</span>
<a href="#l85.4407"></a><span id="l85.4407">       /*</span>
<a href="#l85.4408"></a><span id="l85.4408">        * If we might, then wait for the output stream to be closed.  (We wait</span>
<a href="#l85.4409"></a><span id="l85.4409">        * only for closure because we have no data to write -- and if we waited</span>
<a href="#l85.4410"></a><span id="l85.4410">        * for a specific amount of data, we would get repeatedly notified for no</span>
<a href="#l85.4411"></a><span id="l85.4411">        * reason if over time the output stream permitted more and more data to</span>
<a href="#l85.4412"></a><span id="l85.4412">        * be written to it without blocking.)</span>
<a href="#l85.4413"></a><span id="l85.4413">        */</span>
<a href="#l85.4414"></a><span id="l85.4414" class="difflineminus">-       this._waitForSinkClosure();</span>
<a href="#l85.4415"></a><span id="l85.4415" class="difflineminus">-    }</span>
<a href="#l85.4416"></a><span id="l85.4416" class="difflineminus">-    else</span>
<a href="#l85.4417"></a><span id="l85.4417" class="difflineminus">-    {</span>
<a href="#l85.4418"></a><span id="l85.4418" class="difflineplus">+      this._waitForSinkClosure();</span>
<a href="#l85.4419"></a><span id="l85.4419" class="difflineplus">+    } else {</span>
<a href="#l85.4420"></a><span id="l85.4420">       /*</span>
<a href="#l85.4421"></a><span id="l85.4421">        * On the other hand, if we can't have more data because the input</span>
<a href="#l85.4422"></a><span id="l85.4422">        * stream's gone away, then it's time to notify of copy completion.</span>
<a href="#l85.4423"></a><span id="l85.4423">        * Victory!</span>
<a href="#l85.4424"></a><span id="l85.4424">        */</span>
<a href="#l85.4425"></a><span id="l85.4425">       this._sink = null;</span>
<a href="#l85.4426"></a><span id="l85.4426">       this._cancelOrDispatchCancelCallback(Cr.NS_OK);</span>
<a href="#l85.4427"></a><span id="l85.4427">     }</span>
<a href="#l85.4428"></a><span id="l85.4428">   },</span>
<a href="#l85.4429"></a><span id="l85.4429"> </span>
<a href="#l85.4430"></a><span id="l85.4430"> </span>
<a href="#l85.4431"></a><span id="l85.4431">   // NSIREQUEST</span>
<a href="#l85.4432"></a><span id="l85.4432"> </span>
<a href="#l85.4433"></a><span id="l85.4433">   /** Returns true if the cancel observer hasn't been notified yet. */</span>
<a href="#l85.4434"></a><span id="l85.4434" class="difflineminus">-  isPending: function()</span>
<a href="#l85.4435"></a><span id="l85.4435" class="difflineminus">-  {</span>
<a href="#l85.4436"></a><span id="l85.4436" class="difflineplus">+  isPending() {</span>
<a href="#l85.4437"></a><span id="l85.4437">     return !this._completed;</span>
<a href="#l85.4438"></a><span id="l85.4438">   },</span>
<a href="#l85.4439"></a><span id="l85.4439"> </span>
<a href="#l85.4440"></a><span id="l85.4440">   /** Not implemented, don't use! */</span>
<a href="#l85.4441"></a><span id="l85.4441">   suspend: notImplemented,</span>
<a href="#l85.4442"></a><span id="l85.4442">   /** Not implemented, don't use! */</span>
<a href="#l85.4443"></a><span id="l85.4443">   resume: notImplemented,</span>
<a href="#l85.4444"></a><span id="l85.4444"> </span>
<a href="#l85.4445"></a><span id="l85.4445">   /**</span>
<a href="#l85.4446"></a><span id="l85.4446">    * Cancels data reading from input, asynchronously writes out any pending</span>
<a href="#l85.4447"></a><span id="l85.4447">    * data, and causes the observer to be notified with the given error code when</span>
<a href="#l85.4448"></a><span id="l85.4448">    * all writing has finished.</span>
<a href="#l85.4449"></a><span id="l85.4449">    *</span>
<a href="#l85.4450"></a><span id="l85.4450">    * @param status : nsresult</span>
<a href="#l85.4451"></a><span id="l85.4451">    *   the status to pass to the observer when data copying has been canceled</span>
<a href="#l85.4452"></a><span id="l85.4452">    */</span>
<a href="#l85.4453"></a><span id="l85.4453" class="difflineminus">-  cancel: function(status)</span>
<a href="#l85.4454"></a><span id="l85.4454" class="difflineminus">-  {</span>
<a href="#l85.4455"></a><span id="l85.4455" class="difflineplus">+  cancel(status) {</span>
<a href="#l85.4456"></a><span id="l85.4456">     dumpn(&quot;*** cancel(&quot; + status.toString(16) + &quot;)&quot;);</span>
<a href="#l85.4457"></a><span id="l85.4457"> </span>
<a href="#l85.4458"></a><span id="l85.4458" class="difflineminus">-    if (this._canceled)</span>
<a href="#l85.4459"></a><span id="l85.4459" class="difflineminus">-    {</span>
<a href="#l85.4460"></a><span id="l85.4460" class="difflineplus">+    if (this._canceled) {</span>
<a href="#l85.4461"></a><span id="l85.4461">       dumpn(&quot;*** suppressing a late cancel&quot;);</span>
<a href="#l85.4462"></a><span id="l85.4462">       return;</span>
<a href="#l85.4463"></a><span id="l85.4463">     }</span>
<a href="#l85.4464"></a><span id="l85.4464"> </span>
<a href="#l85.4465"></a><span id="l85.4465">     this._canceled = true;</span>
<a href="#l85.4466"></a><span id="l85.4466">     this.status = status;</span>
<a href="#l85.4467"></a><span id="l85.4467"> </span>
<a href="#l85.4468"></a><span id="l85.4468">     // We could be in the middle of absolutely anything at this point.  Both</span>
<a href="#l85.4469"></a><span id="l85.4469" class="difflineat">@@ -4486,45 +4020,42 @@ WriteThroughCopier.prototype =</span>
<a href="#l85.4470"></a><span id="l85.4470">   /**</span>
<a href="#l85.4471"></a><span id="l85.4471">    * Stop reading input if we haven't already done so, passing e as the status</span>
<a href="#l85.4472"></a><span id="l85.4472">    * when closing the stream, and kick off a copy-completion notice if no more</span>
<a href="#l85.4473"></a><span id="l85.4473">    * data remains to be written.</span>
<a href="#l85.4474"></a><span id="l85.4474">    *</span>
<a href="#l85.4475"></a><span id="l85.4475">    * @param e : nsresult</span>
<a href="#l85.4476"></a><span id="l85.4476">    *   the status to be used when closing the input stream</span>
<a href="#l85.4477"></a><span id="l85.4477">    */</span>
<a href="#l85.4478"></a><span id="l85.4478" class="difflineminus">-  _doneReadingSource: function(e)</span>
<a href="#l85.4479"></a><span id="l85.4479" class="difflineminus">-  {</span>
<a href="#l85.4480"></a><span id="l85.4480" class="difflineplus">+  _doneReadingSource(e) {</span>
<a href="#l85.4481"></a><span id="l85.4481">     dumpn(&quot;*** _doneReadingSource(0x&quot; + e.toString(16) + &quot;)&quot;);</span>
<a href="#l85.4482"></a><span id="l85.4482"> </span>
<a href="#l85.4483"></a><span id="l85.4483">     this._finishSource(e);</span>
<a href="#l85.4484"></a><span id="l85.4484">     if (this._pendingData.length === 0)</span>
<a href="#l85.4485"></a><span id="l85.4485">       this._sink = null;</span>
<a href="#l85.4486"></a><span id="l85.4486">     else</span>
<a href="#l85.4487"></a><span id="l85.4487">       NS_ASSERT(this._sink !== null, &quot;null output?&quot;);</span>
<a href="#l85.4488"></a><span id="l85.4488"> </span>
<a href="#l85.4489"></a><span id="l85.4489">     // If we've written out all data read up to this point, then it's time to</span>
<a href="#l85.4490"></a><span id="l85.4490">     // signal completion.</span>
<a href="#l85.4491"></a><span id="l85.4491" class="difflineminus">-    if (this._sink === null)</span>
<a href="#l85.4492"></a><span id="l85.4492" class="difflineminus">-    {</span>
<a href="#l85.4493"></a><span id="l85.4493" class="difflineplus">+    if (this._sink === null) {</span>
<a href="#l85.4494"></a><span id="l85.4494">       NS_ASSERT(this._pendingData.length === 0, &quot;pending data still?&quot;);</span>
<a href="#l85.4495"></a><span id="l85.4495">       this._cancelOrDispatchCancelCallback(e);</span>
<a href="#l85.4496"></a><span id="l85.4496">     }</span>
<a href="#l85.4497"></a><span id="l85.4497">   },</span>
<a href="#l85.4498"></a><span id="l85.4498"> </span>
<a href="#l85.4499"></a><span id="l85.4499">   /**</span>
<a href="#l85.4500"></a><span id="l85.4500">    * Stop writing output if we haven't already done so, discard any data that</span>
<a href="#l85.4501"></a><span id="l85.4501">    * remained to be sent, close off input if it wasn't already closed, and kick</span>
<a href="#l85.4502"></a><span id="l85.4502">    * off a copy-completion notice.</span>
<a href="#l85.4503"></a><span id="l85.4503">    *</span>
<a href="#l85.4504"></a><span id="l85.4504">    * @param e : nsresult</span>
<a href="#l85.4505"></a><span id="l85.4505">    *   the status to be used when closing input if it wasn't already closed</span>
<a href="#l85.4506"></a><span id="l85.4506">    */</span>
<a href="#l85.4507"></a><span id="l85.4507" class="difflineminus">-  _doneWritingToSink: function(e)</span>
<a href="#l85.4508"></a><span id="l85.4508" class="difflineminus">-  {</span>
<a href="#l85.4509"></a><span id="l85.4509" class="difflineplus">+  _doneWritingToSink(e) {</span>
<a href="#l85.4510"></a><span id="l85.4510">     dumpn(&quot;*** _doneWritingToSink(0x&quot; + e.toString(16) + &quot;)&quot;);</span>
<a href="#l85.4511"></a><span id="l85.4511"> </span>
<a href="#l85.4512"></a><span id="l85.4512">     this._pendingData.length = 0;</span>
<a href="#l85.4513"></a><span id="l85.4513">     this._sink = null;</span>
<a href="#l85.4514"></a><span id="l85.4514">     this._doneReadingSource(e);</span>
<a href="#l85.4515"></a><span id="l85.4515">   },</span>
<a href="#l85.4516"></a><span id="l85.4516"> </span>
<a href="#l85.4517"></a><span id="l85.4517">   /**</span>
<a href="#l85.4518"></a><span id="l85.4518" class="difflineat">@@ -4532,146 +4063,127 @@ WriteThroughCopier.prototype =</span>
<a href="#l85.4519"></a><span id="l85.4519">    * hasn't already been canceled using the provided status, or by dispatching</span>
<a href="#l85.4520"></a><span id="l85.4520">    * the cancel callback event (with the originally provided status, of course)</span>
<a href="#l85.4521"></a><span id="l85.4521">    * if it already has been canceled.</span>
<a href="#l85.4522"></a><span id="l85.4522">    *</span>
<a href="#l85.4523"></a><span id="l85.4523">    * @param status : nsresult</span>
<a href="#l85.4524"></a><span id="l85.4524">    *   the status code to use to cancel this, if this hasn't already been</span>
<a href="#l85.4525"></a><span id="l85.4525">    *   canceled</span>
<a href="#l85.4526"></a><span id="l85.4526">    */</span>
<a href="#l85.4527"></a><span id="l85.4527" class="difflineminus">-  _cancelOrDispatchCancelCallback: function(status)</span>
<a href="#l85.4528"></a><span id="l85.4528" class="difflineminus">-  {</span>
<a href="#l85.4529"></a><span id="l85.4529" class="difflineplus">+  _cancelOrDispatchCancelCallback(status) {</span>
<a href="#l85.4530"></a><span id="l85.4530">     dumpn(&quot;*** _cancelOrDispatchCancelCallback(&quot; + status + &quot;)&quot;);</span>
<a href="#l85.4531"></a><span id="l85.4531"> </span>
<a href="#l85.4532"></a><span id="l85.4532">     NS_ASSERT(this._source === null, &quot;should have finished input&quot;);</span>
<a href="#l85.4533"></a><span id="l85.4533">     NS_ASSERT(this._sink === null, &quot;should have finished output&quot;);</span>
<a href="#l85.4534"></a><span id="l85.4534">     NS_ASSERT(this._pendingData.length === 0, &quot;should have no pending data&quot;);</span>
<a href="#l85.4535"></a><span id="l85.4535"> </span>
<a href="#l85.4536"></a><span id="l85.4536" class="difflineminus">-    if (!this._canceled)</span>
<a href="#l85.4537"></a><span id="l85.4537" class="difflineminus">-    {</span>
<a href="#l85.4538"></a><span id="l85.4538" class="difflineplus">+    if (!this._canceled) {</span>
<a href="#l85.4539"></a><span id="l85.4539">       this.cancel(status);</span>
<a href="#l85.4540"></a><span id="l85.4540">       return;</span>
<a href="#l85.4541"></a><span id="l85.4541">     }</span>
<a href="#l85.4542"></a><span id="l85.4542"> </span>
<a href="#l85.4543"></a><span id="l85.4543">     var self = this;</span>
<a href="#l85.4544"></a><span id="l85.4544" class="difflineminus">-    var event =</span>
<a href="#l85.4545"></a><span id="l85.4545" class="difflineminus">-      {</span>
<a href="#l85.4546"></a><span id="l85.4546" class="difflineminus">-        run: function()</span>
<a href="#l85.4547"></a><span id="l85.4547" class="difflineminus">-        {</span>
<a href="#l85.4548"></a><span id="l85.4548" class="difflineplus">+    var event = {</span>
<a href="#l85.4549"></a><span id="l85.4549" class="difflineplus">+        run() {</span>
<a href="#l85.4550"></a><span id="l85.4550">           dumpn(&quot;*** onStopRequest async callback&quot;);</span>
<a href="#l85.4551"></a><span id="l85.4551"> </span>
<a href="#l85.4552"></a><span id="l85.4552">           self._completed = true;</span>
<a href="#l85.4553"></a><span id="l85.4553" class="difflineminus">-          try</span>
<a href="#l85.4554"></a><span id="l85.4554" class="difflineminus">-          {</span>
<a href="#l85.4555"></a><span id="l85.4555" class="difflineplus">+          try {</span>
<a href="#l85.4556"></a><span id="l85.4556">             self._observer.onStopRequest(self, self._context, self.status);</span>
<a href="#l85.4557"></a><span id="l85.4557" class="difflineminus">-          }</span>
<a href="#l85.4558"></a><span id="l85.4558" class="difflineminus">-          catch (e)</span>
<a href="#l85.4559"></a><span id="l85.4559" class="difflineminus">-          {</span>
<a href="#l85.4560"></a><span id="l85.4560" class="difflineplus">+          } catch (e) {</span>
<a href="#l85.4561"></a><span id="l85.4561">             NS_ASSERT(false,</span>
<a href="#l85.4562"></a><span id="l85.4562">                       &quot;how are we throwing an exception here?  we control &quot; +</span>
<a href="#l85.4563"></a><span id="l85.4563">                       &quot;all the callers!  &quot; + e);</span>
<a href="#l85.4564"></a><span id="l85.4564">           }</span>
<a href="#l85.4565"></a><span id="l85.4565" class="difflineminus">-        }</span>
<a href="#l85.4566"></a><span id="l85.4566" class="difflineplus">+        },</span>
<a href="#l85.4567"></a><span id="l85.4567">       };</span>
<a href="#l85.4568"></a><span id="l85.4568"> </span>
<a href="#l85.4569"></a><span id="l85.4569" class="difflineminus">-    gThreadManager.currentThread.dispatch(event, Ci.nsIThread.DISPATCH_NORMAL);</span>
<a href="#l85.4570"></a><span id="l85.4570" class="difflineplus">+    Services.tm.currentThread.dispatch(event, Ci.nsIThread.DISPATCH_NORMAL);</span>
<a href="#l85.4571"></a><span id="l85.4571">   },</span>
<a href="#l85.4572"></a><span id="l85.4572"> </span>
<a href="#l85.4573"></a><span id="l85.4573">   /**</span>
<a href="#l85.4574"></a><span id="l85.4574">    * Kicks off another wait for more data to be available from the input stream.</span>
<a href="#l85.4575"></a><span id="l85.4575">    */</span>
<a href="#l85.4576"></a><span id="l85.4576" class="difflineminus">-  _waitToReadData: function()</span>
<a href="#l85.4577"></a><span id="l85.4577" class="difflineminus">-  {</span>
<a href="#l85.4578"></a><span id="l85.4578" class="difflineplus">+  _waitToReadData() {</span>
<a href="#l85.4579"></a><span id="l85.4579">     dumpn(&quot;*** _waitToReadData&quot;);</span>
<a href="#l85.4580"></a><span id="l85.4580" class="difflineminus">-    this._source.asyncWait(this, 0, Response.SEGMENT_SIZE,</span>
<a href="#l85.4581"></a><span id="l85.4581" class="difflineminus">-                           gThreadManager.mainThread);</span>
<a href="#l85.4582"></a><span id="l85.4582" class="difflineplus">+    this._source.asyncWait(this, 0, Response.SEGMENT_SIZE, Services.tm.mainThread);</span>
<a href="#l85.4583"></a><span id="l85.4583">   },</span>
<a href="#l85.4584"></a><span id="l85.4584"> </span>
<a href="#l85.4585"></a><span id="l85.4585">   /**</span>
<a href="#l85.4586"></a><span id="l85.4586">    * Kicks off another wait until data can be written to the output stream.</span>
<a href="#l85.4587"></a><span id="l85.4587">    */</span>
<a href="#l85.4588"></a><span id="l85.4588" class="difflineminus">-  _waitToWriteData: function()</span>
<a href="#l85.4589"></a><span id="l85.4589" class="difflineminus">-  {</span>
<a href="#l85.4590"></a><span id="l85.4590" class="difflineplus">+  _waitToWriteData() {</span>
<a href="#l85.4591"></a><span id="l85.4591">     dumpn(&quot;*** _waitToWriteData&quot;);</span>
<a href="#l85.4592"></a><span id="l85.4592"> </span>
<a href="#l85.4593"></a><span id="l85.4593">     var pendingData = this._pendingData;</span>
<a href="#l85.4594"></a><span id="l85.4594">     NS_ASSERT(pendingData.length &gt; 0, &quot;no pending data to write?&quot;);</span>
<a href="#l85.4595"></a><span id="l85.4595">     NS_ASSERT(pendingData[0].length &gt; 0, &quot;buffered an empty write?&quot;);</span>
<a href="#l85.4596"></a><span id="l85.4596"> </span>
<a href="#l85.4597"></a><span id="l85.4597" class="difflineminus">-    this._sink.asyncWait(this, 0, pendingData[0].length,</span>
<a href="#l85.4598"></a><span id="l85.4598" class="difflineminus">-                         gThreadManager.mainThread);</span>
<a href="#l85.4599"></a><span id="l85.4599" class="difflineplus">+    this._sink.asyncWait(this, 0, pendingData[0].length, Services.tm.mainThread);</span>
<a href="#l85.4600"></a><span id="l85.4600">   },</span>
<a href="#l85.4601"></a><span id="l85.4601"> </span>
<a href="#l85.4602"></a><span id="l85.4602">   /**</span>
<a href="#l85.4603"></a><span id="l85.4603">    * Kicks off a wait for the sink to which data is being copied to be closed.</span>
<a href="#l85.4604"></a><span id="l85.4604">    * We wait for stream closure when we don't have any data to be copied, rather</span>
<a href="#l85.4605"></a><span id="l85.4605">    * than waiting to write a specific amount of data.  We can't wait to write</span>
<a href="#l85.4606"></a><span id="l85.4606">    * data because the sink might be infinitely writable, and if no data appears</span>
<a href="#l85.4607"></a><span id="l85.4607">    * in the source for a long time we might have to spin quite a bit waiting to</span>
<a href="#l85.4608"></a><span id="l85.4608">    * write, waiting to write again, &amp;c.  Waiting on stream closure instead means</span>
<a href="#l85.4609"></a><span id="l85.4609">    * we'll get just one notification if the sink dies.  Note that when data</span>
<a href="#l85.4610"></a><span id="l85.4610">    * starts arriving from the sink we'll resume waiting for data to be written,</span>
<a href="#l85.4611"></a><span id="l85.4611">    * dropping this closure-only callback entirely.</span>
<a href="#l85.4612"></a><span id="l85.4612">    */</span>
<a href="#l85.4613"></a><span id="l85.4613" class="difflineminus">-  _waitForSinkClosure: function()</span>
<a href="#l85.4614"></a><span id="l85.4614" class="difflineminus">-  {</span>
<a href="#l85.4615"></a><span id="l85.4615" class="difflineplus">+  _waitForSinkClosure() {</span>
<a href="#l85.4616"></a><span id="l85.4616">     dumpn(&quot;*** _waitForSinkClosure&quot;);</span>
<a href="#l85.4617"></a><span id="l85.4617"> </span>
<a href="#l85.4618"></a><span id="l85.4618">     this._sink.asyncWait(this, Ci.nsIAsyncOutputStream.WAIT_CLOSURE_ONLY, 0,</span>
<a href="#l85.4619"></a><span id="l85.4619" class="difflineminus">-                         gThreadManager.mainThread);</span>
<a href="#l85.4620"></a><span id="l85.4620" class="difflineplus">+                         Services.tm.mainThread);</span>
<a href="#l85.4621"></a><span id="l85.4621">   },</span>
<a href="#l85.4622"></a><span id="l85.4622"> </span>
<a href="#l85.4623"></a><span id="l85.4623">   /**</span>
<a href="#l85.4624"></a><span id="l85.4624">    * Closes input with the given status, if it hasn't already been closed;</span>
<a href="#l85.4625"></a><span id="l85.4625">    * otherwise a no-op.</span>
<a href="#l85.4626"></a><span id="l85.4626">    *</span>
<a href="#l85.4627"></a><span id="l85.4627">    * @param status : nsresult</span>
<a href="#l85.4628"></a><span id="l85.4628">    *   status code use to close the source stream if necessary</span>
<a href="#l85.4629"></a><span id="l85.4629">    */</span>
<a href="#l85.4630"></a><span id="l85.4630" class="difflineminus">-  _finishSource: function(status)</span>
<a href="#l85.4631"></a><span id="l85.4631" class="difflineminus">-  {</span>
<a href="#l85.4632"></a><span id="l85.4632" class="difflineplus">+  _finishSource(status) {</span>
<a href="#l85.4633"></a><span id="l85.4633">     dumpn(&quot;*** _finishSource(&quot; + status.toString(16) + &quot;)&quot;);</span>
<a href="#l85.4634"></a><span id="l85.4634"> </span>
<a href="#l85.4635"></a><span id="l85.4635" class="difflineminus">-    if (this._source !== null)</span>
<a href="#l85.4636"></a><span id="l85.4636" class="difflineminus">-    {</span>
<a href="#l85.4637"></a><span id="l85.4637" class="difflineplus">+    if (this._source !== null) {</span>
<a href="#l85.4638"></a><span id="l85.4638">       this._source.closeWithStatus(status);</span>
<a href="#l85.4639"></a><span id="l85.4639">       this._source = null;</span>
<a href="#l85.4640"></a><span id="l85.4640">     }</span>
<a href="#l85.4641"></a><span id="l85.4641" class="difflineminus">-  }</span>
<a href="#l85.4642"></a><span id="l85.4642" class="difflineplus">+  },</span>
<a href="#l85.4643"></a><span id="l85.4643"> };</span>
<a href="#l85.4644"></a><span id="l85.4644"> </span>
<a href="#l85.4645"></a><span id="l85.4645"> </span>
<a href="#l85.4646"></a><span id="l85.4646"> /**</span>
<a href="#l85.4647"></a><span id="l85.4647">  * A container for utility functions used with HTTP headers.</span>
<a href="#l85.4648"></a><span id="l85.4648">  */</span>
<a href="#l85.4649"></a><span id="l85.4649" class="difflineminus">-var headerUtils =</span>
<a href="#l85.4650"></a><span id="l85.4650" class="difflineminus">-{</span>
<a href="#l85.4651"></a><span id="l85.4651" class="difflineplus">+var headerUtils = {</span>
<a href="#l85.4652"></a><span id="l85.4652">   /**</span>
<a href="#l85.4653"></a><span id="l85.4653">    * Normalizes fieldName (by converting it to lowercase) and ensures it is a</span>
<a href="#l85.4654"></a><span id="l85.4654">    * valid header field name (although not necessarily one specified in RFC</span>
<a href="#l85.4655"></a><span id="l85.4655">    * 2616).</span>
<a href="#l85.4656"></a><span id="l85.4656">    *</span>
<a href="#l85.4657"></a><span id="l85.4657">    * @throws NS_ERROR_INVALID_ARG</span>
<a href="#l85.4658"></a><span id="l85.4658">    *   if fieldName does not match the field-name production in RFC 2616</span>
<a href="#l85.4659"></a><span id="l85.4659">    * @returns string</span>
<a href="#l85.4660"></a><span id="l85.4660">    *   fieldName converted to lowercase if it is a valid header, for characters</span>
<a href="#l85.4661"></a><span id="l85.4661">    *   where case conversion is possible</span>
<a href="#l85.4662"></a><span id="l85.4662">    */</span>
<a href="#l85.4663"></a><span id="l85.4663" class="difflineminus">-  normalizeFieldName: function(fieldName)</span>
<a href="#l85.4664"></a><span id="l85.4664" class="difflineminus">-  {</span>
<a href="#l85.4665"></a><span id="l85.4665" class="difflineminus">-    if (fieldName == &quot;&quot;)</span>
<a href="#l85.4666"></a><span id="l85.4666" class="difflineminus">-    {</span>
<a href="#l85.4667"></a><span id="l85.4667" class="difflineplus">+  normalizeFieldName(fieldName) {</span>
<a href="#l85.4668"></a><span id="l85.4668" class="difflineplus">+    if (fieldName == &quot;&quot;) {</span>
<a href="#l85.4669"></a><span id="l85.4669">       dumpn(&quot;*** Empty fieldName&quot;);</span>
<a href="#l85.4670"></a><span id="l85.4670">       throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l85.4671"></a><span id="l85.4671">     }</span>
<a href="#l85.4672"></a><span id="l85.4672"> </span>
<a href="#l85.4673"></a><span id="l85.4673" class="difflineminus">-    for (var i = 0, sz = fieldName.length; i &lt; sz; i++)</span>
<a href="#l85.4674"></a><span id="l85.4674" class="difflineminus">-    {</span>
<a href="#l85.4675"></a><span id="l85.4675" class="difflineminus">-      if (!IS_TOKEN_ARRAY[fieldName.charCodeAt(i)])</span>
<a href="#l85.4676"></a><span id="l85.4676" class="difflineminus">-      {</span>
<a href="#l85.4677"></a><span id="l85.4677" class="difflineplus">+    for (var i = 0, sz = fieldName.length; i &lt; sz; i++) {</span>
<a href="#l85.4678"></a><span id="l85.4678" class="difflineplus">+      if (!IS_TOKEN_ARRAY[fieldName.charCodeAt(i)]) {</span>
<a href="#l85.4679"></a><span id="l85.4679">         dumpn(fieldName + &quot; is not a valid header field name!&quot;);</span>
<a href="#l85.4680"></a><span id="l85.4680">         throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l85.4681"></a><span id="l85.4681">       }</span>
<a href="#l85.4682"></a><span id="l85.4682">     }</span>
<a href="#l85.4683"></a><span id="l85.4683"> </span>
<a href="#l85.4684"></a><span id="l85.4684">     return fieldName.toLowerCase();</span>
<a href="#l85.4685"></a><span id="l85.4685">   },</span>
<a href="#l85.4686"></a><span id="l85.4686"> </span>
<a href="#l85.4687"></a><span id="l85.4687" class="difflineat">@@ -4683,18 +4195,17 @@ var headerUtils =</span>
<a href="#l85.4688"></a><span id="l85.4688">    *</span>
<a href="#l85.4689"></a><span id="l85.4689">    * @param fieldValue : string</span>
<a href="#l85.4690"></a><span id="l85.4690">    *   a value to be normalized as an HTTP header field value</span>
<a href="#l85.4691"></a><span id="l85.4691">    * @throws NS_ERROR_INVALID_ARG</span>
<a href="#l85.4692"></a><span id="l85.4692">    *   if fieldValue does not match the field-value production in RFC 2616</span>
<a href="#l85.4693"></a><span id="l85.4693">    * @returns string</span>
<a href="#l85.4694"></a><span id="l85.4694">    *   fieldValue as a normalized HTTP header field value</span>
<a href="#l85.4695"></a><span id="l85.4695">    */</span>
<a href="#l85.4696"></a><span id="l85.4696" class="difflineminus">-  normalizeFieldValue: function(fieldValue)</span>
<a href="#l85.4697"></a><span id="l85.4697" class="difflineminus">-  {</span>
<a href="#l85.4698"></a><span id="l85.4698" class="difflineplus">+  normalizeFieldValue(fieldValue) {</span>
<a href="#l85.4699"></a><span id="l85.4699">     // field-value    = *( field-content | LWS )</span>
<a href="#l85.4700"></a><span id="l85.4700">     // field-content  = &lt;the OCTETs making up the field-value</span>
<a href="#l85.4701"></a><span id="l85.4701">     //                  and consisting of either *TEXT or combinations</span>
<a href="#l85.4702"></a><span id="l85.4702">     //                  of token, separators, and quoted-string&gt;</span>
<a href="#l85.4703"></a><span id="l85.4703">     // TEXT           = &lt;any OCTET except CTLs,</span>
<a href="#l85.4704"></a><span id="l85.4704">     //                  but including LWS&gt;</span>
<a href="#l85.4705"></a><span id="l85.4705">     // LWS            = [CRLF] 1*( SP | HT )</span>
<a href="#l85.4706"></a><span id="l85.4706">     //</span>
<a href="#l85.4707"></a><span id="l85.4707" class="difflineat">@@ -4709,42 +4220,40 @@ var headerUtils =</span>
<a href="#l85.4708"></a><span id="l85.4708">     var val = fieldValue.replace(/(?:(?:\r\n)?[ \t]+)+/g, &quot; &quot;);</span>
<a href="#l85.4709"></a><span id="l85.4709"> </span>
<a href="#l85.4710"></a><span id="l85.4710">     // remove leading/trailing LWS (which has been converted to SP)</span>
<a href="#l85.4711"></a><span id="l85.4711">     val = val.replace(/^ +/, &quot;&quot;).replace(/ +$/, &quot;&quot;);</span>
<a href="#l85.4712"></a><span id="l85.4712"> </span>
<a href="#l85.4713"></a><span id="l85.4713">     // that should have taken care of all CTLs, so val should contain no CTLs</span>
<a href="#l85.4714"></a><span id="l85.4714">     dumpn(&quot;*** Normalized value: '&quot; + val + &quot;'&quot;);</span>
<a href="#l85.4715"></a><span id="l85.4715">     for (var i = 0, len = val.length; i &lt; len; i++)</span>
<a href="#l85.4716"></a><span id="l85.4716" class="difflineminus">-      if (isCTL(val.charCodeAt(i)))</span>
<a href="#l85.4717"></a><span id="l85.4717" class="difflineminus">-      {</span>
<a href="#l85.4718"></a><span id="l85.4718" class="difflineplus">+      if (isCTL(val.charCodeAt(i))) {</span>
<a href="#l85.4719"></a><span id="l85.4719">         dump(&quot;*** Char &quot; + i + &quot; has charcode &quot; + val.charCodeAt(i));</span>
<a href="#l85.4720"></a><span id="l85.4720">         throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l85.4721"></a><span id="l85.4721">       }</span>
<a href="#l85.4722"></a><span id="l85.4722"> </span>
<a href="#l85.4723"></a><span id="l85.4723">     // XXX disallows quoted-pair where CHAR is a CTL -- will not invalidly</span>
<a href="#l85.4724"></a><span id="l85.4724">     //     normalize, however, so this can be construed as a tightening of the</span>
<a href="#l85.4725"></a><span id="l85.4725">     //     spec and not entirely as a bug</span>
<a href="#l85.4726"></a><span id="l85.4726">     return val;</span>
<a href="#l85.4727"></a><span id="l85.4727" class="difflineminus">-  }</span>
<a href="#l85.4728"></a><span id="l85.4728" class="difflineplus">+  },</span>
<a href="#l85.4729"></a><span id="l85.4729"> };</span>
<a href="#l85.4730"></a><span id="l85.4730"> </span>
<a href="#l85.4731"></a><span id="l85.4731"> </span>
<a href="#l85.4732"></a><span id="l85.4732"> </span>
<a href="#l85.4733"></a><span id="l85.4733"> /**</span>
<a href="#l85.4734"></a><span id="l85.4734">  * Converts the given string into a string which is safe for use in an HTML</span>
<a href="#l85.4735"></a><span id="l85.4735">  * context.</span>
<a href="#l85.4736"></a><span id="l85.4736">  *</span>
<a href="#l85.4737"></a><span id="l85.4737">  * @param str : string</span>
<a href="#l85.4738"></a><span id="l85.4738">  *   the string to make HTML-safe</span>
<a href="#l85.4739"></a><span id="l85.4739">  * @returns string</span>
<a href="#l85.4740"></a><span id="l85.4740">  *   an HTML-safe version of str</span>
<a href="#l85.4741"></a><span id="l85.4741">  */</span>
<a href="#l85.4742"></a><span id="l85.4742" class="difflineminus">-function htmlEscape(str)</span>
<a href="#l85.4743"></a><span id="l85.4743" class="difflineminus">-{</span>
<a href="#l85.4744"></a><span id="l85.4744" class="difflineplus">+function htmlEscape(str) {</span>
<a href="#l85.4745"></a><span id="l85.4745">   // this is naive, but it'll work</span>
<a href="#l85.4746"></a><span id="l85.4746">   var s = &quot;&quot;;</span>
<a href="#l85.4747"></a><span id="l85.4747">   for (var i = 0; i &lt; str.length; i++)</span>
<a href="#l85.4748"></a><span id="l85.4748">     s += &quot;&amp;#&quot; + str.charCodeAt(i) + &quot;;&quot;;</span>
<a href="#l85.4749"></a><span id="l85.4749">   return s;</span>
<a href="#l85.4750"></a><span id="l85.4750"> }</span>
<a href="#l85.4751"></a><span id="l85.4751"> </span>
<a href="#l85.4752"></a><span id="l85.4752"> </span>
<a href="#l85.4753"></a><span id="l85.4753" class="difflineat">@@ -4752,131 +4261,116 @@ function htmlEscape(str)</span>
<a href="#l85.4754"></a><span id="l85.4754">  * Constructs an object representing an HTTP version (see section 3.1).</span>
<a href="#l85.4755"></a><span id="l85.4755">  *</span>
<a href="#l85.4756"></a><span id="l85.4756">  * @param versionString</span>
<a href="#l85.4757"></a><span id="l85.4757">  *   a string of the form &quot;#.#&quot;, where # is an non-negative decimal integer with</span>
<a href="#l85.4758"></a><span id="l85.4758">  *   or without leading zeros</span>
<a href="#l85.4759"></a><span id="l85.4759">  * @throws</span>
<a href="#l85.4760"></a><span id="l85.4760">  *   if versionString does not specify a valid HTTP version number</span>
<a href="#l85.4761"></a><span id="l85.4761">  */</span>
<a href="#l85.4762"></a><span id="l85.4762" class="difflineminus">-function nsHttpVersion(versionString)</span>
<a href="#l85.4763"></a><span id="l85.4763" class="difflineminus">-{</span>
<a href="#l85.4764"></a><span id="l85.4764" class="difflineplus">+function nsHttpVersion(versionString) {</span>
<a href="#l85.4765"></a><span id="l85.4765">   var matches = /^(\d+)\.(\d+)$/.exec(versionString);</span>
<a href="#l85.4766"></a><span id="l85.4766">   if (!matches)</span>
<a href="#l85.4767"></a><span id="l85.4767">     throw &quot;Not a valid HTTP version!&quot;;</span>
<a href="#l85.4768"></a><span id="l85.4768"> </span>
<a href="#l85.4769"></a><span id="l85.4769">   /** The major version number of this, as a number. */</span>
<a href="#l85.4770"></a><span id="l85.4770">   this.major = parseInt(matches[1], 10);</span>
<a href="#l85.4771"></a><span id="l85.4771"> </span>
<a href="#l85.4772"></a><span id="l85.4772">   /** The minor version number of this, as a number. */</span>
<a href="#l85.4773"></a><span id="l85.4773">   this.minor = parseInt(matches[2], 10);</span>
<a href="#l85.4774"></a><span id="l85.4774"> </span>
<a href="#l85.4775"></a><span id="l85.4775">   if (isNaN(this.major) || isNaN(this.minor) ||</span>
<a href="#l85.4776"></a><span id="l85.4776" class="difflineminus">-      this.major &lt; 0    || this.minor &lt; 0)</span>
<a href="#l85.4777"></a><span id="l85.4777" class="difflineplus">+      this.major &lt; 0 || this.minor &lt; 0)</span>
<a href="#l85.4778"></a><span id="l85.4778">     throw &quot;Not a valid HTTP version!&quot;;</span>
<a href="#l85.4779"></a><span id="l85.4779"> }</span>
<a href="#l85.4780"></a><span id="l85.4780" class="difflineminus">-nsHttpVersion.prototype =</span>
<a href="#l85.4781"></a><span id="l85.4781" class="difflineminus">-{</span>
<a href="#l85.4782"></a><span id="l85.4782" class="difflineplus">+nsHttpVersion.prototype = {</span>
<a href="#l85.4783"></a><span id="l85.4783">   /**</span>
<a href="#l85.4784"></a><span id="l85.4784">    * Returns the standard string representation of the HTTP version represented</span>
<a href="#l85.4785"></a><span id="l85.4785">    * by this (e.g., &quot;1.1&quot;).</span>
<a href="#l85.4786"></a><span id="l85.4786">    */</span>
<a href="#l85.4787"></a><span id="l85.4787" class="difflineminus">-  toString: function ()</span>
<a href="#l85.4788"></a><span id="l85.4788" class="difflineminus">-  {</span>
<a href="#l85.4789"></a><span id="l85.4789" class="difflineplus">+  toString() {</span>
<a href="#l85.4790"></a><span id="l85.4790">     return this.major + &quot;.&quot; + this.minor;</span>
<a href="#l85.4791"></a><span id="l85.4791">   },</span>
<a href="#l85.4792"></a><span id="l85.4792"> </span>
<a href="#l85.4793"></a><span id="l85.4793">   /**</span>
<a href="#l85.4794"></a><span id="l85.4794">    * Returns true if this represents the same HTTP version as otherVersion,</span>
<a href="#l85.4795"></a><span id="l85.4795">    * false otherwise.</span>
<a href="#l85.4796"></a><span id="l85.4796">    *</span>
<a href="#l85.4797"></a><span id="l85.4797">    * @param otherVersion : nsHttpVersion</span>
<a href="#l85.4798"></a><span id="l85.4798">    *   the version to compare against this</span>
<a href="#l85.4799"></a><span id="l85.4799">    */</span>
<a href="#l85.4800"></a><span id="l85.4800" class="difflineminus">-  equals: function (otherVersion)</span>
<a href="#l85.4801"></a><span id="l85.4801" class="difflineminus">-  {</span>
<a href="#l85.4802"></a><span id="l85.4802" class="difflineplus">+  equals(otherVersion) {</span>
<a href="#l85.4803"></a><span id="l85.4803">     return this.major == otherVersion.major &amp;&amp;</span>
<a href="#l85.4804"></a><span id="l85.4804">            this.minor == otherVersion.minor;</span>
<a href="#l85.4805"></a><span id="l85.4805">   },</span>
<a href="#l85.4806"></a><span id="l85.4806"> </span>
<a href="#l85.4807"></a><span id="l85.4807">   /** True if this &gt;= otherVersion, false otherwise. */</span>
<a href="#l85.4808"></a><span id="l85.4808" class="difflineminus">-  atLeast: function(otherVersion)</span>
<a href="#l85.4809"></a><span id="l85.4809" class="difflineminus">-  {</span>
<a href="#l85.4810"></a><span id="l85.4810" class="difflineplus">+  atLeast(otherVersion) {</span>
<a href="#l85.4811"></a><span id="l85.4811">     return this.major &gt; otherVersion.major ||</span>
<a href="#l85.4812"></a><span id="l85.4812">            (this.major == otherVersion.major &amp;&amp;</span>
<a href="#l85.4813"></a><span id="l85.4813">             this.minor &gt;= otherVersion.minor);</span>
<a href="#l85.4814"></a><span id="l85.4814" class="difflineminus">-  }</span>
<a href="#l85.4815"></a><span id="l85.4815" class="difflineplus">+  },</span>
<a href="#l85.4816"></a><span id="l85.4816"> };</span>
<a href="#l85.4817"></a><span id="l85.4817"> </span>
<a href="#l85.4818"></a><span id="l85.4818"> nsHttpVersion.HTTP_1_0 = new nsHttpVersion(&quot;1.0&quot;);</span>
<a href="#l85.4819"></a><span id="l85.4819"> nsHttpVersion.HTTP_1_1 = new nsHttpVersion(&quot;1.1&quot;);</span>
<a href="#l85.4820"></a><span id="l85.4820"> </span>
<a href="#l85.4821"></a><span id="l85.4821"> </span>
<a href="#l85.4822"></a><span id="l85.4822"> /**</span>
<a href="#l85.4823"></a><span id="l85.4823">  * An object which stores HTTP headers for a request or response.</span>
<a href="#l85.4824"></a><span id="l85.4824">  *</span>
<a href="#l85.4825"></a><span id="l85.4825">  * Note that since headers are case-insensitive, this object converts headers to</span>
<a href="#l85.4826"></a><span id="l85.4826">  * lowercase before storing them.  This allows the getHeader and hasHeader</span>
<a href="#l85.4827"></a><span id="l85.4827">  * methods to work correctly for any case of a header, but it means that the</span>
<a href="#l85.4828"></a><span id="l85.4828">  * values returned by .enumerator may not be equal case-sensitively to the</span>
<a href="#l85.4829"></a><span id="l85.4829">  * values passed to setHeader when adding headers to this.</span>
<a href="#l85.4830"></a><span id="l85.4830">  */</span>
<a href="#l85.4831"></a><span id="l85.4831" class="difflineminus">-function nsHttpHeaders()</span>
<a href="#l85.4832"></a><span id="l85.4832" class="difflineminus">-{</span>
<a href="#l85.4833"></a><span id="l85.4833" class="difflineplus">+function nsHttpHeaders() {</span>
<a href="#l85.4834"></a><span id="l85.4834">   /**</span>
<a href="#l85.4835"></a><span id="l85.4835">    * A hash of headers, with header field names as the keys and header field</span>
<a href="#l85.4836"></a><span id="l85.4836">    * values as the values.  Header field names are case-insensitive, but upon</span>
<a href="#l85.4837"></a><span id="l85.4837">    * insertion here they are converted to lowercase.  Header field values are</span>
<a href="#l85.4838"></a><span id="l85.4838">    * normalized upon insertion to contain no leading or trailing whitespace.</span>
<a href="#l85.4839"></a><span id="l85.4839">    *</span>
<a href="#l85.4840"></a><span id="l85.4840">    * Note also that per RFC 2616, section 4.2, two headers with the same name in</span>
<a href="#l85.4841"></a><span id="l85.4841">    * a message may be treated as one header with the same field name and a field</span>
<a href="#l85.4842"></a><span id="l85.4842">    * value consisting of the separate field values joined together with a &quot;,&quot; in</span>
<a href="#l85.4843"></a><span id="l85.4843">    * their original order.  This hash stores multiple headers with the same name</span>
<a href="#l85.4844"></a><span id="l85.4844">    * in this manner.</span>
<a href="#l85.4845"></a><span id="l85.4845">    */</span>
<a href="#l85.4846"></a><span id="l85.4846">   this._headers = {};</span>
<a href="#l85.4847"></a><span id="l85.4847"> }</span>
<a href="#l85.4848"></a><span id="l85.4848" class="difflineminus">-nsHttpHeaders.prototype =</span>
<a href="#l85.4849"></a><span id="l85.4849" class="difflineminus">-{</span>
<a href="#l85.4850"></a><span id="l85.4850" class="difflineplus">+nsHttpHeaders.prototype = {</span>
<a href="#l85.4851"></a><span id="l85.4851">   /**</span>
<a href="#l85.4852"></a><span id="l85.4852">    * Sets the header represented by name and value in this.</span>
<a href="#l85.4853"></a><span id="l85.4853">    *</span>
<a href="#l85.4854"></a><span id="l85.4854">    * @param name : string</span>
<a href="#l85.4855"></a><span id="l85.4855">    *   the header name</span>
<a href="#l85.4856"></a><span id="l85.4856">    * @param value : string</span>
<a href="#l85.4857"></a><span id="l85.4857">    *   the header value</span>
<a href="#l85.4858"></a><span id="l85.4858">    * @throws NS_ERROR_INVALID_ARG</span>
<a href="#l85.4859"></a><span id="l85.4859">    *   if name or value is not a valid header component</span>
<a href="#l85.4860"></a><span id="l85.4860">    */</span>
<a href="#l85.4861"></a><span id="l85.4861" class="difflineminus">-  setHeader: function(fieldName, fieldValue, merge)</span>
<a href="#l85.4862"></a><span id="l85.4862" class="difflineminus">-  {</span>
<a href="#l85.4863"></a><span id="l85.4863" class="difflineplus">+  setHeader(fieldName, fieldValue, merge) {</span>
<a href="#l85.4864"></a><span id="l85.4864">     var name = headerUtils.normalizeFieldName(fieldName);</span>
<a href="#l85.4865"></a><span id="l85.4865">     var value = headerUtils.normalizeFieldValue(fieldValue);</span>
<a href="#l85.4866"></a><span id="l85.4866"> </span>
<a href="#l85.4867"></a><span id="l85.4867">     // The following three headers are stored as arrays because their real-world</span>
<a href="#l85.4868"></a><span id="l85.4868">     // syntax prevents joining individual headers into a single header using</span>
<a href="#l85.4869"></a><span id="l85.4869">     // &quot;,&quot;.  See also &lt;https://hg.mozilla.org/mozilla-central/diff/9b2a99adc05e/netwerk/protocol/http/src/nsHttpHeaderArray.cpp#l77&gt;</span>
<a href="#l85.4870"></a><span id="l85.4870" class="difflineminus">-    if (merge &amp;&amp; name in this._headers)</span>
<a href="#l85.4871"></a><span id="l85.4871" class="difflineminus">-    {</span>
<a href="#l85.4872"></a><span id="l85.4872" class="difflineplus">+    if (merge &amp;&amp; name in this._headers) {</span>
<a href="#l85.4873"></a><span id="l85.4873">       if (name === &quot;www-authenticate&quot; ||</span>
<a href="#l85.4874"></a><span id="l85.4874">           name === &quot;proxy-authenticate&quot; ||</span>
<a href="#l85.4875"></a><span id="l85.4875" class="difflineminus">-          name === &quot;set-cookie&quot;)</span>
<a href="#l85.4876"></a><span id="l85.4876" class="difflineminus">-      {</span>
<a href="#l85.4877"></a><span id="l85.4877" class="difflineplus">+          name === &quot;set-cookie&quot;) {</span>
<a href="#l85.4878"></a><span id="l85.4878">         this._headers[name].push(value);</span>
<a href="#l85.4879"></a><span id="l85.4879" class="difflineminus">-      }</span>
<a href="#l85.4880"></a><span id="l85.4880" class="difflineminus">-      else</span>
<a href="#l85.4881"></a><span id="l85.4881" class="difflineminus">-      {</span>
<a href="#l85.4882"></a><span id="l85.4882" class="difflineplus">+      } else {</span>
<a href="#l85.4883"></a><span id="l85.4883">         this._headers[name][0] += &quot;,&quot; + value;</span>
<a href="#l85.4884"></a><span id="l85.4884" class="difflineminus">-        NS_ASSERT(this._headers[name].length === 1,</span>
<a href="#l85.4885"></a><span id="l85.4885" class="difflineminus">-            &quot;how'd a non-special header have multiple values?&quot;)</span>
<a href="#l85.4886"></a><span id="l85.4886" class="difflineplus">+        NS_ASSERT(this._headers[name].length === 1, &quot;how'd a non-special header have multiple values?&quot;);</span>
<a href="#l85.4887"></a><span id="l85.4887">       }</span>
<a href="#l85.4888"></a><span id="l85.4888" class="difflineminus">-    }</span>
<a href="#l85.4889"></a><span id="l85.4889" class="difflineminus">-    else</span>
<a href="#l85.4890"></a><span id="l85.4890" class="difflineminus">-    {</span>
<a href="#l85.4891"></a><span id="l85.4891" class="difflineplus">+    } else {</span>
<a href="#l85.4892"></a><span id="l85.4892">       this._headers[name] = [value];</span>
<a href="#l85.4893"></a><span id="l85.4893">     }</span>
<a href="#l85.4894"></a><span id="l85.4894">   },</span>
<a href="#l85.4895"></a><span id="l85.4895"> </span>
<a href="#l85.4896"></a><span id="l85.4896">   /**</span>
<a href="#l85.4897"></a><span id="l85.4897">    * Returns the value for the header specified by this.</span>
<a href="#l85.4898"></a><span id="l85.4898">    *</span>
<a href="#l85.4899"></a><span id="l85.4899">    * @throws NS_ERROR_INVALID_ARG</span>
<a href="#l85.4900"></a><span id="l85.4900" class="difflineat">@@ -4885,18 +4379,17 @@ nsHttpHeaders.prototype =</span>
<a href="#l85.4901"></a><span id="l85.4901">    *   if the given header does not exist in this</span>
<a href="#l85.4902"></a><span id="l85.4902">    * @returns string</span>
<a href="#l85.4903"></a><span id="l85.4903">    *   the field value for the given header, possibly with non-semantic changes</span>
<a href="#l85.4904"></a><span id="l85.4904">    *   (i.e., leading/trailing whitespace stripped, whitespace runs replaced</span>
<a href="#l85.4905"></a><span id="l85.4905">    *   with spaces, etc.) at the option of the implementation; multiple</span>
<a href="#l85.4906"></a><span id="l85.4906">    *   instances of the header will be combined with a comma, except for</span>
<a href="#l85.4907"></a><span id="l85.4907">    *   the three headers noted in the description of getHeaderValues</span>
<a href="#l85.4908"></a><span id="l85.4908">    */</span>
<a href="#l85.4909"></a><span id="l85.4909" class="difflineminus">-  getHeader: function(fieldName)</span>
<a href="#l85.4910"></a><span id="l85.4910" class="difflineminus">-  {</span>
<a href="#l85.4911"></a><span id="l85.4911" class="difflineplus">+  getHeader(fieldName) {</span>
<a href="#l85.4912"></a><span id="l85.4912">     return this.getHeaderValues(fieldName).join(&quot;\n&quot;);</span>
<a href="#l85.4913"></a><span id="l85.4913">   },</span>
<a href="#l85.4914"></a><span id="l85.4914"> </span>
<a href="#l85.4915"></a><span id="l85.4915">   /**</span>
<a href="#l85.4916"></a><span id="l85.4916">    * Returns the value for the header specified by fieldName as an array.</span>
<a href="#l85.4917"></a><span id="l85.4917">    *</span>
<a href="#l85.4918"></a><span id="l85.4918">    * @throws NS_ERROR_INVALID_ARG</span>
<a href="#l85.4919"></a><span id="l85.4919">    *   if fieldName does not constitute a valid header field name</span>
<a href="#l85.4920"></a><span id="l85.4920" class="difflineat">@@ -4907,100 +4400,90 @@ nsHttpHeaders.prototype =</span>
<a href="#l85.4921"></a><span id="l85.4921">    *   header name.  Header values will generally be collapsed</span>
<a href="#l85.4922"></a><span id="l85.4922">    *   into a single header by joining all header values together</span>
<a href="#l85.4923"></a><span id="l85.4923">    *   with commas, but certain headers (Proxy-Authenticate,</span>
<a href="#l85.4924"></a><span id="l85.4924">    *   WWW-Authenticate, and Set-Cookie) violate the HTTP spec</span>
<a href="#l85.4925"></a><span id="l85.4925">    *   and cannot be collapsed in this manner.  For these headers</span>
<a href="#l85.4926"></a><span id="l85.4926">    *   only, the returned array may contain multiple elements if</span>
<a href="#l85.4927"></a><span id="l85.4927">    *   that header has been added more than once.</span>
<a href="#l85.4928"></a><span id="l85.4928">    */</span>
<a href="#l85.4929"></a><span id="l85.4929" class="difflineminus">-  getHeaderValues: function(fieldName)</span>
<a href="#l85.4930"></a><span id="l85.4930" class="difflineminus">-  {</span>
<a href="#l85.4931"></a><span id="l85.4931" class="difflineplus">+  getHeaderValues(fieldName) {</span>
<a href="#l85.4932"></a><span id="l85.4932">     var name = headerUtils.normalizeFieldName(fieldName);</span>
<a href="#l85.4933"></a><span id="l85.4933"> </span>
<a href="#l85.4934"></a><span id="l85.4934">     if (name in this._headers)</span>
<a href="#l85.4935"></a><span id="l85.4935">       return this._headers[name];</span>
<a href="#l85.4936"></a><span id="l85.4936" class="difflineminus">-    else</span>
<a href="#l85.4937"></a><span id="l85.4937" class="difflineminus">-      throw Cr.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l85.4938"></a><span id="l85.4938" class="difflineplus">+    throw Cr.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l85.4939"></a><span id="l85.4939">   },</span>
<a href="#l85.4940"></a><span id="l85.4940"> </span>
<a href="#l85.4941"></a><span id="l85.4941">   /**</span>
<a href="#l85.4942"></a><span id="l85.4942">    * Returns true if a header with the given field name exists in this, false</span>
<a href="#l85.4943"></a><span id="l85.4943">    * otherwise.</span>
<a href="#l85.4944"></a><span id="l85.4944">    *</span>
<a href="#l85.4945"></a><span id="l85.4945">    * @param fieldName : string</span>
<a href="#l85.4946"></a><span id="l85.4946">    *   the field name whose existence is to be determined in this</span>
<a href="#l85.4947"></a><span id="l85.4947">    * @throws NS_ERROR_INVALID_ARG</span>
<a href="#l85.4948"></a><span id="l85.4948">    *   if fieldName does not constitute a valid header field name</span>
<a href="#l85.4949"></a><span id="l85.4949">    * @returns boolean</span>
<a href="#l85.4950"></a><span id="l85.4950">    *   true if the header's present, false otherwise</span>
<a href="#l85.4951"></a><span id="l85.4951">    */</span>
<a href="#l85.4952"></a><span id="l85.4952" class="difflineminus">-  hasHeader: function(fieldName)</span>
<a href="#l85.4953"></a><span id="l85.4953" class="difflineminus">-  {</span>
<a href="#l85.4954"></a><span id="l85.4954" class="difflineplus">+  hasHeader(fieldName) {</span>
<a href="#l85.4955"></a><span id="l85.4955">     var name = headerUtils.normalizeFieldName(fieldName);</span>
<a href="#l85.4956"></a><span id="l85.4956">     return (name in this._headers);</span>
<a href="#l85.4957"></a><span id="l85.4957">   },</span>
<a href="#l85.4958"></a><span id="l85.4958"> </span>
<a href="#l85.4959"></a><span id="l85.4959">   /**</span>
<a href="#l85.4960"></a><span id="l85.4960">    * Returns a new enumerator over the field names of the headers in this, as</span>
<a href="#l85.4961"></a><span id="l85.4961">    * nsISupportsStrings.  The names returned will be in lowercase, regardless of</span>
<a href="#l85.4962"></a><span id="l85.4962">    * how they were input using setHeader (header names are case-insensitive per</span>
<a href="#l85.4963"></a><span id="l85.4963">    * RFC 2616).</span>
<a href="#l85.4964"></a><span id="l85.4964">    */</span>
<a href="#l85.4965"></a><span id="l85.4965" class="difflineminus">-  get enumerator()</span>
<a href="#l85.4966"></a><span id="l85.4966" class="difflineminus">-  {</span>
<a href="#l85.4967"></a><span id="l85.4967" class="difflineplus">+  get enumerator() {</span>
<a href="#l85.4968"></a><span id="l85.4968">     var headers = [];</span>
<a href="#l85.4969"></a><span id="l85.4969" class="difflineminus">-    for (var i in this._headers)</span>
<a href="#l85.4970"></a><span id="l85.4970" class="difflineminus">-    {</span>
<a href="#l85.4971"></a><span id="l85.4971" class="difflineplus">+    for (var i in this._headers) {</span>
<a href="#l85.4972"></a><span id="l85.4972">       var supports = new SupportsString();</span>
<a href="#l85.4973"></a><span id="l85.4973">       supports.data = i;</span>
<a href="#l85.4974"></a><span id="l85.4974">       headers.push(supports);</span>
<a href="#l85.4975"></a><span id="l85.4975">     }</span>
<a href="#l85.4976"></a><span id="l85.4976"> </span>
<a href="#l85.4977"></a><span id="l85.4977">     return new nsSimpleEnumerator(headers);</span>
<a href="#l85.4978"></a><span id="l85.4978" class="difflineminus">-  }</span>
<a href="#l85.4979"></a><span id="l85.4979" class="difflineplus">+  },</span>
<a href="#l85.4980"></a><span id="l85.4980"> };</span>
<a href="#l85.4981"></a><span id="l85.4981"> </span>
<a href="#l85.4982"></a><span id="l85.4982"> </span>
<a href="#l85.4983"></a><span id="l85.4983"> /**</span>
<a href="#l85.4984"></a><span id="l85.4984">  * Constructs an nsISimpleEnumerator for the given array of items.</span>
<a href="#l85.4985"></a><span id="l85.4985">  *</span>
<a href="#l85.4986"></a><span id="l85.4986">  * @param items : Array</span>
<a href="#l85.4987"></a><span id="l85.4987">  *   the items, which must all implement nsISupports</span>
<a href="#l85.4988"></a><span id="l85.4988">  */</span>
<a href="#l85.4989"></a><span id="l85.4989" class="difflineminus">-function nsSimpleEnumerator(items)</span>
<a href="#l85.4990"></a><span id="l85.4990" class="difflineminus">-{</span>
<a href="#l85.4991"></a><span id="l85.4991" class="difflineplus">+function nsSimpleEnumerator(items) {</span>
<a href="#l85.4992"></a><span id="l85.4992">   this._items = items;</span>
<a href="#l85.4993"></a><span id="l85.4993">   this._nextIndex = 0;</span>
<a href="#l85.4994"></a><span id="l85.4994"> }</span>
<a href="#l85.4995"></a><span id="l85.4995" class="difflineminus">-nsSimpleEnumerator.prototype =</span>
<a href="#l85.4996"></a><span id="l85.4996" class="difflineminus">-{</span>
<a href="#l85.4997"></a><span id="l85.4997" class="difflineminus">-  hasMoreElements: function()</span>
<a href="#l85.4998"></a><span id="l85.4998" class="difflineminus">-  {</span>
<a href="#l85.4999"></a><span id="l85.4999" class="difflineplus">+nsSimpleEnumerator.prototype = {</span>
<a href="#l85.5000"></a><span id="l85.5000" class="difflineplus">+  hasMoreElements() {</span>
<a href="#l85.5001"></a><span id="l85.5001">     return this._nextIndex &lt; this._items.length;</span>
<a href="#l85.5002"></a><span id="l85.5002">   },</span>
<a href="#l85.5003"></a><span id="l85.5003" class="difflineminus">-  getNext: function()</span>
<a href="#l85.5004"></a><span id="l85.5004" class="difflineminus">-  {</span>
<a href="#l85.5005"></a><span id="l85.5005" class="difflineplus">+  getNext() {</span>
<a href="#l85.5006"></a><span id="l85.5006">     if (!this.hasMoreElements())</span>
<a href="#l85.5007"></a><span id="l85.5007">       throw Cr.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l85.5008"></a><span id="l85.5008"> </span>
<a href="#l85.5009"></a><span id="l85.5009">     return this._items[this._nextIndex++];</span>
<a href="#l85.5010"></a><span id="l85.5010">   },</span>
<a href="#l85.5011"></a><span id="l85.5011">   QueryInterface: ChromeUtils.generateQI([&quot;nsISimpleEnumerator&quot;]),</span>
<a href="#l85.5012"></a><span id="l85.5012"> };</span>
<a href="#l85.5013"></a><span id="l85.5013"> </span>
<a href="#l85.5014"></a><span id="l85.5014"> </span>
<a href="#l85.5015"></a><span id="l85.5015"> /**</span>
<a href="#l85.5016"></a><span id="l85.5016">  * A representation of the data in an HTTP request.</span>
<a href="#l85.5017"></a><span id="l85.5017">  *</span>
<a href="#l85.5018"></a><span id="l85.5018">  * @param port : uint</span>
<a href="#l85.5019"></a><span id="l85.5019">  *   the port on which the server receiving this request runs</span>
<a href="#l85.5020"></a><span id="l85.5020">  */</span>
<a href="#l85.5021"></a><span id="l85.5021" class="difflineminus">-function Request(port)</span>
<a href="#l85.5022"></a><span id="l85.5022" class="difflineminus">-{</span>
<a href="#l85.5023"></a><span id="l85.5023" class="difflineplus">+function Request(port) {</span>
<a href="#l85.5024"></a><span id="l85.5024">   /** Method of this request, e.g. GET or POST. */</span>
<a href="#l85.5025"></a><span id="l85.5025">   this._method = &quot;&quot;;</span>
<a href="#l85.5026"></a><span id="l85.5026"> </span>
<a href="#l85.5027"></a><span id="l85.5027">   /** Path of the requested resource; empty paths are converted to '/'. */</span>
<a href="#l85.5028"></a><span id="l85.5028">   this._path = &quot;&quot;;</span>
<a href="#l85.5029"></a><span id="l85.5029"> </span>
<a href="#l85.5030"></a><span id="l85.5030">   /** Query string, if any, associated with this request (not including '?'). */</span>
<a href="#l85.5031"></a><span id="l85.5031">   this._queryString = &quot;&quot;;</span>
<a href="#l85.5032"></a><span id="l85.5032" class="difflineat">@@ -5029,202 +4512,125 @@ function Request(port)</span>
<a href="#l85.5033"></a><span id="l85.5033"> </span>
<a href="#l85.5034"></a><span id="l85.5034">   /**</span>
<a href="#l85.5035"></a><span id="l85.5035">    * For the addition of ad-hoc properties and new functionality without having</span>
<a href="#l85.5036"></a><span id="l85.5036">    * to change nsIHttpRequest every time; currently lazily created, as its only</span>
<a href="#l85.5037"></a><span id="l85.5037">    * use is in directory listings.</span>
<a href="#l85.5038"></a><span id="l85.5038">    */</span>
<a href="#l85.5039"></a><span id="l85.5039">   this._bag = null;</span>
<a href="#l85.5040"></a><span id="l85.5040"> }</span>
<a href="#l85.5041"></a><span id="l85.5041" class="difflineminus">-Request.prototype =</span>
<a href="#l85.5042"></a><span id="l85.5042" class="difflineminus">-{</span>
<a href="#l85.5043"></a><span id="l85.5043" class="difflineplus">+Request.prototype = {</span>
<a href="#l85.5044"></a><span id="l85.5044">   // SERVER METADATA</span>
<a href="#l85.5045"></a><span id="l85.5045"> </span>
<a href="#l85.5046"></a><span id="l85.5046">   //</span>
<a href="#l85.5047"></a><span id="l85.5047">   // see nsIHttpRequest.scheme</span>
<a href="#l85.5048"></a><span id="l85.5048">   //</span>
<a href="#l85.5049"></a><span id="l85.5049" class="difflineminus">-  get scheme()</span>
<a href="#l85.5050"></a><span id="l85.5050" class="difflineminus">-  {</span>
<a href="#l85.5051"></a><span id="l85.5051" class="difflineplus">+  get scheme() {</span>
<a href="#l85.5052"></a><span id="l85.5052">     return this._scheme;</span>
<a href="#l85.5053"></a><span id="l85.5053">   },</span>
<a href="#l85.5054"></a><span id="l85.5054"> </span>
<a href="#l85.5055"></a><span id="l85.5055">   //</span>
<a href="#l85.5056"></a><span id="l85.5056">   // see nsIHttpRequest.host</span>
<a href="#l85.5057"></a><span id="l85.5057">   //</span>
<a href="#l85.5058"></a><span id="l85.5058" class="difflineminus">-  get host()</span>
<a href="#l85.5059"></a><span id="l85.5059" class="difflineminus">-  {</span>
<a href="#l85.5060"></a><span id="l85.5060" class="difflineplus">+  get host() {</span>
<a href="#l85.5061"></a><span id="l85.5061">     return this._host;</span>
<a href="#l85.5062"></a><span id="l85.5062">   },</span>
<a href="#l85.5063"></a><span id="l85.5063"> </span>
<a href="#l85.5064"></a><span id="l85.5064">   //</span>
<a href="#l85.5065"></a><span id="l85.5065">   // see nsIHttpRequest.port</span>
<a href="#l85.5066"></a><span id="l85.5066">   //</span>
<a href="#l85.5067"></a><span id="l85.5067" class="difflineminus">-  get port()</span>
<a href="#l85.5068"></a><span id="l85.5068" class="difflineminus">-  {</span>
<a href="#l85.5069"></a><span id="l85.5069" class="difflineplus">+  get port() {</span>
<a href="#l85.5070"></a><span id="l85.5070">     return this._port;</span>
<a href="#l85.5071"></a><span id="l85.5071">   },</span>
<a href="#l85.5072"></a><span id="l85.5072"> </span>
<a href="#l85.5073"></a><span id="l85.5073">   // REQUEST LINE</span>
<a href="#l85.5074"></a><span id="l85.5074"> </span>
<a href="#l85.5075"></a><span id="l85.5075">   //</span>
<a href="#l85.5076"></a><span id="l85.5076">   // see nsIHttpRequest.method</span>
<a href="#l85.5077"></a><span id="l85.5077">   //</span>
<a href="#l85.5078"></a><span id="l85.5078" class="difflineminus">-  get method()</span>
<a href="#l85.5079"></a><span id="l85.5079" class="difflineminus">-  {</span>
<a href="#l85.5080"></a><span id="l85.5080" class="difflineplus">+  get method() {</span>
<a href="#l85.5081"></a><span id="l85.5081">     return this._method;</span>
<a href="#l85.5082"></a><span id="l85.5082">   },</span>
<a href="#l85.5083"></a><span id="l85.5083"> </span>
<a href="#l85.5084"></a><span id="l85.5084">   //</span>
<a href="#l85.5085"></a><span id="l85.5085">   // see nsIHttpRequest.httpVersion</span>
<a href="#l85.5086"></a><span id="l85.5086">   //</span>
<a href="#l85.5087"></a><span id="l85.5087" class="difflineminus">-  get httpVersion()</span>
<a href="#l85.5088"></a><span id="l85.5088" class="difflineminus">-  {</span>
<a href="#l85.5089"></a><span id="l85.5089" class="difflineplus">+  get httpVersion() {</span>
<a href="#l85.5090"></a><span id="l85.5090">     return this._httpVersion.toString();</span>
<a href="#l85.5091"></a><span id="l85.5091">   },</span>
<a href="#l85.5092"></a><span id="l85.5092"> </span>
<a href="#l85.5093"></a><span id="l85.5093">   //</span>
<a href="#l85.5094"></a><span id="l85.5094">   // see nsIHttpRequest.path</span>
<a href="#l85.5095"></a><span id="l85.5095">   //</span>
<a href="#l85.5096"></a><span id="l85.5096" class="difflineminus">-  get path()</span>
<a href="#l85.5097"></a><span id="l85.5097" class="difflineminus">-  {</span>
<a href="#l85.5098"></a><span id="l85.5098" class="difflineplus">+  get path() {</span>
<a href="#l85.5099"></a><span id="l85.5099">     return this._path;</span>
<a href="#l85.5100"></a><span id="l85.5100">   },</span>
<a href="#l85.5101"></a><span id="l85.5101"> </span>
<a href="#l85.5102"></a><span id="l85.5102">   //</span>
<a href="#l85.5103"></a><span id="l85.5103">   // see nsIHttpRequest.queryString</span>
<a href="#l85.5104"></a><span id="l85.5104">   //</span>
<a href="#l85.5105"></a><span id="l85.5105" class="difflineminus">-  get queryString()</span>
<a href="#l85.5106"></a><span id="l85.5106" class="difflineminus">-  {</span>
<a href="#l85.5107"></a><span id="l85.5107" class="difflineplus">+  get queryString() {</span>
<a href="#l85.5108"></a><span id="l85.5108">     return this._queryString;</span>
<a href="#l85.5109"></a><span id="l85.5109">   },</span>
<a href="#l85.5110"></a><span id="l85.5110"> </span>
<a href="#l85.5111"></a><span id="l85.5111">   // HEADERS</span>
<a href="#l85.5112"></a><span id="l85.5112"> </span>
<a href="#l85.5113"></a><span id="l85.5113">   //</span>
<a href="#l85.5114"></a><span id="l85.5114">   // see nsIHttpRequest.getHeader</span>
<a href="#l85.5115"></a><span id="l85.5115">   //</span>
<a href="#l85.5116"></a><span id="l85.5116" class="difflineminus">-  getHeader: function(name)</span>
<a href="#l85.5117"></a><span id="l85.5117" class="difflineminus">-  {</span>
<a href="#l85.5118"></a><span id="l85.5118" class="difflineplus">+  getHeader(name) {</span>
<a href="#l85.5119"></a><span id="l85.5119">     return this._headers.getHeader(name);</span>
<a href="#l85.5120"></a><span id="l85.5120">   },</span>
<a href="#l85.5121"></a><span id="l85.5121"> </span>
<a href="#l85.5122"></a><span id="l85.5122">   //</span>
<a href="#l85.5123"></a><span id="l85.5123">   // see nsIHttpRequest.hasHeader</span>
<a href="#l85.5124"></a><span id="l85.5124">   //</span>
<a href="#l85.5125"></a><span id="l85.5125" class="difflineminus">-  hasHeader: function(name)</span>
<a href="#l85.5126"></a><span id="l85.5126" class="difflineminus">-  {</span>
<a href="#l85.5127"></a><span id="l85.5127" class="difflineplus">+  hasHeader(name) {</span>
<a href="#l85.5128"></a><span id="l85.5128">     return this._headers.hasHeader(name);</span>
<a href="#l85.5129"></a><span id="l85.5129">   },</span>
<a href="#l85.5130"></a><span id="l85.5130"> </span>
<a href="#l85.5131"></a><span id="l85.5131">   //</span>
<a href="#l85.5132"></a><span id="l85.5132">   // see nsIHttpRequest.headers</span>
<a href="#l85.5133"></a><span id="l85.5133">   //</span>
<a href="#l85.5134"></a><span id="l85.5134" class="difflineminus">-  get headers()</span>
<a href="#l85.5135"></a><span id="l85.5135" class="difflineminus">-  {</span>
<a href="#l85.5136"></a><span id="l85.5136" class="difflineplus">+  get headers() {</span>
<a href="#l85.5137"></a><span id="l85.5137">     return this._headers.enumerator;</span>
<a href="#l85.5138"></a><span id="l85.5138">   },</span>
<a href="#l85.5139"></a><span id="l85.5139"> </span>
<a href="#l85.5140"></a><span id="l85.5140">   //</span>
<a href="#l85.5141"></a><span id="l85.5141">   // see nsIPropertyBag.enumerator</span>
<a href="#l85.5142"></a><span id="l85.5142">   //</span>
<a href="#l85.5143"></a><span id="l85.5143" class="difflineminus">-  get enumerator()</span>
<a href="#l85.5144"></a><span id="l85.5144" class="difflineminus">-  {</span>
<a href="#l85.5145"></a><span id="l85.5145" class="difflineplus">+  get enumerator() {</span>
<a href="#l85.5146"></a><span id="l85.5146">     this._ensurePropertyBag();</span>
<a href="#l85.5147"></a><span id="l85.5147">     return this._bag.enumerator;</span>
<a href="#l85.5148"></a><span id="l85.5148">   },</span>
<a href="#l85.5149"></a><span id="l85.5149"> </span>
<a href="#l85.5150"></a><span id="l85.5150">   //</span>
<a href="#l85.5151"></a><span id="l85.5151">   // see nsIHttpRequest.headers</span>
<a href="#l85.5152"></a><span id="l85.5152">   //</span>
<a href="#l85.5153"></a><span id="l85.5153" class="difflineminus">-  get bodyInputStream()</span>
<a href="#l85.5154"></a><span id="l85.5154" class="difflineminus">-  {</span>
<a href="#l85.5155"></a><span id="l85.5155" class="difflineplus">+  get bodyInputStream() {</span>
<a href="#l85.5156"></a><span id="l85.5156">     return this._bodyInputStream;</span>
<a href="#l85.5157"></a><span id="l85.5157">   },</span>
<a href="#l85.5158"></a><span id="l85.5158"> </span>
<a href="#l85.5159"></a><span id="l85.5159">   //</span>
<a href="#l85.5160"></a><span id="l85.5160">   // see nsIPropertyBag.getProperty</span>
<a href="#l85.5161"></a><span id="l85.5161">   //</span>
<a href="#l85.5162"></a><span id="l85.5162" class="difflineminus">-  getProperty: function(name)</span>
<a href="#l85.5163"></a><span id="l85.5163" class="difflineminus">-  {</span>
<a href="#l85.5164"></a><span id="l85.5164" class="difflineplus">+  getProperty(name) {</span>
<a href="#l85.5165"></a><span id="l85.5165">     this._ensurePropertyBag();</span>
<a href="#l85.5166"></a><span id="l85.5166">     return this._bag.getProperty(name);</span>
<a href="#l85.5167"></a><span id="l85.5167">   },</span>
<a href="#l85.5168"></a><span id="l85.5168"> </span>
<a href="#l85.5169"></a><span id="l85.5169"> </span>
<a href="#l85.5170"></a><span id="l85.5170">   // NSISUPPORTS</span>
<a href="#l85.5171"></a><span id="l85.5171"> </span>
<a href="#l85.5172"></a><span id="l85.5172">   //</span>
<a href="#l85.5173"></a><span id="l85.5173">   // see nsISupports.QueryInterface</span>
<a href="#l85.5174"></a><span id="l85.5174">   //</span>
<a href="#l85.5175"></a><span id="l85.5175">   QueryInterface: ChromeUtils.generateQI([&quot;nsIHttpRequest&quot;]),</span>
<a href="#l85.5176"></a><span id="l85.5176"> </span>
<a href="#l85.5177"></a><span id="l85.5177"> </span>
<a href="#l85.5178"></a><span id="l85.5178">   // PRIVATE IMPLEMENTATION</span>
<a href="#l85.5179"></a><span id="l85.5179"> </span>
<a href="#l85.5180"></a><span id="l85.5180">   /** Ensures a property bag has been created for ad-hoc behaviors. */</span>
<a href="#l85.5181"></a><span id="l85.5181" class="difflineminus">-  _ensurePropertyBag: function()</span>
<a href="#l85.5182"></a><span id="l85.5182" class="difflineminus">-  {</span>
<a href="#l85.5183"></a><span id="l85.5183" class="difflineplus">+  _ensurePropertyBag() {</span>
<a href="#l85.5184"></a><span id="l85.5184">     if (!this._bag)</span>
<a href="#l85.5185"></a><span id="l85.5185">       this._bag = new WritablePropertyBag();</span>
<a href="#l85.5186"></a><span id="l85.5186" class="difflineminus">-  }</span>
<a href="#l85.5187"></a><span id="l85.5187" class="difflineplus">+  },</span>
<a href="#l85.5188"></a><span id="l85.5188"> };</span>
<a href="#l85.5189"></a><span id="l85.5189" class="difflineminus">-</span>
<a href="#l85.5190"></a><span id="l85.5190" class="difflineminus">-</span>
<a href="#l85.5191"></a><span id="l85.5191" class="difflineminus">-// XPCOM trappings</span>
<a href="#l85.5192"></a><span id="l85.5192" class="difflineminus">-</span>
<a href="#l85.5193"></a><span id="l85.5193" class="difflineminus">-var NSGetFactory = XPCOMUtils.generateNSGetFactory([nsHttpServer]);</span>
<a href="#l85.5194"></a><span id="l85.5194" class="difflineminus">-</span>
<a href="#l85.5195"></a><span id="l85.5195" class="difflineminus">-/**</span>
<a href="#l85.5196"></a><span id="l85.5196" class="difflineminus">- * Creates a new HTTP server listening for loopback traffic on the given port,</span>
<a href="#l85.5197"></a><span id="l85.5197" class="difflineminus">- * starts it, and runs the server until the server processes a shutdown request,</span>
<a href="#l85.5198"></a><span id="l85.5198" class="difflineminus">- * spinning an event loop so that events posted by the server's socket are</span>
<a href="#l85.5199"></a><span id="l85.5199" class="difflineminus">- * processed.</span>
<a href="#l85.5200"></a><span id="l85.5200" class="difflineminus">- *</span>
<a href="#l85.5201"></a><span id="l85.5201" class="difflineminus">- * This method is primarily intended for use in running this script from within</span>
<a href="#l85.5202"></a><span id="l85.5202" class="difflineminus">- * xpcshell and running a functional HTTP server without having to deal with</span>
<a href="#l85.5203"></a><span id="l85.5203" class="difflineminus">- * non-essential details.</span>
<a href="#l85.5204"></a><span id="l85.5204" class="difflineminus">- *</span>
<a href="#l85.5205"></a><span id="l85.5205" class="difflineminus">- * Note that running multiple servers using variants of this method probably</span>
<a href="#l85.5206"></a><span id="l85.5206" class="difflineminus">- * doesn't work, simply due to how the internal event loop is spun and stopped.</span>
<a href="#l85.5207"></a><span id="l85.5207" class="difflineminus">- *</span>
<a href="#l85.5208"></a><span id="l85.5208" class="difflineminus">- * @note</span>
<a href="#l85.5209"></a><span id="l85.5209" class="difflineminus">- *   This method only works with Mozilla 1.9 (i.e., Firefox 3 or trunk code);</span>
<a href="#l85.5210"></a><span id="l85.5210" class="difflineminus">- *   you should use this server as a component in Mozilla 1.8.</span>
<a href="#l85.5211"></a><span id="l85.5211" class="difflineminus">- * @param port</span>
<a href="#l85.5212"></a><span id="l85.5212" class="difflineminus">- *   the port on which the server will run, or -1 if there exists no preference</span>
<a href="#l85.5213"></a><span id="l85.5213" class="difflineminus">- *   for a specific port; note that attempting to use some values for this</span>
<a href="#l85.5214"></a><span id="l85.5214" class="difflineminus">- *   parameter (particularly those below 1024) may cause this method to throw or</span>
<a href="#l85.5215"></a><span id="l85.5215" class="difflineminus">- *   may result in the server being prematurely shut down</span>
<a href="#l85.5216"></a><span id="l85.5216" class="difflineminus">- * @param basePath</span>
<a href="#l85.5217"></a><span id="l85.5217" class="difflineminus">- *   a local directory from which requests will be served (i.e., if this is</span>
<a href="#l85.5218"></a><span id="l85.5218" class="difflineminus">- *   &quot;/home/jwalden/&quot; then a request to /index.html will load</span>
<a href="#l85.5219"></a><span id="l85.5219" class="difflineminus">- *   /home/jwalden/index.html); if this is omitted, only the default URLs in</span>
<a href="#l85.5220"></a><span id="l85.5220" class="difflineminus">- *   this server implementation will be functional</span>
<a href="#l85.5221"></a><span id="l85.5221" class="difflineminus">- */</span>
<a href="#l85.5222"></a><span id="l85.5222" class="difflineminus">-function server(port, basePath)</span>
<a href="#l85.5223"></a><span id="l85.5223" class="difflineminus">-{</span>
<a href="#l85.5224"></a><span id="l85.5224" class="difflineminus">-  if (basePath)</span>
<a href="#l85.5225"></a><span id="l85.5225" class="difflineminus">-  {</span>
<a href="#l85.5226"></a><span id="l85.5226" class="difflineminus">-    var lp = Cc[&quot;@mozilla.org/file/local;1&quot;]</span>
<a href="#l85.5227"></a><span id="l85.5227" class="difflineminus">-               .createInstance(Ci.nsIFile);</span>
<a href="#l85.5228"></a><span id="l85.5228" class="difflineminus">-    lp.initWithPath(basePath);</span>
<a href="#l85.5229"></a><span id="l85.5229" class="difflineminus">-  }</span>
<a href="#l85.5230"></a><span id="l85.5230" class="difflineminus">-</span>
<a href="#l85.5231"></a><span id="l85.5231" class="difflineminus">-  // if you're running this, you probably want to see debugging info</span>
<a href="#l85.5232"></a><span id="l85.5232" class="difflineminus">-  DEBUG = true;</span>
<a href="#l85.5233"></a><span id="l85.5233" class="difflineminus">-</span>
<a href="#l85.5234"></a><span id="l85.5234" class="difflineminus">-  var srv = new nsHttpServer();</span>
<a href="#l85.5235"></a><span id="l85.5235" class="difflineminus">-  if (lp)</span>
<a href="#l85.5236"></a><span id="l85.5236" class="difflineminus">-    srv.registerDirectory(&quot;/&quot;, lp);</span>
<a href="#l85.5237"></a><span id="l85.5237" class="difflineminus">-  srv.registerContentType(&quot;sjs&quot;, SJS_TYPE);</span>
<a href="#l85.5238"></a><span id="l85.5238" class="difflineminus">-  srv.identity.setPrimary(&quot;http&quot;, &quot;localhost&quot;, port);</span>
<a href="#l85.5239"></a><span id="l85.5239" class="difflineminus">-  srv.start(port);</span>
<a href="#l85.5240"></a><span id="l85.5240" class="difflineminus">-</span>
<a href="#l85.5241"></a><span id="l85.5241" class="difflineminus">-  var thread = gThreadManager.currentThread;</span>
<a href="#l85.5242"></a><span id="l85.5242" class="difflineminus">-  while (!srv.isStopped())</span>
<a href="#l85.5243"></a><span id="l85.5243" class="difflineminus">-    thread.processNextEvent(true);</span>
<a href="#l85.5244"></a><span id="l85.5244" class="difflineminus">-</span>
<a href="#l85.5245"></a><span id="l85.5245" class="difflineminus">-  // get rid of any pending requests</span>
<a href="#l85.5246"></a><span id="l85.5246" class="difflineminus">-  while (thread.hasPendingEvents())</span>
<a href="#l85.5247"></a><span id="l85.5247" class="difflineminus">-    thread.processNextEvent(true);</span>
<a href="#l85.5248"></a><span id="l85.5248" class="difflineminus">-</span>
<a href="#l85.5249"></a><span id="l85.5249" class="difflineminus">-  DEBUG = false;</span>
<a href="#l85.5250"></a><span id="l85.5250" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l86.1"></a><span id="l86.1">deleted file mode 100644</span>
<a href="#l86.2"></a><span id="l86.2" class="difflineminus">--- a/mail/test/resources/mozmill/mozmill/extension/content/stdlib/json2.js</span>
<a href="#l86.3"></a><span id="l86.3" class="difflineplus">+++ /dev/null</span>
<a href="#l86.4"></a><span id="l86.4" class="difflineat">@@ -1,473 +0,0 @@</span>
<a href="#l86.5"></a><span id="l86.5" class="difflineminus">-/*</span>
<a href="#l86.6"></a><span id="l86.6" class="difflineminus">-    http://www.JSON.org/json2.js</span>
<a href="#l86.7"></a><span id="l86.7" class="difflineminus">-    2008-05-25</span>
<a href="#l86.8"></a><span id="l86.8" class="difflineminus">-</span>
<a href="#l86.9"></a><span id="l86.9" class="difflineminus">-    Public Domain.</span>
<a href="#l86.10"></a><span id="l86.10" class="difflineminus">-</span>
<a href="#l86.11"></a><span id="l86.11" class="difflineminus">-    NO WARRANTY EXPRESSED OR IMPLIED. USE AT YOUR OWN RISK.</span>
<a href="#l86.12"></a><span id="l86.12" class="difflineminus">-</span>
<a href="#l86.13"></a><span id="l86.13" class="difflineminus">-    See http://www.JSON.org/js.html</span>
<a href="#l86.14"></a><span id="l86.14" class="difflineminus">-</span>
<a href="#l86.15"></a><span id="l86.15" class="difflineminus">-    This file creates a global JSON object containing two methods: stringify</span>
<a href="#l86.16"></a><span id="l86.16" class="difflineminus">-    and parse.</span>
<a href="#l86.17"></a><span id="l86.17" class="difflineminus">-</span>
<a href="#l86.18"></a><span id="l86.18" class="difflineminus">-        JSON.stringify(value, replacer, space)</span>
<a href="#l86.19"></a><span id="l86.19" class="difflineminus">-            value       any JavaScript value, usually an object or array.</span>
<a href="#l86.20"></a><span id="l86.20" class="difflineminus">-</span>
<a href="#l86.21"></a><span id="l86.21" class="difflineminus">-            replacer    an optional parameter that determines how object</span>
<a href="#l86.22"></a><span id="l86.22" class="difflineminus">-                        values are stringified for objects without a toJSON</span>
<a href="#l86.23"></a><span id="l86.23" class="difflineminus">-                        method. It can be a function or an array.</span>
<a href="#l86.24"></a><span id="l86.24" class="difflineminus">-</span>
<a href="#l86.25"></a><span id="l86.25" class="difflineminus">-            space       an optional parameter that specifies the indentation</span>
<a href="#l86.26"></a><span id="l86.26" class="difflineminus">-                        of nested structures. If it is omitted, the text will</span>
<a href="#l86.27"></a><span id="l86.27" class="difflineminus">-                        be packed without extra whitespace. If it is a number,</span>
<a href="#l86.28"></a><span id="l86.28" class="difflineminus">-                        it will specify the number of spaces to indent at each</span>
<a href="#l86.29"></a><span id="l86.29" class="difflineminus">-                        level. If it is a string (such as '\t' or '&amp;nbsp;'),</span>
<a href="#l86.30"></a><span id="l86.30" class="difflineminus">-                        it contains the characters used to indent at each level.</span>
<a href="#l86.31"></a><span id="l86.31" class="difflineminus">-</span>
<a href="#l86.32"></a><span id="l86.32" class="difflineminus">-            This method produces a JSON text from a JavaScript value.</span>
<a href="#l86.33"></a><span id="l86.33" class="difflineminus">-</span>
<a href="#l86.34"></a><span id="l86.34" class="difflineminus">-            When an object value is found, if the object contains a toJSON</span>
<a href="#l86.35"></a><span id="l86.35" class="difflineminus">-            method, its toJSON method will be called and the result will be</span>
<a href="#l86.36"></a><span id="l86.36" class="difflineminus">-            stringified. A toJSON method does not serialize: it returns the</span>
<a href="#l86.37"></a><span id="l86.37" class="difflineminus">-            value represented by the name/value pair that should be serialized,</span>
<a href="#l86.38"></a><span id="l86.38" class="difflineminus">-            or undefined if nothing should be serialized. The toJSON method</span>
<a href="#l86.39"></a><span id="l86.39" class="difflineminus">-            will be passed the key associated with the value, and this will be</span>
<a href="#l86.40"></a><span id="l86.40" class="difflineminus">-            bound to the object holding the key.</span>
<a href="#l86.41"></a><span id="l86.41" class="difflineminus">-</span>
<a href="#l86.42"></a><span id="l86.42" class="difflineminus">-            For example, this would serialize Dates as ISO strings.</span>
<a href="#l86.43"></a><span id="l86.43" class="difflineminus">-</span>
<a href="#l86.44"></a><span id="l86.44" class="difflineminus">-                Date.prototype.toJSON = function (key) {</span>
<a href="#l86.45"></a><span id="l86.45" class="difflineminus">-                    function f(n) {</span>
<a href="#l86.46"></a><span id="l86.46" class="difflineminus">-                        // Format integers to have at least two digits.</span>
<a href="#l86.47"></a><span id="l86.47" class="difflineminus">-                        return n &lt; 10 ? '0' + n : n;</span>
<a href="#l86.48"></a><span id="l86.48" class="difflineminus">-                    }</span>
<a href="#l86.49"></a><span id="l86.49" class="difflineminus">-</span>
<a href="#l86.50"></a><span id="l86.50" class="difflineminus">-                    return this.getUTCFullYear()   + '-' +</span>
<a href="#l86.51"></a><span id="l86.51" class="difflineminus">-                         f(this.getUTCMonth() + 1) + '-' +</span>
<a href="#l86.52"></a><span id="l86.52" class="difflineminus">-                         f(this.getUTCDate())      + 'T' +</span>
<a href="#l86.53"></a><span id="l86.53" class="difflineminus">-                         f(this.getUTCHours())     + ':' +</span>
<a href="#l86.54"></a><span id="l86.54" class="difflineminus">-                         f(this.getUTCMinutes())   + ':' +</span>
<a href="#l86.55"></a><span id="l86.55" class="difflineminus">-                         f(this.getUTCSeconds())   + 'Z';</span>
<a href="#l86.56"></a><span id="l86.56" class="difflineminus">-                };</span>
<a href="#l86.57"></a><span id="l86.57" class="difflineminus">-</span>
<a href="#l86.58"></a><span id="l86.58" class="difflineminus">-            You can provide an optional replacer method. It will be passed the</span>
<a href="#l86.59"></a><span id="l86.59" class="difflineminus">-            key and value of each member, with this bound to the containing</span>
<a href="#l86.60"></a><span id="l86.60" class="difflineminus">-            object. The value that is returned from your method will be</span>
<a href="#l86.61"></a><span id="l86.61" class="difflineminus">-            serialized. If your method returns undefined, then the member will</span>
<a href="#l86.62"></a><span id="l86.62" class="difflineminus">-            be excluded from the serialization.</span>
<a href="#l86.63"></a><span id="l86.63" class="difflineminus">-</span>
<a href="#l86.64"></a><span id="l86.64" class="difflineminus">-            If the replacer parameter is an array, then it will be used to</span>
<a href="#l86.65"></a><span id="l86.65" class="difflineminus">-            select the members to be serialized. It filters the results such</span>
<a href="#l86.66"></a><span id="l86.66" class="difflineminus">-            that only members with keys listed in the replacer array are</span>
<a href="#l86.67"></a><span id="l86.67" class="difflineminus">-            stringified.</span>
<a href="#l86.68"></a><span id="l86.68" class="difflineminus">-</span>
<a href="#l86.69"></a><span id="l86.69" class="difflineminus">-            Values that do not have JSON representations, such as undefined or</span>
<a href="#l86.70"></a><span id="l86.70" class="difflineminus">-            functions, will not be serialized. Such values in objects will be</span>
<a href="#l86.71"></a><span id="l86.71" class="difflineminus">-            dropped; in arrays they will be replaced with null. You can use</span>
<a href="#l86.72"></a><span id="l86.72" class="difflineminus">-            a replacer function to replace those with JSON values.</span>
<a href="#l86.73"></a><span id="l86.73" class="difflineminus">-            JSON.stringify(undefined) returns undefined.</span>
<a href="#l86.74"></a><span id="l86.74" class="difflineminus">-</span>
<a href="#l86.75"></a><span id="l86.75" class="difflineminus">-            The optional space parameter produces a stringification of the</span>
<a href="#l86.76"></a><span id="l86.76" class="difflineminus">-            value that is filled with line breaks and indentation to make it</span>
<a href="#l86.77"></a><span id="l86.77" class="difflineminus">-            easier to read.</span>
<a href="#l86.78"></a><span id="l86.78" class="difflineminus">-</span>
<a href="#l86.79"></a><span id="l86.79" class="difflineminus">-            If the space parameter is a non-empty string, then that string will</span>
<a href="#l86.80"></a><span id="l86.80" class="difflineminus">-            be used for indentation. If the space parameter is a number, then</span>
<a href="#l86.81"></a><span id="l86.81" class="difflineminus">-            the indentation will be that many spaces.</span>
<a href="#l86.82"></a><span id="l86.82" class="difflineminus">-</span>
<a href="#l86.83"></a><span id="l86.83" class="difflineminus">-            Example:</span>
<a href="#l86.84"></a><span id="l86.84" class="difflineminus">-</span>
<a href="#l86.85"></a><span id="l86.85" class="difflineminus">-            text = JSON.stringify(['e', {pluribus: 'unum'}]);</span>
<a href="#l86.86"></a><span id="l86.86" class="difflineminus">-            // text is '[&quot;e&quot;,{&quot;pluribus&quot;:&quot;unum&quot;}]'</span>
<a href="#l86.87"></a><span id="l86.87" class="difflineminus">-</span>
<a href="#l86.88"></a><span id="l86.88" class="difflineminus">-</span>
<a href="#l86.89"></a><span id="l86.89" class="difflineminus">-            text = JSON.stringify(['e', {pluribus: 'unum'}], null, '\t');</span>
<a href="#l86.90"></a><span id="l86.90" class="difflineminus">-            // text is '[\n\t&quot;e&quot;,\n\t{\n\t\t&quot;pluribus&quot;: &quot;unum&quot;\n\t}\n]'</span>
<a href="#l86.91"></a><span id="l86.91" class="difflineminus">-</span>
<a href="#l86.92"></a><span id="l86.92" class="difflineminus">-            text = JSON.stringify([new Date()], function (key, value) {</span>
<a href="#l86.93"></a><span id="l86.93" class="difflineminus">-                return this[key] instanceof Date ?</span>
<a href="#l86.94"></a><span id="l86.94" class="difflineminus">-                    'Date(' + this[key] + ')' : value;</span>
<a href="#l86.95"></a><span id="l86.95" class="difflineminus">-            });</span>
<a href="#l86.96"></a><span id="l86.96" class="difflineminus">-            // text is '[&quot;Date(---current time---)&quot;]'</span>
<a href="#l86.97"></a><span id="l86.97" class="difflineminus">-</span>
<a href="#l86.98"></a><span id="l86.98" class="difflineminus">-</span>
<a href="#l86.99"></a><span id="l86.99" class="difflineminus">-        JSON.parse(text, reviver)</span>
<a href="#l86.100"></a><span id="l86.100" class="difflineminus">-            This method parses a JSON text to produce an object or array.</span>
<a href="#l86.101"></a><span id="l86.101" class="difflineminus">-            It can throw a SyntaxError exception.</span>
<a href="#l86.102"></a><span id="l86.102" class="difflineminus">-</span>
<a href="#l86.103"></a><span id="l86.103" class="difflineminus">-            The optional reviver parameter is a function that can filter and</span>
<a href="#l86.104"></a><span id="l86.104" class="difflineminus">-            transform the results. It receives each of the keys and values,</span>
<a href="#l86.105"></a><span id="l86.105" class="difflineminus">-            and its return value is used instead of the original value.</span>
<a href="#l86.106"></a><span id="l86.106" class="difflineminus">-            If it returns what it received, then the structure is not modified.</span>
<a href="#l86.107"></a><span id="l86.107" class="difflineminus">-            If it returns undefined then the member is deleted.</span>
<a href="#l86.108"></a><span id="l86.108" class="difflineminus">-</span>
<a href="#l86.109"></a><span id="l86.109" class="difflineminus">-            Example:</span>
<a href="#l86.110"></a><span id="l86.110" class="difflineminus">-</span>
<a href="#l86.111"></a><span id="l86.111" class="difflineminus">-            // Parse the text. Values that look like ISO date strings will</span>
<a href="#l86.112"></a><span id="l86.112" class="difflineminus">-            // be converted to Date objects.</span>
<a href="#l86.113"></a><span id="l86.113" class="difflineminus">-</span>
<a href="#l86.114"></a><span id="l86.114" class="difflineminus">-            myData = JSON.parse(text, function (key, value) {</span>
<a href="#l86.115"></a><span id="l86.115" class="difflineminus">-                var a;</span>
<a href="#l86.116"></a><span id="l86.116" class="difflineminus">-                if (typeof value === 'string') {</span>
<a href="#l86.117"></a><span id="l86.117" class="difflineminus">-                    a =</span>
<a href="#l86.118"></a><span id="l86.118" class="difflineminus">-/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2}(?:\.\d*)?)Z$/.exec(value);</span>
<a href="#l86.119"></a><span id="l86.119" class="difflineminus">-                    if (a) {</span>
<a href="#l86.120"></a><span id="l86.120" class="difflineminus">-                        return new Date(Date.UTC(+a[1], +a[2] - 1, +a[3], +a[4],</span>
<a href="#l86.121"></a><span id="l86.121" class="difflineminus">-                            +a[5], +a[6]));</span>
<a href="#l86.122"></a><span id="l86.122" class="difflineminus">-                    }</span>
<a href="#l86.123"></a><span id="l86.123" class="difflineminus">-                }</span>
<a href="#l86.124"></a><span id="l86.124" class="difflineminus">-                return value;</span>
<a href="#l86.125"></a><span id="l86.125" class="difflineminus">-            });</span>
<a href="#l86.126"></a><span id="l86.126" class="difflineminus">-</span>
<a href="#l86.127"></a><span id="l86.127" class="difflineminus">-            myData = JSON.parse('[&quot;Date(09/09/2001)&quot;]', function (key, value) {</span>
<a href="#l86.128"></a><span id="l86.128" class="difflineminus">-                var d;</span>
<a href="#l86.129"></a><span id="l86.129" class="difflineminus">-                if (typeof value === 'string' &amp;&amp;</span>
<a href="#l86.130"></a><span id="l86.130" class="difflineminus">-                        value.slice(0, 5) === 'Date(' &amp;&amp;</span>
<a href="#l86.131"></a><span id="l86.131" class="difflineminus">-                        value.slice(-1) === ')') {</span>
<a href="#l86.132"></a><span id="l86.132" class="difflineminus">-                    d = new Date(value.slice(5, -1));</span>
<a href="#l86.133"></a><span id="l86.133" class="difflineminus">-                    if (d) {</span>
<a href="#l86.134"></a><span id="l86.134" class="difflineminus">-                        return d;</span>
<a href="#l86.135"></a><span id="l86.135" class="difflineminus">-                    }</span>
<a href="#l86.136"></a><span id="l86.136" class="difflineminus">-                }</span>
<a href="#l86.137"></a><span id="l86.137" class="difflineminus">-                return value;</span>
<a href="#l86.138"></a><span id="l86.138" class="difflineminus">-            });</span>
<a href="#l86.139"></a><span id="l86.139" class="difflineminus">-</span>
<a href="#l86.140"></a><span id="l86.140" class="difflineminus">-</span>
<a href="#l86.141"></a><span id="l86.141" class="difflineminus">-    This is a reference implementation. You are free to copy, modify, or</span>
<a href="#l86.142"></a><span id="l86.142" class="difflineminus">-    redistribute.</span>
<a href="#l86.143"></a><span id="l86.143" class="difflineminus">-</span>
<a href="#l86.144"></a><span id="l86.144" class="difflineminus">-    This code should be minified before deployment.</span>
<a href="#l86.145"></a><span id="l86.145" class="difflineminus">-    See http://javascript.crockford.com/jsmin.html</span>
<a href="#l86.146"></a><span id="l86.146" class="difflineminus">-</span>
<a href="#l86.147"></a><span id="l86.147" class="difflineminus">-    USE YOUR OWN COPY. IT IS EXTREMELY UNWISE TO LOAD CODE FROM SERVERS YOU DO</span>
<a href="#l86.148"></a><span id="l86.148" class="difflineminus">-    NOT CONTROL.</span>
<a href="#l86.149"></a><span id="l86.149" class="difflineminus">-*/</span>
<a href="#l86.150"></a><span id="l86.150" class="difflineminus">-</span>
<a href="#l86.151"></a><span id="l86.151" class="difflineminus">-/*jslint evil: true */</span>
<a href="#l86.152"></a><span id="l86.152" class="difflineminus">-</span>
<a href="#l86.153"></a><span id="l86.153" class="difflineminus">-/*global JSON */</span>
<a href="#l86.154"></a><span id="l86.154" class="difflineminus">-</span>
<a href="#l86.155"></a><span id="l86.155" class="difflineminus">-/*members &quot;&quot;, &quot;\b&quot;, &quot;\t&quot;, &quot;\n&quot;, &quot;\f&quot;, &quot;\r&quot;, &quot;\&quot;&quot;, JSON, &quot;\\&quot;, call,</span>
<a href="#l86.156"></a><span id="l86.156" class="difflineminus">-    charCodeAt, getUTCDate, getUTCFullYear, getUTCHours, getUTCMinutes,</span>
<a href="#l86.157"></a><span id="l86.157" class="difflineminus">-    getUTCMonth, getUTCSeconds, hasOwnProperty, join, lastIndex, length,</span>
<a href="#l86.158"></a><span id="l86.158" class="difflineminus">-    parse, propertyIsEnumerable, prototype, push, replace, slice, stringify,</span>
<a href="#l86.159"></a><span id="l86.159" class="difflineminus">-    test, toJSON, toString</span>
<a href="#l86.160"></a><span id="l86.160" class="difflineminus">-*/</span>
<a href="#l86.161"></a><span id="l86.161" class="difflineminus">-</span>
<a href="#l86.162"></a><span id="l86.162" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;JSON&quot;];</span>
<a href="#l86.163"></a><span id="l86.163" class="difflineminus">-var JSON = Cu.getGlobalForObject(this).JSON;</span>
<a href="#l86.164"></a><span id="l86.164" class="difflineminus">-</span>
<a href="#l86.165"></a><span id="l86.165" class="difflineminus">-if (!JSON) {</span>
<a href="#l86.166"></a><span id="l86.166" class="difflineminus">-  dump(&quot;mozmill/extension/resource/stdlib/json2.js: creating JSON object\n&quot;);</span>
<a href="#l86.167"></a><span id="l86.167" class="difflineminus">-</span>
<a href="#l86.168"></a><span id="l86.168" class="difflineminus">-// Create a JSON object only if one does not already exist. We create the</span>
<a href="#l86.169"></a><span id="l86.169" class="difflineminus">-// object in a closure to avoid creating global variables.</span>
<a href="#l86.170"></a><span id="l86.170" class="difflineminus">-</span>
<a href="#l86.171"></a><span id="l86.171" class="difflineminus">-    JSON = function () {</span>
<a href="#l86.172"></a><span id="l86.172" class="difflineminus">-</span>
<a href="#l86.173"></a><span id="l86.173" class="difflineminus">-        function f(n) {</span>
<a href="#l86.174"></a><span id="l86.174" class="difflineminus">-            // Format integers to have at least two digits.</span>
<a href="#l86.175"></a><span id="l86.175" class="difflineminus">-            return n &lt; 10 ? '0' + n : n;</span>
<a href="#l86.176"></a><span id="l86.176" class="difflineminus">-        }</span>
<a href="#l86.177"></a><span id="l86.177" class="difflineminus">-</span>
<a href="#l86.178"></a><span id="l86.178" class="difflineminus">-        Date.prototype.toJSON = function (key) {</span>
<a href="#l86.179"></a><span id="l86.179" class="difflineminus">-</span>
<a href="#l86.180"></a><span id="l86.180" class="difflineminus">-            return this.getUTCFullYear()   + '-' +</span>
<a href="#l86.181"></a><span id="l86.181" class="difflineminus">-                 f(this.getUTCMonth() + 1) + '-' +</span>
<a href="#l86.182"></a><span id="l86.182" class="difflineminus">-                 f(this.getUTCDate())      + 'T' +</span>
<a href="#l86.183"></a><span id="l86.183" class="difflineminus">-                 f(this.getUTCHours())     + ':' +</span>
<a href="#l86.184"></a><span id="l86.184" class="difflineminus">-                 f(this.getUTCMinutes())   + ':' +</span>
<a href="#l86.185"></a><span id="l86.185" class="difflineminus">-                 f(this.getUTCSeconds())   + 'Z';</span>
<a href="#l86.186"></a><span id="l86.186" class="difflineminus">-        };</span>
<a href="#l86.187"></a><span id="l86.187" class="difflineminus">-</span>
<a href="#l86.188"></a><span id="l86.188" class="difflineminus">-        var cx = /[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,</span>
<a href="#l86.189"></a><span id="l86.189" class="difflineminus">-            escapeable = /[\\\&quot;\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,</span>
<a href="#l86.190"></a><span id="l86.190" class="difflineminus">-            gap,</span>
<a href="#l86.191"></a><span id="l86.191" class="difflineminus">-            indent,</span>
<a href="#l86.192"></a><span id="l86.192" class="difflineminus">-            meta = {    // table of character substitutions</span>
<a href="#l86.193"></a><span id="l86.193" class="difflineminus">-                '\b': '\\b',</span>
<a href="#l86.194"></a><span id="l86.194" class="difflineminus">-                '\t': '\\t',</span>
<a href="#l86.195"></a><span id="l86.195" class="difflineminus">-                '\n': '\\n',</span>
<a href="#l86.196"></a><span id="l86.196" class="difflineminus">-                '\f': '\\f',</span>
<a href="#l86.197"></a><span id="l86.197" class="difflineminus">-                '\r': '\\r',</span>
<a href="#l86.198"></a><span id="l86.198" class="difflineminus">-                '&quot;' : '\\&quot;',</span>
<a href="#l86.199"></a><span id="l86.199" class="difflineminus">-                '\\': '\\\\'</span>
<a href="#l86.200"></a><span id="l86.200" class="difflineminus">-            },</span>
<a href="#l86.201"></a><span id="l86.201" class="difflineminus">-            rep;</span>
<a href="#l86.202"></a><span id="l86.202" class="difflineminus">-</span>
<a href="#l86.203"></a><span id="l86.203" class="difflineminus">-</span>
<a href="#l86.204"></a><span id="l86.204" class="difflineminus">-        function quote(string) {</span>
<a href="#l86.205"></a><span id="l86.205" class="difflineminus">-</span>
<a href="#l86.206"></a><span id="l86.206" class="difflineminus">-// If the string contains no control characters, no quote characters, and no</span>
<a href="#l86.207"></a><span id="l86.207" class="difflineminus">-// backslash characters, then we can safely slap some quotes around it.</span>
<a href="#l86.208"></a><span id="l86.208" class="difflineminus">-// Otherwise we must also replace the offending characters with safe escape</span>
<a href="#l86.209"></a><span id="l86.209" class="difflineminus">-// sequences.</span>
<a href="#l86.210"></a><span id="l86.210" class="difflineminus">-</span>
<a href="#l86.211"></a><span id="l86.211" class="difflineminus">-            escapeable.lastIndex = 0;</span>
<a href="#l86.212"></a><span id="l86.212" class="difflineminus">-            return escapeable.test(string) ?</span>
<a href="#l86.213"></a><span id="l86.213" class="difflineminus">-                '&quot;' + string.replace(escapeable, function (a) {</span>
<a href="#l86.214"></a><span id="l86.214" class="difflineminus">-                    var c = meta[a];</span>
<a href="#l86.215"></a><span id="l86.215" class="difflineminus">-                    if (typeof c === 'string') {</span>
<a href="#l86.216"></a><span id="l86.216" class="difflineminus">-                        return c;</span>
<a href="#l86.217"></a><span id="l86.217" class="difflineminus">-                    }</span>
<a href="#l86.218"></a><span id="l86.218" class="difflineminus">-                    return '\\u' + ('0000' +</span>
<a href="#l86.219"></a><span id="l86.219" class="difflineminus">-                            (+(a.charCodeAt(0))).toString(16)).slice(-4);</span>
<a href="#l86.220"></a><span id="l86.220" class="difflineminus">-                }) + '&quot;' :</span>
<a href="#l86.221"></a><span id="l86.221" class="difflineminus">-                '&quot;' + string + '&quot;';</span>
<a href="#l86.222"></a><span id="l86.222" class="difflineminus">-        }</span>
<a href="#l86.223"></a><span id="l86.223" class="difflineminus">-</span>
<a href="#l86.224"></a><span id="l86.224" class="difflineminus">-</span>
<a href="#l86.225"></a><span id="l86.225" class="difflineminus">-        function str(key, holder) {</span>
<a href="#l86.226"></a><span id="l86.226" class="difflineminus">-</span>
<a href="#l86.227"></a><span id="l86.227" class="difflineminus">-// Produce a string from holder[key].</span>
<a href="#l86.228"></a><span id="l86.228" class="difflineminus">-</span>
<a href="#l86.229"></a><span id="l86.229" class="difflineminus">-            var i,          // The loop counter.</span>
<a href="#l86.230"></a><span id="l86.230" class="difflineminus">-                k,          // The member key.</span>
<a href="#l86.231"></a><span id="l86.231" class="difflineminus">-                v,          // The member value.</span>
<a href="#l86.232"></a><span id="l86.232" class="difflineminus">-                length,</span>
<a href="#l86.233"></a><span id="l86.233" class="difflineminus">-                mind = gap,</span>
<a href="#l86.234"></a><span id="l86.234" class="difflineminus">-                partial,</span>
<a href="#l86.235"></a><span id="l86.235" class="difflineminus">-                value = holder[key];</span>
<a href="#l86.236"></a><span id="l86.236" class="difflineminus">-</span>
<a href="#l86.237"></a><span id="l86.237" class="difflineminus">-// If the value has a toJSON method, call it to obtain a replacement value.</span>
<a href="#l86.238"></a><span id="l86.238" class="difflineminus">-</span>
<a href="#l86.239"></a><span id="l86.239" class="difflineminus">-            if (value &amp;&amp; typeof value === 'object' &amp;&amp;</span>
<a href="#l86.240"></a><span id="l86.240" class="difflineminus">-                    typeof value.toJSON === 'function') {</span>
<a href="#l86.241"></a><span id="l86.241" class="difflineminus">-                value = value.toJSON(key);</span>
<a href="#l86.242"></a><span id="l86.242" class="difflineminus">-            }</span>
<a href="#l86.243"></a><span id="l86.243" class="difflineminus">-</span>
<a href="#l86.244"></a><span id="l86.244" class="difflineminus">-// If we were called with a replacer function, then call the replacer to</span>
<a href="#l86.245"></a><span id="l86.245" class="difflineminus">-// obtain a replacement value.</span>
<a href="#l86.246"></a><span id="l86.246" class="difflineminus">-</span>
<a href="#l86.247"></a><span id="l86.247" class="difflineminus">-            if (typeof rep === 'function') {</span>
<a href="#l86.248"></a><span id="l86.248" class="difflineminus">-                value = rep.call(holder, key, value);</span>
<a href="#l86.249"></a><span id="l86.249" class="difflineminus">-            }</span>
<a href="#l86.250"></a><span id="l86.250" class="difflineminus">-</span>
<a href="#l86.251"></a><span id="l86.251" class="difflineminus">-// What happens next depends on the value's type.</span>
<a href="#l86.252"></a><span id="l86.252" class="difflineminus">-</span>
<a href="#l86.253"></a><span id="l86.253" class="difflineminus">-            switch (typeof value) {</span>
<a href="#l86.254"></a><span id="l86.254" class="difflineminus">-            case 'string':</span>
<a href="#l86.255"></a><span id="l86.255" class="difflineminus">-                return quote(value);</span>
<a href="#l86.256"></a><span id="l86.256" class="difflineminus">-</span>
<a href="#l86.257"></a><span id="l86.257" class="difflineminus">-            case 'number':</span>
<a href="#l86.258"></a><span id="l86.258" class="difflineminus">-</span>
<a href="#l86.259"></a><span id="l86.259" class="difflineminus">-// JSON numbers must be finite. Encode non-finite numbers as null.</span>
<a href="#l86.260"></a><span id="l86.260" class="difflineminus">-</span>
<a href="#l86.261"></a><span id="l86.261" class="difflineminus">-                return isFinite(value) ? String(value) : 'null';</span>
<a href="#l86.262"></a><span id="l86.262" class="difflineminus">-</span>
<a href="#l86.263"></a><span id="l86.263" class="difflineminus">-            case 'boolean':</span>
<a href="#l86.264"></a><span id="l86.264" class="difflineminus">-            case 'null':</span>
<a href="#l86.265"></a><span id="l86.265" class="difflineminus">-</span>
<a href="#l86.266"></a><span id="l86.266" class="difflineminus">-// If the value is a boolean or null, convert it to a string. Note:</span>
<a href="#l86.267"></a><span id="l86.267" class="difflineminus">-// typeof null does not produce 'null'. The case is included here in</span>
<a href="#l86.268"></a><span id="l86.268" class="difflineminus">-// the remote chance that this gets fixed someday.</span>
<a href="#l86.269"></a><span id="l86.269" class="difflineminus">-</span>
<a href="#l86.270"></a><span id="l86.270" class="difflineminus">-                return String(value);</span>
<a href="#l86.271"></a><span id="l86.271" class="difflineminus">-</span>
<a href="#l86.272"></a><span id="l86.272" class="difflineminus">-// If the type is 'object', we might be dealing with an object or an array or</span>
<a href="#l86.273"></a><span id="l86.273" class="difflineminus">-// null.</span>
<a href="#l86.274"></a><span id="l86.274" class="difflineminus">-</span>
<a href="#l86.275"></a><span id="l86.275" class="difflineminus">-            case 'object':</span>
<a href="#l86.276"></a><span id="l86.276" class="difflineminus">-</span>
<a href="#l86.277"></a><span id="l86.277" class="difflineminus">-// Due to a specification blunder in ECMAScript, typeof null is 'object',</span>
<a href="#l86.278"></a><span id="l86.278" class="difflineminus">-// so watch out for that case.</span>
<a href="#l86.279"></a><span id="l86.279" class="difflineminus">-</span>
<a href="#l86.280"></a><span id="l86.280" class="difflineminus">-                if (!value) {</span>
<a href="#l86.281"></a><span id="l86.281" class="difflineminus">-                    return 'null';</span>
<a href="#l86.282"></a><span id="l86.282" class="difflineminus">-                }</span>
<a href="#l86.283"></a><span id="l86.283" class="difflineminus">-</span>
<a href="#l86.284"></a><span id="l86.284" class="difflineminus">-// Make an array to hold the partial results of stringifying this object value.</span>
<a href="#l86.285"></a><span id="l86.285" class="difflineminus">-</span>
<a href="#l86.286"></a><span id="l86.286" class="difflineminus">-                gap += indent;</span>
<a href="#l86.287"></a><span id="l86.287" class="difflineminus">-                partial = [];</span>
<a href="#l86.288"></a><span id="l86.288" class="difflineminus">-</span>
<a href="#l86.289"></a><span id="l86.289" class="difflineminus">-// If the object has a dontEnum length property, we'll treat it as an array.</span>
<a href="#l86.290"></a><span id="l86.290" class="difflineminus">-</span>
<a href="#l86.291"></a><span id="l86.291" class="difflineminus">-                if (typeof value.length === 'number' &amp;&amp;</span>
<a href="#l86.292"></a><span id="l86.292" class="difflineminus">-                        !(value.propertyIsEnumerable('length'))) {</span>
<a href="#l86.293"></a><span id="l86.293" class="difflineminus">-</span>
<a href="#l86.294"></a><span id="l86.294" class="difflineminus">-// The object is an array. Stringify every element. Use null as a placeholder</span>
<a href="#l86.295"></a><span id="l86.295" class="difflineminus">-// for non-JSON values.</span>
<a href="#l86.296"></a><span id="l86.296" class="difflineminus">-</span>
<a href="#l86.297"></a><span id="l86.297" class="difflineminus">-                    length = value.length;</span>
<a href="#l86.298"></a><span id="l86.298" class="difflineminus">-                    for (i = 0; i &lt; length; i += 1) {</span>
<a href="#l86.299"></a><span id="l86.299" class="difflineminus">-                        partial[i] = str(i, value) || 'null';</span>
<a href="#l86.300"></a><span id="l86.300" class="difflineminus">-                    }</span>
<a href="#l86.301"></a><span id="l86.301" class="difflineminus">-</span>
<a href="#l86.302"></a><span id="l86.302" class="difflineminus">-// Join all of the elements together, separated with commas, and wrap them in</span>
<a href="#l86.303"></a><span id="l86.303" class="difflineminus">-// brackets.</span>
<a href="#l86.304"></a><span id="l86.304" class="difflineminus">-</span>
<a href="#l86.305"></a><span id="l86.305" class="difflineminus">-                    v = partial.length === 0 ? '[]' :</span>
<a href="#l86.306"></a><span id="l86.306" class="difflineminus">-                        gap ? '[\n' + gap +</span>
<a href="#l86.307"></a><span id="l86.307" class="difflineminus">-                                partial.join(',\n' + gap) + '\n' +</span>
<a href="#l86.308"></a><span id="l86.308" class="difflineminus">-                                    mind + ']' :</span>
<a href="#l86.309"></a><span id="l86.309" class="difflineminus">-                              '[' + partial.join(',') + ']';</span>
<a href="#l86.310"></a><span id="l86.310" class="difflineminus">-                    gap = mind;</span>
<a href="#l86.311"></a><span id="l86.311" class="difflineminus">-                    return v;</span>
<a href="#l86.312"></a><span id="l86.312" class="difflineminus">-                }</span>
<a href="#l86.313"></a><span id="l86.313" class="difflineminus">-</span>
<a href="#l86.314"></a><span id="l86.314" class="difflineminus">-// If the replacer is an array, use it to select the members to be stringified.</span>
<a href="#l86.315"></a><span id="l86.315" class="difflineminus">-</span>
<a href="#l86.316"></a><span id="l86.316" class="difflineminus">-                if (rep &amp;&amp; typeof rep === 'object') {</span>
<a href="#l86.317"></a><span id="l86.317" class="difflineminus">-                    length = rep.length;</span>
<a href="#l86.318"></a><span id="l86.318" class="difflineminus">-                    for (i = 0; i &lt; length; i += 1) {</span>
<a href="#l86.319"></a><span id="l86.319" class="difflineminus">-                        k = rep[i];</span>
<a href="#l86.320"></a><span id="l86.320" class="difflineminus">-                        if (typeof k === 'string') {</span>
<a href="#l86.321"></a><span id="l86.321" class="difflineminus">-                            v = str(k, value, rep);</span>
<a href="#l86.322"></a><span id="l86.322" class="difflineminus">-                            if (v) {</span>
<a href="#l86.323"></a><span id="l86.323" class="difflineminus">-                                partial.push(quote(k) + (gap ? ': ' : ':') + v);</span>
<a href="#l86.324"></a><span id="l86.324" class="difflineminus">-                            }</span>
<a href="#l86.325"></a><span id="l86.325" class="difflineminus">-                        }</span>
<a href="#l86.326"></a><span id="l86.326" class="difflineminus">-                    }</span>
<a href="#l86.327"></a><span id="l86.327" class="difflineminus">-                } else {</span>
<a href="#l86.328"></a><span id="l86.328" class="difflineminus">-</span>
<a href="#l86.329"></a><span id="l86.329" class="difflineminus">-// Otherwise, iterate through all of the keys in the object.</span>
<a href="#l86.330"></a><span id="l86.330" class="difflineminus">-</span>
<a href="#l86.331"></a><span id="l86.331" class="difflineminus">-                    for (k in value) {</span>
<a href="#l86.332"></a><span id="l86.332" class="difflineminus">-                        if (Object.hasOwnProperty.call(value, k)) {</span>
<a href="#l86.333"></a><span id="l86.333" class="difflineminus">-                            v = str(k, value, rep);</span>
<a href="#l86.334"></a><span id="l86.334" class="difflineminus">-                            if (v) {</span>
<a href="#l86.335"></a><span id="l86.335" class="difflineminus">-                                partial.push(quote(k) + (gap ? ': ' : ':') + v);</span>
<a href="#l86.336"></a><span id="l86.336" class="difflineminus">-                            }</span>
<a href="#l86.337"></a><span id="l86.337" class="difflineminus">-                        }</span>
<a href="#l86.338"></a><span id="l86.338" class="difflineminus">-                    }</span>
<a href="#l86.339"></a><span id="l86.339" class="difflineminus">-                }</span>
<a href="#l86.340"></a><span id="l86.340" class="difflineminus">-</span>
<a href="#l86.341"></a><span id="l86.341" class="difflineminus">-// Join all of the member texts together, separated with commas,</span>
<a href="#l86.342"></a><span id="l86.342" class="difflineminus">-// and wrap them in braces.</span>
<a href="#l86.343"></a><span id="l86.343" class="difflineminus">-</span>
<a href="#l86.344"></a><span id="l86.344" class="difflineminus">-                v = partial.length === 0 ? '{}' :</span>
<a href="#l86.345"></a><span id="l86.345" class="difflineminus">-                    gap ? '{\n' + gap + partial.join(',\n' + gap) + '\n' +</span>
<a href="#l86.346"></a><span id="l86.346" class="difflineminus">-                            mind + '}' : '{' + partial.join(',') + '}';</span>
<a href="#l86.347"></a><span id="l86.347" class="difflineminus">-                gap = mind;</span>
<a href="#l86.348"></a><span id="l86.348" class="difflineminus">-                return v;</span>
<a href="#l86.349"></a><span id="l86.349" class="difflineminus">-            }</span>
<a href="#l86.350"></a><span id="l86.350" class="difflineminus">-        }</span>
<a href="#l86.351"></a><span id="l86.351" class="difflineminus">-</span>
<a href="#l86.352"></a><span id="l86.352" class="difflineminus">-// Return the JSON object containing the stringify and parse methods.</span>
<a href="#l86.353"></a><span id="l86.353" class="difflineminus">-</span>
<a href="#l86.354"></a><span id="l86.354" class="difflineminus">-        return {</span>
<a href="#l86.355"></a><span id="l86.355" class="difflineminus">-            stringify: function (value, replacer, space) {</span>
<a href="#l86.356"></a><span id="l86.356" class="difflineminus">-</span>
<a href="#l86.357"></a><span id="l86.357" class="difflineminus">-// The stringify method takes a value and an optional replacer, and an optional</span>
<a href="#l86.358"></a><span id="l86.358" class="difflineminus">-// space parameter, and returns a JSON text. The replacer can be a function</span>
<a href="#l86.359"></a><span id="l86.359" class="difflineminus">-// that can replace values, or an array of strings that will select the keys.</span>
<a href="#l86.360"></a><span id="l86.360" class="difflineminus">-// A default replacer method can be provided. Use of the space parameter can</span>
<a href="#l86.361"></a><span id="l86.361" class="difflineminus">-// produce text that is more easily readable.</span>
<a href="#l86.362"></a><span id="l86.362" class="difflineminus">-</span>
<a href="#l86.363"></a><span id="l86.363" class="difflineminus">-                var i;</span>
<a href="#l86.364"></a><span id="l86.364" class="difflineminus">-                gap = '';</span>
<a href="#l86.365"></a><span id="l86.365" class="difflineminus">-                indent = '';</span>
<a href="#l86.366"></a><span id="l86.366" class="difflineminus">-</span>
<a href="#l86.367"></a><span id="l86.367" class="difflineminus">-// If the space parameter is a number, make an indent string containing that</span>
<a href="#l86.368"></a><span id="l86.368" class="difflineminus">-// many spaces.</span>
<a href="#l86.369"></a><span id="l86.369" class="difflineminus">-</span>
<a href="#l86.370"></a><span id="l86.370" class="difflineminus">-                if (typeof space === 'number') {</span>
<a href="#l86.371"></a><span id="l86.371" class="difflineminus">-                    for (i = 0; i &lt; space; i += 1) {</span>
<a href="#l86.372"></a><span id="l86.372" class="difflineminus">-                        indent += ' ';</span>
<a href="#l86.373"></a><span id="l86.373" class="difflineminus">-                    }</span>
<a href="#l86.374"></a><span id="l86.374" class="difflineminus">-</span>
<a href="#l86.375"></a><span id="l86.375" class="difflineminus">-// If the space parameter is a string, it will be used as the indent string.</span>
<a href="#l86.376"></a><span id="l86.376" class="difflineminus">-</span>
<a href="#l86.377"></a><span id="l86.377" class="difflineminus">-                } else if (typeof space === 'string') {</span>
<a href="#l86.378"></a><span id="l86.378" class="difflineminus">-                    indent = space;</span>
<a href="#l86.379"></a><span id="l86.379" class="difflineminus">-                }</span>
<a href="#l86.380"></a><span id="l86.380" class="difflineminus">-</span>
<a href="#l86.381"></a><span id="l86.381" class="difflineminus">-// If there is a replacer, it must be a function or an array.</span>
<a href="#l86.382"></a><span id="l86.382" class="difflineminus">-// Otherwise, throw an error.</span>
<a href="#l86.383"></a><span id="l86.383" class="difflineminus">-</span>
<a href="#l86.384"></a><span id="l86.384" class="difflineminus">-                rep = replacer;</span>
<a href="#l86.385"></a><span id="l86.385" class="difflineminus">-                if (replacer &amp;&amp; typeof replacer !== 'function' &amp;&amp;</span>
<a href="#l86.386"></a><span id="l86.386" class="difflineminus">-                        (typeof replacer !== 'object' ||</span>
<a href="#l86.387"></a><span id="l86.387" class="difflineminus">-                         typeof replacer.length !== 'number')) {</span>
<a href="#l86.388"></a><span id="l86.388" class="difflineminus">-                    throw new Error('JSON.stringify');</span>
<a href="#l86.389"></a><span id="l86.389" class="difflineminus">-                }</span>
<a href="#l86.390"></a><span id="l86.390" class="difflineminus">-</span>
<a href="#l86.391"></a><span id="l86.391" class="difflineminus">-// Make a fake root object containing our value under the key of ''.</span>
<a href="#l86.392"></a><span id="l86.392" class="difflineminus">-// Return the result of stringifying the value.</span>
<a href="#l86.393"></a><span id="l86.393" class="difflineminus">-</span>
<a href="#l86.394"></a><span id="l86.394" class="difflineminus">-                return str('', {'': value});</span>
<a href="#l86.395"></a><span id="l86.395" class="difflineminus">-            },</span>
<a href="#l86.396"></a><span id="l86.396" class="difflineminus">-</span>
<a href="#l86.397"></a><span id="l86.397" class="difflineminus">-</span>
<a href="#l86.398"></a><span id="l86.398" class="difflineminus">-            parse: function (text, reviver) {</span>
<a href="#l86.399"></a><span id="l86.399" class="difflineminus">-</span>
<a href="#l86.400"></a><span id="l86.400" class="difflineminus">-// The parse method takes a text and an optional reviver function, and returns</span>
<a href="#l86.401"></a><span id="l86.401" class="difflineminus">-// a JavaScript value if the text is a valid JSON text.</span>
<a href="#l86.402"></a><span id="l86.402" class="difflineminus">-</span>
<a href="#l86.403"></a><span id="l86.403" class="difflineminus">-                var j;</span>
<a href="#l86.404"></a><span id="l86.404" class="difflineminus">-</span>
<a href="#l86.405"></a><span id="l86.405" class="difflineminus">-                function walk(holder, key) {</span>
<a href="#l86.406"></a><span id="l86.406" class="difflineminus">-</span>
<a href="#l86.407"></a><span id="l86.407" class="difflineminus">-// The walk method is used to recursively walk the resulting structure so</span>
<a href="#l86.408"></a><span id="l86.408" class="difflineminus">-// that modifications can be made.</span>
<a href="#l86.409"></a><span id="l86.409" class="difflineminus">-</span>
<a href="#l86.410"></a><span id="l86.410" class="difflineminus">-                    var k, v, value = holder[key];</span>
<a href="#l86.411"></a><span id="l86.411" class="difflineminus">-                    if (value &amp;&amp; typeof value === 'object') {</span>
<a href="#l86.412"></a><span id="l86.412" class="difflineminus">-                        for (k in value) {</span>
<a href="#l86.413"></a><span id="l86.413" class="difflineminus">-                            if (Object.hasOwnProperty.call(value, k)) {</span>
<a href="#l86.414"></a><span id="l86.414" class="difflineminus">-                                v = walk(value, k);</span>
<a href="#l86.415"></a><span id="l86.415" class="difflineminus">-                                if (v !== undefined) {</span>
<a href="#l86.416"></a><span id="l86.416" class="difflineminus">-                                    value[k] = v;</span>
<a href="#l86.417"></a><span id="l86.417" class="difflineminus">-                                } else {</span>
<a href="#l86.418"></a><span id="l86.418" class="difflineminus">-                                    delete value[k];</span>
<a href="#l86.419"></a><span id="l86.419" class="difflineminus">-                                }</span>
<a href="#l86.420"></a><span id="l86.420" class="difflineminus">-                            }</span>
<a href="#l86.421"></a><span id="l86.421" class="difflineminus">-                        }</span>
<a href="#l86.422"></a><span id="l86.422" class="difflineminus">-                    }</span>
<a href="#l86.423"></a><span id="l86.423" class="difflineminus">-                    return reviver.call(holder, key, value);</span>
<a href="#l86.424"></a><span id="l86.424" class="difflineminus">-                }</span>
<a href="#l86.425"></a><span id="l86.425" class="difflineminus">-</span>
<a href="#l86.426"></a><span id="l86.426" class="difflineminus">-</span>
<a href="#l86.427"></a><span id="l86.427" class="difflineminus">-// Parsing happens in four stages. In the first stage, we replace certain</span>
<a href="#l86.428"></a><span id="l86.428" class="difflineminus">-// Unicode characters with escape sequences. JavaScript handles many characters</span>
<a href="#l86.429"></a><span id="l86.429" class="difflineminus">-// incorrectly, either silently deleting them, or treating them as line endings.</span>
<a href="#l86.430"></a><span id="l86.430" class="difflineminus">-</span>
<a href="#l86.431"></a><span id="l86.431" class="difflineminus">-                cx.lastIndex = 0;</span>
<a href="#l86.432"></a><span id="l86.432" class="difflineminus">-                if (cx.test(text)) {</span>
<a href="#l86.433"></a><span id="l86.433" class="difflineminus">-                    text = text.replace(cx, function (a) {</span>
<a href="#l86.434"></a><span id="l86.434" class="difflineminus">-                        return '\\u' + ('0000' +</span>
<a href="#l86.435"></a><span id="l86.435" class="difflineminus">-                                (+(a.charCodeAt(0))).toString(16)).slice(-4);</span>
<a href="#l86.436"></a><span id="l86.436" class="difflineminus">-                    });</span>
<a href="#l86.437"></a><span id="l86.437" class="difflineminus">-                }</span>
<a href="#l86.438"></a><span id="l86.438" class="difflineminus">-</span>
<a href="#l86.439"></a><span id="l86.439" class="difflineminus">-// In the second stage, we run the text against regular expressions that look</span>
<a href="#l86.440"></a><span id="l86.440" class="difflineminus">-// for non-JSON patterns. We are especially concerned with '()' and 'new'</span>
<a href="#l86.441"></a><span id="l86.441" class="difflineminus">-// because they can cause invocation, and '=' because it can cause mutation.</span>
<a href="#l86.442"></a><span id="l86.442" class="difflineminus">-// But just to be safe, we want to reject all unexpected forms.</span>
<a href="#l86.443"></a><span id="l86.443" class="difflineminus">-</span>
<a href="#l86.444"></a><span id="l86.444" class="difflineminus">-// We split the second stage into 4 regexp operations in order to work around</span>
<a href="#l86.445"></a><span id="l86.445" class="difflineminus">-// crippling inefficiencies in IE's and Safari's regexp engines. First we</span>
<a href="#l86.446"></a><span id="l86.446" class="difflineminus">-// replace the JSON backslash pairs with '@' (a non-JSON character). Second, we</span>
<a href="#l86.447"></a><span id="l86.447" class="difflineminus">-// replace all simple value tokens with ']' characters. Third, we delete all</span>
<a href="#l86.448"></a><span id="l86.448" class="difflineminus">-// open brackets that follow a colon or comma or that begin the text. Finally,</span>
<a href="#l86.449"></a><span id="l86.449" class="difflineminus">-// we look to see that the remaining characters are only whitespace or ']' or</span>
<a href="#l86.450"></a><span id="l86.450" class="difflineminus">-// ',' or ':' or '{' or '}'. If that is so, then the text is safe for eval.</span>
<a href="#l86.451"></a><span id="l86.451" class="difflineminus">-</span>
<a href="#l86.452"></a><span id="l86.452" class="difflineminus">-                if (/^[\],:{}\s]*$/.</span>
<a href="#l86.453"></a><span id="l86.453" class="difflineminus">-test(text.replace(/\\(?:[&quot;\\\/bfnrt]|u[0-9a-fA-F]{4})/g, '@').</span>
<a href="#l86.454"></a><span id="l86.454" class="difflineminus">-replace(/&quot;[^&quot;\\\n\r]*&quot;|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g, ']').</span>
<a href="#l86.455"></a><span id="l86.455" class="difflineminus">-replace(/(?:^|:|,)(?:\s*\[)+/g, ''))) {</span>
<a href="#l86.456"></a><span id="l86.456" class="difflineminus">-</span>
<a href="#l86.457"></a><span id="l86.457" class="difflineminus">-// In the third stage we use the eval function to compile the text into a</span>
<a href="#l86.458"></a><span id="l86.458" class="difflineminus">-// JavaScript structure. The '{' operator is subject to a syntactic ambiguity</span>
<a href="#l86.459"></a><span id="l86.459" class="difflineminus">-// in JavaScript: it can begin a block or an object literal. We wrap the text</span>
<a href="#l86.460"></a><span id="l86.460" class="difflineminus">-// in parens to eliminate the ambiguity.</span>
<a href="#l86.461"></a><span id="l86.461" class="difflineminus">-</span>
<a href="#l86.462"></a><span id="l86.462" class="difflineminus">-                    j = eval('(' + text + ')');</span>
<a href="#l86.463"></a><span id="l86.463" class="difflineminus">-</span>
<a href="#l86.464"></a><span id="l86.464" class="difflineminus">-// In the optional fourth stage, we recursively walk the new structure, passing</span>
<a href="#l86.465"></a><span id="l86.465" class="difflineminus">-// each name/value pair to a reviver function for possible transformation.</span>
<a href="#l86.466"></a><span id="l86.466" class="difflineminus">-</span>
<a href="#l86.467"></a><span id="l86.467" class="difflineminus">-                    return typeof reviver === 'function' ?</span>
<a href="#l86.468"></a><span id="l86.468" class="difflineminus">-                        walk({'': j}, '') : j;</span>
<a href="#l86.469"></a><span id="l86.469" class="difflineminus">-                }</span>
<a href="#l86.470"></a><span id="l86.470" class="difflineminus">-</span>
<a href="#l86.471"></a><span id="l86.471" class="difflineminus">-// If the text is not JSON parseable, then a SyntaxError is thrown.</span>
<a href="#l86.472"></a><span id="l86.472" class="difflineminus">-</span>
<a href="#l86.473"></a><span id="l86.473" class="difflineminus">-                throw new SyntaxError('JSON.parse');</span>
<a href="#l86.474"></a><span id="l86.474" class="difflineminus">-            }</span>
<a href="#l86.475"></a><span id="l86.475" class="difflineminus">-        };</span>
<a href="#l86.476"></a><span id="l86.476" class="difflineminus">-    }();</span>
<a href="#l86.477"></a><span id="l86.477" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l87.1"></a><span id="l87.1">deleted file mode 100644</span>
<a href="#l87.2"></a><span id="l87.2" class="difflineminus">--- a/mail/test/resources/mozmill/mozmill/extension/content/stdlib/objects.js</span>
<a href="#l87.3"></a><span id="l87.3" class="difflineplus">+++ /dev/null</span>
<a href="#l87.4"></a><span id="l87.4" class="difflineat">@@ -1,86 +0,0 @@</span>
<a href="#l87.5"></a><span id="l87.5" class="difflineminus">-// ***** BEGIN LICENSE BLOCK *****// ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l87.6"></a><span id="l87.6" class="difflineminus">-// Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l87.7"></a><span id="l87.7" class="difflineminus">-//</span>
<a href="#l87.8"></a><span id="l87.8" class="difflineminus">-// The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l87.9"></a><span id="l87.9" class="difflineminus">-// 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l87.10"></a><span id="l87.10" class="difflineminus">-// the License. You may obtain a copy of the License at</span>
<a href="#l87.11"></a><span id="l87.11" class="difflineminus">-// http://www.mozilla.org/MPL/</span>
<a href="#l87.12"></a><span id="l87.12" class="difflineminus">-//</span>
<a href="#l87.13"></a><span id="l87.13" class="difflineminus">-// Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l87.14"></a><span id="l87.14" class="difflineminus">-// WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l87.15"></a><span id="l87.15" class="difflineminus">-// for the specific language governing rights and limitations under the</span>
<a href="#l87.16"></a><span id="l87.16" class="difflineminus">-// License.</span>
<a href="#l87.17"></a><span id="l87.17" class="difflineminus">-//</span>
<a href="#l87.18"></a><span id="l87.18" class="difflineminus">-// The Original Code is Mozilla Corporation Code.</span>
<a href="#l87.19"></a><span id="l87.19" class="difflineminus">-//</span>
<a href="#l87.20"></a><span id="l87.20" class="difflineminus">-// The Initial Developer of the Original Code is</span>
<a href="#l87.21"></a><span id="l87.21" class="difflineminus">-// Mikeal Rogers.</span>
<a href="#l87.22"></a><span id="l87.22" class="difflineminus">-// Portions created by the Initial Developer are Copyright (C) 2008</span>
<a href="#l87.23"></a><span id="l87.23" class="difflineminus">-// the Initial Developer. All Rights Reserved.</span>
<a href="#l87.24"></a><span id="l87.24" class="difflineminus">-//</span>
<a href="#l87.25"></a><span id="l87.25" class="difflineminus">-// Contributor(s):</span>
<a href="#l87.26"></a><span id="l87.26" class="difflineminus">-//  Mikeal Rogers &lt;mikeal.rogers@gmail.com&gt;</span>
<a href="#l87.27"></a><span id="l87.27" class="difflineminus">-//</span>
<a href="#l87.28"></a><span id="l87.28" class="difflineminus">-// Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l87.29"></a><span id="l87.29" class="difflineminus">-// either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l87.30"></a><span id="l87.30" class="difflineminus">-// the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l87.31"></a><span id="l87.31" class="difflineminus">-// in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l87.32"></a><span id="l87.32" class="difflineminus">-// of those above. If you wish to allow use of your version of this file only</span>
<a href="#l87.33"></a><span id="l87.33" class="difflineminus">-// under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l87.34"></a><span id="l87.34" class="difflineminus">-// use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l87.35"></a><span id="l87.35" class="difflineminus">-// decision by deleting the provisions above and replace them with the notice</span>
<a href="#l87.36"></a><span id="l87.36" class="difflineminus">-// and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l87.37"></a><span id="l87.37" class="difflineminus">-// the provisions above, a recipient may use your version of this file under</span>
<a href="#l87.38"></a><span id="l87.38" class="difflineminus">-// the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l87.39"></a><span id="l87.39" class="difflineminus">-//</span>
<a href="#l87.40"></a><span id="l87.40" class="difflineminus">-// ***** END LICENSE BLOCK *****</span>
<a href="#l87.41"></a><span id="l87.41" class="difflineminus">-</span>
<a href="#l87.42"></a><span id="l87.42" class="difflineminus">-var EXPORTED_SYMBOLS = ['getLength', ];//'compare'];</span>
<a href="#l87.43"></a><span id="l87.43" class="difflineminus">-</span>
<a href="#l87.44"></a><span id="l87.44" class="difflineminus">-var getLength = function (obj) {</span>
<a href="#l87.45"></a><span id="l87.45" class="difflineminus">-  var len = 0;</span>
<a href="#l87.46"></a><span id="l87.46" class="difflineminus">-  for (var i in obj) {</span>
<a href="#l87.47"></a><span id="l87.47" class="difflineminus">-    len++;</span>
<a href="#l87.48"></a><span id="l87.48" class="difflineminus">-  }</span>
<a href="#l87.49"></a><span id="l87.49" class="difflineminus">-  return len;</span>
<a href="#l87.50"></a><span id="l87.50" class="difflineminus">-}</span>
<a href="#l87.51"></a><span id="l87.51" class="difflineminus">-</span>
<a href="#l87.52"></a><span id="l87.52" class="difflineminus">-// var logging = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/logging.js&quot;);</span>
<a href="#l87.53"></a><span id="l87.53" class="difflineminus">-</span>
<a href="#l87.54"></a><span id="l87.54" class="difflineminus">-// var objectsLogger = logging.getLogger('objectsLogger');</span>
<a href="#l87.55"></a><span id="l87.55" class="difflineminus">-</span>
<a href="#l87.56"></a><span id="l87.56" class="difflineminus">-// var compare = function (obj1, obj2, depth, recursion) {</span>
<a href="#l87.57"></a><span id="l87.57" class="difflineminus">-//   if (depth == undefined) {</span>
<a href="#l87.58"></a><span id="l87.58" class="difflineminus">-//     var depth = 4;</span>
<a href="#l87.59"></a><span id="l87.59" class="difflineminus">-//   }</span>
<a href="#l87.60"></a><span id="l87.60" class="difflineminus">-//   if (recursion == undefined) {</span>
<a href="#l87.61"></a><span id="l87.61" class="difflineminus">-//     var recursion = 0;</span>
<a href="#l87.62"></a><span id="l87.62" class="difflineminus">-//   }</span>
<a href="#l87.63"></a><span id="l87.63" class="difflineminus">-//</span>
<a href="#l87.64"></a><span id="l87.64" class="difflineminus">-//   if (recursion &gt; depth) {</span>
<a href="#l87.65"></a><span id="l87.65" class="difflineminus">-//     return true;</span>
<a href="#l87.66"></a><span id="l87.66" class="difflineminus">-//   }</span>
<a href="#l87.67"></a><span id="l87.67" class="difflineminus">-//</span>
<a href="#l87.68"></a><span id="l87.68" class="difflineminus">-//   if (typeof(obj1) != typeof(obj2)) {</span>
<a href="#l87.69"></a><span id="l87.69" class="difflineminus">-//     return false;</span>
<a href="#l87.70"></a><span id="l87.70" class="difflineminus">-//   }</span>
<a href="#l87.71"></a><span id="l87.71" class="difflineminus">-//</span>
<a href="#l87.72"></a><span id="l87.72" class="difflineminus">-//   if (typeof(obj1) == &quot;object&quot; &amp;&amp; typeof(obj2) == &quot;object&quot;) {</span>
<a href="#l87.73"></a><span id="l87.73" class="difflineminus">-//     if ([x for (x in obj1)].length != [x for (x in obj2)].length) {</span>
<a href="#l87.74"></a><span id="l87.74" class="difflineminus">-//       return false;</span>
<a href="#l87.75"></a><span id="l87.75" class="difflineminus">-//     }</span>
<a href="#l87.76"></a><span id="l87.76" class="difflineminus">-//     for (var i in obj1) {</span>
<a href="#l87.77"></a><span id="l87.77" class="difflineminus">-//       recursion++;</span>
<a href="#l87.78"></a><span id="l87.78" class="difflineminus">-//       var result = compare(obj1[i], obj2[i], depth, recursion);</span>
<a href="#l87.79"></a><span id="l87.79" class="difflineminus">-//       objectsLogger.info(i+' in recursion '+result);</span>
<a href="#l87.80"></a><span id="l87.80" class="difflineminus">-//       if (result == false) {</span>
<a href="#l87.81"></a><span id="l87.81" class="difflineminus">-//         return false;</span>
<a href="#l87.82"></a><span id="l87.82" class="difflineminus">-//       }</span>
<a href="#l87.83"></a><span id="l87.83" class="difflineminus">-//     }</span>
<a href="#l87.84"></a><span id="l87.84" class="difflineminus">-//   } else {</span>
<a href="#l87.85"></a><span id="l87.85" class="difflineminus">-//     if (obj1 != obj2) {</span>
<a href="#l87.86"></a><span id="l87.86" class="difflineminus">-//       return false;</span>
<a href="#l87.87"></a><span id="l87.87" class="difflineminus">-//     }</span>
<a href="#l87.88"></a><span id="l87.88" class="difflineminus">-//   }</span>
<a href="#l87.89"></a><span id="l87.89" class="difflineminus">-//   return true;</span>
<a href="#l87.90"></a><span id="l87.90" class="difflineminus">-// }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l88.1"></a><span id="l88.1">rename from mail/test/resources/mozmill/mozmill/extension/content/stdlib/os.js</span>
<a href="#l88.2"></a><span id="l88.2">rename to mail/test/resources/mozmill/mozmill/extension/content/stdlib/os.jsm</span>
<a href="#l88.3"></a><span id="l88.3" class="difflineminus">--- a/mail/test/resources/mozmill/mozmill/extension/content/stdlib/os.js</span>
<a href="#l88.4"></a><span id="l88.4" class="difflineplus">+++ b/mail/test/resources/mozmill/mozmill/extension/content/stdlib/os.jsm</span>
<a href="#l88.5"></a><span id="l88.5" class="difflineat">@@ -30,56 +30,52 @@</span>
<a href="#l88.6"></a><span id="l88.6"> // use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l88.7"></a><span id="l88.7"> // decision by deleting the provisions above and replace them with the notice</span>
<a href="#l88.8"></a><span id="l88.8"> // and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l88.9"></a><span id="l88.9"> // the provisions above, a recipient may use your version of this file under</span>
<a href="#l88.10"></a><span id="l88.10"> // the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l88.11"></a><span id="l88.11"> //</span>
<a href="#l88.12"></a><span id="l88.12"> // ***** END LICENSE BLOCK *****</span>
<a href="#l88.13"></a><span id="l88.13"> </span>
<a href="#l88.14"></a><span id="l88.14" class="difflineminus">-var EXPORTED_SYMBOLS = ['listDirectory', 'getFileForPath', 'abspath', 'getPlatform'];</span>
<a href="#l88.15"></a><span id="l88.15" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;listDirectory&quot;, &quot;getFileForPath&quot;, &quot;abspath&quot;, &quot;getPlatform&quot;];</span>
<a href="#l88.16"></a><span id="l88.16"> </span>
<a href="#l88.17"></a><span id="l88.17" class="difflineminus">-function listDirectory (file) {</span>
<a href="#l88.18"></a><span id="l88.18" class="difflineplus">+const {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l88.19"></a><span id="l88.19" class="difflineplus">+</span>
<a href="#l88.20"></a><span id="l88.20" class="difflineplus">+function listDirectory(file) {</span>
<a href="#l88.21"></a><span id="l88.21">   // file is the given directory (nsIFile)</span>
<a href="#l88.22"></a><span id="l88.22">   var entries = file.directoryEntries;</span>
<a href="#l88.23"></a><span id="l88.23">   var array = [];</span>
<a href="#l88.24"></a><span id="l88.24" class="difflineminus">-  while (entries.hasMoreElements())</span>
<a href="#l88.25"></a><span id="l88.25" class="difflineminus">-  {</span>
<a href="#l88.26"></a><span id="l88.26" class="difflineplus">+  while (entries.hasMoreElements()) {</span>
<a href="#l88.27"></a><span id="l88.27">     var entry = entries.getNext();</span>
<a href="#l88.28"></a><span id="l88.28">     entry.QueryInterface(Ci.nsIFile);</span>
<a href="#l88.29"></a><span id="l88.29">     array.push(entry);</span>
<a href="#l88.30"></a><span id="l88.30">   }</span>
<a href="#l88.31"></a><span id="l88.31">   return array;</span>
<a href="#l88.32"></a><span id="l88.32"> }</span>
<a href="#l88.33"></a><span id="l88.33"> </span>
<a href="#l88.34"></a><span id="l88.34" class="difflineminus">-function getFileForPath (path) {</span>
<a href="#l88.35"></a><span id="l88.35" class="difflineminus">-  var file = Cc[&quot;@mozilla.org/file/local;1&quot;]</span>
<a href="#l88.36"></a><span id="l88.36" class="difflineminus">-               .createInstance(Ci.nsIFile);</span>
<a href="#l88.37"></a><span id="l88.37" class="difflineplus">+function getFileForPath(path) {</span>
<a href="#l88.38"></a><span id="l88.38" class="difflineplus">+  var file = Cc[&quot;@mozilla.org/file/local;1&quot;].createInstance(Ci.nsIFile);</span>
<a href="#l88.39"></a><span id="l88.39">   file.initWithPath(path);</span>
<a href="#l88.40"></a><span id="l88.40">   return file;</span>
<a href="#l88.41"></a><span id="l88.41"> }</span>
<a href="#l88.42"></a><span id="l88.42"> </span>
<a href="#l88.43"></a><span id="l88.43" class="difflineminus">-function abspath (rel, file) {</span>
<a href="#l88.44"></a><span id="l88.44" class="difflineminus">-  var relSplit = rel.split('/');</span>
<a href="#l88.45"></a><span id="l88.45" class="difflineminus">-  if (relSplit[0] == '..' &amp;&amp; !file.isDirectory()) {</span>
<a href="#l88.46"></a><span id="l88.46" class="difflineplus">+function abspath(rel, file) {</span>
<a href="#l88.47"></a><span id="l88.47" class="difflineplus">+  var relSplit = rel.split(&quot;/&quot;);</span>
<a href="#l88.48"></a><span id="l88.48" class="difflineplus">+  if (relSplit[0] == &quot;..&quot; &amp;&amp; !file.isDirectory()) {</span>
<a href="#l88.49"></a><span id="l88.49">     file = file.parent;</span>
<a href="#l88.50"></a><span id="l88.50">   }</span>
<a href="#l88.51"></a><span id="l88.51">   for (var p of relSplit) {</span>
<a href="#l88.52"></a><span id="l88.52" class="difflineminus">-    if (p == '..') {</span>
<a href="#l88.53"></a><span id="l88.53" class="difflineplus">+    if (p == &quot;..&quot;) {</span>
<a href="#l88.54"></a><span id="l88.54">       file = file.parent;</span>
<a href="#l88.55"></a><span id="l88.55" class="difflineminus">-    } else if (p == '.'){</span>
<a href="#l88.56"></a><span id="l88.56" class="difflineplus">+    } else if (p == &quot;.&quot;) {</span>
<a href="#l88.57"></a><span id="l88.57">       if (!file.isDirectory()) {</span>
<a href="#l88.58"></a><span id="l88.58">         file = file.parent;</span>
<a href="#l88.59"></a><span id="l88.59">       }</span>
<a href="#l88.60"></a><span id="l88.60">     } else {</span>
<a href="#l88.61"></a><span id="l88.61">       file.append(p);</span>
<a href="#l88.62"></a><span id="l88.62">     }</span>
<a href="#l88.63"></a><span id="l88.63">   }</span>
<a href="#l88.64"></a><span id="l88.64">   return file.path;</span>
<a href="#l88.65"></a><span id="l88.65"> }</span>
<a href="#l88.66"></a><span id="l88.66"> </span>
<a href="#l88.67"></a><span id="l88.67" class="difflineminus">-function getPlatform () {</span>
<a href="#l88.68"></a><span id="l88.68" class="difflineminus">-  var xulRuntime = Cc[&quot;@mozilla.org/xre/app-info;1&quot;]</span>
<a href="#l88.69"></a><span id="l88.69" class="difflineminus">-                   .getService(Ci.nsIXULRuntime);</span>
<a href="#l88.70"></a><span id="l88.70" class="difflineminus">-  return xulRuntime.OS.toLowerCase();</span>
<a href="#l88.71"></a><span id="l88.71" class="difflineplus">+function getPlatform() {</span>
<a href="#l88.72"></a><span id="l88.72" class="difflineplus">+  return Services.appinfo.OS.toLowerCase();</span>
<a href="#l88.73"></a><span id="l88.73"> }</span>
<a href="#l88.74"></a><span id="l88.74" class="difflineminus">-</span>
<a href="#l88.75"></a><span id="l88.75" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l89.1"></a><span id="l89.1">rename from mail/test/resources/mozmill/mozmill/extension/content/stdlib/securable-module.js</span>
<a href="#l89.2"></a><span id="l89.2">rename to mail/test/resources/mozmill/mozmill/extension/content/stdlib/securable-module.jsm</span>
<a href="#l89.3"></a><span id="l89.3" class="difflineminus">--- a/mail/test/resources/mozmill/mozmill/extension/content/stdlib/securable-module.js</span>
<a href="#l89.4"></a><span id="l89.4" class="difflineplus">+++ b/mail/test/resources/mozmill/mozmill/extension/content/stdlib/securable-module.jsm</span>
<a href="#l89.5"></a><span id="l89.5" class="difflineat">@@ -30,39 +30,34 @@</span>
<a href="#l89.6"></a><span id="l89.6">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l89.7"></a><span id="l89.7">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l89.8"></a><span id="l89.8">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l89.9"></a><span id="l89.9">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l89.10"></a><span id="l89.10">  *</span>
<a href="#l89.11"></a><span id="l89.11">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l89.12"></a><span id="l89.12"> </span>
<a href="#l89.13"></a><span id="l89.13"> (function(global) {</span>
<a href="#l89.14"></a><span id="l89.14" class="difflineplus">+  const {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l89.15"></a><span id="l89.15" class="difflineplus">+</span>
<a href="#l89.16"></a><span id="l89.16">    var exports = {};</span>
<a href="#l89.17"></a><span id="l89.17"> </span>
<a href="#l89.18"></a><span id="l89.18" class="difflineminus">-   var ios = Cc['@mozilla.org/network/io-service;1']</span>
<a href="#l89.19"></a><span id="l89.19" class="difflineminus">-             .getService(Ci.nsIIOService);</span>
<a href="#l89.20"></a><span id="l89.20" class="difflineminus">-</span>
<a href="#l89.21"></a><span id="l89.21" class="difflineminus">-   var scriptSecurityManager = Cc['@mozilla.org/scriptsecuritymanager;1']</span>
<a href="#l89.22"></a><span id="l89.22" class="difflineminus">-                               .getService(Ci.nsIScriptSecurityManager);</span>
<a href="#l89.23"></a><span id="l89.23" class="difflineminus">-</span>
<a href="#l89.24"></a><span id="l89.24" class="difflineminus">-   var systemPrincipal = Cc[&quot;@mozilla.org/systemprincipal;1&quot;]</span>
<a href="#l89.25"></a><span id="l89.25" class="difflineminus">-                         .createInstance(Ci.nsIPrincipal);</span>
<a href="#l89.26"></a><span id="l89.26" class="difflineplus">+   var systemPrincipal = Cc[&quot;@mozilla.org/systemprincipal;1&quot;].createInstance(Ci.nsIPrincipal);</span>
<a href="#l89.27"></a><span id="l89.27"> </span>
<a href="#l89.28"></a><span id="l89.28">    function resolvePrincipal(principal, defaultPrincipal) {</span>
<a href="#l89.29"></a><span id="l89.29">      if (principal === undefined)</span>
<a href="#l89.30"></a><span id="l89.30">        return defaultPrincipal;</span>
<a href="#l89.31"></a><span id="l89.31">      if (principal == &quot;system&quot;)</span>
<a href="#l89.32"></a><span id="l89.32">        return systemPrincipal;</span>
<a href="#l89.33"></a><span id="l89.33">      return principal;</span>
<a href="#l89.34"></a><span id="l89.34">    }</span>
<a href="#l89.35"></a><span id="l89.35"> </span>
<a href="#l89.36"></a><span id="l89.36">    // The base URI to we use when we're given relative URLs, if any.</span>
<a href="#l89.37"></a><span id="l89.37">    var baseURI = null;</span>
<a href="#l89.38"></a><span id="l89.38">    if (global.window)</span>
<a href="#l89.39"></a><span id="l89.39" class="difflineminus">-     baseURI = ios.newURI(global.location.href);</span>
<a href="#l89.40"></a><span id="l89.40" class="difflineplus">+     baseURI = Services.io.newURI(global.location.href);</span>
<a href="#l89.41"></a><span id="l89.41">    exports.baseURI = baseURI;</span>
<a href="#l89.42"></a><span id="l89.42"> </span>
<a href="#l89.43"></a><span id="l89.43">    // The &quot;parent&quot; chrome URI to use if we're loading code that</span>
<a href="#l89.44"></a><span id="l89.44">    // needs chrome privileges but may not have a filename that</span>
<a href="#l89.45"></a><span id="l89.45">    // matches any of SpiderMonkey's defined system filename prefixes.</span>
<a href="#l89.46"></a><span id="l89.46">    // The latter is needed so that wrappers can be automatically</span>
<a href="#l89.47"></a><span id="l89.47">    // made for the code. For more information on this, see</span>
<a href="#l89.48"></a><span id="l89.48">    // bug 418356:</span>
<a href="#l89.49"></a><span id="l89.49" class="difflineat">@@ -82,21 +77,19 @@</span>
<a href="#l89.50"></a><span id="l89.50">    function maybeParentifyFilename(filename) {</span>
<a href="#l89.51"></a><span id="l89.51">      var doParentifyFilename = true;</span>
<a href="#l89.52"></a><span id="l89.52">      try {</span>
<a href="#l89.53"></a><span id="l89.53">        // TODO: Ideally we should just make</span>
<a href="#l89.54"></a><span id="l89.54">        // nsIChromeRegistry.wrappersEnabled() available from script</span>
<a href="#l89.55"></a><span id="l89.55">        // and use it here. Until that's in the platform, though,</span>
<a href="#l89.56"></a><span id="l89.56">        // we'll play it safe and parentify the filename unless</span>
<a href="#l89.57"></a><span id="l89.57">        // we're absolutely certain things will be ok if we don't.</span>
<a href="#l89.58"></a><span id="l89.58" class="difflineminus">-       var filenameURI = ios.newURI(options.filename,</span>
<a href="#l89.59"></a><span id="l89.59" class="difflineminus">-                                    null,</span>
<a href="#l89.60"></a><span id="l89.60" class="difflineminus">-                                    baseURI);</span>
<a href="#l89.61"></a><span id="l89.61" class="difflineminus">-       if (filenameURI.scheme == 'chrome' &amp;&amp;</span>
<a href="#l89.62"></a><span id="l89.62" class="difflineminus">-           filenameURI.pathQueryRef.indexOf('/content/') == 0)</span>
<a href="#l89.63"></a><span id="l89.63" class="difflineplus">+       var filenameURI = Services.io.newURI(filename, null, baseURI);</span>
<a href="#l89.64"></a><span id="l89.64" class="difflineplus">+       if (filenameURI.scheme == &quot;chrome&quot; &amp;&amp;</span>
<a href="#l89.65"></a><span id="l89.65" class="difflineplus">+           filenameURI.pathQueryRef.indexOf(&quot;/content/&quot;) == 0)</span>
<a href="#l89.66"></a><span id="l89.66">          // Content packages will always have wrappers made for them;</span>
<a href="#l89.67"></a><span id="l89.67">          // if automatic wrappers have been disabled for the</span>
<a href="#l89.68"></a><span id="l89.68">          // chrome package via a chrome manifest flag, then</span>
<a href="#l89.69"></a><span id="l89.69">          // this still works too, to the extent that the</span>
<a href="#l89.70"></a><span id="l89.70">          // content package is insecure anyways.</span>
<a href="#l89.71"></a><span id="l89.71">          doParentifyFilename = false;</span>
<a href="#l89.72"></a><span id="l89.72">      } catch (e) {}</span>
<a href="#l89.73"></a><span id="l89.73">      if (doParentifyFilename)</span>
<a href="#l89.74"></a><span id="l89.74" class="difflineat">@@ -104,77 +97,77 @@</span>
<a href="#l89.75"></a><span id="l89.75">      return filename;</span>
<a href="#l89.76"></a><span id="l89.76">    }</span>
<a href="#l89.77"></a><span id="l89.77"> </span>
<a href="#l89.78"></a><span id="l89.78">    function getRootDir(urlStr) {</span>
<a href="#l89.79"></a><span id="l89.79">      // TODO: This feels hacky, and like there will be edge cases.</span>
<a href="#l89.80"></a><span id="l89.80">      return urlStr.slice(0, urlStr.lastIndexOf(&quot;/&quot;) + 1);</span>
<a href="#l89.81"></a><span id="l89.81">    }</span>
<a href="#l89.82"></a><span id="l89.82"> </span>
<a href="#l89.83"></a><span id="l89.83" class="difflineminus">-   exports.SandboxFactory = function SandboxFactory(defaultPrincipal) {</span>
<a href="#l89.84"></a><span id="l89.84" class="difflineplus">+   exports.SandboxFactory = function(defaultPrincipal) {</span>
<a href="#l89.85"></a><span id="l89.85">      // Unless specified otherwise, use a principal with limited</span>
<a href="#l89.86"></a><span id="l89.86">      // privileges.</span>
<a href="#l89.87"></a><span id="l89.87" class="difflineminus">-     this._defaultPrincipal = resolvePrincipal(defaultPrincipal,</span>
<a href="#l89.88"></a><span id="l89.88" class="difflineminus">-                                               &quot;http://www.mozilla.org&quot;);</span>
<a href="#l89.89"></a><span id="l89.89" class="difflineminus">-   },</span>
<a href="#l89.90"></a><span id="l89.90" class="difflineplus">+     this._defaultPrincipal = resolvePrincipal(defaultPrincipal, &quot;http://www.mozilla.org&quot;);</span>
<a href="#l89.91"></a><span id="l89.91" class="difflineplus">+   };</span>
<a href="#l89.92"></a><span id="l89.92"> </span>
<a href="#l89.93"></a><span id="l89.93">    exports.SandboxFactory.prototype = {</span>
<a href="#l89.94"></a><span id="l89.94" class="difflineminus">-     createSandbox: function createSandbox(options) {</span>
<a href="#l89.95"></a><span id="l89.95" class="difflineplus">+     createSandbox(options) {</span>
<a href="#l89.96"></a><span id="l89.96">        var principal = resolvePrincipal(options.principal,</span>
<a href="#l89.97"></a><span id="l89.97">                                         this._defaultPrincipal);</span>
<a href="#l89.98"></a><span id="l89.98"> </span>
<a href="#l89.99"></a><span id="l89.99">        return {</span>
<a href="#l89.100"></a><span id="l89.100">          _sandbox: new Cu.Sandbox(principal, { wantGlobalProperties: [&quot;ChromeUtils&quot;] }),</span>
<a href="#l89.101"></a><span id="l89.101">          _principal: principal,</span>
<a href="#l89.102"></a><span id="l89.102">          get globalScope() {</span>
<a href="#l89.103"></a><span id="l89.103">            return this._sandbox;</span>
<a href="#l89.104"></a><span id="l89.104">          },</span>
<a href="#l89.105"></a><span id="l89.105" class="difflineminus">-         defineProperty: function defineProperty(name, value) {</span>
<a href="#l89.106"></a><span id="l89.106" class="difflineplus">+         defineProperty(name, value) {</span>
<a href="#l89.107"></a><span id="l89.107">            this._sandbox[name] = value;</span>
<a href="#l89.108"></a><span id="l89.108">          },</span>
<a href="#l89.109"></a><span id="l89.109" class="difflineminus">-         getProperty: function getProperty(name) {</span>
<a href="#l89.110"></a><span id="l89.110" class="difflineplus">+         getProperty(name) {</span>
<a href="#l89.111"></a><span id="l89.111">            return this._sandbox[name];</span>
<a href="#l89.112"></a><span id="l89.112">          },</span>
<a href="#l89.113"></a><span id="l89.113" class="difflineminus">-         evaluate: function evaluate(options) {</span>
<a href="#l89.114"></a><span id="l89.114" class="difflineminus">-           if (typeof(options) == 'string')</span>
<a href="#l89.115"></a><span id="l89.115" class="difflineplus">+         evaluate(options) {</span>
<a href="#l89.116"></a><span id="l89.116" class="difflineplus">+           if (typeof(options) == &quot;string&quot;)</span>
<a href="#l89.117"></a><span id="l89.117">              options = {contents: options};</span>
<a href="#l89.118"></a><span id="l89.118">            options = {__proto__: options};</span>
<a href="#l89.119"></a><span id="l89.119" class="difflineminus">-           if (typeof(options.contents) != 'string')</span>
<a href="#l89.120"></a><span id="l89.120" class="difflineminus">-             throw new Error('Expected string for options.contents');</span>
<a href="#l89.121"></a><span id="l89.121" class="difflineplus">+           if (typeof(options.contents) != &quot;string&quot;)</span>
<a href="#l89.122"></a><span id="l89.122" class="difflineplus">+             throw new Error(&quot;Expected string for options.contents&quot;);</span>
<a href="#l89.123"></a><span id="l89.123">            if (options.lineNo === undefined)</span>
<a href="#l89.124"></a><span id="l89.124">              options.lineNo = 1;</span>
<a href="#l89.125"></a><span id="l89.125">            if (options.jsVersion === undefined)</span>
<a href="#l89.126"></a><span id="l89.126">              options.jsVersion = &quot;1.8&quot;;</span>
<a href="#l89.127"></a><span id="l89.127" class="difflineminus">-           if (typeof(options.filename) != 'string')</span>
<a href="#l89.128"></a><span id="l89.128" class="difflineminus">-             options.filename = '&lt;string&gt;';</span>
<a href="#l89.129"></a><span id="l89.129" class="difflineplus">+           if (typeof(options.filename) != &quot;string&quot;)</span>
<a href="#l89.130"></a><span id="l89.130" class="difflineplus">+             options.filename = &quot;&lt;string&gt;&quot;;</span>
<a href="#l89.131"></a><span id="l89.131"> </span>
<a href="#l89.132"></a><span id="l89.132">            if (this._principal == systemPrincipal)</span>
<a href="#l89.133"></a><span id="l89.133">              options.filename = maybeParentifyFilename(options.filename);</span>
<a href="#l89.134"></a><span id="l89.134"> </span>
<a href="#l89.135"></a><span id="l89.135">            return Cu.evalInSandbox(options.contents,</span>
<a href="#l89.136"></a><span id="l89.136">                                    this._sandbox,</span>
<a href="#l89.137"></a><span id="l89.137">                                    options.jsVersion,</span>
<a href="#l89.138"></a><span id="l89.138">                                    options.filename,</span>
<a href="#l89.139"></a><span id="l89.139">                                    options.lineNo);</span>
<a href="#l89.140"></a><span id="l89.140" class="difflineminus">-         }</span>
<a href="#l89.141"></a><span id="l89.141" class="difflineplus">+         },</span>
<a href="#l89.142"></a><span id="l89.142">        };</span>
<a href="#l89.143"></a><span id="l89.143" class="difflineminus">-     }</span>
<a href="#l89.144"></a><span id="l89.144" class="difflineplus">+     },</span>
<a href="#l89.145"></a><span id="l89.145">    };</span>
<a href="#l89.146"></a><span id="l89.146"> </span>
<a href="#l89.147"></a><span id="l89.147" class="difflineminus">-   exports.Loader = function Loader(options) {</span>
<a href="#l89.148"></a><span id="l89.148" class="difflineplus">+   exports.Loader = function(options) {</span>
<a href="#l89.149"></a><span id="l89.149">      options = {__proto__: options};</span>
<a href="#l89.150"></a><span id="l89.150">      if (options.fs === undefined) {</span>
<a href="#l89.151"></a><span id="l89.151">        var rootPaths = options.rootPath || options.rootPaths;</span>
<a href="#l89.152"></a><span id="l89.152">        if (rootPaths) {</span>
<a href="#l89.153"></a><span id="l89.153">          if (rootPaths.constructor.name != &quot;Array&quot;)</span>
<a href="#l89.154"></a><span id="l89.154">            rootPaths = [rootPaths];</span>
<a href="#l89.155"></a><span id="l89.155">          var fses = rootPaths.map(path =&gt; new exports.LocalFileSystem(path));</span>
<a href="#l89.156"></a><span id="l89.156">          options.fs = new exports.CompositeFileSystem(fses);</span>
<a href="#l89.157"></a><span id="l89.157" class="difflineminus">-       } else</span>
<a href="#l89.158"></a><span id="l89.158" class="difflineplus">+       } else {</span>
<a href="#l89.159"></a><span id="l89.159">          options.fs = new exports.LocalFileSystem();</span>
<a href="#l89.160"></a><span id="l89.160" class="difflineplus">+       }</span>
<a href="#l89.161"></a><span id="l89.161">      }</span>
<a href="#l89.162"></a><span id="l89.162">      if (options.sandboxFactory === undefined)</span>
<a href="#l89.163"></a><span id="l89.163">        options.sandboxFactory = new exports.SandboxFactory(</span>
<a href="#l89.164"></a><span id="l89.164">          options.defaultPrincipal</span>
<a href="#l89.165"></a><span id="l89.165">        );</span>
<a href="#l89.166"></a><span id="l89.166">      if (options.modules === undefined)</span>
<a href="#l89.167"></a><span id="l89.167">        options.modules = {};</span>
<a href="#l89.168"></a><span id="l89.168">      if (options.globals === undefined)</span>
<a href="#l89.169"></a><span id="l89.169" class="difflineat">@@ -183,178 +176,177 @@</span>
<a href="#l89.170"></a><span id="l89.170">      this.fs = options.fs;</span>
<a href="#l89.171"></a><span id="l89.171">      this.sandboxFactory = options.sandboxFactory;</span>
<a href="#l89.172"></a><span id="l89.172">      this.sandboxes = {};</span>
<a href="#l89.173"></a><span id="l89.173">      this.modules = options.modules;</span>
<a href="#l89.174"></a><span id="l89.174">      this.globals = options.globals;</span>
<a href="#l89.175"></a><span id="l89.175">    };</span>
<a href="#l89.176"></a><span id="l89.176"> </span>
<a href="#l89.177"></a><span id="l89.177">    exports.Loader.prototype = {</span>
<a href="#l89.178"></a><span id="l89.178" class="difflineminus">-     _makeRequire: function _makeRequire(rootDir) {</span>
<a href="#l89.179"></a><span id="l89.179" class="difflineplus">+     _makeRequire(rootDir) {</span>
<a href="#l89.180"></a><span id="l89.180">        var self = this;</span>
<a href="#l89.181"></a><span id="l89.181" class="difflineminus">-       return function require(module) {</span>
<a href="#l89.182"></a><span id="l89.182" class="difflineplus">+       return function(module) {</span>
<a href="#l89.183"></a><span id="l89.183">          if (module == &quot;chrome&quot;) {</span>
<a href="#l89.184"></a><span id="l89.184" class="difflineminus">-           var chrome = { </span>
<a href="#l89.185"></a><span id="l89.185" class="difflineminus">-             Cc, Ci, Cu, Cr, </span>
<a href="#l89.186"></a><span id="l89.186" class="difflineplus">+           var chrome = {</span>
<a href="#l89.187"></a><span id="l89.187" class="difflineplus">+             Cc, Ci, Cu, Cr,</span>
<a href="#l89.188"></a><span id="l89.188">              Cm: Components.manager,</span>
<a href="#l89.189"></a><span id="l89.189" class="difflineminus">-             components: Components</span>
<a href="#l89.190"></a><span id="l89.190" class="difflineplus">+             components: Components,</span>
<a href="#l89.191"></a><span id="l89.191">            };</span>
<a href="#l89.192"></a><span id="l89.192">            return chrome;</span>
<a href="#l89.193"></a><span id="l89.193">          }</span>
<a href="#l89.194"></a><span id="l89.194">          var path = self.fs.resolveModule(rootDir, module);</span>
<a href="#l89.195"></a><span id="l89.195">          if (!path)</span>
<a href="#l89.196"></a><span id="l89.196">            throw new Error('Module &quot;' + module + '&quot; not found');</span>
<a href="#l89.197"></a><span id="l89.197">          if (!(path in self.modules)) {</span>
<a href="#l89.198"></a><span id="l89.198">            var options = self.fs.getFile(path);</span>
<a href="#l89.199"></a><span id="l89.199">            if (options.filename === undefined)</span>
<a href="#l89.200"></a><span id="l89.200">              options.filename = path;</span>
<a href="#l89.201"></a><span id="l89.201"> </span>
<a href="#l89.202"></a><span id="l89.202" class="difflineminus">-           var exports = {};</span>
<a href="#l89.203"></a><span id="l89.203">            var sandbox = self.sandboxFactory.createSandbox(options);</span>
<a href="#l89.204"></a><span id="l89.204">            self.sandboxes[path] = sandbox;</span>
<a href="#l89.205"></a><span id="l89.205">            for (let name in self.globals) {</span>
<a href="#l89.206"></a><span id="l89.206">              sandbox.defineProperty(name, self.globals[name]);</span>
<a href="#l89.207"></a><span id="l89.207">            }</span>
<a href="#l89.208"></a><span id="l89.208" class="difflineminus">-           sandbox.defineProperty('require', self._makeRequire(path));</span>
<a href="#l89.209"></a><span id="l89.209" class="difflineplus">+           sandbox.defineProperty(&quot;require&quot;, self._makeRequire(path));</span>
<a href="#l89.210"></a><span id="l89.210">            sandbox.evaluate(&quot;var exports = {};&quot;);</span>
<a href="#l89.211"></a><span id="l89.211">            let ES5 = self.modules.es5;</span>
<a href="#l89.212"></a><span id="l89.212">            if (ES5) {</span>
<a href="#l89.213"></a><span id="l89.213">              let { Object, Array, Function } = sandbox.globalScope;</span>
<a href="#l89.214"></a><span id="l89.214">              ES5.init(Object, Array, Function);</span>
<a href="#l89.215"></a><span id="l89.215">            }</span>
<a href="#l89.216"></a><span id="l89.216">            self.modules[path] = sandbox.getProperty(&quot;exports&quot;);</span>
<a href="#l89.217"></a><span id="l89.217">            sandbox.evaluate(options);</span>
<a href="#l89.218"></a><span id="l89.218">          }</span>
<a href="#l89.219"></a><span id="l89.219">          return self.modules[path];</span>
<a href="#l89.220"></a><span id="l89.220">        };</span>
<a href="#l89.221"></a><span id="l89.221">      },</span>
<a href="#l89.222"></a><span id="l89.222"> </span>
<a href="#l89.223"></a><span id="l89.223">      // This is only really used by unit tests and other</span>
<a href="#l89.224"></a><span id="l89.224">      // development-related facilities, allowing access to symbols</span>
<a href="#l89.225"></a><span id="l89.225">      // defined in the global scope of a module.</span>
<a href="#l89.226"></a><span id="l89.226" class="difflineminus">-     findSandboxForModule: function findSandboxForModule(module) {</span>
<a href="#l89.227"></a><span id="l89.227" class="difflineplus">+     findSandboxForModule(module) {</span>
<a href="#l89.228"></a><span id="l89.228">        var path = this.fs.resolveModule(null, module);</span>
<a href="#l89.229"></a><span id="l89.229">        if (!path)</span>
<a href="#l89.230"></a><span id="l89.230">          throw new Error('Module &quot;' + module + '&quot; not found');</span>
<a href="#l89.231"></a><span id="l89.231">        if (!(path in this.sandboxes))</span>
<a href="#l89.232"></a><span id="l89.232">          this.require(module);</span>
<a href="#l89.233"></a><span id="l89.233">        if (!(path in this.sandboxes))</span>
<a href="#l89.234"></a><span id="l89.234" class="difflineminus">-         throw new Error('Internal error: path not in sandboxes: ' +</span>
<a href="#l89.235"></a><span id="l89.235" class="difflineplus">+         throw new Error(&quot;Internal error: path not in sandboxes: &quot; +</span>
<a href="#l89.236"></a><span id="l89.236">                          path);</span>
<a href="#l89.237"></a><span id="l89.237">        return this.sandboxes[path];</span>
<a href="#l89.238"></a><span id="l89.238">      },</span>
<a href="#l89.239"></a><span id="l89.239"> </span>
<a href="#l89.240"></a><span id="l89.240" class="difflineminus">-     require: function require(module) {</span>
<a href="#l89.241"></a><span id="l89.241" class="difflineplus">+     require(module) {</span>
<a href="#l89.242"></a><span id="l89.242">        return (this._makeRequire(null))(module);</span>
<a href="#l89.243"></a><span id="l89.243">      },</span>
<a href="#l89.244"></a><span id="l89.244"> </span>
<a href="#l89.245"></a><span id="l89.245" class="difflineminus">-     runScript: function runScript(options, extraOutput) {</span>
<a href="#l89.246"></a><span id="l89.246" class="difflineminus">-       if (typeof(options) == 'string')</span>
<a href="#l89.247"></a><span id="l89.247" class="difflineplus">+     runScript(options, extraOutput) {</span>
<a href="#l89.248"></a><span id="l89.248" class="difflineplus">+       if (typeof(options) == &quot;string&quot;)</span>
<a href="#l89.249"></a><span id="l89.249">          options = {contents: options};</span>
<a href="#l89.250"></a><span id="l89.250">        options = {__proto__: options};</span>
<a href="#l89.251"></a><span id="l89.251">        var sandbox = this.sandboxFactory.createSandbox(options);</span>
<a href="#l89.252"></a><span id="l89.252">        if (extraOutput)</span>
<a href="#l89.253"></a><span id="l89.253">          extraOutput.sandbox = sandbox;</span>
<a href="#l89.254"></a><span id="l89.254">        for (let name in this.globals) {</span>
<a href="#l89.255"></a><span id="l89.255">          sandbox.defineProperty(name, this.globals[name]);</span>
<a href="#l89.256"></a><span id="l89.256">        }</span>
<a href="#l89.257"></a><span id="l89.257" class="difflineminus">-       sandbox.defineProperty('require', this._makeRequire(null));</span>
<a href="#l89.258"></a><span id="l89.258" class="difflineplus">+       sandbox.defineProperty(&quot;require&quot;, this._makeRequire(null));</span>
<a href="#l89.259"></a><span id="l89.259">        return sandbox.evaluate(options);</span>
<a href="#l89.260"></a><span id="l89.260" class="difflineminus">-     }</span>
<a href="#l89.261"></a><span id="l89.261" class="difflineplus">+     },</span>
<a href="#l89.262"></a><span id="l89.262">    };</span>
<a href="#l89.263"></a><span id="l89.263"> </span>
<a href="#l89.264"></a><span id="l89.264" class="difflineminus">-   exports.CompositeFileSystem = function CompositeFileSystem(fses) {</span>
<a href="#l89.265"></a><span id="l89.265" class="difflineplus">+   exports.CompositeFileSystem = function(fses) {</span>
<a href="#l89.266"></a><span id="l89.266">      this.fses = fses;</span>
<a href="#l89.267"></a><span id="l89.267">      this._pathMap = {};</span>
<a href="#l89.268"></a><span id="l89.268">    };</span>
<a href="#l89.269"></a><span id="l89.269"> </span>
<a href="#l89.270"></a><span id="l89.270">    exports.CompositeFileSystem.prototype = {</span>
<a href="#l89.271"></a><span id="l89.271" class="difflineminus">-     resolveModule: function resolveModule(base, path) {</span>
<a href="#l89.272"></a><span id="l89.272" class="difflineplus">+     resolveModule(base, path) {</span>
<a href="#l89.273"></a><span id="l89.273">        for (var i = 0; i &lt; this.fses.length; i++) {</span>
<a href="#l89.274"></a><span id="l89.274">          var fs = this.fses[i];</span>
<a href="#l89.275"></a><span id="l89.275">          var absPath = fs.resolveModule(base, path);</span>
<a href="#l89.276"></a><span id="l89.276">          if (absPath) {</span>
<a href="#l89.277"></a><span id="l89.277">            this._pathMap[absPath] = fs;</span>
<a href="#l89.278"></a><span id="l89.278">            return absPath;</span>
<a href="#l89.279"></a><span id="l89.279">          }</span>
<a href="#l89.280"></a><span id="l89.280">        }</span>
<a href="#l89.281"></a><span id="l89.281">        return null;</span>
<a href="#l89.282"></a><span id="l89.282">      },</span>
<a href="#l89.283"></a><span id="l89.283" class="difflineminus">-     getFile: function getFile(path) {</span>
<a href="#l89.284"></a><span id="l89.284" class="difflineplus">+     getFile(path) {</span>
<a href="#l89.285"></a><span id="l89.285">        return this._pathMap[path].getFile(path);</span>
<a href="#l89.286"></a><span id="l89.286" class="difflineminus">-     }</span>
<a href="#l89.287"></a><span id="l89.287" class="difflineplus">+     },</span>
<a href="#l89.288"></a><span id="l89.288">    };</span>
<a href="#l89.289"></a><span id="l89.289"> </span>
<a href="#l89.290"></a><span id="l89.290" class="difflineminus">-   exports.LocalFileSystem = function LocalFileSystem(root) {</span>
<a href="#l89.291"></a><span id="l89.291" class="difflineplus">+   exports.LocalFileSystem = function(root) {</span>
<a href="#l89.292"></a><span id="l89.292">      if (root === undefined) {</span>
<a href="#l89.293"></a><span id="l89.293">        if (!baseURI)</span>
<a href="#l89.294"></a><span id="l89.294">          throw new Error(&quot;Need a root path for module filesystem&quot;);</span>
<a href="#l89.295"></a><span id="l89.295">        root = baseURI;</span>
<a href="#l89.296"></a><span id="l89.296">      }</span>
<a href="#l89.297"></a><span id="l89.297" class="difflineminus">-     if (typeof(root) == 'string')</span>
<a href="#l89.298"></a><span id="l89.298" class="difflineminus">-       root = ios.newURI(root, null, baseURI);</span>
<a href="#l89.299"></a><span id="l89.299" class="difflineplus">+     if (typeof(root) == &quot;string&quot;)</span>
<a href="#l89.300"></a><span id="l89.300" class="difflineplus">+       root = Services.io.newURI(root, null, baseURI);</span>
<a href="#l89.301"></a><span id="l89.301">      if (root instanceof Ci.nsIFile)</span>
<a href="#l89.302"></a><span id="l89.302" class="difflineminus">-       root = ios.newFileURI(root);</span>
<a href="#l89.303"></a><span id="l89.303" class="difflineplus">+       root = Services.io.newFileURI(root);</span>
<a href="#l89.304"></a><span id="l89.304">      if (!(root instanceof Ci.nsIURI))</span>
<a href="#l89.305"></a><span id="l89.305" class="difflineminus">-       throw new Error('Expected nsIFile, nsIURI, or string for root');</span>
<a href="#l89.306"></a><span id="l89.306" class="difflineplus">+       throw new Error(&quot;Expected nsIFile, nsIURI, or string for root&quot;);</span>
<a href="#l89.307"></a><span id="l89.307"> </span>
<a href="#l89.308"></a><span id="l89.308">      this.root = root.spec;</span>
<a href="#l89.309"></a><span id="l89.309">      this._rootURI = root;</span>
<a href="#l89.310"></a><span id="l89.310">      this._rootURIDir = getRootDir(root.spec);</span>
<a href="#l89.311"></a><span id="l89.311">    };</span>
<a href="#l89.312"></a><span id="l89.312"> </span>
<a href="#l89.313"></a><span id="l89.313">    exports.LocalFileSystem.prototype = {</span>
<a href="#l89.314"></a><span id="l89.314" class="difflineminus">-     resolveModule: function resolveModule(base, path) {</span>
<a href="#l89.315"></a><span id="l89.315" class="difflineplus">+     resolveModule(base, path) {</span>
<a href="#l89.316"></a><span id="l89.316">        path = path + &quot;.js&quot;;</span>
<a href="#l89.317"></a><span id="l89.317"> </span>
<a href="#l89.318"></a><span id="l89.318">        var baseURI;</span>
<a href="#l89.319"></a><span id="l89.319">        if (!base)</span>
<a href="#l89.320"></a><span id="l89.320">          baseURI = this._rootURI;</span>
<a href="#l89.321"></a><span id="l89.321">        else</span>
<a href="#l89.322"></a><span id="l89.322" class="difflineminus">-         baseURI = ios.newURI(base);</span>
<a href="#l89.323"></a><span id="l89.323" class="difflineminus">-       var newURI = ios.newURI(path, null, baseURI);</span>
<a href="#l89.324"></a><span id="l89.324" class="difflineminus">-       var channel = ios.newChannelFromURI2(newURI,</span>
<a href="#l89.325"></a><span id="l89.325" class="difflineplus">+         baseURI = Services.io.newURI(base);</span>
<a href="#l89.326"></a><span id="l89.326" class="difflineplus">+       var newURI = Services.io.newURI(path, null, baseURI);</span>
<a href="#l89.327"></a><span id="l89.327" class="difflineplus">+       var channel = Services.io.newChannelFromURI2(newURI,</span>
<a href="#l89.328"></a><span id="l89.328">                                             null,</span>
<a href="#l89.329"></a><span id="l89.329" class="difflineminus">-                                            scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l89.330"></a><span id="l89.330" class="difflineplus">+                                            Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l89.331"></a><span id="l89.331">                                             null,</span>
<a href="#l89.332"></a><span id="l89.332">                                             Ci.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l89.333"></a><span id="l89.333">                                             Ci.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l89.334"></a><span id="l89.334">        try {</span>
<a href="#l89.335"></a><span id="l89.335">          channel.open().close();</span>
<a href="#l89.336"></a><span id="l89.336">        } catch (e) {</span>
<a href="#l89.337"></a><span id="l89.337">          if (e.result != Cr.NS_ERROR_FILE_NOT_FOUND) {</span>
<a href="#l89.338"></a><span id="l89.338">            throw e;</span>
<a href="#l89.339"></a><span id="l89.339">          }</span>
<a href="#l89.340"></a><span id="l89.340">          return null;</span>
<a href="#l89.341"></a><span id="l89.341">        }</span>
<a href="#l89.342"></a><span id="l89.342">        return newURI.spec;</span>
<a href="#l89.343"></a><span id="l89.343">      },</span>
<a href="#l89.344"></a><span id="l89.344" class="difflineminus">-     getFile: function getFile(path) {</span>
<a href="#l89.345"></a><span id="l89.345" class="difflineminus">-       var channel = ios.newChannel2(path,</span>
<a href="#l89.346"></a><span id="l89.346" class="difflineplus">+     getFile(path) {</span>
<a href="#l89.347"></a><span id="l89.347" class="difflineplus">+       var channel = Services.io.newChannel2(path,</span>
<a href="#l89.348"></a><span id="l89.348">                                      null,</span>
<a href="#l89.349"></a><span id="l89.349">                                      null,</span>
<a href="#l89.350"></a><span id="l89.350">                                      null,</span>
<a href="#l89.351"></a><span id="l89.351" class="difflineminus">-                                     scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l89.352"></a><span id="l89.352" class="difflineplus">+                                     Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l89.353"></a><span id="l89.353">                                      null,</span>
<a href="#l89.354"></a><span id="l89.354">                                      Ci.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l89.355"></a><span id="l89.355">                                      Ci.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l89.356"></a><span id="l89.356">        var iStream = channel.open();</span>
<a href="#l89.357"></a><span id="l89.357">        var ciStream = Cc[&quot;@mozilla.org/intl/converter-input-stream;1&quot;].</span>
<a href="#l89.358"></a><span id="l89.358">                       createInstance(Ci.nsIConverterInputStream);</span>
<a href="#l89.359"></a><span id="l89.359">        var bufLen = 0x8000;</span>
<a href="#l89.360"></a><span id="l89.360">        ciStream.init(iStream, &quot;UTF-8&quot;, bufLen,</span>
<a href="#l89.361"></a><span id="l89.361">                      Ci.nsIConverterInputStream.DEFAULT_REPLACEMENT_CHARACTER);</span>
<a href="#l89.362"></a><span id="l89.362">        var chunk = {};</span>
<a href="#l89.363"></a><span id="l89.363">        var data = &quot;&quot;;</span>
<a href="#l89.364"></a><span id="l89.364">        while (ciStream.readString(bufLen, chunk) &gt; 0)</span>
<a href="#l89.365"></a><span id="l89.365">          data += chunk.value;</span>
<a href="#l89.366"></a><span id="l89.366">        ciStream.close();</span>
<a href="#l89.367"></a><span id="l89.367">        iStream.close();</span>
<a href="#l89.368"></a><span id="l89.368">        return {contents: data};</span>
<a href="#l89.369"></a><span id="l89.369" class="difflineminus">-     }</span>
<a href="#l89.370"></a><span id="l89.370" class="difflineplus">+     },</span>
<a href="#l89.371"></a><span id="l89.371">    };</span>
<a href="#l89.372"></a><span id="l89.372"> </span>
<a href="#l89.373"></a><span id="l89.373">    if (global.window) {</span>
<a href="#l89.374"></a><span id="l89.374">      // We're being loaded in a chrome window, or a web page with</span>
<a href="#l89.375"></a><span id="l89.375">      // UniversalXPConnect privileges.</span>
<a href="#l89.376"></a><span id="l89.376">      global.SecurableModule = exports;</span>
<a href="#l89.377"></a><span id="l89.377">    } else if (global.exports) {</span>
<a href="#l89.378"></a><span id="l89.378">      // We're being loaded in a SecurableModule.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l90.1"></a><span id="l90.1">rename from mail/test/resources/mozmill/mozmill/extension/content/stdlib/strings.js</span>
<a href="#l90.2"></a><span id="l90.2">rename to mail/test/resources/mozmill/mozmill/extension/content/stdlib/strings.jsm</span>
<a href="#l90.3"></a><span id="l90.3" class="difflineminus">--- a/mail/test/resources/mozmill/mozmill/extension/content/stdlib/strings.js</span>
<a href="#l90.4"></a><span id="l90.4" class="difflineplus">+++ b/mail/test/resources/mozmill/mozmill/extension/content/stdlib/strings.jsm</span>
<a href="#l90.5"></a><span id="l90.5" class="difflineat">@@ -30,21 +30,15 @@</span>
<a href="#l90.6"></a><span id="l90.6"> // use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l90.7"></a><span id="l90.7"> // decision by deleting the provisions above and replace them with the notice</span>
<a href="#l90.8"></a><span id="l90.8"> // and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l90.9"></a><span id="l90.9"> // the provisions above, a recipient may use your version of this file under</span>
<a href="#l90.10"></a><span id="l90.10"> // the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l90.11"></a><span id="l90.11"> //</span>
<a href="#l90.12"></a><span id="l90.12"> // ***** END LICENSE BLOCK *****</span>
<a href="#l90.13"></a><span id="l90.13"> </span>
<a href="#l90.14"></a><span id="l90.14" class="difflineminus">-var EXPORTED_SYMBOLS = ['trim', 'vslice'];</span>
<a href="#l90.15"></a><span id="l90.15" class="difflineminus">-</span>
<a href="#l90.16"></a><span id="l90.16" class="difflineminus">-var arrays = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/arrays.js&quot;);</span>
<a href="#l90.17"></a><span id="l90.17" class="difflineplus">+var EXPORTED_SYMBOLS = [&quot;vslice&quot;];</span>
<a href="#l90.18"></a><span id="l90.18"> </span>
<a href="#l90.19"></a><span id="l90.19" class="difflineminus">-var trim = function (str) {</span>
<a href="#l90.20"></a><span id="l90.20" class="difflineminus">-  return (str.replace(/^[\s\xA0]+/, &quot;&quot;).replace(/[\s\xA0]+$/, &quot;&quot;));</span>
<a href="#l90.21"></a><span id="l90.21" class="difflineminus">-}</span>
<a href="#l90.22"></a><span id="l90.22" class="difflineminus">-</span>
<a href="#l90.23"></a><span id="l90.23" class="difflineminus">-var vslice = function (str, svalue, evalue) {</span>
<a href="#l90.24"></a><span id="l90.24" class="difflineminus">-  var sindex = arrays.indexOf(str, svalue);</span>
<a href="#l90.25"></a><span id="l90.25" class="difflineminus">-  var eindex = arrays.rindexOf(str, evalue);</span>
<a href="#l90.26"></a><span id="l90.26" class="difflineplus">+var vslice = function(str, svalue, evalue) {</span>
<a href="#l90.27"></a><span id="l90.27" class="difflineplus">+  var sindex = str.indexOf(svalue);</span>
<a href="#l90.28"></a><span id="l90.28" class="difflineplus">+  var eindex = str.lastIndexOf(evalue);</span>
<a href="#l90.29"></a><span id="l90.29">   return str.slice(sindex + 1, eindex);</span>
<a href="#l90.30"></a><span id="l90.30" class="difflineminus">-}</span>
<a href="#l90.31"></a><span id="l90.31" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l91.1"></a><span id="l91.1">deleted file mode 100644</span>
<a href="#l91.2"></a><span id="l91.2" class="difflineminus">--- a/mail/test/resources/mozmill/mozmill/extension/content/stdlib/withs.js</span>
<a href="#l91.3"></a><span id="l91.3" class="difflineplus">+++ /dev/null</span>
<a href="#l91.4"></a><span id="l91.4" class="difflineat">@@ -1,146 +0,0 @@</span>
<a href="#l91.5"></a><span id="l91.5" class="difflineminus">-/*</span>
<a href="#l91.6"></a><span id="l91.6" class="difflineminus">-    Copyright (c) 2006 Lawrence Oluyede &lt;l.oluyede@gmail.com&gt;</span>
<a href="#l91.7"></a><span id="l91.7" class="difflineminus">-</span>
<a href="#l91.8"></a><span id="l91.8" class="difflineminus">-    Permission is hereby granted, free of charge, to any person obtaining a copy</span>
<a href="#l91.9"></a><span id="l91.9" class="difflineminus">-    of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
<a href="#l91.10"></a><span id="l91.10" class="difflineminus">-    in the Software without restriction, including without limitation the rights</span>
<a href="#l91.11"></a><span id="l91.11" class="difflineminus">-    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
<a href="#l91.12"></a><span id="l91.12" class="difflineminus">-    copies of the Software, and to permit persons to whom the Software is</span>
<a href="#l91.13"></a><span id="l91.13" class="difflineminus">-    furnished to do so, subject to the following conditions:</span>
<a href="#l91.14"></a><span id="l91.14" class="difflineminus">-</span>
<a href="#l91.15"></a><span id="l91.15" class="difflineminus">-    The above copyright notice and this permission notice shall be included in all</span>
<a href="#l91.16"></a><span id="l91.16" class="difflineminus">-    copies or substantial portions of the Software.</span>
<a href="#l91.17"></a><span id="l91.17" class="difflineminus">-</span>
<a href="#l91.18"></a><span id="l91.18" class="difflineminus">-    THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<a href="#l91.19"></a><span id="l91.19" class="difflineminus">-    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<a href="#l91.20"></a><span id="l91.20" class="difflineminus">-    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<a href="#l91.21"></a><span id="l91.21" class="difflineminus">-    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<a href="#l91.22"></a><span id="l91.22" class="difflineminus">-    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
<a href="#l91.23"></a><span id="l91.23" class="difflineminus">-    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<a href="#l91.24"></a><span id="l91.24" class="difflineminus">-    SOFTWARE.</span>
<a href="#l91.25"></a><span id="l91.25" class="difflineminus">-*/</span>
<a href="#l91.26"></a><span id="l91.26" class="difflineminus">-</span>
<a href="#l91.27"></a><span id="l91.27" class="difflineminus">-/*</span>
<a href="#l91.28"></a><span id="l91.28" class="difflineminus">- startsWith(str, prefix[, start[, end]]) -&gt; bool</span>
<a href="#l91.29"></a><span id="l91.29" class="difflineminus">-</span>
<a href="#l91.30"></a><span id="l91.30" class="difflineminus">- Return true if str ends with the specified prefix, false otherwise.</span>
<a href="#l91.31"></a><span id="l91.31" class="difflineminus">- With optional start, test str beginning at that position.</span>
<a href="#l91.32"></a><span id="l91.32" class="difflineminus">- With optional end, stop comparing str at that position.</span>
<a href="#l91.33"></a><span id="l91.33" class="difflineminus">- prefix can also be an array of strings to try.</span>
<a href="#l91.34"></a><span id="l91.34" class="difflineminus">-*/</span>
<a href="#l91.35"></a><span id="l91.35" class="difflineminus">-</span>
<a href="#l91.36"></a><span id="l91.36" class="difflineminus">-var EXPORTED_SYMBOLS = ['startsWith', 'endsWith'];</span>
<a href="#l91.37"></a><span id="l91.37" class="difflineminus">-</span>
<a href="#l91.38"></a><span id="l91.38" class="difflineminus">-function startsWith(str, prefix, start, end) {</span>
<a href="#l91.39"></a><span id="l91.39" class="difflineminus">-    if (arguments.length &lt; 2) {</span>
<a href="#l91.40"></a><span id="l91.40" class="difflineminus">-        throw new TypeError('startsWith() requires at least 2 arguments');</span>
<a href="#l91.41"></a><span id="l91.41" class="difflineminus">-    }</span>
<a href="#l91.42"></a><span id="l91.42" class="difflineminus">-</span>
<a href="#l91.43"></a><span id="l91.43" class="difflineminus">-    // check if start and end are null/undefined or a 'number'</span>
<a href="#l91.44"></a><span id="l91.44" class="difflineminus">-    if ((start == null) || (isNaN(new Number(start)))) {</span>
<a href="#l91.45"></a><span id="l91.45" class="difflineminus">-        start = 0;</span>
<a href="#l91.46"></a><span id="l91.46" class="difflineminus">-    }</span>
<a href="#l91.47"></a><span id="l91.47" class="difflineminus">-    if ((end == null) || (isNaN(new Number(end)))) {</span>
<a href="#l91.48"></a><span id="l91.48" class="difflineminus">-        end = Number.MAX_VALUE;</span>
<a href="#l91.49"></a><span id="l91.49" class="difflineminus">-    }</span>
<a href="#l91.50"></a><span id="l91.50" class="difflineminus">-</span>
<a href="#l91.51"></a><span id="l91.51" class="difflineminus">-    // if it's an array</span>
<a href="#l91.52"></a><span id="l91.52" class="difflineminus">-    if (typeof prefix == &quot;object&quot;) {</span>
<a href="#l91.53"></a><span id="l91.53" class="difflineminus">-        for (var i = 0, j = prefix.length; i &lt; j; i++) {</span>
<a href="#l91.54"></a><span id="l91.54" class="difflineminus">-            var res = _stringTailMatch(str, prefix[i], start, end, true);</span>
<a href="#l91.55"></a><span id="l91.55" class="difflineminus">-            if (res) {</span>
<a href="#l91.56"></a><span id="l91.56" class="difflineminus">-                return true;</span>
<a href="#l91.57"></a><span id="l91.57" class="difflineminus">-            }</span>
<a href="#l91.58"></a><span id="l91.58" class="difflineminus">-        }</span>
<a href="#l91.59"></a><span id="l91.59" class="difflineminus">-        return false;</span>
<a href="#l91.60"></a><span id="l91.60" class="difflineminus">-    }</span>
<a href="#l91.61"></a><span id="l91.61" class="difflineminus">-</span>
<a href="#l91.62"></a><span id="l91.62" class="difflineminus">-    return _stringTailMatch(str, prefix, start, end, true);</span>
<a href="#l91.63"></a><span id="l91.63" class="difflineminus">-}</span>
<a href="#l91.64"></a><span id="l91.64" class="difflineminus">-</span>
<a href="#l91.65"></a><span id="l91.65" class="difflineminus">-/*</span>
<a href="#l91.66"></a><span id="l91.66" class="difflineminus">- endsWith(str, suffix[, start[, end]]) -&gt; bool</span>
<a href="#l91.67"></a><span id="l91.67" class="difflineminus">-</span>
<a href="#l91.68"></a><span id="l91.68" class="difflineminus">- Return true if str ends with the specified suffix, false otherwise.</span>
<a href="#l91.69"></a><span id="l91.69" class="difflineminus">- With optional start, test str beginning at that position.</span>
<a href="#l91.70"></a><span id="l91.70" class="difflineminus">- With optional end, stop comparing str at that position.</span>
<a href="#l91.71"></a><span id="l91.71" class="difflineminus">- suffix can also be an array of strings to try.</span>
<a href="#l91.72"></a><span id="l91.72" class="difflineminus">-*/</span>
<a href="#l91.73"></a><span id="l91.73" class="difflineminus">-function endsWith(str, suffix, start, end) {</span>
<a href="#l91.74"></a><span id="l91.74" class="difflineminus">-    if (arguments.length &lt; 2) {</span>
<a href="#l91.75"></a><span id="l91.75" class="difflineminus">-        throw new TypeError('endsWith() requires at least 2 arguments');</span>
<a href="#l91.76"></a><span id="l91.76" class="difflineminus">-    }</span>
<a href="#l91.77"></a><span id="l91.77" class="difflineminus">-</span>
<a href="#l91.78"></a><span id="l91.78" class="difflineminus">-    // check if start and end are null/undefined or a 'number'</span>
<a href="#l91.79"></a><span id="l91.79" class="difflineminus">-    if ((start == null) || (isNaN(new Number(start)))) {</span>
<a href="#l91.80"></a><span id="l91.80" class="difflineminus">-        start = 0;</span>
<a href="#l91.81"></a><span id="l91.81" class="difflineminus">-    }</span>
<a href="#l91.82"></a><span id="l91.82" class="difflineminus">-    if ((end == null) || (isNaN(new Number(end)))) {</span>
<a href="#l91.83"></a><span id="l91.83" class="difflineminus">-        end = Number.MAX_VALUE;</span>
<a href="#l91.84"></a><span id="l91.84" class="difflineminus">-    }</span>
<a href="#l91.85"></a><span id="l91.85" class="difflineminus">-</span>
<a href="#l91.86"></a><span id="l91.86" class="difflineminus">-    // if it's an array</span>
<a href="#l91.87"></a><span id="l91.87" class="difflineminus">-    if (typeof suffix == &quot;object&quot;) {</span>
<a href="#l91.88"></a><span id="l91.88" class="difflineminus">-        for (var i = 0, j = suffix.length; i &lt; j; i++) {</span>
<a href="#l91.89"></a><span id="l91.89" class="difflineminus">-            var res = _stringTailMatch(str, suffix[i], start, end, false);</span>
<a href="#l91.90"></a><span id="l91.90" class="difflineminus">-            if (res) {</span>
<a href="#l91.91"></a><span id="l91.91" class="difflineminus">-                return true;</span>
<a href="#l91.92"></a><span id="l91.92" class="difflineminus">-            }</span>
<a href="#l91.93"></a><span id="l91.93" class="difflineminus">-        }</span>
<a href="#l91.94"></a><span id="l91.94" class="difflineminus">-        return false;</span>
<a href="#l91.95"></a><span id="l91.95" class="difflineminus">-    }</span>
<a href="#l91.96"></a><span id="l91.96" class="difflineminus">-</span>
<a href="#l91.97"></a><span id="l91.97" class="difflineminus">-    return _stringTailMatch(str, suffix, start, end, false);</span>
<a href="#l91.98"></a><span id="l91.98" class="difflineminus">-}</span>
<a href="#l91.99"></a><span id="l91.99" class="difflineminus">-</span>
<a href="#l91.100"></a><span id="l91.100" class="difflineminus">-/*</span>
<a href="#l91.101"></a><span id="l91.101" class="difflineminus">- Matches the end (direction == false) or start (direction == true) of str</span>
<a href="#l91.102"></a><span id="l91.102" class="difflineminus">- against substr, using the start and end arguments. Returns false</span>
<a href="#l91.103"></a><span id="l91.103" class="difflineminus">- if not found and true if found.</span>
<a href="#l91.104"></a><span id="l91.104" class="difflineminus">-*/</span>
<a href="#l91.105"></a><span id="l91.105" class="difflineminus">-function _stringTailMatch(str, substr, start, end, fromStart) {</span>
<a href="#l91.106"></a><span id="l91.106" class="difflineminus">-    var len = str.length;</span>
<a href="#l91.107"></a><span id="l91.107" class="difflineminus">-    var slen = substr.length;</span>
<a href="#l91.108"></a><span id="l91.108" class="difflineminus">-</span>
<a href="#l91.109"></a><span id="l91.109" class="difflineminus">-    var indices = _adjustIndices(start, end, len);</span>
<a href="#l91.110"></a><span id="l91.110" class="difflineminus">-    start = indices[0]; end = indices[1]; len = indices[2];</span>
<a href="#l91.111"></a><span id="l91.111" class="difflineminus">-</span>
<a href="#l91.112"></a><span id="l91.112" class="difflineminus">-    if (fromStart) {</span>
<a href="#l91.113"></a><span id="l91.113" class="difflineminus">-        if (start + slen &gt; len) {</span>
<a href="#l91.114"></a><span id="l91.114" class="difflineminus">-            return false;</span>
<a href="#l91.115"></a><span id="l91.115" class="difflineminus">-        }</span>
<a href="#l91.116"></a><span id="l91.116" class="difflineminus">-    } else {</span>
<a href="#l91.117"></a><span id="l91.117" class="difflineminus">-        if (end - start &lt; slen || start &gt; len) {</span>
<a href="#l91.118"></a><span id="l91.118" class="difflineminus">-            return false;</span>
<a href="#l91.119"></a><span id="l91.119" class="difflineminus">-        }</span>
<a href="#l91.120"></a><span id="l91.120" class="difflineminus">-        if (end - slen &gt; start) {</span>
<a href="#l91.121"></a><span id="l91.121" class="difflineminus">-            start = end - slen;</span>
<a href="#l91.122"></a><span id="l91.122" class="difflineminus">-        }</span>
<a href="#l91.123"></a><span id="l91.123" class="difflineminus">-    }</span>
<a href="#l91.124"></a><span id="l91.124" class="difflineminus">-</span>
<a href="#l91.125"></a><span id="l91.125" class="difflineminus">-    if (end - start &gt;= slen) {</span>
<a href="#l91.126"></a><span id="l91.126" class="difflineminus">-        return str.substr(start, slen) == substr;</span>
<a href="#l91.127"></a><span id="l91.127" class="difflineminus">-    }</span>
<a href="#l91.128"></a><span id="l91.128" class="difflineminus">-    return false;</span>
<a href="#l91.129"></a><span id="l91.129" class="difflineminus">-}</span>
<a href="#l91.130"></a><span id="l91.130" class="difflineminus">-</span>
<a href="#l91.131"></a><span id="l91.131" class="difflineminus">-function _adjustIndices(start, end, len)</span>
<a href="#l91.132"></a><span id="l91.132" class="difflineminus">-{</span>
<a href="#l91.133"></a><span id="l91.133" class="difflineminus">-  if (end &gt; len) {</span>
<a href="#l91.134"></a><span id="l91.134" class="difflineminus">-    end = len;</span>
<a href="#l91.135"></a><span id="l91.135" class="difflineminus">-  } else if (end &lt; 0) {</span>
<a href="#l91.136"></a><span id="l91.136" class="difflineminus">-    end += len;</span>
<a href="#l91.137"></a><span id="l91.137" class="difflineminus">-  }</span>
<a href="#l91.138"></a><span id="l91.138" class="difflineminus">-</span>
<a href="#l91.139"></a><span id="l91.139" class="difflineminus">-  if (end &lt; 0) {</span>
<a href="#l91.140"></a><span id="l91.140" class="difflineminus">-    end = 0;</span>
<a href="#l91.141"></a><span id="l91.141" class="difflineminus">-  }</span>
<a href="#l91.142"></a><span id="l91.142" class="difflineminus">-  if (start &lt; 0) {</span>
<a href="#l91.143"></a><span id="l91.143" class="difflineminus">-    start += len;</span>
<a href="#l91.144"></a><span id="l91.144" class="difflineminus">-  }</span>
<a href="#l91.145"></a><span id="l91.145" class="difflineminus">-  if (start &lt; 0) {</span>
<a href="#l91.146"></a><span id="l91.146" class="difflineminus">-    start = 0;</span>
<a href="#l91.147"></a><span id="l91.147" class="difflineminus">-  }</span>
<a href="#l91.148"></a><span id="l91.148" class="difflineminus">-</span>
<a href="#l91.149"></a><span id="l91.149" class="difflineminus">-  return [start, end, len];</span>
<a href="#l91.150"></a><span id="l91.150" class="difflineminus">-}</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

