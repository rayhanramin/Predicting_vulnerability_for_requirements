<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 4677:908ca8f18256d174348cbc7a992dcd8de2b8af9a</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 908ca8f18256d174348cbc7a992dcd8de2b8af9a" />
<meta property="og:url" content="/comm-central/rev/908ca8f18256d174348cbc7a992dcd8de2b8af9a" />
<meta property="og:description" content="fix bug 534835, r/sr/a=standard8, when fetching whole imap message, use the literal size as the message size in case the server gets the rfc822.size wrong consistently, to avoid refetching the same message over and over again" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 908ca8f18256d174348cbc7a992dcd8de2b8af9a 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/908ca8f18256d174348cbc7a992dcd8de2b8af9a">shortlog</a> |
<a href="/comm-central/log/908ca8f18256d174348cbc7a992dcd8de2b8af9a">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/908ca8f18256d174348cbc7a992dcd8de2b8af9a">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/908ca8f18256d174348cbc7a992dcd8de2b8af9a">files</a> |
changeset |
<a href="/comm-central/raw-rev/908ca8f18256d174348cbc7a992dcd8de2b8af9a">raw</a>  | <a href="/comm-central/archive/908ca8f18256d174348cbc7a992dcd8de2b8af9a.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=534835">bug 534835</a>, r/sr/a=standard8, when fetching whole imap message, use the literal size as the message size in case the server gets the rfc822.size wrong consistently, to avoid refetching the same message over and over again
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#68;&#97;&#118;&#105;&#100;&#32;&#66;&#105;&#101;&#110;&#118;&#101;&#110;&#117;&#32;&#60;&#98;&#105;&#101;&#110;&#118;&#101;&#110;&#117;&#64;&#110;&#118;&#101;&#110;&#116;&#117;&#114;&#101;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Sun, 10 Jan 2010 15:47:13 -0800</td></tr>

<tr>
 <td>changeset 4677</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/908ca8f18256d174348cbc7a992dcd8de2b8af9a">908ca8f18256d174348cbc7a992dcd8de2b8af9a</a></td>
</tr>



<tr>
<td>parent 4676</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/2927fc566fc80fb2b85d48f43059a91b01fd7b28">2927fc566fc80fb2b85d48f43059a91b01fd7b28</a>
</td>
</tr>

<tr>
<td>child 4678</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/c1d217cb6de91d6a87e8e253d8298722be99ff12">c1d217cb6de91d6a87e8e253d8298722be99ff12</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=908ca8f18256d174348cbc7a992dcd8de2b8af9a">3659</a></td></tr>
<tr><td>push user</td><td>bienvenu@nventure.com</td></tr>
<tr><td>push date</td><td class="date age">Sun, 10 Jan 2010 23:47:18 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@908ca8f18256 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=908ca8f18256d174348cbc7a992dcd8de2b8af9a">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=908ca8f18256d174348cbc7a992dcd8de2b8af9a&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=908ca8f18256d174348cbc7a992dcd8de2b8af9a&newProject=comm-central&newRevision=908ca8f18256d174348cbc7a992dcd8de2b8af9a&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=908ca8f18256d174348cbc7a992dcd8de2b8af9a&newProject=comm-central&newRevision=908ca8f18256d174348cbc7a992dcd8de2b8af9a&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=908ca8f18256d174348cbc7a992dcd8de2b8af9a&newProject=comm-central&newRevision=908ca8f18256d174348cbc7a992dcd8de2b8af9a&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>

<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=534835">534835</a></td></tr>




</table></div>

<div class="page_body description">fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=534835">bug 534835</a>, r/sr/a=standard8, when fetching whole imap message, use the literal size as the message size in case the server gets the rfc822.size wrong consistently, to avoid refetching the same message over and over again</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/908ca8f18256d174348cbc7a992dcd8de2b8af9a/mailnews/imap/src/nsImapServerResponseParser.cpp">mailnews/imap/src/nsImapServerResponseParser.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/908ca8f18256d174348cbc7a992dcd8de2b8af9a/mailnews/imap/src/nsImapServerResponseParser.cpp">file</a> |
<a href="/comm-central/annotate/908ca8f18256d174348cbc7a992dcd8de2b8af9a/mailnews/imap/src/nsImapServerResponseParser.cpp">annotate</a> |
<a href="/comm-central/diff/908ca8f18256d174348cbc7a992dcd8de2b8af9a/mailnews/imap/src/nsImapServerResponseParser.cpp">diff</a> |
<a href="/comm-central/comparison/908ca8f18256d174348cbc7a992dcd8de2b8af9a/mailnews/imap/src/nsImapServerResponseParser.cpp">comparison</a> |
<a href="/comm-central/log/908ca8f18256d174348cbc7a992dcd8de2b8af9a/mailnews/imap/src/nsImapServerResponseParser.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/908ca8f18256d174348cbc7a992dcd8de2b8af9a/mailnews/imap/test/unit/test_downloadOffline.js">mailnews/imap/test/unit/test_downloadOffline.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/908ca8f18256d174348cbc7a992dcd8de2b8af9a/mailnews/imap/test/unit/test_downloadOffline.js">file</a> |
<a href="/comm-central/annotate/908ca8f18256d174348cbc7a992dcd8de2b8af9a/mailnews/imap/test/unit/test_downloadOffline.js">annotate</a> |
<a href="/comm-central/diff/908ca8f18256d174348cbc7a992dcd8de2b8af9a/mailnews/imap/test/unit/test_downloadOffline.js">diff</a> |
<a href="/comm-central/comparison/908ca8f18256d174348cbc7a992dcd8de2b8af9a/mailnews/imap/test/unit/test_downloadOffline.js">comparison</a> |
<a href="/comm-central/log/908ca8f18256d174348cbc7a992dcd8de2b8af9a/mailnews/imap/test/unit/test_downloadOffline.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/908ca8f18256d174348cbc7a992dcd8de2b8af9a/mailnews/test/fakeserver/imapd.js">mailnews/test/fakeserver/imapd.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/908ca8f18256d174348cbc7a992dcd8de2b8af9a/mailnews/test/fakeserver/imapd.js">file</a> |
<a href="/comm-central/annotate/908ca8f18256d174348cbc7a992dcd8de2b8af9a/mailnews/test/fakeserver/imapd.js">annotate</a> |
<a href="/comm-central/diff/908ca8f18256d174348cbc7a992dcd8de2b8af9a/mailnews/test/fakeserver/imapd.js">diff</a> |
<a href="/comm-central/comparison/908ca8f18256d174348cbc7a992dcd8de2b8af9a/mailnews/test/fakeserver/imapd.js">comparison</a> |
<a href="/comm-central/log/908ca8f18256d174348cbc7a992dcd8de2b8af9a/mailnews/test/fakeserver/imapd.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/imap/src/nsImapServerResponseParser.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapServerResponseParser.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -3057,16 +3057,21 @@ PRBool nsImapServerResponseParser::msg_f</span>
<a href="#l1.4"></a><span id="l1.4">     (imapAction != nsIImapUrl::nsImapOnlineToOfflineCopy) &amp;&amp;</span>
<a href="#l1.5"></a><span id="l1.5">     (imapAction != nsIImapUrl::nsImapOnlineToOfflineMove))</span>
<a href="#l1.6"></a><span id="l1.6">   {</span>
<a href="#l1.7"></a><span id="l1.7">     // One day maybe we'll make this smarter and know how to handle CR/LF boundaries across tunnels.</span>
<a href="#l1.8"></a><span id="l1.8">     // For now, we won't, even though it might not be too hard, because it is very rare and will add</span>
<a href="#l1.9"></a><span id="l1.9">     // some complexity.</span>
<a href="#l1.10"></a><span id="l1.10">     charsReadSoFar = fServerConnection.OpenTunnel(numberOfCharsInThisChunk);</span>
<a href="#l1.11"></a><span id="l1.11">   }</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+  // If we're fetching the whole message, the length of the returned literal</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+  // must be the message size, and for servers like Exchange that only</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+  // approximate the rfc822 size, we can use this size as the correct size.</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+  if (!chunk &amp;&amp; fFetchEverythingRFC822)</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+    fSizeOfMostRecentMessage = numberOfCharsInThisChunk;</span>
<a href="#l1.17"></a><span id="l1.17">   </span>
<a href="#l1.18"></a><span id="l1.18">   // If we opened a tunnel, finish everything off here.  Otherwise, get everything here.</span>
<a href="#l1.19"></a><span id="l1.19">   // (just like before)</span>
<a href="#l1.20"></a><span id="l1.20">   </span>
<a href="#l1.21"></a><span id="l1.21">   while (ContinueParse() &amp;&amp; !fServerConnection.DeathSignalReceived() &amp;&amp; (charsReadSoFar &lt; numberOfCharsInThisChunk))</span>
<a href="#l1.22"></a><span id="l1.22">   {</span>
<a href="#l1.23"></a><span id="l1.23">     AdvanceToNextLine();</span>
<a href="#l1.24"></a><span id="l1.24">     if (ContinueParse())</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_downloadOffline.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_downloadOffline.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -4,16 +4,18 @@</span>
<a href="#l2.4"></a><span id="l2.4">  * and returns success.</span>
<a href="#l2.5"></a><span id="l2.5">  */</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7"> var gIMAPDaemon, gServer, gIMAPIncomingServer;</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9"> const gIMAPService = Cc[&quot;@mozilla.org/messenger/messageservice;1?type=imap&quot;]</span>
<a href="#l2.10"></a><span id="l2.10">                        .getService(Ci.nsIMsgMessageService);</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+load(&quot;../../mailnews/resources/messageGenerator.js&quot;);</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+</span>
<a href="#l2.14"></a><span id="l2.14"> const gFileName = &quot;bug460636&quot;;</span>
<a href="#l2.15"></a><span id="l2.15"> const gMsgFile = do_get_file(&quot;../../mailnews/data/&quot; + gFileName);</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17"> var gDownloadedOnce = false;</span>
<a href="#l2.18"></a><span id="l2.18"> var gIMAPInbox;</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20"> function run_test()</span>
<a href="#l2.21"></a><span id="l2.21"> {</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -32,26 +34,37 @@ function run_test()</span>
<a href="#l2.23"></a><span id="l2.23">                      .getService(Ci.nsIPrefBranch);</span>
<a href="#l2.24"></a><span id="l2.24">   prefBranch.setBoolPref(&quot;mail.biff.play_sound&quot;, false);</span>
<a href="#l2.25"></a><span id="l2.25">   prefBranch.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l2.26"></a><span id="l2.26">   prefBranch.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l2.27"></a><span id="l2.27">   prefBranch.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l2.28"></a><span id="l2.28"> </span>
<a href="#l2.29"></a><span id="l2.29">   let inbox = gIMAPDaemon.getMailbox(&quot;INBOX&quot;);</span>
<a href="#l2.30"></a><span id="l2.30"> </span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-  /*</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+  let ioService = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+  .getService(Ci.nsIIOService);</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+ /*</span>
<a href="#l2.35"></a><span id="l2.35">    * Ok, prelude done. Read the original message from disk</span>
<a href="#l2.36"></a><span id="l2.36">    * (through a file URI), and add it to the Inbox.</span>
<a href="#l2.37"></a><span id="l2.37">    */</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineminus">-  let msgfileuri = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-                     .getService(Ci.nsIIOService)</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-                     .newFileURI(gMsgFile).QueryInterface(Ci.nsIFileURL);</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+  let msgfileuri = ioService.newFileURI(gMsgFile).QueryInterface(Ci.nsIFileURL);</span>
<a href="#l2.42"></a><span id="l2.42"> </span>
<a href="#l2.43"></a><span id="l2.43">   inbox.addMessage(new imapMessage(msgfileuri.spec, inbox.uidnext++, []));</span>
<a href="#l2.44"></a><span id="l2.44"> </span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+  let messages = [];</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+  let gMessageGenerator = new MessageGenerator();</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+  messages = messages.concat(gMessageGenerator.makeMessage());</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+  gSynthMessage = messages[0];</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+  let dataUri = ioService.newURI(&quot;data:text/plain;base64,&quot; +</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+                   btoa(messages[0].toMessageString()),</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+                   null, null);</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+  let imapMsg = new imapMessage(dataUri.spec, inbox.uidnext++, []);</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+  imapMsg.setSize(5000);</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+  inbox.addMessage(imapMsg);</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+  </span>
<a href="#l2.56"></a><span id="l2.56">   do_test_pending();</span>
<a href="#l2.57"></a><span id="l2.57">   do_timeout(10000, function(){</span>
<a href="#l2.58"></a><span id="l2.58">         do_throw('downloadAllForOffline did not complete within 10 seconds. ABORTING.');</span>
<a href="#l2.59"></a><span id="l2.59">       }</span>
<a href="#l2.60"></a><span id="l2.60">     );</span>
<a href="#l2.61"></a><span id="l2.61"> </span>
<a href="#l2.62"></a><span id="l2.62">   // Get the IMAP inbox...</span>
<a href="#l2.63"></a><span id="l2.63">   let rootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineat">@@ -69,16 +82,33 @@ var UrlListener =</span>
<a href="#l2.65"></a><span id="l2.65">     // Check for ok status.</span>
<a href="#l2.66"></a><span id="l2.66">     do_check_eq(rc, 0);</span>
<a href="#l2.67"></a><span id="l2.67"> </span>
<a href="#l2.68"></a><span id="l2.68">     if (!gDownloadedOnce) {</span>
<a href="#l2.69"></a><span id="l2.69">       gDownloadedOnce = true;</span>
<a href="#l2.70"></a><span id="l2.70">       gIMAPInbox.downloadAllForOffline(UrlListener, null);</span>
<a href="#l2.71"></a><span id="l2.71">       return;</span>
<a href="#l2.72"></a><span id="l2.72">     }</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+    else {</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+      // verify that the message headers have the offline flag set.</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+      let msgEnumerator = gIMAPInbox.msgDatabase.EnumerateMessages();</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+      let offset = new Object;</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+      let size = new Object;</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+      while (msgEnumerator.hasMoreElements())</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+      {</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineplus">+        let header = msgEnumerator.getNext();</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineplus">+        // Verify that each message has been downloaded and looks OK.</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineplus">+        if (header instanceof Components.interfaces.nsIMsgDBHdr &amp;&amp;</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineplus">+            (header.flags &amp; Ci.nsMsgMessageFlags.Offline))</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineplus">+          gIMAPInbox.getOfflineFileStream(header.messageKey, offset, size).close();</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineplus">+        else</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineplus">+          do_throw(&quot;Message not downloaded for offline use&quot;);</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+      }</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineplus">+      endTest();</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineplus">+    }</span>
<a href="#l2.90"></a><span id="l2.90">     do_timeout(1000, endTest);</span>
<a href="#l2.91"></a><span id="l2.91">   }</span>
<a href="#l2.92"></a><span id="l2.92"> };</span>
<a href="#l2.93"></a><span id="l2.93"> </span>
<a href="#l2.94"></a><span id="l2.94"> function endTest()</span>
<a href="#l2.95"></a><span id="l2.95"> {</span>
<a href="#l2.96"></a><span id="l2.96">   gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l2.97"></a><span id="l2.97">   gServer.stop();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/test/fakeserver/imapd.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/test/fakeserver/imapd.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -314,32 +314,37 @@ imapMailbox.prototype = {</span>
<a href="#l3.4"></a><span id="l3.4">     return response;</span>
<a href="#l3.5"></a><span id="l3.5">   }</span>
<a href="#l3.6"></a><span id="l3.6"> }</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8"> var gIOService;</span>
<a href="#l3.9"></a><span id="l3.9"> function imapMessage(URI, uid, flags) {</span>
<a href="#l3.10"></a><span id="l3.10">   this._URI = URI;</span>
<a href="#l3.11"></a><span id="l3.11">   this.uid = uid;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+  this.size = 0;</span>
<a href="#l3.13"></a><span id="l3.13">   this.flags = new Array;</span>
<a href="#l3.14"></a><span id="l3.14">   for each (flag in flags)</span>
<a href="#l3.15"></a><span id="l3.15">     this.flags.push(flag);</span>
<a href="#l3.16"></a><span id="l3.16">   this.recent = false;</span>
<a href="#l3.17"></a><span id="l3.17"> }</span>
<a href="#l3.18"></a><span id="l3.18"> imapMessage.prototype = {</span>
<a href="#l3.19"></a><span id="l3.19">   get channel() {</span>
<a href="#l3.20"></a><span id="l3.20">     if (!gIOService)</span>
<a href="#l3.21"></a><span id="l3.21">       gIOService = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l3.22"></a><span id="l3.22">                      .getService(Ci.nsIIOService);</span>
<a href="#l3.23"></a><span id="l3.23">     return gIOService.newChannel(this._URI, null, null);</span>
<a href="#l3.24"></a><span id="l3.24">   },</span>
<a href="#l3.25"></a><span id="l3.25">   setFlag : function (flag) {</span>
<a href="#l3.26"></a><span id="l3.26">    if (this.flags.indexOf(flag) == -1)</span>
<a href="#l3.27"></a><span id="l3.27">      this.flags.push(flag);</span>
<a href="#l3.28"></a><span id="l3.28">   },</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+  // This allows us to simulate servers that approximate the rfc822 size.</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+  setSize: function(size) {</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+    this.size = size;</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+  },</span>
<a href="#l3.33"></a><span id="l3.33">   clearFlag : function (flag) {</span>
<a href="#l3.34"></a><span id="l3.34">     if ((index = this.flags.indexOf(flag)) != -1)</span>
<a href="#l3.35"></a><span id="l3.35">       this.flags.splice(index, 1);</span>
<a href="#l3.36"></a><span id="l3.36">   },</span>
<a href="#l3.37"></a><span id="l3.37">   getText : function (start, length) {</span>
<a href="#l3.38"></a><span id="l3.38">     if (!start)</span>
<a href="#l3.39"></a><span id="l3.39">       start = 0;</span>
<a href="#l3.40"></a><span id="l3.40">     if (!length)</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineat">@@ -1455,17 +1460,17 @@ IMAP_RFC3501_handler.prototype = {</span>
<a href="#l3.42"></a><span id="l3.42">       return this._FETCH_BODY(message, &quot;BODY.PEEK[HEADER]&quot;)</span>
<a href="#l3.43"></a><span id="l3.43">                  .replace(&quot;BODY[HEADER]&quot;, &quot;RFC822.HEADER&quot;);</span>
<a href="#l3.44"></a><span id="l3.44">     if (query == &quot;RFC822.TEXT&quot;)</span>
<a href="#l3.45"></a><span id="l3.45">       return this._FETCH_BODY(message, &quot;BODY[TEXT]&quot;)</span>
<a href="#l3.46"></a><span id="l3.46">                  .replace(&quot;BODY[TEXT]&quot;, &quot;RFC822.TEXT&quot;);</span>
<a href="#l3.47"></a><span id="l3.47">     </span>
<a href="#l3.48"></a><span id="l3.48">     if (query == &quot;RFC822.SIZE&quot;) {</span>
<a href="#l3.49"></a><span id="l3.49">       var channel = message.channel;</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">-      var length = channel.contentLength;</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+      var length = message.size ? message.size : channel.contentLength;</span>
<a href="#l3.52"></a><span id="l3.52">       if (length == -1) {</span>
<a href="#l3.53"></a><span id="l3.53">         var inputStream = channel.open();</span>
<a href="#l3.54"></a><span id="l3.54">         length = inputStream.available();</span>
<a href="#l3.55"></a><span id="l3.55">         inputStream.close();</span>
<a href="#l3.56"></a><span id="l3.56">       }</span>
<a href="#l3.57"></a><span id="l3.57">       return &quot;RFC822.SIZE &quot; + length;</span>
<a href="#l3.58"></a><span id="l3.58">     } else {</span>
<a href="#l3.59"></a><span id="l3.59">       throw &quot;Unknown item &quot;+query;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

