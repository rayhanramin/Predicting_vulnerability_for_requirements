<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 22040:ac14ca6da23824d04c49339e1dc2f913babdbac5</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ ac14ca6da23824d04c49339e1dc2f913babdbac5" />
<meta property="og:url" content="/comm-central/rev/ac14ca6da23824d04c49339e1dc2f913babdbac5" />
<meta property="og:description" content="Bug 1393692 (part 1) - Convert nsIAtom arguments to strings before checking their value. r=jorgk" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / ac14ca6da23824d04c49339e1dc2f913babdbac5 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/ac14ca6da23824d04c49339e1dc2f913babdbac5">shortlog</a> |
<a href="/comm-central/log/ac14ca6da23824d04c49339e1dc2f913babdbac5">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/ac14ca6da23824d04c49339e1dc2f913babdbac5">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/ac14ca6da23824d04c49339e1dc2f913babdbac5">files</a> |
changeset |
<a href="/comm-central/raw-rev/ac14ca6da23824d04c49339e1dc2f913babdbac5">raw</a>  | <a href="/comm-central/archive/ac14ca6da23824d04c49339e1dc2f913babdbac5.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1393692">Bug 1393692</a> (part 1) - Convert nsIAtom arguments to strings before checking their value. r=jorgk
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#78;&#105;&#99;&#104;&#111;&#108;&#97;&#115;&#32;&#78;&#101;&#116;&#104;&#101;&#114;&#99;&#111;&#116;&#101;&#32;&#60;&#110;&#110;&#101;&#116;&#104;&#101;&#114;&#99;&#111;&#116;&#101;&#64;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 25 Aug 2017 16:35:44 +1000</td></tr>

<tr>
 <td>changeset 22040</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/ac14ca6da23824d04c49339e1dc2f913babdbac5">ac14ca6da23824d04c49339e1dc2f913babdbac5</a></td>
</tr>



<tr>
<td>parent 22039</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/aaf42ebb0c89b2b1e4d95fe8e395fe7b3d0df188">aaf42ebb0c89b2b1e4d95fe8e395fe7b3d0df188</a>
</td>
</tr>

<tr>
<td>child 22041</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/40598e80284974c52925d38b04031c54783e0adc">40598e80284974c52925d38b04031c54783e0adc</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=ac14ca6da23824d04c49339e1dc2f913babdbac5">13454</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Fri, 25 Aug 2017 20:03:46 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@0a3658e44fd7 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0a3658e44fd7209fa6d0f6706ad17bcf920333a7">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0a3658e44fd7209fa6d0f6706ad17bcf920333a7&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0a3658e44fd7209fa6d0f6706ad17bcf920333a7&newProject=comm-central&newRevision=ac14ca6da23824d04c49339e1dc2f913babdbac5&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0a3658e44fd7209fa6d0f6706ad17bcf920333a7&newProject=comm-central&newRevision=ac14ca6da23824d04c49339e1dc2f913babdbac5&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0a3658e44fd7209fa6d0f6706ad17bcf920333a7&newProject=comm-central&newRevision=ac14ca6da23824d04c49339e1dc2f913babdbac5&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28jorgk%29&revcount=50">jorgk</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1393692">1393692</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1393692">Bug 1393692</a> (part 1) - Convert nsIAtom arguments to strings before checking their value. r=jorgk

A number of OnItem*() methods have nsIAtom parameters. Some of these methods
convert those nsIAtoms to strings and then check their value against another
string. Others check their value against an atom obtained from nsIAtomService.

This patch changes the latter methods to be like the former methods, thus
removing numerous uses of nsIAtomService.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ac14ca6da23824d04c49339e1dc2f913babdbac5/mailnews/db/gloda/modules/index_msg.js">mailnews/db/gloda/modules/index_msg.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ac14ca6da23824d04c49339e1dc2f913babdbac5/mailnews/db/gloda/modules/index_msg.js">file</a> |
<a href="/comm-central/annotate/ac14ca6da23824d04c49339e1dc2f913babdbac5/mailnews/db/gloda/modules/index_msg.js">annotate</a> |
<a href="/comm-central/diff/ac14ca6da23824d04c49339e1dc2f913babdbac5/mailnews/db/gloda/modules/index_msg.js">diff</a> |
<a href="/comm-central/comparison/ac14ca6da23824d04c49339e1dc2f913babdbac5/mailnews/db/gloda/modules/index_msg.js">comparison</a> |
<a href="/comm-central/log/ac14ca6da23824d04c49339e1dc2f913babdbac5/mailnews/db/gloda/modules/index_msg.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ac14ca6da23824d04c49339e1dc2f913babdbac5/mailnews/imap/test/unit/test_imapHdrChunking.js">mailnews/imap/test/unit/test_imapHdrChunking.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ac14ca6da23824d04c49339e1dc2f913babdbac5/mailnews/imap/test/unit/test_imapHdrChunking.js">file</a> |
<a href="/comm-central/annotate/ac14ca6da23824d04c49339e1dc2f913babdbac5/mailnews/imap/test/unit/test_imapHdrChunking.js">annotate</a> |
<a href="/comm-central/diff/ac14ca6da23824d04c49339e1dc2f913babdbac5/mailnews/imap/test/unit/test_imapHdrChunking.js">diff</a> |
<a href="/comm-central/comparison/ac14ca6da23824d04c49339e1dc2f913babdbac5/mailnews/imap/test/unit/test_imapHdrChunking.js">comparison</a> |
<a href="/comm-central/log/ac14ca6da23824d04c49339e1dc2f913babdbac5/mailnews/imap/test/unit/test_imapHdrChunking.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ac14ca6da23824d04c49339e1dc2f913babdbac5/mailnews/news/test/unit/test_internalUris.js">mailnews/news/test/unit/test_internalUris.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ac14ca6da23824d04c49339e1dc2f913babdbac5/mailnews/news/test/unit/test_internalUris.js">file</a> |
<a href="/comm-central/annotate/ac14ca6da23824d04c49339e1dc2f913babdbac5/mailnews/news/test/unit/test_internalUris.js">annotate</a> |
<a href="/comm-central/diff/ac14ca6da23824d04c49339e1dc2f913babdbac5/mailnews/news/test/unit/test_internalUris.js">diff</a> |
<a href="/comm-central/comparison/ac14ca6da23824d04c49339e1dc2f913babdbac5/mailnews/news/test/unit/test_internalUris.js">comparison</a> |
<a href="/comm-central/log/ac14ca6da23824d04c49339e1dc2f913babdbac5/mailnews/news/test/unit/test_internalUris.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ac14ca6da23824d04c49339e1dc2f913babdbac5/mailnews/test/resources/mailTestUtils.js">mailnews/test/resources/mailTestUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ac14ca6da23824d04c49339e1dc2f913babdbac5/mailnews/test/resources/mailTestUtils.js">file</a> |
<a href="/comm-central/annotate/ac14ca6da23824d04c49339e1dc2f913babdbac5/mailnews/test/resources/mailTestUtils.js">annotate</a> |
<a href="/comm-central/diff/ac14ca6da23824d04c49339e1dc2f913babdbac5/mailnews/test/resources/mailTestUtils.js">diff</a> |
<a href="/comm-central/comparison/ac14ca6da23824d04c49339e1dc2f913babdbac5/mailnews/test/resources/mailTestUtils.js">comparison</a> |
<a href="/comm-central/log/ac14ca6da23824d04c49339e1dc2f913babdbac5/mailnews/test/resources/mailTestUtils.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/db/gloda/modules/index_msg.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/db/gloda/modules/index_msg.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -32,20 +32,16 @@ Cu.import(&quot;resource:///modules/gloda/dat</span>
<a href="#l1.4"></a><span id="l1.4"> Cu.import(&quot;resource:///modules/gloda/gloda.js&quot;);</span>
<a href="#l1.5"></a><span id="l1.5"> Cu.import(&quot;resource:///modules/gloda/collection.js&quot;);</span>
<a href="#l1.6"></a><span id="l1.6"> Cu.import(&quot;resource:///modules/gloda/connotent.js&quot;);</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> Cu.import(&quot;resource:///modules/gloda/indexer.js&quot;);</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10"> Cu.import(&quot;resource:///modules/gloda/mimemsg.js&quot;);</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-XPCOMUtils.defineLazyServiceGetter(this, &quot;atomService&quot;,</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-                                   &quot;@mozilla.org/atom-service;1&quot;,</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-                                   &quot;nsIAtomService&quot;);</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-</span>
<a href="#l1.16"></a><span id="l1.16"> // Components.results does not have mailnews error codes!</span>
<a href="#l1.17"></a><span id="l1.17"> var NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE = 0x80550005;</span>
<a href="#l1.18"></a><span id="l1.18"> </span>
<a href="#l1.19"></a><span id="l1.19"> var GLODA_MESSAGE_ID_PROPERTY = &quot;gloda-id&quot;;</span>
<a href="#l1.20"></a><span id="l1.20"> /**</span>
<a href="#l1.21"></a><span id="l1.21">  * Message header property to track dirty status; one of</span>
<a href="#l1.22"></a><span id="l1.22">  *  |GlodaIndexer.kMessageClean|, |GlodaIndexer.kMessageDirty|,</span>
<a href="#l1.23"></a><span id="l1.23">  *  |GlodaIndexer.kMessageFilthy|.</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineat">@@ -2764,54 +2760,31 @@ var GlodaMsgIndexer = {</span>
<a href="#l1.25"></a><span id="l1.25">    */</span>
<a href="#l1.26"></a><span id="l1.26">   _folderListener: {</span>
<a href="#l1.27"></a><span id="l1.27">     indexer: null,</span>
<a href="#l1.28"></a><span id="l1.28"> </span>
<a href="#l1.29"></a><span id="l1.29">     _init: function gloda_indexer_fl_init(aIndexer) {</span>
<a href="#l1.30"></a><span id="l1.30">       this.indexer = aIndexer;</span>
<a href="#l1.31"></a><span id="l1.31">     },</span>
<a href="#l1.32"></a><span id="l1.32"> </span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-    // We explicitly know about these things rather than bothering with some</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-    // form of registration scheme because these aren't going to change much.</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">-    get _kFolderLoadedAtom() {</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineminus">-      delete this._kFolderLoadedAtom;</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-      return this._kFolderLoadedAtom = atomService.getAtom(&quot;FolderLoaded&quot;);</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-    },</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-    get _kKeywordsAtom() {</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineminus">-      delete this._kKeywordsAtom;</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineminus">-      return this._kKeywordsAtom = atomService.getAtom(&quot;Keywords&quot;);</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">-    },</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">-    get _kStatusAtom() {</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineminus">-      delete this._kStatusAtom;</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineminus">-      return this._kStatusAtom = atomService.getAtom(&quot;Status&quot;);</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">-    },</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineminus">-    get _kFlaggedAtom() {</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineminus">-      delete this._kFlaggedAtom;</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineminus">-      return this._kFlaggedAtom = atomService.getAtom(&quot;Flagged&quot;);</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-    },</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineminus">-    get _kFolderFlagAtom() {</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-      delete this._kFolderFlagAtom;</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineminus">-      return this._kFolderFlagAtom = atomService.getAtom(&quot;FolderFlag&quot;);</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineminus">-    },</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineminus">-</span>
<a href="#l1.56"></a><span id="l1.56">     OnItemAdded: function gloda_indexer_OnItemAdded(aParentItem, aItem) {</span>
<a href="#l1.57"></a><span id="l1.57">     },</span>
<a href="#l1.58"></a><span id="l1.58">     OnItemRemoved: function gloda_indexer_OnItemRemoved(aParentItem, aItem) {</span>
<a href="#l1.59"></a><span id="l1.59">     },</span>
<a href="#l1.60"></a><span id="l1.60">     OnItemPropertyChanged: function gloda_indexer_OnItemPropertyChanged(</span>
<a href="#l1.61"></a><span id="l1.61">                              aItem, aProperty, aOldValue, aNewValue) {</span>
<a href="#l1.62"></a><span id="l1.62">     },</span>
<a href="#l1.63"></a><span id="l1.63">     /**</span>
<a href="#l1.64"></a><span id="l1.64">      * Detect changes to folder flags and reset our indexing priority.  This</span>
<a href="#l1.65"></a><span id="l1.65">      * is important because (all?) folders start out without any flags and</span>
<a href="#l1.66"></a><span id="l1.66">      * then get their flags added to them.</span>
<a href="#l1.67"></a><span id="l1.67">      */</span>
<a href="#l1.68"></a><span id="l1.68">     OnItemIntPropertyChanged: function gloda_indexer_OnItemIntPropertyChanged(</span>
<a href="#l1.69"></a><span id="l1.69">                                 aFolderItem, aProperty, aOldValue, aNewValue) {</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineminus">-      if (aProperty !== this._kFolderFlagAtom)</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineplus">+      if (aProperty.toString() !== &quot;FolderFlag&quot;)</span>
<a href="#l1.72"></a><span id="l1.72">         return;</span>
<a href="#l1.73"></a><span id="l1.73">       if (!GlodaMsgIndexer.shouldIndexFolder(aFolderItem))</span>
<a href="#l1.74"></a><span id="l1.74">         return;</span>
<a href="#l1.75"></a><span id="l1.75">       // Only reset priority if folder Special Use changes.</span>
<a href="#l1.76"></a><span id="l1.76">       if ((aOldValue &amp; Ci.nsMsgFolderFlags.SpecialUse) ==</span>
<a href="#l1.77"></a><span id="l1.77">           (aNewValue &amp; Ci.nsMsgFolderFlags.SpecialUse))</span>
<a href="#l1.78"></a><span id="l1.78">         return;</span>
<a href="#l1.79"></a><span id="l1.79">       GlodaMsgIndexer.resetFolderIndexingPriority(aFolderItem);</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineat">@@ -2825,34 +2798,35 @@ var GlodaMsgIndexer = {</span>
<a href="#l1.81"></a><span id="l1.81"> </span>
<a href="#l1.82"></a><span id="l1.82">     },</span>
<a href="#l1.83"></a><span id="l1.83">     /**</span>
<a href="#l1.84"></a><span id="l1.84">      * Notice when user activity adds/removes tags or changes a message's</span>
<a href="#l1.85"></a><span id="l1.85">      *  status.</span>
<a href="#l1.86"></a><span id="l1.86">      */</span>
<a href="#l1.87"></a><span id="l1.87">     OnItemPropertyFlagChanged: function gloda_indexer_OnItemPropertyFlagChanged(</span>
<a href="#l1.88"></a><span id="l1.88">                                 aMsgHdr, aProperty, aOldValue, aNewValue) {</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineminus">-      if (aProperty == this._kKeywordsAtom ||</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineplus">+      let propertyString = aProperty.toString();</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineplus">+      if (propertyString == &quot;Keywords&quot; ||</span>
<a href="#l1.92"></a><span id="l1.92">           // We could care less about the new flag changing.</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineminus">-          (aProperty == this._kStatusAtom &amp;&amp;</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineplus">+          (propertyString == &quot;Status&quot; &amp;&amp;</span>
<a href="#l1.95"></a><span id="l1.95">            (aOldValue ^ aNewValue) != nsMsgMessageFlags.New &amp;&amp;</span>
<a href="#l1.96"></a><span id="l1.96">            // We do care about IMAP deletion, but msgsDeleted tells us that, so</span>
<a href="#l1.97"></a><span id="l1.97">            //  ignore IMAPDeleted too...</span>
<a href="#l1.98"></a><span id="l1.98">            (aOldValue ^ aNewValue) != nsMsgMessageFlags.IMAPDeleted) ||</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineminus">-          aProperty == this._kFlaggedAtom) {</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineplus">+          propertyString == &quot;Flagged&quot;) {</span>
<a href="#l1.101"></a><span id="l1.101">         GlodaMsgIndexer._reindexChangedMessages([aMsgHdr], true);</span>
<a href="#l1.102"></a><span id="l1.102">       }</span>
<a href="#l1.103"></a><span id="l1.103">     },</span>
<a href="#l1.104"></a><span id="l1.104"> </span>
<a href="#l1.105"></a><span id="l1.105">     /**</span>
<a href="#l1.106"></a><span id="l1.106">      * Get folder loaded notifications for folders that had to do some</span>
<a href="#l1.107"></a><span id="l1.107">      *  (asynchronous) processing before they could be opened.</span>
<a href="#l1.108"></a><span id="l1.108">      */</span>
<a href="#l1.109"></a><span id="l1.109">     OnItemEvent: function gloda_indexer_OnItemEvent(aFolder, aEvent) {</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineminus">-      if (aEvent == this._kFolderLoadedAtom)</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineplus">+      if (aEvent.toString() == &quot;FolderLoaded&quot;)</span>
<a href="#l1.112"></a><span id="l1.112">         this.indexer._onFolderLoaded(aFolder);</span>
<a href="#l1.113"></a><span id="l1.113">     },</span>
<a href="#l1.114"></a><span id="l1.114">   },</span>
<a href="#l1.115"></a><span id="l1.115"> </span>
<a href="#l1.116"></a><span id="l1.116">   /* ***** Rebuilding / Reindexing ***** */</span>
<a href="#l1.117"></a><span id="l1.117">   /**</span>
<a href="#l1.118"></a><span id="l1.118">    * Allow us to invalidate an outstanding folder traversal because the</span>
<a href="#l1.119"></a><span id="l1.119">    *  underlying database is going away.  We use other means for detecting</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapHdrChunking.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapHdrChunking.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -13,31 +13,28 @@ load(&quot;../../../resources/messageGenerato</span>
<a href="#l2.4"></a><span id="l2.4"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l2.5"></a><span id="l2.5"> Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l2.6"></a><span id="l2.6"> // javascript mime emitter functions</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8"> // IMAP pump</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10"> setupIMAPPump();</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-var kBiffStateAtom = Cc[&quot;@mozilla.org/atom-service;1&quot;]</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-                         .getService(Ci.nsIAtomService)</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-                         .getAtom(&quot;BiffState&quot;);</span>
<a href="#l2.15"></a><span id="l2.15"> // Dummy message window so we can say the inbox is open in a window.</span>
<a href="#l2.16"></a><span id="l2.16"> var dummyMsgWindow =</span>
<a href="#l2.17"></a><span id="l2.17"> {</span>
<a href="#l2.18"></a><span id="l2.18">   openFolder : IMAPPump.inbox,</span>
<a href="#l2.19"></a><span id="l2.19">   QueryInterface: XPCOMUtils.generateQI([Ci.nsIMsgWindow,</span>
<a href="#l2.20"></a><span id="l2.20">                                          Ci.nsISupportsWeakReference])</span>
<a href="#l2.21"></a><span id="l2.21"> };</span>
<a href="#l2.22"></a><span id="l2.22"> </span>
<a href="#l2.23"></a><span id="l2.23"> var gFolderListener = {</span>
<a href="#l2.24"></a><span id="l2.24">   _gotNewMailBiff: false,</span>
<a href="#l2.25"></a><span id="l2.25">   OnItemIntPropertyChanged : function(aItem, aProperty, aOldValue, aNewValue) {</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineminus">-    if (aProperty == kBiffStateAtom &amp;&amp;</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+    if (aProperty.toString() == &quot;BiffState&quot; &amp;&amp;</span>
<a href="#l2.28"></a><span id="l2.28">         aNewValue == Ci.nsIMsgFolder.nsMsgBiffState_NewMail) {</span>
<a href="#l2.29"></a><span id="l2.29">       this._gotNewMailBiff = true;</span>
<a href="#l2.30"></a><span id="l2.30">       async_driver();</span>
<a href="#l2.31"></a><span id="l2.31">     }</span>
<a href="#l2.32"></a><span id="l2.32">   }</span>
<a href="#l2.33"></a><span id="l2.33"> };</span>
<a href="#l2.34"></a><span id="l2.34"> </span>
<a href="#l2.35"></a><span id="l2.35"> var tests = [</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/news/test/unit/test_internalUris.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/news/test/unit/test_internalUris.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -53,22 +53,19 @@ function alert(title, text) {}</span>
<a href="#l3.4"></a><span id="l3.4"> function confirmEx(title, text, flags) {  return 0; }</span>
<a href="#l3.5"></a><span id="l3.5"> </span>
<a href="#l3.6"></a><span id="l3.6"> function* test_cancel() {</span>
<a href="#l3.7"></a><span id="l3.7">   // This tests nsMsgNewsFolder::CancelMessage</span>
<a href="#l3.8"></a><span id="l3.8">   let folder = localserver.rootFolder.getChildNamed(&quot;test.filter&quot;);</span>
<a href="#l3.9"></a><span id="l3.9">   let db = folder.msgDatabase;</span>
<a href="#l3.10"></a><span id="l3.10">   let hdr = db.GetMsgHdrForKey(4);</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  let atomService = Cc['@mozilla.org/atom-service;1']</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-                      .getService(Ci.nsIAtomService);</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-  let kDeleteAtom = atomService.getAtom(&quot;DeleteOrMoveMsgCompleted&quot;);</span>
<a href="#l3.15"></a><span id="l3.15">   let folderListener = {</span>
<a href="#l3.16"></a><span id="l3.16">     OnItemEvent: function(aEventFolder, aEvent) {</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-      if (aEvent == kDeleteAtom) {</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+      if (aEvent.toString() == &quot;DeleteOrMoveMsgCompleted&quot;) {</span>
<a href="#l3.19"></a><span id="l3.19">         MailServices.mailSession.RemoveFolderListener(this);</span>
<a href="#l3.20"></a><span id="l3.20">       }</span>
<a href="#l3.21"></a><span id="l3.21">     }</span>
<a href="#l3.22"></a><span id="l3.22">   };</span>
<a href="#l3.23"></a><span id="l3.23">   MailServices.mailSession.AddFolderListener(folderListener, Ci.nsIFolderListener.event);</span>
<a href="#l3.24"></a><span id="l3.24">   folder.QueryInterface(Ci.nsIMsgNewsFolder)</span>
<a href="#l3.25"></a><span id="l3.25">         .cancelMessage(hdr, dummyMsgWindow);</span>
<a href="#l3.26"></a><span id="l3.26">   yield false;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/test/resources/mailTestUtils.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/test/resources/mailTestUtils.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -449,23 +449,19 @@ var mailTestUtils = {</span>
<a href="#l4.4"></a><span id="l4.4">    * @param [aSomeoneElseWillTriggerTheUpdate=false] If this is true, we do not</span>
<a href="#l4.5"></a><span id="l4.5">    *     trigger the updateFolder call and it is assumed someone else is taking</span>
<a href="#l4.6"></a><span id="l4.6">    *     care of that.</span>
<a href="#l4.7"></a><span id="l4.7">    */</span>
<a href="#l4.8"></a><span id="l4.8">   updateFolderAndNotify: function(aFolder, aCallback, aCallbackThis,</span>
<a href="#l4.9"></a><span id="l4.9">       aCallbackArgs, aSomeoneElseWillTriggerTheUpdate) {</span>
<a href="#l4.10"></a><span id="l4.10">     // register for the folder loaded notification ahead of time... even though</span>
<a href="#l4.11"></a><span id="l4.11">     //  we may not need it...</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-    let atomService = Cc[&quot;@mozilla.org/atom-service;1&quot;]</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-                        .getService(Ci.nsIAtomService);</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-    let kFolderLoadedAtom = atomService.getAtom(&quot;FolderLoaded&quot;);</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-</span>
<a href="#l4.16"></a><span id="l4.16">     let folderListener = {</span>
<a href="#l4.17"></a><span id="l4.17">       OnItemEvent: function (aEventFolder, aEvent) {</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineminus">-        if (aEvent == kFolderLoadedAtom &amp;&amp; aFolder.URI == aEventFolder.URI) {</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+        if (aEvent.toString() == &quot;FolderLoaded&quot; &amp;&amp; aFolder.URI == aEventFolder.URI) {</span>
<a href="#l4.20"></a><span id="l4.20">           MailServices.mailSession.RemoveFolderListener(this);</span>
<a href="#l4.21"></a><span id="l4.21">           aCallback.apply(aCallbackThis, aCallbackArgs);</span>
<a href="#l4.22"></a><span id="l4.22">         }</span>
<a href="#l4.23"></a><span id="l4.23">       }</span>
<a href="#l4.24"></a><span id="l4.24">     };</span>
<a href="#l4.25"></a><span id="l4.25"> </span>
<a href="#l4.26"></a><span id="l4.26">     MailServices.mailSession.AddFolderListener(folderListener, Ci.nsIFolderListener.event);</span>
<a href="#l4.27"></a><span id="l4.27"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

