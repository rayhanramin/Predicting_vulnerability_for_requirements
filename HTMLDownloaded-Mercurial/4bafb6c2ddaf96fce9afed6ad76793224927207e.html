<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 21650:4bafb6c2ddaf96fce9afed6ad76793224927207e</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 4bafb6c2ddaf96fce9afed6ad76793224927207e" />
<meta property="og:url" content="/comm-central/rev/4bafb6c2ddaf96fce9afed6ad76793224927207e" />
<meta property="og:description" content="Bug 1347149 - Remove inclusion of calUtils.js and use cal prefix for all calUtils functions. r=MakeMyDay" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 4bafb6c2ddaf96fce9afed6ad76793224927207e 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/4bafb6c2ddaf96fce9afed6ad76793224927207e">shortlog</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/4bafb6c2ddaf96fce9afed6ad76793224927207e">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e">files</a> |
changeset |
<a href="/comm-central/raw-rev/4bafb6c2ddaf96fce9afed6ad76793224927207e">raw</a>  | <a href="/comm-central/archive/4bafb6c2ddaf96fce9afed6ad76793224927207e.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1347149">Bug 1347149</a> - Remove inclusion of calUtils.js and use cal prefix for all calUtils functions. r=MakeMyDay
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#104;&#105;&#108;&#105;&#112;&#112;&#32;&#75;&#101;&#119;&#105;&#115;&#99;&#104;&#32;&#60;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#64;&#107;&#101;&#119;&#105;&#115;&#46;&#99;&#104;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 05 Jun 2017 21:47:01 +0200</td></tr>

<tr>
 <td>changeset 21650</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/4bafb6c2ddaf96fce9afed6ad76793224927207e">4bafb6c2ddaf96fce9afed6ad76793224927207e</a></td>
</tr>



<tr>
<td>parent 21649</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/693678f602cfbdf0ff0f1f3f9214f142816bd61b">693678f602cfbdf0ff0f1f3f9214f142816bd61b</a>
</td>
</tr>

<tr>
<td>child 21651</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/291cefb09dff00a327062580caf17c1830d4a50b">291cefb09dff00a327062580caf17c1830d4a50b</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=4bafb6c2ddaf96fce9afed6ad76793224927207e">13196</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Fri, 09 Jun 2017 15:32:08 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@291cefb09dff [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=291cefb09dff00a327062580caf17c1830d4a50b">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=291cefb09dff00a327062580caf17c1830d4a50b&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=291cefb09dff00a327062580caf17c1830d4a50b&newProject=comm-central&newRevision=316de32a421766cd3481da2915a4ecb90730cb86&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=291cefb09dff00a327062580caf17c1830d4a50b&newProject=comm-central&newRevision=316de32a421766cd3481da2915a4ecb90730cb86&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=291cefb09dff00a327062580caf17c1830d4a50b&newProject=comm-central&newRevision=316de32a421766cd3481da2915a4ecb90730cb86&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28MakeMyDay%29&revcount=50">MakeMyDay</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1347149">1347149</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1347149">Bug 1347149</a> - Remove inclusion of calUtils.js and use cal prefix for all calUtils functions. r=MakeMyDay</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/agenda-listbox.js">calendar/base/content/agenda-listbox.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/agenda-listbox.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/agenda-listbox.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/agenda-listbox.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/agenda-listbox.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/agenda-listbox.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/agenda-listbox.xml">calendar/base/content/agenda-listbox.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/agenda-listbox.xml">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/agenda-listbox.xml">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/agenda-listbox.xml">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/agenda-listbox.xml">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/agenda-listbox.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-base-view.xml">calendar/base/content/calendar-base-view.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-base-view.xml">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-base-view.xml">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-base-view.xml">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-base-view.xml">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-base-view.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-clipboard.js">calendar/base/content/calendar-clipboard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-clipboard.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-clipboard.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-clipboard.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-clipboard.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-clipboard.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-common-sets.js">calendar/base/content/calendar-common-sets.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-common-sets.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-common-sets.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-common-sets.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-common-sets.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-common-sets.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-daypicker.xml">calendar/base/content/calendar-daypicker.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-daypicker.xml">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-daypicker.xml">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-daypicker.xml">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-daypicker.xml">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-daypicker.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-dnd-listener.js">calendar/base/content/calendar-dnd-listener.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-dnd-listener.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-dnd-listener.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-dnd-listener.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-dnd-listener.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-dnd-listener.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-extract.js">calendar/base/content/calendar-extract.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-extract.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-extract.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-extract.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-extract.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-extract.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-invitations-manager.js">calendar/base/content/calendar-invitations-manager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-invitations-manager.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-invitations-manager.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-invitations-manager.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-invitations-manager.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-invitations-manager.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-item-bindings.xml">calendar/base/content/calendar-item-bindings.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-item-bindings.xml">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-item-bindings.xml">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-item-bindings.xml">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-item-bindings.xml">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-item-bindings.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-item-editing.js">calendar/base/content/calendar-item-editing.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-item-editing.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-item-editing.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-item-editing.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-item-editing.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-item-editing.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-management.js">calendar/base/content/calendar-management.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-management.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-management.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-management.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-management.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-management.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-menus.xml">calendar/base/content/calendar-menus.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-menus.xml">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-menus.xml">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-menus.xml">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-menus.xml">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-menus.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-month-view.xml">calendar/base/content/calendar-month-view.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-month-view.xml">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-month-view.xml">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-month-view.xml">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-month-view.xml">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-month-view.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-multiday-view.xml">calendar/base/content/calendar-multiday-view.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-multiday-view.xml">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-multiday-view.xml">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-multiday-view.xml">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-multiday-view.xml">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-multiday-view.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-statusbar.js">calendar/base/content/calendar-statusbar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-statusbar.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-statusbar.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-statusbar.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-statusbar.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-statusbar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-task-editing.js">calendar/base/content/calendar-task-editing.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-task-editing.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-task-editing.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-task-editing.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-task-editing.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-task-editing.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-task-tree.js">calendar/base/content/calendar-task-tree.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-task-tree.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-task-tree.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-task-tree.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-task-tree.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-task-tree.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-task-tree.xml">calendar/base/content/calendar-task-tree.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-task-tree.xml">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-task-tree.xml">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-task-tree.xml">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-task-tree.xml">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-task-tree.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-task-view.js">calendar/base/content/calendar-task-view.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-task-view.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-task-view.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-task-view.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-task-view.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-task-view.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-ui-utils.js">calendar/base/content/calendar-ui-utils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-ui-utils.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-ui-utils.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-ui-utils.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-ui-utils.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-ui-utils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-unifinder.js">calendar/base/content/calendar-unifinder.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-unifinder.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-unifinder.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-unifinder.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-unifinder.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-unifinder.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-view-core.xml">calendar/base/content/calendar-view-core.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-view-core.xml">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-view-core.xml">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-view-core.xml">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-view-core.xml">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-view-core.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-views.js">calendar/base/content/calendar-views.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-views.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-views.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-views.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-views.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-views.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-views.xml">calendar/base/content/calendar-views.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-views.xml">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-views.xml">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-views.xml">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-views.xml">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/calendar-views.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-alarm-dialog.js">calendar/base/content/dialogs/calendar-alarm-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-alarm-dialog.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-alarm-dialog.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-alarm-dialog.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-alarm-dialog.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-alarm-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-alarm-dialog.xul">calendar/base/content/dialogs/calendar-alarm-dialog.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-alarm-dialog.xul">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-alarm-dialog.xul">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-alarm-dialog.xul">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-alarm-dialog.xul">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-alarm-dialog.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-conflicts-dialog.xul">calendar/base/content/dialogs/calendar-conflicts-dialog.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-conflicts-dialog.xul">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-conflicts-dialog.xul">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-conflicts-dialog.xul">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-conflicts-dialog.xul">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-conflicts-dialog.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-creation.js">calendar/base/content/dialogs/calendar-creation.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-creation.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-creation.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-creation.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-creation.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-creation.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-dialog-utils.js">calendar/base/content/dialogs/calendar-dialog-utils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-dialog-utils.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-dialog-utils.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-dialog-utils.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-dialog-utils.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-dialog-utils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">calendar/base/content/dialogs/calendar-event-dialog-attendees.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">calendar/base/content/dialogs/calendar-event-dialog-attendees.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-attendees.xul">calendar/base/content/dialogs/calendar-event-dialog-attendees.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-attendees.xul">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-attendees.xul">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-attendees.xul">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-attendees.xul">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-attendees.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml">calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml">calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">calendar/base/content/dialogs/calendar-event-dialog-recurrence.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-recurrence.xul">calendar/base/content/dialogs/calendar-event-dialog-recurrence.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-recurrence.xul">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-recurrence.xul">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-recurrence.xul">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-recurrence.xul">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-recurrence.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-reminder.js">calendar/base/content/dialogs/calendar-event-dialog-reminder.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-reminder.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-reminder.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-reminder.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-reminder.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-reminder.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-reminder.xul">calendar/base/content/dialogs/calendar-event-dialog-reminder.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-reminder.xul">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-reminder.xul">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-reminder.xul">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-reminder.xul">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-reminder.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-timezone.js">calendar/base/content/dialogs/calendar-event-dialog-timezone.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-timezone.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-timezone.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-timezone.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-timezone.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-timezone.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-timezone.xul">calendar/base/content/dialogs/calendar-event-dialog-timezone.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-timezone.xul">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-timezone.xul">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-timezone.xul">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-timezone.xul">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog-timezone.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog.xul">calendar/base/content/dialogs/calendar-event-dialog.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog.xul">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog.xul">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog.xul">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog.xul">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-event-dialog.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-invitations-dialog.xul">calendar/base/content/dialogs/calendar-invitations-dialog.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-invitations-dialog.xul">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-invitations-dialog.xul">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-invitations-dialog.xul">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-invitations-dialog.xul">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-invitations-dialog.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-invitations-list.xml">calendar/base/content/dialogs/calendar-invitations-list.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-invitations-list.xml">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-invitations-list.xml">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-invitations-list.xml">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-invitations-list.xml">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-invitations-list.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-migration-dialog.js">calendar/base/content/dialogs/calendar-migration-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-migration-dialog.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-migration-dialog.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-migration-dialog.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-migration-dialog.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-migration-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-migration-dialog.xul">calendar/base/content/dialogs/calendar-migration-dialog.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-migration-dialog.xul">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-migration-dialog.xul">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-migration-dialog.xul">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-migration-dialog.xul">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-migration-dialog.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-print-dialog.js">calendar/base/content/dialogs/calendar-print-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-print-dialog.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-print-dialog.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-print-dialog.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-print-dialog.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-print-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-print-dialog.xul">calendar/base/content/dialogs/calendar-print-dialog.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-print-dialog.xul">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-print-dialog.xul">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-print-dialog.xul">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-print-dialog.xul">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-print-dialog.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-properties-dialog.xul">calendar/base/content/dialogs/calendar-properties-dialog.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-properties-dialog.xul">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-properties-dialog.xul">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-properties-dialog.xul">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-properties-dialog.xul">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-properties-dialog.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-subscriptions-dialog.js">calendar/base/content/dialogs/calendar-subscriptions-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-subscriptions-dialog.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-subscriptions-dialog.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-subscriptions-dialog.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-subscriptions-dialog.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-subscriptions-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-subscriptions-dialog.xul">calendar/base/content/dialogs/calendar-subscriptions-dialog.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-subscriptions-dialog.xul">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-subscriptions-dialog.xul">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-subscriptions-dialog.xul">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-subscriptions-dialog.xul">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-subscriptions-dialog.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-summary-dialog.js">calendar/base/content/dialogs/calendar-summary-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-summary-dialog.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-summary-dialog.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-summary-dialog.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-summary-dialog.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-summary-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-summary-dialog.xul">calendar/base/content/dialogs/calendar-summary-dialog.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-summary-dialog.xul">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-summary-dialog.xul">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-summary-dialog.xul">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-summary-dialog.xul">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/dialogs/calendar-summary-dialog.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/import-export.js">calendar/base/content/import-export.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/import-export.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/import-export.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/import-export.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/import-export.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/import-export.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/preferences/categories.js">calendar/base/content/preferences/categories.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/preferences/categories.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/preferences/categories.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/preferences/categories.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/preferences/categories.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/preferences/categories.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/preferences/general.js">calendar/base/content/preferences/general.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/preferences/general.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/preferences/general.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/preferences/general.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/preferences/general.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/preferences/general.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/preferences/general.xul">calendar/base/content/preferences/general.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/preferences/general.xul">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/preferences/general.xul">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/preferences/general.xul">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/preferences/general.xul">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/preferences/general.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/today-pane.xul">calendar/base/content/today-pane.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/today-pane.xul">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/today-pane.xul">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/today-pane.xul">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/today-pane.xul">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/today-pane.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/widgets/calendar-alarm-widget.xml">calendar/base/content/widgets/calendar-alarm-widget.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/widgets/calendar-alarm-widget.xml">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/widgets/calendar-alarm-widget.xml">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/widgets/calendar-alarm-widget.xml">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/widgets/calendar-alarm-widget.xml">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/widgets/calendar-alarm-widget.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/widgets/calendar-list-tree.xml">calendar/base/content/widgets/calendar-list-tree.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/widgets/calendar-list-tree.xml">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/widgets/calendar-list-tree.xml">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/widgets/calendar-list-tree.xml">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/widgets/calendar-list-tree.xml">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/widgets/calendar-list-tree.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/widgets/calendar-widgets.xml">calendar/base/content/widgets/calendar-widgets.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/widgets/calendar-widgets.xml">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/widgets/calendar-widgets.xml">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/widgets/calendar-widgets.xml">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/widgets/calendar-widgets.xml">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/widgets/calendar-widgets.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/widgets/minimonth.xml">calendar/base/content/widgets/minimonth.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/widgets/minimonth.xml">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/widgets/minimonth.xml">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/widgets/minimonth.xml">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/widgets/minimonth.xml">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/content/widgets/minimonth.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/jar.mn">calendar/base/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/jar.mn">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/jar.mn">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/jar.mn">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/jar.mn">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/modules/calProviderUtils.jsm">calendar/base/modules/calProviderUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/modules/calProviderUtils.jsm">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/modules/calProviderUtils.jsm">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/modules/calProviderUtils.jsm">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/modules/calProviderUtils.jsm">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/modules/calProviderUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/modules/calUtils.jsm">calendar/base/modules/calUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/modules/calUtils.jsm">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/modules/calUtils.jsm">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/modules/calUtils.jsm">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/modules/calUtils.jsm">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/modules/calUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calAlarm.js">calendar/base/src/calAlarm.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calAlarm.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calAlarm.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calAlarm.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calAlarm.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calAlarm.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calAlarmMonitor.js">calendar/base/src/calAlarmMonitor.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calAlarmMonitor.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calAlarmMonitor.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calAlarmMonitor.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calAlarmMonitor.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calAlarmMonitor.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calAlarmService.js">calendar/base/src/calAlarmService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calAlarmService.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calAlarmService.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calAlarmService.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calAlarmService.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calAlarmService.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calAttachment.js">calendar/base/src/calAttachment.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calAttachment.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calAttachment.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calAttachment.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calAttachment.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calAttachment.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calAttendee.js">calendar/base/src/calAttendee.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calAttendee.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calAttendee.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calAttendee.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calAttendee.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calAttendee.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calCachedCalendar.js">calendar/base/src/calCachedCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calCachedCalendar.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calCachedCalendar.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calCachedCalendar.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calCachedCalendar.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calCachedCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calCalendarManager.js">calendar/base/src/calCalendarManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calCalendarManager.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calCalendarManager.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calCalendarManager.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calCalendarManager.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calCalendarManager.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calCalendarSearchService.js">calendar/base/src/calCalendarSearchService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calCalendarSearchService.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calCalendarSearchService.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calCalendarSearchService.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calCalendarSearchService.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calCalendarSearchService.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calDateTimeFormatter.js">calendar/base/src/calDateTimeFormatter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calDateTimeFormatter.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calDateTimeFormatter.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calDateTimeFormatter.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calDateTimeFormatter.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calDateTimeFormatter.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calEvent.js">calendar/base/src/calEvent.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calEvent.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calEvent.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calEvent.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calEvent.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calEvent.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calFilter.js">calendar/base/src/calFilter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calFilter.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calFilter.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calFilter.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calFilter.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calFilter.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calFreeBusyService.js">calendar/base/src/calFreeBusyService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calFreeBusyService.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calFreeBusyService.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calFreeBusyService.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calFreeBusyService.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calFreeBusyService.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calIcsParser.js">calendar/base/src/calIcsParser.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calIcsParser.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calIcsParser.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calIcsParser.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calIcsParser.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calIcsParser.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calIcsSerializer.js">calendar/base/src/calIcsSerializer.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calIcsSerializer.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calIcsSerializer.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calIcsSerializer.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calIcsSerializer.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calIcsSerializer.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calItemBase.js">calendar/base/src/calItemBase.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calItemBase.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calItemBase.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calItemBase.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calItemBase.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calItemBase.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calItemModule.js">calendar/base/src/calItemModule.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calItemModule.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calItemModule.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calItemModule.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calItemModule.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calItemModule.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calRecurrenceInfo.js">calendar/base/src/calRecurrenceInfo.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calRecurrenceInfo.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calRecurrenceInfo.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calRecurrenceInfo.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calRecurrenceInfo.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calRecurrenceInfo.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calRelation.js">calendar/base/src/calRelation.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calRelation.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calRelation.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calRelation.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calRelation.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calRelation.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calTodo.js">calendar/base/src/calTodo.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calTodo.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calTodo.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calTodo.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calTodo.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calTodo.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calTransactionManager.js">calendar/base/src/calTransactionManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calTransactionManager.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calTransactionManager.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calTransactionManager.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calTransactionManager.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calTransactionManager.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calUtils.js">calendar/base/src/calUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calUtils.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calUtils.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calUtils.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calUtils.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/base/src/calUtils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/html-item-editing/lightning-item-iframe.html">calendar/lightning/content/html-item-editing/lightning-item-iframe.html</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/html-item-editing/lightning-item-iframe.html">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/html-item-editing/lightning-item-iframe.html">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/html-item-editing/lightning-item-iframe.html">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/html-item-editing/lightning-item-iframe.html">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/html-item-editing/lightning-item-iframe.html">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/imip-bar-overlay.xul">calendar/lightning/content/imip-bar-overlay.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/imip-bar-overlay.xul">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/imip-bar-overlay.xul">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/imip-bar-overlay.xul">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/imip-bar-overlay.xul">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/imip-bar-overlay.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/lightning-item-iframe.js">calendar/lightning/content/lightning-item-iframe.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/lightning-item-iframe.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/lightning-item-iframe.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/lightning-item-iframe.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/lightning-item-iframe.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/lightning-item-iframe.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/lightning-item-iframe.xul">calendar/lightning/content/lightning-item-iframe.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/lightning-item-iframe.xul">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/lightning-item-iframe.xul">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/lightning-item-iframe.xul">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/lightning-item-iframe.xul">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/lightning-item-iframe.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/messenger-overlay-accountCentral.xul">calendar/lightning/content/messenger-overlay-accountCentral.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/messenger-overlay-accountCentral.xul">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/messenger-overlay-accountCentral.xul">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/messenger-overlay-accountCentral.xul">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/messenger-overlay-accountCentral.xul">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/messenger-overlay-accountCentral.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/messenger-overlay-preferences.xul">calendar/lightning/content/messenger-overlay-preferences.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/messenger-overlay-preferences.xul">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/messenger-overlay-preferences.xul">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/messenger-overlay-preferences.xul">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/messenger-overlay-preferences.xul">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/messenger-overlay-preferences.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/messenger-overlay-sidebar.js">calendar/lightning/content/messenger-overlay-sidebar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/messenger-overlay-sidebar.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/messenger-overlay-sidebar.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/messenger-overlay-sidebar.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/messenger-overlay-sidebar.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/messenger-overlay-sidebar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/messenger-overlay-sidebar.xul">calendar/lightning/content/messenger-overlay-sidebar.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/messenger-overlay-sidebar.xul">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/messenger-overlay-sidebar.xul">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/messenger-overlay-sidebar.xul">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/messenger-overlay-sidebar.xul">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/messenger-overlay-sidebar.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/suite-overlay-preferences.xul">calendar/lightning/content/suite-overlay-preferences.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/suite-overlay-preferences.xul">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/suite-overlay-preferences.xul">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/suite-overlay-preferences.xul">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/suite-overlay-preferences.xul">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/lightning/content/suite-overlay-preferences.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/caldav/calDavCalendar.js">calendar/providers/caldav/calDavCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/caldav/calDavCalendar.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/caldav/calDavCalendar.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/caldav/calDavCalendar.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/caldav/calDavCalendar.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/caldav/calDavCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/gdata/content/gdata-migration-wizard.xul">calendar/providers/gdata/content/gdata-migration-wizard.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/gdata/content/gdata-migration-wizard.xul">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/gdata/content/gdata-migration-wizard.xul">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/gdata/content/gdata-migration-wizard.xul">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/gdata/content/gdata-migration-wizard.xul">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/gdata/content/gdata-migration-wizard.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/gdata/content/gdata-migration.js">calendar/providers/gdata/content/gdata-migration.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/gdata/content/gdata-migration.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/gdata/content/gdata-migration.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/gdata/content/gdata-migration.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/gdata/content/gdata-migration.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/gdata/content/gdata-migration.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/ics/calICSCalendar.js">calendar/providers/ics/calICSCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/ics/calICSCalendar.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/ics/calICSCalendar.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/ics/calICSCalendar.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/ics/calICSCalendar.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/ics/calICSCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/storage/calStorageCalendar.js">calendar/providers/storage/calStorageCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/storage/calStorageCalendar.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/storage/calStorageCalendar.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/storage/calStorageCalendar.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/storage/calStorageCalendar.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/storage/calStorageCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/wcap/calWcapCalendarItems.js">calendar/providers/wcap/calWcapCalendarItems.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/wcap/calWcapCalendarItems.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/wcap/calWcapCalendarItems.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/wcap/calWcapCalendarItems.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/wcap/calWcapCalendarItems.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/wcap/calWcapCalendarItems.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/wcap/calWcapCalendarModule.js">calendar/providers/wcap/calWcapCalendarModule.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/wcap/calWcapCalendarModule.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/wcap/calWcapCalendarModule.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/wcap/calWcapCalendarModule.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/wcap/calWcapCalendarModule.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/wcap/calWcapCalendarModule.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/wcap/calWcapErrors.js">calendar/providers/wcap/calWcapErrors.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/wcap/calWcapErrors.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/wcap/calWcapErrors.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/wcap/calWcapErrors.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/wcap/calWcapErrors.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/wcap/calWcapErrors.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/wcap/calWcapRequest.js">calendar/providers/wcap/calWcapRequest.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/wcap/calWcapRequest.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/wcap/calWcapRequest.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/wcap/calWcapRequest.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/wcap/calWcapRequest.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/wcap/calWcapRequest.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/wcap/calWcapSession.js">calendar/providers/wcap/calWcapSession.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/wcap/calWcapSession.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/wcap/calWcapSession.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/wcap/calWcapSession.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/wcap/calWcapSession.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/wcap/calWcapSession.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/wcap/calWcapUtils.js">calendar/providers/wcap/calWcapUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/wcap/calWcapUtils.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/wcap/calWcapUtils.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/wcap/calWcapUtils.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/wcap/calWcapUtils.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/providers/wcap/calWcapUtils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/resources/content/calendarCreation.js">calendar/resources/content/calendarCreation.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/resources/content/calendarCreation.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/resources/content/calendarCreation.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/resources/content/calendarCreation.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/resources/content/calendarCreation.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/resources/content/calendarCreation.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/resources/content/calendarCreation.xul">calendar/resources/content/calendarCreation.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/resources/content/calendarCreation.xul">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/resources/content/calendarCreation.xul">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/resources/content/calendarCreation.xul">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/resources/content/calendarCreation.xul">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/resources/content/calendarCreation.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/resources/content/datetimepickers/datetimepickers.xml">calendar/resources/content/datetimepickers/datetimepickers.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/resources/content/datetimepickers/datetimepickers.xml">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/resources/content/datetimepickers/datetimepickers.xml">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/resources/content/datetimepickers/datetimepickers.xml">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/resources/content/datetimepickers/datetimepickers.xml">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/resources/content/datetimepickers/datetimepickers.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/resources/content/mouseoverPreviews.js">calendar/resources/content/mouseoverPreviews.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/resources/content/mouseoverPreviews.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/resources/content/mouseoverPreviews.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/resources/content/mouseoverPreviews.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/resources/content/mouseoverPreviews.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/resources/content/mouseoverPreviews.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/resources/content/publish.js">calendar/resources/content/publish.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/resources/content/publish.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/resources/content/publish.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/resources/content/publish.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/resources/content/publish.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/resources/content/publish.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/resources/content/publishDialog.xul">calendar/resources/content/publishDialog.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/resources/content/publishDialog.xul">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/resources/content/publishDialog.xul">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/resources/content/publishDialog.xul">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/resources/content/publishDialog.xul">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/resources/content/publishDialog.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/mozmill/shared-modules/test-calendar-utils.js">calendar/test/mozmill/shared-modules/test-calendar-utils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/mozmill/shared-modules/test-calendar-utils.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/mozmill/shared-modules/test-calendar-utils.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/mozmill/shared-modules/test-calendar-utils.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/mozmill/shared-modules/test-calendar-utils.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/mozmill/shared-modules/test-calendar-utils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/head_consts.js">calendar/test/unit/head_consts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/head_consts.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/head_consts.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/head_consts.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/head_consts.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/head_consts.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/test_alarm.js">calendar/test/unit/test_alarm.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/test_alarm.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/test_alarm.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/test_alarm.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/test_alarm.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/test_alarm.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/test_attachment.js">calendar/test/unit/test_attachment.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/test_attachment.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/test_attachment.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/test_attachment.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/test_attachment.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/test_attachment.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/test_bug486186.js">calendar/test/unit/test_bug486186.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/test_bug486186.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/test_bug486186.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/test_bug486186.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/test_bug486186.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/test_bug486186.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/test_freebusy_service.js">calendar/test/unit/test_freebusy_service.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/test_freebusy_service.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/test_freebusy_service.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/test_freebusy_service.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/test_freebusy_service.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/test_freebusy_service.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/test_ltninvitationutils.js">calendar/test/unit/test_ltninvitationutils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/test_ltninvitationutils.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/test_ltninvitationutils.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/test_ltninvitationutils.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/test_ltninvitationutils.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/test_ltninvitationutils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/test_recur.js">calendar/test/unit/test_recur.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/test_recur.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/test_recur.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/test_recur.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/test_recur.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/test_recur.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/test_utils.js">calendar/test/unit/test_utils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/test_utils.js">file</a> |
<a href="/comm-central/annotate/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/test_utils.js">annotate</a> |
<a href="/comm-central/diff/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/test_utils.js">diff</a> |
<a href="/comm-central/comparison/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/test_utils.js">comparison</a> |
<a href="/comm-central/log/4bafb6c2ddaf96fce9afed6ad76793224927207e/calendar/test/unit/test_utils.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/content/agenda-listbox.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/content/agenda-listbox.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -110,17 +110,17 @@ agendaListbox.removePeriodListItem = fun</span>
<a href="#l1.4"></a><span id="l1.4"> /**</span>
<a href="#l1.5"></a><span id="l1.5">  * Handler function called when changing the checkbox state on period items.</span>
<a href="#l1.6"></a><span id="l1.6">  *</span>
<a href="#l1.7"></a><span id="l1.7">  * @param event     The DOM event that triggered the checkbox state change.</span>
<a href="#l1.8"></a><span id="l1.8">  */</span>
<a href="#l1.9"></a><span id="l1.9"> agendaListbox.onCheckboxChange = function(event) {</span>
<a href="#l1.10"></a><span id="l1.10">     let periodCheckbox = event.target;</span>
<a href="#l1.11"></a><span id="l1.11">     let lopen = (periodCheckbox.getAttribute(&quot;checked&quot;) == &quot;true&quot;);</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    let listItem = getParentNodeOrThis(periodCheckbox, &quot;agenda-checkbox-richlist-item&quot;);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+    let listItem = cal.getParentNodeOrThis(periodCheckbox, &quot;agenda-checkbox-richlist-item&quot;);</span>
<a href="#l1.14"></a><span id="l1.14">     let period = listItem.getItem();</span>
<a href="#l1.15"></a><span id="l1.15">     period.open = lopen;</span>
<a href="#l1.16"></a><span id="l1.16">     // as the agenda-checkboxes are only transient we have to set the &quot;checked&quot;</span>
<a href="#l1.17"></a><span id="l1.17">     // attribute at their hidden origins to make that attribute persistent.</span>
<a href="#l1.18"></a><span id="l1.18">     document.getElementById(listItem.id + &quot;-hidden&quot;).setAttribute(&quot;checked&quot;,</span>
<a href="#l1.19"></a><span id="l1.19">                             periodCheckbox.getAttribute(&quot;checked&quot;));</span>
<a href="#l1.20"></a><span id="l1.20">     if (lopen) {</span>
<a href="#l1.21"></a><span id="l1.21">         agendaListbox.refreshCalendarQuery(period.start, period.end);</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -216,17 +216,17 @@ agendaListbox.editSelectedItem = functio</span>
<a href="#l1.23"></a><span id="l1.23">  * item occurrs tomorrow.</span>
<a href="#l1.24"></a><span id="l1.24">  *</span>
<a href="#l1.25"></a><span id="l1.25">  * @param aItem     The item to find the period for.</span>
<a href="#l1.26"></a><span id="l1.26">  */</span>
<a href="#l1.27"></a><span id="l1.27"> agendaListbox.findPeriodsForItem = function(aItem) {</span>
<a href="#l1.28"></a><span id="l1.28">     let retPeriods = [];</span>
<a href="#l1.29"></a><span id="l1.29">     for (let i = 0; i &lt; this.periods.length; i++) {</span>
<a href="#l1.30"></a><span id="l1.30">         if (this.periods[i].open) {</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-            if (checkIfInRange(aItem, this.periods[i].start, this.periods[i].end)) {</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+            if (cal.checkIfInRange(aItem, this.periods[i].start, this.periods[i].end)) {</span>
<a href="#l1.33"></a><span id="l1.33">                 retPeriods.push(this.periods[i]);</span>
<a href="#l1.34"></a><span id="l1.34">             }</span>
<a href="#l1.35"></a><span id="l1.35">         }</span>
<a href="#l1.36"></a><span id="l1.36">     }</span>
<a href="#l1.37"></a><span id="l1.37">     return retPeriods;</span>
<a href="#l1.38"></a><span id="l1.38"> };</span>
<a href="#l1.39"></a><span id="l1.39"> </span>
<a href="#l1.40"></a><span id="l1.40"> /**</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineat">@@ -289,17 +289,17 @@ agendaListbox.addItemBefore = function(a</span>
<a href="#l1.42"></a><span id="l1.42"> /**</span>
<a href="#l1.43"></a><span id="l1.43">  * Adds an item to the agenda listbox. This function finds the correct period</span>
<a href="#l1.44"></a><span id="l1.44">  * for the item and inserts it correctly so the period stays sorted.</span>
<a href="#l1.45"></a><span id="l1.45">  *</span>
<a href="#l1.46"></a><span id="l1.46">  * @param aItem         The calIItemBase to add.</span>
<a href="#l1.47"></a><span id="l1.47">  * @return              The newly created XUL element.</span>
<a href="#l1.48"></a><span id="l1.48">  */</span>
<a href="#l1.49"></a><span id="l1.49"> agendaListbox.addItem = function(aItem) {</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-    if (!isEvent(aItem)) {</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+    if (!cal.isEvent(aItem)) {</span>
<a href="#l1.52"></a><span id="l1.52">         return null;</span>
<a href="#l1.53"></a><span id="l1.53">     }</span>
<a href="#l1.54"></a><span id="l1.54">     let periods = this.findPeriodsForItem(aItem);</span>
<a href="#l1.55"></a><span id="l1.55">     if (periods.length == 0) {</span>
<a href="#l1.56"></a><span id="l1.56">         return null;</span>
<a href="#l1.57"></a><span id="l1.57">     }</span>
<a href="#l1.58"></a><span id="l1.58">     let newlistItem = null;</span>
<a href="#l1.59"></a><span id="l1.59">     for (let i = 0; i &lt; periods.length; i++) {</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineat">@@ -510,17 +510,17 @@ agendaListbox.deleteItemsFromCalendar = </span>
<a href="#l1.61"></a><span id="l1.61">  * matches</span>
<a href="#l1.62"></a><span id="l1.62">  *</span>
<a href="#l1.63"></a><span id="l1.63">  * @param aItem         The item to compare.</span>
<a href="#l1.64"></a><span id="l1.64">  * @param aCompItem     The item to compare with.</span>
<a href="#l1.65"></a><span id="l1.65">  * @return              True, if the items match with the above noted criteria.</span>
<a href="#l1.66"></a><span id="l1.66">  */</span>
<a href="#l1.67"></a><span id="l1.67"> agendaListbox.isSameEvent = function(aItem, aCompItem) {</span>
<a href="#l1.68"></a><span id="l1.68">     return aItem.id == aCompItem.id &amp;&amp;</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineminus">-           aItem[calGetStartDateProp(aItem)].compare(aCompItem[calGetStartDateProp(aCompItem)]) == 0;</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+           aItem[cal.calGetStartDateProp(aItem)].compare(aCompItem[cal.calGetStartDateProp(aCompItem)]) == 0;</span>
<a href="#l1.71"></a><span id="l1.71"> };</span>
<a href="#l1.72"></a><span id="l1.72"> </span>
<a href="#l1.73"></a><span id="l1.73"> /**</span>
<a href="#l1.74"></a><span id="l1.74">  * Checks if the currently selected node in the listbox is an Event item (not a</span>
<a href="#l1.75"></a><span id="l1.75">  * period item).</span>
<a href="#l1.76"></a><span id="l1.76">  *</span>
<a href="#l1.77"></a><span id="l1.77">  * @return              True, if the node is not a period item.</span>
<a href="#l1.78"></a><span id="l1.78">  */</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineat">@@ -702,33 +702,33 @@ agendaListbox.setupCalendar = function()</span>
<a href="#l1.80"></a><span id="l1.80">  * Usually called at midnight to update the agenda pane. Also retrieves the</span>
<a href="#l1.81"></a><span id="l1.81">  * items from the calendar.</span>
<a href="#l1.82"></a><span id="l1.82">  *</span>
<a href="#l1.83"></a><span id="l1.83">  * @see #refreshCalendarQuery</span>
<a href="#l1.84"></a><span id="l1.84">  * @param newDate       The first date to show if the agenda pane doesn't show</span>
<a href="#l1.85"></a><span id="l1.85">  *                        today.</span>
<a href="#l1.86"></a><span id="l1.86">  */</span>
<a href="#l1.87"></a><span id="l1.87"> agendaListbox.refreshPeriodDates = function(newDate) {</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineminus">-    this.kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineplus">+    this.kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l1.90"></a><span id="l1.90">     // Today: now until midnight of tonight</span>
<a href="#l1.91"></a><span id="l1.91">     let oldshowstoday = this.showstoday;</span>
<a href="#l1.92"></a><span id="l1.92">     this.showstoday = this.showsToday(newDate);</span>
<a href="#l1.93"></a><span id="l1.93">     if ((this.showstoday) &amp;&amp; (!oldshowstoday)) {</span>
<a href="#l1.94"></a><span id="l1.94">         this.addPeriodListItem(this.tomorrow, &quot;tomorrow-header&quot;);</span>
<a href="#l1.95"></a><span id="l1.95">         this.addPeriodListItem(this.soon, &quot;nextweek-header&quot;);</span>
<a href="#l1.96"></a><span id="l1.96">     } else if (!this.showstoday) {</span>
<a href="#l1.97"></a><span id="l1.97">         this.removePeriodListItem(this.tomorrow);</span>
<a href="#l1.98"></a><span id="l1.98">         this.removePeriodListItem(this.soon);</span>
<a href="#l1.99"></a><span id="l1.99">     }</span>
<a href="#l1.100"></a><span id="l1.100">     newDate.isDate = true;</span>
<a href="#l1.101"></a><span id="l1.101">     for (let i = 0; i &lt; this.periods.length; i++) {</span>
<a href="#l1.102"></a><span id="l1.102">         let curPeriod = this.periods[i];</span>
<a href="#l1.103"></a><span id="l1.103">         newDate.hour = newDate.minute = newDate.second = 0;</span>
<a href="#l1.104"></a><span id="l1.104">         if (i == 0 &amp;&amp; this.showstoday) {</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineminus">-            curPeriod.start = now();</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineplus">+            curPeriod.start = cal.now();</span>
<a href="#l1.107"></a><span id="l1.107">         } else {</span>
<a href="#l1.108"></a><span id="l1.108">             curPeriod.start = newDate.clone();</span>
<a href="#l1.109"></a><span id="l1.109">         }</span>
<a href="#l1.110"></a><span id="l1.110">         newDate.day += curPeriod.duration;</span>
<a href="#l1.111"></a><span id="l1.111">         curPeriod.end = newDate.clone();</span>
<a href="#l1.112"></a><span id="l1.112">         curPeriod.listItem.setItem(curPeriod, this.showstoday);</span>
<a href="#l1.113"></a><span id="l1.113">     }</span>
<a href="#l1.114"></a><span id="l1.114">     this.refreshCalendarQuery();</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineat">@@ -750,17 +750,17 @@ agendaListbox.addListener = function(aLi</span>
<a href="#l1.116"></a><span id="l1.116">  * @param aStartDate    (optional) The day to check if its &quot;today&quot;.</span>
<a href="#l1.117"></a><span id="l1.117">  * @return              Returns true if today is shown.</span>
<a href="#l1.118"></a><span id="l1.118">  */</span>
<a href="#l1.119"></a><span id="l1.119"> agendaListbox.showsToday = function(aStartDate) {</span>
<a href="#l1.120"></a><span id="l1.120">     let lstart = aStartDate;</span>
<a href="#l1.121"></a><span id="l1.121">     if (!lstart) {</span>
<a href="#l1.122"></a><span id="l1.122">         lstart = this.today.start;</span>
<a href="#l1.123"></a><span id="l1.123">     }</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineminus">-    let lshowsToday = sameDay(now(), lstart);</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineplus">+    let lshowsToday = cal.sameDay(cal.now(), lstart);</span>
<a href="#l1.126"></a><span id="l1.126">     if (lshowsToday) {</span>
<a href="#l1.127"></a><span id="l1.127">         this.periods = [this.today, this.tomorrow, this.soon];</span>
<a href="#l1.128"></a><span id="l1.128">     } else {</span>
<a href="#l1.129"></a><span id="l1.129">         this.periods = [this.today];</span>
<a href="#l1.130"></a><span id="l1.130">     }</span>
<a href="#l1.131"></a><span id="l1.131">     return lshowsToday;</span>
<a href="#l1.132"></a><span id="l1.132"> };</span>
<a href="#l1.133"></a><span id="l1.133"> </span>
<a href="#l1.134"></a><span id="l1.134" class="difflineat">@@ -884,17 +884,17 @@ agendaListbox.calendarObserver.onStartBa</span>
<a href="#l1.135"></a><span id="l1.135"> agendaListbox.calendarObserver.onEndBatch = function() {</span>
<a href="#l1.136"></a><span id="l1.136"> };</span>
<a href="#l1.137"></a><span id="l1.137"> </span>
<a href="#l1.138"></a><span id="l1.138"> agendaListbox.calendarObserver.onLoad = function() {</span>
<a href="#l1.139"></a><span id="l1.139">     this.agendaListbox.refreshCalendarQuery();</span>
<a href="#l1.140"></a><span id="l1.140"> };</span>
<a href="#l1.141"></a><span id="l1.141"> </span>
<a href="#l1.142"></a><span id="l1.142"> agendaListbox.calendarObserver.onAddItem = function(item) {</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineminus">-    if (!isEvent(item)) {</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineplus">+    if (!cal.isEvent(item)) {</span>
<a href="#l1.145"></a><span id="l1.145">         return;</span>
<a href="#l1.146"></a><span id="l1.146">     }</span>
<a href="#l1.147"></a><span id="l1.147">     // get all sub items if it is a recurring item</span>
<a href="#l1.148"></a><span id="l1.148">     let occs = this.getOccurrencesBetween(item);</span>
<a href="#l1.149"></a><span id="l1.149">     occs.forEach(this.agendaListbox.addItem, this.agendaListbox);</span>
<a href="#l1.150"></a><span id="l1.150">     setCurrentEvent();</span>
<a href="#l1.151"></a><span id="l1.151"> };</span>
<a href="#l1.152"></a><span id="l1.152"> </span>
<a href="#l1.153"></a><span id="l1.153" class="difflineat">@@ -908,34 +908,34 @@ agendaListbox.calendarObserver.getOccurr</span>
<a href="#l1.154"></a><span id="l1.154">     return occs;</span>
<a href="#l1.155"></a><span id="l1.155"> };</span>
<a href="#l1.156"></a><span id="l1.156"> </span>
<a href="#l1.157"></a><span id="l1.157"> agendaListbox.calendarObserver.onDeleteItem = function(item, rebuildFlag) {</span>
<a href="#l1.158"></a><span id="l1.158">     this.onLocalDeleteItem(item, true);</span>
<a href="#l1.159"></a><span id="l1.159"> };</span>
<a href="#l1.160"></a><span id="l1.160"> </span>
<a href="#l1.161"></a><span id="l1.161"> agendaListbox.calendarObserver.onLocalDeleteItem = function(item, moveSelection) {</span>
<a href="#l1.162"></a><span id="l1.162" class="difflineminus">-    if (!isEvent(item)) {</span>
<a href="#l1.163"></a><span id="l1.163" class="difflineplus">+    if (!cal.isEvent(item)) {</span>
<a href="#l1.164"></a><span id="l1.164">         return false;</span>
<a href="#l1.165"></a><span id="l1.165">     }</span>
<a href="#l1.166"></a><span id="l1.166">     let selectedItemHashId = -1;</span>
<a href="#l1.167"></a><span id="l1.167">     // get all sub items if it is a recurring item</span>
<a href="#l1.168"></a><span id="l1.168">     let occs = this.getOccurrencesBetween(item);</span>
<a href="#l1.169"></a><span id="l1.169">     for (let i = 0; i &lt; occs.length; i++) {</span>
<a href="#l1.170"></a><span id="l1.170">         let isSelected = this.agendaListbox.deleteItem(occs[i], moveSelection);</span>
<a href="#l1.171"></a><span id="l1.171">         if (isSelected) {</span>
<a href="#l1.172"></a><span id="l1.172">             selectedItemHashId = occs[i].hashId;</span>
<a href="#l1.173"></a><span id="l1.173">         }</span>
<a href="#l1.174"></a><span id="l1.174">     }</span>
<a href="#l1.175"></a><span id="l1.175">     return selectedItemHashId;</span>
<a href="#l1.176"></a><span id="l1.176"> };</span>
<a href="#l1.177"></a><span id="l1.177"> </span>
<a href="#l1.178"></a><span id="l1.178"> agendaListbox.calendarObserver.onModifyItem = function(newItem, oldItem) {</span>
<a href="#l1.179"></a><span id="l1.179">     let selectedItemHashId = this.onLocalDeleteItem(oldItem, false);</span>
<a href="#l1.180"></a><span id="l1.180" class="difflineminus">-    if (!isEvent(newItem)) {</span>
<a href="#l1.181"></a><span id="l1.181" class="difflineplus">+    if (!cal.isEvent(newItem)) {</span>
<a href="#l1.182"></a><span id="l1.182">         return;</span>
<a href="#l1.183"></a><span id="l1.183">     }</span>
<a href="#l1.184"></a><span id="l1.184">     this.onAddItem(newItem);</span>
<a href="#l1.185"></a><span id="l1.185">     if (selectedItemHashId != -1) {</span>
<a href="#l1.186"></a><span id="l1.186">         let listItem = agendaListbox.getListItemByHashId(selectedItemHashId);</span>
<a href="#l1.187"></a><span id="l1.187">         if (listItem) {</span>
<a href="#l1.188"></a><span id="l1.188">             agendaListbox.agendaListboxControl.clearSelection();</span>
<a href="#l1.189"></a><span id="l1.189">             agendaListbox.agendaListboxControl.ensureElementIsVisible(listItem);</span>
<a href="#l1.190"></a><span id="l1.190" class="difflineat">@@ -991,17 +991,17 @@ agendaListbox.calendarObserver.onDefault</span>
<a href="#l1.191"></a><span id="l1.191">  * Updates the &quot;Upcoming&quot; section of today pane when preference soondays changes</span>
<a href="#l1.192"></a><span id="l1.192">  **/</span>
<a href="#l1.193"></a><span id="l1.193"> agendaListbox.updateSoonSection = function() {</span>
<a href="#l1.194"></a><span id="l1.194">     this.soon.duration = this.soonDays;</span>
<a href="#l1.195"></a><span id="l1.195">     this.soon.open = true;</span>
<a href="#l1.196"></a><span id="l1.196">     let soonHeader = document.getElementById(&quot;nextweek-header&quot;);</span>
<a href="#l1.197"></a><span id="l1.197">     if (soonHeader) {</span>
<a href="#l1.198"></a><span id="l1.198">         soonHeader.setItem(this.soon, true);</span>
<a href="#l1.199"></a><span id="l1.199" class="difflineminus">-        agendaListbox.refreshPeriodDates(now());</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineplus">+        agendaListbox.refreshPeriodDates(cal.now());</span>
<a href="#l1.201"></a><span id="l1.201">     }</span>
<a href="#l1.202"></a><span id="l1.202"> };</span>
<a href="#l1.203"></a><span id="l1.203"> </span>
<a href="#l1.204"></a><span id="l1.204"> /**</span>
<a href="#l1.205"></a><span id="l1.205">  * Updates the event considered &quot;current&quot;. This goes through all &quot;today&quot; items</span>
<a href="#l1.206"></a><span id="l1.206">  * and sets the &quot;current&quot; attribute on all list items that are currently</span>
<a href="#l1.207"></a><span id="l1.207">  * occurring.</span>
<a href="#l1.208"></a><span id="l1.208">  *</span>
<a href="#l1.209"></a><span id="l1.209" class="difflineat">@@ -1010,17 +1010,17 @@ agendaListbox.updateSoonSection = functi</span>
<a href="#l1.210"></a><span id="l1.210"> function setCurrentEvent() {</span>
<a href="#l1.211"></a><span id="l1.211">     if (!agendaListbox.showsToday() || !agendaListbox.today.open) {</span>
<a href="#l1.212"></a><span id="l1.212">         return;</span>
<a href="#l1.213"></a><span id="l1.213">     }</span>
<a href="#l1.214"></a><span id="l1.214"> </span>
<a href="#l1.215"></a><span id="l1.215">     let msScheduleTime = -1;</span>
<a href="#l1.216"></a><span id="l1.216">     let complistItem = agendaListbox.tomorrow.listItem.previousSibling;</span>
<a href="#l1.217"></a><span id="l1.217">     let removelist = [];</span>
<a href="#l1.218"></a><span id="l1.218" class="difflineminus">-    let anow = now();</span>
<a href="#l1.219"></a><span id="l1.219" class="difflineplus">+    let anow = cal.now();</span>
<a href="#l1.220"></a><span id="l1.220">     let msuntillend = 0;</span>
<a href="#l1.221"></a><span id="l1.221">     let msuntillstart = 0;</span>
<a href="#l1.222"></a><span id="l1.222">     let leaveloop;</span>
<a href="#l1.223"></a><span id="l1.223">     do {</span>
<a href="#l1.224"></a><span id="l1.224">         leaveloop = !agendaListbox.isEventListItem(complistItem);</span>
<a href="#l1.225"></a><span id="l1.225">         if (!leaveloop) {</span>
<a href="#l1.226"></a><span id="l1.226">             msuntillstart = complistItem.occurrence.startDate</span>
<a href="#l1.227"></a><span id="l1.227">                                         .getInTimezone(agendaListbox.kDefaultTimezone)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/calendar/base/content/agenda-listbox.xml</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/calendar/base/content/agenda-listbox.xml</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -42,16 +42,17 @@</span>
<a href="#l2.4"></a><span id="l2.4">     &lt;content&gt;</span>
<a href="#l2.5"></a><span id="l2.5">       &lt;xul:treenode-checkbox class=&quot;agenda-checkbox&quot; anonid=&quot;agenda-checkbox-widget&quot;</span>
<a href="#l2.6"></a><span id="l2.6">                                                    flex=&quot;1&quot;</span>
<a href="#l2.7"></a><span id="l2.7">                                                    xbl:inherits=&quot;selected,label,hidden,disabled&quot;/&gt;</span>
<a href="#l2.8"></a><span id="l2.8">     &lt;/content&gt;</span>
<a href="#l2.9"></a><span id="l2.9">     &lt;implementation&gt;</span>
<a href="#l2.10"></a><span id="l2.10">       &lt;field name=&quot;kCheckbox&quot;&gt;null&lt;/field&gt;;</span>
<a href="#l2.11"></a><span id="l2.11">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l2.13"></a><span id="l2.13">         this.kCheckbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;agenda-checkbox-widget&quot;);</span>
<a href="#l2.14"></a><span id="l2.14">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l2.15"></a><span id="l2.15"> </span>
<a href="#l2.16"></a><span id="l2.16">       &lt;method name=&quot;getItem&quot;&gt;</span>
<a href="#l2.17"></a><span id="l2.17">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l2.18"></a><span id="l2.18">           return this.mItem;</span>
<a href="#l2.19"></a><span id="l2.19">         ]]&gt;&lt;/body&gt;</span>
<a href="#l2.20"></a><span id="l2.20">       &lt;/method&gt;</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineat">@@ -67,19 +68,19 @@</span>
<a href="#l2.22"></a><span id="l2.22">               if (this.id == &quot;nextweek-header&quot;) {</span>
<a href="#l2.23"></a><span id="l2.23">                   if (duration &gt; 7) {</span>
<a href="#l2.24"></a><span id="l2.24">                       this.kCheckbox.label += &quot; (&quot; + unitPluralForm(duration / 7, &quot;weeks&quot;) + &quot;)&quot;;</span>
<a href="#l2.25"></a><span id="l2.25">                   } else {</span>
<a href="#l2.26"></a><span id="l2.26">                       this.kCheckbox.label += &quot; (&quot; + unitPluralForm(duration, &quot;days&quot;) + &quot;)&quot;;</span>
<a href="#l2.27"></a><span id="l2.27">                   }</span>
<a href="#l2.28"></a><span id="l2.28">               }</span>
<a href="#l2.29"></a><span id="l2.29">           } else if (synthetic.duration == 1) {</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-              this.kCheckbox.label = getDateFormatter().formatDate(synthetic.start);</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+              this.kCheckbox.label = cal.getDateFormatter().formatDate(synthetic.start);</span>
<a href="#l2.32"></a><span id="l2.32">           } else {</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-              this.kCheckbox.label = getDateFormatter().formatInterval(synthetic.start, synthetic.end);</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+              this.kCheckbox.label = cal.getDateFormatter().formatInterval(synthetic.start, synthetic.end);</span>
<a href="#l2.35"></a><span id="l2.35">           }</span>
<a href="#l2.36"></a><span id="l2.36">         ]]&gt;&lt;/body&gt;</span>
<a href="#l2.37"></a><span id="l2.37">       &lt;/method&gt;</span>
<a href="#l2.38"></a><span id="l2.38"> </span>
<a href="#l2.39"></a><span id="l2.39">       &lt;method name=&quot;getCheckbox&quot;&gt;</span>
<a href="#l2.40"></a><span id="l2.40">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l2.41"></a><span id="l2.41">           return this.kCheckbox;</span>
<a href="#l2.42"></a><span id="l2.42">         ]]&gt;&lt;/body&gt;</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineat">@@ -105,33 +106,34 @@</span>
<a href="#l2.44"></a><span id="l2.44">           &lt;/xul:hbox&gt;</span>
<a href="#l2.45"></a><span id="l2.45">         &lt;/xul:vbox&gt;</span>
<a href="#l2.46"></a><span id="l2.46">       &lt;/xul:hbox&gt;</span>
<a href="#l2.47"></a><span id="l2.47">     &lt;/content&gt;</span>
<a href="#l2.48"></a><span id="l2.48">     &lt;implementation&gt;</span>
<a href="#l2.49"></a><span id="l2.49">       &lt;field name=&quot;mAllDayItem&quot;&gt;null&lt;/field&gt;;</span>
<a href="#l2.50"></a><span id="l2.50"> </span>
<a href="#l2.51"></a><span id="l2.51">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l2.53"></a><span id="l2.53">         this.mAllDayItem = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;allday-item&quot;);</span>
<a href="#l2.54"></a><span id="l2.54">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l2.55"></a><span id="l2.55"> </span>
<a href="#l2.56"></a><span id="l2.56">       &lt;method name=&quot;setOccurrence&quot;&gt;</span>
<a href="#l2.57"></a><span id="l2.57">         &lt;parameter name=&quot;aOccurrence&quot;/&gt;</span>
<a href="#l2.58"></a><span id="l2.58">         &lt;parameter name=&quot;aPeriod&quot;/&gt;</span>
<a href="#l2.59"></a><span id="l2.59">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l2.60"></a><span id="l2.60">           this.mOccurrence = aOccurrence;</span>
<a href="#l2.61"></a><span id="l2.61">           this.mAllDayItem.occurrence = aOccurrence;</span>
<a href="#l2.62"></a><span id="l2.62">           let dateFormatter = cal.getDateFormatter();</span>
<a href="#l2.63"></a><span id="l2.63">           let periodStartDate = aPeriod.start.clone();</span>
<a href="#l2.64"></a><span id="l2.64">           periodStartDate.isDate = true;</span>
<a href="#l2.65"></a><span id="l2.65">           let periodEndDate = aPeriod.end;</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineminus">-          let startDate = this.mOccurrence[calGetStartDateProp(this.mOccurrence)]</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineminus">-                              .getInTimezone(calendarDefaultTimezone());</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineminus">-          let endDate = this.mOccurrence[calGetEndDateProp(this.mOccurrence)]</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineminus">-                            .getInTimezone(calendarDefaultTimezone());</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+          let startDate = this.mOccurrence[cal.calGetStartDateProp(this.mOccurrence)]</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+                              .getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+          let endDate = this.mOccurrence[cal.calGetEndDateProp(this.mOccurrence)]</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+                            .getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l2.74"></a><span id="l2.74">           let endPreviousDay = endDate.clone();</span>
<a href="#l2.75"></a><span id="l2.75">           endPreviousDay.day--;</span>
<a href="#l2.76"></a><span id="l2.76">           // Show items's date for long periods but also for &quot;Upcoming&quot;</span>
<a href="#l2.77"></a><span id="l2.77">           // period with one day duration.</span>
<a href="#l2.78"></a><span id="l2.78">           let showDate = aPeriod.multiday || aPeriod.duration &gt; 1;</span>
<a href="#l2.79"></a><span id="l2.79"> </span>
<a href="#l2.80"></a><span id="l2.80">           let date = &quot;&quot;;</span>
<a href="#l2.81"></a><span id="l2.81">           let iconType = &quot;&quot;;</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineat">@@ -198,26 +200,26 @@</span>
<a href="#l2.83"></a><span id="l2.83">     &lt;implementation&gt;</span>
<a href="#l2.84"></a><span id="l2.84">       &lt;method name=&quot;setOccurrence&quot;&gt;</span>
<a href="#l2.85"></a><span id="l2.85">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l2.86"></a><span id="l2.86">         &lt;parameter name=&quot;aPeriod&quot;/&gt;</span>
<a href="#l2.87"></a><span id="l2.87">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l2.88"></a><span id="l2.88">           this.mOccurrence = aItem;</span>
<a href="#l2.89"></a><span id="l2.89">           this.setAttribute(&quot;status&quot;, aItem.status);</span>
<a href="#l2.90"></a><span id="l2.90">           let dateFormatter = Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineminus">-                                .getService(Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineplus">+                                        .getService(Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l2.93"></a><span id="l2.93"> </span>
<a href="#l2.94"></a><span id="l2.94">           let periodStartDate = aPeriod.start.clone();</span>
<a href="#l2.95"></a><span id="l2.95">           periodStartDate.isDate = true;</span>
<a href="#l2.96"></a><span id="l2.96">           let periodEndDate = aPeriod.end.clone();</span>
<a href="#l2.97"></a><span id="l2.97">           periodEndDate.day--;</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineminus">-          let start = this.mOccurrence[calGetStartDateProp(this.mOccurrence)]</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineminus">-                          .getInTimezone(calendarDefaultTimezone());</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineminus">-          let end = this.mOccurrence[calGetEndDateProp(this.mOccurrence)]</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineminus">-                        .getInTimezone(calendarDefaultTimezone());</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineplus">+          let start = this.mOccurrence[cal.calGetStartDateProp(this.mOccurrence)]</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineplus">+                          .getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineplus">+          let end = this.mOccurrence[cal.calGetEndDateProp(this.mOccurrence)]</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineplus">+                        .getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l2.106"></a><span id="l2.106">           let startDate = start.clone();</span>
<a href="#l2.107"></a><span id="l2.107">           startDate.isDate = true;</span>
<a href="#l2.108"></a><span id="l2.108">           let endDate = end.clone();</span>
<a href="#l2.109"></a><span id="l2.109">           endDate.isDate = true;</span>
<a href="#l2.110"></a><span id="l2.110">           let endAtMidnight = (end.hour == 0 &amp;&amp; end.minute == 0);</span>
<a href="#l2.111"></a><span id="l2.111">           if (endAtMidnight) {</span>
<a href="#l2.112"></a><span id="l2.112">               endDate.day--;</span>
<a href="#l2.113"></a><span id="l2.113">           }</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineat">@@ -238,18 +240,18 @@</span>
<a href="#l2.115"></a><span id="l2.115">               duration = longFormat ? dateFormatter.formatDateTime(start)</span>
<a href="#l2.116"></a><span id="l2.116">                                     : dateFormatter.formatTime(start);</span>
<a href="#l2.117"></a><span id="l2.117">           } else if (endDate.compare(periodStartDate) &gt;= 0 &amp;&amp;</span>
<a href="#l2.118"></a><span id="l2.118">                      endDate.compare(periodEndDate) &lt;= 0) {</span>
<a href="#l2.119"></a><span id="l2.119">               // event spanning multiple days, end date within period</span>
<a href="#l2.120"></a><span id="l2.120">               iconType = &quot;end&quot;;</span>
<a href="#l2.121"></a><span id="l2.121">               if (endAtMidnight) {</span>
<a href="#l2.122"></a><span id="l2.122">                   duration = dateFormatter.formatDate(endDate) + &quot; &quot;;</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineminus">-                  duration = longFormat ? duration + calGetString(&quot;dateFormat&quot;, &quot;midnight&quot;)</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineminus">-                                        : calGetString(&quot;dateFormat&quot;, &quot;midnight&quot;);</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineplus">+                  duration = longFormat ? duration + cal.calGetString(&quot;dateFormat&quot;, &quot;midnight&quot;)</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineplus">+                                        : cal.calGetString(&quot;dateFormat&quot;, &quot;midnight&quot;);</span>
<a href="#l2.127"></a><span id="l2.127">               } else {</span>
<a href="#l2.128"></a><span id="l2.128">                   duration = longFormat ? dateFormatter.formatDateTime(end)</span>
<a href="#l2.129"></a><span id="l2.129">                                         : dateFormatter.formatTime(end);</span>
<a href="#l2.130"></a><span id="l2.130">               }</span>
<a href="#l2.131"></a><span id="l2.131">           } else {</span>
<a href="#l2.132"></a><span id="l2.132">               iconType = &quot;continue&quot;;</span>
<a href="#l2.133"></a><span id="l2.133">           }</span>
<a href="#l2.134"></a><span id="l2.134">           let multiDayImage = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;agenda-multiDayEvent-image&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/base/content/calendar-base-view.xml</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/base/content/calendar-base-view.xml</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -238,19 +238,19 @@</span>
<a href="#l3.4"></a><span id="l3.4">                                 .getAttribute(&quot;checked&quot;) == &quot;true&quot;);</span>
<a href="#l3.5"></a><span id="l3.5">         this.tasksInView = (document.getElementById(kTasksInViewCommand)</span>
<a href="#l3.6"></a><span id="l3.6">                                 .getAttribute(&quot;checked&quot;) == &quot;true&quot;);</span>
<a href="#l3.7"></a><span id="l3.7">         this.rotated = (document.getElementById(kOrientation)</span>
<a href="#l3.8"></a><span id="l3.8">                                 .getAttribute(&quot;checked&quot;) == &quot;true&quot;);</span>
<a href="#l3.9"></a><span id="l3.9">         this.showCompleted = (document.getElementById(kShowCompleted)</span>
<a href="#l3.10"></a><span id="l3.10">                                 .getAttribute(&quot;checked&quot;) == &quot;true&quot;);</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-        this.mTimezone = calendarDefaultTimezone();</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+        this.mTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l3.14"></a><span id="l3.14">         let alarmService = Components.classes[&quot;@mozilla.org/calendar/alarm-service;1&quot;]</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-                           .getService(Components.interfaces.calIAlarmService);</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+                                     .getService(Components.interfaces.calIAlarmService);</span>
<a href="#l3.17"></a><span id="l3.17">         alarmService.addObserver(this.mObserver);</span>
<a href="#l3.18"></a><span id="l3.18">         this.setAttribute(&quot;type&quot;, this.type);</span>
<a href="#l3.19"></a><span id="l3.19">         this.mResizeHandler = () =&gt; {</span>
<a href="#l3.20"></a><span id="l3.20">             this.onResize(this);</span>
<a href="#l3.21"></a><span id="l3.21">         };</span>
<a href="#l3.22"></a><span id="l3.22">         this.viewBroadcaster.addEventListener(this.getAttribute(&quot;type&quot;) + &quot;viewresized&quot;, this.mResizeHandler, true);</span>
<a href="#l3.23"></a><span id="l3.23">         // add a preference observer to monitor changes</span>
<a href="#l3.24"></a><span id="l3.24">         Services.prefs.addObserver(&quot;calendar.&quot;, this.mPrefObserver, false);</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineat">@@ -263,17 +263,17 @@</span>
<a href="#l3.26"></a><span id="l3.26"> </span>
<a href="#l3.27"></a><span id="l3.27">       &lt;destructor&gt;&lt;![CDATA[</span>
<a href="#l3.28"></a><span id="l3.28">         Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l3.29"></a><span id="l3.29"> </span>
<a href="#l3.30"></a><span id="l3.30">         if (this.mCalendar) {</span>
<a href="#l3.31"></a><span id="l3.31">             this.mCalendar.removeObserver(this.mObserver);</span>
<a href="#l3.32"></a><span id="l3.32">         }</span>
<a href="#l3.33"></a><span id="l3.33">         let alarmService = Components.classes[&quot;@mozilla.org/calendar/alarm-service;1&quot;]</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-                           .getService(Components.interfaces.calIAlarmService);</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+                                     .getService(Components.interfaces.calIAlarmService);</span>
<a href="#l3.36"></a><span id="l3.36">         alarmService.removeObserver(this.mObserver);</span>
<a href="#l3.37"></a><span id="l3.37">         this.viewBroadcaster.removeEventListener(this.getAttribute(&quot;type&quot;) + &quot;viewresized&quot;, this.mResizeHandler, true);</span>
<a href="#l3.38"></a><span id="l3.38">         Services.prefs.removeObserver(&quot;calendar.&quot;, this.mPrefObserver);</span>
<a href="#l3.39"></a><span id="l3.39">       ]]&gt;&lt;/destructor&gt;</span>
<a href="#l3.40"></a><span id="l3.40"> </span>
<a href="#l3.41"></a><span id="l3.41">       &lt;property name=&quot;type&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l3.42"></a><span id="l3.42">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l3.43"></a><span id="l3.43">             let typelist = this.id.split(&quot;-&quot;);</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineat">@@ -380,17 +380,17 @@</span>
<a href="#l3.45"></a><span id="l3.45">         &lt;parameter name=&quot;aDate&quot;/&gt;</span>
<a href="#l3.46"></a><span id="l3.46">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l3.47"></a><span id="l3.47">           this.showDate(aDate);</span>
<a href="#l3.48"></a><span id="l3.48">         ]]&gt;&lt;/body&gt;</span>
<a href="#l3.49"></a><span id="l3.49">       &lt;/method&gt;</span>
<a href="#l3.50"></a><span id="l3.50"> </span>
<a href="#l3.51"></a><span id="l3.51">       &lt;method name=&quot;getRangeDescription&quot;&gt;</span>
<a href="#l3.52"></a><span id="l3.52">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineminus">-          return getDateFormatter().formatInterval(this.rangeStartDate, this.rangeEndDate);</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+          return cal.getDateFormatter().formatInterval(this.rangeStartDate, this.rangeEndDate);</span>
<a href="#l3.55"></a><span id="l3.55">         ]]&gt;&lt;/body&gt;</span>
<a href="#l3.56"></a><span id="l3.56">       &lt;/method&gt;</span>
<a href="#l3.57"></a><span id="l3.57"> </span>
<a href="#l3.58"></a><span id="l3.58">       &lt;!-- This function guarantees that the</span>
<a href="#l3.59"></a><span id="l3.59">        labels are clipped in the instance that the overflow occurrs,</span>
<a href="#l3.60"></a><span id="l3.60">        avoiding horizontal scrollbars from showing up for a short period. --&gt;</span>
<a href="#l3.61"></a><span id="l3.61">       &lt;method name=&quot;adjustWeekdayLength&quot;&gt;</span>
<a href="#l3.62"></a><span id="l3.62">         &lt;parameter name=&quot;forceShortName&quot;/&gt;</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineat">@@ -630,17 +630,17 @@</span>
<a href="#l3.64"></a><span id="l3.64">               case &quot;calendar.week.d2tuesdaysoff&quot;:</span>
<a href="#l3.65"></a><span id="l3.65">               case &quot;calendar.week.d3wednesdaysoff&quot;:</span>
<a href="#l3.66"></a><span id="l3.66">               case &quot;calendar.week.d4thursdaysoff&quot;:</span>
<a href="#l3.67"></a><span id="l3.67">               case &quot;calendar.week.d5fridaysoff&quot;:</span>
<a href="#l3.68"></a><span id="l3.68">               case &quot;calendar.week.d6saturdaysoff&quot;:</span>
<a href="#l3.69"></a><span id="l3.69">                   this.updateDaysOffPrefs();</span>
<a href="#l3.70"></a><span id="l3.70">                   break;</span>
<a href="#l3.71"></a><span id="l3.71">               case &quot;calendar.timezone.local&quot;:</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineminus">-                  this.timezone = calendarDefaultTimezone();</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+                  this.timezone = cal.calendarDefaultTimezone();</span>
<a href="#l3.74"></a><span id="l3.74">                   this.refreshView();</span>
<a href="#l3.75"></a><span id="l3.75">                   break;</span>
<a href="#l3.76"></a><span id="l3.76">               case &quot;calendar.alarms.indicator.show&quot;:</span>
<a href="#l3.77"></a><span id="l3.77">                   // Break here to ensure the view is refreshed</span>
<a href="#l3.78"></a><span id="l3.78">                   break;</span>
<a href="#l3.79"></a><span id="l3.79">               case &quot;calendar.week.start&quot;:</span>
<a href="#l3.80"></a><span id="l3.80">                   this.weekStartOffset = aSubject.getIntPref(aPreference);</span>
<a href="#l3.81"></a><span id="l3.81">                   break;</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineat">@@ -860,18 +860,18 @@</span>
<a href="#l3.83"></a><span id="l3.83">       &lt;property name=&quot;longName&quot; readonly=&quot;true&quot;</span>
<a href="#l3.84"></a><span id="l3.84">                 onget=&quot;return document.getAnonymousElementByAttribute(this, 'anonid', 'longWeekdayName');&quot;/&gt;</span>
<a href="#l3.85"></a><span id="l3.85">       &lt;property name=&quot;shortName&quot; readonly=&quot;true&quot;</span>
<a href="#l3.86"></a><span id="l3.86">                 onget=&quot;return document.getAnonymousElementByAttribute(this, 'anonid', 'shortWeekdayName');&quot;/&gt;</span>
<a href="#l3.87"></a><span id="l3.87">       &lt;property name=&quot;weekDay&quot;&gt;</span>
<a href="#l3.88"></a><span id="l3.88">         &lt;getter&gt;return this.mWeekday;&lt;/getter&gt;</span>
<a href="#l3.89"></a><span id="l3.89">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l3.90"></a><span id="l3.90">           this.mWeekday = val % 7;</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineminus">-          this.longName.value = getDateFormatter().dayName(val);</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineminus">-          this.shortName.value = getDateFormatter().shortDayName(val);</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+          this.longName.value = cal.getDateFormatter().dayName(val);</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineplus">+          this.shortName.value = cal.getDateFormatter().shortDayName(val);</span>
<a href="#l3.95"></a><span id="l3.95">           return this.mWeekday;</span>
<a href="#l3.96"></a><span id="l3.96">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l3.97"></a><span id="l3.97">       &lt;/property&gt;</span>
<a href="#l3.98"></a><span id="l3.98"> </span>
<a href="#l3.99"></a><span id="l3.99">       &lt;property name=&quot;date&quot;&gt;</span>
<a href="#l3.100"></a><span id="l3.100">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l3.101"></a><span id="l3.101">           return this.mDate;</span>
<a href="#l3.102"></a><span id="l3.102">         ]]&gt;&lt;/getter&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/base/content/calendar-clipboard.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/base/content/calendar-clipboard.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -169,17 +169,17 @@ function pasteFromClipboard() {</span>
<a href="#l4.4"></a><span id="l4.4">             }</span>
<a href="#l4.5"></a><span id="l4.5">             let firstDate = currentView().selectedDay;</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7">             let offset = null;</span>
<a href="#l4.8"></a><span id="l4.8">             if (earliestDate) {</span>
<a href="#l4.9"></a><span id="l4.9">                 // Timezones and DT/DST time may differ between the earliest item</span>
<a href="#l4.10"></a><span id="l4.10">                 // and the selected day. Determine the offset between the</span>
<a href="#l4.11"></a><span id="l4.11">                 // earliestDate in local time and the selected day in whole days.</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-                earliestDate = earliestDate.getInTimezone(calendarDefaultTimezone());</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+                earliestDate = earliestDate.getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l4.14"></a><span id="l4.14">                 earliestDate.isDate = true;</span>
<a href="#l4.15"></a><span id="l4.15">                 offset = firstDate.subtractDate(earliestDate);</span>
<a href="#l4.16"></a><span id="l4.16">                 let deltaDST = firstDate.timezoneOffset - earliestDate.timezoneOffset;</span>
<a href="#l4.17"></a><span id="l4.17">                 offset.inSeconds += deltaDST;</span>
<a href="#l4.18"></a><span id="l4.18">             }</span>
<a href="#l4.19"></a><span id="l4.19"> </span>
<a href="#l4.20"></a><span id="l4.20">             startBatchTransaction();</span>
<a href="#l4.21"></a><span id="l4.21">             for (let item of items) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/base/content/calendar-common-sets.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/base/content/calendar-common-sets.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -270,37 +270,37 @@ var calendarController = {</span>
<a href="#l5.4"></a><span id="l5.4">         return false;</span>
<a href="#l5.5"></a><span id="l5.5">     },</span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7">     doCommand: function(aCommand) {</span>
<a href="#l5.8"></a><span id="l5.8">         switch (aCommand) {</span>
<a href="#l5.9"></a><span id="l5.9">             // Common Commands</span>
<a href="#l5.10"></a><span id="l5.10">             case &quot;calendar_new_event_command&quot;:</span>
<a href="#l5.11"></a><span id="l5.11">                 createEventWithDialog(getSelectedCalendar(),</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-                                      getDefaultStartDate(currentView().selectedDay));</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+                                      cal.getDefaultStartDate(currentView().selectedDay));</span>
<a href="#l5.14"></a><span id="l5.14">                 break;</span>
<a href="#l5.15"></a><span id="l5.15">             case &quot;calendar_new_event_context_command&quot;: {</span>
<a href="#l5.16"></a><span id="l5.16">                 let newStart = currentView().selectedDateTime;</span>
<a href="#l5.17"></a><span id="l5.17">                 if (!newStart) {</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineminus">-                    newStart = getDefaultStartDate(currentView().selectedDay);</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+                    newStart = cal.getDefaultStartDate(currentView().selectedDay);</span>
<a href="#l5.20"></a><span id="l5.20">                 }</span>
<a href="#l5.21"></a><span id="l5.21">                 createEventWithDialog(getSelectedCalendar(), newStart,</span>
<a href="#l5.22"></a><span id="l5.22">                                       null, null, null,</span>
<a href="#l5.23"></a><span id="l5.23">                                       newStart.isDate == true);</span>
<a href="#l5.24"></a><span id="l5.24">                 break;</span>
<a href="#l5.25"></a><span id="l5.25">             }</span>
<a href="#l5.26"></a><span id="l5.26">             case &quot;calendar_modify_event_command&quot;:</span>
<a href="#l5.27"></a><span id="l5.27">                 editSelectedEvents();</span>
<a href="#l5.28"></a><span id="l5.28">                 break;</span>
<a href="#l5.29"></a><span id="l5.29">             case &quot;calendar_modify_focused_item_command&quot;: {</span>
<a href="#l5.30"></a><span id="l5.30">                 let focusedElement = document.commandDispatcher.focusedElement;</span>
<a href="#l5.31"></a><span id="l5.31">                 if (!focusedElement &amp;&amp; this.defaultController &amp;&amp; !this.isCalendarInForeground()) {</span>
<a href="#l5.32"></a><span id="l5.32">                     this.defaultController.doCommand(aCommand);</span>
<a href="#l5.33"></a><span id="l5.33">                 } else {</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-                    let focusedRichListbox = getParentNodeOrThis(focusedElement, &quot;richlistbox&quot;);</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+                    let focusedRichListbox = cal.getParentNodeOrThis(focusedElement, &quot;richlistbox&quot;);</span>
<a href="#l5.36"></a><span id="l5.36">                     if (focusedRichListbox &amp;&amp; focusedRichListbox.id == &quot;agenda-listbox&quot;) {</span>
<a href="#l5.37"></a><span id="l5.37">                         agendaListbox.editSelectedItem();</span>
<a href="#l5.38"></a><span id="l5.38">                     } else if (focusedElement &amp;&amp; focusedElement.className == &quot;calendar-task-tree&quot;) {</span>
<a href="#l5.39"></a><span id="l5.39">                         modifyTaskFromContext();</span>
<a href="#l5.40"></a><span id="l5.40">                     } else if (this.isInMode(&quot;calendar&quot;)) {</span>
<a href="#l5.41"></a><span id="l5.41">                         editSelectedEvents();</span>
<a href="#l5.42"></a><span id="l5.42">                     }</span>
<a href="#l5.43"></a><span id="l5.43">                 }</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineat">@@ -309,62 +309,62 @@ var calendarController = {</span>
<a href="#l5.45"></a><span id="l5.45">             case &quot;calendar_delete_event_command&quot;:</span>
<a href="#l5.46"></a><span id="l5.46">                 deleteSelectedEvents();</span>
<a href="#l5.47"></a><span id="l5.47">                 break;</span>
<a href="#l5.48"></a><span id="l5.48">             case &quot;calendar_delete_focused_item_command&quot;: {</span>
<a href="#l5.49"></a><span id="l5.49">                 let focusedElement = document.commandDispatcher.focusedElement;</span>
<a href="#l5.50"></a><span id="l5.50">                 if (!focusedElement &amp;&amp; this.defaultController &amp;&amp; !this.isCalendarInForeground()) {</span>
<a href="#l5.51"></a><span id="l5.51">                     this.defaultController.doCommand(aCommand);</span>
<a href="#l5.52"></a><span id="l5.52">                 } else {</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineminus">-                    let focusedRichListbox = getParentNodeOrThis(focusedElement, &quot;richlistbox&quot;);</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+                    let focusedRichListbox = cal.getParentNodeOrThis(focusedElement, &quot;richlistbox&quot;);</span>
<a href="#l5.55"></a><span id="l5.55">                     if (focusedRichListbox &amp;&amp; focusedRichListbox.id == &quot;agenda-listbox&quot;) {</span>
<a href="#l5.56"></a><span id="l5.56">                         agendaListbox.deleteSelectedItem(false);</span>
<a href="#l5.57"></a><span id="l5.57">                     } else if (focusedElement &amp;&amp; focusedElement.className == &quot;calendar-task-tree&quot;) {</span>
<a href="#l5.58"></a><span id="l5.58">                         deleteToDoCommand(null, false);</span>
<a href="#l5.59"></a><span id="l5.59">                     } else if (this.isInMode(&quot;calendar&quot;)) {</span>
<a href="#l5.60"></a><span id="l5.60">                         deleteSelectedEvents();</span>
<a href="#l5.61"></a><span id="l5.61">                     }</span>
<a href="#l5.62"></a><span id="l5.62">                 }</span>
<a href="#l5.63"></a><span id="l5.63">                 break;</span>
<a href="#l5.64"></a><span id="l5.64">             }</span>
<a href="#l5.65"></a><span id="l5.65">             case &quot;calendar_new_todo_command&quot;:</span>
<a href="#l5.66"></a><span id="l5.66">                 createTodoWithDialog(getSelectedCalendar(),</span>
<a href="#l5.67"></a><span id="l5.67">                                      null, null, null,</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineminus">-                                     getDefaultStartDate(currentView().selectedDay));</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+                                     cal.getDefaultStartDate(currentView().selectedDay));</span>
<a href="#l5.70"></a><span id="l5.70">                 break;</span>
<a href="#l5.71"></a><span id="l5.71">             case &quot;calendar_new_todo_context_command&quot;: {</span>
<a href="#l5.72"></a><span id="l5.72">                 let initialDate = currentView().selectedDateTime;</span>
<a href="#l5.73"></a><span id="l5.73">                 if (!initialDate || initialDate.isDate) {</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineminus">-                    initialDate = getDefaultStartDate(currentView().selectedDay);</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineplus">+                    initialDate = cal.getDefaultStartDate(currentView().selectedDay);</span>
<a href="#l5.76"></a><span id="l5.76">                 }</span>
<a href="#l5.77"></a><span id="l5.77">                 createTodoWithDialog(getSelectedCalendar(),</span>
<a href="#l5.78"></a><span id="l5.78">                                      null, null, null,</span>
<a href="#l5.79"></a><span id="l5.79">                                      initialDate);</span>
<a href="#l5.80"></a><span id="l5.80">                 break;</span>
<a href="#l5.81"></a><span id="l5.81">             }</span>
<a href="#l5.82"></a><span id="l5.82">             case &quot;calendar_new_todo_todaypane_command&quot;:</span>
<a href="#l5.83"></a><span id="l5.83">                 createTodoWithDialog(getSelectedCalendar(),</span>
<a href="#l5.84"></a><span id="l5.84">                                      null, null, null,</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineminus">-                                     getDefaultStartDate(agendaListbox.today.start));</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+                                     cal.getDefaultStartDate(agendaListbox.today.start));</span>
<a href="#l5.87"></a><span id="l5.87">                 break;</span>
<a href="#l5.88"></a><span id="l5.88">             case &quot;calendar_delete_todo_command&quot;:</span>
<a href="#l5.89"></a><span id="l5.89">                 deleteToDoCommand();</span>
<a href="#l5.90"></a><span id="l5.90">                 break;</span>
<a href="#l5.91"></a><span id="l5.91">             case &quot;calendar_modify_todo_command&quot;:</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineminus">-                modifyTaskFromContext(null, getDefaultStartDate(currentView().selectedDay));</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineplus">+                modifyTaskFromContext(null, cal.getDefaultStartDate(currentView().selectedDay));</span>
<a href="#l5.94"></a><span id="l5.94">                 break;</span>
<a href="#l5.95"></a><span id="l5.95">             case &quot;calendar_modify_todo_todaypane_command&quot;:</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineminus">-                modifyTaskFromContext(null, getDefaultStartDate(agendaListbox.today.start));</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineplus">+                modifyTaskFromContext(null, cal.getDefaultStartDate(agendaListbox.today.start));</span>
<a href="#l5.98"></a><span id="l5.98">                 break;</span>
<a href="#l5.99"></a><span id="l5.99"> </span>
<a href="#l5.100"></a><span id="l5.100">             case &quot;calendar_new_calendar_command&quot;:</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineminus">-                openCalendarWizard();</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineplus">+                cal.openCalendarWizard(window);</span>
<a href="#l5.103"></a><span id="l5.103">                 break;</span>
<a href="#l5.104"></a><span id="l5.104">             case &quot;calendar_edit_calendar_command&quot;:</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineminus">-                openCalendarProperties(getSelectedCalendar());</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineplus">+                cal.openCalendarProperties(window, getSelectedCalendar());</span>
<a href="#l5.107"></a><span id="l5.107">                 break;</span>
<a href="#l5.108"></a><span id="l5.108">             case &quot;calendar_delete_calendar_command&quot;:</span>
<a href="#l5.109"></a><span id="l5.109">                 promptDeleteCalendar(getSelectedCalendar());</span>
<a href="#l5.110"></a><span id="l5.110">                 break;</span>
<a href="#l5.111"></a><span id="l5.111"> </span>
<a href="#l5.112"></a><span id="l5.112">             case &quot;calendar_import_command&quot;:</span>
<a href="#l5.113"></a><span id="l5.113">                 loadEventsFromFile();</span>
<a href="#l5.114"></a><span id="l5.114">                 break;</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineat">@@ -535,68 +535,68 @@ var calendarController = {</span>
<a href="#l5.116"></a><span id="l5.116">     get offline() {</span>
<a href="#l5.117"></a><span id="l5.117">         return Services.io.offline;</span>
<a href="#l5.118"></a><span id="l5.118">     },</span>
<a href="#l5.119"></a><span id="l5.119"> </span>
<a href="#l5.120"></a><span id="l5.120">     /**</span>
<a href="#l5.121"></a><span id="l5.121">      * Returns a boolean indicating if all calendars are readonly.</span>
<a href="#l5.122"></a><span id="l5.122">      */</span>
<a href="#l5.123"></a><span id="l5.123">     get all_readonly() {</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineminus">-        let calMgr = getCalendarManager();</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineplus">+        let calMgr = cal.getCalendarManager();</span>
<a href="#l5.126"></a><span id="l5.126">         return (calMgr.readOnlyCalendarCount == calMgr.calendarCount);</span>
<a href="#l5.127"></a><span id="l5.127">     },</span>
<a href="#l5.128"></a><span id="l5.128"> </span>
<a href="#l5.129"></a><span id="l5.129">     /**</span>
<a href="#l5.130"></a><span id="l5.130">      * Returns a boolean indicating if all calendars are local</span>
<a href="#l5.131"></a><span id="l5.131">      */</span>
<a href="#l5.132"></a><span id="l5.132">     get no_network_calendars() {</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineminus">-        return (getCalendarManager().networkCalendarCount == 0);</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineplus">+        return (cal.getCalendarManager().networkCalendarCount == 0);</span>
<a href="#l5.135"></a><span id="l5.135">     },</span>
<a href="#l5.136"></a><span id="l5.136"> </span>
<a href="#l5.137"></a><span id="l5.137">     /**</span>
<a href="#l5.138"></a><span id="l5.138">      * Returns a boolean indicating if there are calendars that don't require</span>
<a href="#l5.139"></a><span id="l5.139">      * network access.</span>
<a href="#l5.140"></a><span id="l5.140">      */</span>
<a href="#l5.141"></a><span id="l5.141">     get has_local_calendars() {</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineminus">-        let calMgr = getCalendarManager();</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineplus">+        let calMgr = cal.getCalendarManager();</span>
<a href="#l5.144"></a><span id="l5.144">         return (calMgr.networkCalendarCount &lt; calMgr.calendarCount);</span>
<a href="#l5.145"></a><span id="l5.145">     },</span>
<a href="#l5.146"></a><span id="l5.146"> </span>
<a href="#l5.147"></a><span id="l5.147">     /**</span>
<a href="#l5.148"></a><span id="l5.148">      * Returns a boolean indicating if there are cached calendars and thus that don't require</span>
<a href="#l5.149"></a><span id="l5.149">      * network access.</span>
<a href="#l5.150"></a><span id="l5.150">      */</span>
<a href="#l5.151"></a><span id="l5.151">     get has_cached_calendars() {</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineminus">-        let calMgr = getCalendarManager();</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineplus">+        let calMgr = cal.getCalendarManager();</span>
<a href="#l5.154"></a><span id="l5.154">         let calendars = calMgr.getCalendars({});</span>
<a href="#l5.155"></a><span id="l5.155">         for (let calendar of calendars) {</span>
<a href="#l5.156"></a><span id="l5.156">             if (calendar.getProperty(&quot;cache.enabled&quot;) || calendar.getProperty(&quot;cache.always&quot;)) {</span>
<a href="#l5.157"></a><span id="l5.157">                 return true;</span>
<a href="#l5.158"></a><span id="l5.158">             }</span>
<a href="#l5.159"></a><span id="l5.159">         }</span>
<a href="#l5.160"></a><span id="l5.160">         return false;</span>
<a href="#l5.161"></a><span id="l5.161">     },</span>
<a href="#l5.162"></a><span id="l5.162"> </span>
<a href="#l5.163"></a><span id="l5.163">     /**</span>
<a href="#l5.164"></a><span id="l5.164">      * Returns a boolean indicating that there is only one calendar left.</span>
<a href="#l5.165"></a><span id="l5.165">      */</span>
<a href="#l5.166"></a><span id="l5.166">     get last_calendar() {</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineminus">-        return (getCalendarManager().calendarCount &lt; 2);</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineplus">+        return (cal.getCalendarManager().calendarCount &lt; 2);</span>
<a href="#l5.169"></a><span id="l5.169">     },</span>
<a href="#l5.170"></a><span id="l5.170"> </span>
<a href="#l5.171"></a><span id="l5.171">     /**</span>
<a href="#l5.172"></a><span id="l5.172">      * Returns a boolean indicating that all local calendars are readonly</span>
<a href="#l5.173"></a><span id="l5.173">      */</span>
<a href="#l5.174"></a><span id="l5.174">     get all_local_calendars_readonly() {</span>
<a href="#l5.175"></a><span id="l5.175">         // We might want to speed this part up by keeping track of this in the</span>
<a href="#l5.176"></a><span id="l5.176">         // calendar manager.</span>
<a href="#l5.177"></a><span id="l5.177" class="difflineminus">-        let calendars = getCalendarManager().getCalendars({});</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineplus">+        let calendars = cal.getCalendarManager().getCalendars({});</span>
<a href="#l5.179"></a><span id="l5.179">         let count = calendars.length;</span>
<a href="#l5.180"></a><span id="l5.180">         for (let calendar of calendars) {</span>
<a href="#l5.181"></a><span id="l5.181" class="difflineminus">-            if (!isCalendarWritable(calendar)) {</span>
<a href="#l5.182"></a><span id="l5.182" class="difflineplus">+            if (!cal.isCalendarWritable(calendar)) {</span>
<a href="#l5.183"></a><span id="l5.183">                 count--;</span>
<a href="#l5.184"></a><span id="l5.184">             }</span>
<a href="#l5.185"></a><span id="l5.185">         }</span>
<a href="#l5.186"></a><span id="l5.186">         return (count == 0);</span>
<a href="#l5.187"></a><span id="l5.187">     },</span>
<a href="#l5.188"></a><span id="l5.188"> </span>
<a href="#l5.189"></a><span id="l5.189">     /**</span>
<a href="#l5.190"></a><span id="l5.190">      * Returns a boolean indicating that at least one of the items selected</span>
<a href="#l5.191"></a><span id="l5.191" class="difflineat">@@ -640,17 +640,17 @@ var calendarController = {</span>
<a href="#l5.192"></a><span id="l5.192"> </span>
<a href="#l5.193"></a><span id="l5.193">     /**</span>
<a href="#l5.194"></a><span id="l5.194">      * Returns a boolean indicating that at least one task in the selection is</span>
<a href="#l5.195"></a><span id="l5.195">      * on a calendar that is writable.</span>
<a href="#l5.196"></a><span id="l5.196">      */</span>
<a href="#l5.197"></a><span id="l5.197">     get todo_items_writable() {</span>
<a href="#l5.198"></a><span id="l5.198">         let selectedTasks = getSelectedTasks();</span>
<a href="#l5.199"></a><span id="l5.199">         for (let task of selectedTasks) {</span>
<a href="#l5.200"></a><span id="l5.200" class="difflineminus">-            if (isCalendarWritable(task.calendar)) {</span>
<a href="#l5.201"></a><span id="l5.201" class="difflineplus">+            if (cal.isCalendarWritable(task.calendar)) {</span>
<a href="#l5.202"></a><span id="l5.202">                 return true;</span>
<a href="#l5.203"></a><span id="l5.203">             }</span>
<a href="#l5.204"></a><span id="l5.204">         }</span>
<a href="#l5.205"></a><span id="l5.205">         return false;</span>
<a href="#l5.206"></a><span id="l5.206">     }</span>
<a href="#l5.207"></a><span id="l5.207"> };</span>
<a href="#l5.208"></a><span id="l5.208"> </span>
<a href="#l5.209"></a><span id="l5.209"> /**</span>
<a href="#l5.210"></a><span id="l5.210" class="difflineat">@@ -737,17 +737,17 @@ var calendarController2 = {</span>
<a href="#l5.211"></a><span id="l5.211">             case &quot;cmd_redo&quot;:</span>
<a href="#l5.212"></a><span id="l5.212">                 redo();</span>
<a href="#l5.213"></a><span id="l5.213">                 break;</span>
<a href="#l5.214"></a><span id="l5.214">             case &quot;cmd_pageSetup&quot;:</span>
<a href="#l5.215"></a><span id="l5.215">                 PrintUtils.showPageSetup();</span>
<a href="#l5.216"></a><span id="l5.216">                 break;</span>
<a href="#l5.217"></a><span id="l5.217">             case &quot;button_print&quot;:</span>
<a href="#l5.218"></a><span id="l5.218">             case &quot;cmd_print&quot;:</span>
<a href="#l5.219"></a><span id="l5.219" class="difflineminus">-                calPrint();</span>
<a href="#l5.220"></a><span id="l5.220" class="difflineplus">+                cal.calPrint(window);</span>
<a href="#l5.221"></a><span id="l5.221">                 break;</span>
<a href="#l5.222"></a><span id="l5.222"> </span>
<a href="#l5.223"></a><span id="l5.223">             // Thunderbird commands</span>
<a href="#l5.224"></a><span id="l5.224">             case &quot;cmd_goForward&quot;:</span>
<a href="#l5.225"></a><span id="l5.225">                 currentView().moveView(1);</span>
<a href="#l5.226"></a><span id="l5.226">                 break;</span>
<a href="#l5.227"></a><span id="l5.227">             case &quot;cmd_goBack&quot;:</span>
<a href="#l5.228"></a><span id="l5.228">                 currentView().moveView(-1);</span>
<a href="#l5.229"></a><span id="l5.229" class="difflineat">@@ -812,27 +812,27 @@ function removeCalendarCommandController</span>
<a href="#l5.230"></a><span id="l5.230">  * @param items         An array of items (usually the selected items) to adapt</span>
<a href="#l5.231"></a><span id="l5.231">  *                        the context menu for.</span>
<a href="#l5.232"></a><span id="l5.232">  * @return              True, to show the popup menu.</span>
<a href="#l5.233"></a><span id="l5.233">  */</span>
<a href="#l5.234"></a><span id="l5.234"> function setupContextItemType(event, items) {</span>
<a href="#l5.235"></a><span id="l5.235">     function adaptModificationMenuItem(aMenuItemId, aItemType) {</span>
<a href="#l5.236"></a><span id="l5.236">         let menuItem = document.getElementById(aMenuItemId);</span>
<a href="#l5.237"></a><span id="l5.237">         if (menuItem) {</span>
<a href="#l5.238"></a><span id="l5.238" class="difflineminus">-            menuItem.setAttribute(&quot;label&quot;, calGetString(&quot;calendar&quot;, &quot;delete&quot; + aItemType + &quot;Label&quot;));</span>
<a href="#l5.239"></a><span id="l5.239" class="difflineminus">-            menuItem.setAttribute(&quot;accesskey&quot;, calGetString(&quot;calendar&quot;, &quot;delete&quot; + aItemType + &quot;Accesskey&quot;));</span>
<a href="#l5.240"></a><span id="l5.240" class="difflineplus">+            menuItem.setAttribute(&quot;label&quot;, cal.calGetString(&quot;calendar&quot;, &quot;delete&quot; + aItemType + &quot;Label&quot;));</span>
<a href="#l5.241"></a><span id="l5.241" class="difflineplus">+            menuItem.setAttribute(&quot;accesskey&quot;, cal.calGetString(&quot;calendar&quot;, &quot;delete&quot; + aItemType + &quot;Accesskey&quot;));</span>
<a href="#l5.242"></a><span id="l5.242">         }</span>
<a href="#l5.243"></a><span id="l5.243">     }</span>
<a href="#l5.244"></a><span id="l5.244" class="difflineminus">-    if (items.some(isEvent) &amp;&amp; items.some(isToDo)) {</span>
<a href="#l5.245"></a><span id="l5.245" class="difflineplus">+    if (items.some(cal.isEvent) &amp;&amp; items.some(cal.isToDo)) {</span>
<a href="#l5.246"></a><span id="l5.246">         event.target.setAttribute(&quot;type&quot;, &quot;mixed&quot;);</span>
<a href="#l5.247"></a><span id="l5.247">         adaptModificationMenuItem(&quot;calendar-item-context-menu-delete-menuitem&quot;, &quot;Item&quot;);</span>
<a href="#l5.248"></a><span id="l5.248" class="difflineminus">-    } else if (items.length &amp;&amp; isEvent(items[0])) {</span>
<a href="#l5.249"></a><span id="l5.249" class="difflineplus">+    } else if (items.length &amp;&amp; cal.isEvent(items[0])) {</span>
<a href="#l5.250"></a><span id="l5.250">         event.target.setAttribute(&quot;type&quot;, &quot;event&quot;);</span>
<a href="#l5.251"></a><span id="l5.251">         adaptModificationMenuItem(&quot;calendar-item-context-menu-delete-menuitem&quot;, &quot;Event&quot;);</span>
<a href="#l5.252"></a><span id="l5.252" class="difflineminus">-    } else if (items.length &amp;&amp; isToDo(items[0])) {</span>
<a href="#l5.253"></a><span id="l5.253" class="difflineplus">+    } else if (items.length &amp;&amp; cal.isToDo(items[0])) {</span>
<a href="#l5.254"></a><span id="l5.254">         event.target.setAttribute(&quot;type&quot;, &quot;todo&quot;);</span>
<a href="#l5.255"></a><span id="l5.255">         adaptModificationMenuItem(&quot;calendar-item-context-menu-delete-menuitem&quot;, &quot;Task&quot;);</span>
<a href="#l5.256"></a><span id="l5.256">     } else {</span>
<a href="#l5.257"></a><span id="l5.257">         event.target.removeAttribute(&quot;type&quot;);</span>
<a href="#l5.258"></a><span id="l5.258">         adaptModificationMenuItem(&quot;calendar-item-context-menu-delete-menuitem&quot;, &quot;Item&quot;);</span>
<a href="#l5.259"></a><span id="l5.259">     }</span>
<a href="#l5.260"></a><span id="l5.260"> </span>
<a href="#l5.261"></a><span id="l5.261">     let menu = document.getElementById(&quot;calendar-item-context-menu-attendance-menu&quot;);</span>
<a href="#l5.262"></a><span id="l5.262" class="difflineat">@@ -904,17 +904,17 @@ function calendarUpdateNewItemsCommand()</span>
<a href="#l5.263"></a><span id="l5.263">                          &quot;calendar_new_event_context_command&quot;];</span>
<a href="#l5.264"></a><span id="l5.264">     let taskCommands = [&quot;calendar_new_todo_command&quot;,</span>
<a href="#l5.265"></a><span id="l5.265">                         &quot;calendar_new_todo_context_command&quot;,</span>
<a href="#l5.266"></a><span id="l5.266">                         &quot;calendar_new_todo_todaypane_command&quot;];</span>
<a href="#l5.267"></a><span id="l5.267"> </span>
<a href="#l5.268"></a><span id="l5.268">     // re-calculate command status</span>
<a href="#l5.269"></a><span id="l5.269">     CalendarNewEventsCommandEnabled = false;</span>
<a href="#l5.270"></a><span id="l5.270">     CalendarNewTasksCommandEnabled = false;</span>
<a href="#l5.271"></a><span id="l5.271" class="difflineminus">-    let calendars = cal.getCalendarManager().getCalendars({}).filter(cal.isCalendarWritable).filter(userCanAddItemsToCalendar);</span>
<a href="#l5.272"></a><span id="l5.272" class="difflineplus">+    let calendars = cal.getCalendarManager().getCalendars({}).filter(cal.isCalendarWritable).filter(cal.userCanAddItemsToCalendar);</span>
<a href="#l5.273"></a><span id="l5.273">     if (calendars.some(cal.isEventCalendar)) {</span>
<a href="#l5.274"></a><span id="l5.274">         CalendarNewEventsCommandEnabled = true;</span>
<a href="#l5.275"></a><span id="l5.275">     }</span>
<a href="#l5.276"></a><span id="l5.276">     if (calendars.some(cal.isTaskCalendar)) {</span>
<a href="#l5.277"></a><span id="l5.277">         CalendarNewTasksCommandEnabled = true;</span>
<a href="#l5.278"></a><span id="l5.278">     }</span>
<a href="#l5.279"></a><span id="l5.279"> </span>
<a href="#l5.280"></a><span id="l5.280">     // update command status if required</span>
<a href="#l5.281"></a><span id="l5.281" class="difflineat">@@ -927,17 +927,17 @@ function calendarUpdateNewItemsCommand()</span>
<a href="#l5.282"></a><span id="l5.282"> }</span>
<a href="#l5.283"></a><span id="l5.283"> </span>
<a href="#l5.284"></a><span id="l5.284"> function calendarUpdateDeleteCommand(selectedItems) {</span>
<a href="#l5.285"></a><span id="l5.285">     let oldValue = CalendarDeleteCommandEnabled;</span>
<a href="#l5.286"></a><span id="l5.286">     CalendarDeleteCommandEnabled = (selectedItems.length &gt; 0);</span>
<a href="#l5.287"></a><span id="l5.287"> </span>
<a href="#l5.288"></a><span id="l5.288">     /* we must disable &quot;delete&quot; when at least one item cannot be deleted */</span>
<a href="#l5.289"></a><span id="l5.289">     for (let item of selectedItems) {</span>
<a href="#l5.290"></a><span id="l5.290" class="difflineminus">-        if (!userCanDeleteItemsFromCalendar(item.calendar)) {</span>
<a href="#l5.291"></a><span id="l5.291" class="difflineplus">+        if (!cal.userCanDeleteItemsFromCalendar(item.calendar)) {</span>
<a href="#l5.292"></a><span id="l5.292">             CalendarDeleteCommandEnabled = false;</span>
<a href="#l5.293"></a><span id="l5.293">             break;</span>
<a href="#l5.294"></a><span id="l5.294">         }</span>
<a href="#l5.295"></a><span id="l5.295">     }</span>
<a href="#l5.296"></a><span id="l5.296"> </span>
<a href="#l5.297"></a><span id="l5.297">     if (CalendarDeleteCommandEnabled != oldValue) {</span>
<a href="#l5.298"></a><span id="l5.298">         let commands = [&quot;calendar_delete_event_command&quot;,</span>
<a href="#l5.299"></a><span id="l5.299">                         &quot;calendar_delete_todo_command&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/calendar/base/content/calendar-daypicker.xml</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/calendar/base/content/calendar-daypicker.xml</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -239,27 +239,28 @@</span>
<a href="#l6.4"></a><span id="l6.4">                   }</span>
<a href="#l6.5"></a><span id="l6.5">               }</span>
<a href="#l6.6"></a><span id="l6.6">           }</span>
<a href="#l6.7"></a><span id="l6.7">           return days;</span>
<a href="#l6.8"></a><span id="l6.8">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l6.9"></a><span id="l6.9">       &lt;/property&gt;</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l6.13"></a><span id="l6.13">         let mainbox =</span>
<a href="#l6.14"></a><span id="l6.14">             document.getAnonymousElementByAttribute(</span>
<a href="#l6.15"></a><span id="l6.15">                 this, &quot;anonid&quot;, &quot;mainbox&quot;);</span>
<a href="#l6.16"></a><span id="l6.16">         let numRows = mainbox.childNodes.length;</span>
<a href="#l6.17"></a><span id="l6.17">         let child = null;</span>
<a href="#l6.18"></a><span id="l6.18">         for (let i = 0; i &lt; numRows; i++) {</span>
<a href="#l6.19"></a><span id="l6.19">             let row = mainbox.childNodes[i];</span>
<a href="#l6.20"></a><span id="l6.20">             let numChilds = row.childNodes.length;</span>
<a href="#l6.21"></a><span id="l6.21">             for (let j = 0; j &lt; numChilds; j++) {</span>
<a href="#l6.22"></a><span id="l6.22">                 child = row.childNodes[j];</span>
<a href="#l6.23"></a><span id="l6.23">                 child.calendar = this;</span>
<a href="#l6.24"></a><span id="l6.24">             }</span>
<a href="#l6.25"></a><span id="l6.25">         }</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineminus">-        let labelLastDay = calGetString(&quot;calendar-event-dialog&quot;, &quot;eventRecurrenceMonthlyLastDayLabel&quot;);</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineplus">+        let labelLastDay = cal.calGetString(&quot;calendar-event-dialog&quot;, &quot;eventRecurrenceMonthlyLastDayLabel&quot;);</span>
<a href="#l6.28"></a><span id="l6.28">         child.setAttribute(&quot;label&quot;, labelLastDay);</span>
<a href="#l6.29"></a><span id="l6.29">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l6.30"></a><span id="l6.30">     &lt;/implementation&gt;</span>
<a href="#l6.31"></a><span id="l6.31">   &lt;/binding&gt;</span>
<a href="#l6.32"></a><span id="l6.32"> &lt;/bindings&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/calendar/base/content/calendar-dnd-listener.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/calendar/base/content/calendar-dnd-listener.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -182,17 +182,17 @@ var itemConversion = {</span>
<a href="#l7.4"></a><span id="l7.4">     }</span>
<a href="#l7.5"></a><span id="l7.5"> };</span>
<a href="#l7.6"></a><span id="l7.6"> </span>
<a href="#l7.7"></a><span id="l7.7"> /**</span>
<a href="#l7.8"></a><span id="l7.8">  * A base class for drag and drop observers</span>
<a href="#l7.9"></a><span id="l7.9">  * @class calDNDBaseObserver</span>
<a href="#l7.10"></a><span id="l7.10">  */</span>
<a href="#l7.11"></a><span id="l7.11"> function calDNDBaseObserver() {</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-    ASSERT(false, &quot;Inheriting objects call calDNDBaseObserver!&quot;);</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+    cal.ASSERT(false, &quot;Inheriting objects call calDNDBaseObserver!&quot;);</span>
<a href="#l7.14"></a><span id="l7.14"> }</span>
<a href="#l7.15"></a><span id="l7.15"> </span>
<a href="#l7.16"></a><span id="l7.16"> calDNDBaseObserver.prototype = {</span>
<a href="#l7.17"></a><span id="l7.17">     // initialize this class's members</span>
<a href="#l7.18"></a><span id="l7.18">     initBase: function calDNDInitBase() {</span>
<a href="#l7.19"></a><span id="l7.19">     },</span>
<a href="#l7.20"></a><span id="l7.20"> </span>
<a href="#l7.21"></a><span id="l7.21">     getSupportedFlavours: function calDNDGetFlavors() {</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineat">@@ -250,17 +250,17 @@ calDNDBaseObserver.prototype = {</span>
<a href="#l7.23"></a><span id="l7.23">                 parser.parseString(data);</span>
<a href="#l7.24"></a><span id="l7.24">                 this.onDropItems(parser.getItems({}).concat(parser.getParentlessItems({})));</span>
<a href="#l7.25"></a><span id="l7.25">                 break;</span>
<a href="#l7.26"></a><span id="l7.26">             case &quot;text/unicode&quot;:</span>
<a href="#l7.27"></a><span id="l7.27">                 var droppedUrl = this.retrieveURLFromData(data, bestFlavor.value);</span>
<a href="#l7.28"></a><span id="l7.28">                 if (!droppedUrl)</span>
<a href="#l7.29"></a><span id="l7.29">                     return;</span>
<a href="#l7.30"></a><span id="l7.30"> </span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-                var url = makeURL(droppedUrl);</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+                var url = cal.makeURL(droppedUrl);</span>
<a href="#l7.33"></a><span id="l7.33"> </span>
<a href="#l7.34"></a><span id="l7.34">                 var localFileInstance = Components.classes[&quot;@mozilla.org/file/local;1&quot;]</span>
<a href="#l7.35"></a><span id="l7.35">                                         .createInstance(Components.interfaces.nsILocalFile);</span>
<a href="#l7.36"></a><span id="l7.36">                 localFileInstance.initWithPath(url.path);</span>
<a href="#l7.37"></a><span id="l7.37"> </span>
<a href="#l7.38"></a><span id="l7.38">                 var inputStream = Components.classes[&quot;@mozilla.org/network/file-input-stream;1&quot;]</span>
<a href="#l7.39"></a><span id="l7.39">                                   .createInstance(Components.interfaces.nsIFileInputStream);</span>
<a href="#l7.40"></a><span id="l7.40">                 inputStream.init(localFileInstance,</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineat">@@ -323,17 +323,17 @@ calDNDBaseObserver.prototype = {</span>
<a href="#l7.42"></a><span id="l7.42">                 } catch(e) {</span>
<a href="#l7.43"></a><span id="l7.43">                     Components.utils.reportError(e)</span>
<a href="#l7.44"></a><span id="l7.44">                 }</span>
<a href="#l7.45"></a><span id="l7.45">                 break;</span>
<a href="#l7.46"></a><span id="l7.46">             case &quot;text/x-moz-message&quot;:</span>
<a href="#l7.47"></a><span id="l7.47">                 this.onDropMessage(messenger.msgHdrFromURI(data));</span>
<a href="#l7.48"></a><span id="l7.48">                 break;</span>
<a href="#l7.49"></a><span id="l7.49">             default:</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-                ASSERT(false, &quot;unknown data flavour:&quot; + bestFlavor.value+'\n');</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+                cal.ASSERT(false, &quot;unknown data flavour:&quot; + bestFlavor.value+'\n');</span>
<a href="#l7.52"></a><span id="l7.52">                 break;</span>
<a href="#l7.53"></a><span id="l7.53">         }</span>
<a href="#l7.54"></a><span id="l7.54">     },</span>
<a href="#l7.55"></a><span id="l7.55"> </span>
<a href="#l7.56"></a><span id="l7.56">     onDragStart: function calDNDStart(aEvent, aTransferData, aDragAction) {},</span>
<a href="#l7.57"></a><span id="l7.57">     onDragOver: function calDNDOver(aEvent, aFlavor, aDragSession) {},</span>
<a href="#l7.58"></a><span id="l7.58">     onDragExit: function calDNDExit(aEvent, aDragSession) {},</span>
<a href="#l7.59"></a><span id="l7.59"> </span>
<a href="#l7.60"></a><span id="l7.60" class="difflineat">@@ -415,17 +415,17 @@ calMailButtonDNDObserver.prototype = {</span>
<a href="#l7.61"></a><span id="l7.61">      *</span>
<a href="#l7.62"></a><span id="l7.62">      * @param aItems        An array of items to handle.</span>
<a href="#l7.63"></a><span id="l7.63">      */</span>
<a href="#l7.64"></a><span id="l7.64">     onDropItems: function(aItems) {</span>
<a href="#l7.65"></a><span id="l7.65">         if (aItems &amp;&amp; aItems.length &gt; 0) {</span>
<a href="#l7.66"></a><span id="l7.66">             let item = aItems[0];</span>
<a href="#l7.67"></a><span id="l7.67">             let recipients = cal.getRecipientList(item.getAttendees({}));</span>
<a href="#l7.68"></a><span id="l7.68">             let identity = item.calendar.getProperty(&quot;imip.identity&quot;);</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineminus">-            sendMailTo(recipients, item.title, item.getProperty(&quot;DESCRIPTION&quot;), identity);</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+            cal.sendMailTo(recipients, item.title, item.getProperty(&quot;DESCRIPTION&quot;), identity);</span>
<a href="#l7.71"></a><span id="l7.71">         }</span>
<a href="#l7.72"></a><span id="l7.72">     },</span>
<a href="#l7.73"></a><span id="l7.73"> </span>
<a href="#l7.74"></a><span id="l7.74">     /**</span>
<a href="#l7.75"></a><span id="l7.75">      * calMailButtonDNDObserver::onDropMessage</span>
<a href="#l7.76"></a><span id="l7.76">      *</span>
<a href="#l7.77"></a><span id="l7.77">      * Gets called in case we're dropping a message</span>
<a href="#l7.78"></a><span id="l7.78">      * on the 'mail mode'-button.</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineat">@@ -456,17 +456,17 @@ calCalendarButtonDNDObserver.prototype =</span>
<a href="#l7.80"></a><span id="l7.80">      * Gets called in case we're dropping an array of items</span>
<a href="#l7.81"></a><span id="l7.81">      * on the 'calendar mode'-button.</span>
<a href="#l7.82"></a><span id="l7.82">      *</span>
<a href="#l7.83"></a><span id="l7.83">      * @param aItems        An array of items to handle.</span>
<a href="#l7.84"></a><span id="l7.84">      */</span>
<a href="#l7.85"></a><span id="l7.85">     onDropItems: function(aItems) {</span>
<a href="#l7.86"></a><span id="l7.86">         for (var item of aItems) {</span>
<a href="#l7.87"></a><span id="l7.87">             var newItem = item;</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineminus">-            if (isToDo(item)) {</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+            if (cal.isToDo(item)) {</span>
<a href="#l7.90"></a><span id="l7.90">                 newItem = itemConversion.eventFromTask(item);</span>
<a href="#l7.91"></a><span id="l7.91">             }</span>
<a href="#l7.92"></a><span id="l7.92">             createEventWithDialog(null, null, null, null, newItem);</span>
<a href="#l7.93"></a><span id="l7.93">         }</span>
<a href="#l7.94"></a><span id="l7.94">     },</span>
<a href="#l7.95"></a><span id="l7.95"> </span>
<a href="#l7.96"></a><span id="l7.96">     /**</span>
<a href="#l7.97"></a><span id="l7.97">      * calCalendarButtonDNDObserver::onDropMessage</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineat">@@ -474,17 +474,17 @@ calCalendarButtonDNDObserver.prototype =</span>
<a href="#l7.99"></a><span id="l7.99">      * Gets called in case we're dropping a message on the</span>
<a href="#l7.100"></a><span id="l7.100">      * 'calendar mode'-button. In this case we create a new</span>
<a href="#l7.101"></a><span id="l7.101">      * event from the mail. We open the default event dialog</span>
<a href="#l7.102"></a><span id="l7.102">      * and just use the subject of the message as the event title.</span>
<a href="#l7.103"></a><span id="l7.103">      *</span>
<a href="#l7.104"></a><span id="l7.104">      * @param aMessage     The message to handle.</span>
<a href="#l7.105"></a><span id="l7.105">      */</span>
<a href="#l7.106"></a><span id="l7.106">     onDropMessage: function(aMessage) {</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineminus">-        var newItem = createEvent();</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineplus">+        var newItem = cal.createEvent();</span>
<a href="#l7.109"></a><span id="l7.109">         itemConversion.calendarItemFromMessage(newItem, aMessage);</span>
<a href="#l7.110"></a><span id="l7.110">         createEventWithDialog(null, null, null, null, newItem);</span>
<a href="#l7.111"></a><span id="l7.111">     }</span>
<a href="#l7.112"></a><span id="l7.112"> };</span>
<a href="#l7.113"></a><span id="l7.113"> </span>
<a href="#l7.114"></a><span id="l7.114"> /**</span>
<a href="#l7.115"></a><span id="l7.115">  * calTaskButtonDNDObserver::calTaskButtonDNDObserver</span>
<a href="#l7.116"></a><span id="l7.116">  *</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineat">@@ -505,33 +505,33 @@ calTaskButtonDNDObserver.prototype = {</span>
<a href="#l7.118"></a><span id="l7.118">      * Gets called in case we're dropping an array of items</span>
<a href="#l7.119"></a><span id="l7.119">      * on the 'task mode'-button.</span>
<a href="#l7.120"></a><span id="l7.120">      *</span>
<a href="#l7.121"></a><span id="l7.121">      * @param aItems        An array of items to handle.</span>
<a href="#l7.122"></a><span id="l7.122">      */</span>
<a href="#l7.123"></a><span id="l7.123">     onDropItems: function(aItems) {</span>
<a href="#l7.124"></a><span id="l7.124">         for (var item of aItems) {</span>
<a href="#l7.125"></a><span id="l7.125">             var newItem = item;</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineminus">-            if (isEvent(item)) {</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineplus">+            if (cal.isEvent(item)) {</span>
<a href="#l7.128"></a><span id="l7.128">                 newItem = itemConversion.taskFromEvent(item);</span>
<a href="#l7.129"></a><span id="l7.129">             }</span>
<a href="#l7.130"></a><span id="l7.130">             createTodoWithDialog(null, null, null, newItem);</span>
<a href="#l7.131"></a><span id="l7.131">         }</span>
<a href="#l7.132"></a><span id="l7.132">     },</span>
<a href="#l7.133"></a><span id="l7.133"> </span>
<a href="#l7.134"></a><span id="l7.134">     /**</span>
<a href="#l7.135"></a><span id="l7.135">      * calTaskButtonDNDObserver::onDropMessage</span>
<a href="#l7.136"></a><span id="l7.136">      *</span>
<a href="#l7.137"></a><span id="l7.137">      * Gets called in case we're dropping a message</span>
<a href="#l7.138"></a><span id="l7.138">      * on the 'task mode'-button.</span>
<a href="#l7.139"></a><span id="l7.139">      *</span>
<a href="#l7.140"></a><span id="l7.140">      * @param aMessage     The message to handle.</span>
<a href="#l7.141"></a><span id="l7.141">      */</span>
<a href="#l7.142"></a><span id="l7.142">     onDropMessage: function(aMessage) {</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineminus">-        var todo = createTodo();</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineplus">+        var todo = cal.createTodo();</span>
<a href="#l7.145"></a><span id="l7.145">         itemConversion.calendarItemFromMessage(todo, aMessage);</span>
<a href="#l7.146"></a><span id="l7.146">         createTodoWithDialog(null, null, null, todo);</span>
<a href="#l7.147"></a><span id="l7.147">     }</span>
<a href="#l7.148"></a><span id="l7.148"> };</span>
<a href="#l7.149"></a><span id="l7.149"> </span>
<a href="#l7.150"></a><span id="l7.150"> /**</span>
<a href="#l7.151"></a><span id="l7.151">  * Invoke a drag session for the passed item. The passed box will be used as a</span>
<a href="#l7.152"></a><span id="l7.152">  * source.</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineat">@@ -550,25 +550,25 @@ function invokeEventDragSession(aItem, a</span>
<a href="#l7.154"></a><span id="l7.154"> </span>
<a href="#l7.155"></a><span id="l7.155">         item: aItem,</span>
<a href="#l7.156"></a><span id="l7.156">         getFlavorData: function(aInTransferable, aInFlavor, aOutData, aOutDataLen) {</span>
<a href="#l7.157"></a><span id="l7.157">             if ((aInFlavor == &quot;application/vnd.x-moz-cal-event&quot;) ||</span>
<a href="#l7.158"></a><span id="l7.158">                 (aInFlavor == &quot;application/vnd.x-moz-cal-task&quot;)) {</span>
<a href="#l7.159"></a><span id="l7.159">                 aOutData.value = aItem;</span>
<a href="#l7.160"></a><span id="l7.160">                 aOutDataLen.value = 1;</span>
<a href="#l7.161"></a><span id="l7.161">             } else {</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineminus">-                ASSERT(false, &quot;error:&quot; + aInFlavor);</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineplus">+                cal.ASSERT(false, &quot;error:&quot; + aInFlavor);</span>
<a href="#l7.164"></a><span id="l7.164">             }</span>
<a href="#l7.165"></a><span id="l7.165">         }</span>
<a href="#l7.166"></a><span id="l7.166">     };</span>
<a href="#l7.167"></a><span id="l7.167"> </span>
<a href="#l7.168"></a><span id="l7.168" class="difflineminus">-    if (isEvent(aItem)) {</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineplus">+    if (cal.isEvent(aItem)) {</span>
<a href="#l7.170"></a><span id="l7.170">       transfer.addDataFlavor(&quot;application/vnd.x-moz-cal-event&quot;);</span>
<a href="#l7.171"></a><span id="l7.171">       transfer.setTransferData(&quot;application/vnd.x-moz-cal-event&quot;, flavourProvider, 0);</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineminus">-    } else if (isToDo(aItem)) {</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineplus">+    } else if (cal.isToDo(aItem)) {</span>
<a href="#l7.174"></a><span id="l7.174">       transfer.addDataFlavor(&quot;application/vnd.x-moz-cal-task&quot;);</span>
<a href="#l7.175"></a><span id="l7.175">       transfer.setTransferData(&quot;application/vnd.x-moz-cal-task&quot;, flavourProvider, 0);</span>
<a href="#l7.176"></a><span id="l7.176">     }</span>
<a href="#l7.177"></a><span id="l7.177"> </span>
<a href="#l7.178"></a><span id="l7.178">     // Also set some normal data-types, in case we drag into another app</span>
<a href="#l7.179"></a><span id="l7.179">     let serializer = Components.classes[&quot;@mozilla.org/calendar/ics-serializer;1&quot;]</span>
<a href="#l7.180"></a><span id="l7.180">                                .createInstance(Components.interfaces.calIIcsSerializer);</span>
<a href="#l7.181"></a><span id="l7.181">     serializer.addItems([aItem], 1);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/calendar/base/content/calendar-extract.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/calendar/base/content/calendar-extract.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -186,19 +186,19 @@ var calendarExtract = {</span>
<a href="#l8.4"></a><span id="l8.4">                 }</span>
<a href="#l8.5"></a><span id="l8.5">                 if (endGuess.hour != null) {</span>
<a href="#l8.6"></a><span id="l8.6">                     dueDate.setHours(endGuess.hour);</span>
<a href="#l8.7"></a><span id="l8.7">                 }</span>
<a href="#l8.8"></a><span id="l8.8">                 if (endGuess.minute != null) {</span>
<a href="#l8.9"></a><span id="l8.9">                     dueDate.setMinutes(endGuess.minute);</span>
<a href="#l8.10"></a><span id="l8.10">                 }</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-                setItemProperty(item, &quot;entryDate&quot;, cal.jsDateToDateTime(date, dtz));</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+                cal.setItemProperty(item, &quot;entryDate&quot;, cal.jsDateToDateTime(date, dtz));</span>
<a href="#l8.14"></a><span id="l8.14">                 if (endGuess.year != null) {</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-                    setItemProperty(item, &quot;dueDate&quot;, cal.jsDateToDateTime(dueDate, dtz));</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+                    cal.setItemProperty(item, &quot;dueDate&quot;, cal.jsDateToDateTime(dueDate, dtz));</span>
<a href="#l8.17"></a><span id="l8.17">                 }</span>
<a href="#l8.18"></a><span id="l8.18">             }</span>
<a href="#l8.19"></a><span id="l8.19"> </span>
<a href="#l8.20"></a><span id="l8.20">             // if time not guessed set allday for events</span>
<a href="#l8.21"></a><span id="l8.21">             if (allDay) {</span>
<a href="#l8.22"></a><span id="l8.22">                 createEventWithDialog(null, null, null, null, item, true);</span>
<a href="#l8.23"></a><span id="l8.23">             } else {</span>
<a href="#l8.24"></a><span id="l8.24">                 createEventWithDialog(null, null, null, null, item);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/calendar/base/content/calendar-invitations-manager.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/calendar/base/content/calendar-invitations-manager.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -122,17 +122,17 @@ InvitationsManager.prototype = {</span>
<a href="#l9.4"></a><span id="l9.4">         if (operationListener2) {</span>
<a href="#l9.5"></a><span id="l9.5">             listeners.push(operationListener2);</span>
<a href="#l9.6"></a><span id="l9.6">         }</span>
<a href="#l9.7"></a><span id="l9.7"> </span>
<a href="#l9.8"></a><span id="l9.8">         gInvitationsRequestManager.cancelPendingRequests();</span>
<a href="#l9.9"></a><span id="l9.9">         this.updateStartDate();</span>
<a href="#l9.10"></a><span id="l9.10">         this.deleteAllItems();</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-        let cals = getCalendarManager().getCalendars({});</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+        let cals = cal.getCalendarManager().getCalendars({});</span>
<a href="#l9.14"></a><span id="l9.14"> </span>
<a href="#l9.15"></a><span id="l9.15">         let opListener = {</span>
<a href="#l9.16"></a><span id="l9.16">             QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l9.17"></a><span id="l9.17">             mCount: cals.length,</span>
<a href="#l9.18"></a><span id="l9.18">             mRequestManager: gInvitationsRequestManager,</span>
<a href="#l9.19"></a><span id="l9.19">             mInvitationsManager: this,</span>
<a href="#l9.20"></a><span id="l9.20">             mHandledItems: {},</span>
<a href="#l9.21"></a><span id="l9.21"> </span>
<a href="#l9.22"></a><span id="l9.22" class="difflineat">@@ -158,17 +158,17 @@ InvitationsManager.prototype = {</span>
<a href="#l9.23"></a><span id="l9.23">                                                      this.mInvitationsManager.mItemList);</span>
<a href="#l9.24"></a><span id="l9.24">                             }</span>
<a href="#l9.25"></a><span id="l9.25">                             listener.onOperationComplete(null,</span>
<a href="#l9.26"></a><span id="l9.26">                                                          Components.results.NS_OK,</span>
<a href="#l9.27"></a><span id="l9.27">                                                          Components.interfaces.calIOperationListener.GET,</span>
<a href="#l9.28"></a><span id="l9.28">                                                          null,</span>
<a href="#l9.29"></a><span id="l9.29">                                                          null);</span>
<a href="#l9.30"></a><span id="l9.30">                         } catch (exc) {</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-                            ERROR(exc);</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+                            cal.ERROR(exc);</span>
<a href="#l9.33"></a><span id="l9.33">                         }</span>
<a href="#l9.34"></a><span id="l9.34">                     }</span>
<a href="#l9.35"></a><span id="l9.35">                 }</span>
<a href="#l9.36"></a><span id="l9.36">             },</span>
<a href="#l9.37"></a><span id="l9.37"> </span>
<a href="#l9.38"></a><span id="l9.38">             onGetResult: function(aCalendar,</span>
<a href="#l9.39"></a><span id="l9.39">                                   aStatus,</span>
<a href="#l9.40"></a><span id="l9.40">                                   aItemType,</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineat">@@ -186,17 +186,17 @@ InvitationsManager.prototype = {</span>
<a href="#l9.42"></a><span id="l9.42">                             this.mInvitationsManager.addItem(item);</span>
<a href="#l9.43"></a><span id="l9.43">                         }</span>
<a href="#l9.44"></a><span id="l9.44">                     }</span>
<a href="#l9.45"></a><span id="l9.45">                 }</span>
<a href="#l9.46"></a><span id="l9.46">             }</span>
<a href="#l9.47"></a><span id="l9.47">         };</span>
<a href="#l9.48"></a><span id="l9.48"> </span>
<a href="#l9.49"></a><span id="l9.49">         for (let calendar of cals) {</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineminus">-            if (!isCalendarWritable(calendar) || calendar.getProperty(&quot;disabled&quot;)) {</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+            if (!cal.isCalendarWritable(calendar) || calendar.getProperty(&quot;disabled&quot;)) {</span>
<a href="#l9.52"></a><span id="l9.52">                 opListener.onOperationComplete();</span>
<a href="#l9.53"></a><span id="l9.53">                 continue;</span>
<a href="#l9.54"></a><span id="l9.54">             }</span>
<a href="#l9.55"></a><span id="l9.55"> </span>
<a href="#l9.56"></a><span id="l9.56">             // temporary hack unless calCachedCalendar supports REQUEST_NEEDS_ACTION filter:</span>
<a href="#l9.57"></a><span id="l9.57">             calendar = calendar.getProperty(&quot;cache.uncachedCalendar&quot;);</span>
<a href="#l9.58"></a><span id="l9.58">             if (!calendar) {</span>
<a href="#l9.59"></a><span id="l9.59">                 opListener.onOperationComplete();</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineat">@@ -213,17 +213,17 @@ InvitationsManager.prototype = {</span>
<a href="#l9.61"></a><span id="l9.61">                                                   // should be fixed with bug 416975</span>
<a href="#l9.62"></a><span id="l9.62">                                                   Components.interfaces.calICalendar.ITEM_FILTER_CLASS_OCCURRENCES,</span>
<a href="#l9.63"></a><span id="l9.63">                                                   0, this.mStartDate,</span>
<a href="#l9.64"></a><span id="l9.64">                                                   endDate /* we currently cannot pass null here, because of bug 416975 */,</span>
<a href="#l9.65"></a><span id="l9.65">                                                   opListener);</span>
<a href="#l9.66"></a><span id="l9.66">                 gInvitationsRequestManager.addRequestStatus(calendar, operation);</span>
<a href="#l9.67"></a><span id="l9.67">             } catch (exc) {</span>
<a href="#l9.68"></a><span id="l9.68">                 opListener.onOperationComplete();</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineminus">-                ERROR(exc);</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineplus">+                cal.ERROR(exc);</span>
<a href="#l9.71"></a><span id="l9.71">             }</span>
<a href="#l9.72"></a><span id="l9.72">         }</span>
<a href="#l9.73"></a><span id="l9.73">     },</span>
<a href="#l9.74"></a><span id="l9.74"> </span>
<a href="#l9.75"></a><span id="l9.75">     /**</span>
<a href="#l9.76"></a><span id="l9.76">      * Open the invitations dialog, non-modal.</span>
<a href="#l9.77"></a><span id="l9.77">      *</span>
<a href="#l9.78"></a><span id="l9.78">      * XXX Passing these listeners in instead of keeping them in the window</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineat">@@ -374,17 +374,17 @@ InvitationsManager.prototype = {</span>
<a href="#l9.80"></a><span id="l9.80"> </span>
<a href="#l9.81"></a><span id="l9.81">     /**</span>
<a href="#l9.82"></a><span id="l9.82">      * Helper function to create a start date to search from. This date is the</span>
<a href="#l9.83"></a><span id="l9.83">      * current time with hour/minute/second set to zero.</span>
<a href="#l9.84"></a><span id="l9.84">      *</span>
<a href="#l9.85"></a><span id="l9.85">      * @return      Potential start date.</span>
<a href="#l9.86"></a><span id="l9.86">      */</span>
<a href="#l9.87"></a><span id="l9.87">     getStartDate: function() {</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineminus">-        let date = now();</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineplus">+        let date = cal.now();</span>
<a href="#l9.90"></a><span id="l9.90">         date.second = 0;</span>
<a href="#l9.91"></a><span id="l9.91">         date.minute = 0;</span>
<a href="#l9.92"></a><span id="l9.92">         date.hour = 0;</span>
<a href="#l9.93"></a><span id="l9.93">         return date;</span>
<a href="#l9.94"></a><span id="l9.94">     },</span>
<a href="#l9.95"></a><span id="l9.95"> </span>
<a href="#l9.96"></a><span id="l9.96">     /**</span>
<a href="#l9.97"></a><span id="l9.97">      * Updates the start date for the invitations manager to the date returned</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineat">@@ -410,13 +410,12 @@ InvitationsManager.prototype = {</span>
<a href="#l9.99"></a><span id="l9.99">      * @param item      The item to check</span>
<a href="#l9.100"></a><span id="l9.100">      * @return          A boolean indicating if the item is a valid invitation.</span>
<a href="#l9.101"></a><span id="l9.101">      */</span>
<a href="#l9.102"></a><span id="l9.102">     validateItem: function(item) {</span>
<a href="#l9.103"></a><span id="l9.103">         if (item.calendar instanceof Components.interfaces.calISchedulingSupport &amp;&amp;</span>
<a href="#l9.104"></a><span id="l9.104">             !item.calendar.isInvitation(item)) {</span>
<a href="#l9.105"></a><span id="l9.105">             return false; // exclude if organizer has invited himself</span>
<a href="#l9.106"></a><span id="l9.106">         }</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineminus">-        let start = item[calGetStartDateProp(item)] || item[calGetEndDateProp(item)];</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineminus">-        return (cal.isOpenInvitation(item) &amp;&amp;</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineminus">-                start.compare(this.mStartDate) &gt;= 0);</span>
<a href="#l9.110"></a><span id="l9.110" class="difflineplus">+        let start = item[cal.calGetStartDateProp(item)] || item[cal.calGetEndDateProp(item)];</span>
<a href="#l9.111"></a><span id="l9.111" class="difflineplus">+        return cal.isOpenInvitation(item) &amp;&amp; start.compare(this.mStartDate) &gt;= 0;</span>
<a href="#l9.112"></a><span id="l9.112">     }</span>
<a href="#l9.113"></a><span id="l9.113"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/calendar/base/content/calendar-item-bindings.xml</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/calendar/base/content/calendar-item-bindings.xml</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -16,25 +16,30 @@</span>
<a href="#l10.4"></a><span id="l10.4">       &lt;xul:label xbl:inherits=&quot;value=label,control&quot; class=&quot;header&quot;/&gt;</span>
<a href="#l10.5"></a><span id="l10.5">       &lt;xul:separator class=&quot;groove&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l10.6"></a><span id="l10.6">     &lt;/content&gt;</span>
<a href="#l10.7"></a><span id="l10.7">   &lt;/binding&gt;</span>
<a href="#l10.8"></a><span id="l10.8"> </span>
<a href="#l10.9"></a><span id="l10.9">   &lt;binding id=&quot;item-date-row&quot; extends=&quot;xul:row&quot;&gt;</span>
<a href="#l10.10"></a><span id="l10.10">     &lt;resources&gt;</span>
<a href="#l10.11"></a><span id="l10.11">       &lt;stylesheet src=&quot;chrome://calendar/skin/calendar-event-dialog.css&quot;/&gt;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-    &lt;/resources&gt;      </span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+    &lt;/resources&gt;</span>
<a href="#l10.14"></a><span id="l10.14">     &lt;content xbl:inherits=&quot;mode&quot;&gt;</span>
<a href="#l10.15"></a><span id="l10.15">       &lt;xul:label anonid=&quot;item-datetime-label&quot;</span>
<a href="#l10.16"></a><span id="l10.16">                  class=&quot;headline&quot;</span>
<a href="#l10.17"></a><span id="l10.17">                  xbl:inherits=&quot;align&quot;/&gt;</span>
<a href="#l10.18"></a><span id="l10.18">       &lt;xul:label anonid=&quot;item-datetime-value&quot;/&gt;</span>
<a href="#l10.19"></a><span id="l10.19">     &lt;/content&gt;</span>
<a href="#l10.20"></a><span id="l10.20">     &lt;implementation&gt;</span>
<a href="#l10.21"></a><span id="l10.21">       &lt;field name=&quot;mItem&quot;&gt;null&lt;/field&gt;</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+      &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+      ]]&gt;&lt;/constructor&gt;</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineplus">+</span>
<a href="#l10.27"></a><span id="l10.27">       &lt;property name=&quot;mode&quot;</span>
<a href="#l10.28"></a><span id="l10.28">                 readonly=&quot;true&quot;&gt;</span>
<a href="#l10.29"></a><span id="l10.29">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l10.30"></a><span id="l10.30">           if (this.hasAttribute(&quot;mode&quot;)) {</span>
<a href="#l10.31"></a><span id="l10.31">               return this.getAttribute(&quot;mode&quot;);</span>
<a href="#l10.32"></a><span id="l10.32">           } else {</span>
<a href="#l10.33"></a><span id="l10.33">               return &quot;start&quot;;</span>
<a href="#l10.34"></a><span id="l10.34">           }</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineat">@@ -45,45 +50,45 @@</span>
<a href="#l10.36"></a><span id="l10.36">           return mItem;</span>
<a href="#l10.37"></a><span id="l10.37">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l10.38"></a><span id="l10.38">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l10.39"></a><span id="l10.39">           this.mItem = val;</span>
<a href="#l10.40"></a><span id="l10.40">           let headerLabel = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;item-datetime-label&quot;);</span>
<a href="#l10.41"></a><span id="l10.41">           let itemDateTimeLabel = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;item-datetime-value&quot;);</span>
<a href="#l10.42"></a><span id="l10.42">           let date;</span>
<a href="#l10.43"></a><span id="l10.43">           if (this.mode == &quot;start&quot;) {</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineminus">-              date = this.mItem[calGetStartDateProp(this.mItem)];</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+              date = this.mItem[cal.calGetStartDateProp(this.mItem)];</span>
<a href="#l10.46"></a><span id="l10.46">               if (date) {</span>
<a href="#l10.47"></a><span id="l10.47">                   let label;</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">-                  if (isToDo(this.mItem)) {</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+                  if (cal.isToDo(this.mItem)) {</span>
<a href="#l10.50"></a><span id="l10.50">                       label = this.getAttribute(&quot;taskStartLabel&quot;);</span>
<a href="#l10.51"></a><span id="l10.51">                   } else {</span>
<a href="#l10.52"></a><span id="l10.52">                       label = this.getAttribute(&quot;eventStartLabel&quot;);</span>
<a href="#l10.53"></a><span id="l10.53">                   }</span>
<a href="#l10.54"></a><span id="l10.54">                   headerLabel.value = label;</span>
<a href="#l10.55"></a><span id="l10.55">               }</span>
<a href="#l10.56"></a><span id="l10.56">           } else {</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineminus">-              date = this.mItem[calGetEndDateProp(this.mItem)];</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineplus">+              date = this.mItem[cal.calGetEndDateProp(this.mItem)];</span>
<a href="#l10.59"></a><span id="l10.59">               if (date) {</span>
<a href="#l10.60"></a><span id="l10.60">                   let label;</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineminus">-                  if (isToDo(this.mItem)) {</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineplus">+                  if (cal.isToDo(this.mItem)) {</span>
<a href="#l10.63"></a><span id="l10.63">                       label = this.getAttribute(&quot;taskDueLabel&quot;);</span>
<a href="#l10.64"></a><span id="l10.64">                   } else {</span>
<a href="#l10.65"></a><span id="l10.65">                       label = this.getAttribute(&quot;eventEndLabel&quot;);</span>
<a href="#l10.66"></a><span id="l10.66">                   }</span>
<a href="#l10.67"></a><span id="l10.67">                   headerLabel.value = label;</span>
<a href="#l10.68"></a><span id="l10.68">               }</span>
<a href="#l10.69"></a><span id="l10.69">           }</span>
<a href="#l10.70"></a><span id="l10.70">           let hideLabels = (date == null);</span>
<a href="#l10.71"></a><span id="l10.71">           if (hideLabels) {</span>
<a href="#l10.72"></a><span id="l10.72">               this.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l10.73"></a><span id="l10.73">           } else {</span>
<a href="#l10.74"></a><span id="l10.74">               const kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l10.75"></a><span id="l10.75">               let localTime = date.getInTimezone(kDefaultTimezone);</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineminus">-              let formatter = getDateFormatter();</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineplus">+              let formatter = cal.getDateFormatter();</span>
<a href="#l10.78"></a><span id="l10.78">               itemDateTimeLabel.value = formatter.formatDateTime(localTime);</span>
<a href="#l10.79"></a><span id="l10.79">               if (!date.timezone.isFloating &amp;&amp; date.timezone.tzid != kDefaultTimezone.tzid) {</span>
<a href="#l10.80"></a><span id="l10.80">                   // we additionally display the original datetime with timezone</span>
<a href="#l10.81"></a><span id="l10.81">                   let orgTime = cal.calGetString(&quot;calendar&quot;,</span>
<a href="#l10.82"></a><span id="l10.82">                                                  &quot;datetimeWithTimezone&quot;,</span>
<a href="#l10.83"></a><span id="l10.83">                                                  [formatter.formatDateTime(date),</span>
<a href="#l10.84"></a><span id="l10.84">                                                   date.timezone.tzid]);</span>
<a href="#l10.85"></a><span id="l10.85">                   itemDateTimeLabel.value += &quot; (&quot; + orgTime + &quot;)&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/calendar/base/content/calendar-item-editing.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/calendar/base/content/calendar-item-editing.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -384,55 +384,55 @@ function openEventDialog(calendarItem, c</span>
<a href="#l11.4"></a><span id="l11.4">         dlg.focus();</span>
<a href="#l11.5"></a><span id="l11.5">         disposeJob(job);</span>
<a href="#l11.6"></a><span id="l11.6">         return;</span>
<a href="#l11.7"></a><span id="l11.7">     }</span>
<a href="#l11.8"></a><span id="l11.8"> </span>
<a href="#l11.9"></a><span id="l11.9">     // Set up some defaults</span>
<a href="#l11.10"></a><span id="l11.10">     mode = mode || &quot;new&quot;;</span>
<a href="#l11.11"></a><span id="l11.11">     calendar = calendar || getSelectedCalendar();</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-    let calendars = getCalendarManager().getCalendars({});</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-    calendars = calendars.filter(isCalendarWritable);</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+    let calendars = cal.getCalendarManager().getCalendars({});</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+    calendars = calendars.filter(cal.isCalendarWritable);</span>
<a href="#l11.16"></a><span id="l11.16"> </span>
<a href="#l11.17"></a><span id="l11.17">     let isItemSupported;</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineminus">-    if (isToDo(calendarItem)) {</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+    if (cal.isToDo(calendarItem)) {</span>
<a href="#l11.20"></a><span id="l11.20">         isItemSupported = function(aCalendar) {</span>
<a href="#l11.21"></a><span id="l11.21">             return (aCalendar.getProperty(&quot;capabilities.tasks.supported&quot;) !== false);</span>
<a href="#l11.22"></a><span id="l11.22">         };</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">-    } else if (isEvent(calendarItem)) {</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+    } else if (cal.isEvent(calendarItem)) {</span>
<a href="#l11.25"></a><span id="l11.25">         isItemSupported = function(aCalendar) {</span>
<a href="#l11.26"></a><span id="l11.26">             return (aCalendar.getProperty(&quot;capabilities.events.supported&quot;) !== false);</span>
<a href="#l11.27"></a><span id="l11.27">         };</span>
<a href="#l11.28"></a><span id="l11.28">     }</span>
<a href="#l11.29"></a><span id="l11.29"> </span>
<a href="#l11.30"></a><span id="l11.30">     // Filter out calendars that don't support the given calendar item</span>
<a href="#l11.31"></a><span id="l11.31">     calendars = calendars.filter(isItemSupported);</span>
<a href="#l11.32"></a><span id="l11.32"> </span>
<a href="#l11.33"></a><span id="l11.33">     // Filter out calendar/items that we cannot write to/modify</span>
<a href="#l11.34"></a><span id="l11.34">     if (mode == &quot;new&quot;) {</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineminus">-        calendars = calendars.filter(userCanAddItemsToCalendar);</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+        calendars = calendars.filter(cal.userCanAddItemsToCalendar);</span>
<a href="#l11.37"></a><span id="l11.37">     } else { /* modify */</span>
<a href="#l11.38"></a><span id="l11.38">         calendars = calendars.filter((aCalendar) =&gt; {</span>
<a href="#l11.39"></a><span id="l11.39">             /* If the calendar is the item calendar, we check that the item</span>
<a href="#l11.40"></a><span id="l11.40">              * can be modified. If the calendar is NOT the item calendar, we</span>
<a href="#l11.41"></a><span id="l11.41">              * check that the user can remove items from that calendar and</span>
<a href="#l11.42"></a><span id="l11.42">              * add items to the current one.</span>
<a href="#l11.43"></a><span id="l11.43">              */</span>
<a href="#l11.44"></a><span id="l11.44">             let isSameCalendar = calendarItem.calendar == aCalendar;</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineminus">-            let canModify = userCanModifyItem(calendarItem);</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineminus">-            let canMoveItems = userCanDeleteItemsFromCalendar(calendarItem.calendar) &amp;&amp;</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineminus">-                               userCanAddItemsToCalendar(aCalendar);</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineplus">+            let canModify = cal.userCanModifyItem(calendarItem);</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineplus">+            let canMoveItems = cal.userCanDeleteItemsFromCalendar(calendarItem.calendar) &amp;&amp;</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineplus">+                               cal.userCanAddItemsToCalendar(aCalendar);</span>
<a href="#l11.51"></a><span id="l11.51"> </span>
<a href="#l11.52"></a><span id="l11.52">             return isSameCalendar ? canModify : canMoveItems;</span>
<a href="#l11.53"></a><span id="l11.53">         });</span>
<a href="#l11.54"></a><span id="l11.54">     }</span>
<a href="#l11.55"></a><span id="l11.55"> </span>
<a href="#l11.56"></a><span id="l11.56">     if (mode == &quot;new&quot; &amp;&amp;</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineminus">-        (!isCalendarWritable(calendar) ||</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineminus">-         !userCanAddItemsToCalendar(calendar) ||</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineplus">+        (!cal.isCalendarWritable(calendar) ||</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineplus">+         !cal.userCanAddItemsToCalendar(calendar) ||</span>
<a href="#l11.61"></a><span id="l11.61">          !isItemSupported(calendar))) {</span>
<a href="#l11.62"></a><span id="l11.62">         if (calendars.length &lt; 1) {</span>
<a href="#l11.63"></a><span id="l11.63">             // There are no writable calendars or no calendar supports the given</span>
<a href="#l11.64"></a><span id="l11.64">             // item. Don't show the dialog.</span>
<a href="#l11.65"></a><span id="l11.65">             disposeJob(job);</span>
<a href="#l11.66"></a><span id="l11.66">             return;</span>
<a href="#l11.67"></a><span id="l11.67">         } else {</span>
<a href="#l11.68"></a><span id="l11.68">             // Pick the first calendar that supports the item and is writable</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineat">@@ -448,17 +448,17 @@ function openEventDialog(calendarItem, c</span>
<a href="#l11.70"></a><span id="l11.70"> </span>
<a href="#l11.71"></a><span id="l11.71">     // Setup the window arguments</span>
<a href="#l11.72"></a><span id="l11.72">     let args = {};</span>
<a href="#l11.73"></a><span id="l11.73">     args.calendarEvent = calendarItem;</span>
<a href="#l11.74"></a><span id="l11.74">     args.calendar = calendar;</span>
<a href="#l11.75"></a><span id="l11.75">     args.mode = mode;</span>
<a href="#l11.76"></a><span id="l11.76">     args.onOk = callback;</span>
<a href="#l11.77"></a><span id="l11.77">     args.job = job;</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineminus">-    args.initialStartDateValue = initialDate || getDefaultStartDate();</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineplus">+    args.initialStartDateValue = initialDate || cal.getDefaultStartDate();</span>
<a href="#l11.80"></a><span id="l11.80">     args.counterProposal = counterProposal;</span>
<a href="#l11.81"></a><span id="l11.81">     args.inTab = Preferences.get(&quot;calendar.item.editInTab&quot;, false);</span>
<a href="#l11.82"></a><span id="l11.82">     args.useNewItemUI = Preferences.get(&quot;calendar.item.useNewItemUI&quot;, false);</span>
<a href="#l11.83"></a><span id="l11.83"> </span>
<a href="#l11.84"></a><span id="l11.84">     // this will be called if file-&gt;new has been selected from within the dialog</span>
<a href="#l11.85"></a><span id="l11.85">     args.onNewEvent = function(opcalendar) {</span>
<a href="#l11.86"></a><span id="l11.86">         createEventWithDialog(opcalendar, null, null);</span>
<a href="#l11.87"></a><span id="l11.87">     };</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineat">@@ -472,18 +472,18 @@ function openEventDialog(calendarItem, c</span>
<a href="#l11.89"></a><span id="l11.89">     // ask the provide if this item is an invitation. if this is the case</span>
<a href="#l11.90"></a><span id="l11.90">     // we'll open the summary dialog since the user is not allowed to change</span>
<a href="#l11.91"></a><span id="l11.91">     // the details of the item.</span>
<a href="#l11.92"></a><span id="l11.92">     let wrappedCalendar = cal.wrapInstance(calendar, Components.interfaces.calISchedulingSupport);</span>
<a href="#l11.93"></a><span id="l11.93">     let isInvitation = wrappedCalendar &amp;&amp; wrappedCalendar.isInvitation(calendarItem);</span>
<a href="#l11.94"></a><span id="l11.94"> </span>
<a href="#l11.95"></a><span id="l11.95">     // open the dialog modeless</span>
<a href="#l11.96"></a><span id="l11.96">     let url;</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineminus">-    let isEditable = mode == &quot;modify&quot; &amp;&amp; !isInvitation &amp;&amp; userCanModifyItem(calendarItem);</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineminus">-    if (isCalendarWritable(calendar) &amp;&amp; (mode == &quot;new&quot; || isEditable)) {</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineplus">+    let isEditable = mode == &quot;modify&quot; &amp;&amp; !isInvitation &amp;&amp; cal.userCanModifyItem(calendarItem);</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineplus">+    if (cal.isCalendarWritable(calendar) &amp;&amp; (mode == &quot;new&quot; || isEditable)) {</span>
<a href="#l11.101"></a><span id="l11.101">         if (args.inTab) {</span>
<a href="#l11.102"></a><span id="l11.102">             url = args.useNewItemUI ? &quot;chrome://lightning/content/html-item-editing/lightning-item-iframe.html&quot;</span>
<a href="#l11.103"></a><span id="l11.103">                                     : &quot;chrome://lightning/content/lightning-item-iframe.xul&quot;;</span>
<a href="#l11.104"></a><span id="l11.104">         } else {</span>
<a href="#l11.105"></a><span id="l11.105">             url = &quot;chrome://calendar/content/calendar-event-dialog.xul&quot;;</span>
<a href="#l11.106"></a><span id="l11.106">         }</span>
<a href="#l11.107"></a><span id="l11.107">     } else {</span>
<a href="#l11.108"></a><span id="l11.108">         url = &quot;chrome://calendar/content/calendar-summary-dialog.xul&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/calendar/base/content/calendar-management.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/calendar/base/content/calendar-management.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -112,17 +112,17 @@ function loadCalendarManager() {</span>
<a href="#l12.4"></a><span id="l12.4"> /**</span>
<a href="#l12.5"></a><span id="l12.5">  * Creates the initial &quot;Home&quot; calendar if no calendar exists.</span>
<a href="#l12.6"></a><span id="l12.6">  */</span>
<a href="#l12.7"></a><span id="l12.7"> function initHomeCalendar() {</span>
<a href="#l12.8"></a><span id="l12.8">     let calMgr = cal.getCalendarManager();</span>
<a href="#l12.9"></a><span id="l12.9">     let composite = cal.getCompositeCalendar(window);</span>
<a href="#l12.10"></a><span id="l12.10">     let url = cal.makeURL(&quot;moz-storage-calendar://&quot;);</span>
<a href="#l12.11"></a><span id="l12.11">     let homeCalendar = calMgr.createCalendar(&quot;storage&quot;, url);</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-    homeCalendar.name = calGetString(&quot;calendar&quot;, &quot;homeCalendarName&quot;);</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+    homeCalendar.name = cal.calGetString(&quot;calendar&quot;, &quot;homeCalendarName&quot;);</span>
<a href="#l12.14"></a><span id="l12.14">     calMgr.registerCalendar(homeCalendar);</span>
<a href="#l12.15"></a><span id="l12.15">     Preferences.set(&quot;calendar.list.sortOrder&quot;, homeCalendar.id);</span>
<a href="#l12.16"></a><span id="l12.16">     composite.addCalendar(homeCalendar);</span>
<a href="#l12.17"></a><span id="l12.17"> </span>
<a href="#l12.18"></a><span id="l12.18">     // Wrapping this in a try/catch block, as if any of the migration code</span>
<a href="#l12.19"></a><span id="l12.19">     // fails, the app may not load.</span>
<a href="#l12.20"></a><span id="l12.20">     if (Preferences.get(&quot;calendar.migrator.enabled&quot;, true)) {</span>
<a href="#l12.21"></a><span id="l12.21">         try {</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineat">@@ -168,36 +168,36 @@ function updateSortOrderPref(event) {</span>
<a href="#l12.23"></a><span id="l12.23">  */</span>
<a href="#l12.24"></a><span id="l12.24"> function calendarListTooltipShowing(event) {</span>
<a href="#l12.25"></a><span id="l12.25">     let tree = document.getElementById(&quot;calendar-list-tree-widget&quot;);</span>
<a href="#l12.26"></a><span id="l12.26">     let calendar = tree.getCalendarFromEvent(event);</span>
<a href="#l12.27"></a><span id="l12.27">     let tooltipText = false;</span>
<a href="#l12.28"></a><span id="l12.28">     if (calendar) {</span>
<a href="#l12.29"></a><span id="l12.29">         let currentStatus = calendar.getProperty(&quot;currentStatus&quot;);</span>
<a href="#l12.30"></a><span id="l12.30">         if (!Components.isSuccessCode(currentStatus)) {</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineminus">-            tooltipText = calGetString(&quot;calendar&quot;, &quot;tooltipCalendarDisabled&quot;, [calendar.name]);</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+            tooltipText = cal.calGetString(&quot;calendar&quot;, &quot;tooltipCalendarDisabled&quot;, [calendar.name]);</span>
<a href="#l12.33"></a><span id="l12.33">         } else if (calendar.readOnly) {</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineminus">-            tooltipText = calGetString(&quot;calendar&quot;, &quot;tooltipCalendarReadOnly&quot;, [calendar.name]);</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+            tooltipText = cal.calGetString(&quot;calendar&quot;, &quot;tooltipCalendarReadOnly&quot;, [calendar.name]);</span>
<a href="#l12.36"></a><span id="l12.36">         }</span>
<a href="#l12.37"></a><span id="l12.37">     }</span>
<a href="#l12.38"></a><span id="l12.38">     setElementValue(&quot;calendar-list-tooltip&quot;, tooltipText, &quot;label&quot;);</span>
<a href="#l12.39"></a><span id="l12.39">     return (tooltipText != false);</span>
<a href="#l12.40"></a><span id="l12.40"> }</span>
<a href="#l12.41"></a><span id="l12.41"> </span>
<a href="#l12.42"></a><span id="l12.42"> /**</span>
<a href="#l12.43"></a><span id="l12.43">  * A handler called to set up the context menu on the calendar list.</span>
<a href="#l12.44"></a><span id="l12.44">  *</span>
<a href="#l12.45"></a><span id="l12.45">  * @param event         The DOM event that caused the context menu to open.</span>
<a href="#l12.46"></a><span id="l12.46">  * @return              Returns true if the context menu should be shown.</span>
<a href="#l12.47"></a><span id="l12.47">  */</span>
<a href="#l12.48"></a><span id="l12.48"> function calendarListSetupContextMenu(event) {</span>
<a href="#l12.49"></a><span id="l12.49">     let col = {};</span>
<a href="#l12.50"></a><span id="l12.50">     let row = {};</span>
<a href="#l12.51"></a><span id="l12.51">     let calendar;</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineminus">-    let calendars = getCalendarManager().getCalendars({});</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineplus">+    let calendars = cal.getCalendarManager().getCalendars({});</span>
<a href="#l12.54"></a><span id="l12.54">     let treeNode = document.getElementById(&quot;calendar-list-tree-widget&quot;);</span>
<a href="#l12.55"></a><span id="l12.55">     let composite = cal.getCompositeCalendar(window);</span>
<a href="#l12.56"></a><span id="l12.56"> </span>
<a href="#l12.57"></a><span id="l12.57">     if (document.popupNode.localName == &quot;tree&quot;) {</span>
<a href="#l12.58"></a><span id="l12.58">         // Using VK_APPS to open the context menu will target the tree</span>
<a href="#l12.59"></a><span id="l12.59">         // itself. In that case we won't have a client point even for</span>
<a href="#l12.60"></a><span id="l12.60">         // opening the context menu. The &quot;target&quot; element should then be the</span>
<a href="#l12.61"></a><span id="l12.61">         // selected calendar.</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineat">@@ -214,17 +214,17 @@ function calendarListSetupContextMenu(ev</span>
<a href="#l12.63"></a><span id="l12.63">         col.value.element.getAttribute(&quot;anonid&quot;) == &quot;checkbox-treecol&quot;) {</span>
<a href="#l12.64"></a><span id="l12.64">         // Don't show the context menu if the checkbox was clicked.</span>
<a href="#l12.65"></a><span id="l12.65">         return false;</span>
<a href="#l12.66"></a><span id="l12.66">     }</span>
<a href="#l12.67"></a><span id="l12.67"> </span>
<a href="#l12.68"></a><span id="l12.68">     document.getElementById(&quot;list-calendars-context-menu&quot;).contextCalendar = calendar;</span>
<a href="#l12.69"></a><span id="l12.69"> </span>
<a href="#l12.70"></a><span id="l12.70">     // Only enable calendar search if there's actually the chance of finding something:</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineminus">-    let hasProviders = getCalendarSearchService().getProviders({}).length &lt; 1 &amp;&amp; &quot;true&quot;;</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineplus">+    let hasProviders = cal.getCalendarSearchService().getProviders({}).length &lt; 1 &amp;&amp; &quot;true&quot;;</span>
<a href="#l12.73"></a><span id="l12.73">     setElementValue(&quot;list-calendars-context-find&quot;, hasProviders, &quot;collapsed&quot;);</span>
<a href="#l12.74"></a><span id="l12.74"> </span>
<a href="#l12.75"></a><span id="l12.75">     if (calendar) {</span>
<a href="#l12.76"></a><span id="l12.76">         enableElement(&quot;list-calendars-context-edit&quot;);</span>
<a href="#l12.77"></a><span id="l12.77">         enableElement(&quot;list-calendars-context-publish&quot;);</span>
<a href="#l12.78"></a><span id="l12.78"> </span>
<a href="#l12.79"></a><span id="l12.79">         enableElement(&quot;list-calendars-context-togglevisible&quot;);</span>
<a href="#l12.80"></a><span id="l12.80">         setElementValue(&quot;list-calendars-context-togglevisible&quot;, false, &quot;collapsed&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/calendar/base/content/calendar-menus.xml</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/calendar/base/content/calendar-menus.xml</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -12,18 +12,20 @@</span>
<a href="#l13.4"></a><span id="l13.4"> </span>
<a href="#l13.5"></a><span id="l13.5">   &lt;binding id=&quot;task-menupopup&quot; extends=&quot;xul:menupopup&quot;&gt;</span>
<a href="#l13.6"></a><span id="l13.6">     &lt;implementation&gt;</span>
<a href="#l13.7"></a><span id="l13.7">       &lt;field name=&quot;mType&quot;&gt;null&lt;/field&gt;;</span>
<a href="#l13.8"></a><span id="l13.8">       &lt;field name=&quot;mPopupHandler&quot;&gt;null&lt;/field&gt;</span>
<a href="#l13.9"></a><span id="l13.9">       &lt;field name=&quot;mParentMenuPopup&quot;&gt;null&lt;/field&gt;</span>
<a href="#l13.10"></a><span id="l13.10"> </span>
<a href="#l13.11"></a><span id="l13.11">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+</span>
<a href="#l13.14"></a><span id="l13.14">         this.mPopupHandler = () =&gt; { this.schangeMenuByPropertyName(); };</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineminus">-        this.mParentMenuPopup = getParentNodeOrThis(this, &quot;menupopup&quot;);</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+        this.mParentMenuPopup = cal.getParentNodeOrThis(this, &quot;menupopup&quot;);</span>
<a href="#l13.17"></a><span id="l13.17">         this.mParentMenuPopup.addEventListener(&quot;popupshowing&quot;, this.mPopupHandler, true);</span>
<a href="#l13.18"></a><span id="l13.18">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l13.19"></a><span id="l13.19"> </span>
<a href="#l13.20"></a><span id="l13.20">       &lt;destructor&gt;&lt;![CDATA[</span>
<a href="#l13.21"></a><span id="l13.21">         this.mParentMenuPopup.removeEventListener(&quot;popupshowing&quot;, this.mPopupHandler, true);</span>
<a href="#l13.22"></a><span id="l13.22">       ]]&gt;&lt;/destructor&gt;</span>
<a href="#l13.23"></a><span id="l13.23"> </span>
<a href="#l13.24"></a><span id="l13.24">       &lt;!-- This method checks a command which naming follows</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineat">@@ -46,21 +48,21 @@</span>
<a href="#l13.26"></a><span id="l13.26">               // We are in a task tab (editing a single task).</span>
<a href="#l13.27"></a><span id="l13.27">               propertyValue = gConfig[this.mType];</span>
<a href="#l13.28"></a><span id="l13.28">           } else {</span>
<a href="#l13.29"></a><span id="l13.29">               // We are in the Tasks tab.</span>
<a href="#l13.30"></a><span id="l13.30">               let tasks = getSelectedTasks();</span>
<a href="#l13.31"></a><span id="l13.31">               let tasksSelected = (tasks != null) &amp;&amp; (tasks.length &gt; 0);</span>
<a href="#l13.32"></a><span id="l13.32">               if (tasksSelected) {</span>
<a href="#l13.33"></a><span id="l13.33">                   let task = tasks[0];</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineminus">-                  if (isPropertyValueSame(tasks, this.mType)) {</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+                  if (cal.isPropertyValueSame(tasks, this.mType)) {</span>
<a href="#l13.36"></a><span id="l13.36">                       propertyValue = task[this.mType];</span>
<a href="#l13.37"></a><span id="l13.37">                   }</span>
<a href="#l13.38"></a><span id="l13.38">               } else {</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineminus">-                  applyAttributeToMenuChildren(this, &quot;disabled&quot;, !tasksSelected);</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineplus">+                  cal.applyAttributeToMenuChildren(this, &quot;disabled&quot;, !tasksSelected);</span>
<a href="#l13.41"></a><span id="l13.41">               }</span>
<a href="#l13.42"></a><span id="l13.42">           }</span>
<a href="#l13.43"></a><span id="l13.43">           if (propertyValue || propertyValue == 0) {</span>
<a href="#l13.44"></a><span id="l13.44">               let command = document.getElementById(&quot;calendar_&quot; + this.mType + &quot;-&quot; + propertyValue + &quot;_command&quot;);</span>
<a href="#l13.45"></a><span id="l13.45">               if (command) {</span>
<a href="#l13.46"></a><span id="l13.46">                   command.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l13.47"></a><span id="l13.47">               }</span>
<a href="#l13.48"></a><span id="l13.48">           }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/calendar/base/content/calendar-month-view.xml</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/calendar/base/content/calendar-month-view.xml</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -1,15 +1,13 @@</span>
<a href="#l14.4"></a><span id="l14.4"> &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<a href="#l14.5"></a><span id="l14.5"> &lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l14.6"></a><span id="l14.6">    - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l14.7"></a><span id="l14.7">    - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l14.8"></a><span id="l14.8"> </span>
<a href="#l14.9"></a><span id="l14.9" class="difflineminus">-&lt;!-- Note that this file depends on helper functions in calUtils.js--&gt;</span>
<a href="#l14.10"></a><span id="l14.10" class="difflineminus">-</span>
<a href="#l14.11"></a><span id="l14.11"> &lt;!DOCTYPE bindings SYSTEM &quot;chrome://global/locale/global.dtd&quot; &gt;</span>
<a href="#l14.12"></a><span id="l14.12"> </span>
<a href="#l14.13"></a><span id="l14.13"> &lt;bindings id=&quot;calendar-month-view-bindings&quot;</span>
<a href="#l14.14"></a><span id="l14.14">           xmlns=&quot;http://www.mozilla.org/xbl&quot;</span>
<a href="#l14.15"></a><span id="l14.15">           xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;</span>
<a href="#l14.16"></a><span id="l14.16">           xmlns:xul=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l14.17"></a><span id="l14.17">           xmlns:xbl=&quot;http://www.mozilla.org/xbl&quot;&gt;</span>
<a href="#l14.18"></a><span id="l14.18"> </span>
<a href="#l14.19"></a><span id="l14.19" class="difflineat">@@ -66,31 +64,35 @@</span>
<a href="#l14.20"></a><span id="l14.20">                 &lt;/xul:hbox&gt;</span>
<a href="#l14.21"></a><span id="l14.21">               &lt;/xul:stack&gt;</span>
<a href="#l14.22"></a><span id="l14.22">             &lt;/xul:box&gt;</span>
<a href="#l14.23"></a><span id="l14.23">           &lt;/xul:box&gt;</span>
<a href="#l14.24"></a><span id="l14.24">         &lt;/xul:hbox&gt;</span>
<a href="#l14.25"></a><span id="l14.25">       &lt;/xul:vbox&gt;</span>
<a href="#l14.26"></a><span id="l14.26">     &lt;/content&gt;</span>
<a href="#l14.27"></a><span id="l14.27">     &lt;implementation&gt;</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineplus">+      &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineplus">+        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+      ]]&gt;&lt;/constructor&gt;</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+</span>
<a href="#l14.32"></a><span id="l14.32">       &lt;property name=&quot;occurrence&quot;&gt;</span>
<a href="#l14.33"></a><span id="l14.33">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l14.34"></a><span id="l14.34">           return this.mOccurrence;</span>
<a href="#l14.35"></a><span id="l14.35">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l14.36"></a><span id="l14.36">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineminus">-          ASSERT(!this.mOccurrence, &quot;Code changes needed to set the occurrence twice&quot;, true);</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+          cal.ASSERT(!this.mOccurrence, &quot;Code changes needed to set the occurrence twice&quot;, true);</span>
<a href="#l14.39"></a><span id="l14.39">           this.mOccurrence = val;</span>
<a href="#l14.40"></a><span id="l14.40">           if (cal.isEvent(val)) {</span>
<a href="#l14.41"></a><span id="l14.41">               if (!val.startDate.isDate) {</span>
<a href="#l14.42"></a><span id="l14.42">                   let label = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;item-label&quot;);</span>
<a href="#l14.43"></a><span id="l14.43">                   let formatter = Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l14.44"></a><span id="l14.44">                                             .getService(Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l14.45"></a><span id="l14.45">                   let timezone = this.calendarView ? this.calendarView.mTimezone</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineminus">-                                                   : calendarDefaultTimezone();</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineminus">-                  let parentDate = ensureDateTime(this.parentBox.date);</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+                                                   : cal.calendarDefaultTimezone();</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+                  let parentDate = cal.ensureDateTime(this.parentBox.date);</span>
<a href="#l14.50"></a><span id="l14.50">                   let startTime = val.startDate.getInTimezone(timezone);</span>
<a href="#l14.51"></a><span id="l14.51">                   let endTime = val.endDate.getInTimezone(timezone);</span>
<a href="#l14.52"></a><span id="l14.52">                   let nextDay = parentDate.clone();</span>
<a href="#l14.53"></a><span id="l14.53">                   nextDay.day++;</span>
<a href="#l14.54"></a><span id="l14.54">                   let comp = endTime.compare(nextDay);</span>
<a href="#l14.55"></a><span id="l14.55">                   if (startTime.compare(parentDate) == -1) {</span>
<a href="#l14.56"></a><span id="l14.56">                       if (comp == 1) {</span>
<a href="#l14.57"></a><span id="l14.57">                           label.value = &quot;&quot;;</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineat">@@ -133,16 +135,20 @@</span>
<a href="#l14.59"></a><span id="l14.59">                    xbl:inherits=&quot;relation,selected,value&quot;/&gt;</span>
<a href="#l14.60"></a><span id="l14.60">       &lt;/xul:hbox&gt;</span>
<a href="#l14.61"></a><span id="l14.61">       &lt;xul:vbox anonid=&quot;day-items&quot; class=&quot;calendar-month-day-box-items-box&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l14.62"></a><span id="l14.62">         &lt;children/&gt;</span>
<a href="#l14.63"></a><span id="l14.63">       &lt;/xul:vbox&gt;</span>
<a href="#l14.64"></a><span id="l14.64">     &lt;/content&gt;</span>
<a href="#l14.65"></a><span id="l14.65"> </span>
<a href="#l14.66"></a><span id="l14.66">     &lt;implementation&gt;</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineplus">+      &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineplus">+        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineplus">+      ]]&gt;&lt;/constructor&gt;</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+</span>
<a href="#l14.71"></a><span id="l14.71">       &lt;field name=&quot;mDate&quot;&gt;null&lt;/field&gt;</span>
<a href="#l14.72"></a><span id="l14.72">       &lt;field name=&quot;mItemHash&quot;&gt;{}&lt;/field&gt;</span>
<a href="#l14.73"></a><span id="l14.73">       &lt;field name=&quot;mShowMonthLabel&quot;&gt;false&lt;/field&gt;</span>
<a href="#l14.74"></a><span id="l14.74"> </span>
<a href="#l14.75"></a><span id="l14.75">       &lt;property name=&quot;date&quot;</span>
<a href="#l14.76"></a><span id="l14.76">                 onget=&quot;return this.mDate&quot;</span>
<a href="#l14.77"></a><span id="l14.77">                 onset=&quot;this.setDate(val); return val;&quot;/&gt;</span>
<a href="#l14.78"></a><span id="l14.78"> </span>
<a href="#l14.79"></a><span id="l14.79" class="difflineat">@@ -178,17 +184,17 @@</span>
<a href="#l14.80"></a><span id="l14.80">               return val;</span>
<a href="#l14.81"></a><span id="l14.81">           }</span>
<a href="#l14.82"></a><span id="l14.82">           this.mShowMonthLabel = val;</span>
<a href="#l14.83"></a><span id="l14.83"> </span>
<a href="#l14.84"></a><span id="l14.84">           if (!this.mDate) {</span>
<a href="#l14.85"></a><span id="l14.85">               return val;</span>
<a href="#l14.86"></a><span id="l14.86">           }</span>
<a href="#l14.87"></a><span id="l14.87">           if (val) {</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineminus">-              this.setAttribute(&quot;value&quot;, getDateFormatter().formatDateWithoutYear(this.mDate));</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineplus">+              this.setAttribute(&quot;value&quot;, cal.getDateFormatter().formatDateWithoutYear(this.mDate));</span>
<a href="#l14.90"></a><span id="l14.90">           } else {</span>
<a href="#l14.91"></a><span id="l14.91">               this.setAttribute(&quot;value&quot;, this.mDate.day);</span>
<a href="#l14.92"></a><span id="l14.92">           }</span>
<a href="#l14.93"></a><span id="l14.93">           return val;</span>
<a href="#l14.94"></a><span id="l14.94">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l14.95"></a><span id="l14.95">       &lt;/property&gt;</span>
<a href="#l14.96"></a><span id="l14.96"> </span>
<a href="#l14.97"></a><span id="l14.97">       &lt;method name=&quot;setDate&quot;&gt;</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineat">@@ -211,17 +217,17 @@</span>
<a href="#l14.99"></a><span id="l14.99">           // Set up DOM attributes for custom CSS coloring.</span>
<a href="#l14.100"></a><span id="l14.100">           let weekTitle = cal.getWeekInfoService().getWeekTitle(aDate);</span>
<a href="#l14.101"></a><span id="l14.101">           this.setAttribute(&quot;year&quot;, aDate.year);</span>
<a href="#l14.102"></a><span id="l14.102">           this.setAttribute(&quot;month&quot;, aDate.month + 1);</span>
<a href="#l14.103"></a><span id="l14.103">           this.setAttribute(&quot;week&quot;, weekTitle);</span>
<a href="#l14.104"></a><span id="l14.104">           this.setAttribute(&quot;day&quot;, aDate.day);</span>
<a href="#l14.105"></a><span id="l14.105"> </span>
<a href="#l14.106"></a><span id="l14.106">           if (this.mShowMonthLabel) {</span>
<a href="#l14.107"></a><span id="l14.107" class="difflineminus">-              let monthName = calGetString(&quot;dateFormat&quot;, &quot;month.&quot; + (aDate.month + 1) + &quot;.Mmm&quot;);</span>
<a href="#l14.108"></a><span id="l14.108" class="difflineplus">+              let monthName = cal.calGetString(&quot;dateFormat&quot;, &quot;month.&quot; + (aDate.month + 1) + &quot;.Mmm&quot;);</span>
<a href="#l14.109"></a><span id="l14.109">               this.setAttribute(&quot;value&quot;, aDate.day + &quot; &quot; + monthName);</span>
<a href="#l14.110"></a><span id="l14.110">           } else {</span>
<a href="#l14.111"></a><span id="l14.111">               this.setAttribute(&quot;value&quot;, aDate.day);</span>
<a href="#l14.112"></a><span id="l14.112">           }</span>
<a href="#l14.113"></a><span id="l14.113">         ]]&gt;&lt;/body&gt;</span>
<a href="#l14.114"></a><span id="l14.114">       &lt;/method&gt;</span>
<a href="#l14.115"></a><span id="l14.115"> </span>
<a href="#l14.116"></a><span id="l14.116">       &lt;method name=&quot;addItem&quot;&gt;</span>
<a href="#l14.117"></a><span id="l14.117" class="difflineat">@@ -282,18 +288,18 @@</span>
<a href="#l14.118"></a><span id="l14.118">       &lt;method name=&quot;onDropItem&quot;&gt;</span>
<a href="#l14.119"></a><span id="l14.119">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l14.120"></a><span id="l14.120">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l14.121"></a><span id="l14.121">           // When item's timezone is different than the default one, the</span>
<a href="#l14.122"></a><span id="l14.122">           // item might get moved on a day different than the drop day.</span>
<a href="#l14.123"></a><span id="l14.123">           // Changing the drop day allows to compensate a possible difference.</span>
<a href="#l14.124"></a><span id="l14.124"> </span>
<a href="#l14.125"></a><span id="l14.125">           // Figure out if the timezones cause a days difference.</span>
<a href="#l14.126"></a><span id="l14.126" class="difflineminus">-          let start = (aItem[calGetStartDateProp(aItem)] ||</span>
<a href="#l14.127"></a><span id="l14.127" class="difflineminus">-                       aItem[calGetEndDateProp(aItem)]).clone();</span>
<a href="#l14.128"></a><span id="l14.128" class="difflineplus">+          let start = (aItem[cal.calGetStartDateProp(aItem)] ||</span>
<a href="#l14.129"></a><span id="l14.129" class="difflineplus">+                       aItem[cal.calGetEndDateProp(aItem)]).clone();</span>
<a href="#l14.130"></a><span id="l14.130">           let dayboxDate = this.mDate.clone();</span>
<a href="#l14.131"></a><span id="l14.131">           if (start.timezone != dayboxDate.timezone) {</span>
<a href="#l14.132"></a><span id="l14.132">               let startInDefaultTz = start.clone().getInTimezone(dayboxDate.timezone);</span>
<a href="#l14.133"></a><span id="l14.133">               start.isDate = true;</span>
<a href="#l14.134"></a><span id="l14.134">               startInDefaultTz.isDate = true;</span>
<a href="#l14.135"></a><span id="l14.135">               startInDefaultTz.timezone = start.timezone;</span>
<a href="#l14.136"></a><span id="l14.136">               let dayDiff = start.subtractDate(startInDefaultTz);</span>
<a href="#l14.137"></a><span id="l14.137">               // Change the day where to drop the item.</span>
<a href="#l14.138"></a><span id="l14.138" class="difflineat">@@ -317,17 +323,17 @@</span>
<a href="#l14.139"></a><span id="l14.139">         this.calendarView.controller.createNewEvent();</span>
<a href="#l14.140"></a><span id="l14.140">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l14.141"></a><span id="l14.141">       &lt;handler event=&quot;click&quot; button=&quot;0&quot;&gt;&lt;![CDATA[</span>
<a href="#l14.142"></a><span id="l14.142">         if (!(event.ctrlKey || event.metaKey)) {</span>
<a href="#l14.143"></a><span id="l14.143">             this.calendarView.setSelectedItems(0, []);</span>
<a href="#l14.144"></a><span id="l14.144">         }</span>
<a href="#l14.145"></a><span id="l14.145">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l14.146"></a><span id="l14.146">       &lt;handler event=&quot;wheel&quot;&gt;&lt;![CDATA[</span>
<a href="#l14.147"></a><span id="l14.147" class="difflineminus">-        if (getParentNodeOrThisByAttribute(event.originalTarget, &quot;anonid&quot;, &quot;day-label&quot;) == null) {</span>
<a href="#l14.148"></a><span id="l14.148" class="difflineplus">+        if (cal.getParentNodeOrThisByAttribute(event.originalTarget, &quot;anonid&quot;, &quot;day-label&quot;) == null) {</span>
<a href="#l14.149"></a><span id="l14.149">             if (this.dayitems.scrollHeight &gt; this.dayitems.clientHeight) {</span>
<a href="#l14.150"></a><span id="l14.150">                 event.stopPropagation();</span>
<a href="#l14.151"></a><span id="l14.151">             }</span>
<a href="#l14.152"></a><span id="l14.152">         }</span>
<a href="#l14.153"></a><span id="l14.153">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l14.154"></a><span id="l14.154">     &lt;/handlers&gt;</span>
<a href="#l14.155"></a><span id="l14.155">   &lt;/binding&gt;</span>
<a href="#l14.156"></a><span id="l14.156"> </span>
<a href="#l14.157"></a><span id="l14.157" class="difflineat">@@ -408,16 +414,17 @@</span>
<a href="#l14.158"></a><span id="l14.158">         &lt;/xul:grid&gt;</span>
<a href="#l14.159"></a><span id="l14.159">       &lt;/xul:vbox&gt;</span>
<a href="#l14.160"></a><span id="l14.160">     &lt;/content&gt;</span>
<a href="#l14.161"></a><span id="l14.161"> </span>
<a href="#l14.162"></a><span id="l14.162">     &lt;implementation implements=&quot;calICalendarView&quot;&gt;</span>
<a href="#l14.163"></a><span id="l14.163">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l14.164"></a><span id="l14.164">         Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l14.165"></a><span id="l14.165">         Components.utils.import(&quot;resource://calendar/modules/calViewUtils.jsm&quot;);</span>
<a href="#l14.166"></a><span id="l14.166" class="difflineplus">+        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l14.167"></a><span id="l14.167"> </span>
<a href="#l14.168"></a><span id="l14.168">         // Set the preference for the default start of the week</span>
<a href="#l14.169"></a><span id="l14.169">         this.weekStartOffset = Preferences.get(&quot;calendar.week.start&quot;, 0);</span>
<a href="#l14.170"></a><span id="l14.170"> </span>
<a href="#l14.171"></a><span id="l14.171">         for (let i = 0; i &lt; 7; i++) {</span>
<a href="#l14.172"></a><span id="l14.172">             let hdr = createXULElement(&quot;calendar-day-label&quot;);</span>
<a href="#l14.173"></a><span id="l14.173">             this.labeldaybox.appendChild(hdr);</span>
<a href="#l14.174"></a><span id="l14.174">             hdr.weekDay = (i + this.mWeekStartOffset) % 7;</span>
<a href="#l14.175"></a><span id="l14.175" class="difflineat">@@ -597,17 +604,17 @@</span>
<a href="#l14.176"></a><span id="l14.176">           }</span>
<a href="#l14.177"></a><span id="l14.177">           this.fireEvent(&quot;dayselect&quot;, realVal);</span>
<a href="#l14.178"></a><span id="l14.178">           return val;</span>
<a href="#l14.179"></a><span id="l14.179">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l14.180"></a><span id="l14.180">       &lt;/property&gt;</span>
<a href="#l14.181"></a><span id="l14.181"> </span>
<a href="#l14.182"></a><span id="l14.182">       &lt;property name=&quot;selectedDateTime&quot;&gt;</span>
<a href="#l14.183"></a><span id="l14.183">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l14.184"></a><span id="l14.184" class="difflineminus">-            return getDefaultStartDate(this.selectedDay);</span>
<a href="#l14.185"></a><span id="l14.185" class="difflineplus">+            return cal.getDefaultStartDate(this.selectedDay);</span>
<a href="#l14.186"></a><span id="l14.186">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l14.187"></a><span id="l14.187">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l14.188"></a><span id="l14.188">             this.mClickedTime = val;</span>
<a href="#l14.189"></a><span id="l14.189">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l14.190"></a><span id="l14.190">       &lt;/property&gt;</span>
<a href="#l14.191"></a><span id="l14.191"> </span>
<a href="#l14.192"></a><span id="l14.192">       &lt;method name=&quot;showDate&quot;&gt;</span>
<a href="#l14.193"></a><span id="l14.193">         &lt;parameter name=&quot;aDate&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/calendar/base/content/calendar-multiday-view.xml</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/calendar/base/content/calendar-multiday-view.xml</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -1,15 +1,13 @@</span>
<a href="#l15.4"></a><span id="l15.4"> &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<a href="#l15.5"></a><span id="l15.5"> &lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l15.6"></a><span id="l15.6">    - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l15.7"></a><span id="l15.7">    - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l15.8"></a><span id="l15.8"> </span>
<a href="#l15.9"></a><span id="l15.9" class="difflineminus">-&lt;!-- Note that this file depends on helper functions in calUtils.js--&gt;</span>
<a href="#l15.10"></a><span id="l15.10" class="difflineminus">-</span>
<a href="#l15.11"></a><span id="l15.11"> &lt;!DOCTYPE bindings SYSTEM &quot;chrome://global/locale/global.dtd&quot; &gt;</span>
<a href="#l15.12"></a><span id="l15.12"> </span>
<a href="#l15.13"></a><span id="l15.13"> &lt;bindings id=&quot;calendar-multiday-view-bindings&quot;</span>
<a href="#l15.14"></a><span id="l15.14">   xmlns=&quot;http://www.mozilla.org/xbl&quot;</span>
<a href="#l15.15"></a><span id="l15.15">   xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;</span>
<a href="#l15.16"></a><span id="l15.16">   xmlns:xul=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l15.17"></a><span id="l15.17">   xmlns:xbl=&quot;http://www.mozilla.org/xbl&quot;&gt;</span>
<a href="#l15.18"></a><span id="l15.18"> </span>
<a href="#l15.19"></a><span id="l15.19" class="difflineat">@@ -241,18 +239,20 @@</span>
<a href="#l15.20"></a><span id="l15.20">           &lt;xul:label anonid=&quot;fgdragbox-endlabel&quot; class=&quot;fgdragbox-label&quot;/&gt;</span>
<a href="#l15.21"></a><span id="l15.21">         &lt;/xul:box&gt;</span>
<a href="#l15.22"></a><span id="l15.22">       &lt;/xul:stack&gt;</span>
<a href="#l15.23"></a><span id="l15.23">       &lt;xul:calendar-event-box anonid=&quot;config-box&quot; hidden=&quot;true&quot; xbl:inherits=&quot;orient&quot;/&gt;</span>
<a href="#l15.24"></a><span id="l15.24">     &lt;/content&gt;</span>
<a href="#l15.25"></a><span id="l15.25"> </span>
<a href="#l15.26"></a><span id="l15.26">     &lt;implementation&gt;</span>
<a href="#l15.27"></a><span id="l15.27">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineplus">+        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineplus">+</span>
<a href="#l15.30"></a><span id="l15.30">         this.mEventInfos = [];</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineminus">-        this.mTimezone = UTC();</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+        this.mTimezone = cal.UTC();</span>
<a href="#l15.33"></a><span id="l15.33">         this.mSelectedItemIds = {};</span>
<a href="#l15.34"></a><span id="l15.34">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l15.35"></a><span id="l15.35"> </span>
<a href="#l15.36"></a><span id="l15.36">       &lt;!-- fields --&gt;</span>
<a href="#l15.37"></a><span id="l15.37">       &lt;field name=&quot;mPixPerMin&quot;&gt;0.6&lt;/field&gt;</span>
<a href="#l15.38"></a><span id="l15.38">       &lt;field name=&quot;mStartMin&quot;&gt;0&lt;/field&gt;</span>
<a href="#l15.39"></a><span id="l15.39">       &lt;field name=&quot;mEndMin&quot;&gt;24 * 60&lt;/field&gt;</span>
<a href="#l15.40"></a><span id="l15.40">       &lt;field name=&quot;mDayStartMin&quot;&gt;8 * 60&lt;/field&gt;</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineat">@@ -328,17 +328,17 @@</span>
<a href="#l15.42"></a><span id="l15.42"> </span>
<a href="#l15.43"></a><span id="l15.43">       &lt;property name=&quot;date&quot;&gt;</span>
<a href="#l15.44"></a><span id="l15.44">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l15.45"></a><span id="l15.45">           return this.mDate;</span>
<a href="#l15.46"></a><span id="l15.46">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l15.47"></a><span id="l15.47">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l15.48"></a><span id="l15.48">           this.mDate = val;</span>
<a href="#l15.49"></a><span id="l15.49"> </span>
<a href="#l15.50"></a><span id="l15.50" class="difflineminus">-          if (!compareObjects(val.timezone, this.mTimezone)) {</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineplus">+          if (!cal.compareObjects(val.timezone, this.mTimezone)) {</span>
<a href="#l15.52"></a><span id="l15.52">               this.mTimezone = val.timezone;</span>
<a href="#l15.53"></a><span id="l15.53">               if (!this.mLayoutBatchCount) {</span>
<a href="#l15.54"></a><span id="l15.54">                   this.recalculateStartEndMinutes();</span>
<a href="#l15.55"></a><span id="l15.55">               }</span>
<a href="#l15.56"></a><span id="l15.56">           }</span>
<a href="#l15.57"></a><span id="l15.57"> </span>
<a href="#l15.58"></a><span id="l15.58">           return val;</span>
<a href="#l15.59"></a><span id="l15.59">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineat">@@ -516,21 +516,21 @@</span>
<a href="#l15.61"></a><span id="l15.61">            minutes of the whole occurrence (which could span multiple days)</span>
<a href="#l15.62"></a><span id="l15.62">            relative to the time 0:00 of the day in this column --&gt;</span>
<a href="#l15.63"></a><span id="l15.63">       &lt;method name=&quot;getStartEndMinutesForOccurrence&quot;&gt;</span>
<a href="#l15.64"></a><span id="l15.64">         &lt;parameter name=&quot;aOccurrence&quot;/&gt;</span>
<a href="#l15.65"></a><span id="l15.65">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l15.66"></a><span id="l15.66">           let stdate = aOccurrence.startDate || aOccurrence.entryDate || aOccurrence.dueDate;</span>
<a href="#l15.67"></a><span id="l15.67">           let enddate = aOccurrence.endDate || aOccurrence.dueDate || aOccurrence.entryDate;</span>
<a href="#l15.68"></a><span id="l15.68"> </span>
<a href="#l15.69"></a><span id="l15.69" class="difflineminus">-          if (!compareObjects(stdate.timezone, this.mTimezone)) {</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineplus">+          if (!cal.compareObjects(stdate.timezone, this.mTimezone)) {</span>
<a href="#l15.71"></a><span id="l15.71">               stdate = stdate.getInTimezone(this.mTimezone);</span>
<a href="#l15.72"></a><span id="l15.72">           }</span>
<a href="#l15.73"></a><span id="l15.73"> </span>
<a href="#l15.74"></a><span id="l15.74" class="difflineminus">-          if (!compareObjects(enddate.timezone, this.mTimezone)) {</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineplus">+          if (!cal.compareObjects(enddate.timezone, this.mTimezone)) {</span>
<a href="#l15.76"></a><span id="l15.76">               enddate = enddate.getInTimezone(this.mTimezone);</span>
<a href="#l15.77"></a><span id="l15.77">           }</span>
<a href="#l15.78"></a><span id="l15.78"> </span>
<a href="#l15.79"></a><span id="l15.79">           let startHour = stdate.hour;</span>
<a href="#l15.80"></a><span id="l15.80">           let startMinute = stdate.minute;</span>
<a href="#l15.81"></a><span id="l15.81">           let endHour = enddate.hour;</span>
<a href="#l15.82"></a><span id="l15.82">           let endMinute = enddate.minute;</span>
<a href="#l15.83"></a><span id="l15.83"> </span>
<a href="#l15.84"></a><span id="l15.84" class="difflineat">@@ -1198,31 +1198,31 @@</span>
<a href="#l15.85"></a><span id="l15.85">                       prevEnd = col[col.length - 1].endDate.clone();</span>
<a href="#l15.86"></a><span id="l15.86">                   } else {</span>
<a href="#l15.87"></a><span id="l15.87">                       // First event in the column, add a placeholder for the</span>
<a href="#l15.88"></a><span id="l15.88">                       // blank time from this.mStartMin to the event's start</span>
<a href="#l15.89"></a><span id="l15.89">                       prevEnd = start.clone();</span>
<a href="#l15.90"></a><span id="l15.90">                       prevEnd.hour = 0;</span>
<a href="#l15.91"></a><span id="l15.91">                       prevEnd.minute = this.mStartMin;</span>
<a href="#l15.92"></a><span id="l15.92">                   }</span>
<a href="#l15.93"></a><span id="l15.93" class="difflineminus">-                  prevEnd.timezone = floating();</span>
<a href="#l15.94"></a><span id="l15.94" class="difflineplus">+                  prevEnd.timezone = cal.floating();</span>
<a href="#l15.95"></a><span id="l15.95">                   // the reason why we need to calculate time durations</span>
<a href="#l15.96"></a><span id="l15.96">                   // based on floating timezones is that we need avoid</span>
<a href="#l15.97"></a><span id="l15.97">                   // dst gaps in this case. converting the date/times to</span>
<a href="#l15.98"></a><span id="l15.98">                   // floating conveys this idea in a natural way. note that</span>
<a href="#l15.99"></a><span id="l15.99">                   // we explicitly don't use getInTimezone() as it would</span>
<a href="#l15.100"></a><span id="l15.100">                   // be slightly more expensive in terms of performance.</span>
<a href="#l15.101"></a><span id="l15.101">                   let floatstart = start.clone();</span>
<a href="#l15.102"></a><span id="l15.102" class="difflineminus">-                  floatstart.timezone = floating();</span>
<a href="#l15.103"></a><span id="l15.103" class="difflineplus">+                  floatstart.timezone = cal.floating();</span>
<a href="#l15.104"></a><span id="l15.104">                   let dur = floatstart.subtractDate(prevEnd);</span>
<a href="#l15.105"></a><span id="l15.105">                   if (dur.inSeconds) {</span>
<a href="#l15.106"></a><span id="l15.106">                       col.push({ duration: dur });</span>
<a href="#l15.107"></a><span id="l15.107">                   }</span>
<a href="#l15.108"></a><span id="l15.108">                   let floatend = end.clone();</span>
<a href="#l15.109"></a><span id="l15.109" class="difflineminus">-                  floatend.timezone = floating();</span>
<a href="#l15.110"></a><span id="l15.110" class="difflineplus">+                  floatend.timezone = cal.floating();</span>
<a href="#l15.111"></a><span id="l15.111">                   col.push({</span>
<a href="#l15.112"></a><span id="l15.112">                       event: data.itemInfo.event,</span>
<a href="#l15.113"></a><span id="l15.113">                       endDate: end,</span>
<a href="#l15.114"></a><span id="l15.114">                       startDate: start,</span>
<a href="#l15.115"></a><span id="l15.115">                       duration: floatend.subtractDate(floatstart)</span>
<a href="#l15.116"></a><span id="l15.116">                   });</span>
<a href="#l15.117"></a><span id="l15.117">               }</span>
<a href="#l15.118"></a><span id="l15.118">               layerOffset = layers.length;</span>
<a href="#l15.119"></a><span id="l15.119" class="difflineat">@@ -1794,18 +1794,18 @@</span>
<a href="#l15.120"></a><span id="l15.120">         &lt;parameter name=&quot;aOccurrence&quot;/&gt;</span>
<a href="#l15.121"></a><span id="l15.121">         &lt;!-- &quot;start&quot;, &quot;end&quot;, &quot;middle&quot; --&gt;</span>
<a href="#l15.122"></a><span id="l15.122">         &lt;parameter name=&quot;aGrabbedElement&quot;/&gt;</span>
<a href="#l15.123"></a><span id="l15.123">         &lt;!-- mouse screenX/screenY from the event --&gt;</span>
<a href="#l15.124"></a><span id="l15.124">         &lt;parameter name=&quot;aMouseX&quot;/&gt;</span>
<a href="#l15.125"></a><span id="l15.125">         &lt;parameter name=&quot;aMouseY&quot;/&gt;</span>
<a href="#l15.126"></a><span id="l15.126">         &lt;parameter name=&quot;aSnapInt&quot;/&gt;</span>
<a href="#l15.127"></a><span id="l15.127">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l15.128"></a><span id="l15.128" class="difflineminus">-          if (!isCalendarWritable(aOccurrence.calendar) ||</span>
<a href="#l15.129"></a><span id="l15.129" class="difflineminus">-              !userCanModifyItem(aOccurrence) ||</span>
<a href="#l15.130"></a><span id="l15.130" class="difflineplus">+          if (!cal.isCalendarWritable(aOccurrence.calendar) ||</span>
<a href="#l15.131"></a><span id="l15.131" class="difflineplus">+              !cal.userCanModifyItem(aOccurrence) ||</span>
<a href="#l15.132"></a><span id="l15.132">               (aOccurrence.calendar instanceof Components.interfaces.calISchedulingSupport &amp;&amp; aOccurrence.calendar.isInvitation(aOccurrence)) ||</span>
<a href="#l15.133"></a><span id="l15.133">               aOccurrence.calendar.getProperty(&quot;capabilities.events.supported&quot;) === false) {</span>
<a href="#l15.134"></a><span id="l15.134">               return;</span>
<a href="#l15.135"></a><span id="l15.135">           }</span>
<a href="#l15.136"></a><span id="l15.136"> </span>
<a href="#l15.137"></a><span id="l15.137">           this.mDragState = {</span>
<a href="#l15.138"></a><span id="l15.138">               origColumn: this,</span>
<a href="#l15.139"></a><span id="l15.139">               dragOccurrence: aOccurrence,</span>
<a href="#l15.140"></a><span id="l15.140" class="difflineat">@@ -1964,19 +1964,19 @@</span>
<a href="#l15.141"></a><span id="l15.141">           let startstr = timeFormatter.formatTime(cal.jsDateToDateTime(jsTime, cal.floating()));</span>
<a href="#l15.142"></a><span id="l15.142">           jsTime.setHours(endhr, endmin);</span>
<a href="#l15.143"></a><span id="l15.143">           let endstr = timeFormatter.formatTime(cal.jsDateToDateTime(jsTime, cal.floating()));</span>
<a href="#l15.144"></a><span id="l15.144"> </span>
<a href="#l15.145"></a><span id="l15.145">           // Tasks without Entry or Due date have a string as first label</span>
<a href="#l15.146"></a><span id="l15.146">           // instead of the time.</span>
<a href="#l15.147"></a><span id="l15.147">           if (cal.isToDo(this.mDragState.dragOccurrence)) {</span>
<a href="#l15.148"></a><span id="l15.148">               if (!this.mDragState.dragOccurrence.dueDate) {</span>
<a href="#l15.149"></a><span id="l15.149" class="difflineminus">-                  startstr = calGetString(&quot;calendar&quot;, &quot;dragLabelTasksWithOnlyEntryDate&quot;);</span>
<a href="#l15.150"></a><span id="l15.150" class="difflineplus">+                  startstr = cal.calGetString(&quot;calendar&quot;, &quot;dragLabelTasksWithOnlyEntryDate&quot;);</span>
<a href="#l15.151"></a><span id="l15.151">               } else if (!this.mDragState.dragOccurrence.entryDate) {</span>
<a href="#l15.152"></a><span id="l15.152" class="difflineminus">-                  startstr = calGetString(&quot;calendar&quot;, &quot;dragLabelTasksWithOnlyDueDate&quot;);</span>
<a href="#l15.153"></a><span id="l15.153" class="difflineplus">+                  startstr = cal.calGetString(&quot;calendar&quot;, &quot;dragLabelTasksWithOnlyDueDate&quot;);</span>
<a href="#l15.154"></a><span id="l15.154">               }</span>
<a href="#l15.155"></a><span id="l15.155">           }</span>
<a href="#l15.156"></a><span id="l15.156">           firstColumn.fgboxes.startlabel.setAttribute(&quot;value&quot;, startstr);</span>
<a href="#l15.157"></a><span id="l15.157">           lastColumn.fgboxes.endlabel.setAttribute(&quot;value&quot;, endstr);</span>
<a href="#l15.158"></a><span id="l15.158"> </span>
<a href="#l15.159"></a><span id="l15.159">         ]]&gt;&lt;/body&gt;</span>
<a href="#l15.160"></a><span id="l15.160">       &lt;/method&gt;</span>
<a href="#l15.161"></a><span id="l15.161"> </span>
<a href="#l15.162"></a><span id="l15.162" class="difflineat">@@ -2042,17 +2042,17 @@</span>
<a href="#l15.163"></a><span id="l15.163">          - event.</span>
<a href="#l15.164"></a><span id="l15.164">         --&gt;</span>
<a href="#l15.165"></a><span id="l15.165">       &lt;handler event=&quot;mousedown&quot;&gt;&lt;![CDATA[</span>
<a href="#l15.166"></a><span id="l15.166">         // select this column</span>
<a href="#l15.167"></a><span id="l15.167">         this.calendarView.selectedDay = this.mDate;</span>
<a href="#l15.168"></a><span id="l15.168"> </span>
<a href="#l15.169"></a><span id="l15.169">         // If the selected calendar is readOnly, we don't want any sweeping.</span>
<a href="#l15.170"></a><span id="l15.170">         let calendar = getSelectedCalendar();</span>
<a href="#l15.171"></a><span id="l15.171" class="difflineminus">-        if (!isCalendarWritable(calendar) ||</span>
<a href="#l15.172"></a><span id="l15.172" class="difflineplus">+        if (!cal.isCalendarWritable(calendar) ||</span>
<a href="#l15.173"></a><span id="l15.173">             calendar.getProperty(&quot;capabilities.events.supported&quot;) === false) {</span>
<a href="#l15.174"></a><span id="l15.174">             return;</span>
<a href="#l15.175"></a><span id="l15.175">         }</span>
<a href="#l15.176"></a><span id="l15.176"> </span>
<a href="#l15.177"></a><span id="l15.177">         // Only start sweeping out an event if the left button was clicked</span>
<a href="#l15.178"></a><span id="l15.178">         if (event.button != 0) {</span>
<a href="#l15.179"></a><span id="l15.179">             return;</span>
<a href="#l15.180"></a><span id="l15.180">         }</span>
<a href="#l15.181"></a><span id="l15.181" class="difflineat">@@ -2099,16 +2099,18 @@</span>
<a href="#l15.182"></a><span id="l15.182">   &lt;binding id=&quot;calendar-header-container&quot; extends=&quot;chrome://calendar/content/widgets/calendar-widgets.xml#dragndropContainer&quot;&gt;</span>
<a href="#l15.183"></a><span id="l15.183">     &lt;content xbl:inherits=&quot;selected&quot; flex=&quot;1&quot; class=&quot;calendar-event-column-header&quot;&gt;</span>
<a href="#l15.184"></a><span id="l15.184">       &lt;children/&gt;</span>
<a href="#l15.185"></a><span id="l15.185">     &lt;/content&gt;</span>
<a href="#l15.186"></a><span id="l15.186"> </span>
<a href="#l15.187"></a><span id="l15.187">     &lt;implementation&gt;</span>
<a href="#l15.188"></a><span id="l15.188">       &lt;field name=&quot;mItemBoxes&quot;&gt;null&lt;/field&gt;</span>
<a href="#l15.189"></a><span id="l15.189">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l15.190"></a><span id="l15.190" class="difflineplus">+        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l15.191"></a><span id="l15.191" class="difflineplus">+</span>
<a href="#l15.192"></a><span id="l15.192">         this.mItemBoxes = [];</span>
<a href="#l15.193"></a><span id="l15.193">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l15.194"></a><span id="l15.194"> </span>
<a href="#l15.195"></a><span id="l15.195">       &lt;property name=&quot;date&quot;&gt;</span>
<a href="#l15.196"></a><span id="l15.196">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l15.197"></a><span id="l15.197">           return this.mDate;</span>
<a href="#l15.198"></a><span id="l15.198">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l15.199"></a><span id="l15.199">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l15.200"></a><span id="l15.200" class="difflineat">@@ -2298,17 +2300,19 @@</span>
<a href="#l15.201"></a><span id="l15.201">             &lt;/xul:stack&gt;</span>
<a href="#l15.202"></a><span id="l15.202">           &lt;/xul:box&gt;</span>
<a href="#l15.203"></a><span id="l15.203">         &lt;/xul:box&gt;</span>
<a href="#l15.204"></a><span id="l15.204">       &lt;/xul:box&gt;</span>
<a href="#l15.205"></a><span id="l15.205">     &lt;/content&gt;</span>
<a href="#l15.206"></a><span id="l15.206"> </span>
<a href="#l15.207"></a><span id="l15.207">     &lt;implementation&gt;</span>
<a href="#l15.208"></a><span id="l15.208">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l15.209"></a><span id="l15.209" class="difflineminus">-         this.orient = this.getAttribute(&quot;orient&quot;);</span>
<a href="#l15.210"></a><span id="l15.210" class="difflineplus">+        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l15.211"></a><span id="l15.211" class="difflineplus">+</span>
<a href="#l15.212"></a><span id="l15.212" class="difflineplus">+        this.orient = this.getAttribute(&quot;orient&quot;);</span>
<a href="#l15.213"></a><span id="l15.213">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l15.214"></a><span id="l15.214"> </span>
<a href="#l15.215"></a><span id="l15.215">       &lt;!-- fields --&gt;</span>
<a href="#l15.216"></a><span id="l15.216">       &lt;field name=&quot;mParentColumn&quot;&gt;null&lt;/field&gt;</span>
<a href="#l15.217"></a><span id="l15.217"> </span>
<a href="#l15.218"></a><span id="l15.218">       &lt;!-- methods/properties --&gt;</span>
<a href="#l15.219"></a><span id="l15.219">       &lt;method name=&quot;setAttribute&quot;&gt;</span>
<a href="#l15.220"></a><span id="l15.220">         &lt;parameter name=&quot;aAttr&quot;/&gt;</span>
<a href="#l15.221"></a><span id="l15.221" class="difflineat">@@ -2384,17 +2388,17 @@</span>
<a href="#l15.222"></a><span id="l15.222">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l15.223"></a><span id="l15.223">           let evl = this.eventNameLabel;</span>
<a href="#l15.224"></a><span id="l15.224">           let item = this.mOccurrence;</span>
<a href="#l15.225"></a><span id="l15.225"> </span>
<a href="#l15.226"></a><span id="l15.226">           if (item.title &amp;&amp; item.title != &quot;&quot;) {</span>
<a href="#l15.227"></a><span id="l15.227">               // Use &lt;description&gt; textContent so it can wrap.</span>
<a href="#l15.228"></a><span id="l15.228">               evl.textContent = item.title;</span>
<a href="#l15.229"></a><span id="l15.229">           } else {</span>
<a href="#l15.230"></a><span id="l15.230" class="difflineminus">-              evl.textContent = calGetString(&quot;calendar&quot;, &quot;eventUntitled&quot;);</span>
<a href="#l15.231"></a><span id="l15.231" class="difflineplus">+              evl.textContent = cal.calGetString(&quot;calendar&quot;, &quot;eventUntitled&quot;);</span>
<a href="#l15.232"></a><span id="l15.232">           }</span>
<a href="#l15.233"></a><span id="l15.233"> </span>
<a href="#l15.234"></a><span id="l15.234">           let gripbar = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;gripbar1&quot;).boxObject.height;</span>
<a href="#l15.235"></a><span id="l15.235">           let height = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;eventbox&quot;).boxObject.height;</span>
<a href="#l15.236"></a><span id="l15.236">           evl.setAttribute(&quot;style&quot;, &quot;max-height: &quot; + Math.max(0, height-gripbar * 2) + &quot;px&quot;);</span>
<a href="#l15.237"></a><span id="l15.237">         ]]&gt;&lt;/body&gt;</span>
<a href="#l15.238"></a><span id="l15.238">       &lt;/method&gt;</span>
<a href="#l15.239"></a><span id="l15.239">     &lt;/implementation&gt;</span>
<a href="#l15.240"></a><span id="l15.240" class="difflineat">@@ -2515,16 +2519,17 @@</span>
<a href="#l15.241"></a><span id="l15.241">                    equalsize=&quot;always&quot;/&gt;</span>
<a href="#l15.242"></a><span id="l15.242">         &lt;/xul:scrollbox&gt;</span>
<a href="#l15.243"></a><span id="l15.243">       &lt;/xul:box&gt;</span>
<a href="#l15.244"></a><span id="l15.244">     &lt;/content&gt;</span>
<a href="#l15.245"></a><span id="l15.245"> </span>
<a href="#l15.246"></a><span id="l15.246">     &lt;implementation implements=&quot;calICalendarView&quot;&gt;</span>
<a href="#l15.247"></a><span id="l15.247">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l15.248"></a><span id="l15.248">         Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l15.249"></a><span id="l15.249" class="difflineplus">+        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l15.250"></a><span id="l15.250"> </span>
<a href="#l15.251"></a><span id="l15.251">         // get day start/end hour from prefs and set on the view</span>
<a href="#l15.252"></a><span id="l15.252">         this.setDayStartEndMinutes(Preferences.get(&quot;calendar.view.daystarthour&quot;, 8) * 60,</span>
<a href="#l15.253"></a><span id="l15.253">                                    Preferences.get(&quot;calendar.view.dayendhour&quot;, 17) * 60);</span>
<a href="#l15.254"></a><span id="l15.254"> </span>
<a href="#l15.255"></a><span id="l15.255">         // initially scroll to the day start hour in the view</span>
<a href="#l15.256"></a><span id="l15.256">         this.scrollToMinute(this.mDayStartMin);</span>
<a href="#l15.257"></a><span id="l15.257"> </span>
<a href="#l15.258"></a><span id="l15.258" class="difflineat">@@ -3033,23 +3038,23 @@</span>
<a href="#l15.259"></a><span id="l15.259">           } else { // undated todo</span>
<a href="#l15.260"></a><span id="l15.260">               return [];</span>
<a href="#l15.261"></a><span id="l15.261">           }</span>
<a href="#l15.262"></a><span id="l15.262">         ]]&gt;&lt;/body&gt;</span>
<a href="#l15.263"></a><span id="l15.263">       &lt;/method&gt;</span>
<a href="#l15.264"></a><span id="l15.264"> </span>
<a href="#l15.265"></a><span id="l15.265">       &lt;method name=&quot;centerSelectedItems&quot;&gt;</span>
<a href="#l15.266"></a><span id="l15.266">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l15.267"></a><span id="l15.267" class="difflineminus">-          let displayTZ = calendarDefaultTimezone();</span>
<a href="#l15.268"></a><span id="l15.268" class="difflineplus">+          let displayTZ = cal.calendarDefaultTimezone();</span>
<a href="#l15.269"></a><span id="l15.269">           let lowMinute = 24 * 60;</span>
<a href="#l15.270"></a><span id="l15.270">           let highMinute = 0;</span>
<a href="#l15.271"></a><span id="l15.271"> </span>
<a href="#l15.272"></a><span id="l15.272">           for (let item of this.mSelectedItems) {</span>
<a href="#l15.273"></a><span id="l15.273" class="difflineminus">-              let startDateProperty = calGetStartDateProp(item);</span>
<a href="#l15.274"></a><span id="l15.274" class="difflineminus">-              let endDateProperty = calGetEndDateProp(item);</span>
<a href="#l15.275"></a><span id="l15.275" class="difflineplus">+              let startDateProperty = cal.calGetStartDateProp(item);</span>
<a href="#l15.276"></a><span id="l15.276" class="difflineplus">+              let endDateProperty = cal.calGetEndDateProp(item);</span>
<a href="#l15.277"></a><span id="l15.277"> </span>
<a href="#l15.278"></a><span id="l15.278">               let occs = [];</span>
<a href="#l15.279"></a><span id="l15.279">               if (item.recurrenceInfo) {</span>
<a href="#l15.280"></a><span id="l15.280">                   // if selected a parent item, show occurrence(s) in view range</span>
<a href="#l15.281"></a><span id="l15.281">                   occs = item.getOccurrencesBetween(this.startDate, this.queryEndDate, {}, 0);</span>
<a href="#l15.282"></a><span id="l15.282">               } else {</span>
<a href="#l15.283"></a><span id="l15.283">                   occs = [item];</span>
<a href="#l15.284"></a><span id="l15.284">               }</span>
<a href="#l15.285"></a><span id="l15.285" class="difflineat">@@ -3085,17 +3090,17 @@</span>
<a href="#l15.286"></a><span id="l15.286">                   if (occStart.timezone != displayTZ) {</span>
<a href="#l15.287"></a><span id="l15.287">                       occStart = occStart.getInTimezone(displayTZ);</span>
<a href="#l15.288"></a><span id="l15.288">                   }</span>
<a href="#l15.289"></a><span id="l15.289">                   if (occEnd.timezone != displayTZ) {</span>
<a href="#l15.290"></a><span id="l15.290">                       occEnd = occEnd.getInTimezone(displayTZ);</span>
<a href="#l15.291"></a><span id="l15.291">                   }</span>
<a href="#l15.292"></a><span id="l15.292">                   // If crosses midnite in current TZ, set end just</span>
<a href="#l15.293"></a><span id="l15.293">                   // before midnite after start so start/title usually visible.</span>
<a href="#l15.294"></a><span id="l15.294" class="difflineminus">-                  if (!sameDay(occStart, occEnd)) {</span>
<a href="#l15.295"></a><span id="l15.295" class="difflineplus">+                  if (!cal.sameDay(occStart, occEnd)) {</span>
<a href="#l15.296"></a><span id="l15.296">                       occEnd = occStart.clone();</span>
<a href="#l15.297"></a><span id="l15.297">                       occEnd.day = occStart.day;</span>
<a href="#l15.298"></a><span id="l15.298">                       occEnd.hour = 23;</span>
<a href="#l15.299"></a><span id="l15.299">                       occEnd.minute = 59;</span>
<a href="#l15.300"></a><span id="l15.300">                   }</span>
<a href="#l15.301"></a><span id="l15.301"> </span>
<a href="#l15.302"></a><span id="l15.302">                   // Ensure range shows occ</span>
<a href="#l15.303"></a><span id="l15.303">                   lowMinute = Math.min(occStart.hour * 60 + occStart.minute,</span>
<a href="#l15.304"></a><span id="l15.304" class="difflineat">@@ -3515,19 +3520,19 @@</span>
<a href="#l15.305"></a><span id="l15.305">         &lt;parameter name=&quot;aOccurrences&quot;/&gt;</span>
<a href="#l15.306"></a><span id="l15.306">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l15.307"></a><span id="l15.307">           if (!this.mDateColumns || !this.mDateColumns.length) {</span>
<a href="#l15.308"></a><span id="l15.308">               return [];</span>
<a href="#l15.309"></a><span id="l15.309">           }</span>
<a href="#l15.310"></a><span id="l15.310"> </span>
<a href="#l15.311"></a><span id="l15.311">           let occMap = {};</span>
<a href="#l15.312"></a><span id="l15.312">           for (let occ of aOccurrences) {</span>
<a href="#l15.313"></a><span id="l15.313" class="difflineminus">-              let startDate = occ[calGetStartDateProp(occ)]</span>
<a href="#l15.314"></a><span id="l15.314" class="difflineplus">+              let startDate = occ[cal.calGetStartDateProp(occ)]</span>
<a href="#l15.315"></a><span id="l15.315">                               .getInTimezone(this.mStartDate.timezone);</span>
<a href="#l15.316"></a><span id="l15.316" class="difflineminus">-              let endDate = occ[calGetEndDateProp(occ)]</span>
<a href="#l15.317"></a><span id="l15.317" class="difflineplus">+              let endDate = occ[cal.calGetEndDateProp(occ)]</span>
<a href="#l15.318"></a><span id="l15.318">                               .getInTimezone(this.mEndDate.timezone) || startDate;</span>
<a href="#l15.319"></a><span id="l15.319">               if (startDate.compare(this.mStartDate) &gt;= 0 &amp;&amp;</span>
<a href="#l15.320"></a><span id="l15.320">                   endDate.compare(this.mEndDate) &lt;= 0) {</span>
<a href="#l15.321"></a><span id="l15.321">                   for (let i = startDate.day; i &lt;= endDate.day; i++) {</span>
<a href="#l15.322"></a><span id="l15.322">                       occMap[i] = true;</span>
<a href="#l15.323"></a><span id="l15.323">                   }</span>
<a href="#l15.324"></a><span id="l15.324">               }</span>
<a href="#l15.325"></a><span id="l15.325">           }</span>
<a href="#l15.326"></a><span id="l15.326" class="difflineat">@@ -3607,18 +3612,18 @@</span>
<a href="#l15.327"></a><span id="l15.327">           }</span>
<a href="#l15.328"></a><span id="l15.328">           return null;</span>
<a href="#l15.329"></a><span id="l15.329">         ]]&gt;&lt;/body&gt;</span>
<a href="#l15.330"></a><span id="l15.330">       &lt;/method&gt;</span>
<a href="#l15.331"></a><span id="l15.331"> </span>
<a href="#l15.332"></a><span id="l15.332">       &lt;method name=&quot;adjustScrollbarSpacersForAlldayEvents&quot;&gt;</span>
<a href="#l15.333"></a><span id="l15.333">         &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l15.334"></a><span id="l15.334">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l15.335"></a><span id="l15.335" class="difflineminus">-          let startDate = aEvent[calGetStartDateProp(aEvent)];</span>
<a href="#l15.336"></a><span id="l15.336" class="difflineminus">-          let endDate = aEvent[calGetEndDateProp(aEvent)];</span>
<a href="#l15.337"></a><span id="l15.337" class="difflineplus">+          let startDate = aEvent[cal.calGetStartDateProp(aEvent)];</span>
<a href="#l15.338"></a><span id="l15.338" class="difflineplus">+          let endDate = aEvent[cal.calGetEndDateProp(aEvent)];</span>
<a href="#l15.339"></a><span id="l15.339">           if ((startDate &amp;&amp; startDate.isDate) ||</span>
<a href="#l15.340"></a><span id="l15.340">               (endDate &amp;&amp; endDate.isDate)) {</span>
<a href="#l15.341"></a><span id="l15.341">               // If this is an all day event, then the header with allday</span>
<a href="#l15.342"></a><span id="l15.342">               // events could possibly get a scrollbar. Readjust them.</span>
<a href="#l15.343"></a><span id="l15.343">               this.adjustScrollBarSpacers();</span>
<a href="#l15.344"></a><span id="l15.344">           }</span>
<a href="#l15.345"></a><span id="l15.345">         ]]&gt;&lt;/body&gt;</span>
<a href="#l15.346"></a><span id="l15.346">       &lt;/method&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/calendar/base/content/calendar-statusbar.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/calendar/base/content/calendar-statusbar.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -1,13 +1,14 @@</span>
<a href="#l16.4"></a><span id="l16.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l16.5"></a><span id="l16.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l16.6"></a><span id="l16.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l16.7"></a><span id="l16.7"> </span>
<a href="#l16.8"></a><span id="l16.8"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l16.9"></a><span id="l16.9" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l16.10"></a><span id="l16.10"> </span>
<a href="#l16.11"></a><span id="l16.11"> /* exported gCalendarStatusFeedback */</span>
<a href="#l16.12"></a><span id="l16.12"> </span>
<a href="#l16.13"></a><span id="l16.13"> /**</span>
<a href="#l16.14"></a><span id="l16.14">  * This code might change soon if we support Thunderbird's activity manager.</span>
<a href="#l16.15"></a><span id="l16.15">  * NOTE: The naming &quot;Meteors&quot; is historical.</span>
<a href="#l16.16"></a><span id="l16.16">  */</span>
<a href="#l16.17"></a><span id="l16.17"> var gCalendarStatusFeedback = {</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineat">@@ -57,17 +58,17 @@ var gCalendarStatusFeedback = {</span>
<a href="#l16.19"></a><span id="l16.19">                 this.mCalendarStep = Math.trunc(100 / this.mCalendarCount);</span>
<a href="#l16.20"></a><span id="l16.20">             }</span>
<a href="#l16.21"></a><span id="l16.21">             this.mProgressMode = aProgressMode;</span>
<a href="#l16.22"></a><span id="l16.22">             this.mStatusProgressPanel.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l16.23"></a><span id="l16.23">             if (this.mProgressMode == Components.interfaces.calIStatusObserver.DETERMINED_PROGRESS) {</span>
<a href="#l16.24"></a><span id="l16.24">                 this.mStatusBar.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l16.25"></a><span id="l16.25">                 this.mStatusBar.setAttribute(&quot;mode&quot;, &quot;determined&quot;);</span>
<a href="#l16.26"></a><span id="l16.26">                 this.mStatusBar.value = 0;</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineminus">-                let commonStatus = calGetString(&quot;calendar&quot;, &quot;gettingCalendarInfoCommon&quot;);</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineplus">+                let commonStatus = cal.calGetString(&quot;calendar&quot;, &quot;gettingCalendarInfoCommon&quot;);</span>
<a href="#l16.29"></a><span id="l16.29">                 this.showStatusString(commonStatus);</span>
<a href="#l16.30"></a><span id="l16.30">             }</span>
<a href="#l16.31"></a><span id="l16.31">             if (this.mThrobber) {</span>
<a href="#l16.32"></a><span id="l16.32">                 this.mThrobber.setAttribute(&quot;busy&quot;, true);</span>
<a href="#l16.33"></a><span id="l16.33">             }</span>
<a href="#l16.34"></a><span id="l16.34">         }</span>
<a href="#l16.35"></a><span id="l16.35">     },</span>
<a href="#l16.36"></a><span id="l16.36"> </span>
<a href="#l16.37"></a><span id="l16.37" class="difflineat">@@ -93,18 +94,18 @@ var gCalendarStatusFeedback = {</span>
<a href="#l16.38"></a><span id="l16.38">             return;</span>
<a href="#l16.39"></a><span id="l16.39">         }</span>
<a href="#l16.40"></a><span id="l16.40">         if (this.spinning != Components.interfaces.calIStatusObserver.NO_PROGRESS) {</span>
<a href="#l16.41"></a><span id="l16.41">             if (this.spinning == Components.interfaces.calIStatusObserver.DETERMINED_PROGRESS) {</span>
<a href="#l16.42"></a><span id="l16.42">                 if (!this.mCalendars[aCalendar.id] || this.mCalendars[aCalendar.id] === undefined) {</span>
<a href="#l16.43"></a><span id="l16.43">                     this.mCalendars[aCalendar.id] = true;</span>
<a href="#l16.44"></a><span id="l16.44">                     this.mStatusBar.value = parseInt(this.mStatusBar.value, 10) + this.mCalendarStep;</span>
<a href="#l16.45"></a><span id="l16.45">                     this.mCurIndex++;</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineminus">-                    let curStatus = calGetString(&quot;calendar&quot;, &quot;gettingCalendarInfoDetail&quot;,</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineminus">-                                                 [this.mCurIndex, this.mCalendarCount]);</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineplus">+                    let curStatus = cal.calGetString(&quot;calendar&quot;, &quot;gettingCalendarInfoDetail&quot;,</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineplus">+                                                     [this.mCurIndex, this.mCalendarCount]);</span>
<a href="#l16.50"></a><span id="l16.50">                     this.showStatusString(curStatus);</span>
<a href="#l16.51"></a><span id="l16.51">                 }</span>
<a href="#l16.52"></a><span id="l16.52">             }</span>
<a href="#l16.53"></a><span id="l16.53">             if (this.mThrobber) {</span>
<a href="#l16.54"></a><span id="l16.54">                 this.mThrobber.setAttribute(&quot;busy&quot;, true);</span>
<a href="#l16.55"></a><span id="l16.55">             }</span>
<a href="#l16.56"></a><span id="l16.56">         }</span>
<a href="#l16.57"></a><span id="l16.57">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/calendar/base/content/calendar-task-editing.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/calendar/base/content/calendar-task-editing.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -68,24 +68,24 @@ var taskEdit = {</span>
<a href="#l17.4"></a><span id="l17.4">         }</span>
<a href="#l17.5"></a><span id="l17.5"> </span>
<a href="#l17.6"></a><span id="l17.6">         let calendar = getSelectedCalendar();</span>
<a href="#l17.7"></a><span id="l17.7">         edit.showsInstructions = true;</span>
<a href="#l17.8"></a><span id="l17.8"> </span>
<a href="#l17.9"></a><span id="l17.9">         if (calendar.getProperty(&quot;capabilities.tasks.supported&quot;) === false) {</span>
<a href="#l17.10"></a><span id="l17.10">             taskEdit.setupTaskField(edit,</span>
<a href="#l17.11"></a><span id="l17.11">                                     true,</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-                                    calGetString(&quot;calendar&quot;, &quot;taskEditInstructionsCapability&quot;));</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-        } else if (isCalendarWritable(calendar)) {</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+                                    cal.calGetString(&quot;calendar&quot;, &quot;taskEditInstructionsCapability&quot;));</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+        } else if (cal.isCalendarWritable(calendar)) {</span>
<a href="#l17.16"></a><span id="l17.16">             edit.showsInstructions = false;</span>
<a href="#l17.17"></a><span id="l17.17">             taskEdit.setupTaskField(edit, false, edit.savedValue || &quot;&quot;);</span>
<a href="#l17.18"></a><span id="l17.18">         } else {</span>
<a href="#l17.19"></a><span id="l17.19">             taskEdit.setupTaskField(edit,</span>
<a href="#l17.20"></a><span id="l17.20">                                     true,</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineminus">-                                    calGetString(&quot;calendar&quot;, &quot;taskEditInstructionsReadonly&quot;));</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineplus">+                                    cal.calGetString(&quot;calendar&quot;, &quot;taskEditInstructionsReadonly&quot;));</span>
<a href="#l17.23"></a><span id="l17.23">         }</span>
<a href="#l17.24"></a><span id="l17.24">     },</span>
<a href="#l17.25"></a><span id="l17.25"> </span>
<a href="#l17.26"></a><span id="l17.26">     /**</span>
<a href="#l17.27"></a><span id="l17.27">      * Handler function to call when the quick-add textbox loses focus.</span>
<a href="#l17.28"></a><span id="l17.28">      *</span>
<a href="#l17.29"></a><span id="l17.29">      * @param aEvent    The DOM blur event</span>
<a href="#l17.30"></a><span id="l17.30">      */</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineat">@@ -102,28 +102,28 @@ var taskEdit = {</span>
<a href="#l17.32"></a><span id="l17.32">         if (!calendar) {</span>
<a href="#l17.33"></a><span id="l17.33">             // this must be a first run, we don't have a calendar yet</span>
<a href="#l17.34"></a><span id="l17.34">             return;</span>
<a href="#l17.35"></a><span id="l17.35">         }</span>
<a href="#l17.36"></a><span id="l17.36"> </span>
<a href="#l17.37"></a><span id="l17.37">         if (calendar.getProperty(&quot;capabilities.tasks.supported&quot;) === false) {</span>
<a href="#l17.38"></a><span id="l17.38">             taskEdit.setupTaskField(edit,</span>
<a href="#l17.39"></a><span id="l17.39">                                     true,</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineminus">-                                    calGetString(&quot;calendar&quot;, &quot;taskEditInstructionsCapability&quot;));</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineminus">-        } else if (isCalendarWritable(calendar)) {</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineplus">+                                    cal.calGetString(&quot;calendar&quot;, &quot;taskEditInstructionsCapability&quot;));</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineplus">+        } else if (cal.isCalendarWritable(calendar)) {</span>
<a href="#l17.44"></a><span id="l17.44">             if (!edit.showsInstructions) {</span>
<a href="#l17.45"></a><span id="l17.45">                 edit.savedValue = edit.value || &quot;&quot;;</span>
<a href="#l17.46"></a><span id="l17.46">             }</span>
<a href="#l17.47"></a><span id="l17.47">             taskEdit.setupTaskField(edit,</span>
<a href="#l17.48"></a><span id="l17.48">                                     false,</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineminus">-                                    calGetString(&quot;calendar&quot;, &quot;taskEditInstructions&quot;));</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineplus">+                                    cal.calGetString(&quot;calendar&quot;, &quot;taskEditInstructions&quot;));</span>
<a href="#l17.51"></a><span id="l17.51">         } else {</span>
<a href="#l17.52"></a><span id="l17.52">             taskEdit.setupTaskField(edit,</span>
<a href="#l17.53"></a><span id="l17.53">                                     true,</span>
<a href="#l17.54"></a><span id="l17.54" class="difflineminus">-                                    calGetString(&quot;calendar&quot;, &quot;taskEditInstructionsReadonly&quot;));</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineplus">+                                    cal.calGetString(&quot;calendar&quot;, &quot;taskEditInstructionsReadonly&quot;));</span>
<a href="#l17.56"></a><span id="l17.56">         }</span>
<a href="#l17.57"></a><span id="l17.57">         edit.showsInstructions = true;</span>
<a href="#l17.58"></a><span id="l17.58">     },</span>
<a href="#l17.59"></a><span id="l17.59"> </span>
<a href="#l17.60"></a><span id="l17.60">     /**</span>
<a href="#l17.61"></a><span id="l17.61">      * Handler function to call on keypress for the quick-add textbox.</span>
<a href="#l17.62"></a><span id="l17.62">      *</span>
<a href="#l17.63"></a><span id="l17.63">      * @param aEvent    The DOM keypress event</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/calendar/base/content/calendar-task-tree.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/calendar/base/content/calendar-task-tree.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -3,16 +3,18 @@</span>
<a href="#l18.4"></a><span id="l18.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l18.5"></a><span id="l18.5"> </span>
<a href="#l18.6"></a><span id="l18.6"> /* exported addCalendarNames, calendars, changeContextMenuForTask,</span>
<a href="#l18.7"></a><span id="l18.7">  *          contextChangeTaskCalendar, contextChangeTaskPriority,</span>
<a href="#l18.8"></a><span id="l18.8">  *          contextPostponeTask, modifyTaskFromContext, deleteToDoCommand,</span>
<a href="#l18.9"></a><span id="l18.9">  *          tasksToMail, tasksToEvents, toggleCompleted,</span>
<a href="#l18.10"></a><span id="l18.10">  */</span>
<a href="#l18.11"></a><span id="l18.11"> </span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+</span>
<a href="#l18.14"></a><span id="l18.14"> /**</span>
<a href="#l18.15"></a><span id="l18.15">  * Add registered calendars to the given menupopup. Removes all previous</span>
<a href="#l18.16"></a><span id="l18.16">  * children.</span>
<a href="#l18.17"></a><span id="l18.17">  *</span>
<a href="#l18.18"></a><span id="l18.18">  * XXX Either replace the existing items using replaceNode, or use helper</span>
<a href="#l18.19"></a><span id="l18.19">  * functions (cal.removeChildren).</span>
<a href="#l18.20"></a><span id="l18.20">  *</span>
<a href="#l18.21"></a><span id="l18.21">  * @param aEvent    The popupshowing event of the opening menu</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineat">@@ -21,17 +23,17 @@ function addCalendarNames(aEvent) {</span>
<a href="#l18.23"></a><span id="l18.23">     let calendarMenuPopup = aEvent.target;</span>
<a href="#l18.24"></a><span id="l18.24">     while (calendarMenuPopup.hasChildNodes()) {</span>
<a href="#l18.25"></a><span id="l18.25">         calendarMenuPopup.lastChild.remove();</span>
<a href="#l18.26"></a><span id="l18.26">     }</span>
<a href="#l18.27"></a><span id="l18.27">     let tasks = getSelectedTasks(aEvent);</span>
<a href="#l18.28"></a><span id="l18.28">     let tasksSelected = (tasks.length &gt; 0);</span>
<a href="#l18.29"></a><span id="l18.29">     if (tasksSelected) {</span>
<a href="#l18.30"></a><span id="l18.30">         let selIndex = appendCalendarItems(tasks[0], calendarMenuPopup, null, &quot;contextChangeTaskCalendar(event);&quot;);</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineminus">-        if (isPropertyValueSame(tasks, &quot;calendar&quot;) &amp;&amp; (selIndex &gt; -1)) {</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineplus">+        if (cal.isPropertyValueSame(tasks, &quot;calendar&quot;) &amp;&amp; (selIndex &gt; -1)) {</span>
<a href="#l18.33"></a><span id="l18.33">             calendarMenuPopup.childNodes[selIndex].setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l18.34"></a><span id="l18.34">         }</span>
<a href="#l18.35"></a><span id="l18.35">     }</span>
<a href="#l18.36"></a><span id="l18.36"> }</span>
<a href="#l18.37"></a><span id="l18.37"> </span>
<a href="#l18.38"></a><span id="l18.38"> /**</span>
<a href="#l18.39"></a><span id="l18.39">  * Change the opening context menu for the selected tasks.</span>
<a href="#l18.40"></a><span id="l18.40">  *</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineat">@@ -51,34 +53,34 @@ function changeContextMenuForTask(aEvent</span>
<a href="#l18.42"></a><span id="l18.42">     document.getElementById(&quot;task-context-menu-modify-todaypane&quot;).hidden =</span>
<a href="#l18.43"></a><span id="l18.43">         (idnode == &quot;calendar-task-tree&quot;);</span>
<a href="#l18.44"></a><span id="l18.44">     document.getElementById(&quot;task-context-menu-filter-todaypane&quot;).hidden =</span>
<a href="#l18.45"></a><span id="l18.45">         (idnode == &quot;calendar-task-tree&quot;);</span>
<a href="#l18.46"></a><span id="l18.46">     document.getElementById(&quot;task-context-menu-separator-filter&quot;).hidden =</span>
<a href="#l18.47"></a><span id="l18.47">         (idnode == &quot;calendar-task-tree&quot;);</span>
<a href="#l18.48"></a><span id="l18.48"> </span>
<a href="#l18.49"></a><span id="l18.49">     let tasksSelected = (items.length &gt; 0);</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineminus">-    applyAttributeToMenuChildren(aEvent.target, &quot;disabled&quot;, (!tasksSelected));</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineplus">+    cal.applyAttributeToMenuChildren(aEvent.target, &quot;disabled&quot;, !tasksSelected);</span>
<a href="#l18.52"></a><span id="l18.52">     if (calendarController.isCommandEnabled(&quot;calendar_new_todo_command&quot;) &amp;&amp;</span>
<a href="#l18.53"></a><span id="l18.53">         calendarController.isCommandEnabled(&quot;calendar_new_todo_todaypane_command&quot;)) {</span>
<a href="#l18.54"></a><span id="l18.54">         document.getElementById(&quot;calendar_new_todo_command&quot;).removeAttribute(&quot;disabled&quot;);</span>
<a href="#l18.55"></a><span id="l18.55">         document.getElementById(&quot;calendar_new_todo_todaypane_command&quot;).removeAttribute(&quot;disabled&quot;);</span>
<a href="#l18.56"></a><span id="l18.56">     } else {</span>
<a href="#l18.57"></a><span id="l18.57">         document.getElementById(&quot;calendar_new_todo_command&quot;).setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l18.58"></a><span id="l18.58">         document.getElementById(&quot;calendar_new_todo_todaypane_command&quot;).setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l18.59"></a><span id="l18.59">     }</span>
<a href="#l18.60"></a><span id="l18.60"> </span>
<a href="#l18.61"></a><span id="l18.61">     // make sure the &quot;Paste&quot; and &quot;Cut&quot; menu items are enabled</span>
<a href="#l18.62"></a><span id="l18.62">     goUpdateCommand(&quot;cmd_paste&quot;);</span>
<a href="#l18.63"></a><span id="l18.63">     goUpdateCommand(&quot;cmd_cut&quot;);</span>
<a href="#l18.64"></a><span id="l18.64"> </span>
<a href="#l18.65"></a><span id="l18.65">     // make sure the filter menu is enabled</span>
<a href="#l18.66"></a><span id="l18.66">     document.getElementById(&quot;task-context-menu-filter-todaypane&quot;).removeAttribute(&quot;disabled&quot;);</span>
<a href="#l18.67"></a><span id="l18.67" class="difflineminus">-    applyAttributeToMenuChildren(document.getElementById(&quot;task-context-menu-filter-todaypane-popup&quot;),</span>
<a href="#l18.68"></a><span id="l18.68" class="difflineminus">-                                 &quot;disabled&quot;, false);</span>
<a href="#l18.69"></a><span id="l18.69" class="difflineplus">+    cal.applyAttributeToMenuChildren(document.getElementById(&quot;task-context-menu-filter-todaypane-popup&quot;),</span>
<a href="#l18.70"></a><span id="l18.70" class="difflineplus">+                                     &quot;disabled&quot;, false);</span>
<a href="#l18.71"></a><span id="l18.71"> </span>
<a href="#l18.72"></a><span id="l18.72">     changeMenuForTask(aEvent);</span>
<a href="#l18.73"></a><span id="l18.73"> </span>
<a href="#l18.74"></a><span id="l18.74">     let menu = document.getElementById(&quot;task-context-menu-attendance-menu&quot;);</span>
<a href="#l18.75"></a><span id="l18.75">     setupAttendanceMenu(menu, items);</span>
<a href="#l18.76"></a><span id="l18.76"> }</span>
<a href="#l18.77"></a><span id="l18.77"> </span>
<a href="#l18.78"></a><span id="l18.78"> /**</span>
<a href="#l18.79"></a><span id="l18.79" class="difflineat">@@ -106,17 +108,17 @@ function changeMenuForTask(aEvent) {</span>
<a href="#l18.80"></a><span id="l18.80">      &quot;calendar_general-progress_command&quot;,</span>
<a href="#l18.81"></a><span id="l18.81">      &quot;calendar_general-priority_command&quot;,</span>
<a href="#l18.82"></a><span id="l18.82">      &quot;calendar_general-postpone_command&quot;].forEach(goUpdateCommand);</span>
<a href="#l18.83"></a><span id="l18.83"> </span>
<a href="#l18.84"></a><span id="l18.84">     let tasks = getSelectedTasks(aEvent);</span>
<a href="#l18.85"></a><span id="l18.85">     let tasksSelected = (tasks.length &gt; 0);</span>
<a href="#l18.86"></a><span id="l18.86">     if (tasksSelected) {</span>
<a href="#l18.87"></a><span id="l18.87">         let cmd = document.getElementById(&quot;calendar_toggle_completed_command&quot;);</span>
<a href="#l18.88"></a><span id="l18.88" class="difflineminus">-        if (isPropertyValueSame(tasks, &quot;isCompleted&quot;)) {</span>
<a href="#l18.89"></a><span id="l18.89" class="difflineplus">+        if (cal.isPropertyValueSame(tasks, &quot;isCompleted&quot;)) {</span>
<a href="#l18.90"></a><span id="l18.90">             setBooleanAttribute(cmd, &quot;checked&quot;, tasks[0].isCompleted);</span>
<a href="#l18.91"></a><span id="l18.91">         } else {</span>
<a href="#l18.92"></a><span id="l18.92">             setBooleanAttribute(cmd, &quot;checked&quot;, false);</span>
<a href="#l18.93"></a><span id="l18.93">         }</span>
<a href="#l18.94"></a><span id="l18.94">     }</span>
<a href="#l18.95"></a><span id="l18.95"> }</span>
<a href="#l18.96"></a><span id="l18.96"> </span>
<a href="#l18.97"></a><span id="l18.97"> /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/calendar/base/content/calendar-task-tree.xml</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/calendar/base/content/calendar-task-tree.xml</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -111,16 +111,17 @@</span>
<a href="#l19.4"></a><span id="l19.4">         &lt;xul:treechildren tooltip=&quot;taskTreeTooltip&quot; ondblclick=&quot;mTreeView.onDoubleClick(event)&quot;/&gt;</span>
<a href="#l19.5"></a><span id="l19.5">       &lt;/xul:tree&gt;</span>
<a href="#l19.6"></a><span id="l19.6">     &lt;/content&gt;</span>
<a href="#l19.7"></a><span id="l19.7"> </span>
<a href="#l19.8"></a><span id="l19.8">     &lt;implementation implements=&quot;nsIObserver&quot;&gt;</span>
<a href="#l19.9"></a><span id="l19.9">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l19.10"></a><span id="l19.10">         Components.utils.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l19.11"></a><span id="l19.11">         Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineplus">+        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l19.13"></a><span id="l19.13">         Components.utils.import(&quot;resource://calendar/modules/calItemUtils.jsm&quot;);</span>
<a href="#l19.14"></a><span id="l19.14">         Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l19.15"></a><span id="l19.15"> </span>
<a href="#l19.16"></a><span id="l19.16">         // set up the tree filter</span>
<a href="#l19.17"></a><span id="l19.17">         this.mFilter = new calFilter();</span>
<a href="#l19.18"></a><span id="l19.18"> </span>
<a href="#l19.19"></a><span id="l19.19">         // set up the custom tree view</span>
<a href="#l19.20"></a><span id="l19.20">         let tree = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;calendar-task-tree&quot;);</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineat">@@ -289,37 +290,37 @@</span>
<a href="#l19.22"></a><span id="l19.22">       &lt;method name=&quot;duration&quot;&gt;</span>
<a href="#l19.23"></a><span id="l19.23">         &lt;parameter name=&quot;aTask&quot;/&gt;</span>
<a href="#l19.24"></a><span id="l19.24">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.25"></a><span id="l19.25">           if (aTask &amp;&amp; aTask.dueDate &amp;&amp; aTask.dueDate.isValid) {</span>
<a href="#l19.26"></a><span id="l19.26">               let dur = aTask.dueDate.subtractDate(cal.now());</span>
<a href="#l19.27"></a><span id="l19.27">               if (!dur.isNegative) {</span>
<a href="#l19.28"></a><span id="l19.28">                   let minutes = Math.ceil(dur.inSeconds / 60);</span>
<a href="#l19.29"></a><span id="l19.29">                   if (minutes &gt;= 1440) { // 1 day or more</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineminus">-                      let dueIn = PluralForm.get(dur.days, calGetString(&quot;calendar&quot;, &quot;dueInDays&quot;));</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineplus">+                      let dueIn = PluralForm.get(dur.days, cal.calGetString(&quot;calendar&quot;, &quot;dueInDays&quot;));</span>
<a href="#l19.32"></a><span id="l19.32">                       return dueIn.replace(&quot;#1&quot;, dur.days);</span>
<a href="#l19.33"></a><span id="l19.33">                   } else if (minutes &gt;= 60) { // 1 hour or more</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineminus">-                      let dueIn = PluralForm.get(dur.hours, calGetString(&quot;calendar&quot;, &quot;dueInHours&quot;));</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineplus">+                      let dueIn = PluralForm.get(dur.hours, cal.calGetString(&quot;calendar&quot;, &quot;dueInHours&quot;));</span>
<a href="#l19.36"></a><span id="l19.36">                       return dueIn.replace(&quot;#1&quot;, dur.hours);</span>
<a href="#l19.37"></a><span id="l19.37">                   } else {</span>
<a href="#l19.38"></a><span id="l19.38">                       // Less than one hour</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineminus">-                      return calGetString(&quot;calendar&quot;, &quot;dueInLessThanOneHour&quot;);</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineplus">+                      return cal.calGetString(&quot;calendar&quot;, &quot;dueInLessThanOneHour&quot;);</span>
<a href="#l19.41"></a><span id="l19.41">                   }</span>
<a href="#l19.42"></a><span id="l19.42">               } else if (!aTask.completedDate || !aTask.completedDate.isValid) {</span>
<a href="#l19.43"></a><span id="l19.43">                   // Overdue task</span>
<a href="#l19.44"></a><span id="l19.44">                   let minutes = Math.ceil(-dur.inSeconds / 60);</span>
<a href="#l19.45"></a><span id="l19.45">                   if (minutes &gt;= 1440) { // 1 day or more</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineminus">-                      let dueIn = PluralForm.get(dur.days, calGetString(&quot;calendar&quot;, &quot;dueInDays&quot;));</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineplus">+                      let dueIn = PluralForm.get(dur.days, cal.calGetString(&quot;calendar&quot;, &quot;dueInDays&quot;));</span>
<a href="#l19.48"></a><span id="l19.48">                       return &quot;-&quot; + dueIn.replace(&quot;#1&quot;, dur.days);</span>
<a href="#l19.49"></a><span id="l19.49">                   } else if (minutes &gt;= 60) { // 1 hour or more</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineminus">-                      let dueIn = PluralForm.get(dur.hours, calGetString(&quot;calendar&quot;, &quot;dueInHours&quot;));</span>
<a href="#l19.51"></a><span id="l19.51" class="difflineplus">+                      let dueIn = PluralForm.get(dur.hours, cal.calGetString(&quot;calendar&quot;, &quot;dueInHours&quot;));</span>
<a href="#l19.52"></a><span id="l19.52">                       return &quot;-&quot; + dueIn.replace(&quot;#1&quot;, dur.hours);</span>
<a href="#l19.53"></a><span id="l19.53">                   } else {</span>
<a href="#l19.54"></a><span id="l19.54">                       // Less than one hour</span>
<a href="#l19.55"></a><span id="l19.55" class="difflineminus">-                      return calGetString(&quot;calendar&quot;, &quot;dueInLessThanOneHour&quot;);</span>
<a href="#l19.56"></a><span id="l19.56" class="difflineplus">+                      return cal.calGetString(&quot;calendar&quot;, &quot;dueInLessThanOneHour&quot;);</span>
<a href="#l19.57"></a><span id="l19.57">                   }</span>
<a href="#l19.58"></a><span id="l19.58">               }</span>
<a href="#l19.59"></a><span id="l19.59">           }</span>
<a href="#l19.60"></a><span id="l19.60">           // No due date specified</span>
<a href="#l19.61"></a><span id="l19.61">           return null;</span>
<a href="#l19.62"></a><span id="l19.62">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.63"></a><span id="l19.63">       &lt;/method&gt;</span>
<a href="#l19.64"></a><span id="l19.64">       &lt;method name=&quot;getTaskAtRow&quot;&gt;</span>
<a href="#l19.65"></a><span id="l19.65" class="difflineat">@@ -509,35 +510,35 @@</span>
<a href="#l19.66"></a><span id="l19.66">           getRowProperties: function(aRow) {</span>
<a href="#l19.67"></a><span id="l19.67">               let properties = [];</span>
<a href="#l19.68"></a><span id="l19.68">               let item = this.binding.mTaskArray[aRow];</span>
<a href="#l19.69"></a><span id="l19.69">               if (item.priority &gt; 0 &amp;&amp; item.priority &lt; 5) {</span>
<a href="#l19.70"></a><span id="l19.70">                   properties.push(&quot;highpriority&quot;);</span>
<a href="#l19.71"></a><span id="l19.71">               } else if (item.priority &gt; 5 &amp;&amp; item.priority &lt; 10) {</span>
<a href="#l19.72"></a><span id="l19.72">                   properties.push(&quot;lowpriority&quot;);</span>
<a href="#l19.73"></a><span id="l19.73">               }</span>
<a href="#l19.74"></a><span id="l19.74" class="difflineminus">-              properties.push(getProgressAtom(item));</span>
<a href="#l19.75"></a><span id="l19.75" class="difflineplus">+              properties.push(cal.getProgressAtom(item));</span>
<a href="#l19.76"></a><span id="l19.76"> </span>
<a href="#l19.77"></a><span id="l19.77">               // Add calendar name and id atom</span>
<a href="#l19.78"></a><span id="l19.78" class="difflineminus">-              properties.push(&quot;calendar-&quot; + formatStringForCSSRule(item.calendar.name));</span>
<a href="#l19.79"></a><span id="l19.79" class="difflineminus">-              properties.push(&quot;calendarid-&quot; + formatStringForCSSRule(item.calendar.id));</span>
<a href="#l19.80"></a><span id="l19.80" class="difflineplus">+              properties.push(&quot;calendar-&quot; + cal.formatStringForCSSRule(item.calendar.name));</span>
<a href="#l19.81"></a><span id="l19.81" class="difflineplus">+              properties.push(&quot;calendarid-&quot; + cal.formatStringForCSSRule(item.calendar.id));</span>
<a href="#l19.82"></a><span id="l19.82"> </span>
<a href="#l19.83"></a><span id="l19.83">               // Add item status atom</span>
<a href="#l19.84"></a><span id="l19.84">               if (item.status) {</span>
<a href="#l19.85"></a><span id="l19.85">                   properties.push(&quot;status-&quot; + item.status.toLowerCase());</span>
<a href="#l19.86"></a><span id="l19.86">               }</span>
<a href="#l19.87"></a><span id="l19.87"> </span>
<a href="#l19.88"></a><span id="l19.88">               // Alarm status atom</span>
<a href="#l19.89"></a><span id="l19.89">               if (item.getAlarms({}).length) {</span>
<a href="#l19.90"></a><span id="l19.90">                   properties.push(&quot;alarm&quot;);</span>
<a href="#l19.91"></a><span id="l19.91">               }</span>
<a href="#l19.92"></a><span id="l19.92"> </span>
<a href="#l19.93"></a><span id="l19.93">               // Task categories</span>
<a href="#l19.94"></a><span id="l19.94">               properties = properties.concat(item.getCategories({})</span>
<a href="#l19.95"></a><span id="l19.95" class="difflineminus">-                                                 .map(formatStringForCSSRule));</span>
<a href="#l19.96"></a><span id="l19.96" class="difflineplus">+                                                 .map(cal.formatStringForCSSRule));</span>
<a href="#l19.97"></a><span id="l19.97"> </span>
<a href="#l19.98"></a><span id="l19.98">               return properties.join(&quot; &quot;);</span>
<a href="#l19.99"></a><span id="l19.99">           },</span>
<a href="#l19.100"></a><span id="l19.100"> </span>
<a href="#l19.101"></a><span id="l19.101">           // Called on the view when a cell in a non-selectable cycling</span>
<a href="#l19.102"></a><span id="l19.102">           // column (e.g., unread/flag/etc.) is clicked.</span>
<a href="#l19.103"></a><span id="l19.103">           cycleCell: function(aRow, aCol) {</span>
<a href="#l19.104"></a><span id="l19.104">               let task = this.binding.mTaskArray[aRow];</span>
<a href="#l19.105"></a><span id="l19.105" class="difflineat">@@ -584,23 +585,23 @@</span>
<a href="#l19.106"></a><span id="l19.106">               let task = this.binding.mTaskArray[aRow];</span>
<a href="#l19.107"></a><span id="l19.107">               if (!task) {</span>
<a href="#l19.108"></a><span id="l19.108">                   return false;</span>
<a href="#l19.109"></a><span id="l19.109">               }</span>
<a href="#l19.110"></a><span id="l19.110"> </span>
<a href="#l19.111"></a><span id="l19.111">               switch (aCol.element.getAttribute(&quot;itemproperty&quot;)) {</span>
<a href="#l19.112"></a><span id="l19.112">                   case &quot;title&quot;:</span>
<a href="#l19.113"></a><span id="l19.113">                       // return title, or &quot;Untitled&quot; if empty/null</span>
<a href="#l19.114"></a><span id="l19.114" class="difflineminus">-                      return (task.title ? task.title.replace(/\n/g, &quot; &quot;) : calGetString(&quot;calendar&quot;, &quot;eventUntitled&quot;));</span>
<a href="#l19.115"></a><span id="l19.115" class="difflineplus">+                      return (task.title ? task.title.replace(/\n/g, &quot; &quot;) : cal.calGetString(&quot;calendar&quot;, &quot;eventUntitled&quot;));</span>
<a href="#l19.116"></a><span id="l19.116">                   case &quot;entryDate&quot;:</span>
<a href="#l19.117"></a><span id="l19.117" class="difflineminus">-                      return task.recurrenceInfo ? calGetString(&quot;dateFormat&quot;, &quot;Repeating&quot;) : this._formatDateTime(task.entryDate);</span>
<a href="#l19.118"></a><span id="l19.118" class="difflineplus">+                      return task.recurrenceInfo ? cal.calGetString(&quot;dateFormat&quot;, &quot;Repeating&quot;) : this._formatDateTime(task.entryDate);</span>
<a href="#l19.119"></a><span id="l19.119">                   case &quot;dueDate&quot;:</span>
<a href="#l19.120"></a><span id="l19.120" class="difflineminus">-                      return task.recurrenceInfo ? calGetString(&quot;dateFormat&quot;, &quot;Repeating&quot;) : this._formatDateTime(task.dueDate);</span>
<a href="#l19.121"></a><span id="l19.121" class="difflineplus">+                      return task.recurrenceInfo ? cal.calGetString(&quot;dateFormat&quot;, &quot;Repeating&quot;) : this._formatDateTime(task.dueDate);</span>
<a href="#l19.122"></a><span id="l19.122">                   case &quot;completedDate&quot;:</span>
<a href="#l19.123"></a><span id="l19.123" class="difflineminus">-                      return task.recurrenceInfo ? calGetString(&quot;dateFormat&quot;, &quot;Repeating&quot;) : this._formatDateTime(task.completedDate);</span>
<a href="#l19.124"></a><span id="l19.124" class="difflineplus">+                      return task.recurrenceInfo ? cal.calGetString(&quot;dateFormat&quot;, &quot;Repeating&quot;) : this._formatDateTime(task.completedDate);</span>
<a href="#l19.125"></a><span id="l19.125">                   case &quot;percentComplete&quot;:</span>
<a href="#l19.126"></a><span id="l19.126">                       return (task.percentComplete &gt; 0 ? task.percentComplete + &quot;%&quot; : &quot;&quot;);</span>
<a href="#l19.127"></a><span id="l19.127">                   case &quot;categories&quot;:</span>
<a href="#l19.128"></a><span id="l19.128">                       return task.getCategories({}).join(&quot;, &quot;); // TODO l10n-unfriendly</span>
<a href="#l19.129"></a><span id="l19.129">                   case &quot;location&quot;:</span>
<a href="#l19.130"></a><span id="l19.130">                       return task.getProperty(&quot;LOCATION&quot;);</span>
<a href="#l19.131"></a><span id="l19.131">                   case &quot;status&quot;:</span>
<a href="#l19.132"></a><span id="l19.132">                       return getToDoStatusString(task);</span>
<a href="#l19.133"></a><span id="l19.133" class="difflineat">@@ -723,17 +724,17 @@</span>
<a href="#l19.134"></a><span id="l19.134"> </span>
<a href="#l19.135"></a><span id="l19.135">           /**</span>
<a href="#l19.136"></a><span id="l19.136">            * Task Tree Events</span>
<a href="#l19.137"></a><span id="l19.137">            */</span>
<a href="#l19.138"></a><span id="l19.138">           onSelect: function(event) {},</span>
<a href="#l19.139"></a><span id="l19.139"> </span>
<a href="#l19.140"></a><span id="l19.140">           onDoubleClick: function(event) {</span>
<a href="#l19.141"></a><span id="l19.141">               if (event.button == 0) {</span>
<a href="#l19.142"></a><span id="l19.142" class="difflineminus">-                  let initialDate = getDefaultStartDate(this.binding.getInitialDate());</span>
<a href="#l19.143"></a><span id="l19.143" class="difflineplus">+                  let initialDate = cal.getDefaultStartDate(this.binding.getInitialDate());</span>
<a href="#l19.144"></a><span id="l19.144">                   let col = {};</span>
<a href="#l19.145"></a><span id="l19.145">                   let item = this._getItemFromEvent(event, col);</span>
<a href="#l19.146"></a><span id="l19.146">                   if (item) {</span>
<a href="#l19.147"></a><span id="l19.147">                       let colAnonId = col.value.element.getAttribute(&quot;itemproperty&quot;);</span>
<a href="#l19.148"></a><span id="l19.148">                       if (colAnonId == &quot;completed&quot;) {</span>
<a href="#l19.149"></a><span id="l19.149">                           // item holds checkbox state toggled by first click,</span>
<a href="#l19.150"></a><span id="l19.150">                           // so don't call modifyEventWithDialog</span>
<a href="#l19.151"></a><span id="l19.151">                           // to make sure user notices state changed.</span>
<a href="#l19.152"></a><span id="l19.152" class="difflineat">@@ -803,17 +804,17 @@</span>
<a href="#l19.153"></a><span id="l19.153"> </span>
<a href="#l19.154"></a><span id="l19.154">           // Helper function to display datetimes</span>
<a href="#l19.155"></a><span id="l19.155">           _formatDateTime: function(aDateTime) {</span>
<a href="#l19.156"></a><span id="l19.156">               let dateFormatter = Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l19.157"></a><span id="l19.157">                                             .getService(Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l19.158"></a><span id="l19.158"> </span>
<a href="#l19.159"></a><span id="l19.159">               // datetime is from todo object, it is not a javascript date</span>
<a href="#l19.160"></a><span id="l19.160">               if (aDateTime &amp;&amp; aDateTime.isValid) {</span>
<a href="#l19.161"></a><span id="l19.161" class="difflineminus">-                  let dateTime = aDateTime.getInTimezone(calendarDefaultTimezone());</span>
<a href="#l19.162"></a><span id="l19.162" class="difflineplus">+                  let dateTime = aDateTime.getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l19.163"></a><span id="l19.163">                   return dateFormatter.formatDateTime(dateTime);</span>
<a href="#l19.164"></a><span id="l19.164">               }</span>
<a href="#l19.165"></a><span id="l19.165">               return &quot;&quot;;</span>
<a href="#l19.166"></a><span id="l19.166">           }</span>
<a href="#l19.167"></a><span id="l19.167">       })</span>
<a href="#l19.168"></a><span id="l19.168">       ]]&gt;&lt;/field&gt;</span>
<a href="#l19.169"></a><span id="l19.169"> </span>
<a href="#l19.170"></a><span id="l19.170">       &lt;!--</span>
<a href="#l19.171"></a><span id="l19.171" class="difflineat">@@ -1012,17 +1013,17 @@</span>
<a href="#l19.172"></a><span id="l19.172">               let modifier = (this.mTreeView.sortDirection == &quot;descending&quot; ? -1 : 1);</span>
<a href="#l19.173"></a><span id="l19.173">               let column = this.mTreeView.selectedColumn;</span>
<a href="#l19.174"></a><span id="l19.174">               cal.sortEntry.mSortKey = column.getAttribute(&quot;sortKey&quot;)</span>
<a href="#l19.175"></a><span id="l19.175">                                        ? column.getAttribute(&quot;sortKey&quot;)</span>
<a href="#l19.176"></a><span id="l19.176">                                        : column.getAttribute(&quot;itemproperty&quot;);</span>
<a href="#l19.177"></a><span id="l19.177">               let sortType = cal.getSortTypeForSortKey(cal.sortEntry.mSortKey);</span>
<a href="#l19.178"></a><span id="l19.178"> </span>
<a href="#l19.179"></a><span id="l19.179">               // sort (key,item) entries</span>
<a href="#l19.180"></a><span id="l19.180" class="difflineminus">-              cal.sortEntry.mSortStartedDate = now();</span>
<a href="#l19.181"></a><span id="l19.181" class="difflineplus">+              cal.sortEntry.mSortStartedDate = cal.now();</span>
<a href="#l19.182"></a><span id="l19.182">               let entries = this.mTaskArray.map(cal.sortEntry, cal.sortEntry);</span>
<a href="#l19.183"></a><span id="l19.183">               entries.sort(cal.sortEntryComparer(sortType, modifier));</span>
<a href="#l19.184"></a><span id="l19.184">               this.mTaskArray = entries.map(cal.sortEntryItem);</span>
<a href="#l19.185"></a><span id="l19.185">           }</span>
<a href="#l19.186"></a><span id="l19.186"> </span>
<a href="#l19.187"></a><span id="l19.187">           this.recreateHashTable();</span>
<a href="#l19.188"></a><span id="l19.188">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.189"></a><span id="l19.189">       &lt;/method&gt;</span>
<a href="#l19.190"></a><span id="l19.190" class="difflineat">@@ -1038,17 +1039,17 @@</span>
<a href="#l19.191"></a><span id="l19.191">               this.mTreeView.treebox.invalidate();</span>
<a href="#l19.192"></a><span id="l19.192">           }</span>
<a href="#l19.193"></a><span id="l19.193">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.194"></a><span id="l19.194">       &lt;/method&gt;</span>
<a href="#l19.195"></a><span id="l19.195"> </span>
<a href="#l19.196"></a><span id="l19.196">       &lt;method name=&quot;getInitialDate&quot;&gt;</span>
<a href="#l19.197"></a><span id="l19.197">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.198"></a><span id="l19.198">           let initialDate = currentView().selectedDay;</span>
<a href="#l19.199"></a><span id="l19.199" class="difflineminus">-          return initialDate ? initialDate : now();</span>
<a href="#l19.200"></a><span id="l19.200" class="difflineplus">+          return initialDate ? initialDate : cal.now();</span>
<a href="#l19.201"></a><span id="l19.201">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.202"></a><span id="l19.202">       &lt;/method&gt;</span>
<a href="#l19.203"></a><span id="l19.203"> </span>
<a href="#l19.204"></a><span id="l19.204">       &lt;method name=&quot;doUpdateFilter&quot;&gt;</span>
<a href="#l19.205"></a><span id="l19.205">         &lt;parameter name=&quot;aFilter&quot;/&gt;</span>
<a href="#l19.206"></a><span id="l19.206">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.207"></a><span id="l19.207">           let needsRefresh = false;</span>
<a href="#l19.208"></a><span id="l19.208">           let oldStart = this.mFilter.mStartDate;</span>
<a href="#l19.209"></a><span id="l19.209" class="difflineat">@@ -1163,36 +1164,41 @@</span>
<a href="#l19.210"></a><span id="l19.210">                 rowY = rowY + rowHeight;</span>
<a href="#l19.211"></a><span id="l19.211">             }</span>
<a href="#l19.212"></a><span id="l19.212"> </span>
<a href="#l19.213"></a><span id="l19.213">             // and finally, clip the result to be sure we don't spill over...</span>
<a href="#l19.214"></a><span id="l19.214">             if (!region.isEmpty()) {</span>
<a href="#l19.215"></a><span id="l19.215">                 region.intersectRect(bodyBox.x, bodyBox.y, bodyBox.width, bodyBox.height);</span>
<a href="#l19.216"></a><span id="l19.216">             }</span>
<a href="#l19.217"></a><span id="l19.217">         } catch (ex) {</span>
<a href="#l19.218"></a><span id="l19.218" class="difflineminus">-            ASSERT(false, &quot;Error while building selection region: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l19.219"></a><span id="l19.219" class="difflineplus">+            cal.ASSERT(false, &quot;Error while building selection region: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l19.220"></a><span id="l19.220">             region = null;</span>
<a href="#l19.221"></a><span id="l19.221">         }</span>
<a href="#l19.222"></a><span id="l19.222">         invokeEventDragSession(item, event.target);</span>
<a href="#l19.223"></a><span id="l19.223">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l19.224"></a><span id="l19.224">     &lt;/handlers&gt;</span>
<a href="#l19.225"></a><span id="l19.225"> </span>
<a href="#l19.226"></a><span id="l19.226">   &lt;/binding&gt;</span>
<a href="#l19.227"></a><span id="l19.227"> </span>
<a href="#l19.228"></a><span id="l19.228">   &lt;binding id=&quot;calendar-task-tree-todaypane&quot; extends=&quot;chrome://calendar/content/calendar-task-tree.xml#calendar-task-tree&quot;&gt;</span>
<a href="#l19.229"></a><span id="l19.229">     &lt;implementation&gt;</span>
<a href="#l19.230"></a><span id="l19.230" class="difflineplus">+      &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l19.231"></a><span id="l19.231" class="difflineplus">+        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l19.232"></a><span id="l19.232" class="difflineplus">+      ]]&gt;&lt;/constructor&gt;</span>
<a href="#l19.233"></a><span id="l19.233" class="difflineplus">+</span>
<a href="#l19.234"></a><span id="l19.234">       &lt;method name=&quot;getInitialDate&quot;&gt;</span>
<a href="#l19.235"></a><span id="l19.235">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.236"></a><span id="l19.236" class="difflineminus">-          let initialDate = agendaListbox.today ? agendaListbox.today.start : now();</span>
<a href="#l19.237"></a><span id="l19.237" class="difflineminus">-          return initialDate ? initialDate : now();</span>
<a href="#l19.238"></a><span id="l19.238" class="difflineplus">+          let initialDate = agendaListbox.today ? agendaListbox.today.start : cal.now();</span>
<a href="#l19.239"></a><span id="l19.239" class="difflineplus">+          return initialDate ? initialDate : cal.now();</span>
<a href="#l19.240"></a><span id="l19.240">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.241"></a><span id="l19.241">       &lt;/method&gt;</span>
<a href="#l19.242"></a><span id="l19.242" class="difflineplus">+</span>
<a href="#l19.243"></a><span id="l19.243">       &lt;method name=&quot;updateFilter&quot;&gt;</span>
<a href="#l19.244"></a><span id="l19.244">         &lt;parameter name=&quot;aFilter&quot;/&gt;</span>
<a href="#l19.245"></a><span id="l19.245">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l19.246"></a><span id="l19.246">           this.mFilter.selectedDate = agendaListbox.today &amp;&amp; agendaListbox.today.start ?</span>
<a href="#l19.247"></a><span id="l19.247" class="difflineminus">-                                      agendaListbox.today.start : now();</span>
<a href="#l19.248"></a><span id="l19.248" class="difflineplus">+                                      agendaListbox.today.start : cal.now();</span>
<a href="#l19.249"></a><span id="l19.249">           this.doUpdateFilter(aFilter);</span>
<a href="#l19.250"></a><span id="l19.250">         ]]&gt;&lt;/body&gt;</span>
<a href="#l19.251"></a><span id="l19.251">       &lt;/method&gt;</span>
<a href="#l19.252"></a><span id="l19.252">     &lt;/implementation&gt;</span>
<a href="#l19.253"></a><span id="l19.253">   &lt;/binding&gt;</span>
<a href="#l19.254"></a><span id="l19.254"> &lt;/bindings&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/calendar/base/content/calendar-task-view.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/calendar/base/content/calendar-task-view.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -1,14 +1,15 @@</span>
<a href="#l20.4"></a><span id="l20.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l20.5"></a><span id="l20.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l20.6"></a><span id="l20.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l20.7"></a><span id="l20.7"> </span>
<a href="#l20.8"></a><span id="l20.8"> /* exported taskDetailsView, sendMailToOrganizer, taskViewCopyLink */</span>
<a href="#l20.9"></a><span id="l20.9"> </span>
<a href="#l20.10"></a><span id="l20.10" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l20.11"></a><span id="l20.11"> Components.utils.import(&quot;resource://calendar/modules/calRecurrenceUtils.jsm&quot;);</span>
<a href="#l20.12"></a><span id="l20.12"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l20.13"></a><span id="l20.13"> Components.utils.import(&quot;resource://gre/modules/AppConstants.jsm&quot;);</span>
<a href="#l20.14"></a><span id="l20.14"> </span>
<a href="#l20.15"></a><span id="l20.15"> var taskDetailsView = {</span>
<a href="#l20.16"></a><span id="l20.16"> </span>
<a href="#l20.17"></a><span id="l20.17">     /**</span>
<a href="#l20.18"></a><span id="l20.18">      * Task Details Events</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineat">@@ -60,45 +61,45 @@ var taskDetailsView = {</span>
<a href="#l20.20"></a><span id="l20.20">             displayElement(&quot;calendar-task-details-priority-normal&quot;, priority == 5);</span>
<a href="#l20.21"></a><span id="l20.21">             displayElement(&quot;calendar-task-details-priority-high&quot;, priority &gt;= 1 &amp;&amp; priority &lt;= 4);</span>
<a href="#l20.22"></a><span id="l20.22"> </span>
<a href="#l20.23"></a><span id="l20.23">             let status = item.getProperty(&quot;STATUS&quot;);</span>
<a href="#l20.24"></a><span id="l20.24">             if (displayElement(&quot;calendar-task-details-status-row&quot;, status &amp;&amp; status.length &gt; 0)) {</span>
<a href="#l20.25"></a><span id="l20.25">                 let statusDetails = document.getElementById(&quot;calendar-task-details-status&quot;);</span>
<a href="#l20.26"></a><span id="l20.26">                 switch (status) {</span>
<a href="#l20.27"></a><span id="l20.27">                     case &quot;NEEDS-ACTION&quot;: {</span>
<a href="#l20.28"></a><span id="l20.28" class="difflineminus">-                        statusDetails.value = calGetString(</span>
<a href="#l20.29"></a><span id="l20.29" class="difflineplus">+                        statusDetails.value = cal.calGetString(</span>
<a href="#l20.30"></a><span id="l20.30">                             &quot;calendar&quot;,</span>
<a href="#l20.31"></a><span id="l20.31">                             &quot;taskDetailsStatusNeedsAction&quot;);</span>
<a href="#l20.32"></a><span id="l20.32">                         break;</span>
<a href="#l20.33"></a><span id="l20.33">                     }</span>
<a href="#l20.34"></a><span id="l20.34">                     case &quot;IN-PROCESS&quot;: {</span>
<a href="#l20.35"></a><span id="l20.35">                         let percent = 0;</span>
<a href="#l20.36"></a><span id="l20.36">                         let property = item.getProperty(&quot;PERCENT-COMPLETE&quot;);</span>
<a href="#l20.37"></a><span id="l20.37">                         if (property != null) {</span>
<a href="#l20.38"></a><span id="l20.38">                             percent = parseInt(property, 10);</span>
<a href="#l20.39"></a><span id="l20.39">                         }</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineminus">-                        statusDetails.value = calGetString(</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineplus">+                        statusDetails.value = cal.calGetString(</span>
<a href="#l20.42"></a><span id="l20.42">                             &quot;calendar&quot;,</span>
<a href="#l20.43"></a><span id="l20.43">                             &quot;taskDetailsStatusInProgress&quot;, [percent]);</span>
<a href="#l20.44"></a><span id="l20.44">                         break;</span>
<a href="#l20.45"></a><span id="l20.45">                     }</span>
<a href="#l20.46"></a><span id="l20.46">                     case &quot;COMPLETED&quot;: {</span>
<a href="#l20.47"></a><span id="l20.47">                         if (item.completedDate) {</span>
<a href="#l20.48"></a><span id="l20.48">                             let completedDate = item.completedDate.getInTimezone(</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineminus">-                                                    calendarDefaultTimezone());</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineminus">-                            statusDetails.value = calGetString(</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineplus">+                                                    cal.calendarDefaultTimezone());</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineplus">+                            statusDetails.value = cal.calGetString(</span>
<a href="#l20.53"></a><span id="l20.53">                                 &quot;calendar&quot;,</span>
<a href="#l20.54"></a><span id="l20.54">                                 &quot;taskDetailsStatusCompletedOn&quot;,</span>
<a href="#l20.55"></a><span id="l20.55">                                 [dateFormatter.formatDateTime(completedDate)]);</span>
<a href="#l20.56"></a><span id="l20.56">                         }</span>
<a href="#l20.57"></a><span id="l20.57">                         break;</span>
<a href="#l20.58"></a><span id="l20.58">                     }</span>
<a href="#l20.59"></a><span id="l20.59">                     case &quot;CANCELLED&quot;: {</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineminus">-                        statusDetails.value = calGetString(</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineplus">+                        statusDetails.value = cal.calGetString(</span>
<a href="#l20.62"></a><span id="l20.62">                             &quot;calendar&quot;,</span>
<a href="#l20.63"></a><span id="l20.63">                             &quot;taskDetailsStatusCancelled&quot;);</span>
<a href="#l20.64"></a><span id="l20.64">                         break;</span>
<a href="#l20.65"></a><span id="l20.65">                     }</span>
<a href="#l20.66"></a><span id="l20.66">                     default: {</span>
<a href="#l20.67"></a><span id="l20.67">                         displayElement(&quot;calendar-task-details-status-row&quot;, false);</span>
<a href="#l20.68"></a><span id="l20.68">                         break;</span>
<a href="#l20.69"></a><span id="l20.69">                     }</span>
<a href="#l20.70"></a><span id="l20.70" class="difflineat">@@ -113,17 +114,17 @@ var taskDetailsView = {</span>
<a href="#l20.71"></a><span id="l20.71">             let parentItem = item;</span>
<a href="#l20.72"></a><span id="l20.72">             if (parentItem.parentItem != parentItem) {</span>
<a href="#l20.73"></a><span id="l20.73">                 // XXXdbo Didn't we want to get rid of these checks?</span>
<a href="#l20.74"></a><span id="l20.74">                 parentItem = parentItem.parentItem;</span>
<a href="#l20.75"></a><span id="l20.75">             }</span>
<a href="#l20.76"></a><span id="l20.76">             let recurrenceInfo = parentItem.recurrenceInfo;</span>
<a href="#l20.77"></a><span id="l20.77">             let recurStart = parentItem.recurrenceStartDate;</span>
<a href="#l20.78"></a><span id="l20.78">             if (displayElement(&quot;calendar-task-details-repeat-row&quot;, recurrenceInfo &amp;&amp; recurStart)) {</span>
<a href="#l20.79"></a><span id="l20.79" class="difflineminus">-                let kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l20.80"></a><span id="l20.80" class="difflineplus">+                let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l20.81"></a><span id="l20.81">                 let startDate = recurStart.getInTimezone(kDefaultTimezone);</span>
<a href="#l20.82"></a><span id="l20.82">                 let endDate = item.dueDate ? item.dueDate.getInTimezone(kDefaultTimezone) : null;</span>
<a href="#l20.83"></a><span id="l20.83">                 let detailsString = recurrenceRule2String(recurrenceInfo, startDate, endDate, startDate.isDate);</span>
<a href="#l20.84"></a><span id="l20.84">                 if (detailsString) {</span>
<a href="#l20.85"></a><span id="l20.85">                     let rpv = document.getElementById(&quot;calendar-task-details-repeat&quot;);</span>
<a href="#l20.86"></a><span id="l20.86">                     rpv.value = detailsString.split(&quot;\n&quot;).join(&quot; &quot;);</span>
<a href="#l20.87"></a><span id="l20.87">                 }</span>
<a href="#l20.88"></a><span id="l20.88">             }</span>
<a href="#l20.89"></a><span id="l20.89" class="difflineat">@@ -218,17 +219,17 @@ function taskViewUpdate(aFilter) {</span>
<a href="#l20.90"></a><span id="l20.90">  */</span>
<a href="#l20.91"></a><span id="l20.91"> function sendMailToOrganizer() {</span>
<a href="#l20.92"></a><span id="l20.92">     let item = document.getElementById(&quot;calendar-task-tree&quot;).currentTask;</span>
<a href="#l20.93"></a><span id="l20.93">     if (item != null) {</span>
<a href="#l20.94"></a><span id="l20.94">         let organizer = item.organizer;</span>
<a href="#l20.95"></a><span id="l20.95">         let email = cal.getAttendeeEmail(organizer, true);</span>
<a href="#l20.96"></a><span id="l20.96">         let emailSubject = cal.calGetString(&quot;calendar-event-dialog&quot;, &quot;emailSubjectReply&quot;, [item.title]);</span>
<a href="#l20.97"></a><span id="l20.97">         let identity = item.calendar.getProperty(&quot;imip.identity&quot;);</span>
<a href="#l20.98"></a><span id="l20.98" class="difflineminus">-        sendMailTo(email, emailSubject, null, identity);</span>
<a href="#l20.99"></a><span id="l20.99" class="difflineplus">+        cal.sendMailTo(email, emailSubject, null, identity);</span>
<a href="#l20.100"></a><span id="l20.100">     }</span>
<a href="#l20.101"></a><span id="l20.101"> }</span>
<a href="#l20.102"></a><span id="l20.102"> </span>
<a href="#l20.103"></a><span id="l20.103"> /**</span>
<a href="#l20.104"></a><span id="l20.104">  * Handler function to observe changing of the calendar display deck. Updates</span>
<a href="#l20.105"></a><span id="l20.105">  * the task tree if the task view was selected.</span>
<a href="#l20.106"></a><span id="l20.106">  *</span>
<a href="#l20.107"></a><span id="l20.107">  * TODO Consolidate this function and anything connected, its still from times</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/calendar/base/content/calendar-ui-utils.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/calendar/base/content/calendar-ui-utils.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -287,20 +287,20 @@ function appendCalendarItems(aItem, aCal</span>
<a href="#l21.4"></a><span id="l21.4">     let calendarToUse = aCalendarToUse || aItem.calendar;</span>
<a href="#l21.5"></a><span id="l21.5">     let calendars = sortCalendarArray(cal.getCalendarManager().getCalendars({}));</span>
<a href="#l21.6"></a><span id="l21.6">     let indexToSelect = 0;</span>
<a href="#l21.7"></a><span id="l21.7">     let index = -1;</span>
<a href="#l21.8"></a><span id="l21.8">     for (let i = 0; i &lt; calendars.length; ++i) {</span>
<a href="#l21.9"></a><span id="l21.9">         let calendar = calendars[i];</span>
<a href="#l21.10"></a><span id="l21.10">         if (calendar.id == calendarToUse.id ||</span>
<a href="#l21.11"></a><span id="l21.11">             (calendar &amp;&amp;</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-             isCalendarWritable(calendar) &amp;&amp;</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-             (userCanAddItemsToCalendar(calendar) ||</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineminus">-              (calendar == aItem.calendar &amp;&amp; userCanModifyItem(aItem))) &amp;&amp;</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineminus">-             isItemSupported(aItem, calendar))) {</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineplus">+             cal.isCalendarWritable(calendar) &amp;&amp;</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineplus">+             (cal.userCanAddItemsToCalendar(calendar) ||</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineplus">+              (calendar == aItem.calendar &amp;&amp; cal.userCanModifyItem(aItem))) &amp;&amp;</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineplus">+             cal.isItemSupported(aItem, calendar))) {</span>
<a href="#l21.20"></a><span id="l21.20">             let menuitem = addMenuItem(aCalendarMenuParent, calendar.name, calendar.name);</span>
<a href="#l21.21"></a><span id="l21.21">             menuitem.calendar = calendar;</span>
<a href="#l21.22"></a><span id="l21.22">             index++;</span>
<a href="#l21.23"></a><span id="l21.23">             if (aOnCommand) {</span>
<a href="#l21.24"></a><span id="l21.24">                 menuitem.setAttribute(&quot;oncommand&quot;, aOnCommand);</span>
<a href="#l21.25"></a><span id="l21.25">             }</span>
<a href="#l21.26"></a><span id="l21.26">             if (aCalendarMenuParent.localName == &quot;menupopup&quot;) {</span>
<a href="#l21.27"></a><span id="l21.27">                 menuitem.setAttribute(&quot;type&quot;, &quot;checkbox&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/calendar/base/content/calendar-unifinder.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/calendar/base/content/calendar-unifinder.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -77,31 +77,31 @@ var unifinderObserver = {</span>
<a href="#l22.4"></a><span id="l22.4">             // those operations and refresh as soon as the unifinder is shown</span>
<a href="#l22.5"></a><span id="l22.5">             // again.</span>
<a href="#l22.6"></a><span id="l22.6">             gUnifinderNeedsRefresh = true;</span>
<a href="#l22.7"></a><span id="l22.7">             unifinderTreeView.clearItems();</span>
<a href="#l22.8"></a><span id="l22.8">         }</span>
<a href="#l22.9"></a><span id="l22.9">     },</span>
<a href="#l22.10"></a><span id="l22.10"> </span>
<a href="#l22.11"></a><span id="l22.11">     onAddItem: function(aItem) {</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-        if (isEvent(aItem) &amp;&amp;</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+        if (cal.isEvent(aItem) &amp;&amp;</span>
<a href="#l22.14"></a><span id="l22.14">             !gUnifinderNeedsRefresh &amp;&amp;</span>
<a href="#l22.15"></a><span id="l22.15">             unifinderTreeView.mFilter.isItemInFilters(aItem)</span>
<a href="#l22.16"></a><span id="l22.16">             ) {</span>
<a href="#l22.17"></a><span id="l22.17">             this.addItemToTree(aItem);</span>
<a href="#l22.18"></a><span id="l22.18">         }</span>
<a href="#l22.19"></a><span id="l22.19">     },</span>
<a href="#l22.20"></a><span id="l22.20"> </span>
<a href="#l22.21"></a><span id="l22.21">     onModifyItem: function(aNewItem, aOldItem) {</span>
<a href="#l22.22"></a><span id="l22.22">         this.onDeleteItem(aOldItem);</span>
<a href="#l22.23"></a><span id="l22.23">         this.onAddItem(aNewItem);</span>
<a href="#l22.24"></a><span id="l22.24">     },</span>
<a href="#l22.25"></a><span id="l22.25"> </span>
<a href="#l22.26"></a><span id="l22.26">     onDeleteItem: function(aDeletedItem) {</span>
<a href="#l22.27"></a><span id="l22.27" class="difflineminus">-        if (isEvent(aDeletedItem) &amp;&amp; !gUnifinderNeedsRefresh) {</span>
<a href="#l22.28"></a><span id="l22.28" class="difflineplus">+        if (cal.isEvent(aDeletedItem) &amp;&amp; !gUnifinderNeedsRefresh) {</span>
<a href="#l22.29"></a><span id="l22.29">             this.removeItemFromTree(aDeletedItem);</span>
<a href="#l22.30"></a><span id="l22.30">         }</span>
<a href="#l22.31"></a><span id="l22.31">     },</span>
<a href="#l22.32"></a><span id="l22.32"> </span>
<a href="#l22.33"></a><span id="l22.33">     onError: function(aCalendar, aErrNo, aMessage) {},</span>
<a href="#l22.34"></a><span id="l22.34"> </span>
<a href="#l22.35"></a><span id="l22.35">     onPropertyChanged: function(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l22.36"></a><span id="l22.36">         switch (aName) {</span>
<a href="#l22.37"></a><span id="l22.37" class="difflineat">@@ -193,17 +193,17 @@ function prepareCalendarUnifinder() {</span>
<a href="#l22.38"></a><span id="l22.38">     branch.addObserver(&quot;calendar.&quot;, unifinderObserver, false);</span>
<a href="#l22.39"></a><span id="l22.39"> </span>
<a href="#l22.40"></a><span id="l22.40">     // Check if this is not the hidden window, which has no UI elements</span>
<a href="#l22.41"></a><span id="l22.41">     if (unifinderTree) {</span>
<a href="#l22.42"></a><span id="l22.42">         // set up our calendar event observer</span>
<a href="#l22.43"></a><span id="l22.43">         let ccalendar = cal.getCompositeCalendar(window);</span>
<a href="#l22.44"></a><span id="l22.44">         ccalendar.addObserver(unifinderObserver);</span>
<a href="#l22.45"></a><span id="l22.45"> </span>
<a href="#l22.46"></a><span id="l22.46" class="difflineminus">-        kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l22.47"></a><span id="l22.47" class="difflineplus">+        kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l22.48"></a><span id="l22.48"> </span>
<a href="#l22.49"></a><span id="l22.49">         // Set up the filter</span>
<a href="#l22.50"></a><span id="l22.50">         unifinderTreeView.mFilter = new calFilter();</span>
<a href="#l22.51"></a><span id="l22.51"> </span>
<a href="#l22.52"></a><span id="l22.52">         // Set up the unifinder views.</span>
<a href="#l22.53"></a><span id="l22.53">         unifinderTreeView.treeElement = unifinderTree;</span>
<a href="#l22.54"></a><span id="l22.54">         unifinderTree.view = unifinderTreeView;</span>
<a href="#l22.55"></a><span id="l22.55"> </span>
<a href="#l22.56"></a><span id="l22.56" class="difflineat">@@ -338,17 +338,17 @@ function unifinderSelect(event) {</span>
<a href="#l22.57"></a><span id="l22.57"> </span>
<a href="#l22.58"></a><span id="l22.58">     for (let range = 0; range &lt; numRanges; range++) {</span>
<a href="#l22.59"></a><span id="l22.59">         tree.view.selection.getRangeAt(range, start, end);</span>
<a href="#l22.60"></a><span id="l22.60"> </span>
<a href="#l22.61"></a><span id="l22.61">         for (let i = start.value; i &lt;= end.value; i++) {</span>
<a href="#l22.62"></a><span id="l22.62">             try {</span>
<a href="#l22.63"></a><span id="l22.63">                 selectedItems.push(unifinderTreeView.getItemAt(i));</span>
<a href="#l22.64"></a><span id="l22.64">             } catch (e) {</span>
<a href="#l22.65"></a><span id="l22.65" class="difflineminus">-                WARN(&quot;Error getting Event from row: &quot; + e + &quot;\n&quot;);</span>
<a href="#l22.66"></a><span id="l22.66" class="difflineplus">+                cal.WARN(&quot;Error getting Event from row: &quot; + e + &quot;\n&quot;);</span>
<a href="#l22.67"></a><span id="l22.67">             }</span>
<a href="#l22.68"></a><span id="l22.68">         }</span>
<a href="#l22.69"></a><span id="l22.69">     }</span>
<a href="#l22.70"></a><span id="l22.70"> </span>
<a href="#l22.71"></a><span id="l22.71">     if (selectedItems.length == 1) {</span>
<a href="#l22.72"></a><span id="l22.72">         // Go to the day of the selected item in the current view.</span>
<a href="#l22.73"></a><span id="l22.73">         currentView().goToDay(selectedItems[0].startDate);</span>
<a href="#l22.74"></a><span id="l22.74">     }</span>
<a href="#l22.75"></a><span id="l22.75" class="difflineat">@@ -548,17 +548,17 @@ var unifinderTreeView = {</span>
<a href="#l22.76"></a><span id="l22.76">      */</span>
<a href="#l22.77"></a><span id="l22.77">     sortItems: function() {</span>
<a href="#l22.78"></a><span id="l22.78">         if (this.selectedColumn) {</span>
<a href="#l22.79"></a><span id="l22.79">             let modifier = (this.sortDirection == &quot;descending&quot; ? -1 : 1);</span>
<a href="#l22.80"></a><span id="l22.80">             let sortKey = unifinderTreeView.selectedColumn.getAttribute(&quot;itemproperty&quot;);</span>
<a href="#l22.81"></a><span id="l22.81">             let sortType = cal.getSortTypeForSortKey(sortKey);</span>
<a href="#l22.82"></a><span id="l22.82">             // sort (key,item) entries</span>
<a href="#l22.83"></a><span id="l22.83">             cal.sortEntry.mSortKey = sortKey;</span>
<a href="#l22.84"></a><span id="l22.84" class="difflineminus">-            cal.sortEntry.mSortStartedDate = now();</span>
<a href="#l22.85"></a><span id="l22.85" class="difflineplus">+            cal.sortEntry.mSortStartedDate = cal.now();</span>
<a href="#l22.86"></a><span id="l22.86">             let entries = this.eventArray.map(cal.sortEntry, cal.sortEntry);</span>
<a href="#l22.87"></a><span id="l22.87">             entries.sort(cal.sortEntryComparer(sortType, modifier));</span>
<a href="#l22.88"></a><span id="l22.88">             this.eventArray = entries.map(cal.sortEntryItem);</span>
<a href="#l22.89"></a><span id="l22.89">         }</span>
<a href="#l22.90"></a><span id="l22.90">         this.calculateIndexMap();</span>
<a href="#l22.91"></a><span id="l22.91">     },</span>
<a href="#l22.92"></a><span id="l22.92"> </span>
<a href="#l22.93"></a><span id="l22.93">     /**</span>
<a href="#l22.94"></a><span id="l22.94" class="difflineat">@@ -688,31 +688,31 @@ var unifinderTreeView = {</span>
<a href="#l22.95"></a><span id="l22.95">         let item = this.eventArray[aRow];</span>
<a href="#l22.96"></a><span id="l22.96">         if (item.priority &gt; 0 &amp;&amp; item.priority &lt; 5) {</span>
<a href="#l22.97"></a><span id="l22.97">             properties.push(&quot;highpriority&quot;);</span>
<a href="#l22.98"></a><span id="l22.98">         } else if (item.priority &gt; 5 &amp;&amp; item.priority &lt; 10) {</span>
<a href="#l22.99"></a><span id="l22.99">             properties.push(&quot;lowpriority&quot;);</span>
<a href="#l22.100"></a><span id="l22.100">         }</span>
<a href="#l22.101"></a><span id="l22.101"> </span>
<a href="#l22.102"></a><span id="l22.102">         // Add calendar name atom</span>
<a href="#l22.103"></a><span id="l22.103" class="difflineminus">-        properties.push(&quot;calendar-&quot; + formatStringForCSSRule(item.calendar.name));</span>
<a href="#l22.104"></a><span id="l22.104" class="difflineplus">+        properties.push(&quot;calendar-&quot; + cal.formatStringForCSSRule(item.calendar.name));</span>
<a href="#l22.105"></a><span id="l22.105"> </span>
<a href="#l22.106"></a><span id="l22.106">         // Add item status atom</span>
<a href="#l22.107"></a><span id="l22.107">         if (item.status) {</span>
<a href="#l22.108"></a><span id="l22.108">             properties.push(&quot;status-&quot; + item.status.toLowerCase());</span>
<a href="#l22.109"></a><span id="l22.109">         }</span>
<a href="#l22.110"></a><span id="l22.110"> </span>
<a href="#l22.111"></a><span id="l22.111">         // Alarm status atom</span>
<a href="#l22.112"></a><span id="l22.112">         if (item.getAlarms({}).length) {</span>
<a href="#l22.113"></a><span id="l22.113">             properties.push(&quot;alarm&quot;);</span>
<a href="#l22.114"></a><span id="l22.114">         }</span>
<a href="#l22.115"></a><span id="l22.115"> </span>
<a href="#l22.116"></a><span id="l22.116">         // Task categories</span>
<a href="#l22.117"></a><span id="l22.117">         properties = properties.concat(item.getCategories({})</span>
<a href="#l22.118"></a><span id="l22.118" class="difflineminus">-                                           .map(formatStringForCSSRule));</span>
<a href="#l22.119"></a><span id="l22.119" class="difflineplus">+                                           .map(cal.formatStringForCSSRule));</span>
<a href="#l22.120"></a><span id="l22.120"> </span>
<a href="#l22.121"></a><span id="l22.121">         return properties.join(&quot; &quot;);</span>
<a href="#l22.122"></a><span id="l22.122">     },</span>
<a href="#l22.123"></a><span id="l22.123">     getColumnProperties: function(aCol) { return &quot;&quot;; },</span>
<a href="#l22.124"></a><span id="l22.124"> </span>
<a href="#l22.125"></a><span id="l22.125">     isContainer: function() {</span>
<a href="#l22.126"></a><span id="l22.126">         return false;</span>
<a href="#l22.127"></a><span id="l22.127">     },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/calendar/base/content/calendar-view-core.xml</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/calendar/base/content/calendar-view-core.xml</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -1,15 +1,13 @@</span>
<a href="#l23.4"></a><span id="l23.4"> &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<a href="#l23.5"></a><span id="l23.5"> &lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l23.6"></a><span id="l23.6">    - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l23.7"></a><span id="l23.7">    - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l23.8"></a><span id="l23.8"> </span>
<a href="#l23.9"></a><span id="l23.9" class="difflineminus">-&lt;!-- Note that this file depends on helper functions in calUtils.js--&gt;</span>
<a href="#l23.10"></a><span id="l23.10" class="difflineminus">-</span>
<a href="#l23.11"></a><span id="l23.11"> &lt;bindings id=&quot;calendar-core-view-bindings&quot;</span>
<a href="#l23.12"></a><span id="l23.12">           xmlns=&quot;http://www.mozilla.org/xbl&quot;</span>
<a href="#l23.13"></a><span id="l23.13">           xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;</span>
<a href="#l23.14"></a><span id="l23.14">           xmlns:xul=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l23.15"></a><span id="l23.15">           xmlns:xbl=&quot;http://www.mozilla.org/xbl&quot;&gt;</span>
<a href="#l23.16"></a><span id="l23.16"> </span>
<a href="#l23.17"></a><span id="l23.17">   &lt;binding id=&quot;calendar-editable-item&quot;&gt;</span>
<a href="#l23.18"></a><span id="l23.18">     &lt;content mousethrough=&quot;never&quot;</span>
<a href="#l23.19"></a><span id="l23.19" class="difflineat">@@ -157,17 +155,17 @@</span>
<a href="#l23.20"></a><span id="l23.20"> </span>
<a href="#l23.21"></a><span id="l23.21">       &lt;method name=&quot;setCSSClasses&quot;&gt;</span>
<a href="#l23.22"></a><span id="l23.22">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l23.23"></a><span id="l23.23">           let item = this.mOccurrence;</span>
<a href="#l23.24"></a><span id="l23.24">           this.setAttribute(&quot;calendar-uri&quot;, item.calendar.uri.spec);</span>
<a href="#l23.25"></a><span id="l23.25">           this.setAttribute(&quot;calendar-id&quot;, item.calendar.id);</span>
<a href="#l23.26"></a><span id="l23.26">           let categoriesArray = item.getCategories({});</span>
<a href="#l23.27"></a><span id="l23.27">           if (categoriesArray.length &gt; 0) {</span>
<a href="#l23.28"></a><span id="l23.28" class="difflineminus">-              let cssClassesArray = categoriesArray.map(formatStringForCSSRule);</span>
<a href="#l23.29"></a><span id="l23.29" class="difflineplus">+              let cssClassesArray = categoriesArray.map(cal.formatStringForCSSRule);</span>
<a href="#l23.30"></a><span id="l23.30">               this.setAttribute(&quot;categories&quot;, cssClassesArray.join(&quot; &quot;));</span>
<a href="#l23.31"></a><span id="l23.31">           }</span>
<a href="#l23.32"></a><span id="l23.32"> </span>
<a href="#l23.33"></a><span id="l23.33">           // Add alarm icons as needed.</span>
<a href="#l23.34"></a><span id="l23.34">           let alarms = item.getAlarms({});</span>
<a href="#l23.35"></a><span id="l23.35">           if (alarms.length &amp;&amp; Preferences.get(&quot;calendar.alarms.indicator.show&quot;, true)) {</span>
<a href="#l23.36"></a><span id="l23.36">               let iconsBox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;alarm-icons-box&quot;);</span>
<a href="#l23.37"></a><span id="l23.37">               cal.alarms.addReminderImages(iconsBox, alarms);</span>
<a href="#l23.38"></a><span id="l23.38" class="difflineat">@@ -191,17 +189,17 @@</span>
<a href="#l23.39"></a><span id="l23.39">           // Event type specific properties</span>
<a href="#l23.40"></a><span id="l23.40">           if (cal.isEvent(item)) {</span>
<a href="#l23.41"></a><span id="l23.41">               if (item.startDate.isDate) {</span>
<a href="#l23.42"></a><span id="l23.42">                   this.setAttribute(&quot;allday&quot;, &quot;true&quot;);</span>
<a href="#l23.43"></a><span id="l23.43">               }</span>
<a href="#l23.44"></a><span id="l23.44">               this.setAttribute(&quot;itemType&quot;, &quot;event&quot;);</span>
<a href="#l23.45"></a><span id="l23.45">           } else if (cal.isToDo(item)) {</span>
<a href="#l23.46"></a><span id="l23.46">               // progress attribute</span>
<a href="#l23.47"></a><span id="l23.47" class="difflineminus">-              this.setAttribute(&quot;progress&quot;, getProgressAtom(item));</span>
<a href="#l23.48"></a><span id="l23.48" class="difflineplus">+              this.setAttribute(&quot;progress&quot;, cal.getProgressAtom(item));</span>
<a href="#l23.49"></a><span id="l23.49">               // Attribute for tasks and tasks image.</span>
<a href="#l23.50"></a><span id="l23.50">               this.setAttribute(&quot;itemType&quot;, &quot;todo&quot;);</span>
<a href="#l23.51"></a><span id="l23.51">               if (item.entryDate &amp;&amp; !item.dueDate) {</span>
<a href="#l23.52"></a><span id="l23.52">                   this.setAttribute(&quot;todoType&quot;, &quot;start&quot;);</span>
<a href="#l23.53"></a><span id="l23.53">               } else if (!item.entryDate &amp;&amp; item.dueDate) {</span>
<a href="#l23.54"></a><span id="l23.54">                   this.setAttribute(&quot;todoType&quot;, &quot;end&quot;);</span>
<a href="#l23.55"></a><span id="l23.55">               }</span>
<a href="#l23.56"></a><span id="l23.56">           }</span>
<a href="#l23.57"></a><span id="l23.57" class="difflineat">@@ -234,17 +232,17 @@</span>
<a href="#l23.58"></a><span id="l23.58"> </span>
<a href="#l23.59"></a><span id="l23.59">           // calendar name</span>
<a href="#l23.60"></a><span id="l23.60">           this.setAttribute(&quot;calendar&quot;, item.calendar.name.toLowerCase());</span>
<a href="#l23.61"></a><span id="l23.61"> </span>
<a href="#l23.62"></a><span id="l23.62">           // Invitation</span>
<a href="#l23.63"></a><span id="l23.63">           if (cal.isInvitation(item)) {</span>
<a href="#l23.64"></a><span id="l23.64">               this.setAttribute(&quot;invitation-status&quot;, cal.getInvitedAttendee(item).participationStatus);</span>
<a href="#l23.65"></a><span id="l23.65">               this.setAttribute(&quot;readonly&quot;, &quot;true&quot;);</span>
<a href="#l23.66"></a><span id="l23.66" class="difflineminus">-          } else if (!isCalendarWritable(item.calendar)) {</span>
<a href="#l23.67"></a><span id="l23.67" class="difflineplus">+          } else if (!cal.isCalendarWritable(item.calendar)) {</span>
<a href="#l23.68"></a><span id="l23.68">               this.setAttribute(&quot;readonly&quot;, &quot;true&quot;);</span>
<a href="#l23.69"></a><span id="l23.69">           }</span>
<a href="#l23.70"></a><span id="l23.70">         ]]&gt;&lt;/body&gt;</span>
<a href="#l23.71"></a><span id="l23.71">       &lt;/method&gt;</span>
<a href="#l23.72"></a><span id="l23.72"> </span>
<a href="#l23.73"></a><span id="l23.73">       &lt;method name=&quot;startEditing&quot;&gt;</span>
<a href="#l23.74"></a><span id="l23.74">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l23.75"></a><span id="l23.75">           this.editingTimer = null;</span>
<a href="#l23.76"></a><span id="l23.76" class="difflineat">@@ -319,17 +317,17 @@</span>
<a href="#l23.77"></a><span id="l23.77">         }</span>
<a href="#l23.78"></a><span id="l23.78"> </span>
<a href="#l23.79"></a><span id="l23.79">         // If the left button was used and the item is already selected</span>
<a href="#l23.80"></a><span id="l23.80">         // and there are no multiple items selected start</span>
<a href="#l23.81"></a><span id="l23.81">         // the 'single click edit' timeout. Otherwise select the item too.</span>
<a href="#l23.82"></a><span id="l23.82">         // Also, check if the calendar is readOnly or we are offline.</span>
<a href="#l23.83"></a><span id="l23.83"> </span>
<a href="#l23.84"></a><span id="l23.84">         if (this.selected &amp;&amp; !(event.ctrlKey || event.metaKey) &amp;&amp;</span>
<a href="#l23.85"></a><span id="l23.85" class="difflineminus">-              isCalendarWritable(this.mOccurrence.calendar)) {</span>
<a href="#l23.86"></a><span id="l23.86" class="difflineplus">+              cal.isCalendarWritable(this.mOccurrence.calendar)) {</span>
<a href="#l23.87"></a><span id="l23.87">             if (this.editingTimer) {</span>
<a href="#l23.88"></a><span id="l23.88">                 clearTimeout(this.editingTimer);</span>
<a href="#l23.89"></a><span id="l23.89">             }</span>
<a href="#l23.90"></a><span id="l23.90">             this.editingTimer = setTimeout(() =&gt; this.startEditing(), 350);</span>
<a href="#l23.91"></a><span id="l23.91">         } else {</span>
<a href="#l23.92"></a><span id="l23.92">             this.select(event);</span>
<a href="#l23.93"></a><span id="l23.93">             event.stopPropagation();</span>
<a href="#l23.94"></a><span id="l23.94">         }</span>
<a href="#l23.95"></a><span id="l23.95" class="difflineat">@@ -356,17 +354,17 @@</span>
<a href="#l23.96"></a><span id="l23.96">         }</span>
<a href="#l23.97"></a><span id="l23.97">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l23.98"></a><span id="l23.98">       &lt;handler event=&quot;dragstart&quot;&gt;&lt;![CDATA[</span>
<a href="#l23.99"></a><span id="l23.99">         if (event.target.localName == &quot;calendar-event-box&quot;) {</span>
<a href="#l23.100"></a><span id="l23.100">             return;</span>
<a href="#l23.101"></a><span id="l23.101">         }</span>
<a href="#l23.102"></a><span id="l23.102">         let item = this.occurrence;</span>
<a href="#l23.103"></a><span id="l23.103">         let isInvitation = item.calendar instanceof Components.interfaces.calISchedulingSupport &amp;&amp; item.calendar.isInvitation(item);</span>
<a href="#l23.104"></a><span id="l23.104" class="difflineminus">-        if (!isCalendarWritable(item.calendar) || !userCanModifyItem(item) || isInvitation) {</span>
<a href="#l23.105"></a><span id="l23.105" class="difflineplus">+        if (!cal.isCalendarWritable(item.calendar) || !cal.userCanModifyItem(item) || isInvitation) {</span>
<a href="#l23.106"></a><span id="l23.106">             return;</span>
<a href="#l23.107"></a><span id="l23.107">         }</span>
<a href="#l23.108"></a><span id="l23.108">         if (!this.selected) {</span>
<a href="#l23.109"></a><span id="l23.109">             this.select(event);</span>
<a href="#l23.110"></a><span id="l23.110">         }</span>
<a href="#l23.111"></a><span id="l23.111">         invokeEventDragSession(item, this);</span>
<a href="#l23.112"></a><span id="l23.112">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l23.113"></a><span id="l23.113">     &lt;/handlers&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/calendar/base/content/calendar-views.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/calendar/base/content/calendar-views.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -33,17 +33,17 @@ var calendarViewController = {</span>
<a href="#l24.4"></a><span id="l24.4">      * Creates a new event</span>
<a href="#l24.5"></a><span id="l24.5">      * @see calICalendarViewController</span>
<a href="#l24.6"></a><span id="l24.6">      */</span>
<a href="#l24.7"></a><span id="l24.7">     createNewEvent: function(aCalendar, aStartTime, aEndTime, aForceAllday) {</span>
<a href="#l24.8"></a><span id="l24.8">         // if we're given both times, skip the dialog</span>
<a href="#l24.9"></a><span id="l24.9">         if (aStartTime &amp;&amp; aEndTime &amp;&amp; !aStartTime.isDate &amp;&amp; !aEndTime.isDate) {</span>
<a href="#l24.10"></a><span id="l24.10">             let item = cal.createEvent();</span>
<a href="#l24.11"></a><span id="l24.11">             setDefaultItemValues(item, aCalendar, aStartTime, aEndTime);</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-            item.title = calGetString(&quot;calendar&quot;, &quot;newEvent&quot;);</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+            item.title = cal.calGetString(&quot;calendar&quot;, &quot;newEvent&quot;);</span>
<a href="#l24.14"></a><span id="l24.14">             doTransaction(&quot;add&quot;, item, item.calendar, null, null);</span>
<a href="#l24.15"></a><span id="l24.15">         } else {</span>
<a href="#l24.16"></a><span id="l24.16">             createEventWithDialog(aCalendar, aStartTime, null, null, null, aForceAllday);</span>
<a href="#l24.17"></a><span id="l24.17">         }</span>
<a href="#l24.18"></a><span id="l24.18">     },</span>
<a href="#l24.19"></a><span id="l24.19"> </span>
<a href="#l24.20"></a><span id="l24.20">     /**</span>
<a href="#l24.21"></a><span id="l24.21">      * Modifies the given occurrence</span>
<a href="#l24.22"></a><span id="l24.22" class="difflineat">@@ -62,17 +62,17 @@ var calendarViewController = {</span>
<a href="#l24.23"></a><span id="l24.23">             // When we made the executive decision (in bug 352862) that</span>
<a href="#l24.24"></a><span id="l24.24">             // dragging an occurrence of a recurring event would _only_ act</span>
<a href="#l24.25"></a><span id="l24.25">             // upon _that_ occurrence, we removed a bunch of code from this</span>
<a href="#l24.26"></a><span id="l24.26">             // function. If we ever revert that decision, check CVS history</span>
<a href="#l24.27"></a><span id="l24.27">             // here to get that code back.</span>
<a href="#l24.28"></a><span id="l24.28"> </span>
<a href="#l24.29"></a><span id="l24.29">             if (aNewStartTime || aNewEndTime) {</span>
<a href="#l24.30"></a><span id="l24.30">                 // Yay for variable names that make this next line look silly</span>
<a href="#l24.31"></a><span id="l24.31" class="difflineminus">-                if (isEvent(instance)) {</span>
<a href="#l24.32"></a><span id="l24.32" class="difflineplus">+                if (cal.isEvent(instance)) {</span>
<a href="#l24.33"></a><span id="l24.33">                     if (aNewStartTime &amp;&amp; instance.startDate) {</span>
<a href="#l24.34"></a><span id="l24.34">                         instance.startDate = aNewStartTime;</span>
<a href="#l24.35"></a><span id="l24.35">                     }</span>
<a href="#l24.36"></a><span id="l24.36">                     if (aNewEndTime &amp;&amp; instance.endDate) {</span>
<a href="#l24.37"></a><span id="l24.37">                         instance.endDate = aNewEndTime;</span>
<a href="#l24.38"></a><span id="l24.38">                     }</span>
<a href="#l24.39"></a><span id="l24.39">                 } else {</span>
<a href="#l24.40"></a><span id="l24.40">                     if (aNewStartTime &amp;&amp; instance.entryDate) {</span>
<a href="#l24.41"></a><span id="l24.41" class="difflineat">@@ -115,17 +115,17 @@ var calendarViewController = {</span>
<a href="#l24.42"></a><span id="l24.42">         };</span>
<a href="#l24.43"></a><span id="l24.43"> </span>
<a href="#l24.44"></a><span id="l24.44">         // Make sure we are modifying a copy of aOccurrences, otherwise we will</span>
<a href="#l24.45"></a><span id="l24.45">         // run into race conditions when the view's doDeleteItem removes the</span>
<a href="#l24.46"></a><span id="l24.46">         // array elements while we are iterating through them. While we are at</span>
<a href="#l24.47"></a><span id="l24.47">         // it, filter out any items that have readonly calendars, so that</span>
<a href="#l24.48"></a><span id="l24.48">         // checking for one total item below also works out if all but one item</span>
<a href="#l24.49"></a><span id="l24.49">         // are readonly.</span>
<a href="#l24.50"></a><span id="l24.50" class="difflineminus">-        let occurrences = aOccurrences.filter(item =&gt; isCalendarWritable(item.calendar));</span>
<a href="#l24.51"></a><span id="l24.51" class="difflineplus">+        let occurrences = aOccurrences.filter(item =&gt; cal.isCalendarWritable(item.calendar));</span>
<a href="#l24.52"></a><span id="l24.52"> </span>
<a href="#l24.53"></a><span id="l24.53">         for (let itemToDelete of occurrences) {</span>
<a href="#l24.54"></a><span id="l24.54">             if (aUseParentItems) {</span>
<a href="#l24.55"></a><span id="l24.55">                 // Usually happens when ctrl-click is used. In that case we</span>
<a href="#l24.56"></a><span id="l24.56">                 // don't need to ask the user if he wants to delete an</span>
<a href="#l24.57"></a><span id="l24.57">                 // occurrence or not.</span>
<a href="#l24.58"></a><span id="l24.58">                 itemToDelete = itemToDelete.parentItem;</span>
<a href="#l24.59"></a><span id="l24.59">             } else if (!aDoNotConfirm &amp;&amp; occurrences.length == 1) {</span>
<a href="#l24.60"></a><span id="l24.60" class="difflineat">@@ -228,35 +228,35 @@ function switchToView(aViewType) {</span>
<a href="#l24.61"></a><span id="l24.61">      &quot;today-view-button&quot;,</span>
<a href="#l24.62"></a><span id="l24.62">      &quot;next-view-button&quot;].forEach(x =&gt; setupViewNode(x, &quot;tooltiptext&quot;));</span>
<a href="#l24.63"></a><span id="l24.63"> </span>
<a href="#l24.64"></a><span id="l24.64">     try {</span>
<a href="#l24.65"></a><span id="l24.65">         selectedDay = viewDeck.selectedPanel.selectedDay;</span>
<a href="#l24.66"></a><span id="l24.66">         currentSelection = viewDeck.selectedPanel.getSelectedItems({});</span>
<a href="#l24.67"></a><span id="l24.67">     } catch (ex) {</span>
<a href="#l24.68"></a><span id="l24.68">         // This dies if no view has even been chosen this session, but that's</span>
<a href="#l24.69"></a><span id="l24.69" class="difflineminus">-        // ok because we'll just use now() below.</span>
<a href="#l24.70"></a><span id="l24.70" class="difflineplus">+        // ok because we'll just use cal.now() below.</span>
<a href="#l24.71"></a><span id="l24.71">     }</span>
<a href="#l24.72"></a><span id="l24.72"> </span>
<a href="#l24.73"></a><span id="l24.73">     if (!selectedDay) {</span>
<a href="#l24.74"></a><span id="l24.74" class="difflineminus">-        selectedDay = now();</span>
<a href="#l24.75"></a><span id="l24.75" class="difflineplus">+        selectedDay = cal.now();</span>
<a href="#l24.76"></a><span id="l24.76">     }</span>
<a href="#l24.77"></a><span id="l24.77"> </span>
<a href="#l24.78"></a><span id="l24.78">     // Anyone wanting to plug in a view needs to follow this naming scheme</span>
<a href="#l24.79"></a><span id="l24.79">     let view = document.getElementById(aViewType + &quot;-view&quot;);</span>
<a href="#l24.80"></a><span id="l24.80">     viewDeck.selectedPanel = view;</span>
<a href="#l24.81"></a><span id="l24.81"> </span>
<a href="#l24.82"></a><span id="l24.82">     // Select the corresponding tab</span>
<a href="#l24.83"></a><span id="l24.83">     let viewTabs = document.getElementById(&quot;view-tabs&quot;);</span>
<a href="#l24.84"></a><span id="l24.84">     viewTabs.selectedIndex = getViewDeck().selectedIndex;</span>
<a href="#l24.85"></a><span id="l24.85"> </span>
<a href="#l24.86"></a><span id="l24.86">     let compositeCal = cal.getCompositeCalendar(window);</span>
<a href="#l24.87"></a><span id="l24.87">     if (view.displayCalendar != compositeCal) {</span>
<a href="#l24.88"></a><span id="l24.88">         view.displayCalendar = compositeCal;</span>
<a href="#l24.89"></a><span id="l24.89" class="difflineminus">-        view.timezone = calendarDefaultTimezone();</span>
<a href="#l24.90"></a><span id="l24.90" class="difflineplus">+        view.timezone = cal.calendarDefaultTimezone();</span>
<a href="#l24.91"></a><span id="l24.91">         view.controller = calendarViewController;</span>
<a href="#l24.92"></a><span id="l24.92">     }</span>
<a href="#l24.93"></a><span id="l24.93"> </span>
<a href="#l24.94"></a><span id="l24.94">     view.goToDay(selectedDay);</span>
<a href="#l24.95"></a><span id="l24.95">     view.setSelectedItems(currentSelection.length, currentSelection);</span>
<a href="#l24.96"></a><span id="l24.96"> </span>
<a href="#l24.97"></a><span id="l24.97">     onCalendarViewResize();</span>
<a href="#l24.98"></a><span id="l24.98"> }</span>
<a href="#l24.99"></a><span id="l24.99" class="difflineat">@@ -407,17 +407,17 @@ var categoryManagement = {</span>
<a href="#l24.100"></a><span id="l24.100">     initCategories: function() {</span>
<a href="#l24.101"></a><span id="l24.101">         categoryPrefBranch = Services.prefs.getBranch(&quot;calendar.category.color.&quot;);</span>
<a href="#l24.102"></a><span id="l24.102">         let categories = categoryPrefBranch.getChildList(&quot;&quot;);</span>
<a href="#l24.103"></a><span id="l24.103"> </span>
<a href="#l24.104"></a><span id="l24.104">         // Fix illegally formatted category prefs.</span>
<a href="#l24.105"></a><span id="l24.105">         for (let i in categories) {</span>
<a href="#l24.106"></a><span id="l24.106">             let category = categories[i];</span>
<a href="#l24.107"></a><span id="l24.107">             if (category.search(/[^_0-9a-z-]/) != -1) {</span>
<a href="#l24.108"></a><span id="l24.108" class="difflineminus">-                let categoryFix = formatStringForCSSRule(category);</span>
<a href="#l24.109"></a><span id="l24.109" class="difflineplus">+                let categoryFix = cal.formatStringForCSSRule(category);</span>
<a href="#l24.110"></a><span id="l24.110">                 if (categoryPrefBranch.prefHasUserValue(categoryFix)) {</span>
<a href="#l24.111"></a><span id="l24.111">                     categories.splice(i, 1); // remove illegal name</span>
<a href="#l24.112"></a><span id="l24.112">                 } else {</span>
<a href="#l24.113"></a><span id="l24.113">                     let color = categoryPrefBranch.getCharPref(category);</span>
<a href="#l24.114"></a><span id="l24.114">                     categoryPrefBranch.setCharPref(categoryFix, color);</span>
<a href="#l24.115"></a><span id="l24.115">                     categoryPrefBranch.clearUserPref(category); // not usable</span>
<a href="#l24.116"></a><span id="l24.116">                     categories[i] = categoryFix;  // replace illegal name</span>
<a href="#l24.117"></a><span id="l24.117">                 }</span>
<a href="#l24.118"></a><span id="l24.118" class="difflineat">@@ -673,37 +673,37 @@ function selectAllEvents() {</span>
<a href="#l24.119"></a><span id="l24.119"> }</span>
<a href="#l24.120"></a><span id="l24.120"> </span>
<a href="#l24.121"></a><span id="l24.121"> var cal = cal || {};</span>
<a href="#l24.122"></a><span id="l24.122"> cal.navigationBar = {</span>
<a href="#l24.123"></a><span id="l24.123">     setDateRange: function(aStartDate, aEndDate) {</span>
<a href="#l24.124"></a><span id="l24.124">         let docTitle = &quot;&quot;;</span>
<a href="#l24.125"></a><span id="l24.125">         if (aStartDate) {</span>
<a href="#l24.126"></a><span id="l24.126">             let intervalLabel = document.getElementById(&quot;intervalDescription&quot;);</span>
<a href="#l24.127"></a><span id="l24.127" class="difflineminus">-            let firstWeekNo = getWeekInfoService().getWeekTitle(aStartDate);</span>
<a href="#l24.128"></a><span id="l24.128" class="difflineplus">+            let firstWeekNo = cal.getWeekInfoService().getWeekTitle(aStartDate);</span>
<a href="#l24.129"></a><span id="l24.129">             let secondWeekNo = firstWeekNo;</span>
<a href="#l24.130"></a><span id="l24.130">             let weekLabel = document.getElementById(&quot;calendarWeek&quot;);</span>
<a href="#l24.131"></a><span id="l24.131">             if (aStartDate.nativeTime == aEndDate.nativeTime) {</span>
<a href="#l24.132"></a><span id="l24.132" class="difflineminus">-                intervalLabel.value = getDateFormatter().formatDate(aStartDate);</span>
<a href="#l24.133"></a><span id="l24.133" class="difflineplus">+                intervalLabel.value = cal.getDateFormatter().formatDate(aStartDate);</span>
<a href="#l24.134"></a><span id="l24.134">             } else {</span>
<a href="#l24.135"></a><span id="l24.135">                 intervalLabel.value = currentView().getRangeDescription();</span>
<a href="#l24.136"></a><span id="l24.136" class="difflineminus">-                secondWeekNo = getWeekInfoService().getWeekTitle(aEndDate);</span>
<a href="#l24.137"></a><span id="l24.137" class="difflineplus">+                secondWeekNo = cal.getWeekInfoService().getWeekTitle(aEndDate);</span>
<a href="#l24.138"></a><span id="l24.138">             }</span>
<a href="#l24.139"></a><span id="l24.139">             if (secondWeekNo == firstWeekNo) {</span>
<a href="#l24.140"></a><span id="l24.140" class="difflineminus">-                weekLabel.value = calGetString(&quot;calendar&quot;, &quot;singleShortCalendarWeek&quot;, [firstWeekNo]);</span>
<a href="#l24.141"></a><span id="l24.141" class="difflineminus">-                weekLabel.tooltipText = calGetString(&quot;calendar&quot;, &quot;singleLongCalendarWeek&quot;, [firstWeekNo]);</span>
<a href="#l24.142"></a><span id="l24.142" class="difflineplus">+                weekLabel.value = cal.calGetString(&quot;calendar&quot;, &quot;singleShortCalendarWeek&quot;, [firstWeekNo]);</span>
<a href="#l24.143"></a><span id="l24.143" class="difflineplus">+                weekLabel.tooltipText = cal.calGetString(&quot;calendar&quot;, &quot;singleLongCalendarWeek&quot;, [firstWeekNo]);</span>
<a href="#l24.144"></a><span id="l24.144">             } else {</span>
<a href="#l24.145"></a><span id="l24.145" class="difflineminus">-                weekLabel.value = calGetString(&quot;calendar&quot;, &quot;severalShortCalendarWeeks&quot;, [firstWeekNo, secondWeekNo]);</span>
<a href="#l24.146"></a><span id="l24.146" class="difflineminus">-                weekLabel.tooltipText = calGetString(&quot;calendar&quot;, &quot;severalLongCalendarWeeks&quot;, [firstWeekNo, secondWeekNo]);</span>
<a href="#l24.147"></a><span id="l24.147" class="difflineplus">+                weekLabel.value = cal.calGetString(&quot;calendar&quot;, &quot;severalShortCalendarWeeks&quot;, [firstWeekNo, secondWeekNo]);</span>
<a href="#l24.148"></a><span id="l24.148" class="difflineplus">+                weekLabel.tooltipText = cal.calGetString(&quot;calendar&quot;, &quot;severalLongCalendarWeeks&quot;, [firstWeekNo, secondWeekNo]);</span>
<a href="#l24.149"></a><span id="l24.149">             }</span>
<a href="#l24.150"></a><span id="l24.150">             docTitle = intervalLabel.value;</span>
<a href="#l24.151"></a><span id="l24.151">         }</span>
<a href="#l24.152"></a><span id="l24.152">         if (document.getElementById(&quot;modeBroadcaster&quot;).getAttribute(&quot;mode&quot;) == &quot;calendar&quot;) {</span>
<a href="#l24.153"></a><span id="l24.153">             document.title = (docTitle ? docTitle + &quot; - &quot; : &quot;&quot;) +</span>
<a href="#l24.154"></a><span id="l24.154" class="difflineminus">-                calGetString(&quot;brand&quot;, &quot;brandFullName&quot;, null, &quot;branding&quot;);</span>
<a href="#l24.155"></a><span id="l24.155" class="difflineplus">+                cal.calGetString(&quot;brand&quot;, &quot;brandFullName&quot;, null, &quot;branding&quot;);</span>
<a href="#l24.156"></a><span id="l24.156">         }</span>
<a href="#l24.157"></a><span id="l24.157">         let viewTabs = document.getElementById(&quot;view-tabs&quot;);</span>
<a href="#l24.158"></a><span id="l24.158">         viewTabs.selectedIndex = getViewDeck().selectedIndex;</span>
<a href="#l24.159"></a><span id="l24.159">     }</span>
<a href="#l24.160"></a><span id="l24.160"> };</span>
<a href="#l24.161"></a><span id="l24.161"> </span>
<a href="#l24.162"></a><span id="l24.162"> /*</span>
<a href="#l24.163"></a><span id="l24.163">  * Timer for the time indicator in day and week view.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/calendar/base/content/calendar-views.xml</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/calendar/base/content/calendar-views.xml</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -7,16 +7,19 @@</span>
<a href="#l25.4"></a><span id="l25.4">           xmlns=&quot;http://www.mozilla.org/xbl&quot;</span>
<a href="#l25.5"></a><span id="l25.5">           xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;</span>
<a href="#l25.6"></a><span id="l25.6">           xmlns:xul=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l25.7"></a><span id="l25.7">           xmlns:xbl=&quot;http://www.mozilla.org/xbl&quot;&gt;</span>
<a href="#l25.8"></a><span id="l25.8"> </span>
<a href="#l25.9"></a><span id="l25.9">   &lt;binding id=&quot;calendar-day-view&quot;</span>
<a href="#l25.10"></a><span id="l25.10">            extends=&quot;chrome://calendar/content/calendar-multiday-view.xml#calendar-multiday-view&quot;&gt;</span>
<a href="#l25.11"></a><span id="l25.11">     &lt;implementation implements=&quot;calICalendarView&quot;&gt;</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineplus">+      &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineplus">+      ]]&gt;&lt;/constructor&gt;</span>
<a href="#l25.15"></a><span id="l25.15">       &lt;property name=&quot;observerID&quot;&gt;</span>
<a href="#l25.16"></a><span id="l25.16">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l25.17"></a><span id="l25.17">           return &quot;day-view-observer&quot;;</span>
<a href="#l25.18"></a><span id="l25.18">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l25.19"></a><span id="l25.19">       &lt;/property&gt;</span>
<a href="#l25.20"></a><span id="l25.20">       &lt;property name=&quot;supportsWorkdaysOnly&quot;</span>
<a href="#l25.21"></a><span id="l25.21">                 readonly=&quot;true&quot;</span>
<a href="#l25.22"></a><span id="l25.22">                 onget=&quot;return false;&quot;/&gt;</span>
<a href="#l25.23"></a><span id="l25.23" class="difflineat">@@ -37,27 +40,29 @@</span>
<a href="#l25.24"></a><span id="l25.24">       &lt;method name=&quot;moveView&quot;&gt;</span>
<a href="#l25.25"></a><span id="l25.25">         &lt;parameter name=&quot;aNumber&quot;/&gt;</span>
<a href="#l25.26"></a><span id="l25.26">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l25.27"></a><span id="l25.27">           if (aNumber) {</span>
<a href="#l25.28"></a><span id="l25.28">               let currentDay = this.startDay.clone();</span>
<a href="#l25.29"></a><span id="l25.29">               currentDay.day += aNumber;</span>
<a href="#l25.30"></a><span id="l25.30">               this.goToDay(currentDay);</span>
<a href="#l25.31"></a><span id="l25.31">           } else {</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineminus">-              this.goToDay(now());</span>
<a href="#l25.33"></a><span id="l25.33" class="difflineplus">+              this.goToDay(cal.now());</span>
<a href="#l25.34"></a><span id="l25.34">           }</span>
<a href="#l25.35"></a><span id="l25.35">         ]]&gt;&lt;/body&gt;</span>
<a href="#l25.36"></a><span id="l25.36">       &lt;/method&gt;</span>
<a href="#l25.37"></a><span id="l25.37">     &lt;/implementation&gt;</span>
<a href="#l25.38"></a><span id="l25.38">   &lt;/binding&gt;</span>
<a href="#l25.39"></a><span id="l25.39"> </span>
<a href="#l25.40"></a><span id="l25.40">   &lt;binding id=&quot;calendar-week-view&quot;</span>
<a href="#l25.41"></a><span id="l25.41">            extends=&quot;chrome://calendar/content/calendar-multiday-view.xml#calendar-multiday-view&quot;&gt;</span>
<a href="#l25.42"></a><span id="l25.42">     &lt;implementation implements=&quot;calICalendarView&quot;&gt;</span>
<a href="#l25.43"></a><span id="l25.43">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l25.44"></a><span id="l25.44" class="difflineplus">+        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l25.45"></a><span id="l25.45" class="difflineplus">+</span>
<a href="#l25.46"></a><span id="l25.46">         // add a listener for the mode change</span>
<a href="#l25.47"></a><span id="l25.47">         this.mModeHandler = (event) =&gt; {</span>
<a href="#l25.48"></a><span id="l25.48">             if (event.attrName == &quot;mode&quot;) {</span>
<a href="#l25.49"></a><span id="l25.49">                 this.onModeChanged(event);</span>
<a href="#l25.50"></a><span id="l25.50">             }</span>
<a href="#l25.51"></a><span id="l25.51">         };</span>
<a href="#l25.52"></a><span id="l25.52">         document.getElementById(&quot;modeBroadcaster&quot;).addEventListener(&quot;DOMAttrModified&quot;, this.mModeHandler, true);</span>
<a href="#l25.53"></a><span id="l25.53">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l25.54"></a><span id="l25.54" class="difflineat">@@ -102,27 +107,28 @@</span>
<a href="#l25.55"></a><span id="l25.55">       &lt;method name=&quot;moveView&quot;&gt;</span>
<a href="#l25.56"></a><span id="l25.56">         &lt;parameter name=&quot;aNumber&quot;/&gt;</span>
<a href="#l25.57"></a><span id="l25.57">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l25.58"></a><span id="l25.58">           if (aNumber) {</span>
<a href="#l25.59"></a><span id="l25.59">               let date = this.selectedDay.clone();</span>
<a href="#l25.60"></a><span id="l25.60">               date.day += 7 * aNumber;</span>
<a href="#l25.61"></a><span id="l25.61">               this.goToDay(date);</span>
<a href="#l25.62"></a><span id="l25.62">           } else {</span>
<a href="#l25.63"></a><span id="l25.63" class="difflineminus">-              this.goToDay(now());</span>
<a href="#l25.64"></a><span id="l25.64" class="difflineplus">+              this.goToDay(cal.now());</span>
<a href="#l25.65"></a><span id="l25.65">           }</span>
<a href="#l25.66"></a><span id="l25.66">         ]]&gt;&lt;/body&gt;</span>
<a href="#l25.67"></a><span id="l25.67">       &lt;/method&gt;</span>
<a href="#l25.68"></a><span id="l25.68">     &lt;/implementation&gt;</span>
<a href="#l25.69"></a><span id="l25.69">   &lt;/binding&gt;</span>
<a href="#l25.70"></a><span id="l25.70"> </span>
<a href="#l25.71"></a><span id="l25.71">   &lt;binding id=&quot;calendar-multiweek-view&quot; extends=&quot;chrome://calendar/content/calendar-month-view.xml#calendar-month-base-view&quot;&gt;</span>
<a href="#l25.72"></a><span id="l25.72">     &lt;implementation implements=&quot;calICalendarView&quot;&gt;</span>
<a href="#l25.73"></a><span id="l25.73">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l25.74"></a><span id="l25.74">         Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l25.75"></a><span id="l25.75" class="difflineplus">+        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l25.76"></a><span id="l25.76">         this.mWeeksInView = Preferences.get(&quot;calendar.weeks.inview&quot;, 4);</span>
<a href="#l25.77"></a><span id="l25.77">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l25.78"></a><span id="l25.78"> </span>
<a href="#l25.79"></a><span id="l25.79">       &lt;field name=&quot;mWeeksInView&quot;&gt;4&lt;/field&gt;</span>
<a href="#l25.80"></a><span id="l25.80"> </span>
<a href="#l25.81"></a><span id="l25.81">       &lt;property name=&quot;weeksInView&quot;&gt;</span>
<a href="#l25.82"></a><span id="l25.82">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l25.83"></a><span id="l25.83">           return this.mWeeksInView;</span>
<a href="#l25.84"></a><span id="l25.84" class="difflineat">@@ -206,27 +212,31 @@</span>
<a href="#l25.85"></a><span id="l25.85">               let savedSelectedDay = this.selectedDay.clone();</span>
<a href="#l25.86"></a><span id="l25.86">               // aNumber only corresponds to the number of weeks to move</span>
<a href="#l25.87"></a><span id="l25.87">               // make sure to compensate for previous weeks in view too</span>
<a href="#l25.88"></a><span id="l25.88">               date.day += 7 * (aNumber + Preferences.get(&quot;calendar.previousweeks.inview&quot;, 4));</span>
<a href="#l25.89"></a><span id="l25.89">               this.goToDay(date);</span>
<a href="#l25.90"></a><span id="l25.90">               savedSelectedDay.day += 7 * aNumber;</span>
<a href="#l25.91"></a><span id="l25.91">               this.selectedDay = savedSelectedDay;</span>
<a href="#l25.92"></a><span id="l25.92">           } else {</span>
<a href="#l25.93"></a><span id="l25.93" class="difflineminus">-              let date = now();</span>
<a href="#l25.94"></a><span id="l25.94" class="difflineplus">+              let date = cal.now();</span>
<a href="#l25.95"></a><span id="l25.95">               this.goToDay(date);</span>
<a href="#l25.96"></a><span id="l25.96">               this.selectedDay = date;</span>
<a href="#l25.97"></a><span id="l25.97">           }</span>
<a href="#l25.98"></a><span id="l25.98">         ]]&gt;&lt;/body&gt;</span>
<a href="#l25.99"></a><span id="l25.99">       &lt;/method&gt;</span>
<a href="#l25.100"></a><span id="l25.100">     &lt;/implementation&gt;</span>
<a href="#l25.101"></a><span id="l25.101">   &lt;/binding&gt;</span>
<a href="#l25.102"></a><span id="l25.102"> </span>
<a href="#l25.103"></a><span id="l25.103">   &lt;binding id=&quot;calendar-month-view&quot; extends=&quot;chrome://calendar/content/calendar-month-view.xml#calendar-month-base-view&quot;&gt;</span>
<a href="#l25.104"></a><span id="l25.104">     &lt;implementation implements=&quot;calICalendarView&quot;&gt;</span>
<a href="#l25.105"></a><span id="l25.105" class="difflineplus">+      &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l25.106"></a><span id="l25.106" class="difflineplus">+        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l25.107"></a><span id="l25.107" class="difflineplus">+      ]]&gt;&lt;/constructor&gt;</span>
<a href="#l25.108"></a><span id="l25.108" class="difflineplus">+</span>
<a href="#l25.109"></a><span id="l25.109">       &lt;property name=&quot;observerID&quot;&gt;</span>
<a href="#l25.110"></a><span id="l25.110">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l25.111"></a><span id="l25.111">           return &quot;month-view-observer&quot;;</span>
<a href="#l25.112"></a><span id="l25.112">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l25.113"></a><span id="l25.113">       &lt;/property&gt;</span>
<a href="#l25.114"></a><span id="l25.114"> </span>
<a href="#l25.115"></a><span id="l25.115">       &lt;!--Public methods--&gt;</span>
<a href="#l25.116"></a><span id="l25.116">       &lt;method name=&quot;goToDay&quot;&gt;</span>
<a href="#l25.117"></a><span id="l25.117" class="difflineat">@@ -239,17 +249,17 @@</span>
<a href="#l25.118"></a><span id="l25.118">           }</span>
<a href="#l25.119"></a><span id="l25.119">           this.showDate(aDate);</span>
<a href="#l25.120"></a><span id="l25.120">         ]]&gt;&lt;/body&gt;</span>
<a href="#l25.121"></a><span id="l25.121">       &lt;/method&gt;</span>
<a href="#l25.122"></a><span id="l25.122">       &lt;method name=&quot;getRangeDescription&quot;&gt;</span>
<a href="#l25.123"></a><span id="l25.123">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l25.124"></a><span id="l25.124">           let monthName = cal.formatMonth(this.rangeStartDate.month + 1,</span>
<a href="#l25.125"></a><span id="l25.125">                                           &quot;calendar&quot;, &quot;monthInYear&quot;);</span>
<a href="#l25.126"></a><span id="l25.126" class="difflineminus">-          return calGetString(&quot;calendar&quot;, &quot;monthInYear&quot;, [monthName, this.rangeStartDate.year]);</span>
<a href="#l25.127"></a><span id="l25.127" class="difflineplus">+          return cal.calGetString(&quot;calendar&quot;, &quot;monthInYear&quot;, [monthName, this.rangeStartDate.year]);</span>
<a href="#l25.128"></a><span id="l25.128">          ]]&gt;&lt;/body&gt;</span>
<a href="#l25.129"></a><span id="l25.129">        &lt;/method&gt;</span>
<a href="#l25.130"></a><span id="l25.130">       &lt;method name=&quot;moveView&quot;&gt;</span>
<a href="#l25.131"></a><span id="l25.131">         &lt;parameter name=&quot;aNumber&quot;/&gt;</span>
<a href="#l25.132"></a><span id="l25.132">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l25.133"></a><span id="l25.133">           let dates = this.getDateList({});</span>
<a href="#l25.134"></a><span id="l25.134">           this.displayDaysOff = !this.mWorkdaysOnly;</span>
<a href="#l25.135"></a><span id="l25.135"> </span>
<a href="#l25.136"></a><span id="l25.136" class="difflineat">@@ -273,17 +283,17 @@</span>
<a href="#l25.137"></a><span id="l25.137">               // correct for accidental rollover into the next month</span>
<a href="#l25.138"></a><span id="l25.138">               if ((newSelectedDay.month - aNumber + 12) % 12 != oldSelectedDay.month) {</span>
<a href="#l25.139"></a><span id="l25.139">                   newSelectedDay.month -= 1;</span>
<a href="#l25.140"></a><span id="l25.140">                   newSelectedDay.day = newSelectedDay.endOfMonth.day;</span>
<a href="#l25.141"></a><span id="l25.141">               }</span>
<a href="#l25.142"></a><span id="l25.142"> </span>
<a href="#l25.143"></a><span id="l25.143">               this.selectedDay = newSelectedDay;</span>
<a href="#l25.144"></a><span id="l25.144">           } else {</span>
<a href="#l25.145"></a><span id="l25.145" class="difflineminus">-              let date = now();</span>
<a href="#l25.146"></a><span id="l25.146" class="difflineplus">+              let date = cal.now();</span>
<a href="#l25.147"></a><span id="l25.147">               this.goToDay(date);</span>
<a href="#l25.148"></a><span id="l25.148">               this.selectedDay = date;</span>
<a href="#l25.149"></a><span id="l25.149">           }</span>
<a href="#l25.150"></a><span id="l25.150">         ]]&gt;&lt;/body&gt;</span>
<a href="#l25.151"></a><span id="l25.151">       &lt;/method&gt;</span>
<a href="#l25.152"></a><span id="l25.152">     &lt;/implementation&gt;</span>
<a href="#l25.153"></a><span id="l25.153">   &lt;/binding&gt;</span>
<a href="#l25.154"></a><span id="l25.154"> &lt;/bindings&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-alarm-dialog.js</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-alarm-dialog.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -225,17 +225,17 @@ function aboveSnoozeLimit(aDuration) {</span>
<a href="#l26.4"></a><span id="l26.4"> </span>
<a href="#l26.5"></a><span id="l26.5"> /**</span>
<a href="#l26.6"></a><span id="l26.6">  * Sets up the window title, counting the number of alarms in the window.</span>
<a href="#l26.7"></a><span id="l26.7">  */</span>
<a href="#l26.8"></a><span id="l26.8"> function setupTitle() {</span>
<a href="#l26.9"></a><span id="l26.9">     let alarmRichlist = document.getElementById(&quot;alarm-richlist&quot;);</span>
<a href="#l26.10"></a><span id="l26.10">     let reminders = alarmRichlist.childNodes.length;</span>
<a href="#l26.11"></a><span id="l26.11"> </span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-    let title = PluralForm.get(reminders, calGetString(&quot;calendar&quot;, &quot;alarmWindowTitle.label&quot;));</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+    let title = PluralForm.get(reminders, cal.calGetString(&quot;calendar&quot;, &quot;alarmWindowTitle.label&quot;));</span>
<a href="#l26.14"></a><span id="l26.14">     document.title = title.replace(&quot;#1&quot;, reminders);</span>
<a href="#l26.15"></a><span id="l26.15"> }</span>
<a href="#l26.16"></a><span id="l26.16"> </span>
<a href="#l26.17"></a><span id="l26.17"> /**</span>
<a href="#l26.18"></a><span id="l26.18">  * Comparison function for the start date of a calendar item and</span>
<a href="#l26.19"></a><span id="l26.19">  * the start date of a calendar-alarm-widget.</span>
<a href="#l26.20"></a><span id="l26.20">  *</span>
<a href="#l26.21"></a><span id="l26.21">  * @param aItem                 A calendar item for the comparison of the start date property</span>
<a href="#l26.22"></a><span id="l26.22" class="difflineat">@@ -245,18 +245,18 @@ function setupTitle() {</span>
<a href="#l26.23"></a><span id="l26.23">  *                              0 - otherwise</span>
<a href="#l26.24"></a><span id="l26.24">  */</span>
<a href="#l26.25"></a><span id="l26.25"> function widgetAlarmComptor(aItem, aWidgetItem) {</span>
<a href="#l26.26"></a><span id="l26.26">     if (aItem == null || aWidgetItem == null) {</span>
<a href="#l26.27"></a><span id="l26.27">         return -1;</span>
<a href="#l26.28"></a><span id="l26.28">     }</span>
<a href="#l26.29"></a><span id="l26.29"> </span>
<a href="#l26.30"></a><span id="l26.30">     // Get the dates to compare</span>
<a href="#l26.31"></a><span id="l26.31" class="difflineminus">-    let aDate = aItem[calGetStartDateProp(aItem)];</span>
<a href="#l26.32"></a><span id="l26.32" class="difflineminus">-    let bDate = aWidgetItem[calGetStartDateProp(aWidgetItem)];</span>
<a href="#l26.33"></a><span id="l26.33" class="difflineplus">+    let aDate = aItem[cal.calGetStartDateProp(aItem)];</span>
<a href="#l26.34"></a><span id="l26.34" class="difflineplus">+    let bDate = aWidgetItem[cal.calGetStartDateProp(aWidgetItem)];</span>
<a href="#l26.35"></a><span id="l26.35"> </span>
<a href="#l26.36"></a><span id="l26.36">     return aDate.compare(bDate);</span>
<a href="#l26.37"></a><span id="l26.37"> }</span>
<a href="#l26.38"></a><span id="l26.38"> </span>
<a href="#l26.39"></a><span id="l26.39"> /**</span>
<a href="#l26.40"></a><span id="l26.40">  * Add an alarm widget for the passed alarm and item.</span>
<a href="#l26.41"></a><span id="l26.41">  *</span>
<a href="#l26.42"></a><span id="l26.42">  * @param aItem       The calendar item to add a widget for.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-alarm-dialog.xul</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-alarm-dialog.xul</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -23,17 +23,16 @@</span>
<a href="#l27.4"></a><span id="l27.4">         onload=&quot;setupWindow(); window.arguments[0].wrappedJSObject.window_onLoad();&quot;</span>
<a href="#l27.5"></a><span id="l27.5">         onunload=&quot;finishWindow();&quot;</span>
<a href="#l27.6"></a><span id="l27.6">         onfocus=&quot;onFocusWindow();&quot;</span>
<a href="#l27.7"></a><span id="l27.7">         onkeypress=&quot;if (event.keyCode == event.DOM_VK_ESCAPE) { window.close(); }&quot;</span>
<a href="#l27.8"></a><span id="l27.8">         width=&quot;600&quot;</span>
<a href="#l27.9"></a><span id="l27.9">         height=&quot;300&quot;&gt;</span>
<a href="#l27.10"></a><span id="l27.10">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calendar-alarm-dialog.js&quot;/&gt;</span>
<a href="#l27.11"></a><span id="l27.11">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calendar-item-editing.js&quot;/&gt;</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-  &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calUtils.js&quot;/&gt;</span>
<a href="#l27.13"></a><span id="l27.13"> </span>
<a href="#l27.14"></a><span id="l27.14">   &lt;richlistbox id=&quot;alarm-richlist&quot; flex=&quot;1&quot; onselect=&quot;onSelectAlarm(event)&quot;/&gt;</span>
<a href="#l27.15"></a><span id="l27.15"> </span>
<a href="#l27.16"></a><span id="l27.16">   &lt;hbox pack=&quot;end&quot; id=&quot;alarm-actionbar&quot; align=&quot;center&quot;&gt;</span>
<a href="#l27.17"></a><span id="l27.17">     &lt;button id=&quot;alarm-snooze-all-button&quot;</span>
<a href="#l27.18"></a><span id="l27.18">             type=&quot;menu&quot;</span>
<a href="#l27.19"></a><span id="l27.19">             label=&quot;&amp;calendar.alarm.snoozeallfor.label;&quot;&gt;</span>
<a href="#l27.20"></a><span id="l27.20">       &lt;menupopup type=&quot;snooze-menupopup&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-conflicts-dialog.xul</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-conflicts-dialog.xul</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -9,17 +9,16 @@</span>
<a href="#l28.4"></a><span id="l28.4"> &lt;dialog id=&quot;calendar-conflicts-dialog&quot;</span>
<a href="#l28.5"></a><span id="l28.5">         windowtype=&quot;Calendar:Conflicts&quot;</span>
<a href="#l28.6"></a><span id="l28.6">         onload=&quot;onLoad()&quot;</span>
<a href="#l28.7"></a><span id="l28.7">         ondialogaccept=&quot;return onAccept();&quot;</span>
<a href="#l28.8"></a><span id="l28.8">         ondialogcancel=&quot;return onCancel();&quot;</span>
<a href="#l28.9"></a><span id="l28.9">         persist=&quot;screenX screenY&quot;</span>
<a href="#l28.10"></a><span id="l28.10">         xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;&gt;</span>
<a href="#l28.11"></a><span id="l28.11">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/mouseoverPreviews.js&quot;/&gt;</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-  &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calUtils.js&quot;/&gt;</span>
<a href="#l28.13"></a><span id="l28.13">   &lt;script type=&quot;application/javascript&quot;&gt;&lt;![CDATA[</span>
<a href="#l28.14"></a><span id="l28.14">     Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l28.15"></a><span id="l28.15">     function onLoad() {</span>
<a href="#l28.16"></a><span id="l28.16">         let docEl = document.documentElement;</span>
<a href="#l28.17"></a><span id="l28.17">         let item = window.arguments[0].item;</span>
<a href="#l28.18"></a><span id="l28.18">         let vbox = getPreviewForEvent(item);</span>
<a href="#l28.19"></a><span id="l28.19">         let descr = document.getElementById(&quot;conflicts-description&quot;);</span>
<a href="#l28.20"></a><span id="l28.20">         descr.parentNode.insertBefore(vbox, descr);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-creation.js</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-creation.js</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -1,32 +1,34 @@</span>
<a href="#l29.4"></a><span id="l29.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l29.5"></a><span id="l29.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l29.6"></a><span id="l29.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l29.7"></a><span id="l29.7"> </span>
<a href="#l29.8"></a><span id="l29.8"> /* exported openLocalCalendar */</span>
<a href="#l29.9"></a><span id="l29.9"> </span>
<a href="#l29.10"></a><span id="l29.10" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l29.11"></a><span id="l29.11" class="difflineplus">+</span>
<a href="#l29.12"></a><span id="l29.12"> /**</span>
<a href="#l29.13"></a><span id="l29.13">  * Shows the filepicker and creates a new calendar with a local file using the ICS</span>
<a href="#l29.14"></a><span id="l29.14">  * provider.</span>
<a href="#l29.15"></a><span id="l29.15">  */</span>
<a href="#l29.16"></a><span id="l29.16"> function openLocalCalendar() {</span>
<a href="#l29.17"></a><span id="l29.17">     const nsIFilePicker = Components.interfaces.nsIFilePicker;</span>
<a href="#l29.18"></a><span id="l29.18">     let picker = Components.classes[&quot;@mozilla.org/filepicker;1&quot;].createInstance(nsIFilePicker);</span>
<a href="#l29.19"></a><span id="l29.19" class="difflineminus">-    picker.init(window, calGetString(&quot;calendar&quot;, &quot;Open&quot;), nsIFilePicker.modeOpen);</span>
<a href="#l29.20"></a><span id="l29.20" class="difflineplus">+    picker.init(window, cal.calGetString(&quot;calendar&quot;, &quot;Open&quot;), nsIFilePicker.modeOpen);</span>
<a href="#l29.21"></a><span id="l29.21">     let wildmat = &quot;*.ics&quot;;</span>
<a href="#l29.22"></a><span id="l29.22" class="difflineminus">-    let description = calGetString(&quot;calendar&quot;, &quot;filterIcs&quot;, [wildmat]);</span>
<a href="#l29.23"></a><span id="l29.23" class="difflineplus">+    let description = cal.calGetString(&quot;calendar&quot;, &quot;filterIcs&quot;, [wildmat]);</span>
<a href="#l29.24"></a><span id="l29.24">     picker.appendFilter(description, wildmat);</span>
<a href="#l29.25"></a><span id="l29.25">     picker.appendFilters(nsIFilePicker.filterAll);</span>
<a href="#l29.26"></a><span id="l29.26"> </span>
<a href="#l29.27"></a><span id="l29.27">     if (picker.show() != nsIFilePicker.returnOK) {</span>
<a href="#l29.28"></a><span id="l29.28">         return;</span>
<a href="#l29.29"></a><span id="l29.29">     }</span>
<a href="#l29.30"></a><span id="l29.30"> </span>
<a href="#l29.31"></a><span id="l29.31" class="difflineminus">-    let calMgr = getCalendarManager();</span>
<a href="#l29.32"></a><span id="l29.32" class="difflineplus">+    let calMgr = cal.getCalendarManager();</span>
<a href="#l29.33"></a><span id="l29.33">     let calendars = calMgr.getCalendars({});</span>
<a href="#l29.34"></a><span id="l29.34">     if (calendars.some(x =&gt; x.uri == picker.fileURL)) {</span>
<a href="#l29.35"></a><span id="l29.35">         // The calendar already exists, select it and return.</span>
<a href="#l29.36"></a><span id="l29.36">         document.getElementById(&quot;calendar-list-tree-widget&quot;)</span>
<a href="#l29.37"></a><span id="l29.37">                 .tree.view.selection.select(index);</span>
<a href="#l29.38"></a><span id="l29.38">         return;</span>
<a href="#l29.39"></a><span id="l29.39">     }</span>
<a href="#l29.40"></a><span id="l29.40"> </span>
<a href="#l29.41"></a><span id="l29.41" class="difflineat">@@ -36,14 +38,14 @@ function openLocalCalendar() {</span>
<a href="#l29.42"></a><span id="l29.42">     // calendarCreation.js</span>
<a href="#l29.43"></a><span id="l29.43">     let fullPathRegex = new RegExp(&quot;([^/:]+)[.]ics$&quot;);</span>
<a href="#l29.44"></a><span id="l29.44">     let prettyName = picker.fileURL.spec.match(fullPathRegex);</span>
<a href="#l29.45"></a><span id="l29.45">     let name;</span>
<a href="#l29.46"></a><span id="l29.46"> </span>
<a href="#l29.47"></a><span id="l29.47">     if (prettyName &amp;&amp; prettyName.length &gt;= 1) {</span>
<a href="#l29.48"></a><span id="l29.48">         name = decodeURIComponent(prettyName[1]);</span>
<a href="#l29.49"></a><span id="l29.49">     } else {</span>
<a href="#l29.50"></a><span id="l29.50" class="difflineminus">-        name = calGetString(&quot;calendar&quot;, &quot;untitledCalendarName&quot;);</span>
<a href="#l29.51"></a><span id="l29.51" class="difflineplus">+        name = cal.calGetString(&quot;calendar&quot;, &quot;untitledCalendarName&quot;);</span>
<a href="#l29.52"></a><span id="l29.52">     }</span>
<a href="#l29.53"></a><span id="l29.53">     openCalendar.name = name;</span>
<a href="#l29.54"></a><span id="l29.54"> </span>
<a href="#l29.55"></a><span id="l29.55">     calMgr.registerCalendar(openCalendar);</span>
<a href="#l29.56"></a><span id="l29.56"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-dialog-utils.js</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-dialog-utils.js</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -6,16 +6,17 @@</span>
<a href="#l30.4"></a><span id="l30.4">  *          dispose, setDialogId, loadReminders, saveReminder,</span>
<a href="#l30.5"></a><span id="l30.5">  *          commonUpdateReminder, updateLink, rearrangeAttendees</span>
<a href="#l30.6"></a><span id="l30.6">  */</span>
<a href="#l30.7"></a><span id="l30.7"> </span>
<a href="#l30.8"></a><span id="l30.8"> Components.utils.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l30.9"></a><span id="l30.9"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l30.10"></a><span id="l30.10"> Components.utils.import(&quot;resource://gre/modules/iteratorUtils.jsm&quot;);</span>
<a href="#l30.11"></a><span id="l30.11"> </span>
<a href="#l30.12"></a><span id="l30.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l30.13"></a><span id="l30.13"> Components.utils.import(&quot;resource://calendar/modules/calAlarmUtils.jsm&quot;);</span>
<a href="#l30.14"></a><span id="l30.14"> Components.utils.import(&quot;resource://calendar/modules/calIteratorUtils.jsm&quot;);</span>
<a href="#l30.15"></a><span id="l30.15"> Components.utils.import(&quot;resource://calendar/modules/calRecurrenceUtils.jsm&quot;);</span>
<a href="#l30.16"></a><span id="l30.16"> </span>
<a href="#l30.17"></a><span id="l30.17"> // Variables related to whether we are in a tab or a window dialog.</span>
<a href="#l30.18"></a><span id="l30.18"> var gInTab = false;</span>
<a href="#l30.19"></a><span id="l30.19"> var gMainWindow = null;</span>
<a href="#l30.20"></a><span id="l30.20"> var gTabmail = null;</span>
<a href="#l30.21"></a><span id="l30.21" class="difflineat">@@ -134,17 +135,17 @@ function createReminderFromMenuitem(aMen</span>
<a href="#l30.22"></a><span id="l30.22">  */</span>
<a href="#l30.23"></a><span id="l30.23"> function editReminder() {</span>
<a href="#l30.24"></a><span id="l30.24">     let customItem = document.getElementById(&quot;reminder-custom-menuitem&quot;);</span>
<a href="#l30.25"></a><span id="l30.25">     let args = {};</span>
<a href="#l30.26"></a><span id="l30.26">     args.reminders = customItem.reminders;</span>
<a href="#l30.27"></a><span id="l30.27">     args.item = window.calendarItem;</span>
<a href="#l30.28"></a><span id="l30.28">     args.timezone = window.gStartTimezone ||</span>
<a href="#l30.29"></a><span id="l30.29">                     window.gEndTimezone ||</span>
<a href="#l30.30"></a><span id="l30.30" class="difflineminus">-                    calendarDefaultTimezone();</span>
<a href="#l30.31"></a><span id="l30.31" class="difflineplus">+                    cal.calendarDefaultTimezone();</span>
<a href="#l30.32"></a><span id="l30.32"> </span>
<a href="#l30.33"></a><span id="l30.33">     args.calendar = getCurrentCalendar();</span>
<a href="#l30.34"></a><span id="l30.34"> </span>
<a href="#l30.35"></a><span id="l30.35">     // While these are &quot;just&quot; callbacks, the dialog is opened modally, so aside</span>
<a href="#l30.36"></a><span id="l30.36">     // from whats needed to set up the reminders, nothing else needs to be done.</span>
<a href="#l30.37"></a><span id="l30.37">     args.onOk = function(reminders) {</span>
<a href="#l30.38"></a><span id="l30.38">         customItem.reminders = reminders;</span>
<a href="#l30.39"></a><span id="l30.39">     };</span>
<a href="#l30.40"></a><span id="l30.40" class="difflineat">@@ -451,17 +452,17 @@ function commonUpdateReminder(aSuppressD</span>
<a href="#l30.41"></a><span id="l30.41">     reminderList.setAttribute(&quot;last-value&quot;, reminderList.value);</span>
<a href="#l30.42"></a><span id="l30.42"> </span>
<a href="#l30.43"></a><span id="l30.43">     // possibly the selected reminder conflicts with the item.</span>
<a href="#l30.44"></a><span id="l30.44">     // for example an end-relation combined with a task without duedate</span>
<a href="#l30.45"></a><span id="l30.45">     // is an invalid state we need to take care of. we take the same</span>
<a href="#l30.46"></a><span id="l30.46">     // approach as with recurring tasks. in case the reminder is related</span>
<a href="#l30.47"></a><span id="l30.47">     // to the entry date we check the entry date automatically and disable</span>
<a href="#l30.48"></a><span id="l30.48">     // the checkbox. the same goes for end related reminder and the due date.</span>
<a href="#l30.49"></a><span id="l30.49" class="difflineminus">-    if (isToDo(window.calendarItem)) {</span>
<a href="#l30.50"></a><span id="l30.50" class="difflineplus">+    if (cal.isToDo(window.calendarItem)) {</span>
<a href="#l30.51"></a><span id="l30.51">         // In general, (re-)enable the due/entry checkboxes. This will be</span>
<a href="#l30.52"></a><span id="l30.52">         // changed in case the alarms are related to START/END below.</span>
<a href="#l30.53"></a><span id="l30.53">         enableElementWithLock(&quot;todo-has-duedate&quot;, &quot;reminder-lock&quot;);</span>
<a href="#l30.54"></a><span id="l30.54">         enableElementWithLock(&quot;todo-has-entrydate&quot;, &quot;reminder-lock&quot;);</span>
<a href="#l30.55"></a><span id="l30.55"> </span>
<a href="#l30.56"></a><span id="l30.56">         let menuitem = reminderList.selectedItem;</span>
<a href="#l30.57"></a><span id="l30.57">         if (menuitem.value != &quot;none&quot;) {</span>
<a href="#l30.58"></a><span id="l30.58">             // In case a reminder is selected, retrieve the array of alarms from</span>
<a href="#l30.59"></a><span id="l30.59" class="difflineat">@@ -528,17 +529,17 @@ function updateLink() {</span>
<a href="#l30.60"></a><span id="l30.60">     if ((linkCommand &amp;&amp; linkCommand.getAttribute(&quot;checked&quot;) != &quot;true&quot;) ||</span>
<a href="#l30.61"></a><span id="l30.61">         !itemUrlString.length) {</span>
<a href="#l30.62"></a><span id="l30.62">         // Hide if there is no url, or the menuitem was chosen so that the url</span>
<a href="#l30.63"></a><span id="l30.63">         // should be hidden</span>
<a href="#l30.64"></a><span id="l30.64">         hideOrShow(false);</span>
<a href="#l30.65"></a><span id="l30.65">     } else {</span>
<a href="#l30.66"></a><span id="l30.66">         let handler, uri;</span>
<a href="#l30.67"></a><span id="l30.67">         try {</span>
<a href="#l30.68"></a><span id="l30.68" class="difflineminus">-            uri = makeURL(itemUrlString);</span>
<a href="#l30.69"></a><span id="l30.69" class="difflineplus">+            uri = cal.makeURL(itemUrlString);</span>
<a href="#l30.70"></a><span id="l30.70">             handler = Services.io.getProtocolHandler(uri.scheme);</span>
<a href="#l30.71"></a><span id="l30.71">         } catch (e) {</span>
<a href="#l30.72"></a><span id="l30.72">             // No protocol handler for the given protocol, or invalid uri</span>
<a href="#l30.73"></a><span id="l30.73">             hideOrShow(false);</span>
<a href="#l30.74"></a><span id="l30.74">             return;</span>
<a href="#l30.75"></a><span id="l30.75">         }</span>
<a href="#l30.76"></a><span id="l30.76"> </span>
<a href="#l30.77"></a><span id="l30.77">         // Only show if its either an internal protcol handler, or its external</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-attendees.js</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-attendees.js</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -173,17 +173,17 @@ function zoomWithButtons(aZoomOut) {</span>
<a href="#l31.4"></a><span id="l31.4">  * Loads the passed start and end dates, fills global variables that give</span>
<a href="#l31.5"></a><span id="l31.5">  * information about the state of the dialog.</span>
<a href="#l31.6"></a><span id="l31.6">  *</span>
<a href="#l31.7"></a><span id="l31.7">  * @param aStartDate        The date/time the grid should start at.</span>
<a href="#l31.8"></a><span id="l31.8">  * @param aEndDate          The date/time the grid should end at.</span>
<a href="#l31.9"></a><span id="l31.9">  */</span>
<a href="#l31.10"></a><span id="l31.10"> function loadDateTime(aStartDate, aEndDate) {</span>
<a href="#l31.11"></a><span id="l31.11">     gDuration = aEndDate.subtractDate(aStartDate);</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-    let kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineplus">+    let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l31.14"></a><span id="l31.14">     gStartTimezone = aStartDate.timezone;</span>
<a href="#l31.15"></a><span id="l31.15">     gEndTimezone = aEndDate.timezone;</span>
<a href="#l31.16"></a><span id="l31.16">     gStartDate = aStartDate.getInTimezone(kDefaultTimezone);</span>
<a href="#l31.17"></a><span id="l31.17">     gEndDate = aEndDate.getInTimezone(kDefaultTimezone);</span>
<a href="#l31.18"></a><span id="l31.18">     gStartDate.makeImmutable();</span>
<a href="#l31.19"></a><span id="l31.19">     gEndDate.makeImmutable();</span>
<a href="#l31.20"></a><span id="l31.20"> }</span>
<a href="#l31.21"></a><span id="l31.21"> </span>
<a href="#l31.22"></a><span id="l31.22" class="difflineat">@@ -215,17 +215,17 @@ function propagateDateTime() {</span>
<a href="#l31.23"></a><span id="l31.23">                   (grid.endDate.compare(gEndDate) != 0);</span>
<a href="#l31.24"></a><span id="l31.24">     grid.startDate = gStartDate;</span>
<a href="#l31.25"></a><span id="l31.25">     grid.endDate = gEndDate;</span>
<a href="#l31.26"></a><span id="l31.26">     if (refresh) {</span>
<a href="#l31.27"></a><span id="l31.27">         grid.forceRefresh();</span>
<a href="#l31.28"></a><span id="l31.28">     }</span>
<a href="#l31.29"></a><span id="l31.29"> </span>
<a href="#l31.30"></a><span id="l31.30">     // Expand to 24hrs if the new range is outside of the default range.</span>
<a href="#l31.31"></a><span id="l31.31" class="difflineminus">-    let kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l31.32"></a><span id="l31.32" class="difflineplus">+    let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l31.33"></a><span id="l31.33">     let startTime = gStartDate.getInTimezone(kDefaultTimezone);</span>
<a href="#l31.34"></a><span id="l31.34">     let endTime = gEndDate.getInTimezone(kDefaultTimezone);</span>
<a href="#l31.35"></a><span id="l31.35">     if ((startTime.hour &lt; gStartHour) ||</span>
<a href="#l31.36"></a><span id="l31.36">         (startTime.hour &gt;= gEndHour) ||</span>
<a href="#l31.37"></a><span id="l31.37">         (endTime.hour &gt;= gEndHour) ||</span>
<a href="#l31.38"></a><span id="l31.38">         (startTime.day != endTime.day) ||</span>
<a href="#l31.39"></a><span id="l31.39">         (startTime.isDate)) {</span>
<a href="#l31.40"></a><span id="l31.40">         setForce24Hours(true);</span>
<a href="#l31.41"></a><span id="l31.41" class="difflineat">@@ -249,47 +249,47 @@ function updateDateTime() {</span>
<a href="#l31.42"></a><span id="l31.42">             document.getElementById(&quot;all-day&quot;)</span>
<a href="#l31.43"></a><span id="l31.43">                 .setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l31.44"></a><span id="l31.44">         }</span>
<a href="#l31.45"></a><span id="l31.45"> </span>
<a href="#l31.46"></a><span id="l31.46">         // In the case where the timezones are different but</span>
<a href="#l31.47"></a><span id="l31.47">         // the timezone of the endtime is &quot;UTC&quot;, we convert</span>
<a href="#l31.48"></a><span id="l31.48">         // the endtime into the timezone of the starttime.</span>
<a href="#l31.49"></a><span id="l31.49">         if (startTime &amp;&amp; endTime) {</span>
<a href="#l31.50"></a><span id="l31.50" class="difflineminus">-            if (!compareObjects(startTime.timezone, endTime.timezone)) {</span>
<a href="#l31.51"></a><span id="l31.51" class="difflineplus">+            if (!cal.compareObjects(startTime.timezone, endTime.timezone)) {</span>
<a href="#l31.52"></a><span id="l31.52">                 if (endTime.timezone.isUTC) {</span>
<a href="#l31.53"></a><span id="l31.53">                     endTime = endTime.getInTimezone(startTime.timezone);</span>
<a href="#l31.54"></a><span id="l31.54">                 }</span>
<a href="#l31.55"></a><span id="l31.55">             }</span>
<a href="#l31.56"></a><span id="l31.56">         }</span>
<a href="#l31.57"></a><span id="l31.57"> </span>
<a href="#l31.58"></a><span id="l31.58">         // Before feeding the date/time value into the control we need</span>
<a href="#l31.59"></a><span id="l31.59">         // to set the timezone to 'floating' in order to avoid the</span>
<a href="#l31.60"></a><span id="l31.60">         // automatic conversion back into the OS timezone.</span>
<a href="#l31.61"></a><span id="l31.61" class="difflineminus">-        startTime.timezone = floating();</span>
<a href="#l31.62"></a><span id="l31.62" class="difflineminus">-        endTime.timezone = floating();</span>
<a href="#l31.63"></a><span id="l31.63" class="difflineplus">+        startTime.timezone = cal.floating();</span>
<a href="#l31.64"></a><span id="l31.64" class="difflineplus">+        endTime.timezone = cal.floating();</span>
<a href="#l31.65"></a><span id="l31.65"> </span>
<a href="#l31.66"></a><span id="l31.66">         document.getElementById(&quot;event-starttime&quot;).value = cal.dateTimeToJsDate(startTime);</span>
<a href="#l31.67"></a><span id="l31.67">         document.getElementById(&quot;event-endtime&quot;).value = cal.dateTimeToJsDate(endTime);</span>
<a href="#l31.68"></a><span id="l31.68">     } else {</span>
<a href="#l31.69"></a><span id="l31.69" class="difflineminus">-        let kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l31.70"></a><span id="l31.70" class="difflineplus">+        let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l31.71"></a><span id="l31.71"> </span>
<a href="#l31.72"></a><span id="l31.72">         let startTime = gStartDate.getInTimezone(kDefaultTimezone);</span>
<a href="#l31.73"></a><span id="l31.73">         let endTime = gEndDate.getInTimezone(kDefaultTimezone);</span>
<a href="#l31.74"></a><span id="l31.74"> </span>
<a href="#l31.75"></a><span id="l31.75">         if (startTime.isDate) {</span>
<a href="#l31.76"></a><span id="l31.76">             document.getElementById(&quot;all-day&quot;)</span>
<a href="#l31.77"></a><span id="l31.77">                 .setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l31.78"></a><span id="l31.78">         }</span>
<a href="#l31.79"></a><span id="l31.79"> </span>
<a href="#l31.80"></a><span id="l31.80">         // Before feeding the date/time value into the control we need</span>
<a href="#l31.81"></a><span id="l31.81">         // to set the timezone to 'floating' in order to avoid the</span>
<a href="#l31.82"></a><span id="l31.82">         // automatic conversion back into the OS timezone.</span>
<a href="#l31.83"></a><span id="l31.83" class="difflineminus">-        startTime.timezone = floating();</span>
<a href="#l31.84"></a><span id="l31.84" class="difflineminus">-        endTime.timezone = floating();</span>
<a href="#l31.85"></a><span id="l31.85" class="difflineplus">+        startTime.timezone = cal.floating();</span>
<a href="#l31.86"></a><span id="l31.86" class="difflineplus">+        endTime.timezone = cal.floating();</span>
<a href="#l31.87"></a><span id="l31.87"> </span>
<a href="#l31.88"></a><span id="l31.88">         document.getElementById(&quot;event-starttime&quot;).value = cal.dateTimeToJsDate(startTime);</span>
<a href="#l31.89"></a><span id="l31.89">         document.getElementById(&quot;event-endtime&quot;).value = cal.dateTimeToJsDate(endTime);</span>
<a href="#l31.90"></a><span id="l31.90">     }</span>
<a href="#l31.91"></a><span id="l31.91"> </span>
<a href="#l31.92"></a><span id="l31.92">     updateTimezone();</span>
<a href="#l31.93"></a><span id="l31.93">     updateAllDay();</span>
<a href="#l31.94"></a><span id="l31.94"> }</span>
<a href="#l31.95"></a><span id="l31.95" class="difflineat">@@ -302,17 +302,17 @@ function updateDateTime() {</span>
<a href="#l31.96"></a><span id="l31.96"> function updateTimezone() {</span>
<a href="#l31.97"></a><span id="l31.97">     gIgnoreUpdate = true;</span>
<a href="#l31.98"></a><span id="l31.98"> </span>
<a href="#l31.99"></a><span id="l31.99">     if (gDisplayTimezone) {</span>
<a href="#l31.100"></a><span id="l31.100">         let startTimezone = gStartTimezone;</span>
<a href="#l31.101"></a><span id="l31.101">         let endTimezone = gEndTimezone;</span>
<a href="#l31.102"></a><span id="l31.102">         let equalTimezones = false;</span>
<a href="#l31.103"></a><span id="l31.103">         if (startTimezone &amp;&amp; endTimezone &amp;&amp;</span>
<a href="#l31.104"></a><span id="l31.104" class="difflineminus">-            (compareObjects(startTimezone, endTimezone) || endTimezone.isUTC)) {</span>
<a href="#l31.105"></a><span id="l31.105" class="difflineplus">+            (cal.compareObjects(startTimezone, endTimezone) || endTimezone.isUTC)) {</span>
<a href="#l31.106"></a><span id="l31.106">             equalTimezones = true;</span>
<a href="#l31.107"></a><span id="l31.107">         }</span>
<a href="#l31.108"></a><span id="l31.108"> </span>
<a href="#l31.109"></a><span id="l31.109">         let tzStart = document.getElementById(&quot;timezone-starttime&quot;);</span>
<a href="#l31.110"></a><span id="l31.110">         let tzEnd = document.getElementById(&quot;timezone-endtime&quot;);</span>
<a href="#l31.111"></a><span id="l31.111">         if (startTimezone) {</span>
<a href="#l31.112"></a><span id="l31.112">             tzStart.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l31.113"></a><span id="l31.113">             tzStart.value = startTimezone.displayName || startTimezone.tzid;</span>
<a href="#l31.114"></a><span id="l31.114" class="difflineat">@@ -347,17 +347,17 @@ function updateStartTime() {</span>
<a href="#l31.115"></a><span id="l31.115"> </span>
<a href="#l31.116"></a><span id="l31.116">     let startWidgetId = &quot;event-starttime&quot;;</span>
<a href="#l31.117"></a><span id="l31.117"> </span>
<a href="#l31.118"></a><span id="l31.118">     let startWidget = document.getElementById(startWidgetId);</span>
<a href="#l31.119"></a><span id="l31.119"> </span>
<a href="#l31.120"></a><span id="l31.120">     // jsDate is always in OS timezone, thus we create a calIDateTime</span>
<a href="#l31.121"></a><span id="l31.121">     // object from the jsDate representation and simply set the new</span>
<a href="#l31.122"></a><span id="l31.122">     // timezone instead of converting.</span>
<a href="#l31.123"></a><span id="l31.123" class="difflineminus">-    let timezone = gDisplayTimezone ? gStartTimezone : calendarDefaultTimezone();</span>
<a href="#l31.124"></a><span id="l31.124" class="difflineplus">+    let timezone = gDisplayTimezone ? gStartTimezone : cal.calendarDefaultTimezone();</span>
<a href="#l31.125"></a><span id="l31.125">     let start = cal.jsDateToDateTime(startWidget.value, timezone);</span>
<a href="#l31.126"></a><span id="l31.126"> </span>
<a href="#l31.127"></a><span id="l31.127">     gStartDate = start.clone();</span>
<a href="#l31.128"></a><span id="l31.128">     start.addDuration(gDuration);</span>
<a href="#l31.129"></a><span id="l31.129">     gEndDate = start.getInTimezone(gEndTimezone);</span>
<a href="#l31.130"></a><span id="l31.130"> </span>
<a href="#l31.131"></a><span id="l31.131">     let allDayElement = document.getElementById(&quot;all-day&quot;);</span>
<a href="#l31.132"></a><span id="l31.132">     let allDay = allDayElement.getAttribute(&quot;checked&quot;) == &quot;true&quot;;</span>
<a href="#l31.133"></a><span id="l31.133" class="difflineat">@@ -380,25 +380,25 @@ function updateEndTime() {</span>
<a href="#l31.134"></a><span id="l31.134">     let startWidgetId = &quot;event-starttime&quot;;</span>
<a href="#l31.135"></a><span id="l31.135">     let endWidgetId = &quot;event-endtime&quot;;</span>
<a href="#l31.136"></a><span id="l31.136"> </span>
<a href="#l31.137"></a><span id="l31.137">     let startWidget = document.getElementById(startWidgetId);</span>
<a href="#l31.138"></a><span id="l31.138">     let endWidget = document.getElementById(endWidgetId);</span>
<a href="#l31.139"></a><span id="l31.139"> </span>
<a href="#l31.140"></a><span id="l31.140">     let saveStartTime = gStartDate;</span>
<a href="#l31.141"></a><span id="l31.141">     let saveEndTime = gEndDate;</span>
<a href="#l31.142"></a><span id="l31.142" class="difflineminus">-    let kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l31.143"></a><span id="l31.143" class="difflineplus">+    let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l31.144"></a><span id="l31.144"> </span>
<a href="#l31.145"></a><span id="l31.145">     gStartDate = cal.jsDateToDateTime(startWidget.value,</span>
<a href="#l31.146"></a><span id="l31.146" class="difflineminus">-                                  gDisplayTimezone ? gStartTimezone : calendarDefaultTimezone());</span>
<a href="#l31.147"></a><span id="l31.147" class="difflineplus">+                                  gDisplayTimezone ? gStartTimezone : cal.calendarDefaultTimezone());</span>
<a href="#l31.148"></a><span id="l31.148"> </span>
<a href="#l31.149"></a><span id="l31.149">     let timezone = gEndTimezone;</span>
<a href="#l31.150"></a><span id="l31.150">     if (timezone.isUTC &amp;&amp;</span>
<a href="#l31.151"></a><span id="l31.151">         gStartDate &amp;&amp;</span>
<a href="#l31.152"></a><span id="l31.152" class="difflineminus">-        !compareObjects(gStartTimezone, gEndTimezone)) {</span>
<a href="#l31.153"></a><span id="l31.153" class="difflineplus">+        !cal.compareObjects(gStartTimezone, gEndTimezone)) {</span>
<a href="#l31.154"></a><span id="l31.154">         timezone = gStartTimezone;</span>
<a href="#l31.155"></a><span id="l31.155">     }</span>
<a href="#l31.156"></a><span id="l31.156">     gEndDate = cal.jsDateToDateTime(endWidget.value,</span>
<a href="#l31.157"></a><span id="l31.157">                                     gDisplayTimezone ? timezone : kDefaultTimezone);</span>
<a href="#l31.158"></a><span id="l31.158"> </span>
<a href="#l31.159"></a><span id="l31.159">     let allDayElement = document.getElementById(&quot;all-day&quot;);</span>
<a href="#l31.160"></a><span id="l31.160">     let allDay = allDayElement.getAttribute(&quot;checked&quot;) == &quot;true&quot;;</span>
<a href="#l31.161"></a><span id="l31.161">     if (allDay) {</span>
<a href="#l31.162"></a><span id="l31.162" class="difflineat">@@ -419,17 +419,17 @@ function updateEndTime() {</span>
<a href="#l31.163"></a><span id="l31.163"> </span>
<a href="#l31.164"></a><span id="l31.164">     propagateDateTime();</span>
<a href="#l31.165"></a><span id="l31.165"> </span>
<a href="#l31.166"></a><span id="l31.166">     if (warning) {</span>
<a href="#l31.167"></a><span id="l31.167">         let callback = function() {</span>
<a href="#l31.168"></a><span id="l31.168">             Services.prompt.alert(</span>
<a href="#l31.169"></a><span id="l31.169">                 null,</span>
<a href="#l31.170"></a><span id="l31.170">                 document.title,</span>
<a href="#l31.171"></a><span id="l31.171" class="difflineminus">-                calGetString(&quot;calendar&quot;, &quot;warningEndBeforeStart&quot;));</span>
<a href="#l31.172"></a><span id="l31.172" class="difflineplus">+                cal.calGetString(&quot;calendar&quot;, &quot;warningEndBeforeStart&quot;));</span>
<a href="#l31.173"></a><span id="l31.173">         };</span>
<a href="#l31.174"></a><span id="l31.174">         setTimeout(callback, 1);</span>
<a href="#l31.175"></a><span id="l31.175">     }</span>
<a href="#l31.176"></a><span id="l31.176"> }</span>
<a href="#l31.177"></a><span id="l31.177"> </span>
<a href="#l31.178"></a><span id="l31.178"> /**</span>
<a href="#l31.179"></a><span id="l31.179">  * Prompts the user to pick a new timezone for the starttime. The dialog is</span>
<a href="#l31.180"></a><span id="l31.180">  * opened modally.</span>
<a href="#l31.181"></a><span id="l31.181" class="difflineat">@@ -442,17 +442,17 @@ function editStartTimezone() {</span>
<a href="#l31.182"></a><span id="l31.182"> </span>
<a href="#l31.183"></a><span id="l31.183">     let self = this;</span>
<a href="#l31.184"></a><span id="l31.184">     let args = {};</span>
<a href="#l31.185"></a><span id="l31.185">     args.calendar = window.arguments[0].calendar;</span>
<a href="#l31.186"></a><span id="l31.186">     args.time = gStartDate.getInTimezone(gStartTimezone);</span>
<a href="#l31.187"></a><span id="l31.187">     args.onOk = function(datetime) {</span>
<a href="#l31.188"></a><span id="l31.188">         let equalTimezones = false;</span>
<a href="#l31.189"></a><span id="l31.189">         if (gStartTimezone &amp;&amp; gEndTimezone &amp;&amp;</span>
<a href="#l31.190"></a><span id="l31.190" class="difflineminus">-            compareObjects(gStartTimezone, gEndTimezone)) {</span>
<a href="#l31.191"></a><span id="l31.191" class="difflineplus">+            cal.compareObjects(gStartTimezone, gEndTimezone)) {</span>
<a href="#l31.192"></a><span id="l31.192">             equalTimezones = true;</span>
<a href="#l31.193"></a><span id="l31.193">         }</span>
<a href="#l31.194"></a><span id="l31.194">         gStartTimezone = datetime.timezone;</span>
<a href="#l31.195"></a><span id="l31.195">         if (equalTimezones) {</span>
<a href="#l31.196"></a><span id="l31.196">             gEndTimezone = datetime.timezone;</span>
<a href="#l31.197"></a><span id="l31.197">         }</span>
<a href="#l31.198"></a><span id="l31.198">         self.propagateDateTime();</span>
<a href="#l31.199"></a><span id="l31.199">     };</span>
<a href="#l31.200"></a><span id="l31.200" class="difflineat">@@ -476,17 +476,17 @@ function editEndTimezone() {</span>
<a href="#l31.201"></a><span id="l31.201">     }</span>
<a href="#l31.202"></a><span id="l31.202"> </span>
<a href="#l31.203"></a><span id="l31.203">     let self = this;</span>
<a href="#l31.204"></a><span id="l31.204">     let args = {};</span>
<a href="#l31.205"></a><span id="l31.205">     args.calendar = window.arguments[0].calendar;</span>
<a href="#l31.206"></a><span id="l31.206">     args.time = gEndTime.getInTimezone(gEndTimezone);</span>
<a href="#l31.207"></a><span id="l31.207">     args.onOk = function(datetime) {</span>
<a href="#l31.208"></a><span id="l31.208">         if (gStartTimezone &amp;&amp; gEndTimezone &amp;&amp;</span>
<a href="#l31.209"></a><span id="l31.209" class="difflineminus">-            compareObjects(gStartTimezone, gEndTimezone)) {</span>
<a href="#l31.210"></a><span id="l31.210" class="difflineplus">+            cal.compareObjects(gStartTimezone, gEndTimezone)) {</span>
<a href="#l31.211"></a><span id="l31.211">             gStartTimezone = datetime.timezone;</span>
<a href="#l31.212"></a><span id="l31.212">         }</span>
<a href="#l31.213"></a><span id="l31.213">         gEndTimezone = datetime.timezone;</span>
<a href="#l31.214"></a><span id="l31.214">         self.propagateDateTime();</span>
<a href="#l31.215"></a><span id="l31.215">     };</span>
<a href="#l31.216"></a><span id="l31.216"> </span>
<a href="#l31.217"></a><span id="l31.217">     // Open the dialog modally</span>
<a href="#l31.218"></a><span id="l31.218">     openDialog(</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-attendees.xml</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -902,17 +902,17 @@</span>
<a href="#l32.4"></a><span id="l32.4">               document.getAnonymousElementByAttribute(</span>
<a href="#l32.5"></a><span id="l32.5">                   this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l32.6"></a><span id="l32.6">           return listbox.getIndexOfFirstVisibleRow();</span>
<a href="#l32.7"></a><span id="l32.7">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l32.8"></a><span id="l32.8">       &lt;/property&gt;</span>
<a href="#l32.9"></a><span id="l32.9"> </span>
<a href="#l32.10"></a><span id="l32.10">       &lt;method name=&quot;createAttendee&quot;&gt;</span>
<a href="#l32.11"></a><span id="l32.11">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-          let attendee = createAttendee();</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineplus">+          let attendee = cal.createAttendee();</span>
<a href="#l32.14"></a><span id="l32.14">           attendee.id = &quot;&quot;;</span>
<a href="#l32.15"></a><span id="l32.15">           attendee.rsvp = &quot;TRUE&quot;;</span>
<a href="#l32.16"></a><span id="l32.16">           attendee.role = &quot;REQ-PARTICIPANT&quot;;</span>
<a href="#l32.17"></a><span id="l32.17">           attendee.participationStatus = &quot;NEEDS-ACTION&quot;;</span>
<a href="#l32.18"></a><span id="l32.18">           return attendee;</span>
<a href="#l32.19"></a><span id="l32.19">         ]]&gt;&lt;/body&gt;</span>
<a href="#l32.20"></a><span id="l32.20">       &lt;/method&gt;</span>
<a href="#l32.21"></a><span id="l32.21"> </span>
<a href="#l32.22"></a><span id="l32.22" class="difflineat">@@ -1256,16 +1256,17 @@</span>
<a href="#l32.23"></a><span id="l32.23">           this.mRatio = val;</span>
<a href="#l32.24"></a><span id="l32.24">           this.update();</span>
<a href="#l32.25"></a><span id="l32.25">           return val;</span>
<a href="#l32.26"></a><span id="l32.26">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l32.27"></a><span id="l32.27">       &lt;/property&gt;</span>
<a href="#l32.28"></a><span id="l32.28"> </span>
<a href="#l32.29"></a><span id="l32.29">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l32.30"></a><span id="l32.30">         Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l32.31"></a><span id="l32.31" class="difflineplus">+        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l32.32"></a><span id="l32.32"> </span>
<a href="#l32.33"></a><span id="l32.33">         this.initTimeRange();</span>
<a href="#l32.34"></a><span id="l32.34"> </span>
<a href="#l32.35"></a><span id="l32.35">         // The basedate is the date/time from which the display</span>
<a href="#l32.36"></a><span id="l32.36">         // of the timebar starts. The range is the number of days</span>
<a href="#l32.37"></a><span id="l32.37">         // we should be able to show. the start- and enddate</span>
<a href="#l32.38"></a><span id="l32.38">         // is the time the event is scheduled for.</span>
<a href="#l32.39"></a><span id="l32.39">         this.mRange = Number(this.getAttribute(&quot;range&quot;));</span>
<a href="#l32.40"></a><span id="l32.40" class="difflineat">@@ -1274,49 +1275,49 @@</span>
<a href="#l32.41"></a><span id="l32.41">                 this, &quot;anonid&quot;, &quot;selection-bar&quot;);</span>
<a href="#l32.42"></a><span id="l32.42">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l32.43"></a><span id="l32.43"> </span>
<a href="#l32.44"></a><span id="l32.44">       &lt;property name=&quot;baseDate&quot;&gt;</span>
<a href="#l32.45"></a><span id="l32.45">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l32.46"></a><span id="l32.46">           // we need to convert the date/time in question in</span>
<a href="#l32.47"></a><span id="l32.47">           // order to calculate with hours that are aligned</span>
<a href="#l32.48"></a><span id="l32.48">           // with our timebar display.</span>
<a href="#l32.49"></a><span id="l32.49" class="difflineminus">-          let kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l32.50"></a><span id="l32.50" class="difflineplus">+          let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l32.51"></a><span id="l32.51">           this.mBaseDate = val.getInTimezone(kDefaultTimezone);</span>
<a href="#l32.52"></a><span id="l32.52">           this.mBaseDate.isDate = true;</span>
<a href="#l32.53"></a><span id="l32.53">           this.mBaseDate.makeImmutable();</span>
<a href="#l32.54"></a><span id="l32.54">           return val;</span>
<a href="#l32.55"></a><span id="l32.55">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l32.56"></a><span id="l32.56">       &lt;/property&gt;</span>
<a href="#l32.57"></a><span id="l32.57"> </span>
<a href="#l32.58"></a><span id="l32.58">       &lt;property name=&quot;startDate&quot;&gt;</span>
<a href="#l32.59"></a><span id="l32.59">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l32.60"></a><span id="l32.60">           // currently we *always* set the basedate to be</span>
<a href="#l32.61"></a><span id="l32.61">           // equal to the startdate. we'll most probably</span>
<a href="#l32.62"></a><span id="l32.62">           // want to change this later.</span>
<a href="#l32.63"></a><span id="l32.63">           this.baseDate = val;</span>
<a href="#l32.64"></a><span id="l32.64">           // we need to convert the date/time in question in</span>
<a href="#l32.65"></a><span id="l32.65">           // order to calculate with hours that are aligned</span>
<a href="#l32.66"></a><span id="l32.66">           // with our timebar display.</span>
<a href="#l32.67"></a><span id="l32.67" class="difflineminus">-          let kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l32.68"></a><span id="l32.68" class="difflineplus">+          let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l32.69"></a><span id="l32.69">           this.mStartDate = val.getInTimezone(kDefaultTimezone);</span>
<a href="#l32.70"></a><span id="l32.70">           this.mStartDate.makeImmutable();</span>
<a href="#l32.71"></a><span id="l32.71">           return val;</span>
<a href="#l32.72"></a><span id="l32.72">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l32.73"></a><span id="l32.73">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l32.74"></a><span id="l32.74">           return this.mStartDate;</span>
<a href="#l32.75"></a><span id="l32.75">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l32.76"></a><span id="l32.76">       &lt;/property&gt;</span>
<a href="#l32.77"></a><span id="l32.77"> </span>
<a href="#l32.78"></a><span id="l32.78">       &lt;property name=&quot;endDate&quot;&gt;</span>
<a href="#l32.79"></a><span id="l32.79">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l32.80"></a><span id="l32.80">           // we need to convert the date/time in question in</span>
<a href="#l32.81"></a><span id="l32.81">           // order to calculate with hours that are aligned</span>
<a href="#l32.82"></a><span id="l32.82">           // with our timebar display.</span>
<a href="#l32.83"></a><span id="l32.83" class="difflineminus">-          let kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l32.84"></a><span id="l32.84" class="difflineplus">+          let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l32.85"></a><span id="l32.85">           this.mEndDate = val.getInTimezone(kDefaultTimezone);</span>
<a href="#l32.86"></a><span id="l32.86">           if (this.mEndDate.isDate) {</span>
<a href="#l32.87"></a><span id="l32.87">               this.mEndDate.day += 1;</span>
<a href="#l32.88"></a><span id="l32.88">           }</span>
<a href="#l32.89"></a><span id="l32.89">           this.mEndDate.makeImmutable();</span>
<a href="#l32.90"></a><span id="l32.90">           return val;</span>
<a href="#l32.91"></a><span id="l32.91">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l32.92"></a><span id="l32.92">         &lt;getter&gt;&lt;![CDATA[</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-attendees.xul</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-attendees.xul</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -24,17 +24,16 @@</span>
<a href="#l33.4"></a><span id="l33.4">         persist=&quot;screenX screenY height width&quot;</span>
<a href="#l33.5"></a><span id="l33.5">         orient=&quot;vertical&quot;</span>
<a href="#l33.6"></a><span id="l33.6">         style=&quot;padding-top: 8px; padding-bottom: 10px; padding-inline-start: 8px; padding-inline-end: 10px;&quot;</span>
<a href="#l33.7"></a><span id="l33.7">         xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;&gt;</span>
<a href="#l33.8"></a><span id="l33.8"> </span>
<a href="#l33.9"></a><span id="l33.9">   &lt;!-- Javascript includes --&gt;</span>
<a href="#l33.10"></a><span id="l33.10">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calendar-event-dialog-attendees.js&quot;/&gt;</span>
<a href="#l33.11"></a><span id="l33.11">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calendar-dialog-utils.js&quot;/&gt;</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-  &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calUtils.js&quot;/&gt;</span>
<a href="#l33.13"></a><span id="l33.13">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calendar-statusbar.js&quot;/&gt;</span>
<a href="#l33.14"></a><span id="l33.14">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calendar-ui-utils.js&quot;/&gt;</span>
<a href="#l33.15"></a><span id="l33.15"> </span>
<a href="#l33.16"></a><span id="l33.16">   &lt;hbox align=&quot;center&quot; pack=&quot;end&quot;&gt;</span>
<a href="#l33.17"></a><span id="l33.17">     &lt;spacer flex=&quot;1&quot;/&gt;</span>
<a href="#l33.18"></a><span id="l33.18">     &lt;label value=&quot;&amp;event.freebusy.suggest.slot;&quot;/&gt;</span>
<a href="#l33.19"></a><span id="l33.19">     &lt;button label=&quot;&amp;event.freebusy.button.previous.slot;&quot;</span>
<a href="#l33.20"></a><span id="l33.20">             dir=&quot;normal&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-freebusy.xml</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -420,28 +420,29 @@</span>
<a href="#l34.4"></a><span id="l34.4">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l34.5"></a><span id="l34.5">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l34.6"></a><span id="l34.6">           return this.mScrollOffset;</span>
<a href="#l34.7"></a><span id="l34.7">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l34.8"></a><span id="l34.8">       &lt;/property&gt;</span>
<a href="#l34.9"></a><span id="l34.9"> </span>
<a href="#l34.10"></a><span id="l34.10">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l34.11"></a><span id="l34.11">         Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineplus">+        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l34.13"></a><span id="l34.13"> </span>
<a href="#l34.14"></a><span id="l34.14">         let args = window.arguments[0];</span>
<a href="#l34.15"></a><span id="l34.15">         let startTime = args.startTime;</span>
<a href="#l34.16"></a><span id="l34.16">         let endTime = args.endTime;</span>
<a href="#l34.17"></a><span id="l34.17"> </span>
<a href="#l34.18"></a><span id="l34.18">         this.initTimeRange();</span>
<a href="#l34.19"></a><span id="l34.19"> </span>
<a href="#l34.20"></a><span id="l34.20">         // The basedate is the date/time from which the display</span>
<a href="#l34.21"></a><span id="l34.21">         // of the timebar starts. The range is the number of days</span>
<a href="#l34.22"></a><span id="l34.22">         // we should be able to show. The start- and enddate</span>
<a href="#l34.23"></a><span id="l34.23">         // is the time the event is scheduled for.</span>
<a href="#l34.24"></a><span id="l34.24" class="difflineminus">-        let kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l34.25"></a><span id="l34.25" class="difflineplus">+        let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l34.26"></a><span id="l34.26">         this.startDate = startTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l34.27"></a><span id="l34.27">         this.endDate = endTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l34.28"></a><span id="l34.28">         this.mRange = Number(this.getAttribute(&quot;range&quot;));</span>
<a href="#l34.29"></a><span id="l34.29"> </span>
<a href="#l34.30"></a><span id="l34.30">         window.addEventListener(&quot;load&quot;, this.onLoad.bind(this), true);</span>
<a href="#l34.31"></a><span id="l34.31">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l34.32"></a><span id="l34.32"> </span>
<a href="#l34.33"></a><span id="l34.33">       &lt;method name=&quot;refresh&quot;&gt;</span>
<a href="#l34.34"></a><span id="l34.34" class="difflineat">@@ -479,17 +480,17 @@</span>
<a href="#l34.35"></a><span id="l34.35">       &lt;/method&gt;</span>
<a href="#l34.36"></a><span id="l34.36"> </span>
<a href="#l34.37"></a><span id="l34.37">       &lt;method name=&quot;initialize&quot;&gt;</span>
<a href="#l34.38"></a><span id="l34.38">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l34.39"></a><span id="l34.39">           let args = window.arguments[0];</span>
<a href="#l34.40"></a><span id="l34.40">           let startTime = args.startTime;</span>
<a href="#l34.41"></a><span id="l34.41">           let endTime = args.endTime;</span>
<a href="#l34.42"></a><span id="l34.42"> </span>
<a href="#l34.43"></a><span id="l34.43" class="difflineminus">-          let kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l34.44"></a><span id="l34.44" class="difflineplus">+          let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l34.45"></a><span id="l34.45">           this.startDate = startTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l34.46"></a><span id="l34.46">           this.endDate = endTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l34.47"></a><span id="l34.47"> </span>
<a href="#l34.48"></a><span id="l34.48">           // Set the number of 'freebusy-day'-elements</span>
<a href="#l34.49"></a><span id="l34.49">           // we need to fill up the content box.</span>
<a href="#l34.50"></a><span id="l34.50">           // TODO: hardcoded value</span>
<a href="#l34.51"></a><span id="l34.51">           this.mNumDays = 4 * this.mZoomFactor / 100;</span>
<a href="#l34.52"></a><span id="l34.52">           if (this.mNumDays &lt; 2) {</span>
<a href="#l34.53"></a><span id="l34.53" class="difflineat">@@ -683,16 +684,17 @@</span>
<a href="#l34.54"></a><span id="l34.54">                   this, &quot;anonid&quot;, &quot;container&quot;);</span>
<a href="#l34.55"></a><span id="l34.55">           container.x = offset;</span>
<a href="#l34.56"></a><span id="l34.56">           return val;</span>
<a href="#l34.57"></a><span id="l34.57">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l34.58"></a><span id="l34.58">       &lt;/property&gt;</span>
<a href="#l34.59"></a><span id="l34.59"> </span>
<a href="#l34.60"></a><span id="l34.60">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l34.61"></a><span id="l34.61">         Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l34.62"></a><span id="l34.62" class="difflineplus">+        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l34.63"></a><span id="l34.63"> </span>
<a href="#l34.64"></a><span id="l34.64">         this.initTimeRange();</span>
<a href="#l34.65"></a><span id="l34.65">         this.mRange = Number(this.getAttribute(&quot;range&quot;));</span>
<a href="#l34.66"></a><span id="l34.66">         this.onLoad();</span>
<a href="#l34.67"></a><span id="l34.67">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l34.68"></a><span id="l34.68"> </span>
<a href="#l34.69"></a><span id="l34.69">       &lt;method name=&quot;onLoad&quot;&gt;</span>
<a href="#l34.70"></a><span id="l34.70">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l34.71"></a><span id="l34.71" class="difflineat">@@ -756,17 +758,17 @@</span>
<a href="#l34.72"></a><span id="l34.72">           // which will map the entries to attributes on the xul elements.</span>
<a href="#l34.73"></a><span id="l34.73">           if (aEntries) {</span>
<a href="#l34.74"></a><span id="l34.74">               // Remember the free/busy array which is used to find a</span>
<a href="#l34.75"></a><span id="l34.75">               // new time for an event. We store this array only if</span>
<a href="#l34.76"></a><span id="l34.76">               // the provider returned a valid array. In any other case</span>
<a href="#l34.77"></a><span id="l34.77">               // (temporarily clean the display) we keep the last know result.</span>
<a href="#l34.78"></a><span id="l34.78">               this.mEntries = aEntries;</span>
<a href="#l34.79"></a><span id="l34.79"> </span>
<a href="#l34.80"></a><span id="l34.80" class="difflineminus">-              let kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l34.81"></a><span id="l34.81" class="difflineplus">+              let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l34.82"></a><span id="l34.82"> </span>
<a href="#l34.83"></a><span id="l34.83">               let start = this.mStartDate.clone();</span>
<a href="#l34.84"></a><span id="l34.84">               start.hour = 0;</span>
<a href="#l34.85"></a><span id="l34.85">               start.minute = 0;</span>
<a href="#l34.86"></a><span id="l34.86">               start.second = 0;</span>
<a href="#l34.87"></a><span id="l34.87">               start.timezone = kDefaultTimezone;</span>
<a href="#l34.88"></a><span id="l34.88">               let end = start.clone();</span>
<a href="#l34.89"></a><span id="l34.89">               end.day += this.mRange;</span>
<a href="#l34.90"></a><span id="l34.90" class="difflineat">@@ -909,17 +911,17 @@</span>
<a href="#l34.91"></a><span id="l34.91">         &lt;parameter name=&quot;aEndTime&quot;/&gt;</span>
<a href="#l34.92"></a><span id="l34.92">         &lt;parameter name=&quot;allDay&quot;/&gt;</span>
<a href="#l34.93"></a><span id="l34.93">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l34.94"></a><span id="l34.94">           let newTime = aStartTime.clone();</span>
<a href="#l34.95"></a><span id="l34.95">           let duration = aEndTime.subtractDate(aStartTime);</span>
<a href="#l34.96"></a><span id="l34.96">           let newEndTime = newTime.clone();</span>
<a href="#l34.97"></a><span id="l34.97">           newEndTime.addDuration(duration);</span>
<a href="#l34.98"></a><span id="l34.98"> </span>
<a href="#l34.99"></a><span id="l34.99" class="difflineminus">-          let kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l34.100"></a><span id="l34.100" class="difflineplus">+          let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l34.101"></a><span id="l34.101"> </span>
<a href="#l34.102"></a><span id="l34.102">           if (this.mEntries) {</span>
<a href="#l34.103"></a><span id="l34.103">               for (let entry of this.mEntries) {</span>
<a href="#l34.104"></a><span id="l34.104">                   let rangeStart =</span>
<a href="#l34.105"></a><span id="l34.105">                       entry.interval.start.getInTimezone(kDefaultTimezone);</span>
<a href="#l34.106"></a><span id="l34.106">                   let rangeEnd =</span>
<a href="#l34.107"></a><span id="l34.107">                       entry.interval.end.getInTimezone(kDefaultTimezone);</span>
<a href="#l34.108"></a><span id="l34.108"> </span>
<a href="#l34.109"></a><span id="l34.109" class="difflineat">@@ -1069,16 +1071,17 @@</span>
<a href="#l34.110"></a><span id="l34.110">           let rowcount = listbox.getRowCount();</span>
<a href="#l34.111"></a><span id="l34.111">           listbox.scrollToIndex(Math.floor(rowcount * val));</span>
<a href="#l34.112"></a><span id="l34.112">           return val;</span>
<a href="#l34.113"></a><span id="l34.113">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l34.114"></a><span id="l34.114">       &lt;/property&gt;</span>
<a href="#l34.115"></a><span id="l34.115"> </span>
<a href="#l34.116"></a><span id="l34.116">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l34.117"></a><span id="l34.117">         Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l34.118"></a><span id="l34.118" class="difflineplus">+        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l34.119"></a><span id="l34.119"> </span>
<a href="#l34.120"></a><span id="l34.120">         this.initTimeRange();</span>
<a href="#l34.121"></a><span id="l34.121"> </span>
<a href="#l34.122"></a><span id="l34.122">         this.mRange = Number(this.getAttribute(&quot;range&quot;));</span>
<a href="#l34.123"></a><span id="l34.123"> </span>
<a href="#l34.124"></a><span id="l34.124">         this.mMaxFreeBusy = 0;</span>
<a href="#l34.125"></a><span id="l34.125">         this.mPendingRequests = [];</span>
<a href="#l34.126"></a><span id="l34.126"> </span>
<a href="#l34.127"></a><span id="l34.127" class="difflineat">@@ -1138,17 +1141,17 @@</span>
<a href="#l34.128"></a><span id="l34.128">       &lt;/method&gt;</span>
<a href="#l34.129"></a><span id="l34.129"> </span>
<a href="#l34.130"></a><span id="l34.130">       &lt;method name=&quot;onInitialize&quot;&gt;</span>
<a href="#l34.131"></a><span id="l34.131">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l34.132"></a><span id="l34.132">           let args = window.arguments[0];</span>
<a href="#l34.133"></a><span id="l34.133">           let startTime = args.startTime;</span>
<a href="#l34.134"></a><span id="l34.134">           let endTime = args.endTime;</span>
<a href="#l34.135"></a><span id="l34.135"> </span>
<a href="#l34.136"></a><span id="l34.136" class="difflineminus">-          let kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l34.137"></a><span id="l34.137" class="difflineplus">+          let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l34.138"></a><span id="l34.138">           this.startDate = startTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l34.139"></a><span id="l34.139">           this.endDate = endTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l34.140"></a><span id="l34.140"> </span>
<a href="#l34.141"></a><span id="l34.141">           let listbox =</span>
<a href="#l34.142"></a><span id="l34.142">               document.getAnonymousElementByAttribute(</span>
<a href="#l34.143"></a><span id="l34.143">                   this, &quot;anonid&quot;, &quot;listbox&quot;);</span>
<a href="#l34.144"></a><span id="l34.144">           let template =</span>
<a href="#l34.145"></a><span id="l34.145">               document.getAnonymousElementByAttribute(</span>
<a href="#l34.146"></a><span id="l34.146" class="difflineat">@@ -1259,17 +1262,17 @@</span>
<a href="#l34.147"></a><span id="l34.147"> </span>
<a href="#l34.148"></a><span id="l34.148">           this.updateFreeBusy();</span>
<a href="#l34.149"></a><span id="l34.149">         ]]&gt;&lt;/body&gt;</span>
<a href="#l34.150"></a><span id="l34.150">       &lt;/method&gt;</span>
<a href="#l34.151"></a><span id="l34.151"> </span>
<a href="#l34.152"></a><span id="l34.152">       &lt;!-- updateFreeBusy(), implementation of the core functionality of this binding --&gt;</span>
<a href="#l34.153"></a><span id="l34.153">       &lt;method name=&quot;updateFreeBusy&quot;&gt;</span>
<a href="#l34.154"></a><span id="l34.154">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l34.155"></a><span id="l34.155" class="difflineminus">-          let fbService = getFreeBusyService();</span>
<a href="#l34.156"></a><span id="l34.156" class="difflineplus">+          let fbService = cal.getFreeBusyService();</span>
<a href="#l34.157"></a><span id="l34.157">           for (let i = 1; i &lt;= this.mMaxFreeBusy; i++) {</span>
<a href="#l34.158"></a><span id="l34.158">               // Retrieve the string from the appropriate row</span>
<a href="#l34.159"></a><span id="l34.159">               let freebusy = this.getFreeBusyElement(i);</span>
<a href="#l34.160"></a><span id="l34.160">               if (freebusy.hasAttribute(&quot;dirty&quot;)) {</span>
<a href="#l34.161"></a><span id="l34.161">                   freebusy.removeAttribute(&quot;dirty&quot;);</span>
<a href="#l34.162"></a><span id="l34.162">                   let calid = freebusy.getAttribute(&quot;calid&quot;);</span>
<a href="#l34.163"></a><span id="l34.163">                   if (calid &amp;&amp; calid.length &gt; 0) {</span>
<a href="#l34.164"></a><span id="l34.164">                       // Define the datetime range we would like to ask for.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-recurrence-preview.xml</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -31,32 +31,34 @@</span>
<a href="#l35.4"></a><span id="l35.4">     &lt;/content&gt;</span>
<a href="#l35.5"></a><span id="l35.5"> </span>
<a href="#l35.6"></a><span id="l35.6">     &lt;implementation&gt;</span>
<a href="#l35.7"></a><span id="l35.7">       &lt;field name=&quot;mRecurrenceInfo&quot;&gt;null&lt;/field&gt;</span>
<a href="#l35.8"></a><span id="l35.8">       &lt;field name=&quot;mResizeHandler&quot;&gt;null&lt;/field&gt;</span>
<a href="#l35.9"></a><span id="l35.9">       &lt;field name=&quot;mDateTime&quot;&gt;null&lt;/field&gt;</span>
<a href="#l35.10"></a><span id="l35.10"> </span>
<a href="#l35.11"></a><span id="l35.11">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineplus">+        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineplus">+</span>
<a href="#l35.14"></a><span id="l35.14">         this.mResizeHandler = this.onResize.bind(this);</span>
<a href="#l35.15"></a><span id="l35.15">         window.addEventListener(&quot;resize&quot;, this.mResizeHandler, true);</span>
<a href="#l35.16"></a><span id="l35.16">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l35.17"></a><span id="l35.17"> </span>
<a href="#l35.18"></a><span id="l35.18">       &lt;destructor&gt;&lt;![CDATA[</span>
<a href="#l35.19"></a><span id="l35.19">         window.removeEventListener(&quot;resize&quot;, this.mResizeHandler, true);</span>
<a href="#l35.20"></a><span id="l35.20">       ]]&gt;&lt;/destructor&gt;</span>
<a href="#l35.21"></a><span id="l35.21"> </span>
<a href="#l35.22"></a><span id="l35.22">       &lt;property name=&quot;dateTime&quot;&gt;</span>
<a href="#l35.23"></a><span id="l35.23">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l35.24"></a><span id="l35.24">             this.mDateTime = val.clone();</span>
<a href="#l35.25"></a><span id="l35.25">             return this.mDateTime;</span>
<a href="#l35.26"></a><span id="l35.26">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l35.27"></a><span id="l35.27">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l35.28"></a><span id="l35.28">             if (this.mDateTime == null) {</span>
<a href="#l35.29"></a><span id="l35.29" class="difflineminus">-                this.mDateTime = now();</span>
<a href="#l35.30"></a><span id="l35.30" class="difflineplus">+                this.mDateTime = cal.now();</span>
<a href="#l35.31"></a><span id="l35.31">             }</span>
<a href="#l35.32"></a><span id="l35.32">             return this.mDateTime;</span>
<a href="#l35.33"></a><span id="l35.33">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l35.34"></a><span id="l35.34">       &lt;/property&gt;</span>
<a href="#l35.35"></a><span id="l35.35">       &lt;method name=&quot;onResize&quot;&gt;</span>
<a href="#l35.36"></a><span id="l35.36">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l35.37"></a><span id="l35.37">           let minimonth =</span>
<a href="#l35.38"></a><span id="l35.38">               document.getAnonymousElementByAttribute(</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-recurrence.js</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -23,17 +23,17 @@ function onLoad() {</span>
<a href="#l36.4"></a><span id="l36.4">     let args = window.arguments[0];</span>
<a href="#l36.5"></a><span id="l36.5">     let item = args.calendarEvent;</span>
<a href="#l36.6"></a><span id="l36.6">     let calendar = item.calendar;</span>
<a href="#l36.7"></a><span id="l36.7">     let recinfo = args.recurrenceInfo;</span>
<a href="#l36.8"></a><span id="l36.8"> </span>
<a href="#l36.9"></a><span id="l36.9">     gStartTime = args.startTime;</span>
<a href="#l36.10"></a><span id="l36.10">     gEndTime = args.endTime;</span>
<a href="#l36.11"></a><span id="l36.11">     let preview = document.getElementById(&quot;recurrence-preview&quot;);</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineminus">-    preview.dateTime = gStartTime.getInTimezone(calendarDefaultTimezone());</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineplus">+    preview.dateTime = gStartTime.getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l36.14"></a><span id="l36.14"> </span>
<a href="#l36.15"></a><span id="l36.15">     onChangeCalendar(calendar);</span>
<a href="#l36.16"></a><span id="l36.16"> </span>
<a href="#l36.17"></a><span id="l36.17">     // Set starting value for 'repeat until' rule and highlight the start date.</span>
<a href="#l36.18"></a><span id="l36.18">     let repeatDate = cal.dateTimeToJsDate(gStartTime.getInTimezone(cal.floating()));</span>
<a href="#l36.19"></a><span id="l36.19">     setElementValue(&quot;repeat-until-date&quot;, repeatDate);</span>
<a href="#l36.20"></a><span id="l36.20">     document.getElementById(&quot;repeat-until-date&quot;).extraDate = repeatDate;</span>
<a href="#l36.21"></a><span id="l36.21"> </span>
<a href="#l36.22"></a><span id="l36.22" class="difflineat">@@ -51,17 +51,17 @@ function onLoad() {</span>
<a href="#l36.23"></a><span id="l36.23">                 // We only handle 1 rule currently</span>
<a href="#l36.24"></a><span id="l36.24">                 rule = cal.wrapInstance(rules[0], Components.interfaces.calIRecurrenceRule);</span>
<a href="#l36.25"></a><span id="l36.25">             }</span>
<a href="#l36.26"></a><span id="l36.26">         } catch (ex) {</span>
<a href="#l36.27"></a><span id="l36.27">             Components.utils.reportError(ex);</span>
<a href="#l36.28"></a><span id="l36.28">         }</span>
<a href="#l36.29"></a><span id="l36.29">     }</span>
<a href="#l36.30"></a><span id="l36.30">     if (!rule) {</span>
<a href="#l36.31"></a><span id="l36.31" class="difflineminus">-        rule = createRecurrenceRule();</span>
<a href="#l36.32"></a><span id="l36.32" class="difflineplus">+        rule = cal.createRecurrenceRule();</span>
<a href="#l36.33"></a><span id="l36.33">         rule.type = &quot;DAILY&quot;;</span>
<a href="#l36.34"></a><span id="l36.34">         rule.interval = 1;</span>
<a href="#l36.35"></a><span id="l36.35">         rule.count = -1;</span>
<a href="#l36.36"></a><span id="l36.36">     }</span>
<a href="#l36.37"></a><span id="l36.37">     initializeControls(rule);</span>
<a href="#l36.38"></a><span id="l36.38"> </span>
<a href="#l36.39"></a><span id="l36.39">     // Update controls</span>
<a href="#l36.40"></a><span id="l36.40">     updateRecurrenceDeck();</span>
<a href="#l36.41"></a><span id="l36.41" class="difflineat">@@ -127,17 +127,17 @@ function initializeControls(rule) {</span>
<a href="#l36.42"></a><span id="l36.42">             document.getElementById(&quot;period-list&quot;).selectedIndex = 0;</span>
<a href="#l36.43"></a><span id="l36.43">             dump(&quot;unable to handle your rule type!\n&quot;);</span>
<a href="#l36.44"></a><span id="l36.44">             break;</span>
<a href="#l36.45"></a><span id="l36.45">     }</span>
<a href="#l36.46"></a><span id="l36.46"> </span>
<a href="#l36.47"></a><span id="l36.47">     let byDayRuleComponent = rule.getComponent(&quot;BYDAY&quot;, {});</span>
<a href="#l36.48"></a><span id="l36.48">     let byMonthDayRuleComponent = rule.getComponent(&quot;BYMONTHDAY&quot;, {});</span>
<a href="#l36.49"></a><span id="l36.49">     let byMonthRuleComponent = rule.getComponent(&quot;BYMONTH&quot;, {});</span>
<a href="#l36.50"></a><span id="l36.50" class="difflineminus">-    let kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l36.51"></a><span id="l36.51" class="difflineplus">+    let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l36.52"></a><span id="l36.52">     let startDate = gStartTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l36.53"></a><span id="l36.53"> </span>
<a href="#l36.54"></a><span id="l36.54">     // &quot;DAILY&quot; ruletype</span>
<a href="#l36.55"></a><span id="l36.55">     // byDayRuleComponents may have been set priorily by &quot;MONTHLY&quot;- ruletypes</span>
<a href="#l36.56"></a><span id="l36.56">     // where they have a different context-</span>
<a href="#l36.57"></a><span id="l36.57">     // that's why we also query the current rule-type</span>
<a href="#l36.58"></a><span id="l36.58">     if (byDayRuleComponent.length == 0 || rule.type != &quot;DAILY&quot;) {</span>
<a href="#l36.59"></a><span id="l36.59">         document.getElementById(&quot;daily-group&quot;).selectedIndex = 0;</span>
<a href="#l36.60"></a><span id="l36.60" class="difflineat">@@ -271,20 +271,20 @@ function onSave(item) {</span>
<a href="#l36.61"></a><span id="l36.61">     if (recurrenceInfo) {</span>
<a href="#l36.62"></a><span id="l36.62">         recurrenceInfo = recurrenceInfo.clone();</span>
<a href="#l36.63"></a><span id="l36.63">         let rrules = splitRecurrenceRules(recurrenceInfo);</span>
<a href="#l36.64"></a><span id="l36.64">         if (rrules[0].length &gt; 0) {</span>
<a href="#l36.65"></a><span id="l36.65">             recurrenceInfo.deleteRecurrenceItem(rrules[0][0]);</span>
<a href="#l36.66"></a><span id="l36.66">         }</span>
<a href="#l36.67"></a><span id="l36.67">         recurrenceInfo.item = item;</span>
<a href="#l36.68"></a><span id="l36.68">     } else {</span>
<a href="#l36.69"></a><span id="l36.69" class="difflineminus">-        recurrenceInfo = createRecurrenceInfo(item);</span>
<a href="#l36.70"></a><span id="l36.70" class="difflineplus">+        recurrenceInfo = cal.createRecurrenceInfo(item);</span>
<a href="#l36.71"></a><span id="l36.71">     }</span>
<a href="#l36.72"></a><span id="l36.72"> </span>
<a href="#l36.73"></a><span id="l36.73" class="difflineminus">-    let recRule = createRecurrenceRule();</span>
<a href="#l36.74"></a><span id="l36.74" class="difflineplus">+    let recRule = cal.createRecurrenceRule();</span>
<a href="#l36.75"></a><span id="l36.75">     const ALL_WEEKDAYS = [2, 3, 4, 5, 6, 7, 1]; // The sequence MO,TU,WE,TH,FR,SA,SU.</span>
<a href="#l36.76"></a><span id="l36.76">     switch (deckNumber) {</span>
<a href="#l36.77"></a><span id="l36.77">         case 0: {</span>
<a href="#l36.78"></a><span id="l36.78">             recRule.type = &quot;DAILY&quot;;</span>
<a href="#l36.79"></a><span id="l36.79">             let dailyGroup = document.getElementById(&quot;daily-group&quot;);</span>
<a href="#l36.80"></a><span id="l36.80">             if (dailyGroup.selectedIndex == 0) {</span>
<a href="#l36.81"></a><span id="l36.81">                 let ndays = Math.max(1, Number(getElementValue(&quot;daily-days&quot;)));</span>
<a href="#l36.82"></a><span id="l36.82">                 recRule.interval = ndays;</span>
<a href="#l36.83"></a><span id="l36.83" class="difflineat">@@ -463,17 +463,17 @@ function onChangeCalendar(calendar) {</span>
<a href="#l36.84"></a><span id="l36.84">  *</span>
<a href="#l36.85"></a><span id="l36.85">  * @param item        The item to check.</span>
<a href="#l36.86"></a><span id="l36.86">  */</span>
<a href="#l36.87"></a><span id="l36.87"> function disableOrEnable(item) {</span>
<a href="#l36.88"></a><span id="l36.88">     if (item.parentItem != item) {</span>
<a href="#l36.89"></a><span id="l36.89">         disableRecurrenceFields(&quot;disable-on-occurrence&quot;);</span>
<a href="#l36.90"></a><span id="l36.90">     } else if (gIsReadOnly) {</span>
<a href="#l36.91"></a><span id="l36.91">         disableRecurrenceFields(&quot;disable-on-readonly&quot;);</span>
<a href="#l36.92"></a><span id="l36.92" class="difflineminus">-    } else if (isToDo(item) &amp;&amp; !gStartTime) {</span>
<a href="#l36.93"></a><span id="l36.93" class="difflineplus">+    } else if (cal.isToDo(item) &amp;&amp; !gStartTime) {</span>
<a href="#l36.94"></a><span id="l36.94">         disableRecurrenceFields(&quot;disable-on-readonly&quot;);</span>
<a href="#l36.95"></a><span id="l36.95">     } else {</span>
<a href="#l36.96"></a><span id="l36.96">         enableRecurrenceFields(&quot;disable-on-readonly&quot;);</span>
<a href="#l36.97"></a><span id="l36.97">     }</span>
<a href="#l36.98"></a><span id="l36.98"> }</span>
<a href="#l36.99"></a><span id="l36.99"> </span>
<a href="#l36.100"></a><span id="l36.100"> /**</span>
<a href="#l36.101"></a><span id="l36.101">  * Disables all fields that have an attribute that matches the argument and is</span>
<a href="#l36.102"></a><span id="l36.102" class="difflineat">@@ -590,28 +590,28 @@ function updatePreview() {</span>
<a href="#l36.103"></a><span id="l36.103">         item = item.parentItem;</span>
<a href="#l36.104"></a><span id="l36.104">     }</span>
<a href="#l36.105"></a><span id="l36.105"> </span>
<a href="#l36.106"></a><span id="l36.106">     // TODO: We should better start the whole dialog with a newly cloned item</span>
<a href="#l36.107"></a><span id="l36.107">     // and always pump changes immediately into it. This would eliminate the</span>
<a href="#l36.108"></a><span id="l36.108">     // need to break the encapsulation, as we do it here. But we need the item</span>
<a href="#l36.109"></a><span id="l36.109">     // to contain the startdate in order to calculate the recurrence preview.</span>
<a href="#l36.110"></a><span id="l36.110">     item = item.clone();</span>
<a href="#l36.111"></a><span id="l36.111" class="difflineminus">-    let kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l36.112"></a><span id="l36.112" class="difflineminus">-    if (isEvent(item)) {</span>
<a href="#l36.113"></a><span id="l36.113" class="difflineplus">+    let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l36.114"></a><span id="l36.114" class="difflineplus">+    if (cal.isEvent(item)) {</span>
<a href="#l36.115"></a><span id="l36.115">         let startDate = gStartTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l36.116"></a><span id="l36.116">         let endDate = gEndTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l36.117"></a><span id="l36.117">         if (startDate.isDate) {</span>
<a href="#l36.118"></a><span id="l36.118">             endDate.day--;</span>
<a href="#l36.119"></a><span id="l36.119">         }</span>
<a href="#l36.120"></a><span id="l36.120"> </span>
<a href="#l36.121"></a><span id="l36.121">         item.startDate = startDate;</span>
<a href="#l36.122"></a><span id="l36.122">         item.endDate = endDate;</span>
<a href="#l36.123"></a><span id="l36.123">     }</span>
<a href="#l36.124"></a><span id="l36.124" class="difflineminus">-    if (isToDo(item)) {</span>
<a href="#l36.125"></a><span id="l36.125" class="difflineplus">+    if (cal.isToDo(item)) {</span>
<a href="#l36.126"></a><span id="l36.126">         let entryDate = gStartTime;</span>
<a href="#l36.127"></a><span id="l36.127">         if (entryDate) {</span>
<a href="#l36.128"></a><span id="l36.128">             entryDate = entryDate.getInTimezone(kDefaultTimezone);</span>
<a href="#l36.129"></a><span id="l36.129">         } else {</span>
<a href="#l36.130"></a><span id="l36.130">             item.recurrenceInfo = null;</span>
<a href="#l36.131"></a><span id="l36.131">         }</span>
<a href="#l36.132"></a><span id="l36.132">         item.entryDate = entryDate;</span>
<a href="#l36.133"></a><span id="l36.133">         let dueDate = gEndTime;</span>
<a href="#l36.134"></a><span id="l36.134" class="difflineat">@@ -756,19 +756,19 @@ function changeOrderForElements(aPropKey</span>
<a href="#l36.135"></a><span id="l36.135"> </span>
<a href="#l36.136"></a><span id="l36.136">     for (let key in aPropParams) {</span>
<a href="#l36.137"></a><span id="l36.137">         // Save original parents so that the nodes to reorder get appended to</span>
<a href="#l36.138"></a><span id="l36.138">         // the correct parent nodes.</span>
<a href="#l36.139"></a><span id="l36.139">         parents[key] = document.getElementById(aPropParams[key]).parentNode;</span>
<a href="#l36.140"></a><span id="l36.140">     }</span>
<a href="#l36.141"></a><span id="l36.141"> </span>
<a href="#l36.142"></a><span id="l36.142">     try {</span>
<a href="#l36.143"></a><span id="l36.143" class="difflineminus">-        localeOrder = calGetString(&quot;calendar-event-dialog&quot;,</span>
<a href="#l36.144"></a><span id="l36.144" class="difflineminus">-                                   aPropKey,</span>
<a href="#l36.145"></a><span id="l36.145" class="difflineminus">-                                   aPropParams);</span>
<a href="#l36.146"></a><span id="l36.146" class="difflineplus">+        localeOrder = cal.calGetString(&quot;calendar-event-dialog&quot;,</span>
<a href="#l36.147"></a><span id="l36.147" class="difflineplus">+                                       aPropKey,</span>
<a href="#l36.148"></a><span id="l36.148" class="difflineplus">+                                       aPropParams);</span>
<a href="#l36.149"></a><span id="l36.149"> </span>
<a href="#l36.150"></a><span id="l36.150">         localeOrder = localeOrder.split(&quot; &quot;);</span>
<a href="#l36.151"></a><span id="l36.151">     } catch (ex) {</span>
<a href="#l36.152"></a><span id="l36.152">         let msg = &quot;The key &quot; + aPropKey + &quot; in calendar-event-dialog.prop&quot; +</span>
<a href="#l36.153"></a><span id="l36.153">                   &quot;erties has incorrect number of params. Expected &quot; +</span>
<a href="#l36.154"></a><span id="l36.154">                   aPropParams.length + &quot; params.&quot;;</span>
<a href="#l36.155"></a><span id="l36.155">         Components.utils.reportError(msg + &quot; &quot; + ex);</span>
<a href="#l36.156"></a><span id="l36.156">         return;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-recurrence.xul</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-recurrence.xul</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -21,17 +21,16 @@</span>
<a href="#l37.4"></a><span id="l37.4">         ondialogcancel=&quot;return onCancel();&quot;</span>
<a href="#l37.5"></a><span id="l37.5">         persist=&quot;screenX screenY width height&quot;</span>
<a href="#l37.6"></a><span id="l37.6">         xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;&gt;</span>
<a href="#l37.7"></a><span id="l37.7"> </span>
<a href="#l37.8"></a><span id="l37.8">   &lt;!-- Javascript includes --&gt;</span>
<a href="#l37.9"></a><span id="l37.9">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calendar-event-dialog-recurrence.js&quot;/&gt;</span>
<a href="#l37.10"></a><span id="l37.10">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calendar-dialog-utils.js&quot;/&gt;</span>
<a href="#l37.11"></a><span id="l37.11">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calendar-ui-utils.js&quot;/&gt;</span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-  &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calUtils.js&quot;/&gt;</span>
<a href="#l37.13"></a><span id="l37.13">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calendar-statusbar.js&quot;/&gt;</span>
<a href="#l37.14"></a><span id="l37.14"> </span>
<a href="#l37.15"></a><span id="l37.15">   &lt;!-- recurrence pattern --&gt;</span>
<a href="#l37.16"></a><span id="l37.16">   &lt;groupbox id=&quot;recurrence-pattern-groupbox&quot;&gt;</span>
<a href="#l37.17"></a><span id="l37.17">     &lt;caption id=&quot;recurrence-pattern-caption&quot;</span>
<a href="#l37.18"></a><span id="l37.18">              label=&quot;&amp;event.recurrence.pattern.label;&quot;/&gt;</span>
<a href="#l37.19"></a><span id="l37.19">     &lt;grid id=&quot;recurrence-pattern-grid&quot;&gt;</span>
<a href="#l37.20"></a><span id="l37.20">       &lt;columns id=&quot;recurrence-pattern-columns&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-reminder.js</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-reminder.js</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -90,17 +90,17 @@ function loadReminders() {</span>
<a href="#l38.4"></a><span id="l38.4">             // action is actually supported by the calendar.</span>
<a href="#l38.5"></a><span id="l38.5">             listbox.appendChild(setupListItem(null, reminders[i].clone(), args.item));</span>
<a href="#l38.6"></a><span id="l38.6">         }</span>
<a href="#l38.7"></a><span id="l38.7">     }</span>
<a href="#l38.8"></a><span id="l38.8"> </span>
<a href="#l38.9"></a><span id="l38.9">     // Set up a default absolute date. This will be overridden if the selected</span>
<a href="#l38.10"></a><span id="l38.10">     // alarm is absolute.</span>
<a href="#l38.11"></a><span id="l38.11">     let absDate = document.getElementById(&quot;reminder-absolute-date&quot;);</span>
<a href="#l38.12"></a><span id="l38.12" class="difflineminus">-    absDate.value = cal.dateTimeToJsDate(getDefaultStartDate());</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineplus">+    absDate.value = cal.dateTimeToJsDate(cal.getDefaultStartDate());</span>
<a href="#l38.14"></a><span id="l38.14"> </span>
<a href="#l38.15"></a><span id="l38.15">     if (listbox.childNodes.length) {</span>
<a href="#l38.16"></a><span id="l38.16">         // We have reminders, select the first by default. For some reason,</span>
<a href="#l38.17"></a><span id="l38.17">         // setting the selected index in a load handler makes the selection</span>
<a href="#l38.18"></a><span id="l38.18">         // break for the set item, therefore we need a setTimeout.</span>
<a href="#l38.19"></a><span id="l38.19">         setupMaxReminders();</span>
<a href="#l38.20"></a><span id="l38.20">         setTimeout(() =&gt; { listbox.selectedIndex = 0; }, 0);</span>
<a href="#l38.21"></a><span id="l38.21">     } else {</span>
<a href="#l38.22"></a><span id="l38.22" class="difflineat">@@ -166,19 +166,19 @@ function setupMaxReminders() {</span>
<a href="#l38.23"></a><span id="l38.23"> </span>
<a href="#l38.24"></a><span id="l38.24">     // If we hit the maximum number of reminders, show the error box and</span>
<a href="#l38.25"></a><span id="l38.25">     // disable the new button.</span>
<a href="#l38.26"></a><span id="l38.26">     setElementValue(&quot;reminder-new-button&quot;, cond &amp;&amp; &quot;true&quot;, &quot;disabled&quot;);</span>
<a href="#l38.27"></a><span id="l38.27"> </span>
<a href="#l38.28"></a><span id="l38.28">     if (!setupMaxReminders.notification) {</span>
<a href="#l38.29"></a><span id="l38.29">         let notification = createXULElement(&quot;notification&quot;);</span>
<a href="#l38.30"></a><span id="l38.30">         let localeErrorString =</span>
<a href="#l38.31"></a><span id="l38.31" class="difflineminus">-            calGetString(&quot;calendar-alarms&quot;,</span>
<a href="#l38.32"></a><span id="l38.32" class="difflineminus">-                         getItemBundleStringName(&quot;reminderErrorMaxCountReached&quot;),</span>
<a href="#l38.33"></a><span id="l38.33" class="difflineminus">-                         [maxReminders]);</span>
<a href="#l38.34"></a><span id="l38.34" class="difflineplus">+            cal.calGetString(&quot;calendar-alarms&quot;,</span>
<a href="#l38.35"></a><span id="l38.35" class="difflineplus">+                             getItemBundleStringName(&quot;reminderErrorMaxCountReached&quot;),</span>
<a href="#l38.36"></a><span id="l38.36" class="difflineplus">+                             [maxReminders]);</span>
<a href="#l38.37"></a><span id="l38.37">         let pluralErrorLabel = PluralForm.get(maxReminders, localeErrorString)</span>
<a href="#l38.38"></a><span id="l38.38">                                          .replace(&quot;#1&quot;, maxReminders);</span>
<a href="#l38.39"></a><span id="l38.39"> </span>
<a href="#l38.40"></a><span id="l38.40">         notification.setAttribute(&quot;label&quot;, pluralErrorLabel);</span>
<a href="#l38.41"></a><span id="l38.41">         notification.setAttribute(&quot;type&quot;, &quot;warning&quot;);</span>
<a href="#l38.42"></a><span id="l38.42">         notification.setAttribute(&quot;hideclose&quot;, &quot;true&quot;);</span>
<a href="#l38.43"></a><span id="l38.43">         setupMaxReminders.notification = notification;</span>
<a href="#l38.44"></a><span id="l38.44">     }</span>
<a href="#l38.45"></a><span id="l38.45" class="difflineat">@@ -348,29 +348,29 @@ function updateReminder(event) {</span>
<a href="#l38.46"></a><span id="l38.46"> /**</span>
<a href="#l38.47"></a><span id="l38.47">  * Gets the locale stringname that is dependant on the item type. This function</span>
<a href="#l38.48"></a><span id="l38.48">  * appends the item type, i.e |aPrefix + &quot;Event&quot;|.</span>
<a href="#l38.49"></a><span id="l38.49">  *</span>
<a href="#l38.50"></a><span id="l38.50">  * @param aPrefix       The prefix to prepend to the item type</span>
<a href="#l38.51"></a><span id="l38.51">  * @return              The full string name.</span>
<a href="#l38.52"></a><span id="l38.52">  */</span>
<a href="#l38.53"></a><span id="l38.53"> function getItemBundleStringName(aPrefix) {</span>
<a href="#l38.54"></a><span id="l38.54" class="difflineminus">-    if (isEvent(window.arguments[0].item)) {</span>
<a href="#l38.55"></a><span id="l38.55" class="difflineplus">+    if (cal.isEvent(window.arguments[0].item)) {</span>
<a href="#l38.56"></a><span id="l38.56">         return aPrefix + &quot;Event&quot;;</span>
<a href="#l38.57"></a><span id="l38.57">     } else {</span>
<a href="#l38.58"></a><span id="l38.58">         return aPrefix + &quot;Task&quot;;</span>
<a href="#l38.59"></a><span id="l38.59">     }</span>
<a href="#l38.60"></a><span id="l38.60"> }</span>
<a href="#l38.61"></a><span id="l38.61"> </span>
<a href="#l38.62"></a><span id="l38.62"> /**</span>
<a href="#l38.63"></a><span id="l38.63">  * Handler function to be called when the &quot;new&quot; button is pressed, to create a</span>
<a href="#l38.64"></a><span id="l38.64">  * new reminder item.</span>
<a href="#l38.65"></a><span id="l38.65">  */</span>
<a href="#l38.66"></a><span id="l38.66"> function onNewReminder() {</span>
<a href="#l38.67"></a><span id="l38.67" class="difflineminus">-    let itemType = (isEvent(window.arguments[0].item) ? &quot;event&quot; : &quot;todo&quot;);</span>
<a href="#l38.68"></a><span id="l38.68" class="difflineplus">+    let itemType = (cal.isEvent(window.arguments[0].item) ? &quot;event&quot; : &quot;todo&quot;);</span>
<a href="#l38.69"></a><span id="l38.69">     let listbox = document.getElementById(&quot;reminder-listbox&quot;);</span>
<a href="#l38.70"></a><span id="l38.70"> </span>
<a href="#l38.71"></a><span id="l38.71">     let reminder = cal.createAlarm();</span>
<a href="#l38.72"></a><span id="l38.72">     let alarmlen = Preferences.get(&quot;calendar.alarms.&quot; + itemType + &quot;alarmlen&quot;, 15);</span>
<a href="#l38.73"></a><span id="l38.73"> </span>
<a href="#l38.74"></a><span id="l38.74">     // Default is a relative DISPLAY alarm, |alarmlen| minutes before the event.</span>
<a href="#l38.75"></a><span id="l38.75">     // If DISPLAY is not supported by the provider, then pick the provider's</span>
<a href="#l38.76"></a><span id="l38.76">     // first alarm type.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-reminder.xul</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-reminder.xul</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -18,17 +18,16 @@</span>
<a href="#l39.4"></a><span id="l39.4">         ondialogaccept=&quot;return onAccept();&quot;</span>
<a href="#l39.5"></a><span id="l39.5">         ondialogcancel=&quot;return onCancel();&quot;</span>
<a href="#l39.6"></a><span id="l39.6">         persist=&quot;screenX screenY width height&quot;</span>
<a href="#l39.7"></a><span id="l39.7">         xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;&gt;</span>
<a href="#l39.8"></a><span id="l39.8"> </span>
<a href="#l39.9"></a><span id="l39.9">   &lt;!-- Javascript includes --&gt;</span>
<a href="#l39.10"></a><span id="l39.10">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calendar-event-dialog-reminder.js&quot;/&gt;</span>
<a href="#l39.11"></a><span id="l39.11">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calendar-ui-utils.js&quot;/&gt;</span>
<a href="#l39.12"></a><span id="l39.12" class="difflineminus">-  &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calUtils.js&quot;/&gt;</span>
<a href="#l39.13"></a><span id="l39.13"> </span>
<a href="#l39.14"></a><span id="l39.14">   &lt;notificationbox id=&quot;reminder-notifications&quot;/&gt;</span>
<a href="#l39.15"></a><span id="l39.15"> </span>
<a href="#l39.16"></a><span id="l39.16">   &lt;!-- Listbox with custom reminders --&gt;</span>
<a href="#l39.17"></a><span id="l39.17">   &lt;vbox flex=&quot;1&quot;&gt;</span>
<a href="#l39.18"></a><span id="l39.18">     &lt;listbox id=&quot;reminder-listbox&quot;</span>
<a href="#l39.19"></a><span id="l39.19">              seltype=&quot;single&quot;</span>
<a href="#l39.20"></a><span id="l39.20">              class=&quot;event-dialog-listbox&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-timezone.js</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-timezone.js</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -19,20 +19,20 @@ function onLoad() {</span>
<a href="#l40.4"></a><span id="l40.4">                      cal.getTimezoneService();</span>
<a href="#l40.5"></a><span id="l40.5">     window.tzProvider = tzProvider;</span>
<a href="#l40.6"></a><span id="l40.6"> </span>
<a href="#l40.7"></a><span id="l40.7">     let menulist = document.getElementById(&quot;timezone-menulist&quot;);</span>
<a href="#l40.8"></a><span id="l40.8">     let tzMenuPopup = document.getElementById(&quot;timezone-menupopup&quot;);</span>
<a href="#l40.9"></a><span id="l40.9"> </span>
<a href="#l40.10"></a><span id="l40.10">     // floating and UTC (if supported) at the top:</span>
<a href="#l40.11"></a><span id="l40.11">     if (args.calendar.getProperty(&quot;capabilities.timezones.floating.supported&quot;) !== false) {</span>
<a href="#l40.12"></a><span id="l40.12" class="difflineminus">-        addMenuItem(tzMenuPopup, floating().displayName, floating().tzid);</span>
<a href="#l40.13"></a><span id="l40.13" class="difflineplus">+        addMenuItem(tzMenuPopup, cal.floating().displayName, cal.floating().tzid);</span>
<a href="#l40.14"></a><span id="l40.14">     }</span>
<a href="#l40.15"></a><span id="l40.15">     if (args.calendar.getProperty(&quot;capabilities.timezones.UTC.supported&quot;) !== false) {</span>
<a href="#l40.16"></a><span id="l40.16" class="difflineminus">-        addMenuItem(tzMenuPopup, UTC().displayName, UTC().tzid);</span>
<a href="#l40.17"></a><span id="l40.17" class="difflineplus">+        addMenuItem(tzMenuPopup, cal.UTC().displayName, cal.UTC().tzid);</span>
<a href="#l40.18"></a><span id="l40.18">     }</span>
<a href="#l40.19"></a><span id="l40.19"> </span>
<a href="#l40.20"></a><span id="l40.20">     let enumerator = tzProvider.timezoneIds;</span>
<a href="#l40.21"></a><span id="l40.21">     let tzids = {};</span>
<a href="#l40.22"></a><span id="l40.22">     let displayNames = [];</span>
<a href="#l40.23"></a><span id="l40.23">     while (enumerator.hasMore()) {</span>
<a href="#l40.24"></a><span id="l40.24">         let timezone = tzProvider.getTimezone(enumerator.getNext());</span>
<a href="#l40.25"></a><span id="l40.25">         if (timezone &amp;&amp; !timezone.isFloating &amp;&amp; !timezone.isUTC) {</span>
<a href="#l40.26"></a><span id="l40.26" class="difflineat">@@ -45,17 +45,17 @@ function onLoad() {</span>
<a href="#l40.27"></a><span id="l40.27">     displayNames.sort((a, b) =&gt; a.localeCompare(b));</span>
<a href="#l40.28"></a><span id="l40.28">     for (let i = 0; i &lt; displayNames.length; ++i) {</span>
<a href="#l40.29"></a><span id="l40.29">         let displayName = displayNames[i];</span>
<a href="#l40.30"></a><span id="l40.30">         addMenuItem(tzMenuPopup, displayName, tzids[displayName]);</span>
<a href="#l40.31"></a><span id="l40.31">     }</span>
<a href="#l40.32"></a><span id="l40.32"> </span>
<a href="#l40.33"></a><span id="l40.33">     let index = findTimezone(window.time.timezone);</span>
<a href="#l40.34"></a><span id="l40.34">     if (index &lt; 0) {</span>
<a href="#l40.35"></a><span id="l40.35" class="difflineminus">-        index = findTimezone(calendarDefaultTimezone());</span>
<a href="#l40.36"></a><span id="l40.36" class="difflineplus">+        index = findTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l40.37"></a><span id="l40.37">         if (index &lt; 0) {</span>
<a href="#l40.38"></a><span id="l40.38">             index = 0;</span>
<a href="#l40.39"></a><span id="l40.39">         }</span>
<a href="#l40.40"></a><span id="l40.40">     }</span>
<a href="#l40.41"></a><span id="l40.41"> </span>
<a href="#l40.42"></a><span id="l40.42">     menulist = document.getElementById(&quot;timezone-menulist&quot;);</span>
<a href="#l40.43"></a><span id="l40.43">     menulist.selectedIndex = index;</span>
<a href="#l40.44"></a><span id="l40.44"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-timezone.xul</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-timezone.xul</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -23,17 +23,16 @@</span>
<a href="#l41.4"></a><span id="l41.4">         ondialogcancel=&quot;return onCancel();&quot;</span>
<a href="#l41.5"></a><span id="l41.5">         persist=&quot;screenX screenY width height&quot;</span>
<a href="#l41.6"></a><span id="l41.6">         xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;&gt;</span>
<a href="#l41.7"></a><span id="l41.7"> </span>
<a href="#l41.8"></a><span id="l41.8">   &lt;!-- Javascript includes --&gt;</span>
<a href="#l41.9"></a><span id="l41.9">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calendar-event-dialog-timezone.js&quot;/&gt;</span>
<a href="#l41.10"></a><span id="l41.10">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calendar-dialog-utils.js&quot;/&gt;</span>
<a href="#l41.11"></a><span id="l41.11">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calendar-ui-utils.js&quot;/&gt;</span>
<a href="#l41.12"></a><span id="l41.12" class="difflineminus">-  &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calUtils.js&quot;/&gt;</span>
<a href="#l41.13"></a><span id="l41.13"> </span>
<a href="#l41.14"></a><span id="l41.14">   &lt;hbox align=&quot;center&quot;&gt;</span>
<a href="#l41.15"></a><span id="l41.15">     &lt;spacer flex=&quot;1&quot;/&gt;</span>
<a href="#l41.16"></a><span id="l41.16">     &lt;datetimepicker id=&quot;timezone-time&quot; disabled=&quot;true&quot;/&gt;</span>
<a href="#l41.17"></a><span id="l41.17">   &lt;/hbox&gt;</span>
<a href="#l41.18"></a><span id="l41.18"> </span>
<a href="#l41.19"></a><span id="l41.19">   &lt;menulist id=&quot;timezone-menulist&quot; oncommand=&quot;updateTimezone()&quot;&gt;</span>
<a href="#l41.20"></a><span id="l41.20">     &lt;menupopup id=&quot;timezone-menupopup&quot; style=&quot;height: 460px;&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog.xul</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog.xul</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineat">@@ -92,17 +92,17 @@</span>
<a href="#l42.4"></a><span id="l42.4">              oncommand=&quot;onCommandSave()&quot;/&gt;</span>
<a href="#l42.5"></a><span id="l42.5">     &lt;command id=&quot;cmd_item_delete&quot;</span>
<a href="#l42.6"></a><span id="l42.6">              disable-on-readonly=&quot;true&quot;</span>
<a href="#l42.7"></a><span id="l42.7">              oncommand=&quot;onCommandDeleteItem()&quot;/&gt;</span>
<a href="#l42.8"></a><span id="l42.8">     &lt;command id=&quot;cmd_printSetup&quot;</span>
<a href="#l42.9"></a><span id="l42.9">              oncommand=&quot;PrintUtils.showPageSetup()&quot;/&gt;</span>
<a href="#l42.10"></a><span id="l42.10">     &lt;command id=&quot;cmd_print&quot;</span>
<a href="#l42.11"></a><span id="l42.11">              disabled=&quot;true&quot;</span>
<a href="#l42.12"></a><span id="l42.12" class="difflineminus">-             oncommand=&quot;calPrint()&quot;/&gt;</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineplus">+             oncommand=&quot;cal.calPrint(window)&quot;/&gt;</span>
<a href="#l42.14"></a><span id="l42.14"> </span>
<a href="#l42.15"></a><span id="l42.15">     &lt;!-- Edit menu --&gt;</span>
<a href="#l42.16"></a><span id="l42.16">     &lt;command id=&quot;cmd_undo&quot;</span>
<a href="#l42.17"></a><span id="l42.17">              disabled=&quot;true&quot;</span>
<a href="#l42.18"></a><span id="l42.18">              oncommand=&quot;goDoCommand('cmd_undo')&quot;/&gt;</span>
<a href="#l42.19"></a><span id="l42.19">     &lt;command id=&quot;cmd_redo&quot;</span>
<a href="#l42.20"></a><span id="l42.20">              disabled=&quot;true&quot;</span>
<a href="#l42.21"></a><span id="l42.21">              oncommand=&quot;goDoCommand('cmd_redo')&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-invitations-dialog.xul</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-invitations-dialog.xul</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineat">@@ -20,17 +20,16 @@</span>
<a href="#l43.4"></a><span id="l43.4">   ondialogcancel=&quot;return onCancel();&quot;</span>
<a href="#l43.5"></a><span id="l43.5">   onload=&quot;return onLoad();&quot;</span>
<a href="#l43.6"></a><span id="l43.6">   onunload=&quot;return onUnload();&quot;</span>
<a href="#l43.7"></a><span id="l43.7">   persist=&quot;screenX screenY width height&quot;</span>
<a href="#l43.8"></a><span id="l43.8">   xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;&gt;</span>
<a href="#l43.9"></a><span id="l43.9"> </span>
<a href="#l43.10"></a><span id="l43.10">   &lt;!-- Javascript includes --&gt;</span>
<a href="#l43.11"></a><span id="l43.11">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calendar-invitations-dialog.js&quot;/&gt;</span>
<a href="#l43.12"></a><span id="l43.12" class="difflineminus">-  &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calUtils.js&quot;/&gt;</span>
<a href="#l43.13"></a><span id="l43.13">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calendar-ui-utils.js&quot;/&gt;</span>
<a href="#l43.14"></a><span id="l43.14"> </span>
<a href="#l43.15"></a><span id="l43.15">   &lt;script type=&quot;application/javascript&quot; &gt;</span>
<a href="#l43.16"></a><span id="l43.16">     var invitationsText = &quot;&amp;calendar.invitations.dialog.invitations.text;&quot;;</span>
<a href="#l43.17"></a><span id="l43.17">   &lt;/script&gt;</span>
<a href="#l43.18"></a><span id="l43.18"> </span>
<a href="#l43.19"></a><span id="l43.19">   &lt;vbox id=&quot;dialog-box&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l43.20"></a><span id="l43.20">     &lt;stack flex=&quot;1&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-invitations-list.xml</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-invitations-list.xml</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineat">@@ -114,17 +114,17 @@</span>
<a href="#l44.4"></a><span id="l44.4">           icon.setAttribute(&quot;status&quot;, val);</span>
<a href="#l44.5"></a><span id="l44.5">           return val;</span>
<a href="#l44.6"></a><span id="l44.6">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l44.7"></a><span id="l44.7">       &lt;/property&gt;</span>
<a href="#l44.8"></a><span id="l44.8"> </span>
<a href="#l44.9"></a><span id="l44.9">       &lt;!-- constructor --&gt;</span>
<a href="#l44.10"></a><span id="l44.10">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l44.11"></a><span id="l44.11">         Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l44.12"></a><span id="l44.12" class="difflineminus">-        this.mDateFormatter = getDateFormatter();</span>
<a href="#l44.13"></a><span id="l44.13" class="difflineplus">+        this.mDateFormatter = cal.getDateFormatter();</span>
<a href="#l44.14"></a><span id="l44.14">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l44.15"></a><span id="l44.15"> </span>
<a href="#l44.16"></a><span id="l44.16">       &lt;!-- methods --&gt;</span>
<a href="#l44.17"></a><span id="l44.17">       &lt;method name=&quot;setCalendarItem&quot;&gt;</span>
<a href="#l44.18"></a><span id="l44.18">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l44.19"></a><span id="l44.19">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l44.20"></a><span id="l44.20">           this.mCalendarItem = aItem;</span>
<a href="#l44.21"></a><span id="l44.21">           this.mInitialParticipationStatus =</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-migration-dialog.js</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-migration-dialog.js</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineat">@@ -243,17 +243,17 @@ var gDataMigrator = {</span>
<a href="#l45.4"></a><span id="l45.4">             };</span>
<a href="#l45.5"></a><span id="l45.5">             req.send(null);</span>
<a href="#l45.6"></a><span id="l45.6">         }</span>
<a href="#l45.7"></a><span id="l45.7"> </span>
<a href="#l45.8"></a><span id="l45.8">         // Callback from the XHR above.  Parses CalendarManager.rdf and imports</span>
<a href="#l45.9"></a><span id="l45.9">         // the data describe therein.</span>
<a href="#l45.10"></a><span id="l45.10">         function parseAndMigrate(aDoc, aCallback) {</span>
<a href="#l45.11"></a><span id="l45.11">             // For duplicate detection</span>
<a href="#l45.12"></a><span id="l45.12" class="difflineminus">-            var calManager = getCalendarManager();</span>
<a href="#l45.13"></a><span id="l45.13" class="difflineplus">+            var calManager = cal.getCalendarManager();</span>
<a href="#l45.14"></a><span id="l45.14">             var uris = [];</span>
<a href="#l45.15"></a><span id="l45.15">             for (var oldCal of calManager.getCalendars({})) {</span>
<a href="#l45.16"></a><span id="l45.16">                 uris.push(oldCal.uri);</span>
<a href="#l45.17"></a><span id="l45.17">             }</span>
<a href="#l45.18"></a><span id="l45.18"> </span>
<a href="#l45.19"></a><span id="l45.19">             function getRDFAttr(aNode, aAttr) {</span>
<a href="#l45.20"></a><span id="l45.20">                 return aNode.getAttributeNS(&quot;http://home.netscape.com/NC-rdf#&quot;,</span>
<a href="#l45.21"></a><span id="l45.21">                                             aAttr);</span>
<a href="#l45.22"></a><span id="l45.22" class="difflineat">@@ -270,17 +270,17 @@ var gDataMigrator = {</span>
<a href="#l45.23"></a><span id="l45.23">                     migLOG(&quot;not remote&quot;);</span>
<a href="#l45.24"></a><span id="l45.24">                     var localFile = Components.classes[&quot;@mozilla.org/file/local;1&quot;]</span>
<a href="#l45.25"></a><span id="l45.25">                                     .createInstance(Components.interfaces.nsILocalFile);</span>
<a href="#l45.26"></a><span id="l45.26">                     localFile.initWithPath(getRDFAttr(node, &quot;path&quot;));</span>
<a href="#l45.27"></a><span id="l45.27">                     calendar = gDataMigrator.importICSToStorage(localFile);</span>
<a href="#l45.28"></a><span id="l45.28">                 } else {</span>
<a href="#l45.29"></a><span id="l45.29">                     // Remote subscription</span>
<a href="#l45.30"></a><span id="l45.30">                     // XXX check for duplicates</span>
<a href="#l45.31"></a><span id="l45.31" class="difflineminus">-                    var url = makeURL(getRDFAttr(node, &quot;remotePath&quot;));</span>
<a href="#l45.32"></a><span id="l45.32" class="difflineplus">+                    var url = cal.makeURL(getRDFAttr(node, &quot;remotePath&quot;));</span>
<a href="#l45.33"></a><span id="l45.33">                     calendar = calManager.createCalendar(&quot;ics&quot;, url);</span>
<a href="#l45.34"></a><span id="l45.34">                 }</span>
<a href="#l45.35"></a><span id="l45.35">                 calendar.name = getRDFAttr(node, &quot;name&quot;);</span>
<a href="#l45.36"></a><span id="l45.36">                 calendar.setProperty(&quot;color&quot;, getRDFAttr(node, &quot;color&quot;));</span>
<a href="#l45.37"></a><span id="l45.37">                 calManager.registerCalendar(calendar);</span>
<a href="#l45.38"></a><span id="l45.38">                 cal.getCompositeCalendar(window).addCalendar(calendar);</span>
<a href="#l45.39"></a><span id="l45.39">             }</span>
<a href="#l45.40"></a><span id="l45.40">             aCallback();</span>
<a href="#l45.41"></a><span id="l45.41" class="difflineat">@@ -338,17 +338,17 @@ var gDataMigrator = {</span>
<a href="#l45.42"></a><span id="l45.42">      * the user has created in it.</span>
<a href="#l45.43"></a><span id="l45.43">      */</span>
<a href="#l45.44"></a><span id="l45.44">     checkIcal: function gdm_ical() {</span>
<a href="#l45.45"></a><span id="l45.45">         migLOG(&quot;Checking for ical data&quot;);</span>
<a href="#l45.46"></a><span id="l45.46"> </span>
<a href="#l45.47"></a><span id="l45.47">         function icalMigrate(aDataDir, aCallback) {</span>
<a href="#l45.48"></a><span id="l45.48">             aDataDir.append(&quot;Sources&quot;);</span>
<a href="#l45.49"></a><span id="l45.49">             var dirs = aDataDir.directoryEntries;</span>
<a href="#l45.50"></a><span id="l45.50" class="difflineminus">-            var calManager = getCalendarManager();</span>
<a href="#l45.51"></a><span id="l45.51" class="difflineplus">+            var calManager = cal.getCalendarManager();</span>
<a href="#l45.52"></a><span id="l45.52"> </span>
<a href="#l45.53"></a><span id="l45.53">             var i = 1;</span>
<a href="#l45.54"></a><span id="l45.54">             while(dirs.hasMoreElements()) {</span>
<a href="#l45.55"></a><span id="l45.55">                 var dataDir = dirs.getNext().QueryInterface(Components.interfaces.nsIFile);</span>
<a href="#l45.56"></a><span id="l45.56">                 var dataStore = dataDir.clone();</span>
<a href="#l45.57"></a><span id="l45.57">                 dataStore.append(&quot;corestorage.ics&quot;);</span>
<a href="#l45.58"></a><span id="l45.58">                 if (!dataStore.exists()) {</span>
<a href="#l45.59"></a><span id="l45.59">                     continue;</span>
<a href="#l45.60"></a><span id="l45.60" class="difflineat">@@ -437,17 +437,17 @@ var gDataMigrator = {</span>
<a href="#l45.61"></a><span id="l45.61">                     var calendar = gDataMigrator.importICSToStorage(dataStore);</span>
<a href="#l45.62"></a><span id="l45.62">                     calendar.name = &quot;Evolution &quot; + (i++);</span>
<a href="#l45.63"></a><span id="l45.63">                     calManager.registerCalendar(calendar);</span>
<a href="#l45.64"></a><span id="l45.64">                     cal.getCompositeCalendar(window).addCalendar(calendar);</span>
<a href="#l45.65"></a><span id="l45.65">                 }</span>
<a href="#l45.66"></a><span id="l45.66">                 return dataStore.exists();</span>
<a href="#l45.67"></a><span id="l45.67">             }</span>
<a href="#l45.68"></a><span id="l45.68"> </span>
<a href="#l45.69"></a><span id="l45.69" class="difflineminus">-            var calManager = getCalendarManager();</span>
<a href="#l45.70"></a><span id="l45.70" class="difflineplus">+            var calManager = cal.getCalendarManager();</span>
<a href="#l45.71"></a><span id="l45.71">             var dirs = aDataDir.directoryEntries;</span>
<a href="#l45.72"></a><span id="l45.72">             while (dirs.hasMoreElements()) {</span>
<a href="#l45.73"></a><span id="l45.73">                 var dataDir = dirs.getNext().QueryInterface(Components.interfaces.nsIFile);</span>
<a href="#l45.74"></a><span id="l45.74">                 var dataStore = dataDir.clone();</span>
<a href="#l45.75"></a><span id="l45.75">                 dataStore.append(&quot;calendar.ics&quot;);</span>
<a href="#l45.76"></a><span id="l45.76">                 evoDataMigrate(dataStore);</span>
<a href="#l45.77"></a><span id="l45.77">             }</span>
<a href="#l45.78"></a><span id="l45.78"> </span>
<a href="#l45.79"></a><span id="l45.79" class="difflineat">@@ -535,36 +535,36 @@ var gDataMigrator = {</span>
<a href="#l45.80"></a><span id="l45.80"> </span>
<a href="#l45.81"></a><span id="l45.81">     /**</span>
<a href="#l45.82"></a><span id="l45.82">      * Creates and registers a storage calendar and imports the given ics file into it.</span>
<a href="#l45.83"></a><span id="l45.83">      *</span>
<a href="#l45.84"></a><span id="l45.84">      * @param icsFile     The nsI(Local)File to import.</span>
<a href="#l45.85"></a><span id="l45.85">      */</span>
<a href="#l45.86"></a><span id="l45.86">     importICSToStorage: function migrateIcsStorage(icsFile) {</span>
<a href="#l45.87"></a><span id="l45.87">         const uri = 'moz-storage-calendar://';</span>
<a href="#l45.88"></a><span id="l45.88" class="difflineminus">-        let calendar = cal.getCalendarManager().createCalendar(&quot;storage&quot;, makeURL(uri));</span>
<a href="#l45.89"></a><span id="l45.89" class="difflineplus">+        let calendar = cal.getCalendarManager().createCalendar(&quot;storage&quot;, cal.makeURL(uri));</span>
<a href="#l45.90"></a><span id="l45.90">         let icsImporter = Components.classes[&quot;@mozilla.org/calendar/import;1?type=ics&quot;]</span>
<a href="#l45.91"></a><span id="l45.91">                                     .getService(Components.interfaces.calIImporter);</span>
<a href="#l45.92"></a><span id="l45.92"> </span>
<a href="#l45.93"></a><span id="l45.93">         let inputStream = Components.classes[&quot;@mozilla.org/network/file-input-stream;1&quot;]</span>
<a href="#l45.94"></a><span id="l45.94">                                     .createInstance(Components.interfaces.nsIFileInputStream);</span>
<a href="#l45.95"></a><span id="l45.95">         let items = [];</span>
<a href="#l45.96"></a><span id="l45.96"> </span>
<a href="#l45.97"></a><span id="l45.97">         calendar.id = cal.getUUID();</span>
<a href="#l45.98"></a><span id="l45.98"> </span>
<a href="#l45.99"></a><span id="l45.99">         try {</span>
<a href="#l45.100"></a><span id="l45.100">             inputStream.init(icsFile, MODE_RDONLY, parseInt(&quot;0444&quot;, 8), {});</span>
<a href="#l45.101"></a><span id="l45.101">             items = icsImporter.importFromStream(inputStream, {});</span>
<a href="#l45.102"></a><span id="l45.102">         } catch(ex) {</span>
<a href="#l45.103"></a><span id="l45.103">             switch (ex.result) {</span>
<a href="#l45.104"></a><span id="l45.104">                 case Components.interfaces.calIErrors.INVALID_TIMEZONE:</span>
<a href="#l45.105"></a><span id="l45.105" class="difflineminus">-                    cal.showError(calGetString(&quot;calendar&quot;, &quot;timezoneError&quot;, [icsFile.path]), window);</span>
<a href="#l45.106"></a><span id="l45.106" class="difflineplus">+                    cal.showError(cal.calGetString(&quot;calendar&quot;, &quot;timezoneError&quot;, [icsFile.path]), window);</span>
<a href="#l45.107"></a><span id="l45.107">                     break;</span>
<a href="#l45.108"></a><span id="l45.108">                 default:</span>
<a href="#l45.109"></a><span id="l45.109" class="difflineminus">-                    cal.showError(calGetString(&quot;calendar&quot;, &quot;unableToRead&quot;) + icsFile.path + &quot;\n&quot;+ ex, window);</span>
<a href="#l45.110"></a><span id="l45.110" class="difflineplus">+                    cal.showError(cal.calGetString(&quot;calendar&quot;, &quot;unableToRead&quot;) + icsFile.path + &quot;\n&quot;+ ex, window);</span>
<a href="#l45.111"></a><span id="l45.111">             }</span>
<a href="#l45.112"></a><span id="l45.112">         } finally {</span>
<a href="#l45.113"></a><span id="l45.113">            inputStream.close();</span>
<a href="#l45.114"></a><span id="l45.114">         }</span>
<a href="#l45.115"></a><span id="l45.115"> </span>
<a href="#l45.116"></a><span id="l45.116">         // Defined in import-export.js</span>
<a href="#l45.117"></a><span id="l45.117">         putItemsIntoCal(calendar, items, icsFile.leafName);</span>
<a href="#l45.118"></a><span id="l45.118"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-migration-dialog.xul</span>
<a href="#l46.2"></a><span id="l46.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-migration-dialog.xul</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineat">@@ -19,17 +19,16 @@</span>
<a href="#l46.4"></a><span id="l46.4">         windowtype=&quot;Calendar:MigrationWizard&quot;</span>
<a href="#l46.5"></a><span id="l46.5">         xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l46.6"></a><span id="l46.6">         onload=&quot;gMigrateWizard.loadMigrators()&quot;</span>
<a href="#l46.7"></a><span id="l46.7">         branded=&quot;true&quot;</span>
<a href="#l46.8"></a><span id="l46.8">         persist=&quot;screenX screenY&quot;&gt;</span>
<a href="#l46.9"></a><span id="l46.9"> </span>
<a href="#l46.10"></a><span id="l46.10">     &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calendar-migration-dialog.js&quot;/&gt;</span>
<a href="#l46.11"></a><span id="l46.11">     &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/import-export.js&quot;/&gt;</span>
<a href="#l46.12"></a><span id="l46.12" class="difflineminus">-    &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calUtils.js&quot;/&gt;</span>
<a href="#l46.13"></a><span id="l46.13"> </span>
<a href="#l46.14"></a><span id="l46.14">     &lt;wizardpage id=&quot;wizardPage1&quot;</span>
<a href="#l46.15"></a><span id="l46.15">                 pageid=&quot;initialPage&quot;</span>
<a href="#l46.16"></a><span id="l46.16">                 next=&quot;progressPage&quot;</span>
<a href="#l46.17"></a><span id="l46.17">                 label=&quot;&amp;migration.welcome;&quot;&gt;</span>
<a href="#l46.18"></a><span id="l46.18">         &lt;label id=&quot;wizard-desc&quot; control=&quot;datasource-list&quot;&gt;&amp;migration.list.description;&lt;/label&gt;</span>
<a href="#l46.19"></a><span id="l46.19">         &lt;listbox id=&quot;datasource-list&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l46.20"></a><span id="l46.20">         &lt;/listbox&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-print-dialog.js</span>
<a href="#l47.2"></a><span id="l47.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-print-dialog.js</span>
<a href="#l47.3"></a><span id="l47.3" class="difflineat">@@ -69,17 +69,17 @@ function loadCalendarPrintDialog() {</span>
<a href="#l47.4"></a><span id="l47.4">  * settings.</span>
<a href="#l47.5"></a><span id="l47.5">  *</span>
<a href="#l47.6"></a><span id="l47.6">  * @param receiverFunc  The callback function to call on completion.</span>
<a href="#l47.7"></a><span id="l47.7">  */</span>
<a href="#l47.8"></a><span id="l47.8"> function getPrintSettings(receiverFunc) {</span>
<a href="#l47.9"></a><span id="l47.9">     let tempTitle = document.getElementById(&quot;title-field&quot;).value;</span>
<a href="#l47.10"></a><span id="l47.10">     let settings = {};</span>
<a href="#l47.11"></a><span id="l47.11">     let requiresFetch = true;</span>
<a href="#l47.12"></a><span id="l47.12" class="difflineminus">-    settings.title = tempTitle || calGetString(&quot;calendar&quot;, &quot;Untitled&quot;);</span>
<a href="#l47.13"></a><span id="l47.13" class="difflineplus">+    settings.title = tempTitle || cal.calGetString(&quot;calendar&quot;, &quot;Untitled&quot;);</span>
<a href="#l47.14"></a><span id="l47.14">     settings.layoutCId = document.getElementById(&quot;layout-field&quot;).value;</span>
<a href="#l47.15"></a><span id="l47.15">     settings.start = null;</span>
<a href="#l47.16"></a><span id="l47.16">     settings.end = null;</span>
<a href="#l47.17"></a><span id="l47.17">     settings.eventList = [];</span>
<a href="#l47.18"></a><span id="l47.18">     settings.printEvents = document.getElementById(&quot;events&quot;).checked;</span>
<a href="#l47.19"></a><span id="l47.19">     settings.printTasks = document.getElementById(&quot;tasks&quot;).checked;</span>
<a href="#l47.20"></a><span id="l47.20">     settings.printCompletedTasks = document.getElementById(&quot;completed-tasks&quot;).checked;</span>
<a href="#l47.21"></a><span id="l47.21">     settings.printTasksWithNoDueDate = document.getElementById(&quot;tasks-with-no-due-date&quot;).checked;</span>
<a href="#l47.22"></a><span id="l47.22" class="difflineat">@@ -197,17 +197,17 @@ function getFilter(settings) {</span>
<a href="#l47.23"></a><span id="l47.23"> </span>
<a href="#l47.24"></a><span id="l47.24"> /**</span>
<a href="#l47.25"></a><span id="l47.25">  * Looks at the selections the user has made (start date, layout, etc.), and</span>
<a href="#l47.26"></a><span id="l47.26">  * updates the HTML in the iframe accordingly. This is also called when a</span>
<a href="#l47.27"></a><span id="l47.27">  * dialog UI element has changed, since we'll want to refresh the preview.</span>
<a href="#l47.28"></a><span id="l47.28">  */</span>
<a href="#l47.29"></a><span id="l47.29"> function refreshHtml(finishFunc) {</span>
<a href="#l47.30"></a><span id="l47.30">     getPrintSettings((settings) =&gt; {</span>
<a href="#l47.31"></a><span id="l47.31" class="difflineminus">-        document.title = calGetString(&quot;calendar&quot;, &quot;PrintPreviewWindowTitle&quot;, [settings.title]);</span>
<a href="#l47.32"></a><span id="l47.32" class="difflineplus">+        document.title = cal.calGetString(&quot;calendar&quot;, &quot;PrintPreviewWindowTitle&quot;, [settings.title]);</span>
<a href="#l47.33"></a><span id="l47.33"> </span>
<a href="#l47.34"></a><span id="l47.34">         let printformatter = Components.classes[settings.layoutCId]</span>
<a href="#l47.35"></a><span id="l47.35">                                        .createInstance(Components.interfaces.calIPrintFormatter);</span>
<a href="#l47.36"></a><span id="l47.36">         let html = &quot;&quot;;</span>
<a href="#l47.37"></a><span id="l47.37">         try {</span>
<a href="#l47.38"></a><span id="l47.38">             let pipe = Components.classes[&quot;@mozilla.org/pipe;1&quot;]</span>
<a href="#l47.39"></a><span id="l47.39">                                  .createInstance(Components.interfaces.nsIPipe);</span>
<a href="#l47.40"></a><span id="l47.40">             const PR_UINT32_MAX = 4294967295; // signals &quot;infinite-length&quot;</span>
<a href="#l47.41"></a><span id="l47.41" class="difflineat">@@ -298,17 +298,17 @@ function printAndClose() {</span>
<a href="#l47.42"></a><span id="l47.42">     });</span>
<a href="#l47.43"></a><span id="l47.43">     return false; // leave open</span>
<a href="#l47.44"></a><span id="l47.44"> }</span>
<a href="#l47.45"></a><span id="l47.45"> </span>
<a href="#l47.46"></a><span id="l47.46"> /**</span>
<a href="#l47.47"></a><span id="l47.47">  * Called when once a date has been selected in the datepicker.</span>
<a href="#l47.48"></a><span id="l47.48">  */</span>
<a href="#l47.49"></a><span id="l47.49"> function onDatePick() {</span>
<a href="#l47.50"></a><span id="l47.50" class="difflineminus">-    calRadioGroupSelectItem(&quot;view-field&quot;, &quot;custom-range&quot;);</span>
<a href="#l47.51"></a><span id="l47.51" class="difflineplus">+    cal.calRadioGroupSelectItem(&quot;view-field&quot;, &quot;custom-range&quot;);</span>
<a href="#l47.52"></a><span id="l47.52">     setTimeout(refreshHtml, 0);</span>
<a href="#l47.53"></a><span id="l47.53"> }</span>
<a href="#l47.54"></a><span id="l47.54"> </span>
<a href="#l47.55"></a><span id="l47.55"> function eventsAndTasksOptions(targetId) {</span>
<a href="#l47.56"></a><span id="l47.56">     let checkbox = document.getElementById(targetId);</span>
<a href="#l47.57"></a><span id="l47.57">     let checked = checkbox.getAttribute(&quot;checked&quot;) == &quot;true&quot;;</span>
<a href="#l47.58"></a><span id="l47.58">     // Workaround to make the checkbox persistent (bug 15232).</span>
<a href="#l47.59"></a><span id="l47.59">     checkbox.setAttribute(&quot;checked&quot;, checked ? &quot;true&quot; : &quot;false&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l48.1"></a><span id="l48.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-print-dialog.xul</span>
<a href="#l48.2"></a><span id="l48.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-print-dialog.xul</span>
<a href="#l48.3"></a><span id="l48.3" class="difflineat">@@ -21,17 +21,16 @@</span>
<a href="#l48.4"></a><span id="l48.4">         buttonaccesskeyaccept=&quot;&amp;calendar.print.button.accesskey;&quot;</span>
<a href="#l48.5"></a><span id="l48.5">         defaultButton=&quot;accept&quot;</span>
<a href="#l48.6"></a><span id="l48.6">         ondialogaccept=&quot;return printAndClose();&quot;</span>
<a href="#l48.7"></a><span id="l48.7">         ondialogcancel=&quot;return true;&quot;</span>
<a href="#l48.8"></a><span id="l48.8">         persist=&quot;screenX screenY width height&quot;</span>
<a href="#l48.9"></a><span id="l48.9">         xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;&gt;</span>
<a href="#l48.10"></a><span id="l48.10"> </span>
<a href="#l48.11"></a><span id="l48.11">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calendar-print-dialog.js&quot;/&gt;</span>
<a href="#l48.12"></a><span id="l48.12" class="difflineminus">-  &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calUtils.js&quot;/&gt;</span>
<a href="#l48.13"></a><span id="l48.13">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calendar-ui-utils.js&quot;/&gt;</span>
<a href="#l48.14"></a><span id="l48.14">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://global/content/printUtils.js&quot;/&gt;</span>
<a href="#l48.15"></a><span id="l48.15"> </span>
<a href="#l48.16"></a><span id="l48.16">   &lt;hbox id=&quot;firstHbox&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l48.17"></a><span id="l48.17">     &lt;vbox id=&quot;groupboxVbox&quot;&gt;</span>
<a href="#l48.18"></a><span id="l48.18">       &lt;groupbox id=&quot;settingsGroup&quot;&gt;</span>
<a href="#l48.19"></a><span id="l48.19">         &lt;caption label=&quot;&amp;calendar.print.settingsGroup.label;&quot;/&gt;</span>
<a href="#l48.20"></a><span id="l48.20"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l49.1"></a><span id="l49.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-properties-dialog.xul</span>
<a href="#l49.2"></a><span id="l49.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-properties-dialog.xul</span>
<a href="#l49.3"></a><span id="l49.3" class="difflineat">@@ -24,17 +24,16 @@</span>
<a href="#l49.4"></a><span id="l49.4">     ondialogcancel=&quot;return true;&quot;</span>
<a href="#l49.5"></a><span id="l49.5">     onload=&quot;onLoad()&quot;</span>
<a href="#l49.6"></a><span id="l49.6">     persist=&quot;screenX screenY&quot;</span>
<a href="#l49.7"></a><span id="l49.7">     xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l49.8"></a><span id="l49.8">     xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;</span>
<a href="#l49.9"></a><span id="l49.9">     width=&quot;500&quot;&gt;</span>
<a href="#l49.10"></a><span id="l49.10"> </span>
<a href="#l49.11"></a><span id="l49.11">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calendar-properties-dialog.js&quot;/&gt;</span>
<a href="#l49.12"></a><span id="l49.12" class="difflineminus">-  &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calUtils.js&quot;/&gt;</span>
<a href="#l49.13"></a><span id="l49.13">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calendar-ui-utils.js&quot;/&gt;</span>
<a href="#l49.14"></a><span id="l49.14"> </span>
<a href="#l49.15"></a><span id="l49.15">   &lt;description id=&quot;force-disabled-description&quot; hidden=&quot;true&quot;&gt;&amp;calendarproperties.forceDisabled.label;&lt;/description&gt;</span>
<a href="#l49.16"></a><span id="l49.16"> </span>
<a href="#l49.17"></a><span id="l49.17">   &lt;checkbox id=&quot;calendar-enabled-checkbox&quot;</span>
<a href="#l49.18"></a><span id="l49.18">             label=&quot;&amp;calendarproperties.enabled.label;&quot;</span>
<a href="#l49.19"></a><span id="l49.19">             oncommand=&quot;setupEnabledCheckbox()&quot;/&gt;</span>
<a href="#l49.20"></a><span id="l49.20"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l50.1"></a><span id="l50.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-subscriptions-dialog.js</span>
<a href="#l50.2"></a><span id="l50.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-subscriptions-dialog.js</span>
<a href="#l50.3"></a><span id="l50.3" class="difflineat">@@ -1,16 +1,18 @@</span>
<a href="#l50.4"></a><span id="l50.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l50.5"></a><span id="l50.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l50.6"></a><span id="l50.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l50.7"></a><span id="l50.7"> </span>
<a href="#l50.8"></a><span id="l50.8"> /* exported onLoad, onUnload, onKeyPress, onTextBoxKeyPress, onAccept,</span>
<a href="#l50.9"></a><span id="l50.9">  *          onCancel, onSubscribe, onUnsubscribe</span>
<a href="#l50.10"></a><span id="l50.10">  */</span>
<a href="#l50.11"></a><span id="l50.11"> </span>
<a href="#l50.12"></a><span id="l50.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l50.13"></a><span id="l50.13" class="difflineplus">+</span>
<a href="#l50.14"></a><span id="l50.14"> /**</span>
<a href="#l50.15"></a><span id="l50.15">  * Cancels any pending search operations.</span>
<a href="#l50.16"></a><span id="l50.16">  */</span>
<a href="#l50.17"></a><span id="l50.17"> var gCurrentSearchOperation = null;</span>
<a href="#l50.18"></a><span id="l50.18"> function cancelPendingSearchOperation() {</span>
<a href="#l50.19"></a><span id="l50.19">     if (gCurrentSearchOperation &amp;&amp; gCurrentSearchOperation.isPending) {</span>
<a href="#l50.20"></a><span id="l50.20">         gCurrentSearchOperation.cancel(Components.interfaces.calIErrors.OPERATION_CANCELLED);</span>
<a href="#l50.21"></a><span id="l50.21">     }</span>
<a href="#l50.22"></a><span id="l50.22" class="difflineat">@@ -71,19 +73,19 @@ function onAccept() {</span>
<a href="#l50.23"></a><span id="l50.23">     let richListBox = document.getElementById(&quot;subscriptions-listbox&quot;);</span>
<a href="#l50.24"></a><span id="l50.24">     let rowCount = richListBox.getRowCount();</span>
<a href="#l50.25"></a><span id="l50.25">     for (let i = 0; i &lt; rowCount; i++) {</span>
<a href="#l50.26"></a><span id="l50.26">         let richListItem = richListBox.getItemAtIndex(i);</span>
<a href="#l50.27"></a><span id="l50.27">         let checked = richListItem.checked;</span>
<a href="#l50.28"></a><span id="l50.28">         if (checked != richListItem.subscribed) {</span>
<a href="#l50.29"></a><span id="l50.29">             let calendar = richListItem.calendar;</span>
<a href="#l50.30"></a><span id="l50.30">             if (checked) {</span>
<a href="#l50.31"></a><span id="l50.31" class="difflineminus">-                getCalendarManager().registerCalendar(calendar);</span>
<a href="#l50.32"></a><span id="l50.32" class="difflineplus">+                cal.getCalendarManager().registerCalendar(calendar);</span>
<a href="#l50.33"></a><span id="l50.33">             } else {</span>
<a href="#l50.34"></a><span id="l50.34" class="difflineminus">-                getCalendarManager().unregisterCalendar(calendar);</span>
<a href="#l50.35"></a><span id="l50.35" class="difflineplus">+                cal.getCalendarManager().unregisterCalendar(calendar);</span>
<a href="#l50.36"></a><span id="l50.36">             }</span>
<a href="#l50.37"></a><span id="l50.37">         }</span>
<a href="#l50.38"></a><span id="l50.38">     }</span>
<a href="#l50.39"></a><span id="l50.39">     return true;</span>
<a href="#l50.40"></a><span id="l50.40"> }</span>
<a href="#l50.41"></a><span id="l50.41"> </span>
<a href="#l50.42"></a><span id="l50.42"> /**</span>
<a href="#l50.43"></a><span id="l50.43">  * Handler function to be called when the cancel button is pressed.</span>
<a href="#l50.44"></a><span id="l50.44" class="difflineat">@@ -96,17 +98,17 @@ function onCancel() {</span>
<a href="#l50.45"></a><span id="l50.45">  */</span>
<a href="#l50.46"></a><span id="l50.46"> function onSearch() {</span>
<a href="#l50.47"></a><span id="l50.47">     cancelPendingSearchOperation();</span>
<a href="#l50.48"></a><span id="l50.48"> </span>
<a href="#l50.49"></a><span id="l50.49">     let richListBox = document.getElementById(&quot;subscriptions-listbox&quot;);</span>
<a href="#l50.50"></a><span id="l50.50">     richListBox.clear();</span>
<a href="#l50.51"></a><span id="l50.51"> </span>
<a href="#l50.52"></a><span id="l50.52">     let registeredCals = {};</span>
<a href="#l50.53"></a><span id="l50.53" class="difflineminus">-    for (let calendar of getCalendarManager().getCalendars({})) {</span>
<a href="#l50.54"></a><span id="l50.54" class="difflineplus">+    for (let calendar of cal.getCalendarManager().getCalendars({})) {</span>
<a href="#l50.55"></a><span id="l50.55">         registeredCals[calendar.id] = true;</span>
<a href="#l50.56"></a><span id="l50.56">     }</span>
<a href="#l50.57"></a><span id="l50.57"> </span>
<a href="#l50.58"></a><span id="l50.58">     let opListener = {</span>
<a href="#l50.59"></a><span id="l50.59">         onResult: function(operation, result) {</span>
<a href="#l50.60"></a><span id="l50.60">             if (result) {</span>
<a href="#l50.61"></a><span id="l50.61">                 for (let calendar of result) {</span>
<a href="#l50.62"></a><span id="l50.62">                     richListBox.addCalendar(calendar, registeredCals[calendar.id]);</span>
<a href="#l50.63"></a><span id="l50.63" class="difflineat">@@ -118,18 +120,18 @@ function onSearch() {</span>
<a href="#l50.64"></a><span id="l50.64">                     statusDeck.selectedIndex = 0;</span>
<a href="#l50.65"></a><span id="l50.65">                 } else {</span>
<a href="#l50.66"></a><span id="l50.66">                     statusDeck.selectedIndex = 2;</span>
<a href="#l50.67"></a><span id="l50.67">                 }</span>
<a href="#l50.68"></a><span id="l50.68">             }</span>
<a href="#l50.69"></a><span id="l50.69">         }</span>
<a href="#l50.70"></a><span id="l50.70">     };</span>
<a href="#l50.71"></a><span id="l50.71"> </span>
<a href="#l50.72"></a><span id="l50.72" class="difflineminus">-    let operation = getCalendarSearchService().searchForCalendars(document.getElementById(&quot;search-textbox&quot;).value,</span>
<a href="#l50.73"></a><span id="l50.73" class="difflineminus">-                                                           0 /* hints */, 50, opListener);</span>
<a href="#l50.74"></a><span id="l50.74" class="difflineplus">+    let operation = cal.getCalendarSearchService().searchForCalendars(document.getElementById(&quot;search-textbox&quot;).value,</span>
<a href="#l50.75"></a><span id="l50.75" class="difflineplus">+                                                                      0 /* hints */, 50, opListener);</span>
<a href="#l50.76"></a><span id="l50.76">     if (operation &amp;&amp; operation.isPending) {</span>
<a href="#l50.77"></a><span id="l50.77">         gCurrentSearchOperation = op;</span>
<a href="#l50.78"></a><span id="l50.78">         document.getElementById(&quot;status-deck&quot;).selectedIndex = 1;</span>
<a href="#l50.79"></a><span id="l50.79">     }</span>
<a href="#l50.80"></a><span id="l50.80"> }</span>
<a href="#l50.81"></a><span id="l50.81"> </span>
<a href="#l50.82"></a><span id="l50.82"> /**</span>
<a href="#l50.83"></a><span id="l50.83">  * Markes the selected item in the subscriptions-listbox for subscribing. The</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l51.1"></a><span id="l51.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-subscriptions-dialog.xul</span>
<a href="#l51.2"></a><span id="l51.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-subscriptions-dialog.xul</span>
<a href="#l51.3"></a><span id="l51.3" class="difflineat">@@ -23,17 +23,16 @@</span>
<a href="#l51.4"></a><span id="l51.4">   onload=&quot;return onLoad();&quot;</span>
<a href="#l51.5"></a><span id="l51.5">   onunload=&quot;return onUnload();&quot;</span>
<a href="#l51.6"></a><span id="l51.6">   onkeypress=&quot;onKeyPress(event);&quot;</span>
<a href="#l51.7"></a><span id="l51.7">   persist=&quot;screenX screenY width height&quot;</span>
<a href="#l51.8"></a><span id="l51.8">   xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;&gt;</span>
<a href="#l51.9"></a><span id="l51.9"> </span>
<a href="#l51.10"></a><span id="l51.10">   &lt;!-- Javascript includes --&gt;</span>
<a href="#l51.11"></a><span id="l51.11">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calendar-subscriptions-dialog.js&quot;/&gt;</span>
<a href="#l51.12"></a><span id="l51.12" class="difflineminus">-  &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calUtils.js&quot;/&gt;</span>
<a href="#l51.13"></a><span id="l51.13">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calendar-ui-utils.js&quot;/&gt;</span>
<a href="#l51.14"></a><span id="l51.14"> </span>
<a href="#l51.15"></a><span id="l51.15">   &lt;vbox flex=&quot;1&quot;&gt;</span>
<a href="#l51.16"></a><span id="l51.16">     &lt;grid flex=&quot;1&quot;&gt;</span>
<a href="#l51.17"></a><span id="l51.17">       &lt;columns&gt;</span>
<a href="#l51.18"></a><span id="l51.18">         &lt;column flex=&quot;1&quot;/&gt;</span>
<a href="#l51.19"></a><span id="l51.19">         &lt;column/&gt;</span>
<a href="#l51.20"></a><span id="l51.20">       &lt;/columns&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l52.1"></a><span id="l52.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-summary-dialog.js</span>
<a href="#l52.2"></a><span id="l52.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-summary-dialog.js</span>
<a href="#l52.3"></a><span id="l52.3" class="difflineat">@@ -47,21 +47,21 @@ function onLoad() {</span>
<a href="#l52.4"></a><span id="l52.4">         setDialogId(document.documentElement, &quot;calendar-event-summary-dialog&quot;);</span>
<a href="#l52.5"></a><span id="l52.5">     } else if (cal.isToDo(item)) {</span>
<a href="#l52.6"></a><span id="l52.6">         setDialogId(document.documentElement, &quot;calendar-task-summary-dialog&quot;);</span>
<a href="#l52.7"></a><span id="l52.7">     }</span>
<a href="#l52.8"></a><span id="l52.8"> </span>
<a href="#l52.9"></a><span id="l52.9">     window.attendees = item.getAttendees({});</span>
<a href="#l52.10"></a><span id="l52.10"> </span>
<a href="#l52.11"></a><span id="l52.11">     let calendar = cal.wrapInstance(item.calendar, Components.interfaces.calISchedulingSupport);</span>
<a href="#l52.12"></a><span id="l52.12" class="difflineminus">-    window.readOnly = !(isCalendarWritable(calendar) &amp;&amp;</span>
<a href="#l52.13"></a><span id="l52.13" class="difflineminus">-                        (userCanModifyItem(item) ||</span>
<a href="#l52.14"></a><span id="l52.14" class="difflineplus">+    window.readOnly = !(cal.isCalendarWritable(calendar) &amp;&amp;</span>
<a href="#l52.15"></a><span id="l52.15" class="difflineplus">+                        (cal.userCanModifyItem(item) ||</span>
<a href="#l52.16"></a><span id="l52.16">                          (calendar &amp;&amp;</span>
<a href="#l52.17"></a><span id="l52.17">                           item.calendar.isInvitation(item) &amp;&amp;</span>
<a href="#l52.18"></a><span id="l52.18" class="difflineminus">-                          userCanRespondToInvitation(item))));</span>
<a href="#l52.19"></a><span id="l52.19" class="difflineplus">+                          cal.userCanRespondToInvitation(item))));</span>
<a href="#l52.20"></a><span id="l52.20">     if (!window.readOnly &amp;&amp; calendar) {</span>
<a href="#l52.21"></a><span id="l52.21">         let attendee = calendar.getInvitedAttendee(item);</span>
<a href="#l52.22"></a><span id="l52.22">         if (attendee) {</span>
<a href="#l52.23"></a><span id="l52.23">             // if this is an unresponded invitation, preset our default alarm values:</span>
<a href="#l52.24"></a><span id="l52.24">             if (!item.getAlarms({}).length &amp;&amp;</span>
<a href="#l52.25"></a><span id="l52.25">                 (attendee.participationStatus == &quot;NEEDS-ACTION&quot;)) {</span>
<a href="#l52.26"></a><span id="l52.26">                 cal.alarms.setDefaultValues(item);</span>
<a href="#l52.27"></a><span id="l52.27">             }</span>
<a href="#l52.28"></a><span id="l52.28" class="difflineat">@@ -301,17 +301,17 @@ function updateRepeatDetails() {</span>
<a href="#l52.29"></a><span id="l52.29">     // First of all collapse the details text. If we fail to</span>
<a href="#l52.30"></a><span id="l52.30">     // create a details string, we simply don't show anything.</span>
<a href="#l52.31"></a><span id="l52.31">     // this could happen if the repeat rule is something exotic</span>
<a href="#l52.32"></a><span id="l52.32">     // we don't have any strings prepared for.</span>
<a href="#l52.33"></a><span id="l52.33">     let repeatDetails = document.getElementById(&quot;repeat-details&quot;);</span>
<a href="#l52.34"></a><span id="l52.34">     repeatDetails.setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l52.35"></a><span id="l52.35"> </span>
<a href="#l52.36"></a><span id="l52.36">     // Try to create a descriptive string from the rule(s).</span>
<a href="#l52.37"></a><span id="l52.37" class="difflineminus">-    let kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l52.38"></a><span id="l52.38" class="difflineplus">+    let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l52.39"></a><span id="l52.39">     let startDate = item.startDate || item.entryDate;</span>
<a href="#l52.40"></a><span id="l52.40">     let endDate = item.endDate || item.dueDate;</span>
<a href="#l52.41"></a><span id="l52.41">     startDate = startDate ? startDate.getInTimezone(kDefaultTimezone) : null;</span>
<a href="#l52.42"></a><span id="l52.42">     endDate = endDate ? endDate.getInTimezone(kDefaultTimezone) : null;</span>
<a href="#l52.43"></a><span id="l52.43">     let detailsString = recurrenceRule2String(recurrenceInfo, startDate,</span>
<a href="#l52.44"></a><span id="l52.44">                                               endDate, startDate.isDate);</span>
<a href="#l52.45"></a><span id="l52.45"> </span>
<a href="#l52.46"></a><span id="l52.46">     if (!detailsString) {</span>
<a href="#l52.47"></a><span id="l52.47" class="difflineat">@@ -373,17 +373,17 @@ function browseDocument() {</span>
<a href="#l52.48"></a><span id="l52.48">  */</span>
<a href="#l52.49"></a><span id="l52.49"> function sendMailToOrganizer() {</span>
<a href="#l52.50"></a><span id="l52.50">     let args = window.arguments[0];</span>
<a href="#l52.51"></a><span id="l52.51">     let item = args.calendarEvent;</span>
<a href="#l52.52"></a><span id="l52.52">     let organizer = item.organizer;</span>
<a href="#l52.53"></a><span id="l52.53">     let email = cal.getAttendeeEmail(organizer, true);</span>
<a href="#l52.54"></a><span id="l52.54">     let emailSubject = cal.calGetString(&quot;calendar-event-dialog&quot;, &quot;emailSubjectReply&quot;, [item.title]);</span>
<a href="#l52.55"></a><span id="l52.55">     let identity = item.calendar.getProperty(&quot;imip.identity&quot;);</span>
<a href="#l52.56"></a><span id="l52.56" class="difflineminus">-    sendMailTo(email, emailSubject, null, identity);</span>
<a href="#l52.57"></a><span id="l52.57" class="difflineplus">+    cal.sendMailTo(email, emailSubject, null, identity);</span>
<a href="#l52.58"></a><span id="l52.58"> }</span>
<a href="#l52.59"></a><span id="l52.59"> </span>
<a href="#l52.60"></a><span id="l52.60"> /**</span>
<a href="#l52.61"></a><span id="l52.61">  * Opens an attachment</span>
<a href="#l52.62"></a><span id="l52.62">  *</span>
<a href="#l52.63"></a><span id="l52.63">  * @param {AUTF8String}  aAttachmentId   The hashId of the attachment to open</span>
<a href="#l52.64"></a><span id="l52.64">  */</span>
<a href="#l52.65"></a><span id="l52.65"> function openAttachment(aAttachmentId) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l53.1"></a><span id="l53.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-summary-dialog.xul</span>
<a href="#l53.2"></a><span id="l53.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-summary-dialog.xul</span>
<a href="#l53.3"></a><span id="l53.3" class="difflineat">@@ -35,18 +35,16 @@</span>
<a href="#l53.4"></a><span id="l53.4">         xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;&gt;</span>
<a href="#l53.5"></a><span id="l53.5"> </span>
<a href="#l53.6"></a><span id="l53.6">   &lt;!-- Javascript includes --&gt;</span>
<a href="#l53.7"></a><span id="l53.7">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l53.8"></a><span id="l53.8">           src=&quot;chrome://calendar/content/calendar-summary-dialog.js&quot;/&gt;</span>
<a href="#l53.9"></a><span id="l53.9">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l53.10"></a><span id="l53.10">           src=&quot;chrome://calendar/content/calendar-dialog-utils.js&quot;/&gt;</span>
<a href="#l53.11"></a><span id="l53.11">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l53.12"></a><span id="l53.12" class="difflineminus">-          src=&quot;chrome://calendar/content/calUtils.js&quot;/&gt;</span>
<a href="#l53.13"></a><span id="l53.13" class="difflineminus">-  &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l53.14"></a><span id="l53.14">           src=&quot;chrome://calendar/content/calendar-ui-utils.js&quot;/&gt;</span>
<a href="#l53.15"></a><span id="l53.15">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l53.16"></a><span id="l53.16">           src=&quot;chrome://calendar/content/calendar-item-editing.js&quot;/&gt;</span>
<a href="#l53.17"></a><span id="l53.17">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l53.18"></a><span id="l53.18">           src=&quot;chrome://calendar/content/calApplicationUtils.js&quot;/&gt;</span>
<a href="#l53.19"></a><span id="l53.19"> </span>
<a href="#l53.20"></a><span id="l53.20">   &lt;!-- General --&gt;</span>
<a href="#l53.21"></a><span id="l53.21">   &lt;box id=&quot;item-general-box&quot; orient=&quot;vertical&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l54.1"></a><span id="l54.1" class="difflineminus">--- a/calendar/base/content/import-export.js</span>
<a href="#l54.2"></a><span id="l54.2" class="difflineplus">+++ b/calendar/base/content/import-export.js</span>
<a href="#l54.3"></a><span id="l54.3" class="difflineat">@@ -1,13 +1,14 @@</span>
<a href="#l54.4"></a><span id="l54.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l54.5"></a><span id="l54.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l54.6"></a><span id="l54.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l54.7"></a><span id="l54.7"> </span>
<a href="#l54.8"></a><span id="l54.8"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l54.9"></a><span id="l54.9" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l54.10"></a><span id="l54.10"> </span>
<a href="#l54.11"></a><span id="l54.11"> /* exported loadEventsFromFile, exportEntireCalendar */</span>
<a href="#l54.12"></a><span id="l54.12"> </span>
<a href="#l54.13"></a><span id="l54.13"> // File constants copied from file-utils.js</span>
<a href="#l54.14"></a><span id="l54.14"> var MODE_RDONLY = 0x01;</span>
<a href="#l54.15"></a><span id="l54.15"> var MODE_WRONLY = 0x02;</span>
<a href="#l54.16"></a><span id="l54.16"> var MODE_CREATE = 0x08;</span>
<a href="#l54.17"></a><span id="l54.17"> var MODE_TRUNCATE = 0x20;</span>
<a href="#l54.18"></a><span id="l54.18" class="difflineat">@@ -19,17 +20,17 @@ var MODE_TRUNCATE = 0x20;</span>
<a href="#l54.19"></a><span id="l54.19">  *                              into the calendar</span>
<a href="#l54.20"></a><span id="l54.20">  */</span>
<a href="#l54.21"></a><span id="l54.21"> function loadEventsFromFile(aCalendar) {</span>
<a href="#l54.22"></a><span id="l54.22">     const nsIFilePicker = Components.interfaces.nsIFilePicker;</span>
<a href="#l54.23"></a><span id="l54.23"> </span>
<a href="#l54.24"></a><span id="l54.24">     let picker = Components.classes[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l54.25"></a><span id="l54.25">                            .createInstance(nsIFilePicker);</span>
<a href="#l54.26"></a><span id="l54.26">     picker.init(window,</span>
<a href="#l54.27"></a><span id="l54.27" class="difflineminus">-                calGetString(&quot;calendar&quot;, &quot;filepickerTitleImport&quot;),</span>
<a href="#l54.28"></a><span id="l54.28" class="difflineplus">+                cal.calGetString(&quot;calendar&quot;, &quot;filepickerTitleImport&quot;),</span>
<a href="#l54.29"></a><span id="l54.29">                 nsIFilePicker.modeOpen);</span>
<a href="#l54.30"></a><span id="l54.30">     picker.defaultExtension = &quot;ics&quot;;</span>
<a href="#l54.31"></a><span id="l54.31"> </span>
<a href="#l54.32"></a><span id="l54.32">     // Get a list of importers</span>
<a href="#l54.33"></a><span id="l54.33">     let contractids = [];</span>
<a href="#l54.34"></a><span id="l54.34">     let catman = Components.classes[&quot;@mozilla.org/categorymanager;1&quot;]</span>
<a href="#l54.35"></a><span id="l54.35">                            .getService(Components.interfaces.nsICategoryManager);</span>
<a href="#l54.36"></a><span id="l54.36">     let catenum = catman.enumerateCategory(&quot;cal-importers&quot;);</span>
<a href="#l54.37"></a><span id="l54.37" class="difflineat">@@ -104,31 +105,31 @@ function loadEventsFromFile(aCalendar) {</span>
<a href="#l54.38"></a><span id="l54.38">         }</span>
<a href="#l54.39"></a><span id="l54.39"> </span>
<a href="#l54.40"></a><span id="l54.40">         if (aCalendar) {</span>
<a href="#l54.41"></a><span id="l54.41">             putItemsIntoCal(aCalendar, items);</span>
<a href="#l54.42"></a><span id="l54.42">             return;</span>
<a href="#l54.43"></a><span id="l54.43">         }</span>
<a href="#l54.44"></a><span id="l54.44"> </span>
<a href="#l54.45"></a><span id="l54.45">         let calendars = cal.getCalendarManager().getCalendars({});</span>
<a href="#l54.46"></a><span id="l54.46" class="difflineminus">-        calendars = calendars.filter(isCalendarWritable);</span>
<a href="#l54.47"></a><span id="l54.47" class="difflineplus">+        calendars = calendars.filter(cal.isCalendarWritable);</span>
<a href="#l54.48"></a><span id="l54.48"> </span>
<a href="#l54.49"></a><span id="l54.49">         if (calendars.length &lt; 1) {</span>
<a href="#l54.50"></a><span id="l54.50">             // XXX alert something?</span>
<a href="#l54.51"></a><span id="l54.51">             return;</span>
<a href="#l54.52"></a><span id="l54.52">         } else if (calendars.length == 1) {</span>
<a href="#l54.53"></a><span id="l54.53">             // There's only one calendar, so it's silly to ask what calendar</span>
<a href="#l54.54"></a><span id="l54.54">             // the user wants to import into.</span>
<a href="#l54.55"></a><span id="l54.55">             putItemsIntoCal(calendars[0], items, filePath);</span>
<a href="#l54.56"></a><span id="l54.56">         } else {</span>
<a href="#l54.57"></a><span id="l54.57">             // Ask what calendar to import into</span>
<a href="#l54.58"></a><span id="l54.58">             let args = {};</span>
<a href="#l54.59"></a><span id="l54.59">             args.onOk = (aCal) =&gt; { putItemsIntoCal(aCal, items, filePath); };</span>
<a href="#l54.60"></a><span id="l54.60">             args.calendars = calendars;</span>
<a href="#l54.61"></a><span id="l54.61" class="difflineminus">-            args.promptText = calGetString(&quot;calendar&quot;, &quot;importPrompt&quot;);</span>
<a href="#l54.62"></a><span id="l54.62" class="difflineplus">+            args.promptText = cal.calGetString(&quot;calendar&quot;, &quot;importPrompt&quot;);</span>
<a href="#l54.63"></a><span id="l54.63">             openDialog(&quot;chrome://calendar/content/chooseCalendarDialog.xul&quot;,</span>
<a href="#l54.64"></a><span id="l54.64">                        &quot;_blank&quot;, &quot;chrome,titlebar,modal,resizable&quot;, args);</span>
<a href="#l54.65"></a><span id="l54.65">         }</span>
<a href="#l54.66"></a><span id="l54.66">     }</span>
<a href="#l54.67"></a><span id="l54.67"> }</span>
<a href="#l54.68"></a><span id="l54.68"> </span>
<a href="#l54.69"></a><span id="l54.69"> /**</span>
<a href="#l54.70"></a><span id="l54.70">  * Put items into a certain calendar, catching errors and showing them to the</span>
<a href="#l54.71"></a><span id="l54.71" class="difflineat">@@ -169,19 +170,19 @@ function putItemsIntoCal(destCal, aItems</span>
<a href="#l54.72"></a><span id="l54.72">                     failedCount++;</span>
<a href="#l54.73"></a><span id="l54.73">                     lastError = aStatus;</span>
<a href="#l54.74"></a><span id="l54.74">                 }</span>
<a href="#l54.75"></a><span id="l54.75">             }</span>
<a href="#l54.76"></a><span id="l54.76">             // See if it is time to end the calendar's batch.</span>
<a href="#l54.77"></a><span id="l54.77">             if (count == aItems.length) {</span>
<a href="#l54.78"></a><span id="l54.78">                 destCal.endBatch();</span>
<a href="#l54.79"></a><span id="l54.79">                 if (!failedCount &amp;&amp; duplicateCount) {</span>
<a href="#l54.80"></a><span id="l54.80" class="difflineminus">-                    cal.showError(calGetString(&quot;calendar&quot;, &quot;duplicateError&quot;, [duplicateCount, aFilePath]), window);</span>
<a href="#l54.81"></a><span id="l54.81" class="difflineplus">+                    cal.showError(cal.calGetString(&quot;calendar&quot;, &quot;duplicateError&quot;, [duplicateCount, aFilePath]), window);</span>
<a href="#l54.82"></a><span id="l54.82">                 } else if (failedCount) {</span>
<a href="#l54.83"></a><span id="l54.83" class="difflineminus">-                    cal.showError(calGetString(&quot;calendar&quot;, &quot;importItemsFailed&quot;, [failedCount, lastError.toString()]), window);</span>
<a href="#l54.84"></a><span id="l54.84" class="difflineplus">+                    cal.showError(cal.calGetString(&quot;calendar&quot;, &quot;importItemsFailed&quot;, [failedCount, lastError.toString()]), window);</span>
<a href="#l54.85"></a><span id="l54.85">                 }</span>
<a href="#l54.86"></a><span id="l54.86">             }</span>
<a href="#l54.87"></a><span id="l54.87">         }</span>
<a href="#l54.88"></a><span id="l54.88">     };</span>
<a href="#l54.89"></a><span id="l54.89"> </span>
<a href="#l54.90"></a><span id="l54.90">     for (let item of aItems) {</span>
<a href="#l54.91"></a><span id="l54.91">         // XXX prompt when finding a duplicate.</span>
<a href="#l54.92"></a><span id="l54.92">         try {</span>
<a href="#l54.93"></a><span id="l54.93" class="difflineat">@@ -215,25 +216,25 @@ function saveEventsToFile(calendarEventA</span>
<a href="#l54.94"></a><span id="l54.94"> </span>
<a href="#l54.95"></a><span id="l54.95">     // Show the 'Save As' dialog and ask for a filename to save to</span>
<a href="#l54.96"></a><span id="l54.96">     const nsIFilePicker = Components.interfaces.nsIFilePicker;</span>
<a href="#l54.97"></a><span id="l54.97"> </span>
<a href="#l54.98"></a><span id="l54.98">     let picker = Components.classes[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l54.99"></a><span id="l54.99">                        .createInstance(nsIFilePicker);</span>
<a href="#l54.100"></a><span id="l54.100"> </span>
<a href="#l54.101"></a><span id="l54.101">     picker.init(window,</span>
<a href="#l54.102"></a><span id="l54.102" class="difflineminus">-                calGetString(&quot;calendar&quot;, &quot;filepickerTitleExport&quot;),</span>
<a href="#l54.103"></a><span id="l54.103" class="difflineplus">+                cal.calGetString(&quot;calendar&quot;, &quot;filepickerTitleExport&quot;),</span>
<a href="#l54.104"></a><span id="l54.104">                 nsIFilePicker.modeSave);</span>
<a href="#l54.105"></a><span id="l54.105"> </span>
<a href="#l54.106"></a><span id="l54.106">     if (aDefaultFileName &amp;&amp; aDefaultFileName.length &amp;&amp; aDefaultFileName.length &gt; 0) {</span>
<a href="#l54.107"></a><span id="l54.107">         picker.defaultString = aDefaultFileName;</span>
<a href="#l54.108"></a><span id="l54.108">     } else if (calendarEventArray.length == 1 &amp;&amp; calendarEventArray[0].title) {</span>
<a href="#l54.109"></a><span id="l54.109">         picker.defaultString = calendarEventArray[0].title;</span>
<a href="#l54.110"></a><span id="l54.110">     } else {</span>
<a href="#l54.111"></a><span id="l54.111" class="difflineminus">-        picker.defaultString = calGetString(&quot;calendar&quot;, &quot;defaultFileName&quot;);</span>
<a href="#l54.112"></a><span id="l54.112" class="difflineplus">+        picker.defaultString = cal.calGetString(&quot;calendar&quot;, &quot;defaultFileName&quot;);</span>
<a href="#l54.113"></a><span id="l54.113">     }</span>
<a href="#l54.114"></a><span id="l54.114"> </span>
<a href="#l54.115"></a><span id="l54.115">     picker.defaultExtension = &quot;ics&quot;;</span>
<a href="#l54.116"></a><span id="l54.116"> </span>
<a href="#l54.117"></a><span id="l54.117">     // Get a list of exporters</span>
<a href="#l54.118"></a><span id="l54.118">     let contractids = [];</span>
<a href="#l54.119"></a><span id="l54.119">     let catman = Components.classes[&quot;@mozilla.org/categorymanager;1&quot;]</span>
<a href="#l54.120"></a><span id="l54.120">                            .getService(Components.interfaces.nsICategoryManager);</span>
<a href="#l54.121"></a><span id="l54.121" class="difflineat">@@ -301,17 +302,17 @@ function saveEventsToFile(calendarEventA</span>
<a href="#l54.122"></a><span id="l54.122">             // XXX Do the right thing with unicode and stuff. Or, again, should the</span>
<a href="#l54.123"></a><span id="l54.123">             //     exporter handle that?</span>
<a href="#l54.124"></a><span id="l54.124">             exporter.exportToStream(outputStream,</span>
<a href="#l54.125"></a><span id="l54.125">                                     calendarEventArray.length,</span>
<a href="#l54.126"></a><span id="l54.126">                                     calendarEventArray,</span>
<a href="#l54.127"></a><span id="l54.127">                                     null);</span>
<a href="#l54.128"></a><span id="l54.128">             outputStream.close();</span>
<a href="#l54.129"></a><span id="l54.129">         } catch (ex) {</span>
<a href="#l54.130"></a><span id="l54.130" class="difflineminus">-            cal.showError(calGetString(&quot;calendar&quot;, &quot;unableToWrite&quot;) + filePath, window);</span>
<a href="#l54.131"></a><span id="l54.131" class="difflineplus">+            cal.showError(cal.calGetString(&quot;calendar&quot;, &quot;unableToWrite&quot;) + filePath, window);</span>
<a href="#l54.132"></a><span id="l54.132">         }</span>
<a href="#l54.133"></a><span id="l54.133">     }</span>
<a href="#l54.134"></a><span id="l54.134"> }</span>
<a href="#l54.135"></a><span id="l54.135"> </span>
<a href="#l54.136"></a><span id="l54.136"> /**</span>
<a href="#l54.137"></a><span id="l54.137">  * Exports all the events and tasks in a calendar.  If aCalendar is not specified,</span>
<a href="#l54.138"></a><span id="l54.138">  * the user will be prompted with a list of calendars to choose which one to export.</span>
<a href="#l54.139"></a><span id="l54.139">  *</span>
<a href="#l54.140"></a><span id="l54.140" class="difflineat">@@ -335,24 +336,24 @@ function exportEntireCalendar(aCalendar)</span>
<a href="#l54.141"></a><span id="l54.141">         aCal.getItems(Components.interfaces.calICalendar.ITEM_FILTER_ALL_ITEMS,</span>
<a href="#l54.142"></a><span id="l54.142">                       0, null, null, getListener);</span>
<a href="#l54.143"></a><span id="l54.143">     };</span>
<a href="#l54.144"></a><span id="l54.144"> </span>
<a href="#l54.145"></a><span id="l54.145">     if (aCalendar) {</span>
<a href="#l54.146"></a><span id="l54.146">         getItemsFromCal(aCalendar);</span>
<a href="#l54.147"></a><span id="l54.147">     } else {</span>
<a href="#l54.148"></a><span id="l54.148">         let count = {};</span>
<a href="#l54.149"></a><span id="l54.149" class="difflineminus">-        let calendars = getCalendarManager().getCalendars(count);</span>
<a href="#l54.150"></a><span id="l54.150" class="difflineplus">+        let calendars = cal.getCalendarManager().getCalendars(count);</span>
<a href="#l54.151"></a><span id="l54.151"> </span>
<a href="#l54.152"></a><span id="l54.152">         if (count.value == 1) {</span>
<a href="#l54.153"></a><span id="l54.153">             // There's only one calendar, so it's silly to ask what calendar</span>
<a href="#l54.154"></a><span id="l54.154">             // the user wants to import into.</span>
<a href="#l54.155"></a><span id="l54.155">             getItemsFromCal(calendars[0]);</span>
<a href="#l54.156"></a><span id="l54.156">         } else {</span>
<a href="#l54.157"></a><span id="l54.157">             // Ask what calendar to import into</span>
<a href="#l54.158"></a><span id="l54.158">             let args = {};</span>
<a href="#l54.159"></a><span id="l54.159">             args.onOk = getItemsFromCal;</span>
<a href="#l54.160"></a><span id="l54.160" class="difflineminus">-            args.promptText = calGetString(&quot;calendar&quot;, &quot;exportPrompt&quot;);</span>
<a href="#l54.161"></a><span id="l54.161" class="difflineplus">+            args.promptText = cal.calGetString(&quot;calendar&quot;, &quot;exportPrompt&quot;);</span>
<a href="#l54.162"></a><span id="l54.162">             openDialog(&quot;chrome://calendar/content/chooseCalendarDialog.xul&quot;,</span>
<a href="#l54.163"></a><span id="l54.163">                        &quot;_blank&quot;, &quot;chrome,titlebar,modal,resizable&quot;, args);</span>
<a href="#l54.164"></a><span id="l54.164">         }</span>
<a href="#l54.165"></a><span id="l54.165">     }</span>
<a href="#l54.166"></a><span id="l54.166"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l55.1"></a><span id="l55.1" class="difflineminus">--- a/calendar/base/content/preferences/categories.js</span>
<a href="#l55.2"></a><span id="l55.2" class="difflineplus">+++ b/calendar/base/content/preferences/categories.js</span>
<a href="#l55.3"></a><span id="l55.3" class="difflineat">@@ -46,17 +46,17 @@ var gCategoriesPane = {</span>
<a href="#l55.4"></a><span id="l55.4">         let categories = document.getElementById(&quot;calendar.categories.names&quot;).value;</span>
<a href="#l55.5"></a><span id="l55.5"> </span>
<a href="#l55.6"></a><span id="l55.6">         // If no categories are configured load a default set from properties file</span>
<a href="#l55.7"></a><span id="l55.7">         if (!categories) {</span>
<a href="#l55.8"></a><span id="l55.8">             categories = cal.setupDefaultCategories();</span>
<a href="#l55.9"></a><span id="l55.9">             document.getElementById(&quot;calendar.categories.names&quot;).value = categories;</span>
<a href="#l55.10"></a><span id="l55.10">         }</span>
<a href="#l55.11"></a><span id="l55.11"> </span>
<a href="#l55.12"></a><span id="l55.12" class="difflineminus">-        gCategoryList = categoriesStringToArray(categories);</span>
<a href="#l55.13"></a><span id="l55.13" class="difflineplus">+        gCategoryList = cal.categoriesStringToArray(categories);</span>
<a href="#l55.14"></a><span id="l55.14"> </span>
<a href="#l55.15"></a><span id="l55.15">         // When categories is empty, split returns an array containing one empty</span>
<a href="#l55.16"></a><span id="l55.16">         // string, rather than an empty array. This results in an empty listbox</span>
<a href="#l55.17"></a><span id="l55.17">         // child with no corresponding category.</span>
<a href="#l55.18"></a><span id="l55.18">         if (gCategoryList.length == 1 &amp;&amp; !gCategoryList[0].length) {</span>
<a href="#l55.19"></a><span id="l55.19">             gCategoryList.pop();</span>
<a href="#l55.20"></a><span id="l55.20">         }</span>
<a href="#l55.21"></a><span id="l55.21"> </span>
<a href="#l55.22"></a><span id="l55.22" class="difflineat">@@ -83,17 +83,17 @@ var gCategoriesPane = {</span>
<a href="#l55.23"></a><span id="l55.23">     /**</span>
<a href="#l55.24"></a><span id="l55.24">      * Updates the listbox containing the categories from the categories saved</span>
<a href="#l55.25"></a><span id="l55.25">      * in preferences.</span>
<a href="#l55.26"></a><span id="l55.26">      */</span>
<a href="#l55.27"></a><span id="l55.27"> </span>
<a href="#l55.28"></a><span id="l55.28">     updatePrefs: function() {</span>
<a href="#l55.29"></a><span id="l55.29">         cal.sortArrayByLocaleCollator(gCategoryList);</span>
<a href="#l55.30"></a><span id="l55.30">         document.getElementById(&quot;calendar.categories.names&quot;).value =</span>
<a href="#l55.31"></a><span id="l55.31" class="difflineminus">-            categoriesArrayToString(gCategoryList);</span>
<a href="#l55.32"></a><span id="l55.32" class="difflineplus">+            cal.categoriesArrayToString(gCategoryList);</span>
<a href="#l55.33"></a><span id="l55.33">     },</span>
<a href="#l55.34"></a><span id="l55.34"> </span>
<a href="#l55.35"></a><span id="l55.35">     updateCategoryList: function() {</span>
<a href="#l55.36"></a><span id="l55.36">         this.updatePrefs();</span>
<a href="#l55.37"></a><span id="l55.37">         let listbox = document.getElementById(&quot;categorieslist&quot;);</span>
<a href="#l55.38"></a><span id="l55.38"> </span>
<a href="#l55.39"></a><span id="l55.39">         listbox.clearSelection();</span>
<a href="#l55.40"></a><span id="l55.40">         this.updateButtons();</span>
<a href="#l55.41"></a><span id="l55.41" class="difflineat">@@ -103,17 +103,17 @@ var gCategoriesPane = {</span>
<a href="#l55.42"></a><span id="l55.42">             listbox.lastChild.remove();</span>
<a href="#l55.43"></a><span id="l55.43">         }</span>
<a href="#l55.44"></a><span id="l55.44"> </span>
<a href="#l55.45"></a><span id="l55.45">         for (let i = 0; i &lt; gCategoryList.length; i++) {</span>
<a href="#l55.46"></a><span id="l55.46">             let newListItem = document.createElement(&quot;listitem&quot;);</span>
<a href="#l55.47"></a><span id="l55.47">             let categoryName = document.createElement(&quot;listcell&quot;);</span>
<a href="#l55.48"></a><span id="l55.48">             categoryName.setAttribute(&quot;id&quot;, gCategoryList[i]);</span>
<a href="#l55.49"></a><span id="l55.49">             categoryName.setAttribute(&quot;label&quot;, gCategoryList[i]);</span>
<a href="#l55.50"></a><span id="l55.50" class="difflineminus">-            let categoryNameFix = formatStringForCSSRule(gCategoryList[i]);</span>
<a href="#l55.51"></a><span id="l55.51" class="difflineplus">+            let categoryNameFix = cal.formatStringForCSSRule(gCategoryList[i]);</span>
<a href="#l55.52"></a><span id="l55.52">             let categoryColor = document.createElement(&quot;listcell&quot;);</span>
<a href="#l55.53"></a><span id="l55.53">             try {</span>
<a href="#l55.54"></a><span id="l55.54">                 let colorCode = categoryPrefBranch.getCharPref(categoryNameFix);</span>
<a href="#l55.55"></a><span id="l55.55">                 categoryColor.setAttribute(&quot;id&quot;, colorCode);</span>
<a href="#l55.56"></a><span id="l55.56">                 categoryColor.setAttribute(&quot;style&quot;, &quot;background-color: &quot; + colorCode + &quot;;&quot;);</span>
<a href="#l55.57"></a><span id="l55.57">             } catch (ex) {</span>
<a href="#l55.58"></a><span id="l55.58">                 categoryColor.setAttribute(&quot;label&quot;, noneLabel);</span>
<a href="#l55.59"></a><span id="l55.59">             }</span>
<a href="#l55.60"></a><span id="l55.60" class="difflineat">@@ -144,17 +144,17 @@ var gCategoriesPane = {</span>
<a href="#l55.61"></a><span id="l55.61">         }</span>
<a href="#l55.62"></a><span id="l55.62">     },</span>
<a href="#l55.63"></a><span id="l55.63"> </span>
<a href="#l55.64"></a><span id="l55.64">     /**</span>
<a href="#l55.65"></a><span id="l55.65">      * Edits the currently selected category using the edit category dialog.</span>
<a href="#l55.66"></a><span id="l55.66">      */</span>
<a href="#l55.67"></a><span id="l55.67">     editCategory: function() {</span>
<a href="#l55.68"></a><span id="l55.68">         let list = document.getElementById(&quot;categorieslist&quot;);</span>
<a href="#l55.69"></a><span id="l55.69" class="difflineminus">-        let categoryNameFix = formatStringForCSSRule(gCategoryList[list.selectedIndex]);</span>
<a href="#l55.70"></a><span id="l55.70" class="difflineplus">+        let categoryNameFix = cal.formatStringForCSSRule(gCategoryList[list.selectedIndex]);</span>
<a href="#l55.71"></a><span id="l55.71">         let currentColor = null;</span>
<a href="#l55.72"></a><span id="l55.72">         try {</span>
<a href="#l55.73"></a><span id="l55.73">             currentColor = categoryPrefBranch.getCharPref(categoryNameFix);</span>
<a href="#l55.74"></a><span id="l55.74">         } catch (ex) {</span>
<a href="#l55.75"></a><span id="l55.75">             // If the pref doesn't exist, don't bail out here.</span>
<a href="#l55.76"></a><span id="l55.76">         }</span>
<a href="#l55.77"></a><span id="l55.77">         let params = {</span>
<a href="#l55.78"></a><span id="l55.78">             title: editTitle,</span>
<a href="#l55.79"></a><span id="l55.79" class="difflineat">@@ -174,17 +174,17 @@ var gCategoriesPane = {</span>
<a href="#l55.80"></a><span id="l55.80">      * Removes the selected category.</span>
<a href="#l55.81"></a><span id="l55.81">      */</span>
<a href="#l55.82"></a><span id="l55.82">     deleteCategory: function() {</span>
<a href="#l55.83"></a><span id="l55.83">         let list = document.getElementById(&quot;categorieslist&quot;);</span>
<a href="#l55.84"></a><span id="l55.84">         if (list.selectedCount &lt; 1) {</span>
<a href="#l55.85"></a><span id="l55.85">             return;</span>
<a href="#l55.86"></a><span id="l55.86">         }</span>
<a href="#l55.87"></a><span id="l55.87"> </span>
<a href="#l55.88"></a><span id="l55.88" class="difflineminus">-        let categoryNameFix = formatStringForCSSRule(gCategoryList[list.selectedIndex]);</span>
<a href="#l55.89"></a><span id="l55.89" class="difflineplus">+        let categoryNameFix = cal.formatStringForCSSRule(gCategoryList[list.selectedIndex]);</span>
<a href="#l55.90"></a><span id="l55.90">         this.backupData(categoryNameFix);</span>
<a href="#l55.91"></a><span id="l55.91">         try {</span>
<a href="#l55.92"></a><span id="l55.92">             categoryPrefBranch.clearUserPref(categoryNameFix);</span>
<a href="#l55.93"></a><span id="l55.93">         } catch (ex) {</span>
<a href="#l55.94"></a><span id="l55.94">             // If the pref doesn't exist, don't bail out here.</span>
<a href="#l55.95"></a><span id="l55.95">         }</span>
<a href="#l55.96"></a><span id="l55.96"> </span>
<a href="#l55.97"></a><span id="l55.97">         // Remove category entry from listbox and gCategoryList.</span>
<a href="#l55.98"></a><span id="l55.98" class="difflineat">@@ -235,17 +235,17 @@ var gCategoriesPane = {</span>
<a href="#l55.99"></a><span id="l55.99">             }</span>
<a href="#l55.100"></a><span id="l55.100">         }</span>
<a href="#l55.101"></a><span id="l55.101"> </span>
<a href="#l55.102"></a><span id="l55.102">         if (categoryName.length == 0) {</span>
<a href="#l55.103"></a><span id="l55.103">             Services.prompt.alert(null, null, noBlankCategories);</span>
<a href="#l55.104"></a><span id="l55.104">             return;</span>
<a href="#l55.105"></a><span id="l55.105">         }</span>
<a href="#l55.106"></a><span id="l55.106"> </span>
<a href="#l55.107"></a><span id="l55.107" class="difflineminus">-        let categoryNameFix = formatStringForCSSRule(categoryName);</span>
<a href="#l55.108"></a><span id="l55.108" class="difflineplus">+        let categoryNameFix = cal.formatStringForCSSRule(categoryName);</span>
<a href="#l55.109"></a><span id="l55.109">         if (list.selectedIndex == -1) {</span>
<a href="#l55.110"></a><span id="l55.110">             this.backupData(categoryNameFix);</span>
<a href="#l55.111"></a><span id="l55.111">             gCategoryList.push(categoryName);</span>
<a href="#l55.112"></a><span id="l55.112">             if (categoryColor) {</span>
<a href="#l55.113"></a><span id="l55.113">                 categoryPrefBranch.setCharPref(categoryNameFix, categoryColor);</span>
<a href="#l55.114"></a><span id="l55.114">             }</span>
<a href="#l55.115"></a><span id="l55.115">         } else {</span>
<a href="#l55.116"></a><span id="l55.116">             this.backupData(categoryNameFix);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l56.1"></a><span id="l56.1" class="difflineminus">--- a/calendar/base/content/preferences/general.js</span>
<a href="#l56.2"></a><span id="l56.2" class="difflineplus">+++ b/calendar/base/content/preferences/general.js</span>
<a href="#l56.3"></a><span id="l56.3" class="difflineat">@@ -13,18 +13,18 @@ var gCalendarGeneralPane = {</span>
<a href="#l56.4"></a><span id="l56.4">     /**</span>
<a href="#l56.5"></a><span id="l56.5">      * Initialize the general pref pane. Sets up dialog controls to match the</span>
<a href="#l56.6"></a><span id="l56.6">      * values set in prefs.</span>
<a href="#l56.7"></a><span id="l56.7">      */</span>
<a href="#l56.8"></a><span id="l56.8">     init: function() {</span>
<a href="#l56.9"></a><span id="l56.9">         let formatter = Components.classes[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;]</span>
<a href="#l56.10"></a><span id="l56.10">                                   .getService(Components.interfaces.calIDateTimeFormatter);</span>
<a href="#l56.11"></a><span id="l56.11"> </span>
<a href="#l56.12"></a><span id="l56.12" class="difflineminus">-        let dateFormattedLong = formatter.formatDateLong(now());</span>
<a href="#l56.13"></a><span id="l56.13" class="difflineminus">-        let dateFormattedShort = formatter.formatDateShort(now());</span>
<a href="#l56.14"></a><span id="l56.14" class="difflineplus">+        let dateFormattedLong = formatter.formatDateLong(cal.now());</span>
<a href="#l56.15"></a><span id="l56.15" class="difflineplus">+        let dateFormattedShort = formatter.formatDateShort(cal.now());</span>
<a href="#l56.16"></a><span id="l56.16"> </span>
<a href="#l56.17"></a><span id="l56.17">         // menu items include examples of current date formats.</span>
<a href="#l56.18"></a><span id="l56.18">         document.getElementById(&quot;dateformat-long-menuitem&quot;)</span>
<a href="#l56.19"></a><span id="l56.19">                 .setAttribute(&quot;label&quot;, labelLong + &quot;: &quot; + dateFormattedLong);</span>
<a href="#l56.20"></a><span id="l56.20">         document.getElementById(&quot;dateformat-short-menuitem&quot;)</span>
<a href="#l56.21"></a><span id="l56.21">                 .setAttribute(&quot;label&quot;, labelShort + &quot;: &quot; + dateFormattedShort);</span>
<a href="#l56.22"></a><span id="l56.22"> </span>
<a href="#l56.23"></a><span id="l56.23">         // deselect and reselect to update visible item title</span>
<a href="#l56.24"></a><span id="l56.24" class="difflineat">@@ -51,17 +51,17 @@ var gCalendarGeneralPane = {</span>
<a href="#l56.25"></a><span id="l56.25">         // the display names need to be sorted</span>
<a href="#l56.26"></a><span id="l56.26">         displayNames.sort((a, b) =&gt; a.localeCompare(b));</span>
<a href="#l56.27"></a><span id="l56.27">         for (let displayName of displayNames) {</span>
<a href="#l56.28"></a><span id="l56.28">             addMenuItem(tzMenuPopup, displayName, tzids[displayName]);</span>
<a href="#l56.29"></a><span id="l56.29">         }</span>
<a href="#l56.30"></a><span id="l56.30"> </span>
<a href="#l56.31"></a><span id="l56.31">         let prefValue = document.getElementById(&quot;calendar-timezone-local&quot;).value;</span>
<a href="#l56.32"></a><span id="l56.32">         if (!prefValue) {</span>
<a href="#l56.33"></a><span id="l56.33" class="difflineminus">-            prefValue = calendarDefaultTimezone().tzid;</span>
<a href="#l56.34"></a><span id="l56.34" class="difflineplus">+            prefValue = cal.calendarDefaultTimezone().tzid;</span>
<a href="#l56.35"></a><span id="l56.35">         }</span>
<a href="#l56.36"></a><span id="l56.36">         tzMenuList.value = prefValue;</span>
<a href="#l56.37"></a><span id="l56.37"> </span>
<a href="#l56.38"></a><span id="l56.38">         // Set the soondays menulist preference</span>
<a href="#l56.39"></a><span id="l56.39">         this.initializeTodaypaneMenu();</span>
<a href="#l56.40"></a><span id="l56.40">     },</span>
<a href="#l56.41"></a><span id="l56.41"> </span>
<a href="#l56.42"></a><span id="l56.42">     updateDefaultTodoDates: function() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l57.1"></a><span id="l57.1" class="difflineminus">--- a/calendar/base/content/preferences/general.xul</span>
<a href="#l57.2"></a><span id="l57.2" class="difflineplus">+++ b/calendar/base/content/preferences/general.xul</span>
<a href="#l57.3"></a><span id="l57.3" class="difflineat">@@ -15,18 +15,16 @@</span>
<a href="#l57.4"></a><span id="l57.4"> &lt;overlay id=&quot;CalendarGeneralPaneOverlay&quot;</span>
<a href="#l57.5"></a><span id="l57.5">          xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;&gt;</span>
<a href="#l57.6"></a><span id="l57.6"> </span>
<a href="#l57.7"></a><span id="l57.7">     &lt;vbox id=&quot;calPreferencesBoxGeneral&quot;&gt;</span>
<a href="#l57.8"></a><span id="l57.8">         &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l57.9"></a><span id="l57.9">                 src=&quot;chrome://calendar/content/preferences/general.js&quot;/&gt;</span>
<a href="#l57.10"></a><span id="l57.10">         &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l57.11"></a><span id="l57.11">                 src=&quot;chrome://calendar/content/calendar-ui-utils.js&quot;/&gt;</span>
<a href="#l57.12"></a><span id="l57.12" class="difflineminus">-        &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l57.13"></a><span id="l57.13" class="difflineminus">-                src=&quot;chrome://calendar/content/calUtils.js&quot;/&gt;</span>
<a href="#l57.14"></a><span id="l57.14"> </span>
<a href="#l57.15"></a><span id="l57.15">         &lt;!-- Get the localized text for use in the .js --&gt;</span>
<a href="#l57.16"></a><span id="l57.16">         &lt;script type=&quot;application/javascript&quot;&gt;</span>
<a href="#l57.17"></a><span id="l57.17">             var labelLong  = &quot;&amp;pref.dateformat.long;&quot;;</span>
<a href="#l57.18"></a><span id="l57.18">             var labelShort = &quot;&amp;pref.dateformat.short;&quot;;</span>
<a href="#l57.19"></a><span id="l57.19">         &lt;/script&gt;</span>
<a href="#l57.20"></a><span id="l57.20"> </span>
<a href="#l57.21"></a><span id="l57.21">         &lt;preferences&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l58.1"></a><span id="l58.1" class="difflineminus">--- a/calendar/base/content/today-pane.xul</span>
<a href="#l58.2"></a><span id="l58.2" class="difflineplus">+++ b/calendar/base/content/today-pane.xul</span>
<a href="#l58.3"></a><span id="l58.3" class="difflineat">@@ -110,17 +110,17 @@</span>
<a href="#l58.4"></a><span id="l58.4">                           &lt;toolbarbutton id=&quot;previous-day-button&quot;</span>
<a href="#l58.5"></a><span id="l58.5">                                          class=&quot;miniday-nav-buttons&quot;</span>
<a href="#l58.6"></a><span id="l58.6">                                          tooltiptext=&quot;&amp;onedaybackward.tooltip;&quot;</span>
<a href="#l58.7"></a><span id="l58.7">                                          onmousedown=&quot;TodayPane.onMousedown(event, parseInt(this.getAttribute('dir')));&quot;</span>
<a href="#l58.8"></a><span id="l58.8">                                          dir=&quot;-1&quot;/&gt;</span>
<a href="#l58.9"></a><span id="l58.9">                           &lt;toolbarbutton id=&quot;today-button&quot;</span>
<a href="#l58.10"></a><span id="l58.10">                                          class=&quot;miniday-nav-buttons&quot;</span>
<a href="#l58.11"></a><span id="l58.11">                                          tooltiptext=&quot;&amp;showToday.tooltip;&quot;</span>
<a href="#l58.12"></a><span id="l58.12" class="difflineminus">-                                         oncommand=&quot;TodayPane.setDay(now());&quot;/&gt;</span>
<a href="#l58.13"></a><span id="l58.13" class="difflineplus">+                                         oncommand=&quot;TodayPane.setDay(cal.now());&quot;/&gt;</span>
<a href="#l58.14"></a><span id="l58.14">                           &lt;toolbarbutton id=&quot;next-day-button&quot;</span>
<a href="#l58.15"></a><span id="l58.15">                                          class=&quot;miniday-nav-buttons&quot;</span>
<a href="#l58.16"></a><span id="l58.16">                                          tooltiptext=&quot;&amp;onedayforward.tooltip;&quot;</span>
<a href="#l58.17"></a><span id="l58.17">                                          onmousedown=&quot;TodayPane.onMousedown(event, parseInt(this.getAttribute('dir')));&quot;</span>
<a href="#l58.18"></a><span id="l58.18">                                          dir=&quot;1&quot;/&gt;</span>
<a href="#l58.19"></a><span id="l58.19">                         &lt;/hbox&gt;</span>
<a href="#l58.20"></a><span id="l58.20">                       &lt;/hbox&gt;</span>
<a href="#l58.21"></a><span id="l58.21">                       &lt;hbox pack=&quot;start&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l59.1"></a><span id="l59.1" class="difflineminus">--- a/calendar/base/content/widgets/calendar-alarm-widget.xml</span>
<a href="#l59.2"></a><span id="l59.2" class="difflineplus">+++ b/calendar/base/content/widgets/calendar-alarm-widget.xml</span>
<a href="#l59.3"></a><span id="l59.3" class="difflineat">@@ -87,19 +87,19 @@</span>
<a href="#l59.4"></a><span id="l59.4">           // Dates</span>
<a href="#l59.5"></a><span id="l59.5">           if (cal.isEvent(this.mItem)) {</span>
<a href="#l59.6"></a><span id="l59.6">               dateLabel.textContent = formatter.formatItemInterval(this.mItem);</span>
<a href="#l59.7"></a><span id="l59.7">           } else if (cal.isToDo(this.mItem)) {</span>
<a href="#l59.8"></a><span id="l59.8">               let startDate = this.mItem.entryDate || this.mItem.dueDate;</span>
<a href="#l59.9"></a><span id="l59.9">               if (startDate) {</span>
<a href="#l59.10"></a><span id="l59.10">                   // A Task with a start or due date, show with label</span>
<a href="#l59.11"></a><span id="l59.11">                   startDate = startDate.getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l59.12"></a><span id="l59.12" class="difflineminus">-                  dateLabel.textContent = calGetString(&quot;calendar&quot;,</span>
<a href="#l59.13"></a><span id="l59.13" class="difflineminus">-                                                       &quot;alarmStarts&quot;,</span>
<a href="#l59.14"></a><span id="l59.14" class="difflineminus">-                                                       [formatter.formatDateTime(startDate)]);</span>
<a href="#l59.15"></a><span id="l59.15" class="difflineplus">+                  dateLabel.textContent = cal.calGetString(&quot;calendar&quot;,</span>
<a href="#l59.16"></a><span id="l59.16" class="difflineplus">+                                                           &quot;alarmStarts&quot;,</span>
<a href="#l59.17"></a><span id="l59.17" class="difflineplus">+                                                           [formatter.formatDateTime(startDate)]);</span>
<a href="#l59.18"></a><span id="l59.18">               } else {</span>
<a href="#l59.19"></a><span id="l59.19">                   // If the task has no start date, then format the alarm date.</span>
<a href="#l59.20"></a><span id="l59.20">                   dateLabel.textContent = formatter.formatDateTime(this.mAlarm.alarmDate);</span>
<a href="#l59.21"></a><span id="l59.21">               }</span>
<a href="#l59.22"></a><span id="l59.22">           } else {</span>
<a href="#l59.23"></a><span id="l59.23">               throw Components.results.NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l59.24"></a><span id="l59.24">           }</span>
<a href="#l59.25"></a><span id="l59.25"> </span>
<a href="#l59.26"></a><span id="l59.26" class="difflineat">@@ -117,43 +117,43 @@</span>
<a href="#l59.27"></a><span id="l59.27">       &lt;/method&gt;</span>
<a href="#l59.28"></a><span id="l59.28"> </span>
<a href="#l59.29"></a><span id="l59.29">       &lt;method name=&quot;updateRelativeDateLabel&quot;&gt;</span>
<a href="#l59.30"></a><span id="l59.30">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l59.31"></a><span id="l59.31">           let formatter = cal.getDateFormatter();</span>
<a href="#l59.32"></a><span id="l59.32">           let item = this.mItem;</span>
<a href="#l59.33"></a><span id="l59.33">           let relativeDateLabel = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;alarm-relative-date-label&quot;);</span>
<a href="#l59.34"></a><span id="l59.34">           let relativeDateString;</span>
<a href="#l59.35"></a><span id="l59.35" class="difflineminus">-          let startDate = item[calGetStartDateProp(item)] || item[calGetEndDateProp(item)];</span>
<a href="#l59.36"></a><span id="l59.36" class="difflineplus">+          let startDate = item[cal.calGetStartDateProp(item)] || item[cal.calGetEndDateProp(item)];</span>
<a href="#l59.37"></a><span id="l59.37">           if (startDate) {</span>
<a href="#l59.38"></a><span id="l59.38" class="difflineminus">-              startDate = startDate.getInTimezone(calendarDefaultTimezone());</span>
<a href="#l59.39"></a><span id="l59.39" class="difflineminus">-              let currentDate = now();</span>
<a href="#l59.40"></a><span id="l59.40" class="difflineplus">+              startDate = startDate.getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l59.41"></a><span id="l59.41" class="difflineplus">+              let currentDate = cal.now();</span>
<a href="#l59.42"></a><span id="l59.42">               let sinceDayStart = (currentDate.hour * 3600) + (currentDate.minute * 60);</span>
<a href="#l59.43"></a><span id="l59.43"> </span>
<a href="#l59.44"></a><span id="l59.44">               currentDate.second = 0;</span>
<a href="#l59.45"></a><span id="l59.45">               startDate.second = 0;</span>
<a href="#l59.46"></a><span id="l59.46"> </span>
<a href="#l59.47"></a><span id="l59.47">               let sinceAlarm = currentDate.subtractDate(startDate).inSeconds;</span>
<a href="#l59.48"></a><span id="l59.48">               this.mAlarmToday = (sinceAlarm &lt; sinceDayStart) &amp;&amp; (sinceAlarm &gt; sinceDayStart - 86400);</span>
<a href="#l59.49"></a><span id="l59.49"> </span>
<a href="#l59.50"></a><span id="l59.50">               if (this.mAlarmToday) {</span>
<a href="#l59.51"></a><span id="l59.51">                   // The alarm is today</span>
<a href="#l59.52"></a><span id="l59.52" class="difflineminus">-                  relativeDateString = calGetString(&quot;calendar&quot;,</span>
<a href="#l59.53"></a><span id="l59.53" class="difflineminus">-                                                    &quot;alarmTodayAt&quot;,</span>
<a href="#l59.54"></a><span id="l59.54" class="difflineminus">-                                                    [formatter.formatTime(startDate)]);</span>
<a href="#l59.55"></a><span id="l59.55" class="difflineplus">+                  relativeDateString = cal.calGetString(&quot;calendar&quot;,</span>
<a href="#l59.56"></a><span id="l59.56" class="difflineplus">+                                                        &quot;alarmTodayAt&quot;,</span>
<a href="#l59.57"></a><span id="l59.57" class="difflineplus">+                                                        [formatter.formatTime(startDate)]);</span>
<a href="#l59.58"></a><span id="l59.58">               } else if (sinceAlarm &lt;= sinceDayStart - 86400 &amp;&amp; sinceAlarm &gt; sinceDayStart - 172800) {</span>
<a href="#l59.59"></a><span id="l59.59">                   // The alarm is tomorrow</span>
<a href="#l59.60"></a><span id="l59.60" class="difflineminus">-                  relativeDateString = calGetString(&quot;calendar&quot;,</span>
<a href="#l59.61"></a><span id="l59.61" class="difflineminus">-                                                    &quot;alarmTomorrowAt&quot;,</span>
<a href="#l59.62"></a><span id="l59.62" class="difflineminus">-                                                    [formatter.formatTime(startDate)]);</span>
<a href="#l59.63"></a><span id="l59.63" class="difflineplus">+                  relativeDateString = cal.calGetString(&quot;calendar&quot;,</span>
<a href="#l59.64"></a><span id="l59.64" class="difflineplus">+                                                        &quot;alarmTomorrowAt&quot;,</span>
<a href="#l59.65"></a><span id="l59.65" class="difflineplus">+                                                        [formatter.formatTime(startDate)]);</span>
<a href="#l59.66"></a><span id="l59.66">               } else if (sinceAlarm &lt; sinceDayStart + 86400 &amp;&amp; sinceAlarm &gt; sinceDayStart) {</span>
<a href="#l59.67"></a><span id="l59.67">                   // The alarm is yesterday</span>
<a href="#l59.68"></a><span id="l59.68" class="difflineminus">-                  relativeDateString = calGetString(&quot;calendar&quot;,</span>
<a href="#l59.69"></a><span id="l59.69" class="difflineminus">-                                                    &quot;alarmYesterdayAt&quot;,</span>
<a href="#l59.70"></a><span id="l59.70" class="difflineminus">-                                                    [formatter.formatTime(startDate)]);</span>
<a href="#l59.71"></a><span id="l59.71" class="difflineplus">+                  relativeDateString = cal.calGetString(&quot;calendar&quot;,</span>
<a href="#l59.72"></a><span id="l59.72" class="difflineplus">+                                                        &quot;alarmYesterdayAt&quot;,</span>
<a href="#l59.73"></a><span id="l59.73" class="difflineplus">+                                                        [formatter.formatTime(startDate)]);</span>
<a href="#l59.74"></a><span id="l59.74">               } else {</span>
<a href="#l59.75"></a><span id="l59.75">                   // The alarm is way back</span>
<a href="#l59.76"></a><span id="l59.76">                   relativeDateString = [formatter.formatDateTime(startDate)];</span>
<a href="#l59.77"></a><span id="l59.77">               }</span>
<a href="#l59.78"></a><span id="l59.78">           } else {</span>
<a href="#l59.79"></a><span id="l59.79">               // No start or end date, therefore the alarm must be absolute and</span>
<a href="#l59.80"></a><span id="l59.80">               // have an alarm date.</span>
<a href="#l59.81"></a><span id="l59.81">               relativeDateString = [formatter.formatDateTime(this.mAlarm.alarmDate)];</span>
<a href="#l59.82"></a><span id="l59.82" class="difflineat">@@ -239,16 +239,17 @@</span>
<a href="#l59.83"></a><span id="l59.83">                            class=&quot;snooze-popup-button snooze-popup-cancel-button&quot;</span>
<a href="#l59.84"></a><span id="l59.84">                            aria-label=&quot;&amp;calendar.alarm.snooze.cancel;&quot;</span>
<a href="#l59.85"></a><span id="l59.85">                            oncommand=&quot;snoozeCancel()&quot;/&gt;</span>
<a href="#l59.86"></a><span id="l59.86">       &lt;/xul:hbox&gt;</span>
<a href="#l59.87"></a><span id="l59.87">     &lt;/content&gt;</span>
<a href="#l59.88"></a><span id="l59.88">     &lt;implementation&gt;</span>
<a href="#l59.89"></a><span id="l59.89">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l59.90"></a><span id="l59.90">         Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l59.91"></a><span id="l59.91" class="difflineplus">+        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l59.92"></a><span id="l59.92"> </span>
<a href="#l59.93"></a><span id="l59.93">         let snoozePref = Preferences.get(&quot;calendar.alarms.defaultsnoozelength&quot;, 0);</span>
<a href="#l59.94"></a><span id="l59.94">         if (snoozePref &lt;= 0) {</span>
<a href="#l59.95"></a><span id="l59.95">             snoozePref = 5;</span>
<a href="#l59.96"></a><span id="l59.96">         }</span>
<a href="#l59.97"></a><span id="l59.97"> </span>
<a href="#l59.98"></a><span id="l59.98">         let unitList = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;snooze-unit-menulist&quot;);</span>
<a href="#l59.99"></a><span id="l59.99">         let unitValue = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;snooze-value-textbox&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l60.1"></a><span id="l60.1" class="difflineminus">--- a/calendar/base/content/widgets/calendar-list-tree.xml</span>
<a href="#l60.2"></a><span id="l60.2" class="difflineplus">+++ b/calendar/base/content/widgets/calendar-list-tree.xml</span>
<a href="#l60.3"></a><span id="l60.3" class="difflineat">@@ -39,17 +39,17 @@</span>
<a href="#l60.4"></a><span id="l60.4">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l60.5"></a><span id="l60.5">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l60.6"></a><span id="l60.6">           this.mCompositeCalendar = val;</span>
<a href="#l60.7"></a><span id="l60.7">           this.mCompositeCalendar.addObserver(this.compositeObserver);</span>
<a href="#l60.8"></a><span id="l60.8"> </span>
<a href="#l60.9"></a><span id="l60.9">           // Now that we have a composite calendar, we can get all calendars</span>
<a href="#l60.10"></a><span id="l60.10">           // from the calendar manager.</span>
<a href="#l60.11"></a><span id="l60.11">           this.mAddingFromComposite = true;</span>
<a href="#l60.12"></a><span id="l60.12" class="difflineminus">-          let calendars = sortCalendarArray(getCalendarManager().getCalendars({}));</span>
<a href="#l60.13"></a><span id="l60.13" class="difflineplus">+          let calendars = sortCalendarArray(cal.getCalendarManager().getCalendars({}));</span>
<a href="#l60.14"></a><span id="l60.14">           calendars.forEach(this.addCalendar, this);</span>
<a href="#l60.15"></a><span id="l60.15">           this.mAddingFromComposite = false;</span>
<a href="#l60.16"></a><span id="l60.16"> </span>
<a href="#l60.17"></a><span id="l60.17">           return val;</span>
<a href="#l60.18"></a><span id="l60.18">         ]]&gt;&lt;/setter&gt;</span>
<a href="#l60.19"></a><span id="l60.19">       &lt;/property&gt;</span>
<a href="#l60.20"></a><span id="l60.20"> </span>
<a href="#l60.21"></a><span id="l60.21">       &lt;property name=&quot;calendars&quot;&gt;</span>
<a href="#l60.22"></a><span id="l60.22" class="difflineat">@@ -151,19 +151,19 @@</span>
<a href="#l60.23"></a><span id="l60.23">         let calendar = this.getCalendarFromEvent(event, col);</span>
<a href="#l60.24"></a><span id="l60.24">         if (event.button != 0 ||</span>
<a href="#l60.25"></a><span id="l60.25">             (col.value &amp;&amp; col.value.element &amp;&amp;</span>
<a href="#l60.26"></a><span id="l60.26">              col.value.element.getAttribute(&quot;anonid&quot;) == &quot;checkbox-treecol&quot;)) {</span>
<a href="#l60.27"></a><span id="l60.27">             // Only left clicks that are not on the checkbox column</span>
<a href="#l60.28"></a><span id="l60.28">             return;</span>
<a href="#l60.29"></a><span id="l60.29">         }</span>
<a href="#l60.30"></a><span id="l60.30">         if (calendar) {</span>
<a href="#l60.31"></a><span id="l60.31" class="difflineminus">-            openCalendarProperties(calendar);</span>
<a href="#l60.32"></a><span id="l60.32" class="difflineplus">+            cal.openCalendarProperties(window, calendar);</span>
<a href="#l60.33"></a><span id="l60.33">         } else {</span>
<a href="#l60.34"></a><span id="l60.34" class="difflineminus">-            openCalendarWizard();</span>
<a href="#l60.35"></a><span id="l60.35" class="difflineplus">+            cal.openCalendarWizard(window);</span>
<a href="#l60.36"></a><span id="l60.36">         }</span>
<a href="#l60.37"></a><span id="l60.37">       ]]&gt;&lt;/handler&gt;</span>
<a href="#l60.38"></a><span id="l60.38">     &lt;/handlers&gt;</span>
<a href="#l60.39"></a><span id="l60.39">   &lt;/binding&gt;</span>
<a href="#l60.40"></a><span id="l60.40"> </span>
<a href="#l60.41"></a><span id="l60.41">   &lt;binding id=&quot;calendar-list-tree&quot;&gt;</span>
<a href="#l60.42"></a><span id="l60.42">     &lt;content&gt;</span>
<a href="#l60.43"></a><span id="l60.43">       &lt;xul:tree anonid=&quot;tree&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l61.1"></a><span id="l61.1" class="difflineminus">--- a/calendar/base/content/widgets/calendar-widgets.xml</span>
<a href="#l61.2"></a><span id="l61.2" class="difflineplus">+++ b/calendar/base/content/widgets/calendar-widgets.xml</span>
<a href="#l61.3"></a><span id="l61.3" class="difflineat">@@ -41,16 +41,20 @@</span>
<a href="#l61.4"></a><span id="l61.4">                    class=&quot;categories-listbox&quot;</span>
<a href="#l61.5"></a><span id="l61.5">                    onselect=&quot;document.getBindingParent(this).selectCategory()&quot;</span>
<a href="#l61.6"></a><span id="l61.6">                    selType=&quot;multiple&quot;</span>
<a href="#l61.7"></a><span id="l61.7">                    &gt;</span>
<a href="#l61.8"></a><span id="l61.8">         &lt;children/&gt;</span>
<a href="#l61.9"></a><span id="l61.9">       &lt;/xul:listbox&gt;</span>
<a href="#l61.10"></a><span id="l61.10">     &lt;/content&gt;</span>
<a href="#l61.11"></a><span id="l61.11">     &lt;implementation&gt;</span>
<a href="#l61.12"></a><span id="l61.12" class="difflineplus">+      &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l61.13"></a><span id="l61.13" class="difflineplus">+        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l61.14"></a><span id="l61.14" class="difflineplus">+      ]]&gt;&lt;/constructor&gt;</span>
<a href="#l61.15"></a><span id="l61.15" class="difflineplus">+</span>
<a href="#l61.16"></a><span id="l61.16">       &lt;field name=&quot;_maxCount&quot;&gt;0&lt;/field&gt;</span>
<a href="#l61.17"></a><span id="l61.17"> </span>
<a href="#l61.18"></a><span id="l61.18">       &lt;property name=&quot;categories&quot; readonly=&quot;true&quot;&gt;</span>
<a href="#l61.19"></a><span id="l61.19">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l61.20"></a><span id="l61.20">           let categoryListbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;categories-listbox&quot;);</span>
<a href="#l61.21"></a><span id="l61.21">           if (this.maxCount == 1) {</span>
<a href="#l61.22"></a><span id="l61.22">               let selectedItem = categoryListbox.selectedItem;</span>
<a href="#l61.23"></a><span id="l61.23">               return selectedItem ? [selectedItem.getAttribute(&quot;value&quot;)] : [];</span>
<a href="#l61.24"></a><span id="l61.24" class="difflineat">@@ -175,17 +179,17 @@</span>
<a href="#l61.25"></a><span id="l61.25">           categoryListbox.ensureElementIsVisible(item);</span>
<a href="#l61.26"></a><span id="l61.26">         ]]&gt;&lt;/body&gt;</span>
<a href="#l61.27"></a><span id="l61.27">       &lt;/method&gt;</span>
<a href="#l61.28"></a><span id="l61.28"> </span>
<a href="#l61.29"></a><span id="l61.29">       &lt;method name=&quot;loadItem&quot;&gt;</span>
<a href="#l61.30"></a><span id="l61.30">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l61.31"></a><span id="l61.31">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l61.32"></a><span id="l61.32">           let categoryListbox = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;categories-listbox&quot;);</span>
<a href="#l61.33"></a><span id="l61.33" class="difflineminus">-          let categoryList = getPrefCategoriesArray();</span>
<a href="#l61.34"></a><span id="l61.34" class="difflineplus">+          let categoryList = cal.getPrefCategoriesArray();</span>
<a href="#l61.35"></a><span id="l61.35"> </span>
<a href="#l61.36"></a><span id="l61.36">           cal.sortArrayByLocaleCollator(categoryList);</span>
<a href="#l61.37"></a><span id="l61.37"> </span>
<a href="#l61.38"></a><span id="l61.38">           removeChildren(categoryListbox);</span>
<a href="#l61.39"></a><span id="l61.39"> </span>
<a href="#l61.40"></a><span id="l61.40">           for (let cat of categoryList) {</span>
<a href="#l61.41"></a><span id="l61.41">               // First insert all categories from the prefs</span>
<a href="#l61.42"></a><span id="l61.42">               let item = categoryListbox.appendItem(cat, cat);</span>
<a href="#l61.43"></a><span id="l61.43" class="difflineat">@@ -229,22 +233,23 @@</span>
<a href="#l61.44"></a><span id="l61.44">       &lt;/xul:stack&gt;</span>
<a href="#l61.45"></a><span id="l61.45">       &lt;xul:label class=&quot;toolbarbutton-text&quot; crop=&quot;right&quot; flex=&quot;1&quot;</span>
<a href="#l61.46"></a><span id="l61.46">                  xbl:inherits=&quot;value=label,accesskey,crop,toolbarmode,buttonstyle&quot;/&gt;</span>
<a href="#l61.47"></a><span id="l61.47">       &lt;xul:image class=&quot;toolbarbutton-icon-end&quot; xbl:inherits=&quot;validate,src-end=image,toolbarmode,buttonstyle&quot;/&gt;</span>
<a href="#l61.48"></a><span id="l61.48">     &lt;/content&gt;</span>
<a href="#l61.49"></a><span id="l61.49"> </span>
<a href="#l61.50"></a><span id="l61.50">     &lt;implementation&gt;</span>
<a href="#l61.51"></a><span id="l61.51">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l61.52"></a><span id="l61.52" class="difflineplus">+        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l61.53"></a><span id="l61.53">         this.setUpTodayDate();</span>
<a href="#l61.54"></a><span id="l61.54">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l61.55"></a><span id="l61.55"> </span>
<a href="#l61.56"></a><span id="l61.56">       &lt;method name=&quot;setUpTodayDate&quot;&gt;</span>
<a href="#l61.57"></a><span id="l61.57">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l61.58"></a><span id="l61.58" class="difflineminus">-          let dayNumber = calGetString(&quot;dateFormat&quot;, &quot;day.&quot; + cal.now().day + &quot;.number&quot;);</span>
<a href="#l61.59"></a><span id="l61.59" class="difflineplus">+          let dayNumber = cal.calGetString(&quot;dateFormat&quot;, &quot;day.&quot; + cal.now().day + &quot;.number&quot;);</span>
<a href="#l61.60"></a><span id="l61.60">           document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;day-label&quot;).value = dayNumber;</span>
<a href="#l61.61"></a><span id="l61.61">         ]]&gt;&lt;/body&gt;</span>
<a href="#l61.62"></a><span id="l61.62">       &lt;/method&gt;</span>
<a href="#l61.63"></a><span id="l61.63">     &lt;/implementation&gt;</span>
<a href="#l61.64"></a><span id="l61.64">    &lt;/binding&gt;</span>
<a href="#l61.65"></a><span id="l61.65"> </span>
<a href="#l61.66"></a><span id="l61.66">   &lt;!-- this binding directly extends to a checkbox but is visualized as</span>
<a href="#l61.67"></a><span id="l61.67">        a treenode in a treecontrol--&gt;</span>
<a href="#l61.68"></a><span id="l61.68" class="difflineat">@@ -515,16 +520,20 @@</span>
<a href="#l61.69"></a><span id="l61.69">   &lt;!-- This binding may server as a droptarget container for arbitrary items</span>
<a href="#l61.70"></a><span id="l61.70">        it contains methods to add DropShadows. This binding is meant to be used</span>
<a href="#l61.71"></a><span id="l61.71">        as a parent binding. The methods may be overwritten. --&gt;</span>
<a href="#l61.72"></a><span id="l61.72">   &lt;binding id=&quot;dragndropContainer&quot;&gt;</span>
<a href="#l61.73"></a><span id="l61.73">     &lt;implementation&gt;</span>
<a href="#l61.74"></a><span id="l61.74">       &lt;field name=&quot;mDropShadows&quot;&gt;[]&lt;/field&gt;</span>
<a href="#l61.75"></a><span id="l61.75">       &lt;field name=&quot;mCalendarView&quot;&gt;null&lt;/field&gt;</span>
<a href="#l61.76"></a><span id="l61.76"> </span>
<a href="#l61.77"></a><span id="l61.77" class="difflineplus">+      &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l61.78"></a><span id="l61.78" class="difflineplus">+        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l61.79"></a><span id="l61.79" class="difflineplus">+      ]]&gt;&lt;/constructor&gt;</span>
<a href="#l61.80"></a><span id="l61.80" class="difflineplus">+</span>
<a href="#l61.81"></a><span id="l61.81">       &lt;!-- The ViewController that supports the interface 'calICalendarView'--&gt;</span>
<a href="#l61.82"></a><span id="l61.82">       &lt;property name=&quot;calendarView&quot;</span>
<a href="#l61.83"></a><span id="l61.83">                 onget=&quot;return this.mCalendarView;&quot;</span>
<a href="#l61.84"></a><span id="l61.84">                 onset=&quot;return (this.mCalendarView = val);&quot;/&gt;</span>
<a href="#l61.85"></a><span id="l61.85"> </span>
<a href="#l61.86"></a><span id="l61.86">       &lt;!-- method to add individual code e.g to set up the new item during</span>
<a href="#l61.87"></a><span id="l61.87">        'ondrop' --&gt;</span>
<a href="#l61.88"></a><span id="l61.88">       &lt;method name=&quot;onDropItem&quot;&gt;</span>
<a href="#l61.89"></a><span id="l61.89" class="difflineat">@@ -677,17 +686,17 @@</span>
<a href="#l61.90"></a><span id="l61.90">             return;</span>
<a href="#l61.91"></a><span id="l61.91">         }</span>
<a href="#l61.92"></a><span id="l61.92">         let item = session.sourceNode.sourceObject.clone();</span>
<a href="#l61.93"></a><span id="l61.93">         this.setAttribute(&quot;dropbox&quot;, &quot;false&quot;);</span>
<a href="#l61.94"></a><span id="l61.94">         let transfer = Components.classes[&quot;@mozilla.org/widget/transferable;1&quot;]</span>
<a href="#l61.95"></a><span id="l61.95">                                  .createInstance(Components.interfaces.nsITransferable);</span>
<a href="#l61.96"></a><span id="l61.96">         transfer.init(null);</span>
<a href="#l61.97"></a><span id="l61.97"> </span>
<a href="#l61.98"></a><span id="l61.98" class="difflineminus">-        if (isEvent(item)) {</span>
<a href="#l61.99"></a><span id="l61.99" class="difflineplus">+        if (cal.isEvent(item)) {</span>
<a href="#l61.100"></a><span id="l61.100">             transfer.addDataFlavor(&quot;application/x-moz-cal-event&quot;);</span>
<a href="#l61.101"></a><span id="l61.101">         } else {</span>
<a href="#l61.102"></a><span id="l61.102">             transfer.addDataFlavor(&quot;application/x-moz-cal-task&quot;);</span>
<a href="#l61.103"></a><span id="l61.103">         }</span>
<a href="#l61.104"></a><span id="l61.104"> </span>
<a href="#l61.105"></a><span id="l61.105">         session.getData(transfer, 0);</span>
<a href="#l61.106"></a><span id="l61.106">         item = session.sourceNode.sourceObject;</span>
<a href="#l61.107"></a><span id="l61.107"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l62.1"></a><span id="l62.1" class="difflineminus">--- a/calendar/base/content/widgets/minimonth.xml</span>
<a href="#l62.2"></a><span id="l62.2" class="difflineplus">+++ b/calendar/base/content/widgets/minimonth.xml</span>
<a href="#l62.3"></a><span id="l62.3" class="difflineat">@@ -129,17 +129,19 @@</span>
<a href="#l62.4"></a><span id="l62.4">       &lt;/xul:popupset&gt;</span>
<a href="#l62.5"></a><span id="l62.5">     &lt;/content&gt;</span>
<a href="#l62.6"></a><span id="l62.6">     &lt;implementation&gt;</span>
<a href="#l62.7"></a><span id="l62.7">       &lt;field name=&quot;kMinimonth&quot;&gt;null&lt;/field&gt;</span>
<a href="#l62.8"></a><span id="l62.8">       &lt;field name=&quot;mPopup&quot;&gt;null&lt;/field&gt;</span>
<a href="#l62.9"></a><span id="l62.9">       &lt;field name=&quot;mScrollYearsHandler&quot;&gt;null&lt;/field&gt;</span>
<a href="#l62.10"></a><span id="l62.10">       &lt;field name=&quot;mPixelScrollDelta&quot;&gt;0&lt;/field&gt;</span>
<a href="#l62.11"></a><span id="l62.11">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l62.12"></a><span id="l62.12" class="difflineminus">-        this.kMinimonth = getParentNodeOrThis(this, &quot;minimonth&quot;);</span>
<a href="#l62.13"></a><span id="l62.13" class="difflineplus">+        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l62.14"></a><span id="l62.14" class="difflineplus">+</span>
<a href="#l62.15"></a><span id="l62.15" class="difflineplus">+        this.kMinimonth = cal.getParentNodeOrThis(this, &quot;minimonth&quot;);</span>
<a href="#l62.16"></a><span id="l62.16">         document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;back-button&quot;).kMinimonth = this.kMinimonth;</span>
<a href="#l62.17"></a><span id="l62.17">         document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;today-button&quot;).kMinimonth = this.kMinimonth;</span>
<a href="#l62.18"></a><span id="l62.18">         document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;forward-button&quot;).kMinimonth = this.kMinimonth;</span>
<a href="#l62.19"></a><span id="l62.19"> </span>
<a href="#l62.20"></a><span id="l62.20">         this.mScrollYearsHandler = this.scrollYears.bind(this);</span>
<a href="#l62.21"></a><span id="l62.21">         document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;years-popup&quot;)</span>
<a href="#l62.22"></a><span id="l62.22">                 .addEventListener(&quot;wheel&quot;, this.mScrollYearsHandler, true);</span>
<a href="#l62.23"></a><span id="l62.23">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l62.24"></a><span id="l62.24" class="difflineat">@@ -181,17 +183,17 @@</span>
<a href="#l62.25"></a><span id="l62.25">               this.kMinimonth.fireEvent(&quot;popuplisthidden&quot;);</span>
<a href="#l62.26"></a><span id="l62.26">           }</span>
<a href="#l62.27"></a><span id="l62.27">         ]]&gt;&lt;/body&gt;</span>
<a href="#l62.28"></a><span id="l62.28">       &lt;/method&gt;</span>
<a href="#l62.29"></a><span id="l62.29"> </span>
<a href="#l62.30"></a><span id="l62.30">       &lt;method name=&quot;onMonthsPopupCommand&quot;&gt;</span>
<a href="#l62.31"></a><span id="l62.31">         &lt;parameter name=&quot;aItem&quot;/&gt;</span>
<a href="#l62.32"></a><span id="l62.32">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l62.33"></a><span id="l62.33" class="difflineminus">-          let popup = getParentNodeOrThis(aItem, &quot;menupopup&quot;);</span>
<a href="#l62.34"></a><span id="l62.34" class="difflineplus">+          let popup = cal.getParentNodeOrThis(aItem, &quot;menupopup&quot;);</span>
<a href="#l62.35"></a><span id="l62.35">           let triggerNode = popup.triggerNode || popup.anchorNode;</span>
<a href="#l62.36"></a><span id="l62.36">           let deck = triggerNode.parentNode;</span>
<a href="#l62.37"></a><span id="l62.37"> </span>
<a href="#l62.38"></a><span id="l62.38">           this.hidePopupList();</span>
<a href="#l62.39"></a><span id="l62.39">           this.kMinimonth.switchMonth(aItem.getAttribute(&quot;index&quot;));</span>
<a href="#l62.40"></a><span id="l62.40"> </span>
<a href="#l62.41"></a><span id="l62.41">           deck.childNodes[deck.selectedIndex].focus();</span>
<a href="#l62.42"></a><span id="l62.42">         ]]&gt;&lt;/body&gt;</span>
<a href="#l62.43"></a><span id="l62.43" class="difflineat">@@ -233,17 +235,17 @@</span>
<a href="#l62.44"></a><span id="l62.44">               year.setFullYear(curfullYear + 1);</span>
<a href="#l62.45"></a><span id="l62.45">           }</span>
<a href="#l62.46"></a><span id="l62.46">         ]]&gt;&lt;/body&gt;</span>
<a href="#l62.47"></a><span id="l62.47">       &lt;/method&gt;</span>
<a href="#l62.48"></a><span id="l62.48"> </span>
<a href="#l62.49"></a><span id="l62.49">       &lt;method name=&quot;scrollYears&quot;&gt;</span>
<a href="#l62.50"></a><span id="l62.50">         &lt;parameter name=&quot;event&quot;/&gt;</span>
<a href="#l62.51"></a><span id="l62.51">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l62.52"></a><span id="l62.52" class="difflineminus">-          let yearPopup = getParentNodeOrThis(event.target, &quot;menupopup&quot;);</span>
<a href="#l62.53"></a><span id="l62.53" class="difflineplus">+          let yearPopup = cal.getParentNodeOrThis(event.target, &quot;menupopup&quot;);</span>
<a href="#l62.54"></a><span id="l62.54">           const pixelThreshold = 75;</span>
<a href="#l62.55"></a><span id="l62.55">           if (yearPopup) {</span>
<a href="#l62.56"></a><span id="l62.56">               let monthList = yearPopup.getElementsByAttribute(&quot;class&quot;, &quot;minimonth-list&quot;);</span>
<a href="#l62.57"></a><span id="l62.57">               if (monthList &amp;&amp; monthList.length &gt; 0) {</span>
<a href="#l62.58"></a><span id="l62.58">                   if (event.deltaMode == event.DOM_DELTA_PAGE) {</span>
<a href="#l62.59"></a><span id="l62.59">                       let dir = event.deltaY &gt; 0 ? &quot;up&quot; : &quot;down&quot;;</span>
<a href="#l62.60"></a><span id="l62.60">                       this.moveYears(dir, Math.abs(event.deltaY) * monthList.length);</span>
<a href="#l62.61"></a><span id="l62.61">                   } else if (event.deltaMode == event.DOM_DELTA_LINE) {</span>
<a href="#l62.62"></a><span id="l62.62" class="difflineat">@@ -571,18 +573,18 @@</span>
<a href="#l62.63"></a><span id="l62.63">       &lt;method name=&quot;setBusyDaysForOccurrence&quot;&gt;</span>
<a href="#l62.64"></a><span id="l62.64">         &lt;parameter name=&quot;aOccurrence&quot;/&gt;</span>
<a href="#l62.65"></a><span id="l62.65">         &lt;parameter name=&quot;aState&quot;/&gt;</span>
<a href="#l62.66"></a><span id="l62.66">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l62.67"></a><span id="l62.67">           if (aOccurrence.getProperty(&quot;TRANSP&quot;) == &quot;TRANSPARENT&quot;) {</span>
<a href="#l62.68"></a><span id="l62.68">               // Skip transparent events</span>
<a href="#l62.69"></a><span id="l62.69">               return;</span>
<a href="#l62.70"></a><span id="l62.70">           }</span>
<a href="#l62.71"></a><span id="l62.71" class="difflineminus">-          let start = aOccurrence[calGetStartDateProp(aOccurrence)] || aOccurrence.dueDate;</span>
<a href="#l62.72"></a><span id="l62.72" class="difflineminus">-          let end = aOccurrence[calGetEndDateProp(aOccurrence)] || start;</span>
<a href="#l62.73"></a><span id="l62.73" class="difflineplus">+          let start = aOccurrence[cal.calGetStartDateProp(aOccurrence)] || aOccurrence.dueDate;</span>
<a href="#l62.74"></a><span id="l62.74" class="difflineplus">+          let end = aOccurrence[cal.calGetEndDateProp(aOccurrence)] || start;</span>
<a href="#l62.75"></a><span id="l62.75">           if (!start) {</span>
<a href="#l62.76"></a><span id="l62.76">               return;</span>
<a href="#l62.77"></a><span id="l62.77">           }</span>
<a href="#l62.78"></a><span id="l62.78"> </span>
<a href="#l62.79"></a><span id="l62.79">           // We need to compare with midnight of the current day, so reset the</span>
<a href="#l62.80"></a><span id="l62.80">           // time here.</span>
<a href="#l62.81"></a><span id="l62.81">           let current = start.clone().getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l62.82"></a><span id="l62.82">           current.hour = 0;</span>
<a href="#l62.83"></a><span id="l62.83" class="difflineat">@@ -751,17 +753,17 @@</span>
<a href="#l62.84"></a><span id="l62.84">           let longDayList = new Array(7);</span>
<a href="#l62.85"></a><span id="l62.85">           let tempDate = new Date();</span>
<a href="#l62.86"></a><span id="l62.86">           let i, j;</span>
<a href="#l62.87"></a><span id="l62.87">           let useOSFormat;</span>
<a href="#l62.88"></a><span id="l62.88">           tempDate.setDate(tempDate.getDate() - (tempDate.getDay() - this.weekStart));</span>
<a href="#l62.89"></a><span id="l62.89">           for (i = 0; i &lt; 7; i++) {</span>
<a href="#l62.90"></a><span id="l62.90">               // if available, use UILocale days, else operating system format</span>
<a href="#l62.91"></a><span id="l62.91">               try {</span>
<a href="#l62.92"></a><span id="l62.92" class="difflineminus">-                  dayList[i] = calGetString(&quot;dateFormat&quot;,</span>
<a href="#l62.93"></a><span id="l62.93" class="difflineplus">+                  dayList[i] = cal.calGetString(&quot;dateFormat&quot;,</span>
<a href="#l62.94"></a><span id="l62.94">                                &quot;day.&quot; + (tempDate.getDay() + 1) + &quot;.short&quot;);</span>
<a href="#l62.95"></a><span id="l62.95">               } catch (e) {</span>
<a href="#l62.96"></a><span id="l62.96">                   dayList[i] = tempDate.toLocaleDateString(undefined, { weekday: 'short' });</span>
<a href="#l62.97"></a><span id="l62.97">                   useOSFormat = true;</span>
<a href="#l62.98"></a><span id="l62.98">               }</span>
<a href="#l62.99"></a><span id="l62.99">               longDayList[i] = tempDate.toLocaleDateString(undefined, { weekday: 'long' });</span>
<a href="#l62.100"></a><span id="l62.100">               tempDate.setDate(tempDate.getDate() + 1);</span>
<a href="#l62.101"></a><span id="l62.101">           }</span>
<a href="#l62.102"></a><span id="l62.102" class="difflineat">@@ -863,21 +865,21 @@</span>
<a href="#l62.103"></a><span id="l62.103">           let date = this._getStartDate(aDate);</span>
<a href="#l62.104"></a><span id="l62.104"> </span>
<a href="#l62.105"></a><span id="l62.105">           // get today's date</span>
<a href="#l62.106"></a><span id="l62.106">           let today = new Date();</span>
<a href="#l62.107"></a><span id="l62.107"> </span>
<a href="#l62.108"></a><span id="l62.108">           if (aDate.getFullYear() != (this.mValue || this.mExtraDate).getFullYear()) {</span>
<a href="#l62.109"></a><span id="l62.109">               let monthName = cal.formatMonth(aDate.getMonth() + 1,</span>
<a href="#l62.110"></a><span id="l62.110">                                               &quot;calendar&quot;, &quot;monthInYear&quot;);</span>
<a href="#l62.111"></a><span id="l62.111" class="difflineminus">-              let label = calGetString(&quot;calendar&quot;, &quot;monthInYear&quot;,</span>
<a href="#l62.112"></a><span id="l62.112" class="difflineplus">+              let label = cal.calGetString(&quot;calendar&quot;, &quot;monthInYear&quot;,</span>
<a href="#l62.113"></a><span id="l62.113">                                        [monthName, aDate.getFullYear()]);</span>
<a href="#l62.114"></a><span id="l62.114">               calbox.setAttribute(&quot;aria-label&quot;, label);</span>
<a href="#l62.115"></a><span id="l62.115">           } else {</span>
<a href="#l62.116"></a><span id="l62.116" class="difflineminus">-              calbox.setAttribute(&quot;aria-label&quot;, calGetString(&quot;dateFormat&quot;,</span>
<a href="#l62.117"></a><span id="l62.117" class="difflineplus">+              calbox.setAttribute(&quot;aria-label&quot;, cal.calGetString(&quot;dateFormat&quot;,</span>
<a href="#l62.118"></a><span id="l62.118">                                   &quot;month.&quot; + (aDate.getMonth() + 1) + &quot;.name&quot;));</span>
<a href="#l62.119"></a><span id="l62.119">           }</span>
<a href="#l62.120"></a><span id="l62.120"> </span>
<a href="#l62.121"></a><span id="l62.121">           this.mDayMap = {};</span>
<a href="#l62.122"></a><span id="l62.122">           let defaultTz = cal.calendarDefaultTimezone();</span>
<a href="#l62.123"></a><span id="l62.123">           for (let k = 1; k &lt; 7; k++) {</span>
<a href="#l62.124"></a><span id="l62.124">               // Set the week number.</span>
<a href="#l62.125"></a><span id="l62.125">               let firstElement = this._getCalBoxNode(k, 0);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l63.1"></a><span id="l63.1" class="difflineminus">--- a/calendar/base/jar.mn</span>
<a href="#l63.2"></a><span id="l63.2" class="difflineplus">+++ b/calendar/base/jar.mn</span>
<a href="#l63.3"></a><span id="l63.3" class="difflineat">@@ -94,17 +94,16 @@ calendar.jar:</span>
<a href="#l63.4"></a><span id="l63.4">     content/calendar/preferences/views.xul                 (content/preferences/views.xul)</span>
<a href="#l63.5"></a><span id="l63.5">     content/calendar/widgets/minimonth.xml                 (content/widgets/minimonth.xml)</span>
<a href="#l63.6"></a><span id="l63.6">     content/calendar/widgets/calendar-alarm-widget.xml     (content/widgets/calendar-alarm-widget.xml)</span>
<a href="#l63.7"></a><span id="l63.7">     content/calendar/widgets/calendar-widgets.xml          (content/widgets/calendar-widgets.xml)</span>
<a href="#l63.8"></a><span id="l63.8">     content/calendar/widgets/calendar-list-tree.xml        (content/widgets/calendar-list-tree.xml)</span>
<a href="#l63.9"></a><span id="l63.9">     content/calendar/calendar-subscriptions-list.xml       (content/widgets/calendar-subscriptions-list.xml)</span>
<a href="#l63.10"></a><span id="l63.10">     content/calendar/widgets/calendar-widget-bindings.css  (content/widgets/calendar-widget-bindings.css)</span>
<a href="#l63.11"></a><span id="l63.11">     content/calendar/calApplicationUtils.js                (src/calApplicationUtils.js)</span>
<a href="#l63.12"></a><span id="l63.12" class="difflineminus">-    content/calendar/calUtils.js                           (src/calUtils.js)</span>
<a href="#l63.13"></a><span id="l63.13">     content/calendar/calFilter.js                          (src/calFilter.js)</span>
<a href="#l63.14"></a><span id="l63.14">     content/calendar/WindowsNTToZoneInfoTZId.properties    (src/WindowsNTToZoneInfoTZId.properties)</span>
<a href="#l63.15"></a><span id="l63.15"> % skin calendar classic/1.0 chrome/skin/linux/calendar/</span>
<a href="#l63.16"></a><span id="l63.16"> % skin calendar classic/1.0 chrome/skin/osx/calendar/ os=Darwin</span>
<a href="#l63.17"></a><span id="l63.17"> % skin calendar classic/1.0 chrome/skin/windows/calendar/ os=WINNT</span>
<a href="#l63.18"></a><span id="l63.18"> % skin calendar-common classic/1.0 chrome/skin/common/</span>
<a href="#l63.19"></a><span id="l63.19"> % style chrome://global/content/customizeToolbar.xul chrome://calendar/skin/calendar-task-view.css</span>
<a href="#l63.20"></a><span id="l63.20"> % style chrome://global/content/customizeToolbar.xul chrome://calendar/skin/calendar-event-dialog.css</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l64.1"></a><span id="l64.1" class="difflineminus">--- a/calendar/base/modules/calProviderUtils.jsm</span>
<a href="#l64.2"></a><span id="l64.2" class="difflineplus">+++ b/calendar/base/modules/calProviderUtils.jsm</span>
<a href="#l64.3"></a><span id="l64.3" class="difflineat">@@ -300,19 +300,16 @@ cal.getEmailIdentityOfCalendar = functio</span>
<a href="#l64.4"></a><span id="l64.4">  *</span>
<a href="#l64.5"></a><span id="l64.5">  * @param aStr          The RFC3339 compliant Date String</span>
<a href="#l64.6"></a><span id="l64.6">  * @param aTimezone     The timezone this date string is most likely in</span>
<a href="#l64.7"></a><span id="l64.7">  * @return              A calIDateTime object</span>
<a href="#l64.8"></a><span id="l64.8">  */</span>
<a href="#l64.9"></a><span id="l64.9"> cal.fromRFC3339 = function(aStr, aTimezone) {</span>
<a href="#l64.10"></a><span id="l64.10">     // XXX I have not covered leapseconds (matches[8]), this might need to</span>
<a href="#l64.11"></a><span id="l64.11">     // be done. The only reference to leap seconds I found is bug 227329.</span>
<a href="#l64.12"></a><span id="l64.12" class="difflineminus">-    //</span>
<a href="#l64.13"></a><span id="l64.13" class="difflineminus">-</span>
<a href="#l64.14"></a><span id="l64.14" class="difflineminus">-    // Create a DateTime instance (calUtils.js)</span>
<a href="#l64.15"></a><span id="l64.15">     let dateTime = cal.createDateTime();</span>
<a href="#l64.16"></a><span id="l64.16"> </span>
<a href="#l64.17"></a><span id="l64.17">     // Killer regex to parse RFC3339 dates</span>
<a href="#l64.18"></a><span id="l64.18">     let re = new RegExp(&quot;^([0-9]{4})-([0-9]{2})-([0-9]{2})&quot; +</span>
<a href="#l64.19"></a><span id="l64.19">         &quot;([Tt]([0-9]{2}):([0-9]{2}):([0-9]{2})(\\.[0-9]+)?)?&quot; +</span>
<a href="#l64.20"></a><span id="l64.20">         &quot;(([Zz]|([+-])([0-9]{2}):([0-9]{2})))?&quot;);</span>
<a href="#l64.21"></a><span id="l64.21"> </span>
<a href="#l64.22"></a><span id="l64.22">     let matches = re.exec(aStr);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l65.1"></a><span id="l65.1" class="difflineminus">--- a/calendar/base/modules/calUtils.jsm</span>
<a href="#l65.2"></a><span id="l65.2" class="difflineplus">+++ b/calendar/base/modules/calUtils.jsm</span>
<a href="#l65.3"></a><span id="l65.3" class="difflineat">@@ -1,31 +1,25 @@</span>
<a href="#l65.4"></a><span id="l65.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l65.5"></a><span id="l65.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l65.6"></a><span id="l65.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l65.7"></a><span id="l65.7"> </span>
<a href="#l65.8"></a><span id="l65.8" class="difflineminus">-// New code must not load/import calUtils.js, but should use calUtils.jsm.</span>
<a href="#l65.9"></a><span id="l65.9" class="difflineminus">-</span>
<a href="#l65.10"></a><span id="l65.10"> var gCalThreadingEnabled;</span>
<a href="#l65.11"></a><span id="l65.11"> </span>
<a href="#l65.12"></a><span id="l65.12"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l65.13"></a><span id="l65.13"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l65.14"></a><span id="l65.14"> Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l65.15"></a><span id="l65.15"> </span>
<a href="#l65.16"></a><span id="l65.16"> // Usually the backend loader gets loaded via profile-after-change, but in case</span>
<a href="#l65.17"></a><span id="l65.17"> // a calendar component hooks in earlier, its very likely it will use calUtils.</span>
<a href="#l65.18"></a><span id="l65.18"> // Getting the service here will load if its not already loaded</span>
<a href="#l65.19"></a><span id="l65.19"> Components.classes[&quot;@mozilla.org/calendar/backend-loader;1&quot;].getService();</span>
<a href="#l65.20"></a><span id="l65.20"> </span>
<a href="#l65.21"></a><span id="l65.21"> this.EXPORTED_SYMBOLS = [&quot;cal&quot;];</span>
<a href="#l65.22"></a><span id="l65.22"> var cal = {</span>
<a href="#l65.23"></a><span id="l65.23" class="difflineminus">-    // new code should land here,</span>
<a href="#l65.24"></a><span id="l65.24" class="difflineminus">-    // and more code should be moved from calUtils.js into this object to avoid</span>
<a href="#l65.25"></a><span id="l65.25" class="difflineminus">-    // clashes with other extensions</span>
<a href="#l65.26"></a><span id="l65.26" class="difflineminus">-</span>
<a href="#l65.27"></a><span id="l65.27">     getDragService: generateServiceAccessor(&quot;@mozilla.org/widget/dragservice;1&quot;,</span>
<a href="#l65.28"></a><span id="l65.28">                                                 Components.interfaces.nsIDragService),</span>
<a href="#l65.29"></a><span id="l65.29"> </span>
<a href="#l65.30"></a><span id="l65.30">     /**</span>
<a href="#l65.31"></a><span id="l65.31">      * Loads an array of calendar scripts into the passed scope.</span>
<a href="#l65.32"></a><span id="l65.32">      *</span>
<a href="#l65.33"></a><span id="l65.33">      * @param scriptNames an array of calendar script names</span>
<a href="#l65.34"></a><span id="l65.34">      * @param scope       scope to load into</span>
<a href="#l65.35"></a><span id="l65.35" class="difflineat">@@ -175,17 +169,17 @@ var cal = {</span>
<a href="#l65.36"></a><span id="l65.36">         // without cloning, because changes cannot be calculated if doing so.</span>
<a href="#l65.37"></a><span id="l65.37">         if (cal.isEvent(item)) {</span>
<a href="#l65.38"></a><span id="l65.38">             let date = item.startDate.clone();</span>
<a href="#l65.39"></a><span id="l65.39">             date.addDuration(offset);</span>
<a href="#l65.40"></a><span id="l65.40">             item.startDate = date;</span>
<a href="#l65.41"></a><span id="l65.41">             date = item.endDate.clone();</span>
<a href="#l65.42"></a><span id="l65.42">             date.addDuration(offset);</span>
<a href="#l65.43"></a><span id="l65.43">             item.endDate = date;</span>
<a href="#l65.44"></a><span id="l65.44" class="difflineminus">-        } else /* isToDo */ {</span>
<a href="#l65.45"></a><span id="l65.45" class="difflineplus">+        } else /* cal.isToDo */ {</span>
<a href="#l65.46"></a><span id="l65.46">             if (item.entryDate) {</span>
<a href="#l65.47"></a><span id="l65.47">                 let date = item.entryDate.clone();</span>
<a href="#l65.48"></a><span id="l65.48">                 date.addDuration(offset);</span>
<a href="#l65.49"></a><span id="l65.49">                 item.entryDate = date;</span>
<a href="#l65.50"></a><span id="l65.50">             }</span>
<a href="#l65.51"></a><span id="l65.51">             if (item.dueDate) {</span>
<a href="#l65.52"></a><span id="l65.52">                 let date = item.dueDate.clone();</span>
<a href="#l65.53"></a><span id="l65.53">                 date.addDuration(offset);</span>
<a href="#l65.54"></a><span id="l65.54" class="difflineat">@@ -776,60 +770,60 @@ var cal = {</span>
<a href="#l65.55"></a><span id="l65.55">      * moves an item to another startDate</span>
<a href="#l65.56"></a><span id="l65.56">      *</span>
<a href="#l65.57"></a><span id="l65.57">      * @param aOldItem             The Item to be modified</span>
<a href="#l65.58"></a><span id="l65.58">      * @param aNewDate             The date at which the new item is going to start</span>
<a href="#l65.59"></a><span id="l65.59">      * @return                     The modified item</span>
<a href="#l65.60"></a><span id="l65.60">      */</span>
<a href="#l65.61"></a><span id="l65.61">     moveItem: function(aOldItem, aNewDate) {</span>
<a href="#l65.62"></a><span id="l65.62">         let newItem = aOldItem.clone();</span>
<a href="#l65.63"></a><span id="l65.63" class="difflineminus">-        let start = (aOldItem[calGetStartDateProp(aOldItem)] ||</span>
<a href="#l65.64"></a><span id="l65.64" class="difflineminus">-                     aOldItem[calGetEndDateProp(aOldItem)]).clone();</span>
<a href="#l65.65"></a><span id="l65.65" class="difflineplus">+        let start = (aOldItem[cal.calGetStartDateProp(aOldItem)] ||</span>
<a href="#l65.66"></a><span id="l65.66" class="difflineplus">+                     aOldItem[cal.calGetEndDateProp(aOldItem)]).clone();</span>
<a href="#l65.67"></a><span id="l65.67">         let isDate = start.isDate;</span>
<a href="#l65.68"></a><span id="l65.68">         start.resetTo(aNewDate.year, aNewDate.month, aNewDate.day,</span>
<a href="#l65.69"></a><span id="l65.69">                       start.hour, start.minute, start.second,</span>
<a href="#l65.70"></a><span id="l65.70">                       start.timezone);</span>
<a href="#l65.71"></a><span id="l65.71">         start.isDate = isDate;</span>
<a href="#l65.72"></a><span id="l65.72" class="difflineminus">-        if (newItem[calGetStartDateProp(newItem)]) {</span>
<a href="#l65.73"></a><span id="l65.73" class="difflineminus">-            newItem[calGetStartDateProp(newItem)] = start;</span>
<a href="#l65.74"></a><span id="l65.74" class="difflineplus">+        if (newItem[cal.calGetStartDateProp(newItem)]) {</span>
<a href="#l65.75"></a><span id="l65.75" class="difflineplus">+            newItem[cal.calGetStartDateProp(newItem)] = start;</span>
<a href="#l65.76"></a><span id="l65.76">             let oldDuration = aOldItem.duration;</span>
<a href="#l65.77"></a><span id="l65.77">             if (oldDuration) {</span>
<a href="#l65.78"></a><span id="l65.78" class="difflineminus">-                let oldEnd = aOldItem[calGetEndDateProp(aOldItem)];</span>
<a href="#l65.79"></a><span id="l65.79" class="difflineplus">+                let oldEnd = aOldItem[cal.calGetEndDateProp(aOldItem)];</span>
<a href="#l65.80"></a><span id="l65.80">                 let newEnd = start.clone();</span>
<a href="#l65.81"></a><span id="l65.81">                 newEnd.addDuration(oldDuration);</span>
<a href="#l65.82"></a><span id="l65.82">                 newEnd = newEnd.getInTimezone(oldEnd.timezone);</span>
<a href="#l65.83"></a><span id="l65.83" class="difflineminus">-                newItem[calGetEndDateProp(newItem)] = newEnd;</span>
<a href="#l65.84"></a><span id="l65.84" class="difflineplus">+                newItem[cal.calGetEndDateProp(newItem)] = newEnd;</span>
<a href="#l65.85"></a><span id="l65.85">             }</span>
<a href="#l65.86"></a><span id="l65.86" class="difflineminus">-        } else if (newItem[calGetEndDateProp(newItem)]) {</span>
<a href="#l65.87"></a><span id="l65.87" class="difflineminus">-            newItem[calGetEndDateProp(newItem)] = start;</span>
<a href="#l65.88"></a><span id="l65.88" class="difflineplus">+        } else if (newItem[cal.calGetEndDateProp(newItem)]) {</span>
<a href="#l65.89"></a><span id="l65.89" class="difflineplus">+            newItem[cal.calGetEndDateProp(newItem)] = start;</span>
<a href="#l65.90"></a><span id="l65.90">         }</span>
<a href="#l65.91"></a><span id="l65.91">         return newItem;</span>
<a href="#l65.92"></a><span id="l65.92">     },</span>
<a href="#l65.93"></a><span id="l65.93"> </span>
<a href="#l65.94"></a><span id="l65.94">     /**</span>
<a href="#l65.95"></a><span id="l65.95">      * sets the 'isDate' property of an item</span>
<a href="#l65.96"></a><span id="l65.96">      *</span>
<a href="#l65.97"></a><span id="l65.97">      * @param aItem         The Item to be modified</span>
<a href="#l65.98"></a><span id="l65.98">      * @param aIsDate       True or false indicating the new value of 'isDate'</span>
<a href="#l65.99"></a><span id="l65.99">      * @return              The modified item</span>
<a href="#l65.100"></a><span id="l65.100">      */</span>
<a href="#l65.101"></a><span id="l65.101">     setItemToAllDay: function(aItem, aIsDate) {</span>
<a href="#l65.102"></a><span id="l65.102" class="difflineminus">-        let start = aItem[calGetStartDateProp(aItem)];</span>
<a href="#l65.103"></a><span id="l65.103" class="difflineminus">-        let end = aItem[calGetEndDateProp(aItem)];</span>
<a href="#l65.104"></a><span id="l65.104" class="difflineplus">+        let start = aItem[cal.calGetStartDateProp(aItem)];</span>
<a href="#l65.105"></a><span id="l65.105" class="difflineplus">+        let end = aItem[cal.calGetEndDateProp(aItem)];</span>
<a href="#l65.106"></a><span id="l65.106">         if (start || end) {</span>
<a href="#l65.107"></a><span id="l65.107">             let item = aItem.clone();</span>
<a href="#l65.108"></a><span id="l65.108">             if (start &amp;&amp; (start.isDate != aIsDate)) {</span>
<a href="#l65.109"></a><span id="l65.109">                 start = start.clone();</span>
<a href="#l65.110"></a><span id="l65.110">                 start.isDate = aIsDate;</span>
<a href="#l65.111"></a><span id="l65.111" class="difflineminus">-                item[calGetStartDateProp(item)] = start;</span>
<a href="#l65.112"></a><span id="l65.112" class="difflineplus">+                item[cal.calGetStartDateProp(item)] = start;</span>
<a href="#l65.113"></a><span id="l65.113">             }</span>
<a href="#l65.114"></a><span id="l65.114">             if (end &amp;&amp; (end.isDate != aIsDate)) {</span>
<a href="#l65.115"></a><span id="l65.115">                 end = end.clone();</span>
<a href="#l65.116"></a><span id="l65.116">                 end.isDate = aIsDate;</span>
<a href="#l65.117"></a><span id="l65.117" class="difflineminus">-                item[calGetEndDateProp(item)] = end;</span>
<a href="#l65.118"></a><span id="l65.118" class="difflineplus">+                item[cal.calGetEndDateProp(item)] = end;</span>
<a href="#l65.119"></a><span id="l65.119">             }</span>
<a href="#l65.120"></a><span id="l65.120">             return item;</span>
<a href="#l65.121"></a><span id="l65.121">         } else {</span>
<a href="#l65.122"></a><span id="l65.122">             return aItem;</span>
<a href="#l65.123"></a><span id="l65.123">         }</span>
<a href="#l65.124"></a><span id="l65.124">     },</span>
<a href="#l65.125"></a><span id="l65.125"> </span>
<a href="#l65.126"></a><span id="l65.126">     /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l66.1"></a><span id="l66.1" class="difflineminus">--- a/calendar/base/src/calAlarm.js</span>
<a href="#l66.2"></a><span id="l66.2" class="difflineplus">+++ b/calendar/base/src/calAlarm.js</span>
<a href="#l66.3"></a><span id="l66.3" class="difflineat">@@ -7,17 +7,17 @@ Components.utils.import(&quot;resource://cale</span>
<a href="#l66.4"></a><span id="l66.4"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l66.5"></a><span id="l66.5"> </span>
<a href="#l66.6"></a><span id="l66.6"> var ALARM_RELATED_ABSOLUTE = Components.interfaces.calIAlarm.ALARM_RELATED_ABSOLUTE;</span>
<a href="#l66.7"></a><span id="l66.7"> var ALARM_RELATED_START = Components.interfaces.calIAlarm.ALARM_RELATED_START;</span>
<a href="#l66.8"></a><span id="l66.8"> var ALARM_RELATED_END = Components.interfaces.calIAlarm.ALARM_RELATED_END;</span>
<a href="#l66.9"></a><span id="l66.9"> </span>
<a href="#l66.10"></a><span id="l66.10"> function calAlarm() {</span>
<a href="#l66.11"></a><span id="l66.11">     this.wrappedJSObject = this;</span>
<a href="#l66.12"></a><span id="l66.12" class="difflineminus">-    this.mProperties = new calPropertyBag();</span>
<a href="#l66.13"></a><span id="l66.13" class="difflineplus">+    this.mProperties = new cal.calPropertyBag();</span>
<a href="#l66.14"></a><span id="l66.14">     this.mPropertyParams = {};</span>
<a href="#l66.15"></a><span id="l66.15">     this.mAttendees = [];</span>
<a href="#l66.16"></a><span id="l66.16">     this.mAttachments = [];</span>
<a href="#l66.17"></a><span id="l66.17"> }</span>
<a href="#l66.18"></a><span id="l66.18"> </span>
<a href="#l66.19"></a><span id="l66.19"> var calAlarmClassID = Components.ID(&quot;{b8db7c7f-c168-4e11-becb-f26c1c4f5f8f}&quot;);</span>
<a href="#l66.20"></a><span id="l66.20"> var calAlarmInterfaces = [Components.interfaces.calIAlarm];</span>
<a href="#l66.21"></a><span id="l66.21"> calAlarm.prototype = {</span>
<a href="#l66.22"></a><span id="l66.22" class="difflineat">@@ -125,17 +125,17 @@ calAlarm.prototype = {</span>
<a href="#l66.23"></a><span id="l66.23">             if (this[member] &amp;&amp; this[member].clone) {</span>
<a href="#l66.24"></a><span id="l66.24">                 cloned[member] = this[member].clone();</span>
<a href="#l66.25"></a><span id="l66.25">             } else {</span>
<a href="#l66.26"></a><span id="l66.26">                 cloned[member] = this[member];</span>
<a href="#l66.27"></a><span id="l66.27">             }</span>
<a href="#l66.28"></a><span id="l66.28">         }</span>
<a href="#l66.29"></a><span id="l66.29"> </span>
<a href="#l66.30"></a><span id="l66.30">         // X-Props</span>
<a href="#l66.31"></a><span id="l66.31" class="difflineminus">-        cloned.mProperties = new calPropertyBag();</span>
<a href="#l66.32"></a><span id="l66.32" class="difflineplus">+        cloned.mProperties = new cal.calPropertyBag();</span>
<a href="#l66.33"></a><span id="l66.33">         for (let [name, value] of this.mProperties) {</span>
<a href="#l66.34"></a><span id="l66.34">             if (value instanceof Components.interfaces.calIDateTime) {</span>
<a href="#l66.35"></a><span id="l66.35">                 value = value.clone();</span>
<a href="#l66.36"></a><span id="l66.36">             }</span>
<a href="#l66.37"></a><span id="l66.37"> </span>
<a href="#l66.38"></a><span id="l66.38">             cloned.mProperties.setProperty(name, value);</span>
<a href="#l66.39"></a><span id="l66.39"> </span>
<a href="#l66.40"></a><span id="l66.40">             let propBucket = this.mPropertyParams[name];</span>
<a href="#l66.41"></a><span id="l66.41" class="difflineat">@@ -360,31 +360,31 @@ calAlarm.prototype = {</span>
<a href="#l66.42"></a><span id="l66.42">     },</span>
<a href="#l66.43"></a><span id="l66.43"> </span>
<a href="#l66.44"></a><span id="l66.44">     get icalString() {</span>
<a href="#l66.45"></a><span id="l66.45">         let comp = this.icalComponent;</span>
<a href="#l66.46"></a><span id="l66.46">         return (comp ? comp.serializeToICS() : &quot;&quot;);</span>
<a href="#l66.47"></a><span id="l66.47">     },</span>
<a href="#l66.48"></a><span id="l66.48">     set icalString(val) {</span>
<a href="#l66.49"></a><span id="l66.49">         this.ensureMutable();</span>
<a href="#l66.50"></a><span id="l66.50" class="difflineminus">-        return (this.icalComponent = getIcsService().parseICS(val, null));</span>
<a href="#l66.51"></a><span id="l66.51" class="difflineplus">+        return (this.icalComponent = cal.getIcsService().parseICS(val, null));</span>
<a href="#l66.52"></a><span id="l66.52">     },</span>
<a href="#l66.53"></a><span id="l66.53"> </span>
<a href="#l66.54"></a><span id="l66.54">     promotedProps: {</span>
<a href="#l66.55"></a><span id="l66.55">         &quot;ACTION&quot;: &quot;action&quot;,</span>
<a href="#l66.56"></a><span id="l66.56">         &quot;TRIGGER&quot;: &quot;offset&quot;,</span>
<a href="#l66.57"></a><span id="l66.57">         &quot;REPEAT&quot;: &quot;repeat&quot;,</span>
<a href="#l66.58"></a><span id="l66.58">         &quot;DURATION&quot;: &quot;duration&quot;,</span>
<a href="#l66.59"></a><span id="l66.59">         &quot;SUMMARY&quot;: &quot;summary&quot;,</span>
<a href="#l66.60"></a><span id="l66.60">         &quot;DESCRIPTION&quot;: &quot;description&quot;,</span>
<a href="#l66.61"></a><span id="l66.61">         &quot;X-MOZ-LASTACK&quot;: &quot;lastAck&quot;</span>
<a href="#l66.62"></a><span id="l66.62">     },</span>
<a href="#l66.63"></a><span id="l66.63"> </span>
<a href="#l66.64"></a><span id="l66.64">     get icalComponent() {</span>
<a href="#l66.65"></a><span id="l66.65" class="difflineminus">-        let icssvc = getIcsService();</span>
<a href="#l66.66"></a><span id="l66.66" class="difflineplus">+        let icssvc = cal.getIcsService();</span>
<a href="#l66.67"></a><span id="l66.67">         let comp = icssvc.createIcalComponent(&quot;VALARM&quot;);</span>
<a href="#l66.68"></a><span id="l66.68"> </span>
<a href="#l66.69"></a><span id="l66.69">         // Set up action (REQUIRED)</span>
<a href="#l66.70"></a><span id="l66.70">         let actionProp = icssvc.createIcalProperty(&quot;ACTION&quot;);</span>
<a href="#l66.71"></a><span id="l66.71">         actionProp.value = this.action;</span>
<a href="#l66.72"></a><span id="l66.72">         comp.addProperty(actionProp);</span>
<a href="#l66.73"></a><span id="l66.73"> </span>
<a href="#l66.74"></a><span id="l66.74">         // Set up trigger (REQUIRED)</span>
<a href="#l66.75"></a><span id="l66.75" class="difflineat">@@ -436,28 +436,28 @@ calAlarm.prototype = {</span>
<a href="#l66.76"></a><span id="l66.76">             comp.addProperty(attachment.icalProperty);</span>
<a href="#l66.77"></a><span id="l66.77">         }</span>
<a href="#l66.78"></a><span id="l66.78"> </span>
<a href="#l66.79"></a><span id="l66.79">         // Set up summary (REQUIRED for EMAIL)</span>
<a href="#l66.80"></a><span id="l66.80">         if (this.summary || this.action == &quot;EMAIL&quot;) {</span>
<a href="#l66.81"></a><span id="l66.81">             let summaryProp = icssvc.createIcalProperty(&quot;SUMMARY&quot;);</span>
<a href="#l66.82"></a><span id="l66.82">             // Summary needs to have a non-empty value</span>
<a href="#l66.83"></a><span id="l66.83">             summaryProp.value = this.summary ||</span>
<a href="#l66.84"></a><span id="l66.84" class="difflineminus">-                calGetString(&quot;calendar&quot;, &quot;alarmDefaultSummary&quot;);</span>
<a href="#l66.85"></a><span id="l66.85" class="difflineplus">+                cal.calGetString(&quot;calendar&quot;, &quot;alarmDefaultSummary&quot;);</span>
<a href="#l66.86"></a><span id="l66.86">             comp.addProperty(summaryProp);</span>
<a href="#l66.87"></a><span id="l66.87">         }</span>
<a href="#l66.88"></a><span id="l66.88"> </span>
<a href="#l66.89"></a><span id="l66.89">         // Set up the description (REQUIRED for DISPLAY and EMAIL)</span>
<a href="#l66.90"></a><span id="l66.90">         if (this.description ||</span>
<a href="#l66.91"></a><span id="l66.91">             this.action == &quot;DISPLAY&quot; ||</span>
<a href="#l66.92"></a><span id="l66.92">             this.action == &quot;EMAIL&quot;) {</span>
<a href="#l66.93"></a><span id="l66.93">             let descriptionProp = icssvc.createIcalProperty(&quot;DESCRIPTION&quot;);</span>
<a href="#l66.94"></a><span id="l66.94">             // description needs to have a non-empty value</span>
<a href="#l66.95"></a><span id="l66.95">             descriptionProp.value = this.description ||</span>
<a href="#l66.96"></a><span id="l66.96" class="difflineminus">-                calGetString(&quot;calendar&quot;, &quot;alarmDefaultDescription&quot;);</span>
<a href="#l66.97"></a><span id="l66.97" class="difflineplus">+                cal.calGetString(&quot;calendar&quot;, &quot;alarmDefaultDescription&quot;);</span>
<a href="#l66.98"></a><span id="l66.98">             comp.addProperty(descriptionProp);</span>
<a href="#l66.99"></a><span id="l66.99">         }</span>
<a href="#l66.100"></a><span id="l66.100"> </span>
<a href="#l66.101"></a><span id="l66.101">         // Set up lastAck</span>
<a href="#l66.102"></a><span id="l66.102">         if (this.lastAck) {</span>
<a href="#l66.103"></a><span id="l66.103">             let lastAckProp = icssvc.createIcalProperty(&quot;X-MOZ-LASTACK&quot;);</span>
<a href="#l66.104"></a><span id="l66.104">             lastAckProp.value = this.lastAck;</span>
<a href="#l66.105"></a><span id="l66.105">             comp.addProperty(lastAckProp);</span>
<a href="#l66.106"></a><span id="l66.106" class="difflineat">@@ -558,17 +558,17 @@ calAlarm.prototype = {</span>
<a href="#l66.107"></a><span id="l66.107">         // Set up description</span>
<a href="#l66.108"></a><span id="l66.108">         this.description = (descriptionProp ? descriptionProp.value : null);</span>
<a href="#l66.109"></a><span id="l66.109"> </span>
<a href="#l66.110"></a><span id="l66.110">         // Set up the alarm lastack. We can't use valueAsDatetime here since</span>
<a href="#l66.111"></a><span id="l66.111">         // the default for an X-Prop is TEXT and in older versions we didn't set</span>
<a href="#l66.112"></a><span id="l66.112">         // VALUE=DATE-TIME.</span>
<a href="#l66.113"></a><span id="l66.113">         this.lastAck = (lastAckProp ? cal.createDateTime(lastAckProp.valueAsIcalString) : null);</span>
<a href="#l66.114"></a><span id="l66.114"> </span>
<a href="#l66.115"></a><span id="l66.115" class="difflineminus">-        this.mProperties = new calPropertyBag();</span>
<a href="#l66.116"></a><span id="l66.116" class="difflineplus">+        this.mProperties = new cal.calPropertyBag();</span>
<a href="#l66.117"></a><span id="l66.117">         this.mPropertyParams = {};</span>
<a href="#l66.118"></a><span id="l66.118"> </span>
<a href="#l66.119"></a><span id="l66.119">         // Other properties</span>
<a href="#l66.120"></a><span id="l66.120">         for (let prop of cal.ical.propertyIterator(aComp)) {</span>
<a href="#l66.121"></a><span id="l66.121">             if (!this.promotedProps[prop.propertyName]) {</span>
<a href="#l66.122"></a><span id="l66.122">                 this.setProperty(prop.propertyName, prop.value);</span>
<a href="#l66.123"></a><span id="l66.123"> </span>
<a href="#l66.124"></a><span id="l66.124">                 for (let [paramName, param] of cal.ical.paramIterator(prop)) {</span>
<a href="#l66.125"></a><span id="l66.125" class="difflineat">@@ -617,19 +617,19 @@ calAlarm.prototype = {</span>
<a href="#l66.126"></a><span id="l66.126">     },</span>
<a href="#l66.127"></a><span id="l66.127"> </span>
<a href="#l66.128"></a><span id="l66.128">     get propertyEnumerator() {</span>
<a href="#l66.129"></a><span id="l66.129">         return this.mProperties.enumerator;</span>
<a href="#l66.130"></a><span id="l66.130">     },</span>
<a href="#l66.131"></a><span id="l66.131"> </span>
<a href="#l66.132"></a><span id="l66.132">     toString: function(aItem) {</span>
<a href="#l66.133"></a><span id="l66.133">         function getItemBundleStringName(aPrefix) {</span>
<a href="#l66.134"></a><span id="l66.134" class="difflineminus">-            if (!aItem || isEvent(aItem)) {</span>
<a href="#l66.135"></a><span id="l66.135" class="difflineplus">+            if (!aItem || cal.isEvent(aItem)) {</span>
<a href="#l66.136"></a><span id="l66.136">                 return aPrefix + &quot;Event&quot;;</span>
<a href="#l66.137"></a><span id="l66.137" class="difflineminus">-            } else if (isToDo(aItem)) {</span>
<a href="#l66.138"></a><span id="l66.138" class="difflineplus">+            } else if (cal.isToDo(aItem)) {</span>
<a href="#l66.139"></a><span id="l66.139">                 return aPrefix + &quot;Task&quot;;</span>
<a href="#l66.140"></a><span id="l66.140">             } else {</span>
<a href="#l66.141"></a><span id="l66.141">                 return aPrefix;</span>
<a href="#l66.142"></a><span id="l66.142">             }</span>
<a href="#l66.143"></a><span id="l66.143">         }</span>
<a href="#l66.144"></a><span id="l66.144"> </span>
<a href="#l66.145"></a><span id="l66.145">         if (this.related == ALARM_RELATED_ABSOLUTE &amp;&amp; this.mAbsoluteDate) {</span>
<a href="#l66.146"></a><span id="l66.146">             // this is an absolute alarm. Use the calendar default timezone and</span>
<a href="#l66.147"></a><span id="l66.147" class="difflineat">@@ -639,21 +639,21 @@ calAlarm.prototype = {</span>
<a href="#l66.148"></a><span id="l66.148">             return formatter.formatDateTime(formatDate);</span>
<a href="#l66.149"></a><span id="l66.149">         } else if (this.related != ALARM_RELATED_ABSOLUTE &amp;&amp; this.mOffset) {</span>
<a href="#l66.150"></a><span id="l66.150">             // Relative alarm length</span>
<a href="#l66.151"></a><span id="l66.151">             let alarmlen = Math.abs(this.mOffset.inSeconds / 60);</span>
<a href="#l66.152"></a><span id="l66.152">             if (alarmlen == 0) {</span>
<a href="#l66.153"></a><span id="l66.153">                 // No need to get the other information if the alarm is at the start</span>
<a href="#l66.154"></a><span id="l66.154">                 // of the event/task.</span>
<a href="#l66.155"></a><span id="l66.155">                 if (this.related == ALARM_RELATED_START) {</span>
<a href="#l66.156"></a><span id="l66.156" class="difflineminus">-                    return calGetString(&quot;calendar-alarms&quot;,</span>
<a href="#l66.157"></a><span id="l66.157" class="difflineminus">-                                        getItemBundleStringName(&quot;reminderTitleAtStart&quot;));</span>
<a href="#l66.158"></a><span id="l66.158" class="difflineplus">+                    return cal.calGetString(&quot;calendar-alarms&quot;,</span>
<a href="#l66.159"></a><span id="l66.159" class="difflineplus">+                                            getItemBundleStringName(&quot;reminderTitleAtStart&quot;));</span>
<a href="#l66.160"></a><span id="l66.160">                 } else if (this.related == ALARM_RELATED_END) {</span>
<a href="#l66.161"></a><span id="l66.161" class="difflineminus">-                    return calGetString(&quot;calendar-alarms&quot;,</span>
<a href="#l66.162"></a><span id="l66.162" class="difflineminus">-                                        getItemBundleStringName(&quot;reminderTitleAtEnd&quot;));</span>
<a href="#l66.163"></a><span id="l66.163" class="difflineplus">+                    return cal.calGetString(&quot;calendar-alarms&quot;,</span>
<a href="#l66.164"></a><span id="l66.164" class="difflineplus">+                                            getItemBundleStringName(&quot;reminderTitleAtEnd&quot;));</span>
<a href="#l66.165"></a><span id="l66.165">                 }</span>
<a href="#l66.166"></a><span id="l66.166">             }</span>
<a href="#l66.167"></a><span id="l66.167"> </span>
<a href="#l66.168"></a><span id="l66.168">             let unit;</span>
<a href="#l66.169"></a><span id="l66.169">             if (alarmlen % 1440 == 0) {</span>
<a href="#l66.170"></a><span id="l66.170">                 // Alarm is in days</span>
<a href="#l66.171"></a><span id="l66.171">                 unit = &quot;unitDays&quot;;</span>
<a href="#l66.172"></a><span id="l66.172">                 alarmlen /= 1440;</span>
<a href="#l66.173"></a><span id="l66.173" class="difflineat">@@ -679,20 +679,20 @@ calAlarm.prototype = {</span>
<a href="#l66.174"></a><span id="l66.174">             }</span>
<a href="#l66.175"></a><span id="l66.175"> </span>
<a href="#l66.176"></a><span id="l66.176">             if (this.offset.isNegative) {</span>
<a href="#l66.177"></a><span id="l66.177">                 originStringName += &quot;Before&quot;;</span>
<a href="#l66.178"></a><span id="l66.178">             } else {</span>
<a href="#l66.179"></a><span id="l66.179">                 originStringName += &quot;After&quot;;</span>
<a href="#l66.180"></a><span id="l66.180">             }</span>
<a href="#l66.181"></a><span id="l66.181"> </span>
<a href="#l66.182"></a><span id="l66.182" class="difflineminus">-            let originString = calGetString(&quot;calendar-alarms&quot;,</span>
<a href="#l66.183"></a><span id="l66.183" class="difflineminus">-                                            getItemBundleStringName(originStringName));</span>
<a href="#l66.184"></a><span id="l66.184" class="difflineminus">-            return calGetString(&quot;calendar-alarms&quot;,</span>
<a href="#l66.185"></a><span id="l66.185" class="difflineminus">-                                &quot;reminderCustomTitle&quot;,</span>
<a href="#l66.186"></a><span id="l66.186" class="difflineminus">-                                [unitString, originString]);</span>
<a href="#l66.187"></a><span id="l66.187" class="difflineplus">+            let originString = cal.calGetString(&quot;calendar-alarms&quot;,</span>
<a href="#l66.188"></a><span id="l66.188" class="difflineplus">+                                                getItemBundleStringName(originStringName));</span>
<a href="#l66.189"></a><span id="l66.189" class="difflineplus">+            return cal.calGetString(&quot;calendar-alarms&quot;,</span>
<a href="#l66.190"></a><span id="l66.190" class="difflineplus">+                                    &quot;reminderCustomTitle&quot;,</span>
<a href="#l66.191"></a><span id="l66.191" class="difflineplus">+                                    [unitString, originString]);</span>
<a href="#l66.192"></a><span id="l66.192">         } else {</span>
<a href="#l66.193"></a><span id="l66.193">             // This is an incomplete alarm, but then again we should never reach</span>
<a href="#l66.194"></a><span id="l66.194">             // this state.</span>
<a href="#l66.195"></a><span id="l66.195">             return &quot;[Incomplete calIAlarm]&quot;;</span>
<a href="#l66.196"></a><span id="l66.196">         }</span>
<a href="#l66.197"></a><span id="l66.197">     }</span>
<a href="#l66.198"></a><span id="l66.198"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l67.1"></a><span id="l67.1" class="difflineminus">--- a/calendar/base/src/calAlarmMonitor.js</span>
<a href="#l67.2"></a><span id="l67.2" class="difflineplus">+++ b/calendar/base/src/calAlarmMonitor.js</span>
<a href="#l67.3"></a><span id="l67.3" class="difflineat">@@ -97,17 +97,17 @@ calAlarmMonitor.prototype = {</span>
<a href="#l67.4"></a><span id="l67.4">                 this.mAlarmSoundCount++;</span>
<a href="#l67.5"></a><span id="l67.5">             }</span>
<a href="#l67.6"></a><span id="l67.6"> </span>
<a href="#l67.7"></a><span id="l67.7">             if (maxAlarmSoundCount &gt; this.mAlarmSoundCount) {</span>
<a href="#l67.8"></a><span id="l67.8">                 // Only ring the alarm sound if we haven't hit the max count.</span>
<a href="#l67.9"></a><span id="l67.9">                 try {</span>
<a href="#l67.10"></a><span id="l67.10">                     let soundURL = Preferences.get(&quot;calendar.alarms.soundURL&quot;, null);</span>
<a href="#l67.11"></a><span id="l67.11">                     if (soundURL &amp;&amp; soundURL.length &gt; 0) {</span>
<a href="#l67.12"></a><span id="l67.12" class="difflineminus">-                        soundURL = makeURL(soundURL);</span>
<a href="#l67.13"></a><span id="l67.13" class="difflineplus">+                        soundURL = cal.makeURL(soundURL);</span>
<a href="#l67.14"></a><span id="l67.14">                         this.mSound.play(soundURL);</span>
<a href="#l67.15"></a><span id="l67.15">                     } else {</span>
<a href="#l67.16"></a><span id="l67.16">                         this.mSound.beep();</span>
<a href="#l67.17"></a><span id="l67.17">                     }</span>
<a href="#l67.18"></a><span id="l67.18">                 } catch (exc) {</span>
<a href="#l67.19"></a><span id="l67.19">                     cal.ERROR(&quot;Error playing alarm sound: &quot; + exc);</span>
<a href="#l67.20"></a><span id="l67.20">                 }</span>
<a href="#l67.21"></a><span id="l67.21">             }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l68.1"></a><span id="l68.1" class="difflineminus">--- a/calendar/base/src/calAlarmService.js</span>
<a href="#l68.2"></a><span id="l68.2" class="difflineplus">+++ b/calendar/base/src/calAlarmService.js</span>
<a href="#l68.3"></a><span id="l68.3" class="difflineat">@@ -26,17 +26,17 @@ function newTimerWithCallback(aCallback,</span>
<a href="#l68.4"></a><span id="l68.4">     return timer;</span>
<a href="#l68.5"></a><span id="l68.5"> }</span>
<a href="#l68.6"></a><span id="l68.6"> </span>
<a href="#l68.7"></a><span id="l68.7"> function calAlarmService() {</span>
<a href="#l68.8"></a><span id="l68.8">     this.wrappedJSObject = this;</span>
<a href="#l68.9"></a><span id="l68.9"> </span>
<a href="#l68.10"></a><span id="l68.10">     this.mLoadedCalendars = {};</span>
<a href="#l68.11"></a><span id="l68.11">     this.mTimerMap = {};</span>
<a href="#l68.12"></a><span id="l68.12" class="difflineminus">-    this.mObservers = new calListenerBag(Components.interfaces.calIAlarmServiceObserver);</span>
<a href="#l68.13"></a><span id="l68.13" class="difflineplus">+    this.mObservers = new cal.calListenerBag(Components.interfaces.calIAlarmServiceObserver);</span>
<a href="#l68.14"></a><span id="l68.14"> </span>
<a href="#l68.15"></a><span id="l68.15">     this.calendarObserver = {</span>
<a href="#l68.16"></a><span id="l68.16">         alarmService: this,</span>
<a href="#l68.17"></a><span id="l68.17"> </span>
<a href="#l68.18"></a><span id="l68.18">         QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIObserver]),</span>
<a href="#l68.19"></a><span id="l68.19"> </span>
<a href="#l68.20"></a><span id="l68.20">         // calIObserver:</span>
<a href="#l68.21"></a><span id="l68.21">         onStartBatch: function() { },</span>
<a href="#l68.22"></a><span id="l68.22" class="difflineat">@@ -139,17 +139,17 @@ calAlarmService.prototype = {</span>
<a href="#l68.23"></a><span id="l68.23">     },</span>
<a href="#l68.24"></a><span id="l68.24"> </span>
<a href="#l68.25"></a><span id="l68.25">     /**</span>
<a href="#l68.26"></a><span id="l68.26">      * calIAlarmService APIs</span>
<a href="#l68.27"></a><span id="l68.27">      */</span>
<a href="#l68.28"></a><span id="l68.28">     get timezone() {</span>
<a href="#l68.29"></a><span id="l68.29">         // TODO Do we really need this? Do we ever set the timezone to something</span>
<a href="#l68.30"></a><span id="l68.30">         // different than the default timezone?</span>
<a href="#l68.31"></a><span id="l68.31" class="difflineminus">-        return this.mTimezone || calendarDefaultTimezone();</span>
<a href="#l68.32"></a><span id="l68.32" class="difflineplus">+        return this.mTimezone || cal.calendarDefaultTimezone();</span>
<a href="#l68.33"></a><span id="l68.33">     },</span>
<a href="#l68.34"></a><span id="l68.34"> </span>
<a href="#l68.35"></a><span id="l68.35">     set timezone(aTimezone) {</span>
<a href="#l68.36"></a><span id="l68.36">         return (this.mTimezone = aTimezone);</span>
<a href="#l68.37"></a><span id="l68.37">     },</span>
<a href="#l68.38"></a><span id="l68.38"> </span>
<a href="#l68.39"></a><span id="l68.39">     snoozeAlarm: function(aItem, aAlarm, aDuration) {</span>
<a href="#l68.40"></a><span id="l68.40">         // Right now we only support snoozing all alarms for the given item for</span>
<a href="#l68.41"></a><span id="l68.41" class="difflineat">@@ -216,19 +216,19 @@ calAlarmService.prototype = {</span>
<a href="#l68.42"></a><span id="l68.42">         Services.obs.addObserver(this, &quot;wake_notification&quot;, false);</span>
<a href="#l68.43"></a><span id="l68.43"> </span>
<a href="#l68.44"></a><span id="l68.44">         /* Tell people that we're alive so they can start monitoring alarms.</span>
<a href="#l68.45"></a><span id="l68.45">          */</span>
<a href="#l68.46"></a><span id="l68.46">         let notifier = Components.classes[&quot;@mozilla.org/embedcomp/appstartup-notifier;1&quot;]</span>
<a href="#l68.47"></a><span id="l68.47">                                  .getService(Components.interfaces.nsIObserver);</span>
<a href="#l68.48"></a><span id="l68.48">         notifier.observe(null, &quot;alarm-service-startup&quot;, null);</span>
<a href="#l68.49"></a><span id="l68.49"> </span>
<a href="#l68.50"></a><span id="l68.50" class="difflineminus">-        getCalendarManager().addObserver(this.calendarManagerObserver);</span>
<a href="#l68.51"></a><span id="l68.51" class="difflineplus">+        cal.getCalendarManager().addObserver(this.calendarManagerObserver);</span>
<a href="#l68.52"></a><span id="l68.52"> </span>
<a href="#l68.53"></a><span id="l68.53" class="difflineminus">-        for (let calendar of getCalendarManager().getCalendars({})) {</span>
<a href="#l68.54"></a><span id="l68.54" class="difflineplus">+        for (let calendar of cal.getCalendarManager().getCalendars({})) {</span>
<a href="#l68.55"></a><span id="l68.55">             this.observeCalendar(calendar);</span>
<a href="#l68.56"></a><span id="l68.56">         }</span>
<a href="#l68.57"></a><span id="l68.57"> </span>
<a href="#l68.58"></a><span id="l68.58">         /* set up a timer to update alarms every N hours */</span>
<a href="#l68.59"></a><span id="l68.59">         let timerCallback = {</span>
<a href="#l68.60"></a><span id="l68.60">             alarmService: this,</span>
<a href="#l68.61"></a><span id="l68.61">             notify: function() {</span>
<a href="#l68.62"></a><span id="l68.62">                 let now = nowUTC();</span>
<a href="#l68.63"></a><span id="l68.63" class="difflineat">@@ -246,19 +246,19 @@ calAlarmService.prototype = {</span>
<a href="#l68.64"></a><span id="l68.64">                     this.alarmService.mRangeStart = start.clone();</span>
<a href="#l68.65"></a><span id="l68.65">                 }</span>
<a href="#l68.66"></a><span id="l68.66">                 let until = now.clone();</span>
<a href="#l68.67"></a><span id="l68.67">                 until.month += Components.interfaces.calIAlarmService.MAX_SNOOZE_MONTHS;</span>
<a href="#l68.68"></a><span id="l68.68"> </span>
<a href="#l68.69"></a><span id="l68.69">                 // We don't set timers for every future alarm, only those within 6 hours</span>
<a href="#l68.70"></a><span id="l68.70">                 let end = now.clone();</span>
<a href="#l68.71"></a><span id="l68.71">                 end.hour += kHoursBetweenUpdates;</span>
<a href="#l68.72"></a><span id="l68.72" class="difflineminus">-                this.alarmService.mRangeEnd = end.getInTimezone(UTC());</span>
<a href="#l68.73"></a><span id="l68.73" class="difflineplus">+                this.alarmService.mRangeEnd = end.getInTimezone(cal.UTC());</span>
<a href="#l68.74"></a><span id="l68.74"> </span>
<a href="#l68.75"></a><span id="l68.75" class="difflineminus">-                this.alarmService.findAlarms(getCalendarManager().getCalendars({}),</span>
<a href="#l68.76"></a><span id="l68.76" class="difflineplus">+                this.alarmService.findAlarms(cal.getCalendarManager().getCalendars({}),</span>
<a href="#l68.77"></a><span id="l68.77">                                              start, until);</span>
<a href="#l68.78"></a><span id="l68.78">             }</span>
<a href="#l68.79"></a><span id="l68.79">         };</span>
<a href="#l68.80"></a><span id="l68.80">         timerCallback.notify();</span>
<a href="#l68.81"></a><span id="l68.81"> </span>
<a href="#l68.82"></a><span id="l68.82">         this.mUpdateTimer = newTimerWithCallback(timerCallback, kHoursBetweenUpdates * 3600000, true);</span>
<a href="#l68.83"></a><span id="l68.83"> </span>
<a href="#l68.84"></a><span id="l68.84">         this.mStarted = true;</span>
<a href="#l68.85"></a><span id="l68.85" class="difflineat">@@ -325,17 +325,17 @@ calAlarmService.prototype = {</span>
<a href="#l68.86"></a><span id="l68.86"> </span>
<a href="#l68.87"></a><span id="l68.87">             // Handle all day events.  This is kinda weird, because they don't have</span>
<a href="#l68.88"></a><span id="l68.88">             // a well defined startTime.  We just consider the start/end to be</span>
<a href="#l68.89"></a><span id="l68.89">             // midnight in the user's timezone.</span>
<a href="#l68.90"></a><span id="l68.90">             if (alarmDate.isDate) {</span>
<a href="#l68.91"></a><span id="l68.91">                 alarmDate = alarmDate.getInTimezone(this.timezone);</span>
<a href="#l68.92"></a><span id="l68.92">                 alarmDate.isDate = false;</span>
<a href="#l68.93"></a><span id="l68.93">             }</span>
<a href="#l68.94"></a><span id="l68.94" class="difflineminus">-            alarmDate = alarmDate.getInTimezone(UTC());</span>
<a href="#l68.95"></a><span id="l68.95" class="difflineplus">+            alarmDate = alarmDate.getInTimezone(cal.UTC());</span>
<a href="#l68.96"></a><span id="l68.96"> </span>
<a href="#l68.97"></a><span id="l68.97">             // Check for snooze</span>
<a href="#l68.98"></a><span id="l68.98">             let snoozeDate;</span>
<a href="#l68.99"></a><span id="l68.99">             if (aItem.parentItem == aItem) {</span>
<a href="#l68.100"></a><span id="l68.100">                 snoozeDate = aItem.getProperty(&quot;X-MOZ-SNOOZE-TIME&quot;);</span>
<a href="#l68.101"></a><span id="l68.101">             } else {</span>
<a href="#l68.102"></a><span id="l68.102">                 snoozeDate = aItem.parentItem.getProperty(&quot;X-MOZ-SNOOZE-TIME-&quot; + aItem.recurrenceId.nativeTime);</span>
<a href="#l68.103"></a><span id="l68.103">             }</span>
<a href="#l68.104"></a><span id="l68.104" class="difflineat">@@ -348,17 +348,17 @@ calAlarmService.prototype = {</span>
<a href="#l68.105"></a><span id="l68.105">             if (snoozeDate &amp;&amp; snoozeDate.compare(alarmDate) &gt; 0) {</span>
<a href="#l68.106"></a><span id="l68.106">                 // If the alarm was snoozed, the snooze time is more important.</span>
<a href="#l68.107"></a><span id="l68.107">                 alarmDate = snoozeDate;</span>
<a href="#l68.108"></a><span id="l68.108">             }</span>
<a href="#l68.109"></a><span id="l68.109"> </span>
<a href="#l68.110"></a><span id="l68.110">             let now = nowUTC();</span>
<a href="#l68.111"></a><span id="l68.111">             if (alarmDate.timezone.isFloating) {</span>
<a href="#l68.112"></a><span id="l68.112">                 now = cal.now();</span>
<a href="#l68.113"></a><span id="l68.113" class="difflineminus">-                now.timezone = floating();</span>
<a href="#l68.114"></a><span id="l68.114" class="difflineplus">+                now.timezone = cal.floating();</span>
<a href="#l68.115"></a><span id="l68.115">             }</span>
<a href="#l68.116"></a><span id="l68.116"> </span>
<a href="#l68.117"></a><span id="l68.117">             if (alarmDate.compare(now) &gt;= 0) {</span>
<a href="#l68.118"></a><span id="l68.118">                 // We assume that future alarms haven't been acknowledged</span>
<a href="#l68.119"></a><span id="l68.119">                 // Delay is in msec, so don't forget to multiply</span>
<a href="#l68.120"></a><span id="l68.120">                 let timeout = alarmDate.subtractDate(now).inSeconds * 1000;</span>
<a href="#l68.121"></a><span id="l68.121"> </span>
<a href="#l68.122"></a><span id="l68.122">                 // No sense in keeping an extra timeout for an alarm thats past</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l69.1"></a><span id="l69.1" class="difflineminus">--- a/calendar/base/src/calAttachment.js</span>
<a href="#l69.2"></a><span id="l69.2" class="difflineplus">+++ b/calendar/base/src/calAttachment.js</span>
<a href="#l69.3"></a><span id="l69.3" class="difflineat">@@ -51,17 +51,17 @@ calAttachment.prototype = {</span>
<a href="#l69.4"></a><span id="l69.4">      */</span>
<a href="#l69.5"></a><span id="l69.5"> </span>
<a href="#l69.6"></a><span id="l69.6">     get uri() {</span>
<a href="#l69.7"></a><span id="l69.7">         let uri = null;</span>
<a href="#l69.8"></a><span id="l69.8">         if (this.getParameter(&quot;VALUE&quot;) != &quot;BINARY&quot;) {</span>
<a href="#l69.9"></a><span id="l69.9">             // If this is not binary data, its likely an uri. Attempt to convert</span>
<a href="#l69.10"></a><span id="l69.10">             // and throw otherwise.</span>
<a href="#l69.11"></a><span id="l69.11">             try {</span>
<a href="#l69.12"></a><span id="l69.12" class="difflineminus">-                uri = makeURL(this.mData);</span>
<a href="#l69.13"></a><span id="l69.13" class="difflineplus">+                uri = cal.makeURL(this.mData);</span>
<a href="#l69.14"></a><span id="l69.14">             } catch (e) {</span>
<a href="#l69.15"></a><span id="l69.15">                 // Its possible that the uri contains malformed data. Often</span>
<a href="#l69.16"></a><span id="l69.16">                 // callers don't expect an exception here, so we just catch</span>
<a href="#l69.17"></a><span id="l69.17">                 // it and return null.</span>
<a href="#l69.18"></a><span id="l69.18">             }</span>
<a href="#l69.19"></a><span id="l69.19">         }</span>
<a href="#l69.20"></a><span id="l69.20"> </span>
<a href="#l69.21"></a><span id="l69.21">         return uri;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l70.1"></a><span id="l70.1" class="difflineminus">--- a/calendar/base/src/calAttendee.js</span>
<a href="#l70.2"></a><span id="l70.2" class="difflineplus">+++ b/calendar/base/src/calAttendee.js</span>
<a href="#l70.3"></a><span id="l70.3" class="difflineat">@@ -3,17 +3,17 @@</span>
<a href="#l70.4"></a><span id="l70.4">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l70.5"></a><span id="l70.5"> </span>
<a href="#l70.6"></a><span id="l70.6"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l70.7"></a><span id="l70.7"> Components.utils.import(&quot;resource://calendar/modules/calIteratorUtils.jsm&quot;);</span>
<a href="#l70.8"></a><span id="l70.8"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l70.9"></a><span id="l70.9"> </span>
<a href="#l70.10"></a><span id="l70.10"> function calAttendee() {</span>
<a href="#l70.11"></a><span id="l70.11">     this.wrappedJSObject = this;</span>
<a href="#l70.12"></a><span id="l70.12" class="difflineminus">-    this.mProperties = new calPropertyBag();</span>
<a href="#l70.13"></a><span id="l70.13" class="difflineplus">+    this.mProperties = new cal.calPropertyBag();</span>
<a href="#l70.14"></a><span id="l70.14"> }</span>
<a href="#l70.15"></a><span id="l70.15"> </span>
<a href="#l70.16"></a><span id="l70.16"> var calAttendeeClassID = Components.ID(&quot;{5c8dcaa3-170c-4a73-8142-d531156f664d}&quot;);</span>
<a href="#l70.17"></a><span id="l70.17"> var calAttendeeInterfaces = [Components.interfaces.calIAttendee];</span>
<a href="#l70.18"></a><span id="l70.18"> calAttendee.prototype = {</span>
<a href="#l70.19"></a><span id="l70.19">     classID: calAttendeeClassID,</span>
<a href="#l70.20"></a><span id="l70.20">     QueryInterface: XPCOMUtils.generateQI(calAttendeeInterfaces),</span>
<a href="#l70.21"></a><span id="l70.21">     classInfo: XPCOMUtils.generateCI({</span>
<a href="#l70.22"></a><span id="l70.22" class="difflineat">@@ -79,17 +79,17 @@ calAttendee.prototype = {</span>
<a href="#l70.23"></a><span id="l70.23">         for (let prop of this.icalAttendeePropMap) {</span>
<a href="#l70.24"></a><span id="l70.24">             this[prop.cal] = icalatt.getParameter(prop.ics);</span>
<a href="#l70.25"></a><span id="l70.25">             // Don't copy these to the property bag.</span>
<a href="#l70.26"></a><span id="l70.26">             promotedProps[prop.ics] = true;</span>
<a href="#l70.27"></a><span id="l70.27">         }</span>
<a href="#l70.28"></a><span id="l70.28"> </span>
<a href="#l70.29"></a><span id="l70.29">         // Reset the property bag for the parameters, it will be re-initialized</span>
<a href="#l70.30"></a><span id="l70.30">         // from the ical property.</span>
<a href="#l70.31"></a><span id="l70.31" class="difflineminus">-        this.mProperties = new calPropertyBag();</span>
<a href="#l70.32"></a><span id="l70.32" class="difflineplus">+        this.mProperties = new cal.calPropertyBag();</span>
<a href="#l70.33"></a><span id="l70.33"> </span>
<a href="#l70.34"></a><span id="l70.34">         for (let [name, value] of cal.ical.paramIterator(icalatt)) {</span>
<a href="#l70.35"></a><span id="l70.35">             if (!promotedProps[name]) {</span>
<a href="#l70.36"></a><span id="l70.36">                 this.setProperty(name, value);</span>
<a href="#l70.37"></a><span id="l70.37">             }</span>
<a href="#l70.38"></a><span id="l70.38">         }</span>
<a href="#l70.39"></a><span id="l70.39">     },</span>
<a href="#l70.40"></a><span id="l70.40"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l71.1"></a><span id="l71.1" class="difflineminus">--- a/calendar/base/src/calCachedCalendar.js</span>
<a href="#l71.2"></a><span id="l71.2" class="difflineplus">+++ b/calendar/base/src/calCachedCalendar.js</span>
<a href="#l71.3"></a><span id="l71.3" class="difflineat">@@ -1,12 +1,13 @@</span>
<a href="#l71.4"></a><span id="l71.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l71.5"></a><span id="l71.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l71.6"></a><span id="l71.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l71.7"></a><span id="l71.7"> </span>
<a href="#l71.8"></a><span id="l71.8" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l71.9"></a><span id="l71.9"> Components.utils.import(&quot;resource://calendar/modules/calProviderUtils.jsm&quot;);</span>
<a href="#l71.10"></a><span id="l71.10"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l71.11"></a><span id="l71.11"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l71.12"></a><span id="l71.12"> Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l71.13"></a><span id="l71.13"> </span>
<a href="#l71.14"></a><span id="l71.14"> var calICalendar = Components.interfaces.calICalendar;</span>
<a href="#l71.15"></a><span id="l71.15"> var cICL = Components.interfaces.calIChangeLog;</span>
<a href="#l71.16"></a><span id="l71.16"> var cIOL = Components.interfaces.calIOperationListener;</span>
<a href="#l71.17"></a><span id="l71.17" class="difflineat">@@ -196,17 +197,17 @@ calCachedCalendar.prototype = {</span>
<a href="#l71.18"></a><span id="l71.18">                     case &quot;memory&quot;: {</span>
<a href="#l71.19"></a><span id="l71.19">                         if (this.supportsChangeLog) {</span>
<a href="#l71.20"></a><span id="l71.20">                             // start with full sync:</span>
<a href="#l71.21"></a><span id="l71.21">                             this.mUncachedCalendar.resetLog();</span>
<a href="#l71.22"></a><span id="l71.22">                         }</span>
<a href="#l71.23"></a><span id="l71.23">                         break;</span>
<a href="#l71.24"></a><span id="l71.24">                     }</span>
<a href="#l71.25"></a><span id="l71.25">                     case &quot;storage&quot;: {</span>
<a href="#l71.26"></a><span id="l71.26" class="difflineminus">-                        let file = getCalendarDirectory();</span>
<a href="#l71.27"></a><span id="l71.27" class="difflineplus">+                        let file = cal.getCalendarDirectory();</span>
<a href="#l71.28"></a><span id="l71.28">                         file.append(&quot;cache.sqlite&quot;);</span>
<a href="#l71.29"></a><span id="l71.29">                         cachedCalendar.uri = Services.io.newFileURI(file);</span>
<a href="#l71.30"></a><span id="l71.30">                         cachedCalendar.id = this.id;</span>
<a href="#l71.31"></a><span id="l71.31">                         break;</span>
<a href="#l71.32"></a><span id="l71.32">                     }</span>
<a href="#l71.33"></a><span id="l71.33">                     default: {</span>
<a href="#l71.34"></a><span id="l71.34">                         throw new Error(&quot;unsupported cache calendar type: &quot; + calType);</span>
<a href="#l71.35"></a><span id="l71.35">                     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l72.1"></a><span id="l72.1" class="difflineminus">--- a/calendar/base/src/calCalendarManager.js</span>
<a href="#l72.2"></a><span id="l72.2" class="difflineplus">+++ b/calendar/base/src/calCalendarManager.js</span>
<a href="#l72.3"></a><span id="l72.3" class="difflineat">@@ -10,18 +10,18 @@ Components.utils.import(&quot;resource://cale</span>
<a href="#l72.4"></a><span id="l72.4"> </span>
<a href="#l72.5"></a><span id="l72.5"> var REGISTRY_BRANCH = &quot;calendar.registry.&quot;;</span>
<a href="#l72.6"></a><span id="l72.6"> var DB_SCHEMA_VERSION = 10;</span>
<a href="#l72.7"></a><span id="l72.7"> var MAX_INT = Math.pow(2, 31) - 1;</span>
<a href="#l72.8"></a><span id="l72.8"> var MIN_INT = -MAX_INT;</span>
<a href="#l72.9"></a><span id="l72.9"> </span>
<a href="#l72.10"></a><span id="l72.10"> function calCalendarManager() {</span>
<a href="#l72.11"></a><span id="l72.11">     this.wrappedJSObject = this;</span>
<a href="#l72.12"></a><span id="l72.12" class="difflineminus">-    this.mObservers = new calListenerBag(Components.interfaces.calICalendarManagerObserver);</span>
<a href="#l72.13"></a><span id="l72.13" class="difflineminus">-    this.mCalendarObservers = new calListenerBag(Components.interfaces.calIObserver);</span>
<a href="#l72.14"></a><span id="l72.14" class="difflineplus">+    this.mObservers = new cal.calListenerBag(Components.interfaces.calICalendarManagerObserver);</span>
<a href="#l72.15"></a><span id="l72.15" class="difflineplus">+    this.mCalendarObservers = new cal.calListenerBag(Components.interfaces.calIObserver);</span>
<a href="#l72.16"></a><span id="l72.16"> }</span>
<a href="#l72.17"></a><span id="l72.17"> </span>
<a href="#l72.18"></a><span id="l72.18"> var calCalendarManagerClassID = Components.ID(&quot;{f42585e7-e736-4600-985d-9624c1c51992}&quot;);</span>
<a href="#l72.19"></a><span id="l72.19"> var calCalendarManagerInterfaces = [</span>
<a href="#l72.20"></a><span id="l72.20">     Components.interfaces.calICalendarManager,</span>
<a href="#l72.21"></a><span id="l72.21">     Components.interfaces.calIStartupService,</span>
<a href="#l72.22"></a><span id="l72.22">     Components.interfaces.nsIObserver,</span>
<a href="#l72.23"></a><span id="l72.23"> ];</span>
<a href="#l72.24"></a><span id="l72.24" class="difflineat">@@ -398,21 +398,21 @@ calCalendarManager.prototype = {</span>
<a href="#l72.25"></a><span id="l72.25"> </span>
<a href="#l72.26"></a><span id="l72.26">     //</span>
<a href="#l72.27"></a><span id="l72.27">     // / DB migration code ends here</span>
<a href="#l72.28"></a><span id="l72.28">     //</span>
<a href="#l72.29"></a><span id="l72.29"> </span>
<a href="#l72.30"></a><span id="l72.30">     alertAndQuit: function() {</span>
<a href="#l72.31"></a><span id="l72.31">         // We want to include the extension name in the error message rather</span>
<a href="#l72.32"></a><span id="l72.32">         // than blaming Thunderbird.</span>
<a href="#l72.33"></a><span id="l72.33" class="difflineminus">-        let hostAppName = calGetString(&quot;brand&quot;, &quot;brandShortName&quot;, null, &quot;branding&quot;);</span>
<a href="#l72.34"></a><span id="l72.34" class="difflineminus">-        let calAppName = calGetString(&quot;lightning&quot;, &quot;brandShortName&quot;, null, &quot;lightning&quot;);</span>
<a href="#l72.35"></a><span id="l72.35" class="difflineminus">-        let errorBoxTitle = calGetString(&quot;calendar&quot;, &quot;tooNewSchemaErrorBoxTitle&quot;, [calAppName]);</span>
<a href="#l72.36"></a><span id="l72.36" class="difflineminus">-        let errorBoxText = calGetString(&quot;calendar&quot;, &quot;tooNewSchemaErrorBoxTextLightning&quot;, [calAppName, hostAppName]);</span>
<a href="#l72.37"></a><span id="l72.37" class="difflineminus">-        let errorBoxButtonLabel = calGetString(&quot;calendar&quot;, &quot;tooNewSchemaButtonRestart&quot;, [hostAppName]);</span>
<a href="#l72.38"></a><span id="l72.38" class="difflineplus">+        let hostAppName = cal.calGetString(&quot;brand&quot;, &quot;brandShortName&quot;, null, &quot;branding&quot;);</span>
<a href="#l72.39"></a><span id="l72.39" class="difflineplus">+        let calAppName = cal.calGetString(&quot;lightning&quot;, &quot;brandShortName&quot;, null, &quot;lightning&quot;);</span>
<a href="#l72.40"></a><span id="l72.40" class="difflineplus">+        let errorBoxTitle = cal.calGetString(&quot;calendar&quot;, &quot;tooNewSchemaErrorBoxTitle&quot;, [calAppName]);</span>
<a href="#l72.41"></a><span id="l72.41" class="difflineplus">+        let errorBoxText = cal.calGetString(&quot;calendar&quot;, &quot;tooNewSchemaErrorBoxTextLightning&quot;, [calAppName, hostAppName]);</span>
<a href="#l72.42"></a><span id="l72.42" class="difflineplus">+        let errorBoxButtonLabel = cal.calGetString(&quot;calendar&quot;, &quot;tooNewSchemaButtonRestart&quot;, [hostAppName]);</span>
<a href="#l72.43"></a><span id="l72.43"> </span>
<a href="#l72.44"></a><span id="l72.44">         let promptSvc = Services.prompt;</span>
<a href="#l72.45"></a><span id="l72.45"> </span>
<a href="#l72.46"></a><span id="l72.46">         let errorBoxButtonFlags = promptSvc.BUTTON_POS_0 *</span>
<a href="#l72.47"></a><span id="l72.47">                                   promptSvc.BUTTON_TITLE_IS_STRING +</span>
<a href="#l72.48"></a><span id="l72.48">                                   promptSvc.BUTTON_POS_0_DEFAULT;</span>
<a href="#l72.49"></a><span id="l72.49"> </span>
<a href="#l72.50"></a><span id="l72.50">         promptSvc.confirmEx(null,</span>
<a href="#l72.51"></a><span id="l72.51" class="difflineat">@@ -455,20 +455,20 @@ calCalendarManager.prototype = {</span>
<a href="#l72.52"></a><span id="l72.52">                 uiMessage = ex.message;</span>
<a href="#l72.53"></a><span id="l72.53">             }</span>
<a href="#l72.54"></a><span id="l72.54">             switch (rc) {</span>
<a href="#l72.55"></a><span id="l72.55">                 case Components.interfaces.calIErrors.STORAGE_UNKNOWN_SCHEMA_ERROR:</span>
<a href="#l72.56"></a><span id="l72.56">                     // For now we alert and quit on schema errors like we've done before:</span>
<a href="#l72.57"></a><span id="l72.57">                     this.alertAndQuit();</span>
<a href="#l72.58"></a><span id="l72.58">                     return null;</span>
<a href="#l72.59"></a><span id="l72.59">                 case Components.interfaces.calIErrors.STORAGE_UNKNOWN_TIMEZONES_ERROR:</span>
<a href="#l72.60"></a><span id="l72.60" class="difflineminus">-                    uiMessage = calGetString(&quot;calendar&quot;, &quot;unknownTimezonesError&quot;, [uri.spec]);</span>
<a href="#l72.61"></a><span id="l72.61" class="difflineplus">+                    uiMessage = cal.calGetString(&quot;calendar&quot;, &quot;unknownTimezonesError&quot;, [uri.spec]);</span>
<a href="#l72.62"></a><span id="l72.62">                     break;</span>
<a href="#l72.63"></a><span id="l72.63">                 default:</span>
<a href="#l72.64"></a><span id="l72.64" class="difflineminus">-                    uiMessage = calGetString(&quot;calendar&quot;, &quot;unableToCreateProvider&quot;, [uri.spec]);</span>
<a href="#l72.65"></a><span id="l72.65" class="difflineplus">+                    uiMessage = cal.calGetString(&quot;calendar&quot;, &quot;unableToCreateProvider&quot;, [uri.spec]);</span>
<a href="#l72.66"></a><span id="l72.66">                     break;</span>
<a href="#l72.67"></a><span id="l72.67">             }</span>
<a href="#l72.68"></a><span id="l72.68">             // Log the original exception via error console to provide more debug info</span>
<a href="#l72.69"></a><span id="l72.69">             cal.ERROR(ex);</span>
<a href="#l72.70"></a><span id="l72.70"> </span>
<a href="#l72.71"></a><span id="l72.71">             // Log the possibly translated message via the UI.</span>
<a href="#l72.72"></a><span id="l72.72">             let paramBlock = Components.classes[&quot;@mozilla.org/embedcomp/dialogparam;1&quot;]</span>
<a href="#l72.73"></a><span id="l72.73">                                        .createInstance(Components.interfaces.nsIDialogParamBlock);</span>
<a href="#l72.74"></a><span id="l72.74" class="difflineat">@@ -939,30 +939,30 @@ calMgrCalendarObserver.prototype = {</span>
<a href="#l72.75"></a><span id="l72.75">         switch (aErrNo) {</span>
<a href="#l72.76"></a><span id="l72.76">             case calIErrors.CAL_UTF8_DECODING_FAILED:</span>
<a href="#l72.77"></a><span id="l72.77">                 message = props.GetStringFromName(&quot;utf8DecodeError&quot;);</span>
<a href="#l72.78"></a><span id="l72.78">                 break;</span>
<a href="#l72.79"></a><span id="l72.79">             case calIErrors.ICS_MALFORMEDDATA:</span>
<a href="#l72.80"></a><span id="l72.80">                 message = props.GetStringFromName(&quot;icsMalformedError&quot;);</span>
<a href="#l72.81"></a><span id="l72.81">                 break;</span>
<a href="#l72.82"></a><span id="l72.82">             case calIErrors.MODIFICATION_FAILED:</span>
<a href="#l72.83"></a><span id="l72.83" class="difflineminus">-                errMsg = calGetString(&quot;calendar&quot;, &quot;errorWriting&quot;, [aCalendar.name]);</span>
<a href="#l72.84"></a><span id="l72.84" class="difflineplus">+                errMsg = cal.calGetString(&quot;calendar&quot;, &quot;errorWriting&quot;, [aCalendar.name]);</span>
<a href="#l72.85"></a><span id="l72.85">                 // falls through</span>
<a href="#l72.86"></a><span id="l72.86">             default:</span>
<a href="#l72.87"></a><span id="l72.87">                 message = aMessage;</span>
<a href="#l72.88"></a><span id="l72.88">         }</span>
<a href="#l72.89"></a><span id="l72.89"> </span>
<a href="#l72.90"></a><span id="l72.90"> </span>
<a href="#l72.91"></a><span id="l72.91">         paramBlock.SetString(0, errMsg);</span>
<a href="#l72.92"></a><span id="l72.92">         paramBlock.SetString(1, errCode);</span>
<a href="#l72.93"></a><span id="l72.93">         paramBlock.SetString(2, message);</span>
<a href="#l72.94"></a><span id="l72.94"> </span>
<a href="#l72.95"></a><span id="l72.95">         this.storedReadOnly = this.calendar.readOnly;</span>
<a href="#l72.96"></a><span id="l72.96" class="difflineminus">-        let errorCode = calGetString(&quot;calendar&quot;, &quot;errorCode&quot;, [errCode]);</span>
<a href="#l72.97"></a><span id="l72.97" class="difflineminus">-        let errorDescription = calGetString(&quot;calendar&quot;, &quot;errorDescription&quot;, [message]);</span>
<a href="#l72.98"></a><span id="l72.98" class="difflineplus">+        let errorCode = cal.calGetString(&quot;calendar&quot;, &quot;errorCode&quot;, [errCode]);</span>
<a href="#l72.99"></a><span id="l72.99" class="difflineplus">+        let errorDescription = cal.calGetString(&quot;calendar&quot;, &quot;errorDescription&quot;, [message]);</span>
<a href="#l72.100"></a><span id="l72.100">         let summary = errMsg + &quot; &quot; + errorCode + &quot;. &quot; + errorDescription;</span>
<a href="#l72.101"></a><span id="l72.101"> </span>
<a href="#l72.102"></a><span id="l72.102">         // Log warnings in error console.</span>
<a href="#l72.103"></a><span id="l72.103">         // Report serious errors in both error console and in prompt window.</span>
<a href="#l72.104"></a><span id="l72.104">         if (aErrNo == calIErrors.MODIFICATION_FAILED) {</span>
<a href="#l72.105"></a><span id="l72.105">             Components.utils.reportError(summary);</span>
<a href="#l72.106"></a><span id="l72.106">             this.announceParamBlock(paramBlock);</span>
<a href="#l72.107"></a><span id="l72.107">         } else {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l73.1"></a><span id="l73.1" class="difflineminus">--- a/calendar/base/src/calCalendarSearchService.js</span>
<a href="#l73.2"></a><span id="l73.2" class="difflineplus">+++ b/calendar/base/src/calCalendarSearchService.js</span>
<a href="#l73.3"></a><span id="l73.3" class="difflineat">@@ -1,18 +1,20 @@</span>
<a href="#l73.4"></a><span id="l73.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l73.5"></a><span id="l73.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l73.6"></a><span id="l73.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l73.7"></a><span id="l73.7"> </span>
<a href="#l73.8"></a><span id="l73.8" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l73.9"></a><span id="l73.9" class="difflineplus">+</span>
<a href="#l73.10"></a><span id="l73.10"> function calCalendarSearchListener(numOperations, finalListener) {</span>
<a href="#l73.11"></a><span id="l73.11">     this.mFinalListener = finalListener;</span>
<a href="#l73.12"></a><span id="l73.12">     this.mNumOperations = numOperations;</span>
<a href="#l73.13"></a><span id="l73.13">     this.mResults = [];</span>
<a href="#l73.14"></a><span id="l73.14"> </span>
<a href="#l73.15"></a><span id="l73.15" class="difflineminus">-    this.opGroup = new calOperationGroup(() =&gt; {</span>
<a href="#l73.16"></a><span id="l73.16" class="difflineplus">+    this.opGroup = new cal.calOperationGroup(() =&gt; {</span>
<a href="#l73.17"></a><span id="l73.17">         this.notifyResult(null);</span>
<a href="#l73.18"></a><span id="l73.18">     });</span>
<a href="#l73.19"></a><span id="l73.19"> }</span>
<a href="#l73.20"></a><span id="l73.20"> calCalendarSearchListener.prototype = {</span>
<a href="#l73.21"></a><span id="l73.21">     mFinalListener: null,</span>
<a href="#l73.22"></a><span id="l73.22">     mNumOperations: 0,</span>
<a href="#l73.23"></a><span id="l73.23">     opGroup: null,</span>
<a href="#l73.24"></a><span id="l73.24"> </span>
<a href="#l73.25"></a><span id="l73.25" class="difflineat">@@ -39,17 +41,17 @@ calCalendarSearchListener.prototype = {</span>
<a href="#l73.26"></a><span id="l73.26">                 this.notifyResult(aResult);</span>
<a href="#l73.27"></a><span id="l73.27">             }</span>
<a href="#l73.28"></a><span id="l73.28">         }</span>
<a href="#l73.29"></a><span id="l73.29">     }</span>
<a href="#l73.30"></a><span id="l73.30"> };</span>
<a href="#l73.31"></a><span id="l73.31"> </span>
<a href="#l73.32"></a><span id="l73.32"> function calCalendarSearchService() {</span>
<a href="#l73.33"></a><span id="l73.33">     this.wrappedJSObject = this;</span>
<a href="#l73.34"></a><span id="l73.34" class="difflineminus">-    this.mProviders = new calInterfaceBag(Components.interfaces.calICalendarSearchProvider);</span>
<a href="#l73.35"></a><span id="l73.35" class="difflineplus">+    this.mProviders = new cal.calInterfaceBag(Components.interfaces.calICalendarSearchProvider);</span>
<a href="#l73.36"></a><span id="l73.36"> }</span>
<a href="#l73.37"></a><span id="l73.37"> var calCalendarSearchServiceClassID = Components.ID(&quot;{f5f743cd-8997-428e-bc1b-644e73f61203}&quot;);</span>
<a href="#l73.38"></a><span id="l73.38"> var calCalendarSearchServiceInterfaces = [</span>
<a href="#l73.39"></a><span id="l73.39">     Components.interfaces.calICalendarSearchProvider,</span>
<a href="#l73.40"></a><span id="l73.40">     Components.interfaces.calICalendarSearchService</span>
<a href="#l73.41"></a><span id="l73.41"> ];</span>
<a href="#l73.42"></a><span id="l73.42"> calCalendarSearchService.prototype = {</span>
<a href="#l73.43"></a><span id="l73.43">     mProviders: null,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l74.1"></a><span id="l74.1" class="difflineminus">--- a/calendar/base/src/calDateTimeFormatter.js</span>
<a href="#l74.2"></a><span id="l74.2" class="difflineplus">+++ b/calendar/base/src/calDateTimeFormatter.js</span>
<a href="#l74.3"></a><span id="l74.3" class="difflineat">@@ -97,25 +97,25 @@ calDateTimeFormatter.prototype = {</span>
<a href="#l74.4"></a><span id="l74.4">         // TODO should we check for the same day? The caller should know what</span>
<a href="#l74.5"></a><span id="l74.5">         // he is doing...</span>
<a href="#l74.6"></a><span id="l74.6">         return this.formatTime(aStartDate) + &quot;\u2013&quot; + this.formatTime(aEndDate);</span>
<a href="#l74.7"></a><span id="l74.7">     },</span>
<a href="#l74.8"></a><span id="l74.8"> </span>
<a href="#l74.9"></a><span id="l74.9">     formatInterval: function(aStartDate, aEndDate) {</span>
<a href="#l74.10"></a><span id="l74.10">         // Check for tasks without start and/or due date</span>
<a href="#l74.11"></a><span id="l74.11">         if (aEndDate == null &amp;&amp; aStartDate == null) {</span>
<a href="#l74.12"></a><span id="l74.12" class="difflineminus">-            return calGetString(&quot;calendar&quot;, &quot;datetimeIntervalTaskWithoutDate&quot;);</span>
<a href="#l74.13"></a><span id="l74.13" class="difflineplus">+            return cal.calGetString(&quot;calendar&quot;, &quot;datetimeIntervalTaskWithoutDate&quot;);</span>
<a href="#l74.14"></a><span id="l74.14">         } else if (aEndDate == null) {</span>
<a href="#l74.15"></a><span id="l74.15">             let startDateString = this.formatDate(aStartDate);</span>
<a href="#l74.16"></a><span id="l74.16">             let startTime = this.formatTime(aStartDate);</span>
<a href="#l74.17"></a><span id="l74.17" class="difflineminus">-            return calGetString(&quot;calendar&quot;, &quot;datetimeIntervalTaskWithoutDueDate&quot;, [startDateString, startTime]);</span>
<a href="#l74.18"></a><span id="l74.18" class="difflineplus">+            return cal.calGetString(&quot;calendar&quot;, &quot;datetimeIntervalTaskWithoutDueDate&quot;, [startDateString, startTime]);</span>
<a href="#l74.19"></a><span id="l74.19">         } else if (aStartDate == null) {</span>
<a href="#l74.20"></a><span id="l74.20">             let endDateString = this.formatDate(aEndDate);</span>
<a href="#l74.21"></a><span id="l74.21">             let endTime = this.formatTime(aEndDate);</span>
<a href="#l74.22"></a><span id="l74.22" class="difflineminus">-            return calGetString(&quot;calendar&quot;, &quot;datetimeIntervalTaskWithoutStartDate&quot;, [endDateString, endTime]);</span>
<a href="#l74.23"></a><span id="l74.23" class="difflineplus">+            return cal.calGetString(&quot;calendar&quot;, &quot;datetimeIntervalTaskWithoutStartDate&quot;, [endDateString, endTime]);</span>
<a href="#l74.24"></a><span id="l74.24">         }</span>
<a href="#l74.25"></a><span id="l74.25">         // Here there are only events or tasks with both start and due date.</span>
<a href="#l74.26"></a><span id="l74.26">         // make sure start and end use the same timezone when formatting intervals:</span>
<a href="#l74.27"></a><span id="l74.27">         let endDate = aEndDate.getInTimezone(aStartDate.timezone);</span>
<a href="#l74.28"></a><span id="l74.28">         let testdate = aStartDate.clone();</span>
<a href="#l74.29"></a><span id="l74.29">         testdate.isDate = true;</span>
<a href="#l74.30"></a><span id="l74.30">         let sameDay = (testdate.compare(endDate) == 0);</span>
<a href="#l74.31"></a><span id="l74.31">         if (aStartDate.isDate) {</span>
<a href="#l74.32"></a><span id="l74.32" class="difflineat">@@ -146,41 +146,41 @@ calDateTimeFormatter.prototype = {</span>
<a href="#l74.33"></a><span id="l74.33">             let endDateString = this.formatDate(endDate);</span>
<a href="#l74.34"></a><span id="l74.34">             let endTime = this.formatTime(endDate);</span>
<a href="#l74.35"></a><span id="l74.35">             // non-allday, so need to return date and time</span>
<a href="#l74.36"></a><span id="l74.36">             if (sameDay) {</span>
<a href="#l74.37"></a><span id="l74.37">                 // End is on the same day as start, so we can leave out the end date</span>
<a href="#l74.38"></a><span id="l74.38">                 if (startTime == endTime) {</span>
<a href="#l74.39"></a><span id="l74.39">                     // End time is on the same time as start, so we can leave out the end time</span>
<a href="#l74.40"></a><span id="l74.40">                     // &quot;5 Jan 2006 13:00&quot;</span>
<a href="#l74.41"></a><span id="l74.41" class="difflineminus">-                    return calGetString(&quot;calendar&quot;, &quot;datetimeIntervalOnSameDateTime&quot;, [startDateString, startTime]);</span>
<a href="#l74.42"></a><span id="l74.42" class="difflineplus">+                    return cal.calGetString(&quot;calendar&quot;, &quot;datetimeIntervalOnSameDateTime&quot;, [startDateString, startTime]);</span>
<a href="#l74.43"></a><span id="l74.43">                 } else {</span>
<a href="#l74.44"></a><span id="l74.44">                     // still include end time</span>
<a href="#l74.45"></a><span id="l74.45">                     // &quot;5 Jan 2006 13:00 - 17:00&quot;</span>
<a href="#l74.46"></a><span id="l74.46" class="difflineminus">-                    return calGetString(&quot;calendar&quot;, &quot;datetimeIntervalOnSameDay&quot;, [startDateString, startTime, endTime]);</span>
<a href="#l74.47"></a><span id="l74.47" class="difflineplus">+                    return cal.calGetString(&quot;calendar&quot;, &quot;datetimeIntervalOnSameDay&quot;, [startDateString, startTime, endTime]);</span>
<a href="#l74.48"></a><span id="l74.48">                 }</span>
<a href="#l74.49"></a><span id="l74.49">             } else {</span>
<a href="#l74.50"></a><span id="l74.50">                 // Spanning multiple days, so need to include date and time</span>
<a href="#l74.51"></a><span id="l74.51">                 // for start and end</span>
<a href="#l74.52"></a><span id="l74.52">                 // &quot;5 Jan 2006 13:00 - 7 Jan 2006 9:00&quot;</span>
<a href="#l74.53"></a><span id="l74.53" class="difflineminus">-                return calGetString(&quot;calendar&quot;, &quot;datetimeIntervalOnSeveralDays&quot;, [startDateString, startTime, endDateString, endTime]);</span>
<a href="#l74.54"></a><span id="l74.54" class="difflineplus">+                return cal.calGetString(&quot;calendar&quot;, &quot;datetimeIntervalOnSeveralDays&quot;, [startDateString, startTime, endDateString, endTime]);</span>
<a href="#l74.55"></a><span id="l74.55">             }</span>
<a href="#l74.56"></a><span id="l74.56">         }</span>
<a href="#l74.57"></a><span id="l74.57">     },</span>
<a href="#l74.58"></a><span id="l74.58"> </span>
<a href="#l74.59"></a><span id="l74.59">     formatDayWithOrdinal: function(aDay) {</span>
<a href="#l74.60"></a><span id="l74.60">         let ordinalSymbols = this.mDateStringBundle.GetStringFromName(&quot;dayOrdinalSymbol&quot;).split(&quot;,&quot;);</span>
<a href="#l74.61"></a><span id="l74.61">         let dayOrdinalSymbol = ordinalSymbols[aDay - 1] || ordinalSymbols[0];</span>
<a href="#l74.62"></a><span id="l74.62">         return aDay + dayOrdinalSymbol;</span>
<a href="#l74.63"></a><span id="l74.63">     },</span>
<a href="#l74.64"></a><span id="l74.64"> </span>
<a href="#l74.65"></a><span id="l74.65">     _getItemDates: function(aItem) {</span>
<a href="#l74.66"></a><span id="l74.66" class="difflineminus">-        let start = aItem[calGetStartDateProp(aItem)];</span>
<a href="#l74.67"></a><span id="l74.67" class="difflineminus">-        let end = aItem[calGetEndDateProp(aItem)];</span>
<a href="#l74.68"></a><span id="l74.68" class="difflineminus">-        let kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l74.69"></a><span id="l74.69" class="difflineplus">+        let start = aItem[cal.calGetStartDateProp(aItem)];</span>
<a href="#l74.70"></a><span id="l74.70" class="difflineplus">+        let end = aItem[cal.calGetEndDateProp(aItem)];</span>
<a href="#l74.71"></a><span id="l74.71" class="difflineplus">+        let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l74.72"></a><span id="l74.72">         // Check for tasks without start and/or due date</span>
<a href="#l74.73"></a><span id="l74.73">         if (start) {</span>
<a href="#l74.74"></a><span id="l74.74">             start = start.getInTimezone(kDefaultTimezone);</span>
<a href="#l74.75"></a><span id="l74.75">         }</span>
<a href="#l74.76"></a><span id="l74.76">         if (end) {</span>
<a href="#l74.77"></a><span id="l74.77">             end = end.getInTimezone(kDefaultTimezone);</span>
<a href="#l74.78"></a><span id="l74.78">         }</span>
<a href="#l74.79"></a><span id="l74.79">         // EndDate is exclusive. For all-day events, we ened to substract one day,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l75.1"></a><span id="l75.1" class="difflineminus">--- a/calendar/base/src/calEvent.js</span>
<a href="#l75.2"></a><span id="l75.2" class="difflineplus">+++ b/calendar/base/src/calEvent.js</span>
<a href="#l75.3"></a><span id="l75.3" class="difflineat">@@ -76,28 +76,28 @@ calEvent.prototype = {</span>
<a href="#l75.4"></a><span id="l75.4">         return this.startDate;</span>
<a href="#l75.5"></a><span id="l75.5">     },</span>
<a href="#l75.6"></a><span id="l75.6"> </span>
<a href="#l75.7"></a><span id="l75.7">     icsEventPropMap: [</span>
<a href="#l75.8"></a><span id="l75.8">     { cal: &quot;DTSTART&quot;, ics: &quot;startTime&quot; },</span>
<a href="#l75.9"></a><span id="l75.9">     { cal: &quot;DTEND&quot;, ics: &quot;endTime&quot; }],</span>
<a href="#l75.10"></a><span id="l75.10"> </span>
<a href="#l75.11"></a><span id="l75.11">     set icalString(value) {</span>
<a href="#l75.12"></a><span id="l75.12" class="difflineminus">-        this.icalComponent = getIcsService().parseICS(value, null);</span>
<a href="#l75.13"></a><span id="l75.13" class="difflineplus">+        this.icalComponent = cal.getIcsService().parseICS(value, null);</span>
<a href="#l75.14"></a><span id="l75.14">     },</span>
<a href="#l75.15"></a><span id="l75.15"> </span>
<a href="#l75.16"></a><span id="l75.16">     get icalString() {</span>
<a href="#l75.17"></a><span id="l75.17" class="difflineminus">-        let calcomp = getIcsService().createIcalComponent(&quot;VCALENDAR&quot;);</span>
<a href="#l75.18"></a><span id="l75.18" class="difflineminus">-        calSetProdidVersion(calcomp);</span>
<a href="#l75.19"></a><span id="l75.19" class="difflineplus">+        let calcomp = cal.getIcsService().createIcalComponent(&quot;VCALENDAR&quot;);</span>
<a href="#l75.20"></a><span id="l75.20" class="difflineplus">+        cal.calSetProdidVersion(calcomp);</span>
<a href="#l75.21"></a><span id="l75.21">         calcomp.addSubcomponent(this.icalComponent);</span>
<a href="#l75.22"></a><span id="l75.22">         return calcomp.serializeToICS();</span>
<a href="#l75.23"></a><span id="l75.23">     },</span>
<a href="#l75.24"></a><span id="l75.24"> </span>
<a href="#l75.25"></a><span id="l75.25">     get icalComponent() {</span>
<a href="#l75.26"></a><span id="l75.26" class="difflineminus">-        let icssvc = getIcsService();</span>
<a href="#l75.27"></a><span id="l75.27" class="difflineplus">+        let icssvc = cal.getIcsService();</span>
<a href="#l75.28"></a><span id="l75.28">         let icalcomp = icssvc.createIcalComponent(&quot;VEVENT&quot;);</span>
<a href="#l75.29"></a><span id="l75.29">         this.fillIcalComponentFromBase(icalcomp);</span>
<a href="#l75.30"></a><span id="l75.30">         this.mapPropsToICS(icalcomp, this.icsEventPropMap);</span>
<a href="#l75.31"></a><span id="l75.31"> </span>
<a href="#l75.32"></a><span id="l75.32">         let bagenum = this.propertyEnumerator;</span>
<a href="#l75.33"></a><span id="l75.33">         while (bagenum.hasMoreElements()) {</span>
<a href="#l75.34"></a><span id="l75.34">             let iprop = bagenum.getNext()</span>
<a href="#l75.35"></a><span id="l75.35">                                .QueryInterface(Components.interfaces.nsIProperty);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l76.1"></a><span id="l76.1" class="difflineminus">--- a/calendar/base/src/calFilter.js</span>
<a href="#l76.2"></a><span id="l76.2" class="difflineplus">+++ b/calendar/base/src/calFilter.js</span>
<a href="#l76.3"></a><span id="l76.3" class="difflineat">@@ -368,17 +368,17 @@ calFilter.prototype = {</span>
<a href="#l76.4"></a><span id="l76.4">     /**</span>
<a href="#l76.5"></a><span id="l76.5">      * Checks if the item matches the current filter date range.</span>
<a href="#l76.6"></a><span id="l76.6">      *</span>
<a href="#l76.7"></a><span id="l76.7">      * @param aItem               The item to check.</span>
<a href="#l76.8"></a><span id="l76.8">      * @return                    Returns true if the item falls within the date range</span>
<a href="#l76.9"></a><span id="l76.9">      *                            specified by mStartDate and mEndDate, false otherwise.</span>
<a href="#l76.10"></a><span id="l76.10">      */</span>
<a href="#l76.11"></a><span id="l76.11">     dateRangeFilter: function(aItem) {</span>
<a href="#l76.12"></a><span id="l76.12" class="difflineminus">-        return checkIfInRange(aItem, this.mStartDate, this.mEndDate);</span>
<a href="#l76.13"></a><span id="l76.13" class="difflineplus">+        return cal.checkIfInRange(aItem, this.mStartDate, this.mEndDate);</span>
<a href="#l76.14"></a><span id="l76.14">     },</span>
<a href="#l76.15"></a><span id="l76.15"> </span>
<a href="#l76.16"></a><span id="l76.16">     /**</span>
<a href="#l76.17"></a><span id="l76.17">      * Checks if the item matches the currently applied filter properties. Filter properties</span>
<a href="#l76.18"></a><span id="l76.18">      * with a value of null or that are not applicable to the item's type are not tested.</span>
<a href="#l76.19"></a><span id="l76.19">      *</span>
<a href="#l76.20"></a><span id="l76.20">      * @param aItem               The item to check.</span>
<a href="#l76.21"></a><span id="l76.21">      * @return                    Returns true if the item matches the filter properties</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l77.1"></a><span id="l77.1" class="difflineminus">--- a/calendar/base/src/calFreeBusyService.js</span>
<a href="#l77.2"></a><span id="l77.2" class="difflineplus">+++ b/calendar/base/src/calFreeBusyService.js</span>
<a href="#l77.3"></a><span id="l77.3" class="difflineat">@@ -1,19 +1,20 @@</span>
<a href="#l77.4"></a><span id="l77.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l77.5"></a><span id="l77.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l77.6"></a><span id="l77.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l77.7"></a><span id="l77.7"> </span>
<a href="#l77.8"></a><span id="l77.8"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l77.9"></a><span id="l77.9" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l77.10"></a><span id="l77.10"> </span>
<a href="#l77.11"></a><span id="l77.11"> function calFreeBusyListener(numOperations, finalListener) {</span>
<a href="#l77.12"></a><span id="l77.12">     this.mFinalListener = finalListener;</span>
<a href="#l77.13"></a><span id="l77.13">     this.mNumOperations = numOperations;</span>
<a href="#l77.14"></a><span id="l77.14"> </span>
<a href="#l77.15"></a><span id="l77.15" class="difflineminus">-    this.opGroup = new calOperationGroup(() =&gt; {</span>
<a href="#l77.16"></a><span id="l77.16" class="difflineplus">+    this.opGroup = new cal.calOperationGroup(() =&gt; {</span>
<a href="#l77.17"></a><span id="l77.17">         this.notifyResult(null);</span>
<a href="#l77.18"></a><span id="l77.18">     });</span>
<a href="#l77.19"></a><span id="l77.19"> }</span>
<a href="#l77.20"></a><span id="l77.20"> calFreeBusyListener.prototype = {</span>
<a href="#l77.21"></a><span id="l77.21">     mFinalListener: null,</span>
<a href="#l77.22"></a><span id="l77.22">     mNumOperations: 0,</span>
<a href="#l77.23"></a><span id="l77.23">     opGroup: null,</span>
<a href="#l77.24"></a><span id="l77.24"> </span>
<a href="#l77.25"></a><span id="l77.25" class="difflineat">@@ -46,17 +47,17 @@ calFreeBusyListener.prototype = {</span>
<a href="#l77.26"></a><span id="l77.26">                 this.notifyResult([]);</span>
<a href="#l77.27"></a><span id="l77.27">             }</span>
<a href="#l77.28"></a><span id="l77.28">         }</span>
<a href="#l77.29"></a><span id="l77.29">     }</span>
<a href="#l77.30"></a><span id="l77.30"> };</span>
<a href="#l77.31"></a><span id="l77.31"> </span>
<a href="#l77.32"></a><span id="l77.32"> function calFreeBusyService() {</span>
<a href="#l77.33"></a><span id="l77.33">     this.wrappedJSObject = this;</span>
<a href="#l77.34"></a><span id="l77.34" class="difflineminus">-    this.mProviders = new calInterfaceBag(Components.interfaces.calIFreeBusyProvider);</span>
<a href="#l77.35"></a><span id="l77.35" class="difflineplus">+    this.mProviders = new cal.calInterfaceBag(Components.interfaces.calIFreeBusyProvider);</span>
<a href="#l77.36"></a><span id="l77.36"> }</span>
<a href="#l77.37"></a><span id="l77.37"> var calFreeBusyServiceClassID = Components.ID(&quot;{29c56cd5-d36e-453a-acde-0083bd4fe6d3}&quot;);</span>
<a href="#l77.38"></a><span id="l77.38"> var calFreeBusyServiceInterfaces = [</span>
<a href="#l77.39"></a><span id="l77.39">     Components.interfaces.calIFreeBusyProvider,</span>
<a href="#l77.40"></a><span id="l77.40">     Components.interfaces.calIFreeBusyService</span>
<a href="#l77.41"></a><span id="l77.41"> ];</span>
<a href="#l77.42"></a><span id="l77.42"> calFreeBusyService.prototype = {</span>
<a href="#l77.43"></a><span id="l77.43">     mProviders: null,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l78.1"></a><span id="l78.1" class="difflineminus">--- a/calendar/base/src/calIcsParser.js</span>
<a href="#l78.2"></a><span id="l78.2" class="difflineplus">+++ b/calendar/base/src/calIcsParser.js</span>
<a href="#l78.3"></a><span id="l78.3" class="difflineat">@@ -70,17 +70,17 @@ calIcsParser.prototype = {</span>
<a href="#l78.4"></a><span id="l78.4"> </span>
<a href="#l78.5"></a><span id="l78.5">         state.join(() =&gt; {</span>
<a href="#l78.6"></a><span id="l78.6">             let fakedParents = {};</span>
<a href="#l78.7"></a><span id="l78.7">             // tag &quot;exceptions&quot;, i.e. items with rid:</span>
<a href="#l78.8"></a><span id="l78.8">             for (let item of state.excItems) {</span>
<a href="#l78.9"></a><span id="l78.9">                 let parent = state.uid2parent[item.id];</span>
<a href="#l78.10"></a><span id="l78.10"> </span>
<a href="#l78.11"></a><span id="l78.11">                 if (!parent) { // a parentless one, fake a master and override it's occurrence</span>
<a href="#l78.12"></a><span id="l78.12" class="difflineminus">-                    parent = isEvent(item) ? createEvent() : createTodo();</span>
<a href="#l78.13"></a><span id="l78.13" class="difflineplus">+                    parent = cal.isEvent(item) ? cal.createEvent() : cal.createTodo();</span>
<a href="#l78.14"></a><span id="l78.14">                     parent.id = item.id;</span>
<a href="#l78.15"></a><span id="l78.15">                     parent.setProperty(&quot;DTSTART&quot;, item.recurrenceId);</span>
<a href="#l78.16"></a><span id="l78.16">                     parent.setProperty(&quot;X-MOZ-FAKED-MASTER&quot;, &quot;1&quot;); // this tag might be useful in the future</span>
<a href="#l78.17"></a><span id="l78.17">                     parent.recurrenceInfo = cal.createRecurrenceInfo(parent);</span>
<a href="#l78.18"></a><span id="l78.18">                     fakedParents[item.id] = true;</span>
<a href="#l78.19"></a><span id="l78.19">                     state.uid2parent[item.id] = parent;</span>
<a href="#l78.20"></a><span id="l78.20">                     state.items.push(parent);</span>
<a href="#l78.21"></a><span id="l78.21">                 }</span>
<a href="#l78.22"></a><span id="l78.22" class="difflineat">@@ -97,18 +97,18 @@ calIcsParser.prototype = {</span>
<a href="#l78.23"></a><span id="l78.23">             }</span>
<a href="#l78.24"></a><span id="l78.24"> </span>
<a href="#l78.25"></a><span id="l78.25">             if (Object.keys(state.tzErrors).length &gt; 0) {</span>
<a href="#l78.26"></a><span id="l78.26">                 // Use an alert rather than a prompt because problems may appear in</span>
<a href="#l78.27"></a><span id="l78.27">                 // remote subscribed calendars the user cannot change.</span>
<a href="#l78.28"></a><span id="l78.28">                 if (Components.classes[&quot;@mozilla.org/alerts-service;1&quot;]) {</span>
<a href="#l78.29"></a><span id="l78.29">                     let notifier = Components.classes[&quot;@mozilla.org/alerts-service;1&quot;]</span>
<a href="#l78.30"></a><span id="l78.30">                                              .getService(Components.interfaces.nsIAlertsService);</span>
<a href="#l78.31"></a><span id="l78.31" class="difflineminus">-                    let title = calGetString(&quot;calendar&quot;, &quot;TimezoneErrorsAlertTitle&quot;);</span>
<a href="#l78.32"></a><span id="l78.32" class="difflineminus">-                    let text = calGetString(&quot;calendar&quot;, &quot;TimezoneErrorsSeeConsole&quot;);</span>
<a href="#l78.33"></a><span id="l78.33" class="difflineplus">+                    let title = cal.calGetString(&quot;calendar&quot;, &quot;TimezoneErrorsAlertTitle&quot;);</span>
<a href="#l78.34"></a><span id="l78.34" class="difflineplus">+                    let text = cal.calGetString(&quot;calendar&quot;, &quot;TimezoneErrorsSeeConsole&quot;);</span>
<a href="#l78.35"></a><span id="l78.35">                     try {</span>
<a href="#l78.36"></a><span id="l78.36">                         notifier.showAlertNotification(&quot;&quot;, title, text, false, null, null, title);</span>
<a href="#l78.37"></a><span id="l78.37">                     } catch (e) {</span>
<a href="#l78.38"></a><span id="l78.38">                         // The notifier may not be available, e.g. on xpcshell tests</span>
<a href="#l78.39"></a><span id="l78.39">                     }</span>
<a href="#l78.40"></a><span id="l78.40">                 }</span>
<a href="#l78.41"></a><span id="l78.41">             }</span>
<a href="#l78.42"></a><span id="l78.42"> </span>
<a href="#l78.43"></a><span id="l78.43" class="difflineat">@@ -242,17 +242,17 @@ parserState.prototype = {</span>
<a href="#l78.44"></a><span id="l78.44">             let hid = item.hashId + &quot;#&quot; + tzid;</span>
<a href="#l78.45"></a><span id="l78.45">             if (!(hid in this.tzErrors)) {</span>
<a href="#l78.46"></a><span id="l78.46">                 // For now, publish errors to console and alert user.</span>
<a href="#l78.47"></a><span id="l78.47">                 // In future, maybe make them available through an interface method</span>
<a href="#l78.48"></a><span id="l78.48">                 // so this UI code can be removed from the parser, and caller can</span>
<a href="#l78.49"></a><span id="l78.49">                 // choose whether to alert, or show user the problem items and ask</span>
<a href="#l78.50"></a><span id="l78.50">                 // for fixes, or something else.</span>
<a href="#l78.51"></a><span id="l78.51">                 let msgArgs = [tzid, item.title, cal.getDateFormatter().formatDateTime(date)];</span>
<a href="#l78.52"></a><span id="l78.52" class="difflineminus">-                let msg = calGetString(&quot;calendar&quot;, &quot;unknownTimezoneInItem&quot;, msgArgs);</span>
<a href="#l78.53"></a><span id="l78.53" class="difflineplus">+                let msg = cal.calGetString(&quot;calendar&quot;, &quot;unknownTimezoneInItem&quot;, msgArgs);</span>
<a href="#l78.54"></a><span id="l78.54"> </span>
<a href="#l78.55"></a><span id="l78.55">                 cal.ERROR(msg + &quot;\n&quot; + item.icalString);</span>
<a href="#l78.56"></a><span id="l78.56">                 this.tzErrors[hid] = true;</span>
<a href="#l78.57"></a><span id="l78.57">             }</span>
<a href="#l78.58"></a><span id="l78.58">         }</span>
<a href="#l78.59"></a><span id="l78.59">     },</span>
<a href="#l78.60"></a><span id="l78.60"> </span>
<a href="#l78.61"></a><span id="l78.61">     /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l79.1"></a><span id="l79.1" class="difflineminus">--- a/calendar/base/src/calIcsSerializer.js</span>
<a href="#l79.2"></a><span id="l79.2" class="difflineplus">+++ b/calendar/base/src/calIcsSerializer.js</span>
<a href="#l79.3"></a><span id="l79.3" class="difflineat">@@ -56,18 +56,18 @@ calIcsSerializer.prototype = {</span>
<a href="#l79.4"></a><span id="l79.4">                                    .createInstance(Components.interfaces.nsIConverterOutputStream);</span>
<a href="#l79.5"></a><span id="l79.5">         convStream.init(aStream, &quot;UTF-8&quot;, 0, 0x0000);</span>
<a href="#l79.6"></a><span id="l79.6"> </span>
<a href="#l79.7"></a><span id="l79.7">         convStream.writeString(str);</span>
<a href="#l79.8"></a><span id="l79.8">         convStream.close();</span>
<a href="#l79.9"></a><span id="l79.9">     },</span>
<a href="#l79.10"></a><span id="l79.10"> </span>
<a href="#l79.11"></a><span id="l79.11">     getIcalComponent: function() {</span>
<a href="#l79.12"></a><span id="l79.12" class="difflineminus">-        let calComp = getIcsService().createIcalComponent(&quot;VCALENDAR&quot;);</span>
<a href="#l79.13"></a><span id="l79.13" class="difflineminus">-        calSetProdidVersion(calComp);</span>
<a href="#l79.14"></a><span id="l79.14" class="difflineplus">+        let calComp = cal.getIcsService().createIcalComponent(&quot;VCALENDAR&quot;);</span>
<a href="#l79.15"></a><span id="l79.15" class="difflineplus">+        cal.calSetProdidVersion(calComp);</span>
<a href="#l79.16"></a><span id="l79.16"> </span>
<a href="#l79.17"></a><span id="l79.17">         // xxx todo: think about that the below code doesn't clone the properties/components,</span>
<a href="#l79.18"></a><span id="l79.18">         //           thus ownership is moved to returned VCALENDAR...</span>
<a href="#l79.19"></a><span id="l79.19"> </span>
<a href="#l79.20"></a><span id="l79.20">         for (let prop of this.mProperties) {</span>
<a href="#l79.21"></a><span id="l79.21">             calComp.addProperty(prop);</span>
<a href="#l79.22"></a><span id="l79.22">         }</span>
<a href="#l79.23"></a><span id="l79.23">         for (let comp of this.mComponents) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l80.1"></a><span id="l80.1" class="difflineminus">--- a/calendar/base/src/calItemBase.js</span>
<a href="#l80.2"></a><span id="l80.2" class="difflineplus">+++ b/calendar/base/src/calItemBase.js</span>
<a href="#l80.3"></a><span id="l80.3" class="difflineat">@@ -40,17 +40,17 @@ calItemBase.prototype = {</span>
<a href="#l80.4"></a><span id="l80.4">     mACLEntry: null,</span>
<a href="#l80.5"></a><span id="l80.5"> </span>
<a href="#l80.6"></a><span id="l80.6">     /**</span>
<a href="#l80.7"></a><span id="l80.7">      * Initialize the base item's attributes. Can be called from inheriting</span>
<a href="#l80.8"></a><span id="l80.8">      * objects in their constructor.</span>
<a href="#l80.9"></a><span id="l80.9">      */</span>
<a href="#l80.10"></a><span id="l80.10">     initItemBase: function() {</span>
<a href="#l80.11"></a><span id="l80.11">         this.wrappedJSObject = this;</span>
<a href="#l80.12"></a><span id="l80.12" class="difflineminus">-        this.mProperties = new calPropertyBag();</span>
<a href="#l80.13"></a><span id="l80.13" class="difflineplus">+        this.mProperties = new cal.calPropertyBag();</span>
<a href="#l80.14"></a><span id="l80.14">         this.mPropertyParams = {};</span>
<a href="#l80.15"></a><span id="l80.15">         this.mProperties.setProperty(&quot;CREATED&quot;, cal.jsDateToDateTime(new Date()));</span>
<a href="#l80.16"></a><span id="l80.16">     },</span>
<a href="#l80.17"></a><span id="l80.17"> </span>
<a href="#l80.18"></a><span id="l80.18">     /**</span>
<a href="#l80.19"></a><span id="l80.19">      * @see nsISupports</span>
<a href="#l80.20"></a><span id="l80.20">      */</span>
<a href="#l80.21"></a><span id="l80.21">     QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIItemBase]),</span>
<a href="#l80.22"></a><span id="l80.22" class="difflineat">@@ -77,17 +77,17 @@ calItemBase.prototype = {</span>
<a href="#l80.23"></a><span id="l80.23"> </span>
<a href="#l80.24"></a><span id="l80.24">     // readonly attribute AUTF8String hashId;</span>
<a href="#l80.25"></a><span id="l80.25">     get hashId() {</span>
<a href="#l80.26"></a><span id="l80.26">         if (this.mHashId === null) {</span>
<a href="#l80.27"></a><span id="l80.27">             let rid = this.recurrenceId;</span>
<a href="#l80.28"></a><span id="l80.28">             let calendar = this.calendar;</span>
<a href="#l80.29"></a><span id="l80.29">             // some unused delim character:</span>
<a href="#l80.30"></a><span id="l80.30">             this.mHashId = [encodeURIComponent(this.id),</span>
<a href="#l80.31"></a><span id="l80.31" class="difflineminus">-                            rid ? rid.getInTimezone(UTC()).icalString : &quot;&quot;,</span>
<a href="#l80.32"></a><span id="l80.32" class="difflineplus">+                            rid ? rid.getInTimezone(cal.UTC()).icalString : &quot;&quot;,</span>
<a href="#l80.33"></a><span id="l80.33">                             calendar ? encodeURIComponent(calendar.id) : &quot;&quot;].join(&quot;#&quot;);</span>
<a href="#l80.34"></a><span id="l80.34">         }</span>
<a href="#l80.35"></a><span id="l80.35">         return this.mHashId;</span>
<a href="#l80.36"></a><span id="l80.36">     },</span>
<a href="#l80.37"></a><span id="l80.37"> </span>
<a href="#l80.38"></a><span id="l80.38">     // attribute AUTF8String id;</span>
<a href="#l80.39"></a><span id="l80.39">     get id() {</span>
<a href="#l80.40"></a><span id="l80.40">         return this.getProperty(&quot;UID&quot;);</span>
<a href="#l80.41"></a><span id="l80.41" class="difflineat">@@ -111,45 +111,45 @@ calItemBase.prototype = {</span>
<a href="#l80.42"></a><span id="l80.42">     },</span>
<a href="#l80.43"></a><span id="l80.43"> </span>
<a href="#l80.44"></a><span id="l80.44">     // attribute calIRecurrenceInfo recurrenceInfo;</span>
<a href="#l80.45"></a><span id="l80.45">     get recurrenceInfo() {</span>
<a href="#l80.46"></a><span id="l80.46">         return this.mRecurrenceInfo;</span>
<a href="#l80.47"></a><span id="l80.47">     },</span>
<a href="#l80.48"></a><span id="l80.48">     set recurrenceInfo(value) {</span>
<a href="#l80.49"></a><span id="l80.49">         this.modify();</span>
<a href="#l80.50"></a><span id="l80.50" class="difflineminus">-        return (this.mRecurrenceInfo = calTryWrappedJSObject(value));</span>
<a href="#l80.51"></a><span id="l80.51" class="difflineplus">+        return (this.mRecurrenceInfo = cal.calTryWrappedJSObject(value));</span>
<a href="#l80.52"></a><span id="l80.52">     },</span>
<a href="#l80.53"></a><span id="l80.53"> </span>
<a href="#l80.54"></a><span id="l80.54">     // attribute calIItemBase parentItem;</span>
<a href="#l80.55"></a><span id="l80.55">     get parentItem() {</span>
<a href="#l80.56"></a><span id="l80.56">         return this.mParentItem || this;</span>
<a href="#l80.57"></a><span id="l80.57">     },</span>
<a href="#l80.58"></a><span id="l80.58">     set parentItem(value) {</span>
<a href="#l80.59"></a><span id="l80.59">         if (this.mImmutable) {</span>
<a href="#l80.60"></a><span id="l80.60">             throw Components.results.NS_ERROR_OBJECT_IS_IMMUTABLE;</span>
<a href="#l80.61"></a><span id="l80.61">         }</span>
<a href="#l80.62"></a><span id="l80.62" class="difflineminus">-        return (this.mParentItem = calTryWrappedJSObject(value));</span>
<a href="#l80.63"></a><span id="l80.63" class="difflineplus">+        return (this.mParentItem = cal.calTryWrappedJSObject(value));</span>
<a href="#l80.64"></a><span id="l80.64">     },</span>
<a href="#l80.65"></a><span id="l80.65"> </span>
<a href="#l80.66"></a><span id="l80.66">     /**</span>
<a href="#l80.67"></a><span id="l80.67">      * Initializes the base item to be an item proxy. Used by inheriting</span>
<a href="#l80.68"></a><span id="l80.68">      * objects createProxy() method.</span>
<a href="#l80.69"></a><span id="l80.69">      *</span>
<a href="#l80.70"></a><span id="l80.70">      * XXXdbo Explain proxy a bit better, either here or in</span>
<a href="#l80.71"></a><span id="l80.71">      * calIInternalShallowCopy.</span>
<a href="#l80.72"></a><span id="l80.72">      *</span>
<a href="#l80.73"></a><span id="l80.73">      * @see calIInternalShallowCopy</span>
<a href="#l80.74"></a><span id="l80.74">      * @param aParentItem     The parent item to initialize the proxy on.</span>
<a href="#l80.75"></a><span id="l80.75">      * @param aRecurrenceId   The recurrence id to initialize the proxy for.</span>
<a href="#l80.76"></a><span id="l80.76">      */</span>
<a href="#l80.77"></a><span id="l80.77">     initializeProxy: function(aParentItem, aRecurrenceId) {</span>
<a href="#l80.78"></a><span id="l80.78">         this.mIsProxy = true;</span>
<a href="#l80.79"></a><span id="l80.79"> </span>
<a href="#l80.80"></a><span id="l80.80" class="difflineminus">-        aParentItem = calTryWrappedJSObject(aParentItem);</span>
<a href="#l80.81"></a><span id="l80.81" class="difflineplus">+        aParentItem = cal.calTryWrappedJSObject(aParentItem);</span>
<a href="#l80.82"></a><span id="l80.82">         this.mParentItem = aParentItem;</span>
<a href="#l80.83"></a><span id="l80.83">         this.mCalendar = aParentItem.mCalendar;</span>
<a href="#l80.84"></a><span id="l80.84">         this.recurrenceId = aRecurrenceId;</span>
<a href="#l80.85"></a><span id="l80.85"> </span>
<a href="#l80.86"></a><span id="l80.86">         // Make sure organizer is unset, as the getter checks for this.</span>
<a href="#l80.87"></a><span id="l80.87">         this.mOrganizer = undefined;</span>
<a href="#l80.88"></a><span id="l80.88"> </span>
<a href="#l80.89"></a><span id="l80.89">         this.mImmutable = aParentItem.mImmutable;</span>
<a href="#l80.90"></a><span id="l80.90" class="difflineat">@@ -246,36 +246,36 @@ calItemBase.prototype = {</span>
<a href="#l80.91"></a><span id="l80.91">      *</span>
<a href="#l80.92"></a><span id="l80.92">      * @param m     The item to clone this item into</span>
<a href="#l80.93"></a><span id="l80.93">      * @param aNewParent    (optional) The new parent item to set on m.</span>
<a href="#l80.94"></a><span id="l80.94">      */</span>
<a href="#l80.95"></a><span id="l80.95">     cloneItemBaseInto: function(cloned, aNewParent) {</span>
<a href="#l80.96"></a><span id="l80.96">         cloned.mImmutable = false;</span>
<a href="#l80.97"></a><span id="l80.97">         cloned.mACLEntry = this.mACLEntry;</span>
<a href="#l80.98"></a><span id="l80.98">         cloned.mIsProxy = this.mIsProxy;</span>
<a href="#l80.99"></a><span id="l80.99" class="difflineminus">-        cloned.mParentItem = calTryWrappedJSObject(aNewParent) || this.mParentItem;</span>
<a href="#l80.100"></a><span id="l80.100" class="difflineplus">+        cloned.mParentItem = cal.calTryWrappedJSObject(aNewParent) || this.mParentItem;</span>
<a href="#l80.101"></a><span id="l80.101">         cloned.mHashId = this.mHashId;</span>
<a href="#l80.102"></a><span id="l80.102">         cloned.mCalendar = this.mCalendar;</span>
<a href="#l80.103"></a><span id="l80.103">         if (this.mRecurrenceInfo) {</span>
<a href="#l80.104"></a><span id="l80.104" class="difflineminus">-            cloned.mRecurrenceInfo = calTryWrappedJSObject(this.mRecurrenceInfo.clone());</span>
<a href="#l80.105"></a><span id="l80.105" class="difflineplus">+            cloned.mRecurrenceInfo = cal.calTryWrappedJSObject(this.mRecurrenceInfo.clone());</span>
<a href="#l80.106"></a><span id="l80.106">             cloned.mRecurrenceInfo.item = cloned;</span>
<a href="#l80.107"></a><span id="l80.107">         }</span>
<a href="#l80.108"></a><span id="l80.108"> </span>
<a href="#l80.109"></a><span id="l80.109">         let org = this.organizer;</span>
<a href="#l80.110"></a><span id="l80.110">         if (org) {</span>
<a href="#l80.111"></a><span id="l80.111">             org = org.clone();</span>
<a href="#l80.112"></a><span id="l80.112">         }</span>
<a href="#l80.113"></a><span id="l80.113">         cloned.mOrganizer = org;</span>
<a href="#l80.114"></a><span id="l80.114"> </span>
<a href="#l80.115"></a><span id="l80.115">         cloned.mAttendees = [];</span>
<a href="#l80.116"></a><span id="l80.116">         for (let att of this.getAttendees({})) {</span>
<a href="#l80.117"></a><span id="l80.117">             cloned.mAttendees.push(att.clone());</span>
<a href="#l80.118"></a><span id="l80.118">         }</span>
<a href="#l80.119"></a><span id="l80.119"> </span>
<a href="#l80.120"></a><span id="l80.120" class="difflineminus">-        cloned.mProperties = new calPropertyBag();</span>
<a href="#l80.121"></a><span id="l80.121" class="difflineplus">+        cloned.mProperties = new cal.calPropertyBag();</span>
<a href="#l80.122"></a><span id="l80.122">         for (let [name, value] of this.mProperties) {</span>
<a href="#l80.123"></a><span id="l80.123">             if (value instanceof Components.interfaces.calIDateTime) {</span>
<a href="#l80.124"></a><span id="l80.124">                 value = value.clone();</span>
<a href="#l80.125"></a><span id="l80.125">             }</span>
<a href="#l80.126"></a><span id="l80.126"> </span>
<a href="#l80.127"></a><span id="l80.127">             cloned.mProperties.setProperty(name, value);</span>
<a href="#l80.128"></a><span id="l80.128"> </span>
<a href="#l80.129"></a><span id="l80.129">             let propBucket = this.mPropertyParams[name];</span>
<a href="#l80.130"></a><span id="l80.130" class="difflineat">@@ -320,17 +320,17 @@ calItemBase.prototype = {</span>
<a href="#l80.131"></a><span id="l80.131"> </span>
<a href="#l80.132"></a><span id="l80.132">     // attribute calIDateTime alarmLastAck;</span>
<a href="#l80.133"></a><span id="l80.133">     get alarmLastAck() {</span>
<a href="#l80.134"></a><span id="l80.134">         return this.mAlarmLastAck;</span>
<a href="#l80.135"></a><span id="l80.135">     },</span>
<a href="#l80.136"></a><span id="l80.136">     set alarmLastAck(aValue) {</span>
<a href="#l80.137"></a><span id="l80.137">         this.modify();</span>
<a href="#l80.138"></a><span id="l80.138">         if (aValue &amp;&amp; !aValue.timezone.isUTC) {</span>
<a href="#l80.139"></a><span id="l80.139" class="difflineminus">-            aValue = aValue.getInTimezone(UTC());</span>
<a href="#l80.140"></a><span id="l80.140" class="difflineplus">+            aValue = aValue.getInTimezone(cal.UTC());</span>
<a href="#l80.141"></a><span id="l80.141">         }</span>
<a href="#l80.142"></a><span id="l80.142">         return (this.mAlarmLastAck = aValue);</span>
<a href="#l80.143"></a><span id="l80.143">     },</span>
<a href="#l80.144"></a><span id="l80.144"> </span>
<a href="#l80.145"></a><span id="l80.145">     // readonly attribute calIDateTime lastModifiedTime;</span>
<a href="#l80.146"></a><span id="l80.146">     get lastModifiedTime() {</span>
<a href="#l80.147"></a><span id="l80.147">         this.ensureNotDirty();</span>
<a href="#l80.148"></a><span id="l80.148">         return this.getProperty(&quot;LAST-MODIFIED&quot;);</span>
<a href="#l80.149"></a><span id="l80.149" class="difflineat">@@ -822,17 +822,17 @@ calItemBase.prototype = {</span>
<a href="#l80.150"></a><span id="l80.150">      *</span>
<a href="#l80.151"></a><span id="l80.151">      * @param icalcomp      The ical component to read.</span>
<a href="#l80.152"></a><span id="l80.152">      */</span>
<a href="#l80.153"></a><span id="l80.153">     setItemBaseFromICS: function(icalcomp) {</span>
<a href="#l80.154"></a><span id="l80.154">         this.modify();</span>
<a href="#l80.155"></a><span id="l80.155"> </span>
<a href="#l80.156"></a><span id="l80.156">         // re-initializing from scratch -- no light proxy anymore:</span>
<a href="#l80.157"></a><span id="l80.157">         this.mIsProxy = false;</span>
<a href="#l80.158"></a><span id="l80.158" class="difflineminus">-        this.mProperties = new calPropertyBag();</span>
<a href="#l80.159"></a><span id="l80.159" class="difflineplus">+        this.mProperties = new cal.calPropertyBag();</span>
<a href="#l80.160"></a><span id="l80.160">         this.mPropertyParams = {};</span>
<a href="#l80.161"></a><span id="l80.161"> </span>
<a href="#l80.162"></a><span id="l80.162">         this.mapPropsFromICS(icalcomp, this.icsBasePropMap);</span>
<a href="#l80.163"></a><span id="l80.163"> </span>
<a href="#l80.164"></a><span id="l80.164">         this.mAttendees = []; // don't inherit anything from parent</span>
<a href="#l80.165"></a><span id="l80.165">         for (let attprop of cal.ical.propertyIterator(icalcomp, &quot;ATTENDEE&quot;)) {</span>
<a href="#l80.166"></a><span id="l80.166">             let att = new calAttendee();</span>
<a href="#l80.167"></a><span id="l80.167">             att.icalProperty = attprop;</span>
<a href="#l80.168"></a><span id="l80.168" class="difflineat">@@ -1078,17 +1078,17 @@ calItemBase.prototype = {</span>
<a href="#l80.169"></a><span id="l80.169">     // void getOccurrencesBetween (in calIDateTime aStartDate, in calIDateTime aEndDate,</span>
<a href="#l80.170"></a><span id="l80.170">     //                             out PRUint32 aCount,</span>
<a href="#l80.171"></a><span id="l80.171">     //                             [array,size_is(aCount),retval] out calIItemBase aOccurrences);</span>
<a href="#l80.172"></a><span id="l80.172">     getOccurrencesBetween: function(aStartDate, aEndDate, aCount) {</span>
<a href="#l80.173"></a><span id="l80.173">         if (this.recurrenceInfo) {</span>
<a href="#l80.174"></a><span id="l80.174">             return this.recurrenceInfo.getOccurrences(aStartDate, aEndDate, 0, aCount);</span>
<a href="#l80.175"></a><span id="l80.175">         }</span>
<a href="#l80.176"></a><span id="l80.176"> </span>
<a href="#l80.177"></a><span id="l80.177" class="difflineminus">-        if (checkIfInRange(this, aStartDate, aEndDate)) {</span>
<a href="#l80.178"></a><span id="l80.178" class="difflineplus">+        if (cal.checkIfInRange(this, aStartDate, aEndDate)) {</span>
<a href="#l80.179"></a><span id="l80.179">             aCount.value = 1;</span>
<a href="#l80.180"></a><span id="l80.180">             return [this];</span>
<a href="#l80.181"></a><span id="l80.181">         }</span>
<a href="#l80.182"></a><span id="l80.182"> </span>
<a href="#l80.183"></a><span id="l80.183">         aCount.value = 0;</span>
<a href="#l80.184"></a><span id="l80.184">         return [];</span>
<a href="#l80.185"></a><span id="l80.185">     }</span>
<a href="#l80.186"></a><span id="l80.186"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l81.1"></a><span id="l81.1" class="difflineminus">--- a/calendar/base/src/calItemModule.js</span>
<a href="#l81.2"></a><span id="l81.2" class="difflineplus">+++ b/calendar/base/src/calItemModule.js</span>
<a href="#l81.3"></a><span id="l81.3" class="difflineat">@@ -1,17 +1,16 @@</span>
<a href="#l81.4"></a><span id="l81.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l81.5"></a><span id="l81.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l81.6"></a><span id="l81.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l81.7"></a><span id="l81.7"> </span>
<a href="#l81.8"></a><span id="l81.8"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l81.9"></a><span id="l81.9"> </span>
<a href="#l81.10"></a><span id="l81.10"> var scriptLoadOrder = [</span>
<a href="#l81.11"></a><span id="l81.11">     &quot;calItemBase.js&quot;,</span>
<a href="#l81.12"></a><span id="l81.12" class="difflineminus">-    &quot;calUtils.js&quot;,</span>
<a href="#l81.13"></a><span id="l81.13">     &quot;calCachedCalendar.js&quot;,</span>
<a href="#l81.14"></a><span id="l81.14"> </span>
<a href="#l81.15"></a><span id="l81.15">     &quot;calAlarm.js&quot;,</span>
<a href="#l81.16"></a><span id="l81.16">     &quot;calAlarmService.js&quot;,</span>
<a href="#l81.17"></a><span id="l81.17">     &quot;calAlarmMonitor.js&quot;,</span>
<a href="#l81.18"></a><span id="l81.18">     &quot;calAttendee.js&quot;,</span>
<a href="#l81.19"></a><span id="l81.19">     &quot;calAttachment.js&quot;,</span>
<a href="#l81.20"></a><span id="l81.20">     &quot;calCalendarManager.js&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l82.1"></a><span id="l82.1" class="difflineminus">--- a/calendar/base/src/calRecurrenceInfo.js</span>
<a href="#l82.2"></a><span id="l82.2" class="difflineplus">+++ b/calendar/base/src/calRecurrenceInfo.js</span>
<a href="#l82.3"></a><span id="l82.3" class="difflineat">@@ -6,17 +6,17 @@ Components.utils.import(&quot;resource://cale</span>
<a href="#l82.4"></a><span id="l82.4"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l82.5"></a><span id="l82.5"> </span>
<a href="#l82.6"></a><span id="l82.6"> function getRidKey(date) {</span>
<a href="#l82.7"></a><span id="l82.7">     if (!date) {</span>
<a href="#l82.8"></a><span id="l82.8">         return null;</span>
<a href="#l82.9"></a><span id="l82.9">     }</span>
<a href="#l82.10"></a><span id="l82.10">     let timezone = date.timezone;</span>
<a href="#l82.11"></a><span id="l82.11">     if (!timezone.isUTC &amp;&amp; !timezone.isFloating) {</span>
<a href="#l82.12"></a><span id="l82.12" class="difflineminus">-        date = date.getInTimezone(UTC());</span>
<a href="#l82.13"></a><span id="l82.13" class="difflineplus">+        date = date.getInTimezone(cal.UTC());</span>
<a href="#l82.14"></a><span id="l82.14">     }</span>
<a href="#l82.15"></a><span id="l82.15">     return date.icalString;</span>
<a href="#l82.16"></a><span id="l82.16"> }</span>
<a href="#l82.17"></a><span id="l82.17"> </span>
<a href="#l82.18"></a><span id="l82.18"> function calRecurrenceInfo() {</span>
<a href="#l82.19"></a><span id="l82.19">     this.mRecurrenceItems = [];</span>
<a href="#l82.20"></a><span id="l82.20">     this.mExceptionMap = {};</span>
<a href="#l82.21"></a><span id="l82.21"> </span>
<a href="#l82.22"></a><span id="l82.22" class="difflineat">@@ -119,17 +119,17 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l82.23"></a><span id="l82.23">      * calIRecurrenceInfo</span>
<a href="#l82.24"></a><span id="l82.24">      */</span>
<a href="#l82.25"></a><span id="l82.25">     get item() {</span>
<a href="#l82.26"></a><span id="l82.26">         return this.mBaseItem;</span>
<a href="#l82.27"></a><span id="l82.27">     },</span>
<a href="#l82.28"></a><span id="l82.28">     set item(value) {</span>
<a href="#l82.29"></a><span id="l82.29">         this.ensureMutable();</span>
<a href="#l82.30"></a><span id="l82.30"> </span>
<a href="#l82.31"></a><span id="l82.31" class="difflineminus">-        value = calTryWrappedJSObject(value);</span>
<a href="#l82.32"></a><span id="l82.32" class="difflineplus">+        value = cal.calTryWrappedJSObject(value);</span>
<a href="#l82.33"></a><span id="l82.33">         this.mBaseItem = value;</span>
<a href="#l82.34"></a><span id="l82.34">         // patch exception's parentItem:</span>
<a href="#l82.35"></a><span id="l82.35">         for (let ex in this.mExceptionMap) {</span>
<a href="#l82.36"></a><span id="l82.36">             let exitem = this.mExceptionMap[ex];</span>
<a href="#l82.37"></a><span id="l82.37">             exitem.parentItem = value;</span>
<a href="#l82.38"></a><span id="l82.38">         }</span>
<a href="#l82.39"></a><span id="l82.39">     },</span>
<a href="#l82.40"></a><span id="l82.40"> </span>
<a href="#l82.41"></a><span id="l82.41" class="difflineat">@@ -281,19 +281,19 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l82.42"></a><span id="l82.42">                                                   null,</span>
<a href="#l82.43"></a><span id="l82.43">                                                   0,</span>
<a href="#l82.44"></a><span id="l82.44">                                                   {});</span>
<a href="#l82.45"></a><span id="l82.45">                 // Map all negative dates.</span>
<a href="#l82.46"></a><span id="l82.46">                 for (let rdate of rdates) {</span>
<a href="#l82.47"></a><span id="l82.47">                     negMap[getRidKey(rdate)] = true;</span>
<a href="#l82.48"></a><span id="l82.48">                 }</span>
<a href="#l82.49"></a><span id="l82.49">             } else {</span>
<a href="#l82.50"></a><span id="l82.50" class="difflineminus">-                WARN(&quot;Item '&quot; + this.mBaseItem.title + &quot;'&quot; +</span>
<a href="#l82.51"></a><span id="l82.51" class="difflineminus">-                     (this.mBaseItem.calendar ? &quot; (&quot; + this.mBaseItem.calendar.name + &quot;)&quot; : &quot;&quot;) +</span>
<a href="#l82.52"></a><span id="l82.52" class="difflineminus">-                     &quot; has an infinite negative rule (EXRULE)&quot;);</span>
<a href="#l82.53"></a><span id="l82.53" class="difflineplus">+                cal.WARN(&quot;Item '&quot; + this.mBaseItem.title + &quot;'&quot; +</span>
<a href="#l82.54"></a><span id="l82.54" class="difflineplus">+                         (this.mBaseItem.calendar ? &quot; (&quot; + this.mBaseItem.calendar.name + &quot;)&quot; : &quot;&quot;) +</span>
<a href="#l82.55"></a><span id="l82.55" class="difflineplus">+                         &quot; has an infinite negative rule (EXRULE)&quot;);</span>
<a href="#l82.56"></a><span id="l82.56">             }</span>
<a href="#l82.57"></a><span id="l82.57">         }</span>
<a href="#l82.58"></a><span id="l82.58"> </span>
<a href="#l82.59"></a><span id="l82.59">         let bailCounter = 0;</span>
<a href="#l82.60"></a><span id="l82.60">         do {</span>
<a href="#l82.61"></a><span id="l82.61">             invalidOccurrences = 0;</span>
<a href="#l82.62"></a><span id="l82.62">             // Go through all positive rules and get the next recurrence id</span>
<a href="#l82.63"></a><span id="l82.63">             // according to that rule. If for all rules the rid is &quot;invalid&quot;,</span>
<a href="#l82.64"></a><span id="l82.64" class="difflineat">@@ -359,17 +359,17 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l82.65"></a><span id="l82.65">                     }</span>
<a href="#l82.66"></a><span id="l82.66">                 }</span>
<a href="#l82.67"></a><span id="l82.67">             }</span>
<a href="#l82.68"></a><span id="l82.68"> </span>
<a href="#l82.69"></a><span id="l82.69">             // To make sure users don't just report bugs like &quot;the application</span>
<a href="#l82.70"></a><span id="l82.70">             // hangs&quot;, bail out after 100 runs. If this happens, it is most</span>
<a href="#l82.71"></a><span id="l82.71">             // likely a bug.</span>
<a href="#l82.72"></a><span id="l82.72">             if (bailCounter++ &gt; 100) {</span>
<a href="#l82.73"></a><span id="l82.73" class="difflineminus">-                ERROR(&quot;Could not find next occurrence after 100 runs!&quot;);</span>
<a href="#l82.74"></a><span id="l82.74" class="difflineplus">+                cal.ERROR(&quot;Could not find next occurrence after 100 runs!&quot;);</span>
<a href="#l82.75"></a><span id="l82.75">                 return null;</span>
<a href="#l82.76"></a><span id="l82.76">             }</span>
<a href="#l82.77"></a><span id="l82.77"> </span>
<a href="#l82.78"></a><span id="l82.78">             // We counted how many positive rules found out that their next</span>
<a href="#l82.79"></a><span id="l82.79">             // candidate is invalid. If all rules produce invalid next</span>
<a href="#l82.80"></a><span id="l82.80">             // occurrences, a second round is needed.</span>
<a href="#l82.81"></a><span id="l82.81">         } while (invalidOccurrences == this.mPositiveRules.length);</span>
<a href="#l82.82"></a><span id="l82.82"> </span>
<a href="#l82.83"></a><span id="l82.83" class="difflineat">@@ -402,17 +402,17 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l82.84"></a><span id="l82.84">         // TODO libical currently does not provide us with easy means of</span>
<a href="#l82.85"></a><span id="l82.85">         // getting the previous occurrence. This could be fixed to improve</span>
<a href="#l82.86"></a><span id="l82.86">         // performance greatly. Filed as libical feature request 1944020.</span>
<a href="#l82.87"></a><span id="l82.87"> </span>
<a href="#l82.88"></a><span id="l82.88">         // HACK We never know how early an RDATE might be before the actual</span>
<a href="#l82.89"></a><span id="l82.89">         // recurrence start. Since rangeStart cannot be null for recurrence</span>
<a href="#l82.90"></a><span id="l82.90">         // items like calIRecurrenceRule, we need to work around by supplying a</span>
<a href="#l82.91"></a><span id="l82.91">         // very early date. Again, this might have a high performance penalty.</span>
<a href="#l82.92"></a><span id="l82.92" class="difflineminus">-        let early = createDateTime();</span>
<a href="#l82.93"></a><span id="l82.93" class="difflineplus">+        let early = cal.createDateTime();</span>
<a href="#l82.94"></a><span id="l82.94">         early.icalString = &quot;00000101T000000Z&quot;;</span>
<a href="#l82.95"></a><span id="l82.95"> </span>
<a href="#l82.96"></a><span id="l82.96">         let rids = this.calculateDates(early,</span>
<a href="#l82.97"></a><span id="l82.97">                                        aTime,</span>
<a href="#l82.98"></a><span id="l82.98">                                        0);</span>
<a href="#l82.99"></a><span id="l82.99">         // The returned dates are sorted, so the last one is a good</span>
<a href="#l82.100"></a><span id="l82.100">         // candidate, if it exists.</span>
<a href="#l82.101"></a><span id="l82.101">         return (rids.length &gt; 0 ? this.getOccurrenceFor(rids[rids.length - 1].id) : null);</span>
<a href="#l82.102"></a><span id="l82.102" class="difflineat">@@ -423,18 +423,18 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l82.103"></a><span id="l82.103">         this.ensureBaseItem();</span>
<a href="#l82.104"></a><span id="l82.104">         this.ensureSortedRecurrenceRules();</span>
<a href="#l82.105"></a><span id="l82.105"> </span>
<a href="#l82.106"></a><span id="l82.106">         function ridDateSortComptor(a, b) {</span>
<a href="#l82.107"></a><span id="l82.107">             return a.rstart.compare(b.rstart);</span>
<a href="#l82.108"></a><span id="l82.108">         }</span>
<a href="#l82.109"></a><span id="l82.109"> </span>
<a href="#l82.110"></a><span id="l82.110">         // workaround for UTC- timezones</span>
<a href="#l82.111"></a><span id="l82.111" class="difflineminus">-        let rangeStart = ensureDateTime(aRangeStart);</span>
<a href="#l82.112"></a><span id="l82.112" class="difflineminus">-        let rangeEnd = ensureDateTime(aRangeEnd);</span>
<a href="#l82.113"></a><span id="l82.113" class="difflineplus">+        let rangeStart = cal.ensureDateTime(aRangeStart);</span>
<a href="#l82.114"></a><span id="l82.114" class="difflineplus">+        let rangeEnd = cal.ensureDateTime(aRangeEnd);</span>
<a href="#l82.115"></a><span id="l82.115"> </span>
<a href="#l82.116"></a><span id="l82.116">         // If aRangeStart falls in the middle of an occurrence, libical will</span>
<a href="#l82.117"></a><span id="l82.117">         // not return that occurrence when we go and ask for an</span>
<a href="#l82.118"></a><span id="l82.118">         // icalrecur_iterator_new.  This actually seems fairly rational, so</span>
<a href="#l82.119"></a><span id="l82.119">         // instead of hacking libical, I'm going to move aRangeStart back far</span>
<a href="#l82.120"></a><span id="l82.120">         // enough to make sure we get the occurrences we might miss.</span>
<a href="#l82.121"></a><span id="l82.121">         let searchStart = rangeStart.clone();</span>
<a href="#l82.122"></a><span id="l82.122">         let baseDuration = this.mBaseItem.duration;</span>
<a href="#l82.123"></a><span id="l82.123" class="difflineat">@@ -454,30 +454,30 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l82.124"></a><span id="l82.124"> </span>
<a href="#l82.125"></a><span id="l82.125">         let dates = [];</span>
<a href="#l82.126"></a><span id="l82.126"> </span>
<a href="#l82.127"></a><span id="l82.127">         // toss in exceptions first. Save a map of all exceptions ids, so we</span>
<a href="#l82.128"></a><span id="l82.128">         // don't add the wrong occurrences later on.</span>
<a href="#l82.129"></a><span id="l82.129">         let occurrenceMap = {};</span>
<a href="#l82.130"></a><span id="l82.130">         for (let ex in this.mExceptionMap) {</span>
<a href="#l82.131"></a><span id="l82.131">             let item = this.mExceptionMap[ex];</span>
<a href="#l82.132"></a><span id="l82.132" class="difflineminus">-            let occDate = checkIfInRange(item, aRangeStart, aRangeEnd, true);</span>
<a href="#l82.133"></a><span id="l82.133" class="difflineplus">+            let occDate = cal.checkIfInRange(item, aRangeStart, aRangeEnd, true);</span>
<a href="#l82.134"></a><span id="l82.134">             occurrenceMap[ex] = true;</span>
<a href="#l82.135"></a><span id="l82.135">             if (occDate) {</span>
<a href="#l82.136"></a><span id="l82.136" class="difflineminus">-                binaryInsert(dates, { id: item.recurrenceId, rstart: occDate }, ridDateSortComptor);</span>
<a href="#l82.137"></a><span id="l82.137" class="difflineplus">+                cal.binaryInsert(dates, { id: item.recurrenceId, rstart: occDate }, ridDateSortComptor);</span>
<a href="#l82.138"></a><span id="l82.138">             }</span>
<a href="#l82.139"></a><span id="l82.139">         }</span>
<a href="#l82.140"></a><span id="l82.140"> </span>
<a href="#l82.141"></a><span id="l82.141">         // DTSTART/DUE is always part of the (positive) expanded set:</span>
<a href="#l82.142"></a><span id="l82.142">         // DTSTART always equals RECURRENCE-ID for items expanded from RRULE</span>
<a href="#l82.143"></a><span id="l82.143" class="difflineminus">-        let baseOccDate = checkIfInRange(this.mBaseItem, aRangeStart, aRangeEnd, true);</span>
<a href="#l82.144"></a><span id="l82.144" class="difflineplus">+        let baseOccDate = cal.checkIfInRange(this.mBaseItem, aRangeStart, aRangeEnd, true);</span>
<a href="#l82.145"></a><span id="l82.145">         let baseOccDateKey = getRidKey(baseOccDate);</span>
<a href="#l82.146"></a><span id="l82.146">         if (baseOccDate &amp;&amp; !occurrenceMap[baseOccDateKey]) {</span>
<a href="#l82.147"></a><span id="l82.147">             occurrenceMap[baseOccDateKey] = true;</span>
<a href="#l82.148"></a><span id="l82.148" class="difflineminus">-            binaryInsert(dates, { id: baseOccDate, rstart: baseOccDate }, ridDateSortComptor);</span>
<a href="#l82.149"></a><span id="l82.149" class="difflineplus">+            cal.binaryInsert(dates, { id: baseOccDate, rstart: baseOccDate }, ridDateSortComptor);</span>
<a href="#l82.150"></a><span id="l82.150">         }</span>
<a href="#l82.151"></a><span id="l82.151"> </span>
<a href="#l82.152"></a><span id="l82.152">         // if both range start and end are specified, we ask for all of the occurrences,</span>
<a href="#l82.153"></a><span id="l82.153">         // to make sure we catch all possible exceptions.  If aRangeEnd isn't specified,</span>
<a href="#l82.154"></a><span id="l82.154">         // then we have to ask for aMaxCount, and hope for the best.</span>
<a href="#l82.155"></a><span id="l82.155">         let maxCount;</span>
<a href="#l82.156"></a><span id="l82.156">         if (rangeStart &amp;&amp; rangeEnd) {</span>
<a href="#l82.157"></a><span id="l82.157">             maxCount = 0;</span>
<a href="#l82.158"></a><span id="l82.158" class="difflineat">@@ -516,17 +516,17 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l82.159"></a><span id="l82.159">                 let dateKey = getRidKey(date);</span>
<a href="#l82.160"></a><span id="l82.160">                 if (occurrenceMap[dateKey]) {</span>
<a href="#l82.161"></a><span id="l82.161">                     // Don't add occurrences twice (i.e exception was</span>
<a href="#l82.162"></a><span id="l82.162">                     // already added before)</span>
<a href="#l82.163"></a><span id="l82.163">                     continue;</span>
<a href="#l82.164"></a><span id="l82.164">                 }</span>
<a href="#l82.165"></a><span id="l82.165">                 // TODO if cur_dates[] is also sorted, then this binary</span>
<a href="#l82.166"></a><span id="l82.166">                 // search could be optimized further</span>
<a href="#l82.167"></a><span id="l82.167" class="difflineminus">-                binaryInsert(dates, { id: date, rstart: date }, ridDateSortComptor);</span>
<a href="#l82.168"></a><span id="l82.168" class="difflineplus">+                cal.binaryInsert(dates, { id: date, rstart: date }, ridDateSortComptor);</span>
<a href="#l82.169"></a><span id="l82.169">                 occurrenceMap[dateKey] = true;</span>
<a href="#l82.170"></a><span id="l82.170">             }</span>
<a href="#l82.171"></a><span id="l82.171">         }</span>
<a href="#l82.172"></a><span id="l82.172"> </span>
<a href="#l82.173"></a><span id="l82.173">         // Apply negative rules</span>
<a href="#l82.174"></a><span id="l82.174">         for (let ritem of this.mNegativeRules) {</span>
<a href="#l82.175"></a><span id="l82.175">             let cur_dates = ritem.getOccurrences(startDate,</span>
<a href="#l82.176"></a><span id="l82.176">                                                  searchStart,</span>
<a href="#l82.177"></a><span id="l82.177" class="difflineat">@@ -670,26 +670,26 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l82.178"></a><span id="l82.178">     // This implementation does the first approach (RECURRENCE-ID will</span>
<a href="#l82.179"></a><span id="l82.179">     // never change even if DTSTART for that instance changes), which</span>
<a href="#l82.180"></a><span id="l82.180">     // I think is the right thing to do for CalDAV; I don't know what</span>
<a href="#l82.181"></a><span id="l82.181">     // we'll do for incoming ITIP events though.</span>
<a href="#l82.182"></a><span id="l82.182">     //</span>
<a href="#l82.183"></a><span id="l82.183">     modifyException: function(anItem, aTakeOverOwnership) {</span>
<a href="#l82.184"></a><span id="l82.184">         this.ensureBaseItem();</span>
<a href="#l82.185"></a><span id="l82.185"> </span>
<a href="#l82.186"></a><span id="l82.186" class="difflineminus">-        anItem = calTryWrappedJSObject(anItem);</span>
<a href="#l82.187"></a><span id="l82.187" class="difflineplus">+        anItem = cal.calTryWrappedJSObject(anItem);</span>
<a href="#l82.188"></a><span id="l82.188"> </span>
<a href="#l82.189"></a><span id="l82.189">         if (anItem.parentItem.calendar != this.mBaseItem.calendar &amp;&amp;</span>
<a href="#l82.190"></a><span id="l82.190">             anItem.parentItem.id != this.mBaseItem.id) {</span>
<a href="#l82.191"></a><span id="l82.191" class="difflineminus">-            ERROR(&quot;recurrenceInfo::addException: item parentItem != this.mBaseItem (calendar/id)!&quot;);</span>
<a href="#l82.192"></a><span id="l82.192" class="difflineplus">+            cal.ERROR(&quot;recurrenceInfo::addException: item parentItem != this.mBaseItem (calendar/id)!&quot;);</span>
<a href="#l82.193"></a><span id="l82.193">             throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l82.194"></a><span id="l82.194">         }</span>
<a href="#l82.195"></a><span id="l82.195"> </span>
<a href="#l82.196"></a><span id="l82.196">         if (anItem.recurrenceId == null) {</span>
<a href="#l82.197"></a><span id="l82.197" class="difflineminus">-            ERROR(&quot;recurrenceInfo::addException: item with null recurrenceId!&quot;);</span>
<a href="#l82.198"></a><span id="l82.198" class="difflineplus">+            cal.ERROR(&quot;recurrenceInfo::addException: item with null recurrenceId!&quot;);</span>
<a href="#l82.199"></a><span id="l82.199">             throw Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l82.200"></a><span id="l82.200">         }</span>
<a href="#l82.201"></a><span id="l82.201"> </span>
<a href="#l82.202"></a><span id="l82.202">         let itemtoadd;</span>
<a href="#l82.203"></a><span id="l82.203">         if (aTakeOverOwnership &amp;&amp; anItem.isMutable) {</span>
<a href="#l82.204"></a><span id="l82.204">             itemtoadd = anItem;</span>
<a href="#l82.205"></a><span id="l82.205">             itemtoadd.parentItem = this.mBaseItem;</span>
<a href="#l82.206"></a><span id="l82.206">         } else {</span>
<a href="#l82.207"></a><span id="l82.207" class="difflineat">@@ -739,17 +739,17 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l82.208"></a><span id="l82.208">         cal.ASSERT(aNewStartTime, &quot;invalid arg!&quot;, true);</span>
<a href="#l82.209"></a><span id="l82.209"> </span>
<a href="#l82.210"></a><span id="l82.210">         // no need to check for changes if there's no previous starttime.</span>
<a href="#l82.211"></a><span id="l82.211">         if (!aOldStartTime) {</span>
<a href="#l82.212"></a><span id="l82.212">             return;</span>
<a href="#l82.213"></a><span id="l82.213">         }</span>
<a href="#l82.214"></a><span id="l82.214"> </span>
<a href="#l82.215"></a><span id="l82.215">         // convert both dates to UTC since subtractDate is not timezone aware.</span>
<a href="#l82.216"></a><span id="l82.216" class="difflineminus">-        let timeDiff = aNewStartTime.getInTimezone(UTC()).subtractDate(aOldStartTime.getInTimezone(UTC()));</span>
<a href="#l82.217"></a><span id="l82.217" class="difflineplus">+        let timeDiff = aNewStartTime.getInTimezone(cal.UTC()).subtractDate(aOldStartTime.getInTimezone(cal.UTC()));</span>
<a href="#l82.218"></a><span id="l82.218"> </span>
<a href="#l82.219"></a><span id="l82.219">         let rdates = {};</span>
<a href="#l82.220"></a><span id="l82.220"> </span>
<a href="#l82.221"></a><span id="l82.221">         // take RDATE's and EXDATE's into account.</span>
<a href="#l82.222"></a><span id="l82.222">         const kCalIRecurrenceDate = Components.interfaces.calIRecurrenceDate;</span>
<a href="#l82.223"></a><span id="l82.223">         let ritems = this.getRecurrenceItems({});</span>
<a href="#l82.224"></a><span id="l82.224">         for (let ritem of ritems) {</span>
<a href="#l82.225"></a><span id="l82.225">             let rDateInstance = cal.wrapInstance(ritem, kCalIRecurrenceDate);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l83.1"></a><span id="l83.1" class="difflineminus">--- a/calendar/base/src/calRelation.js</span>
<a href="#l83.2"></a><span id="l83.2" class="difflineplus">+++ b/calendar/base/src/calRelation.js</span>
<a href="#l83.3"></a><span id="l83.3" class="difflineat">@@ -9,17 +9,17 @@ Components.utils.import(&quot;resource://gre/</span>
<a href="#l83.4"></a><span id="l83.4"> /**</span>
<a href="#l83.5"></a><span id="l83.5">  * calRelation prototype definition</span>
<a href="#l83.6"></a><span id="l83.6">  *</span>
<a href="#l83.7"></a><span id="l83.7">  * @implements calIRelation</span>
<a href="#l83.8"></a><span id="l83.8">  * @constructor</span>
<a href="#l83.9"></a><span id="l83.9">  */</span>
<a href="#l83.10"></a><span id="l83.10"> function calRelation() {</span>
<a href="#l83.11"></a><span id="l83.11">     this.wrappedJSObject = this;</span>
<a href="#l83.12"></a><span id="l83.12" class="difflineminus">-    this.mProperties = new calPropertyBag();</span>
<a href="#l83.13"></a><span id="l83.13" class="difflineplus">+    this.mProperties = new cal.calPropertyBag();</span>
<a href="#l83.14"></a><span id="l83.14"> }</span>
<a href="#l83.15"></a><span id="l83.15"> var calRelationClassID = Components.ID(&quot;{76810fae-abad-4019-917a-08e95d5bbd68}&quot;);</span>
<a href="#l83.16"></a><span id="l83.16"> var calRelationInterfaces = [Components.interfaces.calIRelation];</span>
<a href="#l83.17"></a><span id="l83.17"> calRelation.prototype = {</span>
<a href="#l83.18"></a><span id="l83.18">     mType: null,</span>
<a href="#l83.19"></a><span id="l83.19">     mId: null,</span>
<a href="#l83.20"></a><span id="l83.20"> </span>
<a href="#l83.21"></a><span id="l83.21">     classID: calRelationClassID,</span>
<a href="#l83.22"></a><span id="l83.22" class="difflineat">@@ -45,17 +45,17 @@ calRelation.prototype = {</span>
<a href="#l83.23"></a><span id="l83.23">     get relId() {</span>
<a href="#l83.24"></a><span id="l83.24">         return this.mId;</span>
<a href="#l83.25"></a><span id="l83.25">     },</span>
<a href="#l83.26"></a><span id="l83.26">     set relId(aRelId) {</span>
<a href="#l83.27"></a><span id="l83.27">         return (this.mId = aRelId);</span>
<a href="#l83.28"></a><span id="l83.28">     },</span>
<a href="#l83.29"></a><span id="l83.29"> </span>
<a href="#l83.30"></a><span id="l83.30">     get icalProperty() {</span>
<a href="#l83.31"></a><span id="l83.31" class="difflineminus">-        let icssvc = getIcsService();</span>
<a href="#l83.32"></a><span id="l83.32" class="difflineplus">+        let icssvc = cal.getIcsService();</span>
<a href="#l83.33"></a><span id="l83.33">         let icalatt = icssvc.createIcalProperty(&quot;RELATED-TO&quot;);</span>
<a href="#l83.34"></a><span id="l83.34">         if (this.mId) {</span>
<a href="#l83.35"></a><span id="l83.35">             icalatt.value = this.mId;</span>
<a href="#l83.36"></a><span id="l83.36">         }</span>
<a href="#l83.37"></a><span id="l83.37"> </span>
<a href="#l83.38"></a><span id="l83.38">         if (this.mType) {</span>
<a href="#l83.39"></a><span id="l83.39">             icalatt.setParameter(&quot;RELTYPE&quot;, this.mType);</span>
<a href="#l83.40"></a><span id="l83.40">         }</span>
<a href="#l83.41"></a><span id="l83.41" class="difflineat">@@ -74,17 +74,17 @@ calRelation.prototype = {</span>
<a href="#l83.42"></a><span id="l83.42">             }</span>
<a href="#l83.43"></a><span id="l83.43">         }</span>
<a href="#l83.44"></a><span id="l83.44">         return icalatt;</span>
<a href="#l83.45"></a><span id="l83.45">     },</span>
<a href="#l83.46"></a><span id="l83.46"> </span>
<a href="#l83.47"></a><span id="l83.47">     set icalProperty(attProp) {</span>
<a href="#l83.48"></a><span id="l83.48">         // Reset the property bag for the parameters, it will be re-initialized</span>
<a href="#l83.49"></a><span id="l83.49">         // from the ical property.</span>
<a href="#l83.50"></a><span id="l83.50" class="difflineminus">-        this.mProperties = new calPropertyBag();</span>
<a href="#l83.51"></a><span id="l83.51" class="difflineplus">+        this.mProperties = new cal.calPropertyBag();</span>
<a href="#l83.52"></a><span id="l83.52"> </span>
<a href="#l83.53"></a><span id="l83.53">         if (attProp.value) {</span>
<a href="#l83.54"></a><span id="l83.54">             this.mId = attProp.value;</span>
<a href="#l83.55"></a><span id="l83.55">         }</span>
<a href="#l83.56"></a><span id="l83.56">         for (let [name, value] of cal.ical.paramIterator(attProp)) {</span>
<a href="#l83.57"></a><span id="l83.57">             if (name == &quot;RELTYPE&quot;) {</span>
<a href="#l83.58"></a><span id="l83.58">                 this.mType = value;</span>
<a href="#l83.59"></a><span id="l83.59">                 continue;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l84.1"></a><span id="l84.1" class="difflineminus">--- a/calendar/base/src/calTodo.js</span>
<a href="#l84.2"></a><span id="l84.2" class="difflineplus">+++ b/calendar/base/src/calTodo.js</span>
<a href="#l84.3"></a><span id="l84.3" class="difflineat">@@ -114,28 +114,28 @@ calTodo.prototype = {</span>
<a href="#l84.4"></a><span id="l84.4">     },</span>
<a href="#l84.5"></a><span id="l84.5"> </span>
<a href="#l84.6"></a><span id="l84.6">     icsEventPropMap: [</span>
<a href="#l84.7"></a><span id="l84.7">     { cal: &quot;DTSTART&quot;, ics: &quot;startTime&quot; },</span>
<a href="#l84.8"></a><span id="l84.8">     { cal: &quot;DUE&quot;, ics: &quot;dueTime&quot; },</span>
<a href="#l84.9"></a><span id="l84.9">     { cal: &quot;COMPLETED&quot;, ics: &quot;completedTime&quot; }],</span>
<a href="#l84.10"></a><span id="l84.10"> </span>
<a href="#l84.11"></a><span id="l84.11">     set icalString(value) {</span>
<a href="#l84.12"></a><span id="l84.12" class="difflineminus">-        this.icalComponent = getIcsService().parseICS(value, null);</span>
<a href="#l84.13"></a><span id="l84.13" class="difflineplus">+        this.icalComponent = cal.getIcsService().parseICS(value, null);</span>
<a href="#l84.14"></a><span id="l84.14">     },</span>
<a href="#l84.15"></a><span id="l84.15"> </span>
<a href="#l84.16"></a><span id="l84.16">     get icalString() {</span>
<a href="#l84.17"></a><span id="l84.17" class="difflineminus">-        let calcomp = getIcsService().createIcalComponent(&quot;VCALENDAR&quot;);</span>
<a href="#l84.18"></a><span id="l84.18" class="difflineminus">-        calSetProdidVersion(calcomp);</span>
<a href="#l84.19"></a><span id="l84.19" class="difflineplus">+        let calcomp = cal.getIcsService().createIcalComponent(&quot;VCALENDAR&quot;);</span>
<a href="#l84.20"></a><span id="l84.20" class="difflineplus">+        cal.calSetProdidVersion(calcomp);</span>
<a href="#l84.21"></a><span id="l84.21">         calcomp.addSubcomponent(this.icalComponent);</span>
<a href="#l84.22"></a><span id="l84.22">         return calcomp.serializeToICS();</span>
<a href="#l84.23"></a><span id="l84.23">     },</span>
<a href="#l84.24"></a><span id="l84.24"> </span>
<a href="#l84.25"></a><span id="l84.25">     get icalComponent() {</span>
<a href="#l84.26"></a><span id="l84.26" class="difflineminus">-        let icssvc = getIcsService();</span>
<a href="#l84.27"></a><span id="l84.27" class="difflineplus">+        let icssvc = cal.getIcsService();</span>
<a href="#l84.28"></a><span id="l84.28">         let icalcomp = icssvc.createIcalComponent(&quot;VTODO&quot;);</span>
<a href="#l84.29"></a><span id="l84.29">         this.fillIcalComponentFromBase(icalcomp);</span>
<a href="#l84.30"></a><span id="l84.30">         this.mapPropsToICS(icalcomp, this.icsEventPropMap);</span>
<a href="#l84.31"></a><span id="l84.31"> </span>
<a href="#l84.32"></a><span id="l84.32">         let bagenum = this.propertyEnumerator;</span>
<a href="#l84.33"></a><span id="l84.33">         while (bagenum.hasMoreElements()) {</span>
<a href="#l84.34"></a><span id="l84.34">             let iprop = bagenum.getNext()</span>
<a href="#l84.35"></a><span id="l84.35">                                .QueryInterface(Components.interfaces.nsIProperty);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l85.1"></a><span id="l85.1" class="difflineminus">--- a/calendar/base/src/calTransactionManager.js</span>
<a href="#l85.2"></a><span id="l85.2" class="difflineplus">+++ b/calendar/base/src/calTransactionManager.js</span>
<a href="#l85.3"></a><span id="l85.3" class="difflineat">@@ -1,12 +1,13 @@</span>
<a href="#l85.4"></a><span id="l85.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l85.5"></a><span id="l85.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l85.6"></a><span id="l85.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l85.7"></a><span id="l85.7"> </span>
<a href="#l85.8"></a><span id="l85.8" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l85.9"></a><span id="l85.9"> Components.utils.import(&quot;resource://calendar/modules/calItipUtils.jsm&quot;);</span>
<a href="#l85.10"></a><span id="l85.10"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l85.11"></a><span id="l85.11"> </span>
<a href="#l85.12"></a><span id="l85.12"> function calTransactionManager() {</span>
<a href="#l85.13"></a><span id="l85.13">     this.wrappedJSObject = this;</span>
<a href="#l85.14"></a><span id="l85.14">     if (!this.transactionManager) {</span>
<a href="#l85.15"></a><span id="l85.15">         this.transactionManager =</span>
<a href="#l85.16"></a><span id="l85.16">             Components.classes[&quot;@mozilla.org/transactionmanager;1&quot;]</span>
<a href="#l85.17"></a><span id="l85.17" class="difflineat">@@ -44,18 +45,18 @@ calTransactionManager.prototype = {</span>
<a href="#l85.18"></a><span id="l85.18"> </span>
<a href="#l85.19"></a><span id="l85.19">     endBatch: function() {</span>
<a href="#l85.20"></a><span id="l85.20">         this.transactionManager.endBatch(false);</span>
<a href="#l85.21"></a><span id="l85.21">     },</span>
<a href="#l85.22"></a><span id="l85.22"> </span>
<a href="#l85.23"></a><span id="l85.23">     checkWritable: function(transaction) {</span>
<a href="#l85.24"></a><span id="l85.24">         function checkItem(item) {</span>
<a href="#l85.25"></a><span id="l85.25">             return item &amp;&amp; item.calendar &amp;&amp;</span>
<a href="#l85.26"></a><span id="l85.26" class="difflineminus">-                   isCalendarWritable(item.calendar) &amp;&amp;</span>
<a href="#l85.27"></a><span id="l85.27" class="difflineminus">-                   userCanAddItemsToCalendar(item.calendar);</span>
<a href="#l85.28"></a><span id="l85.28" class="difflineplus">+                   cal.isCalendarWritable(item.calendar) &amp;&amp;</span>
<a href="#l85.29"></a><span id="l85.29" class="difflineplus">+                   cal.userCanAddItemsToCalendar(item.calendar);</span>
<a href="#l85.30"></a><span id="l85.30">         }</span>
<a href="#l85.31"></a><span id="l85.31"> </span>
<a href="#l85.32"></a><span id="l85.32">         let trans = transaction &amp;&amp; transaction.wrappedJSObject;</span>
<a href="#l85.33"></a><span id="l85.33">         return trans &amp;&amp; checkItem(trans.mItem) &amp;&amp; checkItem(trans.mOldItem);</span>
<a href="#l85.34"></a><span id="l85.34">     },</span>
<a href="#l85.35"></a><span id="l85.35"> </span>
<a href="#l85.36"></a><span id="l85.36">     undo: function() {</span>
<a href="#l85.37"></a><span id="l85.37">         this.transactionManager.undoTransaction();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l86.1"></a><span id="l86.1" class="difflineminus">--- a/calendar/base/src/calUtils.js</span>
<a href="#l86.2"></a><span id="l86.2" class="difflineplus">+++ b/calendar/base/src/calUtils.js</span>
<a href="#l86.3"></a><span id="l86.3" class="difflineat">@@ -350,50 +350,54 @@ function attendeeMatchesAddresses(anAtte</span>
<a href="#l86.4"></a><span id="l86.4"> function userCanRespondToInvitation(aItem) {</span>
<a href="#l86.5"></a><span id="l86.5">     let aclEntry = aItem.aclEntry;</span>
<a href="#l86.6"></a><span id="l86.6">     return userCanModifyItem(aItem) || aclEntry.userCanRespond;</span>
<a href="#l86.7"></a><span id="l86.7"> }</span>
<a href="#l86.8"></a><span id="l86.8"> </span>
<a href="#l86.9"></a><span id="l86.9"> /**</span>
<a href="#l86.10"></a><span id="l86.10">  * Opens the Create Calendar wizard</span>
<a href="#l86.11"></a><span id="l86.11">  *</span>
<a href="#l86.12"></a><span id="l86.12" class="difflineplus">+ * @param aWindow The window to show the dialog in.</span>
<a href="#l86.13"></a><span id="l86.13">  * @param aCallback  a function to be performed after calendar creation</span>
<a href="#l86.14"></a><span id="l86.14">  */</span>
<a href="#l86.15"></a><span id="l86.15" class="difflineminus">-function openCalendarWizard(aCallback) {</span>
<a href="#l86.16"></a><span id="l86.16" class="difflineminus">-    openDialog(&quot;chrome://calendar/content/calendarCreation.xul&quot;, &quot;caEditServer&quot;,</span>
<a href="#l86.17"></a><span id="l86.17" class="difflineminus">-               // Workaround for Bug 1151440 - the HTML color picker won't work</span>
<a href="#l86.18"></a><span id="l86.18" class="difflineminus">-               // in linux when opened from modal dialog</span>
<a href="#l86.19"></a><span id="l86.19" class="difflineminus">-               AppConstants.platform == &quot;linux&quot;</span>
<a href="#l86.20"></a><span id="l86.20" class="difflineminus">-                   ? &quot;chrome,titlebar,resizable&quot;</span>
<a href="#l86.21"></a><span id="l86.21" class="difflineminus">-                   : &quot;modal,chrome,titlebar,resizable&quot;,</span>
<a href="#l86.22"></a><span id="l86.22" class="difflineminus">-               aCallback);</span>
<a href="#l86.23"></a><span id="l86.23" class="difflineplus">+function openCalendarWizard(aWindow, aCallback) {</span>
<a href="#l86.24"></a><span id="l86.24" class="difflineplus">+    aWindow.openDialog(&quot;chrome://calendar/content/calendarCreation.xul&quot;, &quot;caEditServer&quot;,</span>
<a href="#l86.25"></a><span id="l86.25" class="difflineplus">+                       // Workaround for Bug 1151440 - the HTML color picker won't work</span>
<a href="#l86.26"></a><span id="l86.26" class="difflineplus">+                       // in linux when opened from modal dialog</span>
<a href="#l86.27"></a><span id="l86.27" class="difflineplus">+                       AppConstants.platform == &quot;linux&quot;</span>
<a href="#l86.28"></a><span id="l86.28" class="difflineplus">+                           ? &quot;chrome,titlebar,resizable&quot;</span>
<a href="#l86.29"></a><span id="l86.29" class="difflineplus">+                           : &quot;modal,chrome,titlebar,resizable&quot;,</span>
<a href="#l86.30"></a><span id="l86.30" class="difflineplus">+                       aCallback);</span>
<a href="#l86.31"></a><span id="l86.31"> }</span>
<a href="#l86.32"></a><span id="l86.32"> </span>
<a href="#l86.33"></a><span id="l86.33"> /**</span>
<a href="#l86.34"></a><span id="l86.34">  * Opens the calendar properties window for aCalendar</span>
<a href="#l86.35"></a><span id="l86.35">  *</span>
<a href="#l86.36"></a><span id="l86.36" class="difflineplus">+ * @param aWindow The window to show the dialog in.</span>
<a href="#l86.37"></a><span id="l86.37">  * @param aCalendar  the calendar whose properties should be displayed</span>
<a href="#l86.38"></a><span id="l86.38">  */</span>
<a href="#l86.39"></a><span id="l86.39" class="difflineminus">-function openCalendarProperties(aCalendar) {</span>
<a href="#l86.40"></a><span id="l86.40" class="difflineminus">-    openDialog(&quot;chrome://calendar/content/calendar-properties-dialog.xul&quot;,</span>
<a href="#l86.41"></a><span id="l86.41" class="difflineminus">-               &quot;CalendarPropertiesDialog&quot;,</span>
<a href="#l86.42"></a><span id="l86.42" class="difflineminus">-               // Workaround for Bug 1151440 - the HTML color picker won't work</span>
<a href="#l86.43"></a><span id="l86.43" class="difflineminus">-               // in linux when opened from modal dialog</span>
<a href="#l86.44"></a><span id="l86.44" class="difflineminus">-               AppConstants.platform == &quot;linux&quot;</span>
<a href="#l86.45"></a><span id="l86.45" class="difflineminus">-                   ? &quot;chrome,titlebar,resizable&quot;</span>
<a href="#l86.46"></a><span id="l86.46" class="difflineminus">-                   : &quot;modal,chrome,titlebar,resizable&quot;,</span>
<a href="#l86.47"></a><span id="l86.47" class="difflineminus">-               { calendar: aCalendar });</span>
<a href="#l86.48"></a><span id="l86.48" class="difflineplus">+function openCalendarProperties(aWindow, aCalendar) {</span>
<a href="#l86.49"></a><span id="l86.49" class="difflineplus">+    aWindow.openDialog(&quot;chrome://calendar/content/calendar-properties-dialog.xul&quot;,</span>
<a href="#l86.50"></a><span id="l86.50" class="difflineplus">+                       &quot;CalendarPropertiesDialog&quot;,</span>
<a href="#l86.51"></a><span id="l86.51" class="difflineplus">+                       // Workaround for Bug 1151440 - the HTML color picker won't work</span>
<a href="#l86.52"></a><span id="l86.52" class="difflineplus">+                       // in linux when opened from modal dialog</span>
<a href="#l86.53"></a><span id="l86.53" class="difflineplus">+                       AppConstants.platform == &quot;linux&quot;</span>
<a href="#l86.54"></a><span id="l86.54" class="difflineplus">+                           ? &quot;chrome,titlebar,resizable&quot;</span>
<a href="#l86.55"></a><span id="l86.55" class="difflineplus">+                           : &quot;modal,chrome,titlebar,resizable&quot;,</span>
<a href="#l86.56"></a><span id="l86.56" class="difflineplus">+                       { calendar: aCalendar });</span>
<a href="#l86.57"></a><span id="l86.57"> }</span>
<a href="#l86.58"></a><span id="l86.58"> </span>
<a href="#l86.59"></a><span id="l86.59"> /**</span>
<a href="#l86.60"></a><span id="l86.60">  * Opens the print dialog</span>
<a href="#l86.61"></a><span id="l86.61" class="difflineplus">+ *</span>
<a href="#l86.62"></a><span id="l86.62" class="difflineplus">+ * @param aWindow The window to show the dialog in.</span>
<a href="#l86.63"></a><span id="l86.63">  */</span>
<a href="#l86.64"></a><span id="l86.64" class="difflineminus">-function calPrint() {</span>
<a href="#l86.65"></a><span id="l86.65" class="difflineminus">-    openDialog(&quot;chrome://calendar/content/calendar-print-dialog.xul&quot;, &quot;Print&quot;,</span>
<a href="#l86.66"></a><span id="l86.66" class="difflineminus">-               &quot;centerscreen,chrome,resizable&quot;);</span>
<a href="#l86.67"></a><span id="l86.67" class="difflineplus">+function calPrint(aWindow) {</span>
<a href="#l86.68"></a><span id="l86.68" class="difflineplus">+    aWindow.openDialog(&quot;chrome://calendar/content/calendar-print-dialog.xul&quot;, &quot;Print&quot;,</span>
<a href="#l86.69"></a><span id="l86.69" class="difflineplus">+                       &quot;centerscreen,chrome,resizable&quot;);</span>
<a href="#l86.70"></a><span id="l86.70"> }</span>
<a href="#l86.71"></a><span id="l86.71"> </span>
<a href="#l86.72"></a><span id="l86.72"> /**</span>
<a href="#l86.73"></a><span id="l86.73">  * Other functions</span>
<a href="#l86.74"></a><span id="l86.74">  */</span>
<a href="#l86.75"></a><span id="l86.75"> </span>
<a href="#l86.76"></a><span id="l86.76"> /**</span>
<a href="#l86.77"></a><span id="l86.77">  * Takes a string and returns an nsIURI</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l87.1"></a><span id="l87.1" class="difflineminus">--- a/calendar/lightning/content/html-item-editing/lightning-item-iframe.html</span>
<a href="#l87.2"></a><span id="l87.2" class="difflineplus">+++ b/calendar/lightning/content/html-item-editing/lightning-item-iframe.html</span>
<a href="#l87.3"></a><span id="l87.3" class="difflineat">@@ -15,14 +15,13 @@</span>
<a href="#l87.4"></a><span id="l87.4">       &lt;p&gt;</span>
<a href="#l87.5"></a><span id="l87.5">         If you can see this, React is still loading or is not working right.</span>
<a href="#l87.6"></a><span id="l87.6">       &lt;/p&gt;</span>
<a href="#l87.7"></a><span id="l87.7">     &lt;/div&gt;</span>
<a href="#l87.8"></a><span id="l87.8">     &lt;script type=&quot;application/javascript&quot; src=&quot;resource://devtools/client/shared/vendor/react.js&quot;&gt;&lt;/script&gt;</span>
<a href="#l87.9"></a><span id="l87.9">     &lt;script type=&quot;application/javascript&quot; src=&quot;resource://devtools/client/shared/vendor/react-dom.js&quot;&gt;&lt;/script&gt;</span>
<a href="#l87.10"></a><span id="l87.10">     &lt;script src='chrome://calendar/content/calendar-dialog-utils.js'&gt;&lt;/script&gt;</span>
<a href="#l87.11"></a><span id="l87.11">     &lt;script src='chrome://calendar/content/calendar-ui-utils.js'&gt;&lt;/script&gt;</span>
<a href="#l87.12"></a><span id="l87.12" class="difflineminus">-    &lt;script src='chrome://calendar/content/calUtils.js'&gt;&lt;/script&gt;</span>
<a href="#l87.13"></a><span id="l87.13">     &lt;script src='chrome://global/content/globalOverlay.js'&gt;&lt;/script&gt;</span>
<a href="#l87.14"></a><span id="l87.14">     &lt;script src='chrome://lightning/content/lightning-item-iframe.js'&gt;&lt;/script&gt;</span>
<a href="#l87.15"></a><span id="l87.15">     &lt;script src='chrome://lightning/content/html-item-editing/react-code.js'&gt;&lt;/script&gt;</span>
<a href="#l87.16"></a><span id="l87.16">   &lt;/body&gt;</span>
<a href="#l87.17"></a><span id="l87.17"> &lt;/html&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l88.1"></a><span id="l88.1" class="difflineminus">--- a/calendar/lightning/content/imip-bar-overlay.xul</span>
<a href="#l88.2"></a><span id="l88.2" class="difflineplus">+++ b/calendar/lightning/content/imip-bar-overlay.xul</span>
<a href="#l88.3"></a><span id="l88.3" class="difflineat">@@ -10,18 +10,16 @@</span>
<a href="#l88.4"></a><span id="l88.4"> </span>
<a href="#l88.5"></a><span id="l88.5"> &lt;?xml-stylesheet href=&quot;chrome://lightning/content/lightning-widgets.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l88.6"></a><span id="l88.6"> </span>
<a href="#l88.7"></a><span id="l88.7"> &lt;overlay xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;&gt;</span>
<a href="#l88.8"></a><span id="l88.8"> </span>
<a href="#l88.9"></a><span id="l88.9">     &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l88.10"></a><span id="l88.10">             src=&quot;chrome://lightning/content/lightning-utils.js&quot;/&gt;</span>
<a href="#l88.11"></a><span id="l88.11">     &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l88.12"></a><span id="l88.12" class="difflineminus">-            src=&quot;chrome://calendar/content/calUtils.js&quot;/&gt;</span>
<a href="#l88.13"></a><span id="l88.13" class="difflineminus">-    &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l88.14"></a><span id="l88.14">             src=&quot;chrome://lightning/content/imip-bar.js&quot;/&gt;</span>
<a href="#l88.15"></a><span id="l88.15">     &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l88.16"></a><span id="l88.16">             src=&quot;chrome://calendar/content/calendar-management.js&quot;/&gt;</span>
<a href="#l88.17"></a><span id="l88.17">     &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l88.18"></a><span id="l88.18">             src=&quot;chrome://calendar/content/calendar-ui-utils.js&quot;/&gt;</span>
<a href="#l88.19"></a><span id="l88.19"> </span>
<a href="#l88.20"></a><span id="l88.20">     &lt;vbox id=&quot;messagepanebox&quot;&gt;</span>
<a href="#l88.21"></a><span id="l88.21">       &lt;vbox id=&quot;singlemessage&quot; insertbefore=&quot;msgHeaderView&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l89.1"></a><span id="l89.1" class="difflineminus">--- a/calendar/lightning/content/lightning-item-iframe.js</span>
<a href="#l89.2"></a><span id="l89.2" class="difflineplus">+++ b/calendar/lightning/content/lightning-item-iframe.js</span>
<a href="#l89.3"></a><span id="l89.3" class="difflineat">@@ -79,20 +79,20 @@ var eventDialogCalendarObserver = {</span>
<a href="#l89.4"></a><span id="l89.4">         if (this.isObserving &amp;&amp; &quot;calendarItem&quot; in window &amp;&amp;</span>
<a href="#l89.5"></a><span id="l89.5">             window.calendarItem &amp;&amp; window.calendarItem.id == aOldItem.id) {</span>
<a href="#l89.6"></a><span id="l89.6">             let doUpdate = true;</span>
<a href="#l89.7"></a><span id="l89.7"> </span>
<a href="#l89.8"></a><span id="l89.8">             // The item has been modified outside the dialog. We only need to</span>
<a href="#l89.9"></a><span id="l89.9">             // prompt if there have been local changes also.</span>
<a href="#l89.10"></a><span id="l89.10">             if (isItemChanged()) {</span>
<a href="#l89.11"></a><span id="l89.11">                 let promptService = Components.interfaces.nsIPromptService;</span>
<a href="#l89.12"></a><span id="l89.12" class="difflineminus">-                let promptTitle = calGetString(&quot;calendar&quot;, &quot;modifyConflictPromptTitle&quot;);</span>
<a href="#l89.13"></a><span id="l89.13" class="difflineminus">-                let promptMessage = calGetString(&quot;calendar&quot;, &quot;modifyConflictPromptMessage&quot;);</span>
<a href="#l89.14"></a><span id="l89.14" class="difflineminus">-                let promptButton1 = calGetString(&quot;calendar&quot;, &quot;modifyConflictPromptButton1&quot;);</span>
<a href="#l89.15"></a><span id="l89.15" class="difflineminus">-                let promptButton2 = calGetString(&quot;calendar&quot;, &quot;modifyConflictPromptButton2&quot;);</span>
<a href="#l89.16"></a><span id="l89.16" class="difflineplus">+                let promptTitle = cal.calGetString(&quot;calendar&quot;, &quot;modifyConflictPromptTitle&quot;);</span>
<a href="#l89.17"></a><span id="l89.17" class="difflineplus">+                let promptMessage = cal.calGetString(&quot;calendar&quot;, &quot;modifyConflictPromptMessage&quot;);</span>
<a href="#l89.18"></a><span id="l89.18" class="difflineplus">+                let promptButton1 = cal.calGetString(&quot;calendar&quot;, &quot;modifyConflictPromptButton1&quot;);</span>
<a href="#l89.19"></a><span id="l89.19" class="difflineplus">+                let promptButton2 = cal.calGetString(&quot;calendar&quot;, &quot;modifyConflictPromptButton2&quot;);</span>
<a href="#l89.20"></a><span id="l89.20">                 let flags = promptService.BUTTON_TITLE_IS_STRING *</span>
<a href="#l89.21"></a><span id="l89.21">                             promptService.BUTTON_POS_0 +</span>
<a href="#l89.22"></a><span id="l89.22">                             promptService.BUTTON_TITLE_IS_STRING *</span>
<a href="#l89.23"></a><span id="l89.23">                             promptService.BUTTON_POS_1;</span>
<a href="#l89.24"></a><span id="l89.24"> </span>
<a href="#l89.25"></a><span id="l89.25">                 let choice = Services.prompt.confirmEx(window, promptTitle, promptMessage, flags,</span>
<a href="#l89.26"></a><span id="l89.26">                                                        promptButton1, promptButton2, null, null, {});</span>
<a href="#l89.27"></a><span id="l89.27">                 if (!choice) {</span>
<a href="#l89.28"></a><span id="l89.28" class="difflineat">@@ -303,17 +303,17 @@ function onLoad() {</span>
<a href="#l89.29"></a><span id="l89.29">     // set the iframe's top level id for event vs task</span>
<a href="#l89.30"></a><span id="l89.30">     if (!cal.isEvent(item)) {</span>
<a href="#l89.31"></a><span id="l89.31">         setDialogId(document.documentElement, &quot;calendar-task-dialog-inner&quot;);</span>
<a href="#l89.32"></a><span id="l89.32">     }</span>
<a href="#l89.33"></a><span id="l89.33"> </span>
<a href="#l89.34"></a><span id="l89.34">     // new items should have a non-empty title.</span>
<a href="#l89.35"></a><span id="l89.35">     if (item.isMutable &amp;&amp; (!item.title || item.title.length &lt;= 0)) {</span>
<a href="#l89.36"></a><span id="l89.36">         item.title = cal.calGetString(&quot;calendar-event-dialog&quot;,</span>
<a href="#l89.37"></a><span id="l89.37" class="difflineminus">-                                      isEvent(item) ? &quot;newEvent&quot; : &quot;newTask&quot;);</span>
<a href="#l89.38"></a><span id="l89.38" class="difflineplus">+                                      cal.isEvent(item) ? &quot;newEvent&quot; : &quot;newTask&quot;);</span>
<a href="#l89.39"></a><span id="l89.39">     }</span>
<a href="#l89.40"></a><span id="l89.40"> </span>
<a href="#l89.41"></a><span id="l89.41">     window.onAcceptCallback = args.onOk;</span>
<a href="#l89.42"></a><span id="l89.42">     window.mode = args.mode;</span>
<a href="#l89.43"></a><span id="l89.43"> </span>
<a href="#l89.44"></a><span id="l89.44">     // we store the item in the window to be able</span>
<a href="#l89.45"></a><span id="l89.45">     // to access this from any location. please note</span>
<a href="#l89.46"></a><span id="l89.46">     // that the item is either an occurrence [proxy]</span>
<a href="#l89.47"></a><span id="l89.47" class="difflineat">@@ -360,17 +360,17 @@ function onLoad() {</span>
<a href="#l89.48"></a><span id="l89.48">     }</span>
<a href="#l89.49"></a><span id="l89.49"> </span>
<a href="#l89.50"></a><span id="l89.50">     window.recurrenceInfo = null;</span>
<a href="#l89.51"></a><span id="l89.51">     if (parentItem.recurrenceInfo) {</span>
<a href="#l89.52"></a><span id="l89.52">         window.recurrenceInfo = parentItem.recurrenceInfo.clone();</span>
<a href="#l89.53"></a><span id="l89.53">     }</span>
<a href="#l89.54"></a><span id="l89.54"> </span>
<a href="#l89.55"></a><span id="l89.55">     // Set initial values for datepickers in New Tasks dialog</span>
<a href="#l89.56"></a><span id="l89.56" class="difflineminus">-    if (isToDo(item)) {</span>
<a href="#l89.57"></a><span id="l89.57" class="difflineplus">+    if (cal.isToDo(item)) {</span>
<a href="#l89.58"></a><span id="l89.58">         let initialDatesValue = cal.dateTimeToJsDate(args.initialStartDateValue);</span>
<a href="#l89.59"></a><span id="l89.59">         if (!gNewItemUI) {</span>
<a href="#l89.60"></a><span id="l89.60">             setElementValue(&quot;completed-date-picker&quot;, initialDatesValue);</span>
<a href="#l89.61"></a><span id="l89.61">             setElementValue(&quot;todo-entrydate&quot;, initialDatesValue);</span>
<a href="#l89.62"></a><span id="l89.62">             setElementValue(&quot;todo-duedate&quot;, initialDatesValue);</span>
<a href="#l89.63"></a><span id="l89.63">         }</span>
<a href="#l89.64"></a><span id="l89.64">     }</span>
<a href="#l89.65"></a><span id="l89.65">     loadDialog(window.calendarItem);</span>
<a href="#l89.66"></a><span id="l89.66" class="difflineat">@@ -452,21 +452,21 @@ function onCommandCancel() {</span>
<a href="#l89.67"></a><span id="l89.67">     if (gInTab &amp;&amp; gTabInfoObject) {</span>
<a href="#l89.68"></a><span id="l89.68">         // Switch to the tab that the prompt refers to.</span>
<a href="#l89.69"></a><span id="l89.69">         gTabmail.switchToTab(gTabInfoObject);</span>
<a href="#l89.70"></a><span id="l89.70">     }</span>
<a href="#l89.71"></a><span id="l89.71"> </span>
<a href="#l89.72"></a><span id="l89.72">     let promptService = Components.interfaces.nsIPromptService;</span>
<a href="#l89.73"></a><span id="l89.73"> </span>
<a href="#l89.74"></a><span id="l89.74">     let promptTitle = cal.calGetString(&quot;calendar&quot;,</span>
<a href="#l89.75"></a><span id="l89.75" class="difflineminus">-                                       isEvent(window.calendarItem)</span>
<a href="#l89.76"></a><span id="l89.76" class="difflineplus">+                                       cal.isEvent(window.calendarItem)</span>
<a href="#l89.77"></a><span id="l89.77">                                           ? &quot;askSaveTitleEvent&quot;</span>
<a href="#l89.78"></a><span id="l89.78">                                           : &quot;askSaveTitleTask&quot;);</span>
<a href="#l89.79"></a><span id="l89.79">     let promptMessage = cal.calGetString(&quot;calendar&quot;,</span>
<a href="#l89.80"></a><span id="l89.80" class="difflineminus">-                                         isEvent(window.calendarItem)</span>
<a href="#l89.81"></a><span id="l89.81" class="difflineplus">+                                         cal.isEvent(window.calendarItem)</span>
<a href="#l89.82"></a><span id="l89.82">                                             ? &quot;askSaveMessageEvent&quot;</span>
<a href="#l89.83"></a><span id="l89.83">                                             : &quot;askSaveMessageTask&quot;);</span>
<a href="#l89.84"></a><span id="l89.84"> </span>
<a href="#l89.85"></a><span id="l89.85">     let flags = promptService.BUTTON_TITLE_SAVE *</span>
<a href="#l89.86"></a><span id="l89.86">                 promptService.BUTTON_POS_0 +</span>
<a href="#l89.87"></a><span id="l89.87">                 promptService.BUTTON_TITLE_CANCEL *</span>
<a href="#l89.88"></a><span id="l89.88">                 promptService.BUTTON_POS_1 +</span>
<a href="#l89.89"></a><span id="l89.89">                 promptService.BUTTON_TITLE_DONT_SAVE *</span>
<a href="#l89.90"></a><span id="l89.90" class="difflineat">@@ -564,20 +564,20 @@ function loadDialog(aItem) {</span>
<a href="#l89.91"></a><span id="l89.91">     if (gNewItemUI) {</span>
<a href="#l89.92"></a><span id="l89.92">         let calendarToUse = aItem.calendar || window.arguments[0].calendar;</span>
<a href="#l89.93"></a><span id="l89.93">         let unfilteredList = sortCalendarArray(cal.getCalendarManager().getCalendars({}));</span>
<a href="#l89.94"></a><span id="l89.94"> </span>
<a href="#l89.95"></a><span id="l89.95">         // filter out calendars that should not be included</span>
<a href="#l89.96"></a><span id="l89.96">         let calendarList = unfilteredList.filter((calendar) =&gt;</span>
<a href="#l89.97"></a><span id="l89.97">            (calendar.id == calendarToUse.id ||</span>
<a href="#l89.98"></a><span id="l89.98">             (calendar &amp;&amp;</span>
<a href="#l89.99"></a><span id="l89.99" class="difflineminus">-             isCalendarWritable(calendar) &amp;&amp;</span>
<a href="#l89.100"></a><span id="l89.100" class="difflineminus">-             (userCanAddItemsToCalendar(calendar) ||</span>
<a href="#l89.101"></a><span id="l89.101" class="difflineminus">-              (calendar == aItem.calendar &amp;&amp; userCanModifyItem(aItem))) &amp;&amp;</span>
<a href="#l89.102"></a><span id="l89.102" class="difflineminus">-             isItemSupported(aItem, calendar))));</span>
<a href="#l89.103"></a><span id="l89.103" class="difflineplus">+             cal.isCalendarWritable(calendar) &amp;&amp;</span>
<a href="#l89.104"></a><span id="l89.104" class="difflineplus">+             (cal.userCanAddItemsToCalendar(calendar) ||</span>
<a href="#l89.105"></a><span id="l89.105" class="difflineplus">+              (calendar == aItem.calendar &amp;&amp; cal.userCanModifyItem(aItem))) &amp;&amp;</span>
<a href="#l89.106"></a><span id="l89.106" class="difflineplus">+             cal.isItemSupported(aItem, calendar))));</span>
<a href="#l89.107"></a><span id="l89.107"> </span>
<a href="#l89.108"></a><span id="l89.108">         itemProps.calendarList = calendarList.map(calendar =&gt; [calendar.id, calendar.name]);</span>
<a href="#l89.109"></a><span id="l89.109"> </span>
<a href="#l89.110"></a><span id="l89.110">         if (calendarToUse &amp;&amp; calendarToUse.id) {</span>
<a href="#l89.111"></a><span id="l89.111">             let index = itemProps.calendarList.findIndex(</span>
<a href="#l89.112"></a><span id="l89.112">                 calendar =&gt; (calendar[0] == calendarToUse.id));</span>
<a href="#l89.113"></a><span id="l89.113">             if (index != -1) {</span>
<a href="#l89.114"></a><span id="l89.114">                 itemProps.initialCalendarId = calendarToUse.id;</span>
<a href="#l89.115"></a><span id="l89.115" class="difflineat">@@ -590,17 +590,17 @@ function loadDialog(aItem) {</span>
<a href="#l89.116"></a><span id="l89.116">         if (indexToSelect &gt; -1) {</span>
<a href="#l89.117"></a><span id="l89.117">             calendarList.selectedIndex = indexToSelect;</span>
<a href="#l89.118"></a><span id="l89.118">         }</span>
<a href="#l89.119"></a><span id="l89.119">     }</span>
<a href="#l89.120"></a><span id="l89.120"> </span>
<a href="#l89.121"></a><span id="l89.121">     // Categories</span>
<a href="#l89.122"></a><span id="l89.122">     if (gNewItemUI) {</span>
<a href="#l89.123"></a><span id="l89.123">         // XXX more to do here with localization, see loadCategories.</span>
<a href="#l89.124"></a><span id="l89.124" class="difflineminus">-        itemProps.initialCategoriesList = cal.sortArrayByLocaleCollator(getPrefCategoriesArray());</span>
<a href="#l89.125"></a><span id="l89.125" class="difflineplus">+        itemProps.initialCategoriesList = cal.sortArrayByLocaleCollator(cal.getPrefCategoriesArray());</span>
<a href="#l89.126"></a><span id="l89.126">         itemProps.initialCategories = aItem.getCategories({});</span>
<a href="#l89.127"></a><span id="l89.127"> </span>
<a href="#l89.128"></a><span id="l89.128">         // just to demo capsules component</span>
<a href="#l89.129"></a><span id="l89.129">         itemProps.initialCategories = [&quot;Some&quot;, &quot;Demo&quot;, &quot;Categories&quot;];</span>
<a href="#l89.130"></a><span id="l89.130">     } else {</span>
<a href="#l89.131"></a><span id="l89.131">         loadCategories(aItem);</span>
<a href="#l89.132"></a><span id="l89.132">     }</span>
<a href="#l89.133"></a><span id="l89.133"> </span>
<a href="#l89.134"></a><span id="l89.134" class="difflineat">@@ -665,17 +665,17 @@ function loadDialog(aItem) {</span>
<a href="#l89.135"></a><span id="l89.135">         if (aItem.completedDate) {</span>
<a href="#l89.136"></a><span id="l89.136">             updateToDoStatus(aItem.status, cal.dateTimeToJsDate(aItem.completedDate));</span>
<a href="#l89.137"></a><span id="l89.137">         } else {</span>
<a href="#l89.138"></a><span id="l89.138">             updateToDoStatus(aItem.status);</span>
<a href="#l89.139"></a><span id="l89.139">         }</span>
<a href="#l89.140"></a><span id="l89.140">     }</span>
<a href="#l89.141"></a><span id="l89.141"> </span>
<a href="#l89.142"></a><span id="l89.142">     // Task percent complete</span>
<a href="#l89.143"></a><span id="l89.143" class="difflineminus">-    if (isToDo(aItem)) {</span>
<a href="#l89.144"></a><span id="l89.144" class="difflineplus">+    if (cal.isToDo(aItem)) {</span>
<a href="#l89.145"></a><span id="l89.145">         let percentCompleteInteger = 0;</span>
<a href="#l89.146"></a><span id="l89.146">         let percentCompleteProperty = aItem.getProperty(&quot;PERCENT-COMPLETE&quot;);</span>
<a href="#l89.147"></a><span id="l89.147">         if (percentCompleteProperty != null) {</span>
<a href="#l89.148"></a><span id="l89.148">             percentCompleteInteger = parseInt(percentCompleteProperty, 10);</span>
<a href="#l89.149"></a><span id="l89.149">         }</span>
<a href="#l89.150"></a><span id="l89.150">         if (percentCompleteInteger &lt; 0) {</span>
<a href="#l89.151"></a><span id="l89.151">             percentCompleteInteger = 0;</span>
<a href="#l89.152"></a><span id="l89.152">         } else if (percentCompleteInteger &gt; 100) {</span>
<a href="#l89.153"></a><span id="l89.153" class="difflineat">@@ -886,18 +886,18 @@ function saveCategories(aItem) {</span>
<a href="#l89.154"></a><span id="l89.154"> }</span>
<a href="#l89.155"></a><span id="l89.155"> </span>
<a href="#l89.156"></a><span id="l89.156"> /**</span>
<a href="#l89.157"></a><span id="l89.157">  * Sets up all date related controls from the passed item</span>
<a href="#l89.158"></a><span id="l89.158">  *</span>
<a href="#l89.159"></a><span id="l89.159">  * @param item      The item to parse information out of.</span>
<a href="#l89.160"></a><span id="l89.160">  */</span>
<a href="#l89.161"></a><span id="l89.161"> function loadDateTime(item) {</span>
<a href="#l89.162"></a><span id="l89.162" class="difflineminus">-    let kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l89.163"></a><span id="l89.163" class="difflineminus">-    if (isEvent(item)) {</span>
<a href="#l89.164"></a><span id="l89.164" class="difflineplus">+    let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l89.165"></a><span id="l89.165" class="difflineplus">+    if (cal.isEvent(item)) {</span>
<a href="#l89.166"></a><span id="l89.166">         let startTime = item.startDate;</span>
<a href="#l89.167"></a><span id="l89.167">         let endTime = item.endDate;</span>
<a href="#l89.168"></a><span id="l89.168">         let duration = endTime.subtractDate(startTime);</span>
<a href="#l89.169"></a><span id="l89.169"> </span>
<a href="#l89.170"></a><span id="l89.170">         // Check if an all-day event has been passed in (to adapt endDate).</span>
<a href="#l89.171"></a><span id="l89.171">         if (startTime.isDate) {</span>
<a href="#l89.172"></a><span id="l89.172">             startTime = startTime.clone();</span>
<a href="#l89.173"></a><span id="l89.173">             endTime = endTime.clone();</span>
<a href="#l89.174"></a><span id="l89.174" class="difflineat">@@ -911,17 +911,17 @@ function loadDateTime(item) {</span>
<a href="#l89.175"></a><span id="l89.175">         // separately.</span>
<a href="#l89.176"></a><span id="l89.176">         gStartTimezone = startTime.timezone;</span>
<a href="#l89.177"></a><span id="l89.177">         gEndTimezone = endTime.timezone;</span>
<a href="#l89.178"></a><span id="l89.178">         gStartTime = startTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l89.179"></a><span id="l89.179">         gEndTime = endTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l89.180"></a><span id="l89.180">         gItemDuration = duration;</span>
<a href="#l89.181"></a><span id="l89.181">     }</span>
<a href="#l89.182"></a><span id="l89.182"> </span>
<a href="#l89.183"></a><span id="l89.183" class="difflineminus">-    if (isToDo(item)) {</span>
<a href="#l89.184"></a><span id="l89.184" class="difflineplus">+    if (cal.isToDo(item)) {</span>
<a href="#l89.185"></a><span id="l89.185">         let startTime = null;</span>
<a href="#l89.186"></a><span id="l89.186">         let endTime = null;</span>
<a href="#l89.187"></a><span id="l89.187">         let duration = null;</span>
<a href="#l89.188"></a><span id="l89.188"> </span>
<a href="#l89.189"></a><span id="l89.189">         let hasEntryDate = (item.entryDate != null);</span>
<a href="#l89.190"></a><span id="l89.190">         if (hasEntryDate) {</span>
<a href="#l89.191"></a><span id="l89.191">             startTime = item.entryDate;</span>
<a href="#l89.192"></a><span id="l89.192">             gStartTimezone = startTime.timezone;</span>
<a href="#l89.193"></a><span id="l89.193" class="difflineat">@@ -987,33 +987,33 @@ function dateTimeControls2State(aStartDa</span>
<a href="#l89.194"></a><span id="l89.194">     if (gIgnoreUpdate) {</span>
<a href="#l89.195"></a><span id="l89.195">         return;</span>
<a href="#l89.196"></a><span id="l89.196">     }</span>
<a href="#l89.197"></a><span id="l89.197">     let keepAttribute = document.getElementById(&quot;keepduration-button&quot;)</span>
<a href="#l89.198"></a><span id="l89.198">                                 .getAttribute(&quot;keep&quot;) == &quot;true&quot;;</span>
<a href="#l89.199"></a><span id="l89.199">     let allDay = getElementValue(&quot;event-all-day&quot;, &quot;checked&quot;);</span>
<a href="#l89.200"></a><span id="l89.200">     let startWidgetId;</span>
<a href="#l89.201"></a><span id="l89.201">     let endWidgetId;</span>
<a href="#l89.202"></a><span id="l89.202" class="difflineminus">-    if (isEvent(window.calendarItem)) {</span>
<a href="#l89.203"></a><span id="l89.203" class="difflineplus">+    if (cal.isEvent(window.calendarItem)) {</span>
<a href="#l89.204"></a><span id="l89.204">         startWidgetId = &quot;event-starttime&quot;;</span>
<a href="#l89.205"></a><span id="l89.205">         endWidgetId = &quot;event-endtime&quot;;</span>
<a href="#l89.206"></a><span id="l89.206">     } else {</span>
<a href="#l89.207"></a><span id="l89.207">         if (!getElementValue(&quot;todo-has-entrydate&quot;, &quot;checked&quot;)) {</span>
<a href="#l89.208"></a><span id="l89.208">             gItemDuration = null;</span>
<a href="#l89.209"></a><span id="l89.209">         }</span>
<a href="#l89.210"></a><span id="l89.210">         if (!getElementValue(&quot;todo-has-duedate&quot;, &quot;checked&quot;)) {</span>
<a href="#l89.211"></a><span id="l89.211">             gItemDuration = null;</span>
<a href="#l89.212"></a><span id="l89.212">         }</span>
<a href="#l89.213"></a><span id="l89.213">         startWidgetId = &quot;todo-entrydate&quot;;</span>
<a href="#l89.214"></a><span id="l89.214">         endWidgetId = &quot;todo-duedate&quot;;</span>
<a href="#l89.215"></a><span id="l89.215">     }</span>
<a href="#l89.216"></a><span id="l89.216"> </span>
<a href="#l89.217"></a><span id="l89.217">     let saveStartTime = gStartTime;</span>
<a href="#l89.218"></a><span id="l89.218">     let saveEndTime = gEndTime;</span>
<a href="#l89.219"></a><span id="l89.219" class="difflineminus">-    let kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l89.220"></a><span id="l89.220" class="difflineplus">+    let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l89.221"></a><span id="l89.221"> </span>
<a href="#l89.222"></a><span id="l89.222">     if (gStartTime) {</span>
<a href="#l89.223"></a><span id="l89.223">         // jsDate is always in OS timezone, thus we create a calIDateTime</span>
<a href="#l89.224"></a><span id="l89.224">         // object from the jsDate representation then we convert the timezone</span>
<a href="#l89.225"></a><span id="l89.225">         // in order to keep gStartTime in default timezone.</span>
<a href="#l89.226"></a><span id="l89.226">         if (gTimezonesEnabled || allDay) {</span>
<a href="#l89.227"></a><span id="l89.227">             gStartTime = cal.jsDateToDateTime(getElementValue(startWidgetId), gStartTimezone);</span>
<a href="#l89.228"></a><span id="l89.228">             gStartTime = gStartTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l89.229"></a><span id="l89.229" class="difflineat">@@ -1027,17 +1027,17 @@ function dateTimeControls2State(aStartDa</span>
<a href="#l89.230"></a><span id="l89.230">             // Change the End date in order to keep the duration.</span>
<a href="#l89.231"></a><span id="l89.231">             gEndTime = gStartTime.clone();</span>
<a href="#l89.232"></a><span id="l89.232">             if (gItemDuration) {</span>
<a href="#l89.233"></a><span id="l89.233">                 gEndTime.addDuration(gItemDuration);</span>
<a href="#l89.234"></a><span id="l89.234">             }</span>
<a href="#l89.235"></a><span id="l89.235">         } else {</span>
<a href="#l89.236"></a><span id="l89.236">             let timezone = gEndTimezone;</span>
<a href="#l89.237"></a><span id="l89.237">             if (timezone.isUTC) {</span>
<a href="#l89.238"></a><span id="l89.238" class="difflineminus">-                if (gStartTime &amp;&amp; !compareObjects(gStartTimezone, gEndTimezone)) {</span>
<a href="#l89.239"></a><span id="l89.239" class="difflineplus">+                if (gStartTime &amp;&amp; !cal.compareObjects(gStartTimezone, gEndTimezone)) {</span>
<a href="#l89.240"></a><span id="l89.240">                     timezone = gStartTimezone;</span>
<a href="#l89.241"></a><span id="l89.241">                 }</span>
<a href="#l89.242"></a><span id="l89.242">             }</span>
<a href="#l89.243"></a><span id="l89.243">             if (gTimezonesEnabled || allDay) {</span>
<a href="#l89.244"></a><span id="l89.244">                 gEndTime = cal.jsDateToDateTime(getElementValue(endWidgetId), timezone);</span>
<a href="#l89.245"></a><span id="l89.245">                 gEndTime = gEndTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l89.246"></a><span id="l89.246">             } else {</span>
<a href="#l89.247"></a><span id="l89.247">                 gEndTime = cal.jsDateToDateTime(getElementValue(endWidgetId), kDefaultTimezone);</span>
<a href="#l89.248"></a><span id="l89.248" class="difflineat">@@ -1176,17 +1176,17 @@ function updateDueDate() {</span>
<a href="#l89.249"></a><span id="l89.249">  * @param aDateTime         An object implementing the isValid and setDateTime</span>
<a href="#l89.250"></a><span id="l89.250">  *                            methods. XXX explain.</span>
<a href="#l89.251"></a><span id="l89.251">  */</span>
<a href="#l89.252"></a><span id="l89.252"> function updateDateCheckboxes(aDatePickerId, aCheckboxId, aDateTime) {</span>
<a href="#l89.253"></a><span id="l89.253">     if (gIgnoreUpdate) {</span>
<a href="#l89.254"></a><span id="l89.254">         return;</span>
<a href="#l89.255"></a><span id="l89.255">     }</span>
<a href="#l89.256"></a><span id="l89.256"> </span>
<a href="#l89.257"></a><span id="l89.257" class="difflineminus">-    if (!isToDo(window.calendarItem)) {</span>
<a href="#l89.258"></a><span id="l89.258" class="difflineplus">+    if (!cal.isToDo(window.calendarItem)) {</span>
<a href="#l89.259"></a><span id="l89.259">         return;</span>
<a href="#l89.260"></a><span id="l89.260">     }</span>
<a href="#l89.261"></a><span id="l89.261"> </span>
<a href="#l89.262"></a><span id="l89.262">     // force something to get set if there was nothing there before</span>
<a href="#l89.263"></a><span id="l89.263">     setElementValue(aDatePickerId, getElementValue(aDatePickerId));</span>
<a href="#l89.264"></a><span id="l89.264"> </span>
<a href="#l89.265"></a><span id="l89.265">     // first of all disable the datetime picker if we don't have a date</span>
<a href="#l89.266"></a><span id="l89.266">     let hasDate = getElementValue(aCheckboxId, &quot;checked&quot;);</span>
<a href="#l89.267"></a><span id="l89.267" class="difflineat">@@ -1386,64 +1386,64 @@ function updateReminder(aSuppressDialogs</span>
<a href="#l89.268"></a><span id="l89.268">  * Saves all values the user chose on the dialog to the passed item</span>
<a href="#l89.269"></a><span id="l89.269">  *</span>
<a href="#l89.270"></a><span id="l89.270">  * @param item    The item to save to.</span>
<a href="#l89.271"></a><span id="l89.271">  */</span>
<a href="#l89.272"></a><span id="l89.272"> function saveDialog(item) {</span>
<a href="#l89.273"></a><span id="l89.273">     // Calendar</span>
<a href="#l89.274"></a><span id="l89.274">     item.calendar = getCurrentCalendar();</span>
<a href="#l89.275"></a><span id="l89.275"> </span>
<a href="#l89.276"></a><span id="l89.276" class="difflineminus">-    setItemProperty(item, &quot;title&quot;, getElementValue(&quot;item-title&quot;));</span>
<a href="#l89.277"></a><span id="l89.277" class="difflineminus">-    setItemProperty(item, &quot;LOCATION&quot;, getElementValue(&quot;item-location&quot;));</span>
<a href="#l89.278"></a><span id="l89.278" class="difflineplus">+    cal.setItemProperty(item, &quot;title&quot;, getElementValue(&quot;item-title&quot;));</span>
<a href="#l89.279"></a><span id="l89.279" class="difflineplus">+    cal.setItemProperty(item, &quot;LOCATION&quot;, getElementValue(&quot;item-location&quot;));</span>
<a href="#l89.280"></a><span id="l89.280"> </span>
<a href="#l89.281"></a><span id="l89.281">     saveDateTime(item);</span>
<a href="#l89.282"></a><span id="l89.282"> </span>
<a href="#l89.283"></a><span id="l89.283" class="difflineminus">-    if (isToDo(item)) {</span>
<a href="#l89.284"></a><span id="l89.284" class="difflineplus">+    if (cal.isToDo(item)) {</span>
<a href="#l89.285"></a><span id="l89.285">         let percentCompleteInteger = 0;</span>
<a href="#l89.286"></a><span id="l89.286">         if (getElementValue(&quot;percent-complete-textbox&quot;) != &quot;&quot;) {</span>
<a href="#l89.287"></a><span id="l89.287">             percentCompleteInteger =</span>
<a href="#l89.288"></a><span id="l89.288">                 parseInt(getElementValue(&quot;percent-complete-textbox&quot;), 10);</span>
<a href="#l89.289"></a><span id="l89.289">         }</span>
<a href="#l89.290"></a><span id="l89.290">         if (percentCompleteInteger &lt; 0) {</span>
<a href="#l89.291"></a><span id="l89.291">             percentCompleteInteger = 0;</span>
<a href="#l89.292"></a><span id="l89.292">         } else if (percentCompleteInteger &gt; 100) {</span>
<a href="#l89.293"></a><span id="l89.293">             percentCompleteInteger = 100;</span>
<a href="#l89.294"></a><span id="l89.294">         }</span>
<a href="#l89.295"></a><span id="l89.295" class="difflineminus">-        setItemProperty(item, &quot;PERCENT-COMPLETE&quot;, percentCompleteInteger);</span>
<a href="#l89.296"></a><span id="l89.296" class="difflineplus">+        cal.setItemProperty(item, &quot;PERCENT-COMPLETE&quot;, percentCompleteInteger);</span>
<a href="#l89.297"></a><span id="l89.297">     }</span>
<a href="#l89.298"></a><span id="l89.298"> </span>
<a href="#l89.299"></a><span id="l89.299">     // Categories</span>
<a href="#l89.300"></a><span id="l89.300">     saveCategories(item);</span>
<a href="#l89.301"></a><span id="l89.301"> </span>
<a href="#l89.302"></a><span id="l89.302">     // Attachment</span>
<a href="#l89.303"></a><span id="l89.303">     // We want the attachments to be up to date, remove all first.</span>
<a href="#l89.304"></a><span id="l89.304">     item.removeAllAttachments();</span>
<a href="#l89.305"></a><span id="l89.305"> </span>
<a href="#l89.306"></a><span id="l89.306">     // Now add back the new ones</span>
<a href="#l89.307"></a><span id="l89.307">     for (let hashId in gAttachMap) {</span>
<a href="#l89.308"></a><span id="l89.308">         let att = gAttachMap[hashId];</span>
<a href="#l89.309"></a><span id="l89.309">         item.addAttachment(att);</span>
<a href="#l89.310"></a><span id="l89.310">     }</span>
<a href="#l89.311"></a><span id="l89.311"> </span>
<a href="#l89.312"></a><span id="l89.312">     // Description</span>
<a href="#l89.313"></a><span id="l89.313" class="difflineminus">-    setItemProperty(item, &quot;DESCRIPTION&quot;, getElementValue(&quot;item-description&quot;));</span>
<a href="#l89.314"></a><span id="l89.314" class="difflineplus">+    cal.setItemProperty(item, &quot;DESCRIPTION&quot;, getElementValue(&quot;item-description&quot;));</span>
<a href="#l89.315"></a><span id="l89.315"> </span>
<a href="#l89.316"></a><span id="l89.316">     // Event Status</span>
<a href="#l89.317"></a><span id="l89.317" class="difflineminus">-    if (isEvent(item)) {</span>
<a href="#l89.318"></a><span id="l89.318" class="difflineplus">+    if (cal.isEvent(item)) {</span>
<a href="#l89.319"></a><span id="l89.319">         if (gConfig.status &amp;&amp; gConfig.status != &quot;NONE&quot;) {</span>
<a href="#l89.320"></a><span id="l89.320">             item.setProperty(&quot;STATUS&quot;, gConfig.status);</span>
<a href="#l89.321"></a><span id="l89.321">         } else {</span>
<a href="#l89.322"></a><span id="l89.322">             item.deleteProperty(&quot;STATUS&quot;);</span>
<a href="#l89.323"></a><span id="l89.323">         }</span>
<a href="#l89.324"></a><span id="l89.324">     } else {</span>
<a href="#l89.325"></a><span id="l89.325">         let status = getElementValue(&quot;todo-status&quot;);</span>
<a href="#l89.326"></a><span id="l89.326">         if (status != &quot;COMPLETED&quot;) {</span>
<a href="#l89.327"></a><span id="l89.327">             item.completedDate = null;</span>
<a href="#l89.328"></a><span id="l89.328">         }</span>
<a href="#l89.329"></a><span id="l89.329" class="difflineminus">-        setItemProperty(item, &quot;STATUS&quot;, status == &quot;NONE&quot; ? null : status);</span>
<a href="#l89.330"></a><span id="l89.330" class="difflineplus">+        cal.setItemProperty(item, &quot;STATUS&quot;, status == &quot;NONE&quot; ? null : status);</span>
<a href="#l89.331"></a><span id="l89.331">     }</span>
<a href="#l89.332"></a><span id="l89.332"> </span>
<a href="#l89.333"></a><span id="l89.333">     // set the &quot;PRIORITY&quot; property if a valid priority has been</span>
<a href="#l89.334"></a><span id="l89.334">     // specified (any integer value except *null*) OR the item</span>
<a href="#l89.335"></a><span id="l89.335">     // already specifies a priority. in any other case we don't</span>
<a href="#l89.336"></a><span id="l89.336">     // need this property and can safely delete it. we need this special</span>
<a href="#l89.337"></a><span id="l89.337">     // handling since the WCAP provider always includes the priority</span>
<a href="#l89.338"></a><span id="l89.338">     // with value *null* and we don't detect changes to this item if</span>
<a href="#l89.339"></a><span id="l89.339" class="difflineat">@@ -1458,73 +1458,73 @@ function saveDialog(item) {</span>
<a href="#l89.340"></a><span id="l89.340">     // Transparency</span>
<a href="#l89.341"></a><span id="l89.341">     if (gConfig.showTimeAs) {</span>
<a href="#l89.342"></a><span id="l89.342">         item.setProperty(&quot;TRANSP&quot;, gConfig.showTimeAs);</span>
<a href="#l89.343"></a><span id="l89.343">     } else {</span>
<a href="#l89.344"></a><span id="l89.344">         item.deleteProperty(&quot;TRANSP&quot;);</span>
<a href="#l89.345"></a><span id="l89.345">     }</span>
<a href="#l89.346"></a><span id="l89.346"> </span>
<a href="#l89.347"></a><span id="l89.347">     // Privacy</span>
<a href="#l89.348"></a><span id="l89.348" class="difflineminus">-    setItemProperty(item, &quot;CLASS&quot;, gConfig.privacy, &quot;privacy&quot;);</span>
<a href="#l89.349"></a><span id="l89.349" class="difflineminus">-</span>
<a href="#l89.350"></a><span id="l89.350" class="difflineminus">-    if (item.status == &quot;COMPLETED&quot; &amp;&amp; isToDo(item)) {</span>
<a href="#l89.351"></a><span id="l89.351" class="difflineplus">+    cal.setItemProperty(item, &quot;CLASS&quot;, gConfig.privacy, &quot;privacy&quot;);</span>
<a href="#l89.352"></a><span id="l89.352" class="difflineplus">+</span>
<a href="#l89.353"></a><span id="l89.353" class="difflineplus">+    if (item.status == &quot;COMPLETED&quot; &amp;&amp; cal.isToDo(item)) {</span>
<a href="#l89.354"></a><span id="l89.354">         let elementValue = getElementValue(&quot;completed-date-picker&quot;);</span>
<a href="#l89.355"></a><span id="l89.355">         item.completedDate = cal.jsDateToDateTime(elementValue);</span>
<a href="#l89.356"></a><span id="l89.356">     }</span>
<a href="#l89.357"></a><span id="l89.357"> </span>
<a href="#l89.358"></a><span id="l89.358">     saveReminder(item);</span>
<a href="#l89.359"></a><span id="l89.359"> }</span>
<a href="#l89.360"></a><span id="l89.360"> </span>
<a href="#l89.361"></a><span id="l89.361"> /**</span>
<a href="#l89.362"></a><span id="l89.362">  * Save date and time related values from the dialog to the passed item.</span>
<a href="#l89.363"></a><span id="l89.363">  *</span>
<a href="#l89.364"></a><span id="l89.364">  * @param item    The item to save to.</span>
<a href="#l89.365"></a><span id="l89.365">  */</span>
<a href="#l89.366"></a><span id="l89.366"> function saveDateTime(item) {</span>
<a href="#l89.367"></a><span id="l89.367">     // Changes to the start date don't have to change the until date.</span>
<a href="#l89.368"></a><span id="l89.368">     untilDateCompensation(item);</span>
<a href="#l89.369"></a><span id="l89.369"> </span>
<a href="#l89.370"></a><span id="l89.370" class="difflineminus">-    if (isEvent(item)) {</span>
<a href="#l89.371"></a><span id="l89.371" class="difflineplus">+    if (cal.isEvent(item)) {</span>
<a href="#l89.372"></a><span id="l89.372">         let startTime = gStartTime.getInTimezone(gStartTimezone);</span>
<a href="#l89.373"></a><span id="l89.373">         let endTime = gEndTime.getInTimezone(gEndTimezone);</span>
<a href="#l89.374"></a><span id="l89.374">         let isAllDay = getElementValue(&quot;event-all-day&quot;, &quot;checked&quot;);</span>
<a href="#l89.375"></a><span id="l89.375">         if (isAllDay) {</span>
<a href="#l89.376"></a><span id="l89.376">             startTime = startTime.clone();</span>
<a href="#l89.377"></a><span id="l89.377">             endTime = endTime.clone();</span>
<a href="#l89.378"></a><span id="l89.378">             startTime.isDate = true;</span>
<a href="#l89.379"></a><span id="l89.379">             endTime.isDate = true;</span>
<a href="#l89.380"></a><span id="l89.380">             endTime.day += 1;</span>
<a href="#l89.381"></a><span id="l89.381">         } else {</span>
<a href="#l89.382"></a><span id="l89.382">             startTime = startTime.clone();</span>
<a href="#l89.383"></a><span id="l89.383">             startTime.isDate = false;</span>
<a href="#l89.384"></a><span id="l89.384">             endTime = endTime.clone();</span>
<a href="#l89.385"></a><span id="l89.385">             endTime.isDate = false;</span>
<a href="#l89.386"></a><span id="l89.386">         }</span>
<a href="#l89.387"></a><span id="l89.387" class="difflineminus">-        setItemProperty(item, &quot;startDate&quot;, startTime);</span>
<a href="#l89.388"></a><span id="l89.388" class="difflineminus">-        setItemProperty(item, &quot;endDate&quot;, endTime);</span>
<a href="#l89.389"></a><span id="l89.389" class="difflineplus">+        cal.setItemProperty(item, &quot;startDate&quot;, startTime);</span>
<a href="#l89.390"></a><span id="l89.390" class="difflineplus">+        cal.setItemProperty(item, &quot;endDate&quot;, endTime);</span>
<a href="#l89.391"></a><span id="l89.391">     }</span>
<a href="#l89.392"></a><span id="l89.392" class="difflineminus">-    if (isToDo(item)) {</span>
<a href="#l89.393"></a><span id="l89.393" class="difflineplus">+    if (cal.isToDo(item)) {</span>
<a href="#l89.394"></a><span id="l89.394">         let startTime = gStartTime &amp;&amp; gStartTime.getInTimezone(gStartTimezone);</span>
<a href="#l89.395"></a><span id="l89.395">         let endTime = gEndTime &amp;&amp; gEndTime.getInTimezone(gEndTimezone);</span>
<a href="#l89.396"></a><span id="l89.396" class="difflineminus">-        setItemProperty(item, &quot;entryDate&quot;, startTime);</span>
<a href="#l89.397"></a><span id="l89.397" class="difflineminus">-        setItemProperty(item, &quot;dueDate&quot;, endTime);</span>
<a href="#l89.398"></a><span id="l89.398" class="difflineplus">+        cal.setItemProperty(item, &quot;entryDate&quot;, startTime);</span>
<a href="#l89.399"></a><span id="l89.399" class="difflineplus">+        cal.setItemProperty(item, &quot;dueDate&quot;, endTime);</span>
<a href="#l89.400"></a><span id="l89.400">     }</span>
<a href="#l89.401"></a><span id="l89.401"> }</span>
<a href="#l89.402"></a><span id="l89.402"> </span>
<a href="#l89.403"></a><span id="l89.403"> /**</span>
<a href="#l89.404"></a><span id="l89.404">  * Changes the until date in the rule in order to compensate the automatic</span>
<a href="#l89.405"></a><span id="l89.405">  * correction caused by the function onStartDateChange() when saving the</span>
<a href="#l89.406"></a><span id="l89.406">  * item.</span>
<a href="#l89.407"></a><span id="l89.407">  * It allows to keep the until date set in the dialog irrespective of the</span>
<a href="#l89.408"></a><span id="l89.408">  * changes that the user has done to the start date.</span>
<a href="#l89.409"></a><span id="l89.409">  */</span>
<a href="#l89.410"></a><span id="l89.410"> function untilDateCompensation(aItem) {</span>
<a href="#l89.411"></a><span id="l89.411">     // The current start date in the item is always the date that we get</span>
<a href="#l89.412"></a><span id="l89.412">     // when opening the dialog or after the last save.</span>
<a href="#l89.413"></a><span id="l89.413" class="difflineminus">-    let startDate = aItem[calGetStartDateProp(aItem)];</span>
<a href="#l89.414"></a><span id="l89.414" class="difflineplus">+    let startDate = aItem[cal.calGetStartDateProp(aItem)];</span>
<a href="#l89.415"></a><span id="l89.415"> </span>
<a href="#l89.416"></a><span id="l89.416">     if (aItem.recurrenceInfo) {</span>
<a href="#l89.417"></a><span id="l89.417">         let rrules = splitRecurrenceRules(aItem.recurrenceInfo);</span>
<a href="#l89.418"></a><span id="l89.418">         let rule = rrules[0][0];</span>
<a href="#l89.419"></a><span id="l89.419">         if (!rule.isByCount &amp;&amp; rule.isFinite &amp;&amp; startDate) {</span>
<a href="#l89.420"></a><span id="l89.420">             let compensation = startDate.subtractDate(gStartTime);</span>
<a href="#l89.421"></a><span id="l89.421">             if (compensation != &quot;PT0S&quot;) {</span>
<a href="#l89.422"></a><span id="l89.422">                 let untilDate = rule.untilDate.clone();</span>
<a href="#l89.423"></a><span id="l89.423" class="difflineat">@@ -1555,17 +1555,17 @@ function updateTitle() {</span>
<a href="#l89.424"></a><span id="l89.424"> </span>
<a href="#l89.425"></a><span id="l89.425"> /**</span>
<a href="#l89.426"></a><span id="l89.426">  * Update the disabled status of the accept button. The button is enabled if all</span>
<a href="#l89.427"></a><span id="l89.427">  * parts of the dialog have options selected that make sense.</span>
<a href="#l89.428"></a><span id="l89.428">  * constraining factors like</span>
<a href="#l89.429"></a><span id="l89.429">  */</span>
<a href="#l89.430"></a><span id="l89.430"> function updateAccept() {</span>
<a href="#l89.431"></a><span id="l89.431">     let enableAccept = true;</span>
<a href="#l89.432"></a><span id="l89.432" class="difflineminus">-    let kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l89.433"></a><span id="l89.433" class="difflineplus">+    let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l89.434"></a><span id="l89.434">     let startDate;</span>
<a href="#l89.435"></a><span id="l89.435">     let endDate;</span>
<a href="#l89.436"></a><span id="l89.436">     let isEvent = cal.isEvent(window.calendarItem);</span>
<a href="#l89.437"></a><span id="l89.437"> </span>
<a href="#l89.438"></a><span id="l89.438">     // don't allow for end dates to be before start dates</span>
<a href="#l89.439"></a><span id="l89.439">     if (isEvent) {</span>
<a href="#l89.440"></a><span id="l89.440">         startDate = cal.jsDateToDateTime(getElementValue(&quot;event-starttime&quot;));</span>
<a href="#l89.441"></a><span id="l89.441">         endDate = cal.jsDateToDateTime(getElementValue(&quot;event-endtime&quot;));</span>
<a href="#l89.442"></a><span id="l89.442" class="difflineat">@@ -1576,17 +1576,17 @@ function updateAccept() {</span>
<a href="#l89.443"></a><span id="l89.443">             cal.jsDateToDateTime(getElementValue(&quot;todo-duedate&quot;)) : null;</span>
<a href="#l89.444"></a><span id="l89.444">     }</span>
<a href="#l89.445"></a><span id="l89.445"> </span>
<a href="#l89.446"></a><span id="l89.446">     if (startDate &amp;&amp; endDate) {</span>
<a href="#l89.447"></a><span id="l89.447">         if (gTimezonesEnabled) {</span>
<a href="#l89.448"></a><span id="l89.448">             let startTimezone = gStartTimezone;</span>
<a href="#l89.449"></a><span id="l89.449">             let endTimezone = gEndTimezone;</span>
<a href="#l89.450"></a><span id="l89.450">             if (endTimezone.isUTC) {</span>
<a href="#l89.451"></a><span id="l89.451" class="difflineminus">-                if (!compareObjects(gStartTimezone, gEndTimezone)) {</span>
<a href="#l89.452"></a><span id="l89.452" class="difflineplus">+                if (!cal.compareObjects(gStartTimezone, gEndTimezone)) {</span>
<a href="#l89.453"></a><span id="l89.453">                     endTimezone = gStartTimezone;</span>
<a href="#l89.454"></a><span id="l89.454">                 }</span>
<a href="#l89.455"></a><span id="l89.455">             }</span>
<a href="#l89.456"></a><span id="l89.456"> </span>
<a href="#l89.457"></a><span id="l89.457">             startDate = startDate.getInTimezone(kDefaultTimezone);</span>
<a href="#l89.458"></a><span id="l89.458">             endDate = endDate.getInTimezone(kDefaultTimezone);</span>
<a href="#l89.459"></a><span id="l89.459"> </span>
<a href="#l89.460"></a><span id="l89.460">             startDate.timezone = startTimezone;</span>
<a href="#l89.461"></a><span id="l89.461" class="difflineat">@@ -1640,21 +1640,21 @@ var gOldEndTime = null;</span>
<a href="#l89.462"></a><span id="l89.462"> var gOldStartTimezone = null;</span>
<a href="#l89.463"></a><span id="l89.463"> var gOldEndTimezone = null;</span>
<a href="#l89.464"></a><span id="l89.464"> </span>
<a href="#l89.465"></a><span id="l89.465"> /**</span>
<a href="#l89.466"></a><span id="l89.466">  * Handler function to update controls and state in consequence of the &quot;all</span>
<a href="#l89.467"></a><span id="l89.467">  * day&quot; checkbox being clicked.</span>
<a href="#l89.468"></a><span id="l89.468">  */</span>
<a href="#l89.469"></a><span id="l89.469"> function onUpdateAllDay() {</span>
<a href="#l89.470"></a><span id="l89.470" class="difflineminus">-    if (!isEvent(window.calendarItem)) {</span>
<a href="#l89.471"></a><span id="l89.471" class="difflineplus">+    if (!cal.isEvent(window.calendarItem)) {</span>
<a href="#l89.472"></a><span id="l89.472">         return;</span>
<a href="#l89.473"></a><span id="l89.473">     }</span>
<a href="#l89.474"></a><span id="l89.474">     let allDay = getElementValue(&quot;event-all-day&quot;, &quot;checked&quot;);</span>
<a href="#l89.475"></a><span id="l89.475" class="difflineminus">-    let kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l89.476"></a><span id="l89.476" class="difflineplus">+    let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l89.477"></a><span id="l89.477"> </span>
<a href="#l89.478"></a><span id="l89.478">     if (allDay) {</span>
<a href="#l89.479"></a><span id="l89.479">         // Store date-times and related timezones so we can restore</span>
<a href="#l89.480"></a><span id="l89.480">         // if the user unchecks the &quot;all day&quot; checkbox.</span>
<a href="#l89.481"></a><span id="l89.481">         gOldStartTime = gStartTime.clone();</span>
<a href="#l89.482"></a><span id="l89.482">         gOldEndTime = gEndTime.clone();</span>
<a href="#l89.483"></a><span id="l89.483">         gOldStartTimezone = gStartTimezone;</span>
<a href="#l89.484"></a><span id="l89.484">         gOldEndTimezone = gEndTimezone;</span>
<a href="#l89.485"></a><span id="l89.485" class="difflineat">@@ -1671,17 +1671,17 @@ function onUpdateAllDay() {</span>
<a href="#l89.486"></a><span id="l89.486">             }</span>
<a href="#l89.487"></a><span id="l89.487">         }</span>
<a href="#l89.488"></a><span id="l89.488">     } else {</span>
<a href="#l89.489"></a><span id="l89.489">         gStartTime.isDate = false;</span>
<a href="#l89.490"></a><span id="l89.490">         gEndTime.isDate = false;</span>
<a href="#l89.491"></a><span id="l89.491">         if (!gOldStartTime &amp;&amp; !gOldEndTime) {</span>
<a href="#l89.492"></a><span id="l89.492">             // The checkbox has been unchecked for the first time, the event</span>
<a href="#l89.493"></a><span id="l89.493">             // was an &quot;All day&quot; type, so we have to set default values.</span>
<a href="#l89.494"></a><span id="l89.494" class="difflineminus">-            gStartTime.hour = getDefaultStartDate(window.initialStartDateValue).hour;</span>
<a href="#l89.495"></a><span id="l89.495" class="difflineplus">+            gStartTime.hour = cal.getDefaultStartDate(window.initialStartDateValue).hour;</span>
<a href="#l89.496"></a><span id="l89.496">             gEndTime.hour = gStartTime.hour;</span>
<a href="#l89.497"></a><span id="l89.497">             gEndTime.minute += Preferences.get(&quot;calendar.event.defaultlength&quot;, 60);</span>
<a href="#l89.498"></a><span id="l89.498">             gOldStartTimezone = kDefaultTimezone;</span>
<a href="#l89.499"></a><span id="l89.499">             gOldEndTimezone = kDefaultTimezone;</span>
<a href="#l89.500"></a><span id="l89.500">         } else {</span>
<a href="#l89.501"></a><span id="l89.501">             // Restore date-times previously stored.</span>
<a href="#l89.502"></a><span id="l89.502">             gStartTime.hour = gOldStartTime.hour;</span>
<a href="#l89.503"></a><span id="l89.503">             gStartTime.minute = gOldStartTime.minute;</span>
<a href="#l89.504"></a><span id="l89.504" class="difflineat">@@ -1709,17 +1709,17 @@ function onUpdateAllDay() {</span>
<a href="#l89.505"></a><span id="l89.505">  * - 'timezone-endtime'</span>
<a href="#l89.506"></a><span id="l89.506">  * the state depends on whether or not the event is configured as 'all-day' or not.</span>
<a href="#l89.507"></a><span id="l89.507">  */</span>
<a href="#l89.508"></a><span id="l89.508"> function updateAllDay() {</span>
<a href="#l89.509"></a><span id="l89.509">     if (gIgnoreUpdate) {</span>
<a href="#l89.510"></a><span id="l89.510">         return;</span>
<a href="#l89.511"></a><span id="l89.511">     }</span>
<a href="#l89.512"></a><span id="l89.512"> </span>
<a href="#l89.513"></a><span id="l89.513" class="difflineminus">-    if (!isEvent(window.calendarItem)) {</span>
<a href="#l89.514"></a><span id="l89.514" class="difflineplus">+    if (!cal.isEvent(window.calendarItem)) {</span>
<a href="#l89.515"></a><span id="l89.515">         return;</span>
<a href="#l89.516"></a><span id="l89.516">     }</span>
<a href="#l89.517"></a><span id="l89.517"> </span>
<a href="#l89.518"></a><span id="l89.518">     let allDay = getElementValue(&quot;event-all-day&quot;, &quot;checked&quot;);</span>
<a href="#l89.519"></a><span id="l89.519">     setElementValue(&quot;event-starttime&quot;, allDay, &quot;timepickerdisabled&quot;);</span>
<a href="#l89.520"></a><span id="l89.520">     setElementValue(&quot;event-endtime&quot;, allDay, &quot;timepickerdisabled&quot;);</span>
<a href="#l89.521"></a><span id="l89.521"> </span>
<a href="#l89.522"></a><span id="l89.522">     gStartTime.isDate = allDay;</span>
<a href="#l89.523"></a><span id="l89.523" class="difflineat">@@ -1792,17 +1792,17 @@ function editAttendees() {</span>
<a href="#l89.524"></a><span id="l89.524">                     organizer.commonName = null;</span>
<a href="#l89.525"></a><span id="l89.525">                 }</span>
<a href="#l89.526"></a><span id="l89.526">             }</span>
<a href="#l89.527"></a><span id="l89.527">             savedWindow.organizer = organizer;</span>
<a href="#l89.528"></a><span id="l89.528">         }</span>
<a href="#l89.529"></a><span id="l89.529">         let duration = endTime.subtractDate(startTime);</span>
<a href="#l89.530"></a><span id="l89.530">         startTime = startTime.clone();</span>
<a href="#l89.531"></a><span id="l89.531">         endTime = endTime.clone();</span>
<a href="#l89.532"></a><span id="l89.532" class="difflineminus">-        let kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l89.533"></a><span id="l89.533" class="difflineplus">+        let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l89.534"></a><span id="l89.534">         gStartTimezone = startTime.timezone;</span>
<a href="#l89.535"></a><span id="l89.535">         gEndTimezone = endTime.timezone;</span>
<a href="#l89.536"></a><span id="l89.536">         gStartTime = startTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l89.537"></a><span id="l89.537">         gEndTime = endTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l89.538"></a><span id="l89.538">         gItemDuration = duration;</span>
<a href="#l89.539"></a><span id="l89.539">         updateAttendees();</span>
<a href="#l89.540"></a><span id="l89.540">         updateDateTime();</span>
<a href="#l89.541"></a><span id="l89.541">         updateAllDay();</span>
<a href="#l89.542"></a><span id="l89.542" class="difflineat">@@ -1946,27 +1946,27 @@ function loadCloudProviders() {</span>
<a href="#l89.543"></a><span id="l89.543"> /**</span>
<a href="#l89.544"></a><span id="l89.544">  * Prompts the user to attach an url to this item.</span>
<a href="#l89.545"></a><span id="l89.545">  */</span>
<a href="#l89.546"></a><span id="l89.546"> function attachURL() {</span>
<a href="#l89.547"></a><span id="l89.547">     if (Services.prompt) {</span>
<a href="#l89.548"></a><span id="l89.548">         // ghost in an example...</span>
<a href="#l89.549"></a><span id="l89.549">         let result = { value: &quot;http://&quot; };</span>
<a href="#l89.550"></a><span id="l89.550">         if (Services.prompt.prompt(window,</span>
<a href="#l89.551"></a><span id="l89.551" class="difflineminus">-                                   calGetString(&quot;calendar-event-dialog&quot;,</span>
<a href="#l89.552"></a><span id="l89.552" class="difflineminus">-                                                &quot;specifyLinkLocation&quot;),</span>
<a href="#l89.553"></a><span id="l89.553" class="difflineminus">-                                   calGetString(&quot;calendar-event-dialog&quot;,</span>
<a href="#l89.554"></a><span id="l89.554" class="difflineminus">-                                                &quot;enterLinkLocation&quot;),</span>
<a href="#l89.555"></a><span id="l89.555" class="difflineplus">+                                   cal.calGetString(&quot;calendar-event-dialog&quot;,</span>
<a href="#l89.556"></a><span id="l89.556" class="difflineplus">+                                                    &quot;specifyLinkLocation&quot;),</span>
<a href="#l89.557"></a><span id="l89.557" class="difflineplus">+                                   cal.calGetString(&quot;calendar-event-dialog&quot;,</span>
<a href="#l89.558"></a><span id="l89.558" class="difflineplus">+                                                    &quot;enterLinkLocation&quot;),</span>
<a href="#l89.559"></a><span id="l89.559">                                    result,</span>
<a href="#l89.560"></a><span id="l89.560">                                    null,</span>
<a href="#l89.561"></a><span id="l89.561">                                    { value: 0 })) {</span>
<a href="#l89.562"></a><span id="l89.562">             try {</span>
<a href="#l89.563"></a><span id="l89.563" class="difflineminus">-                // If something bogus was entered, makeURL may fail.</span>
<a href="#l89.564"></a><span id="l89.564" class="difflineminus">-                let attachment = createAttachment();</span>
<a href="#l89.565"></a><span id="l89.565" class="difflineminus">-                attachment.uri = makeURL(result.value);</span>
<a href="#l89.566"></a><span id="l89.566" class="difflineplus">+                // If something bogus was entered, cal.makeURL may fail.</span>
<a href="#l89.567"></a><span id="l89.567" class="difflineplus">+                let attachment = cal.createAttachment();</span>
<a href="#l89.568"></a><span id="l89.568" class="difflineplus">+                attachment.uri = cal.makeURL(result.value);</span>
<a href="#l89.569"></a><span id="l89.569">                 addAttachment(attachment);</span>
<a href="#l89.570"></a><span id="l89.570">             } catch (e) {</span>
<a href="#l89.571"></a><span id="l89.571">                 // TODO We might want to show a warning instead of just not</span>
<a href="#l89.572"></a><span id="l89.572">                 // adding the file</span>
<a href="#l89.573"></a><span id="l89.573">             }</span>
<a href="#l89.574"></a><span id="l89.574">         }</span>
<a href="#l89.575"></a><span id="l89.575">     }</span>
<a href="#l89.576"></a><span id="l89.576"> }</span>
<a href="#l89.577"></a><span id="l89.577" class="difflineat">@@ -1996,17 +1996,17 @@ function attachFile(cloudProvider) {</span>
<a href="#l89.578"></a><span id="l89.578">     }</span>
<a href="#l89.579"></a><span id="l89.579"> </span>
<a href="#l89.580"></a><span id="l89.580">     let files;</span>
<a href="#l89.581"></a><span id="l89.581">     try {</span>
<a href="#l89.582"></a><span id="l89.582">         const nsIFilePicker = Components.interfaces.nsIFilePicker;</span>
<a href="#l89.583"></a><span id="l89.583">         let filePicker = Components.classes[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l89.584"></a><span id="l89.584">                                    .createInstance(nsIFilePicker);</span>
<a href="#l89.585"></a><span id="l89.585">         filePicker.init(window,</span>
<a href="#l89.586"></a><span id="l89.586" class="difflineminus">-                        calGetString(&quot;calendar-event-dialog&quot;, &quot;selectAFile&quot;),</span>
<a href="#l89.587"></a><span id="l89.587" class="difflineplus">+                        cal.calGetString(&quot;calendar-event-dialog&quot;, &quot;selectAFile&quot;),</span>
<a href="#l89.588"></a><span id="l89.588">                         nsIFilePicker.modeOpenMultiple);</span>
<a href="#l89.589"></a><span id="l89.589"> </span>
<a href="#l89.590"></a><span id="l89.590">         // Check for the last directory</span>
<a href="#l89.591"></a><span id="l89.591">         let lastDir = lastDirectory();</span>
<a href="#l89.592"></a><span id="l89.592">         if (lastDir) {</span>
<a href="#l89.593"></a><span id="l89.593">             filePicker.displayDirectory = lastDir;</span>
<a href="#l89.594"></a><span id="l89.594">         }</span>
<a href="#l89.595"></a><span id="l89.595"> </span>
<a href="#l89.596"></a><span id="l89.596" class="difflineat">@@ -2034,17 +2034,17 @@ function attachFile(cloudProvider) {</span>
<a href="#l89.597"></a><span id="l89.597">         if (!(uriSpec in gAttachMap)) {</span>
<a href="#l89.598"></a><span id="l89.598">             // If the attachment hasn't been added, then set the last display</span>
<a href="#l89.599"></a><span id="l89.599">             // directory.</span>
<a href="#l89.600"></a><span id="l89.600">             lastDirectory(uriSpec);</span>
<a href="#l89.601"></a><span id="l89.601"> </span>
<a href="#l89.602"></a><span id="l89.602">             // ... and add the attachment.</span>
<a href="#l89.603"></a><span id="l89.603">             let attachment = cal.createAttachment();</span>
<a href="#l89.604"></a><span id="l89.604">             if (cloudProvider) {</span>
<a href="#l89.605"></a><span id="l89.605" class="difflineminus">-                attachment.uri = makeURL(uriSpec);</span>
<a href="#l89.606"></a><span id="l89.606" class="difflineplus">+                attachment.uri = cal.makeURL(uriSpec);</span>
<a href="#l89.607"></a><span id="l89.607">             } else {</span>
<a href="#l89.608"></a><span id="l89.608">                 // TODO read file into attachment</span>
<a href="#l89.609"></a><span id="l89.609">             }</span>
<a href="#l89.610"></a><span id="l89.610">             addAttachment(attachment, cloudProvider);</span>
<a href="#l89.611"></a><span id="l89.611">         }</span>
<a href="#l89.612"></a><span id="l89.612">     }</span>
<a href="#l89.613"></a><span id="l89.613"> }</span>
<a href="#l89.614"></a><span id="l89.614"> </span>
<a href="#l89.615"></a><span id="l89.615" class="difflineat">@@ -2054,17 +2054,17 @@ function attachFile(cloudProvider) {</span>
<a href="#l89.616"></a><span id="l89.616">  * @param aFileUri    (optional) If passed, the last directory will be set and</span>
<a href="#l89.617"></a><span id="l89.617">  *                                 returned. If null, the last chosen directory</span>
<a href="#l89.618"></a><span id="l89.618">  *                                 will be returned.</span>
<a href="#l89.619"></a><span id="l89.619">  * @return            The last directory that was set with this function.</span>
<a href="#l89.620"></a><span id="l89.620">  */</span>
<a href="#l89.621"></a><span id="l89.621"> function lastDirectory(aFileUri) {</span>
<a href="#l89.622"></a><span id="l89.622">     if (aFileUri) {</span>
<a href="#l89.623"></a><span id="l89.623">         // Act similar to a setter, save the passed uri.</span>
<a href="#l89.624"></a><span id="l89.624" class="difflineminus">-        let uri = makeURL(aFileUri);</span>
<a href="#l89.625"></a><span id="l89.625" class="difflineplus">+        let uri = cal.makeURL(aFileUri);</span>
<a href="#l89.626"></a><span id="l89.626">         let file = uri.QueryInterface(Components.interfaces.nsIFileURL).file;</span>
<a href="#l89.627"></a><span id="l89.627">         lastDirectory.mValue = file.parent.QueryInterface(Components.interfaces.nsILocalFile);</span>
<a href="#l89.628"></a><span id="l89.628">     }</span>
<a href="#l89.629"></a><span id="l89.629"> </span>
<a href="#l89.630"></a><span id="l89.630">     // In any case, return the value</span>
<a href="#l89.631"></a><span id="l89.631">     return (lastDirectory.mValue === undefined ? null : lastDirectory.mValue);</span>
<a href="#l89.632"></a><span id="l89.632"> }</span>
<a href="#l89.633"></a><span id="l89.633"> </span>
<a href="#l89.634"></a><span id="l89.634" class="difflineat">@@ -2102,17 +2102,17 @@ function uploadCloudAttachment(attachmen</span>
<a href="#l89.635"></a><span id="l89.635">     cloudProvider.uploadFile(file, {</span>
<a href="#l89.636"></a><span id="l89.636">         onStartRequest: function() {</span>
<a href="#l89.637"></a><span id="l89.637">             listItem.setAttribute(&quot;image&quot;, &quot;chrome://global/skin/icons/loading.png&quot;);</span>
<a href="#l89.638"></a><span id="l89.638">         },</span>
<a href="#l89.639"></a><span id="l89.639"> </span>
<a href="#l89.640"></a><span id="l89.640">         onStopRequest: function(aRequest, aContext, aStatusCode) {</span>
<a href="#l89.641"></a><span id="l89.641">             if (Components.isSuccessCode(aStatusCode)) {</span>
<a href="#l89.642"></a><span id="l89.642">                 delete gAttachMap[attachment.hashId];</span>
<a href="#l89.643"></a><span id="l89.643" class="difflineminus">-                attachment.uri = makeURL(cloudProvider.urlForFile(file));</span>
<a href="#l89.644"></a><span id="l89.644" class="difflineplus">+                attachment.uri = cal.makeURL(cloudProvider.urlForFile(file));</span>
<a href="#l89.645"></a><span id="l89.645">                 attachment.setParameter(&quot;FILENAME&quot;, file.leafName);</span>
<a href="#l89.646"></a><span id="l89.646">                 attachment.setParameter(&quot;PROVIDER&quot;, cloudProvider.type);</span>
<a href="#l89.647"></a><span id="l89.647">                 listItem.setAttribute(&quot;label&quot;, file.leafName);</span>
<a href="#l89.648"></a><span id="l89.648">                 gAttachMap[attachment.hashId] = attachment;</span>
<a href="#l89.649"></a><span id="l89.649">                 listItem.setAttribute(&quot;image&quot;, cloudProvider.iconClass);</span>
<a href="#l89.650"></a><span id="l89.650">                 updateAttachment();</span>
<a href="#l89.651"></a><span id="l89.651">             } else {</span>
<a href="#l89.652"></a><span id="l89.652">                 cal.ERROR(&quot;[calendar-event-dialog] Uploading cloud attachment &quot; +</span>
<a href="#l89.653"></a><span id="l89.653" class="difflineat">@@ -2537,17 +2537,17 @@ function editRepeat() {</span>
<a href="#l89.654"></a><span id="l89.654">  * @param aItemRepeatCall      True when the function is being called from</span>
<a href="#l89.655"></a><span id="l89.655">  *                               the item-repeat menu list. It allows to detect</span>
<a href="#l89.656"></a><span id="l89.656">  *                               a change from the &quot;custom&quot; option.</span>
<a href="#l89.657"></a><span id="l89.657">  */</span>
<a href="#l89.658"></a><span id="l89.658"> function updateRepeat(aSuppressDialogs, aItemRepeatCall) {</span>
<a href="#l89.659"></a><span id="l89.659">     function setUpEntrydateForTask(item) {</span>
<a href="#l89.660"></a><span id="l89.660">         // if this item is a task, we need to make sure that it has</span>
<a href="#l89.661"></a><span id="l89.661">         // an entry-date, otherwise we can't create a recurrence.</span>
<a href="#l89.662"></a><span id="l89.662" class="difflineminus">-        if (isToDo(item)) {</span>
<a href="#l89.663"></a><span id="l89.663" class="difflineplus">+        if (cal.isToDo(item)) {</span>
<a href="#l89.664"></a><span id="l89.664">             // automatically check 'has entrydate' if needed.</span>
<a href="#l89.665"></a><span id="l89.665">             if (!getElementValue(&quot;todo-has-entrydate&quot;, &quot;checked&quot;)) {</span>
<a href="#l89.666"></a><span id="l89.666">                 setElementValue(&quot;todo-has-entrydate&quot;, &quot;true&quot;, &quot;checked&quot;);</span>
<a href="#l89.667"></a><span id="l89.667"> </span>
<a href="#l89.668"></a><span id="l89.668">                 // make sure gStartTime is properly initialized</span>
<a href="#l89.669"></a><span id="l89.669">                 updateEntryDate();</span>
<a href="#l89.670"></a><span id="l89.670">             }</span>
<a href="#l89.671"></a><span id="l89.671"> </span>
<a href="#l89.672"></a><span id="l89.672" class="difflineat">@@ -2561,17 +2561,17 @@ function updateRepeat(aSuppressDialogs, </span>
<a href="#l89.673"></a><span id="l89.673">     let repeatMenu = document.getElementById(&quot;item-repeat&quot;);</span>
<a href="#l89.674"></a><span id="l89.674">     let repeatValue = repeatMenu.selectedItem.getAttribute(&quot;value&quot;);</span>
<a href="#l89.675"></a><span id="l89.675">     let repeatDeck = document.getElementById(&quot;repeat-deck&quot;);</span>
<a href="#l89.676"></a><span id="l89.676"> </span>
<a href="#l89.677"></a><span id="l89.677">     if (repeatValue == &quot;none&quot;) {</span>
<a href="#l89.678"></a><span id="l89.678">         repeatDeck.selectedIndex = -1;</span>
<a href="#l89.679"></a><span id="l89.679">         window.recurrenceInfo = null;</span>
<a href="#l89.680"></a><span id="l89.680">         let item = window.calendarItem;</span>
<a href="#l89.681"></a><span id="l89.681" class="difflineminus">-        if (isToDo(item)) {</span>
<a href="#l89.682"></a><span id="l89.682" class="difflineplus">+        if (cal.isToDo(item)) {</span>
<a href="#l89.683"></a><span id="l89.683">             enableElementWithLock(&quot;todo-has-entrydate&quot;, &quot;repeat-lock&quot;);</span>
<a href="#l89.684"></a><span id="l89.684">         }</span>
<a href="#l89.685"></a><span id="l89.685">     } else if (repeatValue == &quot;custom&quot;) {</span>
<a href="#l89.686"></a><span id="l89.686">         let lastRepeatDeck = repeatDeck.selectedIndex;</span>
<a href="#l89.687"></a><span id="l89.687">         repeatDeck.selectedIndex = 1;</span>
<a href="#l89.688"></a><span id="l89.688">         // the user selected custom repeat pattern. we now need to bring</span>
<a href="#l89.689"></a><span id="l89.689">         // up the appropriate dialog in order to let the user specify the</span>
<a href="#l89.690"></a><span id="l89.690">         // new rule. First of all, retrieve the item we want to specify</span>
<a href="#l89.691"></a><span id="l89.691" class="difflineat">@@ -2594,33 +2594,33 @@ function updateRepeat(aSuppressDialogs, </span>
<a href="#l89.692"></a><span id="l89.692"> </span>
<a href="#l89.693"></a><span id="l89.693">         // Assign gUntilDate on the first run or when returning from the</span>
<a href="#l89.694"></a><span id="l89.694">         // edit recurrence dialog.</span>
<a href="#l89.695"></a><span id="l89.695">         if (window.recurrenceInfo) {</span>
<a href="#l89.696"></a><span id="l89.696">             let rrules = splitRecurrenceRules(window.recurrenceInfo);</span>
<a href="#l89.697"></a><span id="l89.697">             let rule = rrules[0][0];</span>
<a href="#l89.698"></a><span id="l89.698">             gUntilDate = null;</span>
<a href="#l89.699"></a><span id="l89.699">             if (!rule.isByCount &amp;&amp; rule.isFinite) {</span>
<a href="#l89.700"></a><span id="l89.700" class="difflineminus">-                gUntilDate = rule.untilDate.clone().getInTimezone(calendarDefaultTimezone());</span>
<a href="#l89.701"></a><span id="l89.701" class="difflineplus">+                gUntilDate = rule.untilDate.clone().getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l89.702"></a><span id="l89.702">             }</span>
<a href="#l89.703"></a><span id="l89.703">         }</span>
<a href="#l89.704"></a><span id="l89.704"> </span>
<a href="#l89.705"></a><span id="l89.705">         // we need to address two separate cases here.</span>
<a href="#l89.706"></a><span id="l89.706">         // 1)- We need to revoke the selection of the repeat</span>
<a href="#l89.707"></a><span id="l89.707">         //     drop down list in case the user didn't specify</span>
<a href="#l89.708"></a><span id="l89.708">         //     a new repeat pattern (i.e. canceled the dialog);</span>
<a href="#l89.709"></a><span id="l89.709">         //   - re-enable the 'has entrydate' option in case</span>
<a href="#l89.710"></a><span id="l89.710">         //     we didn't end up with a recurrence rule.</span>
<a href="#l89.711"></a><span id="l89.711">         // 2)  Check whether the new recurrence rule needs the</span>
<a href="#l89.712"></a><span id="l89.712">         //     recurrence details text or it can be displayed</span>
<a href="#l89.713"></a><span id="l89.713">         //     only with the repeat-until-datepicker.</span>
<a href="#l89.714"></a><span id="l89.714">         if (recurrenceInfo == window.recurrenceInfo) {</span>
<a href="#l89.715"></a><span id="l89.715">             repeatMenu.selectedIndex = gLastRepeatSelection;</span>
<a href="#l89.716"></a><span id="l89.716">             repeatDeck.selectedIndex = lastRepeatDeck;</span>
<a href="#l89.717"></a><span id="l89.717" class="difflineminus">-            if (isToDo(item)) {</span>
<a href="#l89.718"></a><span id="l89.718" class="difflineplus">+            if (cal.isToDo(item)) {</span>
<a href="#l89.719"></a><span id="l89.719">                 if (!window.recurrenceInfo) {</span>
<a href="#l89.720"></a><span id="l89.720">                     enableElementWithLock(&quot;todo-has-entrydate&quot;, &quot;repeat-lock&quot;);</span>
<a href="#l89.721"></a><span id="l89.721">                 }</span>
<a href="#l89.722"></a><span id="l89.722">             }</span>
<a href="#l89.723"></a><span id="l89.723">         } else {</span>
<a href="#l89.724"></a><span id="l89.724">             // From the Edit Recurrence dialog, the rules &quot;every day&quot; and</span>
<a href="#l89.725"></a><span id="l89.725">             // &quot;every weekday&quot; don't need the recurrence details text when they</span>
<a href="#l89.726"></a><span id="l89.726">             // have only the until date. The getRepeatTypeAndUntilDate()</span>
<a href="#l89.727"></a><span id="l89.727" class="difflineat">@@ -2672,23 +2672,23 @@ function updateRepeat(aSuppressDialogs, </span>
<a href="#l89.728"></a><span id="l89.728">                 }</span>
<a href="#l89.729"></a><span id="l89.729">                 setElementValue(&quot;repeat-until-datepicker&quot;, repeatDate);</span>
<a href="#l89.730"></a><span id="l89.730">             }</span>
<a href="#l89.731"></a><span id="l89.731">             if (rrules[0].length &gt; 0) {</span>
<a href="#l89.732"></a><span id="l89.732">                 recurrenceInfo.deleteRecurrenceItem(rule);</span>
<a href="#l89.733"></a><span id="l89.733">             }</span>
<a href="#l89.734"></a><span id="l89.734">         } else {</span>
<a href="#l89.735"></a><span id="l89.735">             // New event proposes &quot;forever&quot; as default until date.</span>
<a href="#l89.736"></a><span id="l89.736" class="difflineminus">-            recurrenceInfo = createRecurrenceInfo(item);</span>
<a href="#l89.737"></a><span id="l89.737" class="difflineplus">+            recurrenceInfo = cal.createRecurrenceInfo(item);</span>
<a href="#l89.738"></a><span id="l89.738">             setElementValue(&quot;repeat-until-datepicker&quot;, &quot;forever&quot;);</span>
<a href="#l89.739"></a><span id="l89.739">         }</span>
<a href="#l89.740"></a><span id="l89.740"> </span>
<a href="#l89.741"></a><span id="l89.741">         repeatDeck.selectedIndex = 0;</span>
<a href="#l89.742"></a><span id="l89.742"> </span>
<a href="#l89.743"></a><span id="l89.743" class="difflineminus">-        let recRule = createRecurrenceRule();</span>
<a href="#l89.744"></a><span id="l89.744" class="difflineplus">+        let recRule = cal.createRecurrenceRule();</span>
<a href="#l89.745"></a><span id="l89.745">         recRule.interval = 1;</span>
<a href="#l89.746"></a><span id="l89.746">         switch (repeatValue) {</span>
<a href="#l89.747"></a><span id="l89.747">             case &quot;daily&quot;:</span>
<a href="#l89.748"></a><span id="l89.748">                 recRule.type = &quot;DAILY&quot;;</span>
<a href="#l89.749"></a><span id="l89.749">                 break;</span>
<a href="#l89.750"></a><span id="l89.750">             case &quot;weekly&quot;:</span>
<a href="#l89.751"></a><span id="l89.751">                 recRule.type = &quot;WEEKLY&quot;;</span>
<a href="#l89.752"></a><span id="l89.752">                 break;</span>
<a href="#l89.753"></a><span id="l89.753" class="difflineat">@@ -2709,17 +2709,17 @@ function updateRepeat(aSuppressDialogs, </span>
<a href="#l89.754"></a><span id="l89.754">         }</span>
<a href="#l89.755"></a><span id="l89.755"> </span>
<a href="#l89.756"></a><span id="l89.756">         setUpEntrydateForTask(item);</span>
<a href="#l89.757"></a><span id="l89.757">         updateUntildateRecRule(recRule);</span>
<a href="#l89.758"></a><span id="l89.758"> </span>
<a href="#l89.759"></a><span id="l89.759">         recurrenceInfo.insertRecurrenceItemAt(recRule, 0);</span>
<a href="#l89.760"></a><span id="l89.760">         window.recurrenceInfo = recurrenceInfo;</span>
<a href="#l89.761"></a><span id="l89.761"> </span>
<a href="#l89.762"></a><span id="l89.762" class="difflineminus">-        if (isToDo(item)) {</span>
<a href="#l89.763"></a><span id="l89.763" class="difflineplus">+        if (cal.isToDo(item)) {</span>
<a href="#l89.764"></a><span id="l89.764">             if (!getElementValue(&quot;todo-has-entrydate&quot;, &quot;checked&quot;)) {</span>
<a href="#l89.765"></a><span id="l89.765">                 setElementValue(&quot;todo-has-entrydate&quot;, &quot;true&quot;, &quot;checked&quot;);</span>
<a href="#l89.766"></a><span id="l89.766">             }</span>
<a href="#l89.767"></a><span id="l89.767">             disableElementWithLock(&quot;todo-has-entrydate&quot;, &quot;repeat-lock&quot;);</span>
<a href="#l89.768"></a><span id="l89.768">         }</span>
<a href="#l89.769"></a><span id="l89.769"> </span>
<a href="#l89.770"></a><span id="l89.770">         // Preset the until-datepicker's minimonth to the start date.</span>
<a href="#l89.771"></a><span id="l89.771">         let startDate = cal.dateTimeToJsDate(gStartTime.getInTimezone(cal.floating()));</span>
<a href="#l89.772"></a><span id="l89.772" class="difflineat">@@ -3036,21 +3036,21 @@ function onCommandSave(aIsClosing) {</span>
<a href="#l89.773"></a><span id="l89.773">  */</span>
<a href="#l89.774"></a><span id="l89.774"> function onCommandDeleteItem() {</span>
<a href="#l89.775"></a><span id="l89.775">     // only ask for confirmation, if the User changed anything on a new item or we modify an existing item</span>
<a href="#l89.776"></a><span id="l89.776">     if (isItemChanged() || window.mode != &quot;new&quot;) {</span>
<a href="#l89.777"></a><span id="l89.777">         let promptTitle = &quot;&quot;;</span>
<a href="#l89.778"></a><span id="l89.778">         let promptMessage = &quot;&quot;;</span>
<a href="#l89.779"></a><span id="l89.779"> </span>
<a href="#l89.780"></a><span id="l89.780">         if (cal.isEvent(window.calendarItem)) {</span>
<a href="#l89.781"></a><span id="l89.781" class="difflineminus">-            promptTitle = calGetString(&quot;calendar&quot;, &quot;deleteEventLabel&quot;);</span>
<a href="#l89.782"></a><span id="l89.782" class="difflineminus">-            promptMessage = calGetString(&quot;calendar&quot;, &quot;deleteEventMessage&quot;);</span>
<a href="#l89.783"></a><span id="l89.783" class="difflineplus">+            promptTitle = cal.calGetString(&quot;calendar&quot;, &quot;deleteEventLabel&quot;);</span>
<a href="#l89.784"></a><span id="l89.784" class="difflineplus">+            promptMessage = cal.calGetString(&quot;calendar&quot;, &quot;deleteEventMessage&quot;);</span>
<a href="#l89.785"></a><span id="l89.785">         } else if (cal.isToDo(window.calendarItem)) {</span>
<a href="#l89.786"></a><span id="l89.786" class="difflineminus">-            promptTitle = calGetString(&quot;calendar&quot;, &quot;deleteTaskLabel&quot;);</span>
<a href="#l89.787"></a><span id="l89.787" class="difflineminus">-            promptMessage = calGetString(&quot;calendar&quot;, &quot;deleteTaskMessage&quot;);</span>
<a href="#l89.788"></a><span id="l89.788" class="difflineplus">+            promptTitle = cal.calGetString(&quot;calendar&quot;, &quot;deleteTaskLabel&quot;);</span>
<a href="#l89.789"></a><span id="l89.789" class="difflineplus">+            promptMessage = cal.calGetString(&quot;calendar&quot;, &quot;deleteTaskMessage&quot;);</span>
<a href="#l89.790"></a><span id="l89.790">         }</span>
<a href="#l89.791"></a><span id="l89.791"> </span>
<a href="#l89.792"></a><span id="l89.792">         let answerDelete = Services.prompt.confirm(</span>
<a href="#l89.793"></a><span id="l89.793">                                     null,</span>
<a href="#l89.794"></a><span id="l89.794">                                     promptTitle,</span>
<a href="#l89.795"></a><span id="l89.795">                                     promptMessage);</span>
<a href="#l89.796"></a><span id="l89.796">         if (!answerDelete) {</span>
<a href="#l89.797"></a><span id="l89.797">             return;</span>
<a href="#l89.798"></a><span id="l89.798" class="difflineat">@@ -3258,129 +3258,129 @@ function editTimezone(aElementId, aDateT</span>
<a href="#l89.799"></a><span id="l89.799"> function updateDateTime() {</span>
<a href="#l89.800"></a><span id="l89.800">     gIgnoreUpdate = true;</span>
<a href="#l89.801"></a><span id="l89.801"> </span>
<a href="#l89.802"></a><span id="l89.802">     let item = window.calendarItem;</span>
<a href="#l89.803"></a><span id="l89.803">     // Convert to default timezone if the timezone option</span>
<a href="#l89.804"></a><span id="l89.804">     // is *not* checked, otherwise keep the specific timezone</span>
<a href="#l89.805"></a><span id="l89.805">     // and display the labels in order to modify the timezone.</span>
<a href="#l89.806"></a><span id="l89.806">     if (gTimezonesEnabled) {</span>
<a href="#l89.807"></a><span id="l89.807" class="difflineminus">-        if (isEvent(item)) {</span>
<a href="#l89.808"></a><span id="l89.808" class="difflineplus">+        if (cal.isEvent(item)) {</span>
<a href="#l89.809"></a><span id="l89.809">             let startTime = gStartTime.getInTimezone(gStartTimezone);</span>
<a href="#l89.810"></a><span id="l89.810">             let endTime = gEndTime.getInTimezone(gEndTimezone);</span>
<a href="#l89.811"></a><span id="l89.811"> </span>
<a href="#l89.812"></a><span id="l89.812">             setElementValue(&quot;event-all-day&quot;, startTime.isDate, &quot;checked&quot;);</span>
<a href="#l89.813"></a><span id="l89.813"> </span>
<a href="#l89.814"></a><span id="l89.814">             // In the case where the timezones are different but</span>
<a href="#l89.815"></a><span id="l89.815">             // the timezone of the endtime is &quot;UTC&quot;, we convert</span>
<a href="#l89.816"></a><span id="l89.816">             // the endtime into the timezone of the starttime.</span>
<a href="#l89.817"></a><span id="l89.817">             if (startTime &amp;&amp; endTime) {</span>
<a href="#l89.818"></a><span id="l89.818" class="difflineminus">-                if (!compareObjects(startTime.timezone, endTime.timezone)) {</span>
<a href="#l89.819"></a><span id="l89.819" class="difflineplus">+                if (!cal.compareObjects(startTime.timezone, endTime.timezone)) {</span>
<a href="#l89.820"></a><span id="l89.820">                     if (endTime.timezone.isUTC) {</span>
<a href="#l89.821"></a><span id="l89.821">                         endTime = endTime.getInTimezone(startTime.timezone);</span>
<a href="#l89.822"></a><span id="l89.822">                     }</span>
<a href="#l89.823"></a><span id="l89.823">                 }</span>
<a href="#l89.824"></a><span id="l89.824">             }</span>
<a href="#l89.825"></a><span id="l89.825"> </span>
<a href="#l89.826"></a><span id="l89.826">             // before feeding the date/time value into the control we need</span>
<a href="#l89.827"></a><span id="l89.827">             // to set the timezone to 'floating' in order to avoid the</span>
<a href="#l89.828"></a><span id="l89.828">             // automatic conversion back into the OS timezone.</span>
<a href="#l89.829"></a><span id="l89.829" class="difflineminus">-            startTime.timezone = floating();</span>
<a href="#l89.830"></a><span id="l89.830" class="difflineminus">-            endTime.timezone = floating();</span>
<a href="#l89.831"></a><span id="l89.831" class="difflineplus">+            startTime.timezone = cal.floating();</span>
<a href="#l89.832"></a><span id="l89.832" class="difflineplus">+            endTime.timezone = cal.floating();</span>
<a href="#l89.833"></a><span id="l89.833"> </span>
<a href="#l89.834"></a><span id="l89.834">             setElementValue(&quot;event-starttime&quot;, cal.dateTimeToJsDate(startTime));</span>
<a href="#l89.835"></a><span id="l89.835">             setElementValue(&quot;event-endtime&quot;, cal.dateTimeToJsDate(endTime));</span>
<a href="#l89.836"></a><span id="l89.836">         }</span>
<a href="#l89.837"></a><span id="l89.837"> </span>
<a href="#l89.838"></a><span id="l89.838" class="difflineminus">-        if (isToDo(item)) {</span>
<a href="#l89.839"></a><span id="l89.839" class="difflineplus">+        if (cal.isToDo(item)) {</span>
<a href="#l89.840"></a><span id="l89.840">             let startTime = gStartTime &amp;&amp; gStartTime.getInTimezone(gStartTimezone);</span>
<a href="#l89.841"></a><span id="l89.841">             let endTime = gEndTime &amp;&amp; gEndTime.getInTimezone(gEndTimezone);</span>
<a href="#l89.842"></a><span id="l89.842">             let hasEntryDate = (startTime != null);</span>
<a href="#l89.843"></a><span id="l89.843">             let hasDueDate = (endTime != null);</span>
<a href="#l89.844"></a><span id="l89.844"> </span>
<a href="#l89.845"></a><span id="l89.845">             if (hasEntryDate &amp;&amp; hasDueDate) {</span>
<a href="#l89.846"></a><span id="l89.846">                 setElementValue(&quot;todo-has-entrydate&quot;, hasEntryDate, &quot;checked&quot;);</span>
<a href="#l89.847"></a><span id="l89.847" class="difflineminus">-                startTime.timezone = floating();</span>
<a href="#l89.848"></a><span id="l89.848" class="difflineplus">+                startTime.timezone = cal.floating();</span>
<a href="#l89.849"></a><span id="l89.849">                 setElementValue(&quot;todo-entrydate&quot;, cal.dateTimeToJsDate(startTime));</span>
<a href="#l89.850"></a><span id="l89.850"> </span>
<a href="#l89.851"></a><span id="l89.851">                 setElementValue(&quot;todo-has-duedate&quot;, hasDueDate, &quot;checked&quot;);</span>
<a href="#l89.852"></a><span id="l89.852" class="difflineminus">-                endTime.timezone = floating();</span>
<a href="#l89.853"></a><span id="l89.853" class="difflineplus">+                endTime.timezone = cal.floating();</span>
<a href="#l89.854"></a><span id="l89.854">                 setElementValue(&quot;todo-duedate&quot;, cal.dateTimeToJsDate(endTime));</span>
<a href="#l89.855"></a><span id="l89.855">             } else if (hasEntryDate) {</span>
<a href="#l89.856"></a><span id="l89.856">                 setElementValue(&quot;todo-has-entrydate&quot;, hasEntryDate, &quot;checked&quot;);</span>
<a href="#l89.857"></a><span id="l89.857" class="difflineminus">-                startTime.timezone = floating();</span>
<a href="#l89.858"></a><span id="l89.858" class="difflineplus">+                startTime.timezone = cal.floating();</span>
<a href="#l89.859"></a><span id="l89.859">                 setElementValue(&quot;todo-entrydate&quot;, cal.dateTimeToJsDate(startTime));</span>
<a href="#l89.860"></a><span id="l89.860"> </span>
<a href="#l89.861"></a><span id="l89.861" class="difflineminus">-                startTime.timezone = floating();</span>
<a href="#l89.862"></a><span id="l89.862" class="difflineplus">+                startTime.timezone = cal.floating();</span>
<a href="#l89.863"></a><span id="l89.863">                 setElementValue(&quot;todo-duedate&quot;, cal.dateTimeToJsDate(startTime));</span>
<a href="#l89.864"></a><span id="l89.864">             } else if (hasDueDate) {</span>
<a href="#l89.865"></a><span id="l89.865" class="difflineminus">-                endTime.timezone = floating();</span>
<a href="#l89.866"></a><span id="l89.866" class="difflineplus">+                endTime.timezone = cal.floating();</span>
<a href="#l89.867"></a><span id="l89.867">                 setElementValue(&quot;todo-entrydate&quot;, cal.dateTimeToJsDate(endTime));</span>
<a href="#l89.868"></a><span id="l89.868"> </span>
<a href="#l89.869"></a><span id="l89.869">                 setElementValue(&quot;todo-has-duedate&quot;, hasDueDate, &quot;checked&quot;);</span>
<a href="#l89.870"></a><span id="l89.870" class="difflineminus">-                endTime.timezone = floating();</span>
<a href="#l89.871"></a><span id="l89.871" class="difflineplus">+                endTime.timezone = cal.floating();</span>
<a href="#l89.872"></a><span id="l89.872">                 setElementValue(&quot;todo-duedate&quot;, cal.dateTimeToJsDate(endTime));</span>
<a href="#l89.873"></a><span id="l89.873">             } else {</span>
<a href="#l89.874"></a><span id="l89.874">                 startTime = window.initialStartDateValue;</span>
<a href="#l89.875"></a><span id="l89.875" class="difflineminus">-                startTime.timezone = floating();</span>
<a href="#l89.876"></a><span id="l89.876" class="difflineplus">+                startTime.timezone = cal.floating();</span>
<a href="#l89.877"></a><span id="l89.877">                 endTime = startTime.clone();</span>
<a href="#l89.878"></a><span id="l89.878"> </span>
<a href="#l89.879"></a><span id="l89.879">                 setElementValue(&quot;todo-entrydate&quot;, cal.dateTimeToJsDate(startTime));</span>
<a href="#l89.880"></a><span id="l89.880">                 setElementValue(&quot;todo-duedate&quot;, cal.dateTimeToJsDate(endTime));</span>
<a href="#l89.881"></a><span id="l89.881">             }</span>
<a href="#l89.882"></a><span id="l89.882">         }</span>
<a href="#l89.883"></a><span id="l89.883">     } else {</span>
<a href="#l89.884"></a><span id="l89.884" class="difflineminus">-        let kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l89.885"></a><span id="l89.885" class="difflineminus">-</span>
<a href="#l89.886"></a><span id="l89.886" class="difflineminus">-        if (isEvent(item)) {</span>
<a href="#l89.887"></a><span id="l89.887" class="difflineplus">+        let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l89.888"></a><span id="l89.888" class="difflineplus">+</span>
<a href="#l89.889"></a><span id="l89.889" class="difflineplus">+        if (cal.isEvent(item)) {</span>
<a href="#l89.890"></a><span id="l89.890">             let startTime = gStartTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l89.891"></a><span id="l89.891">             let endTime = gEndTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l89.892"></a><span id="l89.892">             setElementValue(&quot;event-all-day&quot;, startTime.isDate, &quot;checked&quot;);</span>
<a href="#l89.893"></a><span id="l89.893"> </span>
<a href="#l89.894"></a><span id="l89.894">             // before feeding the date/time value into the control we need</span>
<a href="#l89.895"></a><span id="l89.895">             // to set the timezone to 'floating' in order to avoid the</span>
<a href="#l89.896"></a><span id="l89.896">             // automatic conversion back into the OS timezone.</span>
<a href="#l89.897"></a><span id="l89.897" class="difflineminus">-            startTime.timezone = floating();</span>
<a href="#l89.898"></a><span id="l89.898" class="difflineminus">-            endTime.timezone = floating();</span>
<a href="#l89.899"></a><span id="l89.899" class="difflineplus">+            startTime.timezone = cal.floating();</span>
<a href="#l89.900"></a><span id="l89.900" class="difflineplus">+            endTime.timezone = cal.floating();</span>
<a href="#l89.901"></a><span id="l89.901">             setElementValue(&quot;event-starttime&quot;, cal.dateTimeToJsDate(startTime));</span>
<a href="#l89.902"></a><span id="l89.902">             setElementValue(&quot;event-endtime&quot;, cal.dateTimeToJsDate(endTime));</span>
<a href="#l89.903"></a><span id="l89.903">         }</span>
<a href="#l89.904"></a><span id="l89.904"> </span>
<a href="#l89.905"></a><span id="l89.905" class="difflineminus">-        if (isToDo(item)) {</span>
<a href="#l89.906"></a><span id="l89.906" class="difflineplus">+        if (cal.isToDo(item)) {</span>
<a href="#l89.907"></a><span id="l89.907">             let startTime = gStartTime &amp;&amp;</span>
<a href="#l89.908"></a><span id="l89.908">                             gStartTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l89.909"></a><span id="l89.909">             let endTime = gEndTime &amp;&amp; gEndTime.getInTimezone(kDefaultTimezone);</span>
<a href="#l89.910"></a><span id="l89.910">             let hasEntryDate = (startTime != null);</span>
<a href="#l89.911"></a><span id="l89.911">             let hasDueDate = (endTime != null);</span>
<a href="#l89.912"></a><span id="l89.912"> </span>
<a href="#l89.913"></a><span id="l89.913">             if (hasEntryDate &amp;&amp; hasDueDate) {</span>
<a href="#l89.914"></a><span id="l89.914">                 setElementValue(&quot;todo-has-entrydate&quot;, hasEntryDate, &quot;checked&quot;);</span>
<a href="#l89.915"></a><span id="l89.915" class="difflineminus">-                startTime.timezone = floating();</span>
<a href="#l89.916"></a><span id="l89.916" class="difflineplus">+                startTime.timezone = cal.floating();</span>
<a href="#l89.917"></a><span id="l89.917">                 setElementValue(&quot;todo-entrydate&quot;, cal.dateTimeToJsDate(startTime));</span>
<a href="#l89.918"></a><span id="l89.918"> </span>
<a href="#l89.919"></a><span id="l89.919">                 setElementValue(&quot;todo-has-duedate&quot;, hasDueDate, &quot;checked&quot;);</span>
<a href="#l89.920"></a><span id="l89.920" class="difflineminus">-                endTime.timezone = floating();</span>
<a href="#l89.921"></a><span id="l89.921" class="difflineplus">+                endTime.timezone = cal.floating();</span>
<a href="#l89.922"></a><span id="l89.922">                 setElementValue(&quot;todo-duedate&quot;, cal.dateTimeToJsDate(endTime));</span>
<a href="#l89.923"></a><span id="l89.923">             } else if (hasEntryDate) {</span>
<a href="#l89.924"></a><span id="l89.924">                 setElementValue(&quot;todo-has-entrydate&quot;, hasEntryDate, &quot;checked&quot;);</span>
<a href="#l89.925"></a><span id="l89.925" class="difflineminus">-                startTime.timezone = floating();</span>
<a href="#l89.926"></a><span id="l89.926" class="difflineplus">+                startTime.timezone = cal.floating();</span>
<a href="#l89.927"></a><span id="l89.927">                 setElementValue(&quot;todo-entrydate&quot;, cal.dateTimeToJsDate(startTime));</span>
<a href="#l89.928"></a><span id="l89.928"> </span>
<a href="#l89.929"></a><span id="l89.929" class="difflineminus">-                startTime.timezone = floating();</span>
<a href="#l89.930"></a><span id="l89.930" class="difflineplus">+                startTime.timezone = cal.floating();</span>
<a href="#l89.931"></a><span id="l89.931">                 setElementValue(&quot;todo-duedate&quot;, cal.dateTimeToJsDate(startTime));</span>
<a href="#l89.932"></a><span id="l89.932">             } else if (hasDueDate) {</span>
<a href="#l89.933"></a><span id="l89.933" class="difflineminus">-                endTime.timezone = floating();</span>
<a href="#l89.934"></a><span id="l89.934" class="difflineplus">+                endTime.timezone = cal.floating();</span>
<a href="#l89.935"></a><span id="l89.935">                 setElementValue(&quot;todo-entrydate&quot;, cal.dateTimeToJsDate(endTime));</span>
<a href="#l89.936"></a><span id="l89.936"> </span>
<a href="#l89.937"></a><span id="l89.937">                 setElementValue(&quot;todo-has-duedate&quot;, hasDueDate, &quot;checked&quot;);</span>
<a href="#l89.938"></a><span id="l89.938" class="difflineminus">-                endTime.timezone = floating();</span>
<a href="#l89.939"></a><span id="l89.939" class="difflineplus">+                endTime.timezone = cal.floating();</span>
<a href="#l89.940"></a><span id="l89.940">                 setElementValue(&quot;todo-duedate&quot;, cal.dateTimeToJsDate(endTime));</span>
<a href="#l89.941"></a><span id="l89.941">             } else {</span>
<a href="#l89.942"></a><span id="l89.942">                 startTime = window.initialStartDateValue;</span>
<a href="#l89.943"></a><span id="l89.943" class="difflineminus">-                startTime.timezone = floating();</span>
<a href="#l89.944"></a><span id="l89.944" class="difflineplus">+                startTime.timezone = cal.floating();</span>
<a href="#l89.945"></a><span id="l89.945">                 endTime = startTime.clone();</span>
<a href="#l89.946"></a><span id="l89.946"> </span>
<a href="#l89.947"></a><span id="l89.947">                 setElementValue(&quot;todo-entrydate&quot;, cal.dateTimeToJsDate(startTime));</span>
<a href="#l89.948"></a><span id="l89.948">                 setElementValue(&quot;todo-duedate&quot;, cal.dateTimeToJsDate(endTime));</span>
<a href="#l89.949"></a><span id="l89.949">             }</span>
<a href="#l89.950"></a><span id="l89.950">         }</span>
<a href="#l89.951"></a><span id="l89.951">     }</span>
<a href="#l89.952"></a><span id="l89.952"> </span>
<a href="#l89.953"></a><span id="l89.953" class="difflineat">@@ -3480,17 +3480,17 @@ function updateAttachment() {</span>
<a href="#l89.954"></a><span id="l89.954">  * @param {string} aUrl    The url in question</span>
<a href="#l89.955"></a><span id="l89.955">  * @return {boolean}       Returns true for show and false for hide</span>
<a href="#l89.956"></a><span id="l89.956">  */</span>
<a href="#l89.957"></a><span id="l89.957"> function showOrHideItemURL(aShow, aUrl) {</span>
<a href="#l89.958"></a><span id="l89.958">     if (aShow &amp;&amp; aUrl.length) {</span>
<a href="#l89.959"></a><span id="l89.959">         let handler;</span>
<a href="#l89.960"></a><span id="l89.960">         let uri;</span>
<a href="#l89.961"></a><span id="l89.961">         try {</span>
<a href="#l89.962"></a><span id="l89.962" class="difflineminus">-            uri = makeURL(aUrl);</span>
<a href="#l89.963"></a><span id="l89.963" class="difflineplus">+            uri = cal.makeURL(aUrl);</span>
<a href="#l89.964"></a><span id="l89.964">             handler = Services.io.getProtocolHandler(uri.scheme);</span>
<a href="#l89.965"></a><span id="l89.965">         } catch (e) {</span>
<a href="#l89.966"></a><span id="l89.966">             // No protocol handler for the given protocol, or invalid uri</span>
<a href="#l89.967"></a><span id="l89.967">             // hideOrShow(false);</span>
<a href="#l89.968"></a><span id="l89.968">             return false;</span>
<a href="#l89.969"></a><span id="l89.969">         }</span>
<a href="#l89.970"></a><span id="l89.970">         // Only show if its either an internal protcol handler, or its external</span>
<a href="#l89.971"></a><span id="l89.971">         // and there is an external app for the scheme</span>
<a href="#l89.972"></a><span id="l89.972" class="difflineat">@@ -3531,17 +3531,17 @@ function updateItemURL(aShow, aUrl) {</span>
<a href="#l89.973"></a><span id="l89.973"> </span>
<a href="#l89.974"></a><span id="l89.974"> /**</span>
<a href="#l89.975"></a><span id="l89.975">  * This function updates dialog controls related to attendees.</span>
<a href="#l89.976"></a><span id="l89.976">  */</span>
<a href="#l89.977"></a><span id="l89.977"> function updateAttendees() {</span>
<a href="#l89.978"></a><span id="l89.978">     // sending email invitations currently only supported for events</span>
<a href="#l89.979"></a><span id="l89.979">     let attendeeTab = document.getElementById(&quot;event-grid-tab-attendees&quot;);</span>
<a href="#l89.980"></a><span id="l89.980">     let attendeePanel = document.getElementById(&quot;event-grid-tabpanel-attendees&quot;);</span>
<a href="#l89.981"></a><span id="l89.981" class="difflineminus">-    if (isEvent(window.calendarItem)) {</span>
<a href="#l89.982"></a><span id="l89.982" class="difflineplus">+    if (cal.isEvent(window.calendarItem)) {</span>
<a href="#l89.983"></a><span id="l89.983">         attendeeTab.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l89.984"></a><span id="l89.984">         attendeePanel.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l89.985"></a><span id="l89.985"> </span>
<a href="#l89.986"></a><span id="l89.986">         if (window.organizer &amp;&amp; window.organizer.id) {</span>
<a href="#l89.987"></a><span id="l89.987">             document.getElementById(&quot;item-organizer-row&quot;).removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l89.988"></a><span id="l89.988">             let cell = document.querySelector(&quot;.item-organizer-cell&quot;);</span>
<a href="#l89.989"></a><span id="l89.989">             let icon = cell.querySelector(&quot;img:nth-of-type(1)&quot;);</span>
<a href="#l89.990"></a><span id="l89.990">             let text = cell.querySelector(&quot;label:nth-of-type(1)&quot;);</span>
<a href="#l89.991"></a><span id="l89.991" class="difflineat">@@ -3591,17 +3591,17 @@ function updateRepeatDetails() {</span>
<a href="#l89.992"></a><span id="l89.992">         // First of all collapse the details text. If we fail to</span>
<a href="#l89.993"></a><span id="l89.993">         // create a details string, we simply don't show anything.</span>
<a href="#l89.994"></a><span id="l89.994">         // this could happen if the repeat rule is something exotic</span>
<a href="#l89.995"></a><span id="l89.995">         // we don't have any strings prepared for.</span>
<a href="#l89.996"></a><span id="l89.996">         let repeatDetails = document.getElementById(&quot;repeat-details&quot;);</span>
<a href="#l89.997"></a><span id="l89.997">         repeatDetails.setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l89.998"></a><span id="l89.998"> </span>
<a href="#l89.999"></a><span id="l89.999">         // Try to create a descriptive string from the rule(s).</span>
<a href="#l89.1000"></a><span id="l89.1000" class="difflineminus">-        let kDefaultTimezone = calendarDefaultTimezone();</span>
<a href="#l89.1001"></a><span id="l89.1001" class="difflineplus">+        let kDefaultTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l89.1002"></a><span id="l89.1002">         let event = cal.isEvent(item);</span>
<a href="#l89.1003"></a><span id="l89.1003"> </span>
<a href="#l89.1004"></a><span id="l89.1004">         let startDate = getElementValue(event ? &quot;event-starttime&quot; : &quot;todo-entrydate&quot;);</span>
<a href="#l89.1005"></a><span id="l89.1005">         let endDate = getElementValue(event ? &quot;event-endtime&quot; : &quot;todo-duedate&quot;);</span>
<a href="#l89.1006"></a><span id="l89.1006">         startDate = cal.jsDateToDateTime(startDate, kDefaultTimezone);</span>
<a href="#l89.1007"></a><span id="l89.1007">         endDate = cal.jsDateToDateTime(endDate, kDefaultTimezone);</span>
<a href="#l89.1008"></a><span id="l89.1008"> </span>
<a href="#l89.1009"></a><span id="l89.1009">         let allDay = getElementValue(&quot;event-all-day&quot;, &quot;checked&quot;);</span>
<a href="#l89.1010"></a><span id="l89.1010" class="difflineat">@@ -3753,17 +3753,17 @@ function sendMailToUndecidedAttendees(aA</span>
<a href="#l89.1011"></a><span id="l89.1011">  *</span>
<a href="#l89.1012"></a><span id="l89.1012">  * @param aAttendees    The attendees to send mail to.</span>
<a href="#l89.1013"></a><span id="l89.1013">  */</span>
<a href="#l89.1014"></a><span id="l89.1014"> function sendMailToAttendees(aAttendees) {</span>
<a href="#l89.1015"></a><span id="l89.1015">     let toList = cal.getRecipientList(aAttendees);</span>
<a href="#l89.1016"></a><span id="l89.1016">     let item = saveItem();</span>
<a href="#l89.1017"></a><span id="l89.1017">     let emailSubject = cal.calGetString(&quot;calendar-event-dialog&quot;, &quot;emailSubjectReply&quot;, [item.title]);</span>
<a href="#l89.1018"></a><span id="l89.1018">     let identity = window.calendarItem.calendar.getProperty(&quot;imip.identity&quot;);</span>
<a href="#l89.1019"></a><span id="l89.1019" class="difflineminus">-    sendMailTo(toList, emailSubject, null, identity);</span>
<a href="#l89.1020"></a><span id="l89.1020" class="difflineplus">+    cal.sendMailTo(toList, emailSubject, null, identity);</span>
<a href="#l89.1021"></a><span id="l89.1021"> }</span>
<a href="#l89.1022"></a><span id="l89.1022"> </span>
<a href="#l89.1023"></a><span id="l89.1023"> /**</span>
<a href="#l89.1024"></a><span id="l89.1024">  * Make sure all fields that may have calendar specific capabilities are updated</span>
<a href="#l89.1025"></a><span id="l89.1025">  */</span>
<a href="#l89.1026"></a><span id="l89.1026"> function updateCapabilities() {</span>
<a href="#l89.1027"></a><span id="l89.1027">     updateAttachment();</span>
<a href="#l89.1028"></a><span id="l89.1028">     updateConfigState({</span>
<a href="#l89.1029"></a><span id="l89.1029" class="difflineat">@@ -3782,23 +3782,23 @@ function updateCapabilities() {</span>
<a href="#l89.1030"></a><span id="l89.1030"> function isItemChanged() {</span>
<a href="#l89.1031"></a><span id="l89.1031">     let newItem = saveItem();</span>
<a href="#l89.1032"></a><span id="l89.1032">     let oldItem = window.calendarItem.clone();</span>
<a href="#l89.1033"></a><span id="l89.1033"> </span>
<a href="#l89.1034"></a><span id="l89.1034">     // we need to guide the description text through the text-field since</span>
<a href="#l89.1035"></a><span id="l89.1035">     // newlines are getting converted which would indicate changes to the</span>
<a href="#l89.1036"></a><span id="l89.1036">     // text.</span>
<a href="#l89.1037"></a><span id="l89.1037">     setElementValue(&quot;item-description&quot;, oldItem.getProperty(&quot;DESCRIPTION&quot;));</span>
<a href="#l89.1038"></a><span id="l89.1038" class="difflineminus">-    setItemProperty(oldItem,</span>
<a href="#l89.1039"></a><span id="l89.1039" class="difflineminus">-                    &quot;DESCRIPTION&quot;,</span>
<a href="#l89.1040"></a><span id="l89.1040" class="difflineminus">-                    getElementValue(&quot;item-description&quot;));</span>
<a href="#l89.1041"></a><span id="l89.1041" class="difflineplus">+    cal.setItemProperty(oldItem,</span>
<a href="#l89.1042"></a><span id="l89.1042" class="difflineplus">+                        &quot;DESCRIPTION&quot;,</span>
<a href="#l89.1043"></a><span id="l89.1043" class="difflineplus">+                        getElementValue(&quot;item-description&quot;));</span>
<a href="#l89.1044"></a><span id="l89.1044">     setElementValue(&quot;item-description&quot;, newItem.getProperty(&quot;DESCRIPTION&quot;));</span>
<a href="#l89.1045"></a><span id="l89.1045"> </span>
<a href="#l89.1046"></a><span id="l89.1046">     if ((newItem.calendar.id == oldItem.calendar.id) &amp;&amp;</span>
<a href="#l89.1047"></a><span id="l89.1047" class="difflineminus">-        compareItemContent(newItem, oldItem)) {</span>
<a href="#l89.1048"></a><span id="l89.1048" class="difflineplus">+        cal.compareItemContent(newItem, oldItem)) {</span>
<a href="#l89.1049"></a><span id="l89.1049">         return false;</span>
<a href="#l89.1050"></a><span id="l89.1050">     }</span>
<a href="#l89.1051"></a><span id="l89.1051">     return true;</span>
<a href="#l89.1052"></a><span id="l89.1052"> }</span>
<a href="#l89.1053"></a><span id="l89.1053"> </span>
<a href="#l89.1054"></a><span id="l89.1054"> /**</span>
<a href="#l89.1055"></a><span id="l89.1055">  * Test if a specific capability is supported</span>
<a href="#l89.1056"></a><span id="l89.1056">  *</span>
<a href="#l89.1057"></a><span id="l89.1057" class="difflineat">@@ -3994,17 +3994,17 @@ function lookupCounterLabel(aProperty) {</span>
<a href="#l89.1058"></a><span id="l89.1058">  */</span>
<a href="#l89.1059"></a><span id="l89.1059"> function formatCounterValue(aProperty) {</span>
<a href="#l89.1060"></a><span id="l89.1060">     const dateProps = [&quot;DTSTART&quot;, &quot;DTEND&quot;];</span>
<a href="#l89.1061"></a><span id="l89.1061">     const stringProps = [&quot;SUMMARY&quot;, &quot;LOCATION&quot;];</span>
<a href="#l89.1062"></a><span id="l89.1062"> </span>
<a href="#l89.1063"></a><span id="l89.1063">     let val;</span>
<a href="#l89.1064"></a><span id="l89.1064">     if (dateProps.includes(aProperty.property)) {</span>
<a href="#l89.1065"></a><span id="l89.1065">         let localTime = aProperty.proposed.getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l89.1066"></a><span id="l89.1066" class="difflineminus">-        let formatter = getDateFormatter();</span>
<a href="#l89.1067"></a><span id="l89.1067" class="difflineplus">+        let formatter = cal.getDateFormatter();</span>
<a href="#l89.1068"></a><span id="l89.1068">         val = formatter.formatDateTime(localTime);</span>
<a href="#l89.1069"></a><span id="l89.1069">         if (gTimezonesEnabled) {</span>
<a href="#l89.1070"></a><span id="l89.1070">             let tzone = localTime.timezone.displayName || localTime.timezone.tzid;</span>
<a href="#l89.1071"></a><span id="l89.1071">             val += &quot; &quot; + tzone;</span>
<a href="#l89.1072"></a><span id="l89.1072">         }</span>
<a href="#l89.1073"></a><span id="l89.1073">     } else if (stringProps.includes(aProperty.property)) {</span>
<a href="#l89.1074"></a><span id="l89.1074">         val = aProperty.proposed;</span>
<a href="#l89.1075"></a><span id="l89.1075">     } else {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l90.1"></a><span id="l90.1" class="difflineminus">--- a/calendar/lightning/content/lightning-item-iframe.xul</span>
<a href="#l90.2"></a><span id="l90.2" class="difflineplus">+++ b/calendar/lightning/content/lightning-item-iframe.xul</span>
<a href="#l90.3"></a><span id="l90.3" class="difflineat">@@ -38,18 +38,16 @@</span>
<a href="#l90.4"></a><span id="l90.4">   &lt;!-- Javascript includes --&gt;</span>
<a href="#l90.5"></a><span id="l90.5">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l90.6"></a><span id="l90.6">           src=&quot;chrome://lightning/content/lightning-item-iframe.js&quot;/&gt;</span>
<a href="#l90.7"></a><span id="l90.7">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l90.8"></a><span id="l90.8">           src=&quot;chrome://calendar/content/calendar-dialog-utils.js&quot;/&gt;</span>
<a href="#l90.9"></a><span id="l90.9">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l90.10"></a><span id="l90.10">           src=&quot;chrome://calendar/content/calendar-ui-utils.js&quot;/&gt;</span>
<a href="#l90.11"></a><span id="l90.11">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l90.12"></a><span id="l90.12" class="difflineminus">-          src=&quot;chrome://calendar/content/calUtils.js&quot;/&gt;</span>
<a href="#l90.13"></a><span id="l90.13" class="difflineminus">-  &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l90.14"></a><span id="l90.14">           src=&quot;chrome://calendar/content/calApplicationUtils.js&quot;/&gt;</span>
<a href="#l90.15"></a><span id="l90.15">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l90.16"></a><span id="l90.16">           src=&quot;chrome://global/content/globalOverlay.js&quot;/&gt;</span>
<a href="#l90.17"></a><span id="l90.17">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l90.18"></a><span id="l90.18">           src=&quot;chrome://global/content/printUtils.js&quot;/&gt;</span>
<a href="#l90.19"></a><span id="l90.19">   &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l90.20"></a><span id="l90.20">           src=&quot;chrome://calendar/content/calendar-statusbar.js&quot;/&gt;</span>
<a href="#l90.21"></a><span id="l90.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l91.1"></a><span id="l91.1" class="difflineminus">--- a/calendar/lightning/content/messenger-overlay-accountCentral.xul</span>
<a href="#l91.2"></a><span id="l91.2" class="difflineplus">+++ b/calendar/lightning/content/messenger-overlay-accountCentral.xul</span>
<a href="#l91.3"></a><span id="l91.3" class="difflineat">@@ -19,13 +19,13 @@</span>
<a href="#l91.4"></a><span id="l91.4">             flex=&quot;1&quot;</span>
<a href="#l91.5"></a><span id="l91.5">             insertbefore=&quot;AccountsSection.spacer&quot;/&gt;</span>
<a href="#l91.6"></a><span id="l91.6">     &lt;row id=&quot;lightning-newCalendar-row&quot;</span>
<a href="#l91.7"></a><span id="l91.7">          class=&quot;acctCentralRow&quot;</span>
<a href="#l91.8"></a><span id="l91.8">          insertbefore=&quot;AccountsSection.spacer&quot;&gt;</span>
<a href="#l91.9"></a><span id="l91.9">       &lt;hbox&gt;</span>
<a href="#l91.10"></a><span id="l91.10">         &lt;label class=&quot;acctCentralText acctCentralLinkText&quot;</span>
<a href="#l91.11"></a><span id="l91.11">                value=&quot;&amp;lightning.acctCentral.newCalendar.label;&quot;</span>
<a href="#l91.12"></a><span id="l91.12" class="difflineminus">-               onclick=&quot;window.parent.openCalendarWizard();&quot;/&gt;</span>
<a href="#l91.13"></a><span id="l91.13" class="difflineplus">+               onclick=&quot;window.parent.cal.openCalendarWizard(window);&quot;/&gt;</span>
<a href="#l91.14"></a><span id="l91.14">       &lt;/hbox&gt;</span>
<a href="#l91.15"></a><span id="l91.15">     &lt;/row&gt;</span>
<a href="#l91.16"></a><span id="l91.16">   &lt;/rows&gt;</span>
<a href="#l91.17"></a><span id="l91.17"> &lt;/overlay&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l92.1"></a><span id="l92.1" class="difflineminus">--- a/calendar/lightning/content/messenger-overlay-preferences.xul</span>
<a href="#l92.2"></a><span id="l92.2" class="difflineplus">+++ b/calendar/lightning/content/messenger-overlay-preferences.xul</span>
<a href="#l92.3"></a><span id="l92.3" class="difflineat">@@ -53,15 +53,13 @@</span>
<a href="#l92.4"></a><span id="l92.4">                     &lt;tabpanel orient=&quot;vertical&quot;&gt;</span>
<a href="#l92.5"></a><span id="l92.5">                         &lt;vbox id=&quot;calPreferencesBoxViews&quot;/&gt;</span>
<a href="#l92.6"></a><span id="l92.6">                     &lt;/tabpanel&gt;</span>
<a href="#l92.7"></a><span id="l92.7">                 &lt;/tabpanels&gt;</span>
<a href="#l92.8"></a><span id="l92.8">             &lt;/tabbox&gt;</span>
<a href="#l92.9"></a><span id="l92.9">         &lt;/prefpane&gt;</span>
<a href="#l92.10"></a><span id="l92.10"> </span>
<a href="#l92.11"></a><span id="l92.11">         &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l92.12"></a><span id="l92.12" class="difflineminus">-                src=&quot;chrome://calendar/content/calUtils.js&quot;/&gt;</span>
<a href="#l92.13"></a><span id="l92.13" class="difflineminus">-        &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l92.14"></a><span id="l92.14">                 src=&quot;chrome://lightning/content/messenger-overlay-preferences.js&quot;/&gt;</span>
<a href="#l92.15"></a><span id="l92.15"> </span>
<a href="#l92.16"></a><span id="l92.16">     &lt;/prefwindow&gt;</span>
<a href="#l92.17"></a><span id="l92.17"> </span>
<a href="#l92.18"></a><span id="l92.18"> &lt;/overlay&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l93.1"></a><span id="l93.1" class="difflineminus">--- a/calendar/lightning/content/messenger-overlay-sidebar.js</span>
<a href="#l93.2"></a><span id="l93.2" class="difflineplus">+++ b/calendar/lightning/content/messenger-overlay-sidebar.js</span>
<a href="#l93.3"></a><span id="l93.3" class="difflineat">@@ -8,16 +8,17 @@</span>
<a href="#l93.4"></a><span id="l93.4">  *          customizeMailToolbarForTabType</span>
<a href="#l93.5"></a><span id="l93.5">  */</span>
<a href="#l93.6"></a><span id="l93.6"> </span>
<a href="#l93.7"></a><span id="l93.7"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l93.8"></a><span id="l93.8"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l93.9"></a><span id="l93.9"> Components.utils.import(&quot;resource://gre/modules/Promise.jsm&quot;);</span>
<a href="#l93.10"></a><span id="l93.10"> Components.utils.import(&quot;resource://gre/modules/Task.jsm&quot;);</span>
<a href="#l93.11"></a><span id="l93.11"> Components.utils.import(&quot;resource://gre/modules/AddonManager.jsm&quot;);</span>
<a href="#l93.12"></a><span id="l93.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l93.13"></a><span id="l93.13"> Components.utils.import(&quot;resource://calendar/modules/calAsyncUtils.jsm&quot;);</span>
<a href="#l93.14"></a><span id="l93.14"> </span>
<a href="#l93.15"></a><span id="l93.15"> var gLastShownCalendarView = null;</span>
<a href="#l93.16"></a><span id="l93.16"> </span>
<a href="#l93.17"></a><span id="l93.17"> var calendarTabMonitor = {</span>
<a href="#l93.18"></a><span id="l93.18">     monitorName: &quot;lightning&quot;,</span>
<a href="#l93.19"></a><span id="l93.19"> </span>
<a href="#l93.20"></a><span id="l93.20">     // Unused, but needed functions</span>
<a href="#l93.21"></a><span id="l93.21" class="difflineat">@@ -328,21 +329,21 @@ var calendarItemTabType = {</span>
<a href="#l93.22"></a><span id="l93.22">      * @param {Object} aTabmail  The tabmail interface</span>
<a href="#l93.23"></a><span id="l93.23">      * @param {Object} aState    The state of the tab to restore</span>
<a href="#l93.24"></a><span id="l93.24">      */</span>
<a href="#l93.25"></a><span id="l93.25">     restoreTab: function(aTabmail, aState) {</span>
<a href="#l93.26"></a><span id="l93.26">         // Sometimes restoreTab is called for tabs that were never saved</span>
<a href="#l93.27"></a><span id="l93.27">         // and never meant to be persisted or restored. See persistTab.</span>
<a href="#l93.28"></a><span id="l93.28">         if (aState.args &amp;&amp; aState.calendarId &amp;&amp; aState.itemId) {</span>
<a href="#l93.29"></a><span id="l93.29">             aState.args.initialStartDateValue = aState.initialStartDate</span>
<a href="#l93.30"></a><span id="l93.30" class="difflineminus">-                ? cal.createDateTime(aState.initialStartDate) : getDefaultStartDate();</span>
<a href="#l93.31"></a><span id="l93.31" class="difflineplus">+                ? cal.createDateTime(aState.initialStartDate) : cal.getDefaultStartDate();</span>
<a href="#l93.32"></a><span id="l93.32"> </span>
<a href="#l93.33"></a><span id="l93.33">             aState.args.onOk = doTransaction.bind(null, &quot;modify&quot;);</span>
<a href="#l93.34"></a><span id="l93.34"> </span>
<a href="#l93.35"></a><span id="l93.35" class="difflineminus">-            aState.args.calendar = getCalendarManager().getCalendarById(aState.calendarId);</span>
<a href="#l93.36"></a><span id="l93.36" class="difflineplus">+            aState.args.calendar = cal.getCalendarManager().getCalendarById(aState.calendarId);</span>
<a href="#l93.37"></a><span id="l93.37">             if (aState.args.calendar) {</span>
<a href="#l93.38"></a><span id="l93.38">                 // using wrappedJSObject is a hack that is needed to prevent a proxy error</span>
<a href="#l93.39"></a><span id="l93.39">                 let pcal = cal.async.promisifyCalendar(aState.args.calendar.wrappedJSObject);</span>
<a href="#l93.40"></a><span id="l93.40">                 pcal.getItem(aState.itemId).then((item) =&gt; {</span>
<a href="#l93.41"></a><span id="l93.41">                     if (item[0]) {</span>
<a href="#l93.42"></a><span id="l93.42">                         aState.args.calendarEvent = item[0];</span>
<a href="#l93.43"></a><span id="l93.43">                         aTabmail.openTab(aState.tabType, aState.args);</span>
<a href="#l93.44"></a><span id="l93.44">                     }</span>
<a href="#l93.45"></a><span id="l93.45" class="difflineat">@@ -370,17 +371,17 @@ function ltnOnLoad(event) {</span>
<a href="#l93.46"></a><span id="l93.46">     // Take care of common initialization</span>
<a href="#l93.47"></a><span id="l93.47">     commonInitCalendar();</span>
<a href="#l93.48"></a><span id="l93.48"> </span>
<a href="#l93.49"></a><span id="l93.49">     // Add an unload function to the window so we don't leak any listeners</span>
<a href="#l93.50"></a><span id="l93.50">     window.addEventListener(&quot;unload&quot;, ltnFinish, false);</span>
<a href="#l93.51"></a><span id="l93.51"> </span>
<a href="#l93.52"></a><span id="l93.52">     // Set up invitations manager</span>
<a href="#l93.53"></a><span id="l93.53">     scheduleInvitationsUpdate(FIRST_DELAY_STARTUP);</span>
<a href="#l93.54"></a><span id="l93.54" class="difflineminus">-    getCalendarManager().addObserver(gInvitationsCalendarManagerObserver);</span>
<a href="#l93.55"></a><span id="l93.55" class="difflineplus">+    cal.getCalendarManager().addObserver(gInvitationsCalendarManagerObserver);</span>
<a href="#l93.56"></a><span id="l93.56"> </span>
<a href="#l93.57"></a><span id="l93.57">     let filter = document.getElementById(&quot;task-tree-filtergroup&quot;);</span>
<a href="#l93.58"></a><span id="l93.58">     filter.value = filter.value || &quot;all&quot;;</span>
<a href="#l93.59"></a><span id="l93.59">     document.getElementById(&quot;modeBroadcaster&quot;).setAttribute(&quot;mode&quot;, gCurrentMode);</span>
<a href="#l93.60"></a><span id="l93.60">     document.getElementById(&quot;modeBroadcaster&quot;).setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l93.61"></a><span id="l93.61"> </span>
<a href="#l93.62"></a><span id="l93.62">     let mailContextPopup = document.getElementById(&quot;mailContext&quot;);</span>
<a href="#l93.63"></a><span id="l93.63">     if (mailContextPopup) {</span>
<a href="#l93.64"></a><span id="l93.64" class="difflineat">@@ -548,26 +549,26 @@ function refreshUIBits() {</span>
<a href="#l93.65"></a><span id="l93.65">          &quot;multiweek-view&quot;,</span>
<a href="#l93.66"></a><span id="l93.66">          &quot;month-view&quot;].forEach((view) =&gt; {</span>
<a href="#l93.67"></a><span id="l93.67">              if (view != currView.id) {</span>
<a href="#l93.68"></a><span id="l93.68">                  document.getElementById(view).mToggleStatus = -1;</span>
<a href="#l93.69"></a><span id="l93.69">              }</span>
<a href="#l93.70"></a><span id="l93.70">          });</span>
<a href="#l93.71"></a><span id="l93.71"> </span>
<a href="#l93.72"></a><span id="l93.72">         if (!TodayPane.showsToday()) {</span>
<a href="#l93.73"></a><span id="l93.73" class="difflineminus">-            TodayPane.setDay(now());</span>
<a href="#l93.74"></a><span id="l93.74" class="difflineplus">+            TodayPane.setDay(cal.now());</span>
<a href="#l93.75"></a><span id="l93.75">         }</span>
<a href="#l93.76"></a><span id="l93.76"> </span>
<a href="#l93.77"></a><span id="l93.77">         // update the unifinder</span>
<a href="#l93.78"></a><span id="l93.78">         refreshEventTree();</span>
<a href="#l93.79"></a><span id="l93.79"> </span>
<a href="#l93.80"></a><span id="l93.80">         // update today's date on todaypane button</span>
<a href="#l93.81"></a><span id="l93.81">         document.getElementById(&quot;calendar-status-todaypane-button&quot;).setUpTodayDate();</span>
<a href="#l93.82"></a><span id="l93.82">     } catch (exc) {</span>
<a href="#l93.83"></a><span id="l93.83" class="difflineminus">-        ASSERT(false, exc);</span>
<a href="#l93.84"></a><span id="l93.84" class="difflineplus">+        cal.ASSERT(false, exc);</span>
<a href="#l93.85"></a><span id="l93.85">     }</span>
<a href="#l93.86"></a><span id="l93.86"> </span>
<a href="#l93.87"></a><span id="l93.87">     // schedule our next update...</span>
<a href="#l93.88"></a><span id="l93.88">     scheduleMidnightUpdate(refreshUIBits);</span>
<a href="#l93.89"></a><span id="l93.89"> }</span>
<a href="#l93.90"></a><span id="l93.90"> </span>
<a href="#l93.91"></a><span id="l93.91"> /**</span>
<a href="#l93.92"></a><span id="l93.92">  * Switch the calendar view, and optionally switch to calendar mode.</span>
<a href="#l93.93"></a><span id="l93.93" class="difflineat">@@ -620,17 +621,17 @@ function LtnObserveDisplayDeckChange(eve</span>
<a href="#l93.94"></a><span id="l93.94">     if (gCurrentMode != &quot;mail&quot;) {</span>
<a href="#l93.95"></a><span id="l93.95">         if (id != &quot;calendar-view-box&quot; &amp;&amp; id != &quot;calendar-task-box&quot;) {</span>
<a href="#l93.96"></a><span id="l93.96">             ltnSwitch2Mail();</span>
<a href="#l93.97"></a><span id="l93.97">         }</span>
<a href="#l93.98"></a><span id="l93.98">     }</span>
<a href="#l93.99"></a><span id="l93.99"> }</span>
<a href="#l93.100"></a><span id="l93.100"> </span>
<a href="#l93.101"></a><span id="l93.101"> function ltnFinish() {</span>
<a href="#l93.102"></a><span id="l93.102" class="difflineminus">-    getCalendarManager().removeObserver(gInvitationsCalendarManagerObserver);</span>
<a href="#l93.103"></a><span id="l93.103" class="difflineplus">+    cal.getCalendarManager().removeObserver(gInvitationsCalendarManagerObserver);</span>
<a href="#l93.104"></a><span id="l93.104"> </span>
<a href="#l93.105"></a><span id="l93.105">     // Remove listener for mailContext.</span>
<a href="#l93.106"></a><span id="l93.106">     let mailContextPopup = document.getElementById(&quot;mailContext&quot;);</span>
<a href="#l93.107"></a><span id="l93.107">     if (mailContextPopup) {</span>
<a href="#l93.108"></a><span id="l93.108">         mailContextPopup.removeEventListener(&quot;popupshowing&quot;,</span>
<a href="#l93.109"></a><span id="l93.109">                                              gCalSetupMailContext.popup, false);</span>
<a href="#l93.110"></a><span id="l93.110">     }</span>
<a href="#l93.111"></a><span id="l93.111"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l94.1"></a><span id="l94.1" class="difflineminus">--- a/calendar/lightning/content/messenger-overlay-sidebar.xul</span>
<a href="#l94.2"></a><span id="l94.2" class="difflineplus">+++ b/calendar/lightning/content/messenger-overlay-sidebar.xul</span>
<a href="#l94.3"></a><span id="l94.3" class="difflineat">@@ -42,17 +42,16 @@</span>
<a href="#l94.4"></a><span id="l94.4">   &lt;!-- NEEDED FOR IMPORT / EXPORT SUPPORT --&gt;</span>
<a href="#l94.5"></a><span id="l94.5">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/import-export.js&quot;/&gt;</span>
<a href="#l94.6"></a><span id="l94.6"> </span>
<a href="#l94.7"></a><span id="l94.7">   &lt;!-- NEEDED FOR PUBLICATION SUPPORT --&gt;</span>
<a href="#l94.8"></a><span id="l94.8">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/publish.js&quot;/&gt;</span>
<a href="#l94.9"></a><span id="l94.9"> </span>
<a href="#l94.10"></a><span id="l94.10">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calendar-item-editing.js&quot;/&gt;</span>
<a href="#l94.11"></a><span id="l94.11">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calendar-chrome-startup.js&quot;/&gt;</span>
<a href="#l94.12"></a><span id="l94.12" class="difflineminus">-  &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calUtils.js&quot;/&gt;</span>
<a href="#l94.13"></a><span id="l94.13">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/mouseoverPreviews.js&quot;/&gt;</span>
<a href="#l94.14"></a><span id="l94.14">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calendar-views.js&quot;/&gt;</span>
<a href="#l94.15"></a><span id="l94.15">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calendar-ui-utils.js&quot;/&gt;</span>
<a href="#l94.16"></a><span id="l94.16">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calendar-creation.js&quot;/&gt;</span>
<a href="#l94.17"></a><span id="l94.17">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calendar-dnd-listener.js&quot;/&gt;</span>
<a href="#l94.18"></a><span id="l94.18">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calendar-statusbar.js&quot;/&gt;</span>
<a href="#l94.19"></a><span id="l94.19">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://global/content/nsDragAndDrop.js&quot;/&gt;</span>
<a href="#l94.20"></a><span id="l94.20"> </span>
<a href="#l94.21"></a><span id="l94.21" class="difflineat">@@ -79,17 +78,17 @@</span>
<a href="#l94.22"></a><span id="l94.22">       &lt;command id=&quot;switch2task&quot;</span>
<a href="#l94.23"></a><span id="l94.23">                oncommand=&quot;document.getElementById('tabmail').openTab('tasks', { title: document.getElementById('task-tab-button').getAttribute('title') })&quot;/&gt;</span>
<a href="#l94.24"></a><span id="l94.24">       &lt;command id=&quot;new_calendar_tab&quot;</span>
<a href="#l94.25"></a><span id="l94.25">                oncommand=&quot;document.getElementById('tabmail').openTab('calendar', { title: document.getElementById('calendar-tab-button').getAttribute('title') })&quot;/&gt;</span>
<a href="#l94.26"></a><span id="l94.26">       &lt;command id=&quot;new_task_tab&quot;</span>
<a href="#l94.27"></a><span id="l94.27">                oncommand=&quot;document.getElementById('tabmail').openTab('tasks', { title: document.getElementById('task-tab-button').getAttribute('title') })&quot;/&gt;</span>
<a href="#l94.28"></a><span id="l94.28">       &lt;command id=&quot;calendar_go_to_today_command&quot;</span>
<a href="#l94.29"></a><span id="l94.29">                observes=&quot;calendar_mode_calendar&quot;</span>
<a href="#l94.30"></a><span id="l94.30" class="difflineminus">-               oncommand=&quot;document.getElementById('tabmail').openTab('calendar', { title: document.getElementById('calendar-tab-button').getAttribute('title') }); goToDate(now())&quot;/&gt;</span>
<a href="#l94.31"></a><span id="l94.31" class="difflineplus">+               oncommand=&quot;document.getElementById('tabmail').openTab('calendar', { title: document.getElementById('calendar-tab-button').getAttribute('title') }); goToDate(cal.now())&quot;/&gt;</span>
<a href="#l94.32"></a><span id="l94.32">     &lt;/commandset&gt;</span>
<a href="#l94.33"></a><span id="l94.33"> </span>
<a href="#l94.34"></a><span id="l94.34">     &lt;commandset id=&quot;mailCommands&quot;&gt;</span>
<a href="#l94.35"></a><span id="l94.35">       &lt;command id=&quot;cmd_CustomizeMailToolbar&quot;</span>
<a href="#l94.36"></a><span id="l94.36">                oncommand=&quot;customizeMailToolbarForTabType()&quot;/&gt;</span>
<a href="#l94.37"></a><span id="l94.37">     &lt;/commandset&gt;</span>
<a href="#l94.38"></a><span id="l94.38"> </span>
<a href="#l94.39"></a><span id="l94.39">     &lt;keyset id=&quot;calendar-keys&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l95.1"></a><span id="l95.1" class="difflineminus">--- a/calendar/lightning/content/suite-overlay-preferences.xul</span>
<a href="#l95.2"></a><span id="l95.2" class="difflineplus">+++ b/calendar/lightning/content/suite-overlay-preferences.xul</span>
<a href="#l95.3"></a><span id="l95.3" class="difflineat">@@ -58,11 +58,9 @@</span>
<a href="#l95.4"></a><span id="l95.4">         &lt;/prefpane&gt;</span>
<a href="#l95.5"></a><span id="l95.5">         &lt;prefpane id=&quot;paneLightningViews&quot;</span>
<a href="#l95.6"></a><span id="l95.6">                   label=&quot;&amp;paneViews.title;&quot;</span>
<a href="#l95.7"></a><span id="l95.7">                   onpaneload=&quot;gViewsPane.init();&quot;&gt;</span>
<a href="#l95.8"></a><span id="l95.8">             &lt;vbox id=&quot;calPreferencesBoxViews&quot;/&gt;</span>
<a href="#l95.9"></a><span id="l95.9">         &lt;/prefpane&gt;</span>
<a href="#l95.10"></a><span id="l95.10">     &lt;/prefwindow&gt;</span>
<a href="#l95.11"></a><span id="l95.11"> </span>
<a href="#l95.12"></a><span id="l95.12" class="difflineminus">-    &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l95.13"></a><span id="l95.13" class="difflineminus">-            src=&quot;chrome://calendar/content/calUtils.js&quot;/&gt;</span>
<a href="#l95.14"></a><span id="l95.14"> &lt;/overlay&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l96.1"></a><span id="l96.1" class="difflineminus">--- a/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l96.2"></a><span id="l96.2" class="difflineplus">+++ b/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l96.3"></a><span id="l96.3" class="difflineat">@@ -152,17 +152,17 @@ calDavCalendar.prototype = {</span>
<a href="#l96.4"></a><span id="l96.4">     //</span>
<a href="#l96.5"></a><span id="l96.5">     // calICalendarProvider interface</span>
<a href="#l96.6"></a><span id="l96.6">     //</span>
<a href="#l96.7"></a><span id="l96.7">     get prefChromeOverlay() {</span>
<a href="#l96.8"></a><span id="l96.8">         return null;</span>
<a href="#l96.9"></a><span id="l96.9">     },</span>
<a href="#l96.10"></a><span id="l96.10"> </span>
<a href="#l96.11"></a><span id="l96.11">     get displayName() {</span>
<a href="#l96.12"></a><span id="l96.12" class="difflineminus">-        return calGetString(&quot;calendar&quot;, &quot;caldavName&quot;);</span>
<a href="#l96.13"></a><span id="l96.13" class="difflineplus">+        return cal.calGetString(&quot;calendar&quot;, &quot;caldavName&quot;);</span>
<a href="#l96.14"></a><span id="l96.14">     },</span>
<a href="#l96.15"></a><span id="l96.15"> </span>
<a href="#l96.16"></a><span id="l96.16">     createCalendar: function() {</span>
<a href="#l96.17"></a><span id="l96.17">         throw NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l96.18"></a><span id="l96.18">     },</span>
<a href="#l96.19"></a><span id="l96.19"> </span>
<a href="#l96.20"></a><span id="l96.20">     deleteCalendar: function(cal, listener) {</span>
<a href="#l96.21"></a><span id="l96.21">         throw NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l96.22"></a><span id="l96.22" class="difflineat">@@ -635,17 +635,17 @@ calDavCalendar.prototype = {</span>
<a href="#l96.23"></a><span id="l96.23">         }</span>
<a href="#l96.24"></a><span id="l96.24"> </span>
<a href="#l96.25"></a><span id="l96.25">         if (aItem.id == null) {</span>
<a href="#l96.26"></a><span id="l96.26">             notifyListener(Components.results.NS_ERROR_FAILURE,</span>
<a href="#l96.27"></a><span id="l96.27">                            &quot;Can't set ID on non-mutable item to addItem&quot;);</span>
<a href="#l96.28"></a><span id="l96.28">             return;</span>
<a href="#l96.29"></a><span id="l96.29">         }</span>
<a href="#l96.30"></a><span id="l96.30"> </span>
<a href="#l96.31"></a><span id="l96.31" class="difflineminus">-        if (!isItemSupported(aItem, this)) {</span>
<a href="#l96.32"></a><span id="l96.32" class="difflineplus">+        if (!cal.isItemSupported(aItem, this)) {</span>
<a href="#l96.33"></a><span id="l96.33">             notifyListener(Components.results.NS_ERROR_FAILURE,</span>
<a href="#l96.34"></a><span id="l96.34">                            &quot;Server does not support item type&quot;);</span>
<a href="#l96.35"></a><span id="l96.35">             return;</span>
<a href="#l96.36"></a><span id="l96.36">         }</span>
<a href="#l96.37"></a><span id="l96.37"> </span>
<a href="#l96.38"></a><span id="l96.38">         let parentItem = aItem.parentItem;</span>
<a href="#l96.39"></a><span id="l96.39">         parentItem.calendar = this.superCalendar;</span>
<a href="#l96.40"></a><span id="l96.40"> </span>
<a href="#l96.41"></a><span id="l96.41" class="difflineat">@@ -1330,17 +1330,17 @@ calDavCalendar.prototype = {</span>
<a href="#l96.42"></a><span id="l96.42">             }</span>
<a href="#l96.43"></a><span id="l96.43">         };</span>
<a href="#l96.44"></a><span id="l96.44"> </span>
<a href="#l96.45"></a><span id="l96.45">         if (!this.mACLEntry) {</span>
<a href="#l96.46"></a><span id="l96.46">             let self = this;</span>
<a href="#l96.47"></a><span id="l96.47">             let opListener = {</span>
<a href="#l96.48"></a><span id="l96.48">                 QueryInterface: XPCOMUtils.generateQI([Components.interfaces.calIOperationListener]),</span>
<a href="#l96.49"></a><span id="l96.49">                 onGetResult: function(calendar, status, itemType, detail, count, items) {</span>
<a href="#l96.50"></a><span id="l96.50" class="difflineminus">-                    ASSERT(false, &quot;unexpected!&quot;);</span>
<a href="#l96.51"></a><span id="l96.51" class="difflineplus">+                    cal.ASSERT(false, &quot;unexpected!&quot;);</span>
<a href="#l96.52"></a><span id="l96.52">                 },</span>
<a href="#l96.53"></a><span id="l96.53">                 onOperationComplete: function(opCalendar, opStatus, opType, opId, opDetail) {</span>
<a href="#l96.54"></a><span id="l96.54">                     self.mACLEntry = opDetail;</span>
<a href="#l96.55"></a><span id="l96.55">                     self.fillACLProperties();</span>
<a href="#l96.56"></a><span id="l96.56">                     self.safeRefresh(aChangeLogListener);</span>
<a href="#l96.57"></a><span id="l96.57">                 }</span>
<a href="#l96.58"></a><span id="l96.58">             };</span>
<a href="#l96.59"></a><span id="l96.59"> </span>
<a href="#l96.60"></a><span id="l96.60" class="difflineat">@@ -1468,17 +1468,17 @@ calDavCalendar.prototype = {</span>
<a href="#l96.61"></a><span id="l96.61">         });</span>
<a href="#l96.62"></a><span id="l96.62">     },</span>
<a href="#l96.63"></a><span id="l96.63"> </span>
<a href="#l96.64"></a><span id="l96.64">     refresh: function() {</span>
<a href="#l96.65"></a><span id="l96.65">         this.replayChangesOn(null);</span>
<a href="#l96.66"></a><span id="l96.66">     },</span>
<a href="#l96.67"></a><span id="l96.67"> </span>
<a href="#l96.68"></a><span id="l96.68">     firstInRealm: function() {</span>
<a href="#l96.69"></a><span id="l96.69" class="difflineminus">-        let calendars = getCalendarManager().getCalendars({});</span>
<a href="#l96.70"></a><span id="l96.70" class="difflineplus">+        let calendars = cal.getCalendarManager().getCalendars({});</span>
<a href="#l96.71"></a><span id="l96.71">         for (let i = 0; i &lt; calendars.length; i++) {</span>
<a href="#l96.72"></a><span id="l96.72">             if (calendars[i].type != &quot;caldav&quot; || calendars[i].getProperty(&quot;disabled&quot;)) {</span>
<a href="#l96.73"></a><span id="l96.73">                 continue;</span>
<a href="#l96.74"></a><span id="l96.74">             }</span>
<a href="#l96.75"></a><span id="l96.75">             // XXX We should probably expose the inner calendar via an</span>
<a href="#l96.76"></a><span id="l96.76">             // interface, but for now use wrappedJSObject.</span>
<a href="#l96.77"></a><span id="l96.77">             let calendar = calendars[i].wrappedJSObject;</span>
<a href="#l96.78"></a><span id="l96.78">             if (calendar.mUncachedCalendar) {</span>
<a href="#l96.79"></a><span id="l96.79" class="difflineat">@@ -1993,17 +1993,17 @@ calDavCalendar.prototype = {</span>
<a href="#l96.80"></a><span id="l96.80">                 // XXX - we really shouldn't register with the fb service</span>
<a href="#l96.81"></a><span id="l96.81">                 // if another calendar with the same principal-URL has already</span>
<a href="#l96.82"></a><span id="l96.82">                 // done so. We also shouldn't register with the fb service if we</span>
<a href="#l96.83"></a><span id="l96.83">                 // don't have an outbox.</span>
<a href="#l96.84"></a><span id="l96.84">                 if (!self.hasFreeBusy) {</span>
<a href="#l96.85"></a><span id="l96.85">                     // This may have already been set by fetchCachedMetaData,</span>
<a href="#l96.86"></a><span id="l96.86">                     // we only want to add the freebusy provider once.</span>
<a href="#l96.87"></a><span id="l96.87">                     self.hasFreeBusy = true;</span>
<a href="#l96.88"></a><span id="l96.88" class="difflineminus">-                    getFreeBusyService().addProvider(self);</span>
<a href="#l96.89"></a><span id="l96.89" class="difflineplus">+                    cal.getFreeBusyService().addProvider(self);</span>
<a href="#l96.90"></a><span id="l96.90">                 }</span>
<a href="#l96.91"></a><span id="l96.91">                 self.findPrincipalNS(aChangeLogListener);</span>
<a href="#l96.92"></a><span id="l96.92">             } else {</span>
<a href="#l96.93"></a><span id="l96.93">                 cal.LOG(&quot;CalDAV: Server does not support CalDAV scheduling.&quot;);</span>
<a href="#l96.94"></a><span id="l96.94">                 self.completeCheckServerInfo(aChangeLogListener);</span>
<a href="#l96.95"></a><span id="l96.95">             }</span>
<a href="#l96.96"></a><span id="l96.96">         };</span>
<a href="#l96.97"></a><span id="l96.97"> </span>
<a href="#l96.98"></a><span id="l96.98" class="difflineat">@@ -2163,17 +2163,17 @@ calDavCalendar.prototype = {</span>
<a href="#l96.99"></a><span id="l96.99">                     &quot;&lt;/D:prop&gt;&quot; +</span>
<a href="#l96.100"></a><span id="l96.100">                 &quot;&lt;/D:principal-property-search&gt;&quot;;</span>
<a href="#l96.101"></a><span id="l96.101">             queryMethod = &quot;REPORT&quot;;</span>
<a href="#l96.102"></a><span id="l96.102">             queryDepth = 1;</span>
<a href="#l96.103"></a><span id="l96.103">         }</span>
<a href="#l96.104"></a><span id="l96.104"> </span>
<a href="#l96.105"></a><span id="l96.105">         // We want a trailing slash, ensure it.</span>
<a href="#l96.106"></a><span id="l96.106">         let nextNS = aNameSpaceList.pop().replace(/([^\/])$/, &quot;$1/&quot;);</span>
<a href="#l96.107"></a><span id="l96.107" class="difflineminus">-        let requestUri = makeURL(this.calendarUri.prePath + this.ensureEncodedPath(nextNS));</span>
<a href="#l96.108"></a><span id="l96.108" class="difflineplus">+        let requestUri = cal.makeURL(this.calendarUri.prePath + this.ensureEncodedPath(nextNS));</span>
<a href="#l96.109"></a><span id="l96.109"> </span>
<a href="#l96.110"></a><span id="l96.110">         if (this.verboseLogging()) {</span>
<a href="#l96.111"></a><span id="l96.111">             cal.LOG(&quot;CalDAV: send: &quot; + queryMethod + &quot; &quot; + requestUri.spec + &quot;\n&quot; + queryXml);</span>
<a href="#l96.112"></a><span id="l96.112">         }</span>
<a href="#l96.113"></a><span id="l96.113"> </span>
<a href="#l96.114"></a><span id="l96.114">         let streamListener = {};</span>
<a href="#l96.115"></a><span id="l96.115">         streamListener.onStreamComplete = function(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l96.116"></a><span id="l96.116">             let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l96.117"></a><span id="l96.117" class="difflineat">@@ -2412,30 +2412,30 @@ calDavCalendar.prototype = {</span>
<a href="#l96.118"></a><span id="l96.118">             return;</span>
<a href="#l96.119"></a><span id="l96.119">         }</span>
<a href="#l96.120"></a><span id="l96.120">         let mailto_aCalId = aCalIdParts.join(&quot;:&quot;);</span>
<a href="#l96.121"></a><span id="l96.121"> </span>
<a href="#l96.122"></a><span id="l96.122">         let self = this;</span>
<a href="#l96.123"></a><span id="l96.123"> </span>
<a href="#l96.124"></a><span id="l96.124">         let organizer = this.calendarUserAddress;</span>
<a href="#l96.125"></a><span id="l96.125"> </span>
<a href="#l96.126"></a><span id="l96.126" class="difflineminus">-        let fbQuery = getIcsService().createIcalComponent(&quot;VCALENDAR&quot;);</span>
<a href="#l96.127"></a><span id="l96.127" class="difflineminus">-        calSetProdidVersion(fbQuery);</span>
<a href="#l96.128"></a><span id="l96.128" class="difflineminus">-        let prop = getIcsService().createIcalProperty(&quot;METHOD&quot;);</span>
<a href="#l96.129"></a><span id="l96.129" class="difflineplus">+        let fbQuery = cal.getIcsService().createIcalComponent(&quot;VCALENDAR&quot;);</span>
<a href="#l96.130"></a><span id="l96.130" class="difflineplus">+        cal.calSetProdidVersion(fbQuery);</span>
<a href="#l96.131"></a><span id="l96.131" class="difflineplus">+        let prop = cal.getIcsService().createIcalProperty(&quot;METHOD&quot;);</span>
<a href="#l96.132"></a><span id="l96.132">         prop.value = &quot;REQUEST&quot;;</span>
<a href="#l96.133"></a><span id="l96.133">         fbQuery.addProperty(prop);</span>
<a href="#l96.134"></a><span id="l96.134" class="difflineminus">-        let fbComp = getIcsService().createIcalComponent(&quot;VFREEBUSY&quot;);</span>
<a href="#l96.135"></a><span id="l96.135" class="difflineminus">-        fbComp.stampTime = now().getInTimezone(UTC());</span>
<a href="#l96.136"></a><span id="l96.136" class="difflineminus">-        prop = getIcsService().createIcalProperty(&quot;ORGANIZER&quot;);</span>
<a href="#l96.137"></a><span id="l96.137" class="difflineplus">+        let fbComp = cal.getIcsService().createIcalComponent(&quot;VFREEBUSY&quot;);</span>
<a href="#l96.138"></a><span id="l96.138" class="difflineplus">+        fbComp.stampTime = cal.now().getInTimezone(cal.UTC());</span>
<a href="#l96.139"></a><span id="l96.139" class="difflineplus">+        prop = cal.getIcsService().createIcalProperty(&quot;ORGANIZER&quot;);</span>
<a href="#l96.140"></a><span id="l96.140">         prop.value = organizer;</span>
<a href="#l96.141"></a><span id="l96.141">         fbComp.addProperty(prop);</span>
<a href="#l96.142"></a><span id="l96.142" class="difflineminus">-        fbComp.startTime = aRangeStart.getInTimezone(UTC());</span>
<a href="#l96.143"></a><span id="l96.143" class="difflineminus">-        fbComp.endTime = aRangeEnd.getInTimezone(UTC());</span>
<a href="#l96.144"></a><span id="l96.144" class="difflineplus">+        fbComp.startTime = aRangeStart.getInTimezone(cal.UTC());</span>
<a href="#l96.145"></a><span id="l96.145" class="difflineplus">+        fbComp.endTime = aRangeEnd.getInTimezone(cal.UTC());</span>
<a href="#l96.146"></a><span id="l96.146">         fbComp.uid = cal.getUUID();</span>
<a href="#l96.147"></a><span id="l96.147" class="difflineminus">-        prop = getIcsService().createIcalProperty(&quot;ATTENDEE&quot;);</span>
<a href="#l96.148"></a><span id="l96.148" class="difflineplus">+        prop = cal.getIcsService().createIcalProperty(&quot;ATTENDEE&quot;);</span>
<a href="#l96.149"></a><span id="l96.149">         prop.setParameter(&quot;PARTSTAT&quot;, &quot;NEEDS-ACTION&quot;);</span>
<a href="#l96.150"></a><span id="l96.150">         prop.setParameter(&quot;ROLE&quot;, &quot;REQ-PARTICIPANT&quot;);</span>
<a href="#l96.151"></a><span id="l96.151">         prop.setParameter(&quot;CUTYPE&quot;, &quot;INDIVIDUAL&quot;);</span>
<a href="#l96.152"></a><span id="l96.152">         prop.value = mailto_aCalId;</span>
<a href="#l96.153"></a><span id="l96.153">         fbComp.addProperty(prop);</span>
<a href="#l96.154"></a><span id="l96.154">         fbQuery.addSubcomponent(fbComp);</span>
<a href="#l96.155"></a><span id="l96.155">         fbQuery = fbQuery.serializeToICS();</span>
<a href="#l96.156"></a><span id="l96.156">         if (this.verboseLogging()) {</span>
<a href="#l96.157"></a><span id="l96.157" class="difflineat">@@ -2740,17 +2740,17 @@ calDavCalendar.prototype = {</span>
<a href="#l96.158"></a><span id="l96.158">             // work around BUG 351589, the below just removes RSVP:</span>
<a href="#l96.159"></a><span id="l96.159">             aItipItem.setAttendeeStatus(attendee.id, attendee.participationStatus);</span>
<a href="#l96.160"></a><span id="l96.160">         }</span>
<a href="#l96.161"></a><span id="l96.161"> </span>
<a href="#l96.162"></a><span id="l96.162">         for (let item of aItipItem.getItemList({})) {</span>
<a href="#l96.163"></a><span id="l96.163">             let serializer = Components.classes[&quot;@mozilla.org/calendar/ics-serializer;1&quot;]</span>
<a href="#l96.164"></a><span id="l96.164">                                        .createInstance(Components.interfaces.calIIcsSerializer);</span>
<a href="#l96.165"></a><span id="l96.165">             serializer.addItems([item], 1);</span>
<a href="#l96.166"></a><span id="l96.166" class="difflineminus">-            let methodProp = getIcsService().createIcalProperty(&quot;METHOD&quot;);</span>
<a href="#l96.167"></a><span id="l96.167" class="difflineplus">+            let methodProp = cal.getIcsService().createIcalProperty(&quot;METHOD&quot;);</span>
<a href="#l96.168"></a><span id="l96.168">             methodProp.value = aItipItem.responseMethod;</span>
<a href="#l96.169"></a><span id="l96.169">             serializer.addProperty(methodProp);</span>
<a href="#l96.170"></a><span id="l96.170"> </span>
<a href="#l96.171"></a><span id="l96.171">             let self = this;</span>
<a href="#l96.172"></a><span id="l96.172">             let streamListener = {</span>
<a href="#l96.173"></a><span id="l96.173">                 onStreamComplete: function(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l96.174"></a><span id="l96.174">                     let request = aLoader.request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l96.175"></a><span id="l96.175">                     let status;</span>
<a href="#l96.176"></a><span id="l96.176" class="difflineat">@@ -2982,13 +2982,12 @@ calDavObserver.prototype = {</span>
<a href="#l96.177"></a><span id="l96.177">     onError: function(aCalendar, aErrNo, aMessage) {</span>
<a href="#l96.178"></a><span id="l96.178">         this.mCalendar.readOnly = true;</span>
<a href="#l96.179"></a><span id="l96.179">         this.mCalendar.notifyError(aErrNo, aMessage);</span>
<a href="#l96.180"></a><span id="l96.180">     }</span>
<a href="#l96.181"></a><span id="l96.181"> };</span>
<a href="#l96.182"></a><span id="l96.182"> </span>
<a href="#l96.183"></a><span id="l96.183"> /** Module Registration */</span>
<a href="#l96.184"></a><span id="l96.184"> var scriptLoadOrder = [</span>
<a href="#l96.185"></a><span id="l96.185" class="difflineminus">-    &quot;calUtils.js&quot;,</span>
<a href="#l96.186"></a><span id="l96.186">     &quot;calDavRequestHandlers.js&quot;</span>
<a href="#l96.187"></a><span id="l96.187"> ];</span>
<a href="#l96.188"></a><span id="l96.188"> </span>
<a href="#l96.189"></a><span id="l96.189"> this.NSGetFactory = cal.loadingNSGetFactory(scriptLoadOrder, [calDavCalendar], this);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l97.1"></a><span id="l97.1" class="difflineminus">--- a/calendar/providers/gdata/content/gdata-migration-wizard.xul</span>
<a href="#l97.2"></a><span id="l97.2" class="difflineplus">+++ b/calendar/providers/gdata/content/gdata-migration-wizard.xul</span>
<a href="#l97.3"></a><span id="l97.3" class="difflineat">@@ -15,16 +15,15 @@</span>
<a href="#l97.4"></a><span id="l97.4">         acceptKey=&quot;&amp;gdata.migration.upgrade.accesskey;&quot;</span>
<a href="#l97.5"></a><span id="l97.5">         ondialogaccept=&quot;migrateSelectedCalendars(); return true;&quot;</span>
<a href="#l97.6"></a><span id="l97.6">         ondialogcancel=&quot;window.close()&quot;</span>
<a href="#l97.7"></a><span id="l97.7">         onload=&quot;gdata_migration_loader()&quot;</span>
<a href="#l97.8"></a><span id="l97.8">         width=&quot;300&quot;</span>
<a href="#l97.9"></a><span id="l97.9">         height=&quot;300&quot;</span>
<a href="#l97.10"></a><span id="l97.10">         xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;&gt;</span>
<a href="#l97.11"></a><span id="l97.11">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://gdata-provider/content/gdata-migration.js&quot;/&gt;</span>
<a href="#l97.12"></a><span id="l97.12" class="difflineminus">-  &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calUtils.js&quot;/&gt;</span>
<a href="#l97.13"></a><span id="l97.13">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calendar-views.js&quot;/&gt;</span>
<a href="#l97.14"></a><span id="l97.14">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calendar-ui-utils.js&quot;/&gt;</span>
<a href="#l97.15"></a><span id="l97.15"> </span>
<a href="#l97.16"></a><span id="l97.16">   &lt;description&gt;&amp;gdata.migration.description;&lt;/description&gt;</span>
<a href="#l97.17"></a><span id="l97.17">   &lt;listbox id=&quot;calendars-listbox&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l97.18"></a><span id="l97.18">   &lt;checkbox id=&quot;showagain-checkbox&quot; label=&quot;&amp;gdata.migration.showagain.label;&quot;/&gt;</span>
<a href="#l97.19"></a><span id="l97.19"> &lt;/dialog&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l98.1"></a><span id="l98.1" class="difflineminus">--- a/calendar/providers/gdata/content/gdata-migration.js</span>
<a href="#l98.2"></a><span id="l98.2" class="difflineplus">+++ b/calendar/providers/gdata/content/gdata-migration.js</span>
<a href="#l98.3"></a><span id="l98.3" class="difflineat">@@ -58,17 +58,17 @@ function getMigratableCalendars() {</span>
<a href="#l98.4"></a><span id="l98.4">     function isMigratable(c) {</span>
<a href="#l98.5"></a><span id="l98.5">         let re = new RegExp(&quot;^http[s]?://www\\.google\\.com/calendar/ical/&quot; +</span>
<a href="#l98.6"></a><span id="l98.6">                             &quot;[^/]+/(private(-[^/]+)?|public)/&quot; +</span>
<a href="#l98.7"></a><span id="l98.7">                             &quot;(full|full-noattendees|composite|&quot; +</span>
<a href="#l98.8"></a><span id="l98.8">                             &quot;attendees-only|free-busy|basic)(\\.ics)?$&quot;);</span>
<a href="#l98.9"></a><span id="l98.9">         return c.type == &quot;ics&quot; &amp;&amp; c.uri.spec.match(re);</span>
<a href="#l98.10"></a><span id="l98.10">     }</span>
<a href="#l98.11"></a><span id="l98.11"> </span>
<a href="#l98.12"></a><span id="l98.12" class="difflineminus">-    return getCalendarManager().getCalendars({}).filter(isMigratable);</span>
<a href="#l98.13"></a><span id="l98.13" class="difflineplus">+    return cal.getCalendarManager().getCalendars({}).filter(isMigratable);</span>
<a href="#l98.14"></a><span id="l98.14"> }</span>
<a href="#l98.15"></a><span id="l98.15"> </span>
<a href="#l98.16"></a><span id="l98.16"> /**</span>
<a href="#l98.17"></a><span id="l98.17">  * Load Handler for both the wizard and the Thunderbird main window.</span>
<a href="#l98.18"></a><span id="l98.18">  */</span>
<a href="#l98.19"></a><span id="l98.19"> function gdata_migration_loader() {</span>
<a href="#l98.20"></a><span id="l98.20">     if (document.documentElement.id == &quot;gdata-migration-wizard&quot;) {</span>
<a href="#l98.21"></a><span id="l98.21">         // This is the migration wizard, load the calendars neeeded.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l99.1"></a><span id="l99.1" class="difflineminus">--- a/calendar/providers/ics/calICSCalendar.js</span>
<a href="#l99.2"></a><span id="l99.2" class="difflineplus">+++ b/calendar/providers/ics/calICSCalendar.js</span>
<a href="#l99.3"></a><span id="l99.3" class="difflineat">@@ -77,17 +77,17 @@ calICSCalendar.prototype = {</span>
<a href="#l99.4"></a><span id="l99.4">     //</span>
<a href="#l99.5"></a><span id="l99.5">     // calICalendarProvider interface</span>
<a href="#l99.6"></a><span id="l99.6">     //</span>
<a href="#l99.7"></a><span id="l99.7">     get prefChromeOverlay() {</span>
<a href="#l99.8"></a><span id="l99.8">         return null;</span>
<a href="#l99.9"></a><span id="l99.9">     },</span>
<a href="#l99.10"></a><span id="l99.10"> </span>
<a href="#l99.11"></a><span id="l99.11">     get displayName() {</span>
<a href="#l99.12"></a><span id="l99.12" class="difflineminus">-        return calGetString(&quot;calendar&quot;, &quot;icsName&quot;);</span>
<a href="#l99.13"></a><span id="l99.13" class="difflineplus">+        return cal.calGetString(&quot;calendar&quot;, &quot;icsName&quot;);</span>
<a href="#l99.14"></a><span id="l99.14">     },</span>
<a href="#l99.15"></a><span id="l99.15"> </span>
<a href="#l99.16"></a><span id="l99.16">     createCalendar: function() {</span>
<a href="#l99.17"></a><span id="l99.17">         throw NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l99.18"></a><span id="l99.18">     },</span>
<a href="#l99.19"></a><span id="l99.19"> </span>
<a href="#l99.20"></a><span id="l99.20">     deleteCalendar: function(cal, listener) {</span>
<a href="#l99.21"></a><span id="l99.21">         throw NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l99.22"></a><span id="l99.22" class="difflineat">@@ -577,21 +577,21 @@ calICSCalendar.prototype = {</span>
<a href="#l99.23"></a><span id="l99.23">         }</span>
<a href="#l99.24"></a><span id="l99.24">     },</span>
<a href="#l99.25"></a><span id="l99.25"> </span>
<a href="#l99.26"></a><span id="l99.26">     lock: function() {</span>
<a href="#l99.27"></a><span id="l99.27">         this.locked = true;</span>
<a href="#l99.28"></a><span id="l99.28">     },</span>
<a href="#l99.29"></a><span id="l99.29"> </span>
<a href="#l99.30"></a><span id="l99.30">     unlock: function(errCode) {</span>
<a href="#l99.31"></a><span id="l99.31" class="difflineminus">-        ASSERT(this.locked, &quot;unexpected!&quot;);</span>
<a href="#l99.32"></a><span id="l99.32" class="difflineplus">+        cal.ASSERT(this.locked, &quot;unexpected!&quot;);</span>
<a href="#l99.33"></a><span id="l99.33"> </span>
<a href="#l99.34"></a><span id="l99.34">         this.mModificationActions.forEach((action) =&gt; {</span>
<a href="#l99.35"></a><span id="l99.35">             let args = action.opCompleteArgs;</span>
<a href="#l99.36"></a><span id="l99.36" class="difflineminus">-            ASSERT(args, &quot;missing onOperationComplete call!&quot;);</span>
<a href="#l99.37"></a><span id="l99.37" class="difflineplus">+            cal.ASSERT(args, &quot;missing onOperationComplete call!&quot;);</span>
<a href="#l99.38"></a><span id="l99.38">             let listener = action.listener;</span>
<a href="#l99.39"></a><span id="l99.39">             if (listener) {</span>
<a href="#l99.40"></a><span id="l99.40">                 if (Components.isSuccessCode(args[1]) &amp;&amp;</span>
<a href="#l99.41"></a><span id="l99.41">                     errCode &amp;&amp; !Components.isSuccessCode(errCode)) {</span>
<a href="#l99.42"></a><span id="l99.42">                     listener.onOperationComplete(args[0], errCode, args[2], args[3], null);</span>
<a href="#l99.43"></a><span id="l99.43">                 } else {</span>
<a href="#l99.44"></a><span id="l99.44">                     listener.onOperationComplete(...args);</span>
<a href="#l99.45"></a><span id="l99.45">                 }</span>
<a href="#l99.46"></a><span id="l99.46" class="difflineat">@@ -1106,14 +1106,9 @@ fileHooks.prototype = {</span>
<a href="#l99.47"></a><span id="l99.47">     onAfterPut: function(aChannel, aRespFunc) {</span>
<a href="#l99.48"></a><span id="l99.48">         let filechannel = aChannel.QueryInterface(Components.interfaces.nsIFileChannel);</span>
<a href="#l99.49"></a><span id="l99.49">         this.mtime = filechannel.file.lastModifiedTime;</span>
<a href="#l99.50"></a><span id="l99.50">         aRespFunc();</span>
<a href="#l99.51"></a><span id="l99.51">         return true;</span>
<a href="#l99.52"></a><span id="l99.52">     }</span>
<a href="#l99.53"></a><span id="l99.53"> };</span>
<a href="#l99.54"></a><span id="l99.54"> </span>
<a href="#l99.55"></a><span id="l99.55" class="difflineminus">-/** Module Registration */</span>
<a href="#l99.56"></a><span id="l99.56" class="difflineminus">-var scriptLoadOrder = [</span>
<a href="#l99.57"></a><span id="l99.57" class="difflineminus">-    &quot;calUtils.js&quot;,</span>
<a href="#l99.58"></a><span id="l99.58" class="difflineminus">-];</span>
<a href="#l99.59"></a><span id="l99.59" class="difflineminus">-</span>
<a href="#l99.60"></a><span id="l99.60" class="difflineminus">-this.NSGetFactory = cal.loadingNSGetFactory(scriptLoadOrder, [calICSCalendar], this);</span>
<a href="#l99.61"></a><span id="l99.61" class="difflineplus">+this.NSGetFactory = XPCOMUtils.generateNSGetFactory([calICSCalendar]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l100.1"></a><span id="l100.1" class="difflineminus">--- a/calendar/providers/storage/calStorageCalendar.js</span>
<a href="#l100.2"></a><span id="l100.2" class="difflineplus">+++ b/calendar/providers/storage/calStorageCalendar.js</span>
<a href="#l100.3"></a><span id="l100.3" class="difflineat">@@ -766,17 +766,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l100.4"></a><span id="l100.4">                 // If the item is recurring, get all ocurrences that fall in</span>
<a href="#l100.5"></a><span id="l100.5">                 // the range. If the item doesn't fall into the range at all,</span>
<a href="#l100.6"></a><span id="l100.6">                 // this expands to 0 items.</span>
<a href="#l100.7"></a><span id="l100.7">                 expandedItems = item.recurrenceInfo.getOccurrences(aRangeStart, aRangeEnd, 0, {});</span>
<a href="#l100.8"></a><span id="l100.8">                 if (wantUnrespondedInvitations) {</span>
<a href="#l100.9"></a><span id="l100.9">                     expandedItems = expandedItems.filter(checkUnrespondedInvitation);</span>
<a href="#l100.10"></a><span id="l100.10">                 }</span>
<a href="#l100.11"></a><span id="l100.11">             } else if ((!wantUnrespondedInvitations || checkUnrespondedInvitation(item)) &amp;&amp;</span>
<a href="#l100.12"></a><span id="l100.12" class="difflineminus">-                       checkIfInRange(item, aRangeStart, aRangeEnd)) {</span>
<a href="#l100.13"></a><span id="l100.13" class="difflineplus">+                       cal.checkIfInRange(item, aRangeStart, aRangeEnd)) {</span>
<a href="#l100.14"></a><span id="l100.14">                 // If no occurrences are wanted, check only the parent item.</span>
<a href="#l100.15"></a><span id="l100.15">                 // This will be changed with bug 416975.</span>
<a href="#l100.16"></a><span id="l100.16">                 expandedItems = [item];</span>
<a href="#l100.17"></a><span id="l100.17">             }</span>
<a href="#l100.18"></a><span id="l100.18"> </span>
<a href="#l100.19"></a><span id="l100.19">             if (expandedItems.length &amp;&amp; optionalFilterFunc) {</span>
<a href="#l100.20"></a><span id="l100.20">                 expandedItems = expandedItems.filter(optionalFilterFunc);</span>
<a href="#l100.21"></a><span id="l100.21">             }</span>
<a href="#l100.22"></a><span id="l100.22" class="difflineat">@@ -1594,17 +1594,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l100.23"></a><span id="l100.23">         let item;</span>
<a href="#l100.24"></a><span id="l100.24">         if (!isException) { // only parent items are cached</span>
<a href="#l100.25"></a><span id="l100.25">             item = this.mItemCache[row.id];</span>
<a href="#l100.26"></a><span id="l100.26">             if (item) {</span>
<a href="#l100.27"></a><span id="l100.27">                 return item;</span>
<a href="#l100.28"></a><span id="l100.28">             }</span>
<a href="#l100.29"></a><span id="l100.29">         }</span>
<a href="#l100.30"></a><span id="l100.30"> </span>
<a href="#l100.31"></a><span id="l100.31" class="difflineminus">-        item = createEvent();</span>
<a href="#l100.32"></a><span id="l100.32" class="difflineplus">+        item = cal.createEvent();</span>
<a href="#l100.33"></a><span id="l100.33"> </span>
<a href="#l100.34"></a><span id="l100.34">         if (row.event_start) {</span>
<a href="#l100.35"></a><span id="l100.35">             item.startDate = newDateTime(row.event_start, row.event_start_tz);</span>
<a href="#l100.36"></a><span id="l100.36">         }</span>
<a href="#l100.37"></a><span id="l100.37">         if (row.event_end) {</span>
<a href="#l100.38"></a><span id="l100.38">             item.endDate = newDateTime(row.event_end, row.event_end_tz);</span>
<a href="#l100.39"></a><span id="l100.39">         }</span>
<a href="#l100.40"></a><span id="l100.40">         if (row.event_stamp) {</span>
<a href="#l100.41"></a><span id="l100.41" class="difflineat">@@ -1630,17 +1630,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l100.42"></a><span id="l100.42">         let item;</span>
<a href="#l100.43"></a><span id="l100.43">         if (!isException) { // only parent items are cached</span>
<a href="#l100.44"></a><span id="l100.44">             item = this.mItemCache[row.id];</span>
<a href="#l100.45"></a><span id="l100.45">             if (item) {</span>
<a href="#l100.46"></a><span id="l100.46">                 return item;</span>
<a href="#l100.47"></a><span id="l100.47">             }</span>
<a href="#l100.48"></a><span id="l100.48">         }</span>
<a href="#l100.49"></a><span id="l100.49"> </span>
<a href="#l100.50"></a><span id="l100.50" class="difflineminus">-        item = createTodo();</span>
<a href="#l100.51"></a><span id="l100.51" class="difflineplus">+        item = cal.createTodo();</span>
<a href="#l100.52"></a><span id="l100.52"> </span>
<a href="#l100.53"></a><span id="l100.53">         if (row.todo_entry) {</span>
<a href="#l100.54"></a><span id="l100.54">             item.entryDate = newDateTime(row.todo_entry, row.todo_entry_tz);</span>
<a href="#l100.55"></a><span id="l100.55">         }</span>
<a href="#l100.56"></a><span id="l100.56">         if (row.todo_due) {</span>
<a href="#l100.57"></a><span id="l100.57">             item.dueDate = newDateTime(row.todo_due, row.todo_due_tz);</span>
<a href="#l100.58"></a><span id="l100.58">         }</span>
<a href="#l100.59"></a><span id="l100.59">         if (row.todo_stamp) {</span>
<a href="#l100.60"></a><span id="l100.60" class="difflineat">@@ -1722,17 +1722,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l100.61"></a><span id="l100.61">                 while (selectItem.executeStep()) {</span>
<a href="#l100.62"></a><span id="l100.62">                     let row = selectItem.row;</span>
<a href="#l100.63"></a><span id="l100.63">                     let name = row.key;</span>
<a href="#l100.64"></a><span id="l100.64">                     switch (name) {</span>
<a href="#l100.65"></a><span id="l100.65">                         case &quot;DURATION&quot;:</span>
<a href="#l100.66"></a><span id="l100.66">                             // for events DTEND/DUE is enforced by calEvent/calTodo, so suppress DURATION:</span>
<a href="#l100.67"></a><span id="l100.67">                             break;</span>
<a href="#l100.68"></a><span id="l100.68">                         case &quot;CATEGORIES&quot;: {</span>
<a href="#l100.69"></a><span id="l100.69" class="difflineminus">-                            let cats = categoriesStringToArray(row.value);</span>
<a href="#l100.70"></a><span id="l100.70" class="difflineplus">+                            let cats = cal.categoriesStringToArray(row.value);</span>
<a href="#l100.71"></a><span id="l100.71">                             item.setCategories(cats.length, cats);</span>
<a href="#l100.72"></a><span id="l100.72">                             break;</span>
<a href="#l100.73"></a><span id="l100.73">                         }</span>
<a href="#l100.74"></a><span id="l100.74">                         default:</span>
<a href="#l100.75"></a><span id="l100.75">                             item.setProperty(name, row.value);</span>
<a href="#l100.76"></a><span id="l100.76">                             break;</span>
<a href="#l100.77"></a><span id="l100.77">                     }</span>
<a href="#l100.78"></a><span id="l100.78">                 }</span>
<a href="#l100.79"></a><span id="l100.79" class="difflineat">@@ -1964,17 +1964,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l100.80"></a><span id="l100.80">             }</span>
<a href="#l100.81"></a><span id="l100.81">         } else {</span>
<a href="#l100.82"></a><span id="l100.82">             params[entryname] = null;</span>
<a href="#l100.83"></a><span id="l100.83">             params[entryname + &quot;_tz&quot;] = null;</span>
<a href="#l100.84"></a><span id="l100.84">         }</span>
<a href="#l100.85"></a><span id="l100.85">     },</span>
<a href="#l100.86"></a><span id="l100.86"> </span>
<a href="#l100.87"></a><span id="l100.87">     flushItem: function(item, olditem) {</span>
<a href="#l100.88"></a><span id="l100.88" class="difflineminus">-        ASSERT(!item.recurrenceId, &quot;no parent item passed!&quot;, true);</span>
<a href="#l100.89"></a><span id="l100.89" class="difflineplus">+        cal.ASSERT(!item.recurrenceId, &quot;no parent item passed!&quot;, true);</span>
<a href="#l100.90"></a><span id="l100.90"> </span>
<a href="#l100.91"></a><span id="l100.91">         try {</span>
<a href="#l100.92"></a><span id="l100.92">             this.deleteItemById(olditem ? olditem.id : item.id, true);</span>
<a href="#l100.93"></a><span id="l100.93">             this.acquireTransaction();</span>
<a href="#l100.94"></a><span id="l100.94">             this.writeItem(item, olditem);</span>
<a href="#l100.95"></a><span id="l100.95">         } catch (e) {</span>
<a href="#l100.96"></a><span id="l100.96">             this.releaseTransaction(e);</span>
<a href="#l100.97"></a><span id="l100.97">             throw e;</span>
<a href="#l100.98"></a><span id="l100.98" class="difflineat">@@ -2155,17 +2155,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l100.99"></a><span id="l100.99">                 continue;</span>
<a href="#l100.100"></a><span id="l100.100">             }</span>
<a href="#l100.101"></a><span id="l100.101">             this.writeProperty(item, prop.name, prop.value);</span>
<a href="#l100.102"></a><span id="l100.102">         }</span>
<a href="#l100.103"></a><span id="l100.103"> </span>
<a href="#l100.104"></a><span id="l100.104">         let cats = item.getCategories({});</span>
<a href="#l100.105"></a><span id="l100.105">         if (cats.length &gt; 0) {</span>
<a href="#l100.106"></a><span id="l100.106">             ret = CAL_ITEM_FLAG.HAS_PROPERTIES;</span>
<a href="#l100.107"></a><span id="l100.107" class="difflineminus">-            this.writeProperty(item, &quot;CATEGORIES&quot;, categoriesArrayToString(cats));</span>
<a href="#l100.108"></a><span id="l100.108" class="difflineplus">+            this.writeProperty(item, &quot;CATEGORIES&quot;, cal.categoriesArrayToString(cats));</span>
<a href="#l100.109"></a><span id="l100.109">         }</span>
<a href="#l100.110"></a><span id="l100.110"> </span>
<a href="#l100.111"></a><span id="l100.111">         return ret;</span>
<a href="#l100.112"></a><span id="l100.112">     },</span>
<a href="#l100.113"></a><span id="l100.113"> </span>
<a href="#l100.114"></a><span id="l100.114">     writeRecurrence: function(item, olditem) {</span>
<a href="#l100.115"></a><span id="l100.115">         let flags = 0;</span>
<a href="#l100.116"></a><span id="l100.116"> </span>
<a href="#l100.117"></a><span id="l100.117" class="difflineat">@@ -2460,14 +2460,9 @@ calStorageCalendar.prototype = {</span>
<a href="#l100.118"></a><span id="l100.118">                         ex.deleteProperty(&quot;SEQUENCE&quot;);</span>
<a href="#l100.119"></a><span id="l100.119">                     }</span>
<a href="#l100.120"></a><span id="l100.120">                 }</span>
<a href="#l100.121"></a><span id="l100.121">             }</span>
<a href="#l100.122"></a><span id="l100.122">         }</span>
<a href="#l100.123"></a><span id="l100.123">     }</span>
<a href="#l100.124"></a><span id="l100.124"> };</span>
<a href="#l100.125"></a><span id="l100.125"> </span>
<a href="#l100.126"></a><span id="l100.126" class="difflineminus">-/** Module Registration */</span>
<a href="#l100.127"></a><span id="l100.127" class="difflineminus">-var scriptLoadOrder = [</span>
<a href="#l100.128"></a><span id="l100.128" class="difflineminus">-    &quot;calUtils.js&quot;,</span>
<a href="#l100.129"></a><span id="l100.129" class="difflineminus">-];</span>
<a href="#l100.130"></a><span id="l100.130" class="difflineminus">-</span>
<a href="#l100.131"></a><span id="l100.131" class="difflineminus">-this.NSGetFactory = cal.loadingNSGetFactory(scriptLoadOrder, [calStorageCalendar], this);</span>
<a href="#l100.132"></a><span id="l100.132" class="difflineplus">+this.NSGetFactory = XPCOMUtils.generateNSGetFactory([calStorageCalendar]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l101.1"></a><span id="l101.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapCalendarItems.js</span>
<a href="#l101.2"></a><span id="l101.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapCalendarItems.js</span>
<a href="#l101.3"></a><span id="l101.3" class="difflineat">@@ -1,13 +1,14 @@</span>
<a href="#l101.4"></a><span id="l101.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l101.5"></a><span id="l101.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l101.6"></a><span id="l101.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l101.7"></a><span id="l101.7"> </span>
<a href="#l101.8"></a><span id="l101.8"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l101.9"></a><span id="l101.9" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l101.10"></a><span id="l101.10"> Components.utils.import(&quot;resource://calendar/modules/calAlarmUtils.jsm&quot;);</span>
<a href="#l101.11"></a><span id="l101.11"> Components.utils.import(&quot;resource://calendar/modules/calIteratorUtils.jsm&quot;);</span>
<a href="#l101.12"></a><span id="l101.12"> </span>
<a href="#l101.13"></a><span id="l101.13"> calWcapCalendar.prototype.encodeAttendee = function(att) {</span>
<a href="#l101.14"></a><span id="l101.14">     if (LOG_LEVEL &gt; 2) {</span>
<a href="#l101.15"></a><span id="l101.15">         log(&quot;attendee.icalProperty.icalString=&quot; + att.icalProperty.icalString, this);</span>
<a href="#l101.16"></a><span id="l101.16">     }</span>
<a href="#l101.17"></a><span id="l101.17">     function encodeAttr(val, attr, params) {</span>
<a href="#l101.18"></a><span id="l101.18" class="difflineat">@@ -49,19 +50,19 @@ calWcapCalendar.prototype.getRecurrenceP</span>
<a href="#l101.19"></a><span id="l101.19">                 if (isNeg) {</span>
<a href="#l101.20"></a><span id="l101.20">                     out_exrules.value.push(rule);</span>
<a href="#l101.21"></a><span id="l101.21">                 } else {</span>
<a href="#l101.22"></a><span id="l101.22">                     out_rrules.value.push(rule);</span>
<a href="#l101.23"></a><span id="l101.23">                 }</span>
<a href="#l101.24"></a><span id="l101.24">             } else if (rDateInstance) {</span>
<a href="#l101.25"></a><span id="l101.25">                 // cs does not accept DATEs here:</span>
<a href="#l101.26"></a><span id="l101.26">                 if (isNeg) {</span>
<a href="#l101.27"></a><span id="l101.27" class="difflineminus">-                    out_exdates.value.push(getIcalUTC(ensureDateTime(rDateInstance.date)));</span>
<a href="#l101.28"></a><span id="l101.28" class="difflineplus">+                    out_exdates.value.push(getIcalUTC(cal.ensureDateTime(rDateInstance.date)));</span>
<a href="#l101.29"></a><span id="l101.29">                 } else {</span>
<a href="#l101.30"></a><span id="l101.30" class="difflineminus">-                    out_rdates.value.push(getIcalUTC(ensureDateTime(rDateInstance.date)));</span>
<a href="#l101.31"></a><span id="l101.31" class="difflineplus">+                    out_rdates.value.push(getIcalUTC(cal.ensureDateTime(rDateInstance.date)));</span>
<a href="#l101.32"></a><span id="l101.32">                 }</span>
<a href="#l101.33"></a><span id="l101.33">             } else {</span>
<a href="#l101.34"></a><span id="l101.34">                 this.notifyError(NS_ERROR_UNEXPECTED,</span>
<a href="#l101.35"></a><span id="l101.35">                                  &quot;don't know how to handle this recurrence item: &quot; + rItem.valueAsIcalString);</span>
<a href="#l101.36"></a><span id="l101.36">             }</span>
<a href="#l101.37"></a><span id="l101.37">         }</span>
<a href="#l101.38"></a><span id="l101.38">     }</span>
<a href="#l101.39"></a><span id="l101.39"> };</span>
<a href="#l101.40"></a><span id="l101.40" class="difflineat">@@ -232,17 +233,17 @@ function equalDatetimes(one, two) {</span>
<a href="#l101.41"></a><span id="l101.41">             (one &amp;&amp; two &amp;&amp;</span>
<a href="#l101.42"></a><span id="l101.42">              one.isDate == two.isDate &amp;&amp;</span>
<a href="#l101.43"></a><span id="l101.43">              one.compare(two) == 0);</span>
<a href="#l101.44"></a><span id="l101.44"> }</span>
<a href="#l101.45"></a><span id="l101.45"> </span>
<a href="#l101.46"></a><span id="l101.46"> function identicalDatetimes(one, two) {</span>
<a href="#l101.47"></a><span id="l101.47">     return (!one &amp;&amp; !two) ||</span>
<a href="#l101.48"></a><span id="l101.48">             (equalDatetimes(one, two) &amp;&amp;</span>
<a href="#l101.49"></a><span id="l101.49" class="difflineminus">-             compareObjects(one.timezone, two.timezone));</span>
<a href="#l101.50"></a><span id="l101.50" class="difflineplus">+             cal.compareObjects(one.timezone, two.timezone));</span>
<a href="#l101.51"></a><span id="l101.51"> }</span>
<a href="#l101.52"></a><span id="l101.52"> </span>
<a href="#l101.53"></a><span id="l101.53"> // @return null if nothing has changed else value to be written</span>
<a href="#l101.54"></a><span id="l101.54"> function diffProperty(newItem, oldItem, propName) {</span>
<a href="#l101.55"></a><span id="l101.55">     let val = newItem.getProperty(propName);</span>
<a href="#l101.56"></a><span id="l101.56">     let oldVal = (oldItem ? oldItem.getProperty(propName) : null);</span>
<a href="#l101.57"></a><span id="l101.57">     if (val === null) {</span>
<a href="#l101.58"></a><span id="l101.58">         // force being set when - no old item, eg when adding new item</span>
<a href="#l101.59"></a><span id="l101.59" class="difflineat">@@ -313,17 +314,17 @@ calWcapCalendar.prototype.storeItem = fu</span>
<a href="#l101.60"></a><span id="l101.60">                 }</span>
<a href="#l101.61"></a><span id="l101.61">             }</span>
<a href="#l101.62"></a><span id="l101.62">             strings.sort();</span>
<a href="#l101.63"></a><span id="l101.63">             ret = strings.join(&quot;;&quot;);</span>
<a href="#l101.64"></a><span id="l101.64">         }</span>
<a href="#l101.65"></a><span id="l101.65">         return ret || &quot;&quot;;</span>
<a href="#l101.66"></a><span id="l101.66">     };</span>
<a href="#l101.67"></a><span id="l101.67"> </span>
<a href="#l101.68"></a><span id="l101.68" class="difflineminus">-    let bIsEvent = isEvent(item);</span>
<a href="#l101.69"></a><span id="l101.69" class="difflineplus">+    let bIsEvent = cal.isEvent(item);</span>
<a href="#l101.70"></a><span id="l101.70">     let bIsParent = isParent(item);</span>
<a href="#l101.71"></a><span id="l101.71"> </span>
<a href="#l101.72"></a><span id="l101.72">     let method = METHOD_PUBLISH;</span>
<a href="#l101.73"></a><span id="l101.73">     let bNoSmtpNotify = false;</span>
<a href="#l101.74"></a><span id="l101.74">     let params = &quot;&quot;;</span>
<a href="#l101.75"></a><span id="l101.75"> </span>
<a href="#l101.76"></a><span id="l101.76">     let calId = this.calId;</span>
<a href="#l101.77"></a><span id="l101.77">     if (!bAddItem &amp;&amp; this.isInvitation(item)) { // REPLY</span>
<a href="#l101.78"></a><span id="l101.78" class="difflineat">@@ -548,17 +549,17 @@ calWcapCalendar.prototype.storeItem = fu</span>
<a href="#l101.79"></a><span id="l101.79">             params += &quot;&amp;storetype=1&quot;;</span>
<a href="#l101.80"></a><span id="l101.80">         } else if (oldItem) {</span>
<a href="#l101.81"></a><span id="l101.81">             params += &quot;&amp;storetype=2&quot;;</span>
<a href="#l101.82"></a><span id="l101.82">         } // else we don't know exactly, so don't check</span>
<a href="#l101.83"></a><span id="l101.83"> </span>
<a href="#l101.84"></a><span id="l101.84">         if (bIsParent) {</span>
<a href="#l101.85"></a><span id="l101.85">             params += &quot;&amp;mod=4&quot;; // THIS AND ALL INSTANCES</span>
<a href="#l101.86"></a><span id="l101.86">         } else {</span>
<a href="#l101.87"></a><span id="l101.87" class="difflineminus">-            params += &quot;&amp;mod=1&amp;rid=&quot; + getIcalUTC(ensureDateTime(item.recurrenceId)); // THIS INSTANCE</span>
<a href="#l101.88"></a><span id="l101.88" class="difflineplus">+            params += &quot;&amp;mod=1&amp;rid=&quot; + getIcalUTC(cal.ensureDateTime(item.recurrenceId)); // THIS INSTANCE</span>
<a href="#l101.89"></a><span id="l101.89">         }</span>
<a href="#l101.90"></a><span id="l101.90"> </span>
<a href="#l101.91"></a><span id="l101.91">         params += &quot;&amp;method=&quot; + method;</span>
<a href="#l101.92"></a><span id="l101.92">         if (bNoSmtpNotify) {</span>
<a href="#l101.93"></a><span id="l101.93">             params += &quot;&amp;smtp=0&amp;smtpNotify=0&amp;notify=0&quot;;</span>
<a href="#l101.94"></a><span id="l101.94">         }</span>
<a href="#l101.95"></a><span id="l101.95">         params += &quot;&amp;replace=1&quot;; // (update) don't append to any lists</span>
<a href="#l101.96"></a><span id="l101.96">         params += &quot;&amp;fetch=1&amp;relativealarm=1&amp;compressed=1&amp;recurring=1&quot;;</span>
<a href="#l101.97"></a><span id="l101.97" class="difflineat">@@ -708,17 +709,17 @@ calWcapCalendar.prototype.modifyItem = f</span>
<a href="#l101.98"></a><span id="l101.98">                                                  }</span>
<a href="#l101.99"></a><span id="l101.99">                                                  // invalidate cached results:</span>
<a href="#l101.100"></a><span id="l101.100">                                                  delete this.m_cachedResults;</span>
<a href="#l101.101"></a><span id="l101.101">                                                  this.storeItem(false /* bAddItem */, newItem, oldItem_, request);</span>
<a href="#l101.102"></a><span id="l101.102">                                              } finally {</span>
<a href="#l101.103"></a><span id="l101.103">                                                  request.unlockPending();</span>
<a href="#l101.104"></a><span id="l101.104">                                              }</span>
<a href="#l101.105"></a><span id="l101.105">                                          },</span>
<a href="#l101.106"></a><span id="l101.106" class="difflineminus">-                                         stringToXml, isEvent(newItem) ? &quot;deleteevents_by_id&quot; : &quot;deletetodos_by_id&quot;,</span>
<a href="#l101.107"></a><span id="l101.107" class="difflineplus">+                                         stringToXml, cal.isEvent(newItem) ? &quot;deleteevents_by_id&quot; : &quot;deletetodos_by_id&quot;,</span>
<a href="#l101.108"></a><span id="l101.108">                                          params, calIWcapCalendar.AC_COMP_WRITE);</span>
<a href="#l101.109"></a><span id="l101.109">                 return request;</span>
<a href="#l101.110"></a><span id="l101.110">             }</span>
<a href="#l101.111"></a><span id="l101.111">         } else if (oldItem &amp;&amp; !oldItem.parentItem.recurrenceInfo.getExceptionFor(newItem.recurrenceId)) {</span>
<a href="#l101.112"></a><span id="l101.112">             // pass null for oldItem when creating new exceptions, write whole item:</span>
<a href="#l101.113"></a><span id="l101.113">             oldItem_ = null;</span>
<a href="#l101.114"></a><span id="l101.114">         }</span>
<a href="#l101.115"></a><span id="l101.115">         this.storeItem(false /* bAddItem */, newItem, oldItem_, request);</span>
<a href="#l101.116"></a><span id="l101.116" class="difflineat">@@ -746,17 +747,17 @@ calWcapCalendar.prototype.deleteItem = f</span>
<a href="#l101.117"></a><span id="l101.117">         if (!item.id) {</span>
<a href="#l101.118"></a><span id="l101.118">             throw new Components.Exception(&quot;no item id!&quot;);</span>
<a href="#l101.119"></a><span id="l101.119">         }</span>
<a href="#l101.120"></a><span id="l101.120">         let params = &quot;&amp;uid=&quot; + encodeURIComponent(item.id);</span>
<a href="#l101.121"></a><span id="l101.121">         if (isParent(item)) { // delete THIS AND ALL:</span>
<a href="#l101.122"></a><span id="l101.122">             params += &quot;&amp;mod=4&amp;rid=0&quot;;</span>
<a href="#l101.123"></a><span id="l101.123">         } else { // delete THIS INSTANCE:</span>
<a href="#l101.124"></a><span id="l101.124">             // cs does not accept DATE here:</span>
<a href="#l101.125"></a><span id="l101.125" class="difflineminus">-            params += &quot;&amp;mod=1&amp;rid=&quot; + getIcalUTC(ensureDateTime(item.recurrenceId));</span>
<a href="#l101.126"></a><span id="l101.126" class="difflineplus">+            params += &quot;&amp;mod=1&amp;rid=&quot; + getIcalUTC(cal.ensureDateTime(item.recurrenceId));</span>
<a href="#l101.127"></a><span id="l101.127">         }</span>
<a href="#l101.128"></a><span id="l101.128"> </span>
<a href="#l101.129"></a><span id="l101.129">         let orgCalId = getCalId(item.organizer);</span>
<a href="#l101.130"></a><span id="l101.130">         if (!orgCalId || (orgCalId != this.calId)) {</span>
<a href="#l101.131"></a><span id="l101.131">             // item does not belong to this user, so don't notify:</span>
<a href="#l101.132"></a><span id="l101.132">             params += &quot;&amp;smtp=0&amp;smtpNotify=0&amp;notify=0&quot;;</span>
<a href="#l101.133"></a><span id="l101.133">         }</span>
<a href="#l101.134"></a><span id="l101.134"> </span>
<a href="#l101.135"></a><span id="l101.135" class="difflineat">@@ -768,17 +769,17 @@ calWcapCalendar.prototype.deleteItem = f</span>
<a href="#l101.136"></a><span id="l101.136">                                          throw err;</span>
<a href="#l101.137"></a><span id="l101.137">                                      }</span>
<a href="#l101.138"></a><span id="l101.138">                                      // invalidate cached results:</span>
<a href="#l101.139"></a><span id="l101.139">                                      delete this.m_cachedResults;</span>
<a href="#l101.140"></a><span id="l101.140">                                      if (LOG_LEVEL &gt; 0) {</span>
<a href="#l101.141"></a><span id="l101.141">                                          log(&quot;deleteItem(): &quot; + getWcapRequestStatusString(xml), this);</span>
<a href="#l101.142"></a><span id="l101.142">                                      }</span>
<a href="#l101.143"></a><span id="l101.143">                                  },</span>
<a href="#l101.144"></a><span id="l101.144" class="difflineminus">-                                 stringToXml, isEvent(item) ? &quot;deleteevents_by_id&quot; : &quot;deletetodos_by_id&quot;,</span>
<a href="#l101.145"></a><span id="l101.145" class="difflineplus">+                                 stringToXml, cal.isEvent(item) ? &quot;deleteevents_by_id&quot; : &quot;deletetodos_by_id&quot;,</span>
<a href="#l101.146"></a><span id="l101.146">                                  params, calIWcapCalendar.AC_COMP_WRITE);</span>
<a href="#l101.147"></a><span id="l101.147">     } catch (exc) {</span>
<a href="#l101.148"></a><span id="l101.148">         request.execRespFunc(exc);</span>
<a href="#l101.149"></a><span id="l101.149">     }</span>
<a href="#l101.150"></a><span id="l101.150">     return request;</span>
<a href="#l101.151"></a><span id="l101.151"> };</span>
<a href="#l101.152"></a><span id="l101.152"> </span>
<a href="#l101.153"></a><span id="l101.153"> calWcapCalendar.prototype.patchTimezone = function(subComp, attr, xpropOrTz) {</span>
<a href="#l101.154"></a><span id="l101.154" class="difflineat">@@ -788,17 +789,17 @@ calWcapCalendar.prototype.patchTimezone </span>
<a href="#l101.155"></a><span id="l101.155">         if (LOG_LEVEL &gt; 2) {</span>
<a href="#l101.156"></a><span id="l101.156">             log(attr + &quot; is &quot; + date, this);</span>
<a href="#l101.157"></a><span id="l101.157">         }</span>
<a href="#l101.158"></a><span id="l101.158">         let timezone;</span>
<a href="#l101.159"></a><span id="l101.159">         if (typeof xpropOrTz == &quot;string&quot;) {</span>
<a href="#l101.160"></a><span id="l101.160">             let tzid = subComp.getFirstProperty(xpropOrTz);</span>
<a href="#l101.161"></a><span id="l101.161">             if (tzid) {</span>
<a href="#l101.162"></a><span id="l101.162">                 timezone = this.session.getTimezone(tzid.value);</span>
<a href="#l101.163"></a><span id="l101.163" class="difflineminus">-                ASSERT(timezone, &quot;timezone not found: &quot; + tzid);</span>
<a href="#l101.164"></a><span id="l101.164" class="difflineplus">+                cal.ASSERT(timezone, &quot;timezone not found: &quot; + tzid);</span>
<a href="#l101.165"></a><span id="l101.165">             }</span>
<a href="#l101.166"></a><span id="l101.166">         } else {</span>
<a href="#l101.167"></a><span id="l101.167">             timezone = xpropOrTz;</span>
<a href="#l101.168"></a><span id="l101.168">         }</span>
<a href="#l101.169"></a><span id="l101.169">         if (timezone) {</span>
<a href="#l101.170"></a><span id="l101.170">             if (LOG_LEVEL &gt; 2) {</span>
<a href="#l101.171"></a><span id="l101.171">                 log(&quot;patching &quot; + xpropOrTz + &quot;: from &quot; +</span>
<a href="#l101.172"></a><span id="l101.172">                     date + &quot; to &quot; + date.getInTimezone(timezone), this);</span>
<a href="#l101.173"></a><span id="l101.173" class="difflineat">@@ -841,23 +842,23 @@ calWcapCalendar.prototype.parseItems = f</span>
<a href="#l101.174"></a><span id="l101.174">         }</span>
<a href="#l101.175"></a><span id="l101.175"> </span>
<a href="#l101.176"></a><span id="l101.176">         let dtstart = this.patchTimezone(subComp, &quot;startTime&quot;, &quot;X-NSCP-DTSTART-TZID&quot;);</span>
<a href="#l101.177"></a><span id="l101.177"> </span>
<a href="#l101.178"></a><span id="l101.178">         let item = null;</span>
<a href="#l101.179"></a><span id="l101.179">         switch (subComp.componentType) {</span>
<a href="#l101.180"></a><span id="l101.180">             case &quot;VEVENT&quot;: {</span>
<a href="#l101.181"></a><span id="l101.181">                 this.patchTimezone(subComp, &quot;endTime&quot;, dtstart ? dtstart.timezone : &quot;X-NSCP-DTEND-TZID&quot;);</span>
<a href="#l101.182"></a><span id="l101.182" class="difflineminus">-                item = createEvent();</span>
<a href="#l101.183"></a><span id="l101.183" class="difflineplus">+                item = cal.createEvent();</span>
<a href="#l101.184"></a><span id="l101.184">                 item.icalComponent = subComp;</span>
<a href="#l101.185"></a><span id="l101.185">                 break;</span>
<a href="#l101.186"></a><span id="l101.186">             }</span>
<a href="#l101.187"></a><span id="l101.187">             case &quot;VTODO&quot;: {</span>
<a href="#l101.188"></a><span id="l101.188">                 this.patchTimezone(subComp, &quot;dueTime&quot;, dtstart ? dtstart.timezone : &quot;X-NSCP-DUE-TZID&quot;);</span>
<a href="#l101.189"></a><span id="l101.189" class="difflineminus">-                item = createTodo();</span>
<a href="#l101.190"></a><span id="l101.190" class="difflineplus">+                item = cal.createTodo();</span>
<a href="#l101.191"></a><span id="l101.191">                 item.icalComponent = subComp;</span>
<a href="#l101.192"></a><span id="l101.192">                 switch (itemFilter &amp; calICalendar.ITEM_FILTER_COMPLETED_ALL) {</span>
<a href="#l101.193"></a><span id="l101.193">                     case calICalendar.ITEM_FILTER_COMPLETED_YES:</span>
<a href="#l101.194"></a><span id="l101.194">                         if (!item.isCompleted) {</span>
<a href="#l101.195"></a><span id="l101.195">                             item = null;</span>
<a href="#l101.196"></a><span id="l101.196">                         }</span>
<a href="#l101.197"></a><span id="l101.197">                         break;</span>
<a href="#l101.198"></a><span id="l101.198">                     case calICalendar.ITEM_FILTER_COMPLETED_NO:</span>
<a href="#l101.199"></a><span id="l101.199" class="difflineat">@@ -893,39 +894,39 @@ calWcapCalendar.prototype.parseItems = f</span>
<a href="#l101.200"></a><span id="l101.200">                         &quot;\nrid=&quot; + getIcalUTC(rid) +</span>
<a href="#l101.201"></a><span id="l101.201">                         &quot;\nitem.id=&quot; + item.id, this);</span>
<a href="#l101.202"></a><span id="l101.202">                 }</span>
<a href="#l101.203"></a><span id="l101.203">                 excItems.push(item);</span>
<a href="#l101.204"></a><span id="l101.204">             } else if (item.recurrenceInfo) {</span>
<a href="#l101.205"></a><span id="l101.205">                 unexpandedItems.push(item);</span>
<a href="#l101.206"></a><span id="l101.206">                 uid2parent[item.id] = item;</span>
<a href="#l101.207"></a><span id="l101.207">             } else if ((maxResults == 0 || items.length &lt; maxResults) &amp;&amp;</span>
<a href="#l101.208"></a><span id="l101.208" class="difflineminus">-                       checkIfInRange(item, rangeStart, rangeEnd)) {</span>
<a href="#l101.209"></a><span id="l101.209" class="difflineplus">+                       cal.checkIfInRange(item, rangeStart, rangeEnd)) {</span>
<a href="#l101.210"></a><span id="l101.210">                 if (LOG_LEVEL &gt; 2) {</span>
<a href="#l101.211"></a><span id="l101.211">                     log(&quot;item: &quot; + item.title + &quot;\n&quot; + item.icalString, this);</span>
<a href="#l101.212"></a><span id="l101.212">                 }</span>
<a href="#l101.213"></a><span id="l101.213">                 if (!bLeaveMutable) {</span>
<a href="#l101.214"></a><span id="l101.214">                     item.makeImmutable();</span>
<a href="#l101.215"></a><span id="l101.215">                 }</span>
<a href="#l101.216"></a><span id="l101.216">                 items.push(item);</span>
<a href="#l101.217"></a><span id="l101.217">             }</span>
<a href="#l101.218"></a><span id="l101.218">         }</span>
<a href="#l101.219"></a><span id="l101.219">     }</span>
<a href="#l101.220"></a><span id="l101.220"> </span>
<a href="#l101.221"></a><span id="l101.221">     // tag &quot;exceptions&quot;, i.e. items with rid:</span>
<a href="#l101.222"></a><span id="l101.222">     for (let item of excItems) {</span>
<a href="#l101.223"></a><span id="l101.223">         let parent = uid2parent[item.id];</span>
<a href="#l101.224"></a><span id="l101.224"> </span>
<a href="#l101.225"></a><span id="l101.225">         if (!parent) { // a parentless one, fake a master and override it's occurrence</span>
<a href="#l101.226"></a><span id="l101.226" class="difflineminus">-            parent = isEvent(item) ? createEvent() : createTodo();</span>
<a href="#l101.227"></a><span id="l101.227" class="difflineplus">+            parent = cal.isEvent(item) ? cal.createEvent() : cal.createTodo();</span>
<a href="#l101.228"></a><span id="l101.228">             parent.id = item.id;</span>
<a href="#l101.229"></a><span id="l101.229">             parent.calendar = this.superCalendar;</span>
<a href="#l101.230"></a><span id="l101.230">             parent.setProperty(&quot;DTSTART&quot;, item.recurrenceId);</span>
<a href="#l101.231"></a><span id="l101.231">             parent.setProperty(&quot;X-MOZ-FAKED-MASTER&quot;, &quot;1&quot;); // this tag might be useful in the future</span>
<a href="#l101.232"></a><span id="l101.232" class="difflineminus">-            parent.recurrenceInfo = createRecurrenceInfo(parent);</span>
<a href="#l101.233"></a><span id="l101.233" class="difflineplus">+            parent.recurrenceInfo = cal.createRecurrenceInfo(parent);</span>
<a href="#l101.234"></a><span id="l101.234">             fakedParents[item.id] = true;</span>
<a href="#l101.235"></a><span id="l101.235">             uid2parent[item.id] = parent;</span>
<a href="#l101.236"></a><span id="l101.236">             items.push(parent);</span>
<a href="#l101.237"></a><span id="l101.237">         }</span>
<a href="#l101.238"></a><span id="l101.238">         if (item.id in fakedParents) {</span>
<a href="#l101.239"></a><span id="l101.239">             let rdate = Components.classes[&quot;@mozilla.org/calendar/recurrence-date;1&quot;]</span>
<a href="#l101.240"></a><span id="l101.240">                                   .createInstance(Components.interfaces.calIRecurrenceDate);</span>
<a href="#l101.241"></a><span id="l101.241">             rdate.date = item.recurrenceId;</span>
<a href="#l101.242"></a><span id="l101.242" class="difflineat">@@ -1117,18 +1118,18 @@ function getItemFilterParams(itemFilter)</span>
<a href="#l101.243"></a><span id="l101.243">     //         compstate += &quot;;REQUEST-WAITFORREPLY&quot;;</span>
<a href="#l101.244"></a><span id="l101.244">     if (compstate.length &gt; 0) {</span>
<a href="#l101.245"></a><span id="l101.245">         params += &quot;&amp;compstate=&quot; + compstate.substr(1);</span>
<a href="#l101.246"></a><span id="l101.246">     }</span>
<a href="#l101.247"></a><span id="l101.247">     return params;</span>
<a href="#l101.248"></a><span id="l101.248"> }</span>
<a href="#l101.249"></a><span id="l101.249"> </span>
<a href="#l101.250"></a><span id="l101.250"> calWcapCalendar.prototype.getItems = function(itemFilter, maxResults, rangeStart, rangeEnd, listener) {</span>
<a href="#l101.251"></a><span id="l101.251" class="difflineminus">-    rangeStart = ensureDateTime(rangeStart);</span>
<a href="#l101.252"></a><span id="l101.252" class="difflineminus">-    rangeEnd = ensureDateTime(rangeEnd);</span>
<a href="#l101.253"></a><span id="l101.253" class="difflineplus">+    rangeStart = cal.ensureDateTime(rangeStart);</span>
<a href="#l101.254"></a><span id="l101.254" class="difflineplus">+    rangeEnd = cal.ensureDateTime(rangeEnd);</span>
<a href="#l101.255"></a><span id="l101.255">     let zRangeStart = getIcalUTC(rangeStart);</span>
<a href="#l101.256"></a><span id="l101.256">     let zRangeEnd = getIcalUTC(rangeEnd);</span>
<a href="#l101.257"></a><span id="l101.257"> </span>
<a href="#l101.258"></a><span id="l101.258">     let request = new calWcapRequest(</span>
<a href="#l101.259"></a><span id="l101.259">         (oprequest, err, data) =&gt; {</span>
<a href="#l101.260"></a><span id="l101.260">             log(&quot;getItems() complete: &quot; + errorToString(err), this);</span>
<a href="#l101.261"></a><span id="l101.261">             this.notifyOperationComplete(listener,</span>
<a href="#l101.262"></a><span id="l101.262">                                          getResultCode(err),</span>
<a href="#l101.263"></a><span id="l101.263" class="difflineat">@@ -1193,17 +1194,17 @@ calWcapCalendar.prototype.getItems = fun</span>
<a href="#l101.264"></a><span id="l101.264">                             rangeStart &amp;&amp; rangeEnd) {</span>
<a href="#l101.265"></a><span id="l101.265">                             let freeBusyListener = { // calIGenericOperationListener:</span>
<a href="#l101.266"></a><span id="l101.266">                                 onResult: function(oprequest, result) {</span>
<a href="#l101.267"></a><span id="l101.267">                                     if (!Components.isSuccessCode(oprequest.status)) {</span>
<a href="#l101.268"></a><span id="l101.268">                                         throw oprequest.status;</span>
<a href="#l101.269"></a><span id="l101.269">                                     }</span>
<a href="#l101.270"></a><span id="l101.270">                                     let items = [];</span>
<a href="#l101.271"></a><span id="l101.271">                                     for (let entry of result) {</span>
<a href="#l101.272"></a><span id="l101.272" class="difflineminus">-                                        let item = createEvent();</span>
<a href="#l101.273"></a><span id="l101.273" class="difflineplus">+                                        let item = cal.createEvent();</span>
<a href="#l101.274"></a><span id="l101.274">                                         item.id = g_busyPhantomItemUuidPrefix + getIcalUTC(entry.interval.start);</span>
<a href="#l101.275"></a><span id="l101.275">                                         item.calendar = this.superCalendar;</span>
<a href="#l101.276"></a><span id="l101.276">                                         item.title = g_busyItemTitle;</span>
<a href="#l101.277"></a><span id="l101.277">                                         item.startDate = entry.interval.start;</span>
<a href="#l101.278"></a><span id="l101.278">                                         item.endDate = entry.interval.end;</span>
<a href="#l101.279"></a><span id="l101.279">                                         item.makeImmutable();</span>
<a href="#l101.280"></a><span id="l101.280">                                         items.push(item);</span>
<a href="#l101.281"></a><span id="l101.281">                                     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l102.1"></a><span id="l102.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapCalendarModule.js</span>
<a href="#l102.2"></a><span id="l102.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapCalendarModule.js</span>
<a href="#l102.3"></a><span id="l102.3" class="difflineat">@@ -63,17 +63,16 @@ function initWcapProvider() {</span>
<a href="#l102.4"></a><span id="l102.4">         CACHE_LAST_RESULTS_INVALIDATE = Preferences.get(&quot;calendar.wcap.cache_last_results_invalidate&quot;, 120);</span>
<a href="#l102.5"></a><span id="l102.5">     } catch (exc) {</span>
<a href="#l102.6"></a><span id="l102.6">         logError(exc, &quot;error in init sequence&quot;);</span>
<a href="#l102.7"></a><span id="l102.7">     }</span>
<a href="#l102.8"></a><span id="l102.8"> }</span>
<a href="#l102.9"></a><span id="l102.9"> </span>
<a href="#l102.10"></a><span id="l102.10"> /** Module Registration */</span>
<a href="#l102.11"></a><span id="l102.11"> var scriptLoadOrder = [</span>
<a href="#l102.12"></a><span id="l102.12" class="difflineminus">-    &quot;calUtils.js&quot;,</span>
<a href="#l102.13"></a><span id="l102.13">     &quot;calWcapUtils.js&quot;,</span>
<a href="#l102.14"></a><span id="l102.14">     &quot;calWcapErrors.js&quot;,</span>
<a href="#l102.15"></a><span id="l102.15">     &quot;calWcapRequest.js&quot;,</span>
<a href="#l102.16"></a><span id="l102.16">     &quot;calWcapSession.js&quot;,</span>
<a href="#l102.17"></a><span id="l102.17">     &quot;calWcapCalendar.js&quot;,</span>
<a href="#l102.18"></a><span id="l102.18">     &quot;calWcapCalendarItems.js&quot;</span>
<a href="#l102.19"></a><span id="l102.19"> ];</span>
<a href="#l102.20"></a><span id="l102.20"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l103.1"></a><span id="l103.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapErrors.js</span>
<a href="#l103.2"></a><span id="l103.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapErrors.js</span>
<a href="#l103.3"></a><span id="l103.3" class="difflineat">@@ -1,16 +1,18 @@</span>
<a href="#l103.4"></a><span id="l103.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l103.5"></a><span id="l103.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l103.6"></a><span id="l103.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l103.7"></a><span id="l103.7"> </span>
<a href="#l103.8"></a><span id="l103.8"> /* exported checkErrorCode, checkWcapXmlErrno, checkWcapIcalErrno,</span>
<a href="#l103.9"></a><span id="l103.9">  *          errorToString</span>
<a href="#l103.10"></a><span id="l103.10">  */</span>
<a href="#l103.11"></a><span id="l103.11"> </span>
<a href="#l103.12"></a><span id="l103.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l103.13"></a><span id="l103.13" class="difflineplus">+</span>
<a href="#l103.14"></a><span id="l103.14"> var NS_ERROR_INVALID_ARG = Components.results.NS_ERROR_INVALID_ARG;</span>
<a href="#l103.15"></a><span id="l103.15"> </span>
<a href="#l103.16"></a><span id="l103.16"> //</span>
<a href="#l103.17"></a><span id="l103.17"> // Common netwerk errors:</span>
<a href="#l103.18"></a><span id="l103.18"> //</span>
<a href="#l103.19"></a><span id="l103.19"> var NS_ERROR_MODULE_BASE_OFFSET = 0x45;</span>
<a href="#l103.20"></a><span id="l103.20"> var NS_ERROR_MODULE_NETWORK = 6;</span>
<a href="#l103.21"></a><span id="l103.21"> </span>
<a href="#l103.22"></a><span id="l103.22" class="difflineat">@@ -121,17 +123,17 @@ function netErrorToString(rc) {</span>
<a href="#l103.23"></a><span id="l103.23"> </span>
<a href="#l103.24"></a><span id="l103.24"> //</span>
<a href="#l103.25"></a><span id="l103.25"> // WCAP error handling helpers</span>
<a href="#l103.26"></a><span id="l103.26"> //</span>
<a href="#l103.27"></a><span id="l103.27"> </span>
<a href="#l103.28"></a><span id="l103.28"> var g_wcapErrorCodes = [</span>
<a href="#l103.29"></a><span id="l103.29">     /* -1 */ NS_OK, &quot;Logout successful.&quot;,</span>
<a href="#l103.30"></a><span id="l103.30">     /*  0 */ NS_OK, &quot;Command successful.&quot;,</span>
<a href="#l103.31"></a><span id="l103.31" class="difflineminus">-    /*  1 */ calIWcapErrors.WCAP_LOGIN_FAILED, calGetString(&quot;wcap&quot;, &quot;loginFailed.text&quot;),</span>
<a href="#l103.32"></a><span id="l103.32" class="difflineplus">+    /*  1 */ calIWcapErrors.WCAP_LOGIN_FAILED, cal.calGetString(&quot;wcap&quot;, &quot;loginFailed.text&quot;),</span>
<a href="#l103.33"></a><span id="l103.33">     /*  2 */ calIWcapErrors.WCAP_LOGIN_OK_DEFAULT_CALENDAR_NOT_FOUND, &quot;login.wcap was successful, but the default calendar for this user was not found. A new default calendar set to the userid was created.&quot;,</span>
<a href="#l103.34"></a><span id="l103.34">     /*  3 */ NS_ERROR_INVALID_ARG, &quot;No WCAP error code.&quot;,</span>
<a href="#l103.35"></a><span id="l103.35">     /*  4 */ NS_ERROR_INVALID_ARG, &quot;No WCAP error code.&quot;,</span>
<a href="#l103.36"></a><span id="l103.36">     /*  5 */ NS_ERROR_INVALID_ARG, &quot;No WCAP error code.&quot;,</span>
<a href="#l103.37"></a><span id="l103.37">     /*  6 */ calIWcapErrors.WCAP_DELETE_EVENTS_BY_ID_FAILED, &quot;WCAP_DELETE_EVENTS_BY_ID_FAILED&quot;,</span>
<a href="#l103.38"></a><span id="l103.38">     /*  7 */ NS_ERROR_INVALID_ARG, &quot;No WCAP error code.&quot;,</span>
<a href="#l103.39"></a><span id="l103.39">     /*  8 */ calIWcapErrors.WCAP_SETCALPROPS_FAILED, &quot;WCAP_SETCALPROPS_FAILED&quot;,</span>
<a href="#l103.40"></a><span id="l103.40">     /*  9 */ calIWcapErrors.WCAP_FETCH_EVENTS_BY_ID_FAILED, &quot;WCAP_FETCH_EVENTS_BY_ID_FAILED&quot;,</span>
<a href="#l103.41"></a><span id="l103.41" class="difflineat">@@ -148,17 +150,17 @@ var g_wcapErrorCodes = [</span>
<a href="#l103.42"></a><span id="l103.42">     /* 20 */ calIWcapErrors.WCAP_GET_CALPROPS_FAILED, &quot;WCAP_GET_CALPROPS_FAILED&quot;,</span>
<a href="#l103.43"></a><span id="l103.43">     /* 21 */ calIWcapErrors.WCAP_DELETECOMPONENTS_BY_RANGE_FAILED, &quot;WCAP_DELETECOMPONENTS_BY_RANGE_FAILED&quot;,</span>
<a href="#l103.44"></a><span id="l103.44">     /* 22 */ calIWcapErrors.WCAP_DELETEEVENTS_BY_RANGE_FAILED, &quot;WCAP_DELETEEVENTS_BY_RANGE_FAILED&quot;,</span>
<a href="#l103.45"></a><span id="l103.45">     /* 23 */ calIWcapErrors.WCAP_DELETETODOS_BY_RANGE_FAILED, &quot;WCAP_DELETETODOS_BY_RANGE_FAILED&quot;,</span>
<a href="#l103.46"></a><span id="l103.46">     /* 24 */ calIWcapErrors.WCAP_GET_ALL_TIMEZONES_FAILED, &quot;WCAP_GET_ALL_TIMEZONES_FAILED&quot;,</span>
<a href="#l103.47"></a><span id="l103.47">     /* 25 */ calIWcapErrors.WCAP_CREATECALENDAR_ALREADY_EXISTS_FAILED, &quot;The command createcalendar.wcap failed. A calendar with that name already exists in the database.&quot;,</span>
<a href="#l103.48"></a><span id="l103.48">     /* 26 */ calIWcapErrors.WCAP_SET_USERPREFS_FAILED, &quot;WCAP_SET_USERPREFS_FAILED&quot;,</span>
<a href="#l103.49"></a><span id="l103.49">     /* 27 */ calIWcapErrors.WCAP_CHANGE_PASSWORD_FAILED, &quot;WCAP_CHANGE_PASSWORD_FAILED&quot;,</span>
<a href="#l103.50"></a><span id="l103.50" class="difflineminus">-    /* 28 */ calIWcapErrors.WCAP_ACCESS_DENIED_TO_CALENDAR, calGetString(&quot;wcap&quot;, &quot;accessDenied.text&quot;),</span>
<a href="#l103.51"></a><span id="l103.51" class="difflineplus">+    /* 28 */ calIWcapErrors.WCAP_ACCESS_DENIED_TO_CALENDAR, cal.calGetString(&quot;wcap&quot;, &quot;accessDenied.text&quot;),</span>
<a href="#l103.52"></a><span id="l103.52">     /* 29 */ calIWcapErrors.WCAP_CALENDAR_DOES_NOT_EXIST, &quot;Command failed. The requested calendar does not exist in the database.&quot;,</span>
<a href="#l103.53"></a><span id="l103.53">     /* 30 */ calIWcapErrors.WCAP_ILLEGAL_CALID_NAME, &quot;createcalendar.wcap failed. Invalid calid passed in.&quot;,</span>
<a href="#l103.54"></a><span id="l103.54">     /* 31 */ calIWcapErrors.WCAP_CANNOT_MODIFY_LINKED_EVENTS, &quot;storeevents.wcap failed. The event to modify was a linked event.&quot;,</span>
<a href="#l103.55"></a><span id="l103.55">     /* 32 */ calIWcapErrors.WCAP_CANNOT_MODIFY_LINKED_TODOS, &quot;storetodos.wcap failed. The todo to modify was a linked todo.&quot;,</span>
<a href="#l103.56"></a><span id="l103.56">     /* 33 */ calIWcapErrors.WCAP_CANNOT_SENT_EMAIL, &quot;Command failed. Email notification failed. Usually caused by the server not being properly configured to send email. This can occur in storeevents.wcap, storetodos.wcap, deleteevents_by_id.wcap, deletetodos_by_id.wcap.&quot;,</span>
<a href="#l103.57"></a><span id="l103.57">     /* 34 */ calIWcapErrors.WCAP_CALENDAR_DISABLED, &quot;Command failed. The calendar is disabled in the database.&quot;,</span>
<a href="#l103.58"></a><span id="l103.58">     /* 35 */ calIWcapErrors.WCAP_WRITE_IMPORT_FAILED, &quot;Import failed when writing files to the server.&quot;,</span>
<a href="#l103.59"></a><span id="l103.59">     /* 36 */ calIWcapErrors.WCAP_FETCH_BY_LAST_MODIFIED_FAILED, &quot;WCAP_FETCH_BY_LAST_MODIFIED_FAILED&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l104.1"></a><span id="l104.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapRequest.js</span>
<a href="#l104.2"></a><span id="l104.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapRequest.js</span>
<a href="#l104.3"></a><span id="l104.3" class="difflineat">@@ -16,16 +16,17 @@</span>
<a href="#l104.4"></a><span id="l104.4">    - some data (incl null/undefined) which is the result of the async function,</span>
<a href="#l104.5"></a><span id="l104.5">      indicating that there is no further continuation</span>
<a href="#l104.6"></a><span id="l104.6"> */</span>
<a href="#l104.7"></a><span id="l104.7"> </span>
<a href="#l104.8"></a><span id="l104.8"> /* exported issueNetworkRequest, getWcapRequestStatusString, stringToIcal, stringToXml */</span>
<a href="#l104.9"></a><span id="l104.9"> </span>
<a href="#l104.10"></a><span id="l104.10"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l104.11"></a><span id="l104.11"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l104.12"></a><span id="l104.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l104.13"></a><span id="l104.13"> </span>
<a href="#l104.14"></a><span id="l104.14"> function generateRequestId() {</span>
<a href="#l104.15"></a><span id="l104.15">     if (!generateRequestId.mRequestPrefix) {</span>
<a href="#l104.16"></a><span id="l104.16">         generateRequestId.mRequestPrefix = cal.getUUID() + &quot;-&quot;;</span>
<a href="#l104.17"></a><span id="l104.17">         generateRequestId.mRequestId = 0;</span>
<a href="#l104.18"></a><span id="l104.18">     }</span>
<a href="#l104.19"></a><span id="l104.19">     ++generateRequestId.mRequestId;</span>
<a href="#l104.20"></a><span id="l104.20">     return generateRequestId.mRequestPrefix + generateRequestId.mRequestId;</span>
<a href="#l104.21"></a><span id="l104.21" class="difflineat">@@ -433,17 +434,17 @@ function getWcapRequestStatusString(xml)</span>
<a href="#l104.22"></a><span id="l104.22"> </span>
<a href="#l104.23"></a><span id="l104.23"> function stringToIcal(session, data, expectedErrno) {</span>
<a href="#l104.24"></a><span id="l104.24">     if (!data || data.length == 0) { // assuming time-out; WTF.</span>
<a href="#l104.25"></a><span id="l104.25">         throw new Components.Exception(errorToString(calIWcapErrors.WCAP_LOGIN_FAILED),</span>
<a href="#l104.26"></a><span id="l104.26">                                        calIWcapErrors.WCAP_LOGIN_FAILED);</span>
<a href="#l104.27"></a><span id="l104.27">     }</span>
<a href="#l104.28"></a><span id="l104.28">     let icalRootComp;</span>
<a href="#l104.29"></a><span id="l104.29">     try {</span>
<a href="#l104.30"></a><span id="l104.30" class="difflineminus">-        icalRootComp = getIcsService().parseICS(data, session /* implements calITimezoneProvider */);</span>
<a href="#l104.31"></a><span id="l104.31" class="difflineplus">+        icalRootComp = cal.getIcsService().parseICS(data, session /* implements calITimezoneProvider */);</span>
<a href="#l104.32"></a><span id="l104.32">     } catch (exc) { // map into more useful error string:</span>
<a href="#l104.33"></a><span id="l104.33">         throw new Components.Exception(&quot;error parsing ical data!&quot;, calIErrors.ICS_PARSE);</span>
<a href="#l104.34"></a><span id="l104.34">     }</span>
<a href="#l104.35"></a><span id="l104.35">     checkWcapIcalErrno(icalRootComp, expectedErrno);</span>
<a href="#l104.36"></a><span id="l104.36">     return icalRootComp;</span>
<a href="#l104.37"></a><span id="l104.37"> }</span>
<a href="#l104.38"></a><span id="l104.38"> </span>
<a href="#l104.39"></a><span id="l104.39"> function stringToXml(session, data, expectedErrno) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l105.1"></a><span id="l105.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapSession.js</span>
<a href="#l105.2"></a><span id="l105.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapSession.js</span>
<a href="#l105.3"></a><span id="l105.3" class="difflineat">@@ -148,32 +148,32 @@ calWcapSession.prototype = {</span>
<a href="#l105.4"></a><span id="l105.4">         let tzids = [];</span>
<a href="#l105.5"></a><span id="l105.5">         for (let tzid in this.m_serverTimezones) {</span>
<a href="#l105.6"></a><span id="l105.6">             tzids.push(tzid);</span>
<a href="#l105.7"></a><span id="l105.7">         }</span>
<a href="#l105.8"></a><span id="l105.8">         return { // nsIUTF8StringEnumerator:</span>
<a href="#l105.9"></a><span id="l105.9">             m_index: 0,</span>
<a href="#l105.10"></a><span id="l105.10">             getNext: function() {</span>
<a href="#l105.11"></a><span id="l105.11">                 if (this.m_index &gt;= tzids) {</span>
<a href="#l105.12"></a><span id="l105.12" class="difflineminus">-                    ASSERT(false, &quot;calWcapSession::timezoneIds enumerator!&quot;);</span>
<a href="#l105.13"></a><span id="l105.13" class="difflineplus">+                    cal.ASSERT(false, &quot;calWcapSession::timezoneIds enumerator!&quot;);</span>
<a href="#l105.14"></a><span id="l105.14">                     throw Components.results.NS_ERROR_UNEXPECTED;</span>
<a href="#l105.15"></a><span id="l105.15">                 }</span>
<a href="#l105.16"></a><span id="l105.16">                 return tzids[this.m_index++];</span>
<a href="#l105.17"></a><span id="l105.17">             },</span>
<a href="#l105.18"></a><span id="l105.18">             hasMore: function() {</span>
<a href="#l105.19"></a><span id="l105.19">                 return (this.m_index &lt; tzids.length);</span>
<a href="#l105.20"></a><span id="l105.20">             }</span>
<a href="#l105.21"></a><span id="l105.21">         };</span>
<a href="#l105.22"></a><span id="l105.22">     },</span>
<a href="#l105.23"></a><span id="l105.23">     getTimezone: function(tzid) {</span>
<a href="#l105.24"></a><span id="l105.24">         switch (tzid) {</span>
<a href="#l105.25"></a><span id="l105.25">             case &quot;floating&quot;:</span>
<a href="#l105.26"></a><span id="l105.26" class="difflineminus">-                return floating();</span>
<a href="#l105.27"></a><span id="l105.27" class="difflineplus">+                return cal.floating();</span>
<a href="#l105.28"></a><span id="l105.28">             case &quot;UTC&quot;:</span>
<a href="#l105.29"></a><span id="l105.29" class="difflineminus">-                return UTC();</span>
<a href="#l105.30"></a><span id="l105.30" class="difflineplus">+                return cal.UTC();</span>
<a href="#l105.31"></a><span id="l105.31">             default:</span>
<a href="#l105.32"></a><span id="l105.32">                 if (this.m_serverTimezones) {</span>
<a href="#l105.33"></a><span id="l105.33">                     return this.m_serverTimezones[tzid];</span>
<a href="#l105.34"></a><span id="l105.34">                 }</span>
<a href="#l105.35"></a><span id="l105.35">                 return null;</span>
<a href="#l105.36"></a><span id="l105.36">         }</span>
<a href="#l105.37"></a><span id="l105.37">     },</span>
<a href="#l105.38"></a><span id="l105.38"> </span>
<a href="#l105.39"></a><span id="l105.39" class="difflineat">@@ -211,27 +211,27 @@ calWcapSession.prototype = {</span>
<a href="#l105.40"></a><span id="l105.40">             }</span>
<a href="#l105.41"></a><span id="l105.41"> </span>
<a href="#l105.42"></a><span id="l105.42">             this.m_loginLock = true;</span>
<a href="#l105.43"></a><span id="l105.43">             log(&quot;locked login queue.&quot;, this);</span>
<a href="#l105.44"></a><span id="l105.44">             this.m_sessionId = null; // invalidate for relogin</span>
<a href="#l105.45"></a><span id="l105.45"> </span>
<a href="#l105.46"></a><span id="l105.46">             if (timedOutSessionId) {</span>
<a href="#l105.47"></a><span id="l105.47">                 log(&quot;reconnecting due to session timeout...&quot;, this);</span>
<a href="#l105.48"></a><span id="l105.48" class="difflineminus">-                getFreeBusyService().removeProvider(this);</span>
<a href="#l105.49"></a><span id="l105.49" class="difflineminus">-                getCalendarSearchService().removeProvider(this);</span>
<a href="#l105.50"></a><span id="l105.50" class="difflineplus">+                cal.getFreeBusyService().removeProvider(this);</span>
<a href="#l105.51"></a><span id="l105.51" class="difflineplus">+                cal.getCalendarSearchService().removeProvider(this);</span>
<a href="#l105.52"></a><span id="l105.52">             }</span>
<a href="#l105.53"></a><span id="l105.53"> </span>
<a href="#l105.54"></a><span id="l105.54">             this.getSessionId_(null, // don't couple to parent request parent may be cancelled</span>
<a href="#l105.55"></a><span id="l105.55">                                (err, sessionId) =&gt; {</span>
<a href="#l105.56"></a><span id="l105.56">                                    log(&quot;getSessionId_resp_(): &quot; + sessionId, this);</span>
<a href="#l105.57"></a><span id="l105.57">                                    if (!err) {</span>
<a href="#l105.58"></a><span id="l105.58">                                        this.m_sessionId = sessionId;</span>
<a href="#l105.59"></a><span id="l105.59" class="difflineminus">-                                       getFreeBusyService().addProvider(this);</span>
<a href="#l105.60"></a><span id="l105.60" class="difflineminus">-                                       getCalendarSearchService().addProvider(this);</span>
<a href="#l105.61"></a><span id="l105.61" class="difflineplus">+                                       cal.getFreeBusyService().addProvider(this);</span>
<a href="#l105.62"></a><span id="l105.62" class="difflineplus">+                                       cal.getCalendarSearchService().addProvider(this);</span>
<a href="#l105.63"></a><span id="l105.63">                                    }</span>
<a href="#l105.64"></a><span id="l105.64"> </span>
<a href="#l105.65"></a><span id="l105.65">                                    let queue = this.m_loginQueue;</span>
<a href="#l105.66"></a><span id="l105.66">                                    this.m_loginLock = false;</span>
<a href="#l105.67"></a><span id="l105.67">                                    this.m_loginQueue = [];</span>
<a href="#l105.68"></a><span id="l105.68">                                    log(&quot;unlocked login queue.&quot;, this);</span>
<a href="#l105.69"></a><span id="l105.69"> </span>
<a href="#l105.70"></a><span id="l105.70">                                    let getSessionId_exec = (func) =&gt; {</span>
<a href="#l105.71"></a><span id="l105.71" class="difflineat">@@ -382,18 +382,18 @@ calWcapSession.prototype = {</span>
<a href="#l105.72"></a><span id="l105.72">         if (this.m_sessionId) {</span>
<a href="#l105.73"></a><span id="l105.73">             log(&quot;attempting to log out...&quot;, this);</span>
<a href="#l105.74"></a><span id="l105.74">             // although io service's offline flag is already</span>
<a href="#l105.75"></a><span id="l105.75">             // set BEFORE notification</span>
<a href="#l105.76"></a><span id="l105.76">             // (about to go offline, nsIOService.cpp).</span>
<a href="#l105.77"></a><span id="l105.77">             // WTF.</span>
<a href="#l105.78"></a><span id="l105.78">             url = (this.sessionUri.spec + &quot;logout.wcap?fmt-out=text%2Fxml&amp;id=&quot; + this.m_sessionId);</span>
<a href="#l105.79"></a><span id="l105.79">             this.m_sessionId = null;</span>
<a href="#l105.80"></a><span id="l105.80" class="difflineminus">-            getFreeBusyService().removeProvider(this);</span>
<a href="#l105.81"></a><span id="l105.81" class="difflineminus">-            getCalendarSearchService().removeProvider(this);</span>
<a href="#l105.82"></a><span id="l105.82" class="difflineplus">+            cal.getFreeBusyService().removeProvider(this);</span>
<a href="#l105.83"></a><span id="l105.83" class="difflineplus">+            cal.getCalendarSearchService().removeProvider(this);</span>
<a href="#l105.84"></a><span id="l105.84">         }</span>
<a href="#l105.85"></a><span id="l105.85">         this.m_credentials = null;</span>
<a href="#l105.86"></a><span id="l105.86"> </span>
<a href="#l105.87"></a><span id="l105.87">         if (url) {</span>
<a href="#l105.88"></a><span id="l105.88">             issueNetworkRequest(request,</span>
<a href="#l105.89"></a><span id="l105.89">                                 (err, str) =&gt; {</span>
<a href="#l105.90"></a><span id="l105.90">                                     if (err) {</span>
<a href="#l105.91"></a><span id="l105.91">                                         throw err;</span>
<a href="#l105.92"></a><span id="l105.92" class="difflineat">@@ -920,18 +920,18 @@ calWcapSession.prototype = {</span>
<a href="#l105.93"></a><span id="l105.93">         } catch (exc) {</span>
<a href="#l105.94"></a><span id="l105.94">             request.execRespFunc(exc);</span>
<a href="#l105.95"></a><span id="l105.95">         }</span>
<a href="#l105.96"></a><span id="l105.96">         return request;</span>
<a href="#l105.97"></a><span id="l105.97">     },</span>
<a href="#l105.98"></a><span id="l105.98"> </span>
<a href="#l105.99"></a><span id="l105.99">     // calIFreeBusyProvider:</span>
<a href="#l105.100"></a><span id="l105.100">     getFreeBusyIntervals: function(calId, rangeStart, rangeEnd, busyTypes, listener) {</span>
<a href="#l105.101"></a><span id="l105.101" class="difflineminus">-        rangeStart = ensureDateTime(rangeStart);</span>
<a href="#l105.102"></a><span id="l105.102" class="difflineminus">-        rangeEnd = ensureDateTime(rangeEnd);</span>
<a href="#l105.103"></a><span id="l105.103" class="difflineplus">+        rangeStart = cal.ensureDateTime(rangeStart);</span>
<a href="#l105.104"></a><span id="l105.104" class="difflineplus">+        rangeEnd = cal.ensureDateTime(rangeEnd);</span>
<a href="#l105.105"></a><span id="l105.105">         let zRangeStart = getIcalUTC(rangeStart);</span>
<a href="#l105.106"></a><span id="l105.106">         let zRangeEnd = getIcalUTC(rangeEnd);</span>
<a href="#l105.107"></a><span id="l105.107"> </span>
<a href="#l105.108"></a><span id="l105.108">         let request = new calWcapRequest(</span>
<a href="#l105.109"></a><span id="l105.109">             (oprequest, err, data) =&gt; {</span>
<a href="#l105.110"></a><span id="l105.110">                 let rc = getResultCode(err);</span>
<a href="#l105.111"></a><span id="l105.111">                 switch (rc) {</span>
<a href="#l105.112"></a><span id="l105.112">                     case calIWcapErrors.WCAP_NO_ERRNO: // workaround</span>
<a href="#l105.113"></a><span id="l105.113" class="difflineat">@@ -1064,18 +1064,18 @@ calWcapSession.prototype = {</span>
<a href="#l105.114"></a><span id="l105.114"> </span>
<a href="#l105.115"></a><span id="l105.115">     // called before the unregister actually takes place</span>
<a href="#l105.116"></a><span id="l105.116">     onCalendarUnregistering: function(aCalendar) {</span>
<a href="#l105.117"></a><span id="l105.117">         try {</span>
<a href="#l105.118"></a><span id="l105.118">             // make sure the calendar belongs to this session and is the default calendar,</span>
<a href="#l105.119"></a><span id="l105.119">             // then remove all subscribed calendars:</span>
<a href="#l105.120"></a><span id="l105.120">             aCalendar = this.belongsTo(aCalendar);</span>
<a href="#l105.121"></a><span id="l105.121">             if (aCalendar &amp;&amp; aCalendar.isDefaultCalendar) {</span>
<a href="#l105.122"></a><span id="l105.122" class="difflineminus">-                getFreeBusyService().removeProvider(this);</span>
<a href="#l105.123"></a><span id="l105.123" class="difflineminus">-                getCalendarSearchService().removeProvider(this);</span>
<a href="#l105.124"></a><span id="l105.124" class="difflineplus">+                cal.getFreeBusyService().removeProvider(this);</span>
<a href="#l105.125"></a><span id="l105.125" class="difflineplus">+                cal.getCalendarSearchService().removeProvider(this);</span>
<a href="#l105.126"></a><span id="l105.126">                 let registeredCalendars = this.getRegisteredCalendars();</span>
<a href="#l105.127"></a><span id="l105.127">                 for (let regCal of registeredCalendars) {</span>
<a href="#l105.128"></a><span id="l105.128">                     try {</span>
<a href="#l105.129"></a><span id="l105.129">                         if (!regCal.isDefaultCalendar) {</span>
<a href="#l105.130"></a><span id="l105.130">                             cal.getCalendarManager().unregisterCalendar(regCal);</span>
<a href="#l105.131"></a><span id="l105.131">                         }</span>
<a href="#l105.132"></a><span id="l105.132">                     } catch (exc) {</span>
<a href="#l105.133"></a><span id="l105.133">                         this.notifyError(exc);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l106.1"></a><span id="l106.1" class="difflineminus">--- a/calendar/providers/wcap/calWcapUtils.js</span>
<a href="#l106.2"></a><span id="l106.2" class="difflineplus">+++ b/calendar/providers/wcap/calWcapUtils.js</span>
<a href="#l106.3"></a><span id="l106.3" class="difflineat">@@ -9,22 +9,22 @@</span>
<a href="#l106.4"></a><span id="l106.4"> Components.utils.import(&quot;resource://calendar/modules/calIteratorUtils.jsm&quot;);</span>
<a href="#l106.5"></a><span id="l106.5"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l106.6"></a><span id="l106.6"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l106.7"></a><span id="l106.7"> Components.utils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l106.8"></a><span id="l106.8"> </span>
<a href="#l106.9"></a><span id="l106.9"> var g_bShutdown = false;</span>
<a href="#l106.10"></a><span id="l106.10"> </span>
<a href="#l106.11"></a><span id="l106.11"> function initLogging() {</span>
<a href="#l106.12"></a><span id="l106.12" class="difflineminus">-    initLogging.mLogTimezone = calendarDefaultTimezone();</span>
<a href="#l106.13"></a><span id="l106.13" class="difflineplus">+    initLogging.mLogTimezone = cal.calendarDefaultTimezone();</span>
<a href="#l106.14"></a><span id="l106.14">     if (initLogging.mLogFilestream) {</span>
<a href="#l106.15"></a><span id="l106.15">         try {</span>
<a href="#l106.16"></a><span id="l106.16">             initLogging.mLogFilestream.close();</span>
<a href="#l106.17"></a><span id="l106.17">         } catch (exc) {</span>
<a href="#l106.18"></a><span id="l106.18" class="difflineminus">-            ASSERT(false, exc);</span>
<a href="#l106.19"></a><span id="l106.19" class="difflineplus">+            cal.ASSERT(false, exc);</span>
<a href="#l106.20"></a><span id="l106.20">         }</span>
<a href="#l106.21"></a><span id="l106.21">         initLogging.mLogFilestream = null;</span>
<a href="#l106.22"></a><span id="l106.22">     }</span>
<a href="#l106.23"></a><span id="l106.23"> </span>
<a href="#l106.24"></a><span id="l106.24">     LOG_LEVEL = getPref(&quot;calendar.wcap.log_level&quot;, 0);</span>
<a href="#l106.25"></a><span id="l106.25">     if (LOG_LEVEL &lt; 1 &amp;&amp; getPref(&quot;calendar.debug.log&quot;, false)) {</span>
<a href="#l106.26"></a><span id="l106.26">         LOG_LEVEL = 1; // at least basic logging when calendar.debug.log is set</span>
<a href="#l106.27"></a><span id="l106.27">     }</span>
<a href="#l106.28"></a><span id="l106.28" class="difflineat">@@ -130,17 +130,17 @@ function logWarning(err, context) {</span>
<a href="#l106.29"></a><span id="l106.29">                      Components.interfaces.nsIScriptError.warningFlag,</span>
<a href="#l106.30"></a><span id="l106.30">                      &quot;component javascript&quot;);</span>
<a href="#l106.31"></a><span id="l106.31">     Services.console.logMessage(scriptError);</span>
<a href="#l106.32"></a><span id="l106.32">     return msg;</span>
<a href="#l106.33"></a><span id="l106.33"> }</span>
<a href="#l106.34"></a><span id="l106.34"> </span>
<a href="#l106.35"></a><span id="l106.35"> function logError(err, context) {</span>
<a href="#l106.36"></a><span id="l106.36">     let msg = errorToString(err);</span>
<a href="#l106.37"></a><span id="l106.37" class="difflineminus">-    Components.utils.reportError(log(&quot;error: &quot; + msg + &quot;\nstack:\n&quot; + STACK(10), context, true));</span>
<a href="#l106.38"></a><span id="l106.38" class="difflineplus">+    Components.utils.reportError(log(&quot;error: &quot; + msg + &quot;\nstack:\n&quot; + cal.STACK(10), context, true));</span>
<a href="#l106.39"></a><span id="l106.39">     return msg;</span>
<a href="#l106.40"></a><span id="l106.40"> }</span>
<a href="#l106.41"></a><span id="l106.41"> </span>
<a href="#l106.42"></a><span id="l106.42"> // late-inited service accessors:</span>
<a href="#l106.43"></a><span id="l106.43"> </span>
<a href="#l106.44"></a><span id="l106.44"> function getCalendarSearchService() {</span>
<a href="#l106.45"></a><span id="l106.45">     if (!getCalendarSearchService.m_obj) {</span>
<a href="#l106.46"></a><span id="l106.46">         getCalendarSearchService.m_obj = Components.classes[&quot;@mozilla.org/calendar/calendarsearch-service;1&quot;]</span>
<a href="#l106.47"></a><span id="l106.47" class="difflineat">@@ -186,27 +186,27 @@ function getTime() {</span>
<a href="#l106.48"></a><span id="l106.48"> function getIcalUTC(date) {</span>
<a href="#l106.49"></a><span id="l106.49">     if (!date || !date.isValid) {</span>
<a href="#l106.50"></a><span id="l106.50">         return &quot;0&quot;;</span>
<a href="#l106.51"></a><span id="l106.51">     } else {</span>
<a href="#l106.52"></a><span id="l106.52">         let dtz = date.timezone;</span>
<a href="#l106.53"></a><span id="l106.53">         if (dtz.isUTC || dtz.isFloating) {</span>
<a href="#l106.54"></a><span id="l106.54">             return date.icalString;</span>
<a href="#l106.55"></a><span id="l106.55">         } else {</span>
<a href="#l106.56"></a><span id="l106.56" class="difflineminus">-            return date.getInTimezone(UTC()).icalString;</span>
<a href="#l106.57"></a><span id="l106.57" class="difflineplus">+            return date.getInTimezone(cal.UTC()).icalString;</span>
<a href="#l106.58"></a><span id="l106.58">         }</span>
<a href="#l106.59"></a><span id="l106.59">     }</span>
<a href="#l106.60"></a><span id="l106.60"> }</span>
<a href="#l106.61"></a><span id="l106.61"> </span>
<a href="#l106.62"></a><span id="l106.62"> function getDatetimeFromIcalString(val) {</span>
<a href="#l106.63"></a><span id="l106.63">     if (!val || val.length == 0 || val == &quot;0&quot;) {</span>
<a href="#l106.64"></a><span id="l106.64">         return null;</span>
<a href="#l106.65"></a><span id="l106.65">     }</span>
<a href="#l106.66"></a><span id="l106.66">     // assuming timezone is known:</span>
<a href="#l106.67"></a><span id="l106.67" class="difflineminus">-    let date = createDateTime();</span>
<a href="#l106.68"></a><span id="l106.68" class="difflineplus">+    let date = cal.createDateTime();</span>
<a href="#l106.69"></a><span id="l106.69">     date.icalString = val;</span>
<a href="#l106.70"></a><span id="l106.70">     return date;</span>
<a href="#l106.71"></a><span id="l106.71"> }</span>
<a href="#l106.72"></a><span id="l106.72"> </span>
<a href="#l106.73"></a><span id="l106.73"> function getDatetimeFromIcalProp(prop) {</span>
<a href="#l106.74"></a><span id="l106.74">     if (!prop) {</span>
<a href="#l106.75"></a><span id="l106.75">         return null;</span>
<a href="#l106.76"></a><span id="l106.76">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l107.1"></a><span id="l107.1" class="difflineminus">--- a/calendar/resources/content/calendarCreation.js</span>
<a href="#l107.2"></a><span id="l107.2" class="difflineplus">+++ b/calendar/resources/content/calendarCreation.js</span>
<a href="#l107.3"></a><span id="l107.3" class="difflineat">@@ -217,17 +217,17 @@ function initNameFromURI() {</span>
<a href="#l107.4"></a><span id="l107.4">  * @param aUri              The string to parse as an uri.</span>
<a href="#l107.5"></a><span id="l107.5">  * @return [error, uri]     |error| is the error code from errorConstants,</span>
<a href="#l107.6"></a><span id="l107.6">  *                          |uri| the parsed nsIURI, or null on error.</span>
<a href="#l107.7"></a><span id="l107.7">  */</span>
<a href="#l107.8"></a><span id="l107.8"> function parseUri(aUri) {</span>
<a href="#l107.9"></a><span id="l107.9">     let uri;</span>
<a href="#l107.10"></a><span id="l107.10">     try {</span>
<a href="#l107.11"></a><span id="l107.11">         // Test if the entered uri can be parsed.</span>
<a href="#l107.12"></a><span id="l107.12" class="difflineminus">-        uri = makeURL(aUri);</span>
<a href="#l107.13"></a><span id="l107.13" class="difflineplus">+        uri = cal.makeURL(aUri);</span>
<a href="#l107.14"></a><span id="l107.14">     } catch (ex) {</span>
<a href="#l107.15"></a><span id="l107.15">         return [errorConstants.INVALID_URI, null];</span>
<a href="#l107.16"></a><span id="l107.16">     }</span>
<a href="#l107.17"></a><span id="l107.17"> </span>
<a href="#l107.18"></a><span id="l107.18">     let calManager = cal.getCalendarManager();</span>
<a href="#l107.19"></a><span id="l107.19">     let cals = calManager.getCalendars({});</span>
<a href="#l107.20"></a><span id="l107.20">     let type = document.getElementById(&quot;calendar-type&quot;).selectedItem.value;</span>
<a href="#l107.21"></a><span id="l107.21">     if (type != &quot;local&quot; &amp;&amp; cals.some(calendar =&gt; calendar.uri.spec == uri.spec)) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l108.1"></a><span id="l108.1" class="difflineminus">--- a/calendar/resources/content/calendarCreation.xul</span>
<a href="#l108.2"></a><span id="l108.2" class="difflineplus">+++ b/calendar/resources/content/calendarCreation.xul</span>
<a href="#l108.3"></a><span id="l108.3" class="difflineat">@@ -14,17 +14,16 @@</span>
<a href="#l108.4"></a><span id="l108.4"> &lt;wizard id=&quot;calendar-wizard&quot;</span>
<a href="#l108.5"></a><span id="l108.5">         title=&quot;&amp;wizard.title;&quot;</span>
<a href="#l108.6"></a><span id="l108.6">         windowtype=&quot;Calendar:NewCalendarWizard&quot;</span>
<a href="#l108.7"></a><span id="l108.7">         xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l108.8"></a><span id="l108.8">         xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;</span>
<a href="#l108.9"></a><span id="l108.9">         onwizardfinish=&quot;&quot;</span>
<a href="#l108.10"></a><span id="l108.10">         persist=&quot;screenX screenY&quot;&gt;</span>
<a href="#l108.11"></a><span id="l108.11"> </span>
<a href="#l108.12"></a><span id="l108.12" class="difflineminus">-   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calUtils.js&quot;/&gt;</span>
<a href="#l108.13"></a><span id="l108.13">    &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calendarCreation.js&quot;/&gt;</span>
<a href="#l108.14"></a><span id="l108.14"> </span>
<a href="#l108.15"></a><span id="l108.15">    &lt;wizardpage pageid=&quot;initialPage&quot;</span>
<a href="#l108.16"></a><span id="l108.16">                next=&quot;locationPage&quot;</span>
<a href="#l108.17"></a><span id="l108.17">                label=&quot;&amp;wizard.label;&quot;</span>
<a href="#l108.18"></a><span id="l108.18">                description=&quot;&amp;wizard.description;&quot;</span>
<a href="#l108.19"></a><span id="l108.19">                onpageshow=&quot;checkRequired();&quot;</span>
<a href="#l108.20"></a><span id="l108.20">                onpageadvanced=&quot;onInitialAdvance();&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l109.1"></a><span id="l109.1" class="difflineminus">--- a/calendar/resources/content/datetimepickers/datetimepickers.xml</span>
<a href="#l109.2"></a><span id="l109.2" class="difflineplus">+++ b/calendar/resources/content/datetimepickers/datetimepickers.xml</span>
<a href="#l109.3"></a><span id="l109.3" class="difflineat">@@ -56,42 +56,42 @@</span>
<a href="#l109.4"></a><span id="l109.4">       &lt;field name=&quot;mDayNames&quot;&gt;[]&lt;/field&gt;</span>
<a href="#l109.5"></a><span id="l109.5">       &lt;field name=&quot;mRelationWords&quot;&gt;[]&lt;/field&gt;</span>
<a href="#l109.6"></a><span id="l109.6">       &lt;field name=&quot;mMonthLongNames&quot;&gt;[]&lt;/field&gt;</span>
<a href="#l109.7"></a><span id="l109.7">       &lt;field name=&quot;mMonthShortNames&quot;&gt;[]&lt;/field&gt;</span>
<a href="#l109.8"></a><span id="l109.8"> </span>
<a href="#l109.9"></a><span id="l109.9">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l109.10"></a><span id="l109.10">         Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l109.11"></a><span id="l109.11">         let goButton = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;date-go-button&quot;);</span>
<a href="#l109.12"></a><span id="l109.12" class="difflineminus">-        goButton.setAttribute(&quot;label&quot;, calGetString(&quot;calendar&quot;, &quot;go&quot;));</span>
<a href="#l109.13"></a><span id="l109.13" class="difflineplus">+        goButton.setAttribute(&quot;label&quot;, cal.calGetString(&quot;calendar&quot;, &quot;go&quot;));</span>
<a href="#l109.14"></a><span id="l109.14">         // Load the stuff we're going to use to parse written dates</span>
<a href="#l109.15"></a><span id="l109.15">         this.mRelativeDates = [</span>
<a href="#l109.16"></a><span id="l109.16">             { word: cal.calGetString(&quot;calendar&quot;, &quot;today&quot;).toLowerCase(), offset: 0 },</span>
<a href="#l109.17"></a><span id="l109.17">             { word: cal.calGetString(&quot;calendar&quot;, &quot;yesterday&quot;).toLowerCase(), offset: -1 },</span>
<a href="#l109.18"></a><span id="l109.18">             { word: cal.calGetString(&quot;calendar&quot;, &quot;tomorrow&quot;).toLowerCase(), offset: 1 }];</span>
<a href="#l109.19"></a><span id="l109.19">         for (let i = 1; i &lt;= 7; i++) {</span>
<a href="#l109.20"></a><span id="l109.20" class="difflineminus">-            this.mDayNames.push(calGetString(&quot;dateFormat&quot;, &quot;day.&quot; + i + &quot;.name&quot;).toLowerCase());</span>
<a href="#l109.21"></a><span id="l109.21" class="difflineplus">+            this.mDayNames.push(cal.calGetString(&quot;dateFormat&quot;, &quot;day.&quot; + i + &quot;.name&quot;).toLowerCase());</span>
<a href="#l109.22"></a><span id="l109.22">         }</span>
<a href="#l109.23"></a><span id="l109.23"> </span>
<a href="#l109.24"></a><span id="l109.24">         for (let i = 1; i &lt;= 12; i++) {</span>
<a href="#l109.25"></a><span id="l109.25" class="difflineminus">-            this.mMonthLongNames.push(calGetString(&quot;dateFormat&quot;, &quot;month.&quot; + i + &quot;.name&quot;).toLowerCase());</span>
<a href="#l109.26"></a><span id="l109.26" class="difflineminus">-            this.mMonthShortNames.push(calGetString(&quot;dateFormat&quot;, &quot;month.&quot; + i + &quot;.Mmm&quot;).toLowerCase());</span>
<a href="#l109.27"></a><span id="l109.27" class="difflineplus">+            this.mMonthLongNames.push(cal.calGetString(&quot;dateFormat&quot;, &quot;month.&quot; + i + &quot;.name&quot;).toLowerCase());</span>
<a href="#l109.28"></a><span id="l109.28" class="difflineplus">+            this.mMonthShortNames.push(cal.calGetString(&quot;dateFormat&quot;, &quot;month.&quot; + i + &quot;.Mmm&quot;).toLowerCase());</span>
<a href="#l109.29"></a><span id="l109.29">         }</span>
<a href="#l109.30"></a><span id="l109.30"> </span>
<a href="#l109.31"></a><span id="l109.31">         // note that some languages have different conjugations of</span>
<a href="#l109.32"></a><span id="l109.32">         // next/last depending on the day</span>
<a href="#l109.33"></a><span id="l109.33">         this.mRelationWords = [</span>
<a href="#l109.34"></a><span id="l109.34">             { word: cal.calGetString(&quot;calendar&quot;, &quot;last1&quot;), offset: -1 },</span>
<a href="#l109.35"></a><span id="l109.35">             { word: cal.calGetString(&quot;calendar&quot;, &quot;last2&quot;), offset: -1 },</span>
<a href="#l109.36"></a><span id="l109.36">             { word: cal.calGetString(&quot;calendar&quot;, &quot;next1&quot;), offset: 0 },</span>
<a href="#l109.37"></a><span id="l109.37">             { word: cal.calGetString(&quot;calendar&quot;, &quot;next2&quot;), offset: 0 }];</span>
<a href="#l109.38"></a><span id="l109.38"> </span>
<a href="#l109.39"></a><span id="l109.39">         // Set the value to today</span>
<a href="#l109.40"></a><span id="l109.40">         let text = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;date-textbox&quot;);</span>
<a href="#l109.41"></a><span id="l109.41" class="difflineminus">-        text.value = calGetString(&quot;calendar&quot;, &quot;today&quot;);</span>
<a href="#l109.42"></a><span id="l109.42" class="difflineplus">+        text.value = cal.calGetString(&quot;calendar&quot;, &quot;today&quot;);</span>
<a href="#l109.43"></a><span id="l109.43">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l109.44"></a><span id="l109.44"> </span>
<a href="#l109.45"></a><span id="l109.45">       &lt;property name=&quot;value&quot;&gt;</span>
<a href="#l109.46"></a><span id="l109.46">         &lt;getter&gt;&lt;![CDATA[</span>
<a href="#l109.47"></a><span id="l109.47">           return this.mValue;</span>
<a href="#l109.48"></a><span id="l109.48">         ]]&gt;&lt;/getter&gt;</span>
<a href="#l109.49"></a><span id="l109.49">         &lt;setter&gt;&lt;![CDATA[</span>
<a href="#l109.50"></a><span id="l109.50">           let text = document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;date-textbox&quot;);</span>
<a href="#l109.51"></a><span id="l109.51" class="difflineat">@@ -414,17 +414,19 @@</span>
<a href="#l109.52"></a><span id="l109.52">         &lt;/xul:menulist&gt;</span>
<a href="#l109.53"></a><span id="l109.53">       &lt;/xul:hbox&gt;</span>
<a href="#l109.54"></a><span id="l109.54">     &lt;/content&gt;</span>
<a href="#l109.55"></a><span id="l109.55"> </span>
<a href="#l109.56"></a><span id="l109.56">     &lt;implementation&gt;</span>
<a href="#l109.57"></a><span id="l109.57">       &lt;field name=&quot;mForeverStr&quot;&gt;null&lt;/field&gt;</span>
<a href="#l109.58"></a><span id="l109.58"> </span>
<a href="#l109.59"></a><span id="l109.59">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l109.60"></a><span id="l109.60" class="difflineminus">-        this.mForeverStr = calGetString(&quot;calendar-event-dialog&quot;, &quot;eventRecurrenceForeverLabel&quot;);</span>
<a href="#l109.61"></a><span id="l109.61" class="difflineplus">+        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l109.62"></a><span id="l109.62" class="difflineplus">+</span>
<a href="#l109.63"></a><span id="l109.63" class="difflineplus">+        this.mForeverStr = cal.calGetString(&quot;calendar-event-dialog&quot;, &quot;eventRecurrenceForeverLabel&quot;);</span>
<a href="#l109.64"></a><span id="l109.64">         document.getAnonymousElementByAttribute(this, &quot;anonid&quot;, &quot;menuitemForever&quot;)</span>
<a href="#l109.65"></a><span id="l109.65">                 .setAttribute(&quot;label&quot;, this.mForeverStr);</span>
<a href="#l109.66"></a><span id="l109.66">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l109.67"></a><span id="l109.67"> </span>
<a href="#l109.68"></a><span id="l109.68">       &lt;method name=&quot;parseTextBoxDate&quot;&gt;</span>
<a href="#l109.69"></a><span id="l109.69">         &lt;parameter name=&quot;aRefresh&quot;/&gt;</span>
<a href="#l109.70"></a><span id="l109.70">         &lt;parameter name=&quot;aEvent&quot;/&gt;</span>
<a href="#l109.71"></a><span id="l109.71">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l109.72"></a><span id="l109.72" class="difflineat">@@ -1450,16 +1452,18 @@</span>
<a href="#l109.73"></a><span id="l109.73"> </span>
<a href="#l109.74"></a><span id="l109.74">   &lt;binding id=&quot;datetimepicker-base&quot; extends=&quot;chrome://global/content/bindings/general.xml#basecontrol&quot;</span>
<a href="#l109.75"></a><span id="l109.75">            inherits=&quot;value,onchange&quot;&gt;</span>
<a href="#l109.76"></a><span id="l109.76">     &lt;resources&gt;</span>
<a href="#l109.77"></a><span id="l109.77">       &lt;stylesheet src=&quot;chrome://lightning-common/skin/datetimepickers.css&quot;/&gt;</span>
<a href="#l109.78"></a><span id="l109.78">     &lt;/resources&gt;</span>
<a href="#l109.79"></a><span id="l109.79">     &lt;implementation&gt;</span>
<a href="#l109.80"></a><span id="l109.80">       &lt;constructor&gt;&lt;![CDATA[</span>
<a href="#l109.81"></a><span id="l109.81" class="difflineplus">+        Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l109.82"></a><span id="l109.82" class="difflineplus">+</span>
<a href="#l109.83"></a><span id="l109.83">         this.initDateFormat();</span>
<a href="#l109.84"></a><span id="l109.84">         this.initTimeFormat();</span>
<a href="#l109.85"></a><span id="l109.85">       ]]&gt;&lt;/constructor&gt;</span>
<a href="#l109.86"></a><span id="l109.86"> </span>
<a href="#l109.87"></a><span id="l109.87">       &lt;property name=&quot;value&quot;</span>
<a href="#l109.88"></a><span id="l109.88">                 onget=&quot;return this.mValue&quot;</span>
<a href="#l109.89"></a><span id="l109.89">                 onset=&quot;this.update(val, false)&quot;/&gt;</span>
<a href="#l109.90"></a><span id="l109.90"> </span>
<a href="#l109.91"></a><span id="l109.91" class="difflineat">@@ -1593,22 +1597,22 @@</span>
<a href="#l109.92"></a><span id="l109.92">            am/pm arabic          &quot;\u063502:34&quot; (RTL 02:34a) &quot;\u0645 02.34&quot; (RTL 02.34 p)</span>
<a href="#l109.93"></a><span id="l109.93">            above/below noon      &quot;\u4e0a\u534802:34&quot;    &quot;\u4e0b\u5348 02 34&quot;</span>
<a href="#l109.94"></a><span id="l109.94">            noon before/after     &quot;\u5348\u524d02:34&quot;    &quot;\u5348\u5f8c 02 34&quot;</span>
<a href="#l109.95"></a><span id="l109.95">       --&gt;</span>
<a href="#l109.96"></a><span id="l109.96">       &lt;method name=&quot;parseTime&quot;&gt;</span>
<a href="#l109.97"></a><span id="l109.97">         &lt;parameter name=&quot;aValue&quot;/&gt;</span>
<a href="#l109.98"></a><span id="l109.98">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l109.99"></a><span id="l109.99">           try {</span>
<a href="#l109.100"></a><span id="l109.100" class="difflineminus">-              let noon = calGetString(&quot;dateFormat&quot;, &quot;noon&quot;);</span>
<a href="#l109.101"></a><span id="l109.101" class="difflineplus">+              let noon = cal.calGetString(&quot;dateFormat&quot;, &quot;noon&quot;);</span>
<a href="#l109.102"></a><span id="l109.102">               if (aValue.toLowerCase() == noon.toLowerCase()) {</span>
<a href="#l109.103"></a><span id="l109.103">                   return new Date(0, 0, 0, 12, 0, 0, 0);</span>
<a href="#l109.104"></a><span id="l109.104">               }</span>
<a href="#l109.105"></a><span id="l109.105"> </span>
<a href="#l109.106"></a><span id="l109.106" class="difflineminus">-              let midnight = calGetString(&quot;dateFormat&quot;, &quot;midnight&quot;);</span>
<a href="#l109.107"></a><span id="l109.107" class="difflineplus">+              let midnight = cal.calGetString(&quot;dateFormat&quot;, &quot;midnight&quot;);</span>
<a href="#l109.108"></a><span id="l109.108">               if (aValue.toLowerCase() == midnight.toLowerCase()) {</span>
<a href="#l109.109"></a><span id="l109.109">                   return new Date(0, 0, 0, 0, 0, 0, 0);</span>
<a href="#l109.110"></a><span id="l109.110">               }</span>
<a href="#l109.111"></a><span id="l109.111">           } catch (ex) {</span>
<a href="#l109.112"></a><span id="l109.112">               // Try/catch this, since some people are apparently</span>
<a href="#l109.113"></a><span id="l109.113">               // interested in using the datepicker in remote apps, where</span>
<a href="#l109.114"></a><span id="l109.114">               // calGetString wouldn't exist</span>
<a href="#l109.115"></a><span id="l109.115">           }</span>
<a href="#l109.116"></a><span id="l109.116" class="difflineat">@@ -1864,18 +1868,16 @@</span>
<a href="#l109.117"></a><span id="l109.117">               this.kTimeFormatString = &quot;%H:%M&quot;;</span>
<a href="#l109.118"></a><span id="l109.118">           }</span>
<a href="#l109.119"></a><span id="l109.119">         ]]&gt;&lt;/body&gt;</span>
<a href="#l109.120"></a><span id="l109.120">       &lt;/method&gt;</span>
<a href="#l109.121"></a><span id="l109.121"> </span>
<a href="#l109.122"></a><span id="l109.122">       &lt;method name=&quot;formatDate&quot;&gt;</span>
<a href="#l109.123"></a><span id="l109.123">         &lt;parameter name=&quot;aDate&quot;/&gt;</span>
<a href="#l109.124"></a><span id="l109.124">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l109.125"></a><span id="l109.125" class="difflineminus">-          Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l109.126"></a><span id="l109.126" class="difflineminus">-</span>
<a href="#l109.127"></a><span id="l109.127">           let dateFormatter = cal.getDateFormatter();</span>
<a href="#l109.128"></a><span id="l109.128">           return dateFormatter.formatDateShort(cal.jsDateToDateTime(aDate, cal.floating()));</span>
<a href="#l109.129"></a><span id="l109.129">         ]]&gt;&lt;/body&gt;</span>
<a href="#l109.130"></a><span id="l109.130">       &lt;/method&gt;</span>
<a href="#l109.131"></a><span id="l109.131"> </span>
<a href="#l109.132"></a><span id="l109.132">       &lt;method name=&quot;formatTime&quot;&gt;</span>
<a href="#l109.133"></a><span id="l109.133">         &lt;parameter name=&quot;aValue&quot;/&gt;</span>
<a href="#l109.134"></a><span id="l109.134">         &lt;body&gt;&lt;![CDATA[</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l110.1"></a><span id="l110.1" class="difflineminus">--- a/calendar/resources/content/mouseoverPreviews.js</span>
<a href="#l110.2"></a><span id="l110.2" class="difflineplus">+++ b/calendar/resources/content/mouseoverPreviews.js</span>
<a href="#l110.3"></a><span id="l110.3" class="difflineat">@@ -15,32 +15,34 @@</span>
<a href="#l110.4"></a><span id="l110.4"> </span>
<a href="#l110.5"></a><span id="l110.5"> /** PUBLIC</span>
<a href="#l110.6"></a><span id="l110.6">  *</span>
<a href="#l110.7"></a><span id="l110.7">  *  This changes the mouseover preview based on the start and end dates</span>
<a href="#l110.8"></a><span id="l110.8">  *  of an occurrence of a (one-time or recurring) calEvent or calToDo.</span>
<a href="#l110.9"></a><span id="l110.9">  *  Used by all grid views.</span>
<a href="#l110.10"></a><span id="l110.10">  */</span>
<a href="#l110.11"></a><span id="l110.11"> </span>
<a href="#l110.12"></a><span id="l110.12" class="difflineplus">+Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l110.13"></a><span id="l110.13" class="difflineplus">+</span>
<a href="#l110.14"></a><span id="l110.14"> function onMouseOverItem(occurrenceBoxMouseEvent) {</span>
<a href="#l110.15"></a><span id="l110.15">     if (&quot;occurrence&quot; in occurrenceBoxMouseEvent.currentTarget) {</span>
<a href="#l110.16"></a><span id="l110.16">         // occurrence of repeating event or todo</span>
<a href="#l110.17"></a><span id="l110.17">         let occurrence = occurrenceBoxMouseEvent.currentTarget.occurrence;</span>
<a href="#l110.18"></a><span id="l110.18">         const toolTip = document.getElementById(&quot;itemTooltip&quot;);</span>
<a href="#l110.19"></a><span id="l110.19">         return showToolTip(toolTip, occurrence);</span>
<a href="#l110.20"></a><span id="l110.20">     }</span>
<a href="#l110.21"></a><span id="l110.21">     return false;</span>
<a href="#l110.22"></a><span id="l110.22"> }</span>
<a href="#l110.23"></a><span id="l110.23"> </span>
<a href="#l110.24"></a><span id="l110.24"> function showToolTip(aToolTip, aItem) {</span>
<a href="#l110.25"></a><span id="l110.25">     if (aItem) {</span>
<a href="#l110.26"></a><span id="l110.26">         let holderBox;</span>
<a href="#l110.27"></a><span id="l110.27" class="difflineminus">-        if (isEvent(aItem)) {</span>
<a href="#l110.28"></a><span id="l110.28" class="difflineplus">+        if (cal.isEvent(aItem)) {</span>
<a href="#l110.29"></a><span id="l110.29">             holderBox = getPreviewForEvent(aItem);</span>
<a href="#l110.30"></a><span id="l110.30" class="difflineminus">-        } else if (isToDo(aItem)) {</span>
<a href="#l110.31"></a><span id="l110.31" class="difflineplus">+        } else if (cal.isToDo(aItem)) {</span>
<a href="#l110.32"></a><span id="l110.32">             holderBox = getPreviewForTask(aItem);</span>
<a href="#l110.33"></a><span id="l110.33">         }</span>
<a href="#l110.34"></a><span id="l110.34">         if (holderBox) {</span>
<a href="#l110.35"></a><span id="l110.35">             removeChildren(aToolTip);</span>
<a href="#l110.36"></a><span id="l110.36">             aToolTip.appendChild(holderBox);</span>
<a href="#l110.37"></a><span id="l110.37">             return true;</span>
<a href="#l110.38"></a><span id="l110.38">         }</span>
<a href="#l110.39"></a><span id="l110.39">     }</span>
<a href="#l110.40"></a><span id="l110.40" class="difflineat">@@ -89,21 +91,21 @@ function getPreviewForTask(toDoItem) {</span>
<a href="#l110.41"></a><span id="l110.41">         }</span>
<a href="#l110.42"></a><span id="l110.42"> </span>
<a href="#l110.43"></a><span id="l110.43">         if (toDoItem.priority &amp;&amp; toDoItem.priority != 0) {</span>
<a href="#l110.44"></a><span id="l110.44">             let priorityInteger = parseInt(toDoItem.priority, 10);</span>
<a href="#l110.45"></a><span id="l110.45">             let priorityString;</span>
<a href="#l110.46"></a><span id="l110.46"> </span>
<a href="#l110.47"></a><span id="l110.47">             // These cut-offs should match calendar-event-dialog.js</span>
<a href="#l110.48"></a><span id="l110.48">             if (priorityInteger &gt;= 1 &amp;&amp; priorityInteger &lt;= 4) {</span>
<a href="#l110.49"></a><span id="l110.49" class="difflineminus">-                priorityString = calGetString(&quot;calendar&quot;, &quot;highPriority&quot;); // high priority</span>
<a href="#l110.50"></a><span id="l110.50" class="difflineplus">+                priorityString = cal.calGetString(&quot;calendar&quot;, &quot;highPriority&quot;); // high priority</span>
<a href="#l110.51"></a><span id="l110.51">             } else if (priorityInteger == 5) {</span>
<a href="#l110.52"></a><span id="l110.52" class="difflineminus">-                priorityString = calGetString(&quot;calendar&quot;, &quot;normalPriority&quot;); // normal priority</span>
<a href="#l110.53"></a><span id="l110.53" class="difflineplus">+                priorityString = cal.calGetString(&quot;calendar&quot;, &quot;normalPriority&quot;); // normal priority</span>
<a href="#l110.54"></a><span id="l110.54">             } else {</span>
<a href="#l110.55"></a><span id="l110.55" class="difflineminus">-                priorityString = calGetString(&quot;calendar&quot;, &quot;lowPriority&quot;); // low priority</span>
<a href="#l110.56"></a><span id="l110.56" class="difflineplus">+                priorityString = cal.calGetString(&quot;calendar&quot;, &quot;lowPriority&quot;); // low priority</span>
<a href="#l110.57"></a><span id="l110.57">             }</span>
<a href="#l110.58"></a><span id="l110.58">             boxAppendLabeledText(vbox, &quot;tooltipPriority&quot;, priorityString);</span>
<a href="#l110.59"></a><span id="l110.59">             hasHeader = true;</span>
<a href="#l110.60"></a><span id="l110.60">         }</span>
<a href="#l110.61"></a><span id="l110.61"> </span>
<a href="#l110.62"></a><span id="l110.62">         if (toDoItem.status &amp;&amp; toDoItem.status != &quot;NONE&quot;) {</span>
<a href="#l110.63"></a><span id="l110.63">             let status = getToDoStatusString(toDoItem);</span>
<a href="#l110.64"></a><span id="l110.64">             boxAppendLabeledText(vbox, &quot;tooltipStatus&quot;, status);</span>
<a href="#l110.65"></a><span id="l110.65" class="difflineat">@@ -198,38 +200,38 @@ function getPreviewForEvent(aEvent) {</span>
<a href="#l110.66"></a><span id="l110.66"> }</span>
<a href="#l110.67"></a><span id="l110.67"> </span>
<a href="#l110.68"></a><span id="l110.68"> </span>
<a href="#l110.69"></a><span id="l110.69"> /** String for event status: (none), Tentative, Confirmed, or Cancelled **/</span>
<a href="#l110.70"></a><span id="l110.70"> function getEventStatusString(calendarEvent) {</span>
<a href="#l110.71"></a><span id="l110.71">     switch (calendarEvent.status) {</span>
<a href="#l110.72"></a><span id="l110.72">         // Event status value keywords are specified in RFC2445sec4.8.1.11</span>
<a href="#l110.73"></a><span id="l110.73">         case &quot;TENTATIVE&quot;:</span>
<a href="#l110.74"></a><span id="l110.74" class="difflineminus">-            return calGetString(&quot;calendar&quot;, &quot;statusTentative&quot;);</span>
<a href="#l110.75"></a><span id="l110.75" class="difflineplus">+            return cal.calGetString(&quot;calendar&quot;, &quot;statusTentative&quot;);</span>
<a href="#l110.76"></a><span id="l110.76">         case &quot;CONFIRMED&quot;:</span>
<a href="#l110.77"></a><span id="l110.77" class="difflineminus">-            return calGetString(&quot;calendar&quot;, &quot;statusConfirmed&quot;);</span>
<a href="#l110.78"></a><span id="l110.78" class="difflineplus">+            return cal.calGetString(&quot;calendar&quot;, &quot;statusConfirmed&quot;);</span>
<a href="#l110.79"></a><span id="l110.79">         case &quot;CANCELLED&quot;:</span>
<a href="#l110.80"></a><span id="l110.80" class="difflineminus">-            return calGetString(&quot;calendar&quot;, &quot;eventStatusCancelled&quot;);</span>
<a href="#l110.81"></a><span id="l110.81" class="difflineplus">+            return cal.calGetString(&quot;calendar&quot;, &quot;eventStatusCancelled&quot;);</span>
<a href="#l110.82"></a><span id="l110.82">         default:</span>
<a href="#l110.83"></a><span id="l110.83">             return &quot;&quot;;</span>
<a href="#l110.84"></a><span id="l110.84">     }</span>
<a href="#l110.85"></a><span id="l110.85"> }</span>
<a href="#l110.86"></a><span id="l110.86"> </span>
<a href="#l110.87"></a><span id="l110.87"> /** String for todo status: (none), NeedsAction, InProcess, Cancelled, or Completed **/</span>
<a href="#l110.88"></a><span id="l110.88"> function getToDoStatusString(iCalToDo) {</span>
<a href="#l110.89"></a><span id="l110.89">     switch (iCalToDo.status) {</span>
<a href="#l110.90"></a><span id="l110.90">         // Todo status keywords are specified in RFC2445sec4.8.1.11</span>
<a href="#l110.91"></a><span id="l110.91">         case &quot;NEEDS-ACTION&quot;:</span>
<a href="#l110.92"></a><span id="l110.92" class="difflineminus">-            return calGetString(&quot;calendar&quot;, &quot;statusNeedsAction&quot;);</span>
<a href="#l110.93"></a><span id="l110.93" class="difflineplus">+            return cal.calGetString(&quot;calendar&quot;, &quot;statusNeedsAction&quot;);</span>
<a href="#l110.94"></a><span id="l110.94">         case &quot;IN-PROCESS&quot;:</span>
<a href="#l110.95"></a><span id="l110.95" class="difflineminus">-            return calGetString(&quot;calendar&quot;, &quot;statusInProcess&quot;);</span>
<a href="#l110.96"></a><span id="l110.96" class="difflineplus">+            return cal.calGetString(&quot;calendar&quot;, &quot;statusInProcess&quot;);</span>
<a href="#l110.97"></a><span id="l110.97">         case &quot;CANCELLED&quot;:</span>
<a href="#l110.98"></a><span id="l110.98" class="difflineminus">-            return calGetString(&quot;calendar&quot;, &quot;todoStatusCancelled&quot;);</span>
<a href="#l110.99"></a><span id="l110.99" class="difflineplus">+            return cal.calGetString(&quot;calendar&quot;, &quot;todoStatusCancelled&quot;);</span>
<a href="#l110.100"></a><span id="l110.100">         case &quot;COMPLETED&quot;:</span>
<a href="#l110.101"></a><span id="l110.101" class="difflineminus">-            return calGetString(&quot;calendar&quot;, &quot;statusCompleted&quot;);</span>
<a href="#l110.102"></a><span id="l110.102" class="difflineplus">+            return cal.calGetString(&quot;calendar&quot;, &quot;statusCompleted&quot;);</span>
<a href="#l110.103"></a><span id="l110.103">         default:</span>
<a href="#l110.104"></a><span id="l110.104">             return &quot;&quot;;</span>
<a href="#l110.105"></a><span id="l110.105">     }</span>
<a href="#l110.106"></a><span id="l110.106"> }</span>
<a href="#l110.107"></a><span id="l110.107"> </span>
<a href="#l110.108"></a><span id="l110.108"> /**</span>
<a href="#l110.109"></a><span id="l110.109">  * PRIVATE: Append a separator, a thin space between header and body.</span>
<a href="#l110.110"></a><span id="l110.110">  *</span>
<a href="#l110.111"></a><span id="l110.111" class="difflineat">@@ -255,30 +257,30 @@ function boxAppendBody(box, textString) </span>
<a href="#l110.112"></a><span id="l110.112">     box.appendChild(xulDescription);</span>
<a href="#l110.113"></a><span id="l110.113"> }</span>
<a href="#l110.114"></a><span id="l110.114"> </span>
<a href="#l110.115"></a><span id="l110.115"> /**</span>
<a href="#l110.116"></a><span id="l110.116">  * PRIVATE: Use dateFormatter to format date and time,</span>
<a href="#l110.117"></a><span id="l110.117">  * and to header grid append a row containing localized Label: date.</span>
<a href="#l110.118"></a><span id="l110.118">  */</span>
<a href="#l110.119"></a><span id="l110.119"> function boxAppendLabeledDateTime(box, labelProperty, date) {</span>
<a href="#l110.120"></a><span id="l110.120" class="difflineminus">-    date = date.getInTimezone(calendarDefaultTimezone());</span>
<a href="#l110.121"></a><span id="l110.121" class="difflineminus">-    let formattedDateTime = getDateFormatter().formatDateTime(date);</span>
<a href="#l110.122"></a><span id="l110.122" class="difflineplus">+    date = date.getInTimezone(cal.calendarDefaultTimezone());</span>
<a href="#l110.123"></a><span id="l110.123" class="difflineplus">+    let formattedDateTime = cal.getDateFormatter().formatDateTime(date);</span>
<a href="#l110.124"></a><span id="l110.124">     boxAppendLabeledText(box, labelProperty, formattedDateTime);</span>
<a href="#l110.125"></a><span id="l110.125"> }</span>
<a href="#l110.126"></a><span id="l110.126"> </span>
<a href="#l110.127"></a><span id="l110.127"> /**</span>
<a href="#l110.128"></a><span id="l110.128">  * PRIVATE: Use dateFormatter to format date and time interval,</span>
<a href="#l110.129"></a><span id="l110.129">  * and to header grid append a row containing localized Label: interval.</span>
<a href="#l110.130"></a><span id="l110.130">  * @param box               contains header grid.</span>
<a href="#l110.131"></a><span id="l110.131">  * @param labelProperty     name of property for localized field label.</span>
<a href="#l110.132"></a><span id="l110.132">  * @param item              the event or task</span>
<a href="#l110.133"></a><span id="l110.133">  */</span>
<a href="#l110.134"></a><span id="l110.134"> function boxAppendLabeledDateTimeInterval(box, labelProperty, item) {</span>
<a href="#l110.135"></a><span id="l110.135" class="difflineminus">-    let dateString = getDateFormatter().formatItemInterval(item);</span>
<a href="#l110.136"></a><span id="l110.136" class="difflineplus">+    let dateString = cal.getDateFormatter().formatItemInterval(item);</span>
<a href="#l110.137"></a><span id="l110.137">     boxAppendLabeledText(box, labelProperty, dateString);</span>
<a href="#l110.138"></a><span id="l110.138"> }</span>
<a href="#l110.139"></a><span id="l110.139"> </span>
<a href="#l110.140"></a><span id="l110.140"> /**</span>
<a href="#l110.141"></a><span id="l110.141">  * PRIVATE: create empty 2-column grid for header fields,</span>
<a href="#l110.142"></a><span id="l110.142">  * and append it to box.</span>
<a href="#l110.143"></a><span id="l110.143">  */</span>
<a href="#l110.144"></a><span id="l110.144"> function boxInitializeHeaderGrid(box) {</span>
<a href="#l110.145"></a><span id="l110.145" class="difflineat">@@ -305,17 +307,17 @@ function boxInitializeHeaderGrid(box) {</span>
<a href="#l110.146"></a><span id="l110.146"> /**</span>
<a href="#l110.147"></a><span id="l110.147">  * PRIVATE: To headers grid, append a row containing Label: value,</span>
<a href="#l110.148"></a><span id="l110.148">  * where label is localized text for labelProperty.</span>
<a href="#l110.149"></a><span id="l110.149">  * @param box               box containing headers grid</span>
<a href="#l110.150"></a><span id="l110.150">  * @param labelProperty     name of property for localized name of header</span>
<a href="#l110.151"></a><span id="l110.151">  * @param textString        value of header field.</span>
<a href="#l110.152"></a><span id="l110.152">  */</span>
<a href="#l110.153"></a><span id="l110.153"> function boxAppendLabeledText(box, labelProperty, textString) {</span>
<a href="#l110.154"></a><span id="l110.154" class="difflineminus">-    let labelText = calGetString(&quot;calendar&quot;, labelProperty);</span>
<a href="#l110.155"></a><span id="l110.155" class="difflineplus">+    let labelText = cal.calGetString(&quot;calendar&quot;, labelProperty);</span>
<a href="#l110.156"></a><span id="l110.156">     let rows = box.getElementsByTagNameNS(box.namespaceURI, &quot;rows&quot;)[0];</span>
<a href="#l110.157"></a><span id="l110.157">     let row = document.createElement(&quot;row&quot;);</span>
<a href="#l110.158"></a><span id="l110.158"> </span>
<a href="#l110.159"></a><span id="l110.159">     row.appendChild(createTooltipHeaderLabel(labelText));</span>
<a href="#l110.160"></a><span id="l110.160">     row.appendChild(createTooltipHeaderDescription(textString));</span>
<a href="#l110.161"></a><span id="l110.161"> </span>
<a href="#l110.162"></a><span id="l110.162">     rows.appendChild(row);</span>
<a href="#l110.163"></a><span id="l110.163"> }</span>
<a href="#l110.164"></a><span id="l110.164" class="difflineat">@@ -346,17 +348,17 @@ function getCurrentNextOrPreviousRecurre</span>
<a href="#l110.165"></a><span id="l110.165">         return calendarEvent;</span>
<a href="#l110.166"></a><span id="l110.166">     }</span>
<a href="#l110.167"></a><span id="l110.167"> </span>
<a href="#l110.168"></a><span id="l110.168">     let dur = calendarEvent.duration.clone();</span>
<a href="#l110.169"></a><span id="l110.169">     dur.isNegative = true;</span>
<a href="#l110.170"></a><span id="l110.170"> </span>
<a href="#l110.171"></a><span id="l110.171">     // To find current event when now is during event, look for occurrence</span>
<a href="#l110.172"></a><span id="l110.172">     // starting duration ago.</span>
<a href="#l110.173"></a><span id="l110.173" class="difflineminus">-    let probeTime = now();</span>
<a href="#l110.174"></a><span id="l110.174" class="difflineplus">+    let probeTime = cal.now();</span>
<a href="#l110.175"></a><span id="l110.175">     probeTime.addDuration(dur);</span>
<a href="#l110.176"></a><span id="l110.176"> </span>
<a href="#l110.177"></a><span id="l110.177">     let occ = calendarEvent.recurrenceInfo.getNextOccurrence(probeTime);</span>
<a href="#l110.178"></a><span id="l110.178"> </span>
<a href="#l110.179"></a><span id="l110.179">     if (!occ) {</span>
<a href="#l110.180"></a><span id="l110.180">         let occs = calendarEvent.recurrenceInfo.getOccurrences(calendarEvent.startDate, probeTime, 0, {});</span>
<a href="#l110.181"></a><span id="l110.181">         occ = occs[occs.length - 1];</span>
<a href="#l110.182"></a><span id="l110.182">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l111.1"></a><span id="l111.1" class="difflineminus">--- a/calendar/resources/content/publish.js</span>
<a href="#l111.2"></a><span id="l111.2" class="difflineplus">+++ b/calendar/resources/content/publish.js</span>
<a href="#l111.3"></a><span id="l111.3" class="difflineat">@@ -38,29 +38,29 @@ function publishCalendarDataDialogRespon</span>
<a href="#l111.4"></a><span id="l111.4">  * Show publish dialog, ask for URL and publish all items from the calendar.</span>
<a href="#l111.5"></a><span id="l111.5">  *</span>
<a href="#l111.6"></a><span id="l111.6">  * @param aCalendar   (optional) The calendar that will be published. If ommitted</span>
<a href="#l111.7"></a><span id="l111.7">  *                               the user will be prompted to select a calendar.</span>
<a href="#l111.8"></a><span id="l111.8">  */</span>
<a href="#l111.9"></a><span id="l111.9"> function publishEntireCalendar(aCalendar) {</span>
<a href="#l111.10"></a><span id="l111.10">     if (!aCalendar) {</span>
<a href="#l111.11"></a><span id="l111.11">         let count = {};</span>
<a href="#l111.12"></a><span id="l111.12" class="difflineminus">-        let calendars = getCalendarManager().getCalendars(count);</span>
<a href="#l111.13"></a><span id="l111.13" class="difflineplus">+        let calendars = cal.getCalendarManager().getCalendars(count);</span>
<a href="#l111.14"></a><span id="l111.14"> </span>
<a href="#l111.15"></a><span id="l111.15">         if (count.value == 1) {</span>
<a href="#l111.16"></a><span id="l111.16">             // Do not ask user for calendar if only one calendar exists</span>
<a href="#l111.17"></a><span id="l111.17">             aCalendar = calendars[0];</span>
<a href="#l111.18"></a><span id="l111.18">         } else {</span>
<a href="#l111.19"></a><span id="l111.19">             // Ask user to select the calendar that should be published.</span>
<a href="#l111.20"></a><span id="l111.20">             // publishEntireCalendar() will be called again if OK is pressed</span>
<a href="#l111.21"></a><span id="l111.21">             // in the dialog and the selected calendar will be passed in.</span>
<a href="#l111.22"></a><span id="l111.22">             // Therefore return after openDialog().</span>
<a href="#l111.23"></a><span id="l111.23">             let args = {};</span>
<a href="#l111.24"></a><span id="l111.24">             args.onOk = publishEntireCalendar;</span>
<a href="#l111.25"></a><span id="l111.25" class="difflineminus">-            args.promptText = calGetString(&quot;calendar&quot;, &quot;publishPrompt&quot;);</span>
<a href="#l111.26"></a><span id="l111.26" class="difflineplus">+            args.promptText = cal.calGetString(&quot;calendar&quot;, &quot;publishPrompt&quot;);</span>
<a href="#l111.27"></a><span id="l111.27">             openDialog(&quot;chrome://calendar/content/chooseCalendarDialog.xul&quot;,</span>
<a href="#l111.28"></a><span id="l111.28">                        &quot;_blank&quot;, &quot;chrome,titlebar,modal,resizable&quot;, args);</span>
<a href="#l111.29"></a><span id="l111.29">             return;</span>
<a href="#l111.30"></a><span id="l111.30">         }</span>
<a href="#l111.31"></a><span id="l111.31">     }</span>
<a href="#l111.32"></a><span id="l111.32"> </span>
<a href="#l111.33"></a><span id="l111.33">     let args = {};</span>
<a href="#l111.34"></a><span id="l111.34">     let publishObject = {};</span>
<a href="#l111.35"></a><span id="l111.35" class="difflineat">@@ -118,17 +118,17 @@ function publishEntireCalendarDialogResp</span>
<a href="#l111.36"></a><span id="l111.36">                          0, null, null, getListener);</span>
<a href="#l111.37"></a><span id="l111.37"> }</span>
<a href="#l111.38"></a><span id="l111.38"> </span>
<a href="#l111.39"></a><span id="l111.39"> function publishItemArray(aItemArray, aPath, aProgressDialog) {</span>
<a href="#l111.40"></a><span id="l111.40">     let outputStream;</span>
<a href="#l111.41"></a><span id="l111.41">     let inputStream;</span>
<a href="#l111.42"></a><span id="l111.42">     let storageStream;</span>
<a href="#l111.43"></a><span id="l111.43"> </span>
<a href="#l111.44"></a><span id="l111.44" class="difflineminus">-    let icsURL = makeURL(aPath);</span>
<a href="#l111.45"></a><span id="l111.45" class="difflineplus">+    let icsURL = cal.makeURL(aPath);</span>
<a href="#l111.46"></a><span id="l111.46"> </span>
<a href="#l111.47"></a><span id="l111.47">     let channel = Services.io.newChannelFromURI2(icsURL,</span>
<a href="#l111.48"></a><span id="l111.48">                                                  null,</span>
<a href="#l111.49"></a><span id="l111.49">                                                  Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l111.50"></a><span id="l111.50">                                                  null,</span>
<a href="#l111.51"></a><span id="l111.51">                                                  Components.interfaces.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l111.52"></a><span id="l111.52">                                                  Components.interfaces.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l111.53"></a><span id="l111.53">     if (icsURL.schemeIs(&quot;webcal&quot;)) {</span>
<a href="#l111.54"></a><span id="l111.54" class="difflineat">@@ -161,31 +161,31 @@ function publishItemArray(aItemArray, aP</span>
<a href="#l111.55"></a><span id="l111.55">                                   .createInstance(Components.interfaces.nsIStorageStream);</span>
<a href="#l111.56"></a><span id="l111.56">     storageStream.init(32768, 0xffffffff, null);</span>
<a href="#l111.57"></a><span id="l111.57">     outputStream = storageStream.getOutputStream(0);</span>
<a href="#l111.58"></a><span id="l111.58"> </span>
<a href="#l111.59"></a><span id="l111.59">     let serializer = Components.classes[&quot;@mozilla.org/calendar/ics-serializer;1&quot;]</span>
<a href="#l111.60"></a><span id="l111.60">                                .createInstance(Components.interfaces.calIIcsSerializer);</span>
<a href="#l111.61"></a><span id="l111.61">     serializer.addItems(aItemArray, aItemArray.length);</span>
<a href="#l111.62"></a><span id="l111.62">     // Outlook requires METHOD:PUBLISH property:</span>
<a href="#l111.63"></a><span id="l111.63" class="difflineminus">-    let methodProp = getIcsService().createIcalProperty(&quot;METHOD&quot;);</span>
<a href="#l111.64"></a><span id="l111.64" class="difflineplus">+    let methodProp = cal.getIcsService().createIcalProperty(&quot;METHOD&quot;);</span>
<a href="#l111.65"></a><span id="l111.65">     methodProp.value = &quot;PUBLISH&quot;;</span>
<a href="#l111.66"></a><span id="l111.66">     serializer.addProperty(methodProp);</span>
<a href="#l111.67"></a><span id="l111.67">     serializer.serializeToStream(outputStream);</span>
<a href="#l111.68"></a><span id="l111.68">     outputStream.close();</span>
<a href="#l111.69"></a><span id="l111.69"> </span>
<a href="#l111.70"></a><span id="l111.70">     inputStream = storageStream.newInputStream(0);</span>
<a href="#l111.71"></a><span id="l111.71"> </span>
<a href="#l111.72"></a><span id="l111.72">     uploadChannel.setUploadStream(inputStream,</span>
<a href="#l111.73"></a><span id="l111.73">                                   &quot;text/calendar&quot;, -1);</span>
<a href="#l111.74"></a><span id="l111.74">     try {</span>
<a href="#l111.75"></a><span id="l111.75">         channel.asyncOpen(publishingListener, aProgressDialog);</span>
<a href="#l111.76"></a><span id="l111.76">     } catch (e) {</span>
<a href="#l111.77"></a><span id="l111.77">         let props = Services.strings.createBundle(&quot;chrome://calendar/locale/calendar.properties&quot;);</span>
<a href="#l111.78"></a><span id="l111.78" class="difflineminus">-        Services.prompt.alert(null, calGetString(&quot;calendar&quot;, &quot;genericErrorTitle&quot;),</span>
<a href="#l111.79"></a><span id="l111.79" class="difflineplus">+        Services.prompt.alert(null, cal.calGetString(&quot;calendar&quot;, &quot;genericErrorTitle&quot;),</span>
<a href="#l111.80"></a><span id="l111.80">                               props.formatStringFromName(&quot;otherPutError&quot;, [e.message], 1));</span>
<a href="#l111.81"></a><span id="l111.81">     }</span>
<a href="#l111.82"></a><span id="l111.82"> }</span>
<a href="#l111.83"></a><span id="l111.83"> </span>
<a href="#l111.84"></a><span id="l111.84"> </span>
<a href="#l111.85"></a><span id="l111.85"> var notificationCallbacks = {</span>
<a href="#l111.86"></a><span id="l111.86">     // nsIInterfaceRequestor interface</span>
<a href="#l111.87"></a><span id="l111.87">     getInterface: function(iid, instance) {</span>
<a href="#l111.88"></a><span id="l111.88" class="difflineat">@@ -214,20 +214,20 @@ var publishingListener = {</span>
<a href="#l111.89"></a><span id="l111.89">         try {</span>
<a href="#l111.90"></a><span id="l111.90">             channel = request.QueryInterface(Components.interfaces.nsIHttpChannel);</span>
<a href="#l111.91"></a><span id="l111.91">             requestSucceeded = channel.requestSucceeded;</span>
<a href="#l111.92"></a><span id="l111.92">         } catch (e) {</span>
<a href="#l111.93"></a><span id="l111.93">             // Don't fail if it is not a http channel, will be handled below</span>
<a href="#l111.94"></a><span id="l111.94">         }</span>
<a href="#l111.95"></a><span id="l111.95"> </span>
<a href="#l111.96"></a><span id="l111.96">         if (channel &amp;&amp; !requestSucceeded) {</span>
<a href="#l111.97"></a><span id="l111.97" class="difflineminus">-            Services.prompt.alert(null, calGetString(&quot;calendar&quot;, &quot;genericErrorTitle&quot;),</span>
<a href="#l111.98"></a><span id="l111.98" class="difflineplus">+            Services.prompt.alert(null, cal.calGetString(&quot;calendar&quot;, &quot;genericErrorTitle&quot;),</span>
<a href="#l111.99"></a><span id="l111.99">                                   props.formatStringFromName(&quot;httpPutError&quot;, [channel.responseStatus, channel.responseStatusText], 2));</span>
<a href="#l111.100"></a><span id="l111.100">         } else if (!channel &amp;&amp; !Components.isSuccessCode(request.status)) {</span>
<a href="#l111.101"></a><span id="l111.101">             // XXX this should be made human-readable.</span>
<a href="#l111.102"></a><span id="l111.102" class="difflineminus">-            Services.prompt.alert(null, calGetString(&quot;calendar&quot;, &quot;genericErrorTitle&quot;),</span>
<a href="#l111.103"></a><span id="l111.103" class="difflineplus">+            Services.prompt.alert(null, cal.calGetString(&quot;calendar&quot;, &quot;genericErrorTitle&quot;),</span>
<a href="#l111.104"></a><span id="l111.104">                                   props.formatStringFromName(&quot;otherPutError&quot;, [request.status.toString(16)], 1));</span>
<a href="#l111.105"></a><span id="l111.105">         }</span>
<a href="#l111.106"></a><span id="l111.106">     },</span>
<a href="#l111.107"></a><span id="l111.107"> </span>
<a href="#l111.108"></a><span id="l111.108">     onDataAvailable: function(request, ctxt, inStream, sourceOffset, count) {</span>
<a href="#l111.109"></a><span id="l111.109">     }</span>
<a href="#l111.110"></a><span id="l111.110"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l112.1"></a><span id="l112.1" class="difflineminus">--- a/calendar/resources/content/publishDialog.xul</span>
<a href="#l112.2"></a><span id="l112.2" class="difflineplus">+++ b/calendar/resources/content/publishDialog.xul</span>
<a href="#l112.3"></a><span id="l112.3" class="difflineat">@@ -25,18 +25,16 @@</span>
<a href="#l112.4"></a><span id="l112.4">    ondialogcancel=&quot;return true;&quot;</span>
<a href="#l112.5"></a><span id="l112.5">    onload=&quot;loadCalendarPublishDialog()&quot;</span>
<a href="#l112.6"></a><span id="l112.6">    persist=&quot;screenX screenY&quot;</span>
<a href="#l112.7"></a><span id="l112.7">    xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l112.8"></a><span id="l112.8">    xmlns:nc=&quot;http://home.netscape.com/NC-rdf#&quot;&gt;</span>
<a href="#l112.9"></a><span id="l112.9"> </span>
<a href="#l112.10"></a><span id="l112.10"> </span>
<a href="#l112.11"></a><span id="l112.11">    &lt;!-- Javascript includes --&gt;</span>
<a href="#l112.12"></a><span id="l112.12" class="difflineminus">-</span>
<a href="#l112.13"></a><span id="l112.13" class="difflineminus">-   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/calUtils.js&quot;/&gt;</span>
<a href="#l112.14"></a><span id="l112.14">    &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://calendar/content/publishDialog.js&quot;/&gt;</span>
<a href="#l112.15"></a><span id="l112.15"> </span>
<a href="#l112.16"></a><span id="l112.16">    &lt;script type=&quot;application/javascript&quot; &gt;</span>
<a href="#l112.17"></a><span id="l112.17">    var publishButtonLabel = &quot;&amp;calendar.publish.publish.button;&quot; ;</span>
<a href="#l112.18"></a><span id="l112.18">    var closeButtonLabel = &quot;&amp;calendar.publish.close.button;&quot; ;</span>
<a href="#l112.19"></a><span id="l112.19">    &lt;/script&gt;</span>
<a href="#l112.20"></a><span id="l112.20"> </span>
<a href="#l112.21"></a><span id="l112.21">    &lt;!-- Data used in JS from dtd --&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l113.1"></a><span id="l113.1" class="difflineminus">--- a/calendar/test/mozmill/shared-modules/test-calendar-utils.js</span>
<a href="#l113.2"></a><span id="l113.2" class="difflineplus">+++ b/calendar/test/mozmill/shared-modules/test-calendar-utils.js</span>
<a href="#l113.3"></a><span id="l113.3" class="difflineat">@@ -431,17 +431,17 @@ function viewBack(controller, n) {</span>
<a href="#l113.4"></a><span id="l113.4">  *</span>
<a href="#l113.5"></a><span id="l113.5">  * @param controller    Mozmill window controller</span>
<a href="#l113.6"></a><span id="l113.6">  * @param name          calendar name</span>
<a href="#l113.7"></a><span id="l113.7">  */</span>
<a href="#l113.8"></a><span id="l113.8"> function deleteCalendars(controller, name) {</span>
<a href="#l113.9"></a><span id="l113.9">     let { eid } = helpersForController(controller);</span>
<a href="#l113.10"></a><span id="l113.10"> </span>
<a href="#l113.11"></a><span id="l113.11">     let defaultView = eid(&quot;messengerWindow&quot;).getNode().ownerDocument.defaultView;</span>
<a href="#l113.12"></a><span id="l113.12" class="difflineminus">-    let manager = defaultView.getCalendarManager();</span>
<a href="#l113.13"></a><span id="l113.13" class="difflineplus">+    let manager = defaultView.cal.getCalendarManager();</span>
<a href="#l113.14"></a><span id="l113.14"> </span>
<a href="#l113.15"></a><span id="l113.15">     for (let calendar of manager.getCalendars({})) {</span>
<a href="#l113.16"></a><span id="l113.16">         if (calendar.name == name) {</span>
<a href="#l113.17"></a><span id="l113.17">             manager.removeCalendar(calendar);</span>
<a href="#l113.18"></a><span id="l113.18">         }</span>
<a href="#l113.19"></a><span id="l113.19">     }</span>
<a href="#l113.20"></a><span id="l113.20"> }</span>
<a href="#l113.21"></a><span id="l113.21"> </span>
<a href="#l113.22"></a><span id="l113.22" class="difflineat">@@ -450,19 +450,19 @@ function deleteCalendars(controller, nam</span>
<a href="#l113.23"></a><span id="l113.23">  *</span>
<a href="#l113.24"></a><span id="l113.24">  * @param controller    Mozmill window controller</span>
<a href="#l113.25"></a><span id="l113.25">  * @param name          calendar name</span>
<a href="#l113.26"></a><span id="l113.26">  */</span>
<a href="#l113.27"></a><span id="l113.27"> function createCalendar(controller, name) {</span>
<a href="#l113.28"></a><span id="l113.28">     let { lookup, eid } = helpersForController(controller);</span>
<a href="#l113.29"></a><span id="l113.29"> </span>
<a href="#l113.30"></a><span id="l113.30">     let defaultView = eid(&quot;messengerWindow&quot;).getNode().ownerDocument.defaultView;</span>
<a href="#l113.31"></a><span id="l113.31" class="difflineminus">-    let manager = defaultView.getCalendarManager();</span>
<a href="#l113.32"></a><span id="l113.32" class="difflineplus">+    let manager = defaultView.cal.getCalendarManager();</span>
<a href="#l113.33"></a><span id="l113.33"> </span>
<a href="#l113.34"></a><span id="l113.34" class="difflineminus">-    let url = defaultView.makeURL(&quot;moz-storage-calendar://&quot;);</span>
<a href="#l113.35"></a><span id="l113.35" class="difflineplus">+    let url = defaultView.cal.makeURL(&quot;moz-storage-calendar://&quot;);</span>
<a href="#l113.36"></a><span id="l113.36">     let calendar = manager.createCalendar(&quot;storage&quot;, url);</span>
<a href="#l113.37"></a><span id="l113.37">     calendar.name = name;</span>
<a href="#l113.38"></a><span id="l113.38">     manager.registerCalendar(calendar);</span>
<a href="#l113.39"></a><span id="l113.39"> </span>
<a href="#l113.40"></a><span id="l113.40">     let calendarTree = lookup(`</span>
<a href="#l113.41"></a><span id="l113.41">         /id(&quot;messengerWindow&quot;)/id(&quot;tabmail-container&quot;)/id(&quot;tabmail&quot;)/</span>
<a href="#l113.42"></a><span id="l113.42">         id(&quot;tabpanelcontainer&quot;)/id(&quot;calendarTabPanel&quot;)/id(&quot;calendarContent&quot;)/</span>
<a href="#l113.43"></a><span id="l113.43">         id(&quot;ltnSidebar&quot;)/id(&quot;calendar-panel&quot;)/id(&quot;calendar-list-pane&quot;)/</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l114.1"></a><span id="l114.1" class="difflineminus">--- a/calendar/test/unit/head_consts.js</span>
<a href="#l114.2"></a><span id="l114.2" class="difflineplus">+++ b/calendar/test/unit/head_consts.js</span>
<a href="#l114.3"></a><span id="l114.3" class="difflineat">@@ -23,41 +23,37 @@ var { classes: Cc, interfaces: Ci, resul</span>
<a href="#l114.4"></a><span id="l114.4">     bindir.append(&quot;{e2fda1a4-762b-4020-b5ad-a41df1933103}&quot;);</span>
<a href="#l114.5"></a><span id="l114.5">     bindir.append(&quot;chrome.manifest&quot;);</span>
<a href="#l114.6"></a><span id="l114.6">     dump(&quot;Loading&quot; + bindir.path + &quot;\n&quot;);</span>
<a href="#l114.7"></a><span id="l114.7">     Components.manager.autoRegister(bindir);</span>
<a href="#l114.8"></a><span id="l114.8"> })();</span>
<a href="#l114.9"></a><span id="l114.9"> </span>
<a href="#l114.10"></a><span id="l114.10"> Components.utils.import(&quot;resource://calendar/modules/calUtils.jsm&quot;);</span>
<a href="#l114.11"></a><span id="l114.11"> </span>
<a href="#l114.12"></a><span id="l114.12" class="difflineminus">-// we might want to use calUtils.jsm only in the future throughout all tests,</span>
<a href="#l114.13"></a><span id="l114.13" class="difflineminus">-// but for now source in good old calUtils.js:</span>
<a href="#l114.14"></a><span id="l114.14" class="difflineminus">-cal.loadScripts([&quot;calUtils.js&quot;], Components.utils.getGlobalForObject(Cc));</span>
<a href="#l114.15"></a><span id="l114.15" class="difflineminus">-</span>
<a href="#l114.16"></a><span id="l114.16"> function createDate(aYear, aMonth, aDay, aHasTime, aHour, aMinute, aSecond, aTimezone) {</span>
<a href="#l114.17"></a><span id="l114.17">     let date = Cc[&quot;@mozilla.org/calendar/datetime;1&quot;]</span>
<a href="#l114.18"></a><span id="l114.18">                .createInstance(Ci.calIDateTime);</span>
<a href="#l114.19"></a><span id="l114.19">     date.resetTo(aYear,</span>
<a href="#l114.20"></a><span id="l114.20">                aMonth,</span>
<a href="#l114.21"></a><span id="l114.21">                aDay,</span>
<a href="#l114.22"></a><span id="l114.22">                aHour || 0,</span>
<a href="#l114.23"></a><span id="l114.23">                aMinute || 0,</span>
<a href="#l114.24"></a><span id="l114.24">                aSecond || 0,</span>
<a href="#l114.25"></a><span id="l114.25" class="difflineminus">-               aTimezone || UTC());</span>
<a href="#l114.26"></a><span id="l114.26" class="difflineplus">+               aTimezone || cal.UTC());</span>
<a href="#l114.27"></a><span id="l114.27">     date.isDate = !aHasTime;</span>
<a href="#l114.28"></a><span id="l114.28">     return date;</span>
<a href="#l114.29"></a><span id="l114.29"> }</span>
<a href="#l114.30"></a><span id="l114.30"> </span>
<a href="#l114.31"></a><span id="l114.31"> function createEventFromIcalString(icalString) {</span>
<a href="#l114.32"></a><span id="l114.32">     if (/^BEGIN:VCALENDAR/.test(icalString)) {</span>
<a href="#l114.33"></a><span id="l114.33">         let parser = Components.classes[&quot;@mozilla.org/calendar/ics-parser;1&quot;]</span>
<a href="#l114.34"></a><span id="l114.34">                                .createInstance(Components.interfaces.calIIcsParser);</span>
<a href="#l114.35"></a><span id="l114.35">         parser.parseString(icalString);</span>
<a href="#l114.36"></a><span id="l114.36">         let items = parser.getItems({});</span>
<a href="#l114.37"></a><span id="l114.37" class="difflineminus">-        ASSERT(items.length == 1);</span>
<a href="#l114.38"></a><span id="l114.38" class="difflineplus">+        cal.ASSERT(items.length == 1);</span>
<a href="#l114.39"></a><span id="l114.39">         return items[0];</span>
<a href="#l114.40"></a><span id="l114.40">     } else {</span>
<a href="#l114.41"></a><span id="l114.41">         let event = Cc[&quot;@mozilla.org/calendar/event;1&quot;].createInstance(Ci.calIEvent);</span>
<a href="#l114.42"></a><span id="l114.42">         event.icalString = icalString;</span>
<a href="#l114.43"></a><span id="l114.43">         return event;</span>
<a href="#l114.44"></a><span id="l114.44">     }</span>
<a href="#l114.45"></a><span id="l114.45"> }</span>
<a href="#l114.46"></a><span id="l114.46"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l115.1"></a><span id="l115.1" class="difflineminus">--- a/calendar/test/unit/test_alarm.js</span>
<a href="#l115.2"></a><span id="l115.2" class="difflineplus">+++ b/calendar/test/unit/test_alarm.js</span>
<a href="#l115.3"></a><span id="l115.3" class="difflineat">@@ -147,19 +147,19 @@ function test_audio_alarm() {</span>
<a href="#l115.4"></a><span id="l115.4">         alarm.addAttendee(attendee);</span>
<a href="#l115.5"></a><span id="l115.5">         do_throw(&quot;AUDIO alarm should not be able to save attendees&quot;);</span>
<a href="#l115.6"></a><span id="l115.6">     } catch (e) {</span>
<a href="#l115.7"></a><span id="l115.7">         // TODO looks like this test is disabled. Why?</span>
<a href="#l115.8"></a><span id="l115.8">     }</span>
<a href="#l115.9"></a><span id="l115.9"> </span>
<a href="#l115.10"></a><span id="l115.10">     // Test attachments</span>
<a href="#l115.11"></a><span id="l115.11">     let sound = cal.createAttachment();</span>
<a href="#l115.12"></a><span id="l115.12" class="difflineminus">-    sound.uri = makeURL(&quot;file:///sound.wav&quot;);</span>
<a href="#l115.13"></a><span id="l115.13" class="difflineplus">+    sound.uri = cal.makeURL(&quot;file:///sound.wav&quot;);</span>
<a href="#l115.14"></a><span id="l115.14">     let sound2 = cal.createAttachment();</span>
<a href="#l115.15"></a><span id="l115.15" class="difflineminus">-    sound2.uri = makeURL(&quot;file:///sound2.wav&quot;);</span>
<a href="#l115.16"></a><span id="l115.16" class="difflineplus">+    sound2.uri = cal.makeURL(&quot;file:///sound2.wav&quot;);</span>
<a href="#l115.17"></a><span id="l115.17"> </span>
<a href="#l115.18"></a><span id="l115.18">     // Adding an attachment should work</span>
<a href="#l115.19"></a><span id="l115.19">     alarm.addAttachment(sound);</span>
<a href="#l115.20"></a><span id="l115.20">     let addedAttachments = alarm.getAttachments({});</span>
<a href="#l115.21"></a><span id="l115.21">     equal(addedAttachments.length, 1);</span>
<a href="#l115.22"></a><span id="l115.22">     equal(addedAttachments[0], sound);</span>
<a href="#l115.23"></a><span id="l115.23">     ok(alarm.icalString.includes(&quot;ATTACH:file:///sound.wav&quot;));</span>
<a href="#l115.24"></a><span id="l115.24"> </span>
<a href="#l115.25"></a><span id="l115.25" class="difflineat">@@ -222,19 +222,19 @@ function test_custom_alarm() {</span>
<a href="#l115.26"></a><span id="l115.26">     alarm.deleteAttendee(attendee1);</span>
<a href="#l115.27"></a><span id="l115.27">     equal(alarm.getAttendees({}).length, 1);</span>
<a href="#l115.28"></a><span id="l115.28"> </span>
<a href="#l115.29"></a><span id="l115.29">     alarm.clearAttendees();</span>
<a href="#l115.30"></a><span id="l115.30">     equal(alarm.getAttendees({}).length, 0);</span>
<a href="#l115.31"></a><span id="l115.31"> </span>
<a href="#l115.32"></a><span id="l115.32">     // Test for attachments</span>
<a href="#l115.33"></a><span id="l115.33">     let attach1 = cal.createAttachment();</span>
<a href="#l115.34"></a><span id="l115.34" class="difflineminus">-    attach1.uri = makeURL(&quot;file:///example.txt&quot;);</span>
<a href="#l115.35"></a><span id="l115.35" class="difflineplus">+    attach1.uri = cal.makeURL(&quot;file:///example.txt&quot;);</span>
<a href="#l115.36"></a><span id="l115.36">     let attach2 = cal.createAttachment();</span>
<a href="#l115.37"></a><span id="l115.37" class="difflineminus">-    attach2.uri = makeURL(&quot;file:///example2.txt&quot;);</span>
<a href="#l115.38"></a><span id="l115.38" class="difflineplus">+    attach2.uri = cal.makeURL(&quot;file:///example2.txt&quot;);</span>
<a href="#l115.39"></a><span id="l115.39"> </span>
<a href="#l115.40"></a><span id="l115.40">     alarm.addAttachment(attach1);</span>
<a href="#l115.41"></a><span id="l115.41">     alarm.addAttachment(attach2);</span>
<a href="#l115.42"></a><span id="l115.42"> </span>
<a href="#l115.43"></a><span id="l115.43">     let addedAttachments = alarm.getAttachments({});</span>
<a href="#l115.44"></a><span id="l115.44">     equal(addedAttachments.length, 2);</span>
<a href="#l115.45"></a><span id="l115.45">     equal(addedAttachments[0], attach1);</span>
<a href="#l115.46"></a><span id="l115.46">     equal(addedAttachments[1], attach2);</span>
<a href="#l115.47"></a><span id="l115.47" class="difflineat">@@ -258,17 +258,17 @@ function test_repeat() {</span>
<a href="#l115.48"></a><span id="l115.48">     equal(alarm.repeatOffset, null);</span>
<a href="#l115.49"></a><span id="l115.49">     equal(alarm.repeatDate, null);</span>
<a href="#l115.50"></a><span id="l115.50"> </span>
<a href="#l115.51"></a><span id="l115.51">     // Should not be able to get REPEAT when DURATION is not set</span>
<a href="#l115.52"></a><span id="l115.52">     alarm.repeat = 1;</span>
<a href="#l115.53"></a><span id="l115.53">     equal(alarm.repeat, 0);</span>
<a href="#l115.54"></a><span id="l115.54"> </span>
<a href="#l115.55"></a><span id="l115.55">     // Both REPEAT and DURATION should be accessible, when the two are set.</span>
<a href="#l115.56"></a><span id="l115.56" class="difflineminus">-    alarm.repeatOffset = createDuration();</span>
<a href="#l115.57"></a><span id="l115.57" class="difflineplus">+    alarm.repeatOffset = cal.createDuration();</span>
<a href="#l115.58"></a><span id="l115.58">     notEqual(alarm.repeatOffset, null);</span>
<a href="#l115.59"></a><span id="l115.59">     notEqual(alarm.repeat, 0);</span>
<a href="#l115.60"></a><span id="l115.60"> </span>
<a href="#l115.61"></a><span id="l115.61">     // Should not be able to get DURATION when REPEAT is not set</span>
<a href="#l115.62"></a><span id="l115.62">     alarm.repeat = null;</span>
<a href="#l115.63"></a><span id="l115.63">     equal(alarm.repeatOffset, null);</span>
<a href="#l115.64"></a><span id="l115.64"> </span>
<a href="#l115.65"></a><span id="l115.65">     // Should be able to unset alarm DURATION attribute. (REPEAT already tested above)</span>
<a href="#l115.66"></a><span id="l115.66" class="difflineat">@@ -308,17 +308,17 @@ function test_xprop() {</span>
<a href="#l115.67"></a><span id="l115.67">     equal(alarm.getProperty(&quot;X-PROP&quot;), null);</span>
<a href="#l115.68"></a><span id="l115.68"> </span>
<a href="#l115.69"></a><span id="l115.69">     // also check X-MOZ-LASTACK prop</span>
<a href="#l115.70"></a><span id="l115.70">     let date = cal.createDateTime();</span>
<a href="#l115.71"></a><span id="l115.71">     alarm.setProperty(&quot;X-MOZ-LASTACK&quot;, date.icalString);</span>
<a href="#l115.72"></a><span id="l115.72">     alarm.action = &quot;DISPLAY&quot;;</span>
<a href="#l115.73"></a><span id="l115.73">     alarm.description = &quot;test&quot;;</span>
<a href="#l115.74"></a><span id="l115.74">     alarm.related = Ci.calIAlarm.ALARM_RELATED_START;</span>
<a href="#l115.75"></a><span id="l115.75" class="difflineminus">-    alarm.offset = createDuration(&quot;-PT5M&quot;);</span>
<a href="#l115.76"></a><span id="l115.76" class="difflineplus">+    alarm.offset = cal.createDuration(&quot;-PT5M&quot;);</span>
<a href="#l115.77"></a><span id="l115.77">     ok(alarm.icalComponent.serializeToICS().includes(date.icalString));</span>
<a href="#l115.78"></a><span id="l115.78"> </span>
<a href="#l115.79"></a><span id="l115.79">     alarm.deleteProperty(&quot;X-MOZ-LASTACK&quot;);</span>
<a href="#l115.80"></a><span id="l115.80">     ok(!alarm.icalComponent.serializeToICS().includes(date.icalString));</span>
<a href="#l115.81"></a><span id="l115.81">     dump(&quot;Done\n&quot;);</span>
<a href="#l115.82"></a><span id="l115.82"> }</span>
<a href="#l115.83"></a><span id="l115.83"> </span>
<a href="#l115.84"></a><span id="l115.84"> function test_dates() {</span>
<a href="#l115.85"></a><span id="l115.85" class="difflineat">@@ -326,38 +326,38 @@ function test_dates() {</span>
<a href="#l115.86"></a><span id="l115.86">     let passed;</span>
<a href="#l115.87"></a><span id="l115.87">     // Initial value</span>
<a href="#l115.88"></a><span id="l115.88">     let alarm = cal.createAlarm();</span>
<a href="#l115.89"></a><span id="l115.89">     equal(alarm.alarmDate, null);</span>
<a href="#l115.90"></a><span id="l115.90">     equal(alarm.offset, null);</span>
<a href="#l115.91"></a><span id="l115.91"> </span>
<a href="#l115.92"></a><span id="l115.92">     // Set an offset and check it</span>
<a href="#l115.93"></a><span id="l115.93">     alarm.related = Ci.calIAlarm.ALARM_RELATED_START;</span>
<a href="#l115.94"></a><span id="l115.94" class="difflineminus">-    let offset = createDuration(&quot;-PT5M&quot;);</span>
<a href="#l115.95"></a><span id="l115.95" class="difflineplus">+    let offset = cal.createDuration(&quot;-PT5M&quot;);</span>
<a href="#l115.96"></a><span id="l115.96">     alarm.offset = offset;</span>
<a href="#l115.97"></a><span id="l115.97">     equal(alarm.alarmDate, null);</span>
<a href="#l115.98"></a><span id="l115.98">     equal(alarm.offset, offset);</span>
<a href="#l115.99"></a><span id="l115.99">     try {</span>
<a href="#l115.100"></a><span id="l115.100" class="difflineminus">-        alarm.alarmDate = createDateTime();</span>
<a href="#l115.101"></a><span id="l115.101" class="difflineplus">+        alarm.alarmDate = cal.createDateTime();</span>
<a href="#l115.102"></a><span id="l115.102">         passed = false;</span>
<a href="#l115.103"></a><span id="l115.103">     } catch (e) {</span>
<a href="#l115.104"></a><span id="l115.104">         passed = true;</span>
<a href="#l115.105"></a><span id="l115.105">     }</span>
<a href="#l115.106"></a><span id="l115.106">     if (!passed) {</span>
<a href="#l115.107"></a><span id="l115.107">         do_throw(&quot;Setting alarmDate when alarm is relative should not succeed&quot;);</span>
<a href="#l115.108"></a><span id="l115.108">     }</span>
<a href="#l115.109"></a><span id="l115.109"> </span>
<a href="#l115.110"></a><span id="l115.110">     // Set an absolute time and check it</span>
<a href="#l115.111"></a><span id="l115.111">     alarm.related = Ci.calIAlarm.ALARM_RELATED_ABSOLUTE;</span>
<a href="#l115.112"></a><span id="l115.112">     let alarmDate = createDate(2007, 0, 1, true, 2, 0, 0);</span>
<a href="#l115.113"></a><span id="l115.113">     alarm.alarmDate = alarmDate;</span>
<a href="#l115.114"></a><span id="l115.114">     equal(alarm.alarmDate, alarmDate);</span>
<a href="#l115.115"></a><span id="l115.115">     equal(alarm.offset, null);</span>
<a href="#l115.116"></a><span id="l115.116">     try {</span>
<a href="#l115.117"></a><span id="l115.117" class="difflineminus">-        alarm.offset = createDuration();</span>
<a href="#l115.118"></a><span id="l115.118" class="difflineplus">+        alarm.offset = cal.createDuration();</span>
<a href="#l115.119"></a><span id="l115.119">         passed = false;</span>
<a href="#l115.120"></a><span id="l115.120">     } catch (e) {</span>
<a href="#l115.121"></a><span id="l115.121">         passed = true;</span>
<a href="#l115.122"></a><span id="l115.122">     }</span>
<a href="#l115.123"></a><span id="l115.123">     if (!passed) {</span>
<a href="#l115.124"></a><span id="l115.124">         do_throw(&quot;Setting offset when alarm is absolute should not succeed&quot;);</span>
<a href="#l115.125"></a><span id="l115.125">     }</span>
<a href="#l115.126"></a><span id="l115.126"> </span>
<a href="#l115.127"></a><span id="l115.127" class="difflineat">@@ -365,27 +365,27 @@ function test_dates() {</span>
<a href="#l115.128"></a><span id="l115.128"> }</span>
<a href="#l115.129"></a><span id="l115.129"> </span>
<a href="#l115.130"></a><span id="l115.130"> var propMap = {</span>
<a href="#l115.131"></a><span id="l115.131">     related: Ci.calIAlarm.ALARM_RELATED_START,</span>
<a href="#l115.132"></a><span id="l115.132">     repeat: 1,</span>
<a href="#l115.133"></a><span id="l115.133">     action: &quot;X-TEST&quot;,</span>
<a href="#l115.134"></a><span id="l115.134">     description: &quot;description&quot;,</span>
<a href="#l115.135"></a><span id="l115.135">     summary: &quot;summary&quot;,</span>
<a href="#l115.136"></a><span id="l115.136" class="difflineminus">-    offset: createDuration(&quot;PT4M&quot;),</span>
<a href="#l115.137"></a><span id="l115.137" class="difflineminus">-    repeatOffset: createDuration(&quot;PT1M&quot;)</span>
<a href="#l115.138"></a><span id="l115.138" class="difflineplus">+    offset: cal.createDuration(&quot;PT4M&quot;),</span>
<a href="#l115.139"></a><span id="l115.139" class="difflineplus">+    repeatOffset: cal.createDuration(&quot;PT1M&quot;)</span>
<a href="#l115.140"></a><span id="l115.140"> };</span>
<a href="#l115.141"></a><span id="l115.141"> var clonePropMap = {</span>
<a href="#l115.142"></a><span id="l115.142">     related: Ci.calIAlarm.ALARM_RELATED_END,</span>
<a href="#l115.143"></a><span id="l115.143">     repeat: 2,</span>
<a href="#l115.144"></a><span id="l115.144">     action: &quot;X-CHANGED&quot;,</span>
<a href="#l115.145"></a><span id="l115.145">     description: &quot;description-changed&quot;,</span>
<a href="#l115.146"></a><span id="l115.146">     summary: &quot;summary-changed&quot;,</span>
<a href="#l115.147"></a><span id="l115.147" class="difflineminus">-    offset: createDuration(&quot;PT5M&quot;),</span>
<a href="#l115.148"></a><span id="l115.148" class="difflineminus">-    repeatOffset: createDuration(&quot;PT2M&quot;)</span>
<a href="#l115.149"></a><span id="l115.149" class="difflineplus">+    offset: cal.createDuration(&quot;PT5M&quot;),</span>
<a href="#l115.150"></a><span id="l115.150" class="difflineplus">+    repeatOffset: cal.createDuration(&quot;PT2M&quot;)</span>
<a href="#l115.151"></a><span id="l115.151"> };</span>
<a href="#l115.152"></a><span id="l115.152"> </span>
<a href="#l115.153"></a><span id="l115.153"> function test_immutable() {</span>
<a href="#l115.154"></a><span id="l115.154">     dump(&quot;Testing immutable alarms...&quot;);</span>
<a href="#l115.155"></a><span id="l115.155">     let alarm = cal.createAlarm();</span>
<a href="#l115.156"></a><span id="l115.156">     // Set up each attribute</span>
<a href="#l115.157"></a><span id="l115.157">     for (let prop in propMap) {</span>
<a href="#l115.158"></a><span id="l115.158">         alarm[prop] = propMap[prop];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l116.1"></a><span id="l116.1" class="difflineminus">--- a/calendar/test/unit/test_attachment.js</span>
<a href="#l116.2"></a><span id="l116.2" class="difflineplus">+++ b/calendar/test/unit/test_attachment.js</span>
<a href="#l116.3"></a><span id="l116.3" class="difflineat">@@ -21,17 +21,17 @@ function test_hashes() {</span>
<a href="#l116.4"></a><span id="l116.4">     notEqual(hash1, attach.hashId);</span>
<a href="#l116.5"></a><span id="l116.5"> </span>
<a href="#l116.6"></a><span id="l116.6">     attach.rawData = &quot;hello&quot;;</span>
<a href="#l116.7"></a><span id="l116.7">     equal(hash1, attach.hashId);</span>
<a href="#l116.8"></a><span id="l116.8"> </span>
<a href="#l116.9"></a><span id="l116.9">     // Setting raw data should give us a BINARY attachment</span>
<a href="#l116.10"></a><span id="l116.10">     equal(attach.getParameter(&quot;VALUE&quot;), &quot;BINARY&quot;);</span>
<a href="#l116.11"></a><span id="l116.11"> </span>
<a href="#l116.12"></a><span id="l116.12" class="difflineminus">-    attach.uri = makeURL(&quot;http://hello&quot;);</span>
<a href="#l116.13"></a><span id="l116.13" class="difflineplus">+    attach.uri = cal.makeURL(&quot;http://hello&quot;);</span>
<a href="#l116.14"></a><span id="l116.14"> </span>
<a href="#l116.15"></a><span id="l116.15">     // Setting an uri should delete the value parameter</span>
<a href="#l116.16"></a><span id="l116.16">     equal(attach.getParameter(&quot;VALUE&quot;), null);</span>
<a href="#l116.17"></a><span id="l116.17"> }</span>
<a href="#l116.18"></a><span id="l116.18"> </span>
<a href="#l116.19"></a><span id="l116.19"> function test_uriattach() {</span>
<a href="#l116.20"></a><span id="l116.20">     let attach = cal.createAttachment();</span>
<a href="#l116.21"></a><span id="l116.21"> </span>
<a href="#l116.22"></a><span id="l116.22" class="difflineat">@@ -41,17 +41,17 @@ function test_uriattach() {</span>
<a href="#l116.23"></a><span id="l116.23">                    &quot;ATTACH;FMTTYPE=x-moz/test:http://hello\r\n&quot; +</span>
<a href="#l116.24"></a><span id="l116.24">                    &quot;END:VEVENT&quot;;</span>
<a href="#l116.25"></a><span id="l116.25">     let prop = e.icalComponent.getFirstProperty(&quot;ATTACH&quot;);</span>
<a href="#l116.26"></a><span id="l116.26">     attach.icalProperty = prop;</span>
<a href="#l116.27"></a><span id="l116.27"> </span>
<a href="#l116.28"></a><span id="l116.28">     notEqual(attach.getParameter(&quot;VALUE&quot;), &quot;BINARY&quot;);</span>
<a href="#l116.29"></a><span id="l116.29">     equal(attach.formatType, &quot;x-moz/test&quot;);</span>
<a href="#l116.30"></a><span id="l116.30">     equal(attach.getParameter(&quot;FMTTYPE&quot;), &quot;x-moz/test&quot;);</span>
<a href="#l116.31"></a><span id="l116.31" class="difflineminus">-    equal(attach.uri.spec, makeURL(&quot;http://hello&quot;).spec);</span>
<a href="#l116.32"></a><span id="l116.32" class="difflineplus">+    equal(attach.uri.spec, cal.makeURL(&quot;http://hello&quot;).spec);</span>
<a href="#l116.33"></a><span id="l116.33">     equal(attach.rawData, &quot;http://hello&quot;);</span>
<a href="#l116.34"></a><span id="l116.34"> }</span>
<a href="#l116.35"></a><span id="l116.35"> </span>
<a href="#l116.36"></a><span id="l116.36"> function test_binaryattach() {</span>
<a href="#l116.37"></a><span id="l116.37">     let attach = cal.createAttachment();</span>
<a href="#l116.38"></a><span id="l116.38">     let e = cal.createEvent();</span>
<a href="#l116.39"></a><span id="l116.39"> </span>
<a href="#l116.40"></a><span id="l116.40">     let attachString =</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l117.1"></a><span id="l117.1" class="difflineminus">--- a/calendar/test/unit/test_bug486186.js</span>
<a href="#l117.2"></a><span id="l117.2" class="difflineplus">+++ b/calendar/test/unit/test_bug486186.js</span>
<a href="#l117.3"></a><span id="l117.3" class="difflineat">@@ -3,13 +3,13 @@</span>
<a href="#l117.4"></a><span id="l117.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l117.5"></a><span id="l117.5"> </span>
<a href="#l117.6"></a><span id="l117.6"> function run_test() {</span>
<a href="#l117.7"></a><span id="l117.7">     // ensure that RELATED property is correctly set on the VALARM component</span>
<a href="#l117.8"></a><span id="l117.8">     let alarm = cal.createAlarm();</span>
<a href="#l117.9"></a><span id="l117.9">     alarm.action = &quot;DISPLAY&quot;;</span>
<a href="#l117.10"></a><span id="l117.10">     alarm.description = &quot;test&quot;;</span>
<a href="#l117.11"></a><span id="l117.11">     alarm.related = Ci.calIAlarm.ALARM_RELATED_END;</span>
<a href="#l117.12"></a><span id="l117.12" class="difflineminus">-    alarm.offset = createDuration(&quot;-PT15M&quot;);</span>
<a href="#l117.13"></a><span id="l117.13" class="difflineplus">+    alarm.offset = cal.createDuration(&quot;-PT15M&quot;);</span>
<a href="#l117.14"></a><span id="l117.14">     if (alarm.icalString.search(/RELATED=END/) == -1) {</span>
<a href="#l117.15"></a><span id="l117.15">         do_throw(&quot;Bug 486186: RELATED property missing in VALARM component&quot;);</span>
<a href="#l117.16"></a><span id="l117.16">     }</span>
<a href="#l117.17"></a><span id="l117.17"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l118.1"></a><span id="l118.1" class="difflineminus">--- a/calendar/test/unit/test_freebusy_service.js</span>
<a href="#l118.2"></a><span id="l118.2" class="difflineplus">+++ b/calendar/test/unit/test_freebusy_service.js</span>
<a href="#l118.3"></a><span id="l118.3" class="difflineat">@@ -151,17 +151,17 @@ function test_cancel() {</span>
<a href="#l118.4"></a><span id="l118.4">                                                   cIFI.BUSY_ALL,</span>
<a href="#l118.5"></a><span id="l118.5">                                                   listener);</span>
<a href="#l118.6"></a><span id="l118.6"> }</span>
<a href="#l118.7"></a><span id="l118.7"> </span>
<a href="#l118.8"></a><span id="l118.8"> // The following functions are not in the interface description and probably</span>
<a href="#l118.9"></a><span id="l118.9"> // don't need to be. Make assumptions about the implementation instead.</span>
<a href="#l118.10"></a><span id="l118.10"> </span>
<a href="#l118.11"></a><span id="l118.11"> function _clearProviders() {</span>
<a href="#l118.12"></a><span id="l118.12" class="difflineminus">-    freebusy.wrappedJSObject.mProviders = new calInterfaceBag(Components.interfaces.calIFreeBusyProvider);</span>
<a href="#l118.13"></a><span id="l118.13" class="difflineplus">+    freebusy.wrappedJSObject.mProviders = new cal.calInterfaceBag(Components.interfaces.calIFreeBusyProvider);</span>
<a href="#l118.14"></a><span id="l118.14"> }</span>
<a href="#l118.15"></a><span id="l118.15"> </span>
<a href="#l118.16"></a><span id="l118.16"> function _countProviders() {</span>
<a href="#l118.17"></a><span id="l118.17">     return freebusy.wrappedJSObject.mProviders.interfaceArray.length;</span>
<a href="#l118.18"></a><span id="l118.18"> }</span>
<a href="#l118.19"></a><span id="l118.19"> </span>
<a href="#l118.20"></a><span id="l118.20"> function _getFirstProvider() {</span>
<a href="#l118.21"></a><span id="l118.21">     return freebusy.wrappedJSObject.mProviders.interfaceArray[0].wrappedJSObject;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l119.1"></a><span id="l119.1" class="difflineminus">--- a/calendar/test/unit/test_ltninvitationutils.js</span>
<a href="#l119.2"></a><span id="l119.2" class="difflineplus">+++ b/calendar/test/unit/test_ltninvitationutils.js</span>
<a href="#l119.3"></a><span id="l119.3" class="difflineat">@@ -1037,17 +1037,17 @@ add_task(function* parseCounter_test() {</span>
<a href="#l119.4"></a><span id="l119.4">                 }</span>
<a href="#l119.5"></a><span id="l119.5">             });</span>
<a href="#l119.6"></a><span id="l119.6">         }</span>
<a href="#l119.7"></a><span id="l119.7">         item = item.join(&quot;\r\n&quot;);</span>
<a href="#l119.8"></a><span id="l119.8">         return createEventFromIcalString(item);</span>
<a href="#l119.9"></a><span id="l119.9">     };</span>
<a href="#l119.10"></a><span id="l119.10"> </span>
<a href="#l119.11"></a><span id="l119.11">     let formatDt = function (aDateTime) {</span>
<a href="#l119.12"></a><span id="l119.12" class="difflineminus">-        let datetime = getDateFormatter().formatDateTime(aDateTime);</span>
<a href="#l119.13"></a><span id="l119.13" class="difflineplus">+        let datetime = cal.getDateFormatter().formatDateTime(aDateTime);</span>
<a href="#l119.14"></a><span id="l119.14">         return datetime += &quot; &quot; + aDateTime.timezone.displayName;</span>
<a href="#l119.15"></a><span id="l119.15">     };</span>
<a href="#l119.16"></a><span id="l119.16"> </span>
<a href="#l119.17"></a><span id="l119.17">     for (let i = 1; i &lt;= data.length; i++) {</span>
<a href="#l119.18"></a><span id="l119.18">         let test = data[i - 1];</span>
<a href="#l119.19"></a><span id="l119.19">         let existingItem = getItem(test.input.existing);</span>
<a href="#l119.20"></a><span id="l119.20">         let proposedItem = getItem(test.input.proposed);</span>
<a href="#l119.21"></a><span id="l119.21">         let parsed = ltn.invitation.parseCounter(proposedItem, existingItem);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l120.1"></a><span id="l120.1" class="difflineminus">--- a/calendar/test/unit/test_recur.js</span>
<a href="#l120.2"></a><span id="l120.2" class="difflineplus">+++ b/calendar/test/unit/test_recur.js</span>
<a href="#l120.3"></a><span id="l120.3" class="difflineat">@@ -504,17 +504,17 @@ function test_clone(event) {</span>
<a href="#l120.4"></a><span id="l120.4"> function test_interface() {</span>
<a href="#l120.5"></a><span id="l120.5">     let item = makeEvent(&quot;DTSTART:20020402T114500Z\n&quot; +</span>
<a href="#l120.6"></a><span id="l120.6">                          &quot;DTEND:20020402T124500Z\n&quot; +</span>
<a href="#l120.7"></a><span id="l120.7">                          &quot;RRULE:FREQ=WEEKLY;COUNT=6;BYDAY=TU,WE\r\n&quot; +</span>
<a href="#l120.8"></a><span id="l120.8">                          &quot;EXDATE:20020403T114500Z\r\n&quot; +</span>
<a href="#l120.9"></a><span id="l120.9">                          &quot;RDATE:20020401T114500Z\r\n&quot;);</span>
<a href="#l120.10"></a><span id="l120.10"> </span>
<a href="#l120.11"></a><span id="l120.11">     let rinfo = item.recurrenceInfo;</span>
<a href="#l120.12"></a><span id="l120.12" class="difflineminus">-    ok(compareObjects(rinfo.item, item, Components.interfaces.calIEvent));</span>
<a href="#l120.13"></a><span id="l120.13" class="difflineplus">+    ok(cal.compareObjects(rinfo.item, item, Components.interfaces.calIEvent));</span>
<a href="#l120.14"></a><span id="l120.14"> </span>
<a href="#l120.15"></a><span id="l120.15">     // getRecurrenceItems</span>
<a href="#l120.16"></a><span id="l120.16">     let ritems = rinfo.getRecurrenceItems({});</span>
<a href="#l120.17"></a><span id="l120.17">     equal(ritems.length, 3);</span>
<a href="#l120.18"></a><span id="l120.18"> </span>
<a href="#l120.19"></a><span id="l120.19">     let checkritems = new Map(ritems.map(ritem =&gt; [ritem.icalProperty.propertyName, ritem.icalProperty]));</span>
<a href="#l120.20"></a><span id="l120.20">     let rparts = new Map(checkritems.get(&quot;RRULE&quot;).value.split(&quot;;&quot;).map(value =&gt; value.split(&quot;=&quot;, 2)));</span>
<a href="#l120.21"></a><span id="l120.21">     equal(rparts.size, 3);</span>
<a href="#l120.22"></a><span id="l120.22" class="difflineat">@@ -554,42 +554,42 @@ function test_interface() {</span>
<a href="#l120.23"></a><span id="l120.23">     rinfo.clearRecurrenceItems();</span>
<a href="#l120.24"></a><span id="l120.24">     equal(0, rinfo.countRecurrenceItems());</span>
<a href="#l120.25"></a><span id="l120.25"> </span>
<a href="#l120.26"></a><span id="l120.26">     // appendRecurrenceItems / getRecurrenceItemAt / insertRecurrenceItemAt</span>
<a href="#l120.27"></a><span id="l120.27">     rinfo.appendRecurrenceItem(ritems[0]);</span>
<a href="#l120.28"></a><span id="l120.28">     rinfo.appendRecurrenceItem(ritems[1]);</span>
<a href="#l120.29"></a><span id="l120.29">     rinfo.insertRecurrenceItemAt(ritems[2], 0);</span>
<a href="#l120.30"></a><span id="l120.30"> </span>
<a href="#l120.31"></a><span id="l120.31" class="difflineminus">-    ok(compareObjects(ritems[2],</span>
<a href="#l120.32"></a><span id="l120.32" class="difflineminus">-                                 rinfo.getRecurrenceItemAt(0),</span>
<a href="#l120.33"></a><span id="l120.33" class="difflineminus">-                                 Components.interfaces.calIRecurrenceItem));</span>
<a href="#l120.34"></a><span id="l120.34" class="difflineminus">-    ok(compareObjects(ritems[0],</span>
<a href="#l120.35"></a><span id="l120.35" class="difflineminus">-                                 rinfo.getRecurrenceItemAt(1),</span>
<a href="#l120.36"></a><span id="l120.36" class="difflineminus">-                                 Components.interfaces.calIRecurrenceItem));</span>
<a href="#l120.37"></a><span id="l120.37" class="difflineminus">-    ok(compareObjects(ritems[1],</span>
<a href="#l120.38"></a><span id="l120.38" class="difflineminus">-                                 rinfo.getRecurrenceItemAt(2),</span>
<a href="#l120.39"></a><span id="l120.39" class="difflineminus">-                                 Components.interfaces.calIRecurrenceItem));</span>
<a href="#l120.40"></a><span id="l120.40" class="difflineplus">+    ok(cal.compareObjects(ritems[2],</span>
<a href="#l120.41"></a><span id="l120.41" class="difflineplus">+                          rinfo.getRecurrenceItemAt(0),</span>
<a href="#l120.42"></a><span id="l120.42" class="difflineplus">+                          Components.interfaces.calIRecurrenceItem));</span>
<a href="#l120.43"></a><span id="l120.43" class="difflineplus">+    ok(cal.compareObjects(ritems[0],</span>
<a href="#l120.44"></a><span id="l120.44" class="difflineplus">+                          rinfo.getRecurrenceItemAt(1),</span>
<a href="#l120.45"></a><span id="l120.45" class="difflineplus">+                          Components.interfaces.calIRecurrenceItem));</span>
<a href="#l120.46"></a><span id="l120.46" class="difflineplus">+    ok(cal.compareObjects(ritems[1],</span>
<a href="#l120.47"></a><span id="l120.47" class="difflineplus">+                          rinfo.getRecurrenceItemAt(2),</span>
<a href="#l120.48"></a><span id="l120.48" class="difflineplus">+                          Components.interfaces.calIRecurrenceItem));</span>
<a href="#l120.49"></a><span id="l120.49"> </span>
<a href="#l120.50"></a><span id="l120.50"> </span>
<a href="#l120.51"></a><span id="l120.51">     // deleteRecurrenceItem</span>
<a href="#l120.52"></a><span id="l120.52">     rinfo.deleteRecurrenceItem(ritems[0]);</span>
<a href="#l120.53"></a><span id="l120.53">     ok(!item.icalString.includes(&quot;RRULE&quot;));</span>
<a href="#l120.54"></a><span id="l120.54"> </span>
<a href="#l120.55"></a><span id="l120.55">     // deleteRecurrenceItemAt</span>
<a href="#l120.56"></a><span id="l120.56">     rinfo.deleteRecurrenceItemAt(1);</span>
<a href="#l120.57"></a><span id="l120.57">     itemString = item.icalString;</span>
<a href="#l120.58"></a><span id="l120.58">     ok(!itemString.includes(&quot;EXDATE&quot;));</span>
<a href="#l120.59"></a><span id="l120.59">     ok(itemString.includes(&quot;RDATE&quot;));</span>
<a href="#l120.60"></a><span id="l120.60"> </span>
<a href="#l120.61"></a><span id="l120.61">     // insertRecurrenceItemAt with exdate</span>
<a href="#l120.62"></a><span id="l120.62">     rinfo.insertRecurrenceItemAt(ritems[1], 1);</span>
<a href="#l120.63"></a><span id="l120.63" class="difflineminus">-    ok(compareObjects(ritems[1],</span>
<a href="#l120.64"></a><span id="l120.64" class="difflineminus">-                                 rinfo.getRecurrenceItemAt(1),</span>
<a href="#l120.65"></a><span id="l120.65" class="difflineminus">-                                 Components.interfaces.calIRecurrenceItem));</span>
<a href="#l120.66"></a><span id="l120.66" class="difflineplus">+    ok(cal.compareObjects(ritems[1],</span>
<a href="#l120.67"></a><span id="l120.67" class="difflineplus">+                          rinfo.getRecurrenceItemAt(1),</span>
<a href="#l120.68"></a><span id="l120.68" class="difflineplus">+                          Components.interfaces.calIRecurrenceItem));</span>
<a href="#l120.69"></a><span id="l120.69">     rinfo.deleteRecurrenceItem(ritems[1]);</span>
<a href="#l120.70"></a><span id="l120.70"> </span>
<a href="#l120.71"></a><span id="l120.71">     // isFinite = true</span>
<a href="#l120.72"></a><span id="l120.72">     ok(rinfo.isFinite);</span>
<a href="#l120.73"></a><span id="l120.73">     rinfo.appendRecurrenceItem(ritems[0]);</span>
<a href="#l120.74"></a><span id="l120.74">     ok(rinfo.isFinite);</span>
<a href="#l120.75"></a><span id="l120.75"> </span>
<a href="#l120.76"></a><span id="l120.76">     // isFinite = false</span>
<a href="#l120.77"></a><span id="l120.77" class="difflineat">@@ -809,104 +809,104 @@ function test_immutable() {</span>
<a href="#l120.78"></a><span id="l120.78">     rinfo.makeImmutable(); // Doing so twice shouldn't throw</span>
<a href="#l120.79"></a><span id="l120.79">     throws(() =&gt; rinfo.appendRecurrenceItem(ritem), /Can not modify immutable data container/);</span>
<a href="#l120.80"></a><span id="l120.80">     ok(!rinfo.isMutable);</span>
<a href="#l120.81"></a><span id="l120.81"> </span>
<a href="#l120.82"></a><span id="l120.82">     item.recurrenceInfo.appendRecurrenceItem(ritem);</span>
<a href="#l120.83"></a><span id="l120.83"> }</span>
<a href="#l120.84"></a><span id="l120.84"> </span>
<a href="#l120.85"></a><span id="l120.85"> function test_rrule_icalstring() {</span>
<a href="#l120.86"></a><span id="l120.86" class="difflineminus">-    let recRule = createRecurrenceRule();</span>
<a href="#l120.87"></a><span id="l120.87" class="difflineplus">+    let recRule = cal.createRecurrenceRule();</span>
<a href="#l120.88"></a><span id="l120.88">     recRule.type = &quot;DAILY&quot;;</span>
<a href="#l120.89"></a><span id="l120.89">     recRule.interval = 4;</span>
<a href="#l120.90"></a><span id="l120.90">     equal(recRule.icalString, &quot;RRULE:FREQ=DAILY;INTERVAL=4\r\n&quot;);</span>
<a href="#l120.91"></a><span id="l120.91"> </span>
<a href="#l120.92"></a><span id="l120.92" class="difflineminus">-    recRule = createRecurrenceRule();</span>
<a href="#l120.93"></a><span id="l120.93" class="difflineplus">+    recRule = cal.createRecurrenceRule();</span>
<a href="#l120.94"></a><span id="l120.94">     recRule.type = &quot;DAILY&quot;;</span>
<a href="#l120.95"></a><span id="l120.95">     recRule.setComponent(&quot;BYDAY&quot;, 5, [2, 3, 4, 5, 6]);</span>
<a href="#l120.96"></a><span id="l120.96">     equal(recRule.icalString, &quot;RRULE:FREQ=DAILY;BYDAY=MO,TU,WE,TH,FR\r\n&quot;);</span>
<a href="#l120.97"></a><span id="l120.97">     deepEqual(recRule.getComponent(&quot;BYDAY&quot;, {}), [2, 3, 4, 5, 6]);</span>
<a href="#l120.98"></a><span id="l120.98"> </span>
<a href="#l120.99"></a><span id="l120.99" class="difflineminus">-    recRule = createRecurrenceRule();</span>
<a href="#l120.100"></a><span id="l120.100" class="difflineplus">+    recRule = cal.createRecurrenceRule();</span>
<a href="#l120.101"></a><span id="l120.101">     recRule.type = &quot;WEEKLY&quot;;</span>
<a href="#l120.102"></a><span id="l120.102">     recRule.interval = 3;</span>
<a href="#l120.103"></a><span id="l120.103">     recRule.setComponent(&quot;BYDAY&quot;, 3, [2, 4, 6]);</span>
<a href="#l120.104"></a><span id="l120.104">     equal(recRule.icalString, &quot;RRULE:FREQ=WEEKLY;INTERVAL=3;BYDAY=MO,WE,FR\r\n&quot;);</span>
<a href="#l120.105"></a><span id="l120.105">     deepEqual(recRule.getComponent(&quot;BYDAY&quot;, {}), [2, 4, 6]);</span>
<a href="#l120.106"></a><span id="l120.106"> </span>
<a href="#l120.107"></a><span id="l120.107" class="difflineminus">-    recRule = createRecurrenceRule();</span>
<a href="#l120.108"></a><span id="l120.108" class="difflineplus">+    recRule = cal.createRecurrenceRule();</span>
<a href="#l120.109"></a><span id="l120.109">     recRule.type = &quot;MONTHLY&quot;;</span>
<a href="#l120.110"></a><span id="l120.110">     recRule.setComponent(&quot;BYDAY&quot;, 7, [2, 3, 4, 5, 6, 7, 1]);</span>
<a href="#l120.111"></a><span id="l120.111">     equal(recRule.icalString, &quot;RRULE:FREQ=MONTHLY;BYDAY=MO,TU,WE,TH,FR,SA,SU\r\n&quot;);</span>
<a href="#l120.112"></a><span id="l120.112">     deepEqual(recRule.getComponent(&quot;BYDAY&quot;, {}), [2, 3, 4, 5, 6, 7, 1]);</span>
<a href="#l120.113"></a><span id="l120.113"> </span>
<a href="#l120.114"></a><span id="l120.114" class="difflineminus">-    recRule = createRecurrenceRule();</span>
<a href="#l120.115"></a><span id="l120.115" class="difflineplus">+    recRule = cal.createRecurrenceRule();</span>
<a href="#l120.116"></a><span id="l120.116">     recRule.type = &quot;MONTHLY&quot;;</span>
<a href="#l120.117"></a><span id="l120.117">     recRule.setComponent(&quot;BYDAY&quot;, 1, [10]);</span>
<a href="#l120.118"></a><span id="l120.118">     equal(recRule.icalString, &quot;RRULE:FREQ=MONTHLY;BYDAY=1MO\r\n&quot;);</span>
<a href="#l120.119"></a><span id="l120.119">     deepEqual(recRule.getComponent(&quot;BYDAY&quot;, {}), [10]);</span>
<a href="#l120.120"></a><span id="l120.120"> </span>
<a href="#l120.121"></a><span id="l120.121" class="difflineminus">-    recRule = createRecurrenceRule();</span>
<a href="#l120.122"></a><span id="l120.122" class="difflineplus">+    recRule = cal.createRecurrenceRule();</span>
<a href="#l120.123"></a><span id="l120.123">     recRule.type = &quot;MONTHLY&quot;;</span>
<a href="#l120.124"></a><span id="l120.124">     recRule.setComponent(&quot;BYDAY&quot;, 1, [20]);</span>
<a href="#l120.125"></a><span id="l120.125">     equal(recRule.icalString, &quot;RRULE:FREQ=MONTHLY;BYDAY=2WE\r\n&quot;);</span>
<a href="#l120.126"></a><span id="l120.126">     deepEqual(recRule.getComponent(&quot;BYDAY&quot;, {}), [20]);</span>
<a href="#l120.127"></a><span id="l120.127"> </span>
<a href="#l120.128"></a><span id="l120.128" class="difflineminus">-    recRule = createRecurrenceRule();</span>
<a href="#l120.129"></a><span id="l120.129" class="difflineplus">+    recRule = cal.createRecurrenceRule();</span>
<a href="#l120.130"></a><span id="l120.130">     recRule.type = &quot;MONTHLY&quot;;</span>
<a href="#l120.131"></a><span id="l120.131">     recRule.setComponent(&quot;BYDAY&quot;, 1, [-22]);</span>
<a href="#l120.132"></a><span id="l120.132">     equal(recRule.icalString, &quot;RRULE:FREQ=MONTHLY;BYDAY=-2FR\r\n&quot;);</span>
<a href="#l120.133"></a><span id="l120.133">     deepEqual(recRule.getComponent(&quot;BYDAY&quot;, {}), [-22]);</span>
<a href="#l120.134"></a><span id="l120.134"> </span>
<a href="#l120.135"></a><span id="l120.135" class="difflineminus">-    recRule = createRecurrenceRule();</span>
<a href="#l120.136"></a><span id="l120.136" class="difflineplus">+    recRule = cal.createRecurrenceRule();</span>
<a href="#l120.137"></a><span id="l120.137">     recRule.type = &quot;MONTHLY&quot;;</span>
<a href="#l120.138"></a><span id="l120.138">     recRule.setComponent(&quot;BYMONTHDAY&quot;, 1, [5]);</span>
<a href="#l120.139"></a><span id="l120.139">     equal(recRule.icalString, &quot;RRULE:FREQ=MONTHLY;BYMONTHDAY=5\r\n&quot;);</span>
<a href="#l120.140"></a><span id="l120.140">     deepEqual(recRule.getComponent(&quot;BYMONTHDAY&quot;, {}), [5]);</span>
<a href="#l120.141"></a><span id="l120.141"> </span>
<a href="#l120.142"></a><span id="l120.142" class="difflineminus">-    recRule = createRecurrenceRule();</span>
<a href="#l120.143"></a><span id="l120.143" class="difflineplus">+    recRule = cal.createRecurrenceRule();</span>
<a href="#l120.144"></a><span id="l120.144">     recRule.type = &quot;MONTHLY&quot;;</span>
<a href="#l120.145"></a><span id="l120.145">     recRule.setComponent(&quot;BYMONTHDAY&quot;, 3, [1, 9, 17]);</span>
<a href="#l120.146"></a><span id="l120.146">     equal(recRule.icalString, &quot;RRULE:FREQ=MONTHLY;BYMONTHDAY=1,9,17\r\n&quot;);</span>
<a href="#l120.147"></a><span id="l120.147">     deepEqual(recRule.getComponent(&quot;BYMONTHDAY&quot;, {}), [1, 9, 17]);</span>
<a href="#l120.148"></a><span id="l120.148"> </span>
<a href="#l120.149"></a><span id="l120.149" class="difflineminus">-    recRule = createRecurrenceRule();</span>
<a href="#l120.150"></a><span id="l120.150" class="difflineplus">+    recRule = cal.createRecurrenceRule();</span>
<a href="#l120.151"></a><span id="l120.151">     recRule.type = &quot;YEARLY&quot;;</span>
<a href="#l120.152"></a><span id="l120.152">     recRule.setComponent(&quot;BYMONTH&quot;, 1, [1]);</span>
<a href="#l120.153"></a><span id="l120.153">     recRule.setComponent(&quot;BYMONTHDAY&quot;, 1, [3]);</span>
<a href="#l120.154"></a><span id="l120.154">     ok([</span>
<a href="#l120.155"></a><span id="l120.155">         &quot;RRULE:FREQ=YEARLY;BYMONTHDAY=3;BYMONTH=1\r\n&quot;,</span>
<a href="#l120.156"></a><span id="l120.156">         &quot;RRULE:FREQ=YEARLY;BYMONTH=1;BYMONTHDAY=3\r\n&quot;</span>
<a href="#l120.157"></a><span id="l120.157">     ].includes(recRule.icalString));</span>
<a href="#l120.158"></a><span id="l120.158">     deepEqual(recRule.getComponent(&quot;BYMONTH&quot;, {}), [1]);</span>
<a href="#l120.159"></a><span id="l120.159">     deepEqual(recRule.getComponent(&quot;BYMONTHDAY&quot;, {}), [3]);</span>
<a href="#l120.160"></a><span id="l120.160"> </span>
<a href="#l120.161"></a><span id="l120.161" class="difflineminus">-    recRule = createRecurrenceRule();</span>
<a href="#l120.162"></a><span id="l120.162" class="difflineplus">+    recRule = cal.createRecurrenceRule();</span>
<a href="#l120.163"></a><span id="l120.163">     recRule.type = &quot;YEARLY&quot;;</span>
<a href="#l120.164"></a><span id="l120.164">     recRule.setComponent(&quot;BYMONTH&quot;, 1, [4]);</span>
<a href="#l120.165"></a><span id="l120.165">     recRule.setComponent(&quot;BYDAY&quot;, 1, [3]);</span>
<a href="#l120.166"></a><span id="l120.166">     ok([</span>
<a href="#l120.167"></a><span id="l120.167">         &quot;RRULE:FREQ=YEARLY;BYDAY=TU;BYMONTH=4\r\n&quot;,</span>
<a href="#l120.168"></a><span id="l120.168">         &quot;RRULE:FREQ=YEARLY;BYMONTH=4;BYDAY=TU\r\n&quot;</span>
<a href="#l120.169"></a><span id="l120.169">     ].includes(recRule.icalString));</span>
<a href="#l120.170"></a><span id="l120.170">     deepEqual(recRule.getComponent(&quot;BYMONTH&quot;, {}), [4]);</span>
<a href="#l120.171"></a><span id="l120.171">     deepEqual(recRule.getComponent(&quot;BYDAY&quot;, {}), [3]);</span>
<a href="#l120.172"></a><span id="l120.172"> </span>
<a href="#l120.173"></a><span id="l120.173" class="difflineminus">-    recRule = createRecurrenceRule();</span>
<a href="#l120.174"></a><span id="l120.174" class="difflineplus">+    recRule = cal.createRecurrenceRule();</span>
<a href="#l120.175"></a><span id="l120.175">     recRule.type = &quot;YEARLY&quot;;</span>
<a href="#l120.176"></a><span id="l120.176">     recRule.setComponent(&quot;BYMONTH&quot;, 1, [4]);</span>
<a href="#l120.177"></a><span id="l120.177">     recRule.setComponent(&quot;BYDAY&quot;, 1, [10]);</span>
<a href="#l120.178"></a><span id="l120.178">     ok([</span>
<a href="#l120.179"></a><span id="l120.179">         &quot;RRULE:FREQ=YEARLY;BYDAY=1MO;BYMONTH=4\r\n&quot;,</span>
<a href="#l120.180"></a><span id="l120.180">         &quot;RRULE:FREQ=YEARLY;BYMONTH=4;BYDAY=1MO\r\n&quot;</span>
<a href="#l120.181"></a><span id="l120.181">     ].includes(recRule.icalString));</span>
<a href="#l120.182"></a><span id="l120.182">     deepEqual(recRule.getComponent(&quot;BYMONTH&quot;, {}), [4]);</span>
<a href="#l120.183"></a><span id="l120.183">     deepEqual(recRule.getComponent(&quot;BYDAY&quot;, {}), [10]);</span>
<a href="#l120.184"></a><span id="l120.184"> </span>
<a href="#l120.185"></a><span id="l120.185" class="difflineminus">-    recRule = createRecurrenceRule();</span>
<a href="#l120.186"></a><span id="l120.186" class="difflineplus">+    recRule = cal.createRecurrenceRule();</span>
<a href="#l120.187"></a><span id="l120.187">     recRule.type = &quot;YEARLY&quot;;</span>
<a href="#l120.188"></a><span id="l120.188">     recRule.setComponent(&quot;BYMONTH&quot;, 1, [4]);</span>
<a href="#l120.189"></a><span id="l120.189">     recRule.setComponent(&quot;BYDAY&quot;, 1, [-22]);</span>
<a href="#l120.190"></a><span id="l120.190">     ok([</span>
<a href="#l120.191"></a><span id="l120.191">         &quot;RRULE:FREQ=YEARLY;BYDAY=-2FR;BYMONTH=4\r\n&quot;,</span>
<a href="#l120.192"></a><span id="l120.192">         &quot;RRULE:FREQ=YEARLY;BYMONTH=4;BYDAY=-2FR\r\n&quot;</span>
<a href="#l120.193"></a><span id="l120.193">     ].includes(recRule.icalString));</span>
<a href="#l120.194"></a><span id="l120.194">     deepEqual(recRule.getComponent(&quot;BYMONTH&quot;, {}), [4]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l121.1"></a><span id="l121.1" class="difflineminus">--- a/calendar/test/unit/test_utils.js</span>
<a href="#l121.2"></a><span id="l121.2" class="difflineplus">+++ b/calendar/test/unit/test_utils.js</span>
<a href="#l121.3"></a><span id="l121.3" class="difflineat">@@ -177,16 +177,16 @@ function test_sameDay() {</span>
<a href="#l121.4"></a><span id="l121.4">     ok(cal.sameDay(createDate(&quot;20120101&quot;), createDate(&quot;20120101T120000&quot;)));</span>
<a href="#l121.5"></a><span id="l121.5">     ok(cal.sameDay(createDate(&quot;20120101&quot;), createDate(&quot;20120101&quot;)));</span>
<a href="#l121.6"></a><span id="l121.6">     ok(!cal.sameDay(createDate(&quot;20120101&quot;), createDate(&quot;20120102&quot;)));</span>
<a href="#l121.7"></a><span id="l121.7">     ok(!cal.sameDay(createDate(&quot;20120101T120000&quot;), createDate(&quot;20120102T120000&quot;)));</span>
<a href="#l121.8"></a><span id="l121.8"> }</span>
<a href="#l121.9"></a><span id="l121.9"> </span>
<a href="#l121.10"></a><span id="l121.10"> function test_binarySearch() {</span>
<a href="#l121.11"></a><span id="l121.11">     let arr = [2, 5, 7, 9, 20, 27, 34, 39, 41, 53, 62];</span>
<a href="#l121.12"></a><span id="l121.12" class="difflineminus">-    equal(binarySearch(arr, 27), 5); // Center</span>
<a href="#l121.13"></a><span id="l121.13" class="difflineminus">-    equal(binarySearch(arr, 2), 0); // Left most</span>
<a href="#l121.14"></a><span id="l121.14" class="difflineminus">-    equal(binarySearch(arr, 62), 11); // Right most</span>
<a href="#l121.15"></a><span id="l121.15" class="difflineplus">+    equal(cal.binarySearch(arr, 27), 5); // Center</span>
<a href="#l121.16"></a><span id="l121.16" class="difflineplus">+    equal(cal.binarySearch(arr, 2), 0); // Left most</span>
<a href="#l121.17"></a><span id="l121.17" class="difflineplus">+    equal(cal.binarySearch(arr, 62), 11); // Right most</span>
<a href="#l121.18"></a><span id="l121.18"> </span>
<a href="#l121.19"></a><span id="l121.19" class="difflineminus">-    equal(binarySearch([5], 5), 1); // One element found</span>
<a href="#l121.20"></a><span id="l121.20" class="difflineminus">-    equal(binarySearch([1], 0), 0); // One element insert left</span>
<a href="#l121.21"></a><span id="l121.21" class="difflineminus">-    equal(binarySearch([1], 2), 1); // One element insert right</span>
<a href="#l121.22"></a><span id="l121.22" class="difflineplus">+    equal(cal.binarySearch([5], 5), 1); // One element found</span>
<a href="#l121.23"></a><span id="l121.23" class="difflineplus">+    equal(cal.binarySearch([1], 0), 0); // One element insert left</span>
<a href="#l121.24"></a><span id="l121.24" class="difflineplus">+    equal(cal.binarySearch([1], 2), 1); // One element insert right</span>
<a href="#l121.25"></a><span id="l121.25"> }</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

