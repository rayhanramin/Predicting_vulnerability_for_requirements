<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 29821:82b5fa7bb05fd380d6711e3ddf0977d5343d124c</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 82b5fa7bb05fd380d6711e3ddf0977d5343d124c" />
<meta property="og:url" content="/comm-central/rev/82b5fa7bb05fd380d6711e3ddf0977d5343d124c" />
<meta property="og:description" content="Bug 1637508 - Allow key import in RNP's permissive mode. r=PatrickBrunschwig" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 82b5fa7bb05fd380d6711e3ddf0977d5343d124c 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/82b5fa7bb05fd380d6711e3ddf0977d5343d124c">shortlog</a> |
<a href="/comm-central/log/82b5fa7bb05fd380d6711e3ddf0977d5343d124c">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/82b5fa7bb05fd380d6711e3ddf0977d5343d124c">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/82b5fa7bb05fd380d6711e3ddf0977d5343d124c">files</a> |
changeset |
<a href="/comm-central/raw-rev/82b5fa7bb05fd380d6711e3ddf0977d5343d124c">raw</a>  | <a href="/comm-central/archive/82b5fa7bb05fd380d6711e3ddf0977d5343d124c.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1637508">Bug 1637508</a> - Allow key import in RNP's permissive mode. r=PatrickBrunschwig
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#75;&#97;&#105;&#32;&#69;&#110;&#103;&#101;&#114;&#116;&#32;&#60;&#107;&#97;&#105;&#101;&#64;&#107;&#117;&#105;&#120;&#46;&#100;&#101;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 05 Jun 2020 00:04:26 +0200</td></tr>

<tr>
 <td>changeset 29821</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/82b5fa7bb05fd380d6711e3ddf0977d5343d124c">82b5fa7bb05fd380d6711e3ddf0977d5343d124c</a></td>
</tr>



<tr>
<td>parent 29820</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/f02863ab01e3073760c259b14d0fe46e5a148b99">f02863ab01e3073760c259b14d0fe46e5a148b99</a>
</td>
</tr>

<tr>
<td>child 29822</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/130ee8c869501d5c8743ef7c270d6259966be3ce">130ee8c869501d5c8743ef7c270d6259966be3ce</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=82b5fa7bb05fd380d6711e3ddf0977d5343d124c">17548</a></td></tr>
<tr><td>push user</td><td>kaie@kuix.de</td></tr>
<tr><td>push date</td><td class="date age">Tue, 09 Jun 2020 12:19:36 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@130ee8c86950 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=130ee8c869501d5c8743ef7c270d6259966be3ce">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=130ee8c869501d5c8743ef7c270d6259966be3ce&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=130ee8c869501d5c8743ef7c270d6259966be3ce&newProject=comm-central&newRevision=f02863ab01e3073760c259b14d0fe46e5a148b99&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=130ee8c869501d5c8743ef7c270d6259966be3ce&newProject=comm-central&newRevision=f02863ab01e3073760c259b14d0fe46e5a148b99&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=130ee8c869501d5c8743ef7c270d6259966be3ce&newProject=comm-central&newRevision=f02863ab01e3073760c259b14d0fe46e5a148b99&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28PatrickBrunschwig%29&revcount=50">PatrickBrunschwig</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1637508">1637508</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1637508">Bug 1637508</a> - Allow key import in RNP's permissive mode. r=PatrickBrunschwig

Differential Revision: <a href="https://phabricator.services.mozilla.com/D78856">https://phabricator.services.mozilla.com/D78856</a></div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/RNP.jsm">mail/extensions/openpgp/content/modules/RNP.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/RNP.jsm">file</a> |
<a href="/comm-central/annotate/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/RNP.jsm">annotate</a> |
<a href="/comm-central/diff/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/RNP.jsm">diff</a> |
<a href="/comm-central/comparison/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/RNP.jsm">comparison</a> |
<a href="/comm-central/log/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/RNP.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/RNPLib.jsm">mail/extensions/openpgp/content/modules/RNPLib.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/RNPLib.jsm">file</a> |
<a href="/comm-central/annotate/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/RNPLib.jsm">annotate</a> |
<a href="/comm-central/diff/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/RNPLib.jsm">diff</a> |
<a href="/comm-central/comparison/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/RNPLib.jsm">comparison</a> |
<a href="/comm-central/log/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/RNPLib.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/autocrypt.jsm">mail/extensions/openpgp/content/modules/autocrypt.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/autocrypt.jsm">file</a> |
<a href="/comm-central/annotate/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/autocrypt.jsm">annotate</a> |
<a href="/comm-central/diff/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/autocrypt.jsm">diff</a> |
<a href="/comm-central/comparison/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/autocrypt.jsm">comparison</a> |
<a href="/comm-central/log/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/autocrypt.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/cryptoAPI/GnuPGCryptoAPI.jsm">mail/extensions/openpgp/content/modules/cryptoAPI/GnuPGCryptoAPI.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/cryptoAPI/GnuPGCryptoAPI.jsm">file</a> |
<a href="/comm-central/annotate/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/cryptoAPI/GnuPGCryptoAPI.jsm">annotate</a> |
<a href="/comm-central/diff/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/cryptoAPI/GnuPGCryptoAPI.jsm">diff</a> |
<a href="/comm-central/comparison/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/cryptoAPI/GnuPGCryptoAPI.jsm">comparison</a> |
<a href="/comm-central/log/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/cryptoAPI/GnuPGCryptoAPI.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/cryptoAPI/RNPCryptoAPI.jsm">mail/extensions/openpgp/content/modules/cryptoAPI/RNPCryptoAPI.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/cryptoAPI/RNPCryptoAPI.jsm">file</a> |
<a href="/comm-central/annotate/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/cryptoAPI/RNPCryptoAPI.jsm">annotate</a> |
<a href="/comm-central/diff/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/cryptoAPI/RNPCryptoAPI.jsm">diff</a> |
<a href="/comm-central/comparison/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/cryptoAPI/RNPCryptoAPI.jsm">comparison</a> |
<a href="/comm-central/log/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/cryptoAPI/RNPCryptoAPI.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/cryptoAPI/interface.js">mail/extensions/openpgp/content/modules/cryptoAPI/interface.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/cryptoAPI/interface.js">file</a> |
<a href="/comm-central/annotate/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/cryptoAPI/interface.js">annotate</a> |
<a href="/comm-central/diff/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/cryptoAPI/interface.js">diff</a> |
<a href="/comm-central/comparison/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/cryptoAPI/interface.js">comparison</a> |
<a href="/comm-central/log/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/cryptoAPI/interface.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/decryption.jsm">mail/extensions/openpgp/content/modules/decryption.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/decryption.jsm">file</a> |
<a href="/comm-central/annotate/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/decryption.jsm">annotate</a> |
<a href="/comm-central/diff/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/decryption.jsm">diff</a> |
<a href="/comm-central/comparison/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/decryption.jsm">comparison</a> |
<a href="/comm-central/log/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/decryption.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/key.jsm">mail/extensions/openpgp/content/modules/key.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/key.jsm">file</a> |
<a href="/comm-central/annotate/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/key.jsm">annotate</a> |
<a href="/comm-central/diff/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/key.jsm">diff</a> |
<a href="/comm-central/comparison/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/key.jsm">comparison</a> |
<a href="/comm-central/log/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/key.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/keyLookupHelper.jsm">mail/extensions/openpgp/content/modules/keyLookupHelper.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/keyLookupHelper.jsm">file</a> |
<a href="/comm-central/annotate/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/keyLookupHelper.jsm">annotate</a> |
<a href="/comm-central/diff/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/keyLookupHelper.jsm">diff</a> |
<a href="/comm-central/comparison/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/keyLookupHelper.jsm">comparison</a> |
<a href="/comm-central/log/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/keyLookupHelper.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/keyRing.jsm">mail/extensions/openpgp/content/modules/keyRing.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/keyRing.jsm">file</a> |
<a href="/comm-central/annotate/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/keyRing.jsm">annotate</a> |
<a href="/comm-central/diff/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/keyRing.jsm">diff</a> |
<a href="/comm-central/comparison/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/keyRing.jsm">comparison</a> |
<a href="/comm-central/log/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/keyRing.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/keyserver.jsm">mail/extensions/openpgp/content/modules/keyserver.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/keyserver.jsm">file</a> |
<a href="/comm-central/annotate/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/keyserver.jsm">annotate</a> |
<a href="/comm-central/diff/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/keyserver.jsm">diff</a> |
<a href="/comm-central/comparison/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/keyserver.jsm">comparison</a> |
<a href="/comm-central/log/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/modules/keyserver.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/strings/enigmail.properties">mail/extensions/openpgp/content/strings/enigmail.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/strings/enigmail.properties">file</a> |
<a href="/comm-central/annotate/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/strings/enigmail.properties">annotate</a> |
<a href="/comm-central/diff/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/strings/enigmail.properties">diff</a> |
<a href="/comm-central/comparison/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/strings/enigmail.properties">comparison</a> |
<a href="/comm-central/log/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/strings/enigmail.properties">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/ui/enigmailKeyManager.js">mail/extensions/openpgp/content/ui/enigmailKeyManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/ui/enigmailKeyManager.js">file</a> |
<a href="/comm-central/annotate/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/ui/enigmailKeyManager.js">annotate</a> |
<a href="/comm-central/diff/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/ui/enigmailKeyManager.js">diff</a> |
<a href="/comm-central/comparison/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/ui/enigmailKeyManager.js">comparison</a> |
<a href="/comm-central/log/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/ui/enigmailKeyManager.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">file</a> |
<a href="/comm-central/annotate/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">annotate</a> |
<a href="/comm-central/diff/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">diff</a> |
<a href="/comm-central/comparison/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">comparison</a> |
<a href="/comm-central/log/82b5fa7bb05fd380d6711e3ddf0977d5343d124c/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/RNP.jsm</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/RNP.jsm</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1111,31 +1111,32 @@ var RNP = {</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5">     return newKeyId;</span>
<a href="#l1.6"></a><span id="l1.6">   },</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8">   saveKeyRings() {</span>
<a href="#l1.9"></a><span id="l1.9">     RNPLib.saveKeys();</span>
<a href="#l1.10"></a><span id="l1.10">   },</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-  importToFFI(ffi, keyBlockStr, usePublic, useSecret) {</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+  importToFFI(ffi, keyBlockStr, usePublic, useSecret, permissive) {</span>
<a href="#l1.14"></a><span id="l1.14">     let input_from_memory = new RNPLib.rnp_input_t();</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16">     if (!keyBlockStr) {</span>
<a href="#l1.17"></a><span id="l1.17">       throw new Error(&quot;no keyBlockStr parameter in importToFFI&quot;);</span>
<a href="#l1.18"></a><span id="l1.18">     }</span>
<a href="#l1.19"></a><span id="l1.19"> </span>
<a href="#l1.20"></a><span id="l1.20">     if (typeof keyBlockStr != &quot;string&quot;) {</span>
<a href="#l1.21"></a><span id="l1.21">       throw new Error(</span>
<a href="#l1.22"></a><span id="l1.22">         &quot;keyBlockStr of unepected type importToFFI: %o&quot;,</span>
<a href="#l1.23"></a><span id="l1.23">         keyBlockStr</span>
<a href="#l1.24"></a><span id="l1.24">       );</span>
<a href="#l1.25"></a><span id="l1.25">     }</span>
<a href="#l1.26"></a><span id="l1.26"> </span>
<a href="#l1.27"></a><span id="l1.27">     let arr = [];</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+    arr.length = keyBlockStr.length;</span>
<a href="#l1.29"></a><span id="l1.29">     for (let i = 0; i &lt; keyBlockStr.length; i++) {</span>
<a href="#l1.30"></a><span id="l1.30">       arr[i] = keyBlockStr.charCodeAt(i);</span>
<a href="#l1.31"></a><span id="l1.31">     }</span>
<a href="#l1.32"></a><span id="l1.32">     var key_array = ctypes.uint8_t.array()(arr);</span>
<a href="#l1.33"></a><span id="l1.33"> </span>
<a href="#l1.34"></a><span id="l1.34">     if (</span>
<a href="#l1.35"></a><span id="l1.35">       RNPLib.rnp_input_from_memory(</span>
<a href="#l1.36"></a><span id="l1.36">         input_from_memory.address(),</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineat">@@ -1152,16 +1153,20 @@ var RNP = {</span>
<a href="#l1.38"></a><span id="l1.38">     let flags = 0;</span>
<a href="#l1.39"></a><span id="l1.39">     if (usePublic) {</span>
<a href="#l1.40"></a><span id="l1.40">       flags |= RNPLib.RNP_LOAD_SAVE_PUBLIC_KEYS;</span>
<a href="#l1.41"></a><span id="l1.41">     }</span>
<a href="#l1.42"></a><span id="l1.42">     if (useSecret) {</span>
<a href="#l1.43"></a><span id="l1.43">       flags |= RNPLib.RNP_LOAD_SAVE_SECRET_KEYS;</span>
<a href="#l1.44"></a><span id="l1.44">     }</span>
<a href="#l1.45"></a><span id="l1.45"> </span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+    if (permissive) {</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+      flags |= RNPLib.RNP_LOAD_SAVE_PERMISSIVE;</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+    }</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+</span>
<a href="#l1.50"></a><span id="l1.50">     let rv = RNPLib.rnp_import_keys(</span>
<a href="#l1.51"></a><span id="l1.51">       ffi,</span>
<a href="#l1.52"></a><span id="l1.52">       input_from_memory,</span>
<a href="#l1.53"></a><span id="l1.53">       flags,</span>
<a href="#l1.54"></a><span id="l1.54">       jsonInfo.address()</span>
<a href="#l1.55"></a><span id="l1.55">     );</span>
<a href="#l1.56"></a><span id="l1.56"> </span>
<a href="#l1.57"></a><span id="l1.57">     // TODO: parse jsonInfo and return a list of keys,</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineat">@@ -1175,42 +1180,47 @@ var RNP = {</span>
<a href="#l1.59"></a><span id="l1.59">     RNPLib.rnp_buffer_destroy(jsonInfo);</span>
<a href="#l1.60"></a><span id="l1.60">     RNPLib.rnp_input_destroy(input_from_memory);</span>
<a href="#l1.61"></a><span id="l1.61"> </span>
<a href="#l1.62"></a><span id="l1.62">     return rv;</span>
<a href="#l1.63"></a><span id="l1.63">   },</span>
<a href="#l1.64"></a><span id="l1.64"> </span>
<a href="#l1.65"></a><span id="l1.65">   maxImportKeyBlockSize: 5000000,</span>
<a href="#l1.66"></a><span id="l1.66"> </span>
<a href="#l1.67"></a><span id="l1.67" class="difflineminus">-  async getKeyListFromKeyBlock(keyBlockStr, pubkey = true, seckey = false) {</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+  async getKeyListFromKeyBlockImpl(</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+    keyBlockStr,</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+    pubkey = true,</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineplus">+    seckey = false,</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineplus">+    permissive = true</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineplus">+  ) {</span>
<a href="#l1.74"></a><span id="l1.74">     if (keyBlockStr.length &gt; RNP.maxImportKeyBlockSize) {</span>
<a href="#l1.75"></a><span id="l1.75">       throw new Error(&quot;rejecting big keyblock&quot;);</span>
<a href="#l1.76"></a><span id="l1.76">     }</span>
<a href="#l1.77"></a><span id="l1.77"> </span>
<a href="#l1.78"></a><span id="l1.78">     let tempFFI = new RNPLib.rnp_ffi_t();</span>
<a href="#l1.79"></a><span id="l1.79">     if (RNPLib.rnp_ffi_create(tempFFI.address(), &quot;GPG&quot;, &quot;GPG&quot;)) {</span>
<a href="#l1.80"></a><span id="l1.80">       throw new Error(&quot;Couldn't initialize librnp.&quot;);</span>
<a href="#l1.81"></a><span id="l1.81">     }</span>
<a href="#l1.82"></a><span id="l1.82"> </span>
<a href="#l1.83"></a><span id="l1.83">     let keyList = null;</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineminus">-    if (!this.importToFFI(tempFFI, keyBlockStr, pubkey, seckey)) {</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineplus">+    if (!this.importToFFI(tempFFI, keyBlockStr, pubkey, seckey, permissive)) {</span>
<a href="#l1.86"></a><span id="l1.86">       keyList = await this.getKeysFromFFI(tempFFI, true);</span>
<a href="#l1.87"></a><span id="l1.87">     }</span>
<a href="#l1.88"></a><span id="l1.88"> </span>
<a href="#l1.89"></a><span id="l1.89">     RNPLib.rnp_ffi_destroy(tempFFI);</span>
<a href="#l1.90"></a><span id="l1.90">     return keyList;</span>
<a href="#l1.91"></a><span id="l1.91">   },</span>
<a href="#l1.92"></a><span id="l1.92"> </span>
<a href="#l1.93"></a><span id="l1.93" class="difflineminus">-  async importKeyBlock(</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineplus">+  async importKeyBlockImpl(</span>
<a href="#l1.95"></a><span id="l1.95">     win,</span>
<a href="#l1.96"></a><span id="l1.96">     passCB,</span>
<a href="#l1.97"></a><span id="l1.97">     keyBlockStr,</span>
<a href="#l1.98"></a><span id="l1.98">     pubkey,</span>
<a href="#l1.99"></a><span id="l1.99">     seckey,</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineminus">-    password = null</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineplus">+    permissive = false</span>
<a href="#l1.102"></a><span id="l1.102">   ) {</span>
<a href="#l1.103"></a><span id="l1.103">     if (keyBlockStr.length &gt; RNP.maxImportKeyBlockSize) {</span>
<a href="#l1.104"></a><span id="l1.104">       throw new Error(&quot;rejecting big keyblock&quot;);</span>
<a href="#l1.105"></a><span id="l1.105">     }</span>
<a href="#l1.106"></a><span id="l1.106"> </span>
<a href="#l1.107"></a><span id="l1.107">     /*</span>
<a href="#l1.108"></a><span id="l1.108">      * Import strategy:</span>
<a href="#l1.109"></a><span id="l1.109">      * - import file into a temporary space, in-memory only (ffi)</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineat">@@ -1229,18 +1239,19 @@ var RNP = {</span>
<a href="#l1.111"></a><span id="l1.111">     result.errorMsg = &quot;&quot;;</span>
<a href="#l1.112"></a><span id="l1.112"> </span>
<a href="#l1.113"></a><span id="l1.113">     let tempFFI = new RNPLib.rnp_ffi_t();</span>
<a href="#l1.114"></a><span id="l1.114">     if (RNPLib.rnp_ffi_create(tempFFI.address(), &quot;GPG&quot;, &quot;GPG&quot;)) {</span>
<a href="#l1.115"></a><span id="l1.115">       throw new Error(&quot;Couldn't initialize librnp.&quot;);</span>
<a href="#l1.116"></a><span id="l1.116">     }</span>
<a href="#l1.117"></a><span id="l1.117"> </span>
<a href="#l1.118"></a><span id="l1.118">     // TODO: check result</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineminus">-    if (this.importToFFI(tempFFI, keyBlockStr, pubkey, seckey)) {</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineminus">-      throw new Error(&quot;RNP.importToFFI failed&quot;);</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineplus">+    if (this.importToFFI(tempFFI, keyBlockStr, pubkey, seckey, permissive)) {</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineplus">+      result.errorMsg = &quot;RNP.importToFFI failed&quot;;</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineplus">+      return result;</span>
<a href="#l1.124"></a><span id="l1.124">     }</span>
<a href="#l1.125"></a><span id="l1.125"> </span>
<a href="#l1.126"></a><span id="l1.126">     let keys = await this.getKeysFromFFI(tempFFI, true);</span>
<a href="#l1.127"></a><span id="l1.127"> </span>
<a href="#l1.128"></a><span id="l1.128">     let recentPass = &quot;&quot;;</span>
<a href="#l1.129"></a><span id="l1.129"> </span>
<a href="#l1.130"></a><span id="l1.130">     // Prior to importing, ensure we can unprotect all keys</span>
<a href="#l1.131"></a><span id="l1.131">     for (let ki = 0; ki &lt; keys.length; ki++) {</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineat">@@ -1360,16 +1371,19 @@ var RNP = {</span>
<a href="#l1.133"></a><span id="l1.133"> </span>
<a href="#l1.134"></a><span id="l1.134">         let importFlags = 0;</span>
<a href="#l1.135"></a><span id="l1.135">         if (pubkey) {</span>
<a href="#l1.136"></a><span id="l1.136">           importFlags |= RNPLib.RNP_LOAD_SAVE_PUBLIC_KEYS;</span>
<a href="#l1.137"></a><span id="l1.137">         }</span>
<a href="#l1.138"></a><span id="l1.138">         if (seckey) {</span>
<a href="#l1.139"></a><span id="l1.139">           importFlags |= RNPLib.RNP_LOAD_SAVE_SECRET_KEYS;</span>
<a href="#l1.140"></a><span id="l1.140">         }</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineplus">+        if (permissive) {</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineplus">+          importFlags |= RNPLib.RNP_LOAD_SAVE_PERMISSIVE;</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineplus">+        }</span>
<a href="#l1.144"></a><span id="l1.144"> </span>
<a href="#l1.145"></a><span id="l1.145">         if (</span>
<a href="#l1.146"></a><span id="l1.146">           RNPLib.rnp_import_keys(</span>
<a href="#l1.147"></a><span id="l1.147">             RNPLib.ffi,</span>
<a href="#l1.148"></a><span id="l1.148">             input_from_memory,</span>
<a href="#l1.149"></a><span id="l1.149">             importFlags,</span>
<a href="#l1.150"></a><span id="l1.150">             null</span>
<a href="#l1.151"></a><span id="l1.151">           )</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/RNPLib.jsm</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/RNPLib.jsm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1149,18 +1149,18 @@ function enableRNPLibJS() {</span>
<a href="#l2.4"></a><span id="l2.4">     rnp_op_encrypt_t,</span>
<a href="#l2.5"></a><span id="l2.5">     rnp_op_sign_t,</span>
<a href="#l2.6"></a><span id="l2.6">     rnp_op_sign_signature_t,</span>
<a href="#l2.7"></a><span id="l2.7">     rnp_op_verify_t,</span>
<a href="#l2.8"></a><span id="l2.8">     rnp_op_verify_signature_t,</span>
<a href="#l2.9"></a><span id="l2.9">     rnp_signature_handle_t,</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11">     RNP_LOAD_SAVE_PUBLIC_KEYS: 1,</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-</span>
<a href="#l2.13"></a><span id="l2.13">     RNP_LOAD_SAVE_SECRET_KEYS: 2,</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+    RNP_LOAD_SAVE_PERMISSIVE: 256,</span>
<a href="#l2.15"></a><span id="l2.15"> </span>
<a href="#l2.16"></a><span id="l2.16">     RNP_KEY_REMOVE_PUBLIC: 1,</span>
<a href="#l2.17"></a><span id="l2.17"> </span>
<a href="#l2.18"></a><span id="l2.18">     RNP_KEY_REMOVE_SECRET: 2,</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20">     RNP_KEY_EXPORT_ARMORED: 1,</span>
<a href="#l2.21"></a><span id="l2.21">     RNP_KEY_EXPORT_PUBLIC: 2,</span>
<a href="#l2.22"></a><span id="l2.22">     RNP_KEY_EXPORT_SECRET: 4,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/autocrypt.jsm</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/autocrypt.jsm</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -21,34 +21,38 @@ const { EnigmailFuncs } = ChromeUtils.im</span>
<a href="#l3.4"></a><span id="l3.4">   &quot;chrome://openpgp/content/modules/funcs.jsm&quot;</span>
<a href="#l3.5"></a><span id="l3.5"> );</span>
<a href="#l3.6"></a><span id="l3.6"> const { EnigmailMime } = ChromeUtils.import(</span>
<a href="#l3.7"></a><span id="l3.7">   &quot;chrome://openpgp/content/modules/mime.jsm&quot;</span>
<a href="#l3.8"></a><span id="l3.8"> );</span>
<a href="#l3.9"></a><span id="l3.9"> const { EnigmailSqliteDb } = ChromeUtils.import(</span>
<a href="#l3.10"></a><span id="l3.10">   &quot;chrome://openpgp/content/modules/sqliteDb.jsm&quot;</span>
<a href="#l3.11"></a><span id="l3.11"> );</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+/*</span>
<a href="#l3.13"></a><span id="l3.13"> const { PromiseUtils } = ChromeUtils.import(</span>
<a href="#l3.14"></a><span id="l3.14">   &quot;resource://gre/modules/PromiseUtils.jsm&quot;</span>
<a href="#l3.15"></a><span id="l3.15"> );</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+*/</span>
<a href="#l3.17"></a><span id="l3.17"> const { EnigmailKeyRing } = ChromeUtils.import(</span>
<a href="#l3.18"></a><span id="l3.18">   &quot;chrome://openpgp/content/modules/keyRing.jsm&quot;</span>
<a href="#l3.19"></a><span id="l3.19"> );</span>
<a href="#l3.20"></a><span id="l3.20"> const { EnigmailStreams } = ChromeUtils.import(</span>
<a href="#l3.21"></a><span id="l3.21">   &quot;chrome://openpgp/content/modules/streams.jsm&quot;</span>
<a href="#l3.22"></a><span id="l3.22"> );</span>
<a href="#l3.23"></a><span id="l3.23"> const { EnigmailArmor } = ChromeUtils.import(</span>
<a href="#l3.24"></a><span id="l3.24">   &quot;chrome://openpgp/content/modules/armor.jsm&quot;</span>
<a href="#l3.25"></a><span id="l3.25"> );</span>
<a href="#l3.26"></a><span id="l3.26"> const { EnigmailStdlib } = ChromeUtils.import(</span>
<a href="#l3.27"></a><span id="l3.27">   &quot;chrome://openpgp/content/modules/stdlib.jsm&quot;</span>
<a href="#l3.28"></a><span id="l3.28"> );</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+/*</span>
<a href="#l3.30"></a><span id="l3.30"> const { EnigmailCryptoAPI } = ChromeUtils.import(</span>
<a href="#l3.31"></a><span id="l3.31">   &quot;chrome://openpgp/content/modules/cryptoAPI.jsm&quot;</span>
<a href="#l3.32"></a><span id="l3.32"> );</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+*/</span>
<a href="#l3.34"></a><span id="l3.34"> </span>
<a href="#l3.35"></a><span id="l3.35"> var gCreatedSetupIds = [];</span>
<a href="#l3.36"></a><span id="l3.36"> </span>
<a href="#l3.37"></a><span id="l3.37"> var EnigmailAutocrypt = {</span>
<a href="#l3.38"></a><span id="l3.38">   getKeyFromHeader(fromAddr, headerDataArr) {</span>
<a href="#l3.39"></a><span id="l3.39">     // critical parameters: {param: mandatory}</span>
<a href="#l3.40"></a><span id="l3.40">     const CRITICAL = {</span>
<a href="#l3.41"></a><span id="l3.41">       addr: true,</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineat">@@ -972,16 +976,17 @@ async function findUserRecord(connection</span>
<a href="#l3.43"></a><span id="l3.43">  * Create new database record for an Autorypt header</span>
<a href="#l3.44"></a><span id="l3.44">  *</span>
<a href="#l3.45"></a><span id="l3.45">  * @param connection: Object - SQLite connection</span>
<a href="#l3.46"></a><span id="l3.46">  * @param paramsArr:  Object - the Autocrypt header parameters</span>
<a href="#l3.47"></a><span id="l3.47">  *</span>
<a href="#l3.48"></a><span id="l3.48">  * @return Promise</span>
<a href="#l3.49"></a><span id="l3.49">  */</span>
<a href="#l3.50"></a><span id="l3.50"> async function appendUser(connection, paramsArr) {</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+  /*</span>
<a href="#l3.52"></a><span id="l3.52">   EnigmailLog.DEBUG(&quot;autocrypt.jsm: appendUser(&quot; + paramsArr.addr + &quot;)\n&quot;);</span>
<a href="#l3.53"></a><span id="l3.53"> </span>
<a href="#l3.54"></a><span id="l3.54">   if (!(&quot;fpr&quot; in paramsArr)) {</span>
<a href="#l3.55"></a><span id="l3.55">     await getFprForKey(paramsArr);</span>
<a href="#l3.56"></a><span id="l3.56">   }</span>
<a href="#l3.57"></a><span id="l3.57"> </span>
<a href="#l3.58"></a><span id="l3.58">   return new Promise((resolve, reject) =&gt; {</span>
<a href="#l3.59"></a><span id="l3.59">     if (paramsArr.autocryptDate == 0) {</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineat">@@ -1009,30 +1014,32 @@ async function appendUser(connection, pa</span>
<a href="#l3.61"></a><span id="l3.61">           EnigmailLog.DEBUG(&quot;autocrypt.jsm: appendUser - OK\n&quot;);</span>
<a href="#l3.62"></a><span id="l3.62">           resolve();</span>
<a href="#l3.63"></a><span id="l3.63">         })</span>
<a href="#l3.64"></a><span id="l3.64">         .catch(function() {</span>
<a href="#l3.65"></a><span id="l3.65">           reject(&quot;appendUser&quot;);</span>
<a href="#l3.66"></a><span id="l3.66">         });</span>
<a href="#l3.67"></a><span id="l3.67">     });</span>
<a href="#l3.68"></a><span id="l3.68">   });</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+  */</span>
<a href="#l3.70"></a><span id="l3.70"> }</span>
<a href="#l3.71"></a><span id="l3.71"> </span>
<a href="#l3.72"></a><span id="l3.72"> /**</span>
<a href="#l3.73"></a><span id="l3.73">  * Update the record for an email address and type, if the email we got is newer</span>
<a href="#l3.74"></a><span id="l3.74">  * than the latest record we already stored</span>
<a href="#l3.75"></a><span id="l3.75">  *</span>
<a href="#l3.76"></a><span id="l3.76">  * @param connection: Object - SQLite connection</span>
<a href="#l3.77"></a><span id="l3.77">  * @param paramsArr:  Object - the Autocrypt header parameters</span>
<a href="#l3.78"></a><span id="l3.78">  * @param resultRows: Array of mozIStorageRow - records stored in the database</span>
<a href="#l3.79"></a><span id="l3.79">  * @param autoCryptEnabled: Boolean: is autocrypt enabled for this transaction</span>
<a href="#l3.80"></a><span id="l3.80">  *</span>
<a href="#l3.81"></a><span id="l3.81">  * @return Promise</span>
<a href="#l3.82"></a><span id="l3.82">  */</span>
<a href="#l3.83"></a><span id="l3.83"> async function updateUser(connection, paramsArr, resultRows, autoCryptEnabled) {</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+  /*</span>
<a href="#l3.85"></a><span id="l3.85">   EnigmailLog.DEBUG(&quot;autocrypt.jsm: updateUser\n&quot;);</span>
<a href="#l3.86"></a><span id="l3.86"> </span>
<a href="#l3.87"></a><span id="l3.87">   let currData = resultRows[0];</span>
<a href="#l3.88"></a><span id="l3.88">   PromiseUtils.defer();</span>
<a href="#l3.89"></a><span id="l3.89"> </span>
<a href="#l3.90"></a><span id="l3.90">   let lastSeen = new Date(currData.getResultByName(&quot;last_seen&quot;));</span>
<a href="#l3.91"></a><span id="l3.91">   let lastAutocrypt = new Date(currData.getResultByName(&quot;last_seen_autocrypt&quot;));</span>
<a href="#l3.92"></a><span id="l3.92">   let notGossip = currData.getResultByName(&quot;state&quot;) !== &quot;gossip&quot;;</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineat">@@ -1109,59 +1116,64 @@ async function updateUser(connection, pa</span>
<a href="#l3.94"></a><span id="l3.94">     await updateKeyIfNeeded(</span>
<a href="#l3.95"></a><span id="l3.95">       paramsArr.addr.toLowerCase(),</span>
<a href="#l3.96"></a><span id="l3.96">       paramsArr.keydata,</span>
<a href="#l3.97"></a><span id="l3.97">       paramsArr.fpr,</span>
<a href="#l3.98"></a><span id="l3.98">       paramsArr.type,</span>
<a href="#l3.99"></a><span id="l3.99">       paramsArr[&quot;prefer-encrypt&quot;]</span>
<a href="#l3.100"></a><span id="l3.100">     );</span>
<a href="#l3.101"></a><span id="l3.101">   }</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+  */</span>
<a href="#l3.103"></a><span id="l3.103"> }</span>
<a href="#l3.104"></a><span id="l3.104"> </span>
<a href="#l3.105"></a><span id="l3.105"> /**</span>
<a href="#l3.106"></a><span id="l3.106">  * Determine if a key in the keyring should be replaced by a new (or updated) key</span>
<a href="#l3.107"></a><span id="l3.107">  * @param {String} email - Email address</span>
<a href="#l3.108"></a><span id="l3.108">  * @param {String} keydata - new keydata to import</span>
<a href="#l3.109"></a><span id="l3.109">  * @param {String} fpr - fingerprint of new key</span>
<a href="#l3.110"></a><span id="l3.110">  * @param {String} keyType - key type (1 / 1g)</span>
<a href="#l3.111"></a><span id="l3.111">  * @param {String} autocryptState - mutual or nopreference</span>
<a href="#l3.112"></a><span id="l3.112">  *</span>
<a href="#l3.113"></a><span id="l3.113">  * @return {Promise&lt;Boolean&gt;} - key updated</span>
<a href="#l3.114"></a><span id="l3.114">  */</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineplus">+/*</span>
<a href="#l3.116"></a><span id="l3.116"> async function updateKeyIfNeeded(email, keydata, fpr, keyType, autocryptState) {</span>
<a href="#l3.117"></a><span id="l3.117">   await EnigmailAutocrypt.applyKeyFromKeydata(</span>
<a href="#l3.118"></a><span id="l3.118">     atob(keydata),</span>
<a href="#l3.119"></a><span id="l3.119">     email,</span>
<a href="#l3.120"></a><span id="l3.120">     autocryptState,</span>
<a href="#l3.121"></a><span id="l3.121">     keyType</span>
<a href="#l3.122"></a><span id="l3.122">   );</span>
<a href="#l3.123"></a><span id="l3.123"> </span>
<a href="#l3.124"></a><span id="l3.124">   return true;</span>
<a href="#l3.125"></a><span id="l3.125"> }</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineplus">+*/</span>
<a href="#l3.127"></a><span id="l3.127"> </span>
<a href="#l3.128"></a><span id="l3.128"> /**</span>
<a href="#l3.129"></a><span id="l3.129">  * Set the fpr attribute for a given key parameter object</span>
<a href="#l3.130"></a><span id="l3.130">  */</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineplus">+/*</span>
<a href="#l3.132"></a><span id="l3.132"> async function getFprForKey(paramsArr) {</span>
<a href="#l3.133"></a><span id="l3.133">   let keyData = atob(paramsArr.keydata);</span>
<a href="#l3.134"></a><span id="l3.134"> </span>
<a href="#l3.135"></a><span id="l3.135">   const cApi = EnigmailCryptoAPI();</span>
<a href="#l3.136"></a><span id="l3.136"> </span>
<a href="#l3.137"></a><span id="l3.137">   try {</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineminus">-    let keyArr = await cApi.getKeyListFromKeyBlock(keyData);</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineplus">+    let keyArr = await cApi.getKeyListFromKeyBlockAPI(keyData, ... ?);</span>
<a href="#l3.140"></a><span id="l3.140">     if (!keyArr) {</span>
<a href="#l3.141"></a><span id="l3.141">       // callers can handle empty string for paramsArr.fpr</span>
<a href="#l3.142"></a><span id="l3.142">       return;</span>
<a href="#l3.143"></a><span id="l3.143">     }</span>
<a href="#l3.144"></a><span id="l3.144"> </span>
<a href="#l3.145"></a><span id="l3.145">     if (keyArr.length === 1) {</span>
<a href="#l3.146"></a><span id="l3.146">       paramsArr.fpr = keyArr[0].fpr;</span>
<a href="#l3.147"></a><span id="l3.147">     }</span>
<a href="#l3.148"></a><span id="l3.148">   } catch (x) {}</span>
<a href="#l3.149"></a><span id="l3.149"> }</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineplus">+*/</span>
<a href="#l3.151"></a><span id="l3.151"> </span>
<a href="#l3.152"></a><span id="l3.152"> /**</span>
<a href="#l3.153"></a><span id="l3.153">  * Create the 9x4 digits backup code as defined in the Autocrypt spec</span>
<a href="#l3.154"></a><span id="l3.154">  *</span>
<a href="#l3.155"></a><span id="l3.155">  * @return String: xxxx-xxxx-...</span>
<a href="#l3.156"></a><span id="l3.156">  */</span>
<a href="#l3.157"></a><span id="l3.157"> /*</span>
<a href="#l3.158"></a><span id="l3.158"> function createBackupCode() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/cryptoAPI/GnuPGCryptoAPI.jsm</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/cryptoAPI/GnuPGCryptoAPI.jsm</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -99,33 +99,33 @@ class GnuPGCryptoAPI extends CryptoAPI {</span>
<a href="#l4.4"></a><span id="l4.4">    *</span>
<a href="#l4.5"></a><span id="l4.5">    * @return {nsIFile} object or null in case no data / error.</span>
<a href="#l4.6"></a><span id="l4.6">    */</span>
<a href="#l4.7"></a><span id="l4.7">   async getPhotoFile(keyId, photoNumber) {</span>
<a href="#l4.8"></a><span id="l4.8">     let file = await getPhotoFileFromGnuPG(keyId, photoNumber);</span>
<a href="#l4.9"></a><span id="l4.9">     return file;</span>
<a href="#l4.10"></a><span id="l4.10">   }</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  async importKeyBlock(keyBlock) {</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+  async importKeyBlockAPI(keyBlock) {</span>
<a href="#l4.14"></a><span id="l4.14">     return null;</span>
<a href="#l4.15"></a><span id="l4.15">   }</span>
<a href="#l4.16"></a><span id="l4.16"> </span>
<a href="#l4.17"></a><span id="l4.17">   /**</span>
<a href="#l4.18"></a><span id="l4.18">    * Import key(s) from a file</span>
<a href="#l4.19"></a><span id="l4.19">    *</span>
<a href="#l4.20"></a><span id="l4.20">    * @param {nsIFile} inputFile:  the file holding the keys</span>
<a href="#l4.21"></a><span id="l4.21">    *</span>
<a href="#l4.22"></a><span id="l4.22">    * @return {Object} or null in case no data / error:</span>
<a href="#l4.23"></a><span id="l4.23">    *   - {Number}          exitCode:        result code (0: OK)</span>
<a href="#l4.24"></a><span id="l4.24">    *   - {Array of String) importedKeys:    imported fingerprints</span>
<a href="#l4.25"></a><span id="l4.25">    *   - {String}          errorMsg:        human readable error message</span>
<a href="#l4.26"></a><span id="l4.26">    *   - {Number}          importSum:       total number of processed keys</span>
<a href="#l4.27"></a><span id="l4.27">    *   - {Number}          importUnchanged: number of unchanged keys</span>
<a href="#l4.28"></a><span id="l4.28">    */</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineminus">-  async importKeyFromFile(inputFile) {</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+  async importKeyFromFileAPI(inputFile) {</span>
<a href="#l4.31"></a><span id="l4.31">     let keys = await GnuPG_importKeyFromFile(inputFile);</span>
<a href="#l4.32"></a><span id="l4.32">     return keys;</span>
<a href="#l4.33"></a><span id="l4.33">   }</span>
<a href="#l4.34"></a><span id="l4.34"> </span>
<a href="#l4.35"></a><span id="l4.35">   /**</span>
<a href="#l4.36"></a><span id="l4.36">    * Export secret key(s) to a file</span>
<a href="#l4.37"></a><span id="l4.37">    *</span>
<a href="#l4.38"></a><span id="l4.38">    * @param {String}  keyId      Specification by fingerprint or keyID</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineat">@@ -252,17 +252,17 @@ class GnuPGCryptoAPI extends CryptoAPI {</span>
<a href="#l4.40"></a><span id="l4.40"> </span>
<a href="#l4.41"></a><span id="l4.41">     options.noOutput = true;</span>
<a href="#l4.42"></a><span id="l4.42">     options.verifyOnly = true;</span>
<a href="#l4.43"></a><span id="l4.43">     options.uiFlags = EnigmailConstants.UI_PGP_MIME;</span>
<a href="#l4.44"></a><span id="l4.44"> </span>
<a href="#l4.45"></a><span id="l4.45">     return this.decrypt(signed, options);</span>
<a href="#l4.46"></a><span id="l4.46">   }</span>
<a href="#l4.47"></a><span id="l4.47"> </span>
<a href="#l4.48"></a><span id="l4.48" class="difflineminus">-  async getKeyListFromKeyBlock(keyBlockStr) {</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+  async getKeyListFromKeyBlockAPI(keyBlockStr) {</span>
<a href="#l4.50"></a><span id="l4.50">     let res;</span>
<a href="#l4.51"></a><span id="l4.51">     res = await getGpgKeyData(keyBlockStr);</span>
<a href="#l4.52"></a><span id="l4.52">     return res;</span>
<a href="#l4.53"></a><span id="l4.53">   }</span>
<a href="#l4.54"></a><span id="l4.54"> </span>
<a href="#l4.55"></a><span id="l4.55">   async genKey(userId, keyType, keySize, expiryTime, passphrase) {</span>
<a href="#l4.56"></a><span id="l4.56">     throw new Error(&quot;GnuPG genKey() not implemented&quot;);</span>
<a href="#l4.57"></a><span id="l4.57">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/cryptoAPI/RNPCryptoAPI.jsm</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/cryptoAPI/RNPCryptoAPI.jsm</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -84,36 +84,57 @@ class RNPCryptoAPI extends CryptoAPI {</span>
<a href="#l5.4"></a><span id="l5.4">    * @param {Number} photoNumber: number of the photo on the key, starting with 0</span>
<a href="#l5.5"></a><span id="l5.5">    *</span>
<a href="#l5.6"></a><span id="l5.6">    * @return {nsIFile} object or null in case no data / error.</span>
<a href="#l5.7"></a><span id="l5.7">    */</span>
<a href="#l5.8"></a><span id="l5.8">   async getPhotoFile(keyId, photoNumber) {</span>
<a href="#l5.9"></a><span id="l5.9">     throw new Error(&quot;Not implemented&quot;);</span>
<a href="#l5.10"></a><span id="l5.10">   }</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  async importKeyBlock(keyBlock, pubkey, seckey) {</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+  async importKeyBlockAPI(keyBlock, pubkey, seckey, permissive) {</span>
<a href="#l5.14"></a><span id="l5.14">     // TODO: get status results</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-    let res = await RNP.importKeyBlock(null, null, keyBlock, pubkey, seckey);</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+    let res = await RNP.importKeyBlockImpl(</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+      null,</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+      null,</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+      keyBlock,</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+      pubkey,</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+      seckey,</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+      permissive</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+    );</span>
<a href="#l5.24"></a><span id="l5.24">     RNP.saveKeyRings();</span>
<a href="#l5.25"></a><span id="l5.25">     return res;</span>
<a href="#l5.26"></a><span id="l5.26">   }</span>
<a href="#l5.27"></a><span id="l5.27"> </span>
<a href="#l5.28"></a><span id="l5.28">   /**</span>
<a href="#l5.29"></a><span id="l5.29">    * Import key(s) from a file</span>
<a href="#l5.30"></a><span id="l5.30">    *</span>
<a href="#l5.31"></a><span id="l5.31">    * @param {nsIFile} inputFile:  the file holding the keys</span>
<a href="#l5.32"></a><span id="l5.32">    *</span>
<a href="#l5.33"></a><span id="l5.33">    * @return {Object} or null in case no data / error:</span>
<a href="#l5.34"></a><span id="l5.34">    *   - {Number}          exitCode:        result code (0: OK)</span>
<a href="#l5.35"></a><span id="l5.35">    *   - {Array of String) importedKeys:    imported fingerprints</span>
<a href="#l5.36"></a><span id="l5.36">    *   - {String}          errorMsg:        human readable error message</span>
<a href="#l5.37"></a><span id="l5.37">    */</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">-  async importKeyFromFile(win, passCB, inputFile, pubkey, seckey) {</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+  async importKeyFromFileAPI(</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+    win,</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+    passCB,</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+    inputFile,</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineplus">+    pubkey,</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+    seckey,</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+    permissive</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+  ) {</span>
<a href="#l5.47"></a><span id="l5.47">     var contents = EnigmailFiles.readFile(inputFile);</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineminus">-    return RNP.importKeyBlock(win, passCB, contents, pubkey, seckey);</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+    return RNP.importKeyBlockImpl(</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+      win,</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+      passCB,</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+      contents,</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+      pubkey,</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+      seckey,</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+      permissive</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+    );</span>
<a href="#l5.57"></a><span id="l5.57">   }</span>
<a href="#l5.58"></a><span id="l5.58"> </span>
<a href="#l5.59"></a><span id="l5.59">   /**</span>
<a href="#l5.60"></a><span id="l5.60">    * Export secret key(s) to a file</span>
<a href="#l5.61"></a><span id="l5.61">    *</span>
<a href="#l5.62"></a><span id="l5.62">    * @param {String}  keyId      Specification by fingerprint or keyID</span>
<a href="#l5.63"></a><span id="l5.63">    * @param {Boolean} minimalKey  if true, reduce key to minimum required</span>
<a href="#l5.64"></a><span id="l5.64">    *</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineat">@@ -233,18 +254,23 @@ class RNPCryptoAPI extends CryptoAPI {</span>
<a href="#l5.66"></a><span id="l5.66">     //options.uiFlags = EnigmailConstants.UI_PGP_MIME;</span>
<a href="#l5.67"></a><span id="l5.67"> </span>
<a href="#l5.68"></a><span id="l5.68">     if (!options.mimeSignatureFile) {</span>
<a href="#l5.69"></a><span id="l5.69">       throw new Error(&quot;inline verify not yet implemented&quot;);</span>
<a href="#l5.70"></a><span id="l5.70">     }</span>
<a href="#l5.71"></a><span id="l5.71">     return RNP.verifyDetached(signed, options);</span>
<a href="#l5.72"></a><span id="l5.72">   }</span>
<a href="#l5.73"></a><span id="l5.73"> </span>
<a href="#l5.74"></a><span id="l5.74" class="difflineminus">-  async getKeyListFromKeyBlock(keyBlockStr, pubkey, seckey) {</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineminus">-    return RNP.getKeyListFromKeyBlock(keyBlockStr, pubkey, seckey);</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+  async getKeyListFromKeyBlockAPI(keyBlockStr, pubkey, seckey, permissive) {</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineplus">+    return RNP.getKeyListFromKeyBlockImpl(</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineplus">+      keyBlockStr,</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineplus">+      pubkey,</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineplus">+      seckey,</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+      permissive</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineplus">+    );</span>
<a href="#l5.83"></a><span id="l5.83">   }</span>
<a href="#l5.84"></a><span id="l5.84"> </span>
<a href="#l5.85"></a><span id="l5.85">   async genKey(userId, keyType, keySize, expiryTime, passphrase) {</span>
<a href="#l5.86"></a><span id="l5.86">     let id = RNP.genKey(userId, keyType, keySize, expiryTime, passphrase);</span>
<a href="#l5.87"></a><span id="l5.87">     RNP.saveKeyRings();</span>
<a href="#l5.88"></a><span id="l5.88">     return id;</span>
<a href="#l5.89"></a><span id="l5.89">   }</span>
<a href="#l5.90"></a><span id="l5.90"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/cryptoAPI/interface.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/cryptoAPI/interface.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -118,21 +118,21 @@ class CryptoAPI {</span>
<a href="#l6.4"></a><span id="l6.4">    *</span>
<a href="#l6.5"></a><span id="l6.5">    * @return {Object} or null in case no data / error:</span>
<a href="#l6.6"></a><span id="l6.6">    *   - {Number}          exitCode:        result code (0: OK)</span>
<a href="#l6.7"></a><span id="l6.7">    *   - {Array of String) importedKeys:    imported fingerprints</span>
<a href="#l6.8"></a><span id="l6.8">    *   - {Number}          importSum:       total number of processed keys</span>
<a href="#l6.9"></a><span id="l6.9">    *   - {Number}          importUnchanged: number of unchanged keys</span>
<a href="#l6.10"></a><span id="l6.10">    */</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  async importKeyFromFile(inputFile) {</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+  async importKeyFromFileAPI(inputFile) {</span>
<a href="#l6.14"></a><span id="l6.14">     return null;</span>
<a href="#l6.15"></a><span id="l6.15">   }</span>
<a href="#l6.16"></a><span id="l6.16"> </span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-  async importKeyBlock(keyBlock) {</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+  async importKeyBlockAPI(keyBlock) {</span>
<a href="#l6.19"></a><span id="l6.19">     return null;</span>
<a href="#l6.20"></a><span id="l6.20">   }</span>
<a href="#l6.21"></a><span id="l6.21"> </span>
<a href="#l6.22"></a><span id="l6.22">   /**</span>
<a href="#l6.23"></a><span id="l6.23">    * Export secret key(s) to a file</span>
<a href="#l6.24"></a><span id="l6.24">    *</span>
<a href="#l6.25"></a><span id="l6.25">    * @param {String}  keyId       Specification by fingerprint or keyID</span>
<a href="#l6.26"></a><span id="l6.26">    * @param {Boolean} minimalKey  if true, reduce key to minimum required</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineat">@@ -249,17 +249,17 @@ class CryptoAPI {</span>
<a href="#l6.28"></a><span id="l6.28">    * @param {String} keyBlockStr  String: the contents of one or more public keys</span>
<a href="#l6.29"></a><span id="l6.29">    *</span>
<a href="#l6.30"></a><span id="l6.30">    * @return {Promise&lt;Array&gt;}: array of objects with the following structure:</span>
<a href="#l6.31"></a><span id="l6.31">    *          - id (key ID)</span>
<a href="#l6.32"></a><span id="l6.32">    *          - fpr</span>
<a href="#l6.33"></a><span id="l6.33">    *          - name (the UID of the key)</span>
<a href="#l6.34"></a><span id="l6.34">    */</span>
<a href="#l6.35"></a><span id="l6.35"> </span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">-  async getKeyListFromKeyBlock(keyBlockStr) {</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+  async getKeyListFromKeyBlockAPI(keyBlockStr) {</span>
<a href="#l6.38"></a><span id="l6.38">     return null;</span>
<a href="#l6.39"></a><span id="l6.39">   }</span>
<a href="#l6.40"></a><span id="l6.40"> </span>
<a href="#l6.41"></a><span id="l6.41">   /**</span>
<a href="#l6.42"></a><span id="l6.42">    * Create a new private key pair, including appropriate sub key pair,</span>
<a href="#l6.43"></a><span id="l6.43">    * and store the new keys in the default keyrings.</span>
<a href="#l6.44"></a><span id="l6.44">    *</span>
<a href="#l6.45"></a><span id="l6.45">    * @param {String} userId     User ID string, with name and email.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/decryption.jsm</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/decryption.jsm</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -554,17 +554,23 @@ var EnigmailDecryption = {</span>
<a href="#l7.4"></a><span id="l7.4">       if (</span>
<a href="#l7.5"></a><span id="l7.5">         EnigmailDialog.confirmDlg(</span>
<a href="#l7.6"></a><span id="l7.6">           parent,</span>
<a href="#l7.7"></a><span id="l7.7">           EnigmailLocale.getString(&quot;attachmentPgpKey&quot;, [displayName]),</span>
<a href="#l7.8"></a><span id="l7.8">           EnigmailLocale.getString(&quot;keyMan.button.import&quot;),</span>
<a href="#l7.9"></a><span id="l7.9">           EnigmailLocale.getString(&quot;dlg.button.view&quot;)</span>
<a href="#l7.10"></a><span id="l7.10">         )</span>
<a href="#l7.11"></a><span id="l7.11">       ) {</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-        let preview = EnigmailKey.getKeyListFromKeyBlock(byteData, errorMsgObj);</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+        let preview = EnigmailKey.getKeyListFromKeyBlock(</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+          byteData,</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+          errorMsgObj,</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+          true,</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+          true,</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+          false</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+        );</span>
<a href="#l7.20"></a><span id="l7.20">         exitCodeObj.keyList = preview;</span>
<a href="#l7.21"></a><span id="l7.21">         let exitStatus = 0;</span>
<a href="#l7.22"></a><span id="l7.22"> </span>
<a href="#l7.23"></a><span id="l7.23">         if (preview &amp;&amp; errorMsgObj.value === &quot;&quot;) {</span>
<a href="#l7.24"></a><span id="l7.24">           if (preview.length &gt; 0) {</span>
<a href="#l7.25"></a><span id="l7.25">             if (preview.length == 1) {</span>
<a href="#l7.26"></a><span id="l7.26">               exitStatus = EnigmailDialog.confirmDlg(</span>
<a href="#l7.27"></a><span id="l7.27">                 parent,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/key.jsm</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/key.jsm</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -140,17 +140,17 @@ var EnigmailKey = {</span>
<a href="#l8.4"></a><span id="l8.4">     const cApi = EnigmailCryptoAPI();</span>
<a href="#l8.5"></a><span id="l8.5">     let keyList;</span>
<a href="#l8.6"></a><span id="l8.6">     let key = {};</span>
<a href="#l8.7"></a><span id="l8.7">     let blocks;</span>
<a href="#l8.8"></a><span id="l8.8">     errorMsgObj.value = &quot;&quot;;</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10">     try {</span>
<a href="#l8.11"></a><span id="l8.11">       keyList = cApi.sync(</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-        cApi.getKeyListFromKeyBlock(keyBlockStr, pubkey, seckey)</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+        cApi.getKeyListFromKeyBlockAPI(keyBlockStr, pubkey, seckey, true)</span>
<a href="#l8.14"></a><span id="l8.14">       );</span>
<a href="#l8.15"></a><span id="l8.15">     } catch (ex) {</span>
<a href="#l8.16"></a><span id="l8.16">       errorMsgObj.value = ex.toString();</span>
<a href="#l8.17"></a><span id="l8.17">       return null;</span>
<a href="#l8.18"></a><span id="l8.18">     }</span>
<a href="#l8.19"></a><span id="l8.19"> </span>
<a href="#l8.20"></a><span id="l8.20">     if (!keyList) {</span>
<a href="#l8.21"></a><span id="l8.21">       return null;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/keyLookupHelper.jsm</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/keyLookupHelper.jsm</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -82,16 +82,18 @@ var KeyLookupHelper = {</span>
<a href="#l9.4"></a><span id="l9.4">     let somethingWasImported = false;</span>
<a href="#l9.5"></a><span id="l9.5">     let wkdKeys = await EnigmailWkdLookup.downloadKey(email);</span>
<a href="#l9.6"></a><span id="l9.6">     if (!wkdKeys) {</span>
<a href="#l9.7"></a><span id="l9.7">       console.debug(&quot;searchKeysOnInternet no wkd data for &quot; + email);</span>
<a href="#l9.8"></a><span id="l9.8">     } else {</span>
<a href="#l9.9"></a><span id="l9.9">       let keyList = EnigmailKey.getKeyListFromKeyBlock(</span>
<a href="#l9.10"></a><span id="l9.10">         wkdKeys.keyData,</span>
<a href="#l9.11"></a><span id="l9.11">         {},</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+        false,</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+        true,</span>
<a href="#l9.14"></a><span id="l9.14">         false</span>
<a href="#l9.15"></a><span id="l9.15">       );</span>
<a href="#l9.16"></a><span id="l9.16">       if (!keyList) {</span>
<a href="#l9.17"></a><span id="l9.17">         EnigmailDialog.alert(window, EnigmailLocale.getString(&quot;previewFailed&quot;));</span>
<a href="#l9.18"></a><span id="l9.18">       } else {</span>
<a href="#l9.19"></a><span id="l9.19">         somethingWasImported = EnigmailKeyRing.importKeyDataWithConfirmation(</span>
<a href="#l9.20"></a><span id="l9.20">           window,</span>
<a href="#l9.21"></a><span id="l9.21">           keyList,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/keyRing.jsm</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/keyRing.jsm</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -345,23 +345,49 @@ var EnigmailKeyRing = {</span>
<a href="#l10.4"></a><span id="l10.4">     seckey</span>
<a href="#l10.5"></a><span id="l10.5">   ) {</span>
<a href="#l10.6"></a><span id="l10.6">     EnigmailLog.DEBUG(</span>
<a href="#l10.7"></a><span id="l10.7">       &quot;keyRing.jsm: EnigmailKeyRing.importKeyFromFile: fileName=&quot; +</span>
<a href="#l10.8"></a><span id="l10.8">         inputFile.path +</span>
<a href="#l10.9"></a><span id="l10.9">         &quot;\n&quot;</span>
<a href="#l10.10"></a><span id="l10.10">     );</span>
<a href="#l10.11"></a><span id="l10.11">     const cApi = EnigmailCryptoAPI();</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-    let res = cApi.sync(</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-      cApi.importKeyFromFile(win, passCB, inputFile, pubkey, seckey)</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-    );</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+    let res;</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+    let tryAgain;</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+    let permissive = false;</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+    do {</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+      // strict on first attempt, permissive on optional second attempt</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+      res = cApi.sync(</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+        cApi.importKeyFromFileAPI(</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+          win,</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+          passCB,</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+          inputFile,</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+          pubkey,</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineplus">+          seckey,</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineplus">+          permissive</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineplus">+        )</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+      );</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineplus">+</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+      tryAgain = false;</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+      let failed = res.exitCode || !res.importedKeys.length;</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+      if (failed &amp;&amp; !permissive) {</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+        let agreed = getDialog().confirmDlg(</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineplus">+          win,</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+          EnigmailLocale.getString(&quot;confirmPermissiveImport&quot;)</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineplus">+        );</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+        if (agreed) {</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+          permissive = true;</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+          tryAgain = true;</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+        }</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+      }</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+    } while (tryAgain);</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+</span>
<a href="#l10.45"></a><span id="l10.45">     if (importedKeysObj) {</span>
<a href="#l10.46"></a><span id="l10.46">       importedKeysObj.keys = res.importedKeys;</span>
<a href="#l10.47"></a><span id="l10.47">     }</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">-</span>
<a href="#l10.49"></a><span id="l10.49">     if (!res) {</span>
<a href="#l10.50"></a><span id="l10.50">       return 1;</span>
<a href="#l10.51"></a><span id="l10.51">     }</span>
<a href="#l10.52"></a><span id="l10.52"> </span>
<a href="#l10.53"></a><span id="l10.53">     if (res.importedKeys.length &gt; 0) {</span>
<a href="#l10.54"></a><span id="l10.54">       EnigmailKeyRing.updateKeys(res.importedKeys);</span>
<a href="#l10.55"></a><span id="l10.55">     }</span>
<a href="#l10.56"></a><span id="l10.56">     EnigmailKeyRing.clearCache();</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineat">@@ -624,32 +650,51 @@ var EnigmailKeyRing = {</span>
<a href="#l10.58"></a><span id="l10.58">       );</span>
<a href="#l10.59"></a><span id="l10.59">     }</span>
<a href="#l10.60"></a><span id="l10.60"> </span>
<a href="#l10.61"></a><span id="l10.61">     if (minimizeKey) {</span>
<a href="#l10.62"></a><span id="l10.62">       throw new Error(&quot;importKeyAsync with minimizeKey: not implemented&quot;);</span>
<a href="#l10.63"></a><span id="l10.63">     }</span>
<a href="#l10.64"></a><span id="l10.64"> </span>
<a href="#l10.65"></a><span id="l10.65">     const cApi = EnigmailCryptoAPI();</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineminus">-    if (isBinary) {</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineminus">-      cApi.sync(cApi.importKeyBlock(keyBlock, true, false)); // public only</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineminus">-    } else {</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineminus">-      cApi.sync(cApi.importKeyBlock(pgpBlock, true, false)); // public only</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineplus">+    let result;</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineplus">+    let tryAgain;</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineplus">+    let permissive = false;</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineplus">+    do {</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineplus">+      // strict on first attempt, permissive on optional second attempt</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineplus">+      if (isBinary) {</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineplus">+        result = cApi.sync(</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineplus">+          cApi.importKeyBlockAPI(keyBlock, true, false, permissive)</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineplus">+        ); // public only</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineplus">+      } else {</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineplus">+        result = cApi.sync(</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineplus">+          cApi.importKeyBlockAPI(pgpBlock, true, false, permissive)</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineplus">+        ); // public only</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineplus">+      }</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineplus">+</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineplus">+      tryAgain = false;</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineplus">+      let failed = result.exitCode || !result.importedKeys.length;</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineplus">+      if (failed &amp;&amp; isInteractive &amp;&amp; !permissive) {</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineplus">+        let agreed = getDialog().confirmDlg(</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineplus">+          parent,</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineplus">+          EnigmailLocale.getString(&quot;confirmPermissiveImport&quot;)</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineplus">+        );</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineplus">+        if (agreed) {</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineplus">+          permissive = true;</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineplus">+          tryAgain = true;</span>
<a href="#l10.95"></a><span id="l10.95" class="difflineplus">+        }</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineplus">+      }</span>
<a href="#l10.97"></a><span id="l10.97" class="difflineplus">+    } while (tryAgain);</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineplus">+</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineplus">+    if (importedKeysObj) {</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineplus">+      importedKeysObj.value = result.importedKeys;</span>
<a href="#l10.101"></a><span id="l10.101">     }</span>
<a href="#l10.102"></a><span id="l10.102"> </span>
<a href="#l10.103"></a><span id="l10.103" class="difflineminus">-    if (!importedKeysObj) {</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineminus">-      importedKeysObj = {};</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineminus">-    }</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineminus">-    importedKeysObj.value = [];</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineminus">-</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineminus">-    let exitCode = 0;</span>
<a href="#l10.109"></a><span id="l10.109" class="difflineminus">-</span>
<a href="#l10.110"></a><span id="l10.110">     EnigmailKeyRing.clearCache();</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineminus">-</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineminus">-    return exitCode;</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineplus">+    return result.exitCode;</span>
<a href="#l10.114"></a><span id="l10.114">   },</span>
<a href="#l10.115"></a><span id="l10.115"> </span>
<a href="#l10.116"></a><span id="l10.116">   importKeyDataWithConfirmation(window, preview, keyData, isBinary) {</span>
<a href="#l10.117"></a><span id="l10.117">     let somethingWasImported = false;</span>
<a href="#l10.118"></a><span id="l10.118">     if (preview.length &gt; 0) {</span>
<a href="#l10.119"></a><span id="l10.119">       let exitStatus;</span>
<a href="#l10.120"></a><span id="l10.120">       if (preview.length == 1) {</span>
<a href="#l10.121"></a><span id="l10.121">         exitStatus = getDialog().confirmDlg(</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/extensions/openpgp/content/modules/keyserver.jsm</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/modules/keyserver.jsm</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -1320,17 +1320,22 @@ const accessVksServer = {</span>
<a href="#l11.4"></a><span id="l11.4">         let r = await this.accessKeyServer(</span>
<a href="#l11.5"></a><span id="l11.5">           EnigmailConstants.SEARCH_KEY,</span>
<a href="#l11.6"></a><span id="l11.6">           keyserver,</span>
<a href="#l11.7"></a><span id="l11.7">           searchArr[i],</span>
<a href="#l11.8"></a><span id="l11.8">           listener</span>
<a href="#l11.9"></a><span id="l11.9">         );</span>
<a href="#l11.10"></a><span id="l11.10"> </span>
<a href="#l11.11"></a><span id="l11.11">         const cApi = EnigmailCryptoAPI();</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-        let keyList = await cApi.getKeyListFromKeyBlock(r);</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+        let keyList = await cApi.getKeyListFromKeyBlockAPI(</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+          r,</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+          true,</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+          false,</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+          true</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+        );</span>
<a href="#l11.19"></a><span id="l11.19">         if (!keyList) {</span>
<a href="#l11.20"></a><span id="l11.20">           retObj.result = -1;</span>
<a href="#l11.21"></a><span id="l11.21">           // TODO: should we set retObj.errorDetails to a string?</span>
<a href="#l11.22"></a><span id="l11.22">           return retObj;</span>
<a href="#l11.23"></a><span id="l11.23">         }</span>
<a href="#l11.24"></a><span id="l11.24"> </span>
<a href="#l11.25"></a><span id="l11.25">         for (let k in keyList) {</span>
<a href="#l11.26"></a><span id="l11.26">           key = {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/extensions/openpgp/content/strings/enigmail.properties</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/strings/enigmail.properties</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -628,8 +628,13 @@ importSettings.button.abortImport=&amp;Abort</span>
<a href="#l12.4"></a><span id="l12.4"> </span>
<a href="#l12.5"></a><span id="l12.5"> cannotUseOwnKeyBecause=Unable to send the message, because there is a problem with your personal key. %S</span>
<a href="#l12.6"></a><span id="l12.6"> cannotEncryptBecauseMissing=Unable to send this message with end-to-end encryption, because there are problems with the keys of the following recipients: %S</span>
<a href="#l12.7"></a><span id="l12.7"> </span>
<a href="#l12.8"></a><span id="l12.8"> </span>
<a href="#l12.9"></a><span id="l12.9"> </span>
<a href="#l12.10"></a><span id="l12.10"> </span>
<a href="#l12.11"></a><span id="l12.11"> fileToBigToImport=This file is too big. Please don't import a large set of keys at once.</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+confirmPermissiveImport=Import failed. The key you are trying to import might be corrupt or use unknown attributes. Would you like to attempt to import the parts that are correct? This might result in the import of incomplete and unusable keys.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mail/extensions/openpgp/content/ui/enigmailKeyManager.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/enigmailKeyManager.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -728,17 +728,24 @@ function enigmailImportFromClipbrd() {</span>
<a href="#l13.4"></a><span id="l13.4">       EnigGetString(&quot;keyMan.button.import&quot;)</span>
<a href="#l13.5"></a><span id="l13.5">     )</span>
<a href="#l13.6"></a><span id="l13.6">   ) {</span>
<a href="#l13.7"></a><span id="l13.7">     return;</span>
<a href="#l13.8"></a><span id="l13.8">   }</span>
<a href="#l13.9"></a><span id="l13.9"> </span>
<a href="#l13.10"></a><span id="l13.10">   var cBoardContent = enigGetClipboard();</span>
<a href="#l13.11"></a><span id="l13.11">   var errorMsgObj = {};</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-  var preview = EnigmailKey.getKeyListFromKeyBlock(cBoardContent, errorMsgObj);</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+  var preview = EnigmailKey.getKeyListFromKeyBlock(</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+    cBoardContent,</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+    errorMsgObj,</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+    true,</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+    true,</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+    false</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineplus">+  );</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineplus">+  // should we allow importing secret keys?</span>
<a href="#l13.21"></a><span id="l13.21">   var exitStatus = -1;</span>
<a href="#l13.22"></a><span id="l13.22"> </span>
<a href="#l13.23"></a><span id="l13.23">   if (preview &amp;&amp; preview.length &gt; 0) {</span>
<a href="#l13.24"></a><span id="l13.24">     if (preview.length == 1) {</span>
<a href="#l13.25"></a><span id="l13.25">       exitStatus = EnigmailDialog.confirmDlg(</span>
<a href="#l13.26"></a><span id="l13.26">         window,</span>
<a href="#l13.27"></a><span id="l13.27">         EnigmailLocale.getString(&quot;doImportOne&quot;, [</span>
<a href="#l13.28"></a><span id="l13.28">           preview[0].name,</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineat">@@ -1053,17 +1060,24 @@ function enigmailImportKeysFromUrl() {</span>
<a href="#l13.30"></a><span id="l13.30">   if (</span>
<a href="#l13.31"></a><span id="l13.31">     EnigmailDialog.promptValue(window, EnigGetString(&quot;importFromUrl&quot;), value)</span>
<a href="#l13.32"></a><span id="l13.32">   ) {</span>
<a href="#l13.33"></a><span id="l13.33">     var p = new Promise(function(resolve, reject) {</span>
<a href="#l13.34"></a><span id="l13.34">       var cbFunc = function(data) {</span>
<a href="#l13.35"></a><span id="l13.35">         EnigmailLog.DEBUG(&quot;enigmailImportKeysFromUrl: _cbFunc()\n&quot;);</span>
<a href="#l13.36"></a><span id="l13.36">         var errorMsgObj = {};</span>
<a href="#l13.37"></a><span id="l13.37"> </span>
<a href="#l13.38"></a><span id="l13.38" class="difflineminus">-        var preview = EnigmailKey.getKeyListFromKeyBlock(data, errorMsgObj);</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+        var preview = EnigmailKey.getKeyListFromKeyBlock(</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineplus">+          data,</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineplus">+          errorMsgObj,</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineplus">+          true,</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+          true,</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineplus">+          false</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineplus">+        );</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineplus">+        // should we allow importing secret keys?</span>
<a href="#l13.47"></a><span id="l13.47">         var exitStatus = -1;</span>
<a href="#l13.48"></a><span id="l13.48"> </span>
<a href="#l13.49"></a><span id="l13.49">         if (preview &amp;&amp; preview.length &gt; 0) {</span>
<a href="#l13.50"></a><span id="l13.50">           if (preview.length == 1) {</span>
<a href="#l13.51"></a><span id="l13.51">             exitStatus = EnigmailDialog.confirmDlg(</span>
<a href="#l13.52"></a><span id="l13.52">               window,</span>
<a href="#l13.53"></a><span id="l13.53">               EnigmailLocale.getString(&quot;doImportOne&quot;, [</span>
<a href="#l13.54"></a><span id="l13.54">                 preview[0].name,</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineat">@@ -1445,16 +1459,19 @@ var gKeyListView = {</span>
<a href="#l13.56"></a><span id="l13.56">   },</span>
<a href="#l13.57"></a><span id="l13.57"> </span>
<a href="#l13.58"></a><span id="l13.58">   getCellText(row, col) {</span>
<a href="#l13.59"></a><span id="l13.59">     let r = this.getFilteredRow(row);</span>
<a href="#l13.60"></a><span id="l13.60">     if (!r) {</span>
<a href="#l13.61"></a><span id="l13.61">       return &quot;&quot;;</span>
<a href="#l13.62"></a><span id="l13.62">     }</span>
<a href="#l13.63"></a><span id="l13.63">     let keyObj = gKeyList[r.keyNum];</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineplus">+    if (!keyObj) {</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineplus">+      return &quot;???&quot;;</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineplus">+    }</span>
<a href="#l13.67"></a><span id="l13.67"> </span>
<a href="#l13.68"></a><span id="l13.68">     switch (r.rowType) {</span>
<a href="#l13.69"></a><span id="l13.69">       case &quot;key&quot;:</span>
<a href="#l13.70"></a><span id="l13.70">         switch (col.id) {</span>
<a href="#l13.71"></a><span id="l13.71">           case &quot;enigUserNameCol&quot;:</span>
<a href="#l13.72"></a><span id="l13.72">             return keyObj.userId;</span>
<a href="#l13.73"></a><span id="l13.73">           case &quot;keyCol&quot;:</span>
<a href="#l13.74"></a><span id="l13.74">             return keyObj.keyId;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mail/extensions/openpgp/content/ui/enigmailMessengerOverlay.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -1772,17 +1772,23 @@ Enigmail.msg = {</span>
<a href="#l14.4"></a><span id="l14.4">     let keyDataB64 = document</span>
<a href="#l14.5"></a><span id="l14.5">       .getElementById(&quot;openpgpKeyBox&quot;)</span>
<a href="#l14.6"></a><span id="l14.6">       .getAttribute(&quot;keydata&quot;);</span>
<a href="#l14.7"></a><span id="l14.7">     if (!keyDataB64) {</span>
<a href="#l14.8"></a><span id="l14.8">       return;</span>
<a href="#l14.9"></a><span id="l14.9">     }</span>
<a href="#l14.10"></a><span id="l14.10">     let keyData = EnigmailData.decodeBase64(keyDataB64);</span>
<a href="#l14.11"></a><span id="l14.11">     let errorMsgObj = {};</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-    let preview = EnigmailKey.getKeyListFromKeyBlock(keyData, errorMsgObj);</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+    let preview = EnigmailKey.getKeyListFromKeyBlock(</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+      keyData,</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+      errorMsgObj,</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+      true,</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+      true,</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineplus">+      false</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineplus">+    );</span>
<a href="#l14.20"></a><span id="l14.20">     if (preview &amp;&amp; errorMsgObj.value === &quot;&quot;) {</span>
<a href="#l14.21"></a><span id="l14.21">       EnigmailKeyRing.importKeyDataWithConfirmation(</span>
<a href="#l14.22"></a><span id="l14.22">         window,</span>
<a href="#l14.23"></a><span id="l14.23">         preview,</span>
<a href="#l14.24"></a><span id="l14.24">         keyData,</span>
<a href="#l14.25"></a><span id="l14.25">         true</span>
<a href="#l14.26"></a><span id="l14.26">       );</span>
<a href="#l14.27"></a><span id="l14.27">     } else {</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineat">@@ -1817,17 +1823,23 @@ Enigmail.msg = {</span>
<a href="#l14.29"></a><span id="l14.29">     );</span>
<a href="#l14.30"></a><span id="l14.30">     if (!blockType || blockType !== &quot;PUBLIC KEY BLOCK&quot;) {</span>
<a href="#l14.31"></a><span id="l14.31">       return;</span>
<a href="#l14.32"></a><span id="l14.32">     }</span>
<a href="#l14.33"></a><span id="l14.33"> </span>
<a href="#l14.34"></a><span id="l14.34">     let keyData = msgData.substring(beginIndexObj.value, endIndexObj.value);</span>
<a href="#l14.35"></a><span id="l14.35"> </span>
<a href="#l14.36"></a><span id="l14.36">     let errorMsgObj = {};</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineminus">-    let preview = EnigmailKey.getKeyListFromKeyBlock(keyData, errorMsgObj);</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+    let preview = EnigmailKey.getKeyListFromKeyBlock(</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+      keyData,</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineplus">+      errorMsgObj,</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+      true,</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+      true,</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineplus">+      false</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineplus">+    );</span>
<a href="#l14.45"></a><span id="l14.45">     if (preview &amp;&amp; errorMsgObj.value === &quot;&quot;) {</span>
<a href="#l14.46"></a><span id="l14.46">       EnigmailKeyRing.importKeyDataWithConfirmation(</span>
<a href="#l14.47"></a><span id="l14.47">         window,</span>
<a href="#l14.48"></a><span id="l14.48">         preview,</span>
<a href="#l14.49"></a><span id="l14.49">         keyData,</span>
<a href="#l14.50"></a><span id="l14.50">         false</span>
<a href="#l14.51"></a><span id="l14.51">       );</span>
<a href="#l14.52"></a><span id="l14.52">     } else {</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineat">@@ -2771,17 +2783,20 @@ Enigmail.msg = {</span>
<a href="#l14.54"></a><span id="l14.54">         errorMsgObj.value = EnigmailLocale.getString(&quot;noTempDir&quot;);</span>
<a href="#l14.55"></a><span id="l14.55">         return;</span>
<a href="#l14.56"></a><span id="l14.56">       }</span>
<a href="#l14.57"></a><span id="l14.57">     }</span>
<a href="#l14.58"></a><span id="l14.58"> </span>
<a href="#l14.59"></a><span id="l14.59">     if (callbackArg.actionType == &quot;importKey&quot;) {</span>
<a href="#l14.60"></a><span id="l14.60">       var preview = EnigmailKey.getKeyListFromKeyBlock(</span>
<a href="#l14.61"></a><span id="l14.61">         callbackArg.data,</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineminus">-        errorMsgObj</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineplus">+        errorMsgObj,</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineplus">+        true,</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineplus">+        true,</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineplus">+        false</span>
<a href="#l14.67"></a><span id="l14.67">       );</span>
<a href="#l14.68"></a><span id="l14.68"> </span>
<a href="#l14.69"></a><span id="l14.69">       if (errorMsgObj.value !== &quot;&quot; || !preview || preview.length === 0) {</span>
<a href="#l14.70"></a><span id="l14.70">         // try decrypting the attachment</span>
<a href="#l14.71"></a><span id="l14.71">         exitStatus = EnigmailDecryption.decryptAttachment(</span>
<a href="#l14.72"></a><span id="l14.72">           window,</span>
<a href="#l14.73"></a><span id="l14.73">           outFile,</span>
<a href="#l14.74"></a><span id="l14.74">           EnigmailMsgRead.getAttachmentName(callbackArg.attachment),</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineat">@@ -2790,17 +2805,20 @@ Enigmail.msg = {</span>
<a href="#l14.76"></a><span id="l14.76">           statusFlagsObj,</span>
<a href="#l14.77"></a><span id="l14.77">           errorMsgObj</span>
<a href="#l14.78"></a><span id="l14.78">         );</span>
<a href="#l14.79"></a><span id="l14.79">         if (exitStatus &amp;&amp; exitCodeObj.value === 0) {</span>
<a href="#l14.80"></a><span id="l14.80">           // success decrypting, let's try again</span>
<a href="#l14.81"></a><span id="l14.81">           callbackArg.data = EnigmailFiles.readBinaryFile(outFile);</span>
<a href="#l14.82"></a><span id="l14.82">           preview = EnigmailKey.getKeyListFromKeyBlock(</span>
<a href="#l14.83"></a><span id="l14.83">             callbackArg.data,</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineminus">-            errorMsgObj</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineplus">+            errorMsgObj,</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineplus">+            true,</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineplus">+            true,</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineplus">+            false</span>
<a href="#l14.89"></a><span id="l14.89">           );</span>
<a href="#l14.90"></a><span id="l14.90">         }</span>
<a href="#l14.91"></a><span id="l14.91">       }</span>
<a href="#l14.92"></a><span id="l14.92"> </span>
<a href="#l14.93"></a><span id="l14.93">       if (preview &amp;&amp; errorMsgObj.value === &quot;&quot;) {</span>
<a href="#l14.94"></a><span id="l14.94">         EnigmailKeyRing.importKeyDataWithConfirmation(</span>
<a href="#l14.95"></a><span id="l14.95">           window,</span>
<a href="#l14.96"></a><span id="l14.96">           preview,</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

