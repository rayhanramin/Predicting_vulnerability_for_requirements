<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 27010:71b2391d6c438c32cdd1f9598b96b7f7efe6cde7</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 71b2391d6c438c32cdd1f9598b96b7f7efe6cde7" />
<meta property="og:url" content="/comm-central/rev/71b2391d6c438c32cdd1f9598b96b7f7efe6cde7" />
<meta property="og:description" content="Bug 1558565 - Fix accounts and folders submenus in the new appmenu. r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 71b2391d6c438c32cdd1f9598b96b7f7efe6cde7 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/71b2391d6c438c32cdd1f9598b96b7f7efe6cde7">shortlog</a> |
<a href="/comm-central/log/71b2391d6c438c32cdd1f9598b96b7f7efe6cde7">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/71b2391d6c438c32cdd1f9598b96b7f7efe6cde7">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/71b2391d6c438c32cdd1f9598b96b7f7efe6cde7">files</a> |
changeset |
<a href="/comm-central/raw-rev/71b2391d6c438c32cdd1f9598b96b7f7efe6cde7">raw</a>  | <a href="/comm-central/archive/71b2391d6c438c32cdd1f9598b96b7f7efe6cde7.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1558565">Bug 1558565</a> - Fix accounts and folders submenus in the new appmenu. r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#97;&#117;&#108;&#32;&#77;&#111;&#114;&#114;&#105;&#115;&#32;&#60;&#112;&#97;&#117;&#108;&#64;&#112;&#97;&#117;&#108;&#119;&#109;&#111;&#114;&#114;&#105;&#115;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 21 Jun 2019 09:20:17 -0400</td></tr>

<tr>
 <td>changeset 27010</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/71b2391d6c438c32cdd1f9598b96b7f7efe6cde7">71b2391d6c438c32cdd1f9598b96b7f7efe6cde7</a></td>
</tr>



<tr>
<td>parent 27009</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/50955fe1cb9823bed5efef3d7b5e5f076e87f0a1">50955fe1cb9823bed5efef3d7b5e5f076e87f0a1</a>
</td>
</tr>

<tr>
<td>child 27011</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/ca1b8ae86f9bd685de4c9c2cc019c38637996977">ca1b8ae86f9bd685de4c9c2cc019c38637996977</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=71b2391d6c438c32cdd1f9598b96b7f7efe6cde7">16109</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Thu, 27 Jun 2019 23:44:58 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@d714bac9fcfa [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=d714bac9fcfa78997c1de9d92118b61d028dedd9">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=d714bac9fcfa78997c1de9d92118b61d028dedd9&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=d714bac9fcfa78997c1de9d92118b61d028dedd9&newProject=comm-central&newRevision=537896eeac1b6837f6b14e9b937215571d8ce0e9&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=d714bac9fcfa78997c1de9d92118b61d028dedd9&newProject=comm-central&newRevision=537896eeac1b6837f6b14e9b937215571d8ce0e9&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=d714bac9fcfa78997c1de9d92118b61d028dedd9&newProject=comm-central&newRevision=537896eeac1b6837f6b14e9b937215571d8ce0e9&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1558565">1558565</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1558565">Bug 1558565</a> - Fix accounts and folders submenus in the new appmenu. r=mkmelin</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/71b2391d6c438c32cdd1f9598b96b7f7efe6cde7/mail/base/content/mainCommandSet.inc.xul">mail/base/content/mainCommandSet.inc.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/71b2391d6c438c32cdd1f9598b96b7f7efe6cde7/mail/base/content/mainCommandSet.inc.xul">file</a> |
<a href="/comm-central/annotate/71b2391d6c438c32cdd1f9598b96b7f7efe6cde7/mail/base/content/mainCommandSet.inc.xul">annotate</a> |
<a href="/comm-central/diff/71b2391d6c438c32cdd1f9598b96b7f7efe6cde7/mail/base/content/mainCommandSet.inc.xul">diff</a> |
<a href="/comm-central/comparison/71b2391d6c438c32cdd1f9598b96b7f7efe6cde7/mail/base/content/mainCommandSet.inc.xul">comparison</a> |
<a href="/comm-central/log/71b2391d6c438c32cdd1f9598b96b7f7efe6cde7/mail/base/content/mainCommandSet.inc.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/71b2391d6c438c32cdd1f9598b96b7f7efe6cde7/mail/components/customizableui/content/panelUI.inc.xul">mail/components/customizableui/content/panelUI.inc.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/71b2391d6c438c32cdd1f9598b96b7f7efe6cde7/mail/components/customizableui/content/panelUI.inc.xul">file</a> |
<a href="/comm-central/annotate/71b2391d6c438c32cdd1f9598b96b7f7efe6cde7/mail/components/customizableui/content/panelUI.inc.xul">annotate</a> |
<a href="/comm-central/diff/71b2391d6c438c32cdd1f9598b96b7f7efe6cde7/mail/components/customizableui/content/panelUI.inc.xul">diff</a> |
<a href="/comm-central/comparison/71b2391d6c438c32cdd1f9598b96b7f7efe6cde7/mail/components/customizableui/content/panelUI.inc.xul">comparison</a> |
<a href="/comm-central/log/71b2391d6c438c32cdd1f9598b96b7f7efe6cde7/mail/components/customizableui/content/panelUI.inc.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/71b2391d6c438c32cdd1f9598b96b7f7efe6cde7/mail/test/mozmill/folder-widget/test-message-filters.js">mail/test/mozmill/folder-widget/test-message-filters.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/71b2391d6c438c32cdd1f9598b96b7f7efe6cde7/mail/test/mozmill/folder-widget/test-message-filters.js">file</a> |
<a href="/comm-central/annotate/71b2391d6c438c32cdd1f9598b96b7f7efe6cde7/mail/test/mozmill/folder-widget/test-message-filters.js">annotate</a> |
<a href="/comm-central/diff/71b2391d6c438c32cdd1f9598b96b7f7efe6cde7/mail/test/mozmill/folder-widget/test-message-filters.js">diff</a> |
<a href="/comm-central/comparison/71b2391d6c438c32cdd1f9598b96b7f7efe6cde7/mail/test/mozmill/folder-widget/test-message-filters.js">comparison</a> |
<a href="/comm-central/log/71b2391d6c438c32cdd1f9598b96b7f7efe6cde7/mail/test/mozmill/folder-widget/test-message-filters.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/71b2391d6c438c32cdd1f9598b96b7f7efe6cde7/mailnews/base/content/folder-menupopup.js">mailnews/base/content/folder-menupopup.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/71b2391d6c438c32cdd1f9598b96b7f7efe6cde7/mailnews/base/content/folder-menupopup.js">file</a> |
<a href="/comm-central/annotate/71b2391d6c438c32cdd1f9598b96b7f7efe6cde7/mailnews/base/content/folder-menupopup.js">annotate</a> |
<a href="/comm-central/diff/71b2391d6c438c32cdd1f9598b96b7f7efe6cde7/mailnews/base/content/folder-menupopup.js">diff</a> |
<a href="/comm-central/comparison/71b2391d6c438c32cdd1f9598b96b7f7efe6cde7/mailnews/base/content/folder-menupopup.js">comparison</a> |
<a href="/comm-central/log/71b2391d6c438c32cdd1f9598b96b7f7efe6cde7/mailnews/base/content/folder-menupopup.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/mainCommandSet.inc.xul</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/mainCommandSet.inc.xul</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -166,17 +166,17 @@</span>
<a href="#l1.4"></a><span id="l1.4">     &lt;command id=&quot;cmd_nextUnreadThread&quot; oncommand=&quot;goDoCommand('cmd_nextUnreadThread')&quot; disabled=&quot;true&quot;/&gt;</span>
<a href="#l1.5"></a><span id="l1.5">     &lt;command id=&quot;cmd_previousMsg&quot; oncommand=&quot;goDoCommand('cmd_previousMsg')&quot; disabled=&quot;true&quot;/&gt;</span>
<a href="#l1.6"></a><span id="l1.6">     &lt;command id=&quot;cmd_previousUnreadMsg&quot; oncommand=&quot;goDoCommand('cmd_previousUnreadMsg')&quot; disabled=&quot;true&quot;/&gt;</span>
<a href="#l1.7"></a><span id="l1.7">     &lt;command id=&quot;cmd_previousFlaggedMsg&quot; oncommand=&quot;goDoCommand('cmd_previousFlaggedMsg')&quot; disabled=&quot;true&quot;/&gt;</span>
<a href="#l1.8"></a><span id="l1.8">     &lt;command id=&quot;cmd_goStartPage&quot; oncommand=&quot;goDoCommand('cmd_goStartPage');&quot;/&gt;</span>
<a href="#l1.9"></a><span id="l1.9">     &lt;command id=&quot;cmd_undoCloseTab&quot; oncommand=&quot;goDoCommand('cmd_undoCloseTab');&quot;/&gt;</span>
<a href="#l1.10"></a><span id="l1.10">     &lt;command id=&quot;cmd_goForward&quot; oncommand=&quot;goDoCommand('cmd_goForward')&quot; disabled=&quot;true&quot;/&gt;</span>
<a href="#l1.11"></a><span id="l1.11">     &lt;command id=&quot;cmd_goBack&quot; oncommand=&quot;goDoCommand('cmd_goBack')&quot; disabled=&quot;true&quot;/&gt;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    &lt;command id=&quot;cmd_goFolder&quot; oncommand=&quot;gFolderTreeView.selectFolder(event.target._folder, true);&quot; disabled=&quot;true&quot;/&gt;</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+    &lt;command id=&quot;cmd_goFolder&quot; oncommand=&quot;gFolderTreeView.selectFolder(event.explicitOriginalTarget._folder, true);&quot; disabled=&quot;true&quot;/&gt;</span>
<a href="#l1.14"></a><span id="l1.14">     &lt;command id=&quot;cmd_chat&quot; oncommand=&quot;goDoCommand('cmd_chat')&quot; disabled=&quot;true&quot;/&gt;</span>
<a href="#l1.15"></a><span id="l1.15">   &lt;/commandset&gt;</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17">   &lt;commandset id=&quot;mailMessageMenuItems&quot;</span>
<a href="#l1.18"></a><span id="l1.18">               commandupdater=&quot;true&quot;</span>
<a href="#l1.19"></a><span id="l1.19">               events=&quot;create-menu-message&quot;</span>
<a href="#l1.20"></a><span id="l1.20">               oncommandupdate=&quot;goUpdateMailMenuItems(this)&quot;&gt;</span>
<a href="#l1.21"></a><span id="l1.21">     &lt;command id=&quot;cmd_archive&quot; oncommand=&quot;goDoCommand('cmd_archive')&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/components/customizableui/content/panelUI.inc.xul</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/components/customizableui/content/panelUI.inc.xul</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -673,52 +673,35 @@</span>
<a href="#l2.4"></a><span id="l2.4">                        class=&quot;subviewbutton subviewbutton-nav&quot;</span>
<a href="#l2.5"></a><span id="l2.5">                        label=&quot;&amp;offlineMenu.label;&quot;</span>
<a href="#l2.6"></a><span id="l2.6">                        closemenu=&quot;none&quot;</span>
<a href="#l2.7"></a><span id="l2.7">                        oncommand=&quot;PanelUI.showSubView('appMenu-fileOfflineView', this)&quot;/&gt;</span>
<a href="#l2.8"></a><span id="l2.8">       &lt;/vbox&gt;</span>
<a href="#l2.9"></a><span id="l2.9">     &lt;/panelview&gt;</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11">     &lt;!-- File / Get New Message For --&gt;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-    &lt;panelview id=&quot;appMenu-fileGetNewMsgForView&quot;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+    &lt;panelview is=&quot;folder-panelview&quot; id=&quot;appMenu-fileGetNewMsgForView&quot;</span>
<a href="#l2.14"></a><span id="l2.14">                title=&quot;&amp;getNewMsgForCmd.label;&quot;</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-               class=&quot;PanelUI-subView&quot;&gt;</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+               class=&quot;PanelUI-subView&quot;</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+               mode=&quot;getMail&quot;</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+               expandFolders=&quot;false&quot;</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+               oncommand=&quot;MsgGetMessagesForAccount(event.target._folder); event.stopPropagation();&quot;&gt;</span>
<a href="#l2.20"></a><span id="l2.20">       &lt;vbox class=&quot;panel-subview-body&quot;&gt;</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">-        &lt;!-- TODO appmenu dynamically populate account items here</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineminus">-             Once dynamic folders subviews work, use these commented</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineminus">-             toolbarbuttons in place of the &lt;menu&gt; below. --&gt;</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineminus">-        &lt;!-- &lt;toolbarbutton id=&quot;appmenu_getnewmsgs_all_accounts&quot;</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+        &lt;toolbarbutton id=&quot;appmenu_getnewmsgs_all_accounts&quot;</span>
<a href="#l2.26"></a><span id="l2.26">                        class=&quot;subviewbutton subviewbutton-iconic&quot;</span>
<a href="#l2.27"></a><span id="l2.27">                        label=&quot;&amp;getAllNewMsgCmdPopupMenu.label;&quot;</span>
<a href="#l2.28"></a><span id="l2.28">                        key=&quot;key_getAllNewMessages&quot;</span>
<a href="#l2.29"></a><span id="l2.29">                        command=&quot;cmd_getMsgsForAuthAccounts&quot;/&gt;</span>
<a href="#l2.30"></a><span id="l2.30">         &lt;toolbarbutton id=&quot;appmenu_getnewmsgs_current_account&quot;</span>
<a href="#l2.31"></a><span id="l2.31">                        class=&quot;subviewbutton subviewbutton-iconic&quot;</span>
<a href="#l2.32"></a><span id="l2.32">                        label=&quot;&amp;getNewMsgCurrentAccountCmdPopupMenu.label;&quot;</span>
<a href="#l2.33"></a><span id="l2.33">                        key=&quot;key_getNewMessages&quot;</span>
<a href="#l2.34"></a><span id="l2.34">                        command=&quot;cmd_getNewMessages&quot;/&gt;</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-        &lt;toolbarseparator/&gt; --&gt;</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-        &lt;menu id=&quot;appmenu_getNewMsgFor&quot;</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-              label=&quot;&amp;getNewMsgForCmd.label;&quot;</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineminus">-              oncommand=&quot;MsgGetMessagesForAccount();&quot;&gt;</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-          &lt;menupopup is=&quot;folder-menupopup&quot; id=&quot;appmenu_getAllNewMsgPopup&quot;</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-                     mode=&quot;getMail&quot;</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-                     expandFolders=&quot;false&quot;</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineminus">-                     oncommand=&quot;MsgGetMessagesForAccount(event.target._folder); event.stopPropagation();&quot;&gt;</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineminus">-            &lt;menuitem id=&quot;appmenu_getnewmsgs_all_accounts&quot;</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-                      label=&quot;&amp;getAllNewMsgCmdPopupMenu.label;&quot;</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineminus">-                      key=&quot;key_getAllNewMessages&quot;</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineminus">-                      command=&quot;cmd_getMsgsForAuthAccounts&quot;/&gt;</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineminus">-            &lt;menuitem id=&quot;appmenu_getnewmsgs_current_account&quot;</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-                      label=&quot;&amp;getNewMsgCurrentAccountCmdPopupMenu.label;&quot;</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-                      key=&quot;key_getNewMessages&quot;</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-                      command=&quot;cmd_getNewMessages&quot;/&gt;</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-            &lt;menuseparator/&gt;</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-          &lt;/menupopup&gt;</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-        &lt;/menu&gt;</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+        &lt;toolbarseparator/&gt;</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+        &lt;!-- toolbarbuttons are dynamically added here by folder-panelview custom element. --&gt;</span>
<a href="#l2.56"></a><span id="l2.56">       &lt;/vbox&gt;</span>
<a href="#l2.57"></a><span id="l2.57">     &lt;/panelview&gt;</span>
<a href="#l2.58"></a><span id="l2.58"> </span>
<a href="#l2.59"></a><span id="l2.59">     &lt;!-- File / Offline --&gt;</span>
<a href="#l2.60"></a><span id="l2.60">     &lt;panelview id=&quot;appMenu-fileOfflineView&quot;</span>
<a href="#l2.61"></a><span id="l2.61">                title=&quot;&amp;offlineMenu.label;&quot;</span>
<a href="#l2.62"></a><span id="l2.62">                class=&quot;PanelUI-subView&quot;&gt;</span>
<a href="#l2.63"></a><span id="l2.63">       &lt;vbox class=&quot;panel-subview-body&quot;&gt;</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineat">@@ -1379,31 +1362,24 @@</span>
<a href="#l2.65"></a><span id="l2.65">         &lt;toolbarbutton id=&quot;appmenu_prevFlaggedMsg&quot;</span>
<a href="#l2.66"></a><span id="l2.66">                        class=&quot;subviewbutton subviewbutton-iconic&quot;</span>
<a href="#l2.67"></a><span id="l2.67">                        label=&quot;&amp;prevStarredMsgCmd.label;&quot;</span>
<a href="#l2.68"></a><span id="l2.68">                        command=&quot;cmd_previousFlaggedMsg&quot;/&gt;</span>
<a href="#l2.69"></a><span id="l2.69">       &lt;/vbox&gt;</span>
<a href="#l2.70"></a><span id="l2.70">     &lt;/panelview&gt;</span>
<a href="#l2.71"></a><span id="l2.71"> </span>
<a href="#l2.72"></a><span id="l2.72">     &lt;!-- Go / Folder --&gt;</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineminus">-    &lt;panelview id=&quot;appMenu-goFolderView&quot;</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+    &lt;!-- toolbarbuttons are dynamically added by folder-panelview custom element. --&gt;</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+    &lt;panelview is=&quot;folder-panelview&quot; id=&quot;appMenu-goFolderView&quot;</span>
<a href="#l2.76"></a><span id="l2.76">                title=&quot;&amp;folderMenu.label;&quot;</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineminus">-               class=&quot;PanelUI-subView&quot;&gt;</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineminus">-      &lt;vbox class=&quot;panel-subview-body&quot;&gt;</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineminus">-        &lt;!-- TODO appmenu dynamically populate --&gt;</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineminus">-        &lt;menu id=&quot;appmenu_goFolderMenu&quot;</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineminus">-              label=&quot;&amp;folderMenu.label;&quot;</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineminus">-              command=&quot;cmd_goFolder&quot;&gt;</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineminus">-          &lt;menupopup is=&quot;folder-menupopup&quot; id=&quot;appmenu_GoFolderPopup&quot;</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineminus">-                     showFileHereLabel=&quot;true&quot;</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineminus">-                     showRecent=&quot;true&quot;</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineminus">-                     recentLabel=&quot;&amp;contextMoveCopyMsgRecentMenu.label;&quot;/&gt;</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineminus">-        &lt;/menu&gt;</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineminus">-      &lt;/vbox&gt;</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineminus">-    &lt;/panelview&gt;</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+               class=&quot;PanelUI-subView&quot;</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+               showFileHereLabel=&quot;true&quot;</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineplus">+               showRecent=&quot;true&quot;</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineplus">+               command=&quot;cmd_goFolder&quot;</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineplus">+               recentLabel=&quot;&amp;contextMoveCopyMsgRecentMenu.label;&quot;/&gt;</span>
<a href="#l2.95"></a><span id="l2.95"> </span>
<a href="#l2.96"></a><span id="l2.96">     &lt;!-- Go / Recently Closed Tabs --&gt;</span>
<a href="#l2.97"></a><span id="l2.97">     &lt;!-- Dynamically populated when shown. --&gt;</span>
<a href="#l2.98"></a><span id="l2.98">     &lt;!-- TODO appmenu - what about this 'observes' bit?</span>
<a href="#l2.99"></a><span id="l2.99">         &lt;menu id=&quot;appmenu_goRecentlyClosedTabs&quot;</span>
<a href="#l2.100"></a><span id="l2.100">                   label=&quot;&amp;goRecentlyClosedTabs.label;&quot;</span>
<a href="#l2.101"></a><span id="l2.101">                   observes=&quot;cmd_undoCloseTab&quot;&gt;</span>
<a href="#l2.102"></a><span id="l2.102">     --&gt;</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineat">@@ -1673,56 +1649,42 @@</span>
<a href="#l2.104"></a><span id="l2.104">         &lt;toolbarbutton id=&quot;appmenu_recalculateJunkScore&quot;</span>
<a href="#l2.105"></a><span id="l2.105">                        class=&quot;subviewbutton subviewbutton-iconic&quot;</span>
<a href="#l2.106"></a><span id="l2.106">                        label=&quot;&amp;recalculateJunkScoreCmd.label;&quot;</span>
<a href="#l2.107"></a><span id="l2.107">                        command=&quot;cmd_recalculateJunkScore&quot;/&gt;</span>
<a href="#l2.108"></a><span id="l2.108">       &lt;/vbox&gt;</span>
<a href="#l2.109"></a><span id="l2.109">     &lt;/panelview&gt;</span>
<a href="#l2.110"></a><span id="l2.110"> </span>
<a href="#l2.111"></a><span id="l2.111">     &lt;!-- Message / Move To --&gt;</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineminus">-    &lt;panelview id=&quot;appMenu-messageMoveToView&quot;</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineplus">+    &lt;!-- toolbarbuttons are dynamically added by folder-panelview custom element. --&gt;</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineplus">+    &lt;panelview is=&quot;folder-panelview&quot; id=&quot;appMenu-messageMoveToView&quot;</span>
<a href="#l2.115"></a><span id="l2.115">                title=&quot;&amp;moveMsgToMenu.label;&quot;</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineminus">-               class=&quot;PanelUI-subView&quot;&gt;</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineminus">-      &lt;vbox class=&quot;panel-subview-body&quot;&gt;</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineminus">-        &lt;!-- TODO appmenu dynamic population --&gt;</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineminus">-        &lt;menu id=&quot;appmenu_moveMenu&quot;</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineminus">-              label=&quot;&amp;moveMsgToMenu.label;&quot;</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineminus">-              oncommand=&quot;MsgMoveMessage(event.target._folder)&quot;&gt;</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineminus">-          &lt;menupopup is=&quot;folder-menupopup&quot;</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineminus">-                     mode=&quot;filing&quot;</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineminus">-                     showFileHereLabel=&quot;true&quot;</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineminus">-                     showRecent=&quot;true&quot;</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineminus">-                     recentLabel=&quot;&amp;moveCopyMsgRecentMenu.label;&quot;</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineminus">-                     showFavorites=&quot;true&quot;</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineminus">-                     favoritesLabel=&quot;&amp;contextMoveCopyMsgFavoritesMenu.label;&quot;</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineminus">-                     favoritesAccessKey=&quot;&amp;contextMoveCopyMsgFavoritesMenu.accesskey;&quot;/&gt;</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineminus">-        &lt;/menu&gt;</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineminus">-      &lt;/vbox&gt;</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineminus">-    &lt;/panelview&gt;</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineplus">+               class=&quot;PanelUI-subView&quot;</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineplus">+               oncommand=&quot;MsgMoveMessage(event.target._folder)&quot;</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineplus">+               mode=&quot;filing&quot;</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineplus">+               showFileHereLabel=&quot;true&quot;</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineplus">+               showRecent=&quot;true&quot;</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineplus">+               recentLabel=&quot;&amp;moveCopyMsgRecentMenu.label;&quot;</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineplus">+               showFavorites=&quot;true&quot;</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineplus">+               favoritesLabel=&quot;&amp;contextMoveCopyMsgFavoritesMenu.label;&quot;</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineplus">+               favoritesAccessKey=&quot;&amp;contextMoveCopyMsgFavoritesMenu.accesskey;&quot;/&gt;</span>
<a href="#l2.142"></a><span id="l2.142"> </span>
<a href="#l2.143"></a><span id="l2.143">     &lt;!-- Message / Copy To --&gt;</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineminus">-    &lt;panelview id=&quot;appMenu-messageCopyToView&quot;</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineplus">+    &lt;!-- toolbarbuttons are dynamically added by folder-panelview custom element. --&gt;</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineplus">+    &lt;panelview is=&quot;folder-panelview&quot; id=&quot;appMenu-messageCopyToView&quot;</span>
<a href="#l2.147"></a><span id="l2.147">                title=&quot;&amp;copyMsgToMenu.label;&quot;</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineminus">-               class=&quot;PanelUI-subView&quot;&gt;</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineminus">-      &lt;vbox class=&quot;panel-subview-body&quot;&gt;</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineminus">-        &lt;!-- TODO appmenu dynamic population --&gt;</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineminus">-        &lt;menu id=&quot;appmenu_copyMenu&quot;</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineminus">-              label=&quot;&amp;copyMsgToMenu.label;&quot;</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineminus">-              oncommand=&quot;MsgCopyMessage(event.target._folder)&quot;&gt;</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineminus">-          &lt;menupopup is=&quot;folder-menupopup&quot;</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineminus">-                      mode=&quot;filing&quot;</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineminus">-                      showFileHereLabel=&quot;true&quot;</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineminus">-                      showRecent=&quot;true&quot;</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineminus">-                      recentLabel=&quot;&amp;moveCopyMsgRecentMenu.label;&quot;</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineminus">-                      showFavorites=&quot;true&quot;</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineminus">-                      favoritesLabel=&quot;&amp;contextMoveCopyMsgFavoritesMenu.label;&quot;</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineminus">-                      favoritesAccessKey=&quot;&amp;contextMoveCopyMsgFavoritesMenu.accesskey;&quot;/&gt;</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineminus">-        &lt;/menu&gt;</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineminus">-      &lt;/vbox&gt;</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineminus">-    &lt;/panelview&gt;</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineplus">+               class=&quot;PanelUI-subView&quot;</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineplus">+               oncommand=&quot;MsgCopyMessage(event.target._folder)&quot;</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineplus">+               mode=&quot;filing&quot;</span>
<a href="#l2.168"></a><span id="l2.168" class="difflineplus">+               showFileHereLabel=&quot;true&quot;</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineplus">+               showRecent=&quot;true&quot;</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineplus">+               recentLabel=&quot;&amp;moveCopyMsgRecentMenu.label;&quot;</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineplus">+               showFavorites=&quot;true&quot;</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineplus">+               favoritesLabel=&quot;&amp;contextMoveCopyMsgFavoritesMenu.label;&quot;</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineplus">+               favoritesAccessKey=&quot;&amp;contextMoveCopyMsgFavoritesMenu.accesskey;&quot;/&gt;</span>
<a href="#l2.174"></a><span id="l2.174"> </span>
<a href="#l2.175"></a><span id="l2.175">     &lt;!-- Tools --&gt;</span>
<a href="#l2.176"></a><span id="l2.176">     &lt;panelview id=&quot;appMenu-toolsView&quot;</span>
<a href="#l2.177"></a><span id="l2.177">                title=&quot;&amp;tasksMenu.label;&quot;</span>
<a href="#l2.178"></a><span id="l2.178">                class=&quot;PanelUI-subView&quot;&gt;</span>
<a href="#l2.179"></a><span id="l2.179">       &lt;vbox class=&quot;panel-subview-body&quot;&gt;</span>
<a href="#l2.180"></a><span id="l2.180">         &lt;toolbarbutton hidden=&quot;true&quot;</span>
<a href="#l2.181"></a><span id="l2.181">                        id=&quot;appmenu_tasksMenuMail&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/test/mozmill/folder-widget/test-message-filters.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/test/mozmill/folder-widget/test-message-filters.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -93,18 +93,18 @@ function test_customize_toolbar_doesnt_d</span>
<a href="#l3.4"></a><span id="l3.4">     wait_for_window_focused(mc.window);</span>
<a href="#l3.5"></a><span id="l3.5"> </span>
<a href="#l3.6"></a><span id="l3.6">     const subview = mc.click_through_appmenu(</span>
<a href="#l3.7"></a><span id="l3.7">       [{id: &quot;appmenu_File&quot;}, {id: &quot;appmenu_getNewMsgFor&quot;}]);</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9">     assert_equals(subview.children.length, 5,</span>
<a href="#l3.10"></a><span id="l3.10">                   &quot;Incorrect number of items for GetNewMessages before customization&quot;);</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-    // TODO appmenu - Now click somewhere that causes the appmenu to close.</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-    // (Once this test is no longer skipped, see below.)</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+    // Close the appmenu.</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+    mc.click(mc.eid(&quot;button-appmenu&quot;));</span>
<a href="#l3.16"></a><span id="l3.16">   }</span>
<a href="#l3.17"></a><span id="l3.17"> </span>
<a href="#l3.18"></a><span id="l3.18">   check_getAllNewMsgMenu();</span>
<a href="#l3.19"></a><span id="l3.19"> </span>
<a href="#l3.20"></a><span id="l3.20">   plan_for_new_window(&quot;mailnews:customizeToolbar&quot;);</span>
<a href="#l3.21"></a><span id="l3.21">   // Open the customization dialog.</span>
<a href="#l3.22"></a><span id="l3.22">   mc.rightClick(mc.eid(&quot;mail-bar3&quot;));</span>
<a href="#l3.23"></a><span id="l3.23">   mc.click(mc.eid(&quot;CustomizeMailToolbar&quot;));</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineat">@@ -114,20 +114,16 @@ function test_customize_toolbar_doesnt_d</span>
<a href="#l3.25"></a><span id="l3.25">   wait_for_window_focused(customc.window);</span>
<a href="#l3.26"></a><span id="l3.26">   plan_for_window_close(customc);</span>
<a href="#l3.27"></a><span id="l3.27">   customc.click(customc.eid(&quot;donebutton&quot;));</span>
<a href="#l3.28"></a><span id="l3.28">   wait_for_window_close();</span>
<a href="#l3.29"></a><span id="l3.29"> </span>
<a href="#l3.30"></a><span id="l3.30">   check_getAllNewMsgMenu();</span>
<a href="#l3.31"></a><span id="l3.31"> }</span>
<a href="#l3.32"></a><span id="l3.32"> test_customize_toolbar_doesnt_double_get_mail_menu.EXCLUDED_PLATFORMS = [&quot;darwin&quot;];</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-// TODO appmenu - Skipped because it depends on the folder-menupopup code being</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-// adapted for use in the appmenu.  Namely the call to click_through_appmenu</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-// won't work because the UI it expects will not be there yet.</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">-test_customize_toolbar_doesnt_double_get_mail_menu.__force_skip__ = true;</span>
<a href="#l3.37"></a><span id="l3.37"> </span>
<a href="#l3.38"></a><span id="l3.38"> /* A helper function that opens up the new filter dialog (assuming that the</span>
<a href="#l3.39"></a><span id="l3.39">  * main filters dialog is already open), creates a simple filter, and then</span>
<a href="#l3.40"></a><span id="l3.40">  * closes the dialog.</span>
<a href="#l3.41"></a><span id="l3.41">  */</span>
<a href="#l3.42"></a><span id="l3.42"> function create_simple_filter() {</span>
<a href="#l3.43"></a><span id="l3.43">   // Open the &quot;Tools » Message Filters…&quot; window,</span>
<a href="#l3.44"></a><span id="l3.44">   // a.k.a. &quot;tasksMenu » filtersCmd&quot;.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/content/folder-menupopup.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/content/folder-menupopup.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1,48 +1,101 @@</span>
<a href="#l4.4"></a><span id="l4.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.5"></a><span id="l4.5">   * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.6"></a><span id="l4.6">   * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8"> &quot;use strict&quot;;</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10" class="difflineminus">-/* globals MozElements */</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+/* globals MozElements MozXULElement PanelUI */</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+// This file implements both `folder-menupopup` custom elements used in</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+// traditional menus and `folder-panelview` custom elements used in the appmenu.</span>
<a href="#l4.15"></a><span id="l4.15"> </span>
<a href="#l4.16"></a><span id="l4.16"> // Wrap in a block to prevent leaking to window scope.</span>
<a href="#l4.17"></a><span id="l4.17"> {</span>
<a href="#l4.18"></a><span id="l4.18">   const { FeedUtils } = ChromeUtils.import(&quot;resource:///modules/FeedUtils.jsm&quot;);</span>
<a href="#l4.19"></a><span id="l4.19">   const { allAccountsSorted, folderNameCompare, getSpecialFolderString, getMostRecentFolders } =</span>
<a href="#l4.20"></a><span id="l4.20">     ChromeUtils.import(&quot;resource:///modules/folderUtils.jsm&quot;);</span>
<a href="#l4.21"></a><span id="l4.21">   const { fixIterator, toArray } = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l4.22"></a><span id="l4.22">   const { MailServices } = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l4.23"></a><span id="l4.23">   const { MailUtils } = ChromeUtils.import(&quot;resource:///modules/MailUtils.jsm&quot;);</span>
<a href="#l4.24"></a><span id="l4.24">   const { StringBundle } = ChromeUtils.import(&quot;resource:///modules/StringBundle.js&quot;);</span>
<a href="#l4.25"></a><span id="l4.25"> </span>
<a href="#l4.26"></a><span id="l4.26">   /**</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineminus">-   * The MozFolderMenupopup widget is used as a menupopup for selecting</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineminus">-   * a folder from the list of all the folders from every account. It is also</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineminus">-   * used for selecting the account from the list of all the accounts. The each</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-   * menuitem gets displayed with the folder or account name and icon.</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+   * Creates an element, sets attributes on it, including always setting the</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+   * &quot;generated&quot; attribute to &quot;true&quot;, and returns the element. The &quot;generated&quot;</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+   * attribute is used to determine which elements to remove when clearing</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+   * the menu.</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+   *</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+   * @param {string} tagName    The tag name of the element to generate.</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+   * @param {Object} [attributes]  Optional attributes to set on the element.</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+   * @param {Object} [isObject]  The optional &quot;is&quot; object to use when creating</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+   *                             the element, typically `{is: &quot;folder-menupopup&quot;}`</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+   *                             or `{is: &quot;folder-panelview&quot;}`.</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+   */</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+  function generateElement(tagName, attributes, isObject) {</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+    const element = document.createXULElement(tagName, isObject);</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+    element.setAttribute(&quot;generated&quot;, &quot;true&quot;);</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+    if (attributes) {</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+      Object.entries(attributes).forEach(([key, value]) =&gt; {</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+        element.setAttribute(key, value);</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+      });</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+    }</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+    return element;</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+  }</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+  /**</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+   * Each time this function is called it generates a unique ID attribute,</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+   * e.g. for a `panelview` element. It keeps track of a counter (via a</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+   * closure) that increments each time it is called, guaranteeing the IDs it</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+   * returns are unique.</span>
<a href="#l4.59"></a><span id="l4.59">    *</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineminus">-   * @extends {MozElements.MozMenuPopup}</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+   * @param {string} prefix  Prefix that is combined with a number to make the ID.</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+   * @return {string}        The unique ID.</span>
<a href="#l4.63"></a><span id="l4.63">    */</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineminus">-  class MozFolderMenupopup extends MozElements.MozMenuPopup {</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+  const getUniquePanelViewId = (() =&gt; {</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+    let counter = 0;</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+    return (prefix) =&gt; {</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+      counter += 1;</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+      return prefix + counter;</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+    };</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+  })();</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+  /**</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+   * A &quot;mixin&quot; function to add shared code to the classes for the</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+   * `folder-menupopup` and `folder-panelview` custom elements. Takes a &quot;Base&quot;</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+   * class, and returns a class that extends the &quot;Base&quot; class.</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+   *</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+   * We use this mixin approach because the `folder-menupopup` class needs to</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+   * extend `MozMenuPopup` while the `folder-panelview` class should just extend</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+   * `MozXULElement`.</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+   *</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+   * The shared code in this mixin class works with both `menupopup` and</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+   * `panelview` custom elements by using functions and properties from the</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+   * &quot;Base&quot; `folder-menupopup` or `folder-panelview` class. Generally the</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+   * mixin class determines *what* needs to be built and then defers to the</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+   * &quot;Base&quot; custom element class to handle *how* to build it for that menu type.</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+   *</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+   * Note how this double duty raises some naming challenges. For example,</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+   * variables that could be bound to either a `menupopup` or a `panelview`</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+   * might be named &quot;submenu&quot;. See also `menu`/`menuitem` vs `toolbarbutton`.</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+   * (`panelview` and `toolbarbutton` are used in the appmenu.)</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+   *</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+   * @param {Class} Base  A class to be extended with shared functionality.</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineplus">+   * @return {Class}      A class that extends the first class.</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+   */</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+  let FolderMenuMixin = (Base) =&gt; class extends Base {</span>
<a href="#l4.97"></a><span id="l4.97">     constructor() {</span>
<a href="#l4.98"></a><span id="l4.98">       super();</span>
<a href="#l4.99"></a><span id="l4.99"> </span>
<a href="#l4.100"></a><span id="l4.100" class="difflineminus">-      // In order to improve performance, we're not going to build any of the</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineminus">-      // menu until we're shown.</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineminus">-      // note: _ensureInitialized can be called repeatedly without issue, so</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineminus">-      //       don't worry about it here.</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineminus">-      this.addEventListener(&quot;popupshowing&quot;, (event) =&gt; {</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineminus">-        this._ensureInitialized();</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineminus">-      }, true);</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineminus">-</span>
<a href="#l4.108"></a><span id="l4.108">       window.addEventListener(&quot;unload&quot;, () =&gt; {</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+        // Clean up when being destroyed.</span>
<a href="#l4.110"></a><span id="l4.110">         this._removeListener();</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineplus">+        this._teardown();</span>
<a href="#l4.112"></a><span id="l4.112">       }, { once: true });</span>
<a href="#l4.113"></a><span id="l4.113"> </span>
<a href="#l4.114"></a><span id="l4.114">       // If non-null, the subFolders of this nsIMsgFolder will be used to</span>
<a href="#l4.115"></a><span id="l4.115">       // populate this menu.  If this is null, the menu will be populated</span>
<a href="#l4.116"></a><span id="l4.116">       // using the root-folders for all accounts.</span>
<a href="#l4.117"></a><span id="l4.117">       this._parentFolder = null;</span>
<a href="#l4.118"></a><span id="l4.118"> </span>
<a href="#l4.119"></a><span id="l4.119">       this._stringBundle = null;</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineat">@@ -204,26 +257,30 @@</span>
<a href="#l4.121"></a><span id="l4.121">         },</span>
<a href="#l4.122"></a><span id="l4.122">         OnItemBoolPropertyChanged(item, property, old, newItem) {</span>
<a href="#l4.123"></a><span id="l4.123">           this._setCssSelectorsForItem(item);</span>
<a href="#l4.124"></a><span id="l4.124">         },</span>
<a href="#l4.125"></a><span id="l4.125">         OnItemUnicharPropertyChanged(item, property, old, newItem) {</span>
<a href="#l4.126"></a><span id="l4.126">           this._setCssSelectorsForItem(item);</span>
<a href="#l4.127"></a><span id="l4.127">         },</span>
<a href="#l4.128"></a><span id="l4.128">         OnItemPropertyFlagChanged(item, property, old, newItem) { },</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineplus">+</span>
<a href="#l4.130"></a><span id="l4.130">         OnItemEvent(folder, eventName) {</span>
<a href="#l4.131"></a><span id="l4.131">           if (eventName == &quot;MRMTimeChanged&quot;) {</span>
<a href="#l4.132"></a><span id="l4.132">             if (this._menu.getAttribute(&quot;showRecent&quot;) != &quot;true&quot; ||</span>
<a href="#l4.133"></a><span id="l4.133">                 !this._menu._initializedSpecials.has(&quot;recent&quot;) ||</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineminus">-                !this._menu.firstChild || !this._menu.firstChild.firstChild) {</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineplus">+                !this._menu.childWrapper.firstChild) {</span>
<a href="#l4.136"></a><span id="l4.136">               return;</span>
<a href="#l4.137"></a><span id="l4.137">             }</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineplus">+</span>
<a href="#l4.139"></a><span id="l4.139" class="difflineplus">+            const recentMenuItem = this._menu.childWrapper.firstChild;</span>
<a href="#l4.140"></a><span id="l4.140" class="difflineplus">+            const recentSubMenu = this._menu._getSubMenuForMenuItem(recentMenuItem);</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineplus">+</span>
<a href="#l4.142"></a><span id="l4.142">             // If this folder is already in the recent menu, return.</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineminus">-            if (this._getChildForItem(folder,</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineminus">-                  this._menu.firstChild.firstChild)) {</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineplus">+            if (!recentSubMenu || this._getChildForItem(folder, recentSubMenu)) {</span>
<a href="#l4.146"></a><span id="l4.146">               return;</span>
<a href="#l4.147"></a><span id="l4.147">             }</span>
<a href="#l4.148"></a><span id="l4.148">           } else if (eventName == &quot;RenameCompleted&quot;) {</span>
<a href="#l4.149"></a><span id="l4.149">             // Special casing folder renames here, since they require more work</span>
<a href="#l4.150"></a><span id="l4.150">             // since sort-order may have changed.</span>
<a href="#l4.151"></a><span id="l4.151">             if (!this._getChildForItem(folder)) {</span>
<a href="#l4.152"></a><span id="l4.152">               return;</span>
<a href="#l4.153"></a><span id="l4.153">             }</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineat">@@ -238,28 +295,25 @@</span>
<a href="#l4.155"></a><span id="l4.155">          * Helper function to check and see whether we have a menuitem for this</span>
<a href="#l4.156"></a><span id="l4.156">          * particular nsIMsgFolder.</span>
<a href="#l4.157"></a><span id="l4.157">          *</span>
<a href="#l4.158"></a><span id="l4.158">          * @param {nsIMsgFolder} item  The folder to check.</span>
<a href="#l4.159"></a><span id="l4.159">          * @param {Element} [menu]     Optional menu to look in, defaults to this._menu.</span>
<a href="#l4.160"></a><span id="l4.160">          * @returns {Element|null}     The menuitem for that folder, or null if no</span>
<a href="#l4.161"></a><span id="l4.161">          *                             child for that folder exists.</span>
<a href="#l4.162"></a><span id="l4.162">          */</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineminus">-        _getChildForItem(item, menu) {</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineminus">-          let _menu = menu || this._menu;</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineminus">-          if (!_menu || !_menu.hasChildNodes()) {</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineplus">+        _getChildForItem(item, menu = this._menu) {</span>
<a href="#l4.167"></a><span id="l4.167" class="difflineplus">+          if (!menu ||</span>
<a href="#l4.168"></a><span id="l4.168" class="difflineplus">+              !menu.childWrapper.hasChildNodes() ||</span>
<a href="#l4.169"></a><span id="l4.169" class="difflineplus">+              !(item instanceof Ci.nsIMsgFolder)) {</span>
<a href="#l4.170"></a><span id="l4.170">             return null;</span>
<a href="#l4.171"></a><span id="l4.171">           }</span>
<a href="#l4.172"></a><span id="l4.172" class="difflineminus">-          if (!(item instanceof Ci.nsIMsgFolder)) {</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineminus">-            return null;</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineminus">-          }</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineminus">-          for (let i = 0; i &lt; _menu.childNodes.length; i++) {</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineminus">-            let folder = _menu.childNodes[i]._folder;</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineminus">-            if (folder &amp;&amp; folder.URI == item.URI) {</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineminus">-              return _menu.childNodes[i];</span>
<a href="#l4.179"></a><span id="l4.179" class="difflineplus">+          for (let child of menu.childWrapper.childNodes) {</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineplus">+            if (child._folder &amp;&amp; child._folder.URI == item.URI) {</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineplus">+              return child;</span>
<a href="#l4.182"></a><span id="l4.182">             }</span>
<a href="#l4.183"></a><span id="l4.183">           }</span>
<a href="#l4.184"></a><span id="l4.184">           return null;</span>
<a href="#l4.185"></a><span id="l4.185">         },</span>
<a href="#l4.186"></a><span id="l4.186">       };</span>
<a href="#l4.187"></a><span id="l4.187"> </span>
<a href="#l4.188"></a><span id="l4.188">       // True if we have already built our menu items and are now just</span>
<a href="#l4.189"></a><span id="l4.189">       // listening for changes.</span>
<a href="#l4.190"></a><span id="l4.190" class="difflineat">@@ -272,68 +326,25 @@</span>
<a href="#l4.191"></a><span id="l4.191">       // The format for displaying names of folders.</span>
<a href="#l4.192"></a><span id="l4.192">       this._displayformat = null;</span>
<a href="#l4.193"></a><span id="l4.193">     }</span>
<a href="#l4.194"></a><span id="l4.194"> </span>
<a href="#l4.195"></a><span id="l4.195">     connectedCallback() {</span>
<a href="#l4.196"></a><span id="l4.196">       if (this.delayConnectedCallback()) {</span>
<a href="#l4.197"></a><span id="l4.197">         return;</span>
<a href="#l4.198"></a><span id="l4.198">       }</span>
<a href="#l4.199"></a><span id="l4.199" class="difflineminus">-</span>
<a href="#l4.200"></a><span id="l4.200" class="difflineminus">-      this.setAttribute(&quot;is&quot;, &quot;folder-menupopup&quot;);</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineplus">+      // Call the connectedCallback of the &quot;base&quot; class this mixin class is extending.</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineplus">+      super.connectedCallback();</span>
<a href="#l4.203"></a><span id="l4.203"> </span>
<a href="#l4.204"></a><span id="l4.204">       this._stringBundle = new StringBundle(&quot;chrome://messenger/locale/folderWidgets.properties&quot;);</span>
<a href="#l4.205"></a><span id="l4.205"> </span>
<a href="#l4.206"></a><span id="l4.206">       // Get the displayformat if set.</span>
<a href="#l4.207"></a><span id="l4.207">       if (this.parentNode &amp;&amp; this.parentNode.localName == &quot;menulist&quot;) {</span>
<a href="#l4.208"></a><span id="l4.208">         this._displayformat = this.parentNode.getAttribute(&quot;displayformat&quot;);</span>
<a href="#l4.209"></a><span id="l4.209">       }</span>
<a href="#l4.210"></a><span id="l4.210" class="difflineminus">-</span>
<a href="#l4.211"></a><span id="l4.211" class="difflineminus">-      // Find out if we are in a wrapper (customize toolbars mode is active).</span>
<a href="#l4.212"></a><span id="l4.212" class="difflineminus">-      let inWrapper = false;</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineminus">-      let node = this;</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineminus">-      while (node instanceof XULElement) {</span>
<a href="#l4.215"></a><span id="l4.215" class="difflineminus">-        if (node.id.startsWith(&quot;wrapper-&quot;)) {</span>
<a href="#l4.216"></a><span id="l4.216" class="difflineminus">-          inWrapper = true;</span>
<a href="#l4.217"></a><span id="l4.217" class="difflineminus">-          break;</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineminus">-        }</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineminus">-        node = node.parentNode;</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineminus">-      }</span>
<a href="#l4.221"></a><span id="l4.221" class="difflineminus">-</span>
<a href="#l4.222"></a><span id="l4.222" class="difflineminus">-      if (!inWrapper) {</span>
<a href="#l4.223"></a><span id="l4.223" class="difflineminus">-        if (this.hasAttribute(&quot;original-width&quot;)) {</span>
<a href="#l4.224"></a><span id="l4.224" class="difflineminus">-           // If we were in a wrapper before and have a width stored, restore it now.</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineminus">-          if (this.getAttribute(&quot;original-width&quot;) == &quot;none&quot;) {</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineminus">-            this.removeAttribute(&quot;width&quot;);</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineminus">-          } else {</span>
<a href="#l4.228"></a><span id="l4.228" class="difflineminus">-            this.setAttribute(&quot;width&quot;, this.getAttribute(&quot;original-width&quot;));</span>
<a href="#l4.229"></a><span id="l4.229" class="difflineminus">-          }</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineminus">-</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineminus">-          this.removeAttribute(&quot;original-width&quot;);</span>
<a href="#l4.232"></a><span id="l4.232" class="difflineminus">-        }</span>
<a href="#l4.233"></a><span id="l4.233" class="difflineminus">-</span>
<a href="#l4.234"></a><span id="l4.234" class="difflineminus">-        // If we are a child of a menulist, and we aren't in a wrapper, we</span>
<a href="#l4.235"></a><span id="l4.235" class="difflineminus">-        // need to build our content right away, otherwise the menulist</span>
<a href="#l4.236"></a><span id="l4.236" class="difflineminus">-        // won't have proper sizing.</span>
<a href="#l4.237"></a><span id="l4.237" class="difflineminus">-        if (this.parentNode &amp;&amp; this.parentNode.localName == &quot;menulist&quot;) {</span>
<a href="#l4.238"></a><span id="l4.238" class="difflineminus">-          this._ensureInitialized();</span>
<a href="#l4.239"></a><span id="l4.239" class="difflineminus">-        }</span>
<a href="#l4.240"></a><span id="l4.240" class="difflineminus">-      } else {</span>
<a href="#l4.241"></a><span id="l4.241" class="difflineminus">-        // But if we're in a wrapper, remove our children, because we're</span>
<a href="#l4.242"></a><span id="l4.242" class="difflineminus">-        // getting re-created when the toolbar customization closes.</span>
<a href="#l4.243"></a><span id="l4.243" class="difflineminus">-        this._teardown();</span>
<a href="#l4.244"></a><span id="l4.244" class="difflineminus">-</span>
<a href="#l4.245"></a><span id="l4.245" class="difflineminus">-        // Store our current width and set a safe small width when we show</span>
<a href="#l4.246"></a><span id="l4.246" class="difflineminus">-        // in a wrapper.</span>
<a href="#l4.247"></a><span id="l4.247" class="difflineminus">-        if (!this.hasAttribute(&quot;original-width&quot;)) {</span>
<a href="#l4.248"></a><span id="l4.248" class="difflineminus">-          this.setAttribute(&quot;original-width&quot;, this.hasAttribute(&quot;width&quot;) ?</span>
<a href="#l4.249"></a><span id="l4.249" class="difflineminus">-            this.getAttribute(&quot;width&quot;) : &quot;none&quot;);</span>
<a href="#l4.250"></a><span id="l4.250" class="difflineminus">-          this.setAttribute(&quot;width&quot;, &quot;100&quot;);</span>
<a href="#l4.251"></a><span id="l4.251" class="difflineminus">-        }</span>
<a href="#l4.252"></a><span id="l4.252" class="difflineminus">-      }</span>
<a href="#l4.253"></a><span id="l4.253">     }</span>
<a href="#l4.254"></a><span id="l4.254"> </span>
<a href="#l4.255"></a><span id="l4.255">     set parentFolder(val) {</span>
<a href="#l4.256"></a><span id="l4.256">       return this._parentFolder = val;</span>
<a href="#l4.257"></a><span id="l4.257">     }</span>
<a href="#l4.258"></a><span id="l4.258"> </span>
<a href="#l4.259"></a><span id="l4.259">     get parentFolder() {</span>
<a href="#l4.260"></a><span id="l4.260">       return this._parentFolder;</span>
<a href="#l4.261"></a><span id="l4.261" class="difflineat">@@ -462,67 +473,43 @@</span>
<a href="#l4.262"></a><span id="l4.262">     /**</span>
<a href="#l4.263"></a><span id="l4.263">      * Add menu items that only appear at top level, like &quot;Recent&quot;.</span>
<a href="#l4.264"></a><span id="l4.264">      */</span>
<a href="#l4.265"></a><span id="l4.265">     _addTopLevelMenuItems() {</span>
<a href="#l4.266"></a><span id="l4.266">       const showRecent = this.getAttribute(&quot;showRecent&quot;) == &quot;true&quot;;</span>
<a href="#l4.267"></a><span id="l4.267">       const showFavorites = this.getAttribute(&quot;showFavorites&quot;) == &quot;true&quot;;</span>
<a href="#l4.268"></a><span id="l4.268"> </span>
<a href="#l4.269"></a><span id="l4.269">       if (showRecent) {</span>
<a href="#l4.270"></a><span id="l4.270" class="difflineminus">-        this.appendChild(this._buildSpecialMenu(&quot;recent&quot;));</span>
<a href="#l4.271"></a><span id="l4.271" class="difflineplus">+        this.childWrapper.appendChild(this._buildSpecialMenu({</span>
<a href="#l4.272"></a><span id="l4.272" class="difflineplus">+          &quot;special&quot;: &quot;recent&quot;,</span>
<a href="#l4.273"></a><span id="l4.273" class="difflineplus">+          &quot;label&quot;: this.getAttribute(&quot;recentLabel&quot;),</span>
<a href="#l4.274"></a><span id="l4.274" class="difflineplus">+          &quot;accessKey&quot;: this.getAttribute(&quot;recentAccessKey&quot;),</span>
<a href="#l4.275"></a><span id="l4.275" class="difflineplus">+        }));</span>
<a href="#l4.276"></a><span id="l4.276">       }</span>
<a href="#l4.277"></a><span id="l4.277">       if (showFavorites) {</span>
<a href="#l4.278"></a><span id="l4.278" class="difflineminus">-        this.appendChild(this._buildSpecialMenu(&quot;favorites&quot;));</span>
<a href="#l4.279"></a><span id="l4.279" class="difflineplus">+        this.childWrapper.appendChild(this._buildSpecialMenu({</span>
<a href="#l4.280"></a><span id="l4.280" class="difflineplus">+          &quot;special&quot;: &quot;favorites&quot;,</span>
<a href="#l4.281"></a><span id="l4.281" class="difflineplus">+          &quot;label&quot;: this.getAttribute(&quot;favoritesLabel&quot;),</span>
<a href="#l4.282"></a><span id="l4.282" class="difflineplus">+          &quot;accessKey&quot;: this.getAttribute(&quot;favoritesAccessKey&quot;),</span>
<a href="#l4.283"></a><span id="l4.283" class="difflineplus">+        }));</span>
<a href="#l4.284"></a><span id="l4.284">       }</span>
<a href="#l4.285"></a><span id="l4.285">       if (showRecent || showFavorites) {</span>
<a href="#l4.286"></a><span id="l4.286" class="difflineminus">-        // If we added Recent and/or Favorites, separate them from the rest of the items.</span>
<a href="#l4.287"></a><span id="l4.287" class="difflineminus">-        const sep = document.createXULElement(&quot;menuseparator&quot;);</span>
<a href="#l4.288"></a><span id="l4.288" class="difflineminus">-        sep.setAttribute(&quot;generated&quot;, &quot;true&quot;);</span>
<a href="#l4.289"></a><span id="l4.289" class="difflineminus">-        this.appendChild(sep);</span>
<a href="#l4.290"></a><span id="l4.290" class="difflineplus">+        this.childWrapper.appendChild(this._buildSeparator());</span>
<a href="#l4.291"></a><span id="l4.291">       }</span>
<a href="#l4.292"></a><span id="l4.292">     }</span>
<a href="#l4.293"></a><span id="l4.293"> </span>
<a href="#l4.294"></a><span id="l4.294">     /**</span>
<a href="#l4.295"></a><span id="l4.295" class="difflineminus">-     * This only creates the menu item (or toolbarbutton) in the top-level</span>
<a href="#l4.296"></a><span id="l4.296" class="difflineminus">-     * menulist. The submenu is created once the popup is really shown,</span>
<a href="#l4.297"></a><span id="l4.297" class="difflineminus">-     * via the _buildSpecialSubmenu method.</span>
<a href="#l4.298"></a><span id="l4.298" class="difflineplus">+     * Populate a &quot;recent&quot; or &quot;favorites&quot; special submenu with either the</span>
<a href="#l4.299"></a><span id="l4.299" class="difflineplus">+     * recently used or favorite folders, to allow for easy access.</span>
<a href="#l4.300"></a><span id="l4.300">      *</span>
<a href="#l4.301"></a><span id="l4.301" class="difflineminus">-     * @param {string} type  Type of special menu (e.g. &quot;recent&quot;, &quot;favorites&quot;).</span>
<a href="#l4.302"></a><span id="l4.302" class="difflineminus">-     * @return {Element}     The `menu` or `toolbarbutton` element.</span>
<a href="#l4.303"></a><span id="l4.303" class="difflineplus">+     * @param {Element} menu  The menu or toolbarbutton element for which one</span>
<a href="#l4.304"></a><span id="l4.304" class="difflineplus">+     *                        wants to populate the special sub menu.</span>
<a href="#l4.305"></a><span id="l4.305" class="difflineplus">+     * @param {Element} submenu  The submenu element, typically a menupopup or panelview.</span>
<a href="#l4.306"></a><span id="l4.306">      */</span>
<a href="#l4.307"></a><span id="l4.307" class="difflineminus">-    _buildSpecialMenu(type) {</span>
<a href="#l4.308"></a><span id="l4.308" class="difflineminus">-      // Now create the Recent folder menu and its children.</span>
<a href="#l4.309"></a><span id="l4.309" class="difflineminus">-      let menu = document.createXULElement(&quot;menu&quot;);</span>
<a href="#l4.310"></a><span id="l4.310" class="difflineminus">-      menu.setAttribute(&quot;special&quot;, type);</span>
<a href="#l4.311"></a><span id="l4.311" class="difflineminus">-</span>
<a href="#l4.312"></a><span id="l4.312" class="difflineminus">-      menu.setAttribute(&quot;label&quot;, this.getAttribute((type == &quot;recent&quot;) ?</span>
<a href="#l4.313"></a><span id="l4.313" class="difflineminus">-        &quot;recentLabel&quot; : &quot;favoritesLabel&quot;));</span>
<a href="#l4.314"></a><span id="l4.314" class="difflineminus">-</span>
<a href="#l4.315"></a><span id="l4.315" class="difflineminus">-      menu.setAttribute(&quot;accesskey&quot;, this.getAttribute((type == &quot;recent&quot;) ?</span>
<a href="#l4.316"></a><span id="l4.316" class="difflineminus">-        &quot;recentAccessKey&quot; : &quot;favoritesAccessKey&quot;));</span>
<a href="#l4.317"></a><span id="l4.317" class="difflineminus">-</span>
<a href="#l4.318"></a><span id="l4.318" class="difflineminus">-      menu.setAttribute(&quot;generated&quot;, &quot;true&quot;);</span>
<a href="#l4.319"></a><span id="l4.319" class="difflineminus">-</span>
<a href="#l4.320"></a><span id="l4.320" class="difflineminus">-      let popup = document.createXULElement(&quot;menupopup&quot;);</span>
<a href="#l4.321"></a><span id="l4.321" class="difflineminus">-      popup.setAttribute(&quot;class&quot;, this.getAttribute(&quot;class&quot;));</span>
<a href="#l4.322"></a><span id="l4.322" class="difflineminus">-      popup.addEventListener(&quot;popupshowing&quot;, (event) =&gt; {</span>
<a href="#l4.323"></a><span id="l4.323" class="difflineminus">-        this._buildSpecialSubmenu(menu);</span>
<a href="#l4.324"></a><span id="l4.324" class="difflineminus">-      }, { once: true });</span>
<a href="#l4.325"></a><span id="l4.325" class="difflineminus">-</span>
<a href="#l4.326"></a><span id="l4.326" class="difflineminus">-      menu.appendChild(popup);</span>
<a href="#l4.327"></a><span id="l4.327" class="difflineminus">-      return menu;</span>
<a href="#l4.328"></a><span id="l4.328" class="difflineminus">-    }</span>
<a href="#l4.329"></a><span id="l4.329" class="difflineminus">-</span>
<a href="#l4.330"></a><span id="l4.330" class="difflineminus">-    /**</span>
<a href="#l4.331"></a><span id="l4.331" class="difflineminus">-     * Builds a submenu with all of the recently used folders in it, to</span>
<a href="#l4.332"></a><span id="l4.332" class="difflineminus">-     * allow for easy access.</span>
<a href="#l4.333"></a><span id="l4.333" class="difflineminus">-     *</span>
<a href="#l4.334"></a><span id="l4.334" class="difflineminus">-     * @param {Element} menu  The menu element for which one wants to build the special sub menu.</span>
<a href="#l4.335"></a><span id="l4.335" class="difflineminus">-     */</span>
<a href="#l4.336"></a><span id="l4.336" class="difflineminus">-    _buildSpecialSubmenu(menu) {</span>
<a href="#l4.337"></a><span id="l4.337" class="difflineplus">+    _populateSpecialSubmenu(menu, submenu) {</span>
<a href="#l4.338"></a><span id="l4.338">       let specialType = menu.getAttribute(&quot;special&quot;);</span>
<a href="#l4.339"></a><span id="l4.339">       if (this._initializedSpecials.has(specialType)) {</span>
<a href="#l4.340"></a><span id="l4.340">         return;</span>
<a href="#l4.341"></a><span id="l4.341">       }</span>
<a href="#l4.342"></a><span id="l4.342"> </span>
<a href="#l4.343"></a><span id="l4.343">       // Iterate through all folders in all accounts matching the current filter.</span>
<a href="#l4.344"></a><span id="l4.344">       let specialFolders = toArray(</span>
<a href="#l4.345"></a><span id="l4.345">         fixIterator(MailServices.accounts.allFolders, Ci.nsIMsgFolder));</span>
<a href="#l4.346"></a><span id="l4.346" class="difflineat">@@ -578,25 +565,23 @@</span>
<a href="#l4.347"></a><span id="l4.347">         folderItem.label = label;</span>
<a href="#l4.348"></a><span id="l4.348">       }</span>
<a href="#l4.349"></a><span id="l4.349"> </span>
<a href="#l4.350"></a><span id="l4.350">       // Make sure the entries are sorted alphabetically.</span>
<a href="#l4.351"></a><span id="l4.351">       specialFoldersMap.sort((a, b) =&gt; folderNameCompare(a.label, b.label));</span>
<a href="#l4.352"></a><span id="l4.352"> </span>
<a href="#l4.353"></a><span id="l4.353">       // Create entries for each of the recent folders.</span>
<a href="#l4.354"></a><span id="l4.354">       for (let folderItem of specialFoldersMap) {</span>
<a href="#l4.355"></a><span id="l4.355" class="difflineminus">-        let node = document.createXULElement(&quot;menuitem&quot;);</span>
<a href="#l4.356"></a><span id="l4.356" class="difflineminus">-</span>
<a href="#l4.357"></a><span id="l4.357" class="difflineminus">-        node.setAttribute(&quot;label&quot;, folderItem.label);</span>
<a href="#l4.358"></a><span id="l4.358" class="difflineminus">-        node._folder = folderItem.folder;</span>
<a href="#l4.359"></a><span id="l4.359" class="difflineplus">+        let attributes = {</span>
<a href="#l4.360"></a><span id="l4.360" class="difflineplus">+          label: folderItem.label,</span>
<a href="#l4.361"></a><span id="l4.361" class="difflineplus">+          ...this._getCssSelectorAttributes(folderItem.folder),</span>
<a href="#l4.362"></a><span id="l4.362" class="difflineplus">+        };</span>
<a href="#l4.363"></a><span id="l4.363"> </span>
<a href="#l4.364"></a><span id="l4.364" class="difflineminus">-        node.setAttribute(&quot;class&quot;, &quot;folderMenuItem menuitem-iconic&quot;);</span>
<a href="#l4.365"></a><span id="l4.365" class="difflineminus">-        this._setCssSelectors(folderItem.folder, node);</span>
<a href="#l4.366"></a><span id="l4.366" class="difflineminus">-        node.setAttribute(&quot;generated&quot;, &quot;true&quot;);</span>
<a href="#l4.367"></a><span id="l4.367" class="difflineminus">-        menu.menupopup.appendChild(node);</span>
<a href="#l4.368"></a><span id="l4.368" class="difflineplus">+        submenu.childWrapper.appendChild(</span>
<a href="#l4.369"></a><span id="l4.369" class="difflineplus">+          this._buildMenuItem(attributes, folderItem.folder));</span>
<a href="#l4.370"></a><span id="l4.370">       }</span>
<a href="#l4.371"></a><span id="l4.371"> </span>
<a href="#l4.372"></a><span id="l4.372">       if (specialFoldersMap.length == 0) {</span>
<a href="#l4.373"></a><span id="l4.373">         menu.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l4.374"></a><span id="l4.374">       }</span>
<a href="#l4.375"></a><span id="l4.375"> </span>
<a href="#l4.376"></a><span id="l4.376">       this._initializedSpecials.add(specialType);</span>
<a href="#l4.377"></a><span id="l4.377">     }</span>
<a href="#l4.378"></a><span id="l4.378" class="difflineat">@@ -613,43 +598,39 @@</span>
<a href="#l4.379"></a><span id="l4.379">      *     mode is not equal to newFolder.</span>
<a href="#l4.380"></a><span id="l4.380">      *  The menu item will have the value of the fileHereLabel attribute as</span>
<a href="#l4.381"></a><span id="l4.381">      *  label or if the attribute does not exist the name of the parent</span>
<a href="#l4.382"></a><span id="l4.382">      *  folder instead.</span>
<a href="#l4.383"></a><span id="l4.383">      *</span>
<a href="#l4.384"></a><span id="l4.384">      * @param {string} mode  The mode attribute.</span>
<a href="#l4.385"></a><span id="l4.385">      */</span>
<a href="#l4.386"></a><span id="l4.386">     _maybeAddParentFolderMenuItem(mode) {</span>
<a href="#l4.387"></a><span id="l4.387" class="difflineminus">-      let parent = this._parentFolder;</span>
<a href="#l4.388"></a><span id="l4.388" class="difflineminus">-      if (parent &amp;&amp; (this.getAttribute(&quot;showFileHereLabel&quot;) == &quot;true&quot; || !mode)) {</span>
<a href="#l4.389"></a><span id="l4.389" class="difflineplus">+      let folder = this._parentFolder;</span>
<a href="#l4.390"></a><span id="l4.390" class="difflineplus">+      if (folder &amp;&amp; (this.getAttribute(&quot;showFileHereLabel&quot;) == &quot;true&quot; || !mode)) {</span>
<a href="#l4.391"></a><span id="l4.391">         let showAccountsFileHere = this.getAttribute(&quot;showAccountsFileHere&quot;);</span>
<a href="#l4.392"></a><span id="l4.392" class="difflineminus">-        if ((!parent.isServer || showAccountsFileHere != &quot;false&quot;) &amp;&amp;</span>
<a href="#l4.393"></a><span id="l4.393" class="difflineminus">-             (!mode || mode == &quot;newFolder&quot; || parent.noSelect ||</span>
<a href="#l4.394"></a><span id="l4.394" class="difflineminus">-               parent.canFileMessages || showAccountsFileHere == &quot;true&quot;)) {</span>
<a href="#l4.395"></a><span id="l4.395" class="difflineminus">-          let menuitem = document.createXULElement(&quot;menuitem&quot;);</span>
<a href="#l4.396"></a><span id="l4.396"> </span>
<a href="#l4.397"></a><span id="l4.397" class="difflineminus">-          menuitem._folder = parent;</span>
<a href="#l4.398"></a><span id="l4.398" class="difflineminus">-          menuitem.setAttribute(&quot;generated&quot;, &quot;true&quot;);</span>
<a href="#l4.399"></a><span id="l4.399" class="difflineplus">+        if ((!folder.isServer || showAccountsFileHere != &quot;false&quot;) &amp;&amp;</span>
<a href="#l4.400"></a><span id="l4.400" class="difflineplus">+             (!mode || mode == &quot;newFolder&quot; || folder.noSelect ||</span>
<a href="#l4.401"></a><span id="l4.401" class="difflineplus">+               folder.canFileMessages || showAccountsFileHere == &quot;true&quot;)) {</span>
<a href="#l4.402"></a><span id="l4.402" class="difflineplus">+          let attributes = {};</span>
<a href="#l4.403"></a><span id="l4.403" class="difflineplus">+</span>
<a href="#l4.404"></a><span id="l4.404">           if (this.hasAttribute(&quot;fileHereLabel&quot;)) {</span>
<a href="#l4.405"></a><span id="l4.405" class="difflineminus">-            menuitem.setAttribute(&quot;label&quot;, this.getAttribute(&quot;fileHereLabel&quot;));</span>
<a href="#l4.406"></a><span id="l4.406" class="difflineminus">-            menuitem.setAttribute(&quot;accesskey&quot;, this.getAttribute(&quot;fileHereAccessKey&quot;));</span>
<a href="#l4.407"></a><span id="l4.407" class="difflineplus">+            attributes.label = this.getAttribute(&quot;fileHereLabel&quot;);</span>
<a href="#l4.408"></a><span id="l4.408" class="difflineplus">+            attributes.accesskey = this.getAttribute(&quot;fileHereAccessKey&quot;);</span>
<a href="#l4.409"></a><span id="l4.409">           } else {</span>
<a href="#l4.410"></a><span id="l4.410" class="difflineminus">-            menuitem.setAttribute(&quot;label&quot;, parent.prettyName);</span>
<a href="#l4.411"></a><span id="l4.411" class="difflineminus">-            menuitem.setAttribute(&quot;class&quot;, &quot;folderMenuItem menuitem-iconic&quot;);</span>
<a href="#l4.412"></a><span id="l4.412" class="difflineminus">-            this._setCssSelectors(parent, menuitem);</span>
<a href="#l4.413"></a><span id="l4.413" class="difflineminus">-          }</span>
<a href="#l4.414"></a><span id="l4.414" class="difflineminus">-          this.appendChild(menuitem);</span>
<a href="#l4.415"></a><span id="l4.415" class="difflineminus">-</span>
<a href="#l4.416"></a><span id="l4.416" class="difflineminus">-          if (parent.noSelect) {</span>
<a href="#l4.417"></a><span id="l4.417" class="difflineminus">-            menuitem.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l4.418"></a><span id="l4.418" class="difflineplus">+            attributes.label = folder.prettyName;</span>
<a href="#l4.419"></a><span id="l4.419" class="difflineplus">+            Object.assign(attributes, this._getCssSelectorAttributes(folder));</span>
<a href="#l4.420"></a><span id="l4.420">           }</span>
<a href="#l4.421"></a><span id="l4.421"> </span>
<a href="#l4.422"></a><span id="l4.422" class="difflineminus">-          let sep = document.createXULElement(&quot;menuseparator&quot;);</span>
<a href="#l4.423"></a><span id="l4.423" class="difflineminus">-          sep.setAttribute(&quot;generated&quot;, &quot;true&quot;);</span>
<a href="#l4.424"></a><span id="l4.424" class="difflineminus">-          this.appendChild(sep);</span>
<a href="#l4.425"></a><span id="l4.425" class="difflineplus">+          if (folder.noSelect) {</span>
<a href="#l4.426"></a><span id="l4.426" class="difflineplus">+            attributes.disabled = &quot;true&quot;;</span>
<a href="#l4.427"></a><span id="l4.427" class="difflineplus">+          }</span>
<a href="#l4.428"></a><span id="l4.428" class="difflineplus">+</span>
<a href="#l4.429"></a><span id="l4.429" class="difflineplus">+          this.childWrapper.appendChild(this._buildMenuItem(attributes, folder));</span>
<a href="#l4.430"></a><span id="l4.430" class="difflineplus">+          this.childWrapper.appendChild(this._buildSeparator());</span>
<a href="#l4.431"></a><span id="l4.431">         }</span>
<a href="#l4.432"></a><span id="l4.432">       }</span>
<a href="#l4.433"></a><span id="l4.433">     }</span>
<a href="#l4.434"></a><span id="l4.434"> </span>
<a href="#l4.435"></a><span id="l4.435">     /**</span>
<a href="#l4.436"></a><span id="l4.436">      * Add menu items, one for each folder.</span>
<a href="#l4.437"></a><span id="l4.437">      *</span>
<a href="#l4.438"></a><span id="l4.438">      * @param {nsIMsgFolder[]} folders          Array of folder objects.</span>
<a href="#l4.439"></a><span id="l4.439" class="difflineat">@@ -664,78 +645,80 @@</span>
<a href="#l4.440"></a><span id="l4.440">       // We need to call this, or hasSubFolders will always return false.</span>
<a href="#l4.441"></a><span id="l4.441">       // Remove this workaround when Bug 502900 is fixed.</span>
<a href="#l4.442"></a><span id="l4.442">       MailUtils.discoverFolders();</span>
<a href="#l4.443"></a><span id="l4.443">       this._serversOnly = true;</span>
<a href="#l4.444"></a><span id="l4.444"> </span>
<a href="#l4.445"></a><span id="l4.445">       let [shouldExpand, labels] = this._getShouldExpandAndLabels();</span>
<a href="#l4.446"></a><span id="l4.446"> </span>
<a href="#l4.447"></a><span id="l4.447">       for (let folder of folders) {</span>
<a href="#l4.448"></a><span id="l4.448" class="difflineminus">-        let node;</span>
<a href="#l4.449"></a><span id="l4.449">         if (!folder.isServer) {</span>
<a href="#l4.450"></a><span id="l4.450">           this._serversOnly = false;</span>
<a href="#l4.451"></a><span id="l4.451">         }</span>
<a href="#l4.452"></a><span id="l4.452"> </span>
<a href="#l4.453"></a><span id="l4.453" class="difflineminus">-        // If we're going to add subFolders, we need to make menus, not</span>
<a href="#l4.454"></a><span id="l4.454" class="difflineminus">-        // menuitems.</span>
<a href="#l4.455"></a><span id="l4.455" class="difflineplus">+        let attributes = {</span>
<a href="#l4.456"></a><span id="l4.456" class="difflineplus">+          label: this._getFolderLabel(mode, globalInboxFolder, folder),</span>
<a href="#l4.457"></a><span id="l4.457" class="difflineplus">+          ...this._getCssSelectorAttributes(folder),</span>
<a href="#l4.458"></a><span id="l4.458" class="difflineplus">+        };</span>
<a href="#l4.459"></a><span id="l4.459" class="difflineplus">+</span>
<a href="#l4.460"></a><span id="l4.460" class="difflineplus">+        if (disableServers.includes(folder.server.key)) {</span>
<a href="#l4.461"></a><span id="l4.461" class="difflineplus">+          attributes.disabled = &quot;true&quot;;</span>
<a href="#l4.462"></a><span id="l4.462" class="difflineplus">+        }</span>
<a href="#l4.463"></a><span id="l4.463" class="difflineplus">+</span>
<a href="#l4.464"></a><span id="l4.464">         if (!folder.hasSubFolders || !shouldExpand(folder.server.type)) {</span>
<a href="#l4.465"></a><span id="l4.465" class="difflineminus">-          node = document.createXULElement(&quot;menuitem&quot;);</span>
<a href="#l4.466"></a><span id="l4.466" class="difflineminus">-          node.setAttribute(&quot;class&quot;, &quot;folderMenuItem menuitem-iconic&quot;);</span>
<a href="#l4.467"></a><span id="l4.467" class="difflineminus">-          node.setAttribute(&quot;generated&quot;, &quot;true&quot;);</span>
<a href="#l4.468"></a><span id="l4.468" class="difflineminus">-          this.appendChild(node);</span>
<a href="#l4.469"></a><span id="l4.469" class="difflineplus">+          // There are no subfolders, create a simple menu item.</span>
<a href="#l4.470"></a><span id="l4.470" class="difflineplus">+          this.childWrapper.appendChild(this._buildMenuItem(attributes, folder));</span>
<a href="#l4.471"></a><span id="l4.471">         } else {</span>
<a href="#l4.472"></a><span id="l4.472" class="difflineminus">-          this._serversOnly = false;</span>
<a href="#l4.473"></a><span id="l4.473" class="difflineplus">+          // There are subfolders, create a menu item with a submenu.</span>
<a href="#l4.474"></a><span id="l4.474">           // xxx this is slightly problematic in that we haven't confirmed</span>
<a href="#l4.475"></a><span id="l4.475">           //     whether any of the subfolders will pass the filter.</span>
<a href="#l4.476"></a><span id="l4.476" class="difflineminus">-          node = document.createXULElement(&quot;menu&quot;);</span>
<a href="#l4.477"></a><span id="l4.477" class="difflineminus">-          node.setAttribute(&quot;class&quot;, &quot;folderMenuItem menu-iconic&quot;);</span>
<a href="#l4.478"></a><span id="l4.478" class="difflineminus">-          node.setAttribute(&quot;generated&quot;, &quot;true&quot;);</span>
<a href="#l4.479"></a><span id="l4.479" class="difflineminus">-          this.appendChild(node);</span>
<a href="#l4.480"></a><span id="l4.480"> </span>
<a href="#l4.481"></a><span id="l4.481" class="difflineminus">-          // Create the submenu.</span>
<a href="#l4.482"></a><span id="l4.482" class="difflineminus">-          let popup = document.createXULElement(&quot;menupopup&quot;, { &quot;is&quot;: &quot;folder-menupopup&quot; });</span>
<a href="#l4.483"></a><span id="l4.483" class="difflineminus">-          popup._parentFolder = folder;</span>
<a href="#l4.484"></a><span id="l4.484" class="difflineplus">+          this._serversOnly = false;</span>
<a href="#l4.485"></a><span id="l4.485" class="difflineplus">+</span>
<a href="#l4.486"></a><span id="l4.486" class="difflineplus">+          let submenuAttributes = {};</span>
<a href="#l4.487"></a><span id="l4.487"> </span>
<a href="#l4.488"></a><span id="l4.488">           [&quot;class&quot;, &quot;type&quot;, &quot;fileHereLabel&quot;, &quot;showFileHereLabel&quot;, &quot;oncommand&quot;,</span>
<a href="#l4.489"></a><span id="l4.489">             &quot;mode&quot;, &quot;disableServers&quot;, &quot;position&quot;].forEach(attribute =&gt; {</span>
<a href="#l4.490"></a><span id="l4.490">             if (this.hasAttribute(attribute)) {</span>
<a href="#l4.491"></a><span id="l4.491" class="difflineminus">-              popup.setAttribute(attribute, this.getAttribute(attribute));</span>
<a href="#l4.492"></a><span id="l4.492" class="difflineplus">+              submenuAttributes[attribute] = this.getAttribute(attribute);</span>
<a href="#l4.493"></a><span id="l4.493">             }</span>
<a href="#l4.494"></a><span id="l4.494">           });</span>
<a href="#l4.495"></a><span id="l4.495"> </span>
<a href="#l4.496"></a><span id="l4.496" class="difflineminus">-          // If there are labels, add the labels now.</span>
<a href="#l4.497"></a><span id="l4.497" class="difflineplus">+          const [menuItem, submenu] = this._buildMenuItemWithSubmenu(attributes,</span>
<a href="#l4.498"></a><span id="l4.498" class="difflineplus">+            true, folder, submenuAttributes);</span>
<a href="#l4.499"></a><span id="l4.499" class="difflineplus">+</span>
<a href="#l4.500"></a><span id="l4.500" class="difflineplus">+          // If there are labels, we add an item and separator to the submenu.</span>
<a href="#l4.501"></a><span id="l4.501">           if (labels) {</span>
<a href="#l4.502"></a><span id="l4.502" class="difflineminus">-            let serverNode = document.createXULElement(&quot;menuitem&quot;);</span>
<a href="#l4.503"></a><span id="l4.503" class="difflineminus">-            serverNode.setAttribute(&quot;label&quot;, labels[folder.server.type]);</span>
<a href="#l4.504"></a><span id="l4.504" class="difflineminus">-            serverNode._folder = folder;</span>
<a href="#l4.505"></a><span id="l4.505" class="difflineminus">-            serverNode.setAttribute(&quot;generated&quot;, &quot;true&quot;);</span>
<a href="#l4.506"></a><span id="l4.506" class="difflineminus">-            popup.appendChild(serverNode);</span>
<a href="#l4.507"></a><span id="l4.507" class="difflineminus">-            let sep = document.createXULElement(&quot;menuseparator&quot;);</span>
<a href="#l4.508"></a><span id="l4.508" class="difflineminus">-            sep.setAttribute(&quot;generated&quot;, &quot;true&quot;);</span>
<a href="#l4.509"></a><span id="l4.509" class="difflineminus">-            popup.appendChild(sep);</span>
<a href="#l4.510"></a><span id="l4.510" class="difflineplus">+            const serverAttributes = { label: labels[folder.server.type] };</span>
<a href="#l4.511"></a><span id="l4.511" class="difflineplus">+</span>
<a href="#l4.512"></a><span id="l4.512" class="difflineplus">+            submenu.childWrapper.appendChild(</span>
<a href="#l4.513"></a><span id="l4.513" class="difflineplus">+              this._buildMenuItem(serverAttributes, folder, this));</span>
<a href="#l4.514"></a><span id="l4.514" class="difflineplus">+</span>
<a href="#l4.515"></a><span id="l4.515" class="difflineplus">+            submenu.childWrapper.appendChild(this._buildSeparator());</span>
<a href="#l4.516"></a><span id="l4.516">           }</span>
<a href="#l4.517"></a><span id="l4.517" class="difflineminus">-          popup.setAttribute(&quot;generated&quot;, &quot;true&quot;);</span>
<a href="#l4.518"></a><span id="l4.518" class="difflineminus">-          node.appendChild(popup);</span>
<a href="#l4.519"></a><span id="l4.519" class="difflineminus">-        }</span>
<a href="#l4.520"></a><span id="l4.520"> </span>
<a href="#l4.521"></a><span id="l4.521" class="difflineminus">-        if (disableServers.includes(folder.server.key)) {</span>
<a href="#l4.522"></a><span id="l4.522" class="difflineminus">-          node.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l4.523"></a><span id="l4.523" class="difflineplus">+          this.childWrapper.appendChild(menuItem);</span>
<a href="#l4.524"></a><span id="l4.524">         }</span>
<a href="#l4.525"></a><span id="l4.525" class="difflineplus">+      }</span>
<a href="#l4.526"></a><span id="l4.526" class="difflineplus">+    }</span>
<a href="#l4.527"></a><span id="l4.527"> </span>
<a href="#l4.528"></a><span id="l4.528" class="difflineminus">-        node._folder = folder;</span>
<a href="#l4.529"></a><span id="l4.529" class="difflineminus">-        let label = &quot;&quot;;</span>
<a href="#l4.530"></a><span id="l4.530" class="difflineminus">-        if (mode == &quot;deferred&quot; &amp;&amp; folder.isServer &amp;&amp;</span>
<a href="#l4.531"></a><span id="l4.531" class="difflineminus">-            folder.server.rootFolder == globalInboxFolder) {</span>
<a href="#l4.532"></a><span id="l4.532" class="difflineminus">-          label = this._stringBundle.get(&quot;globalInbox&quot;, [folder.prettyName]);</span>
<a href="#l4.533"></a><span id="l4.533" class="difflineminus">-        } else {</span>
<a href="#l4.534"></a><span id="l4.534" class="difflineminus">-          label = folder.prettyName;</span>
<a href="#l4.535"></a><span id="l4.535" class="difflineminus">-        }</span>
<a href="#l4.536"></a><span id="l4.536" class="difflineminus">-        node.setAttribute(&quot;label&quot;, label);</span>
<a href="#l4.537"></a><span id="l4.537" class="difflineminus">-        this._setCssSelectors(folder, node);</span>
<a href="#l4.538"></a><span id="l4.538" class="difflineplus">+    /**</span>
<a href="#l4.539"></a><span id="l4.539" class="difflineplus">+     * Return the label to use for a folder.</span>
<a href="#l4.540"></a><span id="l4.540" class="difflineplus">+     *</span>
<a href="#l4.541"></a><span id="l4.541" class="difflineplus">+     * @param {string} mode  The mode, e.g. &quot;deferred&quot;.</span>
<a href="#l4.542"></a><span id="l4.542" class="difflineplus">+     * @param {nsIMsgFolder} globalInboxFolder  The root/global inbox folder.</span>
<a href="#l4.543"></a><span id="l4.543" class="difflineplus">+     * @param {nsIMsgFolder} folder  The folder for which we are getting a label.</span>
<a href="#l4.544"></a><span id="l4.544" class="difflineplus">+     * @return {string}  The label to use for the folder.</span>
<a href="#l4.545"></a><span id="l4.545" class="difflineplus">+     */</span>
<a href="#l4.546"></a><span id="l4.546" class="difflineplus">+    _getFolderLabel(mode, globalInboxFolder, folder) {</span>
<a href="#l4.547"></a><span id="l4.547" class="difflineplus">+      if (mode == &quot;deferred&quot; &amp;&amp; folder.isServer &amp;&amp;</span>
<a href="#l4.548"></a><span id="l4.548" class="difflineplus">+          folder.server.rootFolder == globalInboxFolder) {</span>
<a href="#l4.549"></a><span id="l4.549" class="difflineplus">+        return this._stringBundle.get(&quot;globalInbox&quot;, [folder.prettyName]);</span>
<a href="#l4.550"></a><span id="l4.550">       }</span>
<a href="#l4.551"></a><span id="l4.551" class="difflineplus">+      return folder.prettyName;</span>
<a href="#l4.552"></a><span id="l4.552">     }</span>
<a href="#l4.553"></a><span id="l4.553"> </span>
<a href="#l4.554"></a><span id="l4.554">     /**</span>
<a href="#l4.555"></a><span id="l4.555">      * Let the user have a list of subfolders for all account types, none of</span>
<a href="#l4.556"></a><span id="l4.556">      * them, or only some of them.  Returns an array containing a function that</span>
<a href="#l4.557"></a><span id="l4.557">      * determines whether to show subfolders for a given account type, and an</span>
<a href="#l4.558"></a><span id="l4.558">      * object mapping account types to label names (may be null).</span>
<a href="#l4.559"></a><span id="l4.559">      *</span>
<a href="#l4.560"></a><span id="l4.560" class="difflineat">@@ -769,39 +752,57 @@</span>
<a href="#l4.561"></a><span id="l4.561">           }</span>
<a href="#l4.562"></a><span id="l4.562">         }</span>
<a href="#l4.563"></a><span id="l4.563">         shouldExpand = (e) =&gt; types.includes(e);</span>
<a href="#l4.564"></a><span id="l4.564">       }</span>
<a href="#l4.565"></a><span id="l4.565">       return [shouldExpand, labels];</span>
<a href="#l4.566"></a><span id="l4.566">     }</span>
<a href="#l4.567"></a><span id="l4.567"> </span>
<a href="#l4.568"></a><span id="l4.568">     /**</span>
<a href="#l4.569"></a><span id="l4.569" class="difflineminus">-     * This function adds attributes on menu/menuitems to make it easier for</span>
<a href="#l4.570"></a><span id="l4.570" class="difflineminus">-     * css to style them.</span>
<a href="#l4.571"></a><span id="l4.571" class="difflineplus">+     * Set attributes on a menu, menuitem, or toolbarbutton element to allow</span>
<a href="#l4.572"></a><span id="l4.572" class="difflineplus">+     * for CSS styling.</span>
<a href="#l4.573"></a><span id="l4.573">      *</span>
<a href="#l4.574"></a><span id="l4.574">      * @param {nsIMsgFolder} folder  The folder that corresponds to the menu/menuitem.</span>
<a href="#l4.575"></a><span id="l4.575">      * @param {Element} menuNode     The actual DOM node to set attributes on.</span>
<a href="#l4.576"></a><span id="l4.576">      */</span>
<a href="#l4.577"></a><span id="l4.577">     _setCssSelectors(folder, menuNode) {</span>
<a href="#l4.578"></a><span id="l4.578" class="difflineminus">-      // First set the SpecialFolder attribute.</span>
<a href="#l4.579"></a><span id="l4.579" class="difflineminus">-      menuNode.setAttribute(&quot;SpecialFolder&quot;, getSpecialFolderString(folder));</span>
<a href="#l4.580"></a><span id="l4.580" class="difflineplus">+        const cssAttributes = this._getCssSelectorAttributes(folder);</span>
<a href="#l4.581"></a><span id="l4.581" class="difflineplus">+</span>
<a href="#l4.582"></a><span id="l4.582" class="difflineplus">+        Object.entries(cssAttributes).forEach(([key, value]) =&gt;</span>
<a href="#l4.583"></a><span id="l4.583" class="difflineplus">+          menuNode.setAttribute(key, value));</span>
<a href="#l4.584"></a><span id="l4.584" class="difflineplus">+    }</span>
<a href="#l4.585"></a><span id="l4.585"> </span>
<a href="#l4.586"></a><span id="l4.586" class="difflineminus">-      // Now set the biffState.</span>
<a href="#l4.587"></a><span id="l4.587" class="difflineplus">+    /**</span>
<a href="#l4.588"></a><span id="l4.588" class="difflineplus">+     * Returns attributes to be set on a menu, menuitem, or toolbarbutton</span>
<a href="#l4.589"></a><span id="l4.589" class="difflineplus">+     * element to allow for CSS styling.</span>
<a href="#l4.590"></a><span id="l4.590" class="difflineplus">+     *</span>
<a href="#l4.591"></a><span id="l4.591" class="difflineplus">+     * @param {nsIMsgFolder} folder  The folder that corresponds to the menu item.</span>
<a href="#l4.592"></a><span id="l4.592" class="difflineplus">+     * @return {Object}              Contains the CSS selector attributes.</span>
<a href="#l4.593"></a><span id="l4.593" class="difflineplus">+     */</span>
<a href="#l4.594"></a><span id="l4.594" class="difflineplus">+    _getCssSelectorAttributes(folder) {</span>
<a href="#l4.595"></a><span id="l4.595" class="difflineplus">+      let attributes = {};</span>
<a href="#l4.596"></a><span id="l4.596" class="difflineplus">+</span>
<a href="#l4.597"></a><span id="l4.597" class="difflineplus">+      // First the SpecialFolder attribute.</span>
<a href="#l4.598"></a><span id="l4.598" class="difflineplus">+      attributes.SpecialFolder = getSpecialFolderString(folder);</span>
<a href="#l4.599"></a><span id="l4.599" class="difflineplus">+</span>
<a href="#l4.600"></a><span id="l4.600" class="difflineplus">+      // Now the biffState.</span>
<a href="#l4.601"></a><span id="l4.601">       let biffStates = [&quot;NewMail&quot;, &quot;NoMail&quot;, &quot;UnknownMail&quot;];</span>
<a href="#l4.602"></a><span id="l4.602">       for (let state of biffStates) {</span>
<a href="#l4.603"></a><span id="l4.603">         if (folder.biffState == Ci.nsIMsgFolder[&quot;nsMsgBiffState_&quot; + state]) {</span>
<a href="#l4.604"></a><span id="l4.604" class="difflineminus">-          menuNode.setAttribute(&quot;BiffState&quot;, state);</span>
<a href="#l4.605"></a><span id="l4.605" class="difflineplus">+          attributes.BiffState = state;</span>
<a href="#l4.606"></a><span id="l4.606">           break;</span>
<a href="#l4.607"></a><span id="l4.607">         }</span>
<a href="#l4.608"></a><span id="l4.608">       }</span>
<a href="#l4.609"></a><span id="l4.609"> </span>
<a href="#l4.610"></a><span id="l4.610" class="difflineminus">-      menuNode.setAttribute(&quot;IsServer&quot;, folder.isServer);</span>
<a href="#l4.611"></a><span id="l4.611" class="difflineminus">-      menuNode.setAttribute(&quot;IsSecure&quot;, folder.server.isSecure);</span>
<a href="#l4.612"></a><span id="l4.612" class="difflineminus">-      menuNode.setAttribute(&quot;ServerType&quot;, folder.server.type);</span>
<a href="#l4.613"></a><span id="l4.613" class="difflineminus">-      menuNode.setAttribute(&quot;IsFeedFolder&quot;, !!FeedUtils.getFeedUrlsInFolder(folder));</span>
<a href="#l4.614"></a><span id="l4.614" class="difflineplus">+      attributes.IsServer = folder.isServer;</span>
<a href="#l4.615"></a><span id="l4.615" class="difflineplus">+      attributes.IsSecure = folder.server.isSecure;</span>
<a href="#l4.616"></a><span id="l4.616" class="difflineplus">+      attributes.ServerType = folder.server.type;</span>
<a href="#l4.617"></a><span id="l4.617" class="difflineplus">+      attributes.IsFeedFolder = !!FeedUtils.getFeedUrlsInFolder(folder);</span>
<a href="#l4.618"></a><span id="l4.618" class="difflineplus">+</span>
<a href="#l4.619"></a><span id="l4.619" class="difflineplus">+      return attributes;</span>
<a href="#l4.620"></a><span id="l4.620">     }</span>
<a href="#l4.621"></a><span id="l4.621"> </span>
<a href="#l4.622"></a><span id="l4.622">     /**</span>
<a href="#l4.623"></a><span id="l4.623">      * This function returns a formatted display name for a menulist</span>
<a href="#l4.624"></a><span id="l4.624">      * selected folder. The desired format is set as the 'displayformat'</span>
<a href="#l4.625"></a><span id="l4.625">      * attribute of the folderpicker's &lt;menulist&gt;, one of:</span>
<a href="#l4.626"></a><span id="l4.626">      * 'name' (default) - Folder</span>
<a href="#l4.627"></a><span id="l4.627">      * 'verbose'        - Folder on Account</span>
<a href="#l4.628"></a><span id="l4.628" class="difflineat">@@ -824,16 +825,18 @@</span>
<a href="#l4.629"></a><span id="l4.629">         return FeedUtils.getFolderPrettyPath(folder) || folder.name;</span>
<a href="#l4.630"></a><span id="l4.630">       }</span>
<a href="#l4.631"></a><span id="l4.631"> </span>
<a href="#l4.632"></a><span id="l4.632">       return folder.name;</span>
<a href="#l4.633"></a><span id="l4.633">     }</span>
<a href="#l4.634"></a><span id="l4.634"> </span>
<a href="#l4.635"></a><span id="l4.635">     /**</span>
<a href="#l4.636"></a><span id="l4.636">      * Makes a given folder selected.</span>
<a href="#l4.637"></a><span id="l4.637" class="difflineplus">+     * TODO: This function does not work yet for the appmenu. However, as of</span>
<a href="#l4.638"></a><span id="l4.638" class="difflineplus">+     * June 2019, this functionality is not used in the appmenu.</span>
<a href="#l4.639"></a><span id="l4.639">      *</span>
<a href="#l4.640"></a><span id="l4.640">      * @param {nsIMsgFolder} inputFolder  The folder to select (if none, then Choose Folder).</span>
<a href="#l4.641"></a><span id="l4.641">      * @return {boolean}                  Is true if any usable folder was found, otherwise false.</span>
<a href="#l4.642"></a><span id="l4.642">      * @note  If inputFolder is not in this popup, but is instead a descendant of</span>
<a href="#l4.643"></a><span id="l4.643">      *        a member of the popup, that ancestor will be selected.</span>
<a href="#l4.644"></a><span id="l4.644">      */</span>
<a href="#l4.645"></a><span id="l4.645">     selectFolder(inputFolder) {</span>
<a href="#l4.646"></a><span id="l4.646">       // Set the label of the menulist element as if folder had been selected.</span>
<a href="#l4.647"></a><span id="l4.647" class="difflineat">@@ -894,42 +897,397 @@</span>
<a href="#l4.648"></a><span id="l4.648">         noFolders = false;</span>
<a href="#l4.649"></a><span id="l4.649">       }</span>
<a href="#l4.650"></a><span id="l4.650"> </span>
<a href="#l4.651"></a><span id="l4.651">       setupParent(folder, this.parentNode, noFolders);</span>
<a href="#l4.652"></a><span id="l4.652">       return !!folder;</span>
<a href="#l4.653"></a><span id="l4.653">     }</span>
<a href="#l4.654"></a><span id="l4.654"> </span>
<a href="#l4.655"></a><span id="l4.655">     /**</span>
<a href="#l4.656"></a><span id="l4.656" class="difflineminus">-     * Removes all menu items for this popup, resets all fields, and</span>
<a href="#l4.657"></a><span id="l4.657" class="difflineminus">-     * removes the listener. This function is invoked when a change</span>
<a href="#l4.658"></a><span id="l4.658" class="difflineminus">-     * that affects this menu is detected by our listener.</span>
<a href="#l4.659"></a><span id="l4.659" class="difflineplus">+     * Removes all menu items from this menu, removes their submenus (needed for</span>
<a href="#l4.660"></a><span id="l4.660" class="difflineplus">+     * the appmenu where the `panelview` submenus are not children of the</span>
<a href="#l4.661"></a><span id="l4.661" class="difflineplus">+     * `toolbarbutton` menu items), resets all fields, and removes the listener.</span>
<a href="#l4.662"></a><span id="l4.662" class="difflineplus">+     * This function is called when a change that affects this menu is detected</span>
<a href="#l4.663"></a><span id="l4.663" class="difflineplus">+     * by the listener.</span>
<a href="#l4.664"></a><span id="l4.664">      */</span>
<a href="#l4.665"></a><span id="l4.665">     _teardown() {</span>
<a href="#l4.666"></a><span id="l4.666">       if (!this._initialized) {</span>
<a href="#l4.667"></a><span id="l4.667">         return;</span>
<a href="#l4.668"></a><span id="l4.668">       }</span>
<a href="#l4.669"></a><span id="l4.669" class="difflineminus">-</span>
<a href="#l4.670"></a><span id="l4.670" class="difflineminus">-      for (let i = this.childNodes.length - 1; i &gt;= 0; i--) {</span>
<a href="#l4.671"></a><span id="l4.671" class="difflineminus">-        let child = this.childNodes[i];</span>
<a href="#l4.672"></a><span id="l4.672" class="difflineminus">-        if (child.getAttribute(&quot;generated&quot;) != &quot;true&quot;) {</span>
<a href="#l4.673"></a><span id="l4.673" class="difflineplus">+      const children = this.childWrapper.childNodes;</span>
<a href="#l4.674"></a><span id="l4.674" class="difflineplus">+      // We iterate in reverse order because childNodes is live so it changes</span>
<a href="#l4.675"></a><span id="l4.675" class="difflineplus">+      // as we remove child nodes.</span>
<a href="#l4.676"></a><span id="l4.676" class="difflineplus">+      for (let i = children.length - 1; i &gt;= 0; i--) {</span>
<a href="#l4.677"></a><span id="l4.677" class="difflineplus">+        const item = children[i];</span>
<a href="#l4.678"></a><span id="l4.678" class="difflineplus">+        if (item.getAttribute(&quot;generated&quot;) != &quot;true&quot;) {</span>
<a href="#l4.679"></a><span id="l4.679">           continue;</span>
<a href="#l4.680"></a><span id="l4.680">         }</span>
<a href="#l4.681"></a><span id="l4.681" class="difflineminus">-        if (&quot;_teardown&quot; in child) {</span>
<a href="#l4.682"></a><span id="l4.682" class="difflineminus">-          child._teardown();</span>
<a href="#l4.683"></a><span id="l4.683" class="difflineplus">+        const submenu = this._getSubMenuForMenuItem(item);</span>
<a href="#l4.684"></a><span id="l4.684" class="difflineplus">+</span>
<a href="#l4.685"></a><span id="l4.685" class="difflineplus">+        if (submenu &amp;&amp; &quot;_teardown&quot; in submenu) {</span>
<a href="#l4.686"></a><span id="l4.686" class="difflineplus">+          submenu._teardown();</span>
<a href="#l4.687"></a><span id="l4.687" class="difflineplus">+          submenu.remove();</span>
<a href="#l4.688"></a><span id="l4.688">         }</span>
<a href="#l4.689"></a><span id="l4.689" class="difflineminus">-        child.remove();</span>
<a href="#l4.690"></a><span id="l4.690" class="difflineplus">+        item.remove();</span>
<a href="#l4.691"></a><span id="l4.691">       }</span>
<a href="#l4.692"></a><span id="l4.692"> </span>
<a href="#l4.693"></a><span id="l4.693">       this._removeListener();</span>
<a href="#l4.694"></a><span id="l4.694"> </span>
<a href="#l4.695"></a><span id="l4.695">       this._initialized = false;</span>
<a href="#l4.696"></a><span id="l4.696">       this._initializedSpecials.clear();</span>
<a href="#l4.697"></a><span id="l4.697">     }</span>
<a href="#l4.698"></a><span id="l4.698" class="difflineminus">-    disconnectedCallback() {</span>
<a href="#l4.699"></a><span id="l4.699" class="difflineminus">-      // Clean up when being destroyed.</span>
<a href="#l4.700"></a><span id="l4.700" class="difflineminus">-      this._removeListener();</span>
<a href="#l4.701"></a><span id="l4.701" class="difflineminus">-      this._teardown();</span>
<a href="#l4.702"></a><span id="l4.702" class="difflineplus">+  };</span>
<a href="#l4.703"></a><span id="l4.703" class="difflineplus">+</span>
<a href="#l4.704"></a><span id="l4.704" class="difflineplus">+  /**</span>
<a href="#l4.705"></a><span id="l4.705" class="difflineplus">+   * The MozFolderMenupopup widget is used as a menupopup that contains menu</span>
<a href="#l4.706"></a><span id="l4.706" class="difflineplus">+   * items and submenus for all folders from every account (or some subset of</span>
<a href="#l4.707"></a><span id="l4.707" class="difflineplus">+   * folders and accounts). It is also used to provide a menu with a menuitem</span>
<a href="#l4.708"></a><span id="l4.708" class="difflineplus">+   * for each account. Each menu item gets displayed with the folder or</span>
<a href="#l4.709"></a><span id="l4.709" class="difflineplus">+   * account name and icon. It uses code that is also used by MozFolderPanelView</span>
<a href="#l4.710"></a><span id="l4.710" class="difflineplus">+   * via the FolderMenuMixin function.</span>
<a href="#l4.711"></a><span id="l4.711" class="difflineplus">+   *</span>
<a href="#l4.712"></a><span id="l4.712" class="difflineplus">+   * @extends {MozElements.MozMenuPopup}</span>
<a href="#l4.713"></a><span id="l4.713" class="difflineplus">+   */</span>
<a href="#l4.714"></a><span id="l4.714" class="difflineplus">+  let MozFolderMenuPopup = FolderMenuMixin(class extends MozElements.MozMenuPopup {</span>
<a href="#l4.715"></a><span id="l4.715" class="difflineplus">+    constructor() {</span>
<a href="#l4.716"></a><span id="l4.716" class="difflineplus">+      super();</span>
<a href="#l4.717"></a><span id="l4.717" class="difflineplus">+</span>
<a href="#l4.718"></a><span id="l4.718" class="difflineplus">+      // To improve performance, only build the menu when it is shown.</span>
<a href="#l4.719"></a><span id="l4.719" class="difflineplus">+      this.addEventListener(&quot;popupshowing&quot;, (event) =&gt; {</span>
<a href="#l4.720"></a><span id="l4.720" class="difflineplus">+        this._ensureInitialized();</span>
<a href="#l4.721"></a><span id="l4.721" class="difflineplus">+      }, true);</span>
<a href="#l4.722"></a><span id="l4.722" class="difflineplus">+</span>
<a href="#l4.723"></a><span id="l4.723" class="difflineplus">+      // Because the menu items in a panelview go inside a child vbox but are</span>
<a href="#l4.724"></a><span id="l4.724" class="difflineplus">+      // direct children of a menupopup, we set up a consistent way to append</span>
<a href="#l4.725"></a><span id="l4.725" class="difflineplus">+      // and access menu items for both cases.</span>
<a href="#l4.726"></a><span id="l4.726" class="difflineplus">+      this.childWrapper = this;</span>
<a href="#l4.727"></a><span id="l4.727" class="difflineplus">+    }</span>
<a href="#l4.728"></a><span id="l4.728" class="difflineplus">+</span>
<a href="#l4.729"></a><span id="l4.729" class="difflineplus">+    connectedCallback() {</span>
<a href="#l4.730"></a><span id="l4.730" class="difflineplus">+      if (this.delayConnectedCallback()) {</span>
<a href="#l4.731"></a><span id="l4.731" class="difflineplus">+        return;</span>
<a href="#l4.732"></a><span id="l4.732" class="difflineplus">+      }</span>
<a href="#l4.733"></a><span id="l4.733" class="difflineplus">+</span>
<a href="#l4.734"></a><span id="l4.734" class="difflineplus">+      this.setAttribute(&quot;is&quot;, &quot;folder-menupopup&quot;);</span>
<a href="#l4.735"></a><span id="l4.735" class="difflineplus">+</span>
<a href="#l4.736"></a><span id="l4.736" class="difflineplus">+      // Find out if we are in a wrapper (customize toolbars mode is active).</span>
<a href="#l4.737"></a><span id="l4.737" class="difflineplus">+      let inWrapper = false;</span>
<a href="#l4.738"></a><span id="l4.738" class="difflineplus">+      let node = this;</span>
<a href="#l4.739"></a><span id="l4.739" class="difflineplus">+      while (node instanceof XULElement) {</span>
<a href="#l4.740"></a><span id="l4.740" class="difflineplus">+        if (node.id.startsWith(&quot;wrapper-&quot;)) {</span>
<a href="#l4.741"></a><span id="l4.741" class="difflineplus">+          inWrapper = true;</span>
<a href="#l4.742"></a><span id="l4.742" class="difflineplus">+          break;</span>
<a href="#l4.743"></a><span id="l4.743" class="difflineplus">+        }</span>
<a href="#l4.744"></a><span id="l4.744" class="difflineplus">+        node = node.parentNode;</span>
<a href="#l4.745"></a><span id="l4.745" class="difflineplus">+      }</span>
<a href="#l4.746"></a><span id="l4.746" class="difflineplus">+</span>
<a href="#l4.747"></a><span id="l4.747" class="difflineplus">+      if (!inWrapper) {</span>
<a href="#l4.748"></a><span id="l4.748" class="difflineplus">+        if (this.hasAttribute(&quot;original-width&quot;)) {</span>
<a href="#l4.749"></a><span id="l4.749" class="difflineplus">+          // If we were in a wrapper before and have a width stored, restore it now.</span>
<a href="#l4.750"></a><span id="l4.750" class="difflineplus">+          if (this.getAttribute(&quot;original-width&quot;) == &quot;none&quot;) {</span>
<a href="#l4.751"></a><span id="l4.751" class="difflineplus">+            this.removeAttribute(&quot;width&quot;);</span>
<a href="#l4.752"></a><span id="l4.752" class="difflineplus">+          } else {</span>
<a href="#l4.753"></a><span id="l4.753" class="difflineplus">+            this.setAttribute(&quot;width&quot;, this.getAttribute(&quot;original-width&quot;));</span>
<a href="#l4.754"></a><span id="l4.754" class="difflineplus">+          }</span>
<a href="#l4.755"></a><span id="l4.755" class="difflineplus">+</span>
<a href="#l4.756"></a><span id="l4.756" class="difflineplus">+          this.removeAttribute(&quot;original-width&quot;);</span>
<a href="#l4.757"></a><span id="l4.757" class="difflineplus">+        }</span>
<a href="#l4.758"></a><span id="l4.758" class="difflineplus">+</span>
<a href="#l4.759"></a><span id="l4.759" class="difflineplus">+        // If we are a child of a menulist, and we aren't in a wrapper, we</span>
<a href="#l4.760"></a><span id="l4.760" class="difflineplus">+        // need to build our content right away, otherwise the menulist</span>
<a href="#l4.761"></a><span id="l4.761" class="difflineplus">+        // won't have proper sizing.</span>
<a href="#l4.762"></a><span id="l4.762" class="difflineplus">+        if (this.parentNode &amp;&amp; this.parentNode.localName == &quot;menulist&quot;) {</span>
<a href="#l4.763"></a><span id="l4.763" class="difflineplus">+          this._ensureInitialized();</span>
<a href="#l4.764"></a><span id="l4.764" class="difflineplus">+        }</span>
<a href="#l4.765"></a><span id="l4.765" class="difflineplus">+      } else {</span>
<a href="#l4.766"></a><span id="l4.766" class="difflineplus">+        // But if we're in a wrapper, remove our children, because we're</span>
<a href="#l4.767"></a><span id="l4.767" class="difflineplus">+        // getting re-created when the toolbar customization closes.</span>
<a href="#l4.768"></a><span id="l4.768" class="difflineplus">+        this._teardown();</span>
<a href="#l4.769"></a><span id="l4.769" class="difflineplus">+</span>
<a href="#l4.770"></a><span id="l4.770" class="difflineplus">+        // Store our current width and set a safe small width when we show</span>
<a href="#l4.771"></a><span id="l4.771" class="difflineplus">+        // in a wrapper.</span>
<a href="#l4.772"></a><span id="l4.772" class="difflineplus">+        if (!this.hasAttribute(&quot;original-width&quot;)) {</span>
<a href="#l4.773"></a><span id="l4.773" class="difflineplus">+          this.setAttribute(&quot;original-width&quot;, this.hasAttribute(&quot;width&quot;) ?</span>
<a href="#l4.774"></a><span id="l4.774" class="difflineplus">+            this.getAttribute(&quot;width&quot;) : &quot;none&quot;);</span>
<a href="#l4.775"></a><span id="l4.775" class="difflineplus">+          this.setAttribute(&quot;width&quot;, &quot;100&quot;);</span>
<a href="#l4.776"></a><span id="l4.776" class="difflineplus">+        }</span>
<a href="#l4.777"></a><span id="l4.777" class="difflineplus">+      }</span>
<a href="#l4.778"></a><span id="l4.778" class="difflineplus">+    }</span>
<a href="#l4.779"></a><span id="l4.779" class="difflineplus">+</span>
<a href="#l4.780"></a><span id="l4.780" class="difflineplus">+    /**</span>
<a href="#l4.781"></a><span id="l4.781" class="difflineplus">+     * Given a menu item, return the menupopup that it opens.</span>
<a href="#l4.782"></a><span id="l4.782" class="difflineplus">+     *</span>
<a href="#l4.783"></a><span id="l4.783" class="difflineplus">+     * @param {Element} menu   The menu item, typically a `menu` element.</span>
<a href="#l4.784"></a><span id="l4.784" class="difflineplus">+     * @return {Element|null}  The `menupopup` element or null if none found.</span>
<a href="#l4.785"></a><span id="l4.785" class="difflineplus">+     */</span>
<a href="#l4.786"></a><span id="l4.786" class="difflineplus">+    _getSubMenuForMenuItem(menu) {</span>
<a href="#l4.787"></a><span id="l4.787" class="difflineplus">+      return menu.querySelector(&quot;menupopup&quot;);</span>
<a href="#l4.788"></a><span id="l4.788" class="difflineplus">+    }</span>
<a href="#l4.789"></a><span id="l4.789" class="difflineplus">+</span>
<a href="#l4.790"></a><span id="l4.790" class="difflineplus">+    /**</span>
<a href="#l4.791"></a><span id="l4.791" class="difflineplus">+     * Returns a `menuseparator` element for use in a `menupopup`.</span>
<a href="#l4.792"></a><span id="l4.792" class="difflineplus">+     */</span>
<a href="#l4.793"></a><span id="l4.793" class="difflineplus">+    _buildSeparator() {</span>
<a href="#l4.794"></a><span id="l4.794" class="difflineplus">+      return generateElement(&quot;menuseparator&quot;);</span>
<a href="#l4.795"></a><span id="l4.795" class="difflineplus">+    }</span>
<a href="#l4.796"></a><span id="l4.796" class="difflineplus">+</span>
<a href="#l4.797"></a><span id="l4.797" class="difflineplus">+    /**</span>
<a href="#l4.798"></a><span id="l4.798" class="difflineplus">+     * Builds a menu item (`menuitem`) element that does not open a submenu</span>
<a href="#l4.799"></a><span id="l4.799" class="difflineplus">+     * (i.e. not a `menu` element).</span>
<a href="#l4.800"></a><span id="l4.800" class="difflineplus">+     *</span>
<a href="#l4.801"></a><span id="l4.801" class="difflineplus">+     * @param {Object} [attributes]  Attributes to set on the element.</span>
<a href="#l4.802"></a><span id="l4.802" class="difflineplus">+     * @param {nsIMsgFolder} folder  The folder associated with the menu item.</span>
<a href="#l4.803"></a><span id="l4.803" class="difflineplus">+     * @returns {Element}            A `menuitem`.</span>
<a href="#l4.804"></a><span id="l4.804" class="difflineplus">+     */</span>
<a href="#l4.805"></a><span id="l4.805" class="difflineplus">+    _buildMenuItem(attributes, folder) {</span>
<a href="#l4.806"></a><span id="l4.806" class="difflineplus">+        const menuitem = generateElement(&quot;menuitem&quot;, attributes);</span>
<a href="#l4.807"></a><span id="l4.807" class="difflineplus">+        menuitem.classList.add(&quot;folderMenuItem&quot;, &quot;menuitem-iconic&quot;);</span>
<a href="#l4.808"></a><span id="l4.808" class="difflineplus">+        menuitem._folder = folder;</span>
<a href="#l4.809"></a><span id="l4.809" class="difflineplus">+        return menuitem;</span>
<a href="#l4.810"></a><span id="l4.810" class="difflineplus">+    }</span>
<a href="#l4.811"></a><span id="l4.811" class="difflineplus">+</span>
<a href="#l4.812"></a><span id="l4.812" class="difflineplus">+    /**</span>
<a href="#l4.813"></a><span id="l4.813" class="difflineplus">+     * Builds a menu item (`menu`) element and an associated submenu</span>
<a href="#l4.814"></a><span id="l4.814" class="difflineplus">+     * (`menupopup`) element.</span>
<a href="#l4.815"></a><span id="l4.815" class="difflineplus">+     *</span>
<a href="#l4.816"></a><span id="l4.816" class="difflineplus">+     * @param {Object} attributes         Attributes to set on the `menu` element.</span>
<a href="#l4.817"></a><span id="l4.817" class="difflineplus">+     * @param {boolean} folderSubmenu     Whether the submenu is to be a</span>
<a href="#l4.818"></a><span id="l4.818" class="difflineplus">+     *                                    `folder-menupopup` element.</span>
<a href="#l4.819"></a><span id="l4.819" class="difflineplus">+     * @param {nsIMsgFolder} [folder]     The folder associated with the menu item.</span>
<a href="#l4.820"></a><span id="l4.820" class="difflineplus">+     * @param {Object} submenuAttributes  Attributes to set on the `menupopup` element.</span>
<a href="#l4.821"></a><span id="l4.821" class="difflineplus">+     * @return {Element[]}       Array containing the `menu` and</span>
<a href="#l4.822"></a><span id="l4.822" class="difflineplus">+     *                                    `menupopup` elements.</span>
<a href="#l4.823"></a><span id="l4.823" class="difflineplus">+     */</span>
<a href="#l4.824"></a><span id="l4.824" class="difflineplus">+    _buildMenuItemWithSubmenu(attributes, folderSubmenu, folder, submenuAttributes) {</span>
<a href="#l4.825"></a><span id="l4.825" class="difflineplus">+      const menu = generateElement(&quot;menu&quot;, attributes);</span>
<a href="#l4.826"></a><span id="l4.826" class="difflineplus">+      menu.classList.add(&quot;folderMenuItem&quot;, &quot;menu-iconic&quot;);</span>
<a href="#l4.827"></a><span id="l4.827" class="difflineplus">+</span>
<a href="#l4.828"></a><span id="l4.828" class="difflineplus">+      const isObject = folderSubmenu ? { &quot;is&quot;: &quot;folder-menupopup&quot; } : null;</span>
<a href="#l4.829"></a><span id="l4.829" class="difflineplus">+</span>
<a href="#l4.830"></a><span id="l4.830" class="difflineplus">+      const menupopup = generateElement(&quot;menupopup&quot;, submenuAttributes, isObject);</span>
<a href="#l4.831"></a><span id="l4.831" class="difflineplus">+</span>
<a href="#l4.832"></a><span id="l4.832" class="difflineplus">+      if (folder) {</span>
<a href="#l4.833"></a><span id="l4.833" class="difflineplus">+        menu._folder = folder;</span>
<a href="#l4.834"></a><span id="l4.834" class="difflineplus">+        menupopup._parentFolder = folder;</span>
<a href="#l4.835"></a><span id="l4.835" class="difflineplus">+      }</span>
<a href="#l4.836"></a><span id="l4.836" class="difflineplus">+</span>
<a href="#l4.837"></a><span id="l4.837" class="difflineplus">+      if (!menupopup.childWrapper) {</span>
<a href="#l4.838"></a><span id="l4.838" class="difflineplus">+        menupopup.childWrapper = menupopup;</span>
<a href="#l4.839"></a><span id="l4.839" class="difflineplus">+      }</span>
<a href="#l4.840"></a><span id="l4.840" class="difflineplus">+</span>
<a href="#l4.841"></a><span id="l4.841" class="difflineplus">+      menu.appendChild(menupopup);</span>
<a href="#l4.842"></a><span id="l4.842" class="difflineplus">+</span>
<a href="#l4.843"></a><span id="l4.843" class="difflineplus">+      return [menu, menupopup];</span>
<a href="#l4.844"></a><span id="l4.844" class="difflineplus">+    }</span>
<a href="#l4.845"></a><span id="l4.845" class="difflineplus">+</span>
<a href="#l4.846"></a><span id="l4.846" class="difflineplus">+    /**</span>
<a href="#l4.847"></a><span id="l4.847" class="difflineplus">+     * Build a special menu item (`menu`) and an empty submenu (`menupopup`)</span>
<a href="#l4.848"></a><span id="l4.848" class="difflineplus">+     * for it. The submenu is populated just before it is shown by</span>
<a href="#l4.849"></a><span id="l4.849" class="difflineplus">+     * `_populateSpecialSubmenu`.</span>
<a href="#l4.850"></a><span id="l4.850" class="difflineplus">+     *</span>
<a href="#l4.851"></a><span id="l4.851" class="difflineplus">+     * The submenu (`menupopup`) is just a standard element, not a custom</span>
<a href="#l4.852"></a><span id="l4.852" class="difflineplus">+     * element (`folder-menupopup`).</span>
<a href="#l4.853"></a><span id="l4.853" class="difflineplus">+     *</span>
<a href="#l4.854"></a><span id="l4.854" class="difflineplus">+     * @param {Object} [attributes]  Attributes to set on the menu item element.</span>
<a href="#l4.855"></a><span id="l4.855" class="difflineplus">+     * @return {Element}             The menu item (`menu`) element.</span>
<a href="#l4.856"></a><span id="l4.856" class="difflineplus">+     */</span>
<a href="#l4.857"></a><span id="l4.857" class="difflineplus">+    _buildSpecialMenu(attributes) {</span>
<a href="#l4.858"></a><span id="l4.858" class="difflineplus">+      const [menu, menupopup] = this._buildMenuItemWithSubmenu(attributes);</span>
<a href="#l4.859"></a><span id="l4.859" class="difflineplus">+</span>
<a href="#l4.860"></a><span id="l4.860" class="difflineplus">+      menupopup.addEventListener(&quot;popupshowing&quot;, (event) =&gt; {</span>
<a href="#l4.861"></a><span id="l4.861" class="difflineplus">+        this._populateSpecialSubmenu(menu, menupopup);</span>
<a href="#l4.862"></a><span id="l4.862" class="difflineplus">+      }, { once: true });</span>
<a href="#l4.863"></a><span id="l4.863" class="difflineplus">+</span>
<a href="#l4.864"></a><span id="l4.864" class="difflineplus">+      return menu;</span>
<a href="#l4.865"></a><span id="l4.865">     }</span>
<a href="#l4.866"></a><span id="l4.866" class="difflineminus">-  }</span>
<a href="#l4.867"></a><span id="l4.867" class="difflineplus">+  });</span>
<a href="#l4.868"></a><span id="l4.868" class="difflineplus">+</span>
<a href="#l4.869"></a><span id="l4.869" class="difflineplus">+  customElements.define(&quot;folder-menupopup&quot;, MozFolderMenuPopup, { extends: &quot;menupopup&quot; });</span>
<a href="#l4.870"></a><span id="l4.870" class="difflineplus">+</span>
<a href="#l4.871"></a><span id="l4.871" class="difflineplus">+  /**</span>
<a href="#l4.872"></a><span id="l4.872" class="difflineplus">+   * Used as a panelview in the appmenu/hamburger menu. It contains</span>
<a href="#l4.873"></a><span id="l4.873" class="difflineplus">+   * menu items and submenus for all folders from every account (or some subset</span>
<a href="#l4.874"></a><span id="l4.874" class="difflineplus">+   * of folders and accounts). It is also used to provide a menu with a menuitem</span>
<a href="#l4.875"></a><span id="l4.875" class="difflineplus">+   * for each account. Each menu item gets displayed with the folder or account</span>
<a href="#l4.876"></a><span id="l4.876" class="difflineplus">+   * name and icon. It uses code that is also used by MozFolderMenupopup via</span>
<a href="#l4.877"></a><span id="l4.877" class="difflineplus">+   * the FolderMenuMixin function.</span>
<a href="#l4.878"></a><span id="l4.878" class="difflineplus">+   *</span>
<a href="#l4.879"></a><span id="l4.879" class="difflineplus">+   * @extends {MozXULElement}</span>
<a href="#l4.880"></a><span id="l4.880" class="difflineplus">+   */</span>
<a href="#l4.881"></a><span id="l4.881" class="difflineplus">+  let MozFolderPanelView = FolderMenuMixin(class extends MozXULElement {</span>
<a href="#l4.882"></a><span id="l4.882" class="difflineplus">+    constructor() {</span>
<a href="#l4.883"></a><span id="l4.883" class="difflineplus">+      super();</span>
<a href="#l4.884"></a><span id="l4.884" class="difflineplus">+</span>
<a href="#l4.885"></a><span id="l4.885" class="difflineplus">+      // To improve performance, only build the menu when it is shown.</span>
<a href="#l4.886"></a><span id="l4.886" class="difflineplus">+      this.addEventListener(&quot;ViewShowing&quot;, (event) =&gt; {</span>
<a href="#l4.887"></a><span id="l4.887" class="difflineplus">+        this._ensureInitialized();</span>
<a href="#l4.888"></a><span id="l4.888" class="difflineplus">+      }, true);</span>
<a href="#l4.889"></a><span id="l4.889" class="difflineplus">+   }</span>
<a href="#l4.890"></a><span id="l4.890" class="difflineplus">+</span>
<a href="#l4.891"></a><span id="l4.891" class="difflineplus">+    connectedCallback() {</span>
<a href="#l4.892"></a><span id="l4.892" class="difflineplus">+      // In the appmenu the panelview elements may move around, so we only want</span>
<a href="#l4.893"></a><span id="l4.893" class="difflineplus">+      // connectedCallback to run once.</span>
<a href="#l4.894"></a><span id="l4.894" class="difflineplus">+      if (this.delayConnectedCallback() || this.hasConnected) {</span>
<a href="#l4.895"></a><span id="l4.895" class="difflineplus">+        return;</span>
<a href="#l4.896"></a><span id="l4.896" class="difflineplus">+      }</span>
<a href="#l4.897"></a><span id="l4.897" class="difflineplus">+      this.hasConnected = true;</span>
<a href="#l4.898"></a><span id="l4.898" class="difflineplus">+      this.setAttribute(&quot;is&quot;, &quot;folder-panelview&quot;);</span>
<a href="#l4.899"></a><span id="l4.899" class="difflineplus">+      this._setUpPanelView(this);</span>
<a href="#l4.900"></a><span id="l4.900" class="difflineplus">+    }</span>
<a href="#l4.901"></a><span id="l4.901" class="difflineplus">+</span>
<a href="#l4.902"></a><span id="l4.902" class="difflineplus">+    /**</span>
<a href="#l4.903"></a><span id="l4.903" class="difflineplus">+     * Set up a `folder-panelview` or a plain `panelview` element. If the</span>
<a href="#l4.904"></a><span id="l4.904" class="difflineplus">+     * panelview was statically defined in a XUL file then it may already have</span>
<a href="#l4.905"></a><span id="l4.905" class="difflineplus">+     * a child &lt;vbox&gt; element, if it was dynamically generated it may not yet.</span>
<a href="#l4.906"></a><span id="l4.906" class="difflineplus">+     *</span>
<a href="#l4.907"></a><span id="l4.907" class="difflineplus">+     * @param {Element} panelview  The panelview to set up.</span>
<a href="#l4.908"></a><span id="l4.908" class="difflineplus">+     */</span>
<a href="#l4.909"></a><span id="l4.909" class="difflineplus">+    _setUpPanelView(panelview) {</span>
<a href="#l4.910"></a><span id="l4.910" class="difflineplus">+      let subviewBody = panelview.querySelector(&quot;.panel-subview-body&quot;);</span>
<a href="#l4.911"></a><span id="l4.911" class="difflineplus">+</span>
<a href="#l4.912"></a><span id="l4.912" class="difflineplus">+      if (!subviewBody) {</span>
<a href="#l4.913"></a><span id="l4.913" class="difflineplus">+        subviewBody = document.createXULElement(&quot;vbox&quot;);</span>
<a href="#l4.914"></a><span id="l4.914" class="difflineplus">+        subviewBody.classList.add(&quot;panel-subview-body&quot;);</span>
<a href="#l4.915"></a><span id="l4.915" class="difflineplus">+        panelview.appendChild(subviewBody);</span>
<a href="#l4.916"></a><span id="l4.916" class="difflineplus">+      }</span>
<a href="#l4.917"></a><span id="l4.917" class="difflineplus">+      // Because the menu items in a panelview go inside a child vbox but are</span>
<a href="#l4.918"></a><span id="l4.918" class="difflineplus">+      // direct children of a menupopup, we set up a consistent way to append</span>
<a href="#l4.919"></a><span id="l4.919" class="difflineplus">+      // and access menu items for both cases.</span>
<a href="#l4.920"></a><span id="l4.920" class="difflineplus">+      panelview.childWrapper = subviewBody;</span>
<a href="#l4.921"></a><span id="l4.921" class="difflineplus">+      panelview.classList.add(&quot;PanelUI-subView&quot;);</span>
<a href="#l4.922"></a><span id="l4.922" class="difflineplus">+</span>
<a href="#l4.923"></a><span id="l4.923" class="difflineplus">+      // Prevent the back button from firing the command that is set on the</span>
<a href="#l4.924"></a><span id="l4.924" class="difflineplus">+      // panelview by stopping propagation of the event. The back button does</span>
<a href="#l4.925"></a><span id="l4.925" class="difflineplus">+      // not exist until the panelview is shown for the first time (when the</span>
<a href="#l4.926"></a><span id="l4.926" class="difflineplus">+      // header is added to it).</span>
<a href="#l4.927"></a><span id="l4.927" class="difflineplus">+      panelview.addEventListener(&quot;ViewShown&quot;, () =&gt; {</span>
<a href="#l4.928"></a><span id="l4.928" class="difflineplus">+        const backButton = panelview.querySelector(&quot;.panel-header &gt; .subviewbutton-back&quot;);</span>
<a href="#l4.929"></a><span id="l4.929" class="difflineplus">+        if (backButton) {</span>
<a href="#l4.930"></a><span id="l4.930" class="difflineplus">+          backButton.addEventListener(&quot;command&quot;, event =&gt; event.stopPropagation());</span>
<a href="#l4.931"></a><span id="l4.931" class="difflineplus">+        }</span>
<a href="#l4.932"></a><span id="l4.932" class="difflineplus">+      }, { once: true });</span>
<a href="#l4.933"></a><span id="l4.933" class="difflineplus">+    }</span>
<a href="#l4.934"></a><span id="l4.934" class="difflineplus">+</span>
<a href="#l4.935"></a><span id="l4.935" class="difflineplus">+    /**</span>
<a href="#l4.936"></a><span id="l4.936" class="difflineplus">+     * Given a menu item, return the submenu that it opens.</span>
<a href="#l4.937"></a><span id="l4.937" class="difflineplus">+     *</span>
<a href="#l4.938"></a><span id="l4.938" class="difflineplus">+     * @param {Element} item   The menu item, typically a `toolbarbutton`.</span>
<a href="#l4.939"></a><span id="l4.939" class="difflineplus">+     * @return {Element|null}  The submenu (or null if none found), typically a</span>
<a href="#l4.940"></a><span id="l4.940" class="difflineplus">+     *                         `panelview` element.</span>
<a href="#l4.941"></a><span id="l4.941" class="difflineplus">+     */</span>
<a href="#l4.942"></a><span id="l4.942" class="difflineplus">+    _getSubMenuForMenuItem(item) {</span>
<a href="#l4.943"></a><span id="l4.943" class="difflineplus">+      const panelviewId = item.getAttribute(&quot;panelviewId&quot;);</span>
<a href="#l4.944"></a><span id="l4.944" class="difflineplus">+      if (panelviewId) {</span>
<a href="#l4.945"></a><span id="l4.945" class="difflineplus">+        return document.getElementById(panelviewId);</span>
<a href="#l4.946"></a><span id="l4.946" class="difflineplus">+      }</span>
<a href="#l4.947"></a><span id="l4.947" class="difflineplus">+      return null;</span>
<a href="#l4.948"></a><span id="l4.948" class="difflineplus">+    }</span>
<a href="#l4.949"></a><span id="l4.949" class="difflineplus">+</span>
<a href="#l4.950"></a><span id="l4.950" class="difflineplus">+    /**</span>
<a href="#l4.951"></a><span id="l4.951" class="difflineplus">+     * Returns a `toolbarseparator` element for use in a `panelview`.</span>
<a href="#l4.952"></a><span id="l4.952" class="difflineplus">+     */</span>
<a href="#l4.953"></a><span id="l4.953" class="difflineplus">+    _buildSeparator() {</span>
<a href="#l4.954"></a><span id="l4.954" class="difflineplus">+      return generateElement(&quot;toolbarseparator&quot;);</span>
<a href="#l4.955"></a><span id="l4.955" class="difflineplus">+    }</span>
<a href="#l4.956"></a><span id="l4.956"> </span>
<a href="#l4.957"></a><span id="l4.957" class="difflineminus">-  customElements.define(&quot;folder-menupopup&quot;, MozFolderMenupopup, { extends: &quot;menupopup&quot; });</span>
<a href="#l4.958"></a><span id="l4.958" class="difflineplus">+    /**</span>
<a href="#l4.959"></a><span id="l4.959" class="difflineplus">+     * Builds a menu item (`toolbarbutton`) element that does not open a submenu.</span>
<a href="#l4.960"></a><span id="l4.960" class="difflineplus">+     *</span>
<a href="#l4.961"></a><span id="l4.961" class="difflineplus">+     * @param {Object} [attributes]  Attributes to set on the element.</span>
<a href="#l4.962"></a><span id="l4.962" class="difflineplus">+     * @param {nsIMsgFolder} folder  The folder associated with the menu item.</span>
<a href="#l4.963"></a><span id="l4.963" class="difflineplus">+     * @returns {Element}            A `toolbarbutton`.</span>
<a href="#l4.964"></a><span id="l4.964" class="difflineplus">+     */</span>
<a href="#l4.965"></a><span id="l4.965" class="difflineplus">+    _buildMenuItem(attributes, folder) {</span>
<a href="#l4.966"></a><span id="l4.966" class="difflineplus">+        const button = generateElement(&quot;toolbarbutton&quot;, attributes);</span>
<a href="#l4.967"></a><span id="l4.967" class="difflineplus">+        button._folder = folder;</span>
<a href="#l4.968"></a><span id="l4.968" class="difflineplus">+</span>
<a href="#l4.969"></a><span id="l4.969" class="difflineplus">+        button.classList.add(&quot;folderMenuItem&quot;, &quot;subviewbutton&quot;,</span>
<a href="#l4.970"></a><span id="l4.970" class="difflineplus">+          &quot;subviewbutton-iconic&quot;);</span>
<a href="#l4.971"></a><span id="l4.971" class="difflineplus">+        return button;</span>
<a href="#l4.972"></a><span id="l4.972" class="difflineplus">+    }</span>
<a href="#l4.973"></a><span id="l4.973" class="difflineplus">+</span>
<a href="#l4.974"></a><span id="l4.974" class="difflineplus">+    /**</span>
<a href="#l4.975"></a><span id="l4.975" class="difflineplus">+     * Builds a menu item (`toolbarbutton`) element and an associated submenu</span>
<a href="#l4.976"></a><span id="l4.976" class="difflineplus">+     * (`panelview`) element.</span>
<a href="#l4.977"></a><span id="l4.977" class="difflineplus">+     *</span>
<a href="#l4.978"></a><span id="l4.978" class="difflineplus">+     * @param {Object} attributes         Attributes to set on the</span>
<a href="#l4.979"></a><span id="l4.979" class="difflineplus">+     *                                    `toolbarbutton` element.</span>
<a href="#l4.980"></a><span id="l4.980" class="difflineplus">+     * @param {boolean} folderSubmenu     Whether the submenu is to be a</span>
<a href="#l4.981"></a><span id="l4.981" class="difflineplus">+     *                                    `folder-panelview` element.</span>
<a href="#l4.982"></a><span id="l4.982" class="difflineplus">+     * @param {nsIMsgFolder} [folder]     The folder associated with the menu item.</span>
<a href="#l4.983"></a><span id="l4.983" class="difflineplus">+     * @param {Object} submenuAttributes  Attributes to set on the `panelview`</span>
<a href="#l4.984"></a><span id="l4.984" class="difflineplus">+     *                                    element.</span>
<a href="#l4.985"></a><span id="l4.985" class="difflineplus">+     * @return {Element[]}                Array containing the `toolbarbutton`</span>
<a href="#l4.986"></a><span id="l4.986" class="difflineplus">+     *                                    and `panelview` elements.</span>
<a href="#l4.987"></a><span id="l4.987" class="difflineplus">+     */</span>
<a href="#l4.988"></a><span id="l4.988" class="difflineplus">+    _buildMenuItemWithSubmenu(attributes, folderSubmenu, folder, submenuAttributes) {</span>
<a href="#l4.989"></a><span id="l4.989" class="difflineplus">+      const button = generateElement(&quot;toolbarbutton&quot;, attributes);</span>
<a href="#l4.990"></a><span id="l4.990" class="difflineplus">+</span>
<a href="#l4.991"></a><span id="l4.991" class="difflineplus">+      button.classList.add(&quot;folderMenuItem&quot;, &quot;subviewbutton&quot;,</span>
<a href="#l4.992"></a><span id="l4.992" class="difflineplus">+        &quot;subviewbutton-iconic&quot;, &quot;subviewbutton-nav&quot;);</span>
<a href="#l4.993"></a><span id="l4.993" class="difflineplus">+</span>
<a href="#l4.994"></a><span id="l4.994" class="difflineplus">+      const isObject = folderSubmenu ? { &quot;is&quot;: &quot;folder-panelview&quot; } : null;</span>
<a href="#l4.995"></a><span id="l4.995" class="difflineplus">+</span>
<a href="#l4.996"></a><span id="l4.996" class="difflineplus">+      const panelview = generateElement(&quot;panelview&quot;, submenuAttributes, isObject);</span>
<a href="#l4.997"></a><span id="l4.997" class="difflineplus">+</span>
<a href="#l4.998"></a><span id="l4.998" class="difflineplus">+      if (!folderSubmenu) {</span>
<a href="#l4.999"></a><span id="l4.999" class="difflineplus">+        this._setUpPanelView(panelview);</span>
<a href="#l4.1000"></a><span id="l4.1000" class="difflineplus">+      }</span>
<a href="#l4.1001"></a><span id="l4.1001" class="difflineplus">+</span>
<a href="#l4.1002"></a><span id="l4.1002" class="difflineplus">+      if (folder) {</span>
<a href="#l4.1003"></a><span id="l4.1003" class="difflineplus">+        panelview._parentFolder = folder;</span>
<a href="#l4.1004"></a><span id="l4.1004" class="difflineplus">+        panelview._folder = folder;</span>
<a href="#l4.1005"></a><span id="l4.1005" class="difflineplus">+      }</span>
<a href="#l4.1006"></a><span id="l4.1006" class="difflineplus">+</span>
<a href="#l4.1007"></a><span id="l4.1007" class="difflineplus">+      const panelviewId = getUniquePanelViewId(&quot;folderPanelView&quot;);</span>
<a href="#l4.1008"></a><span id="l4.1008" class="difflineplus">+      panelview.setAttribute(&quot;id&quot;, panelviewId);</span>
<a href="#l4.1009"></a><span id="l4.1009" class="difflineplus">+</span>
<a href="#l4.1010"></a><span id="l4.1010" class="difflineplus">+      // Pass these attributes down from panelview to panelview.</span>
<a href="#l4.1011"></a><span id="l4.1011" class="difflineplus">+      [&quot;command&quot;, &quot;oncommand&quot;].forEach(attribute =&gt; {</span>
<a href="#l4.1012"></a><span id="l4.1012" class="difflineplus">+        if (this.hasAttribute(attribute)) {</span>
<a href="#l4.1013"></a><span id="l4.1013" class="difflineplus">+          panelview.setAttribute(attribute, this.getAttribute(attribute));</span>
<a href="#l4.1014"></a><span id="l4.1014" class="difflineplus">+        }</span>
<a href="#l4.1015"></a><span id="l4.1015" class="difflineplus">+      });</span>
<a href="#l4.1016"></a><span id="l4.1016" class="difflineplus">+</span>
<a href="#l4.1017"></a><span id="l4.1017" class="difflineplus">+      if (!submenuAttributes || (submenuAttributes &amp;&amp; !submenuAttributes.label)) {</span>
<a href="#l4.1018"></a><span id="l4.1018" class="difflineplus">+        panelview.setAttribute(&quot;label&quot;, attributes.label);</span>
<a href="#l4.1019"></a><span id="l4.1019" class="difflineplus">+      }</span>
<a href="#l4.1020"></a><span id="l4.1020" class="difflineplus">+</span>
<a href="#l4.1021"></a><span id="l4.1021" class="difflineplus">+      button.addEventListener(&quot;command&quot;, (event) =&gt; {</span>
<a href="#l4.1022"></a><span id="l4.1022" class="difflineplus">+        // Stop event propagation so the command that is set on the panelview</span>
<a href="#l4.1023"></a><span id="l4.1023" class="difflineplus">+        // is not fired when we are just navigating to a submenu.</span>
<a href="#l4.1024"></a><span id="l4.1024" class="difflineplus">+        event.stopPropagation();</span>
<a href="#l4.1025"></a><span id="l4.1025" class="difflineplus">+        PanelUI.showSubView(panelviewId, panelview);</span>
<a href="#l4.1026"></a><span id="l4.1026" class="difflineplus">+      });</span>
<a href="#l4.1027"></a><span id="l4.1027" class="difflineplus">+</span>
<a href="#l4.1028"></a><span id="l4.1028" class="difflineplus">+      // Save the panelviewId on the menu item so we have a way to access the</span>
<a href="#l4.1029"></a><span id="l4.1029" class="difflineplus">+      // panelview from the menu item that opens it.</span>
<a href="#l4.1030"></a><span id="l4.1030" class="difflineplus">+      button.setAttribute(&quot;panelviewId&quot;, panelviewId);</span>
<a href="#l4.1031"></a><span id="l4.1031" class="difflineplus">+      button.setAttribute(&quot;closemenu&quot;, &quot;none&quot;);</span>
<a href="#l4.1032"></a><span id="l4.1032" class="difflineplus">+      document.querySelector(&quot;#appMenu-multiView&quot;).appendChild(panelview);</span>
<a href="#l4.1033"></a><span id="l4.1033" class="difflineplus">+</span>
<a href="#l4.1034"></a><span id="l4.1034" class="difflineplus">+      return [button, panelview];</span>
<a href="#l4.1035"></a><span id="l4.1035" class="difflineplus">+    }</span>
<a href="#l4.1036"></a><span id="l4.1036" class="difflineplus">+</span>
<a href="#l4.1037"></a><span id="l4.1037" class="difflineplus">+    /**</span>
<a href="#l4.1038"></a><span id="l4.1038" class="difflineplus">+     * Build a special menu item (`toolbarbutton`) and an empty submenu</span>
<a href="#l4.1039"></a><span id="l4.1039" class="difflineplus">+     * (`panelview`) for it. The submenu is populated just before it is shown</span>
<a href="#l4.1040"></a><span id="l4.1040" class="difflineplus">+     * by `_populateSpecialSubmenu`.</span>
<a href="#l4.1041"></a><span id="l4.1041" class="difflineplus">+     *</span>
<a href="#l4.1042"></a><span id="l4.1042" class="difflineplus">+     * The submenu (`panelview`) is just a standard element, not a custom</span>
<a href="#l4.1043"></a><span id="l4.1043" class="difflineplus">+     * element (`folder-panelview`).</span>
<a href="#l4.1044"></a><span id="l4.1044" class="difflineplus">+     *</span>
<a href="#l4.1045"></a><span id="l4.1045" class="difflineplus">+     * @param {Object} [attributes]  Attributes to set on the menu item element.</span>
<a href="#l4.1046"></a><span id="l4.1046" class="difflineplus">+     * @return {Element}             The menu item (`toolbarbutton`) element.</span>
<a href="#l4.1047"></a><span id="l4.1047" class="difflineplus">+     */</span>
<a href="#l4.1048"></a><span id="l4.1048" class="difflineplus">+    _buildSpecialMenu(attributes) {</span>
<a href="#l4.1049"></a><span id="l4.1049" class="difflineplus">+      const [button, panelview] = this._buildMenuItemWithSubmenu(attributes);</span>
<a href="#l4.1050"></a><span id="l4.1050" class="difflineplus">+</span>
<a href="#l4.1051"></a><span id="l4.1051" class="difflineplus">+      panelview.addEventListener(&quot;ViewShowing&quot;, (event) =&gt; {</span>
<a href="#l4.1052"></a><span id="l4.1052" class="difflineplus">+        this._populateSpecialSubmenu(button, panelview);</span>
<a href="#l4.1053"></a><span id="l4.1053" class="difflineplus">+      }, { once: true });</span>
<a href="#l4.1054"></a><span id="l4.1054" class="difflineplus">+</span>
<a href="#l4.1055"></a><span id="l4.1055" class="difflineplus">+      return button;</span>
<a href="#l4.1056"></a><span id="l4.1056" class="difflineplus">+    }</span>
<a href="#l4.1057"></a><span id="l4.1057" class="difflineplus">+  });</span>
<a href="#l4.1058"></a><span id="l4.1058" class="difflineplus">+</span>
<a href="#l4.1059"></a><span id="l4.1059" class="difflineplus">+  customElements.define(&quot;folder-panelview&quot;, MozFolderPanelView, { extends: &quot;panelview&quot; });</span>
<a href="#l4.1060"></a><span id="l4.1060"> }</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:31Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

