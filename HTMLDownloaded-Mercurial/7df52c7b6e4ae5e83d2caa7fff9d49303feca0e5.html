<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 9909:7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5" />
<meta property="og:url" content="/comm-central/rev/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5" />
<meta property="og:description" content="Bug 738299 - Need notification bar when Filelink uploads begin. r+ui-r=bwinton,feedback=squib." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5">shortlog</a> |
<a href="/comm-central/log/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5">files</a> |
changeset |
<a href="/comm-central/raw-rev/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5">raw</a>  | <a href="/comm-central/archive/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=738299">Bug 738299</a> - Need notification bar when Filelink uploads begin. r+ui-r=bwinton,feedback=squib.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#77;&#105;&#107;&#101;&#32;&#67;&#111;&#110;&#108;&#101;&#121;&#32;&#60;&#109;&#99;&#111;&#110;&#108;&#101;&#121;&#64;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 16 Apr 2012 12:53:35 -0400</td></tr>

<tr>
 <td>changeset 9909</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5">7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5</a></td>
</tr>



<tr>
<td>parent 9908</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/f7f5eeb7b12a37e4c3dc3971dae512760d39f523">f7f5eeb7b12a37e4c3dc3971dae512760d39f523</a>
</td>
</tr>

<tr>
<td>child 9910</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/88c29b17c96d15bc902dc4babf74310dd20021c7">88c29b17c96d15bc902dc4babf74310dd20021c7</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5">7546</a></td></tr>
<tr><td>push user</td><td>mconley@mozilla.com</td></tr>
<tr><td>push date</td><td class="date age">Mon, 16 Apr 2012 16:56:24 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@974245c3a39b [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=974245c3a39b63bf6fd7c9fdd6ea376e612ff44c">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=974245c3a39b63bf6fd7c9fdd6ea376e612ff44c&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=974245c3a39b63bf6fd7c9fdd6ea376e612ff44c&newProject=comm-central&newRevision=7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=974245c3a39b63bf6fd7c9fdd6ea376e612ff44c&newProject=comm-central&newRevision=7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=974245c3a39b63bf6fd7c9fdd6ea376e612ff44c&newProject=comm-central&newRevision=7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>

<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=738299">738299</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=738299">Bug 738299</a> - Need notification bar when Filelink uploads begin. r+ui-r=bwinton,feedback=squib.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5/mail/app/profile/all-thunderbird.js">mail/app/profile/all-thunderbird.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5/mail/app/profile/all-thunderbird.js">file</a> |
<a href="/comm-central/annotate/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5/mail/app/profile/all-thunderbird.js">annotate</a> |
<a href="/comm-central/diff/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5/mail/app/profile/all-thunderbird.js">diff</a> |
<a href="/comm-central/comparison/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5/mail/app/profile/all-thunderbird.js">comparison</a> |
<a href="/comm-central/log/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5/mail/app/profile/all-thunderbird.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5/mail/components/compose/content/MsgComposeCommands.js">mail/components/compose/content/MsgComposeCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5/mail/components/compose/content/MsgComposeCommands.js">file</a> |
<a href="/comm-central/annotate/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5/mail/components/compose/content/MsgComposeCommands.js">annotate</a> |
<a href="/comm-central/diff/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5/mail/components/compose/content/MsgComposeCommands.js">diff</a> |
<a href="/comm-central/comparison/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5/mail/components/compose/content/MsgComposeCommands.js">comparison</a> |
<a href="/comm-central/log/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5/mail/components/compose/content/MsgComposeCommands.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5/mail/components/compose/content/bigFileObserver.js">mail/components/compose/content/bigFileObserver.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5/mail/components/compose/content/bigFileObserver.js">file</a> |
<a href="/comm-central/annotate/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5/mail/components/compose/content/bigFileObserver.js">annotate</a> |
<a href="/comm-central/diff/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5/mail/components/compose/content/bigFileObserver.js">diff</a> |
<a href="/comm-central/comparison/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5/mail/components/compose/content/bigFileObserver.js">comparison</a> |
<a href="/comm-central/log/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5/mail/components/compose/content/bigFileObserver.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5/mail/test/mozmill/cloudfile/data/testFile4">mail/test/mozmill/cloudfile/data/testFile4</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5/mail/test/mozmill/cloudfile/data/testFile4">file</a> |
<a href="/comm-central/annotate/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5/mail/test/mozmill/cloudfile/data/testFile4">annotate</a> |
<a href="/comm-central/diff/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5/mail/test/mozmill/cloudfile/data/testFile4">diff</a> |
<a href="/comm-central/comparison/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5/mail/test/mozmill/cloudfile/data/testFile4">comparison</a> |
<a href="/comm-central/log/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5/mail/test/mozmill/cloudfile/data/testFile4">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js">mail/test/mozmill/cloudfile/test-cloudfile-notifications.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js">file</a> |
<a href="/comm-central/annotate/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js">annotate</a> |
<a href="/comm-central/diff/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js">diff</a> |
<a href="/comm-central/comparison/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js">comparison</a> |
<a href="/comm-central/log/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">mail/test/mozmill/shared-modules/test-cloudfile-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">file</a> |
<a href="/comm-central/annotate/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">annotate</a> |
<a href="/comm-central/diff/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">diff</a> |
<a href="/comm-central/comparison/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">comparison</a> |
<a href="/comm-central/log/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5/mail/test/mozmill/shared-modules/test-compose-helpers.js">mail/test/mozmill/shared-modules/test-compose-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5/mail/test/mozmill/shared-modules/test-compose-helpers.js">file</a> |
<a href="/comm-central/annotate/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5/mail/test/mozmill/shared-modules/test-compose-helpers.js">annotate</a> |
<a href="/comm-central/diff/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5/mail/test/mozmill/shared-modules/test-compose-helpers.js">diff</a> |
<a href="/comm-central/comparison/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5/mail/test/mozmill/shared-modules/test-compose-helpers.js">comparison</a> |
<a href="/comm-central/log/7df52c7b6e4ae5e83d2caa7fff9d49303feca0e5/mail/test/mozmill/shared-modules/test-compose-helpers.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/app/profile/all-thunderbird.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/app/profile/all-thunderbird.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -482,16 +482,19 @@ pref(&quot;mail.compose.attachment_reminder_k</span>
<a href="#l1.4"></a><span id="l1.4"> // show an alert on send?</span>
<a href="#l1.5"></a><span id="l1.5"> pref(&quot;mail.compose.attachment_reminder_aggressive&quot;, true);</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> // True if the user should be notified when attaching big files</span>
<a href="#l1.8"></a><span id="l1.8"> pref(&quot;mail.compose.big_attachments.notify&quot;, true);</span>
<a href="#l1.9"></a><span id="l1.9"> // Size (in kB) to automatically prompt for conversion of attachments to</span>
<a href="#l1.10"></a><span id="l1.10"> // cloud links</span>
<a href="#l1.11"></a><span id="l1.11"> pref(&quot;mail.compose.big_attachments.threshold_kb&quot;, 1024);</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+// True if the user should be notified that links will be inserted into</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+// their message when the upload is completed</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+pref(&quot;mail.compose.big_attachments.insert_notification&quot;, true);</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16"> // Set this to false to prevent instrumentation from happening, e.g., user</span>
<a href="#l1.17"></a><span id="l1.17"> // has opted out, or an enterprise wants to disable it from the git go.</span>
<a href="#l1.18"></a><span id="l1.18"> pref(&quot;mail.instrumentation.askUser&quot;, true);</span>
<a href="#l1.19"></a><span id="l1.19"> pref(&quot;mail.instrumentation.userOptedIn&quot;, false);</span>
<a href="#l1.20"></a><span id="l1.20"> pref(&quot;mail.instrumentation.postUrl&quot;, &quot;https://www.mozillamessaging.com/instrumentation&quot;);</span>
<a href="#l1.21"></a><span id="l1.21"> // not sure how this will be formatted - would be nice to make it extensible.</span>
<a href="#l1.22"></a><span id="l1.22"> pref(&quot;mail.instrumentation.lastNotificationSent&quot;, &quot;&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1111,16 +1111,21 @@ uploadListener.prototype = {</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5">       if (attachmentItem) {</span>
<a href="#l2.6"></a><span id="l2.6">         // Remove the loading throbber.</span>
<a href="#l2.7"></a><span id="l2.7">         attachmentItem.image = null;</span>
<a href="#l2.8"></a><span id="l2.8">         attachmentItem.setAttribute(&quot;tooltiptext&quot;, attachmentItem.attachment.url);</span>
<a href="#l2.9"></a><span id="l2.9">         attachmentItem.uploading = false;</span>
<a href="#l2.10"></a><span id="l2.10">         attachmentItem.attachment.sendViaCloud = false;</span>
<a href="#l2.11"></a><span id="l2.11">         delete attachmentItem.cloudProvider;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+        let event = document.createEvent(&quot;CustomEvent&quot;);</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+        event.initEvent(&quot;attachment-upload-failed&quot;, true, true,</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+                        aStatusCode);</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+        attachmentItem.dispatchEvent(event);</span>
<a href="#l2.17"></a><span id="l2.17">       }</span>
<a href="#l2.18"></a><span id="l2.18">     }</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20">     gNumUploadingAttachments--;</span>
<a href="#l2.21"></a><span id="l2.21">     updateSendCommands();</span>
<a href="#l2.22"></a><span id="l2.22">   },</span>
<a href="#l2.23"></a><span id="l2.23"> </span>
<a href="#l2.24"></a><span id="l2.24">   QueryInterface: XPCOMUtils.generateQI([Components.interfaces.nsIRequestObserver,</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineat">@@ -1192,16 +1197,17 @@ function attachToCloud(aProvider)</span>
<a href="#l2.26"></a><span id="l2.26">         aProvider.uploadFile(files[i], listener);</span>
<a href="#l2.27"></a><span id="l2.27">       }</span>
<a href="#l2.28"></a><span id="l2.28">       catch (ex) {</span>
<a href="#l2.29"></a><span id="l2.29">         listener.onStopRequest(null, null, ex.result);</span>
<a href="#l2.30"></a><span id="l2.30">       }</span>
<a href="#l2.31"></a><span id="l2.31">       i++;</span>
<a href="#l2.32"></a><span id="l2.32">     });</span>
<a href="#l2.33"></a><span id="l2.33"> </span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+    dispatchAttachmentBucketEvent(&quot;attachments-uploading&quot;, attachments);</span>
<a href="#l2.35"></a><span id="l2.35">     SetLastAttachDirectory(files[files.length-1]);</span>
<a href="#l2.36"></a><span id="l2.36">   }</span>
<a href="#l2.37"></a><span id="l2.37"> }</span>
<a href="#l2.38"></a><span id="l2.38"> </span>
<a href="#l2.39"></a><span id="l2.39"> /**</span>
<a href="#l2.40"></a><span id="l2.40">  * Convert an array of attachments to cloud attachments.</span>
<a href="#l2.41"></a><span id="l2.41">  *</span>
<a href="#l2.42"></a><span id="l2.42">  * @param aItems an array of &lt;attachmentitem&gt;s containing the attachments in</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineat">@@ -1240,20 +1246,23 @@ function convertListItemsToCloudAttachme</span>
<a href="#l2.44"></a><span id="l2.44">                                         aProvider);</span>
<a href="#l2.45"></a><span id="l2.45">       aProvider.uploadFile(file, listener);</span>
<a href="#l2.46"></a><span id="l2.46">       convertedAttachments.appendElement(item.attachment, false);</span>
<a href="#l2.47"></a><span id="l2.47">     }</span>
<a href="#l2.48"></a><span id="l2.48">     catch (ex) {</span>
<a href="#l2.49"></a><span id="l2.49">       listener.onStopRequest(null, null, ex.result);</span>
<a href="#l2.50"></a><span id="l2.50">     }</span>
<a href="#l2.51"></a><span id="l2.51">   }</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-  if (convertedAttachments.length)</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+  if (convertedAttachments.length) {</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+    dispatchAttachmentBucketEvent(&quot;attachments-converted&quot;, convertedAttachments);</span>
<a href="#l2.56"></a><span id="l2.56">     Services.obs.notifyObservers(convertedAttachments,</span>
<a href="#l2.57"></a><span id="l2.57">                                  &quot;mail:attachmentsConverted&quot;,</span>
<a href="#l2.58"></a><span id="l2.58">                                  aProvider.accountKey);</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+  }</span>
<a href="#l2.60"></a><span id="l2.60"> }</span>
<a href="#l2.61"></a><span id="l2.61"> </span>
<a href="#l2.62"></a><span id="l2.62"> /**</span>
<a href="#l2.63"></a><span id="l2.63">  * Convert the selected attachments to cloud attachments.</span>
<a href="#l2.64"></a><span id="l2.64">  *</span>
<a href="#l2.65"></a><span id="l2.65">  * @param aProvider the cloud provider to upload the files to</span>
<a href="#l2.66"></a><span id="l2.66">  */</span>
<a href="#l2.67"></a><span id="l2.67"> function convertSelectedToCloudAttachment(aProvider)</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineat">@@ -1314,24 +1323,21 @@ function convertListItemsToRegularAttach</span>
<a href="#l2.69"></a><span id="l2.69">     item.attachment.sendViaCloud = false;</span>
<a href="#l2.70"></a><span id="l2.70"> </span>
<a href="#l2.71"></a><span id="l2.71">     delete item.cloudProvider;</span>
<a href="#l2.72"></a><span id="l2.72">     delete item.originalUrl;</span>
<a href="#l2.73"></a><span id="l2.73">     item.image = null;</span>
<a href="#l2.74"></a><span id="l2.74"> </span>
<a href="#l2.75"></a><span id="l2.75">     convertedAttachments.appendElement(item.attachment, false);</span>
<a href="#l2.76"></a><span id="l2.76">   }</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineminus">-  let bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineminus">-  let event = document.createEvent(&quot;CustomEvent&quot;);</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineminus">-  event.initCustomEvent(&quot;attachments-converted&quot;, true, true, convertedAttachments);</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineminus">-  bucket.dispatchEvent(event);</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineminus">-</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineplus">+</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineplus">+  dispatchAttachmentBucketEvent(&quot;attachments-converted&quot;, convertedAttachments);</span>
<a href="#l2.84"></a><span id="l2.84">   Services.obs.notifyObservers(convertedAttachments,</span>
<a href="#l2.85"></a><span id="l2.85">                                &quot;mail:attachmentsConverted&quot;, null);</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineminus">-                               </span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+</span>
<a href="#l2.88"></a><span id="l2.88">   // We leave the content location in for the notifications because</span>
<a href="#l2.89"></a><span id="l2.89">   // it may be needed to identify the attachment. But clear it out now.</span>
<a href="#l2.90"></a><span id="l2.90">   for (let [,item] in Iterator(aItems))</span>
<a href="#l2.91"></a><span id="l2.91">     delete item.attachment.contentLocation;</span>
<a href="#l2.92"></a><span id="l2.92"> }</span>
<a href="#l2.93"></a><span id="l2.93"> </span>
<a href="#l2.94"></a><span id="l2.94"> /**</span>
<a href="#l2.95"></a><span id="l2.95">  * Convert the selected attachments to regular (non-cloud) attachments.</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineat">@@ -3630,19 +3636,17 @@ function AddAttachments(aAttachments, aC</span>
<a href="#l2.97"></a><span id="l2.97"> </span>
<a href="#l2.98"></a><span id="l2.98">     CheckForAttachmentNotification(null);</span>
<a href="#l2.99"></a><span id="l2.99">   }</span>
<a href="#l2.100"></a><span id="l2.100"> </span>
<a href="#l2.101"></a><span id="l2.101">   if (addedAttachments.length) {</span>
<a href="#l2.102"></a><span id="l2.102">     gContentChanged = true;</span>
<a href="#l2.103"></a><span id="l2.103"> </span>
<a href="#l2.104"></a><span id="l2.104">     UpdateAttachmentBucket(true);</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineminus">-    let event = document.createEvent(&quot;CustomEvent&quot;);</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineminus">-    event.initCustomEvent(&quot;attachments-added&quot;, true, true, addedAttachments);</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineminus">-    bucket.dispatchEvent(event);</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineplus">+    dispatchAttachmentBucketEvent(&quot;attachments-added&quot;, addedAttachments);</span>
<a href="#l2.109"></a><span id="l2.109">   }</span>
<a href="#l2.110"></a><span id="l2.110"> </span>
<a href="#l2.111"></a><span id="l2.111">   return items;</span>
<a href="#l2.112"></a><span id="l2.112"> }</span>
<a href="#l2.113"></a><span id="l2.113"> </span>
<a href="#l2.114"></a><span id="l2.114"> /**</span>
<a href="#l2.115"></a><span id="l2.115">  * Add a file object as attachment. This is mostly just a helper function to</span>
<a href="#l2.116"></a><span id="l2.116">  * wrap a file into an nsIMsgAttachment object with it's URL set. Note: this</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineat">@@ -3737,20 +3741,17 @@ function RemoveAllAttachments()</span>
<a href="#l2.118"></a><span id="l2.118">     let child = bucket.removeItemAt(bucket.getRowCount() - 1);</span>
<a href="#l2.119"></a><span id="l2.119"> </span>
<a href="#l2.120"></a><span id="l2.120">     removedAttachments.appendElement(child.attachment, false);</span>
<a href="#l2.121"></a><span id="l2.121">     // Let's release the attachment object hold by the node else it won't go</span>
<a href="#l2.122"></a><span id="l2.122">     // away until the window is destroyed</span>
<a href="#l2.123"></a><span id="l2.123">     child.attachment = null;</span>
<a href="#l2.124"></a><span id="l2.124">   }</span>
<a href="#l2.125"></a><span id="l2.125"> </span>
<a href="#l2.126"></a><span id="l2.126" class="difflineminus">-  let event = document.createEvent(&quot;CustomEvent&quot;);</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineminus">-  event.initCustomEvent(&quot;attachments-removed&quot;, true, true, removedAttachments);</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineminus">-  bucket.dispatchEvent(event);</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineminus">-</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineplus">+  dispatchAttachmentBucketEvent(&quot;attachments-removed&quot;, removedAttachments);</span>
<a href="#l2.131"></a><span id="l2.131">   UpdateAttachmentBucket(false);</span>
<a href="#l2.132"></a><span id="l2.132">   CheckForAttachmentNotification(null);</span>
<a href="#l2.133"></a><span id="l2.133"> }</span>
<a href="#l2.134"></a><span id="l2.134"> </span>
<a href="#l2.135"></a><span id="l2.135"> /**</span>
<a href="#l2.136"></a><span id="l2.136">  * Display/hide and update the content of the attachment bucket (specifically</span>
<a href="#l2.137"></a><span id="l2.137">  * the total file size of the attachments and the number of current attachments)</span>
<a href="#l2.138"></a><span id="l2.138">  *</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineat">@@ -3797,21 +3798,17 @@ function RemoveSelectedAttachment()</span>
<a href="#l2.140"></a><span id="l2.140"> </span>
<a href="#l2.141"></a><span id="l2.141">       removedAttachments.appendElement(item.attachment, false);</span>
<a href="#l2.142"></a><span id="l2.142">       // Let's release the attachment object held by the node else it won't go</span>
<a href="#l2.143"></a><span id="l2.143">       // away until the window is destroyed</span>
<a href="#l2.144"></a><span id="l2.144">       item.attachment = null;</span>
<a href="#l2.145"></a><span id="l2.145">     }</span>
<a href="#l2.146"></a><span id="l2.146"> </span>
<a href="#l2.147"></a><span id="l2.147">     gContentChanged = true;</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineminus">-</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineminus">-    let event = document.createEvent(&quot;CustomEvent&quot;);</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineminus">-    event.initCustomEvent(&quot;attachments-removed&quot;, true, true,</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineminus">-                          removedAttachments);</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineminus">-    bucket.dispatchEvent(event);</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineplus">+    dispatchAttachmentBucketEvent(&quot;attachments-removed&quot;, removedAttachments);</span>
<a href="#l2.154"></a><span id="l2.154">   }</span>
<a href="#l2.155"></a><span id="l2.155">   CheckForAttachmentNotification(null);</span>
<a href="#l2.156"></a><span id="l2.156"> }</span>
<a href="#l2.157"></a><span id="l2.157"> </span>
<a href="#l2.158"></a><span id="l2.158"> function RenameSelectedAttachment()</span>
<a href="#l2.159"></a><span id="l2.159"> {</span>
<a href="#l2.160"></a><span id="l2.160">   var bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l2.161"></a><span id="l2.161">   if (bucket.selectedItems.length != 1)</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineat">@@ -4699,8 +4696,21 @@ function getPref(aPrefName, aIsComplex) </span>
<a href="#l2.163"></a><span id="l2.163">     case Ci.nsIPrefBranch.PREF_INT:</span>
<a href="#l2.164"></a><span id="l2.164">       return prefB.getIntPref(aPrefName);</span>
<a href="#l2.165"></a><span id="l2.165">     case Ci.nsIPrefBranch.PREF_STRING:</span>
<a href="#l2.166"></a><span id="l2.166">       return prefB.getCharPref(aPrefName);</span>
<a href="#l2.167"></a><span id="l2.167">     default: // includes nsIPrefBranch.PREF_INVALID</span>
<a href="#l2.168"></a><span id="l2.168">       return null;</span>
<a href="#l2.169"></a><span id="l2.169">   }</span>
<a href="#l2.170"></a><span id="l2.170"> }</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineplus">+</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineplus">+/**</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineplus">+ * Helper function to dispatch a CustomEvent to the attachmentbucket.</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineplus">+ *</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineplus">+ * @param aEventType the name of the event to fire.</span>
<a href="#l2.176"></a><span id="l2.176" class="difflineplus">+ * @param aData any detail data to pass to the CustomEvent.</span>
<a href="#l2.177"></a><span id="l2.177" class="difflineplus">+ */</span>
<a href="#l2.178"></a><span id="l2.178" class="difflineplus">+function dispatchAttachmentBucketEvent(aEventType, aData) {</span>
<a href="#l2.179"></a><span id="l2.179" class="difflineplus">+  let bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l2.180"></a><span id="l2.180" class="difflineplus">+  let event = document.createEvent(&quot;CustomEvent&quot;);</span>
<a href="#l2.181"></a><span id="l2.181" class="difflineplus">+  event.initCustomEvent(aEventType, true, true, aData);</span>
<a href="#l2.182"></a><span id="l2.182" class="difflineplus">+  bucket.dispatchEvent(event);</span>
<a href="#l2.183"></a><span id="l2.183" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/components/compose/content/bigFileObserver.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/components/compose/content/bigFileObserver.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,96 +1,150 @@</span>
<a href="#l3.4"></a><span id="l3.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.5"></a><span id="l3.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l3.6"></a><span id="l3.6">   * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l3.9"></a><span id="l3.9"> Components.utils.import(&quot;resource:///modules/cloudFileAccounts.js&quot;);</span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+const kUploadNotificationValue = &quot;bigAttachmentUploading&quot;;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+</span>
<a href="#l3.13"></a><span id="l3.13"> var gBigFileObserver = {</span>
<a href="#l3.14"></a><span id="l3.14">   bigFiles: [],</span>
<a href="#l3.15"></a><span id="l3.15">   sessionHidden: false,</span>
<a href="#l3.16"></a><span id="l3.16"> </span>
<a href="#l3.17"></a><span id="l3.17">   get hidden() {</span>
<a href="#l3.18"></a><span id="l3.18">     return this.sessionHidden ||</span>
<a href="#l3.19"></a><span id="l3.19">            !Services.prefs.getBoolPref(&quot;mail.cloud_files.enabled&quot;) ||</span>
<a href="#l3.20"></a><span id="l3.20">            !Services.prefs.getBoolPref(&quot;mail.compose.big_attachments.notify&quot;) ||</span>
<a href="#l3.21"></a><span id="l3.21">            Services.io.offline;</span>
<a href="#l3.22"></a><span id="l3.22">   },</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+</span>
<a href="#l3.24"></a><span id="l3.24">   hide: function(aPermanent) {</span>
<a href="#l3.25"></a><span id="l3.25">     if (aPermanent)</span>
<a href="#l3.26"></a><span id="l3.26">       Services.prefs.setBoolPref(&quot;mail.compose.big_attachments.notify&quot;, false);</span>
<a href="#l3.27"></a><span id="l3.27">     else</span>
<a href="#l3.28"></a><span id="l3.28">       this.sessionHidden = true;</span>
<a href="#l3.29"></a><span id="l3.29">   },</span>
<a href="#l3.30"></a><span id="l3.30"> </span>
<a href="#l3.31"></a><span id="l3.31">   init: function() {</span>
<a href="#l3.32"></a><span id="l3.32">     let bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l3.33"></a><span id="l3.33">     bucket.addEventListener(&quot;attachments-added&quot;, this, false);</span>
<a href="#l3.34"></a><span id="l3.34">     bucket.addEventListener(&quot;attachments-removed&quot;, this, false);</span>
<a href="#l3.35"></a><span id="l3.35">     bucket.addEventListener(&quot;attachment-renamed&quot;, this, false);</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+    bucket.addEventListener(&quot;attachments-uploading&quot;, this, false);</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+    bucket.addEventListener(&quot;attachment-uploaded&quot;, this, false);</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+    bucket.addEventListener(&quot;attachment-upload-failed&quot;, this, false);</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+    bucket.addEventListener(&quot;attachments-converted&quot;, this, false);</span>
<a href="#l3.40"></a><span id="l3.40"> </span>
<a href="#l3.41"></a><span id="l3.41">     this.sessionHidden = false;</span>
<a href="#l3.42"></a><span id="l3.42">     this.bigFiles = [];</span>
<a href="#l3.43"></a><span id="l3.43">   },</span>
<a href="#l3.44"></a><span id="l3.44"> </span>
<a href="#l3.45"></a><span id="l3.45">   uninit: function() {</span>
<a href="#l3.46"></a><span id="l3.46">     let bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l3.47"></a><span id="l3.47">     bucket.removeEventListener(&quot;attachments-added&quot;, this, false);</span>
<a href="#l3.48"></a><span id="l3.48">     bucket.removeEventListener(&quot;attachments-removed&quot;, this, false);</span>
<a href="#l3.49"></a><span id="l3.49">     bucket.removeEventListener(&quot;attachment-renamed&quot;, this, false);</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+    bucket.removeEventListener(&quot;attachments-uploading&quot;, this, false);</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+    bucket.removeEventListener(&quot;attachment-uploaded&quot;, this, false);</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+    bucket.removeEventListener(&quot;attachment-upload-failed&quot;, this, false);</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+    bucket.removeEventListener(&quot;attachments-converted&quot;, this, false);</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+    let nb = document.getElementById(&quot;attachmentNotificationBox&quot;);</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+    let notification = nb.getNotificationWithValue(kUploadNotificationValue);</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+    if (notification)</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+      nb.removeNotification(notification);</span>
<a href="#l3.59"></a><span id="l3.59">   },</span>
<a href="#l3.60"></a><span id="l3.60"> </span>
<a href="#l3.61"></a><span id="l3.61">   handleEvent: function(event) {</span>
<a href="#l3.62"></a><span id="l3.62">     if (this.hidden)</span>
<a href="#l3.63"></a><span id="l3.63">       return;</span>
<a href="#l3.64"></a><span id="l3.64"> </span>
<a href="#l3.65"></a><span id="l3.65" class="difflineminus">-    const callbacks = {</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineminus">-      &quot;attachments-added&quot;: this.attachmentAdded,</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineminus">-      &quot;attachments-removed&quot;: this.attachmentRemoved,</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineminus">-      &quot;attachments-converted&quot;: this.attachmentConverted,</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+    const bucketCallbacks = {</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+      &quot;attachments-added&quot;: this.attachmentsAdded,</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+      &quot;attachments-removed&quot;: this.attachmentsRemoved,</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+      &quot;attachments-converted&quot;: this.attachmentsConverted,</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+      &quot;attachments-uploading&quot;: this.attachmentsUploading,</span>
<a href="#l3.74"></a><span id="l3.74">     };</span>
<a href="#l3.75"></a><span id="l3.75"> </span>
<a href="#l3.76"></a><span id="l3.76" class="difflineminus">-    for (let attachment in fixIterator(</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineminus">-         event.detail, Components.interfaces.nsIMsgAttachment)) {</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineminus">-      callbacks[event.type].call(this, attachment);</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+    const itemCallbacks = {</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+      &quot;attachment-uploaded&quot;: this.attachmentUploaded,</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+      &quot;attachment-upload-failed&quot;: this.attachmentUploadFailed,</span>
<a href="#l3.82"></a><span id="l3.82">     }</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+    if (event.type in bucketCallbacks)</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineplus">+      bucketCallbacks[event.type].call(this, event.detail);</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineplus">+</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+    if (event.type in itemCallbacks)</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+      itemCallbacks[event.type].call(this, event.target, event.detail);</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineplus">+</span>
<a href="#l3.90"></a><span id="l3.90">     this.updateNotification();</span>
<a href="#l3.91"></a><span id="l3.91">   },</span>
<a href="#l3.92"></a><span id="l3.92"> </span>
<a href="#l3.93"></a><span id="l3.93">   formatString: function (key, replacements, plural) {</span>
<a href="#l3.94"></a><span id="l3.94">     let str = getComposeBundle().getString(key);</span>
<a href="#l3.95"></a><span id="l3.95">     if (plural !== undefined)</span>
<a href="#l3.96"></a><span id="l3.96">       str = PluralForm.get(plural, str);</span>
<a href="#l3.97"></a><span id="l3.97">     if (replacements !== undefined) {</span>
<a href="#l3.98"></a><span id="l3.98">       for (let i = 0; i &lt; replacements.length; i++)</span>
<a href="#l3.99"></a><span id="l3.99">         str = str.replace(&quot;#&quot; + (i+1), replacements[i]);</span>
<a href="#l3.100"></a><span id="l3.100">     }</span>
<a href="#l3.101"></a><span id="l3.101">     return str;</span>
<a href="#l3.102"></a><span id="l3.102">   },</span>
<a href="#l3.103"></a><span id="l3.103"> </span>
<a href="#l3.104"></a><span id="l3.104" class="difflineminus">-  attachmentAdded: function(aAttachment) {</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineplus">+  attachmentsAdded: function(aAttachments) {</span>
<a href="#l3.106"></a><span id="l3.106">     let threshold = Services.prefs.getIntPref(</span>
<a href="#l3.107"></a><span id="l3.107">                     &quot;mail.compose.big_attachments.threshold_kb&quot;) * 1024;</span>
<a href="#l3.108"></a><span id="l3.108"> </span>
<a href="#l3.109"></a><span id="l3.109" class="difflineminus">-    if (aAttachment.size &gt;= threshold &amp;&amp; !aAttachment.sendViaCloud)</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineminus">-      this.bigFiles.push(aAttachment);</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineplus">+    for (let attachment in fixIterator(</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineplus">+         aAttachments, Components.interfaces.nsIMsgAttachment)) {</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineplus">+      if (attachment.size &gt;= threshold &amp;&amp; !attachment.sendViaCloud)</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineplus">+        this.bigFiles.push(attachment);</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineplus">+    }</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineplus">+  },</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineplus">+</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineplus">+  attachmentsRemoved: function(aAttachments) {</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineplus">+    for (let attachment in fixIterator(</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineplus">+         aAttachment , Components.interfaces.nsIMsgAttachment)) {</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineplus">+      let index = this.bigFiles.indexOf(attachment);</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineplus">+      if (index != -1)</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineplus">+        this.bigFiles.splice(index, 1);</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineplus">+    }</span>
<a href="#l3.125"></a><span id="l3.125">   },</span>
<a href="#l3.126"></a><span id="l3.126"> </span>
<a href="#l3.127"></a><span id="l3.127" class="difflineminus">-  attachmentRemoved: function(aAttachment) {</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineminus">-    let index = this.bigFiles.indexOf(aAttachment);</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineminus">-    if (index != -1)</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineminus">-      this.bigFiles.splice(index, 1);</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineplus">+  attachmentsConverted: function(aAttachments) {</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineplus">+    let uploaded = [];</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineplus">+</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineplus">+    for (let attachment in fixIterator(</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineplus">+         aAttachments, Components.interfaces.nsIMsgAttachment)) {</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineplus">+      if (attachment.sendViaCloud) {</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineplus">+        this.attachmentsRemoved([attachment]);</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineplus">+        uploaded.push(attachment);</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineplus">+      } else {</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineplus">+        this.attachmentsAdded([attachment]);</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineplus">+      }</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineplus">+    }</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineplus">+</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineplus">+    if (uploaded.length)</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineplus">+      this.showUploadingNotification(uploaded);</span>
<a href="#l3.146"></a><span id="l3.146">   },</span>
<a href="#l3.147"></a><span id="l3.147"> </span>
<a href="#l3.148"></a><span id="l3.148" class="difflineminus">-  attachmentConverted: function(aAttachment) {</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineminus">-    if (aAttachment.sendViaCloud)</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineminus">-      this.attachmentRemoved(aAttachment);</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineminus">-    else</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineminus">-      this.attachmentAdded(aAttachment);</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineplus">+  attachmentsUploading: function(aAttachments) {</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineplus">+    this.showUploadingNotification(aAttachments);</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineplus">+  },</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineplus">+</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineplus">+  attachmentUploaded: function(aAttachment) {</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineplus">+    if (!this._anyUploadsInProgress())</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineplus">+      this.hideUploadingNotification();</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineplus">+  },</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineplus">+</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineplus">+  attachmentUploadFailed: function(aAttachment, aStatusCode) {</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineplus">+    if (!this._anyUploadsInProgress())</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineplus">+      this.hideUploadingNotification();</span>
<a href="#l3.165"></a><span id="l3.165">   },</span>
<a href="#l3.166"></a><span id="l3.166"> </span>
<a href="#l3.167"></a><span id="l3.167">   updateNotification: function() {</span>
<a href="#l3.168"></a><span id="l3.168">     let nb = document.getElementById(&quot;attachmentNotificationBox&quot;);</span>
<a href="#l3.169"></a><span id="l3.169">     let notification = nb.getNotificationWithValue(&quot;bigAttachment&quot;);</span>
<a href="#l3.170"></a><span id="l3.170">     let numAccounts = cloudFileAccounts.accounts.length;</span>
<a href="#l3.171"></a><span id="l3.171"> </span>
<a href="#l3.172"></a><span id="l3.172">     if (this.bigFiles.length) {</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineat">@@ -138,17 +192,17 @@ var gBigFileObserver = {</span>
<a href="#l3.174"></a><span id="l3.174">     openContentTab(url);</span>
<a href="#l3.175"></a><span id="l3.175">     return true;</span>
<a href="#l3.176"></a><span id="l3.176">   },</span>
<a href="#l3.177"></a><span id="l3.177"> </span>
<a href="#l3.178"></a><span id="l3.178">   convertAttachments: function() {</span>
<a href="#l3.179"></a><span id="l3.179">     let cloudProvider;</span>
<a href="#l3.180"></a><span id="l3.180">     let accounts = cloudFileAccounts.accounts;</span>
<a href="#l3.181"></a><span id="l3.181"> </span>
<a href="#l3.182"></a><span id="l3.182" class="difflineminus">-    if(accounts.length == 1) {</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineplus">+    if (accounts.length == 1) {</span>
<a href="#l3.184"></a><span id="l3.184">       cloudProvider = accounts[0];</span>
<a href="#l3.185"></a><span id="l3.185">     }</span>
<a href="#l3.186"></a><span id="l3.186">     else if(accounts.length &gt; 1) {</span>
<a href="#l3.187"></a><span id="l3.187">       let selection = {};</span>
<a href="#l3.188"></a><span id="l3.188">       let names = [cloudFileAccounts.getDisplayName(i) for each (i in accounts)];</span>
<a href="#l3.189"></a><span id="l3.189">       if (Services.prompt.select(window,</span>
<a href="#l3.190"></a><span id="l3.190">                                  this.formatString(&quot;bigFileChooseAccount.title&quot;),</span>
<a href="#l3.191"></a><span id="l3.191">                                  this.formatString(&quot;bigFileChooseAccount.text&quot;),</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineat">@@ -173,14 +227,70 @@ var gBigFileObserver = {</span>
<a href="#l3.193"></a><span id="l3.193">                                      this.formatString(&quot;bigFileHideNotification.title&quot;),</span>
<a href="#l3.194"></a><span id="l3.194">                                      this.formatString(&quot;bigFileHideNotification.text&quot;),</span>
<a href="#l3.195"></a><span id="l3.195">                                      this.formatString(&quot;bigFileHideNotification.check&quot;),</span>
<a href="#l3.196"></a><span id="l3.196">                                      never))</span>
<a href="#l3.197"></a><span id="l3.197">       this.hide(never.value);</span>
<a href="#l3.198"></a><span id="l3.198">     else</span>
<a href="#l3.199"></a><span id="l3.199">       return true;</span>
<a href="#l3.200"></a><span id="l3.200">   },</span>
<a href="#l3.201"></a><span id="l3.201" class="difflineplus">+</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineplus">+  showUploadingNotification: function(aAttachments) {</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineplus">+    // We will show the uploading notification for a minimum of 2.5 seconds</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineplus">+    // seconds.</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineplus">+    const kThreshold = 2500; // milliseconds</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineplus">+</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineplus">+    if (!aAttachments.length ||</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineplus">+        !Services.prefs</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineplus">+                 .getBoolPref(&quot;mail.compose.big_attachments.insert_notification&quot;))</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineplus">+      return;</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineplus">+</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineplus">+    let nb = document.getElementById(&quot;attachmentNotificationBox&quot;);</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineplus">+    let notification = nb.getNotificationWithValue(kUploadNotificationValue);</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineplus">+</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineplus">+    if (notification)</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineplus">+      return;</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineplus">+</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineplus">+    let message = this.formatString(&quot;cloudFileUploadingNotification&quot;);</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineplus">+    message = PluralForm.get(aAttachments.length, message);</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineplus">+</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineplus">+    notification = nb.appendNotification(message, kUploadNotificationValue,</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineplus">+                                         &quot;null&quot;, nb.PRIORITY_WARNING_MEDIUM,</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineplus">+                                         null);</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineplus">+</span>
<a href="#l3.225"></a><span id="l3.225" class="difflineplus">+    notification.timeout = Date.now() + kThreshold;</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineplus">+  },</span>
<a href="#l3.227"></a><span id="l3.227" class="difflineplus">+</span>
<a href="#l3.228"></a><span id="l3.228" class="difflineplus">+  hideUploadingNotification: function() {</span>
<a href="#l3.229"></a><span id="l3.229" class="difflineplus">+    let nb = document.getElementById(&quot;attachmentNotificationBox&quot;);</span>
<a href="#l3.230"></a><span id="l3.230" class="difflineplus">+    let notification = nb.getNotificationWithValue(kUploadNotificationValue);</span>
<a href="#l3.231"></a><span id="l3.231" class="difflineplus">+</span>
<a href="#l3.232"></a><span id="l3.232" class="difflineplus">+    if (notification) {</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineplus">+      // Check the timestamp that we stashed in the timeout field of the</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineplus">+      // notification...</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineplus">+      let now = Date.now();</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineplus">+      if (now &gt;= notification.timeout) {</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineplus">+        nb.removeNotification(notification);</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineplus">+      } else {</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineplus">+        setTimeout(function() {</span>
<a href="#l3.240"></a><span id="l3.240" class="difflineplus">+          nb.removeNotification(notification);</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineplus">+        }, notification.timeout - now);</span>
<a href="#l3.242"></a><span id="l3.242" class="difflineplus">+      }</span>
<a href="#l3.243"></a><span id="l3.243" class="difflineplus">+    }</span>
<a href="#l3.244"></a><span id="l3.244" class="difflineplus">+  },</span>
<a href="#l3.245"></a><span id="l3.245" class="difflineplus">+</span>
<a href="#l3.246"></a><span id="l3.246" class="difflineplus">+  _anyUploadsInProgress: function() {</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineplus">+    let bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineplus">+    let rowCount = bucket.getRowCount();</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineplus">+    for (let i = 0; i &lt; bucket.getRowCount(); ++i) {</span>
<a href="#l3.250"></a><span id="l3.250" class="difflineplus">+      let item = bucket.getItemAtIndex(i);</span>
<a href="#l3.251"></a><span id="l3.251" class="difflineplus">+      if (item &amp;&amp; item.uploading)</span>
<a href="#l3.252"></a><span id="l3.252" class="difflineplus">+        return true;</span>
<a href="#l3.253"></a><span id="l3.253" class="difflineplus">+    }</span>
<a href="#l3.254"></a><span id="l3.254" class="difflineplus">+    return false;</span>
<a href="#l3.255"></a><span id="l3.255" class="difflineplus">+  },</span>
<a href="#l3.256"></a><span id="l3.256" class="difflineplus">+</span>
<a href="#l3.257"></a><span id="l3.257"> };</span>
<a href="#l3.258"></a><span id="l3.258"> </span>
<a href="#l3.259"></a><span id="l3.259"> document.documentElement.addEventListener(&quot;compose-window-init&quot;,</span>
<a href="#l3.260"></a><span id="l3.260">   gBigFileObserver.init.bind(gBigFileObserver), false);</span>
<a href="#l3.261"></a><span id="l3.261"> document.documentElement.addEventListener(&quot;compose-window-close&quot;,</span>
<a href="#l3.262"></a><span id="l3.262">   gBigFileObserver.uninit.bind(gBigFileObserver), false);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">new file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- /dev/null</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ b/mail/test/mozmill/cloudfile/data/testFile4</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -0,0 +1,1 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineplus">+Ullamco farm-to-table banh mi, echo park dolor lomo chillwave seitan cred ad mustache 3 wolf moon excepteur. Odd future placeat sint, cliche consequat portland banksy vinyl 3 wolf moon high life you probably haven't heard of them nisi jean shorts. Eu freegan skateboard, kogi etsy beard aliquip blog sapiente pour-over sunt. Cosby sweater jean shorts wayfarers keytar trust fund, four loko pitchfork pinterest forage semiotics lo-fi cray beard swag butcher. Odd future cred swag, pork belly keytar velit terry richardson locavore id brunch excepteur commodo occupy mollit pickled. Street art voluptate pickled fap, ad craft beer cupidatat messenger bag placeat helvetica. Enim raw denim occupy pork belly irure et.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -9,52 +9,95 @@</span>
<a href="#l5.4"></a><span id="l5.4"> let Cu = Components.utils;</span>
<a href="#l5.5"></a><span id="l5.5"> let Cc = Components.classes;</span>
<a href="#l5.6"></a><span id="l5.6"> let Ci = Components.interfaces;</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8"> let MODULE_NAME = 'test-cloudfile-notifications';</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10"> let RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l5.11"></a><span id="l5.11"> let MODULE_REQUIRES = ['folder-display-helpers',</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-                       'compose-helpers'];</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+                       'compose-helpers',</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+                       'cloudfile-helpers',</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+                       'attachment-helpers',</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+                       'prompt-helpers'];</span>
<a href="#l5.17"></a><span id="l5.17"> </span>
<a href="#l5.18"></a><span id="l5.18"> let controller = {};</span>
<a href="#l5.19"></a><span id="l5.19"> let mozmill = {};</span>
<a href="#l5.20"></a><span id="l5.20"> let elib = {};</span>
<a href="#l5.21"></a><span id="l5.21"> Cu.import('resource://mozmill/modules/controller.js', controller);</span>
<a href="#l5.22"></a><span id="l5.22"> Cu.import('resource://mozmill/modules/mozmill.js', mozmill);</span>
<a href="#l5.23"></a><span id="l5.23"> Cu.import('resource://mozmill/modules/elementslib.js', elib);</span>
<a href="#l5.24"></a><span id="l5.24"> Cu.import('resource://gre/modules/Services.jsm');</span>
<a href="#l5.25"></a><span id="l5.25"> </span>
<a href="#l5.26"></a><span id="l5.26" class="difflineminus">-let maxSize;</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+let maxSize, cfh, ah, oldInsertNotificationPref;</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+const kInsertNotificationPref = &quot;mail.compose.big_attachments.insert_notification&quot;;</span>
<a href="#l5.30"></a><span id="l5.30"> </span>
<a href="#l5.31"></a><span id="l5.31"> function setupModule(module) {</span>
<a href="#l5.32"></a><span id="l5.32">   let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l5.33"></a><span id="l5.33">   fdh.installInto(module);</span>
<a href="#l5.34"></a><span id="l5.34"> </span>
<a href="#l5.35"></a><span id="l5.35">   let ch = collector.getModule('compose-helpers');</span>
<a href="#l5.36"></a><span id="l5.36">   ch.installInto(module);</span>
<a href="#l5.37"></a><span id="l5.37"> </span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+  cfh = collector.getModule('cloudfile-helpers');</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+  cfh.installInto(module);</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+  cfh.gMockCloudfileManager.register();</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+  ah = collector.getModule('attachment-helpers');</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineplus">+  ah.installInto(module);</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+  ah.gMockFilePickReg.register();</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+  collector.getModule('prompt-helpers').installInto(module);</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+</span>
<a href="#l5.48"></a><span id="l5.48">   maxSize = Services.prefs</span>
<a href="#l5.49"></a><span id="l5.49">                     .getIntPref(&quot;mail.compose.big_attachments.threshold_kb&quot;,</span>
<a href="#l5.50"></a><span id="l5.50">                                 0) * 1024;</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+  oldInsertNotificationPref = Services.prefs</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+                                      .getBoolPref(kInsertNotificationPref);</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+  Services.prefs.setBoolPref(kInsertNotificationPref, true);</span>
<a href="#l5.54"></a><span id="l5.54"> };</span>
<a href="#l5.55"></a><span id="l5.55"> </span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+function teardownModule(module) {</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+  cfh.gMockCloudfileManager.unregister();</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+  ah.gMockFilePickReg.unregister();</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+  Services.prefs.setBoolPref(kInsertNotificationPref,</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+                             oldInsertNotificationPref);</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+}</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+/**</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+ * A helper function to assert that the Filelink offer notification is</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineplus">+ * either displayed or not displayed.</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+ *</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+ * @param aController the controller of the compose window to check.</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+ * @param aDisplayed true if the notification should be displayed, false</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+ *                   otherwise.</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineplus">+ */</span>
<a href="#l5.71"></a><span id="l5.71"> function assert_cloudfile_notification_displayed(aController, aDisplayed) {</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineminus">-  let nb = aController.window</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineminus">-                      .document</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineminus">-                      .getElementById(&quot;attachmentNotificationBox&quot;);</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineminus">-  let hasNotification = false;</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+  assert_notification_displayed(aController, &quot;bigAttachment&quot;, aDisplayed);</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineplus">+}</span>
<a href="#l5.78"></a><span id="l5.78"> </span>
<a href="#l5.79"></a><span id="l5.79" class="difflineminus">-  if (nb.getNotificationWithValue(&quot;bigAttachment&quot;))</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineminus">-    hasNotification = true;</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+/**</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineplus">+ * A helper function to assert that the Filelink upload notification is</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineplus">+ * either displayed or not displayed.</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineplus">+ *</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineplus">+ * @param aController the controller of the compose window to check.</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+ * @param aDisplayed true if the notification should be displayed, false</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+ *                   otherwise.</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineplus">+ */</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+function assert_upload_notification_displayed(aController, aDisplayed) {</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineplus">+  assert_notification_displayed(aController, &quot;bigAttachmentUploading&quot;,</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineplus">+                                aDisplayed);</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineplus">+}</span>
<a href="#l5.93"></a><span id="l5.93"> </span>
<a href="#l5.94"></a><span id="l5.94" class="difflineminus">-  assert_equals(hasNotification, aDisplayed,</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineminus">-                &quot;Expected the notification to be &quot; +</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineminus">-                (aDisplayed ? &quot;shown&quot; : &quot;not shown&quot;));</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineplus">+/**</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineplus">+ * A helper function to close the Filelink upload notification.</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineplus">+ */</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineplus">+function close_upload_notification(aController) {</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineplus">+  close_notification(aController, &quot;bigAttachmentUploading&quot;);</span>
<a href="#l5.102"></a><span id="l5.102"> }</span>
<a href="#l5.103"></a><span id="l5.103"> </span>
<a href="#l5.104"></a><span id="l5.104"> function test_no_notification_for_small_file() {</span>
<a href="#l5.105"></a><span id="l5.105">   let cwc = open_compose_new_mail(mc);</span>
<a href="#l5.106"></a><span id="l5.106">   add_attachments(cwc, &quot;http://www.example.com/1&quot;, 0);</span>
<a href="#l5.107"></a><span id="l5.107">   assert_cloudfile_notification_displayed(cwc, false);</span>
<a href="#l5.108"></a><span id="l5.108"> </span>
<a href="#l5.109"></a><span id="l5.109">   add_attachments(cwc, &quot;http://www.example.com/2&quot;, 1);</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineat">@@ -107,8 +150,81 @@ function test_no_notification_if_disable</span>
<a href="#l5.111"></a><span id="l5.111">   add_attachments(cwc, &quot;http://www.example.com/3&quot;, maxSize + 10000);</span>
<a href="#l5.112"></a><span id="l5.112">   assert_cloudfile_notification_displayed(cwc, false);</span>
<a href="#l5.113"></a><span id="l5.113"> </span>
<a href="#l5.114"></a><span id="l5.114">   add_attachments(cwc, &quot;http://www.example.com/4&quot;, maxSize + 100000);</span>
<a href="#l5.115"></a><span id="l5.115">   assert_cloudfile_notification_displayed(cwc, false);</span>
<a href="#l5.116"></a><span id="l5.116"> </span>
<a href="#l5.117"></a><span id="l5.117">   Services.prefs.setBoolPref(&quot;mail.cloud_files.enabled&quot;, true);</span>
<a href="#l5.118"></a><span id="l5.118"> }</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineplus">+</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineplus">+/**</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineplus">+ * Tests that if we upload a single file, we get the link insertion</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineplus">+ * notification bar displayed (unless preffed off).</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineplus">+ */</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineplus">+function test_link_insertion_notification_single() {</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineplus">+  gMockFilePicker.returnFiles = collectFiles(['./data/testFile1'], __file__);</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineplus">+  let provider = new MockCloudfileAccount();</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineplus">+  provider.init(&quot;aKey&quot;);</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineplus">+</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineplus">+  let cwc = open_compose_new_mail(mc);</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineplus">+  cwc.window.attachToCloud(provider);</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineplus">+</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineplus">+  assert_upload_notification_displayed(cwc, true);</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineplus">+  close_upload_notification(cwc);</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineplus">+</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineplus">+  Services.prefs.setBoolPref(kInsertNotificationPref, false);</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineplus">+  gMockFilePicker.returnFiles = collectFiles(['./data/testFile2'], __file__);</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineplus">+  cwc.window.attachToCloud(provider);</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineplus">+  assert_upload_notification_displayed(cwc, false);</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineplus">+  Services.prefs.setBoolPref(kInsertNotificationPref, true);</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineplus">+}</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineplus">+</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineplus">+/**</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineplus">+ * Tests that if we upload multiple files, we get the link insertion</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineplus">+ * notification bar displayed (unless preffed off).</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineplus">+ */</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineplus">+function test_link_insertion_notification_multiple() {</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineplus">+  gMockFilePicker.returnFiles = collectFiles(['./data/testFile1',</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineplus">+                                              './data/testFile2'], __file__);</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineplus">+  let provider = new MockCloudfileAccount();</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineplus">+  provider.init(&quot;aKey&quot;);</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineplus">+</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineplus">+  let cwc = open_compose_new_mail(mc);</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineplus">+  cwc.window.attachToCloud(provider);</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineplus">+</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineplus">+  assert_upload_notification_displayed(cwc, true);</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineplus">+  close_upload_notification(cwc);</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineplus">+</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineplus">+  Services.prefs.setBoolPref(kInsertNotificationPref, false);</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineplus">+  gMockFilePicker.returnFiles = collectFiles(['./data/testFile3',</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineplus">+                                              './data/testFile4'], __file__);</span>
<a href="#l5.161"></a><span id="l5.161" class="difflineplus">+  cwc.window.attachToCloud(provider);</span>
<a href="#l5.162"></a><span id="l5.162" class="difflineplus">+  assert_upload_notification_displayed(cwc, false);</span>
<a href="#l5.163"></a><span id="l5.163" class="difflineplus">+  Services.prefs.setBoolPref(kInsertNotificationPref, true);</span>
<a href="#l5.164"></a><span id="l5.164" class="difflineplus">+}</span>
<a href="#l5.165"></a><span id="l5.165" class="difflineplus">+</span>
<a href="#l5.166"></a><span id="l5.166" class="difflineplus">+/**</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineplus">+ * Tests that the link insertion notification bar goes away even</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineplus">+ * if we hit an uploading error.</span>
<a href="#l5.169"></a><span id="l5.169" class="difflineplus">+ */</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineplus">+function test_link_insertion_goes_away_on_error() {</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineplus">+  gMockPromptService.register();</span>
<a href="#l5.172"></a><span id="l5.172" class="difflineplus">+  gMockPromptService.returnValue = false;</span>
<a href="#l5.173"></a><span id="l5.173" class="difflineplus">+  gMockFilePicker.returnFiles = collectFiles(['./data/testFile1',</span>
<a href="#l5.174"></a><span id="l5.174" class="difflineplus">+                                              './data/testFile2'], __file__);</span>
<a href="#l5.175"></a><span id="l5.175" class="difflineplus">+  let provider = new MockCloudfileAccount();</span>
<a href="#l5.176"></a><span id="l5.176" class="difflineplus">+  provider.init(&quot;aKey&quot;);</span>
<a href="#l5.177"></a><span id="l5.177" class="difflineplus">+</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineplus">+  provider.uploadFile = function(aFile, aListener) {</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineplus">+    aListener.onStartRequest(null, null);</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineplus">+    cwc.window.setTimeout(function() {</span>
<a href="#l5.181"></a><span id="l5.181" class="difflineplus">+      aListener.onStopRequest(null, null,</span>
<a href="#l5.182"></a><span id="l5.182" class="difflineplus">+                              Ci.nsIMsgCloudFileProvider.uploadErr);</span>
<a href="#l5.183"></a><span id="l5.183" class="difflineplus">+    }, 500);</span>
<a href="#l5.184"></a><span id="l5.184" class="difflineplus">+  }</span>
<a href="#l5.185"></a><span id="l5.185" class="difflineplus">+  let cwc = open_compose_new_mail(mc);</span>
<a href="#l5.186"></a><span id="l5.186" class="difflineplus">+  cwc.window.attachToCloud(provider);</span>
<a href="#l5.187"></a><span id="l5.187" class="difflineplus">+</span>
<a href="#l5.188"></a><span id="l5.188" class="difflineplus">+  assert_upload_notification_displayed(cwc, true);</span>
<a href="#l5.189"></a><span id="l5.189" class="difflineplus">+  wait_for_notification_to_stop(cwc, &quot;bigAttachmentUploading&quot;);</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineplus">+  gMockPromptService.unregister();</span>
<a href="#l5.191"></a><span id="l5.191" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -107,16 +107,20 @@ MockCloudfileAccount.prototype = {</span>
<a href="#l6.4"></a><span id="l6.4">                                                 aCallback) {</span>
<a href="#l6.5"></a><span id="l6.5">     aCallback.onStartRequest(null, null);</span>
<a href="#l6.6"></a><span id="l6.6">     aCallback.onStopRequest(null, null, Cr.NS_OK);</span>
<a href="#l6.7"></a><span id="l6.7">   },</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9">   cancelFileUpload: function MCA_cancelFileUpload(aFile) {</span>
<a href="#l6.10"></a><span id="l6.10">     throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l6.11"></a><span id="l6.11">   },</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+  providerUrlForError: function MCA_providerUrlForError(aStatusCode) {</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+    return &quot;&quot;;</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+  },</span>
<a href="#l6.16"></a><span id="l6.16"> };</span>
<a href="#l6.17"></a><span id="l6.17"> </span>
<a href="#l6.18"></a><span id="l6.18"> </span>
<a href="#l6.19"></a><span id="l6.19"> var gMockCloudfileManager = {</span>
<a href="#l6.20"></a><span id="l6.20">   _mock_map: {},</span>
<a href="#l6.21"></a><span id="l6.21"> </span>
<a href="#l6.22"></a><span id="l6.22">   register: function MCM_register() {</span>
<a href="#l6.23"></a><span id="l6.23">     gCategoryManager.addCategoryEntry(&quot;cloud-files&quot;, kMockID, kMockContractID,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-compose-helpers.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-compose-helpers.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -81,16 +81,20 @@ function installInto(module) {</span>
<a href="#l7.4"></a><span id="l7.4">   module.wait_for_compose_window = wait_for_compose_window;</span>
<a href="#l7.5"></a><span id="l7.5">   module.create_msg_attachment = create_msg_attachment;</span>
<a href="#l7.6"></a><span id="l7.6">   module.add_attachments = add_attachments;</span>
<a href="#l7.7"></a><span id="l7.7">   module.add_attachment = add_attachments;</span>
<a href="#l7.8"></a><span id="l7.8">   module.delete_attachment = delete_attachment;</span>
<a href="#l7.9"></a><span id="l7.9">   module.get_compose_body = get_compose_body;</span>
<a href="#l7.10"></a><span id="l7.10">   module.type_in_composer = type_in_composer;</span>
<a href="#l7.11"></a><span id="l7.11">   module.assert_previous_text = assert_previous_text;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+  module.assert_notification_displayed = assert_notification_displayed;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+  module.close_notification = close_notification;</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+  module.wait_for_notification_to_stop = wait_for_notification_to_stop;</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+  module.wait_for_notification_to_show = wait_for_notification_to_show;</span>
<a href="#l7.16"></a><span id="l7.16"> }</span>
<a href="#l7.17"></a><span id="l7.17"> </span>
<a href="#l7.18"></a><span id="l7.18"> /**</span>
<a href="#l7.19"></a><span id="l7.19">  * Opens the compose window by starting a new message</span>
<a href="#l7.20"></a><span id="l7.20">  *</span>
<a href="#l7.21"></a><span id="l7.21">  * @param aController the controller for the mail:3pane from which to spawn</span>
<a href="#l7.22"></a><span id="l7.22">  *                    the compose window.  If left blank, defaults to mc.</span>
<a href="#l7.23"></a><span id="l7.23">  *</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineat">@@ -307,16 +311,93 @@ function delete_attachment(aComposeWindo</span>
<a href="#l7.25"></a><span id="l7.25">   let bucket = aComposeWindow.e('attachmentBucket');</span>
<a href="#l7.26"></a><span id="l7.26">   let node = bucket.getElementsByTagName('attachmentitem')[aIndex];</span>
<a href="#l7.27"></a><span id="l7.27"> </span>
<a href="#l7.28"></a><span id="l7.28">   aComposeWindow.click(new elib.Elem(node));</span>
<a href="#l7.29"></a><span id="l7.29">   aComposeWindow.window.RemoveSelectedAttachment();</span>
<a href="#l7.30"></a><span id="l7.30"> }</span>
<a href="#l7.31"></a><span id="l7.31"> </span>
<a href="#l7.32"></a><span id="l7.32"> /**</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+ * A helper function for determining whether or not a notification with</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+ * a particular value is being displayed in the composer window.</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+ *</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+ * @param aController the controller of the compose window to check</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+ * @param aValue the value of the notification to look for.</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+ * @param aDisplayed true if the notification should be displayed, false</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+ *                   otherwise.</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+ */</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+function assert_notification_displayed(aController, aValue, aDisplayed) {</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+  let nb = aController.window</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+                      .document</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+                      .getElementById(&quot;attachmentNotificationBox&quot;);</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+  let hasNotification = false;</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+  if (nb.getNotificationWithValue(aValue))</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+    hasNotification = true;</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+  if (hasNotification != aDisplayed)</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+    throw new Error(&quot;Expected the notification with value &quot; + aValue +</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+                    &quot; to be &quot; + (aDisplayed ? &quot;shown&quot; : &quot;not shown&quot;));</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+}</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+/**</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+ * A helper function for closing a notification in the compose window if</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+ * one is currently displayed.</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+ *</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+ * @param aController the controller for the compose window with</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+ *                    the notification.</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+ * @param aValue the value of the notification to close.</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+ */</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+function close_notification(aController, aValue) {</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+  let nb = aController.window</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+                      .document</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+                      .getElementById(&quot;attachmentNotificationBox&quot;);</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+  let notification = nb.getNotificationWithValue(aValue);</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+  if (notification)</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+    notification.close();</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+}</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+/**</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+ * A helper function that waits for a notification with value aValue</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+ * to stop displaying in the compose window.</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+ *</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+ * @param aController the controller for the compose window with the</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+ *                    notification.</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+ * @param aValue the value of the notification to wait to stop.</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+ */</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+function wait_for_notification_to_stop(aController, aValue) {</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineplus">+  let nb = aController.window</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineplus">+                      .document</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineplus">+                      .getElementById(&quot;attachmentNotificationBox&quot;);</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+  aController.waitFor(function() !nb.getNotificationWithValue(aValue),</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+                      &quot;Timed out waiting for notification with value &quot; +</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+                      aValue + &quot; to stop.&quot;);</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+}</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineplus">+</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+/**</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+ * A helper function that waits for a notification with value aValue</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+ * to show in the compose window.</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+ *</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+ * @param aController the controller for the compose window that we want</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+ *                    the notification to appear in.</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineplus">+ * @param aValue the value of the notification to wait for.</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineplus">+ */</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+function wait_for_notification_to_show(aController, aValue) {</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineplus">+  let nb = aController.window</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineplus">+                      .document</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineplus">+                      .getElementById(&quot;attachmentNotificationBox&quot;);</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineplus">+</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineplus">+  aController.waitFor(function() nb.getNotificationWithValue(aValue),</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineplus">+                      &quot;Timed out waiting for notification with value &quot; +</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineplus">+                      aValue + &quot; to show.&quot;);</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineplus">+}</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineplus">+</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineplus">+/**</span>
<a href="#l7.110"></a><span id="l7.110">  * Helper function returns the message body element of a composer window.</span>
<a href="#l7.111"></a><span id="l7.111">  *</span>
<a href="#l7.112"></a><span id="l7.112">  * @param aController the controller for a compose window.</span>
<a href="#l7.113"></a><span id="l7.113">  */</span>
<a href="#l7.114"></a><span id="l7.114"> function get_compose_body(aController) {</span>
<a href="#l7.115"></a><span id="l7.115">   let mailDoc = aController.e(&quot;content-frame&quot;).contentDocument;</span>
<a href="#l7.116"></a><span id="l7.116">   return mailDoc.querySelector(&quot;body&quot;);</span>
<a href="#l7.117"></a><span id="l7.117"> }</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

