<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 26422:9d2f71d5e74d14a10a5432b7a17fe6949964ca90</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 9d2f71d5e74d14a10a5432b7a17fe6949964ca90" />
<meta property="og:url" content="/comm-central/rev/9d2f71d5e74d14a10a5432b7a17fe6949964ca90" />
<meta property="og:description" content="Bug 1546364 - Reformat to Google coding style in mailnews/import. rs=reformat" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 9d2f71d5e74d14a10a5432b7a17fe6949964ca90 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/9d2f71d5e74d14a10a5432b7a17fe6949964ca90">shortlog</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/9d2f71d5e74d14a10a5432b7a17fe6949964ca90">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90">files</a> |
changeset |
<a href="/comm-central/raw-rev/9d2f71d5e74d14a10a5432b7a17fe6949964ca90">raw</a>  | <a href="/comm-central/archive/9d2f71d5e74d14a10a5432b7a17fe6949964ca90.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">Bug 1546364</a> - Reformat to Google coding style in mailnews/import. rs=reformat
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#114;&#103;&#32;&#75;&#32;&#60;&#106;&#111;&#114;&#103;&#107;&#64;&#106;&#111;&#114;&#103;&#107;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 24 Apr 2019 10:02:35 +0200</td></tr>

<tr>
 <td>changeset 26422</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/9d2f71d5e74d14a10a5432b7a17fe6949964ca90">9d2f71d5e74d14a10a5432b7a17fe6949964ca90</a></td>
</tr>



<tr>
<td>parent 26421</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/bca950c87a074a65e00c0894937c46b3b644ee5e">bca950c87a074a65e00c0894937c46b3b644ee5e</a>
</td>
</tr>

<tr>
<td>child 26423</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/1b6a82d5c4918390440771b9c37cbdaf0e7d6f24">1b6a82d5c4918390440771b9c37cbdaf0e7d6f24</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=9d2f71d5e74d14a10a5432b7a17fe6949964ca90">15829</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Wed, 24 Apr 2019 08:37:09 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@4965f8d61f03 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=4965f8d61f03bad242a90df92454e5fd52763f4f">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=4965f8d61f03bad242a90df92454e5fd52763f4f&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4965f8d61f03bad242a90df92454e5fd52763f4f&newProject=comm-central&newRevision=a7efaecb39ccf179d84a3375da8609698435ef58&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4965f8d61f03bad242a90df92454e5fd52763f4f&newProject=comm-central&newRevision=a7efaecb39ccf179d84a3375da8609698435ef58&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=4965f8d61f03bad242a90df92454e5fd52763f4f&newProject=comm-central&newRevision=a7efaecb39ccf179d84a3375da8609698435ef58&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28reformat%29&revcount=50">reformat</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">1546364</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">Bug 1546364</a> - Reformat to Google coding style in mailnews/import. rs=reformat
# ignore-this-changeset</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/applemail/src/nsAppleMailImport.cpp">mailnews/import/applemail/src/nsAppleMailImport.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/applemail/src/nsAppleMailImport.cpp">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/applemail/src/nsAppleMailImport.cpp">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/applemail/src/nsAppleMailImport.cpp">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/applemail/src/nsAppleMailImport.cpp">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/applemail/src/nsAppleMailImport.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/applemail/src/nsAppleMailImport.h">mailnews/import/applemail/src/nsAppleMailImport.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/applemail/src/nsAppleMailImport.h">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/applemail/src/nsAppleMailImport.h">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/applemail/src/nsAppleMailImport.h">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/applemail/src/nsAppleMailImport.h">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/applemail/src/nsAppleMailImport.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/applemail/src/nsEmlxHelperUtils.h">mailnews/import/applemail/src/nsEmlxHelperUtils.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/applemail/src/nsEmlxHelperUtils.h">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/applemail/src/nsEmlxHelperUtils.h">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/applemail/src/nsEmlxHelperUtils.h">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/applemail/src/nsEmlxHelperUtils.h">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/applemail/src/nsEmlxHelperUtils.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/applemail/src/nsEmlxHelperUtils.mm">mailnews/import/applemail/src/nsEmlxHelperUtils.mm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/applemail/src/nsEmlxHelperUtils.mm">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/applemail/src/nsEmlxHelperUtils.mm">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/applemail/src/nsEmlxHelperUtils.mm">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/applemail/src/nsEmlxHelperUtils.mm">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/applemail/src/nsEmlxHelperUtils.mm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyAddressBooks.cpp">mailnews/import/becky/src/nsBeckyAddressBooks.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyAddressBooks.cpp">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyAddressBooks.cpp">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyAddressBooks.cpp">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyAddressBooks.cpp">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyAddressBooks.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyAddressBooks.h">mailnews/import/becky/src/nsBeckyAddressBooks.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyAddressBooks.h">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyAddressBooks.h">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyAddressBooks.h">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyAddressBooks.h">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyAddressBooks.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyFilters.cpp">mailnews/import/becky/src/nsBeckyFilters.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyFilters.cpp">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyFilters.cpp">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyFilters.cpp">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyFilters.cpp">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyFilters.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyFilters.h">mailnews/import/becky/src/nsBeckyFilters.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyFilters.h">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyFilters.h">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyFilters.h">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyFilters.h">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyFilters.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyImport.cpp">mailnews/import/becky/src/nsBeckyImport.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyImport.cpp">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyImport.cpp">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyImport.cpp">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyImport.cpp">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyImport.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyImport.h">mailnews/import/becky/src/nsBeckyImport.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyImport.h">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyImport.h">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyImport.h">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyImport.h">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyImport.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyMail.cpp">mailnews/import/becky/src/nsBeckyMail.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyMail.cpp">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyMail.cpp">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyMail.cpp">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyMail.cpp">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyMail.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyMail.h">mailnews/import/becky/src/nsBeckyMail.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyMail.h">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyMail.h">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyMail.h">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyMail.h">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyMail.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckySettings.cpp">mailnews/import/becky/src/nsBeckySettings.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckySettings.cpp">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckySettings.cpp">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckySettings.cpp">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckySettings.cpp">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckySettings.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckySettings.h">mailnews/import/becky/src/nsBeckySettings.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckySettings.h">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckySettings.h">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckySettings.h">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckySettings.h">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckySettings.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyStringBundle.cpp">mailnews/import/becky/src/nsBeckyStringBundle.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyStringBundle.cpp">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyStringBundle.cpp">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyStringBundle.cpp">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyStringBundle.cpp">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyStringBundle.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyStringBundle.h">mailnews/import/becky/src/nsBeckyStringBundle.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyStringBundle.h">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyStringBundle.h">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyStringBundle.h">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyStringBundle.h">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyStringBundle.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyUtils.cpp">mailnews/import/becky/src/nsBeckyUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyUtils.cpp">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyUtils.cpp">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyUtils.cpp">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyUtils.cpp">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyUtils.h">mailnews/import/becky/src/nsBeckyUtils.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyUtils.h">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyUtils.h">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyUtils.h">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyUtils.h">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/becky/src/nsBeckyUtils.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/build/nsImportModule.cpp">mailnews/import/build/nsImportModule.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/build/nsImportModule.cpp">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/build/nsImportModule.cpp">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/build/nsImportModule.cpp">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/build/nsImportModule.cpp">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/build/nsImportModule.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiApi.cpp">mailnews/import/outlook/src/MapiApi.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiApi.cpp">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiApi.cpp">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiApi.cpp">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiApi.cpp">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiApi.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiApi.h">mailnews/import/outlook/src/MapiApi.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiApi.h">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiApi.h">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiApi.h">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiApi.h">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiApi.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiDbgLog.h">mailnews/import/outlook/src/MapiDbgLog.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiDbgLog.h">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiDbgLog.h">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiDbgLog.h">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiDbgLog.h">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiDbgLog.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiMessage.cpp">mailnews/import/outlook/src/MapiMessage.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiMessage.cpp">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiMessage.cpp">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiMessage.cpp">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiMessage.cpp">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiMessage.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiMessage.h">mailnews/import/outlook/src/MapiMessage.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiMessage.h">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiMessage.h">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiMessage.h">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiMessage.h">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiMessage.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiMimeTypes.cpp">mailnews/import/outlook/src/MapiMimeTypes.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiMimeTypes.cpp">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiMimeTypes.cpp">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiMimeTypes.cpp">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiMimeTypes.cpp">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiMimeTypes.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiMimeTypes.h">mailnews/import/outlook/src/MapiMimeTypes.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiMimeTypes.h">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiMimeTypes.h">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiMimeTypes.h">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiMimeTypes.h">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiMimeTypes.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiTagStrs.cpp">mailnews/import/outlook/src/MapiTagStrs.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiTagStrs.cpp">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiTagStrs.cpp">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiTagStrs.cpp">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiTagStrs.cpp">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/MapiTagStrs.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookCompose.cpp">mailnews/import/outlook/src/nsOutlookCompose.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookCompose.cpp">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookCompose.cpp">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookCompose.cpp">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookCompose.cpp">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookCompose.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookCompose.h">mailnews/import/outlook/src/nsOutlookCompose.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookCompose.h">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookCompose.h">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookCompose.h">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookCompose.h">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookCompose.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookImport.cpp">mailnews/import/outlook/src/nsOutlookImport.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookImport.cpp">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookImport.cpp">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookImport.cpp">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookImport.cpp">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookImport.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookImport.h">mailnews/import/outlook/src/nsOutlookImport.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookImport.h">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookImport.h">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookImport.h">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookImport.h">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookImport.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookMail.cpp">mailnews/import/outlook/src/nsOutlookMail.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookMail.cpp">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookMail.cpp">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookMail.cpp">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookMail.cpp">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookMail.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookMail.h">mailnews/import/outlook/src/nsOutlookMail.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookMail.h">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookMail.h">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookMail.h">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookMail.h">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookMail.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookSettings.cpp">mailnews/import/outlook/src/nsOutlookSettings.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookSettings.cpp">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookSettings.cpp">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookSettings.cpp">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookSettings.cpp">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookSettings.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookSettings.h">mailnews/import/outlook/src/nsOutlookSettings.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookSettings.h">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookSettings.h">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookSettings.h">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookSettings.h">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookSettings.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookStringBundle.cpp">mailnews/import/outlook/src/nsOutlookStringBundle.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookStringBundle.cpp">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookStringBundle.cpp">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookStringBundle.cpp">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookStringBundle.cpp">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookStringBundle.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookStringBundle.h">mailnews/import/outlook/src/nsOutlookStringBundle.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookStringBundle.h">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookStringBundle.h">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookStringBundle.h">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookStringBundle.h">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/nsOutlookStringBundle.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/rtfDecoder.cpp">mailnews/import/outlook/src/rtfDecoder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/rtfDecoder.cpp">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/rtfDecoder.cpp">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/rtfDecoder.cpp">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/rtfDecoder.cpp">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/rtfDecoder.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/rtfDecoder.h">mailnews/import/outlook/src/rtfDecoder.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/rtfDecoder.h">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/rtfDecoder.h">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/rtfDecoder.h">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/rtfDecoder.h">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/rtfDecoder.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/rtfMailDecoder.cpp">mailnews/import/outlook/src/rtfMailDecoder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/rtfMailDecoder.cpp">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/rtfMailDecoder.cpp">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/rtfMailDecoder.cpp">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/rtfMailDecoder.cpp">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/rtfMailDecoder.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/rtfMailDecoder.h">mailnews/import/outlook/src/rtfMailDecoder.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/rtfMailDecoder.h">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/rtfMailDecoder.h">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/rtfMailDecoder.h">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/rtfMailDecoder.h">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/outlook/src/rtfMailDecoder.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/ImportCharSet.cpp">mailnews/import/src/ImportCharSet.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/ImportCharSet.cpp">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/ImportCharSet.cpp">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/ImportCharSet.cpp">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/ImportCharSet.cpp">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/ImportCharSet.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/ImportCharSet.h">mailnews/import/src/ImportCharSet.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/ImportCharSet.h">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/ImportCharSet.h">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/ImportCharSet.h">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/ImportCharSet.h">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/ImportCharSet.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/ImportDebug.h">mailnews/import/src/ImportDebug.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/ImportDebug.h">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/ImportDebug.h">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/ImportDebug.h">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/ImportDebug.h">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/ImportDebug.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/ImportOutFile.cpp">mailnews/import/src/ImportOutFile.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/ImportOutFile.cpp">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/ImportOutFile.cpp">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/ImportOutFile.cpp">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/ImportOutFile.cpp">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/ImportOutFile.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/ImportOutFile.h">mailnews/import/src/ImportOutFile.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/ImportOutFile.h">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/ImportOutFile.h">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/ImportOutFile.h">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/ImportOutFile.h">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/ImportOutFile.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/ImportTranslate.cpp">mailnews/import/src/ImportTranslate.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/ImportTranslate.cpp">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/ImportTranslate.cpp">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/ImportTranslate.cpp">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/ImportTranslate.cpp">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/ImportTranslate.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/ImportTranslate.h">mailnews/import/src/ImportTranslate.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/ImportTranslate.h">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/ImportTranslate.h">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/ImportTranslate.h">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/ImportTranslate.h">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/ImportTranslate.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportABDescriptor.cpp">mailnews/import/src/nsImportABDescriptor.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportABDescriptor.cpp">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportABDescriptor.cpp">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportABDescriptor.cpp">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportABDescriptor.cpp">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportABDescriptor.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportABDescriptor.h">mailnews/import/src/nsImportABDescriptor.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportABDescriptor.h">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportABDescriptor.h">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportABDescriptor.h">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportABDescriptor.h">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportABDescriptor.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportAddressBooks.cpp">mailnews/import/src/nsImportAddressBooks.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportAddressBooks.cpp">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportAddressBooks.cpp">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportAddressBooks.cpp">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportAddressBooks.cpp">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportAddressBooks.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportEmbeddedImageData.cpp">mailnews/import/src/nsImportEmbeddedImageData.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportEmbeddedImageData.cpp">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportEmbeddedImageData.cpp">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportEmbeddedImageData.cpp">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportEmbeddedImageData.cpp">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportEmbeddedImageData.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportEmbeddedImageData.h">mailnews/import/src/nsImportEmbeddedImageData.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportEmbeddedImageData.h">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportEmbeddedImageData.h">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportEmbeddedImageData.h">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportEmbeddedImageData.h">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportEmbeddedImageData.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportEncodeScan.cpp">mailnews/import/src/nsImportEncodeScan.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportEncodeScan.cpp">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportEncodeScan.cpp">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportEncodeScan.cpp">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportEncodeScan.cpp">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportEncodeScan.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportEncodeScan.h">mailnews/import/src/nsImportEncodeScan.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportEncodeScan.h">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportEncodeScan.h">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportEncodeScan.h">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportEncodeScan.h">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportEncodeScan.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportFieldMap.cpp">mailnews/import/src/nsImportFieldMap.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportFieldMap.cpp">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportFieldMap.cpp">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportFieldMap.cpp">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportFieldMap.cpp">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportFieldMap.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportFieldMap.h">mailnews/import/src/nsImportFieldMap.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportFieldMap.h">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportFieldMap.h">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportFieldMap.h">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportFieldMap.h">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportFieldMap.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportMail.cpp">mailnews/import/src/nsImportMail.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportMail.cpp">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportMail.cpp">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportMail.cpp">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportMail.cpp">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportMail.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportMailboxDescriptor.cpp">mailnews/import/src/nsImportMailboxDescriptor.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportMailboxDescriptor.cpp">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportMailboxDescriptor.cpp">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportMailboxDescriptor.cpp">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportMailboxDescriptor.cpp">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportMailboxDescriptor.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportMailboxDescriptor.h">mailnews/import/src/nsImportMailboxDescriptor.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportMailboxDescriptor.h">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportMailboxDescriptor.h">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportMailboxDescriptor.h">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportMailboxDescriptor.h">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportMailboxDescriptor.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportMimeEncode.cpp">mailnews/import/src/nsImportMimeEncode.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportMimeEncode.cpp">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportMimeEncode.cpp">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportMimeEncode.cpp">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportMimeEncode.cpp">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportMimeEncode.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportMimeEncode.h">mailnews/import/src/nsImportMimeEncode.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportMimeEncode.h">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportMimeEncode.h">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportMimeEncode.h">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportMimeEncode.h">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportMimeEncode.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportScanFile.cpp">mailnews/import/src/nsImportScanFile.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportScanFile.cpp">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportScanFile.cpp">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportScanFile.cpp">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportScanFile.cpp">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportScanFile.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportScanFile.h">mailnews/import/src/nsImportScanFile.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportScanFile.h">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportScanFile.h">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportScanFile.h">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportScanFile.h">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportScanFile.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportService.cpp">mailnews/import/src/nsImportService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportService.cpp">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportService.cpp">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportService.cpp">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportService.cpp">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportService.h">mailnews/import/src/nsImportService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportService.h">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportService.h">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportService.h">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportService.h">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportService.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportStringBundle.cpp">mailnews/import/src/nsImportStringBundle.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportStringBundle.cpp">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportStringBundle.cpp">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportStringBundle.cpp">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportStringBundle.cpp">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportStringBundle.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportStringBundle.h">mailnews/import/src/nsImportStringBundle.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportStringBundle.h">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportStringBundle.h">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportStringBundle.h">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportStringBundle.h">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportStringBundle.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportTranslator.cpp">mailnews/import/src/nsImportTranslator.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportTranslator.cpp">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportTranslator.cpp">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportTranslator.cpp">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportTranslator.cpp">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportTranslator.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportTranslator.h">mailnews/import/src/nsImportTranslator.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportTranslator.h">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportTranslator.h">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportTranslator.h">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportTranslator.h">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/src/nsImportTranslator.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/text/src/nsTextAddress.cpp">mailnews/import/text/src/nsTextAddress.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/text/src/nsTextAddress.cpp">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/text/src/nsTextAddress.cpp">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/text/src/nsTextAddress.cpp">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/text/src/nsTextAddress.cpp">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/text/src/nsTextAddress.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/text/src/nsTextAddress.h">mailnews/import/text/src/nsTextAddress.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/text/src/nsTextAddress.h">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/text/src/nsTextAddress.h">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/text/src/nsTextAddress.h">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/text/src/nsTextAddress.h">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/text/src/nsTextAddress.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/text/src/nsTextImport.cpp">mailnews/import/text/src/nsTextImport.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/text/src/nsTextImport.cpp">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/text/src/nsTextImport.cpp">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/text/src/nsTextImport.cpp">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/text/src/nsTextImport.cpp">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/text/src/nsTextImport.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/text/src/nsTextImport.h">mailnews/import/text/src/nsTextImport.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/text/src/nsTextImport.h">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/text/src/nsTextImport.h">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/text/src/nsTextImport.h">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/text/src/nsTextImport.h">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/text/src/nsTextImport.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/vcard/src/nsVCardAddress.cpp">mailnews/import/vcard/src/nsVCardAddress.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/vcard/src/nsVCardAddress.cpp">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/vcard/src/nsVCardAddress.cpp">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/vcard/src/nsVCardAddress.cpp">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/vcard/src/nsVCardAddress.cpp">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/vcard/src/nsVCardAddress.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/vcard/src/nsVCardAddress.h">mailnews/import/vcard/src/nsVCardAddress.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/vcard/src/nsVCardAddress.h">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/vcard/src/nsVCardAddress.h">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/vcard/src/nsVCardAddress.h">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/vcard/src/nsVCardAddress.h">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/vcard/src/nsVCardAddress.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/vcard/src/nsVCardImport.cpp">mailnews/import/vcard/src/nsVCardImport.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/vcard/src/nsVCardImport.cpp">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/vcard/src/nsVCardImport.cpp">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/vcard/src/nsVCardImport.cpp">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/vcard/src/nsVCardImport.cpp">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/vcard/src/nsVCardImport.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/vcard/src/nsVCardImport.h">mailnews/import/vcard/src/nsVCardImport.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/vcard/src/nsVCardImport.h">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/vcard/src/nsVCardImport.h">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/vcard/src/nsVCardImport.h">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/vcard/src/nsVCardImport.h">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/vcard/src/nsVCardImport.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMImport.cpp">mailnews/import/winlivemail/nsWMImport.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMImport.cpp">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMImport.cpp">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMImport.cpp">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMImport.cpp">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMImport.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMImport.h">mailnews/import/winlivemail/nsWMImport.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMImport.h">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMImport.h">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMImport.h">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMImport.h">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMImport.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMSettings.cpp">mailnews/import/winlivemail/nsWMSettings.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMSettings.cpp">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMSettings.cpp">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMSettings.cpp">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMSettings.cpp">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMSettings.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMSettings.h">mailnews/import/winlivemail/nsWMSettings.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMSettings.h">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMSettings.h">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMSettings.h">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMSettings.h">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMSettings.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMStringBundle.cpp">mailnews/import/winlivemail/nsWMStringBundle.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMStringBundle.cpp">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMStringBundle.cpp">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMStringBundle.cpp">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMStringBundle.cpp">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMStringBundle.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMStringBundle.h">mailnews/import/winlivemail/nsWMStringBundle.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMStringBundle.h">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMStringBundle.h">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMStringBundle.h">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMStringBundle.h">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMStringBundle.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMUtils.cpp">mailnews/import/winlivemail/nsWMUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMUtils.cpp">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMUtils.cpp">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMUtils.cpp">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMUtils.cpp">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMUtils.h">mailnews/import/winlivemail/nsWMUtils.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMUtils.h">file</a> |
<a href="/comm-central/annotate/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMUtils.h">annotate</a> |
<a href="/comm-central/diff/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMUtils.h">diff</a> |
<a href="/comm-central/comparison/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMUtils.h">comparison</a> |
<a href="/comm-central/log/9d2f71d5e74d14a10a5432b7a17fe6949964ca90/mailnews/import/winlivemail/nsWMUtils.h">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/import/applemail/src/nsAppleMailImport.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/import/applemail/src/nsAppleMailImport.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -25,99 +25,94 @@</span>
<a href="#l1.4"></a><span id="l1.4"> #include &quot;nsIOutputStream.h&quot;</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6"> // some hard-coded strings</span>
<a href="#l1.7"></a><span id="l1.7"> #define DEFAULT_MAIL_FOLDER &quot;~/Library/Mail/&quot;</span>
<a href="#l1.8"></a><span id="l1.8"> #define POP_MBOX_SUFFIX &quot;.mbox&quot;</span>
<a href="#l1.9"></a><span id="l1.9"> #define IMAP_MBOX_SUFFIX &quot;.imapmbox&quot;</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11"> // stringbundle URI</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-#define APPLEMAIL_MSGS_URL &quot;chrome://messenger/locale/appleMailImportMsgs.properties&quot;</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+#define APPLEMAIL_MSGS_URL \</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+  &quot;chrome://messenger/locale/appleMailImportMsgs.properties&quot;</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16"> // magic constants</span>
<a href="#l1.17"></a><span id="l1.17"> #define kAccountMailboxID 1234</span>
<a href="#l1.18"></a><span id="l1.18"> </span>
<a href="#l1.19"></a><span id="l1.19" class="difflineminus">-nsAppleMailImportModule::nsAppleMailImportModule()</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineminus">-{</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+nsAppleMailImportModule::nsAppleMailImportModule() {</span>
<a href="#l1.22"></a><span id="l1.22">   IMPORT_LOG0(&quot;nsAppleMailImportModule Created&quot;);</span>
<a href="#l1.23"></a><span id="l1.23"> </span>
<a href="#l1.24"></a><span id="l1.24">   nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l1.27"></a><span id="l1.27">   if (bundleService)</span>
<a href="#l1.28"></a><span id="l1.28">     bundleService-&gt;CreateBundle(APPLEMAIL_MSGS_URL, getter_AddRefs(mBundle));</span>
<a href="#l1.29"></a><span id="l1.29"> }</span>
<a href="#l1.30"></a><span id="l1.30"> </span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-nsAppleMailImportModule::~nsAppleMailImportModule()</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-{</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+nsAppleMailImportModule::~nsAppleMailImportModule() {</span>
<a href="#l1.35"></a><span id="l1.35">   IMPORT_LOG0(&quot;nsAppleMailImportModule Deleted&quot;);</span>
<a href="#l1.36"></a><span id="l1.36"> }</span>
<a href="#l1.37"></a><span id="l1.37"> </span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-</span>
<a href="#l1.39"></a><span id="l1.39"> NS_IMPL_ISUPPORTS(nsAppleMailImportModule, nsIImportModule)</span>
<a href="#l1.40"></a><span id="l1.40"> </span>
<a href="#l1.41"></a><span id="l1.41" class="difflineminus">-</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">-NS_IMETHODIMP nsAppleMailImportModule::GetName(char16_t **aName)</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">-{</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+NS_IMETHODIMP nsAppleMailImportModule::GetName(char16_t **aName) {</span>
<a href="#l1.45"></a><span id="l1.45">   if (!mBundle) {</span>
<a href="#l1.46"></a><span id="l1.46">     return NS_ERROR_FAILURE;</span>
<a href="#l1.47"></a><span id="l1.47">   }</span>
<a href="#l1.48"></a><span id="l1.48">   nsAutoString name;</span>
<a href="#l1.49"></a><span id="l1.49">   nsresult rv = mBundle-&gt;GetStringFromName(&quot;ApplemailImportName&quot;, name);</span>
<a href="#l1.50"></a><span id="l1.50">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.51"></a><span id="l1.51">   *aName = ToNewUnicode(name);</span>
<a href="#l1.52"></a><span id="l1.52">   return rv;</span>
<a href="#l1.53"></a><span id="l1.53"> }</span>
<a href="#l1.54"></a><span id="l1.54"> </span>
<a href="#l1.55"></a><span id="l1.55" class="difflineminus">-NS_IMETHODIMP nsAppleMailImportModule::GetDescription(char16_t **aName)</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineminus">-{</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+NS_IMETHODIMP nsAppleMailImportModule::GetDescription(char16_t **aName) {</span>
<a href="#l1.58"></a><span id="l1.58">   if (!mBundle) {</span>
<a href="#l1.59"></a><span id="l1.59">     return NS_ERROR_FAILURE;</span>
<a href="#l1.60"></a><span id="l1.60">   }</span>
<a href="#l1.61"></a><span id="l1.61">   nsAutoString name;</span>
<a href="#l1.62"></a><span id="l1.62">   nsresult rv = mBundle-&gt;GetStringFromName(&quot;ApplemailImportDescription&quot;, name);</span>
<a href="#l1.63"></a><span id="l1.63">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.64"></a><span id="l1.64">   *aName = ToNewUnicode(name);</span>
<a href="#l1.65"></a><span id="l1.65">   return rv;</span>
<a href="#l1.66"></a><span id="l1.66"> }</span>
<a href="#l1.67"></a><span id="l1.67"> </span>
<a href="#l1.68"></a><span id="l1.68" class="difflineminus">-NS_IMETHODIMP nsAppleMailImportModule::GetSupports(char **aSupports)</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineminus">-{</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+NS_IMETHODIMP nsAppleMailImportModule::GetSupports(char **aSupports) {</span>
<a href="#l1.71"></a><span id="l1.71">   NS_ENSURE_ARG_POINTER(aSupports);</span>
<a href="#l1.72"></a><span id="l1.72">   *aSupports = strdup(NS_IMPORT_MAIL_STR);</span>
<a href="#l1.73"></a><span id="l1.73">   return NS_OK;</span>
<a href="#l1.74"></a><span id="l1.74"> }</span>
<a href="#l1.75"></a><span id="l1.75"> </span>
<a href="#l1.76"></a><span id="l1.76" class="difflineminus">-NS_IMETHODIMP nsAppleMailImportModule::GetSupportsUpgrade(bool *aUpgrade)</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineminus">-{</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineplus">+NS_IMETHODIMP nsAppleMailImportModule::GetSupportsUpgrade(bool *aUpgrade) {</span>
<a href="#l1.79"></a><span id="l1.79">   NS_ENSURE_ARG_POINTER(aUpgrade);</span>
<a href="#l1.80"></a><span id="l1.80">   *aUpgrade = false;</span>
<a href="#l1.81"></a><span id="l1.81">   return NS_OK;</span>
<a href="#l1.82"></a><span id="l1.82"> }</span>
<a href="#l1.83"></a><span id="l1.83"> </span>
<a href="#l1.84"></a><span id="l1.84" class="difflineminus">-NS_IMETHODIMP nsAppleMailImportModule::GetImportInterface(const char *aImportType, nsISupports **aInterface)</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineminus">-{</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineplus">+NS_IMETHODIMP nsAppleMailImportModule::GetImportInterface(</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineplus">+    const char *aImportType, nsISupports **aInterface) {</span>
<a href="#l1.88"></a><span id="l1.88">   NS_ENSURE_ARG_POINTER(aImportType);</span>
<a href="#l1.89"></a><span id="l1.89">   NS_ENSURE_ARG_POINTER(aInterface);</span>
<a href="#l1.90"></a><span id="l1.90">   *aInterface = nullptr;</span>
<a href="#l1.91"></a><span id="l1.91">   nsresult rv = NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l1.92"></a><span id="l1.92"> </span>
<a href="#l1.93"></a><span id="l1.93">   if (!strcmp(aImportType, &quot;mail&quot;)) {</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineminus">-    nsCOMPtr&lt;nsIImportMail&gt; mail(do_CreateInstance(NS_APPLEMAILIMPL_CONTRACTID, &amp;rv));</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineplus">+    nsCOMPtr&lt;nsIImportMail&gt; mail(</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineplus">+        do_CreateInstance(NS_APPLEMAILIMPL_CONTRACTID, &amp;rv));</span>
<a href="#l1.97"></a><span id="l1.97">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineminus">-      nsCOMPtr&lt;nsIImportService&gt; impSvc(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineplus">+      nsCOMPtr&lt;nsIImportService&gt; impSvc(</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineplus">+          do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l1.101"></a><span id="l1.101">       if (NS_SUCCEEDED(rv)) {</span>
<a href="#l1.102"></a><span id="l1.102">         nsCOMPtr&lt;nsIImportGeneric&gt; generic;</span>
<a href="#l1.103"></a><span id="l1.103">         rv = impSvc-&gt;CreateNewGenericMail(getter_AddRefs(generic));</span>
<a href="#l1.104"></a><span id="l1.104">         if (NS_SUCCEEDED(rv)) {</span>
<a href="#l1.105"></a><span id="l1.105">           nsAutoString name;</span>
<a href="#l1.106"></a><span id="l1.106">           rv = mBundle-&gt;GetStringFromName(&quot;ApplemailImportName&quot;, name);</span>
<a href="#l1.107"></a><span id="l1.107">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.108"></a><span id="l1.108"> </span>
<a href="#l1.109"></a><span id="l1.109" class="difflineminus">-          nsCOMPtr&lt;nsISupportsString&gt; nameString(do_CreateInstance(NS_SUPPORTS_STRING_CONTRACTID, &amp;rv));</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineplus">+          nsCOMPtr&lt;nsISupportsString&gt; nameString(</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineplus">+              do_CreateInstance(NS_SUPPORTS_STRING_CONTRACTID, &amp;rv));</span>
<a href="#l1.112"></a><span id="l1.112">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.113"></a><span id="l1.113">           nameString-&gt;SetData(name);</span>
<a href="#l1.114"></a><span id="l1.114"> </span>
<a href="#l1.115"></a><span id="l1.115">           generic-&gt;SetData(&quot;name&quot;, nameString);</span>
<a href="#l1.116"></a><span id="l1.116">           generic-&gt;SetData(&quot;mailInterface&quot;, mail);</span>
<a href="#l1.117"></a><span id="l1.117"> </span>
<a href="#l1.118"></a><span id="l1.118">           generic.forget(aInterface);</span>
<a href="#l1.119"></a><span id="l1.119">         }</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineat">@@ -125,339 +120,356 @@ NS_IMETHODIMP nsAppleMailImportModule::G</span>
<a href="#l1.121"></a><span id="l1.121">     }</span>
<a href="#l1.122"></a><span id="l1.122">   }</span>
<a href="#l1.123"></a><span id="l1.123"> </span>
<a href="#l1.124"></a><span id="l1.124">   return rv;</span>
<a href="#l1.125"></a><span id="l1.125"> }</span>
<a href="#l1.126"></a><span id="l1.126"> </span>
<a href="#l1.127"></a><span id="l1.127"> #pragma mark -</span>
<a href="#l1.128"></a><span id="l1.128"> </span>
<a href="#l1.129"></a><span id="l1.129" class="difflineminus">-nsAppleMailImportMail::nsAppleMailImportMail() : mProgress(0), mCurDepth(0)</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineminus">-{</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineplus">+nsAppleMailImportMail::nsAppleMailImportMail() : mProgress(0), mCurDepth(0) {</span>
<a href="#l1.132"></a><span id="l1.132">   IMPORT_LOG0(&quot;nsAppleMailImportMail created&quot;);</span>
<a href="#l1.133"></a><span id="l1.133"> }</span>
<a href="#l1.134"></a><span id="l1.134"> </span>
<a href="#l1.135"></a><span id="l1.135" class="difflineminus">-nsresult nsAppleMailImportMail::Initialize()</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineminus">-{</span>
<a href="#l1.137"></a><span id="l1.137" class="difflineplus">+nsresult nsAppleMailImportMail::Initialize() {</span>
<a href="#l1.138"></a><span id="l1.138">   nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l1.141"></a><span id="l1.141">   NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l1.142"></a><span id="l1.142"> </span>
<a href="#l1.143"></a><span id="l1.143" class="difflineminus">-  return bundleService-&gt;CreateBundle(APPLEMAIL_MSGS_URL, getter_AddRefs(mBundle));</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineplus">+  return bundleService-&gt;CreateBundle(APPLEMAIL_MSGS_URL,</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineplus">+                                     getter_AddRefs(mBundle));</span>
<a href="#l1.146"></a><span id="l1.146"> }</span>
<a href="#l1.147"></a><span id="l1.147"> </span>
<a href="#l1.148"></a><span id="l1.148" class="difflineminus">-nsAppleMailImportMail::~nsAppleMailImportMail()</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineminus">-{</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineplus">+nsAppleMailImportMail::~nsAppleMailImportMail() {</span>
<a href="#l1.151"></a><span id="l1.151">   IMPORT_LOG0(&quot;nsAppleMailImportMail destroyed&quot;);</span>
<a href="#l1.152"></a><span id="l1.152"> }</span>
<a href="#l1.153"></a><span id="l1.153"> </span>
<a href="#l1.154"></a><span id="l1.154"> NS_IMPL_ISUPPORTS(nsAppleMailImportMail, nsIImportMail)</span>
<a href="#l1.155"></a><span id="l1.155"> </span>
<a href="#l1.156"></a><span id="l1.156" class="difflineminus">-NS_IMETHODIMP nsAppleMailImportMail::GetDefaultLocation(nsIFile **aLocation, bool *aFound, bool *aUserVerify)</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineminus">-{</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineplus">+NS_IMETHODIMP nsAppleMailImportMail::GetDefaultLocation(nsIFile **aLocation,</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineplus">+                                                        bool *aFound,</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineplus">+                                                        bool *aUserVerify) {</span>
<a href="#l1.161"></a><span id="l1.161">   NS_ENSURE_ARG_POINTER(aFound);</span>
<a href="#l1.162"></a><span id="l1.162">   NS_ENSURE_ARG_POINTER(aLocation);</span>
<a href="#l1.163"></a><span id="l1.163">   NS_ENSURE_ARG_POINTER(aUserVerify);</span>
<a href="#l1.164"></a><span id="l1.164"> </span>
<a href="#l1.165"></a><span id="l1.165">   *aLocation = nullptr;</span>
<a href="#l1.166"></a><span id="l1.166">   *aFound = false;</span>
<a href="#l1.167"></a><span id="l1.167">   *aUserVerify = true;</span>
<a href="#l1.168"></a><span id="l1.168"> </span>
<a href="#l1.169"></a><span id="l1.169">   // try to find current user's top-level Mail folder</span>
<a href="#l1.170"></a><span id="l1.170">   nsCOMPtr&lt;nsIFile&gt; mailFolder(do_CreateInstance(NS_LOCAL_FILE_CONTRACTID));</span>
<a href="#l1.171"></a><span id="l1.171">   if (mailFolder) {</span>
<a href="#l1.172"></a><span id="l1.172" class="difflineminus">-    nsresult rv = mailFolder-&gt;InitWithNativePath(NS_LITERAL_CSTRING(DEFAULT_MAIL_FOLDER));</span>
<a href="#l1.173"></a><span id="l1.173" class="difflineplus">+    nsresult rv =</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineplus">+        mailFolder-&gt;InitWithNativePath(NS_LITERAL_CSTRING(DEFAULT_MAIL_FOLDER));</span>
<a href="#l1.175"></a><span id="l1.175">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l1.176"></a><span id="l1.176">       *aFound = true;</span>
<a href="#l1.177"></a><span id="l1.177">       *aUserVerify = false;</span>
<a href="#l1.178"></a><span id="l1.178">       mailFolder.forget(aLocation);</span>
<a href="#l1.179"></a><span id="l1.179">     }</span>
<a href="#l1.180"></a><span id="l1.180">   }</span>
<a href="#l1.181"></a><span id="l1.181"> </span>
<a href="#l1.182"></a><span id="l1.182">   return NS_OK;</span>
<a href="#l1.183"></a><span id="l1.183"> }</span>
<a href="#l1.184"></a><span id="l1.184"> </span>
<a href="#l1.185"></a><span id="l1.185"> // this is the method that initiates all searching for mailboxes.</span>
<a href="#l1.186"></a><span id="l1.186"> // it will assume that it has a directory like ~/Library/Mail/</span>
<a href="#l1.187"></a><span id="l1.187" class="difflineminus">-NS_IMETHODIMP nsAppleMailImportMail::FindMailboxes(nsIFile *aMailboxFile, nsIArray **aResult)</span>
<a href="#l1.188"></a><span id="l1.188" class="difflineminus">-{</span>
<a href="#l1.189"></a><span id="l1.189" class="difflineplus">+NS_IMETHODIMP nsAppleMailImportMail::FindMailboxes(nsIFile *aMailboxFile,</span>
<a href="#l1.190"></a><span id="l1.190" class="difflineplus">+                                                   nsIArray **aResult) {</span>
<a href="#l1.191"></a><span id="l1.191">   NS_ENSURE_ARG_POINTER(aMailboxFile);</span>
<a href="#l1.192"></a><span id="l1.192">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l1.193"></a><span id="l1.193"> </span>
<a href="#l1.194"></a><span id="l1.194">   IMPORT_LOG0(&quot;FindMailboxes for Apple mail invoked&quot;);</span>
<a href="#l1.195"></a><span id="l1.195"> </span>
<a href="#l1.196"></a><span id="l1.196">   bool exists = false;</span>
<a href="#l1.197"></a><span id="l1.197">   nsresult rv = aMailboxFile-&gt;Exists(&amp;exists);</span>
<a href="#l1.198"></a><span id="l1.198" class="difflineminus">-  if (NS_FAILED(rv) || !exists)</span>
<a href="#l1.199"></a><span id="l1.199" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineplus">+  if (NS_FAILED(rv) || !exists) return NS_ERROR_FAILURE;</span>
<a href="#l1.201"></a><span id="l1.201"> </span>
<a href="#l1.202"></a><span id="l1.202" class="difflineminus">-  nsCOMPtr&lt;nsIImportService&gt; importService(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l1.203"></a><span id="l1.203" class="difflineplus">+  nsCOMPtr&lt;nsIImportService&gt; importService(</span>
<a href="#l1.204"></a><span id="l1.204" class="difflineplus">+      do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l1.205"></a><span id="l1.205">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.206"></a><span id="l1.206"> </span>
<a href="#l1.207"></a><span id="l1.207" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; resultsArray(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l1.208"></a><span id="l1.208" class="difflineminus">-  if (!resultsArray)</span>
<a href="#l1.209"></a><span id="l1.209" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l1.210"></a><span id="l1.210" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; resultsArray(</span>
<a href="#l1.211"></a><span id="l1.211" class="difflineplus">+      do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l1.212"></a><span id="l1.212" class="difflineplus">+  if (!resultsArray) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l1.213"></a><span id="l1.213"> </span>
<a href="#l1.214"></a><span id="l1.214">   mCurDepth = 1;</span>
<a href="#l1.215"></a><span id="l1.215"> </span>
<a href="#l1.216"></a><span id="l1.216">   // 1. look for accounts with mailboxes</span>
<a href="#l1.217"></a><span id="l1.217">   FindAccountMailDirs(aMailboxFile, resultsArray, importService);</span>
<a href="#l1.218"></a><span id="l1.218">   mCurDepth--;</span>
<a href="#l1.219"></a><span id="l1.219"> </span>
<a href="#l1.220"></a><span id="l1.220">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l1.221"></a><span id="l1.221" class="difflineminus">-    // 2. look for &quot;global&quot; mailboxes, that don't belong to any specific account. they are inside the</span>
<a href="#l1.222"></a><span id="l1.222" class="difflineplus">+    // 2. look for &quot;global&quot; mailboxes, that don't belong to any specific</span>
<a href="#l1.223"></a><span id="l1.223" class="difflineplus">+    // account. they are inside the</span>
<a href="#l1.224"></a><span id="l1.224">     //    root's Mailboxes/ folder</span>
<a href="#l1.225"></a><span id="l1.225" class="difflineminus">-    nsCOMPtr&lt;nsIFile&gt; mailboxesDir(do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv));</span>
<a href="#l1.226"></a><span id="l1.226" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; mailboxesDir(</span>
<a href="#l1.227"></a><span id="l1.227" class="difflineplus">+        do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv));</span>
<a href="#l1.228"></a><span id="l1.228">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l1.229"></a><span id="l1.229" class="difflineminus">-        mailboxesDir-&gt;InitWithFile(aMailboxFile);</span>
<a href="#l1.230"></a><span id="l1.230" class="difflineminus">-        rv = mailboxesDir-&gt;Append(NS_LITERAL_STRING(&quot;Mailboxes&quot;));</span>
<a href="#l1.231"></a><span id="l1.231" class="difflineminus">-        if (NS_SUCCEEDED(rv)) {</span>
<a href="#l1.232"></a><span id="l1.232" class="difflineminus">-          IMPORT_LOG0(&quot;Looking for global Apple mailboxes&quot;);</span>
<a href="#l1.233"></a><span id="l1.233" class="difflineplus">+      mailboxesDir-&gt;InitWithFile(aMailboxFile);</span>
<a href="#l1.234"></a><span id="l1.234" class="difflineplus">+      rv = mailboxesDir-&gt;Append(NS_LITERAL_STRING(&quot;Mailboxes&quot;));</span>
<a href="#l1.235"></a><span id="l1.235" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l1.236"></a><span id="l1.236" class="difflineplus">+        IMPORT_LOG0(&quot;Looking for global Apple mailboxes&quot;);</span>
<a href="#l1.237"></a><span id="l1.237"> </span>
<a href="#l1.238"></a><span id="l1.238" class="difflineminus">-          mCurDepth++;</span>
<a href="#l1.239"></a><span id="l1.239" class="difflineminus">-          rv = FindMboxDirs(mailboxesDir, resultsArray, importService);</span>
<a href="#l1.240"></a><span id="l1.240" class="difflineminus">-          mCurDepth--;</span>
<a href="#l1.241"></a><span id="l1.241" class="difflineminus">-        }</span>
<a href="#l1.242"></a><span id="l1.242" class="difflineplus">+        mCurDepth++;</span>
<a href="#l1.243"></a><span id="l1.243" class="difflineplus">+        rv = FindMboxDirs(mailboxesDir, resultsArray, importService);</span>
<a href="#l1.244"></a><span id="l1.244" class="difflineplus">+        mCurDepth--;</span>
<a href="#l1.245"></a><span id="l1.245" class="difflineplus">+      }</span>
<a href="#l1.246"></a><span id="l1.246">     }</span>
<a href="#l1.247"></a><span id="l1.247">   }</span>
<a href="#l1.248"></a><span id="l1.248"> </span>
<a href="#l1.249"></a><span id="l1.249" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; resultsArray)</span>
<a href="#l1.250"></a><span id="l1.250" class="difflineminus">-    resultsArray.forget(aResult);</span>
<a href="#l1.251"></a><span id="l1.251" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; resultsArray) resultsArray.forget(aResult);</span>
<a href="#l1.252"></a><span id="l1.252"> </span>
<a href="#l1.253"></a><span id="l1.253">   return rv;</span>
<a href="#l1.254"></a><span id="l1.254"> }</span>
<a href="#l1.255"></a><span id="l1.255"> </span>
<a href="#l1.256"></a><span id="l1.256" class="difflineminus">-// operates on the Mail/ directory root, trying to find accounts (which are folders named something like &quot;POP-hwaara@gmail.com&quot;)</span>
<a href="#l1.257"></a><span id="l1.257" class="difflineminus">-// and add their .mbox dirs</span>
<a href="#l1.258"></a><span id="l1.258" class="difflineminus">-void nsAppleMailImportMail::FindAccountMailDirs(nsIFile *aRoot, nsIMutableArray *aMailboxDescs, nsIImportService *aImportService)</span>
<a href="#l1.259"></a><span id="l1.259" class="difflineminus">-{</span>
<a href="#l1.260"></a><span id="l1.260" class="difflineplus">+// operates on the Mail/ directory root, trying to find accounts (which are</span>
<a href="#l1.261"></a><span id="l1.261" class="difflineplus">+// folders named something like &quot;POP-hwaara@gmail.com&quot;) and add their .mbox dirs</span>
<a href="#l1.262"></a><span id="l1.262" class="difflineplus">+void nsAppleMailImportMail::FindAccountMailDirs(</span>
<a href="#l1.263"></a><span id="l1.263" class="difflineplus">+    nsIFile *aRoot, nsIMutableArray *aMailboxDescs,</span>
<a href="#l1.264"></a><span id="l1.264" class="difflineplus">+    nsIImportService *aImportService) {</span>
<a href="#l1.265"></a><span id="l1.265">   nsCOMPtr&lt;nsIDirectoryEnumerator&gt; directoryEnumerator;</span>
<a href="#l1.266"></a><span id="l1.266">   nsresult rv = aRoot-&gt;GetDirectoryEntries(getter_AddRefs(directoryEnumerator));</span>
<a href="#l1.267"></a><span id="l1.267" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l1.268"></a><span id="l1.268" class="difflineminus">-    return;</span>
<a href="#l1.269"></a><span id="l1.269" class="difflineplus">+  if (NS_FAILED(rv)) return;</span>
<a href="#l1.270"></a><span id="l1.270"> </span>
<a href="#l1.271"></a><span id="l1.271">   bool hasMore = false;</span>
<a href="#l1.272"></a><span id="l1.272" class="difflineminus">-  while (NS_SUCCEEDED(directoryEnumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l1.273"></a><span id="l1.273" class="difflineplus">+  while (NS_SUCCEEDED(directoryEnumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp;</span>
<a href="#l1.274"></a><span id="l1.274" class="difflineplus">+         hasMore) {</span>
<a href="#l1.275"></a><span id="l1.275">     // get the next file entry</span>
<a href="#l1.276"></a><span id="l1.276">     nsCOMPtr&lt;nsIFile&gt; currentEntry;</span>
<a href="#l1.277"></a><span id="l1.277">     directoryEnumerator-&gt;GetNextFile(getter_AddRefs(currentEntry));</span>
<a href="#l1.278"></a><span id="l1.278" class="difflineminus">-    if (!currentEntry)</span>
<a href="#l1.279"></a><span id="l1.279" class="difflineminus">-      continue;</span>
<a href="#l1.280"></a><span id="l1.280" class="difflineplus">+    if (!currentEntry) continue;</span>
<a href="#l1.281"></a><span id="l1.281"> </span>
<a href="#l1.282"></a><span id="l1.282">     // make sure it's a directory</span>
<a href="#l1.283"></a><span id="l1.283">     bool isDirectory = false;</span>
<a href="#l1.284"></a><span id="l1.284">     currentEntry-&gt;IsDirectory(&amp;isDirectory);</span>
<a href="#l1.285"></a><span id="l1.285"> </span>
<a href="#l1.286"></a><span id="l1.286">     if (isDirectory) {</span>
<a href="#l1.287"></a><span id="l1.287" class="difflineminus">-      // now let's see if it's an account folder. if so, we want to traverse it for .mbox children</span>
<a href="#l1.288"></a><span id="l1.288" class="difflineplus">+      // now let's see if it's an account folder. if so, we want to traverse it</span>
<a href="#l1.289"></a><span id="l1.289" class="difflineplus">+      // for .mbox children</span>
<a href="#l1.290"></a><span id="l1.290">       nsAutoString folderName;</span>
<a href="#l1.291"></a><span id="l1.291">       currentEntry-&gt;GetLeafName(folderName);</span>
<a href="#l1.292"></a><span id="l1.292">       bool isAccountFolder = false;</span>
<a href="#l1.293"></a><span id="l1.293"> </span>
<a href="#l1.294"></a><span id="l1.294">       if (StringBeginsWith(folderName, NS_LITERAL_STRING(&quot;POP-&quot;))) {</span>
<a href="#l1.295"></a><span id="l1.295">         // cut off &quot;POP-&quot; prefix so we get a nice folder name</span>
<a href="#l1.296"></a><span id="l1.296">         folderName.Cut(0, 4);</span>
<a href="#l1.297"></a><span id="l1.297">         isAccountFolder = true;</span>
<a href="#l1.298"></a><span id="l1.298" class="difflineminus">-      }</span>
<a href="#l1.299"></a><span id="l1.299" class="difflineminus">-      else if (StringBeginsWith(folderName, NS_LITERAL_STRING(&quot;IMAP-&quot;))) {</span>
<a href="#l1.300"></a><span id="l1.300" class="difflineplus">+      } else if (StringBeginsWith(folderName, NS_LITERAL_STRING(&quot;IMAP-&quot;))) {</span>
<a href="#l1.301"></a><span id="l1.301">         // cut off &quot;IMAP-&quot; prefix so we get a nice folder name</span>
<a href="#l1.302"></a><span id="l1.302">         folderName.Cut(0, 5);</span>
<a href="#l1.303"></a><span id="l1.303">         isAccountFolder = true;</span>
<a href="#l1.304"></a><span id="l1.304">       }</span>
<a href="#l1.305"></a><span id="l1.305"> </span>
<a href="#l1.306"></a><span id="l1.306">       if (isAccountFolder) {</span>
<a href="#l1.307"></a><span id="l1.307" class="difflineminus">-        IMPORT_LOG1(&quot;Found account: %s\n&quot;, NS_ConvertUTF16toUTF8(folderName).get());</span>
<a href="#l1.308"></a><span id="l1.308" class="difflineplus">+        IMPORT_LOG1(&quot;Found account: %s\n&quot;,</span>
<a href="#l1.309"></a><span id="l1.309" class="difflineplus">+                    NS_ConvertUTF16toUTF8(folderName).get());</span>
<a href="#l1.310"></a><span id="l1.310"> </span>
<a href="#l1.311"></a><span id="l1.311" class="difflineminus">-        // create a mailbox for this account, so we get a parent for &quot;Inbox&quot;, &quot;Sent Messages&quot;, etc.</span>
<a href="#l1.312"></a><span id="l1.312" class="difflineplus">+        // create a mailbox for this account, so we get a parent for &quot;Inbox&quot;,</span>
<a href="#l1.313"></a><span id="l1.313" class="difflineplus">+        // &quot;Sent Messages&quot;, etc.</span>
<a href="#l1.314"></a><span id="l1.314">         nsCOMPtr&lt;nsIImportMailboxDescriptor&gt; desc;</span>
<a href="#l1.315"></a><span id="l1.315" class="difflineminus">-        nsresult rv = aImportService-&gt;CreateNewMailboxDescriptor(getter_AddRefs(desc));</span>
<a href="#l1.316"></a><span id="l1.316" class="difflineplus">+        nsresult rv =</span>
<a href="#l1.317"></a><span id="l1.317" class="difflineplus">+            aImportService-&gt;CreateNewMailboxDescriptor(getter_AddRefs(desc));</span>
<a href="#l1.318"></a><span id="l1.318">         desc-&gt;SetSize(1);</span>
<a href="#l1.319"></a><span id="l1.319">         desc-&gt;SetDepth(mCurDepth);</span>
<a href="#l1.320"></a><span id="l1.320">         desc-&gt;SetDisplayName(folderName.get());</span>
<a href="#l1.321"></a><span id="l1.321">         desc-&gt;SetIdentifier(kAccountMailboxID);</span>
<a href="#l1.322"></a><span id="l1.322"> </span>
<a href="#l1.323"></a><span id="l1.323">         nsCOMPtr&lt;nsIFile&gt; mailboxDescFile;</span>
<a href="#l1.324"></a><span id="l1.324">         rv = desc-&gt;GetFile(getter_AddRefs(mailboxDescFile));</span>
<a href="#l1.325"></a><span id="l1.325" class="difflineminus">-        if (!mailboxDescFile)</span>
<a href="#l1.326"></a><span id="l1.326" class="difflineminus">-          continue;</span>
<a href="#l1.327"></a><span id="l1.327" class="difflineplus">+        if (!mailboxDescFile) continue;</span>
<a href="#l1.328"></a><span id="l1.328"> </span>
<a href="#l1.329"></a><span id="l1.329">         mailboxDescFile-&gt;InitWithFile(currentEntry);</span>
<a href="#l1.330"></a><span id="l1.330"> </span>
<a href="#l1.331"></a><span id="l1.331">         // add this mailbox descriptor to the list</span>
<a href="#l1.332"></a><span id="l1.332">         aMailboxDescs-&gt;AppendElement(desc);</span>
<a href="#l1.333"></a><span id="l1.333"> </span>
<a href="#l1.334"></a><span id="l1.334">         // now add all the children mailboxes</span>
<a href="#l1.335"></a><span id="l1.335">         mCurDepth++;</span>
<a href="#l1.336"></a><span id="l1.336">         FindMboxDirs(currentEntry, aMailboxDescs, aImportService);</span>
<a href="#l1.337"></a><span id="l1.337">         mCurDepth--;</span>
<a href="#l1.338"></a><span id="l1.338">       }</span>
<a href="#l1.339"></a><span id="l1.339">     }</span>
<a href="#l1.340"></a><span id="l1.340">   }</span>
<a href="#l1.341"></a><span id="l1.341"> }</span>
<a href="#l1.342"></a><span id="l1.342"> </span>
<a href="#l1.343"></a><span id="l1.343"> // adds the specified file as a mailboxdescriptor to the array</span>
<a href="#l1.344"></a><span id="l1.344" class="difflineminus">-nsresult nsAppleMailImportMail::AddMboxDir(nsIFile *aFolder, nsIMutableArray *aMailboxDescs, nsIImportService *aImportService)</span>
<a href="#l1.345"></a><span id="l1.345" class="difflineminus">-{</span>
<a href="#l1.346"></a><span id="l1.346" class="difflineplus">+nsresult nsAppleMailImportMail::AddMboxDir(nsIFile *aFolder,</span>
<a href="#l1.347"></a><span id="l1.347" class="difflineplus">+                                           nsIMutableArray *aMailboxDescs,</span>
<a href="#l1.348"></a><span id="l1.348" class="difflineplus">+                                           nsIImportService *aImportService) {</span>
<a href="#l1.349"></a><span id="l1.349">   nsAutoString folderName;</span>
<a href="#l1.350"></a><span id="l1.350">   aFolder-&gt;GetLeafName(folderName);</span>
<a href="#l1.351"></a><span id="l1.351"> </span>
<a href="#l1.352"></a><span id="l1.352">   // cut off the suffix, if any, or prefix if this is an account folder.</span>
<a href="#l1.353"></a><span id="l1.353">   if (StringEndsWith(folderName, NS_LITERAL_STRING(POP_MBOX_SUFFIX)))</span>
<a href="#l1.354"></a><span id="l1.354" class="difflineminus">-    folderName.SetLength(folderName.Length()-5);</span>
<a href="#l1.355"></a><span id="l1.355" class="difflineplus">+    folderName.SetLength(folderName.Length() - 5);</span>
<a href="#l1.356"></a><span id="l1.356">   else if (StringEndsWith(folderName, NS_LITERAL_STRING(IMAP_MBOX_SUFFIX)))</span>
<a href="#l1.357"></a><span id="l1.357" class="difflineminus">-    folderName.SetLength(folderName.Length()-9);</span>
<a href="#l1.358"></a><span id="l1.358" class="difflineplus">+    folderName.SetLength(folderName.Length() - 9);</span>
<a href="#l1.359"></a><span id="l1.359">   else if (StringBeginsWith(folderName, NS_LITERAL_STRING(&quot;POP-&quot;)))</span>
<a href="#l1.360"></a><span id="l1.360">     folderName.Cut(4, folderName.Length());</span>
<a href="#l1.361"></a><span id="l1.361">   else if (StringBeginsWith(folderName, NS_LITERAL_STRING(&quot;IMAP-&quot;)))</span>
<a href="#l1.362"></a><span id="l1.362">     folderName.Cut(5, folderName.Length());</span>
<a href="#l1.363"></a><span id="l1.363"> </span>
<a href="#l1.364"></a><span id="l1.364">   nsCOMPtr&lt;nsIImportMailboxDescriptor&gt; desc;</span>
<a href="#l1.365"></a><span id="l1.365" class="difflineminus">-  nsresult rv = aImportService-&gt;CreateNewMailboxDescriptor(getter_AddRefs(desc));</span>
<a href="#l1.366"></a><span id="l1.366" class="difflineplus">+  nsresult rv =</span>
<a href="#l1.367"></a><span id="l1.367" class="difflineplus">+      aImportService-&gt;CreateNewMailboxDescriptor(getter_AddRefs(desc));</span>
<a href="#l1.368"></a><span id="l1.368">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l1.369"></a><span id="l1.369">     // find out number of messages in this .mbox</span>
<a href="#l1.370"></a><span id="l1.370">     uint32_t numMessages = 0;</span>
<a href="#l1.371"></a><span id="l1.371">     {</span>
<a href="#l1.372"></a><span id="l1.372">       // move to the .mbox's Messages folder</span>
<a href="#l1.373"></a><span id="l1.373">       nsCOMPtr&lt;nsIFile&gt; messagesFolder;</span>
<a href="#l1.374"></a><span id="l1.374">       aFolder-&gt;Clone(getter_AddRefs(messagesFolder));</span>
<a href="#l1.375"></a><span id="l1.375">       nsresult rv = messagesFolder-&gt;Append(NS_LITERAL_STRING(&quot;Messages&quot;));</span>
<a href="#l1.376"></a><span id="l1.376">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.377"></a><span id="l1.377"> </span>
<a href="#l1.378"></a><span id="l1.378" class="difflineminus">-      // count the number of messages in this folder. it sucks that we have to iterate through the folder</span>
<a href="#l1.379"></a><span id="l1.379" class="difflineminus">-      // but XPCOM doesn't give us any way to just get the file count, unfortunately. :-(</span>
<a href="#l1.380"></a><span id="l1.380" class="difflineplus">+      // count the number of messages in this folder. it sucks that we have to</span>
<a href="#l1.381"></a><span id="l1.381" class="difflineplus">+      // iterate through the folder but XPCOM doesn't give us any way to just</span>
<a href="#l1.382"></a><span id="l1.382" class="difflineplus">+      // get the file count, unfortunately. :-(</span>
<a href="#l1.383"></a><span id="l1.383">       nsCOMPtr&lt;nsIDirectoryEnumerator&gt; dirEnumerator;</span>
<a href="#l1.384"></a><span id="l1.384">       messagesFolder-&gt;GetDirectoryEntries(getter_AddRefs(dirEnumerator));</span>
<a href="#l1.385"></a><span id="l1.385">       if (dirEnumerator) {</span>
<a href="#l1.386"></a><span id="l1.386">         bool hasMore = false;</span>
<a href="#l1.387"></a><span id="l1.387" class="difflineminus">-        while (NS_SUCCEEDED(dirEnumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l1.388"></a><span id="l1.388" class="difflineplus">+        while (NS_SUCCEEDED(dirEnumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp;</span>
<a href="#l1.389"></a><span id="l1.389" class="difflineplus">+               hasMore) {</span>
<a href="#l1.390"></a><span id="l1.390">           nsCOMPtr&lt;nsIFile&gt; file;</span>
<a href="#l1.391"></a><span id="l1.391">           dirEnumerator-&gt;GetNextFile(getter_AddRefs(file));</span>
<a href="#l1.392"></a><span id="l1.392">           if (file) {</span>
<a href="#l1.393"></a><span id="l1.393">             bool isFile = false;</span>
<a href="#l1.394"></a><span id="l1.394">             file-&gt;IsFile(&amp;isFile);</span>
<a href="#l1.395"></a><span id="l1.395" class="difflineminus">-            if (isFile)</span>
<a href="#l1.396"></a><span id="l1.396" class="difflineminus">-              numMessages++;</span>
<a href="#l1.397"></a><span id="l1.397" class="difflineplus">+            if (isFile) numMessages++;</span>
<a href="#l1.398"></a><span id="l1.398">           }</span>
<a href="#l1.399"></a><span id="l1.399">         }</span>
<a href="#l1.400"></a><span id="l1.400">       }</span>
<a href="#l1.401"></a><span id="l1.401">     }</span>
<a href="#l1.402"></a><span id="l1.402"> </span>
<a href="#l1.403"></a><span id="l1.403">     desc-&gt;SetSize(numMessages);</span>
<a href="#l1.404"></a><span id="l1.404">     desc-&gt;SetDisplayName(folderName.get());</span>
<a href="#l1.405"></a><span id="l1.405">     desc-&gt;SetDepth(mCurDepth);</span>
<a href="#l1.406"></a><span id="l1.406"> </span>
<a href="#l1.407"></a><span id="l1.407" class="difflineminus">-    IMPORT_LOG3(&quot;Will import %s with approx %d messages, depth is %d&quot;, NS_ConvertUTF16toUTF8(folderName).get(), numMessages, mCurDepth);</span>
<a href="#l1.408"></a><span id="l1.408" class="difflineplus">+    IMPORT_LOG3(&quot;Will import %s with approx %d messages, depth is %d&quot;,</span>
<a href="#l1.409"></a><span id="l1.409" class="difflineplus">+                NS_ConvertUTF16toUTF8(folderName).get(), numMessages,</span>
<a href="#l1.410"></a><span id="l1.410" class="difflineplus">+                mCurDepth);</span>
<a href="#l1.411"></a><span id="l1.411"> </span>
<a href="#l1.412"></a><span id="l1.412" class="difflineminus">-    // XXX: this is silly. there's no setter for the mailbox descriptor's file, so we need to get it, and then modify it.</span>
<a href="#l1.413"></a><span id="l1.413" class="difflineplus">+    // XXX: this is silly. there's no setter for the mailbox descriptor's file,</span>
<a href="#l1.414"></a><span id="l1.414" class="difflineplus">+    // so we need to get it, and then modify it.</span>
<a href="#l1.415"></a><span id="l1.415">     nsCOMPtr&lt;nsIFile&gt; mailboxDescFile;</span>
<a href="#l1.416"></a><span id="l1.416">     rv = desc-&gt;GetFile(getter_AddRefs(mailboxDescFile));</span>
<a href="#l1.417"></a><span id="l1.417">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.418"></a><span id="l1.418"> </span>
<a href="#l1.419"></a><span id="l1.419" class="difflineminus">-    if (mailboxDescFile)</span>
<a href="#l1.420"></a><span id="l1.420" class="difflineminus">-      mailboxDescFile-&gt;InitWithFile(aFolder);</span>
<a href="#l1.421"></a><span id="l1.421" class="difflineplus">+    if (mailboxDescFile) mailboxDescFile-&gt;InitWithFile(aFolder);</span>
<a href="#l1.422"></a><span id="l1.422"> </span>
<a href="#l1.423"></a><span id="l1.423">     // add this mailbox descriptor to the list</span>
<a href="#l1.424"></a><span id="l1.424">     aMailboxDescs-&gt;AppendElement(desc);</span>
<a href="#l1.425"></a><span id="l1.425">   }</span>
<a href="#l1.426"></a><span id="l1.426"> </span>
<a href="#l1.427"></a><span id="l1.427">   return NS_OK;</span>
<a href="#l1.428"></a><span id="l1.428"> }</span>
<a href="#l1.429"></a><span id="l1.429"> </span>
<a href="#l1.430"></a><span id="l1.430" class="difflineminus">-// Starts looking for .mbox dirs in the specified dir. The .mbox dirs contain messages and can be considered leafs in a tree of</span>
<a href="#l1.431"></a><span id="l1.431" class="difflineminus">-// nested mailboxes (subfolders).</span>
<a href="#l1.432"></a><span id="l1.432" class="difflineplus">+// Starts looking for .mbox dirs in the specified dir. The .mbox dirs contain</span>
<a href="#l1.433"></a><span id="l1.433" class="difflineplus">+// messages and can be considered leafs in a tree of nested mailboxes</span>
<a href="#l1.434"></a><span id="l1.434" class="difflineplus">+// (subfolders).</span>
<a href="#l1.435"></a><span id="l1.435"> //</span>
<a href="#l1.436"></a><span id="l1.436" class="difflineminus">-// If a mailbox has sub-mailboxes, they are contained in a sibling folder with the same name without the &quot;.mbox&quot; part.</span>
<a href="#l1.437"></a><span id="l1.437" class="difflineminus">-// example:</span>
<a href="#l1.438"></a><span id="l1.438" class="difflineplus">+// If a mailbox has sub-mailboxes, they are contained in a sibling folder with</span>
<a href="#l1.439"></a><span id="l1.439" class="difflineplus">+// the same name without the &quot;.mbox&quot; part. example:</span>
<a href="#l1.440"></a><span id="l1.440"> //   MyParentMailbox.mbox/</span>
<a href="#l1.441"></a><span id="l1.441"> //   MyParentMailbox/</span>
<a href="#l1.442"></a><span id="l1.442"> //     MyChildMailbox.mbox/</span>
<a href="#l1.443"></a><span id="l1.443"> //     MyOtherChildMailbox.mbox/</span>
<a href="#l1.444"></a><span id="l1.444"> //</span>
<a href="#l1.445"></a><span id="l1.445" class="difflineminus">-nsresult nsAppleMailImportMail::FindMboxDirs(nsIFile *aFolder, nsIMutableArray *aMailboxDescs, nsIImportService *aImportService)</span>
<a href="#l1.446"></a><span id="l1.446" class="difflineminus">-{</span>
<a href="#l1.447"></a><span id="l1.447" class="difflineplus">+nsresult nsAppleMailImportMail::FindMboxDirs(nsIFile *aFolder,</span>
<a href="#l1.448"></a><span id="l1.448" class="difflineplus">+                                             nsIMutableArray *aMailboxDescs,</span>
<a href="#l1.449"></a><span id="l1.449" class="difflineplus">+                                             nsIImportService *aImportService) {</span>
<a href="#l1.450"></a><span id="l1.450">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l1.451"></a><span id="l1.451">   NS_ENSURE_ARG_POINTER(aMailboxDescs);</span>
<a href="#l1.452"></a><span id="l1.452">   NS_ENSURE_ARG_POINTER(aImportService);</span>
<a href="#l1.453"></a><span id="l1.453"> </span>
<a href="#l1.454"></a><span id="l1.454">   // make sure this is a directory.</span>
<a href="#l1.455"></a><span id="l1.455">   bool isDir = false;</span>
<a href="#l1.456"></a><span id="l1.456">   if (NS_FAILED(aFolder-&gt;IsDirectory(&amp;isDir)) || !isDir)</span>
<a href="#l1.457"></a><span id="l1.457">     return NS_ERROR_FAILURE;</span>
<a href="#l1.458"></a><span id="l1.458"> </span>
<a href="#l1.459"></a><span id="l1.459">   // iterate through the folder contents</span>
<a href="#l1.460"></a><span id="l1.460">   nsCOMPtr&lt;nsIDirectoryEnumerator&gt; directoryEnumerator;</span>
<a href="#l1.461"></a><span id="l1.461" class="difflineminus">-  nsresult rv = aFolder-&gt;GetDirectoryEntries(getter_AddRefs(directoryEnumerator));</span>
<a href="#l1.462"></a><span id="l1.462" class="difflineminus">-  if (NS_FAILED(rv) || !directoryEnumerator)</span>
<a href="#l1.463"></a><span id="l1.463" class="difflineminus">-    return rv;</span>
<a href="#l1.464"></a><span id="l1.464" class="difflineplus">+  nsresult rv =</span>
<a href="#l1.465"></a><span id="l1.465" class="difflineplus">+      aFolder-&gt;GetDirectoryEntries(getter_AddRefs(directoryEnumerator));</span>
<a href="#l1.466"></a><span id="l1.466" class="difflineplus">+  if (NS_FAILED(rv) || !directoryEnumerator) return rv;</span>
<a href="#l1.467"></a><span id="l1.467"> </span>
<a href="#l1.468"></a><span id="l1.468">   bool hasMore = false;</span>
<a href="#l1.469"></a><span id="l1.469" class="difflineminus">-  while (NS_SUCCEEDED(directoryEnumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l1.470"></a><span id="l1.470" class="difflineplus">+  while (NS_SUCCEEDED(directoryEnumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp;</span>
<a href="#l1.471"></a><span id="l1.471" class="difflineplus">+         hasMore) {</span>
<a href="#l1.472"></a><span id="l1.472">     // get the next file entry</span>
<a href="#l1.473"></a><span id="l1.473">     nsCOMPtr&lt;nsIFile&gt; currentEntry;</span>
<a href="#l1.474"></a><span id="l1.474">     directoryEnumerator-&gt;GetNextFile(getter_AddRefs(currentEntry));</span>
<a href="#l1.475"></a><span id="l1.475" class="difflineminus">-    if (!currentEntry)</span>
<a href="#l1.476"></a><span id="l1.476" class="difflineminus">-      continue;</span>
<a href="#l1.477"></a><span id="l1.477" class="difflineplus">+    if (!currentEntry) continue;</span>
<a href="#l1.478"></a><span id="l1.478"> </span>
<a href="#l1.479"></a><span id="l1.479">     // we only care about directories...</span>
<a href="#l1.480"></a><span id="l1.480" class="difflineminus">-    if (NS_FAILED(currentEntry-&gt;IsDirectory(&amp;isDir)) || !isDir)</span>
<a href="#l1.481"></a><span id="l1.481" class="difflineminus">-      continue;</span>
<a href="#l1.482"></a><span id="l1.482" class="difflineplus">+    if (NS_FAILED(currentEntry-&gt;IsDirectory(&amp;isDir)) || !isDir) continue;</span>
<a href="#l1.483"></a><span id="l1.483"> </span>
<a href="#l1.484"></a><span id="l1.484">     // now find out if this is a .mbox dir</span>
<a href="#l1.485"></a><span id="l1.485">     nsAutoString currentFolderName;</span>
<a href="#l1.486"></a><span id="l1.486">     if (NS_SUCCEEDED(currentEntry-&gt;GetLeafName(currentFolderName)) &amp;&amp;</span>
<a href="#l1.487"></a><span id="l1.487" class="difflineminus">-        (StringEndsWith(currentFolderName, NS_LITERAL_STRING(POP_MBOX_SUFFIX)) ||</span>
<a href="#l1.488"></a><span id="l1.488" class="difflineminus">-         StringEndsWith(currentFolderName, NS_LITERAL_STRING(IMAP_MBOX_SUFFIX)))) {</span>
<a href="#l1.489"></a><span id="l1.489" class="difflineminus">-      IMPORT_LOG1(&quot;Adding .mbox dir: %s&quot;, NS_ConvertUTF16toUTF8(currentFolderName).get());</span>
<a href="#l1.490"></a><span id="l1.490" class="difflineplus">+        (StringEndsWith(currentFolderName,</span>
<a href="#l1.491"></a><span id="l1.491" class="difflineplus">+                        NS_LITERAL_STRING(POP_MBOX_SUFFIX)) ||</span>
<a href="#l1.492"></a><span id="l1.492" class="difflineplus">+         StringEndsWith(currentFolderName,</span>
<a href="#l1.493"></a><span id="l1.493" class="difflineplus">+                        NS_LITERAL_STRING(IMAP_MBOX_SUFFIX)))) {</span>
<a href="#l1.494"></a><span id="l1.494" class="difflineplus">+      IMPORT_LOG1(&quot;Adding .mbox dir: %s&quot;,</span>
<a href="#l1.495"></a><span id="l1.495" class="difflineplus">+                  NS_ConvertUTF16toUTF8(currentFolderName).get());</span>
<a href="#l1.496"></a><span id="l1.496"> </span>
<a href="#l1.497"></a><span id="l1.497">       // add this .mbox</span>
<a href="#l1.498"></a><span id="l1.498">       rv = AddMboxDir(currentEntry, aMailboxDescs, aImportService);</span>
<a href="#l1.499"></a><span id="l1.499">       if (NS_FAILED(rv)) {</span>
<a href="#l1.500"></a><span id="l1.500" class="difflineminus">-        IMPORT_LOG1(&quot;Couldn't add .mbox for import: %s ... continuing anyway&quot;, NS_ConvertUTF16toUTF8(currentFolderName).get());</span>
<a href="#l1.501"></a><span id="l1.501" class="difflineplus">+        IMPORT_LOG1(&quot;Couldn't add .mbox for import: %s ... continuing anyway&quot;,</span>
<a href="#l1.502"></a><span id="l1.502" class="difflineplus">+                    NS_ConvertUTF16toUTF8(currentFolderName).get());</span>
<a href="#l1.503"></a><span id="l1.503">         continue;</span>
<a href="#l1.504"></a><span id="l1.504">       }</span>
<a href="#l1.505"></a><span id="l1.505"> </span>
<a href="#l1.506"></a><span id="l1.506">       // see if this .mbox dir has any sub-mailboxes</span>
<a href="#l1.507"></a><span id="l1.507">       nsAutoString siblingMailboxDirPath;</span>
<a href="#l1.508"></a><span id="l1.508">       currentEntry-&gt;GetPath(siblingMailboxDirPath);</span>
<a href="#l1.509"></a><span id="l1.509"> </span>
<a href="#l1.510"></a><span id="l1.510">       // cut off suffix</span>
<a href="#l1.511"></a><span id="l1.511" class="difflineminus">-      if (StringEndsWith(siblingMailboxDirPath, NS_LITERAL_STRING(IMAP_MBOX_SUFFIX)))</span>
<a href="#l1.512"></a><span id="l1.512" class="difflineminus">-        siblingMailboxDirPath.SetLength(siblingMailboxDirPath.Length()-9);</span>
<a href="#l1.513"></a><span id="l1.513" class="difflineminus">-      else if (StringEndsWith(siblingMailboxDirPath, NS_LITERAL_STRING(POP_MBOX_SUFFIX)))</span>
<a href="#l1.514"></a><span id="l1.514" class="difflineminus">-        siblingMailboxDirPath.SetLength(siblingMailboxDirPath.Length()-5);</span>
<a href="#l1.515"></a><span id="l1.515" class="difflineplus">+      if (StringEndsWith(siblingMailboxDirPath,</span>
<a href="#l1.516"></a><span id="l1.516" class="difflineplus">+                         NS_LITERAL_STRING(IMAP_MBOX_SUFFIX)))</span>
<a href="#l1.517"></a><span id="l1.517" class="difflineplus">+        siblingMailboxDirPath.SetLength(siblingMailboxDirPath.Length() - 9);</span>
<a href="#l1.518"></a><span id="l1.518" class="difflineplus">+      else if (StringEndsWith(siblingMailboxDirPath,</span>
<a href="#l1.519"></a><span id="l1.519" class="difflineplus">+                              NS_LITERAL_STRING(POP_MBOX_SUFFIX)))</span>
<a href="#l1.520"></a><span id="l1.520" class="difflineplus">+        siblingMailboxDirPath.SetLength(siblingMailboxDirPath.Length() - 5);</span>
<a href="#l1.521"></a><span id="l1.521"> </span>
<a href="#l1.522"></a><span id="l1.522" class="difflineminus">-      IMPORT_LOG1(&quot;trying to locate a '%s'&quot;, NS_ConvertUTF16toUTF8(siblingMailboxDirPath).get());</span>
<a href="#l1.523"></a><span id="l1.523" class="difflineminus">-      nsCOMPtr&lt;nsIFile&gt; siblingMailboxDir(do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv));</span>
<a href="#l1.524"></a><span id="l1.524" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l1.525"></a><span id="l1.525" class="difflineminus">-        continue;</span>
<a href="#l1.526"></a><span id="l1.526" class="difflineplus">+      IMPORT_LOG1(&quot;trying to locate a '%s'&quot;,</span>
<a href="#l1.527"></a><span id="l1.527" class="difflineplus">+                  NS_ConvertUTF16toUTF8(siblingMailboxDirPath).get());</span>
<a href="#l1.528"></a><span id="l1.528" class="difflineplus">+      nsCOMPtr&lt;nsIFile&gt; siblingMailboxDir(</span>
<a href="#l1.529"></a><span id="l1.529" class="difflineplus">+          do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv));</span>
<a href="#l1.530"></a><span id="l1.530" class="difflineplus">+      if (NS_FAILED(rv)) continue;</span>
<a href="#l1.531"></a><span id="l1.531"> </span>
<a href="#l1.532"></a><span id="l1.532">       rv = siblingMailboxDir-&gt;InitWithPath(siblingMailboxDirPath);</span>
<a href="#l1.533"></a><span id="l1.533">       bool reallyExists = false;</span>
<a href="#l1.534"></a><span id="l1.534">       siblingMailboxDir-&gt;Exists(&amp;reallyExists);</span>
<a href="#l1.535"></a><span id="l1.535"> </span>
<a href="#l1.536"></a><span id="l1.536">       if (NS_SUCCEEDED(rv) &amp;&amp; reallyExists) {</span>
<a href="#l1.537"></a><span id="l1.537" class="difflineminus">-        IMPORT_LOG1(&quot;Found what looks like an .mbox container: %s&quot;, NS_ConvertUTF16toUTF8(currentFolderName).get());</span>
<a href="#l1.538"></a><span id="l1.538" class="difflineplus">+        IMPORT_LOG1(&quot;Found what looks like an .mbox container: %s&quot;,</span>
<a href="#l1.539"></a><span id="l1.539" class="difflineplus">+                    NS_ConvertUTF16toUTF8(currentFolderName).get());</span>
<a href="#l1.540"></a><span id="l1.540"> </span>
<a href="#l1.541"></a><span id="l1.541">         // traverse this folder for other .mboxes</span>
<a href="#l1.542"></a><span id="l1.542">         mCurDepth++;</span>
<a href="#l1.543"></a><span id="l1.543">         FindMboxDirs(siblingMailboxDir, aMailboxDescs, aImportService);</span>
<a href="#l1.544"></a><span id="l1.544">         mCurDepth--;</span>
<a href="#l1.545"></a><span id="l1.545">       }</span>
<a href="#l1.546"></a><span id="l1.546">     }</span>
<a href="#l1.547"></a><span id="l1.547">   }</span>
<a href="#l1.548"></a><span id="l1.548"> </span>
<a href="#l1.549"></a><span id="l1.549">   return NS_OK;</span>
<a href="#l1.550"></a><span id="l1.550"> }</span>
<a href="#l1.551"></a><span id="l1.551"> </span>
<a href="#l1.552"></a><span id="l1.552"> NS_IMETHODIMP</span>
<a href="#l1.553"></a><span id="l1.553"> nsAppleMailImportMail::ImportMailbox(nsIImportMailboxDescriptor *aMailbox,</span>
<a href="#l1.554"></a><span id="l1.554">                                      nsIMsgFolder *aDstFolder,</span>
<a href="#l1.555"></a><span id="l1.555">                                      char16_t **aErrorLog,</span>
<a href="#l1.556"></a><span id="l1.556" class="difflineminus">-                                     char16_t **aSuccessLog, bool *aFatalError)</span>
<a href="#l1.557"></a><span id="l1.557" class="difflineminus">-{</span>
<a href="#l1.558"></a><span id="l1.558" class="difflineplus">+                                     char16_t **aSuccessLog,</span>
<a href="#l1.559"></a><span id="l1.559" class="difflineplus">+                                     bool *aFatalError) {</span>
<a href="#l1.560"></a><span id="l1.560">   nsAutoString errorLog, successLog;</span>
<a href="#l1.561"></a><span id="l1.561"> </span>
<a href="#l1.562"></a><span id="l1.562">   // reset progress</span>
<a href="#l1.563"></a><span id="l1.563">   mProgress = 0;</span>
<a href="#l1.564"></a><span id="l1.564"> </span>
<a href="#l1.565"></a><span id="l1.565">   nsAutoString mailboxName;</span>
<a href="#l1.566"></a><span id="l1.566">   aMailbox-&gt;GetDisplayName(getter_Copies(mailboxName));</span>
<a href="#l1.567"></a><span id="l1.567"> </span>
<a href="#l1.568"></a><span id="l1.568" class="difflineat">@@ -475,132 +487,129 @@ nsAppleMailImportMail::ImportMailbox(nsI</span>
<a href="#l1.569"></a><span id="l1.569">   aMailbox-&gt;GetIdentifier(&amp;mailboxIdentifier);</span>
<a href="#l1.570"></a><span id="l1.570"> </span>
<a href="#l1.571"></a><span id="l1.571">   if (mailboxIdentifier != kAccountMailboxID) {</span>
<a href="#l1.572"></a><span id="l1.572">     // move to the .mbox's Messages folder</span>
<a href="#l1.573"></a><span id="l1.573">     nsCOMPtr&lt;nsIFile&gt; messagesFolder;</span>
<a href="#l1.574"></a><span id="l1.574">     mboxFolder-&gt;Clone(getter_AddRefs(messagesFolder));</span>
<a href="#l1.575"></a><span id="l1.575">     rv = messagesFolder-&gt;Append(NS_LITERAL_STRING(&quot;Messages&quot;));</span>
<a href="#l1.576"></a><span id="l1.576">     if (NS_FAILED(rv)) {</span>
<a href="#l1.577"></a><span id="l1.577" class="difflineminus">-      // even if there are no messages, it might still be a valid mailbox, or even</span>
<a href="#l1.578"></a><span id="l1.578" class="difflineminus">-      // a parent for other mailboxes.</span>
<a href="#l1.579"></a><span id="l1.579" class="difflineplus">+      // even if there are no messages, it might still be a valid mailbox, or</span>
<a href="#l1.580"></a><span id="l1.580" class="difflineplus">+      // even a parent for other mailboxes.</span>
<a href="#l1.581"></a><span id="l1.581">       //</span>
<a href="#l1.582"></a><span id="l1.582" class="difflineminus">-      // just indicate that we're done, using the same number that we used to estimate</span>
<a href="#l1.583"></a><span id="l1.583" class="difflineminus">-      // number of messages earlier.</span>
<a href="#l1.584"></a><span id="l1.584" class="difflineplus">+      // just indicate that we're done, using the same number that we used to</span>
<a href="#l1.585"></a><span id="l1.585" class="difflineplus">+      // estimate number of messages earlier.</span>
<a href="#l1.586"></a><span id="l1.586">       uint32_t finalSize;</span>
<a href="#l1.587"></a><span id="l1.587">       aMailbox-&gt;GetSize(&amp;finalSize);</span>
<a href="#l1.588"></a><span id="l1.588">       mProgress = finalSize;</span>
<a href="#l1.589"></a><span id="l1.589"> </span>
<a href="#l1.590"></a><span id="l1.590">       // report that we successfully imported this mailbox</span>
<a href="#l1.591"></a><span id="l1.591">       ReportStatus(u&quot;ApplemailImportMailboxSuccess&quot;, mailboxName, successLog);</span>
<a href="#l1.592"></a><span id="l1.592">       SetLogs(successLog, errorLog, aSuccessLog, aErrorLog);</span>
<a href="#l1.593"></a><span id="l1.593">       return NS_OK;</span>
<a href="#l1.594"></a><span id="l1.594">     }</span>
<a href="#l1.595"></a><span id="l1.595"> </span>
<a href="#l1.596"></a><span id="l1.596">     // let's import the messages!</span>
<a href="#l1.597"></a><span id="l1.597">     nsCOMPtr&lt;nsIDirectoryEnumerator&gt; directoryEnumerator;</span>
<a href="#l1.598"></a><span id="l1.598" class="difflineminus">-    rv = messagesFolder-&gt;GetDirectoryEntries(getter_AddRefs(directoryEnumerator));</span>
<a href="#l1.599"></a><span id="l1.599" class="difflineplus">+    rv = messagesFolder-&gt;GetDirectoryEntries(</span>
<a href="#l1.600"></a><span id="l1.600" class="difflineplus">+        getter_AddRefs(directoryEnumerator));</span>
<a href="#l1.601"></a><span id="l1.601">     if (NS_FAILED(rv)) {</span>
<a href="#l1.602"></a><span id="l1.602" class="difflineminus">-      ReportStatus(u&quot;ApplemailImportMailboxConvertError&quot;, mailboxName, errorLog);</span>
<a href="#l1.603"></a><span id="l1.603" class="difflineplus">+      ReportStatus(u&quot;ApplemailImportMailboxConvertError&quot;, mailboxName,</span>
<a href="#l1.604"></a><span id="l1.604" class="difflineplus">+                   errorLog);</span>
<a href="#l1.605"></a><span id="l1.605">       SetLogs(successLog, errorLog, aSuccessLog, aErrorLog);</span>
<a href="#l1.606"></a><span id="l1.606">       return NS_ERROR_FAILURE;</span>
<a href="#l1.607"></a><span id="l1.607">     }</span>
<a href="#l1.608"></a><span id="l1.608"> </span>
<a href="#l1.609"></a><span id="l1.609">     // prepare an outstream to the destination file</span>
<a href="#l1.610"></a><span id="l1.610">     nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l1.611"></a><span id="l1.611">     rv = aDstFolder-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l1.612"></a><span id="l1.612">     if (!msgStore || NS_FAILED(rv)) {</span>
<a href="#l1.613"></a><span id="l1.613" class="difflineminus">-      ReportStatus(u&quot;ApplemailImportMailboxConverterror&quot;, mailboxName, errorLog);</span>
<a href="#l1.614"></a><span id="l1.614" class="difflineplus">+      ReportStatus(u&quot;ApplemailImportMailboxConverterror&quot;, mailboxName,</span>
<a href="#l1.615"></a><span id="l1.615" class="difflineplus">+                   errorLog);</span>
<a href="#l1.616"></a><span id="l1.616">       SetLogs(successLog, errorLog, aSuccessLog, aErrorLog);</span>
<a href="#l1.617"></a><span id="l1.617">       return NS_ERROR_FAILURE;</span>
<a href="#l1.618"></a><span id="l1.618">     }</span>
<a href="#l1.619"></a><span id="l1.619"> </span>
<a href="#l1.620"></a><span id="l1.620">     bool hasMore = false;</span>
<a href="#l1.621"></a><span id="l1.621">     nsCOMPtr&lt;nsIOutputStream&gt; outStream;</span>
<a href="#l1.622"></a><span id="l1.622"> </span>
<a href="#l1.623"></a><span id="l1.623" class="difflineminus">-    while (NS_SUCCEEDED(directoryEnumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l1.624"></a><span id="l1.624" class="difflineplus">+    while (NS_SUCCEEDED(directoryEnumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp;</span>
<a href="#l1.625"></a><span id="l1.625" class="difflineplus">+           hasMore) {</span>
<a href="#l1.626"></a><span id="l1.626">       // get the next file entry</span>
<a href="#l1.627"></a><span id="l1.627">       nsCOMPtr&lt;nsIFile&gt; currentEntry;</span>
<a href="#l1.628"></a><span id="l1.628">       directoryEnumerator-&gt;GetNextFile(getter_AddRefs(currentEntry));</span>
<a href="#l1.629"></a><span id="l1.629" class="difflineminus">-      if (!currentEntry)</span>
<a href="#l1.630"></a><span id="l1.630" class="difflineminus">-        continue;</span>
<a href="#l1.631"></a><span id="l1.631" class="difflineplus">+      if (!currentEntry) continue;</span>
<a href="#l1.632"></a><span id="l1.632"> </span>
<a href="#l1.633"></a><span id="l1.633">       // make sure it's an .emlx file</span>
<a href="#l1.634"></a><span id="l1.634">       bool isFile = false;</span>
<a href="#l1.635"></a><span id="l1.635">       currentEntry-&gt;IsFile(&amp;isFile);</span>
<a href="#l1.636"></a><span id="l1.636" class="difflineminus">-      if (!isFile)</span>
<a href="#l1.637"></a><span id="l1.637" class="difflineminus">-        continue;</span>
<a href="#l1.638"></a><span id="l1.638" class="difflineplus">+      if (!isFile) continue;</span>
<a href="#l1.639"></a><span id="l1.639"> </span>
<a href="#l1.640"></a><span id="l1.640">       nsAutoString leafName;</span>
<a href="#l1.641"></a><span id="l1.641">       currentEntry-&gt;GetLeafName(leafName);</span>
<a href="#l1.642"></a><span id="l1.642" class="difflineminus">-      if (!StringEndsWith(leafName, NS_LITERAL_STRING(&quot;.emlx&quot;)))</span>
<a href="#l1.643"></a><span id="l1.643" class="difflineminus">-        continue;</span>
<a href="#l1.644"></a><span id="l1.644" class="difflineplus">+      if (!StringEndsWith(leafName, NS_LITERAL_STRING(&quot;.emlx&quot;))) continue;</span>
<a href="#l1.645"></a><span id="l1.645"> </span>
<a href="#l1.646"></a><span id="l1.646">       nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.647"></a><span id="l1.647">       bool reusable;</span>
<a href="#l1.648"></a><span id="l1.648" class="difflineminus">-      rv = msgStore-&gt;GetNewMsgOutputStream(aDstFolder, getter_AddRefs(msgHdr),</span>
<a href="#l1.649"></a><span id="l1.649" class="difflineminus">-                                           &amp;reusable,</span>
<a href="#l1.650"></a><span id="l1.650" class="difflineminus">-                                           getter_AddRefs(outStream));</span>
<a href="#l1.651"></a><span id="l1.651" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l1.652"></a><span id="l1.652" class="difflineminus">-        break;</span>
<a href="#l1.653"></a><span id="l1.653" class="difflineplus">+      rv =</span>
<a href="#l1.654"></a><span id="l1.654" class="difflineplus">+          msgStore-&gt;GetNewMsgOutputStream(aDstFolder, getter_AddRefs(msgHdr),</span>
<a href="#l1.655"></a><span id="l1.655" class="difflineplus">+                                          &amp;reusable, getter_AddRefs(outStream));</span>
<a href="#l1.656"></a><span id="l1.656" class="difflineplus">+      if (NS_FAILED(rv)) break;</span>
<a href="#l1.657"></a><span id="l1.657"> </span>
<a href="#l1.658"></a><span id="l1.658">       // add the data to the mbox stream</span>
<a href="#l1.659"></a><span id="l1.659" class="difflineminus">-      if (NS_SUCCEEDED(nsEmlxHelperUtils::AddEmlxMessageToStream(currentEntry, outStream))) {</span>
<a href="#l1.660"></a><span id="l1.660" class="difflineplus">+      if (NS_SUCCEEDED(nsEmlxHelperUtils::AddEmlxMessageToStream(currentEntry,</span>
<a href="#l1.661"></a><span id="l1.661" class="difflineplus">+                                                                 outStream))) {</span>
<a href="#l1.662"></a><span id="l1.662">         mProgress++;</span>
<a href="#l1.663"></a><span id="l1.663">         msgStore-&gt;FinishNewMessage(outStream, msgHdr);</span>
<a href="#l1.664"></a><span id="l1.664" class="difflineminus">-      }</span>
<a href="#l1.665"></a><span id="l1.665" class="difflineminus">-      else {</span>
<a href="#l1.666"></a><span id="l1.666" class="difflineplus">+      } else {</span>
<a href="#l1.667"></a><span id="l1.667">         msgStore-&gt;DiscardNewMessage(outStream, msgHdr);</span>
<a href="#l1.668"></a><span id="l1.668">         break;</span>
<a href="#l1.669"></a><span id="l1.669">       }</span>
<a href="#l1.670"></a><span id="l1.670" class="difflineminus">-      if (!reusable)</span>
<a href="#l1.671"></a><span id="l1.671" class="difflineminus">-        outStream-&gt;Close();</span>
<a href="#l1.672"></a><span id="l1.672" class="difflineplus">+      if (!reusable) outStream-&gt;Close();</span>
<a href="#l1.673"></a><span id="l1.673">     }</span>
<a href="#l1.674"></a><span id="l1.674" class="difflineminus">-    if (outStream)</span>
<a href="#l1.675"></a><span id="l1.675" class="difflineminus">-      outStream-&gt;Close();</span>
<a href="#l1.676"></a><span id="l1.676" class="difflineplus">+    if (outStream) outStream-&gt;Close();</span>
<a href="#l1.677"></a><span id="l1.677">   }</span>
<a href="#l1.678"></a><span id="l1.678" class="difflineminus">-  // just indicate that we're done, using the same number that we used to estimate</span>
<a href="#l1.679"></a><span id="l1.679" class="difflineminus">-  // number of messages earlier.</span>
<a href="#l1.680"></a><span id="l1.680" class="difflineplus">+  // just indicate that we're done, using the same number that we used to</span>
<a href="#l1.681"></a><span id="l1.681" class="difflineplus">+  // estimate number of messages earlier.</span>
<a href="#l1.682"></a><span id="l1.682">   uint32_t finalSize;</span>
<a href="#l1.683"></a><span id="l1.683">   aMailbox-&gt;GetSize(&amp;finalSize);</span>
<a href="#l1.684"></a><span id="l1.684">   mProgress = finalSize;</span>
<a href="#l1.685"></a><span id="l1.685"> </span>
<a href="#l1.686"></a><span id="l1.686">   // report that we successfully imported this mailbox</span>
<a href="#l1.687"></a><span id="l1.687">   ReportStatus(u&quot;ApplemailImportMailboxSuccess&quot;, mailboxName, successLog);</span>
<a href="#l1.688"></a><span id="l1.688">   SetLogs(successLog, errorLog, aSuccessLog, aErrorLog);</span>
<a href="#l1.689"></a><span id="l1.689"> </span>
<a href="#l1.690"></a><span id="l1.690">   return NS_OK;</span>
<a href="#l1.691"></a><span id="l1.691"> }</span>
<a href="#l1.692"></a><span id="l1.692"> </span>
<a href="#l1.693"></a><span id="l1.693" class="difflineminus">-void nsAppleMailImportMail::ReportStatus(const char16_t* aErrorName, nsString &amp;aName,</span>
<a href="#l1.694"></a><span id="l1.694" class="difflineminus">-                                         nsAString &amp;aStream)</span>
<a href="#l1.695"></a><span id="l1.695" class="difflineminus">-{</span>
<a href="#l1.696"></a><span id="l1.696" class="difflineplus">+void nsAppleMailImportMail::ReportStatus(const char16_t *aErrorName,</span>
<a href="#l1.697"></a><span id="l1.697" class="difflineplus">+                                         nsString &amp;aName, nsAString &amp;aStream) {</span>
<a href="#l1.698"></a><span id="l1.698">   // get (and format, if needed) the error string from the bundle</span>
<a href="#l1.699"></a><span id="l1.699">   nsAutoString outString;</span>
<a href="#l1.700"></a><span id="l1.700" class="difflineminus">-  const char16_t *fmt = { aName.get() };</span>
<a href="#l1.701"></a><span id="l1.701" class="difflineminus">-  nsresult rv = mBundle-&gt;FormatStringFromName(NS_ConvertUTF16toUTF8(aErrorName).get(), &amp;fmt, 1, outString);</span>
<a href="#l1.702"></a><span id="l1.702" class="difflineplus">+  const char16_t *fmt = {aName.get()};</span>
<a href="#l1.703"></a><span id="l1.703" class="difflineplus">+  nsresult rv = mBundle-&gt;FormatStringFromName(</span>
<a href="#l1.704"></a><span id="l1.704" class="difflineplus">+      NS_ConvertUTF16toUTF8(aErrorName).get(), &amp;fmt, 1, outString);</span>
<a href="#l1.705"></a><span id="l1.705">   // write it out the stream</span>
<a href="#l1.706"></a><span id="l1.706">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l1.707"></a><span id="l1.707">     aStream.Append(outString);</span>
<a href="#l1.708"></a><span id="l1.708">     aStream.Append(char16_t('\n'));</span>
<a href="#l1.709"></a><span id="l1.709">   }</span>
<a href="#l1.710"></a><span id="l1.710"> }</span>
<a href="#l1.711"></a><span id="l1.711"> </span>
<a href="#l1.712"></a><span id="l1.712" class="difflineminus">-void nsAppleMailImportMail::SetLogs(const nsAString &amp;aSuccess, const nsAString &amp;aError, char16_t **aOutSuccess, char16_t **aOutError)</span>
<a href="#l1.713"></a><span id="l1.713" class="difflineminus">-{</span>
<a href="#l1.714"></a><span id="l1.714" class="difflineminus">-  if (aOutError &amp;&amp; !*aOutError)</span>
<a href="#l1.715"></a><span id="l1.715" class="difflineminus">-    *aOutError = ToNewUnicode(aError);</span>
<a href="#l1.716"></a><span id="l1.716" class="difflineminus">-  if (aOutSuccess &amp;&amp; !*aOutSuccess)</span>
<a href="#l1.717"></a><span id="l1.717" class="difflineminus">-    *aOutSuccess = ToNewUnicode(aSuccess);</span>
<a href="#l1.718"></a><span id="l1.718" class="difflineplus">+void nsAppleMailImportMail::SetLogs(const nsAString &amp;aSuccess,</span>
<a href="#l1.719"></a><span id="l1.719" class="difflineplus">+                                    const nsAString &amp;aError,</span>
<a href="#l1.720"></a><span id="l1.720" class="difflineplus">+                                    char16_t **aOutSuccess,</span>
<a href="#l1.721"></a><span id="l1.721" class="difflineplus">+                                    char16_t **aOutError) {</span>
<a href="#l1.722"></a><span id="l1.722" class="difflineplus">+  if (aOutError &amp;&amp; !*aOutError) *aOutError = ToNewUnicode(aError);</span>
<a href="#l1.723"></a><span id="l1.723" class="difflineplus">+  if (aOutSuccess &amp;&amp; !*aOutSuccess) *aOutSuccess = ToNewUnicode(aSuccess);</span>
<a href="#l1.724"></a><span id="l1.724"> }</span>
<a href="#l1.725"></a><span id="l1.725"> </span>
<a href="#l1.726"></a><span id="l1.726" class="difflineminus">-NS_IMETHODIMP nsAppleMailImportMail::GetImportProgress(uint32_t *aDoneSoFar)</span>
<a href="#l1.727"></a><span id="l1.727" class="difflineminus">-{</span>
<a href="#l1.728"></a><span id="l1.728" class="difflineplus">+NS_IMETHODIMP nsAppleMailImportMail::GetImportProgress(uint32_t *aDoneSoFar) {</span>
<a href="#l1.729"></a><span id="l1.729">   NS_ENSURE_ARG_POINTER(aDoneSoFar);</span>
<a href="#l1.730"></a><span id="l1.730">   *aDoneSoFar = mProgress;</span>
<a href="#l1.731"></a><span id="l1.731">   return NS_OK;</span>
<a href="#l1.732"></a><span id="l1.732"> }</span>
<a href="#l1.733"></a><span id="l1.733"> </span>
<a href="#l1.734"></a><span id="l1.734" class="difflineminus">-NS_IMETHODIMP nsAppleMailImportMail::TranslateFolderName(const nsAString &amp;aFolderName, nsAString &amp;aResult)</span>
<a href="#l1.735"></a><span id="l1.735" class="difflineminus">-{</span>
<a href="#l1.736"></a><span id="l1.736" class="difflineplus">+NS_IMETHODIMP nsAppleMailImportMail::TranslateFolderName(</span>
<a href="#l1.737"></a><span id="l1.737" class="difflineplus">+    const nsAString &amp;aFolderName, nsAString &amp;aResult) {</span>
<a href="#l1.738"></a><span id="l1.738">   aResult = aFolderName;</span>
<a href="#l1.739"></a><span id="l1.739">   return NS_OK;</span>
<a href="#l1.740"></a><span id="l1.740"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/import/applemail/src/nsAppleMailImport.h</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/import/applemail/src/nsAppleMailImport.h</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -8,64 +8,74 @@</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5"> #include &quot;mozilla/Logging.h&quot;</span>
<a href="#l2.6"></a><span id="l2.6"> #include &quot;nsIImportModule.h&quot;</span>
<a href="#l2.7"></a><span id="l2.7"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l2.8"></a><span id="l2.8"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l2.9"></a><span id="l2.9"> #include &quot;nsIImportMail.h&quot;</span>
<a href="#l2.10"></a><span id="l2.10"> #include &quot;ImportDebug.h&quot;</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-#define NS_APPLEMAILIMPL_CID \</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-{ 0x9117a1ea, 0xe012, 0x43b5, { 0xa0, 0x20, 0xcb, 0x8a, 0x66, 0xcc, 0x09, 0xe1 } }</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+#define NS_APPLEMAILIMPL_CID                         \</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+  {                                                  \</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+    0x9117a1ea, 0xe012, 0x43b5, {                    \</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+      0xa0, 0x20, 0xcb, 0x8a, 0x66, 0xcc, 0x09, 0xe1 \</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+    }                                                \</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+  }</span>
<a href="#l2.20"></a><span id="l2.20"> </span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">-#define NS_APPLEMAILIMPORT_CID \</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineminus">-{ 0x6d3f101c, 0x70ec, 0x4e04, { 0xb6, 0x8d, 0x99, 0x08, 0xd1, 0xae, 0xdd, 0xf3 } }</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+#define NS_APPLEMAILIMPORT_CID                       \</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+  {                                                  \</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+    0x6d3f101c, 0x70ec, 0x4e04, {                    \</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+      0xb6, 0x8d, 0x99, 0x08, 0xd1, 0xae, 0xdd, 0xf3 \</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+    }                                                \</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+  }</span>
<a href="#l2.29"></a><span id="l2.29"> </span>
<a href="#l2.30"></a><span id="l2.30"> #define NS_APPLEMAILIMPL_CONTRACTID &quot;@mozilla.org/import/import-appleMailImpl;1&quot;</span>
<a href="#l2.31"></a><span id="l2.31"> </span>
<a href="#l2.32"></a><span id="l2.32"> #define kAppleMailSupportsString &quot;mail&quot;</span>
<a href="#l2.33"></a><span id="l2.33"> </span>
<a href="#l2.34"></a><span id="l2.34"> class nsIImportService;</span>
<a href="#l2.35"></a><span id="l2.35"> class nsIMutableArray;</span>
<a href="#l2.36"></a><span id="l2.36"> </span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-class nsAppleMailImportModule : public nsIImportModule</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineminus">-{</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-  public:</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+class nsAppleMailImportModule : public nsIImportModule {</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+ public:</span>
<a href="#l2.43"></a><span id="l2.43">   nsAppleMailImportModule();</span>
<a href="#l2.44"></a><span id="l2.44"> </span>
<a href="#l2.45"></a><span id="l2.45">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l2.46"></a><span id="l2.46">   NS_DECL_NSIIMPORTMODULE</span>
<a href="#l2.47"></a><span id="l2.47"> </span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-  private:</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+ private:</span>
<a href="#l2.50"></a><span id="l2.50">   virtual ~nsAppleMailImportModule();</span>
<a href="#l2.51"></a><span id="l2.51"> </span>
<a href="#l2.52"></a><span id="l2.52">   nsCOMPtr&lt;nsIStringBundle&gt; mBundle;</span>
<a href="#l2.53"></a><span id="l2.53"> };</span>
<a href="#l2.54"></a><span id="l2.54"> </span>
<a href="#l2.55"></a><span id="l2.55" class="difflineminus">-class nsAppleMailImportMail : public nsIImportMail</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineminus">-{</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineminus">-  public:</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineminus">-</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+class nsAppleMailImportMail : public nsIImportMail {</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+ public:</span>
<a href="#l2.61"></a><span id="l2.61">   nsAppleMailImportMail();</span>
<a href="#l2.62"></a><span id="l2.62"> </span>
<a href="#l2.63"></a><span id="l2.63">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l2.64"></a><span id="l2.64">   NS_DECL_NSIIMPORTMAIL</span>
<a href="#l2.65"></a><span id="l2.65"> </span>
<a href="#l2.66"></a><span id="l2.66">   nsresult Initialize();</span>
<a href="#l2.67"></a><span id="l2.67"> </span>
<a href="#l2.68"></a><span id="l2.68" class="difflineminus">-  private:</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+ private:</span>
<a href="#l2.70"></a><span id="l2.70">   virtual ~nsAppleMailImportMail();</span>
<a href="#l2.71"></a><span id="l2.71"> </span>
<a href="#l2.72"></a><span id="l2.72" class="difflineminus">-  void FindAccountMailDirs(nsIFile *aRoot, nsIMutableArray *aMailboxDescs, nsIImportService *aImportService);</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineminus">-  nsresult FindMboxDirs(nsIFile *aFolder, nsIMutableArray *aMailboxDescs, nsIImportService *aImportService);</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineminus">-  nsresult AddMboxDir(nsIFile *aFolder, nsIMutableArray *aMailboxDescs, nsIImportService *aImportService);</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+  void FindAccountMailDirs(nsIFile *aRoot, nsIMutableArray *aMailboxDescs,</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+                           nsIImportService *aImportService);</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+  nsresult FindMboxDirs(nsIFile *aFolder, nsIMutableArray *aMailboxDescs,</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+                        nsIImportService *aImportService);</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+  nsresult AddMboxDir(nsIFile *aFolder, nsIMutableArray *aMailboxDescs,</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineplus">+                      nsIImportService *aImportService);</span>
<a href="#l2.81"></a><span id="l2.81"> </span>
<a href="#l2.82"></a><span id="l2.82" class="difflineminus">-  // aInfoString is the format to a &quot;foo %s&quot; string. It may be NULL if the error string needs no such format.</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineminus">-  void ReportStatus(const char16_t* aErrorName, nsString &amp;aName, nsAString &amp;aStream);</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineminus">-  static void SetLogs(const nsAString&amp; success, const nsAString&amp; error, char16_t **aOutErrorLog, char16_t **aSuccessLog);</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineplus">+  // aInfoString is the format to a &quot;foo %s&quot; string. It may be NULL if the error</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineplus">+  // string needs no such format.</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+  void ReportStatus(const char16_t *aErrorName, nsString &amp;aName,</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineplus">+                    nsAString &amp;aStream);</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineplus">+  static void SetLogs(const nsAString &amp;success, const nsAString &amp;error,</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+                      char16_t **aOutErrorLog, char16_t **aSuccessLog);</span>
<a href="#l2.91"></a><span id="l2.91"> </span>
<a href="#l2.92"></a><span id="l2.92" class="difflineminus">-  nsCOMPtr&lt;nsIStringBundle&gt;  mBundle;</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineminus">-  uint32_t                   mProgress;</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineminus">-  uint16_t                   mCurDepth;</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineplus">+  nsCOMPtr&lt;nsIStringBundle&gt; mBundle;</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineplus">+  uint32_t mProgress;</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineplus">+  uint16_t mCurDepth;</span>
<a href="#l2.98"></a><span id="l2.98"> };</span>
<a href="#l2.99"></a><span id="l2.99"> </span>
<a href="#l2.100"></a><span id="l2.100"> #endif /* nsAppleMailImport_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/import/applemail/src/nsEmlxHelperUtils.h</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/import/applemail/src/nsEmlxHelperUtils.h</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -9,47 +9,53 @@</span>
<a href="#l3.4"></a><span id="l3.4"> #include &quot;nscore.h&quot;</span>
<a href="#l3.5"></a><span id="l3.5"> #include &quot;nsString.h&quot;</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7"> class nsIOutputStream;</span>
<a href="#l3.8"></a><span id="l3.8"> class nsIFile;</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10"> class nsEmlxHelperUtils {</span>
<a href="#l3.11"></a><span id="l3.11">   /* All emlx messages have a &quot;flags&quot; number in the metadata.</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-     These are the masks to decode that, found via http://jwz.livejournal.com/505711.html */</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+     These are the masks to decode that, found via</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+     http://jwz.livejournal.com/505711.html */</span>
<a href="#l3.15"></a><span id="l3.15">   enum EmlxMetadataMask {</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-    kRead       = 1 &lt;&lt; 0,  // read</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+    kRead = 1 &lt;&lt; 0,  // read</span>
<a href="#l3.18"></a><span id="l3.18">     // 1 &lt;&lt; 1,             // deleted</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-    kAnswered   = 1 &lt;&lt; 2,  // answered</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+    kAnswered = 1 &lt;&lt; 2,  // answered</span>
<a href="#l3.21"></a><span id="l3.21">     // 1 &lt;&lt; 3,             // encrypted</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-    kFlagged    = 1 &lt;&lt; 4,  // flagged</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+    kFlagged = 1 &lt;&lt; 4,  // flagged</span>
<a href="#l3.24"></a><span id="l3.24">     // 1 &lt;&lt; 5,             // recent</span>
<a href="#l3.25"></a><span id="l3.25">     // 1 &lt;&lt; 6,             // draft</span>
<a href="#l3.26"></a><span id="l3.26">     // 1 &lt;&lt; 7,             // initial (no longer used)</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">-    kForwarded  = 1 &lt;&lt; 8,  // forwarded</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+    kForwarded = 1 &lt;&lt; 8,  // forwarded</span>
<a href="#l3.29"></a><span id="l3.29">     // 1 &lt;&lt; 9,             // redirected</span>
<a href="#l3.30"></a><span id="l3.30">     // 3F &lt;&lt; 10,           // attachment count (6 bits)</span>
<a href="#l3.31"></a><span id="l3.31">     // 7F &lt;&lt; 16,           // priority level (7 bits)</span>
<a href="#l3.32"></a><span id="l3.32">     // 1 &lt;&lt; 23,            // signed</span>
<a href="#l3.33"></a><span id="l3.33">     // 1 &lt;&lt; 24,            // is junk</span>
<a href="#l3.34"></a><span id="l3.34">     // 1 &lt;&lt; 25,            // is not junk</span>
<a href="#l3.35"></a><span id="l3.35">     // 1 &lt;&lt; 26,            // font size delta 7 (3 bits)</span>
<a href="#l3.36"></a><span id="l3.36">     // 1 &lt;&lt; 29,            // junk mail level recorded</span>
<a href="#l3.37"></a><span id="l3.37">     // 1 &lt;&lt; 30,            // highlight text in toc</span>
<a href="#l3.38"></a><span id="l3.38">     // 1 &lt;&lt; 31             // (unused)</span>
<a href="#l3.39"></a><span id="l3.39">   };</span>
<a href="#l3.40"></a><span id="l3.40"> </span>
<a href="#l3.41"></a><span id="l3.41" class="difflineminus">-  // This method will scan the raw EMLX message buffer for &quot;dangerous&quot; so-called &quot;From-lines&quot; that we need to escape.</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-  // If it needs to modify any lines, it will return a non-NULL aOutBuffer. If aOutBuffer is NULL, no modification needed</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineminus">-  // to be made.</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineminus">-  static nsresult ConvertToMboxRD(const char *aMessageBufferStart, const char *aMessageBufferEnd, nsCString &amp;aOutBuffer);</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+  // This method will scan the raw EMLX message buffer for &quot;dangerous&quot; so-called</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+  // &quot;From-lines&quot; that we need to escape. If it needs to modify any lines, it</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+  // will return a non-NULL aOutBuffer. If aOutBuffer is NULL, no modification</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+  // needed to be made.</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+  static nsresult ConvertToMboxRD(const char *aMessageBufferStart,</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+                                  const char *aMessageBufferEnd,</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+                                  nsCString &amp;aOutBuffer);</span>
<a href="#l3.52"></a><span id="l3.52"> </span>
<a href="#l3.53"></a><span id="l3.53" class="difflineminus">-  // returns an int representing the X-Mozilla-Status flags set (e.g. &quot;read&quot;, &quot;flagged&quot;) converted from EMLX flags.</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineminus">-  static nsresult ConvertToMozillaStatusFlags(const char *aXMLBufferStart, const char *aXMLBufferEnd, uint32_t *aMozillaStatusFlags);</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+  // returns an int representing the X-Mozilla-Status flags set (e.g. &quot;read&quot;,</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+  // &quot;flagged&quot;) converted from EMLX flags.</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+  static nsresult ConvertToMozillaStatusFlags(const char *aXMLBufferStart,</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+                                              const char *aXMLBufferEnd,</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+                                              uint32_t *aMozillaStatusFlags);</span>
<a href="#l3.60"></a><span id="l3.60"> </span>
<a href="#l3.61"></a><span id="l3.61" class="difflineminus">-  public:</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineminus">-</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+ public:</span>
<a href="#l3.64"></a><span id="l3.64">   // add an .emlx message to the mbox output</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineminus">-  static nsresult AddEmlxMessageToStream(nsIFile *aEmlxFile, nsIOutputStream *aOutoutStream);</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineminus">-</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+  static nsresult AddEmlxMessageToStream(nsIFile *aEmlxFile,</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+                                         nsIOutputStream *aOutoutStream);</span>
<a href="#l3.69"></a><span id="l3.69"> };</span>
<a href="#l3.70"></a><span id="l3.70"> </span>
<a href="#l3.71"></a><span id="l3.71" class="difflineminus">-#endif // nsEmlxHelperUtils_h___</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineplus">+#endif  // nsEmlxHelperUtils_h___</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/import/applemail/src/nsEmlxHelperUtils.mm</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/import/applemail/src/nsEmlxHelperUtils.mm</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -13,104 +13,95 @@</span>
<a href="#l4.4"></a><span id="l4.4"> #include &quot;msgCore.h&quot;</span>
<a href="#l4.5"></a><span id="l4.5"> #include &quot;nsTArray.h&quot;</span>
<a href="#l4.6"></a><span id="l4.6"> #include &quot;nsAppleMailImport.h&quot;</span>
<a href="#l4.7"></a><span id="l4.7"> #include &quot;prprf.h&quot;</span>
<a href="#l4.8"></a><span id="l4.8"> #include &quot;nsIFile.h&quot;</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10"> #import &lt;Cocoa/Cocoa.h&gt;</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-</span>
<a href="#l4.13"></a><span id="l4.13"> nsresult nsEmlxHelperUtils::ConvertToMozillaStatusFlags(const char *aXMLBufferStart,</span>
<a href="#l4.14"></a><span id="l4.14">                                                         const char *aXMLBufferEnd,</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-                                                        uint32_t *aMozillaStatusFlags)</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineminus">-{</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+                                                        uint32_t *aMozillaStatusFlags) {</span>
<a href="#l4.18"></a><span id="l4.18">   // create a NSData wrapper around the buffer, so we can use the Cocoa call below</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineminus">-  NSData *metadata =</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineminus">-    [[[NSData alloc] initWithBytesNoCopy:(void *)aXMLBufferStart length:(aXMLBufferEnd-aXMLBufferStart) freeWhenDone:NO] autorelease];</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+  NSData *metadata = [[[NSData alloc] initWithBytesNoCopy:(void *)aXMLBufferStart</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+                                                   length:(aXMLBufferEnd - aXMLBufferStart)</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+                                             freeWhenDone:NO] autorelease];</span>
<a href="#l4.24"></a><span id="l4.24"> </span>
<a href="#l4.25"></a><span id="l4.25">   // get the XML data as a dictionary</span>
<a href="#l4.26"></a><span id="l4.26">   NSPropertyListFormat format;</span>
<a href="#l4.27"></a><span id="l4.27">   id plist = [NSPropertyListSerialization propertyListWithData:metadata</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineminus">-                                              options:NSPropertyListImmutable</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+                                                       options:NSPropertyListImmutable</span>
<a href="#l4.30"></a><span id="l4.30">                                                         format:&amp;format</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-                                              error:NULL];</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+                                                         error:NULL];</span>
<a href="#l4.33"></a><span id="l4.33"> </span>
<a href="#l4.34"></a><span id="l4.34" class="difflineminus">-  if (!plist)</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+  if (!plist) return NS_ERROR_FAILURE;</span>
<a href="#l4.37"></a><span id="l4.37"> </span>
<a href="#l4.38"></a><span id="l4.38">   // find the &lt;flags&gt;...&lt;/flags&gt; value and convert to int</span>
<a href="#l4.39"></a><span id="l4.39">   const uint32_t emlxMessageFlags = [[(NSDictionary *)plist objectForKey:@&quot;flags&quot;] intValue];</span>
<a href="#l4.40"></a><span id="l4.40"> </span>
<a href="#l4.41"></a><span id="l4.41" class="difflineminus">-  if (emlxMessageFlags == 0)</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+  if (emlxMessageFlags == 0) return NS_ERROR_FAILURE;</span>
<a href="#l4.44"></a><span id="l4.44"> </span>
<a href="#l4.45"></a><span id="l4.45" class="difflineminus">-  if (emlxMessageFlags &amp; nsEmlxHelperUtils::kRead)</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineminus">-    *aMozillaStatusFlags |= nsMsgMessageFlags::Read;</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+  if (emlxMessageFlags &amp; nsEmlxHelperUtils::kRead) *aMozillaStatusFlags |= nsMsgMessageFlags::Read;</span>
<a href="#l4.48"></a><span id="l4.48">   if (emlxMessageFlags &amp; nsEmlxHelperUtils::kForwarded)</span>
<a href="#l4.49"></a><span id="l4.49">     *aMozillaStatusFlags |= nsMsgMessageFlags::Forwarded;</span>
<a href="#l4.50"></a><span id="l4.50">   if (emlxMessageFlags &amp; nsEmlxHelperUtils::kAnswered)</span>
<a href="#l4.51"></a><span id="l4.51">     *aMozillaStatusFlags |= nsMsgMessageFlags::Replied;</span>
<a href="#l4.52"></a><span id="l4.52">   if (emlxMessageFlags &amp; nsEmlxHelperUtils::kFlagged)</span>
<a href="#l4.53"></a><span id="l4.53">     *aMozillaStatusFlags |= nsMsgMessageFlags::Marked;</span>
<a href="#l4.54"></a><span id="l4.54"> </span>
<a href="#l4.55"></a><span id="l4.55">   return NS_OK;</span>
<a href="#l4.56"></a><span id="l4.56"> }</span>
<a href="#l4.57"></a><span id="l4.57"> </span>
<a href="#l4.58"></a><span id="l4.58" class="difflineminus">-nsresult nsEmlxHelperUtils::ConvertToMboxRD(const char *aMessageBufferStart, const char *aMessageBufferEnd, nsCString &amp;aOutBuffer)</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineminus">-{</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+nsresult nsEmlxHelperUtils::ConvertToMboxRD(const char *aMessageBufferStart,</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+                                            const char *aMessageBufferEnd, nsCString &amp;aOutBuffer) {</span>
<a href="#l4.62"></a><span id="l4.62">   nsTArray&lt;const char *&gt; foundFromLines;</span>
<a href="#l4.63"></a><span id="l4.63"> </span>
<a href="#l4.64"></a><span id="l4.64">   const char *cur = aMessageBufferStart;</span>
<a href="#l4.65"></a><span id="l4.65">   while (cur &lt; aMessageBufferEnd) {</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineminus">-</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineminus">-    const char *foundFromStr = strnstr(cur, &quot;From &quot;, aMessageBufferEnd-cur);</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+    const char *foundFromStr = strnstr(cur, &quot;From &quot;, aMessageBufferEnd - cur);</span>
<a href="#l4.69"></a><span id="l4.69"> </span>
<a href="#l4.70"></a><span id="l4.70">     if (foundFromStr) {</span>
<a href="#l4.71"></a><span id="l4.71">       // skip all prepending '&gt;' chars</span>
<a href="#l4.72"></a><span id="l4.72">       const char *fromLineStart = foundFromStr;</span>
<a href="#l4.73"></a><span id="l4.73">       while (fromLineStart-- &gt;= aMessageBufferStart) {</span>
<a href="#l4.74"></a><span id="l4.74">         if (*fromLineStart == '\n' || fromLineStart == aMessageBufferStart) {</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineminus">-          if (fromLineStart &gt; aMessageBufferStart)</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineminus">-            fromLineStart++;</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+          if (fromLineStart &gt; aMessageBufferStart) fromLineStart++;</span>
<a href="#l4.78"></a><span id="l4.78">           foundFromLines.AppendElement(fromLineStart);</span>
<a href="#l4.79"></a><span id="l4.79">           break;</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineminus">-        }</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineminus">-        else if (*fromLineStart != '&gt;')</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+        } else if (*fromLineStart != '&gt;')</span>
<a href="#l4.83"></a><span id="l4.83">           break;</span>
<a href="#l4.84"></a><span id="l4.84">       }</span>
<a href="#l4.85"></a><span id="l4.85"> </span>
<a href="#l4.86"></a><span id="l4.86">       // advance past the last found From string.</span>
<a href="#l4.87"></a><span id="l4.87">       cur = foundFromStr + 5;</span>
<a href="#l4.88"></a><span id="l4.88"> </span>
<a href="#l4.89"></a><span id="l4.89">       // look for more From lines.</span>
<a href="#l4.90"></a><span id="l4.90">       continue;</span>
<a href="#l4.91"></a><span id="l4.91">     }</span>
<a href="#l4.92"></a><span id="l4.92"> </span>
<a href="#l4.93"></a><span id="l4.93">     break;</span>
<a href="#l4.94"></a><span id="l4.94">   }</span>
<a href="#l4.95"></a><span id="l4.95"> </span>
<a href="#l4.96"></a><span id="l4.96">   // go through foundFromLines</span>
<a href="#l4.97"></a><span id="l4.97">   if (foundFromLines.Length()) {</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineminus">-</span>
<a href="#l4.99"></a><span id="l4.99">     const char *chunkStart = aMessageBufferStart;</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineminus">-    for (unsigned i=0; i&lt;foundFromLines.Length(); ++i) {</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineminus">-      aOutBuffer.Append(chunkStart, (foundFromLines[i]-chunkStart));</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+    for (unsigned i = 0; i &lt; foundFromLines.Length(); ++i) {</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+      aOutBuffer.Append(chunkStart, (foundFromLines[i] - chunkStart));</span>
<a href="#l4.104"></a><span id="l4.104">       aOutBuffer.Append(NS_LITERAL_CSTRING(&quot;&gt;&quot;));</span>
<a href="#l4.105"></a><span id="l4.105"> </span>
<a href="#l4.106"></a><span id="l4.106">       chunkStart = foundFromLines[i];</span>
<a href="#l4.107"></a><span id="l4.107">     }</span>
<a href="#l4.108"></a><span id="l4.108">     aOutBuffer.Append(chunkStart, (aMessageBufferEnd - chunkStart));</span>
<a href="#l4.109"></a><span id="l4.109">   }</span>
<a href="#l4.110"></a><span id="l4.110"> </span>
<a href="#l4.111"></a><span id="l4.111">   return NS_OK;</span>
<a href="#l4.112"></a><span id="l4.112"> }</span>
<a href="#l4.113"></a><span id="l4.113"> </span>
<a href="#l4.114"></a><span id="l4.114" class="difflineminus">-nsresult nsEmlxHelperUtils::AddEmlxMessageToStream(nsIFile *aMessage, nsIOutputStream *aOut)</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineminus">-{</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineplus">+nsresult nsEmlxHelperUtils::AddEmlxMessageToStream(nsIFile *aMessage, nsIOutputStream *aOut) {</span>
<a href="#l4.117"></a><span id="l4.117">   NS_OBJC_BEGIN_TRY_ABORT_BLOCK_NSRESULT;</span>
<a href="#l4.118"></a><span id="l4.118"> </span>
<a href="#l4.119"></a><span id="l4.119">   // needed to be sure autoreleased objects are released too, which they might not</span>
<a href="#l4.120"></a><span id="l4.120">   // in a C++ environment where the main event loop has no autorelease pool (e.g on a XPCOM thread)</span>
<a href="#l4.121"></a><span id="l4.121">   NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];</span>
<a href="#l4.122"></a><span id="l4.122"> </span>
<a href="#l4.123"></a><span id="l4.123">   nsresult rv = NS_ERROR_FAILURE;</span>
<a href="#l4.124"></a><span id="l4.124"> </span>
<a href="#l4.125"></a><span id="l4.125" class="difflineat">@@ -138,33 +129,32 @@ nsresult nsEmlxHelperUtils::AddEmlxMessa</span>
<a href="#l4.126"></a><span id="l4.126">   // message data is.</span>
<a href="#l4.127"></a><span id="l4.127">   uint64_t numberOfBytesToRead = strtol((char *)[data bytes], &amp;startOfMessageData, 10);</span>
<a href="#l4.128"></a><span id="l4.128">   if (numberOfBytesToRead &lt;= 0 || !startOfMessageData) {</span>
<a href="#l4.129"></a><span id="l4.129">     [pool release];</span>
<a href="#l4.130"></a><span id="l4.130">     return NS_ERROR_FAILURE;</span>
<a href="#l4.131"></a><span id="l4.131">   }</span>
<a href="#l4.132"></a><span id="l4.132"> </span>
<a href="#l4.133"></a><span id="l4.133">   // skip whitespace</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineminus">-  while (*startOfMessageData == ' '  ||</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineminus">-         *startOfMessageData == '\n' ||</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineminus">-         *startOfMessageData == '\r' ||</span>
<a href="#l4.137"></a><span id="l4.137" class="difflineplus">+  while (*startOfMessageData == ' ' || *startOfMessageData == '\n' || *startOfMessageData == '\r' ||</span>
<a href="#l4.138"></a><span id="l4.138">          *startOfMessageData == '\t')</span>
<a href="#l4.139"></a><span id="l4.139">     ++startOfMessageData;</span>
<a href="#l4.140"></a><span id="l4.140"> </span>
<a href="#l4.141"></a><span id="l4.141">   NS_NAMED_LITERAL_CSTRING(kBogusFromLine, &quot;From \n&quot;);</span>
<a href="#l4.142"></a><span id="l4.142">   NS_NAMED_LITERAL_CSTRING(kEndOfMessage, &quot;\n\n&quot;);</span>
<a href="#l4.143"></a><span id="l4.143"> </span>
<a href="#l4.144"></a><span id="l4.144">   // write the bogus &quot;From &quot; line which is a magic separator in the mbox format</span>
<a href="#l4.145"></a><span id="l4.145">   rv = aOut-&gt;Write(kBogusFromLine.get(), kBogusFromLine.Length(), &amp;actualBytesWritten);</span>
<a href="#l4.146"></a><span id="l4.146">   if (NS_FAILED(rv)) {</span>
<a href="#l4.147"></a><span id="l4.147">     [pool release];</span>
<a href="#l4.148"></a><span id="l4.148">     return rv;</span>
<a href="#l4.149"></a><span id="l4.149">   }</span>
<a href="#l4.150"></a><span id="l4.150"> </span>
<a href="#l4.151"></a><span id="l4.151" class="difflineminus">-  // now read the XML metadata, so we can extract info like which flags (read? replied? flagged? etc) this message has.</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineplus">+  // now read the XML metadata, so we can extract info like which flags (read? replied? flagged?</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineplus">+  // etc) this message has.</span>
<a href="#l4.154"></a><span id="l4.154">   const char *startOfXMLMetadata = startOfMessageData + numberOfBytesToRead;</span>
<a href="#l4.155"></a><span id="l4.155">   const char *endOfXMLMetadata = (char *)[data bytes] + [data length];</span>
<a href="#l4.156"></a><span id="l4.156"> </span>
<a href="#l4.157"></a><span id="l4.157">   uint32_t x_mozilla_flags = 0;</span>
<a href="#l4.158"></a><span id="l4.158">   ConvertToMozillaStatusFlags(startOfXMLMetadata, endOfXMLMetadata, &amp;x_mozilla_flags);</span>
<a href="#l4.159"></a><span id="l4.159"> </span>
<a href="#l4.160"></a><span id="l4.160">   // write the X-Mozilla-Status header according to which flags we've gathered above.</span>
<a href="#l4.161"></a><span id="l4.161">   uint32_t dummyRv;</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineat">@@ -200,17 +190,18 @@ nsresult nsEmlxHelperUtils::AddEmlxMessa</span>
<a href="#l4.163"></a><span id="l4.163">   rv = aOut-&gt;Write(buf.get(), buf.Length(), &amp;dummyRv);</span>
<a href="#l4.164"></a><span id="l4.164">   if (NS_FAILED(rv)) {</span>
<a href="#l4.165"></a><span id="l4.165">     [pool release];</span>
<a href="#l4.166"></a><span id="l4.166">     return rv;</span>
<a href="#l4.167"></a><span id="l4.167">   }</span>
<a href="#l4.168"></a><span id="l4.168"> </span>
<a href="#l4.169"></a><span id="l4.169">   // do any conversion needed for the mbox data to be valid mboxrd.</span>
<a href="#l4.170"></a><span id="l4.170">   nsCString convertedData;</span>
<a href="#l4.171"></a><span id="l4.171" class="difflineminus">-  rv = ConvertToMboxRD(startOfMessageData, (startOfMessageData + numberOfBytesToRead), convertedData);</span>
<a href="#l4.172"></a><span id="l4.172" class="difflineplus">+  rv = ConvertToMboxRD(startOfMessageData, (startOfMessageData + numberOfBytesToRead),</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineplus">+                       convertedData);</span>
<a href="#l4.174"></a><span id="l4.174">   if (NS_FAILED(rv)) {</span>
<a href="#l4.175"></a><span id="l4.175">     [pool release];</span>
<a href="#l4.176"></a><span id="l4.176">     return rv;</span>
<a href="#l4.177"></a><span id="l4.177">   }</span>
<a href="#l4.178"></a><span id="l4.178"> </span>
<a href="#l4.179"></a><span id="l4.179">   // write the actual message data.</span>
<a href="#l4.180"></a><span id="l4.180">   if (convertedData.IsEmpty())</span>
<a href="#l4.181"></a><span id="l4.181">     rv = aOut-&gt;Write(startOfMessageData, (uint32_t)numberOfBytesToRead, &amp;actualBytesWritten);</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineat">@@ -219,17 +210,18 @@ nsresult nsEmlxHelperUtils::AddEmlxMessa</span>
<a href="#l4.183"></a><span id="l4.183">     rv = aOut-&gt;Write(convertedData.get(), convertedData.Length(), &amp;actualBytesWritten);</span>
<a href="#l4.184"></a><span id="l4.184">   }</span>
<a href="#l4.185"></a><span id="l4.185"> </span>
<a href="#l4.186"></a><span id="l4.186">   if (NS_FAILED(rv)) {</span>
<a href="#l4.187"></a><span id="l4.187">     [pool release];</span>
<a href="#l4.188"></a><span id="l4.188">     return rv;</span>
<a href="#l4.189"></a><span id="l4.189">   }</span>
<a href="#l4.190"></a><span id="l4.190"> </span>
<a href="#l4.191"></a><span id="l4.191" class="difflineminus">-  NS_ASSERTION(actualBytesWritten == (convertedData.IsEmpty() ? numberOfBytesToRead : convertedData.Length()),</span>
<a href="#l4.192"></a><span id="l4.192" class="difflineplus">+  NS_ASSERTION(actualBytesWritten ==</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineplus">+                   (convertedData.IsEmpty() ? numberOfBytesToRead : convertedData.Length()),</span>
<a href="#l4.194"></a><span id="l4.194">                &quot;Didn't write as many bytes as expected for .emlx file?&quot;);</span>
<a href="#l4.195"></a><span id="l4.195"> </span>
<a href="#l4.196"></a><span id="l4.196">   // add newlines to denote the end of this message in the mbox</span>
<a href="#l4.197"></a><span id="l4.197">   rv = aOut-&gt;Write(kEndOfMessage.get(), kEndOfMessage.Length(), &amp;actualBytesWritten);</span>
<a href="#l4.198"></a><span id="l4.198"> </span>
<a href="#l4.199"></a><span id="l4.199">   [pool release];</span>
<a href="#l4.200"></a><span id="l4.200"> </span>
<a href="#l4.201"></a><span id="l4.201">   return rv;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/import/becky/src/nsBeckyAddressBooks.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/import/becky/src/nsBeckyAddressBooks.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -17,177 +17,148 @@</span>
<a href="#l5.4"></a><span id="l5.4"> #include &quot;nsVCardAddress.h&quot;</span>
<a href="#l5.5"></a><span id="l5.5"> </span>
<a href="#l5.6"></a><span id="l5.6"> #include &quot;nsBeckyAddressBooks.h&quot;</span>
<a href="#l5.7"></a><span id="l5.7"> #include &quot;nsBeckyStringBundle.h&quot;</span>
<a href="#l5.8"></a><span id="l5.8"> #include &quot;nsBeckyUtils.h&quot;</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10"> NS_IMPL_ISUPPORTS(nsBeckyAddressBooks, nsIImportAddressBooks)</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-nsresult</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-nsBeckyAddressBooks::Create(nsIImportAddressBooks **aImport)</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-{</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+nsresult nsBeckyAddressBooks::Create(nsIImportAddressBooks **aImport) {</span>
<a href="#l5.16"></a><span id="l5.16">   NS_ENSURE_ARG_POINTER(aImport);</span>
<a href="#l5.17"></a><span id="l5.17">   NS_ADDREF(*aImport = new nsBeckyAddressBooks());</span>
<a href="#l5.18"></a><span id="l5.18">   return NS_OK;</span>
<a href="#l5.19"></a><span id="l5.19"> }</span>
<a href="#l5.20"></a><span id="l5.20"> </span>
<a href="#l5.21"></a><span id="l5.21" class="difflineminus">-nsBeckyAddressBooks::nsBeckyAddressBooks()</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineminus">-: mReadBytes(0)</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineminus">-{</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineminus">-}</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+nsBeckyAddressBooks::nsBeckyAddressBooks() : mReadBytes(0) {}</span>
<a href="#l5.26"></a><span id="l5.26"> </span>
<a href="#l5.27"></a><span id="l5.27" class="difflineminus">-nsBeckyAddressBooks::~nsBeckyAddressBooks()</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineminus">-{</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineminus">-}</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+nsBeckyAddressBooks::~nsBeckyAddressBooks() {}</span>
<a href="#l5.31"></a><span id="l5.31"> </span>
<a href="#l5.32"></a><span id="l5.32"> NS_IMETHODIMP</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-nsBeckyAddressBooks::GetSupportsMultiple(bool *_retval)</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-{</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+nsBeckyAddressBooks::GetSupportsMultiple(bool *_retval) {</span>
<a href="#l5.36"></a><span id="l5.36">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l5.37"></a><span id="l5.37">   *_retval = true;</span>
<a href="#l5.38"></a><span id="l5.38">   return NS_OK;</span>
<a href="#l5.39"></a><span id="l5.39"> }</span>
<a href="#l5.40"></a><span id="l5.40"> </span>
<a href="#l5.41"></a><span id="l5.41"> NS_IMETHODIMP</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineminus">-nsBeckyAddressBooks::GetAutoFind(char16_t **aDescription,</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-                                 bool *_retval)</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-{</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+nsBeckyAddressBooks::GetAutoFind(char16_t **aDescription, bool *_retval) {</span>
<a href="#l5.46"></a><span id="l5.46">   NS_ENSURE_ARG_POINTER(aDescription);</span>
<a href="#l5.47"></a><span id="l5.47">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l5.48"></a><span id="l5.48"> </span>
<a href="#l5.49"></a><span id="l5.49">   *aDescription =</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineminus">-    nsBeckyStringBundle::GetStringByName(&quot;BeckyImportDescription&quot;);</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+      nsBeckyStringBundle::GetStringByName(&quot;BeckyImportDescription&quot;);</span>
<a href="#l5.52"></a><span id="l5.52">   *_retval = false;</span>
<a href="#l5.53"></a><span id="l5.53"> </span>
<a href="#l5.54"></a><span id="l5.54">   return NS_OK;</span>
<a href="#l5.55"></a><span id="l5.55"> }</span>
<a href="#l5.56"></a><span id="l5.56"> </span>
<a href="#l5.57"></a><span id="l5.57"> NS_IMETHODIMP</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineminus">-nsBeckyAddressBooks::GetNeedsFieldMap(nsIFile *aLocation, bool *_retval)</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineminus">-{</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+nsBeckyAddressBooks::GetNeedsFieldMap(nsIFile *aLocation, bool *_retval) {</span>
<a href="#l5.61"></a><span id="l5.61">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l5.62"></a><span id="l5.62"> </span>
<a href="#l5.63"></a><span id="l5.63">   *_retval = false;</span>
<a href="#l5.64"></a><span id="l5.64">   return NS_OK;</span>
<a href="#l5.65"></a><span id="l5.65"> }</span>
<a href="#l5.66"></a><span id="l5.66"> </span>
<a href="#l5.67"></a><span id="l5.67" class="difflineminus">-nsresult</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineminus">-nsBeckyAddressBooks::FindAddressBookDirectory(nsIFile **aAddressBookDirectory)</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineminus">-{</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineplus">+nsresult nsBeckyAddressBooks::FindAddressBookDirectory(</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+    nsIFile **aAddressBookDirectory) {</span>
<a href="#l5.72"></a><span id="l5.72">   nsCOMPtr&lt;nsIFile&gt; userDirectory;</span>
<a href="#l5.73"></a><span id="l5.73">   nsresult rv = nsBeckyUtils::FindUserDirectory(getter_AddRefs(userDirectory));</span>
<a href="#l5.74"></a><span id="l5.74">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.75"></a><span id="l5.75"> </span>
<a href="#l5.76"></a><span id="l5.76">   rv = userDirectory-&gt;Append(NS_LITERAL_STRING(&quot;AddrBook&quot;));</span>
<a href="#l5.77"></a><span id="l5.77">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.78"></a><span id="l5.78"> </span>
<a href="#l5.79"></a><span id="l5.79">   bool exists = false;</span>
<a href="#l5.80"></a><span id="l5.80">   rv = userDirectory-&gt;Exists(&amp;exists);</span>
<a href="#l5.81"></a><span id="l5.81">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineminus">-  if (!exists)</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineminus">-    return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineplus">+  if (!exists) return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l5.85"></a><span id="l5.85"> </span>
<a href="#l5.86"></a><span id="l5.86">   bool isDirectory = false;</span>
<a href="#l5.87"></a><span id="l5.87">   rv = userDirectory-&gt;IsDirectory(&amp;isDirectory);</span>
<a href="#l5.88"></a><span id="l5.88">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineminus">-  if (!isDirectory)</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineminus">-    return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineplus">+  if (!isDirectory) return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l5.92"></a><span id="l5.92"> </span>
<a href="#l5.93"></a><span id="l5.93">   userDirectory.forget(aAddressBookDirectory);</span>
<a href="#l5.94"></a><span id="l5.94">   return NS_OK;</span>
<a href="#l5.95"></a><span id="l5.95"> }</span>
<a href="#l5.96"></a><span id="l5.96"> </span>
<a href="#l5.97"></a><span id="l5.97"> NS_IMETHODIMP</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineminus">-nsBeckyAddressBooks::GetDefaultLocation(nsIFile **aLocation,</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineminus">-                                        bool *aFound,</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineminus">-                                        bool *aUserVerify)</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineminus">-{</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineplus">+nsBeckyAddressBooks::GetDefaultLocation(nsIFile **aLocation, bool *aFound,</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineplus">+                                        bool *aUserVerify) {</span>
<a href="#l5.104"></a><span id="l5.104">   NS_ENSURE_ARG_POINTER(aFound);</span>
<a href="#l5.105"></a><span id="l5.105">   NS_ENSURE_ARG_POINTER(aLocation);</span>
<a href="#l5.106"></a><span id="l5.106">   NS_ENSURE_ARG_POINTER(aUserVerify);</span>
<a href="#l5.107"></a><span id="l5.107"> </span>
<a href="#l5.108"></a><span id="l5.108">   *aLocation = nullptr;</span>
<a href="#l5.109"></a><span id="l5.109">   *aFound = false;</span>
<a href="#l5.110"></a><span id="l5.110">   *aUserVerify = true;</span>
<a href="#l5.111"></a><span id="l5.111"> </span>
<a href="#l5.112"></a><span id="l5.112">   if (NS_SUCCEEDED(nsBeckyAddressBooks::FindAddressBookDirectory(aLocation))) {</span>
<a href="#l5.113"></a><span id="l5.113">     *aFound = true;</span>
<a href="#l5.114"></a><span id="l5.114">     *aUserVerify = false;</span>
<a href="#l5.115"></a><span id="l5.115">   }</span>
<a href="#l5.116"></a><span id="l5.116"> </span>
<a href="#l5.117"></a><span id="l5.117">   return NS_OK;</span>
<a href="#l5.118"></a><span id="l5.118"> }</span>
<a href="#l5.119"></a><span id="l5.119"> </span>
<a href="#l5.120"></a><span id="l5.120" class="difflineminus">-nsresult</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineminus">-nsBeckyAddressBooks::CreateAddressBookDescriptor(nsIImportABDescriptor **aDescriptor)</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineminus">-{</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineplus">+nsresult nsBeckyAddressBooks::CreateAddressBookDescriptor(</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineplus">+    nsIImportABDescriptor **aDescriptor) {</span>
<a href="#l5.125"></a><span id="l5.125">   nsresult rv;</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineminus">-  nsCOMPtr&lt;nsIImportService&gt; importService = do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineplus">+  nsCOMPtr&lt;nsIImportService&gt; importService =</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineplus">+      do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l5.129"></a><span id="l5.129">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.130"></a><span id="l5.130"> </span>
<a href="#l5.131"></a><span id="l5.131">   return importService-&gt;CreateNewABDescriptor(aDescriptor);</span>
<a href="#l5.132"></a><span id="l5.132"> }</span>
<a href="#l5.133"></a><span id="l5.133"> </span>
<a href="#l5.134"></a><span id="l5.134" class="difflineminus">-bool</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineminus">-nsBeckyAddressBooks::IsAddressBookFile(nsIFile *aFile)</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineminus">-{</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineminus">-  if (!aFile)</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineminus">-    return false;</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineplus">+bool nsBeckyAddressBooks::IsAddressBookFile(nsIFile *aFile) {</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineplus">+  if (!aFile) return false;</span>
<a href="#l5.141"></a><span id="l5.141"> </span>
<a href="#l5.142"></a><span id="l5.142">   nsresult rv;</span>
<a href="#l5.143"></a><span id="l5.143">   bool isFile = false;</span>
<a href="#l5.144"></a><span id="l5.144">   rv = aFile-&gt;IsFile(&amp;isFile);</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineminus">-  if (NS_FAILED(rv) &amp;&amp; !isFile)</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineminus">-    return false;</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineplus">+  if (NS_FAILED(rv) &amp;&amp; !isFile) return false;</span>
<a href="#l5.148"></a><span id="l5.148"> </span>
<a href="#l5.149"></a><span id="l5.149">   nsAutoString name;</span>
<a href="#l5.150"></a><span id="l5.150">   rv = aFile-&gt;GetLeafName(name);</span>
<a href="#l5.151"></a><span id="l5.151">   return StringEndsWith(name, NS_LITERAL_STRING(&quot;.bab&quot;));</span>
<a href="#l5.152"></a><span id="l5.152"> }</span>
<a href="#l5.153"></a><span id="l5.153"> </span>
<a href="#l5.154"></a><span id="l5.154" class="difflineminus">-bool</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineminus">-nsBeckyAddressBooks::HasAddressBookFile(nsIFile *aDirectory)</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineminus">-{</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineminus">-  if (!aDirectory)</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineminus">-    return false;</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineplus">+bool nsBeckyAddressBooks::HasAddressBookFile(nsIFile *aDirectory) {</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineplus">+  if (!aDirectory) return false;</span>
<a href="#l5.161"></a><span id="l5.161"> </span>
<a href="#l5.162"></a><span id="l5.162">   nsresult rv;</span>
<a href="#l5.163"></a><span id="l5.163">   bool isDirectory = false;</span>
<a href="#l5.164"></a><span id="l5.164">   rv = aDirectory-&gt;IsDirectory(&amp;isDirectory);</span>
<a href="#l5.165"></a><span id="l5.165" class="difflineminus">-  if (NS_FAILED(rv) || !isDirectory)</span>
<a href="#l5.166"></a><span id="l5.166" class="difflineminus">-    return false;</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineplus">+  if (NS_FAILED(rv) || !isDirectory) return false;</span>
<a href="#l5.168"></a><span id="l5.168"> </span>
<a href="#l5.169"></a><span id="l5.169">   nsCOMPtr&lt;nsIDirectoryEnumerator&gt; entries;</span>
<a href="#l5.170"></a><span id="l5.170">   rv = aDirectory-&gt;GetDirectoryEntries(getter_AddRefs(entries));</span>
<a href="#l5.171"></a><span id="l5.171">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l5.172"></a><span id="l5.172"> </span>
<a href="#l5.173"></a><span id="l5.173">   bool more;</span>
<a href="#l5.174"></a><span id="l5.174">   while (NS_SUCCEEDED(entries-&gt;HasMoreElements(&amp;more)) &amp;&amp; more) {</span>
<a href="#l5.175"></a><span id="l5.175">     nsCOMPtr&lt;nsIFile&gt; file;</span>
<a href="#l5.176"></a><span id="l5.176">     rv = entries-&gt;GetNextFile(getter_AddRefs(file));</span>
<a href="#l5.177"></a><span id="l5.177">     NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineminus">-    if (IsAddressBookFile(file))</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineminus">-      return true;</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineplus">+    if (IsAddressBookFile(file)) return true;</span>
<a href="#l5.181"></a><span id="l5.181">   }</span>
<a href="#l5.182"></a><span id="l5.182"> </span>
<a href="#l5.183"></a><span id="l5.183">   return false;</span>
<a href="#l5.184"></a><span id="l5.184"> }</span>
<a href="#l5.185"></a><span id="l5.185"> </span>
<a href="#l5.186"></a><span id="l5.186" class="difflineminus">-uint32_t</span>
<a href="#l5.187"></a><span id="l5.187" class="difflineminus">-nsBeckyAddressBooks::CountAddressBookSize(nsIFile *aDirectory)</span>
<a href="#l5.188"></a><span id="l5.188" class="difflineminus">-{</span>
<a href="#l5.189"></a><span id="l5.189" class="difflineminus">-  if (!aDirectory)</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineminus">-    return 0;</span>
<a href="#l5.191"></a><span id="l5.191" class="difflineplus">+uint32_t nsBeckyAddressBooks::CountAddressBookSize(nsIFile *aDirectory) {</span>
<a href="#l5.192"></a><span id="l5.192" class="difflineplus">+  if (!aDirectory) return 0;</span>
<a href="#l5.193"></a><span id="l5.193"> </span>
<a href="#l5.194"></a><span id="l5.194">   nsresult rv;</span>
<a href="#l5.195"></a><span id="l5.195">   bool isDirectory = false;</span>
<a href="#l5.196"></a><span id="l5.196">   rv = aDirectory-&gt;IsDirectory(&amp;isDirectory);</span>
<a href="#l5.197"></a><span id="l5.197" class="difflineminus">-  if (NS_FAILED(rv) || !isDirectory)</span>
<a href="#l5.198"></a><span id="l5.198" class="difflineminus">-    return 0;</span>
<a href="#l5.199"></a><span id="l5.199" class="difflineplus">+  if (NS_FAILED(rv) || !isDirectory) return 0;</span>
<a href="#l5.200"></a><span id="l5.200"> </span>
<a href="#l5.201"></a><span id="l5.201">   nsCOMPtr&lt;nsIDirectoryEnumerator&gt; entries;</span>
<a href="#l5.202"></a><span id="l5.202">   rv = aDirectory-&gt;GetDirectoryEntries(getter_AddRefs(entries));</span>
<a href="#l5.203"></a><span id="l5.203">   NS_ENSURE_SUCCESS(rv, 0);</span>
<a href="#l5.204"></a><span id="l5.204"> </span>
<a href="#l5.205"></a><span id="l5.205">   uint32_t total = 0;</span>
<a href="#l5.206"></a><span id="l5.206">   bool more;</span>
<a href="#l5.207"></a><span id="l5.207">   while (NS_SUCCEEDED(entries-&gt;HasMoreElements(&amp;more)) &amp;&amp; more) {</span>
<a href="#l5.208"></a><span id="l5.208" class="difflineat">@@ -201,24 +172,21 @@ nsBeckyAddressBooks::CountAddressBookSiz</span>
<a href="#l5.209"></a><span id="l5.209">       return std::numeric_limits&lt;uint32_t&gt;::max();</span>
<a href="#l5.210"></a><span id="l5.210"> </span>
<a href="#l5.211"></a><span id="l5.211">     total += static_cast&lt;uint32_t&gt;(size);</span>
<a href="#l5.212"></a><span id="l5.212">   }</span>
<a href="#l5.213"></a><span id="l5.213"> </span>
<a href="#l5.214"></a><span id="l5.214">   return total;</span>
<a href="#l5.215"></a><span id="l5.215"> }</span>
<a href="#l5.216"></a><span id="l5.216"> </span>
<a href="#l5.217"></a><span id="l5.217" class="difflineminus">-nsresult</span>
<a href="#l5.218"></a><span id="l5.218" class="difflineminus">-nsBeckyAddressBooks::AppendAddressBookDescriptor(nsIFile *aEntry,</span>
<a href="#l5.219"></a><span id="l5.219" class="difflineminus">-                                                 nsIMutableArray *aCollected)</span>
<a href="#l5.220"></a><span id="l5.220" class="difflineminus">-{</span>
<a href="#l5.221"></a><span id="l5.221" class="difflineplus">+nsresult nsBeckyAddressBooks::AppendAddressBookDescriptor(</span>
<a href="#l5.222"></a><span id="l5.222" class="difflineplus">+    nsIFile *aEntry, nsIMutableArray *aCollected) {</span>
<a href="#l5.223"></a><span id="l5.223">   NS_ENSURE_ARG_POINTER(aCollected);</span>
<a href="#l5.224"></a><span id="l5.224"> </span>
<a href="#l5.225"></a><span id="l5.225" class="difflineminus">-  if (!HasAddressBookFile(aEntry))</span>
<a href="#l5.226"></a><span id="l5.226" class="difflineminus">-    return NS_OK;</span>
<a href="#l5.227"></a><span id="l5.227" class="difflineplus">+  if (!HasAddressBookFile(aEntry)) return NS_OK;</span>
<a href="#l5.228"></a><span id="l5.228"> </span>
<a href="#l5.229"></a><span id="l5.229">   nsresult rv;</span>
<a href="#l5.230"></a><span id="l5.230">   nsCOMPtr&lt;nsIImportABDescriptor&gt; descriptor;</span>
<a href="#l5.231"></a><span id="l5.231">   rv = CreateAddressBookDescriptor(getter_AddRefs(descriptor));</span>
<a href="#l5.232"></a><span id="l5.232">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.233"></a><span id="l5.233"> </span>
<a href="#l5.234"></a><span id="l5.234">   uint32_t size = CountAddressBookSize(aEntry);</span>
<a href="#l5.235"></a><span id="l5.235">   descriptor-&gt;SetSize(size);</span>
<a href="#l5.236"></a><span id="l5.236" class="difflineat">@@ -226,20 +194,18 @@ nsBeckyAddressBooks::AppendAddressBookDe</span>
<a href="#l5.237"></a><span id="l5.237"> </span>
<a href="#l5.238"></a><span id="l5.238">   nsAutoString name;</span>
<a href="#l5.239"></a><span id="l5.239">   aEntry-&gt;GetLeafName(name);</span>
<a href="#l5.240"></a><span id="l5.240">   descriptor-&gt;SetPreferredName(name);</span>
<a href="#l5.241"></a><span id="l5.241"> </span>
<a href="#l5.242"></a><span id="l5.242">   return aCollected-&gt;AppendElement(descriptor);</span>
<a href="#l5.243"></a><span id="l5.243"> }</span>
<a href="#l5.244"></a><span id="l5.244"> </span>
<a href="#l5.245"></a><span id="l5.245" class="difflineminus">-nsresult</span>
<a href="#l5.246"></a><span id="l5.246" class="difflineminus">-nsBeckyAddressBooks::CollectAddressBooks(nsIFile *aTarget,</span>
<a href="#l5.247"></a><span id="l5.247" class="difflineminus">-                                         nsIMutableArray *aCollected)</span>
<a href="#l5.248"></a><span id="l5.248" class="difflineminus">-{</span>
<a href="#l5.249"></a><span id="l5.249" class="difflineplus">+nsresult nsBeckyAddressBooks::CollectAddressBooks(nsIFile *aTarget,</span>
<a href="#l5.250"></a><span id="l5.250" class="difflineplus">+                                                  nsIMutableArray *aCollected) {</span>
<a href="#l5.251"></a><span id="l5.251">   nsresult rv = AppendAddressBookDescriptor(aTarget, aCollected);</span>
<a href="#l5.252"></a><span id="l5.252">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.253"></a><span id="l5.253"> </span>
<a href="#l5.254"></a><span id="l5.254">   nsCOMPtr&lt;nsIDirectoryEnumerator&gt; entries;</span>
<a href="#l5.255"></a><span id="l5.255">   rv = aTarget-&gt;GetDirectoryEntries(getter_AddRefs(entries));</span>
<a href="#l5.256"></a><span id="l5.256">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.257"></a><span id="l5.257"> </span>
<a href="#l5.258"></a><span id="l5.258">   bool more;</span>
<a href="#l5.259"></a><span id="l5.259" class="difflineat">@@ -254,54 +220,46 @@ nsBeckyAddressBooks::CollectAddressBooks</span>
<a href="#l5.260"></a><span id="l5.260">       rv = CollectAddressBooks(file, aCollected);</span>
<a href="#l5.261"></a><span id="l5.261">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.262"></a><span id="l5.262">   }</span>
<a href="#l5.263"></a><span id="l5.263"> </span>
<a href="#l5.264"></a><span id="l5.264">   return NS_OK;</span>
<a href="#l5.265"></a><span id="l5.265"> }</span>
<a href="#l5.266"></a><span id="l5.266"> </span>
<a href="#l5.267"></a><span id="l5.267"> NS_IMETHODIMP</span>
<a href="#l5.268"></a><span id="l5.268" class="difflineminus">-nsBeckyAddressBooks::FindAddressBooks(nsIFile *aLocation,</span>
<a href="#l5.269"></a><span id="l5.269" class="difflineminus">-                                      nsIArray **_retval)</span>
<a href="#l5.270"></a><span id="l5.270" class="difflineminus">-{</span>
<a href="#l5.271"></a><span id="l5.271" class="difflineplus">+nsBeckyAddressBooks::FindAddressBooks(nsIFile *aLocation, nsIArray **_retval) {</span>
<a href="#l5.272"></a><span id="l5.272">   NS_ENSURE_ARG_POINTER(aLocation);</span>
<a href="#l5.273"></a><span id="l5.273">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l5.274"></a><span id="l5.274"> </span>
<a href="#l5.275"></a><span id="l5.275">   nsresult rv;</span>
<a href="#l5.276"></a><span id="l5.276">   nsCOMPtr&lt;nsIMutableArray&gt; array(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l5.277"></a><span id="l5.277">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.278"></a><span id="l5.278"> </span>
<a href="#l5.279"></a><span id="l5.279">   bool isDirectory = false;</span>
<a href="#l5.280"></a><span id="l5.280">   rv = aLocation-&gt;IsDirectory(&amp;isDirectory);</span>
<a href="#l5.281"></a><span id="l5.281" class="difflineminus">-  if (NS_FAILED(rv) || !isDirectory)</span>
<a href="#l5.282"></a><span id="l5.282" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l5.283"></a><span id="l5.283" class="difflineplus">+  if (NS_FAILED(rv) || !isDirectory) return NS_ERROR_FAILURE;</span>
<a href="#l5.284"></a><span id="l5.284"> </span>
<a href="#l5.285"></a><span id="l5.285">   rv = CollectAddressBooks(aLocation, array);</span>
<a href="#l5.286"></a><span id="l5.286">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.287"></a><span id="l5.287"> </span>
<a href="#l5.288"></a><span id="l5.288">   array.forget(_retval);</span>
<a href="#l5.289"></a><span id="l5.289"> </span>
<a href="#l5.290"></a><span id="l5.290">   return NS_OK;</span>
<a href="#l5.291"></a><span id="l5.291"> }</span>
<a href="#l5.292"></a><span id="l5.292"> </span>
<a href="#l5.293"></a><span id="l5.293"> NS_IMETHODIMP</span>
<a href="#l5.294"></a><span id="l5.294" class="difflineminus">-nsBeckyAddressBooks::InitFieldMap(nsIImportFieldMap *aFieldMap)</span>
<a href="#l5.295"></a><span id="l5.295" class="difflineminus">-{</span>
<a href="#l5.296"></a><span id="l5.296" class="difflineplus">+nsBeckyAddressBooks::InitFieldMap(nsIImportFieldMap *aFieldMap) {</span>
<a href="#l5.297"></a><span id="l5.297">   return NS_ERROR_FAILURE;</span>
<a href="#l5.298"></a><span id="l5.298"> }</span>
<a href="#l5.299"></a><span id="l5.299"> </span>
<a href="#l5.300"></a><span id="l5.300"> NS_IMETHODIMP</span>
<a href="#l5.301"></a><span id="l5.301" class="difflineminus">-nsBeckyAddressBooks::ImportAddressBook(nsIImportABDescriptor *aSource,</span>
<a href="#l5.302"></a><span id="l5.302" class="difflineminus">-                                       nsIAddrDatabase *aDestination,</span>
<a href="#l5.303"></a><span id="l5.303" class="difflineminus">-                                       nsIImportFieldMap *aFieldMap,</span>
<a href="#l5.304"></a><span id="l5.304" class="difflineminus">-                                       nsISupports *aSupportService,</span>
<a href="#l5.305"></a><span id="l5.305" class="difflineminus">-                                       char16_t **aErrorLog,</span>
<a href="#l5.306"></a><span id="l5.306" class="difflineminus">-                                       char16_t **aSuccessLog,</span>
<a href="#l5.307"></a><span id="l5.307" class="difflineminus">-                                       bool *aFatalError)</span>
<a href="#l5.308"></a><span id="l5.308" class="difflineminus">-{</span>
<a href="#l5.309"></a><span id="l5.309" class="difflineplus">+nsBeckyAddressBooks::ImportAddressBook(</span>
<a href="#l5.310"></a><span id="l5.310" class="difflineplus">+    nsIImportABDescriptor *aSource, nsIAddrDatabase *aDestination,</span>
<a href="#l5.311"></a><span id="l5.311" class="difflineplus">+    nsIImportFieldMap *aFieldMap, nsISupports *aSupportService,</span>
<a href="#l5.312"></a><span id="l5.312" class="difflineplus">+    char16_t **aErrorLog, char16_t **aSuccessLog, bool *aFatalError) {</span>
<a href="#l5.313"></a><span id="l5.313">   NS_ENSURE_ARG_POINTER(aSource);</span>
<a href="#l5.314"></a><span id="l5.314">   NS_ENSURE_ARG_POINTER(aDestination);</span>
<a href="#l5.315"></a><span id="l5.315">   NS_ENSURE_ARG_POINTER(aErrorLog);</span>
<a href="#l5.316"></a><span id="l5.316">   NS_ENSURE_ARG_POINTER(aSuccessLog);</span>
<a href="#l5.317"></a><span id="l5.317">   NS_ENSURE_ARG_POINTER(aFatalError);</span>
<a href="#l5.318"></a><span id="l5.318"> </span>
<a href="#l5.319"></a><span id="l5.319">   mReadBytes = 0;</span>
<a href="#l5.320"></a><span id="l5.320"> </span>
<a href="#l5.321"></a><span id="l5.321" class="difflineat">@@ -315,51 +273,45 @@ nsBeckyAddressBooks::ImportAddressBook(n</span>
<a href="#l5.322"></a><span id="l5.322"> </span>
<a href="#l5.323"></a><span id="l5.323">   bool more;</span>
<a href="#l5.324"></a><span id="l5.324">   nsAutoString error;</span>
<a href="#l5.325"></a><span id="l5.325">   while (NS_SUCCEEDED(entries-&gt;HasMoreElements(&amp;more)) &amp;&amp; more) {</span>
<a href="#l5.326"></a><span id="l5.326">     nsCOMPtr&lt;nsIFile&gt; file;</span>
<a href="#l5.327"></a><span id="l5.327">     rv = entries-&gt;GetNextFile(getter_AddRefs(file));</span>
<a href="#l5.328"></a><span id="l5.328">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.329"></a><span id="l5.329"> </span>
<a href="#l5.330"></a><span id="l5.330" class="difflineminus">-    if (!IsAddressBookFile(file))</span>
<a href="#l5.331"></a><span id="l5.331" class="difflineminus">-      continue;</span>
<a href="#l5.332"></a><span id="l5.332" class="difflineplus">+    if (!IsAddressBookFile(file)) continue;</span>
<a href="#l5.333"></a><span id="l5.333"> </span>
<a href="#l5.334"></a><span id="l5.334">     bool aborted = false;</span>
<a href="#l5.335"></a><span id="l5.335">     nsAutoString name;</span>
<a href="#l5.336"></a><span id="l5.336">     aSource-&gt;GetPreferredName(name);</span>
<a href="#l5.337"></a><span id="l5.337">     nsVCardAddress vcard;</span>
<a href="#l5.338"></a><span id="l5.338" class="difflineminus">-    rv = vcard.ImportAddresses(&amp;aborted, name.get(), file, aDestination, error, &amp;mReadBytes);</span>
<a href="#l5.339"></a><span id="l5.339" class="difflineplus">+    rv = vcard.ImportAddresses(&amp;aborted, name.get(), file, aDestination, error,</span>
<a href="#l5.340"></a><span id="l5.340" class="difflineplus">+                               &amp;mReadBytes);</span>
<a href="#l5.341"></a><span id="l5.341">     if (NS_FAILED(rv)) {</span>
<a href="#l5.342"></a><span id="l5.342">       break;</span>
<a href="#l5.343"></a><span id="l5.343">     }</span>
<a href="#l5.344"></a><span id="l5.344">   }</span>
<a href="#l5.345"></a><span id="l5.345"> </span>
<a href="#l5.346"></a><span id="l5.346">   if (!error.IsEmpty())</span>
<a href="#l5.347"></a><span id="l5.347">     *aErrorLog = ToNewUnicode(error);</span>
<a href="#l5.348"></a><span id="l5.348">   else</span>
<a href="#l5.349"></a><span id="l5.349" class="difflineminus">-    *aSuccessLog = nsBeckyStringBundle::GetStringByName(&quot;BeckyImportAddressSuccess&quot;);</span>
<a href="#l5.350"></a><span id="l5.350" class="difflineplus">+    *aSuccessLog =</span>
<a href="#l5.351"></a><span id="l5.351" class="difflineplus">+        nsBeckyStringBundle::GetStringByName(&quot;BeckyImportAddressSuccess&quot;);</span>
<a href="#l5.352"></a><span id="l5.352"> </span>
<a href="#l5.353"></a><span id="l5.353">   return rv;</span>
<a href="#l5.354"></a><span id="l5.354"> }</span>
<a href="#l5.355"></a><span id="l5.355"> </span>
<a href="#l5.356"></a><span id="l5.356"> NS_IMETHODIMP</span>
<a href="#l5.357"></a><span id="l5.357" class="difflineminus">-nsBeckyAddressBooks::GetImportProgress(uint32_t *_retval)</span>
<a href="#l5.358"></a><span id="l5.358" class="difflineminus">-{</span>
<a href="#l5.359"></a><span id="l5.359" class="difflineplus">+nsBeckyAddressBooks::GetImportProgress(uint32_t *_retval) {</span>
<a href="#l5.360"></a><span id="l5.360">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l5.361"></a><span id="l5.361">   *_retval = mReadBytes;</span>
<a href="#l5.362"></a><span id="l5.362">   return NS_OK;</span>
<a href="#l5.363"></a><span id="l5.363"> }</span>
<a href="#l5.364"></a><span id="l5.364"> </span>
<a href="#l5.365"></a><span id="l5.365"> NS_IMETHODIMP</span>
<a href="#l5.366"></a><span id="l5.366" class="difflineminus">-nsBeckyAddressBooks::SetSampleLocation(nsIFile *aLocation)</span>
<a href="#l5.367"></a><span id="l5.367" class="difflineminus">-{</span>
<a href="#l5.368"></a><span id="l5.368" class="difflineminus">-  return NS_OK;</span>
<a href="#l5.369"></a><span id="l5.369" class="difflineminus">-}</span>
<a href="#l5.370"></a><span id="l5.370" class="difflineplus">+nsBeckyAddressBooks::SetSampleLocation(nsIFile *aLocation) { return NS_OK; }</span>
<a href="#l5.371"></a><span id="l5.371"> </span>
<a href="#l5.372"></a><span id="l5.372"> NS_IMETHODIMP</span>
<a href="#l5.373"></a><span id="l5.373" class="difflineminus">-nsBeckyAddressBooks::GetSampleData(int32_t aRecordNumber,</span>
<a href="#l5.374"></a><span id="l5.374" class="difflineminus">-                                   bool *aRecordExists,</span>
<a href="#l5.375"></a><span id="l5.375" class="difflineminus">-                                   char16_t **_retval)</span>
<a href="#l5.376"></a><span id="l5.376" class="difflineminus">-{</span>
<a href="#l5.377"></a><span id="l5.377" class="difflineplus">+nsBeckyAddressBooks::GetSampleData(int32_t aRecordNumber, bool *aRecordExists,</span>
<a href="#l5.378"></a><span id="l5.378" class="difflineplus">+                                   char16_t **_retval) {</span>
<a href="#l5.379"></a><span id="l5.379">   return NS_ERROR_FAILURE;</span>
<a href="#l5.380"></a><span id="l5.380"> }</span>
<a href="#l5.381"></a><span id="l5.381" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/import/becky/src/nsBeckyAddressBooks.h</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/import/becky/src/nsBeckyAddressBooks.h</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -5,26 +5,25 @@</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5"> #ifndef nsBeckyAddressBooks_h___</span>
<a href="#l6.6"></a><span id="l6.6"> #define nsBeckyAddressBooks_h___</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8"> #include &quot;nsIImportAddressBooks.h&quot;</span>
<a href="#l6.9"></a><span id="l6.9"> #include &quot;nsIFile.h&quot;</span>
<a href="#l6.10"></a><span id="l6.10"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-class nsBeckyAddressBooks final : public nsIImportAddressBooks</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-{</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-public:</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+class nsBeckyAddressBooks final : public nsIImportAddressBooks {</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+ public:</span>
<a href="#l6.17"></a><span id="l6.17">   nsBeckyAddressBooks();</span>
<a href="#l6.18"></a><span id="l6.18">   static nsresult Create(nsIImportAddressBooks **aImport);</span>
<a href="#l6.19"></a><span id="l6.19"> </span>
<a href="#l6.20"></a><span id="l6.20">   NS_DECL_ISUPPORTS</span>
<a href="#l6.21"></a><span id="l6.21">   NS_DECL_NSIIMPORTADDRESSBOOKS</span>
<a href="#l6.22"></a><span id="l6.22"> </span>
<a href="#l6.23"></a><span id="l6.23" class="difflineminus">-private:</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+ private:</span>
<a href="#l6.25"></a><span id="l6.25">   virtual ~nsBeckyAddressBooks();</span>
<a href="#l6.26"></a><span id="l6.26"> </span>
<a href="#l6.27"></a><span id="l6.27">   uint32_t mReadBytes;</span>
<a href="#l6.28"></a><span id="l6.28"> </span>
<a href="#l6.29"></a><span id="l6.29">   nsresult CollectAddressBooks(nsIFile *aTarget, nsIMutableArray *aCollected);</span>
<a href="#l6.30"></a><span id="l6.30">   nsresult FindAddressBookDirectory(nsIFile **aAddressBookDirectory);</span>
<a href="#l6.31"></a><span id="l6.31">   nsresult AppendAddressBookDescriptor(nsIFile *aEntry,</span>
<a href="#l6.32"></a><span id="l6.32">                                        nsIMutableArray *aCollected);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/import/becky/src/nsBeckyFilters.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/import/becky/src/nsBeckyFilters.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -20,52 +20,41 @@</span>
<a href="#l7.4"></a><span id="l7.4"> #include &quot;msgCore.h&quot;</span>
<a href="#l7.5"></a><span id="l7.5"> </span>
<a href="#l7.6"></a><span id="l7.6"> #include &quot;nsBeckyFilters.h&quot;</span>
<a href="#l7.7"></a><span id="l7.7"> #include &quot;nsBeckyStringBundle.h&quot;</span>
<a href="#l7.8"></a><span id="l7.8"> #include &quot;nsBeckyUtils.h&quot;</span>
<a href="#l7.9"></a><span id="l7.9"> </span>
<a href="#l7.10"></a><span id="l7.10"> NS_IMPL_ISUPPORTS(nsBeckyFilters, nsIImportFilters)</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-nsresult</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-nsBeckyFilters::Create(nsIImportFilters **aImport)</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-{</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+nsresult nsBeckyFilters::Create(nsIImportFilters **aImport) {</span>
<a href="#l7.16"></a><span id="l7.16">   NS_ENSURE_ARG_POINTER(aImport);</span>
<a href="#l7.17"></a><span id="l7.17">   NS_ADDREF(*aImport = new nsBeckyFilters());</span>
<a href="#l7.18"></a><span id="l7.18">   return NS_OK;</span>
<a href="#l7.19"></a><span id="l7.19"> }</span>
<a href="#l7.20"></a><span id="l7.20"> </span>
<a href="#l7.21"></a><span id="l7.21"> nsBeckyFilters::nsBeckyFilters()</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">-: mLocation(nullptr),</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">-  mServer(nullptr),</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">-  mConvertedFile(nullptr)</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineminus">-{</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">-}</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+    : mLocation(nullptr), mServer(nullptr), mConvertedFile(nullptr) {}</span>
<a href="#l7.28"></a><span id="l7.28"> </span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">-nsBeckyFilters::~nsBeckyFilters()</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-{</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-}</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+nsBeckyFilters::~nsBeckyFilters() {}</span>
<a href="#l7.33"></a><span id="l7.33"> </span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-nsresult</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">-nsBeckyFilters::GetDefaultFilterLocation(nsIFile **aFile)</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineminus">-{</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+nsresult nsBeckyFilters::GetDefaultFilterLocation(nsIFile **aFile) {</span>
<a href="#l7.38"></a><span id="l7.38">   NS_ENSURE_ARG_POINTER(aFile);</span>
<a href="#l7.39"></a><span id="l7.39"> </span>
<a href="#l7.40"></a><span id="l7.40">   nsresult rv;</span>
<a href="#l7.41"></a><span id="l7.41">   nsCOMPtr&lt;nsIFile&gt; filterDir;</span>
<a href="#l7.42"></a><span id="l7.42">   rv = nsBeckyUtils::GetDefaultMailboxDirectory(getter_AddRefs(filterDir));</span>
<a href="#l7.43"></a><span id="l7.43">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.44"></a><span id="l7.44"> </span>
<a href="#l7.45"></a><span id="l7.45">   filterDir.forget(aFile);</span>
<a href="#l7.46"></a><span id="l7.46">   return NS_OK;</span>
<a href="#l7.47"></a><span id="l7.47"> }</span>
<a href="#l7.48"></a><span id="l7.48"> </span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-nsresult</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-nsBeckyFilters::GetFilterFile(bool aIncoming, nsIFile *aLocation, nsIFile **aFile)</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-{</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+nsresult nsBeckyFilters::GetFilterFile(bool aIncoming, nsIFile *aLocation,</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+                                       nsIFile **aFile) {</span>
<a href="#l7.54"></a><span id="l7.54">   NS_ENSURE_ARG_POINTER(aLocation);</span>
<a href="#l7.55"></a><span id="l7.55">   NS_ENSURE_ARG_POINTER(aFile);</span>
<a href="#l7.56"></a><span id="l7.56"> </span>
<a href="#l7.57"></a><span id="l7.57">   // We assume the caller has already checked that aLocation is a directory,</span>
<a href="#l7.58"></a><span id="l7.58">   // otherwise it would not make sense to call us.</span>
<a href="#l7.59"></a><span id="l7.59"> </span>
<a href="#l7.60"></a><span id="l7.60">   nsresult rv;</span>
<a href="#l7.61"></a><span id="l7.61">   nsCOMPtr&lt;nsIFile&gt; filter;</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineat">@@ -74,34 +63,31 @@ nsBeckyFilters::GetFilterFile(bool aInco</span>
<a href="#l7.63"></a><span id="l7.63">     rv = filter-&gt;Append(NS_LITERAL_STRING(&quot;IFilter.def&quot;));</span>
<a href="#l7.64"></a><span id="l7.64">   else</span>
<a href="#l7.65"></a><span id="l7.65">     rv = filter-&gt;Append(NS_LITERAL_STRING(&quot;OFilter.def&quot;));</span>
<a href="#l7.66"></a><span id="l7.66">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.67"></a><span id="l7.67"> </span>
<a href="#l7.68"></a><span id="l7.68">   bool exists = false;</span>
<a href="#l7.69"></a><span id="l7.69">   rv = filter-&gt;Exists(&amp;exists);</span>
<a href="#l7.70"></a><span id="l7.70">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineminus">-  if (!exists)</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineminus">-    return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+  if (!exists) return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l7.74"></a><span id="l7.74"> </span>
<a href="#l7.75"></a><span id="l7.75">   filter.forget(aFile);</span>
<a href="#l7.76"></a><span id="l7.76">   return NS_OK;</span>
<a href="#l7.77"></a><span id="l7.77"> }</span>
<a href="#l7.78"></a><span id="l7.78"> </span>
<a href="#l7.79"></a><span id="l7.79"> NS_IMETHODIMP</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineminus">-nsBeckyFilters::AutoLocate(char16_t **aDescription,</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineminus">-                           nsIFile **aLocation,</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineminus">-                           bool *_retval)</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineminus">-{</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineplus">+nsBeckyFilters::AutoLocate(char16_t **aDescription, nsIFile **aLocation,</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+                           bool *_retval) {</span>
<a href="#l7.86"></a><span id="l7.86">   NS_ENSURE_ARG_POINTER(aLocation);</span>
<a href="#l7.87"></a><span id="l7.87">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l7.88"></a><span id="l7.88"> </span>
<a href="#l7.89"></a><span id="l7.89">   if (aDescription) {</span>
<a href="#l7.90"></a><span id="l7.90">     *aDescription =</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineminus">-      nsBeckyStringBundle::GetStringByName(&quot;BeckyImportDescription&quot;);</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+        nsBeckyStringBundle::GetStringByName(&quot;BeckyImportDescription&quot;);</span>
<a href="#l7.93"></a><span id="l7.93">   }</span>
<a href="#l7.94"></a><span id="l7.94">   *aLocation = nullptr;</span>
<a href="#l7.95"></a><span id="l7.95">   *_retval = false;</span>
<a href="#l7.96"></a><span id="l7.96"> </span>
<a href="#l7.97"></a><span id="l7.97">   nsresult rv;</span>
<a href="#l7.98"></a><span id="l7.98">   nsCOMPtr&lt;nsIFile&gt; location;</span>
<a href="#l7.99"></a><span id="l7.99">   rv = GetDefaultFilterLocation(getter_AddRefs(location));</span>
<a href="#l7.100"></a><span id="l7.100">   if (NS_FAILED(rv))</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineat">@@ -109,35 +95,30 @@ nsBeckyFilters::AutoLocate(char16_t **aD</span>
<a href="#l7.102"></a><span id="l7.102">   else</span>
<a href="#l7.103"></a><span id="l7.103">     *_retval = true;</span>
<a href="#l7.104"></a><span id="l7.104"> </span>
<a href="#l7.105"></a><span id="l7.105">   location.forget(aLocation);</span>
<a href="#l7.106"></a><span id="l7.106">   return NS_OK;</span>
<a href="#l7.107"></a><span id="l7.107"> }</span>
<a href="#l7.108"></a><span id="l7.108"> </span>
<a href="#l7.109"></a><span id="l7.109"> NS_IMETHODIMP</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineminus">-nsBeckyFilters::SetLocation(nsIFile *aLocation)</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineminus">-{</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineplus">+nsBeckyFilters::SetLocation(nsIFile *aLocation) {</span>
<a href="#l7.113"></a><span id="l7.113">   NS_ENSURE_ARG_POINTER(aLocation);</span>
<a href="#l7.114"></a><span id="l7.114"> </span>
<a href="#l7.115"></a><span id="l7.115">   bool exists = false;</span>
<a href="#l7.116"></a><span id="l7.116">   nsresult rv = aLocation-&gt;Exists(&amp;exists);</span>
<a href="#l7.117"></a><span id="l7.117">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineminus">-  if (!exists)</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineminus">-    return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineplus">+  if (!exists) return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l7.121"></a><span id="l7.121"> </span>
<a href="#l7.122"></a><span id="l7.122">   mLocation = aLocation;</span>
<a href="#l7.123"></a><span id="l7.123">   return NS_OK;</span>
<a href="#l7.124"></a><span id="l7.124"> }</span>
<a href="#l7.125"></a><span id="l7.125"> </span>
<a href="#l7.126"></a><span id="l7.126" class="difflineminus">-static nsMsgSearchAttribValue</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineminus">-ConvertSearchKeyToAttrib(const nsACString &amp;aKey)</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineminus">-{</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineminus">-  if (aKey.EqualsLiteral(&quot;From&quot;) ||</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineminus">-      aKey.EqualsLiteral(&quot;Sender&quot;) ||</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineplus">+static nsMsgSearchAttribValue ConvertSearchKeyToAttrib(const nsACString &amp;aKey) {</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineplus">+  if (aKey.EqualsLiteral(&quot;From&quot;) || aKey.EqualsLiteral(&quot;Sender&quot;) ||</span>
<a href="#l7.133"></a><span id="l7.133">       aKey.EqualsLiteral(&quot;From, Sender, X-Sender&quot;)) {</span>
<a href="#l7.134"></a><span id="l7.134">     return nsMsgSearchAttrib::Sender;</span>
<a href="#l7.135"></a><span id="l7.135">   } else if (aKey.EqualsLiteral(&quot;Subject&quot;)) {</span>
<a href="#l7.136"></a><span id="l7.136">     return nsMsgSearchAttrib::Subject;</span>
<a href="#l7.137"></a><span id="l7.137">   } else if (aKey.EqualsLiteral(&quot;[body]&quot;)) {</span>
<a href="#l7.138"></a><span id="l7.138">     return nsMsgSearchAttrib::Body;</span>
<a href="#l7.139"></a><span id="l7.139">   } else if (aKey.EqualsLiteral(&quot;Date&quot;)) {</span>
<a href="#l7.140"></a><span id="l7.140">     return nsMsgSearchAttrib::Date;</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineat">@@ -146,19 +127,18 @@ ConvertSearchKeyToAttrib(const nsACStrin</span>
<a href="#l7.142"></a><span id="l7.142">   } else if (aKey.EqualsLiteral(&quot;Cc&quot;)) {</span>
<a href="#l7.143"></a><span id="l7.143">     return nsMsgSearchAttrib::CC;</span>
<a href="#l7.144"></a><span id="l7.144">   } else if (aKey.EqualsLiteral(&quot;To,  Cc,  Bcc:&quot;)) {</span>
<a href="#l7.145"></a><span id="l7.145">     return nsMsgSearchAttrib::ToOrCC;</span>
<a href="#l7.146"></a><span id="l7.146">   }</span>
<a href="#l7.147"></a><span id="l7.147">   return -1;</span>
<a href="#l7.148"></a><span id="l7.148"> }</span>
<a href="#l7.149"></a><span id="l7.149"> </span>
<a href="#l7.150"></a><span id="l7.150" class="difflineminus">-static nsMsgSearchOpValue</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineminus">-ConvertSearchFlagsToOperator(const nsACString &amp;aFlags)</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineminus">-{</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineplus">+static nsMsgSearchOpValue ConvertSearchFlagsToOperator(</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineplus">+    const nsACString &amp;aFlags) {</span>
<a href="#l7.155"></a><span id="l7.155">   nsCString flags(aFlags);</span>
<a href="#l7.156"></a><span id="l7.156">   int32_t lastTabPosition = flags.RFindChar('\t');</span>
<a href="#l7.157"></a><span id="l7.157">   if ((lastTabPosition == -1) ||</span>
<a href="#l7.158"></a><span id="l7.158">       ((int32_t)aFlags.Length() == lastTabPosition - 1)) {</span>
<a href="#l7.159"></a><span id="l7.159">     return -1;</span>
<a href="#l7.160"></a><span id="l7.160">   }</span>
<a href="#l7.161"></a><span id="l7.161"> </span>
<a href="#l7.162"></a><span id="l7.162">   switch (aFlags.CharAt(0)) {</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineat">@@ -168,61 +148,58 @@ ConvertSearchFlagsToOperator(const nsACS</span>
<a href="#l7.164"></a><span id="l7.164">       if (aFlags.FindChar('T', lastTabPosition + 1) &gt;= 0)</span>
<a href="#l7.165"></a><span id="l7.165">         return nsMsgSearchOp::BeginsWith;</span>
<a href="#l7.166"></a><span id="l7.166">       return nsMsgSearchOp::Contains;</span>
<a href="#l7.167"></a><span id="l7.167">     default:</span>
<a href="#l7.168"></a><span id="l7.168">       return -1;</span>
<a href="#l7.169"></a><span id="l7.169">   }</span>
<a href="#l7.170"></a><span id="l7.170"> }</span>
<a href="#l7.171"></a><span id="l7.171"> </span>
<a href="#l7.172"></a><span id="l7.172" class="difflineminus">-nsresult</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineminus">-nsBeckyFilters::ParseRuleLine(const nsCString &amp;aLine,</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineminus">-                              nsMsgSearchAttribValue *aSearchAttribute,</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineminus">-                              nsMsgSearchOpValue *aSearchOperator,</span>
<a href="#l7.176"></a><span id="l7.176" class="difflineminus">-                              nsString &amp;aSearchKeyword)</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineminus">-{</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineplus">+nsresult nsBeckyFilters::ParseRuleLine(const nsCString &amp;aLine,</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineplus">+                                       nsMsgSearchAttribValue *aSearchAttribute,</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineplus">+                                       nsMsgSearchOpValue *aSearchOperator,</span>
<a href="#l7.181"></a><span id="l7.181" class="difflineplus">+                                       nsString &amp;aSearchKeyword) {</span>
<a href="#l7.182"></a><span id="l7.182">   int32_t firstColonPosition = aLine.FindChar(':');</span>
<a href="#l7.183"></a><span id="l7.183">   if (firstColonPosition == -1 ||</span>
<a href="#l7.184"></a><span id="l7.184">       (int32_t)aLine.Length() == firstColonPosition - 1) {</span>
<a href="#l7.185"></a><span id="l7.185">     return NS_ERROR_FAILURE;</span>
<a href="#l7.186"></a><span id="l7.186">   }</span>
<a href="#l7.187"></a><span id="l7.187"> </span>
<a href="#l7.188"></a><span id="l7.188">   int32_t secondColonPosition = aLine.FindChar(':', firstColonPosition + 1);</span>
<a href="#l7.189"></a><span id="l7.189">   if (secondColonPosition == -1 ||</span>
<a href="#l7.190"></a><span id="l7.190">       (int32_t)aLine.Length() == secondColonPosition - 1) {</span>
<a href="#l7.191"></a><span id="l7.191">     return NS_ERROR_FAILURE;</span>
<a href="#l7.192"></a><span id="l7.192">   }</span>
<a href="#l7.193"></a><span id="l7.193"> </span>
<a href="#l7.194"></a><span id="l7.194">   int32_t length = secondColonPosition - firstColonPosition - 1;</span>
<a href="#l7.195"></a><span id="l7.195">   nsMsgSearchAttribValue searchAttribute;</span>
<a href="#l7.196"></a><span id="l7.196" class="difflineminus">-  searchAttribute = ConvertSearchKeyToAttrib(Substring(aLine, firstColonPosition + 1, length));</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineminus">-  if (searchAttribute &lt; 0)</span>
<a href="#l7.198"></a><span id="l7.198" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l7.199"></a><span id="l7.199" class="difflineplus">+  searchAttribute = ConvertSearchKeyToAttrib(</span>
<a href="#l7.200"></a><span id="l7.200" class="difflineplus">+      Substring(aLine, firstColonPosition + 1, length));</span>
<a href="#l7.201"></a><span id="l7.201" class="difflineplus">+  if (searchAttribute &lt; 0) return NS_ERROR_FAILURE;</span>
<a href="#l7.202"></a><span id="l7.202"> </span>
<a href="#l7.203"></a><span id="l7.203">   int32_t tabPosition = aLine.FindChar('\t');</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineminus">-  if (tabPosition == -1 ||</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineminus">-      (int32_t)aLine.Length() == tabPosition - 1) {</span>
<a href="#l7.206"></a><span id="l7.206" class="difflineplus">+  if (tabPosition == -1 || (int32_t)aLine.Length() == tabPosition - 1) {</span>
<a href="#l7.207"></a><span id="l7.207">     return NS_ERROR_FAILURE;</span>
<a href="#l7.208"></a><span id="l7.208">   }</span>
<a href="#l7.209"></a><span id="l7.209"> </span>
<a href="#l7.210"></a><span id="l7.210">   nsMsgSearchOpValue searchOperator;</span>
<a href="#l7.211"></a><span id="l7.211" class="difflineminus">-  searchOperator = ConvertSearchFlagsToOperator(Substring(aLine, tabPosition + 1));</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineminus">-  if (searchOperator &lt; 0)</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineplus">+  searchOperator =</span>
<a href="#l7.215"></a><span id="l7.215" class="difflineplus">+      ConvertSearchFlagsToOperator(Substring(aLine, tabPosition + 1));</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineplus">+  if (searchOperator &lt; 0) return NS_ERROR_FAILURE;</span>
<a href="#l7.217"></a><span id="l7.217"> </span>
<a href="#l7.218"></a><span id="l7.218">   *aSearchOperator = searchOperator;</span>
<a href="#l7.219"></a><span id="l7.219">   *aSearchAttribute = searchAttribute;</span>
<a href="#l7.220"></a><span id="l7.220">   length = tabPosition - secondColonPosition - 1;</span>
<a href="#l7.221"></a><span id="l7.221" class="difflineminus">-  CopyUTF8toUTF16(Substring(aLine, secondColonPosition + 1, length), aSearchKeyword);</span>
<a href="#l7.222"></a><span id="l7.222" class="difflineplus">+  CopyUTF8toUTF16(Substring(aLine, secondColonPosition + 1, length),</span>
<a href="#l7.223"></a><span id="l7.223" class="difflineplus">+                  aSearchKeyword);</span>
<a href="#l7.224"></a><span id="l7.224">   return NS_OK;</span>
<a href="#l7.225"></a><span id="l7.225"> }</span>
<a href="#l7.226"></a><span id="l7.226"> </span>
<a href="#l7.227"></a><span id="l7.227" class="difflineminus">-nsresult</span>
<a href="#l7.228"></a><span id="l7.228" class="difflineminus">-nsBeckyFilters::SetSearchTerm(const nsCString &amp;aLine, nsIMsgFilter *aFilter)</span>
<a href="#l7.229"></a><span id="l7.229" class="difflineminus">-{</span>
<a href="#l7.230"></a><span id="l7.230" class="difflineplus">+nsresult nsBeckyFilters::SetSearchTerm(const nsCString &amp;aLine,</span>
<a href="#l7.231"></a><span id="l7.231" class="difflineplus">+                                       nsIMsgFilter *aFilter) {</span>
<a href="#l7.232"></a><span id="l7.232">   NS_ENSURE_ARG_POINTER(aFilter);</span>
<a href="#l7.233"></a><span id="l7.233"> </span>
<a href="#l7.234"></a><span id="l7.234">   nsresult rv;</span>
<a href="#l7.235"></a><span id="l7.235">   nsMsgSearchAttribValue searchAttribute = -1;</span>
<a href="#l7.236"></a><span id="l7.236">   nsMsgSearchOpValue searchOperator = -1;</span>
<a href="#l7.237"></a><span id="l7.237">   nsAutoString searchKeyword;</span>
<a href="#l7.238"></a><span id="l7.238">   rv = ParseRuleLine(aLine, &amp;searchAttribute, &amp;searchOperator, searchKeyword);</span>
<a href="#l7.239"></a><span id="l7.239">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineat">@@ -253,53 +230,47 @@ nsBeckyFilters::SetSearchTerm(const nsCS</span>
<a href="#l7.241"></a><span id="l7.241">     rv = aFilter-&gt;SetFilterName(searchKeyword);</span>
<a href="#l7.242"></a><span id="l7.242">   else</span>
<a href="#l7.243"></a><span id="l7.243">     rv = aFilter-&gt;SetFilterName(NS_LITERAL_STRING(&quot;No name&quot;));</span>
<a href="#l7.244"></a><span id="l7.244">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.245"></a><span id="l7.245"> </span>
<a href="#l7.246"></a><span id="l7.246">   return aFilter-&gt;AppendTerm(term);</span>
<a href="#l7.247"></a><span id="l7.247"> }</span>
<a href="#l7.248"></a><span id="l7.248"> </span>
<a href="#l7.249"></a><span id="l7.249" class="difflineminus">-nsresult</span>
<a href="#l7.250"></a><span id="l7.250" class="difflineminus">-nsBeckyFilters::CreateRuleAction(nsIMsgFilter *aFilter,</span>
<a href="#l7.251"></a><span id="l7.251" class="difflineminus">-                                 nsMsgRuleActionType actionType,</span>
<a href="#l7.252"></a><span id="l7.252" class="difflineminus">-                                 nsIMsgRuleAction **_retval)</span>
<a href="#l7.253"></a><span id="l7.253" class="difflineminus">-{</span>
<a href="#l7.254"></a><span id="l7.254" class="difflineplus">+nsresult nsBeckyFilters::CreateRuleAction(nsIMsgFilter *aFilter,</span>
<a href="#l7.255"></a><span id="l7.255" class="difflineplus">+                                          nsMsgRuleActionType actionType,</span>
<a href="#l7.256"></a><span id="l7.256" class="difflineplus">+                                          nsIMsgRuleAction **_retval) {</span>
<a href="#l7.257"></a><span id="l7.257">   nsresult rv;</span>
<a href="#l7.258"></a><span id="l7.258">   nsCOMPtr&lt;nsIMsgRuleAction&gt; action;</span>
<a href="#l7.259"></a><span id="l7.259">   rv = aFilter-&gt;CreateAction(getter_AddRefs(action));</span>
<a href="#l7.260"></a><span id="l7.260">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.261"></a><span id="l7.261">   rv = action-&gt;SetType(actionType);</span>
<a href="#l7.262"></a><span id="l7.262">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.263"></a><span id="l7.263"> </span>
<a href="#l7.264"></a><span id="l7.264">   action.forget(_retval);</span>
<a href="#l7.265"></a><span id="l7.265"> </span>
<a href="#l7.266"></a><span id="l7.266">   return NS_OK;</span>
<a href="#l7.267"></a><span id="l7.267"> }</span>
<a href="#l7.268"></a><span id="l7.268"> </span>
<a href="#l7.269"></a><span id="l7.269" class="difflineminus">-nsresult</span>
<a href="#l7.270"></a><span id="l7.270" class="difflineminus">-nsBeckyFilters::GetActionTarget(const nsCString &amp;aLine,</span>
<a href="#l7.271"></a><span id="l7.271" class="difflineminus">-                                nsCString &amp;aTarget)</span>
<a href="#l7.272"></a><span id="l7.272" class="difflineminus">-{</span>
<a href="#l7.273"></a><span id="l7.273" class="difflineplus">+nsresult nsBeckyFilters::GetActionTarget(const nsCString &amp;aLine,</span>
<a href="#l7.274"></a><span id="l7.274" class="difflineplus">+                                         nsCString &amp;aTarget) {</span>
<a href="#l7.275"></a><span id="l7.275">   int32_t firstColonPosition = aLine.FindChar(':');</span>
<a href="#l7.276"></a><span id="l7.276">   if (firstColonPosition &lt; -1 ||</span>
<a href="#l7.277"></a><span id="l7.277">       aLine.Length() == static_cast&lt;uint32_t&gt;(firstColonPosition)) {</span>
<a href="#l7.278"></a><span id="l7.278">     return NS_ERROR_FAILURE;</span>
<a href="#l7.279"></a><span id="l7.279">   }</span>
<a href="#l7.280"></a><span id="l7.280"> </span>
<a href="#l7.281"></a><span id="l7.281">   aTarget.Assign(Substring(aLine, firstColonPosition + 1));</span>
<a href="#l7.282"></a><span id="l7.282"> </span>
<a href="#l7.283"></a><span id="l7.283">   return NS_OK;</span>
<a href="#l7.284"></a><span id="l7.284"> }</span>
<a href="#l7.285"></a><span id="l7.285"> </span>
<a href="#l7.286"></a><span id="l7.286" class="difflineminus">-nsresult</span>
<a href="#l7.287"></a><span id="l7.287" class="difflineminus">-nsBeckyFilters::GetResendTarget(const nsCString &amp;aLine,</span>
<a href="#l7.288"></a><span id="l7.288" class="difflineminus">-                                nsCString &amp;aTemplate,</span>
<a href="#l7.289"></a><span id="l7.289" class="difflineminus">-                                nsCString &amp;aTargetAddress)</span>
<a href="#l7.290"></a><span id="l7.290" class="difflineminus">-{</span>
<a href="#l7.291"></a><span id="l7.291" class="difflineplus">+nsresult nsBeckyFilters::GetResendTarget(const nsCString &amp;aLine,</span>
<a href="#l7.292"></a><span id="l7.292" class="difflineplus">+                                         nsCString &amp;aTemplate,</span>
<a href="#l7.293"></a><span id="l7.293" class="difflineplus">+                                         nsCString &amp;aTargetAddress) {</span>
<a href="#l7.294"></a><span id="l7.294">   nsresult rv;</span>
<a href="#l7.295"></a><span id="l7.295">   nsAutoCString target;</span>
<a href="#l7.296"></a><span id="l7.296">   rv = GetActionTarget(aLine, target);</span>
<a href="#l7.297"></a><span id="l7.297">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.298"></a><span id="l7.298"> </span>
<a href="#l7.299"></a><span id="l7.299">   int32_t asteriskPosition = target.FindChar('*');</span>
<a href="#l7.300"></a><span id="l7.300">   if (asteriskPosition &lt; 0) {</span>
<a href="#l7.301"></a><span id="l7.301">     aTemplate.Assign(target);</span>
<a href="#l7.302"></a><span id="l7.302" class="difflineat">@@ -310,22 +281,19 @@ nsBeckyFilters::GetResendTarget(const ns</span>
<a href="#l7.303"></a><span id="l7.303">     return NS_ERROR_FAILURE;</span>
<a href="#l7.304"></a><span id="l7.304"> </span>
<a href="#l7.305"></a><span id="l7.305">   aTemplate.Assign(StringHead(target, asteriskPosition - 1));</span>
<a href="#l7.306"></a><span id="l7.306">   aTargetAddress.Assign(Substring(target, asteriskPosition + 1));</span>
<a href="#l7.307"></a><span id="l7.307"> </span>
<a href="#l7.308"></a><span id="l7.308">   return NS_OK;</span>
<a href="#l7.309"></a><span id="l7.309"> }</span>
<a href="#l7.310"></a><span id="l7.310"> </span>
<a href="#l7.311"></a><span id="l7.311" class="difflineminus">-nsresult</span>
<a href="#l7.312"></a><span id="l7.312" class="difflineminus">-nsBeckyFilters::CreateResendAction(const nsCString &amp;aLine,</span>
<a href="#l7.313"></a><span id="l7.313" class="difflineminus">-                                   nsIMsgFilter *aFilter,</span>
<a href="#l7.314"></a><span id="l7.314" class="difflineminus">-                                   const nsMsgRuleActionType &amp;aActionType,</span>
<a href="#l7.315"></a><span id="l7.315" class="difflineminus">-                                   nsIMsgRuleAction **_retval)</span>
<a href="#l7.316"></a><span id="l7.316" class="difflineminus">-{</span>
<a href="#l7.317"></a><span id="l7.317" class="difflineplus">+nsresult nsBeckyFilters::CreateResendAction(</span>
<a href="#l7.318"></a><span id="l7.318" class="difflineplus">+    const nsCString &amp;aLine, nsIMsgFilter *aFilter,</span>
<a href="#l7.319"></a><span id="l7.319" class="difflineplus">+    const nsMsgRuleActionType &amp;aActionType, nsIMsgRuleAction **_retval) {</span>
<a href="#l7.320"></a><span id="l7.320">   nsresult rv;</span>
<a href="#l7.321"></a><span id="l7.321">   nsCOMPtr&lt;nsIMsgRuleAction&gt; action;</span>
<a href="#l7.322"></a><span id="l7.322">   rv = CreateRuleAction(aFilter, aActionType, getter_AddRefs(action));</span>
<a href="#l7.323"></a><span id="l7.323">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.324"></a><span id="l7.324"> </span>
<a href="#l7.325"></a><span id="l7.325">   nsAutoCString templateString;</span>
<a href="#l7.326"></a><span id="l7.326">   nsAutoCString targetAddress;</span>
<a href="#l7.327"></a><span id="l7.327">   rv = GetResendTarget(aLine, templateString, targetAddress);</span>
<a href="#l7.328"></a><span id="l7.328" class="difflineat">@@ -337,79 +305,72 @@ nsBeckyFilters::CreateResendAction(const</span>
<a href="#l7.329"></a><span id="l7.329">     rv = action-&gt;SetStrValue(templateString);</span>
<a href="#l7.330"></a><span id="l7.330">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.331"></a><span id="l7.331"> </span>
<a href="#l7.332"></a><span id="l7.332">   action.forget(_retval);</span>
<a href="#l7.333"></a><span id="l7.333"> </span>
<a href="#l7.334"></a><span id="l7.334">   return NS_OK;</span>
<a href="#l7.335"></a><span id="l7.335"> }</span>
<a href="#l7.336"></a><span id="l7.336"> </span>
<a href="#l7.337"></a><span id="l7.337" class="difflineminus">-nsresult</span>
<a href="#l7.338"></a><span id="l7.338" class="difflineminus">-nsBeckyFilters::GetFolderNameFromTarget(const nsCString &amp;aTarget, nsAString &amp;aName)</span>
<a href="#l7.339"></a><span id="l7.339" class="difflineminus">-{</span>
<a href="#l7.340"></a><span id="l7.340" class="difflineplus">+nsresult nsBeckyFilters::GetFolderNameFromTarget(const nsCString &amp;aTarget,</span>
<a href="#l7.341"></a><span id="l7.341" class="difflineplus">+                                                 nsAString &amp;aName) {</span>
<a href="#l7.342"></a><span id="l7.342">   int32_t backslashPosition = aTarget.RFindChar('\\');</span>
<a href="#l7.343"></a><span id="l7.343">   if (backslashPosition &gt; 0) {</span>
<a href="#l7.344"></a><span id="l7.344" class="difflineminus">-    NS_ConvertUTF8toUTF16 utf16String(Substring(aTarget, backslashPosition + 1));</span>
<a href="#l7.345"></a><span id="l7.345" class="difflineplus">+    NS_ConvertUTF8toUTF16 utf16String(</span>
<a href="#l7.346"></a><span id="l7.346" class="difflineplus">+        Substring(aTarget, backslashPosition + 1));</span>
<a href="#l7.347"></a><span id="l7.347">     nsBeckyUtils::TranslateFolderName(utf16String, aName);</span>
<a href="#l7.348"></a><span id="l7.348">   }</span>
<a href="#l7.349"></a><span id="l7.349"> </span>
<a href="#l7.350"></a><span id="l7.350">   return NS_OK;</span>
<a href="#l7.351"></a><span id="l7.351"> }</span>
<a href="#l7.352"></a><span id="l7.352"> </span>
<a href="#l7.353"></a><span id="l7.353" class="difflineminus">-nsresult</span>
<a href="#l7.354"></a><span id="l7.354" class="difflineminus">-nsBeckyFilters::GetDistributeTarget(const nsCString &amp;aLine,</span>
<a href="#l7.355"></a><span id="l7.355" class="difflineminus">-                                    nsCString &amp;aTargetFolder)</span>
<a href="#l7.356"></a><span id="l7.356" class="difflineminus">-{</span>
<a href="#l7.357"></a><span id="l7.357" class="difflineplus">+nsresult nsBeckyFilters::GetDistributeTarget(const nsCString &amp;aLine,</span>
<a href="#l7.358"></a><span id="l7.358" class="difflineplus">+                                             nsCString &amp;aTargetFolder) {</span>
<a href="#l7.359"></a><span id="l7.359">   nsresult rv;</span>
<a href="#l7.360"></a><span id="l7.360">   nsAutoCString target;</span>
<a href="#l7.361"></a><span id="l7.361">   rv = GetActionTarget(aLine, target);</span>
<a href="#l7.362"></a><span id="l7.362">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.363"></a><span id="l7.363"> </span>
<a href="#l7.364"></a><span id="l7.364">   target.Trim(&quot;\\&quot;, false, true);</span>
<a href="#l7.365"></a><span id="l7.365">   nsAutoString folderName;</span>
<a href="#l7.366"></a><span id="l7.366">   rv = GetFolderNameFromTarget(target, folderName);</span>
<a href="#l7.367"></a><span id="l7.367">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.368"></a><span id="l7.368"> </span>
<a href="#l7.369"></a><span id="l7.369" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; folder;</span>
<a href="#l7.370"></a><span id="l7.370" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l7.371"></a><span id="l7.371">   rv = GetMessageFolder(folderName, getter_AddRefs(folder));</span>
<a href="#l7.372"></a><span id="l7.372">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.373"></a><span id="l7.373"> </span>
<a href="#l7.374"></a><span id="l7.374">   if (!folder) {</span>
<a href="#l7.375"></a><span id="l7.375">     rv = mServer-&gt;GetRootMsgFolder(getter_AddRefs(folder));</span>
<a href="#l7.376"></a><span id="l7.376">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.377"></a><span id="l7.377">   }</span>
<a href="#l7.378"></a><span id="l7.378">   return folder-&gt;GetURI(aTargetFolder);</span>
<a href="#l7.379"></a><span id="l7.379"> }</span>
<a href="#l7.380"></a><span id="l7.380"> </span>
<a href="#l7.381"></a><span id="l7.381" class="difflineminus">-nsresult</span>
<a href="#l7.382"></a><span id="l7.382" class="difflineminus">-nsBeckyFilters::CreateDistributeAction(const nsCString &amp;aLine,</span>
<a href="#l7.383"></a><span id="l7.383" class="difflineminus">-                                       nsIMsgFilter *aFilter,</span>
<a href="#l7.384"></a><span id="l7.384" class="difflineminus">-                                       const nsMsgRuleActionType &amp;aActionType,</span>
<a href="#l7.385"></a><span id="l7.385" class="difflineminus">-                                       nsIMsgRuleAction **_retval)</span>
<a href="#l7.386"></a><span id="l7.386" class="difflineminus">-{</span>
<a href="#l7.387"></a><span id="l7.387" class="difflineplus">+nsresult nsBeckyFilters::CreateDistributeAction(</span>
<a href="#l7.388"></a><span id="l7.388" class="difflineplus">+    const nsCString &amp;aLine, nsIMsgFilter *aFilter,</span>
<a href="#l7.389"></a><span id="l7.389" class="difflineplus">+    const nsMsgRuleActionType &amp;aActionType, nsIMsgRuleAction **_retval) {</span>
<a href="#l7.390"></a><span id="l7.390">   nsresult rv;</span>
<a href="#l7.391"></a><span id="l7.391">   nsCOMPtr&lt;nsIMsgRuleAction&gt; action;</span>
<a href="#l7.392"></a><span id="l7.392">   rv = CreateRuleAction(aFilter, aActionType, getter_AddRefs(action));</span>
<a href="#l7.393"></a><span id="l7.393">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.394"></a><span id="l7.394">   nsAutoCString targetFolder;</span>
<a href="#l7.395"></a><span id="l7.395">   rv = GetDistributeTarget(aLine, targetFolder);</span>
<a href="#l7.396"></a><span id="l7.396">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.397"></a><span id="l7.397">   rv = action-&gt;SetTargetFolderUri(targetFolder);</span>
<a href="#l7.398"></a><span id="l7.398">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.399"></a><span id="l7.399"> </span>
<a href="#l7.400"></a><span id="l7.400">   action.forget(_retval);</span>
<a href="#l7.401"></a><span id="l7.401"> </span>
<a href="#l7.402"></a><span id="l7.402">   return NS_OK;</span>
<a href="#l7.403"></a><span id="l7.403"> }</span>
<a href="#l7.404"></a><span id="l7.404"> </span>
<a href="#l7.405"></a><span id="l7.405" class="difflineminus">-nsresult</span>
<a href="#l7.406"></a><span id="l7.406" class="difflineminus">-nsBeckyFilters::CreateLeaveOrDeleteAction(const nsCString &amp;aLine,</span>
<a href="#l7.407"></a><span id="l7.407" class="difflineminus">-                                          nsIMsgFilter *aFilter,</span>
<a href="#l7.408"></a><span id="l7.408" class="difflineminus">-                                          nsIMsgRuleAction **_retval)</span>
<a href="#l7.409"></a><span id="l7.409" class="difflineminus">-{</span>
<a href="#l7.410"></a><span id="l7.410" class="difflineplus">+nsresult nsBeckyFilters::CreateLeaveOrDeleteAction(const nsCString &amp;aLine,</span>
<a href="#l7.411"></a><span id="l7.411" class="difflineplus">+                                                   nsIMsgFilter *aFilter,</span>
<a href="#l7.412"></a><span id="l7.412" class="difflineplus">+                                                   nsIMsgRuleAction **_retval) {</span>
<a href="#l7.413"></a><span id="l7.413">   nsresult rv;</span>
<a href="#l7.414"></a><span id="l7.414">   nsMsgRuleActionType actionType;</span>
<a href="#l7.415"></a><span id="l7.415">   if (aLine.CharAt(3) == '0') {</span>
<a href="#l7.416"></a><span id="l7.416">     actionType = nsMsgFilterAction::LeaveOnPop3Server;</span>
<a href="#l7.417"></a><span id="l7.417">   } else if (aLine.CharAt(3) == '1') {</span>
<a href="#l7.418"></a><span id="l7.418">     if (aLine.CharAt(5) == '1')</span>
<a href="#l7.419"></a><span id="l7.419">       actionType = nsMsgFilterAction::Delete;</span>
<a href="#l7.420"></a><span id="l7.420">     else</span>
<a href="#l7.421"></a><span id="l7.421" class="difflineat">@@ -421,112 +382,100 @@ nsBeckyFilters::CreateLeaveOrDeleteActio</span>
<a href="#l7.422"></a><span id="l7.422">   rv = CreateRuleAction(aFilter, actionType, getter_AddRefs(action));</span>
<a href="#l7.423"></a><span id="l7.423">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.424"></a><span id="l7.424"> </span>
<a href="#l7.425"></a><span id="l7.425">   action.forget(_retval);</span>
<a href="#l7.426"></a><span id="l7.426"> </span>
<a href="#l7.427"></a><span id="l7.427">   return NS_OK;</span>
<a href="#l7.428"></a><span id="l7.428"> }</span>
<a href="#l7.429"></a><span id="l7.429"> </span>
<a href="#l7.430"></a><span id="l7.430" class="difflineminus">-nsresult</span>
<a href="#l7.431"></a><span id="l7.431" class="difflineminus">-nsBeckyFilters::SetRuleAction(const nsCString &amp;aLine, nsIMsgFilter *aFilter)</span>
<a href="#l7.432"></a><span id="l7.432" class="difflineminus">-{</span>
<a href="#l7.433"></a><span id="l7.433" class="difflineminus">-  if (!aFilter || aLine.Length() &lt; 4)</span>
<a href="#l7.434"></a><span id="l7.434" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l7.435"></a><span id="l7.435" class="difflineplus">+nsresult nsBeckyFilters::SetRuleAction(const nsCString &amp;aLine,</span>
<a href="#l7.436"></a><span id="l7.436" class="difflineplus">+                                       nsIMsgFilter *aFilter) {</span>
<a href="#l7.437"></a><span id="l7.437" class="difflineplus">+  if (!aFilter || aLine.Length() &lt; 4) return NS_ERROR_FAILURE;</span>
<a href="#l7.438"></a><span id="l7.438"> </span>
<a href="#l7.439"></a><span id="l7.439">   nsresult rv = NS_OK;</span>
<a href="#l7.440"></a><span id="l7.440">   nsCOMPtr&lt;nsIMsgRuleAction&gt; action;</span>
<a href="#l7.441"></a><span id="l7.441">   switch (aLine.CharAt(1)) {</span>
<a href="#l7.442"></a><span id="l7.442" class="difflineminus">-    case 'R': // Reply</span>
<a href="#l7.443"></a><span id="l7.443" class="difflineminus">-      rv = CreateResendAction(aLine,</span>
<a href="#l7.444"></a><span id="l7.444" class="difflineminus">-                              aFilter,</span>
<a href="#l7.445"></a><span id="l7.445" class="difflineminus">-                              nsMsgFilterAction::Reply,</span>
<a href="#l7.446"></a><span id="l7.446" class="difflineplus">+    case 'R':  // Reply</span>
<a href="#l7.447"></a><span id="l7.447" class="difflineplus">+      rv = CreateResendAction(aLine, aFilter, nsMsgFilterAction::Reply,</span>
<a href="#l7.448"></a><span id="l7.448">                               getter_AddRefs(action));</span>
<a href="#l7.449"></a><span id="l7.449">       break;</span>
<a href="#l7.450"></a><span id="l7.450" class="difflineminus">-    case 'F': // Forward</span>
<a href="#l7.451"></a><span id="l7.451" class="difflineminus">-      rv = CreateResendAction(aLine,</span>
<a href="#l7.452"></a><span id="l7.452" class="difflineminus">-                              aFilter,</span>
<a href="#l7.453"></a><span id="l7.453" class="difflineminus">-                              nsMsgFilterAction::Forward,</span>
<a href="#l7.454"></a><span id="l7.454" class="difflineplus">+    case 'F':  // Forward</span>
<a href="#l7.455"></a><span id="l7.455" class="difflineplus">+      rv = CreateResendAction(aLine, aFilter, nsMsgFilterAction::Forward,</span>
<a href="#l7.456"></a><span id="l7.456">                               getter_AddRefs(action));</span>
<a href="#l7.457"></a><span id="l7.457">       break;</span>
<a href="#l7.458"></a><span id="l7.458" class="difflineminus">-    case 'L': // Leave or delete</span>
<a href="#l7.459"></a><span id="l7.459" class="difflineplus">+    case 'L':  // Leave or delete</span>
<a href="#l7.460"></a><span id="l7.460">       rv = CreateLeaveOrDeleteAction(aLine, aFilter, getter_AddRefs(action));</span>
<a href="#l7.461"></a><span id="l7.461">       break;</span>
<a href="#l7.462"></a><span id="l7.462" class="difflineminus">-    case 'Y': // Copy</span>
<a href="#l7.463"></a><span id="l7.463" class="difflineminus">-      rv = CreateDistributeAction(aLine,</span>
<a href="#l7.464"></a><span id="l7.464" class="difflineminus">-                                  aFilter,</span>
<a href="#l7.465"></a><span id="l7.465" class="difflineplus">+    case 'Y':  // Copy</span>
<a href="#l7.466"></a><span id="l7.466" class="difflineplus">+      rv = CreateDistributeAction(aLine, aFilter,</span>
<a href="#l7.467"></a><span id="l7.467">                                   nsMsgFilterAction::CopyToFolder,</span>
<a href="#l7.468"></a><span id="l7.468">                                   getter_AddRefs(action));</span>
<a href="#l7.469"></a><span id="l7.469">       break;</span>
<a href="#l7.470"></a><span id="l7.470" class="difflineminus">-    case 'M': // Move</span>
<a href="#l7.471"></a><span id="l7.471" class="difflineminus">-      rv = CreateDistributeAction(aLine,</span>
<a href="#l7.472"></a><span id="l7.472" class="difflineminus">-                                  aFilter,</span>
<a href="#l7.473"></a><span id="l7.473" class="difflineplus">+    case 'M':  // Move</span>
<a href="#l7.474"></a><span id="l7.474" class="difflineplus">+      rv = CreateDistributeAction(aLine, aFilter,</span>
<a href="#l7.475"></a><span id="l7.475">                                   nsMsgFilterAction::MoveToFolder,</span>
<a href="#l7.476"></a><span id="l7.476">                                   getter_AddRefs(action));</span>
<a href="#l7.477"></a><span id="l7.477">       break;</span>
<a href="#l7.478"></a><span id="l7.478" class="difflineminus">-    case 'G': // Set flag</span>
<a href="#l7.479"></a><span id="l7.479" class="difflineminus">-      if (aLine.CharAt(3) == 'R') // Read</span>
<a href="#l7.480"></a><span id="l7.480" class="difflineminus">-        rv = CreateRuleAction(aFilter, nsMsgFilterAction::MarkRead, getter_AddRefs(action));</span>
<a href="#l7.481"></a><span id="l7.481" class="difflineplus">+    case 'G':                      // Set flag</span>
<a href="#l7.482"></a><span id="l7.482" class="difflineplus">+      if (aLine.CharAt(3) == 'R')  // Read</span>
<a href="#l7.483"></a><span id="l7.483" class="difflineplus">+        rv = CreateRuleAction(aFilter, nsMsgFilterAction::MarkRead,</span>
<a href="#l7.484"></a><span id="l7.484" class="difflineplus">+                              getter_AddRefs(action));</span>
<a href="#l7.485"></a><span id="l7.485">       break;</span>
<a href="#l7.486"></a><span id="l7.486">     default:</span>
<a href="#l7.487"></a><span id="l7.487">       return NS_OK;</span>
<a href="#l7.488"></a><span id="l7.488">   }</span>
<a href="#l7.489"></a><span id="l7.489">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.490"></a><span id="l7.490"> </span>
<a href="#l7.491"></a><span id="l7.491">   if (action) {</span>
<a href="#l7.492"></a><span id="l7.492">     rv = aFilter-&gt;AppendAction(action);</span>
<a href="#l7.493"></a><span id="l7.493">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.494"></a><span id="l7.494">   }</span>
<a href="#l7.495"></a><span id="l7.495"> </span>
<a href="#l7.496"></a><span id="l7.496">   return NS_OK;</span>
<a href="#l7.497"></a><span id="l7.497"> }</span>
<a href="#l7.498"></a><span id="l7.498"> </span>
<a href="#l7.499"></a><span id="l7.499" class="difflineminus">-nsresult</span>
<a href="#l7.500"></a><span id="l7.500" class="difflineminus">-nsBeckyFilters::CreateFilter(bool aIncoming, nsIMsgFilter **_retval)</span>
<a href="#l7.501"></a><span id="l7.501" class="difflineminus">-{</span>
<a href="#l7.502"></a><span id="l7.502" class="difflineplus">+nsresult nsBeckyFilters::CreateFilter(bool aIncoming, nsIMsgFilter **_retval) {</span>
<a href="#l7.503"></a><span id="l7.503">   NS_ENSURE_STATE(mServer);</span>
<a href="#l7.504"></a><span id="l7.504"> </span>
<a href="#l7.505"></a><span id="l7.505" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFilterList&gt; filterList;</span>
<a href="#l7.506"></a><span id="l7.506" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFilterList&gt; filterList;</span>
<a href="#l7.507"></a><span id="l7.507">   nsresult rv = mServer-&gt;GetFilterList(nullptr, getter_AddRefs(filterList));</span>
<a href="#l7.508"></a><span id="l7.508">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.509"></a><span id="l7.509"> </span>
<a href="#l7.510"></a><span id="l7.510">   nsCOMPtr&lt;nsIMsgFilter&gt; filter;</span>
<a href="#l7.511"></a><span id="l7.511">   rv = filterList-&gt;CreateFilter(EmptyString(), getter_AddRefs(filter));</span>
<a href="#l7.512"></a><span id="l7.512">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.513"></a><span id="l7.513"> </span>
<a href="#l7.514"></a><span id="l7.514">   if (aIncoming)</span>
<a href="#l7.515"></a><span id="l7.515">     filter-&gt;SetFilterType(nsMsgFilterType::InboxRule | nsMsgFilterType::Manual);</span>
<a href="#l7.516"></a><span id="l7.516">   else</span>
<a href="#l7.517"></a><span id="l7.517" class="difflineminus">-    filter-&gt;SetFilterType(nsMsgFilterType::PostOutgoing | nsMsgFilterType::Manual);</span>
<a href="#l7.518"></a><span id="l7.518" class="difflineplus">+    filter-&gt;SetFilterType(nsMsgFilterType::PostOutgoing |</span>
<a href="#l7.519"></a><span id="l7.519" class="difflineplus">+                          nsMsgFilterType::Manual);</span>
<a href="#l7.520"></a><span id="l7.520"> </span>
<a href="#l7.521"></a><span id="l7.521">   filter-&gt;SetEnabled(true);</span>
<a href="#l7.522"></a><span id="l7.522">   filter.forget(_retval);</span>
<a href="#l7.523"></a><span id="l7.523"> </span>
<a href="#l7.524"></a><span id="l7.524">   return NS_OK;</span>
<a href="#l7.525"></a><span id="l7.525"> }</span>
<a href="#l7.526"></a><span id="l7.526"> </span>
<a href="#l7.527"></a><span id="l7.527" class="difflineminus">-nsresult</span>
<a href="#l7.528"></a><span id="l7.528" class="difflineminus">-nsBeckyFilters::AppendFilter(nsIMsgFilter *aFilter)</span>
<a href="#l7.529"></a><span id="l7.529" class="difflineminus">-{</span>
<a href="#l7.530"></a><span id="l7.530" class="difflineplus">+nsresult nsBeckyFilters::AppendFilter(nsIMsgFilter *aFilter) {</span>
<a href="#l7.531"></a><span id="l7.531">   NS_ENSURE_STATE(mServer);</span>
<a href="#l7.532"></a><span id="l7.532"> </span>
<a href="#l7.533"></a><span id="l7.533" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFilterList&gt; filterList;</span>
<a href="#l7.534"></a><span id="l7.534" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFilterList&gt; filterList;</span>
<a href="#l7.535"></a><span id="l7.535">   nsresult rv = mServer-&gt;GetFilterList(nullptr, getter_AddRefs(filterList));</span>
<a href="#l7.536"></a><span id="l7.536">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.537"></a><span id="l7.537"> </span>
<a href="#l7.538"></a><span id="l7.538">   uint32_t count;</span>
<a href="#l7.539"></a><span id="l7.539">   rv = filterList-&gt;GetFilterCount(&amp;count);</span>
<a href="#l7.540"></a><span id="l7.540">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.541"></a><span id="l7.541"> </span>
<a href="#l7.542"></a><span id="l7.542">   return filterList-&gt;InsertFilterAt(count, aFilter);</span>
<a href="#l7.543"></a><span id="l7.543"> }</span>
<a href="#l7.544"></a><span id="l7.544"> </span>
<a href="#l7.545"></a><span id="l7.545" class="difflineminus">-nsresult</span>
<a href="#l7.546"></a><span id="l7.546" class="difflineminus">-nsBeckyFilters::ParseFilterFile(nsIFile *aFile, bool aIncoming)</span>
<a href="#l7.547"></a><span id="l7.547" class="difflineminus">-{</span>
<a href="#l7.548"></a><span id="l7.548" class="difflineplus">+nsresult nsBeckyFilters::ParseFilterFile(nsIFile *aFile, bool aIncoming) {</span>
<a href="#l7.549"></a><span id="l7.549">   nsresult rv;</span>
<a href="#l7.550"></a><span id="l7.550">   nsCOMPtr&lt;nsILineInputStream&gt; lineStream;</span>
<a href="#l7.551"></a><span id="l7.551">   rv = nsBeckyUtils::CreateLineInputStream(aFile, getter_AddRefs(lineStream));</span>
<a href="#l7.552"></a><span id="l7.552">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.553"></a><span id="l7.553"> </span>
<a href="#l7.554"></a><span id="l7.554">   bool more = true;</span>
<a href="#l7.555"></a><span id="l7.555">   nsAutoCString line;</span>
<a href="#l7.556"></a><span id="l7.556"> </span>
<a href="#l7.557"></a><span id="l7.557" class="difflineat">@@ -534,44 +483,41 @@ nsBeckyFilters::ParseFilterFile(nsIFile </span>
<a href="#l7.558"></a><span id="l7.558">   while (NS_SUCCEEDED(rv) &amp;&amp; more) {</span>
<a href="#l7.559"></a><span id="l7.559">     rv = lineStream-&gt;ReadLine(line, &amp;more);</span>
<a href="#l7.560"></a><span id="l7.560"> </span>
<a href="#l7.561"></a><span id="l7.561">     switch (line.CharAt(0)) {</span>
<a href="#l7.562"></a><span id="l7.562">       case ':':</span>
<a href="#l7.563"></a><span id="l7.563">         if (line.EqualsLiteral(&quot;:Begin \&quot;\&quot;&quot;)) {</span>
<a href="#l7.564"></a><span id="l7.564">           CreateFilter(aIncoming, getter_AddRefs(filter));</span>
<a href="#l7.565"></a><span id="l7.565">         } else if (line.EqualsLiteral(&quot;:End \&quot;\&quot;&quot;)) {</span>
<a href="#l7.566"></a><span id="l7.566" class="difflineminus">-          if (filter)</span>
<a href="#l7.567"></a><span id="l7.567" class="difflineminus">-            AppendFilter(filter);</span>
<a href="#l7.568"></a><span id="l7.568" class="difflineplus">+          if (filter) AppendFilter(filter);</span>
<a href="#l7.569"></a><span id="l7.569">           filter = nullptr;</span>
<a href="#l7.570"></a><span id="l7.570">         }</span>
<a href="#l7.571"></a><span id="l7.571">         break;</span>
<a href="#l7.572"></a><span id="l7.572">       case '!':</span>
<a href="#l7.573"></a><span id="l7.573">         SetRuleAction(line, filter);</span>
<a href="#l7.574"></a><span id="l7.574">         break;</span>
<a href="#l7.575"></a><span id="l7.575">       case '@':</span>
<a href="#l7.576"></a><span id="l7.576">         SetSearchTerm(line, filter);</span>
<a href="#l7.577"></a><span id="l7.577">         break;</span>
<a href="#l7.578"></a><span id="l7.578" class="difflineminus">-      case '$': // $X: disabled</span>
<a href="#l7.579"></a><span id="l7.579" class="difflineplus">+      case '$':  // $X: disabled</span>
<a href="#l7.580"></a><span id="l7.580">         if (StringBeginsWith(line, NS_LITERAL_CSTRING(&quot;$X&quot;)) &amp;&amp; filter) {</span>
<a href="#l7.581"></a><span id="l7.581">           filter-&gt;SetEnabled(false);</span>
<a href="#l7.582"></a><span id="l7.582">         }</span>
<a href="#l7.583"></a><span id="l7.583">         break;</span>
<a href="#l7.584"></a><span id="l7.584">       default:</span>
<a href="#l7.585"></a><span id="l7.585">         break;</span>
<a href="#l7.586"></a><span id="l7.586">     }</span>
<a href="#l7.587"></a><span id="l7.587">   }</span>
<a href="#l7.588"></a><span id="l7.588"> </span>
<a href="#l7.589"></a><span id="l7.589">   return NS_OK;</span>
<a href="#l7.590"></a><span id="l7.590"> }</span>
<a href="#l7.591"></a><span id="l7.591"> </span>
<a href="#l7.592"></a><span id="l7.592"> NS_IMETHODIMP</span>
<a href="#l7.593"></a><span id="l7.593" class="difflineminus">-nsBeckyFilters::Import(char16_t **aError,</span>
<a href="#l7.594"></a><span id="l7.594" class="difflineminus">-                       bool *_retval)</span>
<a href="#l7.595"></a><span id="l7.595" class="difflineminus">-{</span>
<a href="#l7.596"></a><span id="l7.596" class="difflineplus">+nsBeckyFilters::Import(char16_t **aError, bool *_retval) {</span>
<a href="#l7.597"></a><span id="l7.597">   NS_ENSURE_ARG_POINTER(aError);</span>
<a href="#l7.598"></a><span id="l7.598">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l7.599"></a><span id="l7.599"> </span>
<a href="#l7.600"></a><span id="l7.600">   // If mLocation is null, set it to the default filter directory.</span>
<a href="#l7.601"></a><span id="l7.601">   // If mLocation is a file, we import it as incoming folder.</span>
<a href="#l7.602"></a><span id="l7.602">   // If mLocation is a directory, we try to import incoming and outgoing folders</span>
<a href="#l7.603"></a><span id="l7.603">   // from it (in default files).</span>
<a href="#l7.604"></a><span id="l7.604"> </span>
<a href="#l7.605"></a><span id="l7.605" class="difflineat">@@ -580,18 +526,17 @@ nsBeckyFilters::Import(char16_t **aError</span>
<a href="#l7.606"></a><span id="l7.606">   nsCOMPtr&lt;nsIFile&gt; filterFile;</span>
<a href="#l7.607"></a><span id="l7.607"> </span>
<a href="#l7.608"></a><span id="l7.608">   bool haveFile = false;</span>
<a href="#l7.609"></a><span id="l7.609"> </span>
<a href="#l7.610"></a><span id="l7.610">   if (!mLocation) {</span>
<a href="#l7.611"></a><span id="l7.611">     bool retval = false;</span>
<a href="#l7.612"></a><span id="l7.612">     rv = AutoLocate(nullptr, getter_AddRefs(mLocation), &amp;retval);</span>
<a href="#l7.613"></a><span id="l7.613">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.614"></a><span id="l7.614" class="difflineminus">-    if (!retval)</span>
<a href="#l7.615"></a><span id="l7.615" class="difflineminus">-      return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l7.616"></a><span id="l7.616" class="difflineplus">+    if (!retval) return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l7.617"></a><span id="l7.617">   }</span>
<a href="#l7.618"></a><span id="l7.618"> </span>
<a href="#l7.619"></a><span id="l7.619">   // What type of location do we have?</span>
<a href="#l7.620"></a><span id="l7.620">   bool isDirectory = false;</span>
<a href="#l7.621"></a><span id="l7.621">   rv = mLocation-&gt;IsDirectory(&amp;isDirectory);</span>
<a href="#l7.622"></a><span id="l7.622">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.623"></a><span id="l7.623">   if (isDirectory) {</span>
<a href="#l7.624"></a><span id="l7.624">     haveFile = false;</span>
<a href="#l7.625"></a><span id="l7.625" class="difflineat">@@ -610,62 +555,60 @@ nsBeckyFilters::Import(char16_t **aError</span>
<a href="#l7.626"></a><span id="l7.626"> </span>
<a href="#l7.627"></a><span id="l7.627">   bool haveIncoming = true;</span>
<a href="#l7.628"></a><span id="l7.628">   if (haveFile) {</span>
<a href="#l7.629"></a><span id="l7.629">     // If the passed filename equals OFilter.def, import as outgoing filters.</span>
<a href="#l7.630"></a><span id="l7.630">     // Everything else is considered incoming.</span>
<a href="#l7.631"></a><span id="l7.631">     nsAutoString fileName;</span>
<a href="#l7.632"></a><span id="l7.632">     rv = mLocation-&gt;GetLeafName(fileName);</span>
<a href="#l7.633"></a><span id="l7.633">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.634"></a><span id="l7.634" class="difflineminus">-    if (fileName.EqualsLiteral(&quot;OFilter.def&quot;))</span>
<a href="#l7.635"></a><span id="l7.635" class="difflineminus">-      haveIncoming = false;</span>
<a href="#l7.636"></a><span id="l7.636" class="difflineplus">+    if (fileName.EqualsLiteral(&quot;OFilter.def&quot;)) haveIncoming = false;</span>
<a href="#l7.637"></a><span id="l7.637">   }</span>
<a href="#l7.638"></a><span id="l7.638"> </span>
<a href="#l7.639"></a><span id="l7.639">   // Try importing from the passed in file or the default incoming filters file.</span>
<a href="#l7.640"></a><span id="l7.640" class="difflineminus">-  if ((haveFile &amp;&amp; haveIncoming) || (!haveFile &amp;&amp;</span>
<a href="#l7.641"></a><span id="l7.641" class="difflineminus">-      NS_SUCCEEDED(GetFilterFile(true, mLocation, getter_AddRefs(filterFile)))))</span>
<a href="#l7.642"></a><span id="l7.642" class="difflineminus">-  {</span>
<a href="#l7.643"></a><span id="l7.643" class="difflineplus">+  if ((haveFile &amp;&amp; haveIncoming) ||</span>
<a href="#l7.644"></a><span id="l7.644" class="difflineplus">+      (!haveFile &amp;&amp; NS_SUCCEEDED(GetFilterFile(true, mLocation,</span>
<a href="#l7.645"></a><span id="l7.645" class="difflineplus">+                                               getter_AddRefs(filterFile))))) {</span>
<a href="#l7.646"></a><span id="l7.646">     rv = CollectServers();</span>
<a href="#l7.647"></a><span id="l7.647">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.648"></a><span id="l7.648"> </span>
<a href="#l7.649"></a><span id="l7.649" class="difflineminus">-    rv = nsBeckyUtils::ConvertToUTF8File(filterFile, getter_AddRefs(mConvertedFile));</span>
<a href="#l7.650"></a><span id="l7.650" class="difflineplus">+    rv = nsBeckyUtils::ConvertToUTF8File(filterFile,</span>
<a href="#l7.651"></a><span id="l7.651" class="difflineplus">+                                         getter_AddRefs(mConvertedFile));</span>
<a href="#l7.652"></a><span id="l7.652">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.653"></a><span id="l7.653"> </span>
<a href="#l7.654"></a><span id="l7.654">     rv = ParseFilterFile(mConvertedFile, true);</span>
<a href="#l7.655"></a><span id="l7.655" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l7.656"></a><span id="l7.656" class="difflineminus">-      *_retval = true;</span>
<a href="#l7.657"></a><span id="l7.657" class="difflineplus">+    if (NS_SUCCEEDED(rv)) *_retval = true;</span>
<a href="#l7.658"></a><span id="l7.658"> </span>
<a href="#l7.659"></a><span id="l7.659">     (void)RemoveConvertedFile();</span>
<a href="#l7.660"></a><span id="l7.660">   }</span>
<a href="#l7.661"></a><span id="l7.661"> </span>
<a href="#l7.662"></a><span id="l7.662" class="difflineminus">-  // If we didn't have a file passed (but a directory), try finding also outgoing filters.</span>
<a href="#l7.663"></a><span id="l7.663" class="difflineminus">-  if ((haveFile &amp;&amp; !haveIncoming) || (!haveFile &amp;&amp;</span>
<a href="#l7.664"></a><span id="l7.664" class="difflineminus">-      NS_SUCCEEDED(GetFilterFile(false, mLocation, getter_AddRefs(filterFile)))))</span>
<a href="#l7.665"></a><span id="l7.665" class="difflineminus">-  {</span>
<a href="#l7.666"></a><span id="l7.666" class="difflineplus">+  // If we didn't have a file passed (but a directory), try finding also</span>
<a href="#l7.667"></a><span id="l7.667" class="difflineplus">+  // outgoing filters.</span>
<a href="#l7.668"></a><span id="l7.668" class="difflineplus">+  if ((haveFile &amp;&amp; !haveIncoming) ||</span>
<a href="#l7.669"></a><span id="l7.669" class="difflineplus">+      (!haveFile &amp;&amp; NS_SUCCEEDED(GetFilterFile(false, mLocation,</span>
<a href="#l7.670"></a><span id="l7.670" class="difflineplus">+                                               getter_AddRefs(filterFile))))) {</span>
<a href="#l7.671"></a><span id="l7.671">     rv = CollectServers();</span>
<a href="#l7.672"></a><span id="l7.672">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.673"></a><span id="l7.673"> </span>
<a href="#l7.674"></a><span id="l7.674" class="difflineminus">-    rv = nsBeckyUtils::ConvertToUTF8File(filterFile, getter_AddRefs(mConvertedFile));</span>
<a href="#l7.675"></a><span id="l7.675" class="difflineplus">+    rv = nsBeckyUtils::ConvertToUTF8File(filterFile,</span>
<a href="#l7.676"></a><span id="l7.676" class="difflineplus">+                                         getter_AddRefs(mConvertedFile));</span>
<a href="#l7.677"></a><span id="l7.677">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.678"></a><span id="l7.678"> </span>
<a href="#l7.679"></a><span id="l7.679">     rv = ParseFilterFile(mConvertedFile, false);</span>
<a href="#l7.680"></a><span id="l7.680" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l7.681"></a><span id="l7.681" class="difflineminus">-      *_retval = true;</span>
<a href="#l7.682"></a><span id="l7.682" class="difflineplus">+    if (NS_SUCCEEDED(rv)) *_retval = true;</span>
<a href="#l7.683"></a><span id="l7.683"> </span>
<a href="#l7.684"></a><span id="l7.684">     (void)RemoveConvertedFile();</span>
<a href="#l7.685"></a><span id="l7.685">   }</span>
<a href="#l7.686"></a><span id="l7.686"> </span>
<a href="#l7.687"></a><span id="l7.687">   return rv;</span>
<a href="#l7.688"></a><span id="l7.688"> }</span>
<a href="#l7.689"></a><span id="l7.689"> </span>
<a href="#l7.690"></a><span id="l7.690" class="difflineminus">-nsresult</span>
<a href="#l7.691"></a><span id="l7.691" class="difflineminus">-nsBeckyFilters::FindMessageFolder(const nsAString &amp;aName,</span>
<a href="#l7.692"></a><span id="l7.692" class="difflineminus">-                                  nsIMsgFolder *aParentFolder,</span>
<a href="#l7.693"></a><span id="l7.693" class="difflineminus">-                                  nsIMsgFolder **_retval)</span>
<a href="#l7.694"></a><span id="l7.694" class="difflineminus">-{</span>
<a href="#l7.695"></a><span id="l7.695" class="difflineplus">+nsresult nsBeckyFilters::FindMessageFolder(const nsAString &amp;aName,</span>
<a href="#l7.696"></a><span id="l7.696" class="difflineplus">+                                           nsIMsgFolder *aParentFolder,</span>
<a href="#l7.697"></a><span id="l7.697" class="difflineplus">+                                           nsIMsgFolder **_retval) {</span>
<a href="#l7.698"></a><span id="l7.698">   nsresult rv;</span>
<a href="#l7.699"></a><span id="l7.699"> </span>
<a href="#l7.700"></a><span id="l7.700">   nsCOMPtr&lt;nsIMsgFolder&gt; found;</span>
<a href="#l7.701"></a><span id="l7.701">   rv = aParentFolder-&gt;GetChildNamed(aName, getter_AddRefs(found));</span>
<a href="#l7.702"></a><span id="l7.702">   if (found) {</span>
<a href="#l7.703"></a><span id="l7.703">     found.forget(_retval);</span>
<a href="#l7.704"></a><span id="l7.704">     return NS_OK;</span>
<a href="#l7.705"></a><span id="l7.705">   }</span>
<a href="#l7.706"></a><span id="l7.706" class="difflineat">@@ -688,33 +631,29 @@ nsBeckyFilters::FindMessageFolder(const </span>
<a href="#l7.707"></a><span id="l7.707">       found.forget(_retval);</span>
<a href="#l7.708"></a><span id="l7.708">       return NS_OK;</span>
<a href="#l7.709"></a><span id="l7.709">     }</span>
<a href="#l7.710"></a><span id="l7.710">   }</span>
<a href="#l7.711"></a><span id="l7.711"> </span>
<a href="#l7.712"></a><span id="l7.712">   return NS_MSG_ERROR_INVALID_FOLDER_NAME;</span>
<a href="#l7.713"></a><span id="l7.713"> }</span>
<a href="#l7.714"></a><span id="l7.714"> </span>
<a href="#l7.715"></a><span id="l7.715" class="difflineminus">-nsresult</span>
<a href="#l7.716"></a><span id="l7.716" class="difflineminus">-nsBeckyFilters::FindMessageFolderInServer(const nsAString &amp;aName,</span>
<a href="#l7.717"></a><span id="l7.717" class="difflineminus">-                                          nsIMsgIncomingServer *aServer,</span>
<a href="#l7.718"></a><span id="l7.718" class="difflineminus">-                                          nsIMsgFolder **_retval)</span>
<a href="#l7.719"></a><span id="l7.719" class="difflineminus">-{</span>
<a href="#l7.720"></a><span id="l7.720" class="difflineplus">+nsresult nsBeckyFilters::FindMessageFolderInServer(</span>
<a href="#l7.721"></a><span id="l7.721" class="difflineplus">+    const nsAString &amp;aName, nsIMsgIncomingServer *aServer,</span>
<a href="#l7.722"></a><span id="l7.722" class="difflineplus">+    nsIMsgFolder **_retval) {</span>
<a href="#l7.723"></a><span id="l7.723">   nsresult rv;</span>
<a href="#l7.724"></a><span id="l7.724" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l7.725"></a><span id="l7.725" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l7.726"></a><span id="l7.726">   rv = aServer-&gt;GetRootMsgFolder(getter_AddRefs(rootFolder));</span>
<a href="#l7.727"></a><span id="l7.727">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.728"></a><span id="l7.728"> </span>
<a href="#l7.729"></a><span id="l7.729">   return FindMessageFolder(aName, rootFolder, _retval);</span>
<a href="#l7.730"></a><span id="l7.730"> }</span>
<a href="#l7.731"></a><span id="l7.731"> </span>
<a href="#l7.732"></a><span id="l7.732" class="difflineminus">-nsresult</span>
<a href="#l7.733"></a><span id="l7.733" class="difflineminus">-nsBeckyFilters::GetMessageFolder(const nsAString &amp;aName,</span>
<a href="#l7.734"></a><span id="l7.734" class="difflineminus">-                                 nsIMsgFolder **_retval)</span>
<a href="#l7.735"></a><span id="l7.735" class="difflineminus">-{</span>
<a href="#l7.736"></a><span id="l7.736" class="difflineplus">+nsresult nsBeckyFilters::GetMessageFolder(const nsAString &amp;aName,</span>
<a href="#l7.737"></a><span id="l7.737" class="difflineplus">+                                          nsIMsgFolder **_retval) {</span>
<a href="#l7.738"></a><span id="l7.738">   nsresult rv;</span>
<a href="#l7.739"></a><span id="l7.739"> </span>
<a href="#l7.740"></a><span id="l7.740">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager;</span>
<a href="#l7.741"></a><span id="l7.741">   accountManager = do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l7.742"></a><span id="l7.742">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.743"></a><span id="l7.743"> </span>
<a href="#l7.744"></a><span id="l7.744">   nsCOMPtr&lt;nsIArray&gt; accounts;</span>
<a href="#l7.745"></a><span id="l7.745">   rv = accountManager-&gt;GetAccounts(getter_AddRefs(accounts));</span>
<a href="#l7.746"></a><span id="l7.746" class="difflineat">@@ -722,75 +661,64 @@ nsBeckyFilters::GetMessageFolder(const n</span>
<a href="#l7.747"></a><span id="l7.747"> </span>
<a href="#l7.748"></a><span id="l7.748">   uint32_t accountCount;</span>
<a href="#l7.749"></a><span id="l7.749">   rv = accounts-&gt;GetLength(&amp;accountCount);</span>
<a href="#l7.750"></a><span id="l7.750">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.751"></a><span id="l7.751"> </span>
<a href="#l7.752"></a><span id="l7.752">   nsCOMPtr&lt;nsIMsgFolder&gt; found;</span>
<a href="#l7.753"></a><span id="l7.753">   for (uint32_t i = 0; i &lt; accountCount; i++) {</span>
<a href="#l7.754"></a><span id="l7.754">     nsCOMPtr&lt;nsIMsgAccount&gt; account(do_QueryElementAt(accounts, i));</span>
<a href="#l7.755"></a><span id="l7.755" class="difflineminus">-    if (!account)</span>
<a href="#l7.756"></a><span id="l7.756" class="difflineminus">-      continue;</span>
<a href="#l7.757"></a><span id="l7.757" class="difflineplus">+    if (!account) continue;</span>
<a href="#l7.758"></a><span id="l7.758"> </span>
<a href="#l7.759"></a><span id="l7.759">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l7.760"></a><span id="l7.760">     account-&gt;GetIncomingServer(getter_AddRefs(server));</span>
<a href="#l7.761"></a><span id="l7.761" class="difflineminus">-    if (!server)</span>
<a href="#l7.762"></a><span id="l7.762" class="difflineminus">-      continue;</span>
<a href="#l7.763"></a><span id="l7.763" class="difflineplus">+    if (!server) continue;</span>
<a href="#l7.764"></a><span id="l7.764">     FindMessageFolderInServer(aName, server, getter_AddRefs(found));</span>
<a href="#l7.765"></a><span id="l7.765" class="difflineminus">-    if (found)</span>
<a href="#l7.766"></a><span id="l7.766" class="difflineminus">-      break;</span>
<a href="#l7.767"></a><span id="l7.767" class="difflineplus">+    if (found) break;</span>
<a href="#l7.768"></a><span id="l7.768">   }</span>
<a href="#l7.769"></a><span id="l7.769"> </span>
<a href="#l7.770"></a><span id="l7.770">   if (!found) {</span>
<a href="#l7.771"></a><span id="l7.771">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l7.772"></a><span id="l7.772">     rv = accountManager-&gt;GetLocalFoldersServer(getter_AddRefs(server));</span>
<a href="#l7.773"></a><span id="l7.773">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.774"></a><span id="l7.774"> </span>
<a href="#l7.775"></a><span id="l7.775">     FindMessageFolderInServer(aName, server, getter_AddRefs(found));</span>
<a href="#l7.776"></a><span id="l7.776">   }</span>
<a href="#l7.777"></a><span id="l7.777"> </span>
<a href="#l7.778"></a><span id="l7.778" class="difflineminus">-  if (!found)</span>
<a href="#l7.779"></a><span id="l7.779" class="difflineminus">-    return NS_MSG_ERROR_INVALID_FOLDER_NAME;</span>
<a href="#l7.780"></a><span id="l7.780" class="difflineplus">+  if (!found) return NS_MSG_ERROR_INVALID_FOLDER_NAME;</span>
<a href="#l7.781"></a><span id="l7.781"> </span>
<a href="#l7.782"></a><span id="l7.782">   found.forget(_retval);</span>
<a href="#l7.783"></a><span id="l7.783"> </span>
<a href="#l7.784"></a><span id="l7.784">   return NS_OK;</span>
<a href="#l7.785"></a><span id="l7.785"> }</span>
<a href="#l7.786"></a><span id="l7.786"> </span>
<a href="#l7.787"></a><span id="l7.787" class="difflineminus">-nsresult</span>
<a href="#l7.788"></a><span id="l7.788" class="difflineminus">-nsBeckyFilters::CollectServers()</span>
<a href="#l7.789"></a><span id="l7.789" class="difflineminus">-{</span>
<a href="#l7.790"></a><span id="l7.790" class="difflineplus">+nsresult nsBeckyFilters::CollectServers() {</span>
<a href="#l7.791"></a><span id="l7.791">   nsresult rv;</span>
<a href="#l7.792"></a><span id="l7.792">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager;</span>
<a href="#l7.793"></a><span id="l7.793">   accountManager = do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l7.794"></a><span id="l7.794">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.795"></a><span id="l7.795"> </span>
<a href="#l7.796"></a><span id="l7.796">   nsCOMPtr&lt;nsIMsgAccount&gt; defaultAccount;</span>
<a href="#l7.797"></a><span id="l7.797">   rv = accountManager-&gt;GetDefaultAccount(getter_AddRefs(defaultAccount));</span>
<a href="#l7.798"></a><span id="l7.798">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.799"></a><span id="l7.799">   if (defaultAccount)</span>
<a href="#l7.800"></a><span id="l7.800">     return defaultAccount-&gt;GetIncomingServer(getter_AddRefs(mServer));</span>
<a href="#l7.801"></a><span id="l7.801"> </span>
<a href="#l7.802"></a><span id="l7.802">   // We can also import filters into the Local Folders account.</span>
<a href="#l7.803"></a><span id="l7.803">   rv = accountManager-&gt;GetLocalFoldersServer(getter_AddRefs(mServer));</span>
<a href="#l7.804"></a><span id="l7.804">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.805"></a><span id="l7.805" class="difflineminus">-  if (!mServer)</span>
<a href="#l7.806"></a><span id="l7.806" class="difflineminus">-    return NS_ERROR_UNEXPECTED;</span>
<a href="#l7.807"></a><span id="l7.807" class="difflineplus">+  if (!mServer) return NS_ERROR_UNEXPECTED;</span>
<a href="#l7.808"></a><span id="l7.808"> </span>
<a href="#l7.809"></a><span id="l7.809">   return NS_OK;</span>
<a href="#l7.810"></a><span id="l7.810"> }</span>
<a href="#l7.811"></a><span id="l7.811"> </span>
<a href="#l7.812"></a><span id="l7.812" class="difflineminus">-nsresult</span>
<a href="#l7.813"></a><span id="l7.813" class="difflineminus">-nsBeckyFilters::RemoveConvertedFile()</span>
<a href="#l7.814"></a><span id="l7.814" class="difflineminus">-{</span>
<a href="#l7.815"></a><span id="l7.815" class="difflineplus">+nsresult nsBeckyFilters::RemoveConvertedFile() {</span>
<a href="#l7.816"></a><span id="l7.816">   nsresult rv = NS_OK;</span>
<a href="#l7.817"></a><span id="l7.817">   if (mConvertedFile) {</span>
<a href="#l7.818"></a><span id="l7.818">     bool exists = false;</span>
<a href="#l7.819"></a><span id="l7.819">     mConvertedFile-&gt;Exists(&amp;exists);</span>
<a href="#l7.820"></a><span id="l7.820">     if (exists) {</span>
<a href="#l7.821"></a><span id="l7.821">       rv = mConvertedFile-&gt;Remove(false);</span>
<a href="#l7.822"></a><span id="l7.822" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l7.823"></a><span id="l7.823" class="difflineminus">-        mConvertedFile = nullptr;</span>
<a href="#l7.824"></a><span id="l7.824" class="difflineplus">+      if (NS_SUCCEEDED(rv)) mConvertedFile = nullptr;</span>
<a href="#l7.825"></a><span id="l7.825">     }</span>
<a href="#l7.826"></a><span id="l7.826">   }</span>
<a href="#l7.827"></a><span id="l7.827">   return rv;</span>
<a href="#l7.828"></a><span id="l7.828"> }</span>
<a href="#l7.829"></a><span id="l7.829" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/import/becky/src/nsBeckyFilters.h</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/import/becky/src/nsBeckyFilters.h</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -10,66 +10,62 @@</span>
<a href="#l8.4"></a><span id="l8.4"> #include &quot;nsIFile.h&quot;</span>
<a href="#l8.5"></a><span id="l8.5"> #include &quot;nsString.h&quot;</span>
<a href="#l8.6"></a><span id="l8.6"> #include &quot;nsIMsgIncomingServer.h&quot;</span>
<a href="#l8.7"></a><span id="l8.7"> #include &quot;nsMsgFilterCore.h&quot;</span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9"> class nsIMsgFilter;</span>
<a href="#l8.10"></a><span id="l8.10"> class nsIMsgRuleAction;</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-class nsBeckyFilters final : public nsIImportFilters</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-{</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-public:</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+class nsBeckyFilters final : public nsIImportFilters {</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+ public:</span>
<a href="#l8.17"></a><span id="l8.17">   nsBeckyFilters();</span>
<a href="#l8.18"></a><span id="l8.18">   static nsresult Create(nsIImportFilters **aImport);</span>
<a href="#l8.19"></a><span id="l8.19"> </span>
<a href="#l8.20"></a><span id="l8.20">   NS_DECL_ISUPPORTS</span>
<a href="#l8.21"></a><span id="l8.21">   NS_DECL_NSIIMPORTFILTERS</span>
<a href="#l8.22"></a><span id="l8.22"> </span>
<a href="#l8.23"></a><span id="l8.23" class="difflineminus">-private:</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+ private:</span>
<a href="#l8.25"></a><span id="l8.25">   virtual ~nsBeckyFilters();</span>
<a href="#l8.26"></a><span id="l8.26"> </span>
<a href="#l8.27"></a><span id="l8.27">   nsCOMPtr&lt;nsIFile&gt; mLocation;</span>
<a href="#l8.28"></a><span id="l8.28">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; mServer;</span>
<a href="#l8.29"></a><span id="l8.29">   nsCOMPtr&lt;nsIFile&gt; mConvertedFile;</span>
<a href="#l8.30"></a><span id="l8.30"> </span>
<a href="#l8.31"></a><span id="l8.31">   nsresult GetDefaultFilterLocation(nsIFile **aFile);</span>
<a href="#l8.32"></a><span id="l8.32">   nsresult GetFilterFile(bool aIncoming, nsIFile *aLocation, nsIFile **aFile);</span>
<a href="#l8.33"></a><span id="l8.33">   nsresult ParseFilterFile(nsIFile *aFile, bool aIncoming);</span>
<a href="#l8.34"></a><span id="l8.34">   nsresult ParseRuleLine(const nsCString &amp;aLine,</span>
<a href="#l8.35"></a><span id="l8.35">                          nsMsgSearchAttribValue *aSearchAttribute,</span>
<a href="#l8.36"></a><span id="l8.36">                          nsMsgSearchOpValue *aSearchOperator,</span>
<a href="#l8.37"></a><span id="l8.37">                          nsString &amp;aSearchKeyword);</span>
<a href="#l8.38"></a><span id="l8.38">   nsresult CollectServers();</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineminus">-  nsresult FindMessageFolder(const nsAString&amp; aName,</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+  nsresult FindMessageFolder(const nsAString &amp;aName,</span>
<a href="#l8.41"></a><span id="l8.41">                              nsIMsgFolder *aParantFolder,</span>
<a href="#l8.42"></a><span id="l8.42">                              nsIMsgFolder **_retval);</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineminus">-  nsresult FindMessageFolderInServer(const nsAString&amp; aName,</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+  nsresult FindMessageFolderInServer(const nsAString &amp;aName,</span>
<a href="#l8.45"></a><span id="l8.45">                                      nsIMsgIncomingServer *aServer,</span>
<a href="#l8.46"></a><span id="l8.46">                                      nsIMsgFolder **_retval);</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineminus">-  nsresult GetMessageFolder(const nsAString&amp; aName, nsIMsgFolder **_retval);</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+  nsresult GetMessageFolder(const nsAString &amp;aName, nsIMsgFolder **_retval);</span>
<a href="#l8.49"></a><span id="l8.49">   nsresult GetActionTarget(const nsCString &amp;aLine, nsCString &amp;aTarget);</span>
<a href="#l8.50"></a><span id="l8.50">   nsresult GetFolderNameFromTarget(const nsCString &amp;aTarget, nsAString &amp;aName);</span>
<a href="#l8.51"></a><span id="l8.51">   nsresult GetDistributeTarget(const nsCString &amp;aLine,</span>
<a href="#l8.52"></a><span id="l8.52">                                nsCString &amp;aTargetFolder);</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineminus">-  nsresult GetResendTarget(const nsCString &amp;aLine,</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineminus">-                           nsCString &amp;aTemplate,</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+  nsresult GetResendTarget(const nsCString &amp;aLine, nsCString &amp;aTemplate,</span>
<a href="#l8.56"></a><span id="l8.56">                            nsCString &amp;aTargetAddress);</span>
<a href="#l8.57"></a><span id="l8.57">   nsresult CreateRuleAction(nsIMsgFilter *aFilter,</span>
<a href="#l8.58"></a><span id="l8.58">                             nsMsgRuleActionType actionType,</span>
<a href="#l8.59"></a><span id="l8.59">                             nsIMsgRuleAction **_retval);</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineminus">-  nsresult CreateDistributeAction(const nsCString &amp;aLine,</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineminus">-                                  nsIMsgFilter *aFilter,</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+  nsresult CreateDistributeAction(const nsCString &amp;aLine, nsIMsgFilter *aFilter,</span>
<a href="#l8.63"></a><span id="l8.63">                                   const nsMsgRuleActionType &amp;aActionType,</span>
<a href="#l8.64"></a><span id="l8.64">                                   nsIMsgRuleAction **_retval);</span>
<a href="#l8.65"></a><span id="l8.65">   nsresult CreateLeaveOrDeleteAction(const nsCString &amp;aLine,</span>
<a href="#l8.66"></a><span id="l8.66">                                      nsIMsgFilter *aFilter,</span>
<a href="#l8.67"></a><span id="l8.67">                                      nsIMsgRuleAction **_retval);</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineminus">-  nsresult CreateResendAction(const nsCString &amp;aLine,</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineminus">-                              nsIMsgFilter *aFilter,</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+  nsresult CreateResendAction(const nsCString &amp;aLine, nsIMsgFilter *aFilter,</span>
<a href="#l8.71"></a><span id="l8.71">                               const nsMsgRuleActionType &amp;aActionType,</span>
<a href="#l8.72"></a><span id="l8.72">                               nsIMsgRuleAction **_retval);</span>
<a href="#l8.73"></a><span id="l8.73">   nsresult CreateFilter(bool aIncoming, nsIMsgFilter **_retval);</span>
<a href="#l8.74"></a><span id="l8.74">   nsresult AppendFilter(nsIMsgFilter *aFilter);</span>
<a href="#l8.75"></a><span id="l8.75">   nsresult SetRuleAction(const nsCString &amp;aLine, nsIMsgFilter *aFilter);</span>
<a href="#l8.76"></a><span id="l8.76">   nsresult SetSearchTerm(const nsCString &amp;aLine, nsIMsgFilter *aFilter);</span>
<a href="#l8.77"></a><span id="l8.77">   nsresult RemoveConvertedFile();</span>
<a href="#l8.78"></a><span id="l8.78"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/import/becky/src/nsBeckyImport.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/import/becky/src/nsBeckyImport.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -21,137 +21,123 @@</span>
<a href="#l9.4"></a><span id="l9.4"> </span>
<a href="#l9.5"></a><span id="l9.5"> #include &quot;nsBeckyImport.h&quot;</span>
<a href="#l9.6"></a><span id="l9.6"> #include &quot;nsBeckyMail.h&quot;</span>
<a href="#l9.7"></a><span id="l9.7"> #include &quot;nsBeckyAddressBooks.h&quot;</span>
<a href="#l9.8"></a><span id="l9.8"> #include &quot;nsBeckySettings.h&quot;</span>
<a href="#l9.9"></a><span id="l9.9"> #include &quot;nsBeckyFilters.h&quot;</span>
<a href="#l9.10"></a><span id="l9.10"> #include &quot;nsBeckyStringBundle.h&quot;</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-nsBeckyImport::nsBeckyImport()</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-{</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-}</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+nsBeckyImport::nsBeckyImport() {}</span>
<a href="#l9.16"></a><span id="l9.16"> </span>
<a href="#l9.17"></a><span id="l9.17" class="difflineminus">-nsBeckyImport::~nsBeckyImport()</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineminus">-{</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineminus">-}</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+nsBeckyImport::~nsBeckyImport() {}</span>
<a href="#l9.21"></a><span id="l9.21"> </span>
<a href="#l9.22"></a><span id="l9.22"> NS_IMPL_ISUPPORTS(nsBeckyImport, nsIImportModule)</span>
<a href="#l9.23"></a><span id="l9.23"> </span>
<a href="#l9.24"></a><span id="l9.24"> NS_IMETHODIMP</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineminus">-nsBeckyImport::GetName(char16_t **aName)</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineminus">-{</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+nsBeckyImport::GetName(char16_t **aName) {</span>
<a href="#l9.28"></a><span id="l9.28">   NS_ENSURE_ARG_POINTER(aName);</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineminus">-  *aName =</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-    nsBeckyStringBundle::GetStringByName(&quot;BeckyImportName&quot;);</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+  *aName = nsBeckyStringBundle::GetStringByName(&quot;BeckyImportName&quot;);</span>
<a href="#l9.32"></a><span id="l9.32">   return NS_OK;</span>
<a href="#l9.33"></a><span id="l9.33"> }</span>
<a href="#l9.34"></a><span id="l9.34"> </span>
<a href="#l9.35"></a><span id="l9.35"> NS_IMETHODIMP</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-nsBeckyImport::GetDescription(char16_t **aDescription)</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineminus">-{</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+nsBeckyImport::GetDescription(char16_t **aDescription) {</span>
<a href="#l9.39"></a><span id="l9.39">   NS_ENSURE_ARG_POINTER(aDescription);</span>
<a href="#l9.40"></a><span id="l9.40">   *aDescription =</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineminus">-    nsBeckyStringBundle::GetStringByName(&quot;BeckyImportDescription&quot;);</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+      nsBeckyStringBundle::GetStringByName(&quot;BeckyImportDescription&quot;);</span>
<a href="#l9.43"></a><span id="l9.43">   return NS_OK;</span>
<a href="#l9.44"></a><span id="l9.44"> }</span>
<a href="#l9.45"></a><span id="l9.45"> </span>
<a href="#l9.46"></a><span id="l9.46"> NS_IMETHODIMP</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineminus">-nsBeckyImport::GetSupports(char **aSupports)</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineminus">-{</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+nsBeckyImport::GetSupports(char **aSupports) {</span>
<a href="#l9.50"></a><span id="l9.50">   NS_ENSURE_ARG_POINTER(aSupports);</span>
<a href="#l9.51"></a><span id="l9.51">   *aSupports = strdup(kBeckySupportsString);</span>
<a href="#l9.52"></a><span id="l9.52">   return NS_OK;</span>
<a href="#l9.53"></a><span id="l9.53"> }</span>
<a href="#l9.54"></a><span id="l9.54"> </span>
<a href="#l9.55"></a><span id="l9.55"> NS_IMETHODIMP</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineminus">-nsBeckyImport::GetSupportsUpgrade(bool *aUpgrade)</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineminus">-{</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+nsBeckyImport::GetSupportsUpgrade(bool *aUpgrade) {</span>
<a href="#l9.59"></a><span id="l9.59">   NS_ENSURE_ARG_POINTER(aUpgrade);</span>
<a href="#l9.60"></a><span id="l9.60">   *aUpgrade = true;</span>
<a href="#l9.61"></a><span id="l9.61">   return NS_OK;</span>
<a href="#l9.62"></a><span id="l9.62"> }</span>
<a href="#l9.63"></a><span id="l9.63"> </span>
<a href="#l9.64"></a><span id="l9.64" class="difflineminus">-nsresult</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineminus">-nsBeckyImport::GetMailImportInterface(nsISupports **aInterface)</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineminus">-{</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineplus">+nsresult nsBeckyImport::GetMailImportInterface(nsISupports **aInterface) {</span>
<a href="#l9.68"></a><span id="l9.68">   nsCOMPtr&lt;nsIImportMail&gt; importer;</span>
<a href="#l9.69"></a><span id="l9.69">   nsresult rv = nsBeckyMail::Create(getter_AddRefs(importer));</span>
<a href="#l9.70"></a><span id="l9.70">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.71"></a><span id="l9.71"> </span>
<a href="#l9.72"></a><span id="l9.72" class="difflineminus">-  nsCOMPtr&lt;nsIImportService&gt; importService(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineplus">+  nsCOMPtr&lt;nsIImportService&gt; importService(</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineplus">+      do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l9.75"></a><span id="l9.75">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.76"></a><span id="l9.76">   nsCOMPtr&lt;nsIImportGeneric&gt; generic;</span>
<a href="#l9.77"></a><span id="l9.77">   rv = importService-&gt;CreateNewGenericMail(getter_AddRefs(generic));</span>
<a href="#l9.78"></a><span id="l9.78">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.79"></a><span id="l9.79"> </span>
<a href="#l9.80"></a><span id="l9.80">   generic-&gt;SetData(&quot;mailInterface&quot;, importer);</span>
<a href="#l9.81"></a><span id="l9.81"> </span>
<a href="#l9.82"></a><span id="l9.82">   nsString name;</span>
<a href="#l9.83"></a><span id="l9.83">   name.Adopt(nsBeckyStringBundle::GetStringByName(&quot;BeckyImportName&quot;));</span>
<a href="#l9.84"></a><span id="l9.84"> </span>
<a href="#l9.85"></a><span id="l9.85" class="difflineminus">-  nsCOMPtr&lt;nsISupportsString&gt; nameString(do_CreateInstance(NS_SUPPORTS_STRING_CONTRACTID, &amp;rv));</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineplus">+  nsCOMPtr&lt;nsISupportsString&gt; nameString(</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineplus">+      do_CreateInstance(NS_SUPPORTS_STRING_CONTRACTID, &amp;rv));</span>
<a href="#l9.88"></a><span id="l9.88">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.89"></a><span id="l9.89"> </span>
<a href="#l9.90"></a><span id="l9.90">   nameString-&gt;SetData(name);</span>
<a href="#l9.91"></a><span id="l9.91">   generic-&gt;SetData(&quot;name&quot;, nameString);</span>
<a href="#l9.92"></a><span id="l9.92"> </span>
<a href="#l9.93"></a><span id="l9.93">   return CallQueryInterface(generic, aInterface);</span>
<a href="#l9.94"></a><span id="l9.94"> }</span>
<a href="#l9.95"></a><span id="l9.95"> </span>
<a href="#l9.96"></a><span id="l9.96" class="difflineminus">-nsresult</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineminus">-nsBeckyImport::GetAddressBookImportInterface(nsISupports **aInterface)</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineminus">-{</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineplus">+nsresult nsBeckyImport::GetAddressBookImportInterface(</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineplus">+    nsISupports **aInterface) {</span>
<a href="#l9.101"></a><span id="l9.101">   nsresult rv;</span>
<a href="#l9.102"></a><span id="l9.102">   nsCOMPtr&lt;nsIImportAddressBooks&gt; importer;</span>
<a href="#l9.103"></a><span id="l9.103">   rv = nsBeckyAddressBooks::Create(getter_AddRefs(importer));</span>
<a href="#l9.104"></a><span id="l9.104">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.105"></a><span id="l9.105"> </span>
<a href="#l9.106"></a><span id="l9.106" class="difflineminus">-  nsCOMPtr&lt;nsIImportService&gt; importService(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineplus">+  nsCOMPtr&lt;nsIImportService&gt; importService(</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineplus">+      do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l9.109"></a><span id="l9.109">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.110"></a><span id="l9.110"> </span>
<a href="#l9.111"></a><span id="l9.111">   nsCOMPtr&lt;nsIImportGeneric&gt; generic;</span>
<a href="#l9.112"></a><span id="l9.112">   rv = importService-&gt;CreateNewGenericAddressBooks(getter_AddRefs(generic));</span>
<a href="#l9.113"></a><span id="l9.113">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.114"></a><span id="l9.114"> </span>
<a href="#l9.115"></a><span id="l9.115">   generic-&gt;SetData(&quot;addressInterface&quot;, importer);</span>
<a href="#l9.116"></a><span id="l9.116">   return CallQueryInterface(generic, aInterface);</span>
<a href="#l9.117"></a><span id="l9.117"> }</span>
<a href="#l9.118"></a><span id="l9.118"> </span>
<a href="#l9.119"></a><span id="l9.119" class="difflineminus">-nsresult</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineminus">-nsBeckyImport::GetSettingsImportInterface(nsISupports **aInterface)</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineminus">-{</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineplus">+nsresult nsBeckyImport::GetSettingsImportInterface(nsISupports **aInterface) {</span>
<a href="#l9.123"></a><span id="l9.123">   nsresult rv;</span>
<a href="#l9.124"></a><span id="l9.124">   nsCOMPtr&lt;nsIImportSettings&gt; importer;</span>
<a href="#l9.125"></a><span id="l9.125">   rv = nsBeckySettings::Create(getter_AddRefs(importer));</span>
<a href="#l9.126"></a><span id="l9.126">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.127"></a><span id="l9.127"> </span>
<a href="#l9.128"></a><span id="l9.128">   return CallQueryInterface(importer, aInterface);</span>
<a href="#l9.129"></a><span id="l9.129"> }</span>
<a href="#l9.130"></a><span id="l9.130"> </span>
<a href="#l9.131"></a><span id="l9.131" class="difflineminus">-nsresult</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineminus">-nsBeckyImport::GetFiltersImportInterface(nsISupports **aInterface)</span>
<a href="#l9.133"></a><span id="l9.133" class="difflineminus">-{</span>
<a href="#l9.134"></a><span id="l9.134" class="difflineplus">+nsresult nsBeckyImport::GetFiltersImportInterface(nsISupports **aInterface) {</span>
<a href="#l9.135"></a><span id="l9.135">   nsresult rv;</span>
<a href="#l9.136"></a><span id="l9.136">   nsCOMPtr&lt;nsIImportFilters&gt; importer;</span>
<a href="#l9.137"></a><span id="l9.137">   rv = nsBeckyFilters::Create(getter_AddRefs(importer));</span>
<a href="#l9.138"></a><span id="l9.138">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l9.139"></a><span id="l9.139"> </span>
<a href="#l9.140"></a><span id="l9.140">   return CallQueryInterface(importer, aInterface);</span>
<a href="#l9.141"></a><span id="l9.141"> }</span>
<a href="#l9.142"></a><span id="l9.142"> </span>
<a href="#l9.143"></a><span id="l9.143"> NS_IMETHODIMP</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineminus">-nsBeckyImport::GetImportInterface(const char *aImportType, nsISupports **aInterface)</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineminus">-{</span>
<a href="#l9.146"></a><span id="l9.146" class="difflineplus">+nsBeckyImport::GetImportInterface(const char *aImportType,</span>
<a href="#l9.147"></a><span id="l9.147" class="difflineplus">+                                  nsISupports **aInterface) {</span>
<a href="#l9.148"></a><span id="l9.148">   NS_ENSURE_ARG_POINTER(aImportType);</span>
<a href="#l9.149"></a><span id="l9.149">   NS_ENSURE_ARG_POINTER(aInterface);</span>
<a href="#l9.150"></a><span id="l9.150"> </span>
<a href="#l9.151"></a><span id="l9.151">   *aInterface = nullptr;</span>
<a href="#l9.152"></a><span id="l9.152" class="difflineminus">-  if (!strcmp(aImportType, &quot;mail&quot;))</span>
<a href="#l9.153"></a><span id="l9.153" class="difflineminus">-    return GetMailImportInterface(aInterface);</span>
<a href="#l9.154"></a><span id="l9.154" class="difflineplus">+  if (!strcmp(aImportType, &quot;mail&quot;)) return GetMailImportInterface(aInterface);</span>
<a href="#l9.155"></a><span id="l9.155">   if (!strcmp(aImportType, &quot;addressbook&quot;))</span>
<a href="#l9.156"></a><span id="l9.156">     return GetAddressBookImportInterface(aInterface);</span>
<a href="#l9.157"></a><span id="l9.157">   if (!strcmp(aImportType, &quot;settings&quot;))</span>
<a href="#l9.158"></a><span id="l9.158">     return GetSettingsImportInterface(aInterface);</span>
<a href="#l9.159"></a><span id="l9.159">   if (!strcmp(aImportType, &quot;filters&quot;))</span>
<a href="#l9.160"></a><span id="l9.160">     return GetFiltersImportInterface(aInterface);</span>
<a href="#l9.161"></a><span id="l9.161"> </span>
<a href="#l9.162"></a><span id="l9.162">   return NS_ERROR_NOT_AVAILABLE;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/import/becky/src/nsBeckyImport.h</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/import/becky/src/nsBeckyImport.h</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -3,34 +3,36 @@</span>
<a href="#l10.4"></a><span id="l10.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l10.5"></a><span id="l10.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l10.6"></a><span id="l10.6"> </span>
<a href="#l10.7"></a><span id="l10.7"> #ifndef nsBeckyImport_h___</span>
<a href="#l10.8"></a><span id="l10.8"> #define nsBeckyImport_h___</span>
<a href="#l10.9"></a><span id="l10.9"> </span>
<a href="#l10.10"></a><span id="l10.10"> #include &quot;nsIImportModule.h&quot;</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-#define NS_BECKYIMPORT_CID          \</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-{                                   \</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-  0x7952a6cf, 0x2442,0x4c04,        \</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-  {0x9f, 0x02, 0x15, 0x0b, 0x15, 0xa0, 0xa8, 0x41}}</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+#define NS_BECKYIMPORT_CID                           \</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+  {                                                  \</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+    0x7952a6cf, 0x2442, 0x4c04, {                    \</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+      0x9f, 0x02, 0x15, 0x0b, 0x15, 0xa0, 0xa8, 0x41 \</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+    }                                                \</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+  }</span>
<a href="#l10.22"></a><span id="l10.22"> </span>
<a href="#l10.23"></a><span id="l10.23" class="difflineminus">-#define kBeckySupportsString NS_IMPORT_MAIL_STR &quot;,&quot; NS_IMPORT_ADDRESS_STR &quot;,&quot; NS_IMPORT_SETTINGS_STR &quot;,&quot; NS_IMPORT_FILTERS_STR</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+#define kBeckySupportsString                                              \</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+  NS_IMPORT_MAIL_STR &quot;,&quot; NS_IMPORT_ADDRESS_STR &quot;,&quot; NS_IMPORT_SETTINGS_STR \</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineplus">+                     &quot;,&quot; NS_IMPORT_FILTERS_STR</span>
<a href="#l10.27"></a><span id="l10.27"> </span>
<a href="#l10.28"></a><span id="l10.28" class="difflineminus">-class nsBeckyImport final : public nsIImportModule</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineminus">-{</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineminus">-public:</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+class nsBeckyImport final : public nsIImportModule {</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+ public:</span>
<a href="#l10.33"></a><span id="l10.33">   nsBeckyImport();</span>
<a href="#l10.34"></a><span id="l10.34"> </span>
<a href="#l10.35"></a><span id="l10.35">   NS_DECL_ISUPPORTS</span>
<a href="#l10.36"></a><span id="l10.36">   NS_DECL_NSIIMPORTMODULE</span>
<a href="#l10.37"></a><span id="l10.37"> </span>
<a href="#l10.38"></a><span id="l10.38" class="difflineminus">-private:</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+ private:</span>
<a href="#l10.40"></a><span id="l10.40">   virtual ~nsBeckyImport();</span>
<a href="#l10.41"></a><span id="l10.41"> </span>
<a href="#l10.42"></a><span id="l10.42">   nsresult GetMailImportInterface(nsISupports **aInterface);</span>
<a href="#l10.43"></a><span id="l10.43">   nsresult GetAddressBookImportInterface(nsISupports **aInterface);</span>
<a href="#l10.44"></a><span id="l10.44">   nsresult GetSettingsImportInterface(nsISupports **aInterface);</span>
<a href="#l10.45"></a><span id="l10.45">   nsresult GetFiltersImportInterface(nsISupports **aInterface);</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineminus">-</span>
<a href="#l10.47"></a><span id="l10.47"> };</span>
<a href="#l10.48"></a><span id="l10.48"> </span>
<a href="#l10.49"></a><span id="l10.49"> #endif /* nsBeckyImport_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/import/becky/src/nsBeckyMail.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/import/becky/src/nsBeckyMail.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -29,72 +29,60 @@</span>
<a href="#l11.4"></a><span id="l11.4"> #include &quot;nsBeckyUtils.h&quot;</span>
<a href="#l11.5"></a><span id="l11.5"> #include &quot;nsBeckyStringBundle.h&quot;</span>
<a href="#l11.6"></a><span id="l11.6"> </span>
<a href="#l11.7"></a><span id="l11.7"> #define FROM_LINE &quot;From - Mon Jan 1 00:00:00 1965&quot; MSG_LINEBREAK</span>
<a href="#l11.8"></a><span id="l11.8"> #define X_BECKY_STATUS_HEADER &quot;X-Becky-Status&quot;</span>
<a href="#l11.9"></a><span id="l11.9"> #define X_BECKY_INCLUDE_HEADER &quot;X-Becky-Include&quot;</span>
<a href="#l11.10"></a><span id="l11.10"> </span>
<a href="#l11.11"></a><span id="l11.11"> enum {</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-  BECKY_STATUS_READ      = 1 &lt;&lt; 0,</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+  BECKY_STATUS_READ = 1 &lt;&lt; 0,</span>
<a href="#l11.14"></a><span id="l11.14">   BECKY_STATUS_FORWARDED = 1 &lt;&lt; 1,</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-  BECKY_STATUS_REPLIED   = 1 &lt;&lt; 2</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+  BECKY_STATUS_REPLIED = 1 &lt;&lt; 2</span>
<a href="#l11.17"></a><span id="l11.17"> };</span>
<a href="#l11.18"></a><span id="l11.18"> </span>
<a href="#l11.19"></a><span id="l11.19"> NS_IMPL_ISUPPORTS(nsBeckyMail, nsIImportMail)</span>
<a href="#l11.20"></a><span id="l11.20"> </span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">-nsresult</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineminus">-nsBeckyMail::Create(nsIImportMail **aImport)</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">-{</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+nsresult nsBeckyMail::Create(nsIImportMail **aImport) {</span>
<a href="#l11.25"></a><span id="l11.25">   NS_ENSURE_ARG_POINTER(aImport);</span>
<a href="#l11.26"></a><span id="l11.26">   NS_ADDREF(*aImport = new nsBeckyMail());</span>
<a href="#l11.27"></a><span id="l11.27">   return NS_OK;</span>
<a href="#l11.28"></a><span id="l11.28"> }</span>
<a href="#l11.29"></a><span id="l11.29"> </span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">-nsBeckyMail::nsBeckyMail()</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-: mReadBytes(0)</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-{</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-}</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+nsBeckyMail::nsBeckyMail() : mReadBytes(0) {}</span>
<a href="#l11.35"></a><span id="l11.35"> </span>
<a href="#l11.36"></a><span id="l11.36" class="difflineminus">-nsBeckyMail::~nsBeckyMail()</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineminus">-{</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineminus">-}</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+nsBeckyMail::~nsBeckyMail() {}</span>
<a href="#l11.40"></a><span id="l11.40"> </span>
<a href="#l11.41"></a><span id="l11.41"> NS_IMETHODIMP</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineminus">-nsBeckyMail::GetDefaultLocation(nsIFile **aLocation,</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineminus">-                                bool *aFound,</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineminus">-                                bool *aUserVerify)</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineminus">-{</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineplus">+nsBeckyMail::GetDefaultLocation(nsIFile **aLocation, bool *aFound,</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineplus">+                                bool *aUserVerify) {</span>
<a href="#l11.48"></a><span id="l11.48">   NS_ENSURE_ARG_POINTER(aFound);</span>
<a href="#l11.49"></a><span id="l11.49">   NS_ENSURE_ARG_POINTER(aLocation);</span>
<a href="#l11.50"></a><span id="l11.50">   NS_ENSURE_ARG_POINTER(aUserVerify);</span>
<a href="#l11.51"></a><span id="l11.51"> </span>
<a href="#l11.52"></a><span id="l11.52">   *aLocation = nullptr;</span>
<a href="#l11.53"></a><span id="l11.53">   *aUserVerify = true;</span>
<a href="#l11.54"></a><span id="l11.54">   *aFound = false;</span>
<a href="#l11.55"></a><span id="l11.55">   if (NS_SUCCEEDED(nsBeckyUtils::GetDefaultMailboxDirectory(aLocation)))</span>
<a href="#l11.56"></a><span id="l11.56">     *aFound = true;</span>
<a href="#l11.57"></a><span id="l11.57"> </span>
<a href="#l11.58"></a><span id="l11.58">   return NS_OK;</span>
<a href="#l11.59"></a><span id="l11.59"> }</span>
<a href="#l11.60"></a><span id="l11.60"> </span>
<a href="#l11.61"></a><span id="l11.61" class="difflineminus">-nsresult</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineminus">-nsBeckyMail::CreateMailboxDescriptor(nsIImportMailboxDescriptor **aDescriptor)</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineminus">-{</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineplus">+nsresult nsBeckyMail::CreateMailboxDescriptor(</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineplus">+    nsIImportMailboxDescriptor **aDescriptor) {</span>
<a href="#l11.66"></a><span id="l11.66">   nsresult rv;</span>
<a href="#l11.67"></a><span id="l11.67">   nsCOMPtr&lt;nsIImportService&gt; importService;</span>
<a href="#l11.68"></a><span id="l11.68">   importService = do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l11.69"></a><span id="l11.69">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.70"></a><span id="l11.70"> </span>
<a href="#l11.71"></a><span id="l11.71">   return importService-&gt;CreateNewMailboxDescriptor(aDescriptor);</span>
<a href="#l11.72"></a><span id="l11.72"> }</span>
<a href="#l11.73"></a><span id="l11.73"> </span>
<a href="#l11.74"></a><span id="l11.74" class="difflineminus">-nsresult</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineminus">-nsBeckyMail::GetMailboxName(nsIFile *aMailbox, nsAString &amp;aName)</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineminus">-{</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineplus">+nsresult nsBeckyMail::GetMailboxName(nsIFile *aMailbox, nsAString &amp;aName) {</span>
<a href="#l11.78"></a><span id="l11.78">   nsCOMPtr&lt;nsIFile&gt; iniFile;</span>
<a href="#l11.79"></a><span id="l11.79">   nsBeckyUtils::GetMailboxINIFile(aMailbox, getter_AddRefs(iniFile));</span>
<a href="#l11.80"></a><span id="l11.80">   if (iniFile) {</span>
<a href="#l11.81"></a><span id="l11.81">     nsCOMPtr&lt;nsIFile&gt; convertedFile;</span>
<a href="#l11.82"></a><span id="l11.82">     nsBeckyUtils::ConvertToUTF8File(iniFile, getter_AddRefs(convertedFile));</span>
<a href="#l11.83"></a><span id="l11.83">     if (convertedFile) {</span>
<a href="#l11.84"></a><span id="l11.84">       nsAutoCString utf8Name;</span>
<a href="#l11.85"></a><span id="l11.85">       nsBeckyUtils::GetMailboxNameFromINIFile(convertedFile, utf8Name);</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineat">@@ -108,22 +96,20 @@ nsBeckyMail::GetMailboxName(nsIFile *aMa</span>
<a href="#l11.87"></a><span id="l11.87">     aMailbox-&gt;GetLeafName(name);</span>
<a href="#l11.88"></a><span id="l11.88">     name.Trim(&quot;!&quot;, true, false);</span>
<a href="#l11.89"></a><span id="l11.89">     aName.Assign(name);</span>
<a href="#l11.90"></a><span id="l11.90">   }</span>
<a href="#l11.91"></a><span id="l11.91"> </span>
<a href="#l11.92"></a><span id="l11.92">   return NS_OK;</span>
<a href="#l11.93"></a><span id="l11.93"> }</span>
<a href="#l11.94"></a><span id="l11.94"> </span>
<a href="#l11.95"></a><span id="l11.95" class="difflineminus">-nsresult</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineminus">-nsBeckyMail::AppendMailboxDescriptor(nsIFile *aEntry,</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineminus">-                                     const nsString &amp;aName,</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineminus">-                                     uint32_t aDepth,</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineminus">-                                     nsIMutableArray *aCollected)</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineminus">-{</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineplus">+nsresult nsBeckyMail::AppendMailboxDescriptor(nsIFile *aEntry,</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineplus">+                                              const nsString &amp;aName,</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineplus">+                                              uint32_t aDepth,</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineplus">+                                              nsIMutableArray *aCollected) {</span>
<a href="#l11.105"></a><span id="l11.105">   nsresult rv;</span>
<a href="#l11.106"></a><span id="l11.106">   nsCOMPtr&lt;nsIImportMailboxDescriptor&gt; descriptor;</span>
<a href="#l11.107"></a><span id="l11.107">   rv = CreateMailboxDescriptor(getter_AddRefs(descriptor));</span>
<a href="#l11.108"></a><span id="l11.108">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.109"></a><span id="l11.109"> </span>
<a href="#l11.110"></a><span id="l11.110">   int64_t size;</span>
<a href="#l11.111"></a><span id="l11.111">   rv = aEntry-&gt;GetFileSize(&amp;size);</span>
<a href="#l11.112"></a><span id="l11.112">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineat">@@ -141,21 +127,18 @@ nsBeckyMail::AppendMailboxDescriptor(nsI</span>
<a href="#l11.114"></a><span id="l11.114">   descriptor-&gt;SetDepth(aDepth);</span>
<a href="#l11.115"></a><span id="l11.115"> </span>
<a href="#l11.116"></a><span id="l11.116">   mailboxFile-&gt;InitWithFile(aEntry);</span>
<a href="#l11.117"></a><span id="l11.117">   aCollected-&gt;AppendElement(descriptor);</span>
<a href="#l11.118"></a><span id="l11.118"> </span>
<a href="#l11.119"></a><span id="l11.119">   return NS_OK;</span>
<a href="#l11.120"></a><span id="l11.120"> }</span>
<a href="#l11.121"></a><span id="l11.121"> </span>
<a href="#l11.122"></a><span id="l11.122" class="difflineminus">-nsresult</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineminus">-nsBeckyMail::CollectMailboxesInFolderListFile(nsIFile *aListFile,</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineminus">-                                              uint32_t aDepth,</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineminus">-                                              nsIMutableArray *aCollected)</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineminus">-{</span>
<a href="#l11.127"></a><span id="l11.127" class="difflineplus">+nsresult nsBeckyMail::CollectMailboxesInFolderListFile(</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineplus">+    nsIFile *aListFile, uint32_t aDepth, nsIMutableArray *aCollected) {</span>
<a href="#l11.129"></a><span id="l11.129">   nsresult rv;</span>
<a href="#l11.130"></a><span id="l11.130">   nsCOMPtr&lt;nsILineInputStream&gt; lineStream;</span>
<a href="#l11.131"></a><span id="l11.131">   rv = nsBeckyUtils::CreateLineInputStream(aListFile,</span>
<a href="#l11.132"></a><span id="l11.132">                                            getter_AddRefs(lineStream));</span>
<a href="#l11.133"></a><span id="l11.133">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.134"></a><span id="l11.134"> </span>
<a href="#l11.135"></a><span id="l11.135">   nsCOMPtr&lt;nsIFile&gt; parent;</span>
<a href="#l11.136"></a><span id="l11.136">   rv = aListFile-&gt;GetParent(getter_AddRefs(parent));</span>
<a href="#l11.137"></a><span id="l11.137" class="difflineat">@@ -163,47 +146,45 @@ nsBeckyMail::CollectMailboxesInFolderLis</span>
<a href="#l11.138"></a><span id="l11.138"> </span>
<a href="#l11.139"></a><span id="l11.139">   bool more = true;</span>
<a href="#l11.140"></a><span id="l11.140">   nsAutoCString folderName;</span>
<a href="#l11.141"></a><span id="l11.141">   bool isEmpty = true;</span>
<a href="#l11.142"></a><span id="l11.142">   while (more &amp;&amp; NS_SUCCEEDED(rv)) {</span>
<a href="#l11.143"></a><span id="l11.143">     rv = lineStream-&gt;ReadLine(folderName, &amp;more);</span>
<a href="#l11.144"></a><span id="l11.144">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.145"></a><span id="l11.145"> </span>
<a href="#l11.146"></a><span id="l11.146" class="difflineminus">-    if (folderName.IsEmpty())</span>
<a href="#l11.147"></a><span id="l11.147" class="difflineminus">-      continue;</span>
<a href="#l11.148"></a><span id="l11.148" class="difflineplus">+    if (folderName.IsEmpty()) continue;</span>
<a href="#l11.149"></a><span id="l11.149"> </span>
<a href="#l11.150"></a><span id="l11.150">     nsCOMPtr&lt;nsIFile&gt; folder;</span>
<a href="#l11.151"></a><span id="l11.151">     rv = parent-&gt;Clone(getter_AddRefs(folder));</span>
<a href="#l11.152"></a><span id="l11.152">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.153"></a><span id="l11.153"> </span>
<a href="#l11.154"></a><span id="l11.154">     rv = folder-&gt;AppendNative(folderName);</span>
<a href="#l11.155"></a><span id="l11.155">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.156"></a><span id="l11.156"> </span>
<a href="#l11.157"></a><span id="l11.157">     isEmpty = false;</span>
<a href="#l11.158"></a><span id="l11.158">     rv = CollectMailboxesInDirectory(folder, aDepth + 1, aCollected);</span>
<a href="#l11.159"></a><span id="l11.159">   }</span>
<a href="#l11.160"></a><span id="l11.160"> </span>
<a href="#l11.161"></a><span id="l11.161">   return isEmpty ? NS_ERROR_FILE_NOT_FOUND : NS_OK;</span>
<a href="#l11.162"></a><span id="l11.162"> }</span>
<a href="#l11.163"></a><span id="l11.163"> </span>
<a href="#l11.164"></a><span id="l11.164" class="difflineminus">-nsresult</span>
<a href="#l11.165"></a><span id="l11.165" class="difflineminus">-nsBeckyMail::CollectMailboxesInDirectory(nsIFile *aDirectory,</span>
<a href="#l11.166"></a><span id="l11.166" class="difflineminus">-                                         uint32_t aDepth,</span>
<a href="#l11.167"></a><span id="l11.167" class="difflineminus">-                                         nsIMutableArray *aCollected)</span>
<a href="#l11.168"></a><span id="l11.168" class="difflineminus">-{</span>
<a href="#l11.169"></a><span id="l11.169" class="difflineplus">+nsresult nsBeckyMail::CollectMailboxesInDirectory(nsIFile *aDirectory,</span>
<a href="#l11.170"></a><span id="l11.170" class="difflineplus">+                                                  uint32_t aDepth,</span>
<a href="#l11.171"></a><span id="l11.171" class="difflineplus">+                                                  nsIMutableArray *aCollected) {</span>
<a href="#l11.172"></a><span id="l11.172">   nsAutoString mailboxName;</span>
<a href="#l11.173"></a><span id="l11.173">   nsresult rv = GetMailboxName(aDirectory, mailboxName);</span>
<a href="#l11.174"></a><span id="l11.174">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.175"></a><span id="l11.175"> </span>
<a href="#l11.176"></a><span id="l11.176">   if (aDepth != 0)</span>
<a href="#l11.177"></a><span id="l11.177">     AppendMailboxDescriptor(aDirectory, mailboxName, aDepth, aCollected);</span>
<a href="#l11.178"></a><span id="l11.178"> </span>
<a href="#l11.179"></a><span id="l11.179">   nsCOMPtr&lt;nsIFile&gt; folderListFile;</span>
<a href="#l11.180"></a><span id="l11.180" class="difflineminus">-  rv = nsBeckyUtils::GetFolderListFile(aDirectory, getter_AddRefs(folderListFile));</span>
<a href="#l11.181"></a><span id="l11.181" class="difflineplus">+  rv = nsBeckyUtils::GetFolderListFile(aDirectory,</span>
<a href="#l11.182"></a><span id="l11.182" class="difflineplus">+                                       getter_AddRefs(folderListFile));</span>
<a href="#l11.183"></a><span id="l11.183">   bool folderListExists = false;</span>
<a href="#l11.184"></a><span id="l11.184"> </span>
<a href="#l11.185"></a><span id="l11.185">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l11.186"></a><span id="l11.186">     rv = CollectMailboxesInFolderListFile(folderListFile, aDepth, aCollected);</span>
<a href="#l11.187"></a><span id="l11.187">     folderListExists = true;</span>
<a href="#l11.188"></a><span id="l11.188">   }</span>
<a href="#l11.189"></a><span id="l11.189"> </span>
<a href="#l11.190"></a><span id="l11.190">   nsCOMPtr&lt;nsIDirectoryEnumerator&gt; entries;</span>
<a href="#l11.191"></a><span id="l11.191" class="difflineat">@@ -240,204 +221,176 @@ nsBeckyMail::CollectMailboxesInDirectory</span>
<a href="#l11.192"></a><span id="l11.192">       }</span>
<a href="#l11.193"></a><span id="l11.193">     }</span>
<a href="#l11.194"></a><span id="l11.194">   }</span>
<a href="#l11.195"></a><span id="l11.195"> </span>
<a href="#l11.196"></a><span id="l11.196">   return NS_OK;</span>
<a href="#l11.197"></a><span id="l11.197"> }</span>
<a href="#l11.198"></a><span id="l11.198"> </span>
<a href="#l11.199"></a><span id="l11.199"> NS_IMETHODIMP</span>
<a href="#l11.200"></a><span id="l11.200" class="difflineminus">-nsBeckyMail::FindMailboxes(nsIFile *aLocation, nsIArray **_retval)</span>
<a href="#l11.201"></a><span id="l11.201" class="difflineminus">-{</span>
<a href="#l11.202"></a><span id="l11.202" class="difflineplus">+nsBeckyMail::FindMailboxes(nsIFile *aLocation, nsIArray **_retval) {</span>
<a href="#l11.203"></a><span id="l11.203">   NS_ENSURE_ARG_POINTER(aLocation);</span>
<a href="#l11.204"></a><span id="l11.204">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l11.205"></a><span id="l11.205"> </span>
<a href="#l11.206"></a><span id="l11.206">   nsresult rv;</span>
<a href="#l11.207"></a><span id="l11.207">   nsCOMPtr&lt;nsIMutableArray&gt; array(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l11.208"></a><span id="l11.208">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.209"></a><span id="l11.209"> </span>
<a href="#l11.210"></a><span id="l11.210">   rv = CollectMailboxesInDirectory(aLocation, 0, array);</span>
<a href="#l11.211"></a><span id="l11.211">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.212"></a><span id="l11.212"> </span>
<a href="#l11.213"></a><span id="l11.213">   array.forget(_retval);</span>
<a href="#l11.214"></a><span id="l11.214"> </span>
<a href="#l11.215"></a><span id="l11.215">   return NS_OK;</span>
<a href="#l11.216"></a><span id="l11.216"> }</span>
<a href="#l11.217"></a><span id="l11.217"> </span>
<a href="#l11.218"></a><span id="l11.218" class="difflineminus">-static nsresult</span>
<a href="#l11.219"></a><span id="l11.219" class="difflineminus">-GetBeckyStatusValue(const nsCString &amp;aHeader, nsACString &amp;aValue)</span>
<a href="#l11.220"></a><span id="l11.220" class="difflineminus">-{</span>
<a href="#l11.221"></a><span id="l11.221" class="difflineplus">+static nsresult GetBeckyStatusValue(const nsCString &amp;aHeader,</span>
<a href="#l11.222"></a><span id="l11.222" class="difflineplus">+                                    nsACString &amp;aValue) {</span>
<a href="#l11.223"></a><span id="l11.223">   int32_t valueStartPosition;</span>
<a href="#l11.224"></a><span id="l11.224"> </span>
<a href="#l11.225"></a><span id="l11.225">   valueStartPosition = aHeader.FindChar(':');</span>
<a href="#l11.226"></a><span id="l11.226" class="difflineminus">-  if (valueStartPosition &lt; 0)</span>
<a href="#l11.227"></a><span id="l11.227" class="difflineminus">-    return NS_ERROR_UNEXPECTED;</span>
<a href="#l11.228"></a><span id="l11.228" class="difflineplus">+  if (valueStartPosition &lt; 0) return NS_ERROR_UNEXPECTED;</span>
<a href="#l11.229"></a><span id="l11.229"> </span>
<a href="#l11.230"></a><span id="l11.230">   valueStartPosition++;</span>
<a href="#l11.231"></a><span id="l11.231"> </span>
<a href="#l11.232"></a><span id="l11.232">   int32_t commaPosition = aHeader.FindChar(',', valueStartPosition);</span>
<a href="#l11.233"></a><span id="l11.233" class="difflineminus">-  if (commaPosition &lt; 0)</span>
<a href="#l11.234"></a><span id="l11.234" class="difflineminus">-    return NS_ERROR_UNEXPECTED;</span>
<a href="#l11.235"></a><span id="l11.235" class="difflineplus">+  if (commaPosition &lt; 0) return NS_ERROR_UNEXPECTED;</span>
<a href="#l11.236"></a><span id="l11.236"> </span>
<a href="#l11.237"></a><span id="l11.237" class="difflineminus">-  nsAutoCString value(Substring(aHeader,</span>
<a href="#l11.238"></a><span id="l11.238" class="difflineminus">-                                valueStartPosition,</span>
<a href="#l11.239"></a><span id="l11.239" class="difflineplus">+  nsAutoCString value(Substring(aHeader, valueStartPosition,</span>
<a href="#l11.240"></a><span id="l11.240">                                 commaPosition - valueStartPosition));</span>
<a href="#l11.241"></a><span id="l11.241">   value.Trim(&quot; \t&quot;);</span>
<a href="#l11.242"></a><span id="l11.242"> </span>
<a href="#l11.243"></a><span id="l11.243">   aValue.Assign(value);</span>
<a href="#l11.244"></a><span id="l11.244"> </span>
<a href="#l11.245"></a><span id="l11.245">   return NS_OK;</span>
<a href="#l11.246"></a><span id="l11.246"> }</span>
<a href="#l11.247"></a><span id="l11.247"> </span>
<a href="#l11.248"></a><span id="l11.248" class="difflineminus">-static nsresult</span>
<a href="#l11.249"></a><span id="l11.249" class="difflineminus">-GetBeckyIncludeValue(const nsCString &amp;aHeader, nsACString &amp;aValue)</span>
<a href="#l11.250"></a><span id="l11.250" class="difflineminus">-{</span>
<a href="#l11.251"></a><span id="l11.251" class="difflineplus">+static nsresult GetBeckyIncludeValue(const nsCString &amp;aHeader,</span>
<a href="#l11.252"></a><span id="l11.252" class="difflineplus">+                                     nsACString &amp;aValue) {</span>
<a href="#l11.253"></a><span id="l11.253">   int32_t valueStartPosition;</span>
<a href="#l11.254"></a><span id="l11.254"> </span>
<a href="#l11.255"></a><span id="l11.255">   valueStartPosition = aHeader.FindChar(':');</span>
<a href="#l11.256"></a><span id="l11.256" class="difflineminus">-  if (valueStartPosition &lt; 0)</span>
<a href="#l11.257"></a><span id="l11.257" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l11.258"></a><span id="l11.258" class="difflineplus">+  if (valueStartPosition &lt; 0) return NS_ERROR_FAILURE;</span>
<a href="#l11.259"></a><span id="l11.259"> </span>
<a href="#l11.260"></a><span id="l11.260">   valueStartPosition++;</span>
<a href="#l11.261"></a><span id="l11.261">   nsAutoCString value(Substring(aHeader, valueStartPosition));</span>
<a href="#l11.262"></a><span id="l11.262">   value.Trim(&quot; \t&quot;);</span>
<a href="#l11.263"></a><span id="l11.263"> </span>
<a href="#l11.264"></a><span id="l11.264">   aValue.Assign(value);</span>
<a href="#l11.265"></a><span id="l11.265"> </span>
<a href="#l11.266"></a><span id="l11.266">   return NS_OK;</span>
<a href="#l11.267"></a><span id="l11.267"> }</span>
<a href="#l11.268"></a><span id="l11.268"> </span>
<a href="#l11.269"></a><span id="l11.269" class="difflineminus">-static bool</span>
<a href="#l11.270"></a><span id="l11.270" class="difflineminus">-ConvertBeckyStatusToMozillaStatus(const nsCString &amp;aHeader,</span>
<a href="#l11.271"></a><span id="l11.271" class="difflineminus">-                                  nsMsgMessageFlagType *aMozillaStatusFlag)</span>
<a href="#l11.272"></a><span id="l11.272" class="difflineminus">-{</span>
<a href="#l11.273"></a><span id="l11.273" class="difflineplus">+static bool ConvertBeckyStatusToMozillaStatus(</span>
<a href="#l11.274"></a><span id="l11.274" class="difflineplus">+    const nsCString &amp;aHeader, nsMsgMessageFlagType *aMozillaStatusFlag) {</span>
<a href="#l11.275"></a><span id="l11.275">   nsresult rv;</span>
<a href="#l11.276"></a><span id="l11.276">   nsAutoCString statusString;</span>
<a href="#l11.277"></a><span id="l11.277">   rv = GetBeckyStatusValue(aHeader, statusString);</span>
<a href="#l11.278"></a><span id="l11.278">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l11.279"></a><span id="l11.279"> </span>
<a href="#l11.280"></a><span id="l11.280">   nsresult errorCode;</span>
<a href="#l11.281"></a><span id="l11.281" class="difflineminus">-  uint32_t beckyStatusFlag = static_cast&lt;uint32_t&gt;(statusString.ToInteger(&amp;errorCode, 16));</span>
<a href="#l11.282"></a><span id="l11.282" class="difflineminus">-  if (NS_FAILED(errorCode))</span>
<a href="#l11.283"></a><span id="l11.283" class="difflineminus">-    return false;</span>
<a href="#l11.284"></a><span id="l11.284" class="difflineplus">+  uint32_t beckyStatusFlag =</span>
<a href="#l11.285"></a><span id="l11.285" class="difflineplus">+      static_cast&lt;uint32_t&gt;(statusString.ToInteger(&amp;errorCode, 16));</span>
<a href="#l11.286"></a><span id="l11.286" class="difflineplus">+  if (NS_FAILED(errorCode)) return false;</span>
<a href="#l11.287"></a><span id="l11.287"> </span>
<a href="#l11.288"></a><span id="l11.288">   if (beckyStatusFlag &amp; BECKY_STATUS_READ)</span>
<a href="#l11.289"></a><span id="l11.289">     *aMozillaStatusFlag |= nsMsgMessageFlags::Read;</span>
<a href="#l11.290"></a><span id="l11.290">   if (beckyStatusFlag &amp; BECKY_STATUS_FORWARDED)</span>
<a href="#l11.291"></a><span id="l11.291">     *aMozillaStatusFlag |= nsMsgMessageFlags::Forwarded;</span>
<a href="#l11.292"></a><span id="l11.292">   if (beckyStatusFlag &amp; BECKY_STATUS_REPLIED)</span>
<a href="#l11.293"></a><span id="l11.293">     *aMozillaStatusFlag |= nsMsgMessageFlags::Replied;</span>
<a href="#l11.294"></a><span id="l11.294"> </span>
<a href="#l11.295"></a><span id="l11.295">   return true;</span>
<a href="#l11.296"></a><span id="l11.296"> }</span>
<a href="#l11.297"></a><span id="l11.297"> </span>
<a href="#l11.298"></a><span id="l11.298" class="difflineminus">-static inline bool</span>
<a href="#l11.299"></a><span id="l11.299" class="difflineminus">-CheckHeaderKey(const nsCString &amp;aHeader, const char *aKeyString)</span>
<a href="#l11.300"></a><span id="l11.300" class="difflineminus">-{</span>
<a href="#l11.301"></a><span id="l11.301" class="difflineplus">+static inline bool CheckHeaderKey(const nsCString &amp;aHeader,</span>
<a href="#l11.302"></a><span id="l11.302" class="difflineplus">+                                  const char *aKeyString) {</span>
<a href="#l11.303"></a><span id="l11.303">   nsAutoCString key(StringHead(aHeader, aHeader.FindChar(':')));</span>
<a href="#l11.304"></a><span id="l11.304">   key.Trim(&quot; \t&quot;);</span>
<a href="#l11.305"></a><span id="l11.305">   return key.Equals(aKeyString);</span>
<a href="#l11.306"></a><span id="l11.306"> }</span>
<a href="#l11.307"></a><span id="l11.307"> </span>
<a href="#l11.308"></a><span id="l11.308" class="difflineminus">-static inline bool</span>
<a href="#l11.309"></a><span id="l11.309" class="difflineminus">-IsBeckyStatusHeader(const nsCString &amp;aHeader)</span>
<a href="#l11.310"></a><span id="l11.310" class="difflineminus">-{</span>
<a href="#l11.311"></a><span id="l11.311" class="difflineplus">+static inline bool IsBeckyStatusHeader(const nsCString &amp;aHeader) {</span>
<a href="#l11.312"></a><span id="l11.312">   return CheckHeaderKey(aHeader, X_BECKY_STATUS_HEADER);</span>
<a href="#l11.313"></a><span id="l11.313"> }</span>
<a href="#l11.314"></a><span id="l11.314"> </span>
<a href="#l11.315"></a><span id="l11.315" class="difflineminus">-static inline bool</span>
<a href="#l11.316"></a><span id="l11.316" class="difflineminus">-IsBeckyIncludeLine(const nsCString &amp;aLine)</span>
<a href="#l11.317"></a><span id="l11.317" class="difflineminus">-{</span>
<a href="#l11.318"></a><span id="l11.318" class="difflineplus">+static inline bool IsBeckyIncludeLine(const nsCString &amp;aLine) {</span>
<a href="#l11.319"></a><span id="l11.319">   return CheckHeaderKey(aLine, X_BECKY_INCLUDE_HEADER);</span>
<a href="#l11.320"></a><span id="l11.320"> }</span>
<a href="#l11.321"></a><span id="l11.321"> </span>
<a href="#l11.322"></a><span id="l11.322" class="difflineminus">-static inline bool</span>
<a href="#l11.323"></a><span id="l11.323" class="difflineminus">-IsEndOfHeaders(const nsCString &amp;aLine)</span>
<a href="#l11.324"></a><span id="l11.324" class="difflineminus">-{</span>
<a href="#l11.325"></a><span id="l11.325" class="difflineplus">+static inline bool IsEndOfHeaders(const nsCString &amp;aLine) {</span>
<a href="#l11.326"></a><span id="l11.326">   return aLine.IsEmpty();</span>
<a href="#l11.327"></a><span id="l11.327"> }</span>
<a href="#l11.328"></a><span id="l11.328"> </span>
<a href="#l11.329"></a><span id="l11.329" class="difflineminus">-static inline bool</span>
<a href="#l11.330"></a><span id="l11.330" class="difflineminus">-IsEndOfMessage(const nsCString &amp;aLine)</span>
<a href="#l11.331"></a><span id="l11.331" class="difflineminus">-{</span>
<a href="#l11.332"></a><span id="l11.332" class="difflineplus">+static inline bool IsEndOfMessage(const nsCString &amp;aLine) {</span>
<a href="#l11.333"></a><span id="l11.333">   return aLine.EqualsLiteral(&quot;.&quot;);</span>
<a href="#l11.334"></a><span id="l11.334"> }</span>
<a href="#l11.335"></a><span id="l11.335"> </span>
<a href="#l11.336"></a><span id="l11.336" class="difflineminus">-class ImportMessageRunnable: public mozilla::Runnable</span>
<a href="#l11.337"></a><span id="l11.337" class="difflineminus">-{</span>
<a href="#l11.338"></a><span id="l11.338" class="difflineminus">-public:</span>
<a href="#l11.339"></a><span id="l11.339" class="difflineminus">-  ImportMessageRunnable(nsIFile *aMessageFile,</span>
<a href="#l11.340"></a><span id="l11.340" class="difflineminus">-                        nsIMsgFolder *aFolder);</span>
<a href="#l11.341"></a><span id="l11.341" class="difflineplus">+class ImportMessageRunnable : public mozilla::Runnable {</span>
<a href="#l11.342"></a><span id="l11.342" class="difflineplus">+ public:</span>
<a href="#l11.343"></a><span id="l11.343" class="difflineplus">+  ImportMessageRunnable(nsIFile *aMessageFile, nsIMsgFolder *aFolder);</span>
<a href="#l11.344"></a><span id="l11.344">   NS_DECL_NSIRUNNABLE</span>
<a href="#l11.345"></a><span id="l11.345">   nsresult mResult;</span>
<a href="#l11.346"></a><span id="l11.346"> </span>
<a href="#l11.347"></a><span id="l11.347" class="difflineminus">-private:</span>
<a href="#l11.348"></a><span id="l11.348" class="difflineplus">+ private:</span>
<a href="#l11.349"></a><span id="l11.349">   nsresult WriteHeaders(nsCString &amp;aHeaders, nsIOutputStream *aOutputStream);</span>
<a href="#l11.350"></a><span id="l11.350">   nsresult HandleHeaderLine(const nsCString &amp;aHeaderLine, nsACString &amp;aHeaders);</span>
<a href="#l11.351"></a><span id="l11.351" class="difflineminus">-  nsresult GetAttachmentFile(nsIFile *aMailboxFile,</span>
<a href="#l11.352"></a><span id="l11.352" class="difflineminus">-                             const nsCString &amp;aHeader,</span>
<a href="#l11.353"></a><span id="l11.353" class="difflineplus">+  nsresult GetAttachmentFile(nsIFile *aMailboxFile, const nsCString &amp;aHeader,</span>
<a href="#l11.354"></a><span id="l11.354">                              nsIFile **_retval);</span>
<a href="#l11.355"></a><span id="l11.355" class="difflineminus">-  nsresult WriteAttachmentFile(nsIFile *aMailboxFile,</span>
<a href="#l11.356"></a><span id="l11.356" class="difflineminus">-                               const nsCString &amp;aHeader,</span>
<a href="#l11.357"></a><span id="l11.357" class="difflineplus">+  nsresult WriteAttachmentFile(nsIFile *aMailboxFile, const nsCString &amp;aHeader,</span>
<a href="#l11.358"></a><span id="l11.358">                                nsIOutputStream *aOutputStream);</span>
<a href="#l11.359"></a><span id="l11.359"> </span>
<a href="#l11.360"></a><span id="l11.360">   nsCOMPtr&lt;nsIFile&gt; mMessageFile;</span>
<a href="#l11.361"></a><span id="l11.361">   nsCOMPtr&lt;nsIMsgFolder&gt; mFolder;</span>
<a href="#l11.362"></a><span id="l11.362"> };</span>
<a href="#l11.363"></a><span id="l11.363"> </span>
<a href="#l11.364"></a><span id="l11.364"> ImportMessageRunnable::ImportMessageRunnable(nsIFile *aMessageFile,</span>
<a href="#l11.365"></a><span id="l11.365" class="difflineminus">-                                             nsIMsgFolder *aFolder) :</span>
<a href="#l11.366"></a><span id="l11.366" class="difflineminus">-  mozilla::Runnable(&quot;ImportMessageRunnable&quot;),</span>
<a href="#l11.367"></a><span id="l11.367" class="difflineminus">-  mMessageFile(aMessageFile), mFolder(aFolder)</span>
<a href="#l11.368"></a><span id="l11.368" class="difflineminus">-{</span>
<a href="#l11.369"></a><span id="l11.369" class="difflineminus">-}</span>
<a href="#l11.370"></a><span id="l11.370" class="difflineplus">+                                             nsIMsgFolder *aFolder)</span>
<a href="#l11.371"></a><span id="l11.371" class="difflineplus">+    : mozilla::Runnable(&quot;ImportMessageRunnable&quot;),</span>
<a href="#l11.372"></a><span id="l11.372" class="difflineplus">+      mMessageFile(aMessageFile),</span>
<a href="#l11.373"></a><span id="l11.373" class="difflineplus">+      mFolder(aFolder) {}</span>
<a href="#l11.374"></a><span id="l11.374"> </span>
<a href="#l11.375"></a><span id="l11.375" class="difflineminus">-nsresult</span>
<a href="#l11.376"></a><span id="l11.376" class="difflineminus">-ImportMessageRunnable::WriteHeaders(nsCString &amp;aHeaders,</span>
<a href="#l11.377"></a><span id="l11.377" class="difflineminus">-                                    nsIOutputStream *aOutputStream)</span>
<a href="#l11.378"></a><span id="l11.378" class="difflineminus">-{</span>
<a href="#l11.379"></a><span id="l11.379" class="difflineplus">+nsresult ImportMessageRunnable::WriteHeaders(nsCString &amp;aHeaders,</span>
<a href="#l11.380"></a><span id="l11.380" class="difflineplus">+                                             nsIOutputStream *aOutputStream) {</span>
<a href="#l11.381"></a><span id="l11.381">   nsresult rv;</span>
<a href="#l11.382"></a><span id="l11.382">   uint32_t writtenBytes = 0;</span>
<a href="#l11.383"></a><span id="l11.383"> </span>
<a href="#l11.384"></a><span id="l11.384">   rv = aOutputStream-&gt;Write(FROM_LINE, strlen(FROM_LINE), &amp;writtenBytes);</span>
<a href="#l11.385"></a><span id="l11.385">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.386"></a><span id="l11.386">   rv = aOutputStream-&gt;Write(aHeaders.get(), aHeaders.Length(), &amp;writtenBytes);</span>
<a href="#l11.387"></a><span id="l11.387">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.388"></a><span id="l11.388" class="difflineminus">-  rv = aOutputStream-&gt;Write(MSG_LINEBREAK, strlen(MSG_LINEBREAK), &amp;writtenBytes);</span>
<a href="#l11.389"></a><span id="l11.389" class="difflineplus">+  rv =</span>
<a href="#l11.390"></a><span id="l11.390" class="difflineplus">+      aOutputStream-&gt;Write(MSG_LINEBREAK, strlen(MSG_LINEBREAK), &amp;writtenBytes);</span>
<a href="#l11.391"></a><span id="l11.391">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.392"></a><span id="l11.392">   aHeaders.Truncate();</span>
<a href="#l11.393"></a><span id="l11.393"> </span>
<a href="#l11.394"></a><span id="l11.394">   return NS_OK;</span>
<a href="#l11.395"></a><span id="l11.395"> }</span>
<a href="#l11.396"></a><span id="l11.396"> </span>
<a href="#l11.397"></a><span id="l11.397" class="difflineminus">-nsresult</span>
<a href="#l11.398"></a><span id="l11.398" class="difflineminus">-ImportMessageRunnable::HandleHeaderLine(const nsCString &amp;aHeaderLine,</span>
<a href="#l11.399"></a><span id="l11.399" class="difflineminus">-                                        nsACString &amp;aHeaders)</span>
<a href="#l11.400"></a><span id="l11.400" class="difflineminus">-{</span>
<a href="#l11.401"></a><span id="l11.401" class="difflineplus">+nsresult ImportMessageRunnable::HandleHeaderLine(const nsCString &amp;aHeaderLine,</span>
<a href="#l11.402"></a><span id="l11.402" class="difflineplus">+                                                 nsACString &amp;aHeaders) {</span>
<a href="#l11.403"></a><span id="l11.403">   aHeaders.Append(aHeaderLine);</span>
<a href="#l11.404"></a><span id="l11.404">   aHeaders.AppendLiteral(MSG_LINEBREAK);</span>
<a href="#l11.405"></a><span id="l11.405"> </span>
<a href="#l11.406"></a><span id="l11.406">   nsMsgMessageFlagType flag = 0;</span>
<a href="#l11.407"></a><span id="l11.407">   if (IsBeckyStatusHeader(aHeaderLine) &amp;&amp;</span>
<a href="#l11.408"></a><span id="l11.408">       ConvertBeckyStatusToMozillaStatus(aHeaderLine, &amp;flag)) {</span>
<a href="#l11.409"></a><span id="l11.409">     char *statusLine;</span>
<a href="#l11.410"></a><span id="l11.410">     statusLine = PR_smprintf(X_MOZILLA_STATUS_FORMAT MSG_LINEBREAK, flag);</span>
<a href="#l11.411"></a><span id="l11.411">     aHeaders.Append(statusLine);</span>
<a href="#l11.412"></a><span id="l11.412">     PR_smprintf_free(statusLine);</span>
<a href="#l11.413"></a><span id="l11.413">     aHeaders.AppendLiteral(X_MOZILLA_KEYWORDS);</span>
<a href="#l11.414"></a><span id="l11.414">   }</span>
<a href="#l11.415"></a><span id="l11.415"> </span>
<a href="#l11.416"></a><span id="l11.416">   return NS_OK;</span>
<a href="#l11.417"></a><span id="l11.417"> }</span>
<a href="#l11.418"></a><span id="l11.418"> </span>
<a href="#l11.419"></a><span id="l11.419" class="difflineminus">-nsresult</span>
<a href="#l11.420"></a><span id="l11.420" class="difflineminus">-ImportMessageRunnable::GetAttachmentFile(nsIFile *aMailboxFile,</span>
<a href="#l11.421"></a><span id="l11.421" class="difflineminus">-                                         const nsCString &amp;aHeader,</span>
<a href="#l11.422"></a><span id="l11.422" class="difflineminus">-                                         nsIFile **_retval)</span>
<a href="#l11.423"></a><span id="l11.423" class="difflineminus">-{</span>
<a href="#l11.424"></a><span id="l11.424" class="difflineplus">+nsresult ImportMessageRunnable::GetAttachmentFile(nsIFile *aMailboxFile,</span>
<a href="#l11.425"></a><span id="l11.425" class="difflineplus">+                                                  const nsCString &amp;aHeader,</span>
<a href="#l11.426"></a><span id="l11.426" class="difflineplus">+                                                  nsIFile **_retval) {</span>
<a href="#l11.427"></a><span id="l11.427">   nsresult rv;</span>
<a href="#l11.428"></a><span id="l11.428">   nsCOMPtr&lt;nsIFile&gt; attachmentFile;</span>
<a href="#l11.429"></a><span id="l11.429"> </span>
<a href="#l11.430"></a><span id="l11.430">   rv = aMailboxFile-&gt;Clone(getter_AddRefs(attachmentFile));</span>
<a href="#l11.431"></a><span id="l11.431">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.432"></a><span id="l11.432"> </span>
<a href="#l11.433"></a><span id="l11.433">   rv = attachmentFile-&gt;Append(NS_LITERAL_STRING(&quot;#Attach&quot;));</span>
<a href="#l11.434"></a><span id="l11.434">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.435"></a><span id="l11.435" class="difflineat">@@ -446,152 +399,136 @@ ImportMessageRunnable::GetAttachmentFile</span>
<a href="#l11.436"></a><span id="l11.436">   rv = GetBeckyIncludeValue(aHeader, nativeAttachmentPath);</span>
<a href="#l11.437"></a><span id="l11.437">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.438"></a><span id="l11.438"> </span>
<a href="#l11.439"></a><span id="l11.439">   rv = attachmentFile-&gt;AppendRelativeNativePath(nativeAttachmentPath);</span>
<a href="#l11.440"></a><span id="l11.440">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.441"></a><span id="l11.441"> </span>
<a href="#l11.442"></a><span id="l11.442">   bool exists = false;</span>
<a href="#l11.443"></a><span id="l11.443">   attachmentFile-&gt;Exists(&amp;exists);</span>
<a href="#l11.444"></a><span id="l11.444" class="difflineminus">-  if (!exists)</span>
<a href="#l11.445"></a><span id="l11.445" class="difflineminus">-    return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l11.446"></a><span id="l11.446" class="difflineplus">+  if (!exists) return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l11.447"></a><span id="l11.447"> </span>
<a href="#l11.448"></a><span id="l11.448">   attachmentFile.forget(_retval);</span>
<a href="#l11.449"></a><span id="l11.449">   return NS_OK;</span>
<a href="#l11.450"></a><span id="l11.450"> }</span>
<a href="#l11.451"></a><span id="l11.451"> </span>
<a href="#l11.452"></a><span id="l11.452" class="difflineminus">-nsresult</span>
<a href="#l11.453"></a><span id="l11.453" class="difflineminus">-ImportMessageRunnable::WriteAttachmentFile(nsIFile *aMailboxFile,</span>
<a href="#l11.454"></a><span id="l11.454" class="difflineminus">-                                           const nsCString &amp;aHeader,</span>
<a href="#l11.455"></a><span id="l11.455" class="difflineminus">-                                           nsIOutputStream *aOutputStream)</span>
<a href="#l11.456"></a><span id="l11.456" class="difflineminus">-{</span>
<a href="#l11.457"></a><span id="l11.457" class="difflineplus">+nsresult ImportMessageRunnable::WriteAttachmentFile(</span>
<a href="#l11.458"></a><span id="l11.458" class="difflineplus">+    nsIFile *aMailboxFile, const nsCString &amp;aHeader,</span>
<a href="#l11.459"></a><span id="l11.459" class="difflineplus">+    nsIOutputStream *aOutputStream) {</span>
<a href="#l11.460"></a><span id="l11.460">   nsresult rv;</span>
<a href="#l11.461"></a><span id="l11.461">   nsCOMPtr&lt;nsIFile&gt; parentDirectory;</span>
<a href="#l11.462"></a><span id="l11.462">   rv = aMailboxFile-&gt;GetParent(getter_AddRefs(parentDirectory));</span>
<a href="#l11.463"></a><span id="l11.463">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.464"></a><span id="l11.464"> </span>
<a href="#l11.465"></a><span id="l11.465">   nsCOMPtr&lt;nsIFile&gt; attachmentFile;</span>
<a href="#l11.466"></a><span id="l11.466" class="difflineminus">-  rv = GetAttachmentFile(parentDirectory,</span>
<a href="#l11.467"></a><span id="l11.467" class="difflineminus">-                         aHeader,</span>
<a href="#l11.468"></a><span id="l11.468" class="difflineplus">+  rv = GetAttachmentFile(parentDirectory, aHeader,</span>
<a href="#l11.469"></a><span id="l11.469">                          getter_AddRefs(attachmentFile));</span>
<a href="#l11.470"></a><span id="l11.470">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.471"></a><span id="l11.471"> </span>
<a href="#l11.472"></a><span id="l11.472">   nsCOMPtr&lt;nsIInputStream&gt; inputStream;</span>
<a href="#l11.473"></a><span id="l11.473" class="difflineminus">-  rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream),</span>
<a href="#l11.474"></a><span id="l11.474" class="difflineminus">-                                  attachmentFile);</span>
<a href="#l11.475"></a><span id="l11.475" class="difflineplus">+  rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream), attachmentFile);</span>
<a href="#l11.476"></a><span id="l11.476">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.477"></a><span id="l11.477"> </span>
<a href="#l11.478"></a><span id="l11.478">   char buffer[FILE_IO_BUFFER_SIZE];</span>
<a href="#l11.479"></a><span id="l11.479">   uint32_t readBytes = 0;</span>
<a href="#l11.480"></a><span id="l11.480">   uint32_t writtenBytes = 0;</span>
<a href="#l11.481"></a><span id="l11.481" class="difflineminus">-  rv = aOutputStream-&gt;Write(MSG_LINEBREAK, strlen(MSG_LINEBREAK), &amp;writtenBytes);</span>
<a href="#l11.482"></a><span id="l11.482" class="difflineplus">+  rv =</span>
<a href="#l11.483"></a><span id="l11.483" class="difflineplus">+      aOutputStream-&gt;Write(MSG_LINEBREAK, strlen(MSG_LINEBREAK), &amp;writtenBytes);</span>
<a href="#l11.484"></a><span id="l11.484">   while (NS_SUCCEEDED(inputStream-&gt;Read(buffer, sizeof(buffer), &amp;readBytes)) &amp;&amp;</span>
<a href="#l11.485"></a><span id="l11.485">          readBytes &gt; 0) {</span>
<a href="#l11.486"></a><span id="l11.486">     rv = aOutputStream-&gt;Write(buffer, readBytes, &amp;writtenBytes);</span>
<a href="#l11.487"></a><span id="l11.487" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l11.488"></a><span id="l11.488" class="difflineminus">-      break;</span>
<a href="#l11.489"></a><span id="l11.489" class="difflineplus">+    if (NS_FAILED(rv)) break;</span>
<a href="#l11.490"></a><span id="l11.490">   }</span>
<a href="#l11.491"></a><span id="l11.491"> </span>
<a href="#l11.492"></a><span id="l11.492">   return rv;</span>
<a href="#l11.493"></a><span id="l11.493"> }</span>
<a href="#l11.494"></a><span id="l11.494"> </span>
<a href="#l11.495"></a><span id="l11.495" class="difflineminus">-NS_IMETHODIMP ImportMessageRunnable::Run()</span>
<a href="#l11.496"></a><span id="l11.496" class="difflineminus">-{</span>
<a href="#l11.497"></a><span id="l11.497" class="difflineplus">+NS_IMETHODIMP ImportMessageRunnable::Run() {</span>
<a href="#l11.498"></a><span id="l11.498">   nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l11.499"></a><span id="l11.499">   mResult = mFolder-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l11.500"></a><span id="l11.500">   NS_ENSURE_SUCCESS(mResult, NS_OK);</span>
<a href="#l11.501"></a><span id="l11.501"> </span>
<a href="#l11.502"></a><span id="l11.502">   nsCOMPtr&lt;nsILineInputStream&gt; lineStream;</span>
<a href="#l11.503"></a><span id="l11.503">   mResult = nsBeckyUtils::CreateLineInputStream(mMessageFile,</span>
<a href="#l11.504"></a><span id="l11.504">                                                 getter_AddRefs(lineStream));</span>
<a href="#l11.505"></a><span id="l11.505">   NS_ENSURE_SUCCESS(mResult, NS_OK);</span>
<a href="#l11.506"></a><span id="l11.506"> </span>
<a href="#l11.507"></a><span id="l11.507">   bool reusable;</span>
<a href="#l11.508"></a><span id="l11.508">   nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l11.509"></a><span id="l11.509">   nsCOMPtr&lt;nsIOutputStream&gt; outputStream;</span>
<a href="#l11.510"></a><span id="l11.510" class="difflineminus">-  mResult = msgStore-&gt;GetNewMsgOutputStream(mFolder, getter_AddRefs(msgHdr), &amp;reusable,</span>
<a href="#l11.511"></a><span id="l11.511" class="difflineminus">-                                            getter_AddRefs(outputStream));</span>
<a href="#l11.512"></a><span id="l11.512" class="difflineplus">+  mResult = msgStore-&gt;GetNewMsgOutputStream(</span>
<a href="#l11.513"></a><span id="l11.513" class="difflineplus">+      mFolder, getter_AddRefs(msgHdr), &amp;reusable, getter_AddRefs(outputStream));</span>
<a href="#l11.514"></a><span id="l11.514">   NS_ENSURE_SUCCESS(mResult, NS_OK);</span>
<a href="#l11.515"></a><span id="l11.515"> </span>
<a href="#l11.516"></a><span id="l11.516">   bool inHeader = true;</span>
<a href="#l11.517"></a><span id="l11.517">   bool more = true;</span>
<a href="#l11.518"></a><span id="l11.518">   nsAutoCString headers;</span>
<a href="#l11.519"></a><span id="l11.519">   while (NS_SUCCEEDED(mResult) &amp;&amp; more) {</span>
<a href="#l11.520"></a><span id="l11.520">     nsAutoCString line;</span>
<a href="#l11.521"></a><span id="l11.521">     mResult = lineStream-&gt;ReadLine(line, &amp;more);</span>
<a href="#l11.522"></a><span id="l11.522" class="difflineminus">-    if (NS_FAILED(mResult))</span>
<a href="#l11.523"></a><span id="l11.523" class="difflineminus">-      break;</span>
<a href="#l11.524"></a><span id="l11.524" class="difflineplus">+    if (NS_FAILED(mResult)) break;</span>
<a href="#l11.525"></a><span id="l11.525"> </span>
<a href="#l11.526"></a><span id="l11.526">     if (inHeader) {</span>
<a href="#l11.527"></a><span id="l11.527">       if (IsEndOfHeaders(line)) {</span>
<a href="#l11.528"></a><span id="l11.528">         inHeader = false;</span>
<a href="#l11.529"></a><span id="l11.529">         mResult = WriteHeaders(headers, outputStream);</span>
<a href="#l11.530"></a><span id="l11.530">       } else {</span>
<a href="#l11.531"></a><span id="l11.531">         mResult = HandleHeaderLine(line, headers);</span>
<a href="#l11.532"></a><span id="l11.532">       }</span>
<a href="#l11.533"></a><span id="l11.533">     } else if (IsEndOfMessage(line)) {</span>
<a href="#l11.534"></a><span id="l11.534">       inHeader = true;</span>
<a href="#l11.535"></a><span id="l11.535">       mResult = msgStore-&gt;FinishNewMessage(outputStream, msgHdr);</span>
<a href="#l11.536"></a><span id="l11.536" class="difflineminus">-      if (!reusable)</span>
<a href="#l11.537"></a><span id="l11.537" class="difflineminus">-        outputStream-&gt;Close();</span>
<a href="#l11.538"></a><span id="l11.538" class="difflineminus">-      mResult = msgStore-&gt;GetNewMsgOutputStream(mFolder, getter_AddRefs(msgHdr), &amp;reusable,</span>
<a href="#l11.539"></a><span id="l11.539" class="difflineplus">+      if (!reusable) outputStream-&gt;Close();</span>
<a href="#l11.540"></a><span id="l11.540" class="difflineplus">+      mResult = msgStore-&gt;GetNewMsgOutputStream(mFolder, getter_AddRefs(msgHdr),</span>
<a href="#l11.541"></a><span id="l11.541" class="difflineplus">+                                                &amp;reusable,</span>
<a href="#l11.542"></a><span id="l11.542">                                                 getter_AddRefs(outputStream));</span>
<a href="#l11.543"></a><span id="l11.543">     } else if (IsBeckyIncludeLine(line)) {</span>
<a href="#l11.544"></a><span id="l11.544">       mResult = WriteAttachmentFile(mMessageFile, line, outputStream);</span>
<a href="#l11.545"></a><span id="l11.545">     } else {</span>
<a href="#l11.546"></a><span id="l11.546">       uint32_t writtenBytes = 0;</span>
<a href="#l11.547"></a><span id="l11.547">       if (StringBeginsWith(line, NS_LITERAL_CSTRING(&quot;..&quot;)))</span>
<a href="#l11.548"></a><span id="l11.548">         line.Cut(0, 1);</span>
<a href="#l11.549"></a><span id="l11.549">       else if (CheckHeaderKey(line, &quot;From&quot;))</span>
<a href="#l11.550"></a><span id="l11.550">         line.Insert('&gt;', 0);</span>
<a href="#l11.551"></a><span id="l11.551"> </span>
<a href="#l11.552"></a><span id="l11.552">       line.AppendLiteral(MSG_LINEBREAK);</span>
<a href="#l11.553"></a><span id="l11.553">       mResult = outputStream-&gt;Write(line.get(), line.Length(), &amp;writtenBytes);</span>
<a href="#l11.554"></a><span id="l11.554">     }</span>
<a href="#l11.555"></a><span id="l11.555">   }</span>
<a href="#l11.556"></a><span id="l11.556"> </span>
<a href="#l11.557"></a><span id="l11.557">   if (outputStream) {</span>
<a href="#l11.558"></a><span id="l11.558" class="difflineminus">-    if (NS_FAILED(mResult))</span>
<a href="#l11.559"></a><span id="l11.559" class="difflineminus">-      msgStore-&gt;DiscardNewMessage(outputStream, msgHdr);</span>
<a href="#l11.560"></a><span id="l11.560" class="difflineplus">+    if (NS_FAILED(mResult)) msgStore-&gt;DiscardNewMessage(outputStream, msgHdr);</span>
<a href="#l11.561"></a><span id="l11.561">     outputStream-&gt;Close();</span>
<a href="#l11.562"></a><span id="l11.562">   }</span>
<a href="#l11.563"></a><span id="l11.563"> </span>
<a href="#l11.564"></a><span id="l11.564">   return NS_OK;</span>
<a href="#l11.565"></a><span id="l11.565"> }</span>
<a href="#l11.566"></a><span id="l11.566"> </span>
<a href="#l11.567"></a><span id="l11.567" class="difflineminus">-static</span>
<a href="#l11.568"></a><span id="l11.568" class="difflineminus">-nsresult ProxyImportMessage(nsIFile *aMessageFile,</span>
<a href="#l11.569"></a><span id="l11.569" class="difflineminus">-                            nsIMsgFolder *aFolder)</span>
<a href="#l11.570"></a><span id="l11.570" class="difflineminus">-{</span>
<a href="#l11.571"></a><span id="l11.571" class="difflineplus">+static nsresult ProxyImportMessage(nsIFile *aMessageFile,</span>
<a href="#l11.572"></a><span id="l11.572" class="difflineplus">+                                   nsIMsgFolder *aFolder) {</span>
<a href="#l11.573"></a><span id="l11.573">   RefPtr&lt;ImportMessageRunnable&gt; importMessage =</span>
<a href="#l11.574"></a><span id="l11.574" class="difflineminus">-    new ImportMessageRunnable(aMessageFile, aFolder);</span>
<a href="#l11.575"></a><span id="l11.575" class="difflineplus">+      new ImportMessageRunnable(aMessageFile, aFolder);</span>
<a href="#l11.576"></a><span id="l11.576">   nsresult rv = NS_DispatchToMainThread(importMessage, NS_DISPATCH_SYNC);</span>
<a href="#l11.577"></a><span id="l11.577">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.578"></a><span id="l11.578">   return importMessage-&gt;mResult;</span>
<a href="#l11.579"></a><span id="l11.579"> }</span>
<a href="#l11.580"></a><span id="l11.580"> </span>
<a href="#l11.581"></a><span id="l11.581" class="difflineminus">-nsresult</span>
<a href="#l11.582"></a><span id="l11.582" class="difflineminus">-nsBeckyMail::ImportMailFile(nsIFile *aMailFile,</span>
<a href="#l11.583"></a><span id="l11.583" class="difflineminus">-                            nsIMsgFolder *aDestination)</span>
<a href="#l11.584"></a><span id="l11.584" class="difflineminus">-{</span>
<a href="#l11.585"></a><span id="l11.585" class="difflineplus">+nsresult nsBeckyMail::ImportMailFile(nsIFile *aMailFile,</span>
<a href="#l11.586"></a><span id="l11.586" class="difflineplus">+                                     nsIMsgFolder *aDestination) {</span>
<a href="#l11.587"></a><span id="l11.587">   int64_t size;</span>
<a href="#l11.588"></a><span id="l11.588">   aMailFile-&gt;GetFileSize(&amp;size);</span>
<a href="#l11.589"></a><span id="l11.589" class="difflineminus">-  if (size == 0)</span>
<a href="#l11.590"></a><span id="l11.590" class="difflineminus">-    return NS_OK;</span>
<a href="#l11.591"></a><span id="l11.591" class="difflineplus">+  if (size == 0) return NS_OK;</span>
<a href="#l11.592"></a><span id="l11.592"> </span>
<a href="#l11.593"></a><span id="l11.593">   return ProxyImportMessage(aMailFile, aDestination);</span>
<a href="#l11.594"></a><span id="l11.594"> }</span>
<a href="#l11.595"></a><span id="l11.595"> </span>
<a href="#l11.596"></a><span id="l11.596"> NS_IMETHODIMP</span>
<a href="#l11.597"></a><span id="l11.597"> nsBeckyMail::ImportMailbox(nsIImportMailboxDescriptor *aSource,</span>
<a href="#l11.598"></a><span id="l11.598" class="difflineminus">-                           nsIMsgFolder *aDestination,</span>
<a href="#l11.599"></a><span id="l11.599" class="difflineminus">-                           char16_t **aErrorLog,</span>
<a href="#l11.600"></a><span id="l11.600" class="difflineminus">-                           char16_t **aSuccessLog,</span>
<a href="#l11.601"></a><span id="l11.601" class="difflineminus">-                           bool *aFatalError)</span>
<a href="#l11.602"></a><span id="l11.602" class="difflineminus">-{</span>
<a href="#l11.603"></a><span id="l11.603" class="difflineplus">+                           nsIMsgFolder *aDestination, char16_t **aErrorLog,</span>
<a href="#l11.604"></a><span id="l11.604" class="difflineplus">+                           char16_t **aSuccessLog, bool *aFatalError) {</span>
<a href="#l11.605"></a><span id="l11.605">   NS_ENSURE_ARG_POINTER(aSource);</span>
<a href="#l11.606"></a><span id="l11.606">   NS_ENSURE_ARG_POINTER(aDestination);</span>
<a href="#l11.607"></a><span id="l11.607">   NS_ENSURE_ARG_POINTER(aErrorLog);</span>
<a href="#l11.608"></a><span id="l11.608">   NS_ENSURE_ARG_POINTER(aSuccessLog);</span>
<a href="#l11.609"></a><span id="l11.609">   NS_ENSURE_ARG_POINTER(aFatalError);</span>
<a href="#l11.610"></a><span id="l11.610"> </span>
<a href="#l11.611"></a><span id="l11.611">   mReadBytes = 0;</span>
<a href="#l11.612"></a><span id="l11.612"> </span>
<a href="#l11.613"></a><span id="l11.613" class="difflineat">@@ -606,35 +543,29 @@ nsBeckyMail::ImportMailbox(nsIImportMail</span>
<a href="#l11.614"></a><span id="l11.614">   uint32_t finalSize;</span>
<a href="#l11.615"></a><span id="l11.615">   aSource-&gt;GetSize(&amp;finalSize);</span>
<a href="#l11.616"></a><span id="l11.616">   mReadBytes = finalSize;</span>
<a href="#l11.617"></a><span id="l11.617"> </span>
<a href="#l11.618"></a><span id="l11.618">   nsAutoString name;</span>
<a href="#l11.619"></a><span id="l11.619">   aSource-&gt;GetDisplayName(getter_Copies(name));</span>
<a href="#l11.620"></a><span id="l11.620"> </span>
<a href="#l11.621"></a><span id="l11.621">   nsAutoString successMessage;</span>
<a href="#l11.622"></a><span id="l11.622" class="difflineminus">-  const char16_t *format = { name.get() };</span>
<a href="#l11.623"></a><span id="l11.623" class="difflineminus">-  rv =</span>
<a href="#l11.624"></a><span id="l11.624" class="difflineminus">-      nsBeckyStringBundle::FormatStringFromName(&quot;BeckyImportMailboxSuccess&quot;,</span>
<a href="#l11.625"></a><span id="l11.625" class="difflineminus">-                                                &amp;format,</span>
<a href="#l11.626"></a><span id="l11.626" class="difflineminus">-                                                1,</span>
<a href="#l11.627"></a><span id="l11.627" class="difflineminus">-                                                successMessage);</span>
<a href="#l11.628"></a><span id="l11.628" class="difflineplus">+  const char16_t *format = {name.get()};</span>
<a href="#l11.629"></a><span id="l11.629" class="difflineplus">+  rv = nsBeckyStringBundle::FormatStringFromName(&quot;BeckyImportMailboxSuccess&quot;,</span>
<a href="#l11.630"></a><span id="l11.630" class="difflineplus">+                                                 &amp;format, 1, successMessage);</span>
<a href="#l11.631"></a><span id="l11.631">   successMessage.AppendLiteral(&quot;\n&quot;);</span>
<a href="#l11.632"></a><span id="l11.632">   *aSuccessLog = ToNewUnicode(successMessage);</span>
<a href="#l11.633"></a><span id="l11.633"> </span>
<a href="#l11.634"></a><span id="l11.634">   return rv;</span>
<a href="#l11.635"></a><span id="l11.635"> }</span>
<a href="#l11.636"></a><span id="l11.636"> </span>
<a href="#l11.637"></a><span id="l11.637"> NS_IMETHODIMP</span>
<a href="#l11.638"></a><span id="l11.638" class="difflineminus">-nsBeckyMail::GetImportProgress(uint32_t *_retval)</span>
<a href="#l11.639"></a><span id="l11.639" class="difflineminus">-{</span>
<a href="#l11.640"></a><span id="l11.640" class="difflineplus">+nsBeckyMail::GetImportProgress(uint32_t *_retval) {</span>
<a href="#l11.641"></a><span id="l11.641">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l11.642"></a><span id="l11.642">   *_retval = mReadBytes;</span>
<a href="#l11.643"></a><span id="l11.643">   return NS_OK;</span>
<a href="#l11.644"></a><span id="l11.644"> }</span>
<a href="#l11.645"></a><span id="l11.645"> </span>
<a href="#l11.646"></a><span id="l11.646"> NS_IMETHODIMP</span>
<a href="#l11.647"></a><span id="l11.647" class="difflineminus">-nsBeckyMail::TranslateFolderName(const nsAString &amp; aFolderName,</span>
<a href="#l11.648"></a><span id="l11.648" class="difflineminus">-                                 nsAString &amp; _retval)</span>
<a href="#l11.649"></a><span id="l11.649" class="difflineminus">-{</span>
<a href="#l11.650"></a><span id="l11.650" class="difflineplus">+nsBeckyMail::TranslateFolderName(const nsAString &amp;aFolderName,</span>
<a href="#l11.651"></a><span id="l11.651" class="difflineplus">+                                 nsAString &amp;_retval) {</span>
<a href="#l11.652"></a><span id="l11.652">   return nsBeckyUtils::TranslateFolderName(aFolderName, _retval);</span>
<a href="#l11.653"></a><span id="l11.653"> }</span>
<a href="#l11.654"></a><span id="l11.654" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/import/becky/src/nsBeckyMail.h</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/import/becky/src/nsBeckyMail.h</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -7,39 +7,34 @@</span>
<a href="#l12.4"></a><span id="l12.4"> #define nsBeckyMail_h___</span>
<a href="#l12.5"></a><span id="l12.5"> </span>
<a href="#l12.6"></a><span id="l12.6"> #include &quot;nsIImportMail.h&quot;</span>
<a href="#l12.7"></a><span id="l12.7"> </span>
<a href="#l12.8"></a><span id="l12.8"> class nsIFile;</span>
<a href="#l12.9"></a><span id="l12.9"> class nsIMutableArray;</span>
<a href="#l12.10"></a><span id="l12.10"> class nsIMsgFolder;</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-class nsBeckyMail final : public nsIImportMail</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-{</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">-public:</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+class nsBeckyMail final : public nsIImportMail {</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+ public:</span>
<a href="#l12.17"></a><span id="l12.17">   nsBeckyMail();</span>
<a href="#l12.18"></a><span id="l12.18">   static nsresult Create(nsIImportMail **aImport);</span>
<a href="#l12.19"></a><span id="l12.19"> </span>
<a href="#l12.20"></a><span id="l12.20">   NS_DECL_ISUPPORTS</span>
<a href="#l12.21"></a><span id="l12.21">   NS_DECL_NSIIMPORTMAIL</span>
<a href="#l12.22"></a><span id="l12.22"> </span>
<a href="#l12.23"></a><span id="l12.23" class="difflineminus">-private:</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineplus">+ private:</span>
<a href="#l12.25"></a><span id="l12.25">   virtual ~nsBeckyMail();</span>
<a href="#l12.26"></a><span id="l12.26"> </span>
<a href="#l12.27"></a><span id="l12.27">   uint32_t mReadBytes;</span>
<a href="#l12.28"></a><span id="l12.28"> </span>
<a href="#l12.29"></a><span id="l12.29" class="difflineminus">-  nsresult CollectMailboxesInDirectory(nsIFile *aDirectory,</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineminus">-                                       uint32_t aDepth,</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+  nsresult CollectMailboxesInDirectory(nsIFile *aDirectory, uint32_t aDepth,</span>
<a href="#l12.32"></a><span id="l12.32">                                        nsIMutableArray *aCollected);</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineminus">-  nsresult CollectMailboxesInFolderListFile(nsIFile *aListFile,</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineminus">-                                            uint32_t aDepth,</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+  nsresult CollectMailboxesInFolderListFile(nsIFile *aListFile, uint32_t aDepth,</span>
<a href="#l12.36"></a><span id="l12.36">                                             nsIMutableArray *aCollected);</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineminus">-  nsresult AppendMailboxDescriptor(nsIFile *aEntry,</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineminus">-                                   const nsString &amp;aName,</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+  nsresult AppendMailboxDescriptor(nsIFile *aEntry, const nsString &amp;aName,</span>
<a href="#l12.40"></a><span id="l12.40">                                    uint32_t aDepth,</span>
<a href="#l12.41"></a><span id="l12.41">                                    nsIMutableArray *aCollected);</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineminus">-  nsresult ImportMailFile(nsIFile *aMailFile,</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineminus">-                          nsIMsgFolder *aDestination);</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+  nsresult ImportMailFile(nsIFile *aMailFile, nsIMsgFolder *aDestination);</span>
<a href="#l12.45"></a><span id="l12.45">   nsresult CreateMailboxDescriptor(nsIImportMailboxDescriptor **aDescriptor);</span>
<a href="#l12.46"></a><span id="l12.46">   nsresult GetMailboxName(nsIFile *aMailbox, nsAString &amp;aName);</span>
<a href="#l12.47"></a><span id="l12.47"> };</span>
<a href="#l12.48"></a><span id="l12.48"> </span>
<a href="#l12.49"></a><span id="l12.49"> #endif /* nsBeckyMail_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/import/becky/src/nsBeckySettings.cpp</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/import/becky/src/nsBeckySettings.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -15,96 +15,85 @@</span>
<a href="#l13.4"></a><span id="l13.4"> #include &quot;nsString.h&quot;</span>
<a href="#l13.5"></a><span id="l13.5"> #include &quot;msgCore.h&quot;</span>
<a href="#l13.6"></a><span id="l13.6"> #include &quot;nsBeckySettings.h&quot;</span>
<a href="#l13.7"></a><span id="l13.7"> #include &quot;nsBeckyStringBundle.h&quot;</span>
<a href="#l13.8"></a><span id="l13.8"> #include &quot;nsBeckyUtils.h&quot;</span>
<a href="#l13.9"></a><span id="l13.9"> </span>
<a href="#l13.10"></a><span id="l13.10"> NS_IMPL_ISUPPORTS(nsBeckySettings, nsIImportSettings)</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-nsresult</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-nsBeckySettings::Create(nsIImportSettings **aImport)</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-{</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+nsresult nsBeckySettings::Create(nsIImportSettings **aImport) {</span>
<a href="#l13.16"></a><span id="l13.16">   NS_ENSURE_ARG_POINTER(aImport);</span>
<a href="#l13.17"></a><span id="l13.17">   NS_ADDREF(*aImport = new nsBeckySettings());</span>
<a href="#l13.18"></a><span id="l13.18">   return NS_OK;</span>
<a href="#l13.19"></a><span id="l13.19"> }</span>
<a href="#l13.20"></a><span id="l13.20"> </span>
<a href="#l13.21"></a><span id="l13.21" class="difflineminus">-nsBeckySettings::nsBeckySettings()</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineminus">-{</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineminus">-}</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineplus">+nsBeckySettings::nsBeckySettings() {}</span>
<a href="#l13.25"></a><span id="l13.25"> </span>
<a href="#l13.26"></a><span id="l13.26" class="difflineminus">-nsBeckySettings::~nsBeckySettings()</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineminus">-{</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineminus">-}</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineplus">+nsBeckySettings::~nsBeckySettings() {}</span>
<a href="#l13.30"></a><span id="l13.30"> </span>
<a href="#l13.31"></a><span id="l13.31"> NS_IMETHODIMP</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineminus">-nsBeckySettings::AutoLocate(char16_t **aDescription,</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">-                            nsIFile **aLocation,</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineminus">-                            bool *_retval)</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineminus">-{</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+nsBeckySettings::AutoLocate(char16_t **aDescription, nsIFile **aLocation,</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+                            bool *_retval) {</span>
<a href="#l13.38"></a><span id="l13.38">   NS_ENSURE_ARG_POINTER(aDescription);</span>
<a href="#l13.39"></a><span id="l13.39">   NS_ENSURE_ARG_POINTER(aLocation);</span>
<a href="#l13.40"></a><span id="l13.40">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l13.41"></a><span id="l13.41"> </span>
<a href="#l13.42"></a><span id="l13.42" class="difflineminus">-  *aDescription =</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineminus">-    nsBeckyStringBundle::GetStringByName(&quot;BeckyImportName&quot;);</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineplus">+  *aDescription = nsBeckyStringBundle::GetStringByName(&quot;BeckyImportName&quot;);</span>
<a href="#l13.45"></a><span id="l13.45">   *aLocation = nullptr;</span>
<a href="#l13.46"></a><span id="l13.46">   *_retval = false;</span>
<a href="#l13.47"></a><span id="l13.47"> </span>
<a href="#l13.48"></a><span id="l13.48">   nsCOMPtr&lt;nsIFile&gt; location;</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineminus">-  nsresult rv = nsBeckyUtils::GetDefaultMailboxINIFile(getter_AddRefs(location));</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+  nsresult rv =</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+      nsBeckyUtils::GetDefaultMailboxINIFile(getter_AddRefs(location));</span>
<a href="#l13.52"></a><span id="l13.52">   if (NS_FAILED(rv))</span>
<a href="#l13.53"></a><span id="l13.53">     location = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l13.54"></a><span id="l13.54">   else</span>
<a href="#l13.55"></a><span id="l13.55">     *_retval = true;</span>
<a href="#l13.56"></a><span id="l13.56"> </span>
<a href="#l13.57"></a><span id="l13.57">   location.forget(aLocation);</span>
<a href="#l13.58"></a><span id="l13.58">   return NS_OK;</span>
<a href="#l13.59"></a><span id="l13.59"> }</span>
<a href="#l13.60"></a><span id="l13.60"> </span>
<a href="#l13.61"></a><span id="l13.61"> NS_IMETHODIMP</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineminus">-nsBeckySettings::SetLocation(nsIFile *aLocation)</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineminus">-{</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineplus">+nsBeckySettings::SetLocation(nsIFile *aLocation) {</span>
<a href="#l13.65"></a><span id="l13.65">   mLocation = aLocation;</span>
<a href="#l13.66"></a><span id="l13.66">   return NS_OK;</span>
<a href="#l13.67"></a><span id="l13.67"> }</span>
<a href="#l13.68"></a><span id="l13.68"> </span>
<a href="#l13.69"></a><span id="l13.69" class="difflineminus">-nsresult</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineminus">-nsBeckySettings::CreateParser()</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineminus">-{</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineplus">+nsresult nsBeckySettings::CreateParser() {</span>
<a href="#l13.73"></a><span id="l13.73">   if (!mLocation) {</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineminus">-    nsresult rv = nsBeckyUtils::GetDefaultMailboxINIFile(getter_AddRefs(mLocation));</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineplus">+    nsresult rv =</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineplus">+        nsBeckyUtils::GetDefaultMailboxINIFile(getter_AddRefs(mLocation));</span>
<a href="#l13.77"></a><span id="l13.77">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.78"></a><span id="l13.78">   }</span>
<a href="#l13.79"></a><span id="l13.79"> </span>
<a href="#l13.80"></a><span id="l13.80">   // nsIINIParser accepts only UTF-8 encoding, so we need to convert the file</span>
<a href="#l13.81"></a><span id="l13.81">   // first.</span>
<a href="#l13.82"></a><span id="l13.82">   nsresult rv;</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineminus">-  rv = nsBeckyUtils::ConvertToUTF8File(mLocation, getter_AddRefs(mConvertedFile));</span>
<a href="#l13.84"></a><span id="l13.84" class="difflineplus">+  rv = nsBeckyUtils::ConvertToUTF8File(mLocation,</span>
<a href="#l13.85"></a><span id="l13.85" class="difflineplus">+                                       getter_AddRefs(mConvertedFile));</span>
<a href="#l13.86"></a><span id="l13.86">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.87"></a><span id="l13.87"> </span>
<a href="#l13.88"></a><span id="l13.88">   return nsBeckyUtils::CreateINIParserForFile(mConvertedFile,</span>
<a href="#l13.89"></a><span id="l13.89">                                               getter_AddRefs(mParser));</span>
<a href="#l13.90"></a><span id="l13.90"> }</span>
<a href="#l13.91"></a><span id="l13.91"> </span>
<a href="#l13.92"></a><span id="l13.92" class="difflineminus">-nsresult</span>
<a href="#l13.93"></a><span id="l13.93" class="difflineminus">-nsBeckySettings::CreateSmtpServer(const nsCString &amp;aUserName,</span>
<a href="#l13.94"></a><span id="l13.94" class="difflineminus">-                                  const nsCString &amp;aServerName,</span>
<a href="#l13.95"></a><span id="l13.95" class="difflineminus">-                                  nsISmtpServer **aServer,</span>
<a href="#l13.96"></a><span id="l13.96" class="difflineminus">-                                  bool *existing)</span>
<a href="#l13.97"></a><span id="l13.97" class="difflineminus">-{</span>
<a href="#l13.98"></a><span id="l13.98" class="difflineplus">+nsresult nsBeckySettings::CreateSmtpServer(const nsCString &amp;aUserName,</span>
<a href="#l13.99"></a><span id="l13.99" class="difflineplus">+                                           const nsCString &amp;aServerName,</span>
<a href="#l13.100"></a><span id="l13.100" class="difflineplus">+                                           nsISmtpServer **aServer,</span>
<a href="#l13.101"></a><span id="l13.101" class="difflineplus">+                                           bool *existing) {</span>
<a href="#l13.102"></a><span id="l13.102">   nsresult rv;</span>
<a href="#l13.103"></a><span id="l13.103"> </span>
<a href="#l13.104"></a><span id="l13.104" class="difflineminus">-  nsCOMPtr&lt;nsISmtpService&gt; smtpService = do_GetService(NS_SMTPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l13.105"></a><span id="l13.105" class="difflineplus">+  nsCOMPtr&lt;nsISmtpService&gt; smtpService =</span>
<a href="#l13.106"></a><span id="l13.106" class="difflineplus">+      do_GetService(NS_SMTPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l13.107"></a><span id="l13.107">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.108"></a><span id="l13.108"> </span>
<a href="#l13.109"></a><span id="l13.109">   nsCOMPtr&lt;nsISmtpServer&gt; server;</span>
<a href="#l13.110"></a><span id="l13.110" class="difflineminus">-  rv = smtpService-&gt;FindServer(aUserName.get(),</span>
<a href="#l13.111"></a><span id="l13.111" class="difflineminus">-                               aServerName.get(),</span>
<a href="#l13.112"></a><span id="l13.112" class="difflineplus">+  rv = smtpService-&gt;FindServer(aUserName.get(), aServerName.get(),</span>
<a href="#l13.113"></a><span id="l13.113">                                getter_AddRefs(server));</span>
<a href="#l13.114"></a><span id="l13.114"> </span>
<a href="#l13.115"></a><span id="l13.115">   if (NS_FAILED(rv) || !server) {</span>
<a href="#l13.116"></a><span id="l13.116">     rv = smtpService-&gt;CreateServer(getter_AddRefs(server));</span>
<a href="#l13.117"></a><span id="l13.117">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.118"></a><span id="l13.118"> </span>
<a href="#l13.119"></a><span id="l13.119">     server-&gt;SetHostname(aServerName);</span>
<a href="#l13.120"></a><span id="l13.120">     server-&gt;SetUsername(aUserName);</span>
<a href="#l13.121"></a><span id="l13.121" class="difflineat">@@ -113,258 +102,219 @@ nsBeckySettings::CreateSmtpServer(const </span>
<a href="#l13.122"></a><span id="l13.122">     *existing = true;</span>
<a href="#l13.123"></a><span id="l13.123">   }</span>
<a href="#l13.124"></a><span id="l13.124"> </span>
<a href="#l13.125"></a><span id="l13.125">   server.forget(aServer);</span>
<a href="#l13.126"></a><span id="l13.126"> </span>
<a href="#l13.127"></a><span id="l13.127">   return NS_OK;</span>
<a href="#l13.128"></a><span id="l13.128"> }</span>
<a href="#l13.129"></a><span id="l13.129"> </span>
<a href="#l13.130"></a><span id="l13.130" class="difflineminus">-nsresult</span>
<a href="#l13.131"></a><span id="l13.131" class="difflineminus">-nsBeckySettings::CreateIncomingServer(const nsCString &amp;aUserName,</span>
<a href="#l13.132"></a><span id="l13.132" class="difflineminus">-                                      const nsCString &amp;aServerName,</span>
<a href="#l13.133"></a><span id="l13.133" class="difflineminus">-                                      const nsCString &amp;aProtocol,</span>
<a href="#l13.134"></a><span id="l13.134" class="difflineminus">-                                      nsIMsgIncomingServer **aServer)</span>
<a href="#l13.135"></a><span id="l13.135" class="difflineminus">-{</span>
<a href="#l13.136"></a><span id="l13.136" class="difflineplus">+nsresult nsBeckySettings::CreateIncomingServer(const nsCString &amp;aUserName,</span>
<a href="#l13.137"></a><span id="l13.137" class="difflineplus">+                                               const nsCString &amp;aServerName,</span>
<a href="#l13.138"></a><span id="l13.138" class="difflineplus">+                                               const nsCString &amp;aProtocol,</span>
<a href="#l13.139"></a><span id="l13.139" class="difflineplus">+                                               nsIMsgIncomingServer **aServer) {</span>
<a href="#l13.140"></a><span id="l13.140">   nsresult rv;</span>
<a href="#l13.141"></a><span id="l13.141" class="difflineminus">-  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager = do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l13.142"></a><span id="l13.142" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l13.143"></a><span id="l13.143" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l13.144"></a><span id="l13.144">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.145"></a><span id="l13.145"> </span>
<a href="#l13.146"></a><span id="l13.146">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; incomingServer;</span>
<a href="#l13.147"></a><span id="l13.147" class="difflineminus">-  rv = accountManager-&gt;FindServer(aUserName,</span>
<a href="#l13.148"></a><span id="l13.148" class="difflineminus">-                                  aServerName,</span>
<a href="#l13.149"></a><span id="l13.149" class="difflineminus">-                                  aProtocol,</span>
<a href="#l13.150"></a><span id="l13.150" class="difflineplus">+  rv = accountManager-&gt;FindServer(aUserName, aServerName, aProtocol,</span>
<a href="#l13.151"></a><span id="l13.151">                                   getter_AddRefs(incomingServer));</span>
<a href="#l13.152"></a><span id="l13.152"> </span>
<a href="#l13.153"></a><span id="l13.153">   if (NS_FAILED(rv) || !incomingServer) {</span>
<a href="#l13.154"></a><span id="l13.154" class="difflineminus">-    rv = accountManager-&gt;CreateIncomingServer(aUserName,</span>
<a href="#l13.155"></a><span id="l13.155" class="difflineminus">-                                              aServerName,</span>
<a href="#l13.156"></a><span id="l13.156" class="difflineminus">-                                              aProtocol,</span>
<a href="#l13.157"></a><span id="l13.157" class="difflineplus">+    rv = accountManager-&gt;CreateIncomingServer(aUserName, aServerName, aProtocol,</span>
<a href="#l13.158"></a><span id="l13.158">                                               getter_AddRefs(incomingServer));</span>
<a href="#l13.159"></a><span id="l13.159">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.160"></a><span id="l13.160">   }</span>
<a href="#l13.161"></a><span id="l13.161">   incomingServer.forget(aServer);</span>
<a href="#l13.162"></a><span id="l13.162"> </span>
<a href="#l13.163"></a><span id="l13.163">   return NS_OK;</span>
<a href="#l13.164"></a><span id="l13.164"> }</span>
<a href="#l13.165"></a><span id="l13.165"> </span>
<a href="#l13.166"></a><span id="l13.166" class="difflineminus">-nsresult</span>
<a href="#l13.167"></a><span id="l13.167" class="difflineminus">-nsBeckySettings::SetupSmtpServer(nsISmtpServer **aServer)</span>
<a href="#l13.168"></a><span id="l13.168" class="difflineminus">-{</span>
<a href="#l13.169"></a><span id="l13.169" class="difflineplus">+nsresult nsBeckySettings::SetupSmtpServer(nsISmtpServer **aServer) {</span>
<a href="#l13.170"></a><span id="l13.170">   nsresult rv;</span>
<a href="#l13.171"></a><span id="l13.171">   nsAutoCString userName, serverName;</span>
<a href="#l13.172"></a><span id="l13.172"> </span>
<a href="#l13.173"></a><span id="l13.173">   mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l13.174"></a><span id="l13.174" class="difflineminus">-                     NS_LITERAL_CSTRING(&quot;SMTPServer&quot;),</span>
<a href="#l13.175"></a><span id="l13.175" class="difflineminus">-                     serverName);</span>
<a href="#l13.176"></a><span id="l13.176" class="difflineplus">+                     NS_LITERAL_CSTRING(&quot;SMTPServer&quot;), serverName);</span>
<a href="#l13.177"></a><span id="l13.177">   mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l13.178"></a><span id="l13.178" class="difflineminus">-                     NS_LITERAL_CSTRING(&quot;UserID&quot;),</span>
<a href="#l13.179"></a><span id="l13.179" class="difflineminus">-                     userName);</span>
<a href="#l13.180"></a><span id="l13.180" class="difflineplus">+                     NS_LITERAL_CSTRING(&quot;UserID&quot;), userName);</span>
<a href="#l13.181"></a><span id="l13.181"> </span>
<a href="#l13.182"></a><span id="l13.182">   nsCOMPtr&lt;nsISmtpServer&gt; server;</span>
<a href="#l13.183"></a><span id="l13.183">   bool existing = false;</span>
<a href="#l13.184"></a><span id="l13.184" class="difflineminus">-  rv = CreateSmtpServer(userName, serverName, getter_AddRefs(server), &amp;existing);</span>
<a href="#l13.185"></a><span id="l13.185" class="difflineplus">+  rv =</span>
<a href="#l13.186"></a><span id="l13.186" class="difflineplus">+      CreateSmtpServer(userName, serverName, getter_AddRefs(server), &amp;existing);</span>
<a href="#l13.187"></a><span id="l13.187">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.188"></a><span id="l13.188"> </span>
<a href="#l13.189"></a><span id="l13.189">   // If we already have an existing server, do not touch it's settings.</span>
<a href="#l13.190"></a><span id="l13.190">   if (existing) {</span>
<a href="#l13.191"></a><span id="l13.191">     server.forget(aServer);</span>
<a href="#l13.192"></a><span id="l13.192">     return NS_OK;</span>
<a href="#l13.193"></a><span id="l13.193">   }</span>
<a href="#l13.194"></a><span id="l13.194"> </span>
<a href="#l13.195"></a><span id="l13.195">   nsAutoCString value;</span>
<a href="#l13.196"></a><span id="l13.196">   rv = mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l13.197"></a><span id="l13.197" class="difflineminus">-                          NS_LITERAL_CSTRING(&quot;SMTPPort&quot;),</span>
<a href="#l13.198"></a><span id="l13.198" class="difflineminus">-                          value);</span>
<a href="#l13.199"></a><span id="l13.199" class="difflineplus">+                          NS_LITERAL_CSTRING(&quot;SMTPPort&quot;), value);</span>
<a href="#l13.200"></a><span id="l13.200">   int32_t port = 25;</span>
<a href="#l13.201"></a><span id="l13.201">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l13.202"></a><span id="l13.202">     nsresult errorCode;</span>
<a href="#l13.203"></a><span id="l13.203">     port = value.ToInteger(&amp;errorCode, 10);</span>
<a href="#l13.204"></a><span id="l13.204">   }</span>
<a href="#l13.205"></a><span id="l13.205">   server-&gt;SetPort(port);</span>
<a href="#l13.206"></a><span id="l13.206"> </span>
<a href="#l13.207"></a><span id="l13.207">   mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l13.208"></a><span id="l13.208" class="difflineminus">-                     NS_LITERAL_CSTRING(&quot;SSLSMTP&quot;),</span>
<a href="#l13.209"></a><span id="l13.209" class="difflineminus">-                     value);</span>
<a href="#l13.210"></a><span id="l13.210" class="difflineminus">-  if (value.EqualsLiteral(&quot;1&quot;))</span>
<a href="#l13.211"></a><span id="l13.211" class="difflineminus">-    server-&gt;SetSocketType(nsMsgSocketType::SSL);</span>
<a href="#l13.212"></a><span id="l13.212" class="difflineplus">+                     NS_LITERAL_CSTRING(&quot;SSLSMTP&quot;), value);</span>
<a href="#l13.213"></a><span id="l13.213" class="difflineplus">+  if (value.EqualsLiteral(&quot;1&quot;)) server-&gt;SetSocketType(nsMsgSocketType::SSL);</span>
<a href="#l13.214"></a><span id="l13.214"> </span>
<a href="#l13.215"></a><span id="l13.215">   mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l13.216"></a><span id="l13.216" class="difflineminus">-                     NS_LITERAL_CSTRING(&quot;SMTPAUTH&quot;),</span>
<a href="#l13.217"></a><span id="l13.217" class="difflineminus">-                     value);</span>
<a href="#l13.218"></a><span id="l13.218" class="difflineplus">+                     NS_LITERAL_CSTRING(&quot;SMTPAUTH&quot;), value);</span>
<a href="#l13.219"></a><span id="l13.219">   if (value.EqualsLiteral(&quot;1&quot;)) {</span>
<a href="#l13.220"></a><span id="l13.220">     mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l13.221"></a><span id="l13.221" class="difflineminus">-                       NS_LITERAL_CSTRING(&quot;SMTPAUTHMODE&quot;),</span>
<a href="#l13.222"></a><span id="l13.222" class="difflineminus">-                       value);</span>
<a href="#l13.223"></a><span id="l13.223" class="difflineplus">+                       NS_LITERAL_CSTRING(&quot;SMTPAUTHMODE&quot;), value);</span>
<a href="#l13.224"></a><span id="l13.224">     nsMsgAuthMethodValue authMethod = nsMsgAuthMethod::none;</span>
<a href="#l13.225"></a><span id="l13.225">     if (value.EqualsLiteral(&quot;1&quot;)) {</span>
<a href="#l13.226"></a><span id="l13.226">       authMethod = nsMsgAuthMethod::passwordEncrypted;</span>
<a href="#l13.227"></a><span id="l13.227" class="difflineminus">-    } else if (value.EqualsLiteral(&quot;2&quot;) ||</span>
<a href="#l13.228"></a><span id="l13.228" class="difflineminus">-               value.EqualsLiteral(&quot;4&quot;) ||</span>
<a href="#l13.229"></a><span id="l13.229" class="difflineplus">+    } else if (value.EqualsLiteral(&quot;2&quot;) || value.EqualsLiteral(&quot;4&quot;) ||</span>
<a href="#l13.230"></a><span id="l13.230">                value.EqualsLiteral(&quot;6&quot;)) {</span>
<a href="#l13.231"></a><span id="l13.231">       authMethod = nsMsgAuthMethod::passwordCleartext;</span>
<a href="#l13.232"></a><span id="l13.232">     } else {</span>
<a href="#l13.233"></a><span id="l13.233">       authMethod = nsMsgAuthMethod::anything;</span>
<a href="#l13.234"></a><span id="l13.234">     }</span>
<a href="#l13.235"></a><span id="l13.235">     server-&gt;SetAuthMethod(authMethod);</span>
<a href="#l13.236"></a><span id="l13.236">   }</span>
<a href="#l13.237"></a><span id="l13.237"> </span>
<a href="#l13.238"></a><span id="l13.238">   server.forget(aServer);</span>
<a href="#l13.239"></a><span id="l13.239"> </span>
<a href="#l13.240"></a><span id="l13.240">   return NS_OK;</span>
<a href="#l13.241"></a><span id="l13.241"> }</span>
<a href="#l13.242"></a><span id="l13.242"> </span>
<a href="#l13.243"></a><span id="l13.243" class="difflineminus">-nsresult</span>
<a href="#l13.244"></a><span id="l13.244" class="difflineminus">-nsBeckySettings::SetPop3ServerProperties(nsIMsgIncomingServer *aServer)</span>
<a href="#l13.245"></a><span id="l13.245" class="difflineminus">-{</span>
<a href="#l13.246"></a><span id="l13.246" class="difflineplus">+nsresult nsBeckySettings::SetPop3ServerProperties(</span>
<a href="#l13.247"></a><span id="l13.247" class="difflineplus">+    nsIMsgIncomingServer *aServer) {</span>
<a href="#l13.248"></a><span id="l13.248">   nsCOMPtr&lt;nsIPop3IncomingServer&gt; pop3Server = do_QueryInterface(aServer);</span>
<a href="#l13.249"></a><span id="l13.249"> </span>
<a href="#l13.250"></a><span id="l13.250">   nsAutoCString value;</span>
<a href="#l13.251"></a><span id="l13.251">   mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l13.252"></a><span id="l13.252">                      NS_LITERAL_CSTRING(&quot;POP3Auth&quot;),</span>
<a href="#l13.253"></a><span id="l13.253" class="difflineminus">-                     value); // 0: plain, 1: APOP, 2: CRAM-MD5, 3: NTLM</span>
<a href="#l13.254"></a><span id="l13.254" class="difflineplus">+                     value);  // 0: plain, 1: APOP, 2: CRAM-MD5, 3: NTLM</span>
<a href="#l13.255"></a><span id="l13.255">   nsMsgAuthMethodValue authMethod;</span>
<a href="#l13.256"></a><span id="l13.256">   if (value.IsEmpty() || value.EqualsLiteral(&quot;0&quot;)) {</span>
<a href="#l13.257"></a><span id="l13.257">     authMethod = nsMsgAuthMethod::passwordCleartext;</span>
<a href="#l13.258"></a><span id="l13.258">   } else if (value.EqualsLiteral(&quot;1&quot;)) {</span>
<a href="#l13.259"></a><span id="l13.259">     authMethod = nsMsgAuthMethod::old;</span>
<a href="#l13.260"></a><span id="l13.260">   } else if (value.EqualsLiteral(&quot;2&quot;)) {</span>
<a href="#l13.261"></a><span id="l13.261">     authMethod = nsMsgAuthMethod::passwordEncrypted;</span>
<a href="#l13.262"></a><span id="l13.262">   } else if (value.EqualsLiteral(&quot;3&quot;)) {</span>
<a href="#l13.263"></a><span id="l13.263">     authMethod = nsMsgAuthMethod::NTLM;</span>
<a href="#l13.264"></a><span id="l13.264">   } else {</span>
<a href="#l13.265"></a><span id="l13.265">     authMethod = nsMsgAuthMethod::none;</span>
<a href="#l13.266"></a><span id="l13.266">   }</span>
<a href="#l13.267"></a><span id="l13.267">   aServer-&gt;SetAuthMethod(authMethod);</span>
<a href="#l13.268"></a><span id="l13.268"> </span>
<a href="#l13.269"></a><span id="l13.269">   mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l13.270"></a><span id="l13.270" class="difflineminus">-                     NS_LITERAL_CSTRING(&quot;LeaveServer&quot;),</span>
<a href="#l13.271"></a><span id="l13.271" class="difflineminus">-                     value);</span>
<a href="#l13.272"></a><span id="l13.272" class="difflineplus">+                     NS_LITERAL_CSTRING(&quot;LeaveServer&quot;), value);</span>
<a href="#l13.273"></a><span id="l13.273">   if (value.EqualsLiteral(&quot;1&quot;)) {</span>
<a href="#l13.274"></a><span id="l13.274">     pop3Server-&gt;SetLeaveMessagesOnServer(true);</span>
<a href="#l13.275"></a><span id="l13.275">     nsresult rv = mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l13.276"></a><span id="l13.276" class="difflineminus">-                                     NS_LITERAL_CSTRING(&quot;KeepDays&quot;),</span>
<a href="#l13.277"></a><span id="l13.277" class="difflineminus">-                                     value);</span>
<a href="#l13.278"></a><span id="l13.278" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l13.279"></a><span id="l13.279" class="difflineminus">-      return NS_OK;</span>
<a href="#l13.280"></a><span id="l13.280" class="difflineplus">+                                     NS_LITERAL_CSTRING(&quot;KeepDays&quot;), value);</span>
<a href="#l13.281"></a><span id="l13.281" class="difflineplus">+    if (NS_FAILED(rv)) return NS_OK;</span>
<a href="#l13.282"></a><span id="l13.282"> </span>
<a href="#l13.283"></a><span id="l13.283">     nsresult errorCode;</span>
<a href="#l13.284"></a><span id="l13.284">     int32_t leftDays = value.ToInteger(&amp;errorCode, 10);</span>
<a href="#l13.285"></a><span id="l13.285">     if (NS_SUCCEEDED(errorCode)) {</span>
<a href="#l13.286"></a><span id="l13.286">       pop3Server-&gt;SetNumDaysToLeaveOnServer(leftDays);</span>
<a href="#l13.287"></a><span id="l13.287">       pop3Server-&gt;SetDeleteByAgeFromServer(true);</span>
<a href="#l13.288"></a><span id="l13.288">     }</span>
<a href="#l13.289"></a><span id="l13.289">   }</span>
<a href="#l13.290"></a><span id="l13.290"> </span>
<a href="#l13.291"></a><span id="l13.291">   return NS_OK;</span>
<a href="#l13.292"></a><span id="l13.292"> }</span>
<a href="#l13.293"></a><span id="l13.293"> </span>
<a href="#l13.294"></a><span id="l13.294" class="difflineminus">-nsresult</span>
<a href="#l13.295"></a><span id="l13.295" class="difflineminus">-nsBeckySettings::SetupIncomingServer(nsIMsgIncomingServer **aServer)</span>
<a href="#l13.296"></a><span id="l13.296" class="difflineminus">-{</span>
<a href="#l13.297"></a><span id="l13.297" class="difflineplus">+nsresult nsBeckySettings::SetupIncomingServer(nsIMsgIncomingServer **aServer) {</span>
<a href="#l13.298"></a><span id="l13.298">   nsAutoCString value;</span>
<a href="#l13.299"></a><span id="l13.299">   mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l13.300"></a><span id="l13.300" class="difflineminus">-                     NS_LITERAL_CSTRING(&quot;Protocol&quot;),</span>
<a href="#l13.301"></a><span id="l13.301" class="difflineminus">-                     value);</span>
<a href="#l13.302"></a><span id="l13.302" class="difflineplus">+                     NS_LITERAL_CSTRING(&quot;Protocol&quot;), value);</span>
<a href="#l13.303"></a><span id="l13.303">   nsCString protocol;</span>
<a href="#l13.304"></a><span id="l13.304">   if (value.EqualsLiteral(&quot;1&quot;)) {</span>
<a href="#l13.305"></a><span id="l13.305">     protocol = NS_LITERAL_CSTRING(&quot;imap&quot;);</span>
<a href="#l13.306"></a><span id="l13.306">   } else {</span>
<a href="#l13.307"></a><span id="l13.307">     protocol = NS_LITERAL_CSTRING(&quot;pop3&quot;);</span>
<a href="#l13.308"></a><span id="l13.308">   }</span>
<a href="#l13.309"></a><span id="l13.309"> </span>
<a href="#l13.310"></a><span id="l13.310">   nsAutoCString userName, serverName;</span>
<a href="#l13.311"></a><span id="l13.311">   mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l13.312"></a><span id="l13.312" class="difflineminus">-                     NS_LITERAL_CSTRING(&quot;MailServer&quot;),</span>
<a href="#l13.313"></a><span id="l13.313" class="difflineminus">-                     serverName);</span>
<a href="#l13.314"></a><span id="l13.314" class="difflineplus">+                     NS_LITERAL_CSTRING(&quot;MailServer&quot;), serverName);</span>
<a href="#l13.315"></a><span id="l13.315">   mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l13.316"></a><span id="l13.316" class="difflineminus">-                     NS_LITERAL_CSTRING(&quot;UserID&quot;),</span>
<a href="#l13.317"></a><span id="l13.317" class="difflineminus">-                     userName);</span>
<a href="#l13.318"></a><span id="l13.318" class="difflineplus">+                     NS_LITERAL_CSTRING(&quot;UserID&quot;), userName);</span>
<a href="#l13.319"></a><span id="l13.319"> </span>
<a href="#l13.320"></a><span id="l13.320">   nsresult rv;</span>
<a href="#l13.321"></a><span id="l13.321">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l13.322"></a><span id="l13.322" class="difflineminus">-  rv = CreateIncomingServer(userName, serverName, protocol, getter_AddRefs(server));</span>
<a href="#l13.323"></a><span id="l13.323" class="difflineplus">+  rv = CreateIncomingServer(userName, serverName, protocol,</span>
<a href="#l13.324"></a><span id="l13.324" class="difflineplus">+                            getter_AddRefs(server));</span>
<a href="#l13.325"></a><span id="l13.325">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.326"></a><span id="l13.326"> </span>
<a href="#l13.327"></a><span id="l13.327">   bool isSecure = false;</span>
<a href="#l13.328"></a><span id="l13.328">   int32_t port = 0;</span>
<a href="#l13.329"></a><span id="l13.329">   nsresult errorCode;</span>
<a href="#l13.330"></a><span id="l13.330">   if (protocol.EqualsLiteral(&quot;pop3&quot;)) {</span>
<a href="#l13.331"></a><span id="l13.331">     SetPop3ServerProperties(server);</span>
<a href="#l13.332"></a><span id="l13.332">     rv = mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l13.333"></a><span id="l13.333" class="difflineminus">-                            NS_LITERAL_CSTRING(&quot;POP3Port&quot;),</span>
<a href="#l13.334"></a><span id="l13.334" class="difflineminus">-                            value);</span>
<a href="#l13.335"></a><span id="l13.335" class="difflineplus">+                            NS_LITERAL_CSTRING(&quot;POP3Port&quot;), value);</span>
<a href="#l13.336"></a><span id="l13.336">     if (NS_SUCCEEDED(rv))</span>
<a href="#l13.337"></a><span id="l13.337">       port = value.ToInteger(&amp;errorCode, 10);</span>
<a href="#l13.338"></a><span id="l13.338">     else</span>
<a href="#l13.339"></a><span id="l13.339">       port = 110;</span>
<a href="#l13.340"></a><span id="l13.340">     mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l13.341"></a><span id="l13.341" class="difflineminus">-                       NS_LITERAL_CSTRING(&quot;SSLPOP&quot;),</span>
<a href="#l13.342"></a><span id="l13.342" class="difflineminus">-                       value);</span>
<a href="#l13.343"></a><span id="l13.343" class="difflineminus">-    if (value.EqualsLiteral(&quot;1&quot;))</span>
<a href="#l13.344"></a><span id="l13.344" class="difflineminus">-      isSecure = true;</span>
<a href="#l13.345"></a><span id="l13.345" class="difflineplus">+                       NS_LITERAL_CSTRING(&quot;SSLPOP&quot;), value);</span>
<a href="#l13.346"></a><span id="l13.346" class="difflineplus">+    if (value.EqualsLiteral(&quot;1&quot;)) isSecure = true;</span>
<a href="#l13.347"></a><span id="l13.347">   } else if (protocol.EqualsLiteral(&quot;imap&quot;)) {</span>
<a href="#l13.348"></a><span id="l13.348">     rv = mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l13.349"></a><span id="l13.349" class="difflineminus">-                            NS_LITERAL_CSTRING(&quot;IMAP4Port&quot;),</span>
<a href="#l13.350"></a><span id="l13.350" class="difflineminus">-                            value);</span>
<a href="#l13.351"></a><span id="l13.351" class="difflineplus">+                            NS_LITERAL_CSTRING(&quot;IMAP4Port&quot;), value);</span>
<a href="#l13.352"></a><span id="l13.352">     if (NS_SUCCEEDED(rv))</span>
<a href="#l13.353"></a><span id="l13.353">       port = value.ToInteger(&amp;errorCode, 10);</span>
<a href="#l13.354"></a><span id="l13.354">     else</span>
<a href="#l13.355"></a><span id="l13.355">       port = 143;</span>
<a href="#l13.356"></a><span id="l13.356">     mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l13.357"></a><span id="l13.357" class="difflineminus">-                       NS_LITERAL_CSTRING(&quot;SSLIMAP&quot;),</span>
<a href="#l13.358"></a><span id="l13.358" class="difflineminus">-                       value);</span>
<a href="#l13.359"></a><span id="l13.359" class="difflineminus">-    if (value.EqualsLiteral(&quot;1&quot;))</span>
<a href="#l13.360"></a><span id="l13.360" class="difflineminus">-      isSecure = true;</span>
<a href="#l13.361"></a><span id="l13.361" class="difflineplus">+                       NS_LITERAL_CSTRING(&quot;SSLIMAP&quot;), value);</span>
<a href="#l13.362"></a><span id="l13.362" class="difflineplus">+    if (value.EqualsLiteral(&quot;1&quot;)) isSecure = true;</span>
<a href="#l13.363"></a><span id="l13.363">   }</span>
<a href="#l13.364"></a><span id="l13.364"> </span>
<a href="#l13.365"></a><span id="l13.365">   server-&gt;SetPort(port);</span>
<a href="#l13.366"></a><span id="l13.366" class="difflineminus">-  if (isSecure)</span>
<a href="#l13.367"></a><span id="l13.367" class="difflineminus">-    server-&gt;SetSocketType(nsMsgSocketType::SSL);</span>
<a href="#l13.368"></a><span id="l13.368" class="difflineplus">+  if (isSecure) server-&gt;SetSocketType(nsMsgSocketType::SSL);</span>
<a href="#l13.369"></a><span id="l13.369"> </span>
<a href="#l13.370"></a><span id="l13.370">   mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l13.371"></a><span id="l13.371" class="difflineminus">-                     NS_LITERAL_CSTRING(&quot;CheckInt&quot;),</span>
<a href="#l13.372"></a><span id="l13.372" class="difflineminus">-                     value);</span>
<a href="#l13.373"></a><span id="l13.373" class="difflineminus">-  if (value.EqualsLiteral(&quot;1&quot;))</span>
<a href="#l13.374"></a><span id="l13.374" class="difflineminus">-    server-&gt;SetDoBiff(true);</span>
<a href="#l13.375"></a><span id="l13.375" class="difflineplus">+                     NS_LITERAL_CSTRING(&quot;CheckInt&quot;), value);</span>
<a href="#l13.376"></a><span id="l13.376" class="difflineplus">+  if (value.EqualsLiteral(&quot;1&quot;)) server-&gt;SetDoBiff(true);</span>
<a href="#l13.377"></a><span id="l13.377">   rv = mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l13.378"></a><span id="l13.378" class="difflineminus">-                          NS_LITERAL_CSTRING(&quot;CheckEvery&quot;),</span>
<a href="#l13.379"></a><span id="l13.379" class="difflineminus">-                          value);</span>
<a href="#l13.380"></a><span id="l13.380" class="difflineplus">+                          NS_LITERAL_CSTRING(&quot;CheckEvery&quot;), value);</span>
<a href="#l13.381"></a><span id="l13.381">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l13.382"></a><span id="l13.382">     int32_t minutes = value.ToInteger(&amp;errorCode, 10);</span>
<a href="#l13.383"></a><span id="l13.383" class="difflineminus">-    if (NS_SUCCEEDED(errorCode))</span>
<a href="#l13.384"></a><span id="l13.384" class="difflineminus">-      server-&gt;SetBiffMinutes(minutes);</span>
<a href="#l13.385"></a><span id="l13.385" class="difflineplus">+    if (NS_SUCCEEDED(errorCode)) server-&gt;SetBiffMinutes(minutes);</span>
<a href="#l13.386"></a><span id="l13.386">   }</span>
<a href="#l13.387"></a><span id="l13.387"> </span>
<a href="#l13.388"></a><span id="l13.388">   server.forget(aServer);</span>
<a href="#l13.389"></a><span id="l13.389"> </span>
<a href="#l13.390"></a><span id="l13.390">   return NS_OK;</span>
<a href="#l13.391"></a><span id="l13.391"> }</span>
<a href="#l13.392"></a><span id="l13.392"> </span>
<a href="#l13.393"></a><span id="l13.393" class="difflineminus">-nsresult</span>
<a href="#l13.394"></a><span id="l13.394" class="difflineminus">-nsBeckySettings::CreateIdentity(nsIMsgIdentity **aIdentity)</span>
<a href="#l13.395"></a><span id="l13.395" class="difflineminus">-{</span>
<a href="#l13.396"></a><span id="l13.396" class="difflineplus">+nsresult nsBeckySettings::CreateIdentity(nsIMsgIdentity **aIdentity) {</span>
<a href="#l13.397"></a><span id="l13.397">   nsAutoCString email, fullName, identityName, bccAddress;</span>
<a href="#l13.398"></a><span id="l13.398"> </span>
<a href="#l13.399"></a><span id="l13.399" class="difflineminus">-  mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l13.400"></a><span id="l13.400" class="difflineminus">-                     NS_LITERAL_CSTRING(&quot;Name&quot;),</span>
<a href="#l13.401"></a><span id="l13.401" class="difflineplus">+  mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;), NS_LITERAL_CSTRING(&quot;Name&quot;),</span>
<a href="#l13.402"></a><span id="l13.402">                      identityName);</span>
<a href="#l13.403"></a><span id="l13.403">   mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l13.404"></a><span id="l13.404" class="difflineminus">-                     NS_LITERAL_CSTRING(&quot;YourName&quot;),</span>
<a href="#l13.405"></a><span id="l13.405" class="difflineminus">-                     fullName);</span>
<a href="#l13.406"></a><span id="l13.406" class="difflineplus">+                     NS_LITERAL_CSTRING(&quot;YourName&quot;), fullName);</span>
<a href="#l13.407"></a><span id="l13.407">   mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l13.408"></a><span id="l13.408" class="difflineminus">-                     NS_LITERAL_CSTRING(&quot;MailAddress&quot;),</span>
<a href="#l13.409"></a><span id="l13.409" class="difflineminus">-                     email);</span>
<a href="#l13.410"></a><span id="l13.410" class="difflineplus">+                     NS_LITERAL_CSTRING(&quot;MailAddress&quot;), email);</span>
<a href="#l13.411"></a><span id="l13.411">   mParser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l13.412"></a><span id="l13.412" class="difflineminus">-                     NS_LITERAL_CSTRING(&quot;PermBcc&quot;),</span>
<a href="#l13.413"></a><span id="l13.413" class="difflineminus">-                     bccAddress);</span>
<a href="#l13.414"></a><span id="l13.414" class="difflineplus">+                     NS_LITERAL_CSTRING(&quot;PermBcc&quot;), bccAddress);</span>
<a href="#l13.415"></a><span id="l13.415"> </span>
<a href="#l13.416"></a><span id="l13.416">   nsresult rv;</span>
<a href="#l13.417"></a><span id="l13.417">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l13.418"></a><span id="l13.418" class="difflineminus">-    do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l13.419"></a><span id="l13.419" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l13.420"></a><span id="l13.420">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.421"></a><span id="l13.421"> </span>
<a href="#l13.422"></a><span id="l13.422">   nsCOMPtr&lt;nsIMsgIdentity&gt; identity;</span>
<a href="#l13.423"></a><span id="l13.423">   rv = accountManager-&gt;CreateIdentity(getter_AddRefs(identity));</span>
<a href="#l13.424"></a><span id="l13.424">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.425"></a><span id="l13.425"> </span>
<a href="#l13.426"></a><span id="l13.426">   identity-&gt;SetLabel(NS_ConvertUTF8toUTF16(identityName));</span>
<a href="#l13.427"></a><span id="l13.427">   identity-&gt;SetFullName(NS_ConvertUTF8toUTF16(fullName));</span>
<a href="#l13.428"></a><span id="l13.428" class="difflineat">@@ -374,24 +324,22 @@ nsBeckySettings::CreateIdentity(nsIMsgId</span>
<a href="#l13.429"></a><span id="l13.429">     identity-&gt;SetDoBccList(bccAddress);</span>
<a href="#l13.430"></a><span id="l13.430">   }</span>
<a href="#l13.431"></a><span id="l13.431"> </span>
<a href="#l13.432"></a><span id="l13.432">   identity.forget(aIdentity);</span>
<a href="#l13.433"></a><span id="l13.433"> </span>
<a href="#l13.434"></a><span id="l13.434">   return NS_OK;</span>
<a href="#l13.435"></a><span id="l13.435"> }</span>
<a href="#l13.436"></a><span id="l13.436"> </span>
<a href="#l13.437"></a><span id="l13.437" class="difflineminus">-nsresult</span>
<a href="#l13.438"></a><span id="l13.438" class="difflineminus">-nsBeckySettings::CreateAccount(nsIMsgIdentity *aIdentity,</span>
<a href="#l13.439"></a><span id="l13.439" class="difflineminus">-                               nsIMsgIncomingServer *aIncomingServer,</span>
<a href="#l13.440"></a><span id="l13.440" class="difflineminus">-                               nsIMsgAccount **aAccount)</span>
<a href="#l13.441"></a><span id="l13.441" class="difflineminus">-{</span>
<a href="#l13.442"></a><span id="l13.442" class="difflineplus">+nsresult nsBeckySettings::CreateAccount(nsIMsgIdentity *aIdentity,</span>
<a href="#l13.443"></a><span id="l13.443" class="difflineplus">+                                        nsIMsgIncomingServer *aIncomingServer,</span>
<a href="#l13.444"></a><span id="l13.444" class="difflineplus">+                                        nsIMsgAccount **aAccount) {</span>
<a href="#l13.445"></a><span id="l13.445">   nsresult rv;</span>
<a href="#l13.446"></a><span id="l13.446">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l13.447"></a><span id="l13.447" class="difflineminus">-    do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l13.448"></a><span id="l13.448" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l13.449"></a><span id="l13.449">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.450"></a><span id="l13.450"> </span>
<a href="#l13.451"></a><span id="l13.451">   nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l13.452"></a><span id="l13.452">   rv = accountManager-&gt;CreateAccount(getter_AddRefs(account));</span>
<a href="#l13.453"></a><span id="l13.453">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.454"></a><span id="l13.454"> </span>
<a href="#l13.455"></a><span id="l13.455">   rv = account-&gt;AddIdentity(aIdentity);</span>
<a href="#l13.456"></a><span id="l13.456">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.457"></a><span id="l13.457" class="difflineat">@@ -399,39 +347,34 @@ nsBeckySettings::CreateAccount(nsIMsgIde</span>
<a href="#l13.458"></a><span id="l13.458">   rv = account-&gt;SetIncomingServer(aIncomingServer);</span>
<a href="#l13.459"></a><span id="l13.459">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.460"></a><span id="l13.460"> </span>
<a href="#l13.461"></a><span id="l13.461">   account.forget(aAccount);</span>
<a href="#l13.462"></a><span id="l13.462"> </span>
<a href="#l13.463"></a><span id="l13.463">   return NS_OK;</span>
<a href="#l13.464"></a><span id="l13.464"> }</span>
<a href="#l13.465"></a><span id="l13.465"> </span>
<a href="#l13.466"></a><span id="l13.466" class="difflineminus">-nsresult</span>
<a href="#l13.467"></a><span id="l13.467" class="difflineminus">-nsBeckySettings::RemoveConvertedFile()</span>
<a href="#l13.468"></a><span id="l13.468" class="difflineminus">-{</span>
<a href="#l13.469"></a><span id="l13.469" class="difflineplus">+nsresult nsBeckySettings::RemoveConvertedFile() {</span>
<a href="#l13.470"></a><span id="l13.470">   if (mConvertedFile) {</span>
<a href="#l13.471"></a><span id="l13.471">     bool exists;</span>
<a href="#l13.472"></a><span id="l13.472">     mConvertedFile-&gt;Exists(&amp;exists);</span>
<a href="#l13.473"></a><span id="l13.473" class="difflineminus">-    if (exists)</span>
<a href="#l13.474"></a><span id="l13.474" class="difflineminus">-      mConvertedFile-&gt;Remove(false);</span>
<a href="#l13.475"></a><span id="l13.475" class="difflineplus">+    if (exists) mConvertedFile-&gt;Remove(false);</span>
<a href="#l13.476"></a><span id="l13.476">     mConvertedFile = nullptr;</span>
<a href="#l13.477"></a><span id="l13.477">   }</span>
<a href="#l13.478"></a><span id="l13.478">   return NS_OK;</span>
<a href="#l13.479"></a><span id="l13.479"> }</span>
<a href="#l13.480"></a><span id="l13.480"> </span>
<a href="#l13.481"></a><span id="l13.481"> #define NS_RETURN_IF_FAILED_WITH_REMOVE_CONVERTED_FILE(expr, rv) \</span>
<a href="#l13.482"></a><span id="l13.482">   if (NS_FAILED(expr)) {                                         \</span>
<a href="#l13.483"></a><span id="l13.483">     RemoveConvertedFile();                                       \</span>
<a href="#l13.484"></a><span id="l13.484">     return rv;                                                   \</span>
<a href="#l13.485"></a><span id="l13.485">   }</span>
<a href="#l13.486"></a><span id="l13.486"> </span>
<a href="#l13.487"></a><span id="l13.487"> NS_IMETHODIMP</span>
<a href="#l13.488"></a><span id="l13.488" class="difflineminus">-nsBeckySettings::Import(nsIMsgAccount **aLocalMailAccount,</span>
<a href="#l13.489"></a><span id="l13.489" class="difflineminus">-                        bool *_retval)</span>
<a href="#l13.490"></a><span id="l13.490" class="difflineminus">-{</span>
<a href="#l13.491"></a><span id="l13.491" class="difflineplus">+nsBeckySettings::Import(nsIMsgAccount **aLocalMailAccount, bool *_retval) {</span>
<a href="#l13.492"></a><span id="l13.492">   NS_ENSURE_ARG_POINTER(aLocalMailAccount);</span>
<a href="#l13.493"></a><span id="l13.493">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l13.494"></a><span id="l13.494"> </span>
<a href="#l13.495"></a><span id="l13.495">   nsresult rv = CreateParser();</span>
<a href="#l13.496"></a><span id="l13.496">   NS_RETURN_IF_FAILED_WITH_REMOVE_CONVERTED_FILE(rv, rv);</span>
<a href="#l13.497"></a><span id="l13.497"> </span>
<a href="#l13.498"></a><span id="l13.498">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; incomingServer;</span>
<a href="#l13.499"></a><span id="l13.499">   rv = SetupIncomingServer(getter_AddRefs(incomingServer));</span>
<a href="#l13.500"></a><span id="l13.500" class="difflineat">@@ -449,14 +392,12 @@ nsBeckySettings::Import(nsIMsgAccount **</span>
<a href="#l13.501"></a><span id="l13.501">   smtpServer-&gt;GetKey(getter_Copies(smtpKey));</span>
<a href="#l13.502"></a><span id="l13.502">   identity-&gt;SetSmtpServerKey(smtpKey);</span>
<a href="#l13.503"></a><span id="l13.503"> </span>
<a href="#l13.504"></a><span id="l13.504">   nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l13.505"></a><span id="l13.505">   rv = CreateAccount(identity, incomingServer, getter_AddRefs(account));</span>
<a href="#l13.506"></a><span id="l13.506">   NS_RETURN_IF_FAILED_WITH_REMOVE_CONVERTED_FILE(rv, rv);</span>
<a href="#l13.507"></a><span id="l13.507"> </span>
<a href="#l13.508"></a><span id="l13.508">   RemoveConvertedFile();</span>
<a href="#l13.509"></a><span id="l13.509" class="difflineminus">-  if (aLocalMailAccount)</span>
<a href="#l13.510"></a><span id="l13.510" class="difflineminus">-    account.forget(aLocalMailAccount);</span>
<a href="#l13.511"></a><span id="l13.511" class="difflineplus">+  if (aLocalMailAccount) account.forget(aLocalMailAccount);</span>
<a href="#l13.512"></a><span id="l13.512">   *_retval = true;</span>
<a href="#l13.513"></a><span id="l13.513">   return NS_OK;</span>
<a href="#l13.514"></a><span id="l13.514"> }</span>
<a href="#l13.515"></a><span id="l13.515" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/import/becky/src/nsBeckySettings.h</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/import/becky/src/nsBeckySettings.h</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -9,41 +9,39 @@</span>
<a href="#l14.4"></a><span id="l14.4"> #include &quot;nsIImportSettings.h&quot;</span>
<a href="#l14.5"></a><span id="l14.5"> #include &quot;nsIFile.h&quot;</span>
<a href="#l14.6"></a><span id="l14.6"> #include &quot;nsIINIParser.h&quot;</span>
<a href="#l14.7"></a><span id="l14.7"> </span>
<a href="#l14.8"></a><span id="l14.8"> class nsIMsgIncomingServer;</span>
<a href="#l14.9"></a><span id="l14.9"> class nsIMsgIdentity;</span>
<a href="#l14.10"></a><span id="l14.10"> class nsISmtpServer;</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-class nsBeckySettings final : public nsIImportSettings</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-{</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineminus">-public:</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+class nsBeckySettings final : public nsIImportSettings {</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+ public:</span>
<a href="#l14.17"></a><span id="l14.17">   nsBeckySettings();</span>
<a href="#l14.18"></a><span id="l14.18">   static nsresult Create(nsIImportSettings **aImport);</span>
<a href="#l14.19"></a><span id="l14.19"> </span>
<a href="#l14.20"></a><span id="l14.20">   NS_DECL_ISUPPORTS</span>
<a href="#l14.21"></a><span id="l14.21">   NS_DECL_NSIIMPORTSETTINGS</span>
<a href="#l14.22"></a><span id="l14.22"> </span>
<a href="#l14.23"></a><span id="l14.23" class="difflineminus">-private:</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineplus">+ private:</span>
<a href="#l14.25"></a><span id="l14.25">   virtual ~nsBeckySettings();</span>
<a href="#l14.26"></a><span id="l14.26"> </span>
<a href="#l14.27"></a><span id="l14.27">   nsCOMPtr&lt;nsIFile&gt; mLocation;</span>
<a href="#l14.28"></a><span id="l14.28">   nsCOMPtr&lt;nsIFile&gt; mConvertedFile;</span>
<a href="#l14.29"></a><span id="l14.29">   nsCOMPtr&lt;nsIINIParser&gt; mParser;</span>
<a href="#l14.30"></a><span id="l14.30"> </span>
<a href="#l14.31"></a><span id="l14.31">   nsresult CreateParser();</span>
<a href="#l14.32"></a><span id="l14.32">   nsresult CreateIdentity(nsIMsgIdentity **aIdentity);</span>
<a href="#l14.33"></a><span id="l14.33">   nsresult CreateAccount(nsIMsgIdentity *aIdentity,</span>
<a href="#l14.34"></a><span id="l14.34">                          nsIMsgIncomingServer *aIncomingServer,</span>
<a href="#l14.35"></a><span id="l14.35">                          nsIMsgAccount **aAccount);</span>
<a href="#l14.36"></a><span id="l14.36">   nsresult CreateSmtpServer(const nsCString &amp;aUserName,</span>
<a href="#l14.37"></a><span id="l14.37">                             const nsCString &amp;aServerName,</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineminus">-                            nsISmtpServer **aServer,</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineminus">-                            bool *existing);</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineplus">+                            nsISmtpServer **aServer, bool *existing);</span>
<a href="#l14.41"></a><span id="l14.41">   nsresult CreateIncomingServer(const nsCString &amp;aUserName,</span>
<a href="#l14.42"></a><span id="l14.42">                                 const nsCString &amp;aServerName,</span>
<a href="#l14.43"></a><span id="l14.43">                                 const nsCString &amp;aProtocol,</span>
<a href="#l14.44"></a><span id="l14.44">                                 nsIMsgIncomingServer **aServer);</span>
<a href="#l14.45"></a><span id="l14.45">   nsresult SetupIncomingServer(nsIMsgIncomingServer **aServer);</span>
<a href="#l14.46"></a><span id="l14.46">   nsresult SetupSmtpServer(nsISmtpServer **aServer);</span>
<a href="#l14.47"></a><span id="l14.47">   nsresult SetPop3ServerProperties(nsIMsgIncomingServer *aServer);</span>
<a href="#l14.48"></a><span id="l14.48">   nsresult RemoveConvertedFile();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/import/becky/src/nsBeckyStringBundle.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/import/becky/src/nsBeckyStringBundle.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -7,64 +7,50 @@</span>
<a href="#l15.4"></a><span id="l15.4"> #include &quot;prmem.h&quot;</span>
<a href="#l15.5"></a><span id="l15.5"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l15.6"></a><span id="l15.6"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l15.7"></a><span id="l15.7"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l15.8"></a><span id="l15.8"> #include &quot;nsXPCOMCIDInternal.h&quot;</span>
<a href="#l15.9"></a><span id="l15.9"> </span>
<a href="#l15.10"></a><span id="l15.10"> #include &quot;nsBeckyStringBundle.h&quot;</span>
<a href="#l15.11"></a><span id="l15.11"> </span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-#define BECKY_MESSAGES_URL &quot;chrome://messenger/locale/beckyImportMsgs.properties&quot;</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+#define BECKY_MESSAGES_URL \</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+  &quot;chrome://messenger/locale/beckyImportMsgs.properties&quot;</span>
<a href="#l15.15"></a><span id="l15.15"> </span>
<a href="#l15.16"></a><span id="l15.16"> nsCOMPtr&lt;nsIStringBundle&gt; nsBeckyStringBundle::mBundle = nullptr;</span>
<a href="#l15.17"></a><span id="l15.17"> </span>
<a href="#l15.18"></a><span id="l15.18" class="difflineminus">-void</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineminus">-nsBeckyStringBundle::GetStringBundle(void)</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineminus">-{</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineminus">-  if (mBundle)</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineminus">-    return;</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineplus">+void nsBeckyStringBundle::GetStringBundle(void) {</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineplus">+  if (mBundle) return;</span>
<a href="#l15.25"></a><span id="l15.25"> </span>
<a href="#l15.26"></a><span id="l15.26">   nsresult rv;</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineminus">-  nsCOMPtr&lt;nsIStringBundleService&gt; bundleService = do_GetService(NS_STRINGBUNDLE_CONTRACTID, &amp;rv);</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineplus">+  nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineplus">+      do_GetService(NS_STRINGBUNDLE_CONTRACTID, &amp;rv);</span>
<a href="#l15.30"></a><span id="l15.30">   if (NS_SUCCEEDED(rv) &amp;&amp; bundleService)</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineminus">-    rv = bundleService-&gt;CreateBundle(BECKY_MESSAGES_URL, getter_AddRefs(mBundle));</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+    rv = bundleService-&gt;CreateBundle(BECKY_MESSAGES_URL,</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+                                     getter_AddRefs(mBundle));</span>
<a href="#l15.34"></a><span id="l15.34"> }</span>
<a href="#l15.35"></a><span id="l15.35"> </span>
<a href="#l15.36"></a><span id="l15.36" class="difflineminus">-void</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineminus">-nsBeckyStringBundle::EnsureStringBundle(void)</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineminus">-{</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineminus">-  if (!mBundle)</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineminus">-    GetStringBundle();</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineplus">+void nsBeckyStringBundle::EnsureStringBundle(void) {</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineplus">+  if (!mBundle) GetStringBundle();</span>
<a href="#l15.43"></a><span id="l15.43"> }</span>
<a href="#l15.44"></a><span id="l15.44"> </span>
<a href="#l15.45"></a><span id="l15.45" class="difflineminus">-char16_t *</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineminus">-nsBeckyStringBundle::GetStringByName(const char *aName)</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineminus">-{</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineplus">+char16_t *nsBeckyStringBundle::GetStringByName(const char *aName) {</span>
<a href="#l15.49"></a><span id="l15.49">   EnsureStringBundle();</span>
<a href="#l15.50"></a><span id="l15.50"> </span>
<a href="#l15.51"></a><span id="l15.51">   if (mBundle) {</span>
<a href="#l15.52"></a><span id="l15.52">     nsAutoString string;</span>
<a href="#l15.53"></a><span id="l15.53">     mBundle-&gt;GetStringFromName(aName, string);</span>
<a href="#l15.54"></a><span id="l15.54">     return ToNewUnicode(string);</span>
<a href="#l15.55"></a><span id="l15.55">   }</span>
<a href="#l15.56"></a><span id="l15.56"> </span>
<a href="#l15.57"></a><span id="l15.57">   return nullptr;</span>
<a href="#l15.58"></a><span id="l15.58"> }</span>
<a href="#l15.59"></a><span id="l15.59"> </span>
<a href="#l15.60"></a><span id="l15.60" class="difflineminus">-nsresult</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineminus">-nsBeckyStringBundle::FormatStringFromName(const char *name,</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineminus">-                                          const char16_t **params,</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineminus">-                                          uint32_t length,</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineminus">-                                          nsAString&amp; _retval)</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineminus">-{</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineplus">+nsresult nsBeckyStringBundle::FormatStringFromName(const char *name,</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineplus">+                                                   const char16_t **params,</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineplus">+                                                   uint32_t length,</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineplus">+                                                   nsAString &amp;_retval) {</span>
<a href="#l15.70"></a><span id="l15.70">   EnsureStringBundle();</span>
<a href="#l15.71"></a><span id="l15.71"> </span>
<a href="#l15.72"></a><span id="l15.72" class="difflineminus">-  return mBundle-&gt;FormatStringFromName(name,</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineminus">-                                       params,</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineminus">-                                       length,</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineminus">-                                       _retval);</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineplus">+  return mBundle-&gt;FormatStringFromName(name, params, length, _retval);</span>
<a href="#l15.77"></a><span id="l15.77"> }</span>
<a href="#l15.78"></a><span id="l15.78"> </span>
<a href="#l15.79"></a><span id="l15.79" class="difflineminus">-void</span>
<a href="#l15.80"></a><span id="l15.80" class="difflineminus">-nsBeckyStringBundle::Cleanup(void)</span>
<a href="#l15.81"></a><span id="l15.81" class="difflineminus">-{</span>
<a href="#l15.82"></a><span id="l15.82" class="difflineminus">-  mBundle = nullptr;</span>
<a href="#l15.83"></a><span id="l15.83" class="difflineminus">-}</span>
<a href="#l15.84"></a><span id="l15.84" class="difflineplus">+void nsBeckyStringBundle::Cleanup(void) { mBundle = nullptr; }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/import/becky/src/nsBeckyStringBundle.h</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/import/becky/src/nsBeckyStringBundle.h</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -4,30 +4,29 @@</span>
<a href="#l16.4"></a><span id="l16.4"> #ifndef _nsBeckyStringBundle_H__</span>
<a href="#l16.5"></a><span id="l16.5"> #define _nsBeckyStringBundle_H__</span>
<a href="#l16.6"></a><span id="l16.6"> </span>
<a href="#l16.7"></a><span id="l16.7"> #include &quot;nsString.h&quot;</span>
<a href="#l16.8"></a><span id="l16.8"> </span>
<a href="#l16.9"></a><span id="l16.9"> class nsIStringBundle;</span>
<a href="#l16.10"></a><span id="l16.10"> </span>
<a href="#l16.11"></a><span id="l16.11"> class nsBeckyStringBundle final {</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-public:</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+ public:</span>
<a href="#l16.14"></a><span id="l16.14">   static char16_t *GetStringByName(const char *name);</span>
<a href="#l16.15"></a><span id="l16.15">   static nsresult FormatStringFromName(const char *name,</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineminus">-                                       const char16_t **params,</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineminus">-                                       uint32_t length,</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineminus">-                                       nsAString&amp; _retval);</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineplus">+                                       const char16_t **params, uint32_t length,</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineplus">+                                       nsAString &amp;_retval);</span>
<a href="#l16.21"></a><span id="l16.21">   static void GetStringBundle(void);</span>
<a href="#l16.22"></a><span id="l16.22">   static void EnsureStringBundle(void);</span>
<a href="#l16.23"></a><span id="l16.23">   static void Cleanup(void);</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineminus">-private:</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineplus">+</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineplus">+ private:</span>
<a href="#l16.27"></a><span id="l16.27">   static nsCOMPtr&lt;nsIStringBundle&gt; mBundle;</span>
<a href="#l16.28"></a><span id="l16.28"> };</span>
<a href="#l16.29"></a><span id="l16.29"> </span>
<a href="#l16.30"></a><span id="l16.30" class="difflineminus">-#define BECKYIMPORT_NAME                     2000</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineminus">-#define BECKYIMPORT_DESCRIPTION              2001</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineminus">-#define BECKYIMPORT_MAILBOX_SUCCESS          2002</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineminus">-#define BECKYIMPORT_MAILBOX_BADPARAM         2003</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineminus">-#define BECKYIMPORT_MAILBOX_CONVERTERROR     2004</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineminus">-#define BECKYIMPORT_ADDRESS_SUCCESS          2005</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineminus">-</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineplus">+#define BECKYIMPORT_NAME 2000</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineplus">+#define BECKYIMPORT_DESCRIPTION 2001</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineplus">+#define BECKYIMPORT_MAILBOX_SUCCESS 2002</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineplus">+#define BECKYIMPORT_MAILBOX_BADPARAM 2003</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineplus">+#define BECKYIMPORT_MAILBOX_CONVERTERROR 2004</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineplus">+#define BECKYIMPORT_ADDRESS_SUCCESS 2005</span>
<a href="#l16.43"></a><span id="l16.43"> </span>
<a href="#l16.44"></a><span id="l16.44"> #endif /* _nsBeckyStringBundle_H__ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/import/becky/src/nsBeckyUtils.cpp</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/import/becky/src/nsBeckyUtils.cpp</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -24,67 +24,60 @@</span>
<a href="#l17.4"></a><span id="l17.4"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l17.5"></a><span id="l17.5"> #include &quot;msgCore.h&quot;</span>
<a href="#l17.6"></a><span id="l17.6"> #include &quot;nsIImportMail.h&quot;</span>
<a href="#l17.7"></a><span id="l17.7"> #include &quot;nsThreadUtils.h&quot;</span>
<a href="#l17.8"></a><span id="l17.8"> </span>
<a href="#l17.9"></a><span id="l17.9"> #include &quot;nsBeckyUtils.h&quot;</span>
<a href="#l17.10"></a><span id="l17.10"> #include &quot;SpecialSystemDirectory.h&quot;</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-nsresult</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-nsBeckyUtils::FindUserDirectoryOnWindows7(nsIFile **aLocation)</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">-{</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+nsresult nsBeckyUtils::FindUserDirectoryOnWindows7(nsIFile **aLocation) {</span>
<a href="#l17.16"></a><span id="l17.16">   NS_ENSURE_ARG_POINTER(aLocation);</span>
<a href="#l17.17"></a><span id="l17.17"> </span>
<a href="#l17.18"></a><span id="l17.18">   nsresult rv;</span>
<a href="#l17.19"></a><span id="l17.19">   nsCOMPtr&lt;nsIFile&gt; directory;</span>
<a href="#l17.20"></a><span id="l17.20">   rv = GetSpecialSystemDirectory(Win_Documents, getter_AddRefs(directory));</span>
<a href="#l17.21"></a><span id="l17.21">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.22"></a><span id="l17.22">   rv = directory-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;Becky&quot;));</span>
<a href="#l17.23"></a><span id="l17.23">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.24"></a><span id="l17.24"> </span>
<a href="#l17.25"></a><span id="l17.25">   bool exists = false;</span>
<a href="#l17.26"></a><span id="l17.26">   rv = directory-&gt;Exists(&amp;exists);</span>
<a href="#l17.27"></a><span id="l17.27">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineminus">-  if (!exists)</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineminus">-    return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineplus">+  if (!exists) return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l17.31"></a><span id="l17.31"> </span>
<a href="#l17.32"></a><span id="l17.32">   bool isDirectory = false;</span>
<a href="#l17.33"></a><span id="l17.33">   rv = directory-&gt;IsDirectory(&amp;isDirectory);</span>
<a href="#l17.34"></a><span id="l17.34">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineminus">-  if (!isDirectory)</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineminus">-    return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineplus">+  if (!isDirectory) return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l17.38"></a><span id="l17.38"> </span>
<a href="#l17.39"></a><span id="l17.39">   directory.forget(aLocation);</span>
<a href="#l17.40"></a><span id="l17.40">   return NS_OK;</span>
<a href="#l17.41"></a><span id="l17.41"> }</span>
<a href="#l17.42"></a><span id="l17.42"> </span>
<a href="#l17.43"></a><span id="l17.43" class="difflineminus">-nsresult</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineminus">-nsBeckyUtils::FindUserDirectoryOnWindowsXP(nsIFile **aLocation)</span>
<a href="#l17.45"></a><span id="l17.45" class="difflineminus">-{</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineplus">+nsresult nsBeckyUtils::FindUserDirectoryOnWindowsXP(nsIFile **aLocation) {</span>
<a href="#l17.47"></a><span id="l17.47">   NS_ENSURE_ARG_POINTER(aLocation);</span>
<a href="#l17.48"></a><span id="l17.48"> </span>
<a href="#l17.49"></a><span id="l17.49">   nsresult rv;</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt; directory = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; directory =</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineplus">+      do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l17.53"></a><span id="l17.53">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.54"></a><span id="l17.54"> </span>
<a href="#l17.55"></a><span id="l17.55">   rv = directory-&gt;InitWithPath(NS_LITERAL_STRING(&quot;C:\\Becky!&quot;));</span>
<a href="#l17.56"></a><span id="l17.56">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.57"></a><span id="l17.57"> </span>
<a href="#l17.58"></a><span id="l17.58">   bool exists = false;</span>
<a href="#l17.59"></a><span id="l17.59">   rv = directory-&gt;Exists(&amp;exists);</span>
<a href="#l17.60"></a><span id="l17.60">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.61"></a><span id="l17.61" class="difflineminus">-  if (!exists)</span>
<a href="#l17.62"></a><span id="l17.62" class="difflineminus">-    return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l17.63"></a><span id="l17.63" class="difflineplus">+  if (!exists) return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l17.64"></a><span id="l17.64"> </span>
<a href="#l17.65"></a><span id="l17.65">   bool isDirectory = false;</span>
<a href="#l17.66"></a><span id="l17.66">   rv = directory-&gt;IsDirectory(&amp;isDirectory);</span>
<a href="#l17.67"></a><span id="l17.67">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.68"></a><span id="l17.68" class="difflineminus">-  if (!isDirectory)</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineminus">-    return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineplus">+  if (!isDirectory) return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l17.71"></a><span id="l17.71"> </span>
<a href="#l17.72"></a><span id="l17.72">   nsCOMPtr&lt;nsIDirectoryEnumerator&gt; entries;</span>
<a href="#l17.73"></a><span id="l17.73">   rv = directory-&gt;GetDirectoryEntries(getter_AddRefs(entries));</span>
<a href="#l17.74"></a><span id="l17.74">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.75"></a><span id="l17.75"> </span>
<a href="#l17.76"></a><span id="l17.76">   bool more;</span>
<a href="#l17.77"></a><span id="l17.77">   while (NS_SUCCEEDED(entries-&gt;HasMoreElements(&amp;more)) &amp;&amp; more) {</span>
<a href="#l17.78"></a><span id="l17.78">     nsCOMPtr&lt;nsIFile&gt; file;</span>
<a href="#l17.79"></a><span id="l17.79" class="difflineat">@@ -100,92 +93,81 @@ nsBeckyUtils::FindUserDirectoryOnWindows</span>
<a href="#l17.80"></a><span id="l17.80">       return NS_OK;</span>
<a href="#l17.81"></a><span id="l17.81">     }</span>
<a href="#l17.82"></a><span id="l17.82">   }</span>
<a href="#l17.83"></a><span id="l17.83"> </span>
<a href="#l17.84"></a><span id="l17.84">   directory.forget(aLocation);</span>
<a href="#l17.85"></a><span id="l17.85">   return NS_OK;</span>
<a href="#l17.86"></a><span id="l17.86"> }</span>
<a href="#l17.87"></a><span id="l17.87"> </span>
<a href="#l17.88"></a><span id="l17.88" class="difflineminus">-nsresult</span>
<a href="#l17.89"></a><span id="l17.89" class="difflineminus">-nsBeckyUtils::FindUserDirectory(nsIFile **aLocation)</span>
<a href="#l17.90"></a><span id="l17.90" class="difflineminus">-{</span>
<a href="#l17.91"></a><span id="l17.91" class="difflineplus">+nsresult nsBeckyUtils::FindUserDirectory(nsIFile **aLocation) {</span>
<a href="#l17.92"></a><span id="l17.92">   nsresult rv = FindUserDirectoryOnWindows7(aLocation);</span>
<a href="#l17.93"></a><span id="l17.93">   if (rv == NS_ERROR_FILE_NOT_FOUND) {</span>
<a href="#l17.94"></a><span id="l17.94">     rv = FindUserDirectoryOnWindowsXP(aLocation);</span>
<a href="#l17.95"></a><span id="l17.95">   }</span>
<a href="#l17.96"></a><span id="l17.96">   return rv;</span>
<a href="#l17.97"></a><span id="l17.97"> }</span>
<a href="#l17.98"></a><span id="l17.98"> </span>
<a href="#l17.99"></a><span id="l17.99" class="difflineminus">-nsresult</span>
<a href="#l17.100"></a><span id="l17.100" class="difflineminus">-nsBeckyUtils::ConvertNativeStringToUTF8(const nsACString&amp; aOriginal,</span>
<a href="#l17.101"></a><span id="l17.101" class="difflineminus">-                                        nsACString&amp; _retval)</span>
<a href="#l17.102"></a><span id="l17.102" class="difflineminus">-{</span>
<a href="#l17.103"></a><span id="l17.103" class="difflineplus">+nsresult nsBeckyUtils::ConvertNativeStringToUTF8(const nsACString &amp;aOriginal,</span>
<a href="#l17.104"></a><span id="l17.104" class="difflineplus">+                                                 nsACString &amp;_retval) {</span>
<a href="#l17.105"></a><span id="l17.105">   nsresult rv;</span>
<a href="#l17.106"></a><span id="l17.106">   nsAutoString unicodeString;</span>
<a href="#l17.107"></a><span id="l17.107">   rv = NS_CopyNativeToUnicode(aOriginal, unicodeString);</span>
<a href="#l17.108"></a><span id="l17.108">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.109"></a><span id="l17.109"> </span>
<a href="#l17.110"></a><span id="l17.110">   CopyUTF16toUTF8(unicodeString, _retval);</span>
<a href="#l17.111"></a><span id="l17.111">   return NS_OK;</span>
<a href="#l17.112"></a><span id="l17.112"> }</span>
<a href="#l17.113"></a><span id="l17.113"> </span>
<a href="#l17.114"></a><span id="l17.114" class="difflineminus">-nsresult</span>
<a href="#l17.115"></a><span id="l17.115" class="difflineminus">-nsBeckyUtils::CreateLineInputStream(nsIFile *aFile,</span>
<a href="#l17.116"></a><span id="l17.116" class="difflineminus">-                                    nsILineInputStream **_retval)</span>
<a href="#l17.117"></a><span id="l17.117" class="difflineminus">-{</span>
<a href="#l17.118"></a><span id="l17.118" class="difflineplus">+nsresult nsBeckyUtils::CreateLineInputStream(nsIFile *aFile,</span>
<a href="#l17.119"></a><span id="l17.119" class="difflineplus">+                                             nsILineInputStream **_retval) {</span>
<a href="#l17.120"></a><span id="l17.120">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l17.121"></a><span id="l17.121"> </span>
<a href="#l17.122"></a><span id="l17.122">   nsCOMPtr&lt;nsIInputStream&gt; inputStream;</span>
<a href="#l17.123"></a><span id="l17.123">   nsresult rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream), aFile);</span>
<a href="#l17.124"></a><span id="l17.124">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.125"></a><span id="l17.125"> </span>
<a href="#l17.126"></a><span id="l17.126">   return CallQueryInterface(inputStream, _retval);</span>
<a href="#l17.127"></a><span id="l17.127"> }</span>
<a href="#l17.128"></a><span id="l17.128"> </span>
<a href="#l17.129"></a><span id="l17.129" class="difflineminus">-nsresult</span>
<a href="#l17.130"></a><span id="l17.130" class="difflineminus">-nsBeckyUtils::GetFolderListFile(nsIFile *aLocation, nsIFile **_retval)</span>
<a href="#l17.131"></a><span id="l17.131" class="difflineminus">-{</span>
<a href="#l17.132"></a><span id="l17.132" class="difflineplus">+nsresult nsBeckyUtils::GetFolderListFile(nsIFile *aLocation,</span>
<a href="#l17.133"></a><span id="l17.133" class="difflineplus">+                                         nsIFile **_retval) {</span>
<a href="#l17.134"></a><span id="l17.134">   nsresult rv;</span>
<a href="#l17.135"></a><span id="l17.135">   nsCOMPtr&lt;nsIFile&gt; folderListFile;</span>
<a href="#l17.136"></a><span id="l17.136">   rv = aLocation-&gt;Clone(getter_AddRefs(folderListFile));</span>
<a href="#l17.137"></a><span id="l17.137">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.138"></a><span id="l17.138"> </span>
<a href="#l17.139"></a><span id="l17.139">   rv = folderListFile-&gt;Append(NS_LITERAL_STRING(&quot;Folder.lst&quot;));</span>
<a href="#l17.140"></a><span id="l17.140">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.141"></a><span id="l17.141"> </span>
<a href="#l17.142"></a><span id="l17.142">   bool exists;</span>
<a href="#l17.143"></a><span id="l17.143">   rv = folderListFile-&gt;Exists(&amp;exists);</span>
<a href="#l17.144"></a><span id="l17.144">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.145"></a><span id="l17.145"> </span>
<a href="#l17.146"></a><span id="l17.146" class="difflineminus">-  if (!exists)</span>
<a href="#l17.147"></a><span id="l17.147" class="difflineminus">-    return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l17.148"></a><span id="l17.148" class="difflineplus">+  if (!exists) return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l17.149"></a><span id="l17.149"> </span>
<a href="#l17.150"></a><span id="l17.150">   folderListFile.forget(_retval);</span>
<a href="#l17.151"></a><span id="l17.151">   return NS_OK;</span>
<a href="#l17.152"></a><span id="l17.152"> }</span>
<a href="#l17.153"></a><span id="l17.153"> </span>
<a href="#l17.154"></a><span id="l17.154" class="difflineminus">-nsresult</span>
<a href="#l17.155"></a><span id="l17.155" class="difflineminus">-nsBeckyUtils::GetDefaultFolderName(nsIFile *aFolderListFile, nsACString&amp; name)</span>
<a href="#l17.156"></a><span id="l17.156" class="difflineminus">-{</span>
<a href="#l17.157"></a><span id="l17.157" class="difflineplus">+nsresult nsBeckyUtils::GetDefaultFolderName(nsIFile *aFolderListFile,</span>
<a href="#l17.158"></a><span id="l17.158" class="difflineplus">+                                            nsACString &amp;name) {</span>
<a href="#l17.159"></a><span id="l17.159">   nsresult rv;</span>
<a href="#l17.160"></a><span id="l17.160">   nsCOMPtr&lt;nsILineInputStream&gt; lineStream;</span>
<a href="#l17.161"></a><span id="l17.161">   rv = CreateLineInputStream(aFolderListFile, getter_AddRefs(lineStream));</span>
<a href="#l17.162"></a><span id="l17.162">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.163"></a><span id="l17.163"> </span>
<a href="#l17.164"></a><span id="l17.164">   bool more = true;</span>
<a href="#l17.165"></a><span id="l17.165">   rv = lineStream-&gt;ReadLine(name, &amp;more);</span>
<a href="#l17.166"></a><span id="l17.166">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.167"></a><span id="l17.167"> </span>
<a href="#l17.168"></a><span id="l17.168">   return NS_OK;</span>
<a href="#l17.169"></a><span id="l17.169"> }</span>
<a href="#l17.170"></a><span id="l17.170"> </span>
<a href="#l17.171"></a><span id="l17.171" class="difflineminus">-nsresult</span>
<a href="#l17.172"></a><span id="l17.172" class="difflineminus">-nsBeckyUtils::GetDefaultMailboxDirectory(nsIFile **_retval)</span>
<a href="#l17.173"></a><span id="l17.173" class="difflineminus">-{</span>
<a href="#l17.174"></a><span id="l17.174" class="difflineplus">+nsresult nsBeckyUtils::GetDefaultMailboxDirectory(nsIFile **_retval) {</span>
<a href="#l17.175"></a><span id="l17.175">   nsCOMPtr&lt;nsIFile&gt; userDirectory;</span>
<a href="#l17.176"></a><span id="l17.176">   nsresult rv = FindUserDirectory(getter_AddRefs(userDirectory));</span>
<a href="#l17.177"></a><span id="l17.177">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.178"></a><span id="l17.178"> </span>
<a href="#l17.179"></a><span id="l17.179">   nsCOMPtr&lt;nsIFile&gt; folderListFile;</span>
<a href="#l17.180"></a><span id="l17.180">   rv = GetFolderListFile(userDirectory, getter_AddRefs(folderListFile));</span>
<a href="#l17.181"></a><span id="l17.181">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.182"></a><span id="l17.182"> </span>
<a href="#l17.183"></a><span id="l17.183" class="difflineat">@@ -194,137 +176,121 @@ nsBeckyUtils::GetDefaultMailboxDirectory</span>
<a href="#l17.184"></a><span id="l17.184">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.185"></a><span id="l17.185"> </span>
<a href="#l17.186"></a><span id="l17.186">   rv = userDirectory-&gt;AppendNative(defaultFolderName);</span>
<a href="#l17.187"></a><span id="l17.187">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.188"></a><span id="l17.188"> </span>
<a href="#l17.189"></a><span id="l17.189">   bool exists;</span>
<a href="#l17.190"></a><span id="l17.190">   rv = userDirectory-&gt;Exists(&amp;exists);</span>
<a href="#l17.191"></a><span id="l17.191">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.192"></a><span id="l17.192" class="difflineminus">-  if (!exists)</span>
<a href="#l17.193"></a><span id="l17.193" class="difflineminus">-    return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l17.194"></a><span id="l17.194" class="difflineplus">+  if (!exists) return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l17.195"></a><span id="l17.195"> </span>
<a href="#l17.196"></a><span id="l17.196">   bool isDirectory = false;</span>
<a href="#l17.197"></a><span id="l17.197">   rv = userDirectory-&gt;IsDirectory(&amp;isDirectory);</span>
<a href="#l17.198"></a><span id="l17.198">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.199"></a><span id="l17.199" class="difflineminus">-  if (!isDirectory)</span>
<a href="#l17.200"></a><span id="l17.200" class="difflineminus">-    return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l17.201"></a><span id="l17.201" class="difflineplus">+  if (!isDirectory) return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l17.202"></a><span id="l17.202"> </span>
<a href="#l17.203"></a><span id="l17.203">   userDirectory.forget(_retval);</span>
<a href="#l17.204"></a><span id="l17.204">   return NS_OK;</span>
<a href="#l17.205"></a><span id="l17.205"> }</span>
<a href="#l17.206"></a><span id="l17.206"> </span>
<a href="#l17.207"></a><span id="l17.207" class="difflineminus">-nsresult</span>
<a href="#l17.208"></a><span id="l17.208" class="difflineminus">-nsBeckyUtils::GetDefaultMailboxINIFile(nsIFile **_retval)</span>
<a href="#l17.209"></a><span id="l17.209" class="difflineminus">-{</span>
<a href="#l17.210"></a><span id="l17.210" class="difflineplus">+nsresult nsBeckyUtils::GetDefaultMailboxINIFile(nsIFile **_retval) {</span>
<a href="#l17.211"></a><span id="l17.211">   nsresult rv;</span>
<a href="#l17.212"></a><span id="l17.212">   nsCOMPtr&lt;nsIFile&gt; mailboxDirectory;</span>
<a href="#l17.213"></a><span id="l17.213">   rv = GetDefaultMailboxDirectory(getter_AddRefs(mailboxDirectory));</span>
<a href="#l17.214"></a><span id="l17.214">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.215"></a><span id="l17.215"> </span>
<a href="#l17.216"></a><span id="l17.216">   return GetMailboxINIFile(mailboxDirectory, _retval);</span>
<a href="#l17.217"></a><span id="l17.217"> }</span>
<a href="#l17.218"></a><span id="l17.218"> </span>
<a href="#l17.219"></a><span id="l17.219" class="difflineminus">-nsresult</span>
<a href="#l17.220"></a><span id="l17.220" class="difflineminus">-nsBeckyUtils::GetMailboxINIFile(nsIFile *aDirectory, nsIFile **_retval)</span>
<a href="#l17.221"></a><span id="l17.221" class="difflineminus">-{</span>
<a href="#l17.222"></a><span id="l17.222" class="difflineplus">+nsresult nsBeckyUtils::GetMailboxINIFile(nsIFile *aDirectory,</span>
<a href="#l17.223"></a><span id="l17.223" class="difflineplus">+                                         nsIFile **_retval) {</span>
<a href="#l17.224"></a><span id="l17.224">   nsresult rv;</span>
<a href="#l17.225"></a><span id="l17.225">   nsCOMPtr&lt;nsIFile&gt; target;</span>
<a href="#l17.226"></a><span id="l17.226">   rv = aDirectory-&gt;Clone(getter_AddRefs(target));</span>
<a href="#l17.227"></a><span id="l17.227">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.228"></a><span id="l17.228"> </span>
<a href="#l17.229"></a><span id="l17.229">   rv = target-&gt;Append(NS_LITERAL_STRING(&quot;Mailbox.ini&quot;));</span>
<a href="#l17.230"></a><span id="l17.230">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.231"></a><span id="l17.231">   bool exists;</span>
<a href="#l17.232"></a><span id="l17.232">   rv = target-&gt;Exists(&amp;exists);</span>
<a href="#l17.233"></a><span id="l17.233" class="difflineminus">-  if (!exists)</span>
<a href="#l17.234"></a><span id="l17.234" class="difflineminus">-    return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l17.235"></a><span id="l17.235" class="difflineplus">+  if (!exists) return NS_ERROR_FILE_NOT_FOUND;</span>
<a href="#l17.236"></a><span id="l17.236"> </span>
<a href="#l17.237"></a><span id="l17.237">   target.forget(_retval);</span>
<a href="#l17.238"></a><span id="l17.238">   return NS_OK;</span>
<a href="#l17.239"></a><span id="l17.239"> }</span>
<a href="#l17.240"></a><span id="l17.240"> </span>
<a href="#l17.241"></a><span id="l17.241" class="difflineminus">-nsresult</span>
<a href="#l17.242"></a><span id="l17.242" class="difflineminus">-nsBeckyUtils::CreateINIParserForFile(nsIFile *aFile,</span>
<a href="#l17.243"></a><span id="l17.243" class="difflineminus">-                                     nsIINIParser **aParser)</span>
<a href="#l17.244"></a><span id="l17.244" class="difflineminus">-{</span>
<a href="#l17.245"></a><span id="l17.245" class="difflineplus">+nsresult nsBeckyUtils::CreateINIParserForFile(nsIFile *aFile,</span>
<a href="#l17.246"></a><span id="l17.246" class="difflineplus">+                                              nsIINIParser **aParser) {</span>
<a href="#l17.247"></a><span id="l17.247">   nsresult rv;</span>
<a href="#l17.248"></a><span id="l17.248">   nsCOMPtr&lt;nsIINIParserFactory&gt; factory =</span>
<a href="#l17.249"></a><span id="l17.249" class="difflineminus">-    do_GetService(&quot;@mozilla.org/xpcom/ini-processor-factory;1&quot;, &amp;rv);</span>
<a href="#l17.250"></a><span id="l17.250" class="difflineplus">+      do_GetService(&quot;@mozilla.org/xpcom/ini-processor-factory;1&quot;, &amp;rv);</span>
<a href="#l17.251"></a><span id="l17.251">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.252"></a><span id="l17.252"> </span>
<a href="#l17.253"></a><span id="l17.253">   return factory-&gt;CreateINIParser(aFile, aParser);</span>
<a href="#l17.254"></a><span id="l17.254"> }</span>
<a href="#l17.255"></a><span id="l17.255"> </span>
<a href="#l17.256"></a><span id="l17.256" class="difflineminus">-nsresult</span>
<a href="#l17.257"></a><span id="l17.257" class="difflineminus">-nsBeckyUtils::GetMailboxNameFromINIFile(nsIFile *aFile, nsCString &amp;aName)</span>
<a href="#l17.258"></a><span id="l17.258" class="difflineminus">-{</span>
<a href="#l17.259"></a><span id="l17.259" class="difflineplus">+nsresult nsBeckyUtils::GetMailboxNameFromINIFile(nsIFile *aFile,</span>
<a href="#l17.260"></a><span id="l17.260" class="difflineplus">+                                                 nsCString &amp;aName) {</span>
<a href="#l17.261"></a><span id="l17.261">   nsresult rv;</span>
<a href="#l17.262"></a><span id="l17.262">   nsCOMPtr&lt;nsIINIParser&gt; parser;</span>
<a href="#l17.263"></a><span id="l17.263">   rv = CreateINIParserForFile(aFile, getter_AddRefs(parser));</span>
<a href="#l17.264"></a><span id="l17.264">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.265"></a><span id="l17.265"> </span>
<a href="#l17.266"></a><span id="l17.266">   return parser-&gt;GetString(NS_LITERAL_CSTRING(&quot;Account&quot;),</span>
<a href="#l17.267"></a><span id="l17.267" class="difflineminus">-                           NS_LITERAL_CSTRING(&quot;Name&quot;),</span>
<a href="#l17.268"></a><span id="l17.268" class="difflineminus">-                           aName);</span>
<a href="#l17.269"></a><span id="l17.269" class="difflineplus">+                           NS_LITERAL_CSTRING(&quot;Name&quot;), aName);</span>
<a href="#l17.270"></a><span id="l17.270"> }</span>
<a href="#l17.271"></a><span id="l17.271"> </span>
<a href="#l17.272"></a><span id="l17.272" class="difflineminus">-nsresult</span>
<a href="#l17.273"></a><span id="l17.273" class="difflineminus">-nsBeckyUtils::ConvertToUTF8File(nsIFile *aSourceFile,</span>
<a href="#l17.274"></a><span id="l17.274" class="difflineminus">-                                nsIFile **_retval)</span>
<a href="#l17.275"></a><span id="l17.275" class="difflineminus">-{</span>
<a href="#l17.276"></a><span id="l17.276" class="difflineplus">+nsresult nsBeckyUtils::ConvertToUTF8File(nsIFile *aSourceFile,</span>
<a href="#l17.277"></a><span id="l17.277" class="difflineplus">+                                         nsIFile **_retval) {</span>
<a href="#l17.278"></a><span id="l17.278">   nsresult rv;</span>
<a href="#l17.279"></a><span id="l17.279">   nsCOMPtr&lt;nsIFile&gt; convertedFile;</span>
<a href="#l17.280"></a><span id="l17.280">   rv = GetSpecialDirectoryWithFileName(NS_OS_TEMP_DIR,</span>
<a href="#l17.281"></a><span id="l17.281">                                        &quot;thunderbird-becky-import&quot;,</span>
<a href="#l17.282"></a><span id="l17.282">                                        getter_AddRefs(convertedFile));</span>
<a href="#l17.283"></a><span id="l17.283">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.284"></a><span id="l17.284">   rv = convertedFile-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 0600);</span>
<a href="#l17.285"></a><span id="l17.285">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.286"></a><span id="l17.286"> </span>
<a href="#l17.287"></a><span id="l17.287">   nsCOMPtr&lt;nsIInputStream&gt; source;</span>
<a href="#l17.288"></a><span id="l17.288">   rv = NS_NewLocalFileInputStream(getter_AddRefs(source), aSourceFile);</span>
<a href="#l17.289"></a><span id="l17.289">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.290"></a><span id="l17.290"> </span>
<a href="#l17.291"></a><span id="l17.291">   nsCOMPtr&lt;nsIOutputStream&gt; destination;</span>
<a href="#l17.292"></a><span id="l17.292" class="difflineminus">-  rv = NS_NewLocalFileOutputStream(getter_AddRefs(destination),</span>
<a href="#l17.293"></a><span id="l17.293" class="difflineminus">-                                   convertedFile);</span>
<a href="#l17.294"></a><span id="l17.294" class="difflineplus">+  rv = NS_NewLocalFileOutputStream(getter_AddRefs(destination), convertedFile);</span>
<a href="#l17.295"></a><span id="l17.295">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.296"></a><span id="l17.296"> </span>
<a href="#l17.297"></a><span id="l17.297">   const uint32_t kBlock = 8192;</span>
<a href="#l17.298"></a><span id="l17.298"> </span>
<a href="#l17.299"></a><span id="l17.299">   nsCOMPtr&lt;nsIConverterInputStream&gt; convertedInput =</span>
<a href="#l17.300"></a><span id="l17.300" class="difflineminus">-    do_CreateInstance(&quot;@mozilla.org/intl/converter-input-stream;1&quot;);</span>
<a href="#l17.301"></a><span id="l17.301" class="difflineplus">+      do_CreateInstance(&quot;@mozilla.org/intl/converter-input-stream;1&quot;);</span>
<a href="#l17.302"></a><span id="l17.302">   convertedInput-&gt;Init(source,</span>
<a href="#l17.303"></a><span id="l17.303">                        PromiseFlatCString(nsMsgI18NFileSystemCharset()).get(),</span>
<a href="#l17.304"></a><span id="l17.304" class="difflineminus">-                       kBlock,</span>
<a href="#l17.305"></a><span id="l17.305" class="difflineminus">-                       0x0000);</span>
<a href="#l17.306"></a><span id="l17.306" class="difflineplus">+                       kBlock, 0x0000);</span>
<a href="#l17.307"></a><span id="l17.307"> </span>
<a href="#l17.308"></a><span id="l17.308">   nsCOMPtr&lt;nsIConverterOutputStream&gt; convertedOutput =</span>
<a href="#l17.309"></a><span id="l17.309" class="difflineminus">-    do_CreateInstance(&quot;@mozilla.org/intl/converter-output-stream;1&quot;);</span>
<a href="#l17.310"></a><span id="l17.310" class="difflineplus">+      do_CreateInstance(&quot;@mozilla.org/intl/converter-output-stream;1&quot;);</span>
<a href="#l17.311"></a><span id="l17.311">   convertedOutput-&gt;Init(destination, &quot;UTF-8&quot;);</span>
<a href="#l17.312"></a><span id="l17.312"> </span>
<a href="#l17.313"></a><span id="l17.313">   char16_t *line = (char16_t *)moz_xmalloc(kBlock);</span>
<a href="#l17.314"></a><span id="l17.314">   uint32_t readBytes = kBlock;</span>
<a href="#l17.315"></a><span id="l17.315">   bool writtenBytes;</span>
<a href="#l17.316"></a><span id="l17.316">   while (readBytes == kBlock) {</span>
<a href="#l17.317"></a><span id="l17.317">     rv = convertedInput-&gt;Read(line, kBlock, &amp;readBytes);</span>
<a href="#l17.318"></a><span id="l17.318">     rv = convertedOutput-&gt;Write(readBytes, line, &amp;writtenBytes);</span>
<a href="#l17.319"></a><span id="l17.319">   }</span>
<a href="#l17.320"></a><span id="l17.320">   convertedOutput-&gt;Close();</span>
<a href="#l17.321"></a><span id="l17.321">   convertedInput-&gt;Close();</span>
<a href="#l17.322"></a><span id="l17.322"> </span>
<a href="#l17.323"></a><span id="l17.323">   convertedFile.forget(_retval);</span>
<a href="#l17.324"></a><span id="l17.324">   return NS_OK;</span>
<a href="#l17.325"></a><span id="l17.325"> }</span>
<a href="#l17.326"></a><span id="l17.326"> </span>
<a href="#l17.327"></a><span id="l17.327" class="difflineminus">-nsresult</span>
<a href="#l17.328"></a><span id="l17.328" class="difflineminus">-nsBeckyUtils::TranslateFolderName(const nsAString &amp; aFolderName,</span>
<a href="#l17.329"></a><span id="l17.329" class="difflineminus">-                                  nsAString &amp; _retval)</span>
<a href="#l17.330"></a><span id="l17.330" class="difflineminus">-{</span>
<a href="#l17.331"></a><span id="l17.331" class="difflineplus">+nsresult nsBeckyUtils::TranslateFolderName(const nsAString &amp;aFolderName,</span>
<a href="#l17.332"></a><span id="l17.332" class="difflineplus">+                                           nsAString &amp;_retval) {</span>
<a href="#l17.333"></a><span id="l17.333">   if (aFolderName.LowerCaseEqualsLiteral(&quot;!trash&quot;))</span>
<a href="#l17.334"></a><span id="l17.334">     _retval = NS_LITERAL_STRING(kDestTrashFolderName);</span>
<a href="#l17.335"></a><span id="l17.335">   else if (aFolderName.LowerCaseEqualsLiteral(&quot;!!!!inbox&quot;))</span>
<a href="#l17.336"></a><span id="l17.336">     _retval = NS_LITERAL_STRING(kDestInboxFolderName);</span>
<a href="#l17.337"></a><span id="l17.337">   else if (aFolderName.LowerCaseEqualsLiteral(&quot;!!!!outbox&quot;))</span>
<a href="#l17.338"></a><span id="l17.338">     _retval = NS_LITERAL_STRING(kDestSentFolderName);</span>
<a href="#l17.339"></a><span id="l17.339">   else if (aFolderName.LowerCaseEqualsLiteral(&quot;!!!!unsent&quot;))</span>
<a href="#l17.340"></a><span id="l17.340">     _retval = NS_LITERAL_STRING(kDestUnsentMessagesFolderName);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/import/becky/src/nsBeckyUtils.h</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/import/becky/src/nsBeckyUtils.h</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -5,34 +5,31 @@</span>
<a href="#l18.4"></a><span id="l18.4"> #define _nsBeckyUtils_H__</span>
<a href="#l18.5"></a><span id="l18.5"> </span>
<a href="#l18.6"></a><span id="l18.6"> #include &quot;nsString.h&quot;</span>
<a href="#l18.7"></a><span id="l18.7"> class nsIFile;</span>
<a href="#l18.8"></a><span id="l18.8"> class nsILineInputStream;</span>
<a href="#l18.9"></a><span id="l18.9"> class nsIINIParser;</span>
<a href="#l18.10"></a><span id="l18.10"> </span>
<a href="#l18.11"></a><span id="l18.11"> class nsBeckyUtils final {</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-public:</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+ public:</span>
<a href="#l18.14"></a><span id="l18.14">   static nsresult FindUserDirectoryOnWindows7(nsIFile **aLocation);</span>
<a href="#l18.15"></a><span id="l18.15">   static nsresult FindUserDirectoryOnWindowsXP(nsIFile **aLocation);</span>
<a href="#l18.16"></a><span id="l18.16">   static nsresult FindUserDirectory(nsIFile **aFile);</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineminus">-  static nsresult ConvertNativeStringToUTF8(const nsACString&amp; aOriginal,</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineminus">-                                            nsACString&amp; _retval);</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineplus">+  static nsresult ConvertNativeStringToUTF8(const nsACString &amp;aOriginal,</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineplus">+                                            nsACString &amp;_retval);</span>
<a href="#l18.21"></a><span id="l18.21">   static nsresult CreateLineInputStream(nsIFile *aFile,</span>
<a href="#l18.22"></a><span id="l18.22">                                         nsILineInputStream **_retval);</span>
<a href="#l18.23"></a><span id="l18.23">   static nsresult GetDefaultMailboxDirectory(nsIFile **_retval);</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineminus">-  static nsresult GetFolderListFile(nsIFile *aLocation,</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineminus">-                                    nsIFile **_retval);</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineplus">+  static nsresult GetFolderListFile(nsIFile *aLocation, nsIFile **_retval);</span>
<a href="#l18.27"></a><span id="l18.27">   static nsresult GetDefaultFolderName(nsIFile *aFolderListFile,</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineminus">-                                       nsACString&amp; name);</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineplus">+                                       nsACString &amp;name);</span>
<a href="#l18.30"></a><span id="l18.30">   static nsresult GetDefaultMailboxINIFile(nsIFile **_retval);</span>
<a href="#l18.31"></a><span id="l18.31">   static nsresult GetMailboxINIFile(nsIFile *aDirectory, nsIFile **_retval);</span>
<a href="#l18.32"></a><span id="l18.32">   static nsresult CreateINIParserForFile(nsIFile *aFile,</span>
<a href="#l18.33"></a><span id="l18.33">                                          nsIINIParser **aParser);</span>
<a href="#l18.34"></a><span id="l18.34">   static nsresult GetMailboxNameFromINIFile(nsIFile *aFile, nsCString &amp;aName);</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineminus">-  static nsresult ConvertToUTF8File(nsIFile *aSourceFile,</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineminus">-                                    nsIFile **_retval);</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineminus">-  static nsresult TranslateFolderName(const nsAString &amp; aFolderName,</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineminus">-                                      nsAString &amp; _retval);</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineplus">+  static nsresult ConvertToUTF8File(nsIFile *aSourceFile, nsIFile **_retval);</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineplus">+  static nsresult TranslateFolderName(const nsAString &amp;aFolderName,</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineplus">+                                      nsAString &amp;_retval);</span>
<a href="#l18.42"></a><span id="l18.42"> };</span>
<a href="#l18.43"></a><span id="l18.43"> </span>
<a href="#l18.44"></a><span id="l18.44" class="difflineminus">-</span>
<a href="#l18.45"></a><span id="l18.45"> #endif /* _nsBeckyUtils_H__ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/import/build/nsImportModule.cpp</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/import/build/nsImportModule.cpp</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -30,48 +30,48 @@ NS_DEFINE_NAMED_CID(NS_TEXTIMPORT_CID);</span>
<a href="#l19.4"></a><span id="l19.4"> #include &quot;nsVCardImport.h&quot;</span>
<a href="#l19.5"></a><span id="l19.5"> </span>
<a href="#l19.6"></a><span id="l19.6"> NS_DEFINE_NAMED_CID(NS_VCARDIMPORT_CID);</span>
<a href="#l19.7"></a><span id="l19.7"> </span>
<a href="#l19.8"></a><span id="l19.8"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l19.9"></a><span id="l19.9"> // Apple Mail import Include Files</span>
<a href="#l19.10"></a><span id="l19.10"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l19.11"></a><span id="l19.11"> #if defined(XP_MACOSX)</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-#include &quot;nsAppleMailImport.h&quot;</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+#  include &quot;nsAppleMailImport.h&quot;</span>
<a href="#l19.14"></a><span id="l19.14"> </span>
<a href="#l19.15"></a><span id="l19.15"> NS_DEFINE_NAMED_CID(NS_APPLEMAILIMPORT_CID);</span>
<a href="#l19.16"></a><span id="l19.16"> NS_DEFINE_NAMED_CID(NS_APPLEMAILIMPL_CID);</span>
<a href="#l19.17"></a><span id="l19.17"> #endif</span>
<a href="#l19.18"></a><span id="l19.18"> </span>
<a href="#l19.19"></a><span id="l19.19"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l19.20"></a><span id="l19.20"> // outlook import Include Files</span>
<a href="#l19.21"></a><span id="l19.21"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l19.22"></a><span id="l19.22"> #ifdef XP_WIN</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineminus">-#ifdef MOZ_MAPI_SUPPORT</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineminus">-#include &quot;nsOutlookImport.h&quot;</span>
<a href="#l19.25"></a><span id="l19.25" class="difflineminus">-#include &quot;nsOutlookStringBundle.h&quot;</span>
<a href="#l19.26"></a><span id="l19.26" class="difflineminus">-#endif</span>
<a href="#l19.27"></a><span id="l19.27" class="difflineminus">-#include &quot;nsWMImport.h&quot;</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineminus">-#include &quot;nsWMStringBundle.h&quot;</span>
<a href="#l19.29"></a><span id="l19.29" class="difflineplus">+#  ifdef MOZ_MAPI_SUPPORT</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineplus">+#    include &quot;nsOutlookImport.h&quot;</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineplus">+#    include &quot;nsOutlookStringBundle.h&quot;</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineplus">+#  endif</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineplus">+#  include &quot;nsWMImport.h&quot;</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineplus">+#  include &quot;nsWMStringBundle.h&quot;</span>
<a href="#l19.35"></a><span id="l19.35"> </span>
<a href="#l19.36"></a><span id="l19.36"> NS_DEFINE_NAMED_CID(NS_WMIMPORT_CID);</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineminus">-#ifdef MOZ_MAPI_SUPPORT</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineplus">+#  ifdef MOZ_MAPI_SUPPORT</span>
<a href="#l19.39"></a><span id="l19.39"> NS_DEFINE_NAMED_CID(NS_OUTLOOKIMPORT_CID);</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineminus">-#endif</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineminus">-#endif // XP_WIN</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineplus">+#  endif</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineplus">+#endif  // XP_WIN</span>
<a href="#l19.44"></a><span id="l19.44"> </span>
<a href="#l19.45"></a><span id="l19.45"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l19.46"></a><span id="l19.46"> // becky import Include Files</span>
<a href="#l19.47"></a><span id="l19.47"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l19.48"></a><span id="l19.48"> #ifdef XP_WIN</span>
<a href="#l19.49"></a><span id="l19.49" class="difflineminus">-#include &quot;nsBeckyImport.h&quot;</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineminus">-#include &quot;nsBeckyStringBundle.h&quot;</span>
<a href="#l19.51"></a><span id="l19.51" class="difflineplus">+#  include &quot;nsBeckyImport.h&quot;</span>
<a href="#l19.52"></a><span id="l19.52" class="difflineplus">+#  include &quot;nsBeckyStringBundle.h&quot;</span>
<a href="#l19.53"></a><span id="l19.53"> </span>
<a href="#l19.54"></a><span id="l19.54"> NS_DEFINE_NAMED_CID(NS_BECKYIMPORT_CID);</span>
<a href="#l19.55"></a><span id="l19.55" class="difflineminus">-#endif // XP_WIN</span>
<a href="#l19.56"></a><span id="l19.56" class="difflineplus">+#endif  // XP_WIN</span>
<a href="#l19.57"></a><span id="l19.57"> </span>
<a href="#l19.58"></a><span id="l19.58"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l19.59"></a><span id="l19.59"> // core import factories</span>
<a href="#l19.60"></a><span id="l19.60"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l19.61"></a><span id="l19.61"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsImportService)</span>
<a href="#l19.62"></a><span id="l19.62"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsIImportMimeEncodeImpl)</span>
<a href="#l19.63"></a><span id="l19.63"> </span>
<a href="#l19.64"></a><span id="l19.64"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l19.65"></a><span id="l19.65" class="difflineat">@@ -92,98 +92,100 @@ NS_GENERIC_FACTORY_CONSTRUCTOR(nsAppleMa</span>
<a href="#l19.66"></a><span id="l19.66"> NS_GENERIC_FACTORY_CONSTRUCTOR_INIT(nsAppleMailImportMail, Initialize)</span>
<a href="#l19.67"></a><span id="l19.67"> #endif</span>
<a href="#l19.68"></a><span id="l19.68"> </span>
<a href="#l19.69"></a><span id="l19.69"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l19.70"></a><span id="l19.70"> // outlook import factories</span>
<a href="#l19.71"></a><span id="l19.71"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l19.72"></a><span id="l19.72"> #ifdef XP_WIN</span>
<a href="#l19.73"></a><span id="l19.73"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsWMImport)</span>
<a href="#l19.74"></a><span id="l19.74" class="difflineminus">-#ifdef MOZ_MAPI_SUPPORT</span>
<a href="#l19.75"></a><span id="l19.75" class="difflineplus">+#  ifdef MOZ_MAPI_SUPPORT</span>
<a href="#l19.76"></a><span id="l19.76"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsOutlookImport)</span>
<a href="#l19.77"></a><span id="l19.77" class="difflineminus">-#endif</span>
<a href="#l19.78"></a><span id="l19.78" class="difflineminus">-#endif // XP_WIN</span>
<a href="#l19.79"></a><span id="l19.79" class="difflineplus">+#  endif</span>
<a href="#l19.80"></a><span id="l19.80" class="difflineplus">+#endif  // XP_WIN</span>
<a href="#l19.81"></a><span id="l19.81"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l19.82"></a><span id="l19.82"> // becky import factory</span>
<a href="#l19.83"></a><span id="l19.83"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l19.84"></a><span id="l19.84"> #ifdef XP_WIN</span>
<a href="#l19.85"></a><span id="l19.85"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsBeckyImport)</span>
<a href="#l19.86"></a><span id="l19.86" class="difflineminus">-#endif // XP_WIN</span>
<a href="#l19.87"></a><span id="l19.87" class="difflineplus">+#endif  // XP_WIN</span>
<a href="#l19.88"></a><span id="l19.88"> </span>
<a href="#l19.89"></a><span id="l19.89"> static const mozilla::Module::CategoryEntry kMailNewsImportCategories[] = {</span>
<a href="#l19.90"></a><span id="l19.90" class="difflineminus">-  // XXX These CIDs should match the explicit CIDs defined in the header files,</span>
<a href="#l19.91"></a><span id="l19.91" class="difflineminus">-  // or be changed so that they are contract IDs (with appropriate code updates)</span>
<a href="#l19.92"></a><span id="l19.92" class="difflineminus">-  { &quot;mailnewsimport&quot;, &quot;{A5991D01-ADA7-11d3-A9C2-00A0CC26DA63}&quot;, NS_IMPORT_ADDRESS_STR },</span>
<a href="#l19.93"></a><span id="l19.93" class="difflineminus">-  { &quot;mailnewsimport&quot;, &quot;{0eb034a3-964a-4e2f-92eb-cc55d9ae9dd2}&quot;, NS_IMPORT_ADDRESS_STR },</span>
<a href="#l19.94"></a><span id="l19.94" class="difflineplus">+    // XXX These CIDs should match the explicit CIDs defined in the header</span>
<a href="#l19.95"></a><span id="l19.95" class="difflineplus">+    // files,</span>
<a href="#l19.96"></a><span id="l19.96" class="difflineplus">+    // or be changed so that they are contract IDs (with appropriate code</span>
<a href="#l19.97"></a><span id="l19.97" class="difflineplus">+    // updates)</span>
<a href="#l19.98"></a><span id="l19.98" class="difflineplus">+    {&quot;mailnewsimport&quot;, &quot;{A5991D01-ADA7-11d3-A9C2-00A0CC26DA63}&quot;,</span>
<a href="#l19.99"></a><span id="l19.99" class="difflineplus">+     NS_IMPORT_ADDRESS_STR},</span>
<a href="#l19.100"></a><span id="l19.100" class="difflineplus">+    {&quot;mailnewsimport&quot;, &quot;{0eb034a3-964a-4e2f-92eb-cc55d9ae9dd2}&quot;,</span>
<a href="#l19.101"></a><span id="l19.101" class="difflineplus">+     NS_IMPORT_ADDRESS_STR},</span>
<a href="#l19.102"></a><span id="l19.102"> #ifdef XP_WIN</span>
<a href="#l19.103"></a><span id="l19.103" class="difflineminus">-  { &quot;mailnewsimport&quot;, &quot;{42bc82bc-8e9f-4597-8b6e-e529daaf3af1}&quot;, kWMSupportsString },</span>
<a href="#l19.104"></a><span id="l19.104" class="difflineminus">-  { &quot;mailnewsimport&quot;, &quot;{7952a6cf-2442-4c04-9f02-150b15a0a841}&quot;, kBeckySupportsString },</span>
<a href="#l19.105"></a><span id="l19.105" class="difflineminus">-#ifdef MOZ_MAPI_SUPPORT</span>
<a href="#l19.106"></a><span id="l19.106" class="difflineminus">-  { &quot;mailnewsimport&quot;, &quot;{1DB469A0-8B00-11d3-A206-00A0CC26DA63}&quot;, kOutlookSupportsString },</span>
<a href="#l19.107"></a><span id="l19.107" class="difflineminus">-#endif</span>
<a href="#l19.108"></a><span id="l19.108" class="difflineplus">+    {&quot;mailnewsimport&quot;, &quot;{42bc82bc-8e9f-4597-8b6e-e529daaf3af1}&quot;,</span>
<a href="#l19.109"></a><span id="l19.109" class="difflineplus">+     kWMSupportsString},</span>
<a href="#l19.110"></a><span id="l19.110" class="difflineplus">+    {&quot;mailnewsimport&quot;, &quot;{7952a6cf-2442-4c04-9f02-150b15a0a841}&quot;,</span>
<a href="#l19.111"></a><span id="l19.111" class="difflineplus">+     kBeckySupportsString},</span>
<a href="#l19.112"></a><span id="l19.112" class="difflineplus">+#  ifdef MOZ_MAPI_SUPPORT</span>
<a href="#l19.113"></a><span id="l19.113" class="difflineplus">+    {&quot;mailnewsimport&quot;, &quot;{1DB469A0-8B00-11d3-A206-00A0CC26DA63}&quot;,</span>
<a href="#l19.114"></a><span id="l19.114" class="difflineplus">+     kOutlookSupportsString},</span>
<a href="#l19.115"></a><span id="l19.115" class="difflineplus">+#  endif</span>
<a href="#l19.116"></a><span id="l19.116"> #endif</span>
<a href="#l19.117"></a><span id="l19.117"> #if defined(XP_MACOSX)</span>
<a href="#l19.118"></a><span id="l19.118" class="difflineminus">-  { &quot;mailnewsimport&quot;, &quot;{6d3f101c-70ec-4e04-b68d-9908d1aeddf3}&quot;, kAppleMailSupportsString },</span>
<a href="#l19.119"></a><span id="l19.119" class="difflineplus">+    {&quot;mailnewsimport&quot;, &quot;{6d3f101c-70ec-4e04-b68d-9908d1aeddf3}&quot;,</span>
<a href="#l19.120"></a><span id="l19.120" class="difflineplus">+     kAppleMailSupportsString},</span>
<a href="#l19.121"></a><span id="l19.121"> #endif</span>
<a href="#l19.122"></a><span id="l19.122" class="difflineminus">-  { NULL }</span>
<a href="#l19.123"></a><span id="l19.123" class="difflineminus">-};</span>
<a href="#l19.124"></a><span id="l19.124" class="difflineplus">+    {NULL}};</span>
<a href="#l19.125"></a><span id="l19.125"> </span>
<a href="#l19.126"></a><span id="l19.126"> const mozilla::Module::CIDEntry kMailNewsImportCIDs[] = {</span>
<a href="#l19.127"></a><span id="l19.127" class="difflineminus">-  { &amp;kNS_IMPORTSERVICE_CID, false, NULL, nsImportServiceConstructor },</span>
<a href="#l19.128"></a><span id="l19.128" class="difflineminus">-  { &amp;kNS_IMPORTMIMEENCODE_CID, false, NULL, nsIImportMimeEncodeImplConstructor },</span>
<a href="#l19.129"></a><span id="l19.129" class="difflineminus">-  { &amp;kNS_TEXTIMPORT_CID, false, NULL, nsTextImportConstructor },</span>
<a href="#l19.130"></a><span id="l19.130" class="difflineminus">-  { &amp;kNS_VCARDIMPORT_CID, false, NULL, nsVCardImportConstructor },</span>
<a href="#l19.131"></a><span id="l19.131" class="difflineplus">+    {&amp;kNS_IMPORTSERVICE_CID, false, NULL, nsImportServiceConstructor},</span>
<a href="#l19.132"></a><span id="l19.132" class="difflineplus">+    {&amp;kNS_IMPORTMIMEENCODE_CID, false, NULL,</span>
<a href="#l19.133"></a><span id="l19.133" class="difflineplus">+     nsIImportMimeEncodeImplConstructor},</span>
<a href="#l19.134"></a><span id="l19.134" class="difflineplus">+    {&amp;kNS_TEXTIMPORT_CID, false, NULL, nsTextImportConstructor},</span>
<a href="#l19.135"></a><span id="l19.135" class="difflineplus">+    {&amp;kNS_VCARDIMPORT_CID, false, NULL, nsVCardImportConstructor},</span>
<a href="#l19.136"></a><span id="l19.136"> #if defined(XP_MACOSX)</span>
<a href="#l19.137"></a><span id="l19.137" class="difflineminus">-  { &amp;kNS_APPLEMAILIMPORT_CID, false, NULL, nsAppleMailImportModuleConstructor },</span>
<a href="#l19.138"></a><span id="l19.138" class="difflineminus">-  { &amp;kNS_APPLEMAILIMPL_CID, false, NULL, nsAppleMailImportMailConstructor },</span>
<a href="#l19.139"></a><span id="l19.139" class="difflineplus">+    {&amp;kNS_APPLEMAILIMPORT_CID, false, NULL, nsAppleMailImportModuleConstructor},</span>
<a href="#l19.140"></a><span id="l19.140" class="difflineplus">+    {&amp;kNS_APPLEMAILIMPL_CID, false, NULL, nsAppleMailImportMailConstructor},</span>
<a href="#l19.141"></a><span id="l19.141"> #endif</span>
<a href="#l19.142"></a><span id="l19.142"> </span>
<a href="#l19.143"></a><span id="l19.143"> #ifdef XP_WIN</span>
<a href="#l19.144"></a><span id="l19.144" class="difflineminus">-  { &amp;kNS_WMIMPORT_CID, false, NULL, nsWMImportConstructor },</span>
<a href="#l19.145"></a><span id="l19.145" class="difflineminus">-  { &amp;kNS_BECKYIMPORT_CID, false, NULL, nsBeckyImportConstructor },</span>
<a href="#l19.146"></a><span id="l19.146" class="difflineminus">-#ifdef MOZ_MAPI_SUPPORT</span>
<a href="#l19.147"></a><span id="l19.147" class="difflineminus">-  { &amp;kNS_OUTLOOKIMPORT_CID, false, NULL, nsOutlookImportConstructor },</span>
<a href="#l19.148"></a><span id="l19.148" class="difflineplus">+    {&amp;kNS_WMIMPORT_CID, false, NULL, nsWMImportConstructor},</span>
<a href="#l19.149"></a><span id="l19.149" class="difflineplus">+    {&amp;kNS_BECKYIMPORT_CID, false, NULL, nsBeckyImportConstructor},</span>
<a href="#l19.150"></a><span id="l19.150" class="difflineplus">+#  ifdef MOZ_MAPI_SUPPORT</span>
<a href="#l19.151"></a><span id="l19.151" class="difflineplus">+    {&amp;kNS_OUTLOOKIMPORT_CID, false, NULL, nsOutlookImportConstructor},</span>
<a href="#l19.152"></a><span id="l19.152" class="difflineplus">+#  endif</span>
<a href="#l19.153"></a><span id="l19.153"> #endif</span>
<a href="#l19.154"></a><span id="l19.154" class="difflineminus">-#endif</span>
<a href="#l19.155"></a><span id="l19.155" class="difflineminus">-  { NULL }</span>
<a href="#l19.156"></a><span id="l19.156" class="difflineminus">-};</span>
<a href="#l19.157"></a><span id="l19.157" class="difflineplus">+    {NULL}};</span>
<a href="#l19.158"></a><span id="l19.158"> </span>
<a href="#l19.159"></a><span id="l19.159"> const mozilla::Module::ContractIDEntry kMailNewsImportContracts[] = {</span>
<a href="#l19.160"></a><span id="l19.160" class="difflineminus">-  { NS_IMPORTSERVICE_CONTRACTID, &amp;kNS_IMPORTSERVICE_CID },</span>
<a href="#l19.161"></a><span id="l19.161" class="difflineminus">-  { &quot;@mozilla.org/import/import-mimeencode;1&quot;, &amp;kNS_IMPORTMIMEENCODE_CID },</span>
<a href="#l19.162"></a><span id="l19.162" class="difflineminus">-  { &quot;@mozilla.org/import/import-text;1&quot;, &amp;kNS_TEXTIMPORT_CID },</span>
<a href="#l19.163"></a><span id="l19.163" class="difflineminus">-  { &quot;@mozilla.org/import/import-vcard;1&quot;, &amp;kNS_VCARDIMPORT_CID },</span>
<a href="#l19.164"></a><span id="l19.164" class="difflineplus">+    {NS_IMPORTSERVICE_CONTRACTID, &amp;kNS_IMPORTSERVICE_CID},</span>
<a href="#l19.165"></a><span id="l19.165" class="difflineplus">+    {&quot;@mozilla.org/import/import-mimeencode;1&quot;, &amp;kNS_IMPORTMIMEENCODE_CID},</span>
<a href="#l19.166"></a><span id="l19.166" class="difflineplus">+    {&quot;@mozilla.org/import/import-text;1&quot;, &amp;kNS_TEXTIMPORT_CID},</span>
<a href="#l19.167"></a><span id="l19.167" class="difflineplus">+    {&quot;@mozilla.org/import/import-vcard;1&quot;, &amp;kNS_VCARDIMPORT_CID},</span>
<a href="#l19.168"></a><span id="l19.168"> #if defined(XP_MACOSX)</span>
<a href="#l19.169"></a><span id="l19.169" class="difflineminus">-  { &quot;@mozilla.org/import/import-applemail;1&quot;, &amp;kNS_APPLEMAILIMPORT_CID },</span>
<a href="#l19.170"></a><span id="l19.170" class="difflineminus">-  { NS_APPLEMAILIMPL_CONTRACTID, &amp;kNS_APPLEMAILIMPL_CID },</span>
<a href="#l19.171"></a><span id="l19.171" class="difflineplus">+    {&quot;@mozilla.org/import/import-applemail;1&quot;, &amp;kNS_APPLEMAILIMPORT_CID},</span>
<a href="#l19.172"></a><span id="l19.172" class="difflineplus">+    {NS_APPLEMAILIMPL_CONTRACTID, &amp;kNS_APPLEMAILIMPL_CID},</span>
<a href="#l19.173"></a><span id="l19.173"> #endif</span>
<a href="#l19.174"></a><span id="l19.174"> </span>
<a href="#l19.175"></a><span id="l19.175"> #ifdef XP_WIN</span>
<a href="#l19.176"></a><span id="l19.176" class="difflineminus">-  { &quot;@mozilla.org/import/import-wm;1&quot;, &amp;kNS_WMIMPORT_CID },</span>
<a href="#l19.177"></a><span id="l19.177" class="difflineminus">-  { &quot;@mozilla.org/import/import-becky;1&quot;, &amp;kNS_BECKYIMPORT_CID },</span>
<a href="#l19.178"></a><span id="l19.178" class="difflineminus">-#ifdef MOZ_MAPI_SUPPORT</span>
<a href="#l19.179"></a><span id="l19.179" class="difflineminus">-  { &quot;@mozilla.org/import/import-outlook;1&quot;, &amp;kNS_OUTLOOKIMPORT_CID },</span>
<a href="#l19.180"></a><span id="l19.180" class="difflineplus">+    {&quot;@mozilla.org/import/import-wm;1&quot;, &amp;kNS_WMIMPORT_CID},</span>
<a href="#l19.181"></a><span id="l19.181" class="difflineplus">+    {&quot;@mozilla.org/import/import-becky;1&quot;, &amp;kNS_BECKYIMPORT_CID},</span>
<a href="#l19.182"></a><span id="l19.182" class="difflineplus">+#  ifdef MOZ_MAPI_SUPPORT</span>
<a href="#l19.183"></a><span id="l19.183" class="difflineplus">+    {&quot;@mozilla.org/import/import-outlook;1&quot;, &amp;kNS_OUTLOOKIMPORT_CID},</span>
<a href="#l19.184"></a><span id="l19.184" class="difflineplus">+#  endif</span>
<a href="#l19.185"></a><span id="l19.185"> #endif</span>
<a href="#l19.186"></a><span id="l19.186" class="difflineminus">-#endif</span>
<a href="#l19.187"></a><span id="l19.187" class="difflineminus">-  { NULL }</span>
<a href="#l19.188"></a><span id="l19.188" class="difflineminus">-};</span>
<a href="#l19.189"></a><span id="l19.189" class="difflineplus">+    {NULL}};</span>
<a href="#l19.190"></a><span id="l19.190"> </span>
<a href="#l19.191"></a><span id="l19.191" class="difflineminus">-</span>
<a href="#l19.192"></a><span id="l19.192" class="difflineminus">-static void importModuleDtor()</span>
<a href="#l19.193"></a><span id="l19.193" class="difflineminus">-{</span>
<a href="#l19.194"></a><span id="l19.194" class="difflineplus">+static void importModuleDtor() {</span>
<a href="#l19.195"></a><span id="l19.195"> #ifdef XP_WIN</span>
<a href="#l19.196"></a><span id="l19.196" class="difflineminus">-    nsWMStringBundle::Cleanup();</span>
<a href="#l19.197"></a><span id="l19.197" class="difflineminus">-    nsBeckyStringBundle::Cleanup();</span>
<a href="#l19.198"></a><span id="l19.198" class="difflineminus">-#ifdef MOZ_MAPI_SUPPORT</span>
<a href="#l19.199"></a><span id="l19.199" class="difflineminus">-    nsOutlookStringBundle::Cleanup();</span>
<a href="#l19.200"></a><span id="l19.200" class="difflineminus">-#endif</span>
<a href="#l19.201"></a><span id="l19.201" class="difflineplus">+  nsWMStringBundle::Cleanup();</span>
<a href="#l19.202"></a><span id="l19.202" class="difflineplus">+  nsBeckyStringBundle::Cleanup();</span>
<a href="#l19.203"></a><span id="l19.203" class="difflineplus">+#  ifdef MOZ_MAPI_SUPPORT</span>
<a href="#l19.204"></a><span id="l19.204" class="difflineplus">+  nsOutlookStringBundle::Cleanup();</span>
<a href="#l19.205"></a><span id="l19.205" class="difflineplus">+#  endif</span>
<a href="#l19.206"></a><span id="l19.206"> #endif</span>
<a href="#l19.207"></a><span id="l19.207"> }</span>
<a href="#l19.208"></a><span id="l19.208"> </span>
<a href="#l19.209"></a><span id="l19.209" class="difflineminus">-extern const mozilla::Module kMailNewsImportModule = {</span>
<a href="#l19.210"></a><span id="l19.210" class="difflineminus">-  mozilla::Module::kVersion,</span>
<a href="#l19.211"></a><span id="l19.211" class="difflineminus">-  kMailNewsImportCIDs,</span>
<a href="#l19.212"></a><span id="l19.212" class="difflineminus">-  kMailNewsImportContracts,</span>
<a href="#l19.213"></a><span id="l19.213" class="difflineminus">-  kMailNewsImportCategories,</span>
<a href="#l19.214"></a><span id="l19.214" class="difflineminus">-  NULL,</span>
<a href="#l19.215"></a><span id="l19.215" class="difflineminus">-  NULL,</span>
<a href="#l19.216"></a><span id="l19.216" class="difflineminus">-  importModuleDtor</span>
<a href="#l19.217"></a><span id="l19.217" class="difflineminus">-};</span>
<a href="#l19.218"></a><span id="l19.218" class="difflineplus">+extern const mozilla::Module kMailNewsImportModule = {mozilla::Module::kVersion,</span>
<a href="#l19.219"></a><span id="l19.219" class="difflineplus">+                                                      kMailNewsImportCIDs,</span>
<a href="#l19.220"></a><span id="l19.220" class="difflineplus">+                                                      kMailNewsImportContracts,</span>
<a href="#l19.221"></a><span id="l19.221" class="difflineplus">+                                                      kMailNewsImportCategories,</span>
<a href="#l19.222"></a><span id="l19.222" class="difflineplus">+                                                      NULL,</span>
<a href="#l19.223"></a><span id="l19.223" class="difflineplus">+                                                      NULL,</span>
<a href="#l19.224"></a><span id="l19.224" class="difflineplus">+                                                      importModuleDtor};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/import/outlook/src/MapiApi.cpp</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/import/outlook/src/MapiApi.cpp</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -10,263 +10,247 @@</span>
<a href="#l20.4"></a><span id="l20.4"> #include &quot;rtfMailDecoder.h&quot;</span>
<a href="#l20.5"></a><span id="l20.5"> </span>
<a href="#l20.6"></a><span id="l20.6"> #include &quot;prprf.h&quot;</span>
<a href="#l20.7"></a><span id="l20.7"> #include &quot;nsMemory.h&quot;</span>
<a href="#l20.8"></a><span id="l20.8"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l20.9"></a><span id="l20.9"> #include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l20.10"></a><span id="l20.10"> #include &quot;nsNativeCharsetUtils.h&quot;</span>
<a href="#l20.11"></a><span id="l20.11"> </span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-int      CMapiApi::m_clients = 0;</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-BOOL    CMapiApi::m_initialized = false;</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineminus">-nsTArray&lt;CMsgStore*&gt;  *CMapiApi::m_pStores = NULL;</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineplus">+int CMapiApi::m_clients = 0;</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineplus">+BOOL CMapiApi::m_initialized = false;</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineplus">+nsTArray&lt;CMsgStore *&gt; *CMapiApi::m_pStores = NULL;</span>
<a href="#l20.18"></a><span id="l20.18"> LPMAPISESSION CMapiApi::m_lpSession = NULL;</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineminus">-LPMDB    CMapiApi::m_lpMdb = NULL;</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineminus">-HRESULT    CMapiApi::m_lastError;</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineplus">+LPMDB CMapiApi::m_lpMdb = NULL;</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineplus">+HRESULT CMapiApi::m_lastError;</span>
<a href="#l20.23"></a><span id="l20.23"> /*</span>
<a href="#l20.24"></a><span id="l20.24"> Type: 1, name: Calendar, class: IPF.Appointment</span>
<a href="#l20.25"></a><span id="l20.25"> Type: 1, name: Contacts, class: IPF.Contact</span>
<a href="#l20.26"></a><span id="l20.26"> Type: 1, name: Journal, class: IPF.Journal</span>
<a href="#l20.27"></a><span id="l20.27"> Type: 1, name: Notes, class: IPF.StickyNote</span>
<a href="#l20.28"></a><span id="l20.28"> Type: 1, name: Tasks, class: IPF.Task</span>
<a href="#l20.29"></a><span id="l20.29"> Type: 1, name: Drafts, class: IPF.Note</span>
<a href="#l20.30"></a><span id="l20.30"> */</span>
<a href="#l20.31"></a><span id="l20.31"> </span>
<a href="#l20.32"></a><span id="l20.32" class="difflineminus">-HINSTANCE  CMapiApi::m_hMapi32 = NULL;</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineplus">+HINSTANCE CMapiApi::m_hMapi32 = NULL;</span>
<a href="#l20.34"></a><span id="l20.34"> </span>
<a href="#l20.35"></a><span id="l20.35" class="difflineminus">-LPMAPIUNINITIALIZE    gpMapiUninitialize = NULL;</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineminus">-LPMAPIINITIALIZE    gpMapiInitialize = NULL;</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineminus">-LPMAPIALLOCATEBUFFER  gpMapiAllocateBuffer = NULL;</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineminus">-LPMAPIFREEBUFFER    gpMapiFreeBuffer = NULL;</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineminus">-LPMAPILOGONEX      gpMapiLogonEx = NULL;</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineminus">-LPOPENSTREAMONFILE    gpMapiOpenStreamOnFile = NULL;</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineplus">+LPMAPIUNINITIALIZE gpMapiUninitialize = NULL;</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineplus">+LPMAPIINITIALIZE gpMapiInitialize = NULL;</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineplus">+LPMAPIALLOCATEBUFFER gpMapiAllocateBuffer = NULL;</span>
<a href="#l20.44"></a><span id="l20.44" class="difflineplus">+LPMAPIFREEBUFFER gpMapiFreeBuffer = NULL;</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineplus">+LPMAPILOGONEX gpMapiLogonEx = NULL;</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineplus">+LPOPENSTREAMONFILE gpMapiOpenStreamOnFile = NULL;</span>
<a href="#l20.47"></a><span id="l20.47"> </span>
<a href="#l20.48"></a><span id="l20.48" class="difflineminus">-typedef HRESULT (STDMETHODCALLTYPE WRAPCOMPRESSEDRTFSTREAM) (</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineminus">-  LPSTREAM lpCompressedRTFStream, ULONG ulFlags, LPSTREAM FAR *lpUncompressedRTFStream);</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineplus">+typedef HRESULT(STDMETHODCALLTYPE WRAPCOMPRESSEDRTFSTREAM)(</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineplus">+    LPSTREAM lpCompressedRTFStream, ULONG ulFlags,</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineplus">+    LPSTREAM FAR *lpUncompressedRTFStream);</span>
<a href="#l20.53"></a><span id="l20.53"> typedef WRAPCOMPRESSEDRTFSTREAM *LPWRAPCOMPRESSEDRTFSTREAM;</span>
<a href="#l20.54"></a><span id="l20.54"> LPWRAPCOMPRESSEDRTFSTREAM gpWrapCompressedRTFStream = NULL;</span>
<a href="#l20.55"></a><span id="l20.55"> </span>
<a href="#l20.56"></a><span id="l20.56" class="difflineminus">-// WrapCompressedRTFStreamEx related stuff - see http://support.microsoft.com/kb/839560</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineplus">+// WrapCompressedRTFStreamEx related stuff - see</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineplus">+// http://support.microsoft.com/kb/839560</span>
<a href="#l20.59"></a><span id="l20.59"> typedef struct {</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineminus">-  ULONG       size;</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineminus">-  ULONG       ulFlags;</span>
<a href="#l20.62"></a><span id="l20.62" class="difflineminus">-  ULONG       ulInCodePage;</span>
<a href="#l20.63"></a><span id="l20.63" class="difflineminus">-  ULONG       ulOutCodePage;</span>
<a href="#l20.64"></a><span id="l20.64" class="difflineplus">+  ULONG size;</span>
<a href="#l20.65"></a><span id="l20.65" class="difflineplus">+  ULONG ulFlags;</span>
<a href="#l20.66"></a><span id="l20.66" class="difflineplus">+  ULONG ulInCodePage;</span>
<a href="#l20.67"></a><span id="l20.67" class="difflineplus">+  ULONG ulOutCodePage;</span>
<a href="#l20.68"></a><span id="l20.68"> } RTF_WCSINFO;</span>
<a href="#l20.69"></a><span id="l20.69"> typedef struct {</span>
<a href="#l20.70"></a><span id="l20.70" class="difflineminus">-  ULONG       size;</span>
<a href="#l20.71"></a><span id="l20.71" class="difflineminus">-  ULONG       ulStreamFlags;</span>
<a href="#l20.72"></a><span id="l20.72" class="difflineplus">+  ULONG size;</span>
<a href="#l20.73"></a><span id="l20.73" class="difflineplus">+  ULONG ulStreamFlags;</span>
<a href="#l20.74"></a><span id="l20.74"> } RTF_WCSRETINFO;</span>
<a href="#l20.75"></a><span id="l20.75"> </span>
<a href="#l20.76"></a><span id="l20.76" class="difflineminus">-typedef HRESULT (STDMETHODCALLTYPE WRAPCOMPRESSEDRTFSTREAMEX) (</span>
<a href="#l20.77"></a><span id="l20.77" class="difflineminus">-  LPSTREAM lpCompressedRTFStream, CONST RTF_WCSINFO * pWCSInfo,</span>
<a href="#l20.78"></a><span id="l20.78" class="difflineminus">-  LPSTREAM * lppUncompressedRTFStream, RTF_WCSRETINFO * pRetInfo);</span>
<a href="#l20.79"></a><span id="l20.79" class="difflineplus">+typedef HRESULT(STDMETHODCALLTYPE WRAPCOMPRESSEDRTFSTREAMEX)(</span>
<a href="#l20.80"></a><span id="l20.80" class="difflineplus">+    LPSTREAM lpCompressedRTFStream, CONST RTF_WCSINFO *pWCSInfo,</span>
<a href="#l20.81"></a><span id="l20.81" class="difflineplus">+    LPSTREAM *lppUncompressedRTFStream, RTF_WCSRETINFO *pRetInfo);</span>
<a href="#l20.82"></a><span id="l20.82"> typedef WRAPCOMPRESSEDRTFSTREAMEX *LPWRAPCOMPRESSEDRTFSTREAMEX;</span>
<a href="#l20.83"></a><span id="l20.83"> LPWRAPCOMPRESSEDRTFSTREAMEX gpWrapCompressedRTFStreamEx = NULL;</span>
<a href="#l20.84"></a><span id="l20.84"> </span>
<a href="#l20.85"></a><span id="l20.85" class="difflineminus">-BOOL CMapiApi::LoadMapiEntryPoints(void)</span>
<a href="#l20.86"></a><span id="l20.86" class="difflineminus">-{</span>
<a href="#l20.87"></a><span id="l20.87" class="difflineminus">-  if (!(gpMapiUninitialize = (LPMAPIUNINITIALIZE) GetProcAddress(</span>
<a href="#l20.88"></a><span id="l20.88" class="difflineminus">-      m_hMapi32, &quot;MAPIUninitialize&quot;)))</span>
<a href="#l20.89"></a><span id="l20.89" class="difflineplus">+BOOL CMapiApi::LoadMapiEntryPoints(void) {</span>
<a href="#l20.90"></a><span id="l20.90" class="difflineplus">+  if (!(gpMapiUninitialize =</span>
<a href="#l20.91"></a><span id="l20.91" class="difflineplus">+            (LPMAPIUNINITIALIZE)GetProcAddress(m_hMapi32, &quot;MAPIUninitialize&quot;)))</span>
<a href="#l20.92"></a><span id="l20.92">     return FALSE;</span>
<a href="#l20.93"></a><span id="l20.93" class="difflineminus">-  if (!(gpMapiInitialize = (LPMAPIINITIALIZE) GetProcAddress(</span>
<a href="#l20.94"></a><span id="l20.94" class="difflineminus">-      m_hMapi32, &quot;MAPIInitialize&quot;)))</span>
<a href="#l20.95"></a><span id="l20.95" class="difflineplus">+  if (!(gpMapiInitialize =</span>
<a href="#l20.96"></a><span id="l20.96" class="difflineplus">+            (LPMAPIINITIALIZE)GetProcAddress(m_hMapi32, &quot;MAPIInitialize&quot;)))</span>
<a href="#l20.97"></a><span id="l20.97">     return FALSE;</span>
<a href="#l20.98"></a><span id="l20.98" class="difflineminus">-  if (!(gpMapiAllocateBuffer = (LPMAPIALLOCATEBUFFER) GetProcAddress(</span>
<a href="#l20.99"></a><span id="l20.99" class="difflineminus">-      m_hMapi32, &quot;MAPIAllocateBuffer&quot;)))</span>
<a href="#l20.100"></a><span id="l20.100" class="difflineplus">+  if (!(gpMapiAllocateBuffer = (LPMAPIALLOCATEBUFFER)GetProcAddress(</span>
<a href="#l20.101"></a><span id="l20.101" class="difflineplus">+            m_hMapi32, &quot;MAPIAllocateBuffer&quot;)))</span>
<a href="#l20.102"></a><span id="l20.102">     return FALSE;</span>
<a href="#l20.103"></a><span id="l20.103" class="difflineminus">-  if (!(gpMapiFreeBuffer = (LPMAPIFREEBUFFER) GetProcAddress(</span>
<a href="#l20.104"></a><span id="l20.104" class="difflineminus">-      m_hMapi32, &quot;MAPIFreeBuffer&quot;)))</span>
<a href="#l20.105"></a><span id="l20.105" class="difflineplus">+  if (!(gpMapiFreeBuffer =</span>
<a href="#l20.106"></a><span id="l20.106" class="difflineplus">+            (LPMAPIFREEBUFFER)GetProcAddress(m_hMapi32, &quot;MAPIFreeBuffer&quot;)))</span>
<a href="#l20.107"></a><span id="l20.107">     return FALSE;</span>
<a href="#l20.108"></a><span id="l20.108" class="difflineminus">-  if (!(gpMapiLogonEx = (LPMAPILOGONEX) GetProcAddress(m_hMapi32,</span>
<a href="#l20.109"></a><span id="l20.109" class="difflineminus">-                                                       &quot;MAPILogonEx&quot;)))</span>
<a href="#l20.110"></a><span id="l20.110" class="difflineplus">+  if (!(gpMapiLogonEx =</span>
<a href="#l20.111"></a><span id="l20.111" class="difflineplus">+            (LPMAPILOGONEX)GetProcAddress(m_hMapi32, &quot;MAPILogonEx&quot;)))</span>
<a href="#l20.112"></a><span id="l20.112">     return FALSE;</span>
<a href="#l20.113"></a><span id="l20.113" class="difflineminus">-  if (!(gpMapiOpenStreamOnFile = (LPOPENSTREAMONFILE) GetProcAddress(</span>
<a href="#l20.114"></a><span id="l20.114" class="difflineminus">-      m_hMapi32, &quot;OpenStreamOnFile&quot;)))</span>
<a href="#l20.115"></a><span id="l20.115" class="difflineplus">+  if (!(gpMapiOpenStreamOnFile =</span>
<a href="#l20.116"></a><span id="l20.116" class="difflineplus">+            (LPOPENSTREAMONFILE)GetProcAddress(m_hMapi32, &quot;OpenStreamOnFile&quot;)))</span>
<a href="#l20.117"></a><span id="l20.117">     return FALSE;</span>
<a href="#l20.118"></a><span id="l20.118"> </span>
<a href="#l20.119"></a><span id="l20.119" class="difflineminus">-  // Available from the Outlook 2002 post-SP3 hotfix (http://support.microsoft.com/kb/883924/)</span>
<a href="#l20.120"></a><span id="l20.120" class="difflineminus">-  // Exported by msmapi32.dll; so it's unavailable to us using mapi32.dll</span>
<a href="#l20.121"></a><span id="l20.121" class="difflineminus">-  gpWrapCompressedRTFStreamEx = (LPWRAPCOMPRESSEDRTFSTREAMEX) GetProcAddress(</span>
<a href="#l20.122"></a><span id="l20.122" class="difflineminus">-    m_hMapi32, &quot;WrapCompressedRTFStreamEx&quot;);</span>
<a href="#l20.123"></a><span id="l20.123" class="difflineplus">+  // Available from the Outlook 2002 post-SP3 hotfix</span>
<a href="#l20.124"></a><span id="l20.124" class="difflineplus">+  // (http://support.microsoft.com/kb/883924/) Exported by msmapi32.dll; so it's</span>
<a href="#l20.125"></a><span id="l20.125" class="difflineplus">+  // unavailable to us using mapi32.dll</span>
<a href="#l20.126"></a><span id="l20.126" class="difflineplus">+  gpWrapCompressedRTFStreamEx = (LPWRAPCOMPRESSEDRTFSTREAMEX)GetProcAddress(</span>
<a href="#l20.127"></a><span id="l20.127" class="difflineplus">+      m_hMapi32, &quot;WrapCompressedRTFStreamEx&quot;);</span>
<a href="#l20.128"></a><span id="l20.128">   // Available always</span>
<a href="#l20.129"></a><span id="l20.129" class="difflineminus">-  gpWrapCompressedRTFStream = (LPWRAPCOMPRESSEDRTFSTREAM) GetProcAddress(</span>
<a href="#l20.130"></a><span id="l20.130" class="difflineminus">-    m_hMapi32, &quot;WrapCompressedRTFStream&quot;);</span>
<a href="#l20.131"></a><span id="l20.131" class="difflineplus">+  gpWrapCompressedRTFStream = (LPWRAPCOMPRESSEDRTFSTREAM)GetProcAddress(</span>
<a href="#l20.132"></a><span id="l20.132" class="difflineplus">+      m_hMapi32, &quot;WrapCompressedRTFStream&quot;);</span>
<a href="#l20.133"></a><span id="l20.133"> </span>
<a href="#l20.134"></a><span id="l20.134">   return TRUE;</span>
<a href="#l20.135"></a><span id="l20.135"> }</span>
<a href="#l20.136"></a><span id="l20.136"> </span>
<a href="#l20.137"></a><span id="l20.137"> // Gets the PR_RTF_COMPRESSED tag property</span>
<a href="#l20.138"></a><span id="l20.138"> // Codepage is used only if the WrapCompressedRTFStreamEx is available</span>
<a href="#l20.139"></a><span id="l20.139" class="difflineminus">-BOOL CMapiApi::GetRTFPropertyDecodedAsUTF16(LPMAPIPROP pProp, nsString&amp; val,</span>
<a href="#l20.140"></a><span id="l20.140" class="difflineminus">-                                            unsigned long&amp; nativeBodyType,</span>
<a href="#l20.141"></a><span id="l20.141" class="difflineminus">-                                            unsigned long codepage)</span>
<a href="#l20.142"></a><span id="l20.142" class="difflineminus">-{</span>
<a href="#l20.143"></a><span id="l20.143" class="difflineplus">+BOOL CMapiApi::GetRTFPropertyDecodedAsUTF16(LPMAPIPROP pProp, nsString &amp;val,</span>
<a href="#l20.144"></a><span id="l20.144" class="difflineplus">+                                            unsigned long &amp;nativeBodyType,</span>
<a href="#l20.145"></a><span id="l20.145" class="difflineplus">+                                            unsigned long codepage) {</span>
<a href="#l20.146"></a><span id="l20.146">   if (!m_hMapi32 || !(gpWrapCompressedRTFStreamEx || gpWrapCompressedRTFStream))</span>
<a href="#l20.147"></a><span id="l20.147" class="difflineminus">-    return FALSE; // Fallback to the default processing</span>
<a href="#l20.148"></a><span id="l20.148" class="difflineplus">+    return FALSE;  // Fallback to the default processing</span>
<a href="#l20.149"></a><span id="l20.149"> </span>
<a href="#l20.150"></a><span id="l20.150" class="difflineminus">-  LPSTREAM icstream = 0; // for the compressed stream</span>
<a href="#l20.151"></a><span id="l20.151" class="difflineminus">-  LPSTREAM iunstream = 0; // for the uncompressed stream</span>
<a href="#l20.152"></a><span id="l20.152" class="difflineminus">-  HRESULT hr = pProp-&gt;OpenProperty(PR_RTF_COMPRESSED,</span>
<a href="#l20.153"></a><span id="l20.153" class="difflineminus">-                                   &amp;IID_IStream, STGM_READ | STGM_DIRECT,</span>
<a href="#l20.154"></a><span id="l20.154" class="difflineminus">-                                   0, (LPUNKNOWN *)&amp;icstream);</span>
<a href="#l20.155"></a><span id="l20.155" class="difflineminus">-  if (HR_FAILED(hr))</span>
<a href="#l20.156"></a><span id="l20.156" class="difflineminus">-    return FALSE;</span>
<a href="#l20.157"></a><span id="l20.157" class="difflineplus">+  LPSTREAM icstream = 0;   // for the compressed stream</span>
<a href="#l20.158"></a><span id="l20.158" class="difflineplus">+  LPSTREAM iunstream = 0;  // for the uncompressed stream</span>
<a href="#l20.159"></a><span id="l20.159" class="difflineplus">+  HRESULT hr =</span>
<a href="#l20.160"></a><span id="l20.160" class="difflineplus">+      pProp-&gt;OpenProperty(PR_RTF_COMPRESSED, &amp;IID_IStream,</span>
<a href="#l20.161"></a><span id="l20.161" class="difflineplus">+                          STGM_READ | STGM_DIRECT, 0, (LPUNKNOWN *)&amp;icstream);</span>
<a href="#l20.162"></a><span id="l20.162" class="difflineplus">+  if (HR_FAILED(hr)) return FALSE;</span>
<a href="#l20.163"></a><span id="l20.163"> </span>
<a href="#l20.164"></a><span id="l20.164" class="difflineminus">-  if (gpWrapCompressedRTFStreamEx) { // Impossible - we use mapi32.dll!</span>
<a href="#l20.165"></a><span id="l20.165" class="difflineminus">-    RTF_WCSINFO     wcsinfo = {0};</span>
<a href="#l20.166"></a><span id="l20.166" class="difflineminus">-    RTF_WCSRETINFO  retinfo = {0};</span>
<a href="#l20.167"></a><span id="l20.167" class="difflineplus">+  if (gpWrapCompressedRTFStreamEx) {  // Impossible - we use mapi32.dll!</span>
<a href="#l20.168"></a><span id="l20.168" class="difflineplus">+    RTF_WCSINFO wcsinfo = {0};</span>
<a href="#l20.169"></a><span id="l20.169" class="difflineplus">+    RTF_WCSRETINFO retinfo = {0};</span>
<a href="#l20.170"></a><span id="l20.170"> </span>
<a href="#l20.171"></a><span id="l20.171">     retinfo.size = sizeof(RTF_WCSRETINFO);</span>
<a href="#l20.172"></a><span id="l20.172"> </span>
<a href="#l20.173"></a><span id="l20.173">     wcsinfo.size = sizeof(RTF_WCSINFO);</span>
<a href="#l20.174"></a><span id="l20.174">     wcsinfo.ulFlags = MAPI_NATIVE_BODY;</span>
<a href="#l20.175"></a><span id="l20.175">     wcsinfo.ulInCodePage = codepage;</span>
<a href="#l20.176"></a><span id="l20.176">     wcsinfo.ulOutCodePage = CP_UTF8;</span>
<a href="#l20.177"></a><span id="l20.177"> </span>
<a href="#l20.178"></a><span id="l20.178" class="difflineminus">-    if(HR_SUCCEEDED(hr = gpWrapCompressedRTFStreamEx(icstream, &amp;wcsinfo,</span>
<a href="#l20.179"></a><span id="l20.179" class="difflineminus">-                                                     &amp;iunstream, &amp;retinfo)))</span>
<a href="#l20.180"></a><span id="l20.180" class="difflineplus">+    if (HR_SUCCEEDED(hr = gpWrapCompressedRTFStreamEx(icstream, &amp;wcsinfo,</span>
<a href="#l20.181"></a><span id="l20.181" class="difflineplus">+                                                      &amp;iunstream, &amp;retinfo)))</span>
<a href="#l20.182"></a><span id="l20.182">       nativeBodyType = retinfo.ulStreamFlags;</span>
<a href="#l20.183"></a><span id="l20.183" class="difflineminus">-  }</span>
<a href="#l20.184"></a><span id="l20.184" class="difflineminus">-  else { // mapi32.dll</span>
<a href="#l20.185"></a><span id="l20.185" class="difflineminus">-    gpWrapCompressedRTFStream(icstream,0,&amp;iunstream);</span>
<a href="#l20.186"></a><span id="l20.186" class="difflineplus">+  } else {  // mapi32.dll</span>
<a href="#l20.187"></a><span id="l20.187" class="difflineplus">+    gpWrapCompressedRTFStream(icstream, 0, &amp;iunstream);</span>
<a href="#l20.188"></a><span id="l20.188">   }</span>
<a href="#l20.189"></a><span id="l20.189">   icstream-&gt;Release();</span>
<a href="#l20.190"></a><span id="l20.190"> </span>
<a href="#l20.191"></a><span id="l20.191" class="difflineminus">-  if(iunstream) { // Succeeded</span>
<a href="#l20.192"></a><span id="l20.192" class="difflineplus">+  if (iunstream) {  // Succeeded</span>
<a href="#l20.193"></a><span id="l20.193">     std::string streamData;</span>
<a href="#l20.194"></a><span id="l20.194">     // Stream.Stat doesn't work for this stream!</span>
<a href="#l20.195"></a><span id="l20.195">     bool done = false;</span>
<a href="#l20.196"></a><span id="l20.196">     while (!done) {</span>
<a href="#l20.197"></a><span id="l20.197" class="difflineminus">-      // I think 10K is a good guess to minimize the number of reads while keeping memory usage low</span>
<a href="#l20.198"></a><span id="l20.198" class="difflineplus">+      // I think 10K is a good guess to minimize the number of reads while</span>
<a href="#l20.199"></a><span id="l20.199" class="difflineplus">+      // keeping memory usage low</span>
<a href="#l20.200"></a><span id="l20.200">       const int bufsize = 10240;</span>
<a href="#l20.201"></a><span id="l20.201">       char buf[bufsize];</span>
<a href="#l20.202"></a><span id="l20.202">       ULONG read;</span>
<a href="#l20.203"></a><span id="l20.203">       hr = iunstream-&gt;Read(buf, bufsize, &amp;read);</span>
<a href="#l20.204"></a><span id="l20.204">       done = (read &lt; bufsize) || (hr != S_OK);</span>
<a href="#l20.205"></a><span id="l20.205" class="difflineminus">-      if (read)</span>
<a href="#l20.206"></a><span id="l20.206" class="difflineminus">-        streamData.append(buf, read);</span>
<a href="#l20.207"></a><span id="l20.207" class="difflineplus">+      if (read) streamData.append(buf, read);</span>
<a href="#l20.208"></a><span id="l20.208">     }</span>
<a href="#l20.209"></a><span id="l20.209">     iunstream-&gt;Release();</span>
<a href="#l20.210"></a><span id="l20.210">     // if rtf -&gt; convert to plain text.</span>
<a href="#l20.211"></a><span id="l20.211">     if (!gpWrapCompressedRTFStreamEx ||</span>
<a href="#l20.212"></a><span id="l20.212" class="difflineminus">-        (nativeBodyType==MAPI_NATIVE_BODY_TYPE_RTF)) {</span>
<a href="#l20.213"></a><span id="l20.213" class="difflineplus">+        (nativeBodyType == MAPI_NATIVE_BODY_TYPE_RTF)) {</span>
<a href="#l20.214"></a><span id="l20.214">       std::stringstream s(streamData);</span>
<a href="#l20.215"></a><span id="l20.215">       CRTFMailDecoder decoder;</span>
<a href="#l20.216"></a><span id="l20.216">       DecodeRTF(s, decoder);</span>
<a href="#l20.217"></a><span id="l20.217">       if (decoder.mode() == CRTFMailDecoder::mHTML)</span>
<a href="#l20.218"></a><span id="l20.218">         nativeBodyType = MAPI_NATIVE_BODY_TYPE_HTML;</span>
<a href="#l20.219"></a><span id="l20.219">       else if (decoder.mode() == CRTFMailDecoder::mText)</span>
<a href="#l20.220"></a><span id="l20.220">         nativeBodyType = MAPI_NATIVE_BODY_TYPE_PLAINTEXT;</span>
<a href="#l20.221"></a><span id="l20.221">       else</span>
<a href="#l20.222"></a><span id="l20.222">         nativeBodyType = MAPI_NATIVE_BODY_TYPE_RTF;</span>
<a href="#l20.223"></a><span id="l20.223">       val.Assign(decoder.text(), decoder.textSize());</span>
<a href="#l20.224"></a><span id="l20.224" class="difflineminus">-    }</span>
<a href="#l20.225"></a><span id="l20.225" class="difflineminus">-    else { // WrapCompressedRTFStreamEx available and original type is not rtf</span>
<a href="#l20.226"></a><span id="l20.226" class="difflineplus">+    } else {  // WrapCompressedRTFStreamEx available and original type is not</span>
<a href="#l20.227"></a><span id="l20.227" class="difflineplus">+              // rtf</span>
<a href="#l20.228"></a><span id="l20.228">       CopyUTF8toUTF16(nsDependentCString(streamData.c_str()), val);</span>
<a href="#l20.229"></a><span id="l20.229">     }</span>
<a href="#l20.230"></a><span id="l20.230">     return TRUE;</span>
<a href="#l20.231"></a><span id="l20.231">   }</span>
<a href="#l20.232"></a><span id="l20.232">   return FALSE;</span>
<a href="#l20.233"></a><span id="l20.233"> }</span>
<a href="#l20.234"></a><span id="l20.234"> </span>
<a href="#l20.235"></a><span id="l20.235" class="difflineminus">-void CMapiApi::MAPIUninitialize(void)</span>
<a href="#l20.236"></a><span id="l20.236" class="difflineminus">-{</span>
<a href="#l20.237"></a><span id="l20.237" class="difflineminus">-  if (m_hMapi32 &amp;&amp; gpMapiUninitialize)</span>
<a href="#l20.238"></a><span id="l20.238" class="difflineminus">-    (*gpMapiUninitialize)();</span>
<a href="#l20.239"></a><span id="l20.239" class="difflineplus">+void CMapiApi::MAPIUninitialize(void) {</span>
<a href="#l20.240"></a><span id="l20.240" class="difflineplus">+  if (m_hMapi32 &amp;&amp; gpMapiUninitialize) (*gpMapiUninitialize)();</span>
<a href="#l20.241"></a><span id="l20.241" class="difflineplus">+}</span>
<a href="#l20.242"></a><span id="l20.242" class="difflineplus">+</span>
<a href="#l20.243"></a><span id="l20.243" class="difflineplus">+HRESULT CMapiApi::MAPIInitialize(LPVOID lpInit) {</span>
<a href="#l20.244"></a><span id="l20.244" class="difflineplus">+  return (m_hMapi32 &amp;&amp; gpMapiInitialize) ? (*gpMapiInitialize)(lpInit)</span>
<a href="#l20.245"></a><span id="l20.245" class="difflineplus">+                                         : MAPI_E_NOT_INITIALIZED;</span>
<a href="#l20.246"></a><span id="l20.246"> }</span>
<a href="#l20.247"></a><span id="l20.247"> </span>
<a href="#l20.248"></a><span id="l20.248" class="difflineminus">-HRESULT CMapiApi::MAPIInitialize(LPVOID lpInit)</span>
<a href="#l20.249"></a><span id="l20.249" class="difflineminus">-{</span>
<a href="#l20.250"></a><span id="l20.250" class="difflineminus">-  return (m_hMapi32 &amp;&amp; gpMapiInitialize) ? (*gpMapiInitialize)(lpInit) :</span>
<a href="#l20.251"></a><span id="l20.251" class="difflineminus">-          MAPI_E_NOT_INITIALIZED;</span>
<a href="#l20.252"></a><span id="l20.252" class="difflineplus">+SCODE CMapiApi::MAPIAllocateBuffer(ULONG cbSize, LPVOID FAR *lppBuffer) {</span>
<a href="#l20.253"></a><span id="l20.253" class="difflineplus">+  return (m_hMapi32 &amp;&amp; gpMapiAllocateBuffer)</span>
<a href="#l20.254"></a><span id="l20.254" class="difflineplus">+             ? (*gpMapiAllocateBuffer)(cbSize, lppBuffer)</span>
<a href="#l20.255"></a><span id="l20.255" class="difflineplus">+             : MAPI_E_NOT_INITIALIZED;</span>
<a href="#l20.256"></a><span id="l20.256"> }</span>
<a href="#l20.257"></a><span id="l20.257"> </span>
<a href="#l20.258"></a><span id="l20.258" class="difflineminus">-SCODE CMapiApi::MAPIAllocateBuffer(ULONG cbSize, LPVOID FAR * lppBuffer)</span>
<a href="#l20.259"></a><span id="l20.259" class="difflineminus">-{</span>
<a href="#l20.260"></a><span id="l20.260" class="difflineminus">-  return (m_hMapi32 &amp;&amp; gpMapiAllocateBuffer) ?</span>
<a href="#l20.261"></a><span id="l20.261" class="difflineminus">-          (*gpMapiAllocateBuffer)(cbSize, lppBuffer) : MAPI_E_NOT_INITIALIZED;</span>
<a href="#l20.262"></a><span id="l20.262" class="difflineminus">-}</span>
<a href="#l20.263"></a><span id="l20.263" class="difflineminus">-</span>
<a href="#l20.264"></a><span id="l20.264" class="difflineminus">-ULONG CMapiApi::MAPIFreeBuffer(LPVOID lpBuff)</span>
<a href="#l20.265"></a><span id="l20.265" class="difflineminus">-{</span>
<a href="#l20.266"></a><span id="l20.266" class="difflineminus">-  return (m_hMapi32 &amp;&amp; gpMapiFreeBuffer) ? (*gpMapiFreeBuffer)(lpBuff) :</span>
<a href="#l20.267"></a><span id="l20.267" class="difflineminus">-          MAPI_E_NOT_INITIALIZED;</span>
<a href="#l20.268"></a><span id="l20.268" class="difflineplus">+ULONG CMapiApi::MAPIFreeBuffer(LPVOID lpBuff) {</span>
<a href="#l20.269"></a><span id="l20.269" class="difflineplus">+  return (m_hMapi32 &amp;&amp; gpMapiFreeBuffer) ? (*gpMapiFreeBuffer)(lpBuff)</span>
<a href="#l20.270"></a><span id="l20.270" class="difflineplus">+                                         : MAPI_E_NOT_INITIALIZED;</span>
<a href="#l20.271"></a><span id="l20.271"> }</span>
<a href="#l20.272"></a><span id="l20.272"> </span>
<a href="#l20.273"></a><span id="l20.273"> HRESULT CMapiApi::MAPILogonEx(ULONG ulUIParam, LPTSTR lpszProfileName,</span>
<a href="#l20.274"></a><span id="l20.274">                               LPTSTR lpszPassword, FLAGS flFlags,</span>
<a href="#l20.275"></a><span id="l20.275" class="difflineminus">-                              LPMAPISESSION FAR * lppSession)</span>
<a href="#l20.276"></a><span id="l20.276" class="difflineminus">-{</span>
<a href="#l20.277"></a><span id="l20.277" class="difflineminus">-  return (m_hMapi32 &amp;&amp; gpMapiLogonEx) ?</span>
<a href="#l20.278"></a><span id="l20.278" class="difflineminus">-    (*gpMapiLogonEx)(ulUIParam, lpszProfileName, lpszPassword, flFlags, lppSession) :</span>
<a href="#l20.279"></a><span id="l20.279" class="difflineminus">-     MAPI_E_NOT_INITIALIZED;</span>
<a href="#l20.280"></a><span id="l20.280" class="difflineplus">+                              LPMAPISESSION FAR *lppSession) {</span>
<a href="#l20.281"></a><span id="l20.281" class="difflineplus">+  return (m_hMapi32 &amp;&amp; gpMapiLogonEx)</span>
<a href="#l20.282"></a><span id="l20.282" class="difflineplus">+             ? (*gpMapiLogonEx)(ulUIParam, lpszProfileName, lpszPassword,</span>
<a href="#l20.283"></a><span id="l20.283" class="difflineplus">+                                flFlags, lppSession)</span>
<a href="#l20.284"></a><span id="l20.284" class="difflineplus">+             : MAPI_E_NOT_INITIALIZED;</span>
<a href="#l20.285"></a><span id="l20.285"> }</span>
<a href="#l20.286"></a><span id="l20.286"> </span>
<a href="#l20.287"></a><span id="l20.287"> HRESULT CMapiApi::OpenStreamOnFile(LPALLOCATEBUFFER lpAllocateBuffer,</span>
<a href="#l20.288"></a><span id="l20.288">                                    LPFREEBUFFER lpFreeBuffer, ULONG ulFlags,</span>
<a href="#l20.289"></a><span id="l20.289">                                    LPCTSTR lpszFileName, LPTSTR lpszPrefix,</span>
<a href="#l20.290"></a><span id="l20.290" class="difflineminus">-                                   LPSTREAM FAR * lppStream)</span>
<a href="#l20.291"></a><span id="l20.291" class="difflineminus">-{</span>
<a href="#l20.292"></a><span id="l20.292" class="difflineminus">-  return (m_hMapi32 &amp;&amp; gpMapiOpenStreamOnFile) ?</span>
<a href="#l20.293"></a><span id="l20.293" class="difflineminus">-    (*gpMapiOpenStreamOnFile)(lpAllocateBuffer, lpFreeBuffer, ulFlags,</span>
<a href="#l20.294"></a><span id="l20.294" class="difflineminus">-                              lpszFileName, lpszPrefix, lppStream) :</span>
<a href="#l20.295"></a><span id="l20.295" class="difflineminus">-    MAPI_E_NOT_INITIALIZED;</span>
<a href="#l20.296"></a><span id="l20.296" class="difflineplus">+                                   LPSTREAM FAR *lppStream) {</span>
<a href="#l20.297"></a><span id="l20.297" class="difflineplus">+  return (m_hMapi32 &amp;&amp; gpMapiOpenStreamOnFile)</span>
<a href="#l20.298"></a><span id="l20.298" class="difflineplus">+             ? (*gpMapiOpenStreamOnFile)(lpAllocateBuffer, lpFreeBuffer,</span>
<a href="#l20.299"></a><span id="l20.299" class="difflineplus">+                                         ulFlags, lpszFileName, lpszPrefix,</span>
<a href="#l20.300"></a><span id="l20.300" class="difflineplus">+                                         lppStream)</span>
<a href="#l20.301"></a><span id="l20.301" class="difflineplus">+             : MAPI_E_NOT_INITIALIZED;</span>
<a href="#l20.302"></a><span id="l20.302"> }</span>
<a href="#l20.303"></a><span id="l20.303"> </span>
<a href="#l20.304"></a><span id="l20.304" class="difflineminus">-void CMapiApi::FreeProws(LPSRowSet prows)</span>
<a href="#l20.305"></a><span id="l20.305" class="difflineminus">-{</span>
<a href="#l20.306"></a><span id="l20.306" class="difflineminus">-  ULONG    irow;</span>
<a href="#l20.307"></a><span id="l20.307" class="difflineminus">-  if (!prows)</span>
<a href="#l20.308"></a><span id="l20.308" class="difflineminus">-    return;</span>
<a href="#l20.309"></a><span id="l20.309" class="difflineplus">+void CMapiApi::FreeProws(LPSRowSet prows) {</span>
<a href="#l20.310"></a><span id="l20.310" class="difflineplus">+  ULONG irow;</span>
<a href="#l20.311"></a><span id="l20.311" class="difflineplus">+  if (!prows) return;</span>
<a href="#l20.312"></a><span id="l20.312">   for (irow = 0; irow &lt; prows-&gt;cRows; ++irow)</span>
<a href="#l20.313"></a><span id="l20.313">     MAPIFreeBuffer(prows-&gt;aRow[irow].lpProps);</span>
<a href="#l20.314"></a><span id="l20.314">   MAPIFreeBuffer(prows);</span>
<a href="#l20.315"></a><span id="l20.315"> }</span>
<a href="#l20.316"></a><span id="l20.316"> </span>
<a href="#l20.317"></a><span id="l20.317" class="difflineminus">-BOOL CMapiApi::LoadMapi(void)</span>
<a href="#l20.318"></a><span id="l20.318" class="difflineminus">-{</span>
<a href="#l20.319"></a><span id="l20.319" class="difflineminus">-  if (m_hMapi32)</span>
<a href="#l20.320"></a><span id="l20.320" class="difflineminus">-    return TRUE;</span>
<a href="#l20.321"></a><span id="l20.321" class="difflineplus">+BOOL CMapiApi::LoadMapi(void) {</span>
<a href="#l20.322"></a><span id="l20.322" class="difflineplus">+  if (m_hMapi32) return TRUE;</span>
<a href="#l20.323"></a><span id="l20.323"> </span>
<a href="#l20.324"></a><span id="l20.324" class="difflineminus">-  HINSTANCE  hInst = ::LoadLibrary(&quot;MAPI32.DLL&quot;);</span>
<a href="#l20.325"></a><span id="l20.325" class="difflineminus">-  if (!hInst)</span>
<a href="#l20.326"></a><span id="l20.326" class="difflineminus">-    return FALSE;</span>
<a href="#l20.327"></a><span id="l20.327" class="difflineplus">+  HINSTANCE hInst = ::LoadLibrary(&quot;MAPI32.DLL&quot;);</span>
<a href="#l20.328"></a><span id="l20.328" class="difflineplus">+  if (!hInst) return FALSE;</span>
<a href="#l20.329"></a><span id="l20.329">   FARPROC pProc = GetProcAddress(hInst, &quot;MAPIGetNetscapeVersion&quot;);</span>
<a href="#l20.330"></a><span id="l20.330">   if (pProc) {</span>
<a href="#l20.331"></a><span id="l20.331">     ::FreeLibrary(hInst);</span>
<a href="#l20.332"></a><span id="l20.332">     hInst = ::LoadLibrary(&quot;MAPI32BAK.DLL&quot;);</span>
<a href="#l20.333"></a><span id="l20.333" class="difflineminus">-    if (!hInst)</span>
<a href="#l20.334"></a><span id="l20.334" class="difflineminus">-      return FALSE;</span>
<a href="#l20.335"></a><span id="l20.335" class="difflineplus">+    if (!hInst) return FALSE;</span>
<a href="#l20.336"></a><span id="l20.336">   }</span>
<a href="#l20.337"></a><span id="l20.337"> </span>
<a href="#l20.338"></a><span id="l20.338">   m_hMapi32 = hInst;</span>
<a href="#l20.339"></a><span id="l20.339">   return LoadMapiEntryPoints();</span>
<a href="#l20.340"></a><span id="l20.340"> }</span>
<a href="#l20.341"></a><span id="l20.341"> </span>
<a href="#l20.342"></a><span id="l20.342" class="difflineminus">-void CMapiApi::UnloadMapi(void)</span>
<a href="#l20.343"></a><span id="l20.343" class="difflineminus">-{</span>
<a href="#l20.344"></a><span id="l20.344" class="difflineminus">-  if (m_hMapi32)</span>
<a href="#l20.345"></a><span id="l20.345" class="difflineminus">-    ::FreeLibrary(m_hMapi32);</span>
<a href="#l20.346"></a><span id="l20.346" class="difflineplus">+void CMapiApi::UnloadMapi(void) {</span>
<a href="#l20.347"></a><span id="l20.347" class="difflineplus">+  if (m_hMapi32) ::FreeLibrary(m_hMapi32);</span>
<a href="#l20.348"></a><span id="l20.348">   m_hMapi32 = NULL;</span>
<a href="#l20.349"></a><span id="l20.349"> }</span>
<a href="#l20.350"></a><span id="l20.350"> </span>
<a href="#l20.351"></a><span id="l20.351" class="difflineminus">-CMapiApi::CMapiApi()</span>
<a href="#l20.352"></a><span id="l20.352" class="difflineminus">-{</span>
<a href="#l20.353"></a><span id="l20.353" class="difflineplus">+CMapiApi::CMapiApi() {</span>
<a href="#l20.354"></a><span id="l20.354">   m_clients++;</span>
<a href="#l20.355"></a><span id="l20.355">   LoadMapi();</span>
<a href="#l20.356"></a><span id="l20.356" class="difflineminus">-  if (!m_pStores)</span>
<a href="#l20.357"></a><span id="l20.357" class="difflineminus">-    m_pStores = new nsTArray&lt;CMsgStore*&gt;();</span>
<a href="#l20.358"></a><span id="l20.358" class="difflineplus">+  if (!m_pStores) m_pStores = new nsTArray&lt;CMsgStore *&gt;();</span>
<a href="#l20.359"></a><span id="l20.359"> }</span>
<a href="#l20.360"></a><span id="l20.360"> </span>
<a href="#l20.361"></a><span id="l20.361" class="difflineminus">-CMapiApi::~CMapiApi()</span>
<a href="#l20.362"></a><span id="l20.362" class="difflineminus">-{</span>
<a href="#l20.363"></a><span id="l20.363" class="difflineplus">+CMapiApi::~CMapiApi() {</span>
<a href="#l20.364"></a><span id="l20.364">   m_clients--;</span>
<a href="#l20.365"></a><span id="l20.365">   if (!m_clients) {</span>
<a href="#l20.366"></a><span id="l20.366" class="difflineminus">-    HRESULT  hr;</span>
<a href="#l20.367"></a><span id="l20.367" class="difflineplus">+    HRESULT hr;</span>
<a href="#l20.368"></a><span id="l20.368"> </span>
<a href="#l20.369"></a><span id="l20.369">     ClearMessageStores();</span>
<a href="#l20.370"></a><span id="l20.370">     delete m_pStores;</span>
<a href="#l20.371"></a><span id="l20.371">     m_pStores = NULL;</span>
<a href="#l20.372"></a><span id="l20.372"> </span>
<a href="#l20.373"></a><span id="l20.373">     m_lpMdb = NULL;</span>
<a href="#l20.374"></a><span id="l20.374"> </span>
<a href="#l20.375"></a><span id="l20.375">     if (m_lpSession) {</span>
<a href="#l20.376"></a><span id="l20.376" class="difflineat">@@ -282,331 +266,309 @@ CMapiApi::~CMapiApi()</span>
<a href="#l20.377"></a><span id="l20.377">       MAPIUninitialize();</span>
<a href="#l20.378"></a><span id="l20.378">       m_initialized = FALSE;</span>
<a href="#l20.379"></a><span id="l20.379">     }</span>
<a href="#l20.380"></a><span id="l20.380"> </span>
<a href="#l20.381"></a><span id="l20.381">     UnloadMapi();</span>
<a href="#l20.382"></a><span id="l20.382">   }</span>
<a href="#l20.383"></a><span id="l20.383"> }</span>
<a href="#l20.384"></a><span id="l20.384"> </span>
<a href="#l20.385"></a><span id="l20.385" class="difflineminus">-void CMapiApi::CStrToUnicode(const char *pStr, nsString&amp; result)</span>
<a href="#l20.386"></a><span id="l20.386" class="difflineminus">-{</span>
<a href="#l20.387"></a><span id="l20.387" class="difflineplus">+void CMapiApi::CStrToUnicode(const char *pStr, nsString &amp;result) {</span>
<a href="#l20.388"></a><span id="l20.388">   NS_CopyNativeToUnicode(nsDependentCString(pStr), result);</span>
<a href="#l20.389"></a><span id="l20.389"> }</span>
<a href="#l20.390"></a><span id="l20.390"> </span>
<a href="#l20.391"></a><span id="l20.391" class="difflineminus">-BOOL CMapiApi::Initialize(void)</span>
<a href="#l20.392"></a><span id="l20.392" class="difflineminus">-{</span>
<a href="#l20.393"></a><span id="l20.393" class="difflineminus">-  if (m_initialized)</span>
<a href="#l20.394"></a><span id="l20.394" class="difflineminus">-    return TRUE;</span>
<a href="#l20.395"></a><span id="l20.395" class="difflineplus">+BOOL CMapiApi::Initialize(void) {</span>
<a href="#l20.396"></a><span id="l20.396" class="difflineplus">+  if (m_initialized) return TRUE;</span>
<a href="#l20.397"></a><span id="l20.397"> </span>
<a href="#l20.398"></a><span id="l20.398" class="difflineminus">-  HRESULT    hr;</span>
<a href="#l20.399"></a><span id="l20.399" class="difflineplus">+  HRESULT hr;</span>
<a href="#l20.400"></a><span id="l20.400"> </span>
<a href="#l20.401"></a><span id="l20.401">   hr = MAPIInitialize(NULL);</span>
<a href="#l20.402"></a><span id="l20.402"> </span>
<a href="#l20.403"></a><span id="l20.403">   if (FAILED(hr)) {</span>
<a href="#l20.404"></a><span id="l20.404">     MAPI_TRACE2(&quot;MAPI Initialize failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l20.405"></a><span id="l20.405">     return FALSE;</span>
<a href="#l20.406"></a><span id="l20.406">   }</span>
<a href="#l20.407"></a><span id="l20.407"> </span>
<a href="#l20.408"></a><span id="l20.408">   m_initialized = TRUE;</span>
<a href="#l20.409"></a><span id="l20.409">   MAPI_TRACE0(&quot;MAPI Initialized\n&quot;);</span>
<a href="#l20.410"></a><span id="l20.410"> </span>
<a href="#l20.411"></a><span id="l20.411">   return TRUE;</span>
<a href="#l20.412"></a><span id="l20.412"> }</span>
<a href="#l20.413"></a><span id="l20.413"> </span>
<a href="#l20.414"></a><span id="l20.414" class="difflineminus">-BOOL CMapiApi::LogOn(void)</span>
<a href="#l20.415"></a><span id="l20.415" class="difflineminus">-{</span>
<a href="#l20.416"></a><span id="l20.416" class="difflineplus">+BOOL CMapiApi::LogOn(void) {</span>
<a href="#l20.417"></a><span id="l20.417">   if (!m_initialized) {</span>
<a href="#l20.418"></a><span id="l20.418">     MAPI_TRACE0(&quot;Tried to LogOn before initializing MAPI\n&quot;);</span>
<a href="#l20.419"></a><span id="l20.419">     return FALSE;</span>
<a href="#l20.420"></a><span id="l20.420">   }</span>
<a href="#l20.421"></a><span id="l20.421"> </span>
<a href="#l20.422"></a><span id="l20.422" class="difflineminus">-  if (m_lpSession)</span>
<a href="#l20.423"></a><span id="l20.423" class="difflineminus">-    return TRUE;</span>
<a href="#l20.424"></a><span id="l20.424" class="difflineplus">+  if (m_lpSession) return TRUE;</span>
<a href="#l20.425"></a><span id="l20.425"> </span>
<a href="#l20.426"></a><span id="l20.426">   HRESULT hr;</span>
<a href="#l20.427"></a><span id="l20.427"> </span>
<a href="#l20.428"></a><span id="l20.428" class="difflineminus">-  hr = MAPILogonEx( 0, // might need to be passed in HWND</span>
<a href="#l20.429"></a><span id="l20.429" class="difflineminus">-            NULL, // profile name, 64 char max (LPTSTR)</span>
<a href="#l20.430"></a><span id="l20.430" class="difflineminus">-            NULL, // profile password, 64 char max (LPTSTR)</span>
<a href="#l20.431"></a><span id="l20.431" class="difflineminus">-            // MAPI_NEW_SESSION | MAPI_NO_MAIL | MAPI_LOGON_UI | MAPI_EXPLICIT_PROFILE,</span>
<a href="#l20.432"></a><span id="l20.432" class="difflineminus">-            // MAPI_NEW_SESSION | MAPI_NO_MAIL | MAPI_LOGON_UI,</span>
<a href="#l20.433"></a><span id="l20.433" class="difflineminus">-            // MAPI_NO_MAIL | MAPI_LOGON_UI,</span>
<a href="#l20.434"></a><span id="l20.434" class="difflineminus">-            MAPI_NO_MAIL | MAPI_USE_DEFAULT | MAPI_EXTENDED | MAPI_NEW_SESSION,</span>
<a href="#l20.435"></a><span id="l20.435" class="difflineminus">-            &amp;m_lpSession);</span>
<a href="#l20.436"></a><span id="l20.436" class="difflineplus">+  hr = MAPILogonEx(</span>
<a href="#l20.437"></a><span id="l20.437" class="difflineplus">+      0,     // might need to be passed in HWND</span>
<a href="#l20.438"></a><span id="l20.438" class="difflineplus">+      NULL,  // profile name, 64 char max (LPTSTR)</span>
<a href="#l20.439"></a><span id="l20.439" class="difflineplus">+      NULL,  // profile password, 64 char max (LPTSTR)</span>
<a href="#l20.440"></a><span id="l20.440" class="difflineplus">+      // MAPI_NEW_SESSION | MAPI_NO_MAIL | MAPI_LOGON_UI |</span>
<a href="#l20.441"></a><span id="l20.441" class="difflineplus">+      // MAPI_EXPLICIT_PROFILE, MAPI_NEW_SESSION | MAPI_NO_MAIL | MAPI_LOGON_UI,</span>
<a href="#l20.442"></a><span id="l20.442" class="difflineplus">+      // MAPI_NO_MAIL | MAPI_LOGON_UI,</span>
<a href="#l20.443"></a><span id="l20.443" class="difflineplus">+      MAPI_NO_MAIL | MAPI_USE_DEFAULT | MAPI_EXTENDED | MAPI_NEW_SESSION,</span>
<a href="#l20.444"></a><span id="l20.444" class="difflineplus">+      &amp;m_lpSession);</span>
<a href="#l20.445"></a><span id="l20.445"> </span>
<a href="#l20.446"></a><span id="l20.446">   if (FAILED(hr)) {</span>
<a href="#l20.447"></a><span id="l20.447">     m_lpSession = NULL;</span>
<a href="#l20.448"></a><span id="l20.448">     MAPI_TRACE2(&quot;LogOn failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l20.449"></a><span id="l20.449">     return FALSE;</span>
<a href="#l20.450"></a><span id="l20.450">   }</span>
<a href="#l20.451"></a><span id="l20.451"> </span>
<a href="#l20.452"></a><span id="l20.452">   MAPI_TRACE0(&quot;MAPI Logged on\n&quot;);</span>
<a href="#l20.453"></a><span id="l20.453">   return TRUE;</span>
<a href="#l20.454"></a><span id="l20.454"> }</span>
<a href="#l20.455"></a><span id="l20.455"> </span>
<a href="#l20.456"></a><span id="l20.456"> class CGetStoreFoldersIter : public CMapiHierarchyIter {</span>
<a href="#l20.457"></a><span id="l20.457" class="difflineminus">-public:</span>
<a href="#l20.458"></a><span id="l20.458" class="difflineminus">-  CGetStoreFoldersIter(CMapiApi *pApi, CMapiFolderList&amp; folders, int depth, BOOL isMail = TRUE);</span>
<a href="#l20.459"></a><span id="l20.459" class="difflineplus">+ public:</span>
<a href="#l20.460"></a><span id="l20.460" class="difflineplus">+  CGetStoreFoldersIter(CMapiApi *pApi, CMapiFolderList &amp;folders, int depth,</span>
<a href="#l20.461"></a><span id="l20.461" class="difflineplus">+                       BOOL isMail = TRUE);</span>
<a href="#l20.462"></a><span id="l20.462"> </span>
<a href="#l20.463"></a><span id="l20.463">   virtual BOOL HandleHierarchyItem(ULONG oType, ULONG cb, LPENTRYID pEntry);</span>
<a href="#l20.464"></a><span id="l20.464"> </span>
<a href="#l20.465"></a><span id="l20.465" class="difflineminus">-protected:</span>
<a href="#l20.466"></a><span id="l20.466" class="difflineminus">-  BOOL  ExcludeFolderClass(const char16_t *pName);</span>
<a href="#l20.467"></a><span id="l20.467" class="difflineplus">+ protected:</span>
<a href="#l20.468"></a><span id="l20.468" class="difflineplus">+  BOOL ExcludeFolderClass(const char16_t *pName);</span>
<a href="#l20.469"></a><span id="l20.469"> </span>
<a href="#l20.470"></a><span id="l20.470" class="difflineminus">-  BOOL        m_isMail;</span>
<a href="#l20.471"></a><span id="l20.471" class="difflineminus">-  CMapiApi *      m_pApi;</span>
<a href="#l20.472"></a><span id="l20.472" class="difflineminus">-  CMapiFolderList *  m_pList;</span>
<a href="#l20.473"></a><span id="l20.473" class="difflineminus">-  int          m_depth;</span>
<a href="#l20.474"></a><span id="l20.474" class="difflineplus">+  BOOL m_isMail;</span>
<a href="#l20.475"></a><span id="l20.475" class="difflineplus">+  CMapiApi *m_pApi;</span>
<a href="#l20.476"></a><span id="l20.476" class="difflineplus">+  CMapiFolderList *m_pList;</span>
<a href="#l20.477"></a><span id="l20.477" class="difflineplus">+  int m_depth;</span>
<a href="#l20.478"></a><span id="l20.478"> };</span>
<a href="#l20.479"></a><span id="l20.479"> </span>
<a href="#l20.480"></a><span id="l20.480" class="difflineminus">-CGetStoreFoldersIter::CGetStoreFoldersIter(CMapiApi *pApi, CMapiFolderList&amp; folders, int depth, BOOL isMail)</span>
<a href="#l20.481"></a><span id="l20.481" class="difflineminus">-{</span>
<a href="#l20.482"></a><span id="l20.482" class="difflineplus">+CGetStoreFoldersIter::CGetStoreFoldersIter(CMapiApi *pApi,</span>
<a href="#l20.483"></a><span id="l20.483" class="difflineplus">+                                           CMapiFolderList &amp;folders, int depth,</span>
<a href="#l20.484"></a><span id="l20.484" class="difflineplus">+                                           BOOL isMail) {</span>
<a href="#l20.485"></a><span id="l20.485">   m_pApi = pApi;</span>
<a href="#l20.486"></a><span id="l20.486">   m_pList = &amp;folders;</span>
<a href="#l20.487"></a><span id="l20.487">   m_depth = depth;</span>
<a href="#l20.488"></a><span id="l20.488">   m_isMail = isMail;</span>
<a href="#l20.489"></a><span id="l20.489"> }</span>
<a href="#l20.490"></a><span id="l20.490"> </span>
<a href="#l20.491"></a><span id="l20.491" class="difflineminus">-BOOL CGetStoreFoldersIter::ExcludeFolderClass(const char16_t *pName)</span>
<a href="#l20.492"></a><span id="l20.492" class="difflineminus">-{</span>
<a href="#l20.493"></a><span id="l20.493" class="difflineplus">+BOOL CGetStoreFoldersIter::ExcludeFolderClass(const char16_t *pName) {</span>
<a href="#l20.494"></a><span id="l20.494">   BOOL bResult;</span>
<a href="#l20.495"></a><span id="l20.495" class="difflineminus">-    nsDependentString pNameStr(pName);</span>
<a href="#l20.496"></a><span id="l20.496" class="difflineplus">+  nsDependentString pNameStr(pName);</span>
<a href="#l20.497"></a><span id="l20.497">   if (m_isMail) {</span>
<a href="#l20.498"></a><span id="l20.498">     bResult = FALSE;</span>
<a href="#l20.499"></a><span id="l20.499" class="difflineminus">-        if (pNameStr.EqualsLiteral(&quot;IPF.Appointment&quot;))</span>
<a href="#l20.500"></a><span id="l20.500" class="difflineplus">+    if (pNameStr.EqualsLiteral(&quot;IPF.Appointment&quot;))</span>
<a href="#l20.501"></a><span id="l20.501">       bResult = TRUE;</span>
<a href="#l20.502"></a><span id="l20.502">     else if (pNameStr.EqualsLiteral(&quot;IPF.Contact&quot;))</span>
<a href="#l20.503"></a><span id="l20.503">       bResult = TRUE;</span>
<a href="#l20.504"></a><span id="l20.504">     else if (pNameStr.EqualsLiteral(&quot;IPF.Journal&quot;))</span>
<a href="#l20.505"></a><span id="l20.505">       bResult = TRUE;</span>
<a href="#l20.506"></a><span id="l20.506" class="difflineminus">-        else if (pNameStr.EqualsLiteral(&quot;IPF.StickyNote&quot;))</span>
<a href="#l20.507"></a><span id="l20.507" class="difflineplus">+    else if (pNameStr.EqualsLiteral(&quot;IPF.StickyNote&quot;))</span>
<a href="#l20.508"></a><span id="l20.508">       bResult = TRUE;</span>
<a href="#l20.509"></a><span id="l20.509">     else if (pNameStr.EqualsLiteral(&quot;IPF.Task&quot;))</span>
<a href="#l20.510"></a><span id="l20.510">       bResult = TRUE;</span>
<a href="#l20.511"></a><span id="l20.511">     // Skip IMAP folders</span>
<a href="#l20.512"></a><span id="l20.512">     else if (pNameStr.EqualsLiteral(&quot;IPF.Imap&quot;))</span>
<a href="#l20.513"></a><span id="l20.513">       bResult = TRUE;</span>
<a href="#l20.514"></a><span id="l20.514">     // else if (!stricmp(pName, &quot;IPF.Note&quot;))</span>
<a href="#l20.515"></a><span id="l20.515">     //  bResult = TRUE;</span>
<a href="#l20.516"></a><span id="l20.516" class="difflineminus">-  }</span>
<a href="#l20.517"></a><span id="l20.517" class="difflineminus">-  else {</span>
<a href="#l20.518"></a><span id="l20.518" class="difflineplus">+  } else {</span>
<a href="#l20.519"></a><span id="l20.519">     bResult = TRUE;</span>
<a href="#l20.520"></a><span id="l20.520" class="difflineminus">-    if (pNameStr.EqualsLiteral(&quot;IPF.Contact&quot;))</span>
<a href="#l20.521"></a><span id="l20.521" class="difflineminus">-      bResult = FALSE;</span>
<a href="#l20.522"></a><span id="l20.522" class="difflineplus">+    if (pNameStr.EqualsLiteral(&quot;IPF.Contact&quot;)) bResult = FALSE;</span>
<a href="#l20.523"></a><span id="l20.523">   }</span>
<a href="#l20.524"></a><span id="l20.524"> </span>
<a href="#l20.525"></a><span id="l20.525">   return bResult;</span>
<a href="#l20.526"></a><span id="l20.526"> }</span>
<a href="#l20.527"></a><span id="l20.527"> </span>
<a href="#l20.528"></a><span id="l20.528" class="difflineminus">-BOOL CGetStoreFoldersIter::HandleHierarchyItem(ULONG oType, ULONG cb, LPENTRYID pEntry)</span>
<a href="#l20.529"></a><span id="l20.529" class="difflineminus">-{</span>
<a href="#l20.530"></a><span id="l20.530" class="difflineplus">+BOOL CGetStoreFoldersIter::HandleHierarchyItem(ULONG oType, ULONG cb,</span>
<a href="#l20.531"></a><span id="l20.531" class="difflineplus">+                                               LPENTRYID pEntry) {</span>
<a href="#l20.532"></a><span id="l20.532">   if (oType == MAPI_FOLDER) {</span>
<a href="#l20.533"></a><span id="l20.533">     LPMAPIFOLDER pFolder;</span>
<a href="#l20.534"></a><span id="l20.534" class="difflineminus">-    if (m_pApi-&gt;OpenEntry(cb, pEntry, (LPUNKNOWN *) &amp;pFolder)) {</span>
<a href="#l20.535"></a><span id="l20.535" class="difflineminus">-      LPSPropValue    pVal;</span>
<a href="#l20.536"></a><span id="l20.536" class="difflineminus">-      nsString      name;</span>
<a href="#l20.537"></a><span id="l20.537" class="difflineplus">+    if (m_pApi-&gt;OpenEntry(cb, pEntry, (LPUNKNOWN *)&amp;pFolder)) {</span>
<a href="#l20.538"></a><span id="l20.538" class="difflineplus">+      LPSPropValue pVal;</span>
<a href="#l20.539"></a><span id="l20.539" class="difflineplus">+      nsString name;</span>
<a href="#l20.540"></a><span id="l20.540"> </span>
<a href="#l20.541"></a><span id="l20.541">       pVal = m_pApi-&gt;GetMapiProperty(pFolder, PR_CONTAINER_CLASS);</span>
<a href="#l20.542"></a><span id="l20.542">       if (pVal)</span>
<a href="#l20.543"></a><span id="l20.543">         m_pApi-&gt;GetStringFromProp(pVal, name);</span>
<a href="#l20.544"></a><span id="l20.544">       else</span>
<a href="#l20.545"></a><span id="l20.545">         name.Truncate();</span>
<a href="#l20.546"></a><span id="l20.546"> </span>
<a href="#l20.547"></a><span id="l20.547">       if ((name.IsEmpty() &amp;&amp; m_isMail) || (!ExcludeFolderClass(name.get()))) {</span>
<a href="#l20.548"></a><span id="l20.548">         pVal = m_pApi-&gt;GetMapiProperty(pFolder, PR_DISPLAY_NAME);</span>
<a href="#l20.549"></a><span id="l20.549">         m_pApi-&gt;GetStringFromProp(pVal, name);</span>
<a href="#l20.550"></a><span id="l20.550" class="difflineminus">-        CMapiFolder  *pNewFolder = new CMapiFolder(name.get(), cb, pEntry, m_depth);</span>
<a href="#l20.551"></a><span id="l20.551" class="difflineplus">+        CMapiFolder *pNewFolder =</span>
<a href="#l20.552"></a><span id="l20.552" class="difflineplus">+            new CMapiFolder(name.get(), cb, pEntry, m_depth);</span>
<a href="#l20.553"></a><span id="l20.553">         m_pList-&gt;AddItem(pNewFolder);</span>
<a href="#l20.554"></a><span id="l20.554"> </span>
<a href="#l20.555"></a><span id="l20.555">         pVal = m_pApi-&gt;GetMapiProperty(pFolder, PR_FOLDER_TYPE);</span>
<a href="#l20.556"></a><span id="l20.556" class="difflineminus">-        MAPI_TRACE2(&quot;Type: %d, name: %s\n&quot;,</span>
<a href="#l20.557"></a><span id="l20.557" class="difflineminus">-                    m_pApi-&gt;GetLongFromProp(pVal), name.get());</span>
<a href="#l20.558"></a><span id="l20.558" class="difflineplus">+        MAPI_TRACE2(&quot;Type: %d, name: %s\n&quot;, m_pApi-&gt;GetLongFromProp(pVal),</span>
<a href="#l20.559"></a><span id="l20.559" class="difflineplus">+                    name.get());</span>
<a href="#l20.560"></a><span id="l20.560">         // m_pApi-&gt;ListProperties(pFolder);</span>
<a href="#l20.561"></a><span id="l20.561"> </span>
<a href="#l20.562"></a><span id="l20.562" class="difflineminus">-        CGetStoreFoldersIter  nextIter(m_pApi, *m_pList, m_depth + 1, m_isMail);</span>
<a href="#l20.563"></a><span id="l20.563" class="difflineplus">+        CGetStoreFoldersIter nextIter(m_pApi, *m_pList, m_depth + 1, m_isMail);</span>
<a href="#l20.564"></a><span id="l20.564">         m_pApi-&gt;IterateHierarchy(&amp;nextIter, pFolder);</span>
<a href="#l20.565"></a><span id="l20.565">       }</span>
<a href="#l20.566"></a><span id="l20.566">       pFolder-&gt;Release();</span>
<a href="#l20.567"></a><span id="l20.567" class="difflineminus">-    }</span>
<a href="#l20.568"></a><span id="l20.568" class="difflineminus">-    else {</span>
<a href="#l20.569"></a><span id="l20.569" class="difflineminus">-      MAPI_TRACE0(&quot;GetStoreFolders - HandleHierarchyItem: Error opening folder entry.\n&quot;);</span>
<a href="#l20.570"></a><span id="l20.570" class="difflineplus">+    } else {</span>
<a href="#l20.571"></a><span id="l20.571" class="difflineplus">+      MAPI_TRACE0(</span>
<a href="#l20.572"></a><span id="l20.572" class="difflineplus">+          &quot;GetStoreFolders - HandleHierarchyItem: Error opening folder &quot;</span>
<a href="#l20.573"></a><span id="l20.573" class="difflineplus">+          &quot;entry.\n&quot;);</span>
<a href="#l20.574"></a><span id="l20.574">       return FALSE;</span>
<a href="#l20.575"></a><span id="l20.575">     }</span>
<a href="#l20.576"></a><span id="l20.576" class="difflineminus">-  }</span>
<a href="#l20.577"></a><span id="l20.577" class="difflineminus">-  else</span>
<a href="#l20.578"></a><span id="l20.578" class="difflineminus">-    MAPI_TRACE1(&quot;GetStoreFolders - HandleHierarchyItem: Unhandled ObjectType: %ld\n&quot;, oType);</span>
<a href="#l20.579"></a><span id="l20.579" class="difflineplus">+  } else</span>
<a href="#l20.580"></a><span id="l20.580" class="difflineplus">+    MAPI_TRACE1(</span>
<a href="#l20.581"></a><span id="l20.581" class="difflineplus">+        &quot;GetStoreFolders - HandleHierarchyItem: Unhandled ObjectType: %ld\n&quot;,</span>
<a href="#l20.582"></a><span id="l20.582" class="difflineplus">+        oType);</span>
<a href="#l20.583"></a><span id="l20.583">   return TRUE;</span>
<a href="#l20.584"></a><span id="l20.584"> }</span>
<a href="#l20.585"></a><span id="l20.585"> </span>
<a href="#l20.586"></a><span id="l20.586" class="difflineminus">-BOOL CMapiApi::GetStoreFolders(ULONG cbEid, LPENTRYID lpEid, CMapiFolderList&amp; folders, int startDepth)</span>
<a href="#l20.587"></a><span id="l20.587" class="difflineminus">-{</span>
<a href="#l20.588"></a><span id="l20.588" class="difflineplus">+BOOL CMapiApi::GetStoreFolders(ULONG cbEid, LPENTRYID lpEid,</span>
<a href="#l20.589"></a><span id="l20.589" class="difflineplus">+                               CMapiFolderList &amp;folders, int startDepth) {</span>
<a href="#l20.590"></a><span id="l20.590">   // Fill in the array with the folders in the given store</span>
<a href="#l20.591"></a><span id="l20.591">   if (!m_initialized || !m_lpSession) {</span>
<a href="#l20.592"></a><span id="l20.592">     MAPI_TRACE0(&quot;MAPI not initialized for GetStoreFolders\n&quot;);</span>
<a href="#l20.593"></a><span id="l20.593">     return FALSE;</span>
<a href="#l20.594"></a><span id="l20.594">   }</span>
<a href="#l20.595"></a><span id="l20.595"> </span>
<a href="#l20.596"></a><span id="l20.596">   m_lpMdb = NULL;</span>
<a href="#l20.597"></a><span id="l20.597"> </span>
<a href="#l20.598"></a><span id="l20.598" class="difflineminus">-  CMsgStore *    pStore = FindMessageStore(cbEid, lpEid);</span>
<a href="#l20.599"></a><span id="l20.599" class="difflineminus">-  BOOL      bResult = FALSE;</span>
<a href="#l20.600"></a><span id="l20.600" class="difflineminus">-  LPSPropValue  pVal;</span>
<a href="#l20.601"></a><span id="l20.601" class="difflineplus">+  CMsgStore *pStore = FindMessageStore(cbEid, lpEid);</span>
<a href="#l20.602"></a><span id="l20.602" class="difflineplus">+  BOOL bResult = FALSE;</span>
<a href="#l20.603"></a><span id="l20.603" class="difflineplus">+  LPSPropValue pVal;</span>
<a href="#l20.604"></a><span id="l20.604"> </span>
<a href="#l20.605"></a><span id="l20.605">   if (pStore &amp;&amp; pStore-&gt;Open(m_lpSession, &amp;m_lpMdb)) {</span>
<a href="#l20.606"></a><span id="l20.606">     // Successful open, do the iteration of the store</span>
<a href="#l20.607"></a><span id="l20.607">     pVal = GetMapiProperty(m_lpMdb, PR_IPM_SUBTREE_ENTRYID);</span>
<a href="#l20.608"></a><span id="l20.608">     if (pVal) {</span>
<a href="#l20.609"></a><span id="l20.609" class="difflineminus">-      ULONG      cbEntry;</span>
<a href="#l20.610"></a><span id="l20.610" class="difflineminus">-      LPENTRYID    pEntry;</span>
<a href="#l20.611"></a><span id="l20.611" class="difflineminus">-      LPMAPIFOLDER  lpSubTree = NULL;</span>
<a href="#l20.612"></a><span id="l20.612" class="difflineplus">+      ULONG cbEntry;</span>
<a href="#l20.613"></a><span id="l20.613" class="difflineplus">+      LPENTRYID pEntry;</span>
<a href="#l20.614"></a><span id="l20.614" class="difflineplus">+      LPMAPIFOLDER lpSubTree = NULL;</span>
<a href="#l20.615"></a><span id="l20.615"> </span>
<a href="#l20.616"></a><span id="l20.616">       if (GetEntryIdFromProp(pVal, cbEntry, pEntry)) {</span>
<a href="#l20.617"></a><span id="l20.617">         // Open up the folder!</span>
<a href="#l20.618"></a><span id="l20.618">         bResult = OpenEntry(cbEntry, pEntry, (LPUNKNOWN *)&amp;lpSubTree);</span>
<a href="#l20.619"></a><span id="l20.619">         MAPIFreeBuffer(pEntry);</span>
<a href="#l20.620"></a><span id="l20.620">         if (bResult &amp;&amp; lpSubTree) {</span>
<a href="#l20.621"></a><span id="l20.621">           // Iterate the subtree with the results going into the folder list</span>
<a href="#l20.622"></a><span id="l20.622">           CGetStoreFoldersIter iterHandler(this, folders, startDepth);</span>
<a href="#l20.623"></a><span id="l20.623">           bResult = IterateHierarchy(&amp;iterHandler, lpSubTree);</span>
<a href="#l20.624"></a><span id="l20.624">           lpSubTree-&gt;Release();</span>
<a href="#l20.625"></a><span id="l20.625" class="difflineminus">-        }</span>
<a href="#l20.626"></a><span id="l20.626" class="difflineminus">-        else {</span>
<a href="#l20.627"></a><span id="l20.627" class="difflineplus">+        } else {</span>
<a href="#l20.628"></a><span id="l20.628">           MAPI_TRACE0(&quot;GetStoreFolders: Error opening sub tree.\n&quot;);</span>
<a href="#l20.629"></a><span id="l20.629">         }</span>
<a href="#l20.630"></a><span id="l20.630" class="difflineplus">+      } else {</span>
<a href="#l20.631"></a><span id="l20.631" class="difflineplus">+        MAPI_TRACE0(</span>
<a href="#l20.632"></a><span id="l20.632" class="difflineplus">+            &quot;GetStoreFolders: Error getting entryID from sub tree property &quot;</span>
<a href="#l20.633"></a><span id="l20.633" class="difflineplus">+            &quot;val.\n&quot;);</span>
<a href="#l20.634"></a><span id="l20.634">       }</span>
<a href="#l20.635"></a><span id="l20.635" class="difflineminus">-      else {</span>
<a href="#l20.636"></a><span id="l20.636" class="difflineminus">-        MAPI_TRACE0(&quot;GetStoreFolders: Error getting entryID from sub tree property val.\n&quot;);</span>
<a href="#l20.637"></a><span id="l20.637" class="difflineminus">-      }</span>
<a href="#l20.638"></a><span id="l20.638" class="difflineminus">-    }</span>
<a href="#l20.639"></a><span id="l20.639" class="difflineminus">-    else {</span>
<a href="#l20.640"></a><span id="l20.640" class="difflineplus">+    } else {</span>
<a href="#l20.641"></a><span id="l20.641">       MAPI_TRACE0(&quot;GetStoreFolders: Error getting sub tree property.\n&quot;);</span>
<a href="#l20.642"></a><span id="l20.642">     }</span>
<a href="#l20.643"></a><span id="l20.643" class="difflineminus">-  }</span>
<a href="#l20.644"></a><span id="l20.644" class="difflineminus">-  else {</span>
<a href="#l20.645"></a><span id="l20.645" class="difflineplus">+  } else {</span>
<a href="#l20.646"></a><span id="l20.646">     MAPI_TRACE0(&quot;GetStoreFolders: Error opening message store.\n&quot;);</span>
<a href="#l20.647"></a><span id="l20.647">   }</span>
<a href="#l20.648"></a><span id="l20.648"> </span>
<a href="#l20.649"></a><span id="l20.649">   return bResult;</span>
<a href="#l20.650"></a><span id="l20.650"> }</span>
<a href="#l20.651"></a><span id="l20.651"> </span>
<a href="#l20.652"></a><span id="l20.652" class="difflineminus">-BOOL CMapiApi::GetStoreAddressFolders(ULONG cbEid, LPENTRYID lpEid, CMapiFolderList&amp; folders)</span>
<a href="#l20.653"></a><span id="l20.653" class="difflineminus">-{</span>
<a href="#l20.654"></a><span id="l20.654" class="difflineplus">+BOOL CMapiApi::GetStoreAddressFolders(ULONG cbEid, LPENTRYID lpEid,</span>
<a href="#l20.655"></a><span id="l20.655" class="difflineplus">+                                      CMapiFolderList &amp;folders) {</span>
<a href="#l20.656"></a><span id="l20.656">   // Fill in the array with the folders in the given store</span>
<a href="#l20.657"></a><span id="l20.657">   if (!m_initialized || !m_lpSession) {</span>
<a href="#l20.658"></a><span id="l20.658">     MAPI_TRACE0(&quot;MAPI not initialized for GetStoreAddressFolders\n&quot;);</span>
<a href="#l20.659"></a><span id="l20.659">     return FALSE;</span>
<a href="#l20.660"></a><span id="l20.660">   }</span>
<a href="#l20.661"></a><span id="l20.661"> </span>
<a href="#l20.662"></a><span id="l20.662">   m_lpMdb = NULL;</span>
<a href="#l20.663"></a><span id="l20.663"> </span>
<a href="#l20.664"></a><span id="l20.664" class="difflineminus">-  CMsgStore *    pStore = FindMessageStore(cbEid, lpEid);</span>
<a href="#l20.665"></a><span id="l20.665" class="difflineminus">-  BOOL      bResult = FALSE;</span>
<a href="#l20.666"></a><span id="l20.666" class="difflineminus">-  LPSPropValue  pVal;</span>
<a href="#l20.667"></a><span id="l20.667" class="difflineplus">+  CMsgStore *pStore = FindMessageStore(cbEid, lpEid);</span>
<a href="#l20.668"></a><span id="l20.668" class="difflineplus">+  BOOL bResult = FALSE;</span>
<a href="#l20.669"></a><span id="l20.669" class="difflineplus">+  LPSPropValue pVal;</span>
<a href="#l20.670"></a><span id="l20.670"> </span>
<a href="#l20.671"></a><span id="l20.671">   if (pStore &amp;&amp; pStore-&gt;Open(m_lpSession, &amp;m_lpMdb)) {</span>
<a href="#l20.672"></a><span id="l20.672">     // Successful open, do the iteration of the store</span>
<a href="#l20.673"></a><span id="l20.673">     pVal = GetMapiProperty(m_lpMdb, PR_IPM_SUBTREE_ENTRYID);</span>
<a href="#l20.674"></a><span id="l20.674">     if (pVal) {</span>
<a href="#l20.675"></a><span id="l20.675" class="difflineminus">-      ULONG      cbEntry;</span>
<a href="#l20.676"></a><span id="l20.676" class="difflineminus">-      LPENTRYID    pEntry;</span>
<a href="#l20.677"></a><span id="l20.677" class="difflineminus">-      LPMAPIFOLDER  lpSubTree = NULL;</span>
<a href="#l20.678"></a><span id="l20.678" class="difflineplus">+      ULONG cbEntry;</span>
<a href="#l20.679"></a><span id="l20.679" class="difflineplus">+      LPENTRYID pEntry;</span>
<a href="#l20.680"></a><span id="l20.680" class="difflineplus">+      LPMAPIFOLDER lpSubTree = NULL;</span>
<a href="#l20.681"></a><span id="l20.681"> </span>
<a href="#l20.682"></a><span id="l20.682">       if (GetEntryIdFromProp(pVal, cbEntry, pEntry)) {</span>
<a href="#l20.683"></a><span id="l20.683">         // Open up the folder!</span>
<a href="#l20.684"></a><span id="l20.684">         bResult = OpenEntry(cbEntry, pEntry, (LPUNKNOWN *)&amp;lpSubTree);</span>
<a href="#l20.685"></a><span id="l20.685">         MAPIFreeBuffer(pEntry);</span>
<a href="#l20.686"></a><span id="l20.686">         if (bResult &amp;&amp; lpSubTree) {</span>
<a href="#l20.687"></a><span id="l20.687">           // Iterate the subtree with the results going into the folder list</span>
<a href="#l20.688"></a><span id="l20.688">           CGetStoreFoldersIter iterHandler(this, folders, 1, FALSE);</span>
<a href="#l20.689"></a><span id="l20.689">           bResult = IterateHierarchy(&amp;iterHandler, lpSubTree);</span>
<a href="#l20.690"></a><span id="l20.690">           lpSubTree-&gt;Release();</span>
<a href="#l20.691"></a><span id="l20.691" class="difflineminus">-        }</span>
<a href="#l20.692"></a><span id="l20.692" class="difflineminus">-        else {</span>
<a href="#l20.693"></a><span id="l20.693" class="difflineplus">+        } else {</span>
<a href="#l20.694"></a><span id="l20.694">           MAPI_TRACE0(&quot;GetStoreAddressFolders: Error opening sub tree.\n&quot;);</span>
<a href="#l20.695"></a><span id="l20.695">         }</span>
<a href="#l20.696"></a><span id="l20.696" class="difflineplus">+      } else {</span>
<a href="#l20.697"></a><span id="l20.697" class="difflineplus">+        MAPI_TRACE0(</span>
<a href="#l20.698"></a><span id="l20.698" class="difflineplus">+            &quot;GetStoreAddressFolders: Error getting entryID from sub tree &quot;</span>
<a href="#l20.699"></a><span id="l20.699" class="difflineplus">+            &quot;property val.\n&quot;);</span>
<a href="#l20.700"></a><span id="l20.700">       }</span>
<a href="#l20.701"></a><span id="l20.701" class="difflineminus">-      else {</span>
<a href="#l20.702"></a><span id="l20.702" class="difflineminus">-        MAPI_TRACE0(&quot;GetStoreAddressFolders: Error getting entryID from sub tree property val.\n&quot;);</span>
<a href="#l20.703"></a><span id="l20.703" class="difflineminus">-      }</span>
<a href="#l20.704"></a><span id="l20.704" class="difflineminus">-    }</span>
<a href="#l20.705"></a><span id="l20.705" class="difflineminus">-    else {</span>
<a href="#l20.706"></a><span id="l20.706" class="difflineplus">+    } else {</span>
<a href="#l20.707"></a><span id="l20.707">       MAPI_TRACE0(&quot;GetStoreAddressFolders: Error getting sub tree property.\n&quot;);</span>
<a href="#l20.708"></a><span id="l20.708">     }</span>
<a href="#l20.709"></a><span id="l20.709" class="difflineminus">-  }</span>
<a href="#l20.710"></a><span id="l20.710" class="difflineminus">-  else</span>
<a href="#l20.711"></a><span id="l20.711" class="difflineplus">+  } else</span>
<a href="#l20.712"></a><span id="l20.712">     MAPI_TRACE0(&quot;GetStoreAddressFolders: Error opening message store.\n&quot;);</span>
<a href="#l20.713"></a><span id="l20.713"> </span>
<a href="#l20.714"></a><span id="l20.714">   return bResult;</span>
<a href="#l20.715"></a><span id="l20.715"> }</span>
<a href="#l20.716"></a><span id="l20.716"> </span>
<a href="#l20.717"></a><span id="l20.717" class="difflineminus">-</span>
<a href="#l20.718"></a><span id="l20.718" class="difflineminus">-BOOL CMapiApi::OpenStore(ULONG cbEid, LPENTRYID lpEid, LPMDB *ppMdb)</span>
<a href="#l20.719"></a><span id="l20.719" class="difflineminus">-{</span>
<a href="#l20.720"></a><span id="l20.720" class="difflineplus">+BOOL CMapiApi::OpenStore(ULONG cbEid, LPENTRYID lpEid, LPMDB *ppMdb) {</span>
<a href="#l20.721"></a><span id="l20.721">   if (!m_lpSession) {</span>
<a href="#l20.722"></a><span id="l20.722">     MAPI_TRACE0(&quot;OpenStore called before a session was opened\n&quot;);</span>
<a href="#l20.723"></a><span id="l20.723">     return FALSE;</span>
<a href="#l20.724"></a><span id="l20.724">   }</span>
<a href="#l20.725"></a><span id="l20.725"> </span>
<a href="#l20.726"></a><span id="l20.726" class="difflineminus">-  CMsgStore *    pStore = FindMessageStore(cbEid, lpEid);</span>
<a href="#l20.727"></a><span id="l20.727" class="difflineminus">-  if (pStore &amp;&amp; pStore-&gt;Open(m_lpSession, ppMdb))</span>
<a href="#l20.728"></a><span id="l20.728" class="difflineminus">-    return TRUE;</span>
<a href="#l20.729"></a><span id="l20.729" class="difflineplus">+  CMsgStore *pStore = FindMessageStore(cbEid, lpEid);</span>
<a href="#l20.730"></a><span id="l20.730" class="difflineplus">+  if (pStore &amp;&amp; pStore-&gt;Open(m_lpSession, ppMdb)) return TRUE;</span>
<a href="#l20.731"></a><span id="l20.731">   return FALSE;</span>
<a href="#l20.732"></a><span id="l20.732"> }</span>
<a href="#l20.733"></a><span id="l20.733"> </span>
<a href="#l20.734"></a><span id="l20.734" class="difflineminus">-</span>
<a href="#l20.735"></a><span id="l20.735" class="difflineminus">-BOOL CMapiApi::OpenEntry(ULONG cbEntry, LPENTRYID pEntryId, LPUNKNOWN *ppOpen)</span>
<a href="#l20.736"></a><span id="l20.736" class="difflineminus">-{</span>
<a href="#l20.737"></a><span id="l20.737" class="difflineplus">+BOOL CMapiApi::OpenEntry(ULONG cbEntry, LPENTRYID pEntryId, LPUNKNOWN *ppOpen) {</span>
<a href="#l20.738"></a><span id="l20.738">   if (!m_lpMdb) {</span>
<a href="#l20.739"></a><span id="l20.739">     MAPI_TRACE0(&quot;OpenEntry called before the message store is open\n&quot;);</span>
<a href="#l20.740"></a><span id="l20.740">     return FALSE;</span>
<a href="#l20.741"></a><span id="l20.741">   }</span>
<a href="#l20.742"></a><span id="l20.742"> </span>
<a href="#l20.743"></a><span id="l20.743">   return OpenMdbEntry(m_lpMdb, cbEntry, pEntryId, ppOpen);</span>
<a href="#l20.744"></a><span id="l20.744"> }</span>
<a href="#l20.745"></a><span id="l20.745"> </span>
<a href="#l20.746"></a><span id="l20.746" class="difflineminus">-BOOL CMapiApi::OpenMdbEntry(LPMDB lpMdb, ULONG cbEntry, LPENTRYID pEntryId, LPUNKNOWN *ppOpen)</span>
<a href="#l20.747"></a><span id="l20.747" class="difflineminus">-{</span>
<a href="#l20.748"></a><span id="l20.748" class="difflineminus">-  ULONG    ulObjType;</span>
<a href="#l20.749"></a><span id="l20.749" class="difflineminus">-  HRESULT    hr;</span>
<a href="#l20.750"></a><span id="l20.750" class="difflineminus">-  hr = m_lpSession-&gt;OpenEntry(cbEntry,</span>
<a href="#l20.751"></a><span id="l20.751" class="difflineminus">-              pEntryId,</span>
<a href="#l20.752"></a><span id="l20.752" class="difflineminus">-              NULL,</span>
<a href="#l20.753"></a><span id="l20.753" class="difflineminus">-              0,</span>
<a href="#l20.754"></a><span id="l20.754" class="difflineminus">-              &amp;ulObjType,</span>
<a href="#l20.755"></a><span id="l20.755" class="difflineminus">-              (LPUNKNOWN *) ppOpen);</span>
<a href="#l20.756"></a><span id="l20.756" class="difflineplus">+BOOL CMapiApi::OpenMdbEntry(LPMDB lpMdb, ULONG cbEntry, LPENTRYID pEntryId,</span>
<a href="#l20.757"></a><span id="l20.757" class="difflineplus">+                            LPUNKNOWN *ppOpen) {</span>
<a href="#l20.758"></a><span id="l20.758" class="difflineplus">+  ULONG ulObjType;</span>
<a href="#l20.759"></a><span id="l20.759" class="difflineplus">+  HRESULT hr;</span>
<a href="#l20.760"></a><span id="l20.760" class="difflineplus">+  hr = m_lpSession-&gt;OpenEntry(cbEntry, pEntryId, NULL, 0, &amp;ulObjType,</span>
<a href="#l20.761"></a><span id="l20.761" class="difflineplus">+                              (LPUNKNOWN *)ppOpen);</span>
<a href="#l20.762"></a><span id="l20.762">   if (FAILED(hr)) {</span>
<a href="#l20.763"></a><span id="l20.763">     MAPI_TRACE2(&quot;OpenMdbEntry failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l20.764"></a><span id="l20.764">     return FALSE;</span>
<a href="#l20.765"></a><span id="l20.765">   }</span>
<a href="#l20.766"></a><span id="l20.766">   return TRUE;</span>
<a href="#l20.767"></a><span id="l20.767"> }</span>
<a href="#l20.768"></a><span id="l20.768"> </span>
<a href="#l20.769"></a><span id="l20.769" class="difflineminus">-enum {</span>
<a href="#l20.770"></a><span id="l20.770" class="difflineminus">-  ieidPR_ENTRYID = 0,</span>
<a href="#l20.771"></a><span id="l20.771" class="difflineminus">-  ieidPR_OBJECT_TYPE,</span>
<a href="#l20.772"></a><span id="l20.772" class="difflineminus">-  ieidMax</span>
<a href="#l20.773"></a><span id="l20.773" class="difflineminus">-};</span>
<a href="#l20.774"></a><span id="l20.774" class="difflineplus">+enum { ieidPR_ENTRYID = 0, ieidPR_OBJECT_TYPE, ieidMax };</span>
<a href="#l20.775"></a><span id="l20.775"> </span>
<a href="#l20.776"></a><span id="l20.776" class="difflineminus">-static const SizedSPropTagArray(ieidMax, ptaEid)=</span>
<a href="#l20.777"></a><span id="l20.777" class="difflineminus">-{</span>
<a href="#l20.778"></a><span id="l20.778" class="difflineminus">-  ieidMax,</span>
<a href="#l20.779"></a><span id="l20.779" class="difflineminus">-  {</span>
<a href="#l20.780"></a><span id="l20.780" class="difflineminus">-      PR_ENTRYID,</span>
<a href="#l20.781"></a><span id="l20.781" class="difflineminus">-    PR_OBJECT_TYPE,</span>
<a href="#l20.782"></a><span id="l20.782" class="difflineminus">-  }</span>
<a href="#l20.783"></a><span id="l20.783" class="difflineminus">-};</span>
<a href="#l20.784"></a><span id="l20.784" class="difflineplus">+static const SizedSPropTagArray(ieidMax, ptaEid) = {ieidMax,</span>
<a href="#l20.785"></a><span id="l20.785" class="difflineplus">+                                                    {</span>
<a href="#l20.786"></a><span id="l20.786" class="difflineplus">+                                                        PR_ENTRYID,</span>
<a href="#l20.787"></a><span id="l20.787" class="difflineplus">+                                                        PR_OBJECT_TYPE,</span>
<a href="#l20.788"></a><span id="l20.788" class="difflineplus">+                                                    }};</span>
<a href="#l20.789"></a><span id="l20.789"> </span>
<a href="#l20.790"></a><span id="l20.790" class="difflineminus">-BOOL CMapiApi::IterateContents(CMapiContentIter *pIter, LPMAPIFOLDER pFolder, ULONG flags)</span>
<a href="#l20.791"></a><span id="l20.791" class="difflineminus">-{</span>
<a href="#l20.792"></a><span id="l20.792" class="difflineplus">+BOOL CMapiApi::IterateContents(CMapiContentIter *pIter, LPMAPIFOLDER pFolder,</span>
<a href="#l20.793"></a><span id="l20.793" class="difflineplus">+                               ULONG flags) {</span>
<a href="#l20.794"></a><span id="l20.794">   // flags can be 0 or MAPI_ASSOCIATED</span>
<a href="#l20.795"></a><span id="l20.795">   // MAPI_ASSOCIATED is usually used for forms and views</span>
<a href="#l20.796"></a><span id="l20.796"> </span>
<a href="#l20.797"></a><span id="l20.797" class="difflineminus">-  HRESULT    hr;</span>
<a href="#l20.798"></a><span id="l20.798" class="difflineminus">-  LPMAPITABLE  lpTable;</span>
<a href="#l20.799"></a><span id="l20.799" class="difflineplus">+  HRESULT hr;</span>
<a href="#l20.800"></a><span id="l20.800" class="difflineplus">+  LPMAPITABLE lpTable;</span>
<a href="#l20.801"></a><span id="l20.801">   hr = pFolder-&gt;GetContentsTable(flags, &amp;lpTable);</span>
<a href="#l20.802"></a><span id="l20.802">   if (FAILED(hr)) {</span>
<a href="#l20.803"></a><span id="l20.803">     MAPI_TRACE2(&quot;GetContentsTable failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l20.804"></a><span id="l20.804">     return FALSE;</span>
<a href="#l20.805"></a><span id="l20.805">   }</span>
<a href="#l20.806"></a><span id="l20.806"> </span>
<a href="#l20.807"></a><span id="l20.807">   ULONG rowCount;</span>
<a href="#l20.808"></a><span id="l20.808">   hr = lpTable-&gt;GetRowCount(0, &amp;rowCount);</span>
<a href="#l20.809"></a><span id="l20.809" class="difflineat">@@ -623,303 +585,285 @@ BOOL CMapiApi::IterateContents(CMapiCont</span>
<a href="#l20.810"></a><span id="l20.810"> </span>
<a href="#l20.811"></a><span id="l20.811">   hr = lpTable-&gt;SeekRow(BOOKMARK_BEGINNING, 0, NULL);</span>
<a href="#l20.812"></a><span id="l20.812">   if (FAILED(hr)) {</span>
<a href="#l20.813"></a><span id="l20.813">     lpTable-&gt;Release();</span>
<a href="#l20.814"></a><span id="l20.814">     MAPI_TRACE2(&quot;SeekRow failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l20.815"></a><span id="l20.815">     return FALSE;</span>
<a href="#l20.816"></a><span id="l20.816">   }</span>
<a href="#l20.817"></a><span id="l20.817"> </span>
<a href="#l20.818"></a><span id="l20.818" class="difflineminus">-  int      cNumRows = 0;</span>
<a href="#l20.819"></a><span id="l20.819" class="difflineminus">-  LPSRowSet  lpRow;</span>
<a href="#l20.820"></a><span id="l20.820" class="difflineminus">-  BOOL    keepGoing = TRUE;</span>
<a href="#l20.821"></a><span id="l20.821" class="difflineminus">-  BOOL    bResult = TRUE;</span>
<a href="#l20.822"></a><span id="l20.822" class="difflineplus">+  int cNumRows = 0;</span>
<a href="#l20.823"></a><span id="l20.823" class="difflineplus">+  LPSRowSet lpRow;</span>
<a href="#l20.824"></a><span id="l20.824" class="difflineplus">+  BOOL keepGoing = TRUE;</span>
<a href="#l20.825"></a><span id="l20.825" class="difflineplus">+  BOOL bResult = TRUE;</span>
<a href="#l20.826"></a><span id="l20.826">   do {</span>
<a href="#l20.827"></a><span id="l20.827">     lpRow = NULL;</span>
<a href="#l20.828"></a><span id="l20.828">     hr = lpTable-&gt;QueryRows(1, 0, &amp;lpRow);</span>
<a href="#l20.829"></a><span id="l20.829" class="difflineminus">-    if(HR_FAILED(hr)) {</span>
<a href="#l20.830"></a><span id="l20.830" class="difflineplus">+    if (HR_FAILED(hr)) {</span>
<a href="#l20.831"></a><span id="l20.831">       MAPI_TRACE2(&quot;QueryRows failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l20.832"></a><span id="l20.832">       bResult = FALSE;</span>
<a href="#l20.833"></a><span id="l20.833">       break;</span>
<a href="#l20.834"></a><span id="l20.834">     }</span>
<a href="#l20.835"></a><span id="l20.835"> </span>
<a href="#l20.836"></a><span id="l20.836" class="difflineminus">-    if(lpRow) {</span>
<a href="#l20.837"></a><span id="l20.837" class="difflineplus">+    if (lpRow) {</span>
<a href="#l20.838"></a><span id="l20.838">       cNumRows = lpRow-&gt;cRows;</span>
<a href="#l20.839"></a><span id="l20.839">       if (cNumRows) {</span>
<a href="#l20.840"></a><span id="l20.840" class="difflineminus">-        LPENTRYID  lpEID = (LPENTRYID) lpRow-&gt;aRow[0].lpProps[ieidPR_ENTRYID].Value.bin.lpb;</span>
<a href="#l20.841"></a><span id="l20.841" class="difflineminus">-        ULONG    cbEID = lpRow-&gt;aRow[0].lpProps[ieidPR_ENTRYID].Value.bin.cb;</span>
<a href="#l20.842"></a><span id="l20.842" class="difflineminus">-        ULONG    oType = lpRow-&gt;aRow[0].lpProps[ieidPR_OBJECT_TYPE].Value.ul;</span>
<a href="#l20.843"></a><span id="l20.843" class="difflineplus">+        LPENTRYID lpEID =</span>
<a href="#l20.844"></a><span id="l20.844" class="difflineplus">+            (LPENTRYID)lpRow-&gt;aRow[0].lpProps[ieidPR_ENTRYID].Value.bin.lpb;</span>
<a href="#l20.845"></a><span id="l20.845" class="difflineplus">+        ULONG cbEID = lpRow-&gt;aRow[0].lpProps[ieidPR_ENTRYID].Value.bin.cb;</span>
<a href="#l20.846"></a><span id="l20.846" class="difflineplus">+        ULONG oType = lpRow-&gt;aRow[0].lpProps[ieidPR_OBJECT_TYPE].Value.ul;</span>
<a href="#l20.847"></a><span id="l20.847">         keepGoing = HandleContentsItem(oType, cbEID, lpEID);</span>
<a href="#l20.848"></a><span id="l20.848">         MAPI_TRACE1(&quot;    ObjectType: %ld\n&quot;, oType);</span>
<a href="#l20.849"></a><span id="l20.849">       }</span>
<a href="#l20.850"></a><span id="l20.850">       FreeProws(lpRow);</span>
<a href="#l20.851"></a><span id="l20.851">     }</span>
<a href="#l20.852"></a><span id="l20.852"> </span>
<a href="#l20.853"></a><span id="l20.853">   } while (SUCCEEDED(hr) &amp;&amp; cNumRows &amp;&amp; lpRow &amp;&amp; keepGoing);</span>
<a href="#l20.854"></a><span id="l20.854"> </span>
<a href="#l20.855"></a><span id="l20.855">   lpTable-&gt;Release();</span>
<a href="#l20.856"></a><span id="l20.856">   return bResult;</span>
<a href="#l20.857"></a><span id="l20.857"> }</span>
<a href="#l20.858"></a><span id="l20.858"> </span>
<a href="#l20.859"></a><span id="l20.859" class="difflineminus">-BOOL CMapiApi::HandleContentsItem(ULONG oType, ULONG cb, LPENTRYID pEntry)</span>
<a href="#l20.860"></a><span id="l20.860" class="difflineminus">-{</span>
<a href="#l20.861"></a><span id="l20.861" class="difflineplus">+BOOL CMapiApi::HandleContentsItem(ULONG oType, ULONG cb, LPENTRYID pEntry) {</span>
<a href="#l20.862"></a><span id="l20.862">   if (oType == MAPI_MESSAGE) {</span>
<a href="#l20.863"></a><span id="l20.863">     LPMESSAGE pMsg;</span>
<a href="#l20.864"></a><span id="l20.864" class="difflineminus">-    if (OpenEntry(cb, pEntry, (LPUNKNOWN *) &amp;pMsg)) {</span>
<a href="#l20.865"></a><span id="l20.865" class="difflineplus">+    if (OpenEntry(cb, pEntry, (LPUNKNOWN *)&amp;pMsg)) {</span>
<a href="#l20.866"></a><span id="l20.866">       LPSPropValue pVal;</span>
<a href="#l20.867"></a><span id="l20.867">       pVal = GetMapiProperty(pMsg, PR_SUBJECT);</span>
<a href="#l20.868"></a><span id="l20.868">       ReportStringProp(&quot;PR_SUBJECT:&quot;, pVal);</span>
<a href="#l20.869"></a><span id="l20.869">       pVal = GetMapiProperty(pMsg, PR_DISPLAY_BCC);</span>
<a href="#l20.870"></a><span id="l20.870">       ReportStringProp(&quot;PR_DISPLAY_BCC:&quot;, pVal);</span>
<a href="#l20.871"></a><span id="l20.871">       pVal = GetMapiProperty(pMsg, PR_DISPLAY_CC);</span>
<a href="#l20.872"></a><span id="l20.872">       ReportStringProp(&quot;PR_DISPLAY_CC:&quot;, pVal);</span>
<a href="#l20.873"></a><span id="l20.873">       pVal = GetMapiProperty(pMsg, PR_DISPLAY_TO);</span>
<a href="#l20.874"></a><span id="l20.874">       ReportStringProp(&quot;PR_DISPLAY_TO:&quot;, pVal);</span>
<a href="#l20.875"></a><span id="l20.875">       pVal = GetMapiProperty(pMsg, PR_MESSAGE_CLASS);</span>
<a href="#l20.876"></a><span id="l20.876">       ReportStringProp(&quot;PR_MESSAGE_CLASS:&quot;, pVal);</span>
<a href="#l20.877"></a><span id="l20.877">       ListProperties(pMsg);</span>
<a href="#l20.878"></a><span id="l20.878">       pMsg-&gt;Release();</span>
<a href="#l20.879"></a><span id="l20.879" class="difflineminus">-    }</span>
<a href="#l20.880"></a><span id="l20.880" class="difflineminus">-    else {</span>
<a href="#l20.881"></a><span id="l20.881" class="difflineplus">+    } else {</span>
<a href="#l20.882"></a><span id="l20.882">       MAPI_TRACE0(&quot;    Folder type - error opening\n&quot;);</span>
<a href="#l20.883"></a><span id="l20.883">     }</span>
<a href="#l20.884"></a><span id="l20.884" class="difflineminus">-  }</span>
<a href="#l20.885"></a><span id="l20.885" class="difflineminus">-  else</span>
<a href="#l20.886"></a><span id="l20.886" class="difflineplus">+  } else</span>
<a href="#l20.887"></a><span id="l20.887">     MAPI_TRACE1(&quot;    ObjectType: %ld\n&quot;, oType);</span>
<a href="#l20.888"></a><span id="l20.888"> </span>
<a href="#l20.889"></a><span id="l20.889">   return TRUE;</span>
<a href="#l20.890"></a><span id="l20.890"> }</span>
<a href="#l20.891"></a><span id="l20.891"> </span>
<a href="#l20.892"></a><span id="l20.892" class="difflineminus">-void CMapiApi::ListProperties(LPMAPIPROP lpProp, BOOL getValues)</span>
<a href="#l20.893"></a><span id="l20.893" class="difflineminus">-{</span>
<a href="#l20.894"></a><span id="l20.894" class="difflineminus">-  LPSPropTagArray    pArray;</span>
<a href="#l20.895"></a><span id="l20.895" class="difflineminus">-  HRESULT        hr = lpProp-&gt;GetPropList(0, &amp;pArray);</span>
<a href="#l20.896"></a><span id="l20.896" class="difflineplus">+void CMapiApi::ListProperties(LPMAPIPROP lpProp, BOOL getValues) {</span>
<a href="#l20.897"></a><span id="l20.897" class="difflineplus">+  LPSPropTagArray pArray;</span>
<a href="#l20.898"></a><span id="l20.898" class="difflineplus">+  HRESULT hr = lpProp-&gt;GetPropList(0, &amp;pArray);</span>
<a href="#l20.899"></a><span id="l20.899">   if (FAILED(hr)) {</span>
<a href="#l20.900"></a><span id="l20.900">     MAPI_TRACE0(&quot;    Unable to retrieve property list\n&quot;);</span>
<a href="#l20.901"></a><span id="l20.901">     return;</span>
<a href="#l20.902"></a><span id="l20.902">   }</span>
<a href="#l20.903"></a><span id="l20.903">   ULONG count = 0;</span>
<a href="#l20.904"></a><span id="l20.904" class="difflineminus">-  LPMAPINAMEID FAR * lppPropNames;</span>
<a href="#l20.905"></a><span id="l20.905" class="difflineminus">-  SPropTagArray    tagArray;</span>
<a href="#l20.906"></a><span id="l20.906" class="difflineplus">+  LPMAPINAMEID FAR *lppPropNames;</span>
<a href="#l20.907"></a><span id="l20.907" class="difflineplus">+  SPropTagArray tagArray;</span>
<a href="#l20.908"></a><span id="l20.908">   LPSPropTagArray lpTagArray = &amp;tagArray;</span>
<a href="#l20.909"></a><span id="l20.909">   tagArray.cValues = (ULONG)1;</span>
<a href="#l20.910"></a><span id="l20.910" class="difflineminus">-  nsCString  desc;</span>
<a href="#l20.911"></a><span id="l20.911" class="difflineplus">+  nsCString desc;</span>
<a href="#l20.912"></a><span id="l20.912">   for (ULONG i = 0; i &lt; pArray-&gt;cValues; i++) {</span>
<a href="#l20.913"></a><span id="l20.913">     GetPropTagName(pArray-&gt;aulPropTag[i], desc);</span>
<a href="#l20.914"></a><span id="l20.914">     if (getValues) {</span>
<a href="#l20.915"></a><span id="l20.915">       tagArray.aulPropTag[0] = pArray-&gt;aulPropTag[i];</span>
<a href="#l20.916"></a><span id="l20.916" class="difflineminus">-      hr = lpProp-&gt;GetNamesFromIDs(&amp;lpTagArray, nullptr, 0, &amp;count, &amp;lppPropNames);</span>
<a href="#l20.917"></a><span id="l20.917" class="difflineminus">-      if (hr == S_OK)</span>
<a href="#l20.918"></a><span id="l20.918" class="difflineminus">-        MAPIFreeBuffer(lppPropNames);</span>
<a href="#l20.919"></a><span id="l20.919" class="difflineplus">+      hr = lpProp-&gt;GetNamesFromIDs(&amp;lpTagArray, nullptr, 0, &amp;count,</span>
<a href="#l20.920"></a><span id="l20.920" class="difflineplus">+                                   &amp;lppPropNames);</span>
<a href="#l20.921"></a><span id="l20.921" class="difflineplus">+      if (hr == S_OK) MAPIFreeBuffer(lppPropNames);</span>
<a href="#l20.922"></a><span id="l20.922"> </span>
<a href="#l20.923"></a><span id="l20.923">       LPSPropValue pVal = GetMapiProperty(lpProp, pArray-&gt;aulPropTag[i]);</span>
<a href="#l20.924"></a><span id="l20.924">       if (pVal) {</span>
<a href="#l20.925"></a><span id="l20.925">         desc += &quot;, &quot;;</span>
<a href="#l20.926"></a><span id="l20.926">         ListPropertyValue(pVal, desc);</span>
<a href="#l20.927"></a><span id="l20.927">         MAPIFreeBuffer(pVal);</span>
<a href="#l20.928"></a><span id="l20.928">       }</span>
<a href="#l20.929"></a><span id="l20.929">     }</span>
<a href="#l20.930"></a><span id="l20.930" class="difflineminus">-    MAPI_TRACE2(&quot;    Tag #%d: %s\n&quot;, (int) i, desc.get());</span>
<a href="#l20.931"></a><span id="l20.931" class="difflineplus">+    MAPI_TRACE2(&quot;    Tag #%d: %s\n&quot;, (int)i, desc.get());</span>
<a href="#l20.932"></a><span id="l20.932">   }</span>
<a href="#l20.933"></a><span id="l20.933"> </span>
<a href="#l20.934"></a><span id="l20.934">   MAPIFreeBuffer(pArray);</span>
<a href="#l20.935"></a><span id="l20.935"> }</span>
<a href="#l20.936"></a><span id="l20.936"> </span>
<a href="#l20.937"></a><span id="l20.937" class="difflineminus">-ULONG CMapiApi::GetEmailPropertyTag(LPMAPIPROP lpProp, LONG nameID)</span>
<a href="#l20.938"></a><span id="l20.938" class="difflineminus">-{</span>
<a href="#l20.939"></a><span id="l20.939" class="difflineminus">-static GUID emailGUID = {</span>
<a href="#l20.940"></a><span id="l20.940" class="difflineminus">-   0x00062004, 0x0000, 0x0000, { 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x46 }</span>
<a href="#l20.941"></a><span id="l20.941" class="difflineminus">-};</span>
<a href="#l20.942"></a><span id="l20.942" class="difflineplus">+ULONG CMapiApi::GetEmailPropertyTag(LPMAPIPROP lpProp, LONG nameID) {</span>
<a href="#l20.943"></a><span id="l20.943" class="difflineplus">+  static GUID emailGUID = {0x00062004,</span>
<a href="#l20.944"></a><span id="l20.944" class="difflineplus">+                           0x0000,</span>
<a href="#l20.945"></a><span id="l20.945" class="difflineplus">+                           0x0000,</span>
<a href="#l20.946"></a><span id="l20.946" class="difflineplus">+                           {0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x46}};</span>
<a href="#l20.947"></a><span id="l20.947"> </span>
<a href="#l20.948"></a><span id="l20.948">   MAPINAMEID mapiNameID;</span>
<a href="#l20.949"></a><span id="l20.949">   mapiNameID.lpguid = &amp;emailGUID;</span>
<a href="#l20.950"></a><span id="l20.950">   mapiNameID.ulKind = MNID_ID;</span>
<a href="#l20.951"></a><span id="l20.951">   mapiNameID.Kind.lID = nameID;</span>
<a href="#l20.952"></a><span id="l20.952"> </span>
<a href="#l20.953"></a><span id="l20.953">   LPMAPINAMEID lpMapiNames = &amp;mapiNameID;</span>
<a href="#l20.954"></a><span id="l20.954">   LPSPropTagArray lpMailTagArray = nullptr;</span>
<a href="#l20.955"></a><span id="l20.955"> </span>
<a href="#l20.956"></a><span id="l20.956" class="difflineminus">-  HRESULT result = lpProp-&gt;GetIDsFromNames(1L, &amp;lpMapiNames, 0, &amp;lpMailTagArray);</span>
<a href="#l20.957"></a><span id="l20.957" class="difflineminus">-  if (result == S_OK)</span>
<a href="#l20.958"></a><span id="l20.958" class="difflineminus">-  {</span>
<a href="#l20.959"></a><span id="l20.959" class="difflineplus">+  HRESULT result =</span>
<a href="#l20.960"></a><span id="l20.960" class="difflineplus">+      lpProp-&gt;GetIDsFromNames(1L, &amp;lpMapiNames, 0, &amp;lpMailTagArray);</span>
<a href="#l20.961"></a><span id="l20.961" class="difflineplus">+  if (result == S_OK) {</span>
<a href="#l20.962"></a><span id="l20.962">     ULONG lTag = lpMailTagArray-&gt;aulPropTag[0];</span>
<a href="#l20.963"></a><span id="l20.963">     MAPIFreeBuffer(lpMailTagArray);</span>
<a href="#l20.964"></a><span id="l20.964">     return lTag;</span>
<a href="#l20.965"></a><span id="l20.965" class="difflineminus">-  }</span>
<a href="#l20.966"></a><span id="l20.966" class="difflineminus">-  else</span>
<a href="#l20.967"></a><span id="l20.967" class="difflineplus">+  } else</span>
<a href="#l20.968"></a><span id="l20.968">     return 0L;</span>
<a href="#l20.969"></a><span id="l20.969"> }</span>
<a href="#l20.970"></a><span id="l20.970"> </span>
<a href="#l20.971"></a><span id="l20.971" class="difflineminus">-BOOL CMapiApi::HandleHierarchyItem(ULONG oType, ULONG cb, LPENTRYID pEntry)</span>
<a href="#l20.972"></a><span id="l20.972" class="difflineminus">-{</span>
<a href="#l20.973"></a><span id="l20.973" class="difflineplus">+BOOL CMapiApi::HandleHierarchyItem(ULONG oType, ULONG cb, LPENTRYID pEntry) {</span>
<a href="#l20.974"></a><span id="l20.974">   if (oType == MAPI_FOLDER) {</span>
<a href="#l20.975"></a><span id="l20.975">     LPMAPIFOLDER pFolder;</span>
<a href="#l20.976"></a><span id="l20.976" class="difflineminus">-    if (OpenEntry(cb, pEntry, (LPUNKNOWN *) &amp;pFolder)) {</span>
<a href="#l20.977"></a><span id="l20.977" class="difflineplus">+    if (OpenEntry(cb, pEntry, (LPUNKNOWN *)&amp;pFolder)) {</span>
<a href="#l20.978"></a><span id="l20.978">       LPSPropValue pVal;</span>
<a href="#l20.979"></a><span id="l20.979">       pVal = GetMapiProperty(pFolder, PR_DISPLAY_NAME);</span>
<a href="#l20.980"></a><span id="l20.980">       ReportStringProp(&quot;Folder name:&quot;, pVal);</span>
<a href="#l20.981"></a><span id="l20.981">       IterateContents(NULL, pFolder);</span>
<a href="#l20.982"></a><span id="l20.982">       IterateHierarchy(NULL, pFolder);</span>
<a href="#l20.983"></a><span id="l20.983">       pFolder-&gt;Release();</span>
<a href="#l20.984"></a><span id="l20.984" class="difflineminus">-    }</span>
<a href="#l20.985"></a><span id="l20.985" class="difflineminus">-    else {</span>
<a href="#l20.986"></a><span id="l20.986" class="difflineplus">+    } else {</span>
<a href="#l20.987"></a><span id="l20.987">       MAPI_TRACE0(&quot;    Folder type - error opening\n&quot;);</span>
<a href="#l20.988"></a><span id="l20.988">     }</span>
<a href="#l20.989"></a><span id="l20.989" class="difflineminus">-  }</span>
<a href="#l20.990"></a><span id="l20.990" class="difflineminus">-  else</span>
<a href="#l20.991"></a><span id="l20.991" class="difflineplus">+  } else</span>
<a href="#l20.992"></a><span id="l20.992">     MAPI_TRACE1(&quot;    ObjectType: %ld\n&quot;, oType);</span>
<a href="#l20.993"></a><span id="l20.993"> </span>
<a href="#l20.994"></a><span id="l20.994">   return TRUE;</span>
<a href="#l20.995"></a><span id="l20.995"> }</span>
<a href="#l20.996"></a><span id="l20.996"> </span>
<a href="#l20.997"></a><span id="l20.997" class="difflineminus">-BOOL CMapiApi::IterateHierarchy(CMapiHierarchyIter *pIter, LPMAPIFOLDER pFolder, ULONG flags)</span>
<a href="#l20.998"></a><span id="l20.998" class="difflineminus">-{</span>
<a href="#l20.999"></a><span id="l20.999" class="difflineplus">+BOOL CMapiApi::IterateHierarchy(CMapiHierarchyIter *pIter, LPMAPIFOLDER pFolder,</span>
<a href="#l20.1000"></a><span id="l20.1000" class="difflineplus">+                                ULONG flags) {</span>
<a href="#l20.1001"></a><span id="l20.1001">   // flags can be CONVENIENT_DEPTH or 0</span>
<a href="#l20.1002"></a><span id="l20.1002">   // CONVENIENT_DEPTH will return all depths I believe instead</span>
<a href="#l20.1003"></a><span id="l20.1003">   // of just children</span>
<a href="#l20.1004"></a><span id="l20.1004" class="difflineminus">-  HRESULT    hr;</span>
<a href="#l20.1005"></a><span id="l20.1005" class="difflineminus">-  LPMAPITABLE  lpTable;</span>
<a href="#l20.1006"></a><span id="l20.1006" class="difflineplus">+  HRESULT hr;</span>
<a href="#l20.1007"></a><span id="l20.1007" class="difflineplus">+  LPMAPITABLE lpTable;</span>
<a href="#l20.1008"></a><span id="l20.1008">   hr = pFolder-&gt;GetHierarchyTable(flags, &amp;lpTable);</span>
<a href="#l20.1009"></a><span id="l20.1009">   if (HR_FAILED(hr)) {</span>
<a href="#l20.1010"></a><span id="l20.1010">     m_lastError = hr;</span>
<a href="#l20.1011"></a><span id="l20.1011" class="difflineminus">-    MAPI_TRACE2(&quot;IterateHierarchy: GetContentsTable failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l20.1012"></a><span id="l20.1012" class="difflineplus">+    MAPI_TRACE2(&quot;IterateHierarchy: GetContentsTable failed: 0x%lx, %d\n&quot;,</span>
<a href="#l20.1013"></a><span id="l20.1013" class="difflineplus">+                (long)hr, (int)hr);</span>
<a href="#l20.1014"></a><span id="l20.1014">     return FALSE;</span>
<a href="#l20.1015"></a><span id="l20.1015">   }</span>
<a href="#l20.1016"></a><span id="l20.1016"> </span>
<a href="#l20.1017"></a><span id="l20.1017">   ULONG rowCount;</span>
<a href="#l20.1018"></a><span id="l20.1018">   hr = lpTable-&gt;GetRowCount(0, &amp;rowCount);</span>
<a href="#l20.1019"></a><span id="l20.1019">   if (!rowCount) {</span>
<a href="#l20.1020"></a><span id="l20.1020">     lpTable-&gt;Release();</span>
<a href="#l20.1021"></a><span id="l20.1021">     return TRUE;</span>
<a href="#l20.1022"></a><span id="l20.1022">   }</span>
<a href="#l20.1023"></a><span id="l20.1023"> </span>
<a href="#l20.1024"></a><span id="l20.1024">   hr = lpTable-&gt;SetColumns((LPSPropTagArray)&amp;ptaEid, 0);</span>
<a href="#l20.1025"></a><span id="l20.1025">   if (HR_FAILED(hr)) {</span>
<a href="#l20.1026"></a><span id="l20.1026">     m_lastError = hr;</span>
<a href="#l20.1027"></a><span id="l20.1027">     lpTable-&gt;Release();</span>
<a href="#l20.1028"></a><span id="l20.1028" class="difflineminus">-    MAPI_TRACE2(&quot;IterateHierarchy: SetColumns failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l20.1029"></a><span id="l20.1029" class="difflineplus">+    MAPI_TRACE2(&quot;IterateHierarchy: SetColumns failed: 0x%lx, %d\n&quot;, (long)hr,</span>
<a href="#l20.1030"></a><span id="l20.1030" class="difflineplus">+                (int)hr);</span>
<a href="#l20.1031"></a><span id="l20.1031">     return FALSE;</span>
<a href="#l20.1032"></a><span id="l20.1032">   }</span>
<a href="#l20.1033"></a><span id="l20.1033"> </span>
<a href="#l20.1034"></a><span id="l20.1034">   hr = lpTable-&gt;SeekRow(BOOKMARK_BEGINNING, 0, NULL);</span>
<a href="#l20.1035"></a><span id="l20.1035">   if (HR_FAILED(hr)) {</span>
<a href="#l20.1036"></a><span id="l20.1036">     m_lastError = hr;</span>
<a href="#l20.1037"></a><span id="l20.1037">     lpTable-&gt;Release();</span>
<a href="#l20.1038"></a><span id="l20.1038" class="difflineminus">-    MAPI_TRACE2(&quot;IterateHierarchy: SeekRow failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l20.1039"></a><span id="l20.1039" class="difflineplus">+    MAPI_TRACE2(&quot;IterateHierarchy: SeekRow failed: 0x%lx, %d\n&quot;, (long)hr,</span>
<a href="#l20.1040"></a><span id="l20.1040" class="difflineplus">+                (int)hr);</span>
<a href="#l20.1041"></a><span id="l20.1041">     return FALSE;</span>
<a href="#l20.1042"></a><span id="l20.1042">   }</span>
<a href="#l20.1043"></a><span id="l20.1043"> </span>
<a href="#l20.1044"></a><span id="l20.1044" class="difflineminus">-  int      cNumRows = 0;</span>
<a href="#l20.1045"></a><span id="l20.1045" class="difflineminus">-  LPSRowSet  lpRow;</span>
<a href="#l20.1046"></a><span id="l20.1046" class="difflineminus">-  BOOL    keepGoing = TRUE;</span>
<a href="#l20.1047"></a><span id="l20.1047" class="difflineminus">-  BOOL    bResult = TRUE;</span>
<a href="#l20.1048"></a><span id="l20.1048" class="difflineplus">+  int cNumRows = 0;</span>
<a href="#l20.1049"></a><span id="l20.1049" class="difflineplus">+  LPSRowSet lpRow;</span>
<a href="#l20.1050"></a><span id="l20.1050" class="difflineplus">+  BOOL keepGoing = TRUE;</span>
<a href="#l20.1051"></a><span id="l20.1051" class="difflineplus">+  BOOL bResult = TRUE;</span>
<a href="#l20.1052"></a><span id="l20.1052">   do {</span>
<a href="#l20.1053"></a><span id="l20.1053">     lpRow = NULL;</span>
<a href="#l20.1054"></a><span id="l20.1054">     hr = lpTable-&gt;QueryRows(1, 0, &amp;lpRow);</span>
<a href="#l20.1055"></a><span id="l20.1055"> </span>
<a href="#l20.1056"></a><span id="l20.1056" class="difflineminus">-    if(HR_FAILED(hr)) {</span>
<a href="#l20.1057"></a><span id="l20.1057" class="difflineplus">+    if (HR_FAILED(hr)) {</span>
<a href="#l20.1058"></a><span id="l20.1058">       MAPI_TRACE2(&quot;QueryRows failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l20.1059"></a><span id="l20.1059">       m_lastError = hr;</span>
<a href="#l20.1060"></a><span id="l20.1060">       bResult = FALSE;</span>
<a href="#l20.1061"></a><span id="l20.1061">       break;</span>
<a href="#l20.1062"></a><span id="l20.1062">     }</span>
<a href="#l20.1063"></a><span id="l20.1063"> </span>
<a href="#l20.1064"></a><span id="l20.1064" class="difflineminus">-    if(lpRow) {</span>
<a href="#l20.1065"></a><span id="l20.1065" class="difflineplus">+    if (lpRow) {</span>
<a href="#l20.1066"></a><span id="l20.1066">       cNumRows = lpRow-&gt;cRows;</span>
<a href="#l20.1067"></a><span id="l20.1067"> </span>
<a href="#l20.1068"></a><span id="l20.1068">       if (cNumRows) {</span>
<a href="#l20.1069"></a><span id="l20.1069" class="difflineminus">-        LPENTRYID  lpEntry = (LPENTRYID) lpRow-&gt;aRow[0].lpProps[ieidPR_ENTRYID].Value.bin.lpb;</span>
<a href="#l20.1070"></a><span id="l20.1070" class="difflineminus">-        ULONG    cb = lpRow-&gt;aRow[0].lpProps[ieidPR_ENTRYID].Value.bin.cb;</span>
<a href="#l20.1071"></a><span id="l20.1071" class="difflineminus">-        ULONG    oType = lpRow-&gt;aRow[0].lpProps[ieidPR_OBJECT_TYPE].Value.ul;</span>
<a href="#l20.1072"></a><span id="l20.1072" class="difflineplus">+        LPENTRYID lpEntry =</span>
<a href="#l20.1073"></a><span id="l20.1073" class="difflineplus">+            (LPENTRYID)lpRow-&gt;aRow[0].lpProps[ieidPR_ENTRYID].Value.bin.lpb;</span>
<a href="#l20.1074"></a><span id="l20.1074" class="difflineplus">+        ULONG cb = lpRow-&gt;aRow[0].lpProps[ieidPR_ENTRYID].Value.bin.cb;</span>
<a href="#l20.1075"></a><span id="l20.1075" class="difflineplus">+        ULONG oType = lpRow-&gt;aRow[0].lpProps[ieidPR_OBJECT_TYPE].Value.ul;</span>
<a href="#l20.1076"></a><span id="l20.1076"> </span>
<a href="#l20.1077"></a><span id="l20.1077">         if (pIter)</span>
<a href="#l20.1078"></a><span id="l20.1078">           keepGoing = pIter-&gt;HandleHierarchyItem(oType, cb, lpEntry);</span>
<a href="#l20.1079"></a><span id="l20.1079">         else</span>
<a href="#l20.1080"></a><span id="l20.1080">           keepGoing = HandleHierarchyItem(oType, cb, lpEntry);</span>
<a href="#l20.1081"></a><span id="l20.1081" class="difflineminus">-</span>
<a href="#l20.1082"></a><span id="l20.1082">       }</span>
<a href="#l20.1083"></a><span id="l20.1083">       FreeProws(lpRow);</span>
<a href="#l20.1084"></a><span id="l20.1084">     }</span>
<a href="#l20.1085"></a><span id="l20.1085">   } while (SUCCEEDED(hr) &amp;&amp; cNumRows &amp;&amp; lpRow &amp;&amp; keepGoing);</span>
<a href="#l20.1086"></a><span id="l20.1086"> </span>
<a href="#l20.1087"></a><span id="l20.1087">   lpTable-&gt;Release();</span>
<a href="#l20.1088"></a><span id="l20.1088"> </span>
<a href="#l20.1089"></a><span id="l20.1089" class="difflineminus">-  if (bResult &amp;&amp; !keepGoing)</span>
<a href="#l20.1090"></a><span id="l20.1090" class="difflineminus">-    bResult = FALSE;</span>
<a href="#l20.1091"></a><span id="l20.1091" class="difflineplus">+  if (bResult &amp;&amp; !keepGoing) bResult = FALSE;</span>
<a href="#l20.1092"></a><span id="l20.1092"> </span>
<a href="#l20.1093"></a><span id="l20.1093">   return bResult;</span>
<a href="#l20.1094"></a><span id="l20.1094"> }</span>
<a href="#l20.1095"></a><span id="l20.1095"> </span>
<a href="#l20.1096"></a><span id="l20.1096" class="difflineminus">-</span>
<a href="#l20.1097"></a><span id="l20.1097" class="difflineminus">-enum {</span>
<a href="#l20.1098"></a><span id="l20.1098" class="difflineminus">-  itblPR_DISPLAY_NAME,</span>
<a href="#l20.1099"></a><span id="l20.1099" class="difflineminus">-    itblPR_ENTRYID,</span>
<a href="#l20.1100"></a><span id="l20.1100" class="difflineminus">-    itblMax</span>
<a href="#l20.1101"></a><span id="l20.1101" class="difflineminus">-};</span>
<a href="#l20.1102"></a><span id="l20.1102" class="difflineplus">+enum { itblPR_DISPLAY_NAME, itblPR_ENTRYID, itblMax };</span>
<a href="#l20.1103"></a><span id="l20.1103"> </span>
<a href="#l20.1104"></a><span id="l20.1104" class="difflineminus">-static const SizedSPropTagArray(itblMax, ptaTbl)=</span>
<a href="#l20.1105"></a><span id="l20.1105" class="difflineminus">-{</span>
<a href="#l20.1106"></a><span id="l20.1106" class="difflineminus">-    itblMax,</span>
<a href="#l20.1107"></a><span id="l20.1107" class="difflineminus">-    {</span>
<a href="#l20.1108"></a><span id="l20.1108" class="difflineminus">-    PR_DISPLAY_NAME,</span>
<a href="#l20.1109"></a><span id="l20.1109" class="difflineminus">-        PR_ENTRYID,</span>
<a href="#l20.1110"></a><span id="l20.1110" class="difflineminus">-    }</span>
<a href="#l20.1111"></a><span id="l20.1111" class="difflineminus">-};</span>
<a href="#l20.1112"></a><span id="l20.1112" class="difflineplus">+static const SizedSPropTagArray(itblMax, ptaTbl) = {itblMax,</span>
<a href="#l20.1113"></a><span id="l20.1113" class="difflineplus">+                                                    {</span>
<a href="#l20.1114"></a><span id="l20.1114" class="difflineplus">+                                                        PR_DISPLAY_NAME,</span>
<a href="#l20.1115"></a><span id="l20.1115" class="difflineplus">+                                                        PR_ENTRYID,</span>
<a href="#l20.1116"></a><span id="l20.1116" class="difflineplus">+                                                    }};</span>
<a href="#l20.1117"></a><span id="l20.1117"> </span>
<a href="#l20.1118"></a><span id="l20.1118" class="difflineminus">-BOOL CMapiApi::IterateStores(CMapiFolderList&amp; stores)</span>
<a href="#l20.1119"></a><span id="l20.1119" class="difflineminus">-{</span>
<a href="#l20.1120"></a><span id="l20.1120" class="difflineplus">+BOOL CMapiApi::IterateStores(CMapiFolderList &amp;stores) {</span>
<a href="#l20.1121"></a><span id="l20.1121">   stores.ClearAll();</span>
<a href="#l20.1122"></a><span id="l20.1122"> </span>
<a href="#l20.1123"></a><span id="l20.1123">   if (!m_lpSession) {</span>
<a href="#l20.1124"></a><span id="l20.1124">     MAPI_TRACE0(&quot;IterateStores called before session is open\n&quot;);</span>
<a href="#l20.1125"></a><span id="l20.1125">     m_lastError = -1;</span>
<a href="#l20.1126"></a><span id="l20.1126">     return FALSE;</span>
<a href="#l20.1127"></a><span id="l20.1127">   }</span>
<a href="#l20.1128"></a><span id="l20.1128"> </span>
<a href="#l20.1129"></a><span id="l20.1129" class="difflineplus">+  HRESULT hr;</span>
<a href="#l20.1130"></a><span id="l20.1130"> </span>
<a href="#l20.1131"></a><span id="l20.1131" class="difflineminus">-  HRESULT    hr;</span>
<a href="#l20.1132"></a><span id="l20.1132" class="difflineplus">+  /* -- Some Microsoft sample code just to see if things are working --- */ /*</span>
<a href="#l20.1133"></a><span id="l20.1133"> </span>
<a href="#l20.1134"></a><span id="l20.1134" class="difflineminus">-  /* -- Some Microsoft sample code just to see if things are working --- *//*</span>
<a href="#l20.1135"></a><span id="l20.1135" class="difflineplus">+   ULONG    cbEIDStore;</span>
<a href="#l20.1136"></a><span id="l20.1136" class="difflineplus">+   LPENTRYID  lpEIDStore;</span>
<a href="#l20.1137"></a><span id="l20.1137"> </span>
<a href="#l20.1138"></a><span id="l20.1138" class="difflineminus">-  ULONG    cbEIDStore;</span>
<a href="#l20.1139"></a><span id="l20.1139" class="difflineminus">-  LPENTRYID  lpEIDStore;</span>
<a href="#l20.1140"></a><span id="l20.1140" class="difflineminus">-</span>
<a href="#l20.1141"></a><span id="l20.1141" class="difflineminus">-    hr = HrMAPIFindDefaultMsgStore(m_lpSession, &amp;cbEIDStore, &amp;lpEIDStore);</span>
<a href="#l20.1142"></a><span id="l20.1142" class="difflineminus">-    if (HR_FAILED(hr)) {</span>
<a href="#l20.1143"></a><span id="l20.1143" class="difflineminus">-        MAPI_TRACE0(&quot;Default message store not found\n&quot;);</span>
<a href="#l20.1144"></a><span id="l20.1144" class="difflineminus">-    // MessageBoxW(NULL, L&quot;Message Store Not Found&quot;, NULL, MB_OK);</span>
<a href="#l20.1145"></a><span id="l20.1145" class="difflineplus">+     hr = HrMAPIFindDefaultMsgStore(m_lpSession, &amp;cbEIDStore, &amp;lpEIDStore);</span>
<a href="#l20.1146"></a><span id="l20.1146" class="difflineplus">+     if (HR_FAILED(hr)) {</span>
<a href="#l20.1147"></a><span id="l20.1147" class="difflineplus">+         MAPI_TRACE0(&quot;Default message store not found\n&quot;);</span>
<a href="#l20.1148"></a><span id="l20.1148" class="difflineplus">+     // MessageBoxW(NULL, L&quot;Message Store Not Found&quot;, NULL, MB_OK);</span>
<a href="#l20.1149"></a><span id="l20.1149" class="difflineplus">+     }</span>
<a href="#l20.1150"></a><span id="l20.1150" class="difflineplus">+   else {</span>
<a href="#l20.1151"></a><span id="l20.1151" class="difflineplus">+     LPMDB  lpStore;</span>
<a href="#l20.1152"></a><span id="l20.1152" class="difflineplus">+     MAPI_TRACE0(&quot;Default Message store FOUND\n&quot;);</span>
<a href="#l20.1153"></a><span id="l20.1153" class="difflineplus">+     hr = m_lpSession-&gt;OpenMsgStore(NULL, cbEIDStore,</span>
<a href="#l20.1154"></a><span id="l20.1154" class="difflineplus">+                                   lpEIDStore, NULL,</span>
<a href="#l20.1155"></a><span id="l20.1155" class="difflineplus">+                                   MDB_NO_MAIL | MDB_NO_DIALOG, &amp;lpStore);</span>
<a href="#l20.1156"></a><span id="l20.1156" class="difflineplus">+     if (HR_FAILED(hr)) {</span>
<a href="#l20.1157"></a><span id="l20.1157" class="difflineplus">+       MAPI_TRACE1(&quot;Unable to open default message store: 0x%lx\n&quot;, hr);</span>
<a href="#l20.1158"></a><span id="l20.1158" class="difflineplus">+     }</span>
<a href="#l20.1159"></a><span id="l20.1159" class="difflineplus">+     else {</span>
<a href="#l20.1160"></a><span id="l20.1160" class="difflineplus">+       MAPI_TRACE0(&quot;Default message store OPENED\n&quot;);</span>
<a href="#l20.1161"></a><span id="l20.1161" class="difflineplus">+       lpStore-&gt;Release();</span>
<a href="#l20.1162"></a><span id="l20.1162" class="difflineplus">+     }</span>
<a href="#l20.1163"></a><span id="l20.1163">     }</span>
<a href="#l20.1164"></a><span id="l20.1164" class="difflineminus">-  else {</span>
<a href="#l20.1165"></a><span id="l20.1165" class="difflineminus">-    LPMDB  lpStore;</span>
<a href="#l20.1166"></a><span id="l20.1166" class="difflineminus">-    MAPI_TRACE0(&quot;Default Message store FOUND\n&quot;);</span>
<a href="#l20.1167"></a><span id="l20.1167" class="difflineminus">-    hr = m_lpSession-&gt;OpenMsgStore(NULL, cbEIDStore,</span>
<a href="#l20.1168"></a><span id="l20.1168" class="difflineminus">-                                  lpEIDStore, NULL,</span>
<a href="#l20.1169"></a><span id="l20.1169" class="difflineminus">-                                  MDB_NO_MAIL | MDB_NO_DIALOG, &amp;lpStore);</span>
<a href="#l20.1170"></a><span id="l20.1170" class="difflineminus">-    if (HR_FAILED(hr)) {</span>
<a href="#l20.1171"></a><span id="l20.1171" class="difflineminus">-      MAPI_TRACE1(&quot;Unable to open default message store: 0x%lx\n&quot;, hr);</span>
<a href="#l20.1172"></a><span id="l20.1172" class="difflineminus">-    }</span>
<a href="#l20.1173"></a><span id="l20.1173" class="difflineminus">-    else {</span>
<a href="#l20.1174"></a><span id="l20.1174" class="difflineminus">-      MAPI_TRACE0(&quot;Default message store OPENED\n&quot;);</span>
<a href="#l20.1175"></a><span id="l20.1175" class="difflineminus">-      lpStore-&gt;Release();</span>
<a href="#l20.1176"></a><span id="l20.1176" class="difflineminus">-    }</span>
<a href="#l20.1177"></a><span id="l20.1177" class="difflineminus">-   }</span>
<a href="#l20.1178"></a><span id="l20.1178" class="difflineminus">-     */</span>
<a href="#l20.1179"></a><span id="l20.1179" class="difflineplus">+      */</span>
<a href="#l20.1180"></a><span id="l20.1180"> </span>
<a href="#l20.1181"></a><span id="l20.1181" class="difflineminus">-</span>
<a href="#l20.1182"></a><span id="l20.1182" class="difflineminus">-</span>
<a href="#l20.1183"></a><span id="l20.1183" class="difflineminus">-  LPMAPITABLE  lpTable;</span>
<a href="#l20.1184"></a><span id="l20.1184" class="difflineplus">+  LPMAPITABLE lpTable;</span>
<a href="#l20.1185"></a><span id="l20.1185"> </span>
<a href="#l20.1186"></a><span id="l20.1186">   hr = m_lpSession-&gt;GetMsgStoresTable(0, &amp;lpTable);</span>
<a href="#l20.1187"></a><span id="l20.1187">   if (FAILED(hr)) {</span>
<a href="#l20.1188"></a><span id="l20.1188">     MAPI_TRACE0(&quot;GetMsgStoresTable failed\n&quot;);</span>
<a href="#l20.1189"></a><span id="l20.1189">     m_lastError = hr;</span>
<a href="#l20.1190"></a><span id="l20.1190">     return FALSE;</span>
<a href="#l20.1191"></a><span id="l20.1191">   }</span>
<a href="#l20.1192"></a><span id="l20.1192"> </span>
<a href="#l20.1193"></a><span id="l20.1193" class="difflineminus">-</span>
<a href="#l20.1194"></a><span id="l20.1194">   ULONG rowCount;</span>
<a href="#l20.1195"></a><span id="l20.1195">   hr = lpTable-&gt;GetRowCount(0, &amp;rowCount);</span>
<a href="#l20.1196"></a><span id="l20.1196">   MAPI_TRACE1(&quot;MsgStores Table rowCount: %ld\n&quot;, rowCount);</span>
<a href="#l20.1197"></a><span id="l20.1197"> </span>
<a href="#l20.1198"></a><span id="l20.1198">   hr = lpTable-&gt;SetColumns((LPSPropTagArray)&amp;ptaTbl, 0);</span>
<a href="#l20.1199"></a><span id="l20.1199">   if (FAILED(hr)) {</span>
<a href="#l20.1200"></a><span id="l20.1200">     lpTable-&gt;Release();</span>
<a href="#l20.1201"></a><span id="l20.1201">     MAPI_TRACE2(&quot;SetColumns failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l20.1202"></a><span id="l20.1202" class="difflineat">@@ -930,61 +874,66 @@ BOOL CMapiApi::IterateStores(CMapiFolder</span>
<a href="#l20.1203"></a><span id="l20.1203">   hr = lpTable-&gt;SeekRow(BOOKMARK_BEGINNING, 0, NULL);</span>
<a href="#l20.1204"></a><span id="l20.1204">   if (FAILED(hr)) {</span>
<a href="#l20.1205"></a><span id="l20.1205">     lpTable-&gt;Release();</span>
<a href="#l20.1206"></a><span id="l20.1206">     MAPI_TRACE2(&quot;SeekRow failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l20.1207"></a><span id="l20.1207">     m_lastError = hr;</span>
<a href="#l20.1208"></a><span id="l20.1208">     return FALSE;</span>
<a href="#l20.1209"></a><span id="l20.1209">   }</span>
<a href="#l20.1210"></a><span id="l20.1210"> </span>
<a href="#l20.1211"></a><span id="l20.1211" class="difflineminus">-  int      cNumRows = 0;</span>
<a href="#l20.1212"></a><span id="l20.1212" class="difflineminus">-  LPSRowSet  lpRow;</span>
<a href="#l20.1213"></a><span id="l20.1213" class="difflineminus">-  BOOL    keepGoing = TRUE;</span>
<a href="#l20.1214"></a><span id="l20.1214" class="difflineminus">-  BOOL    bResult = TRUE;</span>
<a href="#l20.1215"></a><span id="l20.1215" class="difflineplus">+  int cNumRows = 0;</span>
<a href="#l20.1216"></a><span id="l20.1216" class="difflineplus">+  LPSRowSet lpRow;</span>
<a href="#l20.1217"></a><span id="l20.1217" class="difflineplus">+  BOOL keepGoing = TRUE;</span>
<a href="#l20.1218"></a><span id="l20.1218" class="difflineplus">+  BOOL bResult = TRUE;</span>
<a href="#l20.1219"></a><span id="l20.1219">   do {</span>
<a href="#l20.1220"></a><span id="l20.1220">     lpRow = NULL;</span>
<a href="#l20.1221"></a><span id="l20.1221">     hr = lpTable-&gt;QueryRows(1, 0, &amp;lpRow);</span>
<a href="#l20.1222"></a><span id="l20.1222"> </span>
<a href="#l20.1223"></a><span id="l20.1223" class="difflineminus">-    if(HR_FAILED(hr)) {</span>
<a href="#l20.1224"></a><span id="l20.1224" class="difflineplus">+    if (HR_FAILED(hr)) {</span>
<a href="#l20.1225"></a><span id="l20.1225">       MAPI_TRACE2(&quot;QueryRows failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l20.1226"></a><span id="l20.1226">       bResult = FALSE;</span>
<a href="#l20.1227"></a><span id="l20.1227">       m_lastError = hr;</span>
<a href="#l20.1228"></a><span id="l20.1228">       break;</span>
<a href="#l20.1229"></a><span id="l20.1229">     }</span>
<a href="#l20.1230"></a><span id="l20.1230"> </span>
<a href="#l20.1231"></a><span id="l20.1231" class="difflineminus">-    if(lpRow) {</span>
<a href="#l20.1232"></a><span id="l20.1232" class="difflineplus">+    if (lpRow) {</span>
<a href="#l20.1233"></a><span id="l20.1233">       cNumRows = lpRow-&gt;cRows;</span>
<a href="#l20.1234"></a><span id="l20.1234"> </span>
<a href="#l20.1235"></a><span id="l20.1235">       if (cNumRows) {</span>
<a href="#l20.1236"></a><span id="l20.1236" class="difflineminus">-        LPCTSTR    lpStr = (LPCTSTR) lpRow-&gt;aRow[0].lpProps[itblPR_DISPLAY_NAME].Value.LPSZ;</span>
<a href="#l20.1237"></a><span id="l20.1237" class="difflineminus">-        LPENTRYID  lpEID = (LPENTRYID) lpRow-&gt;aRow[0].lpProps[itblPR_ENTRYID].Value.bin.lpb;</span>
<a href="#l20.1238"></a><span id="l20.1238" class="difflineminus">-        ULONG    cbEID = lpRow-&gt;aRow[0].lpProps[itblPR_ENTRYID].Value.bin.cb;</span>
<a href="#l20.1239"></a><span id="l20.1239" class="difflineplus">+        LPCTSTR lpStr =</span>
<a href="#l20.1240"></a><span id="l20.1240" class="difflineplus">+            (LPCTSTR)lpRow-&gt;aRow[0].lpProps[itblPR_DISPLAY_NAME].Value.LPSZ;</span>
<a href="#l20.1241"></a><span id="l20.1241" class="difflineplus">+        LPENTRYID lpEID =</span>
<a href="#l20.1242"></a><span id="l20.1242" class="difflineplus">+            (LPENTRYID)lpRow-&gt;aRow[0].lpProps[itblPR_ENTRYID].Value.bin.lpb;</span>
<a href="#l20.1243"></a><span id="l20.1243" class="difflineplus">+        ULONG cbEID = lpRow-&gt;aRow[0].lpProps[itblPR_ENTRYID].Value.bin.cb;</span>
<a href="#l20.1244"></a><span id="l20.1244"> </span>
<a href="#l20.1245"></a><span id="l20.1245">         // In the future, GetStoreInfo needs to somehow return</span>
<a href="#l20.1246"></a><span id="l20.1246">         // whether or not the store is from an IMAP server.</span>
<a href="#l20.1247"></a><span id="l20.1247">         // Currently, GetStoreInfo opens the store and attempts</span>
<a href="#l20.1248"></a><span id="l20.1248">         // to get the hierarchy tree.  If the tree is empty or</span>
<a href="#l20.1249"></a><span id="l20.1249">         // does not exist, then szContents will be zero.  We'll</span>
<a href="#l20.1250"></a><span id="l20.1250">         // assume that any store that doesn't have anything in</span>
<a href="#l20.1251"></a><span id="l20.1251">         // it's hierarchy tree is not a store we want to import -</span>
<a href="#l20.1252"></a><span id="l20.1252">         // there would be nothing to import from anyway!</span>
<a href="#l20.1253"></a><span id="l20.1253">         // Currently, this does exclude IMAP server accounts</span>
<a href="#l20.1254"></a><span id="l20.1254">         // which is the desired behaviour.</span>
<a href="#l20.1255"></a><span id="l20.1255"> </span>
<a href="#l20.1256"></a><span id="l20.1256" class="difflineminus">-        int         strLen = strlen(lpStr);</span>
<a href="#l20.1257"></a><span id="l20.1257" class="difflineminus">-        char16_t * pwszStr = (char16_t *) moz_xmalloc((strLen + 1) * sizeof(WCHAR));</span>
<a href="#l20.1258"></a><span id="l20.1258" class="difflineplus">+        int strLen = strlen(lpStr);</span>
<a href="#l20.1259"></a><span id="l20.1259" class="difflineplus">+        char16_t *pwszStr =</span>
<a href="#l20.1260"></a><span id="l20.1260" class="difflineplus">+            (char16_t *)moz_xmalloc((strLen + 1) * sizeof(WCHAR));</span>
<a href="#l20.1261"></a><span id="l20.1261">         if (!pwszStr) {</span>
<a href="#l20.1262"></a><span id="l20.1262">           // out of memory</span>
<a href="#l20.1263"></a><span id="l20.1263">           FreeProws(lpRow);</span>
<a href="#l20.1264"></a><span id="l20.1264">           lpTable-&gt;Release();</span>
<a href="#l20.1265"></a><span id="l20.1265">           return FALSE;</span>
<a href="#l20.1266"></a><span id="l20.1266">         }</span>
<a href="#l20.1267"></a><span id="l20.1267">         ::MultiByteToWideChar(CP_ACP, 0, lpStr, strlen(lpStr) + 1,</span>
<a href="#l20.1268"></a><span id="l20.1268" class="difflineminus">-          reinterpret_cast&lt;wchar_t*&gt;(pwszStr), (strLen + 1) * sizeof(WCHAR));</span>
<a href="#l20.1269"></a><span id="l20.1269" class="difflineminus">-        CMapiFolder *pFolder = new CMapiFolder(pwszStr, cbEID, lpEID, 0, MAPI_STORE);</span>
<a href="#l20.1270"></a><span id="l20.1270" class="difflineplus">+                              reinterpret_cast&lt;wchar_t *&gt;(pwszStr),</span>
<a href="#l20.1271"></a><span id="l20.1271" class="difflineplus">+                              (strLen + 1) * sizeof(WCHAR));</span>
<a href="#l20.1272"></a><span id="l20.1272" class="difflineplus">+        CMapiFolder *pFolder =</span>
<a href="#l20.1273"></a><span id="l20.1273" class="difflineplus">+            new CMapiFolder(pwszStr, cbEID, lpEID, 0, MAPI_STORE);</span>
<a href="#l20.1274"></a><span id="l20.1274">         free(pwszStr);</span>
<a href="#l20.1275"></a><span id="l20.1275"> </span>
<a href="#l20.1276"></a><span id="l20.1276">         long szContents = 1;</span>
<a href="#l20.1277"></a><span id="l20.1277">         GetStoreInfo(pFolder, &amp;szContents);</span>
<a href="#l20.1278"></a><span id="l20.1278"> </span>
<a href="#l20.1279"></a><span id="l20.1279">         MAPI_TRACE1(&quot;    DisplayName: %s\n&quot;, lpStr);</span>
<a href="#l20.1280"></a><span id="l20.1280">         if (szContents)</span>
<a href="#l20.1281"></a><span id="l20.1281">           stores.AddItem(pFolder);</span>
<a href="#l20.1282"></a><span id="l20.1282" class="difflineat">@@ -999,23 +948,21 @@ BOOL CMapiApi::IterateStores(CMapiFolder</span>
<a href="#l20.1283"></a><span id="l20.1283">     }</span>
<a href="#l20.1284"></a><span id="l20.1284">   } while (SUCCEEDED(hr) &amp;&amp; cNumRows &amp;&amp; lpRow &amp;&amp; keepGoing);</span>
<a href="#l20.1285"></a><span id="l20.1285"> </span>
<a href="#l20.1286"></a><span id="l20.1286">   lpTable-&gt;Release();</span>
<a href="#l20.1287"></a><span id="l20.1287"> </span>
<a href="#l20.1288"></a><span id="l20.1288">   return bResult;</span>
<a href="#l20.1289"></a><span id="l20.1289"> }</span>
<a href="#l20.1290"></a><span id="l20.1290"> </span>
<a href="#l20.1291"></a><span id="l20.1291" class="difflineminus">-void CMapiApi::GetStoreInfo(CMapiFolder *pFolder, long *pSzContents)</span>
<a href="#l20.1292"></a><span id="l20.1292" class="difflineminus">-{</span>
<a href="#l20.1293"></a><span id="l20.1293" class="difflineminus">-  HRESULT  hr;</span>
<a href="#l20.1294"></a><span id="l20.1294" class="difflineminus">-  LPMDB  lpMdb;</span>
<a href="#l20.1295"></a><span id="l20.1295" class="difflineplus">+void CMapiApi::GetStoreInfo(CMapiFolder *pFolder, long *pSzContents) {</span>
<a href="#l20.1296"></a><span id="l20.1296" class="difflineplus">+  HRESULT hr;</span>
<a href="#l20.1297"></a><span id="l20.1297" class="difflineplus">+  LPMDB lpMdb;</span>
<a href="#l20.1298"></a><span id="l20.1298"> </span>
<a href="#l20.1299"></a><span id="l20.1299" class="difflineminus">-  if (pSzContents)</span>
<a href="#l20.1300"></a><span id="l20.1300" class="difflineminus">-    *pSzContents = 0;</span>
<a href="#l20.1301"></a><span id="l20.1301" class="difflineplus">+  if (pSzContents) *pSzContents = 0;</span>
<a href="#l20.1302"></a><span id="l20.1302"> </span>
<a href="#l20.1303"></a><span id="l20.1303">   if (!OpenStore(pFolder-&gt;GetCBEntryID(), pFolder-&gt;GetEntryID(), &amp;lpMdb))</span>
<a href="#l20.1304"></a><span id="l20.1304">     return;</span>
<a href="#l20.1305"></a><span id="l20.1305"> </span>
<a href="#l20.1306"></a><span id="l20.1306">   LPSPropValue pVal;</span>
<a href="#l20.1307"></a><span id="l20.1307">   /*</span>
<a href="#l20.1308"></a><span id="l20.1308">   pVal = GetMapiProperty(lpMdb, PR_DISPLAY_NAME);</span>
<a href="#l20.1309"></a><span id="l20.1309">   ReportStringProp(&quot;    Message store name:&quot;, pVal);</span>
<a href="#l20.1310"></a><span id="l20.1310" class="difflineat">@@ -1036,94 +983,90 @@ void CMapiApi::GetStoreInfo(CMapiFolder </span>
<a href="#l20.1311"></a><span id="l20.1311"> </span>
<a href="#l20.1312"></a><span id="l20.1312">   pVal = GetMapiProperty(lpMdb, 0x8001001e);</span>
<a href="#l20.1313"></a><span id="l20.1313">   ReportStringProp(&quot;    Message prop 0x8001001e:&quot;, pVal);</span>
<a href="#l20.1314"></a><span id="l20.1314"> </span>
<a href="#l20.1315"></a><span id="l20.1315">   // This key appears to be the OMI Account Manager account that corresponds</span>
<a href="#l20.1316"></a><span id="l20.1316">   // to this message store.  This is important for IMAP accounts</span>
<a href="#l20.1317"></a><span id="l20.1317">   // since we may not want to import messages from an IMAP store!</span>
<a href="#l20.1318"></a><span id="l20.1318">   // Seems silly if you ask me!</span>
<a href="#l20.1319"></a><span id="l20.1319" class="difflineminus">-  // In order to test this, we'll need the registry key to look under to determine</span>
<a href="#l20.1320"></a><span id="l20.1320" class="difflineplus">+  // In order to test this, we'll need the registry key to look under to</span>
<a href="#l20.1321"></a><span id="l20.1321" class="difflineplus">+  determine</span>
<a href="#l20.1322"></a><span id="l20.1322">   // if it contains the &quot;IMAP Server&quot; value, if it does then we are an</span>
<a href="#l20.1323"></a><span id="l20.1323">   // IMAP store, if not, then we are a non-IMAP store - which may always mean</span>
<a href="#l20.1324"></a><span id="l20.1324">   // a regular store that should be imported.</span>
<a href="#l20.1325"></a><span id="l20.1325"> </span>
<a href="#l20.1326"></a><span id="l20.1326">   pVal = GetMapiProperty(lpMdb, 0x80000003);</span>
<a href="#l20.1327"></a><span id="l20.1327">   ReportLongProp(&quot;    Message prop 0x80000003:&quot;, pVal);</span>
<a href="#l20.1328"></a><span id="l20.1328"> </span>
<a href="#l20.1329"></a><span id="l20.1329">   // ListProperties(lpMdb);</span>
<a href="#l20.1330"></a><span id="l20.1330">   */</span>
<a href="#l20.1331"></a><span id="l20.1331"> </span>
<a href="#l20.1332"></a><span id="l20.1332">   pVal = GetMapiProperty(lpMdb, PR_IPM_SUBTREE_ENTRYID);</span>
<a href="#l20.1333"></a><span id="l20.1333">   if (pVal) {</span>
<a href="#l20.1334"></a><span id="l20.1334" class="difflineminus">-    ULONG      cbEntry;</span>
<a href="#l20.1335"></a><span id="l20.1335" class="difflineminus">-    LPENTRYID    pEntry;</span>
<a href="#l20.1336"></a><span id="l20.1336" class="difflineminus">-    LPMAPIFOLDER  lpSubTree = NULL;</span>
<a href="#l20.1337"></a><span id="l20.1337" class="difflineplus">+    ULONG cbEntry;</span>
<a href="#l20.1338"></a><span id="l20.1338" class="difflineplus">+    LPENTRYID pEntry;</span>
<a href="#l20.1339"></a><span id="l20.1339" class="difflineplus">+    LPMAPIFOLDER lpSubTree = NULL;</span>
<a href="#l20.1340"></a><span id="l20.1340"> </span>
<a href="#l20.1341"></a><span id="l20.1341">     if (GetEntryIdFromProp(pVal, cbEntry, pEntry)) {</span>
<a href="#l20.1342"></a><span id="l20.1342">       // Open up the folder!</span>
<a href="#l20.1343"></a><span id="l20.1343" class="difflineminus">-      ULONG    ulObjType;</span>
<a href="#l20.1344"></a><span id="l20.1344" class="difflineminus">-      hr = lpMdb-&gt;OpenEntry(cbEntry, pEntry, NULL, 0, &amp;ulObjType, (LPUNKNOWN *) &amp;lpSubTree);</span>
<a href="#l20.1345"></a><span id="l20.1345" class="difflineplus">+      ULONG ulObjType;</span>
<a href="#l20.1346"></a><span id="l20.1346" class="difflineplus">+      hr = lpMdb-&gt;OpenEntry(cbEntry, pEntry, NULL, 0, &amp;ulObjType,</span>
<a href="#l20.1347"></a><span id="l20.1347" class="difflineplus">+                            (LPUNKNOWN *)&amp;lpSubTree);</span>
<a href="#l20.1348"></a><span id="l20.1348">       MAPIFreeBuffer(pEntry);</span>
<a href="#l20.1349"></a><span id="l20.1349">       if (SUCCEEDED(hr) &amp;&amp; lpSubTree) {</span>
<a href="#l20.1350"></a><span id="l20.1350">         // Find out if there are any contents in the</span>
<a href="#l20.1351"></a><span id="l20.1351">         // tree.</span>
<a href="#l20.1352"></a><span id="l20.1352" class="difflineminus">-        LPMAPITABLE  lpTable;</span>
<a href="#l20.1353"></a><span id="l20.1353" class="difflineplus">+        LPMAPITABLE lpTable;</span>
<a href="#l20.1354"></a><span id="l20.1354">         hr = lpSubTree-&gt;GetHierarchyTable(0, &amp;lpTable);</span>
<a href="#l20.1355"></a><span id="l20.1355">         if (HR_FAILED(hr)) {</span>
<a href="#l20.1356"></a><span id="l20.1356" class="difflineminus">-          MAPI_TRACE2(&quot;GetStoreInfo: GetHierarchyTable failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l20.1357"></a><span id="l20.1357" class="difflineminus">-        }</span>
<a href="#l20.1358"></a><span id="l20.1358" class="difflineminus">-        else {</span>
<a href="#l20.1359"></a><span id="l20.1359" class="difflineplus">+          MAPI_TRACE2(&quot;GetStoreInfo: GetHierarchyTable failed: 0x%lx, %d\n&quot;,</span>
<a href="#l20.1360"></a><span id="l20.1360" class="difflineplus">+                      (long)hr, (int)hr);</span>
<a href="#l20.1361"></a><span id="l20.1361" class="difflineplus">+        } else {</span>
<a href="#l20.1362"></a><span id="l20.1362">           ULONG rowCount;</span>
<a href="#l20.1363"></a><span id="l20.1363">           hr = lpTable-&gt;GetRowCount(0, &amp;rowCount);</span>
<a href="#l20.1364"></a><span id="l20.1364">           lpTable-&gt;Release();</span>
<a href="#l20.1365"></a><span id="l20.1365" class="difflineminus">-          if (SUCCEEDED(hr) &amp;&amp; pSzContents)</span>
<a href="#l20.1366"></a><span id="l20.1366" class="difflineminus">-            *pSzContents = (long) rowCount;</span>
<a href="#l20.1367"></a><span id="l20.1367" class="difflineplus">+          if (SUCCEEDED(hr) &amp;&amp; pSzContents) *pSzContents = (long)rowCount;</span>
<a href="#l20.1368"></a><span id="l20.1368">         }</span>
<a href="#l20.1369"></a><span id="l20.1369"> </span>
<a href="#l20.1370"></a><span id="l20.1370">         lpSubTree-&gt;Release();</span>
<a href="#l20.1371"></a><span id="l20.1371">       }</span>
<a href="#l20.1372"></a><span id="l20.1372">     }</span>
<a href="#l20.1373"></a><span id="l20.1373">   }</span>
<a href="#l20.1374"></a><span id="l20.1374"> }</span>
<a href="#l20.1375"></a><span id="l20.1375"> </span>
<a href="#l20.1376"></a><span id="l20.1376" class="difflineminus">-</span>
<a href="#l20.1377"></a><span id="l20.1377" class="difflineminus">-void CMapiApi::ClearMessageStores(void)</span>
<a href="#l20.1378"></a><span id="l20.1378" class="difflineminus">-{</span>
<a href="#l20.1379"></a><span id="l20.1379" class="difflineplus">+void CMapiApi::ClearMessageStores(void) {</span>
<a href="#l20.1380"></a><span id="l20.1380">   if (m_pStores) {</span>
<a href="#l20.1381"></a><span id="l20.1381" class="difflineminus">-    CMsgStore *  pStore;</span>
<a href="#l20.1382"></a><span id="l20.1382" class="difflineplus">+    CMsgStore *pStore;</span>
<a href="#l20.1383"></a><span id="l20.1383">     for (size_t i = 0; i &lt; m_pStores-&gt;Length(); i++) {</span>
<a href="#l20.1384"></a><span id="l20.1384">       pStore = m_pStores-&gt;ElementAt(i);</span>
<a href="#l20.1385"></a><span id="l20.1385">       delete pStore;</span>
<a href="#l20.1386"></a><span id="l20.1386">     }</span>
<a href="#l20.1387"></a><span id="l20.1387">     m_pStores-&gt;Clear();</span>
<a href="#l20.1388"></a><span id="l20.1388">   }</span>
<a href="#l20.1389"></a><span id="l20.1389"> }</span>
<a href="#l20.1390"></a><span id="l20.1390"> </span>
<a href="#l20.1391"></a><span id="l20.1391" class="difflineminus">-void CMapiApi::AddMessageStore(CMsgStore *pStore)</span>
<a href="#l20.1392"></a><span id="l20.1392" class="difflineminus">-{</span>
<a href="#l20.1393"></a><span id="l20.1393" class="difflineminus">-  if (m_pStores)</span>
<a href="#l20.1394"></a><span id="l20.1394" class="difflineminus">-    m_pStores-&gt;AppendElement(pStore);</span>
<a href="#l20.1395"></a><span id="l20.1395" class="difflineplus">+void CMapiApi::AddMessageStore(CMsgStore *pStore) {</span>
<a href="#l20.1396"></a><span id="l20.1396" class="difflineplus">+  if (m_pStores) m_pStores-&gt;AppendElement(pStore);</span>
<a href="#l20.1397"></a><span id="l20.1397"> }</span>
<a href="#l20.1398"></a><span id="l20.1398"> </span>
<a href="#l20.1399"></a><span id="l20.1399" class="difflineminus">-CMsgStore *  CMapiApi::FindMessageStore(ULONG cbEid, LPENTRYID lpEid)</span>
<a href="#l20.1400"></a><span id="l20.1400" class="difflineminus">-{</span>
<a href="#l20.1401"></a><span id="l20.1401" class="difflineplus">+CMsgStore *CMapiApi::FindMessageStore(ULONG cbEid, LPENTRYID lpEid) {</span>
<a href="#l20.1402"></a><span id="l20.1402">   if (!m_lpSession) {</span>
<a href="#l20.1403"></a><span id="l20.1403">     MAPI_TRACE0(&quot;FindMessageStore called before session is open\n&quot;);</span>
<a href="#l20.1404"></a><span id="l20.1404">     m_lastError = -1;</span>
<a href="#l20.1405"></a><span id="l20.1405">     return NULL;</span>
<a href="#l20.1406"></a><span id="l20.1406">   }</span>
<a href="#l20.1407"></a><span id="l20.1407"> </span>
<a href="#l20.1408"></a><span id="l20.1408" class="difflineminus">-  ULONG    result;</span>
<a href="#l20.1409"></a><span id="l20.1409" class="difflineminus">-  HRESULT    hr;</span>
<a href="#l20.1410"></a><span id="l20.1410" class="difflineminus">-  CMsgStore *  pStore;</span>
<a href="#l20.1411"></a><span id="l20.1411" class="difflineplus">+  ULONG result;</span>
<a href="#l20.1412"></a><span id="l20.1412" class="difflineplus">+  HRESULT hr;</span>
<a href="#l20.1413"></a><span id="l20.1413" class="difflineplus">+  CMsgStore *pStore;</span>
<a href="#l20.1414"></a><span id="l20.1414">   for (size_t i = 0; i &lt; m_pStores-&gt;Length(); i++) {</span>
<a href="#l20.1415"></a><span id="l20.1415">     pStore = m_pStores-&gt;ElementAt(i);</span>
<a href="#l20.1416"></a><span id="l20.1416" class="difflineminus">-    hr = m_lpSession-&gt;CompareEntryIDs(cbEid, lpEid, pStore-&gt;GetCBEntryID(), pStore-&gt;GetLPEntryID(),</span>
<a href="#l20.1417"></a><span id="l20.1417" class="difflineminus">-                      0, &amp;result);</span>
<a href="#l20.1418"></a><span id="l20.1418" class="difflineplus">+    hr = m_lpSession-&gt;CompareEntryIDs(cbEid, lpEid, pStore-&gt;GetCBEntryID(),</span>
<a href="#l20.1419"></a><span id="l20.1419" class="difflineplus">+                                      pStore-&gt;GetLPEntryID(), 0, &amp;result);</span>
<a href="#l20.1420"></a><span id="l20.1420">     if (HR_FAILED(hr)) {</span>
<a href="#l20.1421"></a><span id="l20.1421">       MAPI_TRACE2(&quot;CompareEntryIDs failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l20.1422"></a><span id="l20.1422">       m_lastError = hr;</span>
<a href="#l20.1423"></a><span id="l20.1423">       return NULL;</span>
<a href="#l20.1424"></a><span id="l20.1424">     }</span>
<a href="#l20.1425"></a><span id="l20.1425">     if (result) {</span>
<a href="#l20.1426"></a><span id="l20.1426">       return pStore;</span>
<a href="#l20.1427"></a><span id="l20.1427">     }</span>
<a href="#l20.1428"></a><span id="l20.1428" class="difflineat">@@ -1133,792 +1076,770 @@ CMsgStore *  CMapiApi::FindMessageStore(</span>
<a href="#l20.1429"></a><span id="l20.1429">   AddMessageStore(pStore);</span>
<a href="#l20.1430"></a><span id="l20.1430">   return pStore;</span>
<a href="#l20.1431"></a><span id="l20.1431"> }</span>
<a href="#l20.1432"></a><span id="l20.1432"> </span>
<a href="#l20.1433"></a><span id="l20.1433"> // --------------------------------------------------------------------</span>
<a href="#l20.1434"></a><span id="l20.1434"> // Utility stuff</span>
<a href="#l20.1435"></a><span id="l20.1435"> // --------------------------------------------------------------------</span>
<a href="#l20.1436"></a><span id="l20.1436"> </span>
<a href="#l20.1437"></a><span id="l20.1437" class="difflineminus">-LPSPropValue CMapiApi::GetMapiProperty(LPMAPIPROP pProp, ULONG tag)</span>
<a href="#l20.1438"></a><span id="l20.1438" class="difflineminus">-{</span>
<a href="#l20.1439"></a><span id="l20.1439" class="difflineminus">-  if (!pProp)</span>
<a href="#l20.1440"></a><span id="l20.1440" class="difflineminus">-    return NULL;</span>
<a href="#l20.1441"></a><span id="l20.1441" class="difflineplus">+LPSPropValue CMapiApi::GetMapiProperty(LPMAPIPROP pProp, ULONG tag) {</span>
<a href="#l20.1442"></a><span id="l20.1442" class="difflineplus">+  if (!pProp) return NULL;</span>
<a href="#l20.1443"></a><span id="l20.1443"> </span>
<a href="#l20.1444"></a><span id="l20.1444" class="difflineminus">-  int  sz = CbNewSPropTagArray(1);</span>
<a href="#l20.1445"></a><span id="l20.1445" class="difflineminus">-  SPropTagArray *pTag = (SPropTagArray *) new char[sz];</span>
<a href="#l20.1446"></a><span id="l20.1446" class="difflineplus">+  int sz = CbNewSPropTagArray(1);</span>
<a href="#l20.1447"></a><span id="l20.1447" class="difflineplus">+  SPropTagArray *pTag = (SPropTagArray *)new char[sz];</span>
<a href="#l20.1448"></a><span id="l20.1448">   pTag-&gt;cValues = 1;</span>
<a href="#l20.1449"></a><span id="l20.1449">   pTag-&gt;aulPropTag[0] = tag;</span>
<a href="#l20.1450"></a><span id="l20.1450" class="difflineminus">-  LPSPropValue  lpProp = NULL;</span>
<a href="#l20.1451"></a><span id="l20.1451" class="difflineminus">-  ULONG  cValues = 0;</span>
<a href="#l20.1452"></a><span id="l20.1452" class="difflineplus">+  LPSPropValue lpProp = NULL;</span>
<a href="#l20.1453"></a><span id="l20.1453" class="difflineplus">+  ULONG cValues = 0;</span>
<a href="#l20.1454"></a><span id="l20.1454">   HRESULT hr = pProp-&gt;GetProps(pTag, 0, &amp;cValues, &amp;lpProp);</span>
<a href="#l20.1455"></a><span id="l20.1455" class="difflineminus">-  delete [] pTag;</span>
<a href="#l20.1456"></a><span id="l20.1456" class="difflineplus">+  delete[] pTag;</span>
<a href="#l20.1457"></a><span id="l20.1457">   if (HR_FAILED(hr) || (cValues != 1)) {</span>
<a href="#l20.1458"></a><span id="l20.1458" class="difflineminus">-    if (lpProp)</span>
<a href="#l20.1459"></a><span id="l20.1459" class="difflineminus">-      MAPIFreeBuffer(lpProp);</span>
<a href="#l20.1460"></a><span id="l20.1460" class="difflineplus">+    if (lpProp) MAPIFreeBuffer(lpProp);</span>
<a href="#l20.1461"></a><span id="l20.1461">     return NULL;</span>
<a href="#l20.1462"></a><span id="l20.1462" class="difflineminus">-  }</span>
<a href="#l20.1463"></a><span id="l20.1463" class="difflineminus">-  else {</span>
<a href="#l20.1464"></a><span id="l20.1464" class="difflineplus">+  } else {</span>
<a href="#l20.1465"></a><span id="l20.1465">     if (PROP_TYPE(lpProp-&gt;ulPropTag) == PT_ERROR) {</span>
<a href="#l20.1466"></a><span id="l20.1466">       if (lpProp-&gt;Value.l == MAPI_E_NOT_FOUND) {</span>
<a href="#l20.1467"></a><span id="l20.1467">         MAPIFreeBuffer(lpProp);</span>
<a href="#l20.1468"></a><span id="l20.1468">         lpProp = NULL;</span>
<a href="#l20.1469"></a><span id="l20.1469">       }</span>
<a href="#l20.1470"></a><span id="l20.1470">     }</span>
<a href="#l20.1471"></a><span id="l20.1471">   }</span>
<a href="#l20.1472"></a><span id="l20.1472"> </span>
<a href="#l20.1473"></a><span id="l20.1473">   return lpProp;</span>
<a href="#l20.1474"></a><span id="l20.1474"> }</span>
<a href="#l20.1475"></a><span id="l20.1475"> </span>
<a href="#l20.1476"></a><span id="l20.1476" class="difflineminus">-BOOL CMapiApi::IsLargeProperty(LPSPropValue pVal)</span>
<a href="#l20.1477"></a><span id="l20.1477" class="difflineminus">-{</span>
<a href="#l20.1478"></a><span id="l20.1478" class="difflineminus">-  return ((PROP_TYPE(pVal-&gt;ulPropTag) == PT_ERROR) &amp;&amp; (pVal-&gt;Value.l == E_OUTOFMEMORY));</span>
<a href="#l20.1479"></a><span id="l20.1479" class="difflineplus">+BOOL CMapiApi::IsLargeProperty(LPSPropValue pVal) {</span>
<a href="#l20.1480"></a><span id="l20.1480" class="difflineplus">+  return ((PROP_TYPE(pVal-&gt;ulPropTag) == PT_ERROR) &amp;&amp;</span>
<a href="#l20.1481"></a><span id="l20.1481" class="difflineplus">+          (pVal-&gt;Value.l == E_OUTOFMEMORY));</span>
<a href="#l20.1482"></a><span id="l20.1482"> }</span>
<a href="#l20.1483"></a><span id="l20.1483"> </span>
<a href="#l20.1484"></a><span id="l20.1484"> // The output buffer (result) must be freed with operator delete[]</span>
<a href="#l20.1485"></a><span id="l20.1485" class="difflineminus">-BOOL CMapiApi::GetLargeProperty(LPMAPIPROP pProp, ULONG tag, void** result)</span>
<a href="#l20.1486"></a><span id="l20.1486" class="difflineminus">-{</span>
<a href="#l20.1487"></a><span id="l20.1487" class="difflineminus">-  LPSTREAM  lpStream;</span>
<a href="#l20.1488"></a><span id="l20.1488" class="difflineminus">-  HRESULT    hr = pProp-&gt;OpenProperty(tag, &amp;IID_IStream, 0, 0, (LPUNKNOWN *)&amp;lpStream);</span>
<a href="#l20.1489"></a><span id="l20.1489" class="difflineminus">-  if (HR_FAILED(hr))</span>
<a href="#l20.1490"></a><span id="l20.1490" class="difflineminus">-    return FALSE;</span>
<a href="#l20.1491"></a><span id="l20.1491" class="difflineminus">-  STATSTG    st;</span>
<a href="#l20.1492"></a><span id="l20.1492" class="difflineplus">+BOOL CMapiApi::GetLargeProperty(LPMAPIPROP pProp, ULONG tag, void **result) {</span>
<a href="#l20.1493"></a><span id="l20.1493" class="difflineplus">+  LPSTREAM lpStream;</span>
<a href="#l20.1494"></a><span id="l20.1494" class="difflineplus">+  HRESULT hr =</span>
<a href="#l20.1495"></a><span id="l20.1495" class="difflineplus">+      pProp-&gt;OpenProperty(tag, &amp;IID_IStream, 0, 0, (LPUNKNOWN *)&amp;lpStream);</span>
<a href="#l20.1496"></a><span id="l20.1496" class="difflineplus">+  if (HR_FAILED(hr)) return FALSE;</span>
<a href="#l20.1497"></a><span id="l20.1497" class="difflineplus">+  STATSTG st;</span>
<a href="#l20.1498"></a><span id="l20.1498">   BOOL bResult = TRUE;</span>
<a href="#l20.1499"></a><span id="l20.1499">   hr = lpStream-&gt;Stat(&amp;st, STATFLAG_NONAME);</span>
<a href="#l20.1500"></a><span id="l20.1500">   if (HR_FAILED(hr))</span>
<a href="#l20.1501"></a><span id="l20.1501">     bResult = FALSE;</span>
<a href="#l20.1502"></a><span id="l20.1502">   else {</span>
<a href="#l20.1503"></a><span id="l20.1503" class="difflineminus">-    if (!st.cbSize.QuadPart)</span>
<a href="#l20.1504"></a><span id="l20.1504" class="difflineminus">-      st.cbSize.QuadPart = 1;</span>
<a href="#l20.1505"></a><span id="l20.1505" class="difflineminus">-    char *pVal = new char[ (int) st.cbSize.QuadPart + 2];</span>
<a href="#l20.1506"></a><span id="l20.1506" class="difflineplus">+    if (!st.cbSize.QuadPart) st.cbSize.QuadPart = 1;</span>
<a href="#l20.1507"></a><span id="l20.1507" class="difflineplus">+    char *pVal = new char[(int)st.cbSize.QuadPart + 2];</span>
<a href="#l20.1508"></a><span id="l20.1508">     if (pVal) {</span>
<a href="#l20.1509"></a><span id="l20.1509" class="difflineminus">-      ULONG  sz;</span>
<a href="#l20.1510"></a><span id="l20.1510" class="difflineminus">-      hr = lpStream-&gt;Read(pVal, (ULONG) st.cbSize.QuadPart, &amp;sz);</span>
<a href="#l20.1511"></a><span id="l20.1511" class="difflineplus">+      ULONG sz;</span>
<a href="#l20.1512"></a><span id="l20.1512" class="difflineplus">+      hr = lpStream-&gt;Read(pVal, (ULONG)st.cbSize.QuadPart, &amp;sz);</span>
<a href="#l20.1513"></a><span id="l20.1513">       if (HR_FAILED(hr)) {</span>
<a href="#l20.1514"></a><span id="l20.1514">         bResult = FALSE;</span>
<a href="#l20.1515"></a><span id="l20.1515">         delete[] pVal;</span>
<a href="#l20.1516"></a><span id="l20.1516" class="difflineminus">-      }</span>
<a href="#l20.1517"></a><span id="l20.1517" class="difflineminus">-      else {</span>
<a href="#l20.1518"></a><span id="l20.1518" class="difflineminus">-         // Just in case it's a UTF16 string</span>
<a href="#l20.1519"></a><span id="l20.1519" class="difflineminus">-        pVal[(int) st.cbSize.QuadPart] = pVal[(int) st.cbSize.QuadPart+1] = 0;</span>
<a href="#l20.1520"></a><span id="l20.1520" class="difflineplus">+      } else {</span>
<a href="#l20.1521"></a><span id="l20.1521" class="difflineplus">+        // Just in case it's a UTF16 string</span>
<a href="#l20.1522"></a><span id="l20.1522" class="difflineplus">+        pVal[(int)st.cbSize.QuadPart] = pVal[(int)st.cbSize.QuadPart + 1] = 0;</span>
<a href="#l20.1523"></a><span id="l20.1523">         *result = pVal;</span>
<a href="#l20.1524"></a><span id="l20.1524">       }</span>
<a href="#l20.1525"></a><span id="l20.1525" class="difflineminus">-    }</span>
<a href="#l20.1526"></a><span id="l20.1526" class="difflineminus">-    else</span>
<a href="#l20.1527"></a><span id="l20.1527" class="difflineplus">+    } else</span>
<a href="#l20.1528"></a><span id="l20.1528">       bResult = FALSE;</span>
<a href="#l20.1529"></a><span id="l20.1529">   }</span>
<a href="#l20.1530"></a><span id="l20.1530"> </span>
<a href="#l20.1531"></a><span id="l20.1531">   lpStream-&gt;Release();</span>
<a href="#l20.1532"></a><span id="l20.1532"> </span>
<a href="#l20.1533"></a><span id="l20.1533">   return bResult;</span>
<a href="#l20.1534"></a><span id="l20.1534"> }</span>
<a href="#l20.1535"></a><span id="l20.1535"> </span>
<a href="#l20.1536"></a><span id="l20.1536" class="difflineminus">-BOOL CMapiApi::GetLargeStringProperty(LPMAPIPROP pProp, ULONG tag, nsCString&amp; val)</span>
<a href="#l20.1537"></a><span id="l20.1537" class="difflineminus">-{</span>
<a href="#l20.1538"></a><span id="l20.1538" class="difflineminus">-  void* result;</span>
<a href="#l20.1539"></a><span id="l20.1539" class="difflineminus">-  if (!GetLargeProperty(pProp, tag, &amp;result))</span>
<a href="#l20.1540"></a><span id="l20.1540" class="difflineminus">-    return FALSE;</span>
<a href="#l20.1541"></a><span id="l20.1541" class="difflineminus">-  if (PROP_TYPE(tag) == PT_UNICODE) // unicode string</span>
<a href="#l20.1542"></a><span id="l20.1542" class="difflineminus">-    LossyCopyUTF16toASCII(nsDependentString(static_cast&lt;wchar_t*&gt;(result)), val);</span>
<a href="#l20.1543"></a><span id="l20.1543" class="difflineminus">-  else // either PT_STRING8 or some other binary - use as is</span>
<a href="#l20.1544"></a><span id="l20.1544" class="difflineminus">-    val.Assign(static_cast&lt;char*&gt;(result));</span>
<a href="#l20.1545"></a><span id="l20.1545" class="difflineminus">-  // Despite being used as wchar_t*, result it allocated as &quot;new char[]&quot; in GetLargeProperty().</span>
<a href="#l20.1546"></a><span id="l20.1546" class="difflineminus">-  delete[] static_cast&lt;char*&gt;(result);</span>
<a href="#l20.1547"></a><span id="l20.1547" class="difflineplus">+BOOL CMapiApi::GetLargeStringProperty(LPMAPIPROP pProp, ULONG tag,</span>
<a href="#l20.1548"></a><span id="l20.1548" class="difflineplus">+                                      nsCString &amp;val) {</span>
<a href="#l20.1549"></a><span id="l20.1549" class="difflineplus">+  void *result;</span>
<a href="#l20.1550"></a><span id="l20.1550" class="difflineplus">+  if (!GetLargeProperty(pProp, tag, &amp;result)) return FALSE;</span>
<a href="#l20.1551"></a><span id="l20.1551" class="difflineplus">+  if (PROP_TYPE(tag) == PT_UNICODE)  // unicode string</span>
<a href="#l20.1552"></a><span id="l20.1552" class="difflineplus">+    LossyCopyUTF16toASCII(nsDependentString(static_cast&lt;wchar_t *&gt;(result)),</span>
<a href="#l20.1553"></a><span id="l20.1553" class="difflineplus">+                          val);</span>
<a href="#l20.1554"></a><span id="l20.1554" class="difflineplus">+  else  // either PT_STRING8 or some other binary - use as is</span>
<a href="#l20.1555"></a><span id="l20.1555" class="difflineplus">+    val.Assign(static_cast&lt;char *&gt;(result));</span>
<a href="#l20.1556"></a><span id="l20.1556" class="difflineplus">+  // Despite being used as wchar_t*, result it allocated as &quot;new char[]&quot; in</span>
<a href="#l20.1557"></a><span id="l20.1557" class="difflineplus">+  // GetLargeProperty().</span>
<a href="#l20.1558"></a><span id="l20.1558" class="difflineplus">+  delete[] static_cast&lt;char *&gt;(result);</span>
<a href="#l20.1559"></a><span id="l20.1559">   return TRUE;</span>
<a href="#l20.1560"></a><span id="l20.1560"> }</span>
<a href="#l20.1561"></a><span id="l20.1561"> </span>
<a href="#l20.1562"></a><span id="l20.1562" class="difflineminus">-BOOL CMapiApi::GetLargeStringProperty(LPMAPIPROP pProp, ULONG tag, nsString&amp; val)</span>
<a href="#l20.1563"></a><span id="l20.1563" class="difflineminus">-{</span>
<a href="#l20.1564"></a><span id="l20.1564" class="difflineminus">-  void* result;</span>
<a href="#l20.1565"></a><span id="l20.1565" class="difflineminus">-  if (!GetLargeProperty(pProp, tag, &amp;result))</span>
<a href="#l20.1566"></a><span id="l20.1566" class="difflineminus">-    return FALSE;</span>
<a href="#l20.1567"></a><span id="l20.1567" class="difflineminus">-  if (PROP_TYPE(tag) == PT_UNICODE) // We already get the unicode string</span>
<a href="#l20.1568"></a><span id="l20.1568" class="difflineminus">-    val.Assign(static_cast&lt;wchar_t*&gt;(result));</span>
<a href="#l20.1569"></a><span id="l20.1569" class="difflineminus">-  else // either PT_STRING8 or some other binary</span>
<a href="#l20.1570"></a><span id="l20.1570" class="difflineminus">-    CStrToUnicode(static_cast&lt;char*&gt;(result), val);</span>
<a href="#l20.1571"></a><span id="l20.1571" class="difflineminus">-  // Despite being used as wchar_t*, result it allocated as &quot;new char[]&quot; in GetLargeProperty().</span>
<a href="#l20.1572"></a><span id="l20.1572" class="difflineminus">-  delete[] static_cast&lt;char*&gt;(result);</span>
<a href="#l20.1573"></a><span id="l20.1573" class="difflineplus">+BOOL CMapiApi::GetLargeStringProperty(LPMAPIPROP pProp, ULONG tag,</span>
<a href="#l20.1574"></a><span id="l20.1574" class="difflineplus">+                                      nsString &amp;val) {</span>
<a href="#l20.1575"></a><span id="l20.1575" class="difflineplus">+  void *result;</span>
<a href="#l20.1576"></a><span id="l20.1576" class="difflineplus">+  if (!GetLargeProperty(pProp, tag, &amp;result)) return FALSE;</span>
<a href="#l20.1577"></a><span id="l20.1577" class="difflineplus">+  if (PROP_TYPE(tag) == PT_UNICODE)  // We already get the unicode string</span>
<a href="#l20.1578"></a><span id="l20.1578" class="difflineplus">+    val.Assign(static_cast&lt;wchar_t *&gt;(result));</span>
<a href="#l20.1579"></a><span id="l20.1579" class="difflineplus">+  else  // either PT_STRING8 or some other binary</span>
<a href="#l20.1580"></a><span id="l20.1580" class="difflineplus">+    CStrToUnicode(static_cast&lt;char *&gt;(result), val);</span>
<a href="#l20.1581"></a><span id="l20.1581" class="difflineplus">+  // Despite being used as wchar_t*, result it allocated as &quot;new char[]&quot; in</span>
<a href="#l20.1582"></a><span id="l20.1582" class="difflineplus">+  // GetLargeProperty().</span>
<a href="#l20.1583"></a><span id="l20.1583" class="difflineplus">+  delete[] static_cast&lt;char *&gt;(result);</span>
<a href="#l20.1584"></a><span id="l20.1584">   return TRUE;</span>
<a href="#l20.1585"></a><span id="l20.1585"> }</span>
<a href="#l20.1586"></a><span id="l20.1586"> // If the value is a string, get it...</span>
<a href="#l20.1587"></a><span id="l20.1587" class="difflineminus">-BOOL CMapiApi::GetEntryIdFromProp(LPSPropValue pVal, ULONG&amp; cbEntryId,</span>
<a href="#l20.1588"></a><span id="l20.1588" class="difflineminus">-                                  LPENTRYID&amp; lpEntryId, BOOL delVal)</span>
<a href="#l20.1589"></a><span id="l20.1589" class="difflineminus">-{</span>
<a href="#l20.1590"></a><span id="l20.1590" class="difflineminus">-  if (!pVal)</span>
<a href="#l20.1591"></a><span id="l20.1591" class="difflineminus">-    return FALSE;</span>
<a href="#l20.1592"></a><span id="l20.1592" class="difflineplus">+BOOL CMapiApi::GetEntryIdFromProp(LPSPropValue pVal, ULONG &amp;cbEntryId,</span>
<a href="#l20.1593"></a><span id="l20.1593" class="difflineplus">+                                  LPENTRYID &amp;lpEntryId, BOOL delVal) {</span>
<a href="#l20.1594"></a><span id="l20.1594" class="difflineplus">+  if (!pVal) return FALSE;</span>
<a href="#l20.1595"></a><span id="l20.1595"> </span>
<a href="#l20.1596"></a><span id="l20.1596">   BOOL bResult = TRUE;</span>
<a href="#l20.1597"></a><span id="l20.1597" class="difflineminus">-    switch(PROP_TYPE(pVal-&gt;ulPropTag)) {</span>
<a href="#l20.1598"></a><span id="l20.1598" class="difflineplus">+  switch (PROP_TYPE(pVal-&gt;ulPropTag)) {</span>
<a href="#l20.1599"></a><span id="l20.1599">     case PT_BINARY:</span>
<a href="#l20.1600"></a><span id="l20.1600">       cbEntryId = pVal-&gt;Value.bin.cb;</span>
<a href="#l20.1601"></a><span id="l20.1601" class="difflineminus">-      MAPIAllocateBuffer(cbEntryId, (LPVOID *) &amp;lpEntryId);</span>
<a href="#l20.1602"></a><span id="l20.1602" class="difflineplus">+      MAPIAllocateBuffer(cbEntryId, (LPVOID *)&amp;lpEntryId);</span>
<a href="#l20.1603"></a><span id="l20.1603">       memcpy(lpEntryId, pVal-&gt;Value.bin.lpb, cbEntryId);</span>
<a href="#l20.1604"></a><span id="l20.1604" class="difflineminus">-    break;</span>
<a href="#l20.1605"></a><span id="l20.1605" class="difflineplus">+      break;</span>
<a href="#l20.1606"></a><span id="l20.1606"> </span>
<a href="#l20.1607"></a><span id="l20.1607">     default:</span>
<a href="#l20.1608"></a><span id="l20.1608">       MAPI_TRACE0(&quot;EntryId not in BINARY prop value\n&quot;);</span>
<a href="#l20.1609"></a><span id="l20.1609">       bResult = FALSE;</span>
<a href="#l20.1610"></a><span id="l20.1610" class="difflineminus">-        break;</span>
<a href="#l20.1611"></a><span id="l20.1611" class="difflineminus">-    }</span>
<a href="#l20.1612"></a><span id="l20.1612" class="difflineplus">+      break;</span>
<a href="#l20.1613"></a><span id="l20.1613" class="difflineplus">+  }</span>
<a href="#l20.1614"></a><span id="l20.1614"> </span>
<a href="#l20.1615"></a><span id="l20.1615" class="difflineminus">-  if (pVal &amp;&amp; delVal)</span>
<a href="#l20.1616"></a><span id="l20.1616" class="difflineminus">-    MAPIFreeBuffer(pVal);</span>
<a href="#l20.1617"></a><span id="l20.1617" class="difflineplus">+  if (pVal &amp;&amp; delVal) MAPIFreeBuffer(pVal);</span>
<a href="#l20.1618"></a><span id="l20.1618"> </span>
<a href="#l20.1619"></a><span id="l20.1619">   return bResult;</span>
<a href="#l20.1620"></a><span id="l20.1620"> }</span>
<a href="#l20.1621"></a><span id="l20.1621"> </span>
<a href="#l20.1622"></a><span id="l20.1622" class="difflineminus">-BOOL CMapiApi::GetStringFromProp(LPSPropValue pVal, nsCString&amp; val, BOOL delVal)</span>
<a href="#l20.1623"></a><span id="l20.1623" class="difflineminus">-{</span>
<a href="#l20.1624"></a><span id="l20.1624" class="difflineplus">+BOOL CMapiApi::GetStringFromProp(LPSPropValue pVal, nsCString &amp;val,</span>
<a href="#l20.1625"></a><span id="l20.1625" class="difflineplus">+                                 BOOL delVal) {</span>
<a href="#l20.1626"></a><span id="l20.1626">   BOOL bResult = TRUE;</span>
<a href="#l20.1627"></a><span id="l20.1627">   if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_STRING8))</span>
<a href="#l20.1628"></a><span id="l20.1628">     val = pVal-&gt;Value.lpszA;</span>
<a href="#l20.1629"></a><span id="l20.1629">   else if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_UNICODE))</span>
<a href="#l20.1630"></a><span id="l20.1630">     LossyCopyUTF16toASCII(nsDependentString(pVal-&gt;Value.lpszW), val);</span>
<a href="#l20.1631"></a><span id="l20.1631">   else if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_NULL))</span>
<a href="#l20.1632"></a><span id="l20.1632">     val.Truncate();</span>
<a href="#l20.1633"></a><span id="l20.1633">   else if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_ERROR)) {</span>
<a href="#l20.1634"></a><span id="l20.1634">     val.Truncate();</span>
<a href="#l20.1635"></a><span id="l20.1635">     bResult = FALSE;</span>
<a href="#l20.1636"></a><span id="l20.1636" class="difflineminus">-  }</span>
<a href="#l20.1637"></a><span id="l20.1637" class="difflineminus">-  else {</span>
<a href="#l20.1638"></a><span id="l20.1638" class="difflineplus">+  } else {</span>
<a href="#l20.1639"></a><span id="l20.1639">     if (pVal) {</span>
<a href="#l20.1640"></a><span id="l20.1640" class="difflineminus">-      MAPI_TRACE1(&quot;GetStringFromProp: invalid value, expecting string - %d\n&quot;, (int) PROP_TYPE(pVal-&gt;ulPropTag));</span>
<a href="#l20.1641"></a><span id="l20.1641" class="difflineminus">-    }</span>
<a href="#l20.1642"></a><span id="l20.1642" class="difflineminus">-    else {</span>
<a href="#l20.1643"></a><span id="l20.1643" class="difflineminus">-      MAPI_TRACE0(&quot;GetStringFromProp: invalid value, expecting string, got null pointer\n&quot;);</span>
<a href="#l20.1644"></a><span id="l20.1644" class="difflineplus">+      MAPI_TRACE1(&quot;GetStringFromProp: invalid value, expecting string - %d\n&quot;,</span>
<a href="#l20.1645"></a><span id="l20.1645" class="difflineplus">+                  (int)PROP_TYPE(pVal-&gt;ulPropTag));</span>
<a href="#l20.1646"></a><span id="l20.1646" class="difflineplus">+    } else {</span>
<a href="#l20.1647"></a><span id="l20.1647" class="difflineplus">+      MAPI_TRACE0(</span>
<a href="#l20.1648"></a><span id="l20.1648" class="difflineplus">+          &quot;GetStringFromProp: invalid value, expecting string, got null &quot;</span>
<a href="#l20.1649"></a><span id="l20.1649" class="difflineplus">+          &quot;pointer\n&quot;);</span>
<a href="#l20.1650"></a><span id="l20.1650">     }</span>
<a href="#l20.1651"></a><span id="l20.1651">     val.Truncate();</span>
<a href="#l20.1652"></a><span id="l20.1652">     bResult = FALSE;</span>
<a href="#l20.1653"></a><span id="l20.1653">   }</span>
<a href="#l20.1654"></a><span id="l20.1654" class="difflineminus">-  if (pVal &amp;&amp; delVal)</span>
<a href="#l20.1655"></a><span id="l20.1655" class="difflineminus">-    MAPIFreeBuffer(pVal);</span>
<a href="#l20.1656"></a><span id="l20.1656" class="difflineplus">+  if (pVal &amp;&amp; delVal) MAPIFreeBuffer(pVal);</span>
<a href="#l20.1657"></a><span id="l20.1657"> </span>
<a href="#l20.1658"></a><span id="l20.1658">   return bResult;</span>
<a href="#l20.1659"></a><span id="l20.1659"> }</span>
<a href="#l20.1660"></a><span id="l20.1660"> </span>
<a href="#l20.1661"></a><span id="l20.1661" class="difflineminus">-BOOL CMapiApi::GetStringFromProp(LPSPropValue pVal, nsString&amp; val, BOOL delVal)</span>
<a href="#l20.1662"></a><span id="l20.1662" class="difflineminus">-{</span>
<a href="#l20.1663"></a><span id="l20.1663" class="difflineplus">+BOOL CMapiApi::GetStringFromProp(LPSPropValue pVal, nsString &amp;val,</span>
<a href="#l20.1664"></a><span id="l20.1664" class="difflineplus">+                                 BOOL delVal) {</span>
<a href="#l20.1665"></a><span id="l20.1665">   BOOL bResult = TRUE;</span>
<a href="#l20.1666"></a><span id="l20.1666">   if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_STRING8)) {</span>
<a href="#l20.1667"></a><span id="l20.1667">     CStrToUnicode((const char *)pVal-&gt;Value.lpszA, val);</span>
<a href="#l20.1668"></a><span id="l20.1668" class="difflineminus">-  }</span>
<a href="#l20.1669"></a><span id="l20.1669" class="difflineminus">-  else if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_UNICODE)) {</span>
<a href="#l20.1670"></a><span id="l20.1670" class="difflineminus">-    val = (char16_t *) pVal-&gt;Value.lpszW;</span>
<a href="#l20.1671"></a><span id="l20.1671" class="difflineminus">-  }</span>
<a href="#l20.1672"></a><span id="l20.1672" class="difflineminus">-  else if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_NULL)) {</span>
<a href="#l20.1673"></a><span id="l20.1673" class="difflineplus">+  } else if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_UNICODE)) {</span>
<a href="#l20.1674"></a><span id="l20.1674" class="difflineplus">+    val = (char16_t *)pVal-&gt;Value.lpszW;</span>
<a href="#l20.1675"></a><span id="l20.1675" class="difflineplus">+  } else if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_NULL)) {</span>
<a href="#l20.1676"></a><span id="l20.1676">     val.Truncate();</span>
<a href="#l20.1677"></a><span id="l20.1677" class="difflineminus">-  }</span>
<a href="#l20.1678"></a><span id="l20.1678" class="difflineminus">-  else if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_ERROR)) {</span>
<a href="#l20.1679"></a><span id="l20.1679" class="difflineplus">+  } else if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_ERROR)) {</span>
<a href="#l20.1680"></a><span id="l20.1680">     val.Truncate();</span>
<a href="#l20.1681"></a><span id="l20.1681">     bResult = FALSE;</span>
<a href="#l20.1682"></a><span id="l20.1682" class="difflineminus">-  }</span>
<a href="#l20.1683"></a><span id="l20.1683" class="difflineminus">-  else {</span>
<a href="#l20.1684"></a><span id="l20.1684" class="difflineplus">+  } else {</span>
<a href="#l20.1685"></a><span id="l20.1685">     if (pVal) {</span>
<a href="#l20.1686"></a><span id="l20.1686" class="difflineminus">-      MAPI_TRACE1(&quot;GetStringFromProp: invalid value, expecting string - %d\n&quot;, (int) PROP_TYPE(pVal-&gt;ulPropTag));</span>
<a href="#l20.1687"></a><span id="l20.1687" class="difflineminus">-    }</span>
<a href="#l20.1688"></a><span id="l20.1688" class="difflineminus">-    else {</span>
<a href="#l20.1689"></a><span id="l20.1689" class="difflineminus">-      MAPI_TRACE0(&quot;GetStringFromProp: invalid value, expecting string, got null pointer\n&quot;);</span>
<a href="#l20.1690"></a><span id="l20.1690" class="difflineplus">+      MAPI_TRACE1(&quot;GetStringFromProp: invalid value, expecting string - %d\n&quot;,</span>
<a href="#l20.1691"></a><span id="l20.1691" class="difflineplus">+                  (int)PROP_TYPE(pVal-&gt;ulPropTag));</span>
<a href="#l20.1692"></a><span id="l20.1692" class="difflineplus">+    } else {</span>
<a href="#l20.1693"></a><span id="l20.1693" class="difflineplus">+      MAPI_TRACE0(</span>
<a href="#l20.1694"></a><span id="l20.1694" class="difflineplus">+          &quot;GetStringFromProp: invalid value, expecting string, got null &quot;</span>
<a href="#l20.1695"></a><span id="l20.1695" class="difflineplus">+          &quot;pointer\n&quot;);</span>
<a href="#l20.1696"></a><span id="l20.1696">     }</span>
<a href="#l20.1697"></a><span id="l20.1697">     val.Truncate();</span>
<a href="#l20.1698"></a><span id="l20.1698">     bResult = FALSE;</span>
<a href="#l20.1699"></a><span id="l20.1699">   }</span>
<a href="#l20.1700"></a><span id="l20.1700" class="difflineminus">-  if (pVal &amp;&amp; delVal)</span>
<a href="#l20.1701"></a><span id="l20.1701" class="difflineminus">-    MAPIFreeBuffer(pVal);</span>
<a href="#l20.1702"></a><span id="l20.1702" class="difflineplus">+  if (pVal &amp;&amp; delVal) MAPIFreeBuffer(pVal);</span>
<a href="#l20.1703"></a><span id="l20.1703"> </span>
<a href="#l20.1704"></a><span id="l20.1704">   return bResult;</span>
<a href="#l20.1705"></a><span id="l20.1705"> }</span>
<a href="#l20.1706"></a><span id="l20.1706"> </span>
<a href="#l20.1707"></a><span id="l20.1707" class="difflineminus">-</span>
<a href="#l20.1708"></a><span id="l20.1708" class="difflineminus">-LONG CMapiApi::GetLongFromProp(LPSPropValue pVal, BOOL delVal)</span>
<a href="#l20.1709"></a><span id="l20.1709" class="difflineminus">-{</span>
<a href="#l20.1710"></a><span id="l20.1710" class="difflineplus">+LONG CMapiApi::GetLongFromProp(LPSPropValue pVal, BOOL delVal) {</span>
<a href="#l20.1711"></a><span id="l20.1711">   LONG val = 0;</span>
<a href="#l20.1712"></a><span id="l20.1712">   if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_LONG)) {</span>
<a href="#l20.1713"></a><span id="l20.1713">     val = pVal-&gt;Value.l;</span>
<a href="#l20.1714"></a><span id="l20.1714" class="difflineminus">-  }</span>
<a href="#l20.1715"></a><span id="l20.1715" class="difflineminus">-  else if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_NULL)) {</span>
<a href="#l20.1716"></a><span id="l20.1716" class="difflineplus">+  } else if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_NULL)) {</span>
<a href="#l20.1717"></a><span id="l20.1717">     val = 0;</span>
<a href="#l20.1718"></a><span id="l20.1718" class="difflineminus">-  }</span>
<a href="#l20.1719"></a><span id="l20.1719" class="difflineminus">-  else if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_ERROR)) {</span>
<a href="#l20.1720"></a><span id="l20.1720" class="difflineplus">+  } else if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_ERROR)) {</span>
<a href="#l20.1721"></a><span id="l20.1721">     val = 0;</span>
<a href="#l20.1722"></a><span id="l20.1722">     MAPI_TRACE0(&quot;GetLongFromProp: Error retrieving property\n&quot;);</span>
<a href="#l20.1723"></a><span id="l20.1723" class="difflineminus">-  }</span>
<a href="#l20.1724"></a><span id="l20.1724" class="difflineminus">-  else {</span>
<a href="#l20.1725"></a><span id="l20.1725" class="difflineplus">+  } else {</span>
<a href="#l20.1726"></a><span id="l20.1726">     MAPI_TRACE0(&quot;GetLongFromProp: invalid value, expecting long\n&quot;);</span>
<a href="#l20.1727"></a><span id="l20.1727">   }</span>
<a href="#l20.1728"></a><span id="l20.1728" class="difflineminus">-  if (pVal &amp;&amp; delVal)</span>
<a href="#l20.1729"></a><span id="l20.1729" class="difflineminus">-    MAPIFreeBuffer(pVal);</span>
<a href="#l20.1730"></a><span id="l20.1730" class="difflineplus">+  if (pVal &amp;&amp; delVal) MAPIFreeBuffer(pVal);</span>
<a href="#l20.1731"></a><span id="l20.1731"> </span>
<a href="#l20.1732"></a><span id="l20.1732">   return val;</span>
<a href="#l20.1733"></a><span id="l20.1733"> }</span>
<a href="#l20.1734"></a><span id="l20.1734"> </span>
<a href="#l20.1735"></a><span id="l20.1735" class="difflineminus">-</span>
<a href="#l20.1736"></a><span id="l20.1736" class="difflineminus">-void CMapiApi::ReportUIDProp(const char *pTag, LPSPropValue pVal)</span>
<a href="#l20.1737"></a><span id="l20.1737" class="difflineminus">-{</span>
<a href="#l20.1738"></a><span id="l20.1738" class="difflineplus">+void CMapiApi::ReportUIDProp(const char *pTag, LPSPropValue pVal) {</span>
<a href="#l20.1739"></a><span id="l20.1739">   if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_BINARY)) {</span>
<a href="#l20.1740"></a><span id="l20.1740">     if (pVal-&gt;Value.bin.cb != 16) {</span>
<a href="#l20.1741"></a><span id="l20.1741" class="difflineminus">-      MAPI_TRACE1(&quot;%s - INVALID, expecting 16 bytes of binary data for UID\n&quot;, pTag);</span>
<a href="#l20.1742"></a><span id="l20.1742" class="difflineminus">-    }</span>
<a href="#l20.1743"></a><span id="l20.1743" class="difflineminus">-    else {</span>
<a href="#l20.1744"></a><span id="l20.1744" class="difflineminus">-      nsIID  uid;</span>
<a href="#l20.1745"></a><span id="l20.1745" class="difflineplus">+      MAPI_TRACE1(&quot;%s - INVALID, expecting 16 bytes of binary data for UID\n&quot;,</span>
<a href="#l20.1746"></a><span id="l20.1746" class="difflineplus">+                  pTag);</span>
<a href="#l20.1747"></a><span id="l20.1747" class="difflineplus">+    } else {</span>
<a href="#l20.1748"></a><span id="l20.1748" class="difflineplus">+      nsIID uid;</span>
<a href="#l20.1749"></a><span id="l20.1749">       memcpy(&amp;uid, pVal-&gt;Value.bin.lpb, 16);</span>
<a href="#l20.1750"></a><span id="l20.1750" class="difflineminus">-      char *  pStr = uid.ToString();</span>
<a href="#l20.1751"></a><span id="l20.1751" class="difflineplus">+      char *pStr = uid.ToString();</span>
<a href="#l20.1752"></a><span id="l20.1752">       if (pStr) {</span>
<a href="#l20.1753"></a><span id="l20.1753">         MAPI_TRACE2(&quot;%s %s\n&quot;, pTag, (const char *)pStr);</span>
<a href="#l20.1754"></a><span id="l20.1754">         free(pStr);</span>
<a href="#l20.1755"></a><span id="l20.1755">       }</span>
<a href="#l20.1756"></a><span id="l20.1756">     }</span>
<a href="#l20.1757"></a><span id="l20.1757" class="difflineminus">-  }</span>
<a href="#l20.1758"></a><span id="l20.1758" class="difflineminus">-  else if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_NULL)) {</span>
<a href="#l20.1759"></a><span id="l20.1759" class="difflineplus">+  } else if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_NULL)) {</span>
<a href="#l20.1760"></a><span id="l20.1760">     MAPI_TRACE1(&quot;%s {NULL}\n&quot;, pTag);</span>
<a href="#l20.1761"></a><span id="l20.1761" class="difflineminus">-  }</span>
<a href="#l20.1762"></a><span id="l20.1762" class="difflineminus">-  else if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_ERROR)) {</span>
<a href="#l20.1763"></a><span id="l20.1763" class="difflineplus">+  } else if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_ERROR)) {</span>
<a href="#l20.1764"></a><span id="l20.1764">     MAPI_TRACE1(&quot;%s {Error retrieving property}\n&quot;, pTag);</span>
<a href="#l20.1765"></a><span id="l20.1765" class="difflineminus">-  }</span>
<a href="#l20.1766"></a><span id="l20.1766" class="difflineminus">-  else {</span>
<a href="#l20.1767"></a><span id="l20.1767" class="difflineplus">+  } else {</span>
<a href="#l20.1768"></a><span id="l20.1768">     MAPI_TRACE1(&quot;%s invalid value, expecting binary\n&quot;, pTag);</span>
<a href="#l20.1769"></a><span id="l20.1769">   }</span>
<a href="#l20.1770"></a><span id="l20.1770" class="difflineminus">-  if (pVal)</span>
<a href="#l20.1771"></a><span id="l20.1771" class="difflineminus">-    MAPIFreeBuffer(pVal);</span>
<a href="#l20.1772"></a><span id="l20.1772" class="difflineplus">+  if (pVal) MAPIFreeBuffer(pVal);</span>
<a href="#l20.1773"></a><span id="l20.1773"> }</span>
<a href="#l20.1774"></a><span id="l20.1774"> </span>
<a href="#l20.1775"></a><span id="l20.1775" class="difflineminus">-void CMapiApi::ReportLongProp(const char *pTag, LPSPropValue pVal)</span>
<a href="#l20.1776"></a><span id="l20.1776" class="difflineminus">-{</span>
<a href="#l20.1777"></a><span id="l20.1777" class="difflineplus">+void CMapiApi::ReportLongProp(const char *pTag, LPSPropValue pVal) {</span>
<a href="#l20.1778"></a><span id="l20.1778">   if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_LONG)) {</span>
<a href="#l20.1779"></a><span id="l20.1779" class="difflineminus">-    nsCString  num;</span>
<a href="#l20.1780"></a><span id="l20.1780" class="difflineminus">-    nsCString  num2;</span>
<a href="#l20.1781"></a><span id="l20.1781" class="difflineplus">+    nsCString num;</span>
<a href="#l20.1782"></a><span id="l20.1782" class="difflineplus">+    nsCString num2;</span>
<a href="#l20.1783"></a><span id="l20.1783"> </span>
<a href="#l20.1784"></a><span id="l20.1784" class="difflineminus">-    num.AppendInt((int32_t) pVal-&gt;Value.l);</span>
<a href="#l20.1785"></a><span id="l20.1785" class="difflineminus">-    num2.AppendInt((int32_t) pVal-&gt;Value.l, 16);</span>
<a href="#l20.1786"></a><span id="l20.1786" class="difflineplus">+    num.AppendInt((int32_t)pVal-&gt;Value.l);</span>
<a href="#l20.1787"></a><span id="l20.1787" class="difflineplus">+    num2.AppendInt((int32_t)pVal-&gt;Value.l, 16);</span>
<a href="#l20.1788"></a><span id="l20.1788">     MAPI_TRACE3(&quot;%s %s, 0x%s\n&quot;, pTag, num, num2);</span>
<a href="#l20.1789"></a><span id="l20.1789" class="difflineminus">-  }</span>
<a href="#l20.1790"></a><span id="l20.1790" class="difflineminus">-  else if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_NULL)) {</span>
<a href="#l20.1791"></a><span id="l20.1791" class="difflineplus">+  } else if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_NULL)) {</span>
<a href="#l20.1792"></a><span id="l20.1792">     MAPI_TRACE1(&quot;%s {NULL}\n&quot;, pTag);</span>
<a href="#l20.1793"></a><span id="l20.1793" class="difflineminus">-  }</span>
<a href="#l20.1794"></a><span id="l20.1794" class="difflineminus">-  else if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_ERROR)) {</span>
<a href="#l20.1795"></a><span id="l20.1795" class="difflineplus">+  } else if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_ERROR)) {</span>
<a href="#l20.1796"></a><span id="l20.1796">     MAPI_TRACE1(&quot;%s {Error retrieving property}\n&quot;, pTag);</span>
<a href="#l20.1797"></a><span id="l20.1797" class="difflineminus">-  }</span>
<a href="#l20.1798"></a><span id="l20.1798" class="difflineminus">-  else if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_ERROR)) {</span>
<a href="#l20.1799"></a><span id="l20.1799" class="difflineplus">+  } else if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_ERROR)) {</span>
<a href="#l20.1800"></a><span id="l20.1800">     MAPI_TRACE1(&quot;%s {Error retrieving property}\n&quot;, pTag);</span>
<a href="#l20.1801"></a><span id="l20.1801" class="difflineminus">-  }</span>
<a href="#l20.1802"></a><span id="l20.1802" class="difflineminus">-  else {</span>
<a href="#l20.1803"></a><span id="l20.1803" class="difflineplus">+  } else {</span>
<a href="#l20.1804"></a><span id="l20.1804">     MAPI_TRACE1(&quot;%s invalid value, expecting long\n&quot;, pTag);</span>
<a href="#l20.1805"></a><span id="l20.1805">   }</span>
<a href="#l20.1806"></a><span id="l20.1806" class="difflineminus">-  if (pVal)</span>
<a href="#l20.1807"></a><span id="l20.1807" class="difflineminus">-    MAPIFreeBuffer(pVal);</span>
<a href="#l20.1808"></a><span id="l20.1808" class="difflineplus">+  if (pVal) MAPIFreeBuffer(pVal);</span>
<a href="#l20.1809"></a><span id="l20.1809"> }</span>
<a href="#l20.1810"></a><span id="l20.1810"> </span>
<a href="#l20.1811"></a><span id="l20.1811" class="difflineminus">-void CMapiApi::ReportStringProp(const char *pTag, LPSPropValue pVal)</span>
<a href="#l20.1812"></a><span id="l20.1812" class="difflineminus">-{</span>
<a href="#l20.1813"></a><span id="l20.1813" class="difflineplus">+void CMapiApi::ReportStringProp(const char *pTag, LPSPropValue pVal) {</span>
<a href="#l20.1814"></a><span id="l20.1814">   if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_TSTRING)) {</span>
<a href="#l20.1815"></a><span id="l20.1815" class="difflineminus">-    nsCString val((LPCTSTR) (pVal-&gt;Value.LPSZ));</span>
<a href="#l20.1816"></a><span id="l20.1816" class="difflineplus">+    nsCString val((LPCTSTR)(pVal-&gt;Value.LPSZ));</span>
<a href="#l20.1817"></a><span id="l20.1817">     MAPI_TRACE2(&quot;%s %s\n&quot;, pTag, val.get());</span>
<a href="#l20.1818"></a><span id="l20.1818" class="difflineminus">-  }</span>
<a href="#l20.1819"></a><span id="l20.1819" class="difflineminus">-  else if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_NULL)) {</span>
<a href="#l20.1820"></a><span id="l20.1820" class="difflineplus">+  } else if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_NULL)) {</span>
<a href="#l20.1821"></a><span id="l20.1821">     MAPI_TRACE1(&quot;%s {NULL}\n&quot;, pTag);</span>
<a href="#l20.1822"></a><span id="l20.1822" class="difflineminus">-  }</span>
<a href="#l20.1823"></a><span id="l20.1823" class="difflineminus">-  else if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_ERROR)) {</span>
<a href="#l20.1824"></a><span id="l20.1824" class="difflineplus">+  } else if (pVal &amp;&amp; (PROP_TYPE(pVal-&gt;ulPropTag) == PT_ERROR)) {</span>
<a href="#l20.1825"></a><span id="l20.1825">     MAPI_TRACE1(&quot;%s {Error retrieving property}\n&quot;, pTag);</span>
<a href="#l20.1826"></a><span id="l20.1826" class="difflineminus">-  }</span>
<a href="#l20.1827"></a><span id="l20.1827" class="difflineminus">-  else {</span>
<a href="#l20.1828"></a><span id="l20.1828" class="difflineplus">+  } else {</span>
<a href="#l20.1829"></a><span id="l20.1829">     MAPI_TRACE1(&quot;%s invalid value, expecting string\n&quot;, pTag);</span>
<a href="#l20.1830"></a><span id="l20.1830">   }</span>
<a href="#l20.1831"></a><span id="l20.1831" class="difflineminus">-  if (pVal)</span>
<a href="#l20.1832"></a><span id="l20.1832" class="difflineminus">-    MAPIFreeBuffer(pVal);</span>
<a href="#l20.1833"></a><span id="l20.1833" class="difflineplus">+  if (pVal) MAPIFreeBuffer(pVal);</span>
<a href="#l20.1834"></a><span id="l20.1834"> }</span>
<a href="#l20.1835"></a><span id="l20.1835"> </span>
<a href="#l20.1836"></a><span id="l20.1836" class="difflineminus">-void CMapiApi::GetPropTagName(ULONG tag, nsCString&amp; s)</span>
<a href="#l20.1837"></a><span id="l20.1837" class="difflineminus">-{</span>
<a href="#l20.1838"></a><span id="l20.1838" class="difflineplus">+void CMapiApi::GetPropTagName(ULONG tag, nsCString &amp;s) {</span>
<a href="#l20.1839"></a><span id="l20.1839">   char numStr[256];</span>
<a href="#l20.1840"></a><span id="l20.1840">   PR_snprintf(numStr, 256, &quot;0x%lx, %ld&quot;, tag, tag);</span>
<a href="#l20.1841"></a><span id="l20.1841">   s = numStr;</span>
<a href="#l20.1842"></a><span id="l20.1842" class="difflineminus">-  switch(tag) {</span>
<a href="#l20.1843"></a><span id="l20.1843" class="difflineplus">+  switch (tag) {</span>
<a href="#l20.1844"></a><span id="l20.1844"> #include &quot;MapiTagStrs.cpp&quot;</span>
<a href="#l20.1845"></a><span id="l20.1845">   }</span>
<a href="#l20.1846"></a><span id="l20.1846">   s += &quot;, data: &quot;;</span>
<a href="#l20.1847"></a><span id="l20.1847" class="difflineminus">-  switch(PROP_TYPE(tag)) {</span>
<a href="#l20.1848"></a><span id="l20.1848" class="difflineminus">-    case PT_UNSPECIFIED: s += &quot;PT_UNSPECIFIED&quot;; break;</span>
<a href="#l20.1849"></a><span id="l20.1849" class="difflineminus">-    case PT_NULL: s += &quot;PT_NULL&quot;; break;</span>
<a href="#l20.1850"></a><span id="l20.1850" class="difflineminus">-    case PT_I2: s += &quot;PT_I2&quot;; break;</span>
<a href="#l20.1851"></a><span id="l20.1851" class="difflineminus">-    case PT_LONG: s += &quot;PT_LONG&quot;; break;</span>
<a href="#l20.1852"></a><span id="l20.1852" class="difflineminus">-    case PT_R4: s += &quot;PT_R4&quot;; break;</span>
<a href="#l20.1853"></a><span id="l20.1853" class="difflineminus">-    case PT_DOUBLE: s += &quot;PT_DOUBLE&quot;; break;</span>
<a href="#l20.1854"></a><span id="l20.1854" class="difflineminus">-    case PT_CURRENCY: s += &quot;PT_CURRENCY&quot;; break;</span>
<a href="#l20.1855"></a><span id="l20.1855" class="difflineminus">-    case PT_APPTIME: s += &quot;PT_APPTIME&quot;; break;</span>
<a href="#l20.1856"></a><span id="l20.1856" class="difflineminus">-    case PT_ERROR: s += &quot;PT_ERROR&quot;; break;</span>
<a href="#l20.1857"></a><span id="l20.1857" class="difflineminus">-    case PT_BOOLEAN: s += &quot;PT_BOOLEAN&quot;; break;</span>
<a href="#l20.1858"></a><span id="l20.1858" class="difflineminus">-    case PT_OBJECT: s += &quot;PT_OBJECT&quot;; break;</span>
<a href="#l20.1859"></a><span id="l20.1859" class="difflineminus">-    case PT_I8: s += &quot;PT_I8&quot;; break;</span>
<a href="#l20.1860"></a><span id="l20.1860" class="difflineminus">-    case PT_STRING8: s += &quot;PT_STRING8&quot;; break;</span>
<a href="#l20.1861"></a><span id="l20.1861" class="difflineminus">-    case PT_UNICODE: s += &quot;PT_UNICODE&quot;; break;</span>
<a href="#l20.1862"></a><span id="l20.1862" class="difflineminus">-    case PT_SYSTIME: s += &quot;PT_SYSTIME&quot;; break;</span>
<a href="#l20.1863"></a><span id="l20.1863" class="difflineminus">-    case PT_CLSID: s += &quot;PT_CLSID&quot;; break;</span>
<a href="#l20.1864"></a><span id="l20.1864" class="difflineminus">-    case PT_BINARY: s += &quot;PT_BINARY&quot;; break;</span>
<a href="#l20.1865"></a><span id="l20.1865" class="difflineminus">-    case PT_MV_I2: s += &quot;PT_MV_I2&quot;; break;</span>
<a href="#l20.1866"></a><span id="l20.1866" class="difflineminus">-    case PT_MV_LONG: s += &quot;PT_MV_LONG&quot;; break;</span>
<a href="#l20.1867"></a><span id="l20.1867" class="difflineminus">-    case PT_MV_R4: s += &quot;PT_MV_R4&quot;; break;</span>
<a href="#l20.1868"></a><span id="l20.1868" class="difflineminus">-    case PT_MV_DOUBLE: s += &quot;PT_MV_DOUBLE&quot;; break;</span>
<a href="#l20.1869"></a><span id="l20.1869" class="difflineminus">-    case PT_MV_CURRENCY: s += &quot;PT_MV_CURRENCY&quot;; break;</span>
<a href="#l20.1870"></a><span id="l20.1870" class="difflineminus">-    case PT_MV_APPTIME: s += &quot;PT_MV_APPTIME&quot;; break;</span>
<a href="#l20.1871"></a><span id="l20.1871" class="difflineminus">-    case PT_MV_SYSTIME: s += &quot;PT_MV_SYSTIME&quot;; break;</span>
<a href="#l20.1872"></a><span id="l20.1872" class="difflineminus">-    case PT_MV_STRING8: s += &quot;PT_MV_STRING8&quot;; break;</span>
<a href="#l20.1873"></a><span id="l20.1873" class="difflineminus">-    case PT_MV_BINARY: s += &quot;PT_MV_BINARY&quot;; break;</span>
<a href="#l20.1874"></a><span id="l20.1874" class="difflineminus">-    case PT_MV_UNICODE: s += &quot;PT_MV_UNICODE&quot;; break;</span>
<a href="#l20.1875"></a><span id="l20.1875" class="difflineminus">-    case PT_MV_CLSID: s += &quot;PT_MV_CLSID&quot;; break;</span>
<a href="#l20.1876"></a><span id="l20.1876" class="difflineminus">-    case PT_MV_I8: s += &quot;PT_MV_I8&quot;; break;</span>
<a href="#l20.1877"></a><span id="l20.1877" class="difflineplus">+  switch (PROP_TYPE(tag)) {</span>
<a href="#l20.1878"></a><span id="l20.1878" class="difflineplus">+    case PT_UNSPECIFIED:</span>
<a href="#l20.1879"></a><span id="l20.1879" class="difflineplus">+      s += &quot;PT_UNSPECIFIED&quot;;</span>
<a href="#l20.1880"></a><span id="l20.1880" class="difflineplus">+      break;</span>
<a href="#l20.1881"></a><span id="l20.1881" class="difflineplus">+    case PT_NULL:</span>
<a href="#l20.1882"></a><span id="l20.1882" class="difflineplus">+      s += &quot;PT_NULL&quot;;</span>
<a href="#l20.1883"></a><span id="l20.1883" class="difflineplus">+      break;</span>
<a href="#l20.1884"></a><span id="l20.1884" class="difflineplus">+    case PT_I2:</span>
<a href="#l20.1885"></a><span id="l20.1885" class="difflineplus">+      s += &quot;PT_I2&quot;;</span>
<a href="#l20.1886"></a><span id="l20.1886" class="difflineplus">+      break;</span>
<a href="#l20.1887"></a><span id="l20.1887" class="difflineplus">+    case PT_LONG:</span>
<a href="#l20.1888"></a><span id="l20.1888" class="difflineplus">+      s += &quot;PT_LONG&quot;;</span>
<a href="#l20.1889"></a><span id="l20.1889" class="difflineplus">+      break;</span>
<a href="#l20.1890"></a><span id="l20.1890" class="difflineplus">+    case PT_R4:</span>
<a href="#l20.1891"></a><span id="l20.1891" class="difflineplus">+      s += &quot;PT_R4&quot;;</span>
<a href="#l20.1892"></a><span id="l20.1892" class="difflineplus">+      break;</span>
<a href="#l20.1893"></a><span id="l20.1893" class="difflineplus">+    case PT_DOUBLE:</span>
<a href="#l20.1894"></a><span id="l20.1894" class="difflineplus">+      s += &quot;PT_DOUBLE&quot;;</span>
<a href="#l20.1895"></a><span id="l20.1895" class="difflineplus">+      break;</span>
<a href="#l20.1896"></a><span id="l20.1896" class="difflineplus">+    case PT_CURRENCY:</span>
<a href="#l20.1897"></a><span id="l20.1897" class="difflineplus">+      s += &quot;PT_CURRENCY&quot;;</span>
<a href="#l20.1898"></a><span id="l20.1898" class="difflineplus">+      break;</span>
<a href="#l20.1899"></a><span id="l20.1899" class="difflineplus">+    case PT_APPTIME:</span>
<a href="#l20.1900"></a><span id="l20.1900" class="difflineplus">+      s += &quot;PT_APPTIME&quot;;</span>
<a href="#l20.1901"></a><span id="l20.1901" class="difflineplus">+      break;</span>
<a href="#l20.1902"></a><span id="l20.1902" class="difflineplus">+    case PT_ERROR:</span>
<a href="#l20.1903"></a><span id="l20.1903" class="difflineplus">+      s += &quot;PT_ERROR&quot;;</span>
<a href="#l20.1904"></a><span id="l20.1904" class="difflineplus">+      break;</span>
<a href="#l20.1905"></a><span id="l20.1905" class="difflineplus">+    case PT_BOOLEAN:</span>
<a href="#l20.1906"></a><span id="l20.1906" class="difflineplus">+      s += &quot;PT_BOOLEAN&quot;;</span>
<a href="#l20.1907"></a><span id="l20.1907" class="difflineplus">+      break;</span>
<a href="#l20.1908"></a><span id="l20.1908" class="difflineplus">+    case PT_OBJECT:</span>
<a href="#l20.1909"></a><span id="l20.1909" class="difflineplus">+      s += &quot;PT_OBJECT&quot;;</span>
<a href="#l20.1910"></a><span id="l20.1910" class="difflineplus">+      break;</span>
<a href="#l20.1911"></a><span id="l20.1911" class="difflineplus">+    case PT_I8:</span>
<a href="#l20.1912"></a><span id="l20.1912" class="difflineplus">+      s += &quot;PT_I8&quot;;</span>
<a href="#l20.1913"></a><span id="l20.1913" class="difflineplus">+      break;</span>
<a href="#l20.1914"></a><span id="l20.1914" class="difflineplus">+    case PT_STRING8:</span>
<a href="#l20.1915"></a><span id="l20.1915" class="difflineplus">+      s += &quot;PT_STRING8&quot;;</span>
<a href="#l20.1916"></a><span id="l20.1916" class="difflineplus">+      break;</span>
<a href="#l20.1917"></a><span id="l20.1917" class="difflineplus">+    case PT_UNICODE:</span>
<a href="#l20.1918"></a><span id="l20.1918" class="difflineplus">+      s += &quot;PT_UNICODE&quot;;</span>
<a href="#l20.1919"></a><span id="l20.1919" class="difflineplus">+      break;</span>
<a href="#l20.1920"></a><span id="l20.1920" class="difflineplus">+    case PT_SYSTIME:</span>
<a href="#l20.1921"></a><span id="l20.1921" class="difflineplus">+      s += &quot;PT_SYSTIME&quot;;</span>
<a href="#l20.1922"></a><span id="l20.1922" class="difflineplus">+      break;</span>
<a href="#l20.1923"></a><span id="l20.1923" class="difflineplus">+    case PT_CLSID:</span>
<a href="#l20.1924"></a><span id="l20.1924" class="difflineplus">+      s += &quot;PT_CLSID&quot;;</span>
<a href="#l20.1925"></a><span id="l20.1925" class="difflineplus">+      break;</span>
<a href="#l20.1926"></a><span id="l20.1926" class="difflineplus">+    case PT_BINARY:</span>
<a href="#l20.1927"></a><span id="l20.1927" class="difflineplus">+      s += &quot;PT_BINARY&quot;;</span>
<a href="#l20.1928"></a><span id="l20.1928" class="difflineplus">+      break;</span>
<a href="#l20.1929"></a><span id="l20.1929" class="difflineplus">+    case PT_MV_I2:</span>
<a href="#l20.1930"></a><span id="l20.1930" class="difflineplus">+      s += &quot;PT_MV_I2&quot;;</span>
<a href="#l20.1931"></a><span id="l20.1931" class="difflineplus">+      break;</span>
<a href="#l20.1932"></a><span id="l20.1932" class="difflineplus">+    case PT_MV_LONG:</span>
<a href="#l20.1933"></a><span id="l20.1933" class="difflineplus">+      s += &quot;PT_MV_LONG&quot;;</span>
<a href="#l20.1934"></a><span id="l20.1934" class="difflineplus">+      break;</span>
<a href="#l20.1935"></a><span id="l20.1935" class="difflineplus">+    case PT_MV_R4:</span>
<a href="#l20.1936"></a><span id="l20.1936" class="difflineplus">+      s += &quot;PT_MV_R4&quot;;</span>
<a href="#l20.1937"></a><span id="l20.1937" class="difflineplus">+      break;</span>
<a href="#l20.1938"></a><span id="l20.1938" class="difflineplus">+    case PT_MV_DOUBLE:</span>
<a href="#l20.1939"></a><span id="l20.1939" class="difflineplus">+      s += &quot;PT_MV_DOUBLE&quot;;</span>
<a href="#l20.1940"></a><span id="l20.1940" class="difflineplus">+      break;</span>
<a href="#l20.1941"></a><span id="l20.1941" class="difflineplus">+    case PT_MV_CURRENCY:</span>
<a href="#l20.1942"></a><span id="l20.1942" class="difflineplus">+      s += &quot;PT_MV_CURRENCY&quot;;</span>
<a href="#l20.1943"></a><span id="l20.1943" class="difflineplus">+      break;</span>
<a href="#l20.1944"></a><span id="l20.1944" class="difflineplus">+    case PT_MV_APPTIME:</span>
<a href="#l20.1945"></a><span id="l20.1945" class="difflineplus">+      s += &quot;PT_MV_APPTIME&quot;;</span>
<a href="#l20.1946"></a><span id="l20.1946" class="difflineplus">+      break;</span>
<a href="#l20.1947"></a><span id="l20.1947" class="difflineplus">+    case PT_MV_SYSTIME:</span>
<a href="#l20.1948"></a><span id="l20.1948" class="difflineplus">+      s += &quot;PT_MV_SYSTIME&quot;;</span>
<a href="#l20.1949"></a><span id="l20.1949" class="difflineplus">+      break;</span>
<a href="#l20.1950"></a><span id="l20.1950" class="difflineplus">+    case PT_MV_STRING8:</span>
<a href="#l20.1951"></a><span id="l20.1951" class="difflineplus">+      s += &quot;PT_MV_STRING8&quot;;</span>
<a href="#l20.1952"></a><span id="l20.1952" class="difflineplus">+      break;</span>
<a href="#l20.1953"></a><span id="l20.1953" class="difflineplus">+    case PT_MV_BINARY:</span>
<a href="#l20.1954"></a><span id="l20.1954" class="difflineplus">+      s += &quot;PT_MV_BINARY&quot;;</span>
<a href="#l20.1955"></a><span id="l20.1955" class="difflineplus">+      break;</span>
<a href="#l20.1956"></a><span id="l20.1956" class="difflineplus">+    case PT_MV_UNICODE:</span>
<a href="#l20.1957"></a><span id="l20.1957" class="difflineplus">+      s += &quot;PT_MV_UNICODE&quot;;</span>
<a href="#l20.1958"></a><span id="l20.1958" class="difflineplus">+      break;</span>
<a href="#l20.1959"></a><span id="l20.1959" class="difflineplus">+    case PT_MV_CLSID:</span>
<a href="#l20.1960"></a><span id="l20.1960" class="difflineplus">+      s += &quot;PT_MV_CLSID&quot;;</span>
<a href="#l20.1961"></a><span id="l20.1961" class="difflineplus">+      break;</span>
<a href="#l20.1962"></a><span id="l20.1962" class="difflineplus">+    case PT_MV_I8:</span>
<a href="#l20.1963"></a><span id="l20.1963" class="difflineplus">+      s += &quot;PT_MV_I8&quot;;</span>
<a href="#l20.1964"></a><span id="l20.1964" class="difflineplus">+      break;</span>
<a href="#l20.1965"></a><span id="l20.1965">     default:</span>
<a href="#l20.1966"></a><span id="l20.1966">       s += &quot;Unknown&quot;;</span>
<a href="#l20.1967"></a><span id="l20.1967">   }</span>
<a href="#l20.1968"></a><span id="l20.1968"> }</span>
<a href="#l20.1969"></a><span id="l20.1969"> </span>
<a href="#l20.1970"></a><span id="l20.1970" class="difflineminus">-void CMapiApi::ListPropertyValue(LPSPropValue pVal, nsCString&amp; s)</span>
<a href="#l20.1971"></a><span id="l20.1971" class="difflineminus">-{</span>
<a href="#l20.1972"></a><span id="l20.1972" class="difflineminus">-  nsCString    strVal;</span>
<a href="#l20.1973"></a><span id="l20.1973" class="difflineminus">-  char      nBuff[64];</span>
<a href="#l20.1974"></a><span id="l20.1974" class="difflineplus">+void CMapiApi::ListPropertyValue(LPSPropValue pVal, nsCString &amp;s) {</span>
<a href="#l20.1975"></a><span id="l20.1975" class="difflineplus">+  nsCString strVal;</span>
<a href="#l20.1976"></a><span id="l20.1976" class="difflineplus">+  char nBuff[64];</span>
<a href="#l20.1977"></a><span id="l20.1977"> </span>
<a href="#l20.1978"></a><span id="l20.1978">   s += &quot;value: &quot;;</span>
<a href="#l20.1979"></a><span id="l20.1979">   switch (PROP_TYPE(pVal-&gt;ulPropTag)) {</span>
<a href="#l20.1980"></a><span id="l20.1980">     case PT_STRING8:</span>
<a href="#l20.1981"></a><span id="l20.1981">       GetStringFromProp(pVal, strVal, FALSE);</span>
<a href="#l20.1982"></a><span id="l20.1982">       if (strVal.Length() &gt; 60) {</span>
<a href="#l20.1983"></a><span id="l20.1983">         strVal.SetLength(60);</span>
<a href="#l20.1984"></a><span id="l20.1984">         strVal += &quot;...&quot;;</span>
<a href="#l20.1985"></a><span id="l20.1985">       }</span>
<a href="#l20.1986"></a><span id="l20.1986">       MsgReplaceSubstring(strVal, &quot;\r&quot;, &quot;\\r&quot;);</span>
<a href="#l20.1987"></a><span id="l20.1987">       MsgReplaceSubstring(strVal, &quot;\n&quot;, &quot;\\n&quot;);</span>
<a href="#l20.1988"></a><span id="l20.1988">       s += strVal;</span>
<a href="#l20.1989"></a><span id="l20.1989" class="difflineminus">-    break;</span>
<a href="#l20.1990"></a><span id="l20.1990" class="difflineplus">+      break;</span>
<a href="#l20.1991"></a><span id="l20.1991">     case PT_LONG:</span>
<a href="#l20.1992"></a><span id="l20.1992" class="difflineminus">-      s.AppendInt((int32_t) pVal-&gt;Value.l);</span>
<a href="#l20.1993"></a><span id="l20.1993" class="difflineplus">+      s.AppendInt((int32_t)pVal-&gt;Value.l);</span>
<a href="#l20.1994"></a><span id="l20.1994">       s += &quot;, 0x&quot;;</span>
<a href="#l20.1995"></a><span id="l20.1995" class="difflineminus">-      s.AppendInt((int32_t) pVal-&gt;Value.l, 16);</span>
<a href="#l20.1996"></a><span id="l20.1996" class="difflineplus">+      s.AppendInt((int32_t)pVal-&gt;Value.l, 16);</span>
<a href="#l20.1997"></a><span id="l20.1997">       s += nBuff;</span>
<a href="#l20.1998"></a><span id="l20.1998" class="difflineminus">-    break;</span>
<a href="#l20.1999"></a><span id="l20.1999" class="difflineplus">+      break;</span>
<a href="#l20.2000"></a><span id="l20.2000">     case PT_BOOLEAN:</span>
<a href="#l20.2001"></a><span id="l20.2001">       if (pVal-&gt;Value.b)</span>
<a href="#l20.2002"></a><span id="l20.2002">         s += &quot;True&quot;;</span>
<a href="#l20.2003"></a><span id="l20.2003">       else</span>
<a href="#l20.2004"></a><span id="l20.2004">         s += &quot;False&quot;;</span>
<a href="#l20.2005"></a><span id="l20.2005" class="difflineminus">-    break;</span>
<a href="#l20.2006"></a><span id="l20.2006" class="difflineplus">+      break;</span>
<a href="#l20.2007"></a><span id="l20.2007">     case PT_NULL:</span>
<a href="#l20.2008"></a><span id="l20.2008">       s += &quot;--NULL--&quot;;</span>
<a href="#l20.2009"></a><span id="l20.2009" class="difflineminus">-    break;</span>
<a href="#l20.2010"></a><span id="l20.2010" class="difflineplus">+      break;</span>
<a href="#l20.2011"></a><span id="l20.2011">     case PT_SYSTIME: {</span>
<a href="#l20.2012"></a><span id="l20.2012">       /*</span>
<a href="#l20.2013"></a><span id="l20.2013">       COleDateTime  tm(pVal-&gt;Value.ft);</span>
<a href="#l20.2014"></a><span id="l20.2014">       s += tm.Format();</span>
<a href="#l20.2015"></a><span id="l20.2015">       */</span>
<a href="#l20.2016"></a><span id="l20.2016">       s += &quot;-- Figure out how to format time in mozilla, PT_SYSTIME --&quot;;</span>
<a href="#l20.2017"></a><span id="l20.2017" class="difflineminus">-    }</span>
<a href="#l20.2018"></a><span id="l20.2018" class="difflineminus">-    break;</span>
<a href="#l20.2019"></a><span id="l20.2019" class="difflineplus">+    } break;</span>
<a href="#l20.2020"></a><span id="l20.2020">     default:</span>
<a href="#l20.2021"></a><span id="l20.2021" class="difflineminus">-     s += &quot;?&quot;;</span>
<a href="#l20.2022"></a><span id="l20.2022" class="difflineplus">+      s += &quot;?&quot;;</span>
<a href="#l20.2023"></a><span id="l20.2023">   }</span>
<a href="#l20.2024"></a><span id="l20.2024"> }</span>
<a href="#l20.2025"></a><span id="l20.2025"> </span>
<a href="#l20.2026"></a><span id="l20.2026" class="difflineminus">-</span>
<a href="#l20.2027"></a><span id="l20.2027" class="difflineminus">-</span>
<a href="#l20.2028"></a><span id="l20.2028"> // -------------------------------------------------------------------</span>
<a href="#l20.2029"></a><span id="l20.2029"> // Folder list stuff</span>
<a href="#l20.2030"></a><span id="l20.2030"> // -------------------------------------------------------------------</span>
<a href="#l20.2031"></a><span id="l20.2031" class="difflineminus">-CMapiFolderList::CMapiFolderList()</span>
<a href="#l20.2032"></a><span id="l20.2032" class="difflineminus">-{</span>
<a href="#l20.2033"></a><span id="l20.2033" class="difflineminus">-}</span>
<a href="#l20.2034"></a><span id="l20.2034" class="difflineplus">+CMapiFolderList::CMapiFolderList() {}</span>
<a href="#l20.2035"></a><span id="l20.2035"> </span>
<a href="#l20.2036"></a><span id="l20.2036" class="difflineminus">-CMapiFolderList::~CMapiFolderList()</span>
<a href="#l20.2037"></a><span id="l20.2037" class="difflineminus">-{</span>
<a href="#l20.2038"></a><span id="l20.2038" class="difflineminus">-  ClearAll();</span>
<a href="#l20.2039"></a><span id="l20.2039" class="difflineminus">-}</span>
<a href="#l20.2040"></a><span id="l20.2040" class="difflineplus">+CMapiFolderList::~CMapiFolderList() { ClearAll(); }</span>
<a href="#l20.2041"></a><span id="l20.2041"> </span>
<a href="#l20.2042"></a><span id="l20.2042" class="difflineminus">-void CMapiFolderList::AddItem(CMapiFolder *pFolder)</span>
<a href="#l20.2043"></a><span id="l20.2043" class="difflineminus">-{</span>
<a href="#l20.2044"></a><span id="l20.2044" class="difflineplus">+void CMapiFolderList::AddItem(CMapiFolder *pFolder) {</span>
<a href="#l20.2045"></a><span id="l20.2045">   EnsureUniqueName(pFolder);</span>
<a href="#l20.2046"></a><span id="l20.2046">   GenerateFilePath(pFolder);</span>
<a href="#l20.2047"></a><span id="l20.2047">   m_array.AppendElement(pFolder);</span>
<a href="#l20.2048"></a><span id="l20.2048"> }</span>
<a href="#l20.2049"></a><span id="l20.2049"> </span>
<a href="#l20.2050"></a><span id="l20.2050" class="difflineminus">-void CMapiFolderList::ChangeName(nsString&amp; name)</span>
<a href="#l20.2051"></a><span id="l20.2051" class="difflineminus">-{</span>
<a href="#l20.2052"></a><span id="l20.2052" class="difflineplus">+void CMapiFolderList::ChangeName(nsString &amp;name) {</span>
<a href="#l20.2053"></a><span id="l20.2053">   if (name.IsEmpty()) {</span>
<a href="#l20.2054"></a><span id="l20.2054">     name.Assign('1');</span>
<a href="#l20.2055"></a><span id="l20.2055">     return;</span>
<a href="#l20.2056"></a><span id="l20.2056">   }</span>
<a href="#l20.2057"></a><span id="l20.2057">   char16_t lastC = name.Last();</span>
<a href="#l20.2058"></a><span id="l20.2058">   if ((lastC &gt;= '0') &amp;&amp; (lastC &lt;= '9')) {</span>
<a href="#l20.2059"></a><span id="l20.2059">     lastC++;</span>
<a href="#l20.2060"></a><span id="l20.2060">     if (lastC &gt; '9') {</span>
<a href="#l20.2061"></a><span id="l20.2061">       lastC = '1';</span>
<a href="#l20.2062"></a><span id="l20.2062">       name.SetCharAt(lastC, name.Length() - 1);</span>
<a href="#l20.2063"></a><span id="l20.2063">       name.Append('0');</span>
<a href="#l20.2064"></a><span id="l20.2064" class="difflineminus">-    }</span>
<a href="#l20.2065"></a><span id="l20.2065" class="difflineminus">-    else {</span>
<a href="#l20.2066"></a><span id="l20.2066" class="difflineplus">+    } else {</span>
<a href="#l20.2067"></a><span id="l20.2067">       name.SetCharAt(lastC, name.Length() - 1);</span>
<a href="#l20.2068"></a><span id="l20.2068">     }</span>
<a href="#l20.2069"></a><span id="l20.2069" class="difflineminus">-  }</span>
<a href="#l20.2070"></a><span id="l20.2070" class="difflineminus">-  else {</span>
<a href="#l20.2071"></a><span id="l20.2071" class="difflineplus">+  } else {</span>
<a href="#l20.2072"></a><span id="l20.2072">     name.AppendLiteral(&quot; 2&quot;);</span>
<a href="#l20.2073"></a><span id="l20.2073">   }</span>
<a href="#l20.2074"></a><span id="l20.2074"> }</span>
<a href="#l20.2075"></a><span id="l20.2075"> </span>
<a href="#l20.2076"></a><span id="l20.2076" class="difflineminus">-void CMapiFolderList::EnsureUniqueName(CMapiFolder *pFolder)</span>
<a href="#l20.2077"></a><span id="l20.2077" class="difflineminus">-{</span>
<a href="#l20.2078"></a><span id="l20.2078" class="difflineplus">+void CMapiFolderList::EnsureUniqueName(CMapiFolder *pFolder) {</span>
<a href="#l20.2079"></a><span id="l20.2079">   // For everybody in the array before me with the SAME</span>
<a href="#l20.2080"></a><span id="l20.2080">   // depth, my name must be unique</span>
<a href="#l20.2081"></a><span id="l20.2081" class="difflineminus">-  CMapiFolder *  pCurrent;</span>
<a href="#l20.2082"></a><span id="l20.2082" class="difflineminus">-  int        i;</span>
<a href="#l20.2083"></a><span id="l20.2083" class="difflineminus">-  BOOL      done;</span>
<a href="#l20.2084"></a><span id="l20.2084" class="difflineminus">-  nsString    name;</span>
<a href="#l20.2085"></a><span id="l20.2085" class="difflineminus">-  nsString    cName;</span>
<a href="#l20.2086"></a><span id="l20.2086" class="difflineplus">+  CMapiFolder *pCurrent;</span>
<a href="#l20.2087"></a><span id="l20.2087" class="difflineplus">+  int i;</span>
<a href="#l20.2088"></a><span id="l20.2088" class="difflineplus">+  BOOL done;</span>
<a href="#l20.2089"></a><span id="l20.2089" class="difflineplus">+  nsString name;</span>
<a href="#l20.2090"></a><span id="l20.2090" class="difflineplus">+  nsString cName;</span>
<a href="#l20.2091"></a><span id="l20.2091"> </span>
<a href="#l20.2092"></a><span id="l20.2092">   pFolder-&gt;GetDisplayName(name);</span>
<a href="#l20.2093"></a><span id="l20.2093">   do {</span>
<a href="#l20.2094"></a><span id="l20.2094">     done = TRUE;</span>
<a href="#l20.2095"></a><span id="l20.2095">     i = m_array.Length() - 1;</span>
<a href="#l20.2096"></a><span id="l20.2096">     while (i &gt;= 0) {</span>
<a href="#l20.2097"></a><span id="l20.2097">       pCurrent = GetAt(i);</span>
<a href="#l20.2098"></a><span id="l20.2098">       if (pCurrent-&gt;GetDepth() == pFolder-&gt;GetDepth()) {</span>
<a href="#l20.2099"></a><span id="l20.2099">         pCurrent-&gt;GetDisplayName(cName);</span>
<a href="#l20.2100"></a><span id="l20.2100">         if (cName.Equals(name, nsCaseInsensitiveStringComparator())) {</span>
<a href="#l20.2101"></a><span id="l20.2101">           ChangeName(name);</span>
<a href="#l20.2102"></a><span id="l20.2102">           pFolder-&gt;SetDisplayName(name.get());</span>
<a href="#l20.2103"></a><span id="l20.2103">           done = FALSE;</span>
<a href="#l20.2104"></a><span id="l20.2104">           break;</span>
<a href="#l20.2105"></a><span id="l20.2105">         }</span>
<a href="#l20.2106"></a><span id="l20.2106" class="difflineminus">-      }</span>
<a href="#l20.2107"></a><span id="l20.2107" class="difflineminus">-      else if (pCurrent-&gt;GetDepth() &lt; pFolder-&gt;GetDepth())</span>
<a href="#l20.2108"></a><span id="l20.2108" class="difflineplus">+      } else if (pCurrent-&gt;GetDepth() &lt; pFolder-&gt;GetDepth())</span>
<a href="#l20.2109"></a><span id="l20.2109">         break;</span>
<a href="#l20.2110"></a><span id="l20.2110">       i--;</span>
<a href="#l20.2111"></a><span id="l20.2111">     }</span>
<a href="#l20.2112"></a><span id="l20.2112">   } while (!done);</span>
<a href="#l20.2113"></a><span id="l20.2113"> }</span>
<a href="#l20.2114"></a><span id="l20.2114"> </span>
<a href="#l20.2115"></a><span id="l20.2115" class="difflineminus">-void CMapiFolderList::GenerateFilePath(CMapiFolder *pFolder)</span>
<a href="#l20.2116"></a><span id="l20.2116" class="difflineminus">-{</span>
<a href="#l20.2117"></a><span id="l20.2117" class="difflineplus">+void CMapiFolderList::GenerateFilePath(CMapiFolder *pFolder) {</span>
<a href="#l20.2118"></a><span id="l20.2118">   // A file path, includes all of my parent's path, plus mine</span>
<a href="#l20.2119"></a><span id="l20.2119" class="difflineminus">-  nsString    name;</span>
<a href="#l20.2120"></a><span id="l20.2120" class="difflineminus">-  nsString    path;</span>
<a href="#l20.2121"></a><span id="l20.2121" class="difflineplus">+  nsString name;</span>
<a href="#l20.2122"></a><span id="l20.2122" class="difflineplus">+  nsString path;</span>
<a href="#l20.2123"></a><span id="l20.2123">   if (!pFolder-&gt;GetDepth()) {</span>
<a href="#l20.2124"></a><span id="l20.2124">     pFolder-&gt;GetDisplayName(name);</span>
<a href="#l20.2125"></a><span id="l20.2125">     pFolder-&gt;SetFilePath(name.get());</span>
<a href="#l20.2126"></a><span id="l20.2126">     return;</span>
<a href="#l20.2127"></a><span id="l20.2127">   }</span>
<a href="#l20.2128"></a><span id="l20.2128"> </span>
<a href="#l20.2129"></a><span id="l20.2129" class="difflineminus">-  CMapiFolder *  pCurrent;</span>
<a href="#l20.2130"></a><span id="l20.2130" class="difflineminus">-  int        i = m_array.Length() - 1;</span>
<a href="#l20.2131"></a><span id="l20.2131" class="difflineplus">+  CMapiFolder *pCurrent;</span>
<a href="#l20.2132"></a><span id="l20.2132" class="difflineplus">+  int i = m_array.Length() - 1;</span>
<a href="#l20.2133"></a><span id="l20.2133">   while (i &gt;= 0) {</span>
<a href="#l20.2134"></a><span id="l20.2134">     pCurrent = GetAt(i);</span>
<a href="#l20.2135"></a><span id="l20.2135">     if (pCurrent-&gt;GetDepth() == (pFolder-&gt;GetDepth() - 1)) {</span>
<a href="#l20.2136"></a><span id="l20.2136">       pCurrent-&gt;GetFilePath(path);</span>
<a href="#l20.2137"></a><span id="l20.2137">       path.AppendLiteral(&quot;.sbd\\&quot;);</span>
<a href="#l20.2138"></a><span id="l20.2138">       pFolder-&gt;GetDisplayName(name);</span>
<a href="#l20.2139"></a><span id="l20.2139">       path += name;</span>
<a href="#l20.2140"></a><span id="l20.2140">       pFolder-&gt;SetFilePath(path.get());</span>
<a href="#l20.2141"></a><span id="l20.2141">       return;</span>
<a href="#l20.2142"></a><span id="l20.2142">     }</span>
<a href="#l20.2143"></a><span id="l20.2143">     i--;</span>
<a href="#l20.2144"></a><span id="l20.2144">   }</span>
<a href="#l20.2145"></a><span id="l20.2145">   pFolder-&gt;GetDisplayName(name);</span>
<a href="#l20.2146"></a><span id="l20.2146">   pFolder-&gt;SetFilePath(name.get());</span>
<a href="#l20.2147"></a><span id="l20.2147"> }</span>
<a href="#l20.2148"></a><span id="l20.2148"> </span>
<a href="#l20.2149"></a><span id="l20.2149" class="difflineminus">-void CMapiFolderList::ClearAll(void)</span>
<a href="#l20.2150"></a><span id="l20.2150" class="difflineminus">-{</span>
<a href="#l20.2151"></a><span id="l20.2151" class="difflineplus">+void CMapiFolderList::ClearAll(void) {</span>
<a href="#l20.2152"></a><span id="l20.2152">   CMapiFolder *pFolder;</span>
<a href="#l20.2153"></a><span id="l20.2153">   for (size_t i = 0; i &lt; m_array.Length(); i++) {</span>
<a href="#l20.2154"></a><span id="l20.2154">     pFolder = GetAt(i);</span>
<a href="#l20.2155"></a><span id="l20.2155">     delete pFolder;</span>
<a href="#l20.2156"></a><span id="l20.2156">   }</span>
<a href="#l20.2157"></a><span id="l20.2157">   m_array.Clear();</span>
<a href="#l20.2158"></a><span id="l20.2158"> }</span>
<a href="#l20.2159"></a><span id="l20.2159"> </span>
<a href="#l20.2160"></a><span id="l20.2160" class="difflineminus">-void CMapiFolderList::DumpList(void)</span>
<a href="#l20.2161"></a><span id="l20.2161" class="difflineminus">-{</span>
<a href="#l20.2162"></a><span id="l20.2162" class="difflineplus">+void CMapiFolderList::DumpList(void) {</span>
<a href="#l20.2163"></a><span id="l20.2163">   CMapiFolder *pFolder;</span>
<a href="#l20.2164"></a><span id="l20.2164" class="difflineminus">-  nsString  str;</span>
<a href="#l20.2165"></a><span id="l20.2165" class="difflineminus">-  int      depth;</span>
<a href="#l20.2166"></a><span id="l20.2166" class="difflineminus">-  char    prefix[256];</span>
<a href="#l20.2167"></a><span id="l20.2167" class="difflineplus">+  nsString str;</span>
<a href="#l20.2168"></a><span id="l20.2168" class="difflineplus">+  int depth;</span>
<a href="#l20.2169"></a><span id="l20.2169" class="difflineplus">+  char prefix[256];</span>
<a href="#l20.2170"></a><span id="l20.2170"> </span>
<a href="#l20.2171"></a><span id="l20.2171">   MAPI_TRACE0(&quot;Folder List ---------------------------------\n&quot;);</span>
<a href="#l20.2172"></a><span id="l20.2172">   for (size_t i = 0; i &lt; m_array.Length(); i++) {</span>
<a href="#l20.2173"></a><span id="l20.2173">     pFolder = GetAt(i);</span>
<a href="#l20.2174"></a><span id="l20.2174">     depth = pFolder-&gt;GetDepth();</span>
<a href="#l20.2175"></a><span id="l20.2175">     pFolder-&gt;GetDisplayName(str);</span>
<a href="#l20.2176"></a><span id="l20.2176">     depth *= 2;</span>
<a href="#l20.2177"></a><span id="l20.2177" class="difflineminus">-    if (depth &gt; 255)</span>
<a href="#l20.2178"></a><span id="l20.2178" class="difflineminus">-      depth = 255;</span>
<a href="#l20.2179"></a><span id="l20.2179" class="difflineplus">+    if (depth &gt; 255) depth = 255;</span>
<a href="#l20.2180"></a><span id="l20.2180">     memset(prefix, ' ', depth);</span>
<a href="#l20.2181"></a><span id="l20.2181">     prefix[depth] = 0;</span>
<a href="#l20.2182"></a><span id="l20.2182"> #ifdef MAPI_DEBUG</span>
<a href="#l20.2183"></a><span id="l20.2183" class="difflineminus">-        char *ansiStr = ToNewCString(str);</span>
<a href="#l20.2184"></a><span id="l20.2184" class="difflineplus">+    char *ansiStr = ToNewCString(str);</span>
<a href="#l20.2185"></a><span id="l20.2185">     MAPI_TRACE2(&quot;%s%s: &quot;, prefix, ansiStr);</span>
<a href="#l20.2186"></a><span id="l20.2186">     free(ansiStr);</span>
<a href="#l20.2187"></a><span id="l20.2187"> #endif</span>
<a href="#l20.2188"></a><span id="l20.2188">     pFolder-&gt;GetFilePath(str);</span>
<a href="#l20.2189"></a><span id="l20.2189"> #ifdef MAPI_DEBUG</span>
<a href="#l20.2190"></a><span id="l20.2190" class="difflineminus">-        ansiStr = ToNewCString(str);</span>
<a href="#l20.2191"></a><span id="l20.2191" class="difflineplus">+    ansiStr = ToNewCString(str);</span>
<a href="#l20.2192"></a><span id="l20.2192">     MAPI_TRACE2(&quot;depth=%d, filePath=%s\n&quot;, pFolder-&gt;GetDepth(), ansiStr);</span>
<a href="#l20.2193"></a><span id="l20.2193">     free(ansiStr);</span>
<a href="#l20.2194"></a><span id="l20.2194"> #endif</span>
<a href="#l20.2195"></a><span id="l20.2195">   }</span>
<a href="#l20.2196"></a><span id="l20.2196">   MAPI_TRACE0(&quot;---------------------------------------------\n&quot;);</span>
<a href="#l20.2197"></a><span id="l20.2197"> }</span>
<a href="#l20.2198"></a><span id="l20.2198"> </span>
<a href="#l20.2199"></a><span id="l20.2199" class="difflineminus">-</span>
<a href="#l20.2200"></a><span id="l20.2200" class="difflineminus">-CMapiFolder::CMapiFolder()</span>
<a href="#l20.2201"></a><span id="l20.2201" class="difflineminus">-{</span>
<a href="#l20.2202"></a><span id="l20.2202" class="difflineplus">+CMapiFolder::CMapiFolder() {</span>
<a href="#l20.2203"></a><span id="l20.2203">   m_objectType = MAPI_FOLDER;</span>
<a href="#l20.2204"></a><span id="l20.2204">   m_cbEid = 0;</span>
<a href="#l20.2205"></a><span id="l20.2205">   m_lpEid = NULL;</span>
<a href="#l20.2206"></a><span id="l20.2206">   m_depth = 0;</span>
<a href="#l20.2207"></a><span id="l20.2207">   m_doImport = TRUE;</span>
<a href="#l20.2208"></a><span id="l20.2208"> }</span>
<a href="#l20.2209"></a><span id="l20.2209"> </span>
<a href="#l20.2210"></a><span id="l20.2210" class="difflineminus">-CMapiFolder::CMapiFolder(const char16_t *pDisplayName, ULONG cbEid, LPENTRYID lpEid, int depth, LONG oType)</span>
<a href="#l20.2211"></a><span id="l20.2211" class="difflineminus">-{</span>
<a href="#l20.2212"></a><span id="l20.2212" class="difflineplus">+CMapiFolder::CMapiFolder(const char16_t *pDisplayName, ULONG cbEid,</span>
<a href="#l20.2213"></a><span id="l20.2213" class="difflineplus">+                         LPENTRYID lpEid, int depth, LONG oType) {</span>
<a href="#l20.2214"></a><span id="l20.2214">   m_cbEid = 0;</span>
<a href="#l20.2215"></a><span id="l20.2215">   m_lpEid = NULL;</span>
<a href="#l20.2216"></a><span id="l20.2216">   SetDisplayName(pDisplayName);</span>
<a href="#l20.2217"></a><span id="l20.2217">   SetEntryID(cbEid, lpEid);</span>
<a href="#l20.2218"></a><span id="l20.2218">   SetDepth(depth);</span>
<a href="#l20.2219"></a><span id="l20.2219">   SetObjectType(oType);</span>
<a href="#l20.2220"></a><span id="l20.2220">   SetDoImport(TRUE);</span>
<a href="#l20.2221"></a><span id="l20.2221"> }</span>
<a href="#l20.2222"></a><span id="l20.2222"> </span>
<a href="#l20.2223"></a><span id="l20.2223" class="difflineminus">-CMapiFolder::CMapiFolder(const CMapiFolder *pCopyFrom)</span>
<a href="#l20.2224"></a><span id="l20.2224" class="difflineminus">-{</span>
<a href="#l20.2225"></a><span id="l20.2225" class="difflineplus">+CMapiFolder::CMapiFolder(const CMapiFolder *pCopyFrom) {</span>
<a href="#l20.2226"></a><span id="l20.2226">   m_lpEid = NULL;</span>
<a href="#l20.2227"></a><span id="l20.2227">   m_cbEid = 0;</span>
<a href="#l20.2228"></a><span id="l20.2228">   SetDoImport(pCopyFrom-&gt;GetDoImport());</span>
<a href="#l20.2229"></a><span id="l20.2229">   SetDisplayName(pCopyFrom-&gt;m_displayName.get());</span>
<a href="#l20.2230"></a><span id="l20.2230">   SetObjectType(pCopyFrom-&gt;GetObjectType());</span>
<a href="#l20.2231"></a><span id="l20.2231">   SetEntryID(pCopyFrom-&gt;GetCBEntryID(), pCopyFrom-&gt;GetEntryID());</span>
<a href="#l20.2232"></a><span id="l20.2232">   SetDepth(pCopyFrom-&gt;GetDepth());</span>
<a href="#l20.2233"></a><span id="l20.2233">   SetFilePath(pCopyFrom-&gt;m_mailFilePath.get());</span>
<a href="#l20.2234"></a><span id="l20.2234"> }</span>
<a href="#l20.2235"></a><span id="l20.2235"> </span>
<a href="#l20.2236"></a><span id="l20.2236" class="difflineminus">-CMapiFolder::~CMapiFolder()</span>
<a href="#l20.2237"></a><span id="l20.2237" class="difflineminus">-{</span>
<a href="#l20.2238"></a><span id="l20.2238" class="difflineminus">-  if (m_lpEid)</span>
<a href="#l20.2239"></a><span id="l20.2239" class="difflineminus">-    delete m_lpEid;</span>
<a href="#l20.2240"></a><span id="l20.2240" class="difflineplus">+CMapiFolder::~CMapiFolder() {</span>
<a href="#l20.2241"></a><span id="l20.2241" class="difflineplus">+  if (m_lpEid) delete m_lpEid;</span>
<a href="#l20.2242"></a><span id="l20.2242"> }</span>
<a href="#l20.2243"></a><span id="l20.2243"> </span>
<a href="#l20.2244"></a><span id="l20.2244" class="difflineminus">-void CMapiFolder::SetEntryID(ULONG cbEid, LPENTRYID lpEid)</span>
<a href="#l20.2245"></a><span id="l20.2245" class="difflineminus">-{</span>
<a href="#l20.2246"></a><span id="l20.2246" class="difflineminus">-  if (m_lpEid)</span>
<a href="#l20.2247"></a><span id="l20.2247" class="difflineminus">-    delete m_lpEid;</span>
<a href="#l20.2248"></a><span id="l20.2248" class="difflineplus">+void CMapiFolder::SetEntryID(ULONG cbEid, LPENTRYID lpEid) {</span>
<a href="#l20.2249"></a><span id="l20.2249" class="difflineplus">+  if (m_lpEid) delete m_lpEid;</span>
<a href="#l20.2250"></a><span id="l20.2250">   m_lpEid = NULL;</span>
<a href="#l20.2251"></a><span id="l20.2251">   m_cbEid = cbEid;</span>
<a href="#l20.2252"></a><span id="l20.2252">   if (cbEid) {</span>
<a href="#l20.2253"></a><span id="l20.2253">     m_lpEid = new BYTE[cbEid];</span>
<a href="#l20.2254"></a><span id="l20.2254">     memcpy(m_lpEid, lpEid, cbEid);</span>
<a href="#l20.2255"></a><span id="l20.2255">   }</span>
<a href="#l20.2256"></a><span id="l20.2256"> }</span>
<a href="#l20.2257"></a><span id="l20.2257"> </span>
<a href="#l20.2258"></a><span id="l20.2258"> // ---------------------------------------------------------------------</span>
<a href="#l20.2259"></a><span id="l20.2259"> // Message store stuff</span>
<a href="#l20.2260"></a><span id="l20.2260"> // ---------------------------------------------------------------------</span>
<a href="#l20.2261"></a><span id="l20.2261"> </span>
<a href="#l20.2262"></a><span id="l20.2262" class="difflineminus">-</span>
<a href="#l20.2263"></a><span id="l20.2263" class="difflineminus">-CMsgStore::CMsgStore(ULONG cbEid, LPENTRYID lpEid)</span>
<a href="#l20.2264"></a><span id="l20.2264" class="difflineminus">-{</span>
<a href="#l20.2265"></a><span id="l20.2265" class="difflineplus">+CMsgStore::CMsgStore(ULONG cbEid, LPENTRYID lpEid) {</span>
<a href="#l20.2266"></a><span id="l20.2266">   m_lpEid = NULL;</span>
<a href="#l20.2267"></a><span id="l20.2267">   m_lpMdb = NULL;</span>
<a href="#l20.2268"></a><span id="l20.2268">   SetEntryID(cbEid, lpEid);</span>
<a href="#l20.2269"></a><span id="l20.2269"> }</span>
<a href="#l20.2270"></a><span id="l20.2270"> </span>
<a href="#l20.2271"></a><span id="l20.2271" class="difflineminus">-CMsgStore::~CMsgStore()</span>
<a href="#l20.2272"></a><span id="l20.2272" class="difflineminus">-{</span>
<a href="#l20.2273"></a><span id="l20.2273" class="difflineminus">-  if (m_lpEid)</span>
<a href="#l20.2274"></a><span id="l20.2274" class="difflineminus">-    delete m_lpEid;</span>
<a href="#l20.2275"></a><span id="l20.2275" class="difflineplus">+CMsgStore::~CMsgStore() {</span>
<a href="#l20.2276"></a><span id="l20.2276" class="difflineplus">+  if (m_lpEid) delete m_lpEid;</span>
<a href="#l20.2277"></a><span id="l20.2277"> </span>
<a href="#l20.2278"></a><span id="l20.2278">   if (m_lpMdb) {</span>
<a href="#l20.2279"></a><span id="l20.2279">     ULONG flags = LOGOFF_NO_WAIT;</span>
<a href="#l20.2280"></a><span id="l20.2280">     m_lpMdb-&gt;StoreLogoff(&amp;flags);</span>
<a href="#l20.2281"></a><span id="l20.2281">     m_lpMdb-&gt;Release();</span>
<a href="#l20.2282"></a><span id="l20.2282">     m_lpMdb = NULL;</span>
<a href="#l20.2283"></a><span id="l20.2283">   }</span>
<a href="#l20.2284"></a><span id="l20.2284"> }</span>
<a href="#l20.2285"></a><span id="l20.2285"> </span>
<a href="#l20.2286"></a><span id="l20.2286" class="difflineminus">-void CMsgStore::SetEntryID(ULONG cbEid, LPENTRYID lpEid)</span>
<a href="#l20.2287"></a><span id="l20.2287" class="difflineminus">-{</span>
<a href="#l20.2288"></a><span id="l20.2288" class="difflineminus">-  if (m_lpEid)</span>
<a href="#l20.2289"></a><span id="l20.2289" class="difflineminus">-    delete m_lpEid;</span>
<a href="#l20.2290"></a><span id="l20.2290" class="difflineplus">+void CMsgStore::SetEntryID(ULONG cbEid, LPENTRYID lpEid) {</span>
<a href="#l20.2291"></a><span id="l20.2291" class="difflineplus">+  if (m_lpEid) delete m_lpEid;</span>
<a href="#l20.2292"></a><span id="l20.2292"> </span>
<a href="#l20.2293"></a><span id="l20.2293">   m_lpEid = NULL;</span>
<a href="#l20.2294"></a><span id="l20.2294">   if (cbEid) {</span>
<a href="#l20.2295"></a><span id="l20.2295">     m_lpEid = new BYTE[cbEid];</span>
<a href="#l20.2296"></a><span id="l20.2296">     memcpy(m_lpEid, lpEid, cbEid);</span>
<a href="#l20.2297"></a><span id="l20.2297">   }</span>
<a href="#l20.2298"></a><span id="l20.2298">   m_cbEid = cbEid;</span>
<a href="#l20.2299"></a><span id="l20.2299"> </span>
<a href="#l20.2300"></a><span id="l20.2300">   if (m_lpMdb) {</span>
<a href="#l20.2301"></a><span id="l20.2301">     ULONG flags = LOGOFF_NO_WAIT;</span>
<a href="#l20.2302"></a><span id="l20.2302">     m_lpMdb-&gt;StoreLogoff(&amp;flags);</span>
<a href="#l20.2303"></a><span id="l20.2303">     m_lpMdb-&gt;Release();</span>
<a href="#l20.2304"></a><span id="l20.2304">     m_lpMdb = NULL;</span>
<a href="#l20.2305"></a><span id="l20.2305">   }</span>
<a href="#l20.2306"></a><span id="l20.2306"> }</span>
<a href="#l20.2307"></a><span id="l20.2307"> </span>
<a href="#l20.2308"></a><span id="l20.2308" class="difflineminus">-BOOL CMsgStore::Open(LPMAPISESSION pSession, LPMDB *ppMdb)</span>
<a href="#l20.2309"></a><span id="l20.2309" class="difflineminus">-{</span>
<a href="#l20.2310"></a><span id="l20.2310" class="difflineplus">+BOOL CMsgStore::Open(LPMAPISESSION pSession, LPMDB *ppMdb) {</span>
<a href="#l20.2311"></a><span id="l20.2311">   if (m_lpMdb) {</span>
<a href="#l20.2312"></a><span id="l20.2312" class="difflineminus">-    if (ppMdb)</span>
<a href="#l20.2313"></a><span id="l20.2313" class="difflineminus">-      *ppMdb = m_lpMdb;</span>
<a href="#l20.2314"></a><span id="l20.2314" class="difflineplus">+    if (ppMdb) *ppMdb = m_lpMdb;</span>
<a href="#l20.2315"></a><span id="l20.2315">     return TRUE;</span>
<a href="#l20.2316"></a><span id="l20.2316">   }</span>
<a href="#l20.2317"></a><span id="l20.2317"> </span>
<a href="#l20.2318"></a><span id="l20.2318">   BOOL bResult = TRUE;</span>
<a href="#l20.2319"></a><span id="l20.2319" class="difflineminus">-  HRESULT hr = pSession-&gt;OpenMsgStore(NULL, m_cbEid, (LPENTRYID)m_lpEid, NULL, MDB_NO_MAIL, &amp;m_lpMdb);    // MDB pointer</span>
<a href="#l20.2320"></a><span id="l20.2320" class="difflineplus">+  HRESULT hr = pSession-&gt;OpenMsgStore(NULL, m_cbEid, (LPENTRYID)m_lpEid, NULL,</span>
<a href="#l20.2321"></a><span id="l20.2321" class="difflineplus">+                                      MDB_NO_MAIL, &amp;m_lpMdb);  // MDB pointer</span>
<a href="#l20.2322"></a><span id="l20.2322">   if (HR_FAILED(hr)) {</span>
<a href="#l20.2323"></a><span id="l20.2323">     m_lpMdb = NULL;</span>
<a href="#l20.2324"></a><span id="l20.2324">     MAPI_TRACE2(&quot;OpenMsgStore failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l20.2325"></a><span id="l20.2325">     bResult = FALSE;</span>
<a href="#l20.2326"></a><span id="l20.2326">   }</span>
<a href="#l20.2327"></a><span id="l20.2327"> </span>
<a href="#l20.2328"></a><span id="l20.2328" class="difflineminus">-  if (ppMdb)</span>
<a href="#l20.2329"></a><span id="l20.2329" class="difflineminus">-    *ppMdb = m_lpMdb;</span>
<a href="#l20.2330"></a><span id="l20.2330" class="difflineplus">+  if (ppMdb) *ppMdb = m_lpMdb;</span>
<a href="#l20.2331"></a><span id="l20.2331">   return bResult;</span>
<a href="#l20.2332"></a><span id="l20.2332"> }</span>
<a href="#l20.2333"></a><span id="l20.2333"> </span>
<a href="#l20.2334"></a><span id="l20.2334" class="difflineminus">-</span>
<a href="#l20.2335"></a><span id="l20.2335" class="difflineminus">-</span>
<a href="#l20.2336"></a><span id="l20.2336"> // ------------------------------------------------------------</span>
<a href="#l20.2337"></a><span id="l20.2337"> // Contents Iterator</span>
<a href="#l20.2338"></a><span id="l20.2338"> // -----------------------------------------------------------</span>
<a href="#l20.2339"></a><span id="l20.2339"> </span>
<a href="#l20.2340"></a><span id="l20.2340" class="difflineminus">-</span>
<a href="#l20.2341"></a><span id="l20.2341" class="difflineminus">-CMapiFolderContents::CMapiFolderContents(LPMDB lpMdb, ULONG cbEid, LPENTRYID lpEid)</span>
<a href="#l20.2342"></a><span id="l20.2342" class="difflineminus">-{</span>
<a href="#l20.2343"></a><span id="l20.2343" class="difflineplus">+CMapiFolderContents::CMapiFolderContents(LPMDB lpMdb, ULONG cbEid,</span>
<a href="#l20.2344"></a><span id="l20.2344" class="difflineplus">+                                         LPENTRYID lpEid) {</span>
<a href="#l20.2345"></a><span id="l20.2345">   m_lpMdb = lpMdb;</span>
<a href="#l20.2346"></a><span id="l20.2346">   m_fCbEid = cbEid;</span>
<a href="#l20.2347"></a><span id="l20.2347">   m_fLpEid = new BYTE[cbEid];</span>
<a href="#l20.2348"></a><span id="l20.2348">   memcpy(m_fLpEid, lpEid, cbEid);</span>
<a href="#l20.2349"></a><span id="l20.2349">   m_count = 0;</span>
<a href="#l20.2350"></a><span id="l20.2350">   m_iterCount = 0;</span>
<a href="#l20.2351"></a><span id="l20.2351">   m_failure = FALSE;</span>
<a href="#l20.2352"></a><span id="l20.2352">   m_lastError = 0;</span>
<a href="#l20.2353"></a><span id="l20.2353">   m_lpFolder = NULL;</span>
<a href="#l20.2354"></a><span id="l20.2354">   m_lpTable = NULL;</span>
<a href="#l20.2355"></a><span id="l20.2355">   m_lastLpEid = NULL;</span>
<a href="#l20.2356"></a><span id="l20.2356">   m_lastCbEid = 0;</span>
<a href="#l20.2357"></a><span id="l20.2357"> }</span>
<a href="#l20.2358"></a><span id="l20.2358"> </span>
<a href="#l20.2359"></a><span id="l20.2359" class="difflineminus">-CMapiFolderContents::~CMapiFolderContents()</span>
<a href="#l20.2360"></a><span id="l20.2360" class="difflineminus">-{</span>
<a href="#l20.2361"></a><span id="l20.2361" class="difflineminus">-  if (m_lastLpEid)</span>
<a href="#l20.2362"></a><span id="l20.2362" class="difflineminus">-    delete m_lastLpEid;</span>
<a href="#l20.2363"></a><span id="l20.2363" class="difflineplus">+CMapiFolderContents::~CMapiFolderContents() {</span>
<a href="#l20.2364"></a><span id="l20.2364" class="difflineplus">+  if (m_lastLpEid) delete m_lastLpEid;</span>
<a href="#l20.2365"></a><span id="l20.2365">   delete m_fLpEid;</span>
<a href="#l20.2366"></a><span id="l20.2366" class="difflineminus">-  if (m_lpTable)</span>
<a href="#l20.2367"></a><span id="l20.2367" class="difflineminus">-    m_lpTable-&gt;Release();</span>
<a href="#l20.2368"></a><span id="l20.2368" class="difflineminus">-  if (m_lpFolder)</span>
<a href="#l20.2369"></a><span id="l20.2369" class="difflineminus">-    m_lpFolder-&gt;Release();</span>
<a href="#l20.2370"></a><span id="l20.2370" class="difflineplus">+  if (m_lpTable) m_lpTable-&gt;Release();</span>
<a href="#l20.2371"></a><span id="l20.2371" class="difflineplus">+  if (m_lpFolder) m_lpFolder-&gt;Release();</span>
<a href="#l20.2372"></a><span id="l20.2372"> }</span>
<a href="#l20.2373"></a><span id="l20.2373"> </span>
<a href="#l20.2374"></a><span id="l20.2374" class="difflineminus">-</span>
<a href="#l20.2375"></a><span id="l20.2375" class="difflineminus">-BOOL CMapiFolderContents::SetUpIter(void)</span>
<a href="#l20.2376"></a><span id="l20.2376" class="difflineminus">-{</span>
<a href="#l20.2377"></a><span id="l20.2377" class="difflineplus">+BOOL CMapiFolderContents::SetUpIter(void) {</span>
<a href="#l20.2378"></a><span id="l20.2378">   // First, open up the MAPIFOLDER object</span>
<a href="#l20.2379"></a><span id="l20.2379" class="difflineminus">-  ULONG    ulObjType;</span>
<a href="#l20.2380"></a><span id="l20.2380" class="difflineminus">-  HRESULT    hr;</span>
<a href="#l20.2381"></a><span id="l20.2381" class="difflineminus">-  hr = m_lpMdb-&gt;OpenEntry(m_fCbEid, (LPENTRYID) m_fLpEid, NULL, 0, &amp;ulObjType, (LPUNKNOWN *) &amp;m_lpFolder);</span>
<a href="#l20.2382"></a><span id="l20.2382" class="difflineplus">+  ULONG ulObjType;</span>
<a href="#l20.2383"></a><span id="l20.2383" class="difflineplus">+  HRESULT hr;</span>
<a href="#l20.2384"></a><span id="l20.2384" class="difflineplus">+  hr = m_lpMdb-&gt;OpenEntry(m_fCbEid, (LPENTRYID)m_fLpEid, NULL, 0, &amp;ulObjType,</span>
<a href="#l20.2385"></a><span id="l20.2385" class="difflineplus">+                          (LPUNKNOWN *)&amp;m_lpFolder);</span>
<a href="#l20.2386"></a><span id="l20.2386"> </span>
<a href="#l20.2387"></a><span id="l20.2387">   if (FAILED(hr) || !m_lpFolder) {</span>
<a href="#l20.2388"></a><span id="l20.2388">     m_lpFolder = NULL;</span>
<a href="#l20.2389"></a><span id="l20.2389">     m_lastError = hr;</span>
<a href="#l20.2390"></a><span id="l20.2390" class="difflineminus">-    MAPI_TRACE2(&quot;CMapiFolderContents OpenEntry failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l20.2391"></a><span id="l20.2391" class="difflineplus">+    MAPI_TRACE2(&quot;CMapiFolderContents OpenEntry failed: 0x%lx, %d\n&quot;, (long)hr,</span>
<a href="#l20.2392"></a><span id="l20.2392" class="difflineplus">+                (int)hr);</span>
<a href="#l20.2393"></a><span id="l20.2393">     return FALSE;</span>
<a href="#l20.2394"></a><span id="l20.2394">   }</span>
<a href="#l20.2395"></a><span id="l20.2395"> </span>
<a href="#l20.2396"></a><span id="l20.2396">   if (ulObjType != MAPI_FOLDER) {</span>
<a href="#l20.2397"></a><span id="l20.2397">     m_lastError = -1;</span>
<a href="#l20.2398"></a><span id="l20.2398">     MAPI_TRACE0(&quot;CMapiFolderContents - bad object type, not a folder.\n&quot;);</span>
<a href="#l20.2399"></a><span id="l20.2399">     return FALSE;</span>
<a href="#l20.2400"></a><span id="l20.2400">   }</span>
<a href="#l20.2401"></a><span id="l20.2401"> </span>
<a href="#l20.2402"></a><span id="l20.2402" class="difflineminus">-</span>
<a href="#l20.2403"></a><span id="l20.2403">   hr = m_lpFolder-&gt;GetContentsTable(0, &amp;m_lpTable);</span>
<a href="#l20.2404"></a><span id="l20.2404">   if (FAILED(hr) || !m_lpTable) {</span>
<a href="#l20.2405"></a><span id="l20.2405">     m_lastError = hr;</span>
<a href="#l20.2406"></a><span id="l20.2406">     m_lpTable = NULL;</span>
<a href="#l20.2407"></a><span id="l20.2407" class="difflineminus">-    MAPI_TRACE2(&quot;CMapiFolderContents - GetContentsTable failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l20.2408"></a><span id="l20.2408" class="difflineplus">+    MAPI_TRACE2(&quot;CMapiFolderContents - GetContentsTable failed: 0x%lx, %d\n&quot;,</span>
<a href="#l20.2409"></a><span id="l20.2409" class="difflineplus">+                (long)hr, (int)hr);</span>
<a href="#l20.2410"></a><span id="l20.2410">     return FALSE;</span>
<a href="#l20.2411"></a><span id="l20.2411">   }</span>
<a href="#l20.2412"></a><span id="l20.2412"> </span>
<a href="#l20.2413"></a><span id="l20.2413">   hr = m_lpTable-&gt;GetRowCount(0, &amp;m_count);</span>
<a href="#l20.2414"></a><span id="l20.2414">   if (FAILED(hr)) {</span>
<a href="#l20.2415"></a><span id="l20.2415">     m_lastError = hr;</span>
<a href="#l20.2416"></a><span id="l20.2416">     MAPI_TRACE0(&quot;CMapiFolderContents - GetRowCount failed\n&quot;);</span>
<a href="#l20.2417"></a><span id="l20.2417">     return FALSE;</span>
<a href="#l20.2418"></a><span id="l20.2418">   }</span>
<a href="#l20.2419"></a><span id="l20.2419"> </span>
<a href="#l20.2420"></a><span id="l20.2420">   hr = m_lpTable-&gt;SetColumns((LPSPropTagArray)&amp;ptaEid, 0);</span>
<a href="#l20.2421"></a><span id="l20.2421">   if (FAILED(hr)) {</span>
<a href="#l20.2422"></a><span id="l20.2422">     m_lastError = hr;</span>
<a href="#l20.2423"></a><span id="l20.2423" class="difflineminus">-    MAPI_TRACE2(&quot;CMapiFolderContents - SetColumns failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l20.2424"></a><span id="l20.2424" class="difflineplus">+    MAPI_TRACE2(&quot;CMapiFolderContents - SetColumns failed: 0x%lx, %d\n&quot;,</span>
<a href="#l20.2425"></a><span id="l20.2425" class="difflineplus">+                (long)hr, (int)hr);</span>
<a href="#l20.2426"></a><span id="l20.2426">     return FALSE;</span>
<a href="#l20.2427"></a><span id="l20.2427">   }</span>
<a href="#l20.2428"></a><span id="l20.2428"> </span>
<a href="#l20.2429"></a><span id="l20.2429">   hr = m_lpTable-&gt;SeekRow(BOOKMARK_BEGINNING, 0, NULL);</span>
<a href="#l20.2430"></a><span id="l20.2430">   if (FAILED(hr)) {</span>
<a href="#l20.2431"></a><span id="l20.2431">     m_lastError = hr;</span>
<a href="#l20.2432"></a><span id="l20.2432" class="difflineminus">-    MAPI_TRACE2(&quot;CMapiFolderContents - SeekRow failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l20.2433"></a><span id="l20.2433" class="difflineplus">+    MAPI_TRACE2(&quot;CMapiFolderContents - SeekRow failed: 0x%lx, %d\n&quot;, (long)hr,</span>
<a href="#l20.2434"></a><span id="l20.2434" class="difflineplus">+                (int)hr);</span>
<a href="#l20.2435"></a><span id="l20.2435">     return FALSE;</span>
<a href="#l20.2436"></a><span id="l20.2436">   }</span>
<a href="#l20.2437"></a><span id="l20.2437"> </span>
<a href="#l20.2438"></a><span id="l20.2438">   return TRUE;</span>
<a href="#l20.2439"></a><span id="l20.2439"> }</span>
<a href="#l20.2440"></a><span id="l20.2440"> </span>
<a href="#l20.2441"></a><span id="l20.2441" class="difflineminus">-</span>
<a href="#l20.2442"></a><span id="l20.2442" class="difflineminus">-BOOL CMapiFolderContents::GetNext(ULONG *pcbEid, LPENTRYID *ppEid, ULONG *poType, BOOL *pDone)</span>
<a href="#l20.2443"></a><span id="l20.2443" class="difflineminus">-{</span>
<a href="#l20.2444"></a><span id="l20.2444" class="difflineplus">+BOOL CMapiFolderContents::GetNext(ULONG *pcbEid, LPENTRYID *ppEid,</span>
<a href="#l20.2445"></a><span id="l20.2445" class="difflineplus">+                                  ULONG *poType, BOOL *pDone) {</span>
<a href="#l20.2446"></a><span id="l20.2446">   *pDone = FALSE;</span>
<a href="#l20.2447"></a><span id="l20.2447" class="difflineminus">-  if (m_failure)</span>
<a href="#l20.2448"></a><span id="l20.2448" class="difflineminus">-    return FALSE;</span>
<a href="#l20.2449"></a><span id="l20.2449" class="difflineplus">+  if (m_failure) return FALSE;</span>
<a href="#l20.2450"></a><span id="l20.2450">   if (!m_lpFolder) {</span>
<a href="#l20.2451"></a><span id="l20.2451">     if (!SetUpIter()) {</span>
<a href="#l20.2452"></a><span id="l20.2452">       m_failure = TRUE;</span>
<a href="#l20.2453"></a><span id="l20.2453">       return FALSE;</span>
<a href="#l20.2454"></a><span id="l20.2454">     }</span>
<a href="#l20.2455"></a><span id="l20.2455">     if (!m_count) {</span>
<a href="#l20.2456"></a><span id="l20.2456">       *pDone = TRUE;</span>
<a href="#l20.2457"></a><span id="l20.2457">       return TRUE;</span>
<a href="#l20.2458"></a><span id="l20.2458">     }</span>
<a href="#l20.2459"></a><span id="l20.2459">   }</span>
<a href="#l20.2460"></a><span id="l20.2460"> </span>
<a href="#l20.2461"></a><span id="l20.2461" class="difflineminus">-  int      cNumRows = 0;</span>
<a href="#l20.2462"></a><span id="l20.2462" class="difflineminus">-  LPSRowSet  lpRow = NULL;</span>
<a href="#l20.2463"></a><span id="l20.2463" class="difflineminus">-  HRESULT    hr = m_lpTable-&gt;QueryRows(1, 0, &amp;lpRow);</span>
<a href="#l20.2464"></a><span id="l20.2464" class="difflineplus">+  int cNumRows = 0;</span>
<a href="#l20.2465"></a><span id="l20.2465" class="difflineplus">+  LPSRowSet lpRow = NULL;</span>
<a href="#l20.2466"></a><span id="l20.2466" class="difflineplus">+  HRESULT hr = m_lpTable-&gt;QueryRows(1, 0, &amp;lpRow);</span>
<a href="#l20.2467"></a><span id="l20.2467"> </span>
<a href="#l20.2468"></a><span id="l20.2468" class="difflineminus">-  if(HR_FAILED(hr)) {</span>
<a href="#l20.2469"></a><span id="l20.2469" class="difflineplus">+  if (HR_FAILED(hr)) {</span>
<a href="#l20.2470"></a><span id="l20.2470">     m_lastError = hr;</span>
<a href="#l20.2471"></a><span id="l20.2471">     m_failure = TRUE;</span>
<a href="#l20.2472"></a><span id="l20.2472" class="difflineminus">-    MAPI_TRACE2(&quot;CMapiFolderContents - QueryRows failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l20.2473"></a><span id="l20.2473" class="difflineplus">+    MAPI_TRACE2(&quot;CMapiFolderContents - QueryRows failed: 0x%lx, %d\n&quot;, (long)hr,</span>
<a href="#l20.2474"></a><span id="l20.2474" class="difflineplus">+                (int)hr);</span>
<a href="#l20.2475"></a><span id="l20.2475">     return FALSE;</span>
<a href="#l20.2476"></a><span id="l20.2476">   }</span>
<a href="#l20.2477"></a><span id="l20.2477"> </span>
<a href="#l20.2478"></a><span id="l20.2478" class="difflineminus">-  if(lpRow) {</span>
<a href="#l20.2479"></a><span id="l20.2479" class="difflineplus">+  if (lpRow) {</span>
<a href="#l20.2480"></a><span id="l20.2480">     cNumRows = lpRow-&gt;cRows;</span>
<a href="#l20.2481"></a><span id="l20.2481">     if (cNumRows) {</span>
<a href="#l20.2482"></a><span id="l20.2482" class="difflineminus">-            LPENTRYID  lpEID = (LPENTRYID) lpRow-&gt;aRow[0].lpProps[ieidPR_ENTRYID].Value.bin.lpb;</span>
<a href="#l20.2483"></a><span id="l20.2483" class="difflineminus">-            ULONG    cbEID = lpRow-&gt;aRow[0].lpProps[ieidPR_ENTRYID].Value.bin.cb;</span>
<a href="#l20.2484"></a><span id="l20.2484" class="difflineminus">-      ULONG    oType = lpRow-&gt;aRow[0].lpProps[ieidPR_OBJECT_TYPE].Value.ul;</span>
<a href="#l20.2485"></a><span id="l20.2485" class="difflineplus">+      LPENTRYID lpEID =</span>
<a href="#l20.2486"></a><span id="l20.2486" class="difflineplus">+          (LPENTRYID)lpRow-&gt;aRow[0].lpProps[ieidPR_ENTRYID].Value.bin.lpb;</span>
<a href="#l20.2487"></a><span id="l20.2487" class="difflineplus">+      ULONG cbEID = lpRow-&gt;aRow[0].lpProps[ieidPR_ENTRYID].Value.bin.cb;</span>
<a href="#l20.2488"></a><span id="l20.2488" class="difflineplus">+      ULONG oType = lpRow-&gt;aRow[0].lpProps[ieidPR_OBJECT_TYPE].Value.ul;</span>
<a href="#l20.2489"></a><span id="l20.2489"> </span>
<a href="#l20.2490"></a><span id="l20.2490">       if (m_lastCbEid != cbEID) {</span>
<a href="#l20.2491"></a><span id="l20.2491" class="difflineminus">-        if (m_lastLpEid)</span>
<a href="#l20.2492"></a><span id="l20.2492" class="difflineminus">-          delete m_lastLpEid;</span>
<a href="#l20.2493"></a><span id="l20.2493" class="difflineplus">+        if (m_lastLpEid) delete m_lastLpEid;</span>
<a href="#l20.2494"></a><span id="l20.2494">         m_lastLpEid = new BYTE[cbEID];</span>
<a href="#l20.2495"></a><span id="l20.2495">         m_lastCbEid = cbEID;</span>
<a href="#l20.2496"></a><span id="l20.2496">       }</span>
<a href="#l20.2497"></a><span id="l20.2497">       memcpy(m_lastLpEid, lpEID, cbEID);</span>
<a href="#l20.2498"></a><span id="l20.2498"> </span>
<a href="#l20.2499"></a><span id="l20.2499" class="difflineminus">-      *ppEid = (LPENTRYID) m_lastLpEid;</span>
<a href="#l20.2500"></a><span id="l20.2500" class="difflineplus">+      *ppEid = (LPENTRYID)m_lastLpEid;</span>
<a href="#l20.2501"></a><span id="l20.2501">       *pcbEid = cbEID;</span>
<a href="#l20.2502"></a><span id="l20.2502">       *poType = oType;</span>
<a href="#l20.2503"></a><span id="l20.2503" class="difflineminus">-    }</span>
<a href="#l20.2504"></a><span id="l20.2504" class="difflineminus">-    else</span>
<a href="#l20.2505"></a><span id="l20.2505" class="difflineplus">+    } else</span>
<a href="#l20.2506"></a><span id="l20.2506">       *pDone = TRUE;</span>
<a href="#l20.2507"></a><span id="l20.2507">     CMapiApi::FreeProws(lpRow);</span>
<a href="#l20.2508"></a><span id="l20.2508" class="difflineminus">-    }</span>
<a href="#l20.2509"></a><span id="l20.2509" class="difflineminus">-  else</span>
<a href="#l20.2510"></a><span id="l20.2510" class="difflineplus">+  } else</span>
<a href="#l20.2511"></a><span id="l20.2511">     *pDone = TRUE;</span>
<a href="#l20.2512"></a><span id="l20.2512"> </span>
<a href="#l20.2513"></a><span id="l20.2513">   return TRUE;</span>
<a href="#l20.2514"></a><span id="l20.2514"> }</span>
<a href="#l20.2515"></a><span id="l20.2515" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/import/outlook/src/MapiApi.h</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/import/outlook/src/MapiApi.h</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -18,248 +18,267 @@</span>
<a href="#l21.4"></a><span id="l21.4"> #include &lt;mapicode.h&gt;</span>
<a href="#l21.5"></a><span id="l21.5"> #include &lt;mapitags.h&gt;</span>
<a href="#l21.6"></a><span id="l21.6"> #include &lt;mapiutil.h&gt;</span>
<a href="#l21.7"></a><span id="l21.7"> // wabutil.h expects mapiutil to define _MAPIUTIL_H but it actually</span>
<a href="#l21.8"></a><span id="l21.8"> // defines _MAPIUTIL_H_</span>
<a href="#l21.9"></a><span id="l21.9"> #define _MAPIUTIL_H</span>
<a href="#l21.10"></a><span id="l21.10"> </span>
<a href="#l21.11"></a><span id="l21.11"> #ifndef PR_INTERNET_CPID</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-#define PR_INTERNET_CPID (PROP_TAG(PT_LONG,0x3FDE))</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+#  define PR_INTERNET_CPID (PROP_TAG(PT_LONG, 0x3FDE))</span>
<a href="#l21.14"></a><span id="l21.14"> #endif</span>
<a href="#l21.15"></a><span id="l21.15"> #ifndef MAPI_NATIVE_BODY</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineminus">-#define MAPI_NATIVE_BODY (0x00010000)</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineplus">+#  define MAPI_NATIVE_BODY (0x00010000)</span>
<a href="#l21.18"></a><span id="l21.18"> #endif</span>
<a href="#l21.19"></a><span id="l21.19"> #ifndef MAPI_NATIVE_BODY_TYPE_RTF</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineminus">-#define MAPI_NATIVE_BODY_TYPE_RTF (0x00000001)</span>
<a href="#l21.21"></a><span id="l21.21" class="difflineplus">+#  define MAPI_NATIVE_BODY_TYPE_RTF (0x00000001)</span>
<a href="#l21.22"></a><span id="l21.22"> #endif</span>
<a href="#l21.23"></a><span id="l21.23"> #ifndef MAPI_NATIVE_BODY_TYPE_HTML</span>
<a href="#l21.24"></a><span id="l21.24" class="difflineminus">-#define MAPI_NATIVE_BODY_TYPE_HTML (0x00000002)</span>
<a href="#l21.25"></a><span id="l21.25" class="difflineplus">+#  define MAPI_NATIVE_BODY_TYPE_HTML (0x00000002)</span>
<a href="#l21.26"></a><span id="l21.26"> #endif</span>
<a href="#l21.27"></a><span id="l21.27"> #ifndef MAPI_NATIVE_BODY_TYPE_PLAINTEXT</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineminus">-#define MAPI_NATIVE_BODY_TYPE_PLAINTEXT (0x00000004)</span>
<a href="#l21.29"></a><span id="l21.29" class="difflineplus">+#  define MAPI_NATIVE_BODY_TYPE_PLAINTEXT (0x00000004)</span>
<a href="#l21.30"></a><span id="l21.30"> #endif</span>
<a href="#l21.31"></a><span id="l21.31"> #ifndef PR_BODY_HTML_A</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineminus">-#define PR_BODY_HTML_A (PROP_TAG(PT_STRING8,0x1013))</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineplus">+#  define PR_BODY_HTML_A (PROP_TAG(PT_STRING8, 0x1013))</span>
<a href="#l21.34"></a><span id="l21.34"> #endif</span>
<a href="#l21.35"></a><span id="l21.35"> #ifndef PR_BODY_HTML_W</span>
<a href="#l21.36"></a><span id="l21.36" class="difflineminus">-#define PR_BODY_HTML_W (PROP_TAG(PT_UNICODE,0x1013))</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineplus">+#  define PR_BODY_HTML_W (PROP_TAG(PT_UNICODE, 0x1013))</span>
<a href="#l21.38"></a><span id="l21.38"> #endif</span>
<a href="#l21.39"></a><span id="l21.39"> #ifndef PR_BODY_HTML</span>
<a href="#l21.40"></a><span id="l21.40" class="difflineminus">-#define PR_BODY_HTML (PROP_TAG(PT_TSTRING,0x1013))</span>
<a href="#l21.41"></a><span id="l21.41" class="difflineplus">+#  define PR_BODY_HTML (PROP_TAG(PT_TSTRING, 0x1013))</span>
<a href="#l21.42"></a><span id="l21.42"> #endif</span>
<a href="#l21.43"></a><span id="l21.43"> </span>
<a href="#l21.44"></a><span id="l21.44"> class CMapiFolderList;</span>
<a href="#l21.45"></a><span id="l21.45"> class CMsgStore;</span>
<a href="#l21.46"></a><span id="l21.46"> class CMapiFolder;</span>
<a href="#l21.47"></a><span id="l21.47"> </span>
<a href="#l21.48"></a><span id="l21.48"> class CMapiContentIter {</span>
<a href="#l21.49"></a><span id="l21.49" class="difflineminus">-public:</span>
<a href="#l21.50"></a><span id="l21.50" class="difflineplus">+ public:</span>
<a href="#l21.51"></a><span id="l21.51">   virtual BOOL HandleContentItem(ULONG oType, ULONG cb, LPENTRYID pEntry) = 0;</span>
<a href="#l21.52"></a><span id="l21.52"> };</span>
<a href="#l21.53"></a><span id="l21.53"> </span>
<a href="#l21.54"></a><span id="l21.54"> class CMapiHierarchyIter {</span>
<a href="#l21.55"></a><span id="l21.55" class="difflineminus">-public:</span>
<a href="#l21.56"></a><span id="l21.56" class="difflineplus">+ public:</span>
<a href="#l21.57"></a><span id="l21.57">   virtual BOOL HandleHierarchyItem(ULONG oType, ULONG cb, LPENTRYID pEntry) = 0;</span>
<a href="#l21.58"></a><span id="l21.58"> };</span>
<a href="#l21.59"></a><span id="l21.59"> </span>
<a href="#l21.60"></a><span id="l21.60"> class CMapiApi {</span>
<a href="#l21.61"></a><span id="l21.61" class="difflineminus">-public:</span>
<a href="#l21.62"></a><span id="l21.62" class="difflineplus">+ public:</span>
<a href="#l21.63"></a><span id="l21.63">   CMapiApi();</span>
<a href="#l21.64"></a><span id="l21.64">   ~CMapiApi();</span>
<a href="#l21.65"></a><span id="l21.65"> </span>
<a href="#l21.66"></a><span id="l21.66" class="difflineminus">-  static BOOL    LoadMapi(void);</span>
<a href="#l21.67"></a><span id="l21.67" class="difflineminus">-  static BOOL    LoadMapiEntryPoints(void);</span>
<a href="#l21.68"></a><span id="l21.68" class="difflineminus">-  static void    UnloadMapi(void);</span>
<a href="#l21.69"></a><span id="l21.69" class="difflineplus">+  static BOOL LoadMapi(void);</span>
<a href="#l21.70"></a><span id="l21.70" class="difflineplus">+  static BOOL LoadMapiEntryPoints(void);</span>
<a href="#l21.71"></a><span id="l21.71" class="difflineplus">+  static void UnloadMapi(void);</span>
<a href="#l21.72"></a><span id="l21.72"> </span>
<a href="#l21.73"></a><span id="l21.73" class="difflineminus">-  static HINSTANCE  m_hMapi32;</span>
<a href="#l21.74"></a><span id="l21.74" class="difflineplus">+  static HINSTANCE m_hMapi32;</span>
<a href="#l21.75"></a><span id="l21.75"> </span>
<a href="#l21.76"></a><span id="l21.76" class="difflineminus">-  static void    MAPIUninitialize(void);</span>
<a href="#l21.77"></a><span id="l21.77" class="difflineminus">-  static HRESULT  MAPIInitialize(LPVOID lpInit);</span>
<a href="#l21.78"></a><span id="l21.78" class="difflineminus">-  static SCODE  MAPIAllocateBuffer(ULONG cbSize, LPVOID FAR * lppBuffer);</span>
<a href="#l21.79"></a><span id="l21.79" class="difflineminus">-  static ULONG  MAPIFreeBuffer(LPVOID lpBuff);</span>
<a href="#l21.80"></a><span id="l21.80" class="difflineminus">-  static HRESULT  MAPILogonEx(ULONG ulUIParam, LPTSTR lpszProfileName, LPTSTR lpszPassword, FLAGS flFlags, LPMAPISESSION FAR * lppSession);</span>
<a href="#l21.81"></a><span id="l21.81" class="difflineminus">-  static HRESULT  OpenStreamOnFile(LPALLOCATEBUFFER lpAllocateBuffer, LPFREEBUFFER lpFreeBuffer, ULONG ulFlags, LPCTSTR lpszFileName, LPTSTR lpszPrefix, LPSTREAM FAR * lppStream);</span>
<a href="#l21.82"></a><span id="l21.82" class="difflineminus">-  static void    FreeProws(LPSRowSet prows);</span>
<a href="#l21.83"></a><span id="l21.83" class="difflineplus">+  static void MAPIUninitialize(void);</span>
<a href="#l21.84"></a><span id="l21.84" class="difflineplus">+  static HRESULT MAPIInitialize(LPVOID lpInit);</span>
<a href="#l21.85"></a><span id="l21.85" class="difflineplus">+  static SCODE MAPIAllocateBuffer(ULONG cbSize, LPVOID FAR *lppBuffer);</span>
<a href="#l21.86"></a><span id="l21.86" class="difflineplus">+  static ULONG MAPIFreeBuffer(LPVOID lpBuff);</span>
<a href="#l21.87"></a><span id="l21.87" class="difflineplus">+  static HRESULT MAPILogonEx(ULONG ulUIParam, LPTSTR lpszProfileName,</span>
<a href="#l21.88"></a><span id="l21.88" class="difflineplus">+                             LPTSTR lpszPassword, FLAGS flFlags,</span>
<a href="#l21.89"></a><span id="l21.89" class="difflineplus">+                             LPMAPISESSION FAR *lppSession);</span>
<a href="#l21.90"></a><span id="l21.90" class="difflineplus">+  static HRESULT OpenStreamOnFile(LPALLOCATEBUFFER lpAllocateBuffer,</span>
<a href="#l21.91"></a><span id="l21.91" class="difflineplus">+                                  LPFREEBUFFER lpFreeBuffer, ULONG ulFlags,</span>
<a href="#l21.92"></a><span id="l21.92" class="difflineplus">+                                  LPCTSTR lpszFileName, LPTSTR lpszPrefix,</span>
<a href="#l21.93"></a><span id="l21.93" class="difflineplus">+                                  LPSTREAM FAR *lppStream);</span>
<a href="#l21.94"></a><span id="l21.94" class="difflineplus">+  static void FreeProws(LPSRowSet prows);</span>
<a href="#l21.95"></a><span id="l21.95"> </span>
<a href="#l21.96"></a><span id="l21.96" class="difflineplus">+  BOOL Initialize(void);</span>
<a href="#l21.97"></a><span id="l21.97" class="difflineplus">+  BOOL LogOn(void);</span>
<a href="#l21.98"></a><span id="l21.98"> </span>
<a href="#l21.99"></a><span id="l21.99" class="difflineminus">-  BOOL  Initialize(void);</span>
<a href="#l21.100"></a><span id="l21.100" class="difflineminus">-  BOOL  LogOn(void);</span>
<a href="#l21.101"></a><span id="l21.101" class="difflineminus">-</span>
<a href="#l21.102"></a><span id="l21.102" class="difflineminus">-  void  AddMessageStore(CMsgStore *pStore);</span>
<a href="#l21.103"></a><span id="l21.103" class="difflineminus">-  void  SetCurrentMsgStore(LPMDB lpMdb) { m_lpMdb = lpMdb;}</span>
<a href="#l21.104"></a><span id="l21.104" class="difflineplus">+  void AddMessageStore(CMsgStore *pStore);</span>
<a href="#l21.105"></a><span id="l21.105" class="difflineplus">+  void SetCurrentMsgStore(LPMDB lpMdb) { m_lpMdb = lpMdb; }</span>
<a href="#l21.106"></a><span id="l21.106"> </span>
<a href="#l21.107"></a><span id="l21.107">   // Open any given entry from the current Message Store</span>
<a href="#l21.108"></a><span id="l21.108" class="difflineminus">-  BOOL  OpenEntry(ULONG cbEntry, LPENTRYID pEntryId, LPUNKNOWN *ppOpen);</span>
<a href="#l21.109"></a><span id="l21.109" class="difflineminus">-  static BOOL OpenMdbEntry(LPMDB lpMdb, ULONG cbEntry, LPENTRYID pEntryId, LPUNKNOWN *ppOpen);</span>
<a href="#l21.110"></a><span id="l21.110" class="difflineplus">+  BOOL OpenEntry(ULONG cbEntry, LPENTRYID pEntryId, LPUNKNOWN *ppOpen);</span>
<a href="#l21.111"></a><span id="l21.111" class="difflineplus">+  static BOOL OpenMdbEntry(LPMDB lpMdb, ULONG cbEntry, LPENTRYID pEntryId,</span>
<a href="#l21.112"></a><span id="l21.112" class="difflineplus">+                           LPUNKNOWN *ppOpen);</span>
<a href="#l21.113"></a><span id="l21.113"> </span>
<a href="#l21.114"></a><span id="l21.114">   // Fill in the folders list with the hierarchy from the given</span>
<a href="#l21.115"></a><span id="l21.115">   // message store.</span>
<a href="#l21.116"></a><span id="l21.116" class="difflineminus">-  BOOL  GetStoreFolders(ULONG cbEid, LPENTRYID lpEid, CMapiFolderList&amp; folders, int startDepth);</span>
<a href="#l21.117"></a><span id="l21.117" class="difflineminus">-  BOOL  GetStoreAddressFolders(ULONG cbEid, LPENTRYID lpEid, CMapiFolderList&amp; folders);</span>
<a href="#l21.118"></a><span id="l21.118" class="difflineminus">-  BOOL  OpenStore(ULONG cbEid, LPENTRYID lpEid, LPMDB *ppMdb);</span>
<a href="#l21.119"></a><span id="l21.119" class="difflineplus">+  BOOL GetStoreFolders(ULONG cbEid, LPENTRYID lpEid, CMapiFolderList &amp;folders,</span>
<a href="#l21.120"></a><span id="l21.120" class="difflineplus">+                       int startDepth);</span>
<a href="#l21.121"></a><span id="l21.121" class="difflineplus">+  BOOL GetStoreAddressFolders(ULONG cbEid, LPENTRYID lpEid,</span>
<a href="#l21.122"></a><span id="l21.122" class="difflineplus">+                              CMapiFolderList &amp;folders);</span>
<a href="#l21.123"></a><span id="l21.123" class="difflineplus">+  BOOL OpenStore(ULONG cbEid, LPENTRYID lpEid, LPMDB *ppMdb);</span>
<a href="#l21.124"></a><span id="l21.124"> </span>
<a href="#l21.125"></a><span id="l21.125">   // Iteration</span>
<a href="#l21.126"></a><span id="l21.126" class="difflineminus">-  BOOL  IterateStores(CMapiFolderList&amp; list);</span>
<a href="#l21.127"></a><span id="l21.127" class="difflineminus">-  BOOL  IterateContents(CMapiContentIter *pIter, LPMAPIFOLDER pFolder, ULONG flags = 0);</span>
<a href="#l21.128"></a><span id="l21.128" class="difflineminus">-  BOOL  IterateHierarchy(CMapiHierarchyIter *pIter, LPMAPIFOLDER pFolder, ULONG flags = 0);</span>
<a href="#l21.129"></a><span id="l21.129" class="difflineplus">+  BOOL IterateStores(CMapiFolderList &amp;list);</span>
<a href="#l21.130"></a><span id="l21.130" class="difflineplus">+  BOOL IterateContents(CMapiContentIter *pIter, LPMAPIFOLDER pFolder,</span>
<a href="#l21.131"></a><span id="l21.131" class="difflineplus">+                       ULONG flags = 0);</span>
<a href="#l21.132"></a><span id="l21.132" class="difflineplus">+  BOOL IterateHierarchy(CMapiHierarchyIter *pIter, LPMAPIFOLDER pFolder,</span>
<a href="#l21.133"></a><span id="l21.133" class="difflineplus">+                        ULONG flags = 0);</span>
<a href="#l21.134"></a><span id="l21.134"> </span>
<a href="#l21.135"></a><span id="l21.135">   // Properties</span>
<a href="#l21.136"></a><span id="l21.136" class="difflineminus">-  static LPSPropValue  GetMapiProperty(LPMAPIPROP pProp, ULONG tag);</span>
<a href="#l21.137"></a><span id="l21.137" class="difflineplus">+  static LPSPropValue GetMapiProperty(LPMAPIPROP pProp, ULONG tag);</span>
<a href="#l21.138"></a><span id="l21.138">   // If delVal is true, functions will call CMapiApi::MAPIFreeBuffer on pVal.</span>
<a href="#l21.139"></a><span id="l21.139" class="difflineminus">-  static BOOL      GetEntryIdFromProp(LPSPropValue pVal, ULONG&amp; cbEntryId,</span>
<a href="#l21.140"></a><span id="l21.140" class="difflineminus">-                                      LPENTRYID&amp; lpEntryId, BOOL delVal = TRUE);</span>
<a href="#l21.141"></a><span id="l21.141" class="difflineminus">-  static BOOL      GetStringFromProp(LPSPropValue pVal, nsCString&amp; val, BOOL delVal = TRUE);</span>
<a href="#l21.142"></a><span id="l21.142" class="difflineminus">-  static BOOL      GetStringFromProp(LPSPropValue pVal, nsString&amp; val, BOOL delVal = TRUE);</span>
<a href="#l21.143"></a><span id="l21.143" class="difflineminus">-  static LONG      GetLongFromProp(LPSPropValue pVal, BOOL delVal = TRUE);</span>
<a href="#l21.144"></a><span id="l21.144" class="difflineminus">-  static BOOL      GetLargeStringProperty(LPMAPIPROP pProp, ULONG tag, nsCString&amp; val);</span>
<a href="#l21.145"></a><span id="l21.145" class="difflineminus">-  static BOOL      GetLargeStringProperty(LPMAPIPROP pProp, ULONG tag, nsString&amp; val);</span>
<a href="#l21.146"></a><span id="l21.146" class="difflineminus">-  static BOOL      IsLargeProperty(LPSPropValue pVal);</span>
<a href="#l21.147"></a><span id="l21.147" class="difflineminus">-  static ULONG    GetEmailPropertyTag(LPMAPIPROP lpProp, LONG nameID);</span>
<a href="#l21.148"></a><span id="l21.148" class="difflineplus">+  static BOOL GetEntryIdFromProp(LPSPropValue pVal, ULONG &amp;cbEntryId,</span>
<a href="#l21.149"></a><span id="l21.149" class="difflineplus">+                                 LPENTRYID &amp;lpEntryId, BOOL delVal = TRUE);</span>
<a href="#l21.150"></a><span id="l21.150" class="difflineplus">+  static BOOL GetStringFromProp(LPSPropValue pVal, nsCString &amp;val,</span>
<a href="#l21.151"></a><span id="l21.151" class="difflineplus">+                                BOOL delVal = TRUE);</span>
<a href="#l21.152"></a><span id="l21.152" class="difflineplus">+  static BOOL GetStringFromProp(LPSPropValue pVal, nsString &amp;val,</span>
<a href="#l21.153"></a><span id="l21.153" class="difflineplus">+                                BOOL delVal = TRUE);</span>
<a href="#l21.154"></a><span id="l21.154" class="difflineplus">+  static LONG GetLongFromProp(LPSPropValue pVal, BOOL delVal = TRUE);</span>
<a href="#l21.155"></a><span id="l21.155" class="difflineplus">+  static BOOL GetLargeStringProperty(LPMAPIPROP pProp, ULONG tag,</span>
<a href="#l21.156"></a><span id="l21.156" class="difflineplus">+                                     nsCString &amp;val);</span>
<a href="#l21.157"></a><span id="l21.157" class="difflineplus">+  static BOOL GetLargeStringProperty(LPMAPIPROP pProp, ULONG tag,</span>
<a href="#l21.158"></a><span id="l21.158" class="difflineplus">+                                     nsString &amp;val);</span>
<a href="#l21.159"></a><span id="l21.159" class="difflineplus">+  static BOOL IsLargeProperty(LPSPropValue pVal);</span>
<a href="#l21.160"></a><span id="l21.160" class="difflineplus">+  static ULONG GetEmailPropertyTag(LPMAPIPROP lpProp, LONG nameID);</span>
<a href="#l21.161"></a><span id="l21.161"> </span>
<a href="#l21.162"></a><span id="l21.162" class="difflineminus">-  static BOOL GetRTFPropertyDecodedAsUTF16(LPMAPIPROP pProp, nsString&amp; val,</span>
<a href="#l21.163"></a><span id="l21.163" class="difflineminus">-                                           unsigned long&amp; nativeBodyType,</span>
<a href="#l21.164"></a><span id="l21.164" class="difflineplus">+  static BOOL GetRTFPropertyDecodedAsUTF16(LPMAPIPROP pProp, nsString &amp;val,</span>
<a href="#l21.165"></a><span id="l21.165" class="difflineplus">+                                           unsigned long &amp;nativeBodyType,</span>
<a href="#l21.166"></a><span id="l21.166">                                            unsigned long codepage = 0);</span>
<a href="#l21.167"></a><span id="l21.167"> </span>
<a href="#l21.168"></a><span id="l21.168">   // Debugging &amp; reporting stuff</span>
<a href="#l21.169"></a><span id="l21.169" class="difflineminus">-  static void      ListProperties(LPMAPIPROP lpProp, BOOL getValues = TRUE);</span>
<a href="#l21.170"></a><span id="l21.170" class="difflineminus">-  static void      ListPropertyValue(LPSPropValue pVal, nsCString&amp; s);</span>
<a href="#l21.171"></a><span id="l21.171" class="difflineplus">+  static void ListProperties(LPMAPIPROP lpProp, BOOL getValues = TRUE);</span>
<a href="#l21.172"></a><span id="l21.172" class="difflineplus">+  static void ListPropertyValue(LPSPropValue pVal, nsCString &amp;s);</span>
<a href="#l21.173"></a><span id="l21.173"> </span>
<a href="#l21.174"></a><span id="l21.174" class="difflineminus">-protected:</span>
<a href="#l21.175"></a><span id="l21.175" class="difflineminus">-  BOOL      HandleHierarchyItem(ULONG oType, ULONG cb, LPENTRYID pEntry);</span>
<a href="#l21.176"></a><span id="l21.176" class="difflineminus">-  BOOL      HandleContentsItem(ULONG oType, ULONG cb, LPENTRYID pEntry);</span>
<a href="#l21.177"></a><span id="l21.177" class="difflineminus">-  void      GetStoreInfo(CMapiFolder *pFolder, long *pSzContents);</span>
<a href="#l21.178"></a><span id="l21.178" class="difflineplus">+ protected:</span>
<a href="#l21.179"></a><span id="l21.179" class="difflineplus">+  BOOL HandleHierarchyItem(ULONG oType, ULONG cb, LPENTRYID pEntry);</span>
<a href="#l21.180"></a><span id="l21.180" class="difflineplus">+  BOOL HandleContentsItem(ULONG oType, ULONG cb, LPENTRYID pEntry);</span>
<a href="#l21.181"></a><span id="l21.181" class="difflineplus">+  void GetStoreInfo(CMapiFolder *pFolder, long *pSzContents);</span>
<a href="#l21.182"></a><span id="l21.182"> </span>
<a href="#l21.183"></a><span id="l21.183">   // array of available message stores, cached so that</span>
<a href="#l21.184"></a><span id="l21.184">   // message stores are only opened once, preventing multiple</span>
<a href="#l21.185"></a><span id="l21.185">   // logon's by the user if the store requires a logon.</span>
<a href="#l21.186"></a><span id="l21.186" class="difflineminus">-  CMsgStore *    FindMessageStore(ULONG cbEid, LPENTRYID lpEid);</span>
<a href="#l21.187"></a><span id="l21.187" class="difflineminus">-  void      ClearMessageStores(void);</span>
<a href="#l21.188"></a><span id="l21.188" class="difflineplus">+  CMsgStore *FindMessageStore(ULONG cbEid, LPENTRYID lpEid);</span>
<a href="#l21.189"></a><span id="l21.189" class="difflineplus">+  void ClearMessageStores(void);</span>
<a href="#l21.190"></a><span id="l21.190"> </span>
<a href="#l21.191"></a><span id="l21.191" class="difflineminus">-  static void      CStrToUnicode(const char *pStr, nsString&amp; result);</span>
<a href="#l21.192"></a><span id="l21.192" class="difflineplus">+  static void CStrToUnicode(const char *pStr, nsString &amp;result);</span>
<a href="#l21.193"></a><span id="l21.193"> </span>
<a href="#l21.194"></a><span id="l21.194">   // Debugging &amp; reporting stuff</span>
<a href="#l21.195"></a><span id="l21.195" class="difflineminus">-  static void      GetPropTagName(ULONG tag, nsCString&amp; s);</span>
<a href="#l21.196"></a><span id="l21.196" class="difflineminus">-  static void      ReportStringProp(const char *pTag, LPSPropValue pVal);</span>
<a href="#l21.197"></a><span id="l21.197" class="difflineminus">-  static void      ReportUIDProp(const char *pTag, LPSPropValue pVal);</span>
<a href="#l21.198"></a><span id="l21.198" class="difflineminus">-  static void      ReportLongProp(const char *pTag, LPSPropValue pVal);</span>
<a href="#l21.199"></a><span id="l21.199" class="difflineminus">-</span>
<a href="#l21.200"></a><span id="l21.200" class="difflineplus">+  static void GetPropTagName(ULONG tag, nsCString &amp;s);</span>
<a href="#l21.201"></a><span id="l21.201" class="difflineplus">+  static void ReportStringProp(const char *pTag, LPSPropValue pVal);</span>
<a href="#l21.202"></a><span id="l21.202" class="difflineplus">+  static void ReportUIDProp(const char *pTag, LPSPropValue pVal);</span>
<a href="#l21.203"></a><span id="l21.203" class="difflineplus">+  static void ReportLongProp(const char *pTag, LPSPropValue pVal);</span>
<a href="#l21.204"></a><span id="l21.204"> </span>
<a href="#l21.205"></a><span id="l21.205" class="difflineminus">-private:</span>
<a href="#l21.206"></a><span id="l21.206" class="difflineminus">-  static int        m_clients;</span>
<a href="#l21.207"></a><span id="l21.207" class="difflineminus">-  static BOOL        m_initialized;</span>
<a href="#l21.208"></a><span id="l21.208" class="difflineminus">-  static nsTArray&lt;CMsgStore*&gt; *  m_pStores;</span>
<a href="#l21.209"></a><span id="l21.209" class="difflineminus">-  static LPMAPISESSION  m_lpSession;</span>
<a href="#l21.210"></a><span id="l21.210" class="difflineminus">-  static LPMDB      m_lpMdb;</span>
<a href="#l21.211"></a><span id="l21.211" class="difflineminus">-  static HRESULT      m_lastError;</span>
<a href="#l21.212"></a><span id="l21.212" class="difflineminus">-  static char16_t *    m_pUniBuff;</span>
<a href="#l21.213"></a><span id="l21.213" class="difflineminus">-  static int        m_uniBuffLen;</span>
<a href="#l21.214"></a><span id="l21.214" class="difflineplus">+ private:</span>
<a href="#l21.215"></a><span id="l21.215" class="difflineplus">+  static int m_clients;</span>
<a href="#l21.216"></a><span id="l21.216" class="difflineplus">+  static BOOL m_initialized;</span>
<a href="#l21.217"></a><span id="l21.217" class="difflineplus">+  static nsTArray&lt;CMsgStore *&gt; *m_pStores;</span>
<a href="#l21.218"></a><span id="l21.218" class="difflineplus">+  static LPMAPISESSION m_lpSession;</span>
<a href="#l21.219"></a><span id="l21.219" class="difflineplus">+  static LPMDB m_lpMdb;</span>
<a href="#l21.220"></a><span id="l21.220" class="difflineplus">+  static HRESULT m_lastError;</span>
<a href="#l21.221"></a><span id="l21.221" class="difflineplus">+  static char16_t *m_pUniBuff;</span>
<a href="#l21.222"></a><span id="l21.222" class="difflineplus">+  static int m_uniBuffLen;</span>
<a href="#l21.223"></a><span id="l21.223"> </span>
<a href="#l21.224"></a><span id="l21.224" class="difflineminus">-  static BOOL      GetLargeProperty(LPMAPIPROP pProp, ULONG tag, void** result);</span>
<a href="#l21.225"></a><span id="l21.225" class="difflineplus">+  static BOOL GetLargeProperty(LPMAPIPROP pProp, ULONG tag, void **result);</span>
<a href="#l21.226"></a><span id="l21.226"> };</span>
<a href="#l21.227"></a><span id="l21.227"> </span>
<a href="#l21.228"></a><span id="l21.228"> class CMapiFolder {</span>
<a href="#l21.229"></a><span id="l21.229" class="difflineminus">-public:</span>
<a href="#l21.230"></a><span id="l21.230" class="difflineplus">+ public:</span>
<a href="#l21.231"></a><span id="l21.231">   CMapiFolder();</span>
<a href="#l21.232"></a><span id="l21.232">   explicit CMapiFolder(const CMapiFolder *pCopyFrom);</span>
<a href="#l21.233"></a><span id="l21.233" class="difflineminus">-  CMapiFolder(const char16_t *pDisplayName, ULONG cbEid, LPENTRYID lpEid, int depth, LONG oType = MAPI_FOLDER);</span>
<a href="#l21.234"></a><span id="l21.234" class="difflineplus">+  CMapiFolder(const char16_t *pDisplayName, ULONG cbEid, LPENTRYID lpEid,</span>
<a href="#l21.235"></a><span id="l21.235" class="difflineplus">+              int depth, LONG oType = MAPI_FOLDER);</span>
<a href="#l21.236"></a><span id="l21.236">   ~CMapiFolder();</span>
<a href="#l21.237"></a><span id="l21.237"> </span>
<a href="#l21.238"></a><span id="l21.238" class="difflineminus">-  void  SetDoImport(BOOL doIt) { m_doImport = doIt;}</span>
<a href="#l21.239"></a><span id="l21.239" class="difflineminus">-  void  SetObjectType(long oType) { m_objectType = oType;}</span>
<a href="#l21.240"></a><span id="l21.240" class="difflineminus">-  void  SetDisplayName(const char16_t *pDisplayName) { m_displayName = pDisplayName;}</span>
<a href="#l21.241"></a><span id="l21.241" class="difflineminus">-  void  SetEntryID(ULONG cbEid, LPENTRYID lpEid);</span>
<a href="#l21.242"></a><span id="l21.242" class="difflineminus">-  void  SetDepth(int depth) { m_depth = depth;}</span>
<a href="#l21.243"></a><span id="l21.243" class="difflineminus">-  void  SetFilePath(const char16_t *pFilePath) { m_mailFilePath = pFilePath;}</span>
<a href="#l21.244"></a><span id="l21.244" class="difflineplus">+  void SetDoImport(BOOL doIt) { m_doImport = doIt; }</span>
<a href="#l21.245"></a><span id="l21.245" class="difflineplus">+  void SetObjectType(long oType) { m_objectType = oType; }</span>
<a href="#l21.246"></a><span id="l21.246" class="difflineplus">+  void SetDisplayName(const char16_t *pDisplayName) {</span>
<a href="#l21.247"></a><span id="l21.247" class="difflineplus">+    m_displayName = pDisplayName;</span>
<a href="#l21.248"></a><span id="l21.248" class="difflineplus">+  }</span>
<a href="#l21.249"></a><span id="l21.249" class="difflineplus">+  void SetEntryID(ULONG cbEid, LPENTRYID lpEid);</span>
<a href="#l21.250"></a><span id="l21.250" class="difflineplus">+  void SetDepth(int depth) { m_depth = depth; }</span>
<a href="#l21.251"></a><span id="l21.251" class="difflineplus">+  void SetFilePath(const char16_t *pFilePath) { m_mailFilePath = pFilePath; }</span>
<a href="#l21.252"></a><span id="l21.252"> </span>
<a href="#l21.253"></a><span id="l21.253" class="difflineminus">-  BOOL  GetDoImport(void) const { return m_doImport;}</span>
<a href="#l21.254"></a><span id="l21.254" class="difflineminus">-  LONG  GetObjectType(void) const { return m_objectType;}</span>
<a href="#l21.255"></a><span id="l21.255" class="difflineminus">-  void  GetDisplayName(nsString&amp; name) const { name = m_displayName;}</span>
<a href="#l21.256"></a><span id="l21.256" class="difflineminus">-  void  GetFilePath(nsString&amp; path) const { path = m_mailFilePath;}</span>
<a href="#l21.257"></a><span id="l21.257" class="difflineminus">-  BOOL  IsStore(void) const { return m_objectType == MAPI_STORE;}</span>
<a href="#l21.258"></a><span id="l21.258" class="difflineminus">-  BOOL  IsFolder(void) const { return m_objectType == MAPI_FOLDER;}</span>
<a href="#l21.259"></a><span id="l21.259" class="difflineminus">-  int    GetDepth(void) const { return m_depth;}</span>
<a href="#l21.260"></a><span id="l21.260" class="difflineplus">+  BOOL GetDoImport(void) const { return m_doImport; }</span>
<a href="#l21.261"></a><span id="l21.261" class="difflineplus">+  LONG GetObjectType(void) const { return m_objectType; }</span>
<a href="#l21.262"></a><span id="l21.262" class="difflineplus">+  void GetDisplayName(nsString &amp;name) const { name = m_displayName; }</span>
<a href="#l21.263"></a><span id="l21.263" class="difflineplus">+  void GetFilePath(nsString &amp;path) const { path = m_mailFilePath; }</span>
<a href="#l21.264"></a><span id="l21.264" class="difflineplus">+  BOOL IsStore(void) const { return m_objectType == MAPI_STORE; }</span>
<a href="#l21.265"></a><span id="l21.265" class="difflineplus">+  BOOL IsFolder(void) const { return m_objectType == MAPI_FOLDER; }</span>
<a href="#l21.266"></a><span id="l21.266" class="difflineplus">+  int GetDepth(void) const { return m_depth; }</span>
<a href="#l21.267"></a><span id="l21.267"> </span>
<a href="#l21.268"></a><span id="l21.268" class="difflineminus">-  LPENTRYID  GetEntryID(ULONG *pCb = NULL) const { if (pCb) *pCb = m_cbEid; return (LPENTRYID) m_lpEid;}</span>
<a href="#l21.269"></a><span id="l21.269" class="difflineminus">-  ULONG    GetCBEntryID(void) const { return m_cbEid;}</span>
<a href="#l21.270"></a><span id="l21.270" class="difflineplus">+  LPENTRYID GetEntryID(ULONG *pCb = NULL) const {</span>
<a href="#l21.271"></a><span id="l21.271" class="difflineplus">+    if (pCb) *pCb = m_cbEid;</span>
<a href="#l21.272"></a><span id="l21.272" class="difflineplus">+    return (LPENTRYID)m_lpEid;</span>
<a href="#l21.273"></a><span id="l21.273" class="difflineplus">+  }</span>
<a href="#l21.274"></a><span id="l21.274" class="difflineplus">+  ULONG GetCBEntryID(void) const { return m_cbEid; }</span>
<a href="#l21.275"></a><span id="l21.275"> </span>
<a href="#l21.276"></a><span id="l21.276" class="difflineminus">-private:</span>
<a href="#l21.277"></a><span id="l21.277" class="difflineminus">-  LONG    m_objectType;</span>
<a href="#l21.278"></a><span id="l21.278" class="difflineminus">-  ULONG    m_cbEid;</span>
<a href="#l21.279"></a><span id="l21.279" class="difflineminus">-  BYTE *    m_lpEid;</span>
<a href="#l21.280"></a><span id="l21.280" class="difflineminus">-  nsString  m_displayName;</span>
<a href="#l21.281"></a><span id="l21.281" class="difflineminus">-  int      m_depth;</span>
<a href="#l21.282"></a><span id="l21.282" class="difflineminus">-  nsString  m_mailFilePath;</span>
<a href="#l21.283"></a><span id="l21.283" class="difflineminus">-  BOOL    m_doImport;</span>
<a href="#l21.284"></a><span id="l21.284" class="difflineminus">-</span>
<a href="#l21.285"></a><span id="l21.285" class="difflineplus">+ private:</span>
<a href="#l21.286"></a><span id="l21.286" class="difflineplus">+  LONG m_objectType;</span>
<a href="#l21.287"></a><span id="l21.287" class="difflineplus">+  ULONG m_cbEid;</span>
<a href="#l21.288"></a><span id="l21.288" class="difflineplus">+  BYTE *m_lpEid;</span>
<a href="#l21.289"></a><span id="l21.289" class="difflineplus">+  nsString m_displayName;</span>
<a href="#l21.290"></a><span id="l21.290" class="difflineplus">+  int m_depth;</span>
<a href="#l21.291"></a><span id="l21.291" class="difflineplus">+  nsString m_mailFilePath;</span>
<a href="#l21.292"></a><span id="l21.292" class="difflineplus">+  BOOL m_doImport;</span>
<a href="#l21.293"></a><span id="l21.293"> };</span>
<a href="#l21.294"></a><span id="l21.294"> </span>
<a href="#l21.295"></a><span id="l21.295"> class CMapiFolderList {</span>
<a href="#l21.296"></a><span id="l21.296" class="difflineminus">-public:</span>
<a href="#l21.297"></a><span id="l21.297" class="difflineplus">+ public:</span>
<a href="#l21.298"></a><span id="l21.298">   CMapiFolderList();</span>
<a href="#l21.299"></a><span id="l21.299">   ~CMapiFolderList();</span>
<a href="#l21.300"></a><span id="l21.300"> </span>
<a href="#l21.301"></a><span id="l21.301" class="difflineminus">-  void      AddItem(CMapiFolder *pFolder);</span>
<a href="#l21.302"></a><span id="l21.302" class="difflineminus">-  CMapiFolder *  GetItem(int index) { if ((index &gt;= 0) &amp;&amp; (index &lt; (int)m_array.Length())) return GetAt(index); else return NULL;}</span>
<a href="#l21.303"></a><span id="l21.303" class="difflineminus">-  void      ClearAll(void);</span>
<a href="#l21.304"></a><span id="l21.304" class="difflineplus">+  void AddItem(CMapiFolder *pFolder);</span>
<a href="#l21.305"></a><span id="l21.305" class="difflineplus">+  CMapiFolder *GetItem(int index) {</span>
<a href="#l21.306"></a><span id="l21.306" class="difflineplus">+    if ((index &gt;= 0) &amp;&amp; (index &lt; (int)m_array.Length()))</span>
<a href="#l21.307"></a><span id="l21.307" class="difflineplus">+      return GetAt(index);</span>
<a href="#l21.308"></a><span id="l21.308" class="difflineplus">+    else</span>
<a href="#l21.309"></a><span id="l21.309" class="difflineplus">+      return NULL;</span>
<a href="#l21.310"></a><span id="l21.310" class="difflineplus">+  }</span>
<a href="#l21.311"></a><span id="l21.311" class="difflineplus">+  void ClearAll(void);</span>
<a href="#l21.312"></a><span id="l21.312"> </span>
<a href="#l21.313"></a><span id="l21.313">   // Debugging and reporting</span>
<a href="#l21.314"></a><span id="l21.314" class="difflineminus">-  void      DumpList(void);</span>
<a href="#l21.315"></a><span id="l21.315" class="difflineplus">+  void DumpList(void);</span>
<a href="#l21.316"></a><span id="l21.316"> </span>
<a href="#l21.317"></a><span id="l21.317" class="difflineminus">-  CMapiFolder *  GetAt(int index) { return m_array.ElementAt(index);}</span>
<a href="#l21.318"></a><span id="l21.318" class="difflineminus">-  int        GetSize(void) { return m_array.Length();}</span>
<a href="#l21.319"></a><span id="l21.319" class="difflineplus">+  CMapiFolder *GetAt(int index) { return m_array.ElementAt(index); }</span>
<a href="#l21.320"></a><span id="l21.320" class="difflineplus">+  int GetSize(void) { return m_array.Length(); }</span>
<a href="#l21.321"></a><span id="l21.321"> </span>
<a href="#l21.322"></a><span id="l21.322" class="difflineminus">-protected:</span>
<a href="#l21.323"></a><span id="l21.323" class="difflineminus">-  void  EnsureUniqueName(CMapiFolder *pFolder);</span>
<a href="#l21.324"></a><span id="l21.324" class="difflineminus">-  void  GenerateFilePath(CMapiFolder *pFolder);</span>
<a href="#l21.325"></a><span id="l21.325" class="difflineminus">-  void  ChangeName(nsString&amp; name);</span>
<a href="#l21.326"></a><span id="l21.326" class="difflineplus">+ protected:</span>
<a href="#l21.327"></a><span id="l21.327" class="difflineplus">+  void EnsureUniqueName(CMapiFolder *pFolder);</span>
<a href="#l21.328"></a><span id="l21.328" class="difflineplus">+  void GenerateFilePath(CMapiFolder *pFolder);</span>
<a href="#l21.329"></a><span id="l21.329" class="difflineplus">+  void ChangeName(nsString &amp;name);</span>
<a href="#l21.330"></a><span id="l21.330"> </span>
<a href="#l21.331"></a><span id="l21.331" class="difflineminus">-private:</span>
<a href="#l21.332"></a><span id="l21.332" class="difflineminus">-  nsTArray&lt;CMapiFolder*&gt;    m_array;</span>
<a href="#l21.333"></a><span id="l21.333" class="difflineplus">+ private:</span>
<a href="#l21.334"></a><span id="l21.334" class="difflineplus">+  nsTArray&lt;CMapiFolder *&gt; m_array;</span>
<a href="#l21.335"></a><span id="l21.335"> };</span>
<a href="#l21.336"></a><span id="l21.336"> </span>
<a href="#l21.337"></a><span id="l21.337" class="difflineminus">-</span>
<a href="#l21.338"></a><span id="l21.338"> class CMsgStore {</span>
<a href="#l21.339"></a><span id="l21.339" class="difflineminus">-public:</span>
<a href="#l21.340"></a><span id="l21.340" class="difflineplus">+ public:</span>
<a href="#l21.341"></a><span id="l21.341">   explicit CMsgStore(ULONG cbEid = 0, LPENTRYID lpEid = NULL);</span>
<a href="#l21.342"></a><span id="l21.342">   ~CMsgStore();</span>
<a href="#l21.343"></a><span id="l21.343"> </span>
<a href="#l21.344"></a><span id="l21.344" class="difflineminus">-  void    SetEntryID(ULONG cbEid, LPENTRYID lpEid);</span>
<a href="#l21.345"></a><span id="l21.345" class="difflineminus">-  BOOL    Open(LPMAPISESSION pSession, LPMDB *ppMdb);</span>
<a href="#l21.346"></a><span id="l21.346" class="difflineplus">+  void SetEntryID(ULONG cbEid, LPENTRYID lpEid);</span>
<a href="#l21.347"></a><span id="l21.347" class="difflineplus">+  BOOL Open(LPMAPISESSION pSession, LPMDB *ppMdb);</span>
<a href="#l21.348"></a><span id="l21.348"> </span>
<a href="#l21.349"></a><span id="l21.349" class="difflineminus">-  ULONG    GetCBEntryID(void) { return m_cbEid;}</span>
<a href="#l21.350"></a><span id="l21.350" class="difflineminus">-  LPENTRYID  GetLPEntryID(void) { return (LPENTRYID) m_lpEid;}</span>
<a href="#l21.351"></a><span id="l21.351" class="difflineplus">+  ULONG GetCBEntryID(void) { return m_cbEid; }</span>
<a href="#l21.352"></a><span id="l21.352" class="difflineplus">+  LPENTRYID GetLPEntryID(void) { return (LPENTRYID)m_lpEid; }</span>
<a href="#l21.353"></a><span id="l21.353"> </span>
<a href="#l21.354"></a><span id="l21.354" class="difflineminus">-private:</span>
<a href="#l21.355"></a><span id="l21.355" class="difflineminus">-  ULONG    m_cbEid;</span>
<a href="#l21.356"></a><span id="l21.356" class="difflineminus">-  BYTE *    m_lpEid;</span>
<a href="#l21.357"></a><span id="l21.357" class="difflineminus">-  LPMDB    m_lpMdb;</span>
<a href="#l21.358"></a><span id="l21.358" class="difflineplus">+ private:</span>
<a href="#l21.359"></a><span id="l21.359" class="difflineplus">+  ULONG m_cbEid;</span>
<a href="#l21.360"></a><span id="l21.360" class="difflineplus">+  BYTE *m_lpEid;</span>
<a href="#l21.361"></a><span id="l21.361" class="difflineplus">+  LPMDB m_lpMdb;</span>
<a href="#l21.362"></a><span id="l21.362"> };</span>
<a href="#l21.363"></a><span id="l21.363"> </span>
<a href="#l21.364"></a><span id="l21.364" class="difflineminus">-</span>
<a href="#l21.365"></a><span id="l21.365"> class CMapiFolderContents {</span>
<a href="#l21.366"></a><span id="l21.366" class="difflineminus">-public:</span>
<a href="#l21.367"></a><span id="l21.367" class="difflineplus">+ public:</span>
<a href="#l21.368"></a><span id="l21.368">   CMapiFolderContents(LPMDB lpMdb, ULONG cbEID, LPENTRYID lpEid);</span>
<a href="#l21.369"></a><span id="l21.369">   ~CMapiFolderContents();</span>
<a href="#l21.370"></a><span id="l21.370"> </span>
<a href="#l21.371"></a><span id="l21.371" class="difflineminus">-  BOOL  GetNext(ULONG *pcbEid, LPENTRYID *ppEid, ULONG *poType, BOOL *pDone);</span>
<a href="#l21.372"></a><span id="l21.372" class="difflineplus">+  BOOL GetNext(ULONG *pcbEid, LPENTRYID *ppEid, ULONG *poType, BOOL *pDone);</span>
<a href="#l21.373"></a><span id="l21.373"> </span>
<a href="#l21.374"></a><span id="l21.374" class="difflineminus">-  ULONG  GetCount(void) { return m_count;}</span>
<a href="#l21.375"></a><span id="l21.375" class="difflineplus">+  ULONG GetCount(void) { return m_count; }</span>
<a href="#l21.376"></a><span id="l21.376"> </span>
<a href="#l21.377"></a><span id="l21.377" class="difflineminus">-protected:</span>
<a href="#l21.378"></a><span id="l21.378" class="difflineplus">+ protected:</span>
<a href="#l21.379"></a><span id="l21.379">   BOOL SetUpIter(void);</span>
<a href="#l21.380"></a><span id="l21.380"> </span>
<a href="#l21.381"></a><span id="l21.381" class="difflineminus">-private:</span>
<a href="#l21.382"></a><span id="l21.382" class="difflineminus">-  HRESULT      m_lastError;</span>
<a href="#l21.383"></a><span id="l21.383" class="difflineminus">-  BOOL      m_failure;</span>
<a href="#l21.384"></a><span id="l21.384" class="difflineminus">-  LPMDB      m_lpMdb;</span>
<a href="#l21.385"></a><span id="l21.385" class="difflineminus">-  LPMAPIFOLDER  m_lpFolder;</span>
<a href="#l21.386"></a><span id="l21.386" class="difflineminus">-  LPMAPITABLE    m_lpTable;</span>
<a href="#l21.387"></a><span id="l21.387" class="difflineminus">-  ULONG      m_fCbEid;</span>
<a href="#l21.388"></a><span id="l21.388" class="difflineminus">-  BYTE *      m_fLpEid;</span>
<a href="#l21.389"></a><span id="l21.389" class="difflineminus">-  ULONG      m_count;</span>
<a href="#l21.390"></a><span id="l21.390" class="difflineminus">-  ULONG      m_iterCount;</span>
<a href="#l21.391"></a><span id="l21.391" class="difflineminus">-  BYTE *      m_lastLpEid;</span>
<a href="#l21.392"></a><span id="l21.392" class="difflineminus">-  ULONG      m_lastCbEid;</span>
<a href="#l21.393"></a><span id="l21.393" class="difflineplus">+ private:</span>
<a href="#l21.394"></a><span id="l21.394" class="difflineplus">+  HRESULT m_lastError;</span>
<a href="#l21.395"></a><span id="l21.395" class="difflineplus">+  BOOL m_failure;</span>
<a href="#l21.396"></a><span id="l21.396" class="difflineplus">+  LPMDB m_lpMdb;</span>
<a href="#l21.397"></a><span id="l21.397" class="difflineplus">+  LPMAPIFOLDER m_lpFolder;</span>
<a href="#l21.398"></a><span id="l21.398" class="difflineplus">+  LPMAPITABLE m_lpTable;</span>
<a href="#l21.399"></a><span id="l21.399" class="difflineplus">+  ULONG m_fCbEid;</span>
<a href="#l21.400"></a><span id="l21.400" class="difflineplus">+  BYTE *m_fLpEid;</span>
<a href="#l21.401"></a><span id="l21.401" class="difflineplus">+  ULONG m_count;</span>
<a href="#l21.402"></a><span id="l21.402" class="difflineplus">+  ULONG m_iterCount;</span>
<a href="#l21.403"></a><span id="l21.403" class="difflineplus">+  BYTE *m_lastLpEid;</span>
<a href="#l21.404"></a><span id="l21.404" class="difflineplus">+  ULONG m_lastCbEid;</span>
<a href="#l21.405"></a><span id="l21.405"> };</span>
<a href="#l21.406"></a><span id="l21.406"> </span>
<a href="#l21.407"></a><span id="l21.407" class="difflineminus">-</span>
<a href="#l21.408"></a><span id="l21.408"> #endif /* MapiApi_h__ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/import/outlook/src/MapiDbgLog.h</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/import/outlook/src/MapiDbgLog.h</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -8,33 +8,29 @@</span>
<a href="#l22.4"></a><span id="l22.4"> </span>
<a href="#l22.5"></a><span id="l22.5"> /*</span>
<a href="#l22.6"></a><span id="l22.6"> #ifdef NS_DEBUG</span>
<a href="#l22.7"></a><span id="l22.7"> #define MAPI_DEBUG  1</span>
<a href="#l22.8"></a><span id="l22.8"> #endif</span>
<a href="#l22.9"></a><span id="l22.9"> */</span>
<a href="#l22.10"></a><span id="l22.10"> </span>
<a href="#l22.11"></a><span id="l22.11"> #ifdef MAPI_DEBUG</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-#include &lt;stdio.h&gt;</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+#  include &lt;stdio.h&gt;</span>
<a href="#l22.14"></a><span id="l22.14"> </span>
<a href="#l22.15"></a><span id="l22.15" class="difflineminus">-#define MAPI_DUMP_STRING(x)    printf(&quot;%s&quot;, (const char *)x)</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineminus">-#define MAPI_TRACE0(x)        printf(x)</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineminus">-#define MAPI_TRACE1(x, y)      printf(x, y)</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineminus">-#define MAPI_TRACE2(x, y, z)    printf(x, y, z)</span>
<a href="#l22.19"></a><span id="l22.19" class="difflineminus">-#define MAPI_TRACE3(x, y, z, a)  printf(x, y, z, a)</span>
<a href="#l22.20"></a><span id="l22.20" class="difflineminus">-#define MAPI_TRACE4(x, y, z, a, b) printf(x, y, z, a, b)</span>
<a href="#l22.21"></a><span id="l22.21" class="difflineminus">-</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineplus">+#  define MAPI_DUMP_STRING(x) printf(&quot;%s&quot;, (const char *)x)</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineplus">+#  define MAPI_TRACE0(x) printf(x)</span>
<a href="#l22.24"></a><span id="l22.24" class="difflineplus">+#  define MAPI_TRACE1(x, y) printf(x, y)</span>
<a href="#l22.25"></a><span id="l22.25" class="difflineplus">+#  define MAPI_TRACE2(x, y, z) printf(x, y, z)</span>
<a href="#l22.26"></a><span id="l22.26" class="difflineplus">+#  define MAPI_TRACE3(x, y, z, a) printf(x, y, z, a)</span>
<a href="#l22.27"></a><span id="l22.27" class="difflineplus">+#  define MAPI_TRACE4(x, y, z, a, b) printf(x, y, z, a, b)</span>
<a href="#l22.28"></a><span id="l22.28"> </span>
<a href="#l22.29"></a><span id="l22.29"> #else</span>
<a href="#l22.30"></a><span id="l22.30"> </span>
<a href="#l22.31"></a><span id="l22.31" class="difflineminus">-#define MAPI_DUMP_STRING(x)</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineminus">-#define  MAPI_TRACE0(x)</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineminus">-#define  MAPI_TRACE1(x, y)</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineminus">-#define  MAPI_TRACE2(x, y, z)</span>
<a href="#l22.35"></a><span id="l22.35" class="difflineminus">-#define MAPI_TRACE3(x, y, z, a)</span>
<a href="#l22.36"></a><span id="l22.36" class="difflineminus">-#define MAPI_TRACE4(x, y, z, a, b)</span>
<a href="#l22.37"></a><span id="l22.37" class="difflineplus">+#  define MAPI_DUMP_STRING(x)</span>
<a href="#l22.38"></a><span id="l22.38" class="difflineplus">+#  define MAPI_TRACE0(x)</span>
<a href="#l22.39"></a><span id="l22.39" class="difflineplus">+#  define MAPI_TRACE1(x, y)</span>
<a href="#l22.40"></a><span id="l22.40" class="difflineplus">+#  define MAPI_TRACE2(x, y, z)</span>
<a href="#l22.41"></a><span id="l22.41" class="difflineplus">+#  define MAPI_TRACE3(x, y, z, a)</span>
<a href="#l22.42"></a><span id="l22.42" class="difflineplus">+#  define MAPI_TRACE4(x, y, z, a, b)</span>
<a href="#l22.43"></a><span id="l22.43"> </span>
<a href="#l22.44"></a><span id="l22.44"> #endif</span>
<a href="#l22.45"></a><span id="l22.45"> </span>
<a href="#l22.46"></a><span id="l22.46" class="difflineminus">-</span>
<a href="#l22.47"></a><span id="l22.47" class="difflineminus">-</span>
<a href="#l22.48"></a><span id="l22.48"> #endif /* MapiDbgLog_h___ */</span>
<a href="#l22.49"></a><span id="l22.49" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/import/outlook/src/MapiMessage.cpp</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/import/outlook/src/MapiMessage.cpp</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -1,19 +1,19 @@</span>
<a href="#l23.4"></a><span id="l23.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l23.5"></a><span id="l23.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l23.6"></a><span id="l23.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l23.7"></a><span id="l23.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l23.8"></a><span id="l23.8"> </span>
<a href="#l23.9"></a><span id="l23.9"> #ifndef INITGUID</span>
<a href="#l23.10"></a><span id="l23.10" class="difflineminus">-#define INITGUID</span>
<a href="#l23.11"></a><span id="l23.11" class="difflineplus">+#  define INITGUID</span>
<a href="#l23.12"></a><span id="l23.12"> #endif</span>
<a href="#l23.13"></a><span id="l23.13"> </span>
<a href="#l23.14"></a><span id="l23.14"> #ifndef USES_IID_IMessage</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineminus">-#define USES_IID_IMessage</span>
<a href="#l23.16"></a><span id="l23.16" class="difflineplus">+#  define USES_IID_IMessage</span>
<a href="#l23.17"></a><span id="l23.17"> #endif</span>
<a href="#l23.18"></a><span id="l23.18"> </span>
<a href="#l23.19"></a><span id="l23.19"> #include &quot;nscore.h&quot;</span>
<a href="#l23.20"></a><span id="l23.20"> #include &lt;time.h&gt;</span>
<a href="#l23.21"></a><span id="l23.21"> #include &quot;nsString.h&quot;</span>
<a href="#l23.22"></a><span id="l23.22"> #include &quot;nsDirectoryServiceDefs.h&quot;</span>
<a href="#l23.23"></a><span id="l23.23"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l23.24"></a><span id="l23.24"> #include &quot;nsMimeTypes.h&quot;</span>
<a href="#l23.25"></a><span id="l23.25" class="difflineat">@@ -37,136 +37,120 @@</span>
<a href="#l23.26"></a><span id="l23.26"> #include &quot;mozilla/Encoding.h&quot;</span>
<a href="#l23.27"></a><span id="l23.27"> </span>
<a href="#l23.28"></a><span id="l23.28"> // needed for the call the OpenStreamOnFile</span>
<a href="#l23.29"></a><span id="l23.29"> extern LPMAPIALLOCATEBUFFER gpMapiAllocateBuffer;</span>
<a href="#l23.30"></a><span id="l23.30"> extern LPMAPIFREEBUFFER gpMapiFreeBuffer;</span>
<a href="#l23.31"></a><span id="l23.31"> </span>
<a href="#l23.32"></a><span id="l23.32"> // Sample From line: From - 1 Jan 1965 00:00:00</span>
<a href="#l23.33"></a><span id="l23.33"> </span>
<a href="#l23.34"></a><span id="l23.34" class="difflineminus">-typedef const char * PC_S8;</span>
<a href="#l23.35"></a><span id="l23.35" class="difflineplus">+typedef const char* PC_S8;</span>
<a href="#l23.36"></a><span id="l23.36"> </span>
<a href="#l23.37"></a><span id="l23.37" class="difflineminus">-static const char * kWhitespace = &quot;\b\t\r\n &quot;;</span>
<a href="#l23.38"></a><span id="l23.38" class="difflineminus">-static const char * sFromLine = &quot;From - &quot;;</span>
<a href="#l23.39"></a><span id="l23.39" class="difflineminus">-static const char * sFromDate = &quot;Mon Jan 1 00:00:00 1965&quot;;</span>
<a href="#l23.40"></a><span id="l23.40" class="difflineminus">-static const char * sDaysOfWeek[7] = {</span>
<a href="#l23.41"></a><span id="l23.41" class="difflineminus">-  &quot;Sun&quot;, &quot;Mon&quot;, &quot;Tue&quot;, &quot;Wed&quot;, &quot;Thu&quot;, &quot;Fri&quot;, &quot;Sat&quot;</span>
<a href="#l23.42"></a><span id="l23.42" class="difflineminus">-};</span>
<a href="#l23.43"></a><span id="l23.43" class="difflineplus">+static const char* kWhitespace = &quot;\b\t\r\n &quot;;</span>
<a href="#l23.44"></a><span id="l23.44" class="difflineplus">+static const char* sFromLine = &quot;From - &quot;;</span>
<a href="#l23.45"></a><span id="l23.45" class="difflineplus">+static const char* sFromDate = &quot;Mon Jan 1 00:00:00 1965&quot;;</span>
<a href="#l23.46"></a><span id="l23.46" class="difflineplus">+static const char* sDaysOfWeek[7] = {&quot;Sun&quot;, &quot;Mon&quot;, &quot;Tue&quot;, &quot;Wed&quot;,</span>
<a href="#l23.47"></a><span id="l23.47" class="difflineplus">+                                     &quot;Thu&quot;, &quot;Fri&quot;, &quot;Sat&quot;};</span>
<a href="#l23.48"></a><span id="l23.48"> </span>
<a href="#l23.49"></a><span id="l23.49" class="difflineminus">-static const char *sMonths[12] = {</span>
<a href="#l23.50"></a><span id="l23.50" class="difflineminus">-  &quot;Jan&quot;, &quot;Feb&quot;, &quot;Mar&quot;, &quot;Apr&quot;, &quot;May&quot;, &quot;Jun&quot;, &quot;Jul&quot;, &quot;Aug&quot;, &quot;Sep&quot;, &quot;Oct&quot;, &quot;Nov&quot;, &quot;Dec&quot;</span>
<a href="#l23.51"></a><span id="l23.51" class="difflineminus">-};</span>
<a href="#l23.52"></a><span id="l23.52" class="difflineplus">+static const char* sMonths[12] = {&quot;Jan&quot;, &quot;Feb&quot;, &quot;Mar&quot;, &quot;Apr&quot;, &quot;May&quot;, &quot;Jun&quot;,</span>
<a href="#l23.53"></a><span id="l23.53" class="difflineplus">+                                  &quot;Jul&quot;, &quot;Aug&quot;, &quot;Sep&quot;, &quot;Oct&quot;, &quot;Nov&quot;, &quot;Dec&quot;};</span>
<a href="#l23.54"></a><span id="l23.54"> </span>
<a href="#l23.55"></a><span id="l23.55"> CMapiMessage::CMapiMessage(LPMESSAGE lpMsg)</span>
<a href="#l23.56"></a><span id="l23.56" class="difflineminus">-  : m_lpMsg(lpMsg), m_dldStateHeadersOnly(false), m_msgFlags(0)</span>
<a href="#l23.57"></a><span id="l23.57" class="difflineminus">-{</span>
<a href="#l23.58"></a><span id="l23.58" class="difflineplus">+    : m_lpMsg(lpMsg), m_dldStateHeadersOnly(false), m_msgFlags(0) {</span>
<a href="#l23.59"></a><span id="l23.59">   nsresult rv;</span>
<a href="#l23.60"></a><span id="l23.60">   m_pIOService = do_GetService(NS_IOSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l23.61"></a><span id="l23.61" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l23.62"></a><span id="l23.62" class="difflineminus">-    return;</span>
<a href="#l23.63"></a><span id="l23.63" class="difflineplus">+  if (NS_FAILED(rv)) return;</span>
<a href="#l23.64"></a><span id="l23.64"> </span>
<a href="#l23.65"></a><span id="l23.65">   FetchHeaders();</span>
<a href="#l23.66"></a><span id="l23.66">   if (ValidState()) {</span>
<a href="#l23.67"></a><span id="l23.67">     BuildFromLine();</span>
<a href="#l23.68"></a><span id="l23.68">     FetchFlags();</span>
<a href="#l23.69"></a><span id="l23.69">     GetDownloadState();</span>
<a href="#l23.70"></a><span id="l23.70">     if (FullMessageDownloaded()) {</span>
<a href="#l23.71"></a><span id="l23.71">       FetchBody();</span>
<a href="#l23.72"></a><span id="l23.72">       ProcessAttachments();</span>
<a href="#l23.73"></a><span id="l23.73">     }</span>
<a href="#l23.74"></a><span id="l23.74">   }</span>
<a href="#l23.75"></a><span id="l23.75"> }</span>
<a href="#l23.76"></a><span id="l23.76"> </span>
<a href="#l23.77"></a><span id="l23.77" class="difflineminus">-CMapiMessage::~CMapiMessage()</span>
<a href="#l23.78"></a><span id="l23.78" class="difflineminus">-{</span>
<a href="#l23.79"></a><span id="l23.79" class="difflineplus">+CMapiMessage::~CMapiMessage() {</span>
<a href="#l23.80"></a><span id="l23.80">   ClearAttachments();</span>
<a href="#l23.81"></a><span id="l23.81" class="difflineminus">-  if (m_lpMsg)</span>
<a href="#l23.82"></a><span id="l23.82" class="difflineminus">-    m_lpMsg-&gt;Release();</span>
<a href="#l23.83"></a><span id="l23.83" class="difflineplus">+  if (m_lpMsg) m_lpMsg-&gt;Release();</span>
<a href="#l23.84"></a><span id="l23.84"> }</span>
<a href="#l23.85"></a><span id="l23.85"> </span>
<a href="#l23.86"></a><span id="l23.86" class="difflineminus">-void CMapiMessage::FormatDateTime(SYSTEMTIME&amp; tm, nsCString&amp; s, bool includeTZ)</span>
<a href="#l23.87"></a><span id="l23.87" class="difflineminus">-{</span>
<a href="#l23.88"></a><span id="l23.88" class="difflineplus">+void CMapiMessage::FormatDateTime(SYSTEMTIME&amp; tm, nsCString&amp; s,</span>
<a href="#l23.89"></a><span id="l23.89" class="difflineplus">+                                  bool includeTZ) {</span>
<a href="#l23.90"></a><span id="l23.90">   long offset = _timezone;</span>
<a href="#l23.91"></a><span id="l23.91">   s += sDaysOfWeek[tm.wDayOfWeek];</span>
<a href="#l23.92"></a><span id="l23.92">   s += &quot;, &quot;;</span>
<a href="#l23.93"></a><span id="l23.93" class="difflineminus">-  s.AppendInt((int32_t) tm.wDay);</span>
<a href="#l23.94"></a><span id="l23.94" class="difflineplus">+  s.AppendInt((int32_t)tm.wDay);</span>
<a href="#l23.95"></a><span id="l23.95">   s += &quot; &quot;;</span>
<a href="#l23.96"></a><span id="l23.96">   s += sMonths[tm.wMonth - 1];</span>
<a href="#l23.97"></a><span id="l23.97">   s += &quot; &quot;;</span>
<a href="#l23.98"></a><span id="l23.98" class="difflineminus">-  s.AppendInt((int32_t) tm.wYear);</span>
<a href="#l23.99"></a><span id="l23.99" class="difflineplus">+  s.AppendInt((int32_t)tm.wYear);</span>
<a href="#l23.100"></a><span id="l23.100">   s += &quot; &quot;;</span>
<a href="#l23.101"></a><span id="l23.101">   int val = tm.wHour;</span>
<a href="#l23.102"></a><span id="l23.102" class="difflineminus">-  if (val &lt; 10)</span>
<a href="#l23.103"></a><span id="l23.103" class="difflineminus">-    s += &quot;0&quot;;</span>
<a href="#l23.104"></a><span id="l23.104" class="difflineminus">-  s.AppendInt((int32_t) val);</span>
<a href="#l23.105"></a><span id="l23.105" class="difflineplus">+  if (val &lt; 10) s += &quot;0&quot;;</span>
<a href="#l23.106"></a><span id="l23.106" class="difflineplus">+  s.AppendInt((int32_t)val);</span>
<a href="#l23.107"></a><span id="l23.107">   s += &quot;:&quot;;</span>
<a href="#l23.108"></a><span id="l23.108">   val = tm.wMinute;</span>
<a href="#l23.109"></a><span id="l23.109" class="difflineminus">-  if (val &lt; 10)</span>
<a href="#l23.110"></a><span id="l23.110" class="difflineminus">-    s += &quot;0&quot;;</span>
<a href="#l23.111"></a><span id="l23.111" class="difflineminus">-  s.AppendInt((int32_t) val);</span>
<a href="#l23.112"></a><span id="l23.112" class="difflineplus">+  if (val &lt; 10) s += &quot;0&quot;;</span>
<a href="#l23.113"></a><span id="l23.113" class="difflineplus">+  s.AppendInt((int32_t)val);</span>
<a href="#l23.114"></a><span id="l23.114">   s += &quot;:&quot;;</span>
<a href="#l23.115"></a><span id="l23.115">   val = tm.wSecond;</span>
<a href="#l23.116"></a><span id="l23.116" class="difflineminus">-  if (val &lt; 10)</span>
<a href="#l23.117"></a><span id="l23.117" class="difflineminus">-    s += &quot;0&quot;;</span>
<a href="#l23.118"></a><span id="l23.118" class="difflineminus">-  s.AppendInt((int32_t) val);</span>
<a href="#l23.119"></a><span id="l23.119" class="difflineplus">+  if (val &lt; 10) s += &quot;0&quot;;</span>
<a href="#l23.120"></a><span id="l23.120" class="difflineplus">+  s.AppendInt((int32_t)val);</span>
<a href="#l23.121"></a><span id="l23.121">   if (includeTZ) {</span>
<a href="#l23.122"></a><span id="l23.122">     s += &quot; &quot;;</span>
<a href="#l23.123"></a><span id="l23.123">     if (offset &lt; 0) {</span>
<a href="#l23.124"></a><span id="l23.124">       offset *= -1;</span>
<a href="#l23.125"></a><span id="l23.125">       s += &quot;+&quot;;</span>
<a href="#l23.126"></a><span id="l23.126" class="difflineminus">-    }</span>
<a href="#l23.127"></a><span id="l23.127" class="difflineminus">-    else</span>
<a href="#l23.128"></a><span id="l23.128" class="difflineplus">+    } else</span>
<a href="#l23.129"></a><span id="l23.129">       s += &quot;-&quot;;</span>
<a href="#l23.130"></a><span id="l23.130">     offset /= 60;</span>
<a href="#l23.131"></a><span id="l23.131" class="difflineminus">-    val = (int) (offset / 60);</span>
<a href="#l23.132"></a><span id="l23.132" class="difflineminus">-    if (val &lt; 10)</span>
<a href="#l23.133"></a><span id="l23.133" class="difflineminus">-      s += &quot;0&quot;;</span>
<a href="#l23.134"></a><span id="l23.134" class="difflineminus">-    s.AppendInt((int32_t) val);</span>
<a href="#l23.135"></a><span id="l23.135" class="difflineminus">-    val = (int) (offset % 60);</span>
<a href="#l23.136"></a><span id="l23.136" class="difflineminus">-    if (val &lt; 10)</span>
<a href="#l23.137"></a><span id="l23.137" class="difflineminus">-      s += &quot;0&quot;;</span>
<a href="#l23.138"></a><span id="l23.138" class="difflineminus">-    s.AppendInt((int32_t) val);</span>
<a href="#l23.139"></a><span id="l23.139" class="difflineplus">+    val = (int)(offset / 60);</span>
<a href="#l23.140"></a><span id="l23.140" class="difflineplus">+    if (val &lt; 10) s += &quot;0&quot;;</span>
<a href="#l23.141"></a><span id="l23.141" class="difflineplus">+    s.AppendInt((int32_t)val);</span>
<a href="#l23.142"></a><span id="l23.142" class="difflineplus">+    val = (int)(offset % 60);</span>
<a href="#l23.143"></a><span id="l23.143" class="difflineplus">+    if (val &lt; 10) s += &quot;0&quot;;</span>
<a href="#l23.144"></a><span id="l23.144" class="difflineplus">+    s.AppendInt((int32_t)val);</span>
<a href="#l23.145"></a><span id="l23.145">   }</span>
<a href="#l23.146"></a><span id="l23.146"> }</span>
<a href="#l23.147"></a><span id="l23.147"> </span>
<a href="#l23.148"></a><span id="l23.148"> bool CMapiMessage::EnsureHeader(CMapiMessageHeaders::SpecialHeader special,</span>
<a href="#l23.149"></a><span id="l23.149" class="difflineminus">-                                ULONG mapiTag)</span>
<a href="#l23.150"></a><span id="l23.150" class="difflineminus">-{</span>
<a href="#l23.151"></a><span id="l23.151" class="difflineminus">-  if (m_headers.Value(special))</span>
<a href="#l23.152"></a><span id="l23.152" class="difflineminus">-    return true;</span>
<a href="#l23.153"></a><span id="l23.153" class="difflineplus">+                                ULONG mapiTag) {</span>
<a href="#l23.154"></a><span id="l23.154" class="difflineplus">+  if (m_headers.Value(special)) return true;</span>
<a href="#l23.155"></a><span id="l23.155"> </span>
<a href="#l23.156"></a><span id="l23.156">   LPSPropValue pVal = CMapiApi::GetMapiProperty(m_lpMsg, mapiTag);</span>
<a href="#l23.157"></a><span id="l23.157">   bool success = false;</span>
<a href="#l23.158"></a><span id="l23.158">   if (pVal) {</span>
<a href="#l23.159"></a><span id="l23.159">     if (PROP_TYPE(pVal-&gt;ulPropTag) == PT_STRING8) {</span>
<a href="#l23.160"></a><span id="l23.160">       if (pVal-&gt;Value.lpszA &amp;&amp; strlen(pVal-&gt;Value.lpszA)) {</span>
<a href="#l23.161"></a><span id="l23.161">         m_headers.SetValue(special, pVal-&gt;Value.lpszA);</span>
<a href="#l23.162"></a><span id="l23.162">         success = true;</span>
<a href="#l23.163"></a><span id="l23.163">       }</span>
<a href="#l23.164"></a><span id="l23.164" class="difflineminus">-    }</span>
<a href="#l23.165"></a><span id="l23.165" class="difflineminus">-    else if (PROP_TYPE(pVal-&gt;ulPropTag) == PT_UNICODE) {</span>
<a href="#l23.166"></a><span id="l23.166" class="difflineplus">+    } else if (PROP_TYPE(pVal-&gt;ulPropTag) == PT_UNICODE) {</span>
<a href="#l23.167"></a><span id="l23.167">       if (pVal-&gt;Value.lpszW &amp;&amp; wcslen(pVal-&gt;Value.lpszW)) {</span>
<a href="#l23.168"></a><span id="l23.168" class="difflineminus">-        m_headers.SetValue(special, NS_ConvertUTF16toUTF8(pVal-&gt;Value.lpszW).get());</span>
<a href="#l23.169"></a><span id="l23.169" class="difflineplus">+        m_headers.SetValue(special,</span>
<a href="#l23.170"></a><span id="l23.170" class="difflineplus">+                           NS_ConvertUTF16toUTF8(pVal-&gt;Value.lpszW).get());</span>
<a href="#l23.171"></a><span id="l23.171">         success = true;</span>
<a href="#l23.172"></a><span id="l23.172">       }</span>
<a href="#l23.173"></a><span id="l23.173">     }</span>
<a href="#l23.174"></a><span id="l23.174">     CMapiApi::MAPIFreeBuffer(pVal);</span>
<a href="#l23.175"></a><span id="l23.175">   }</span>
<a href="#l23.176"></a><span id="l23.176"> </span>
<a href="#l23.177"></a><span id="l23.177">   return success;</span>
<a href="#l23.178"></a><span id="l23.178"> }</span>
<a href="#l23.179"></a><span id="l23.179"> </span>
<a href="#l23.180"></a><span id="l23.180" class="difflineminus">-bool CMapiMessage::EnsureDate()</span>
<a href="#l23.181"></a><span id="l23.181" class="difflineminus">-{</span>
<a href="#l23.182"></a><span id="l23.182" class="difflineminus">-  if (m_headers.Value(CMapiMessageHeaders::hdrDate))</span>
<a href="#l23.183"></a><span id="l23.183" class="difflineminus">-    return true;</span>
<a href="#l23.184"></a><span id="l23.184" class="difflineplus">+bool CMapiMessage::EnsureDate() {</span>
<a href="#l23.185"></a><span id="l23.185" class="difflineplus">+  if (m_headers.Value(CMapiMessageHeaders::hdrDate)) return true;</span>
<a href="#l23.186"></a><span id="l23.186"> </span>
<a href="#l23.187"></a><span id="l23.187" class="difflineminus">-  LPSPropValue pVal = CMapiApi::GetMapiProperty(m_lpMsg, PR_MESSAGE_DELIVERY_TIME);</span>
<a href="#l23.188"></a><span id="l23.188" class="difflineminus">-  if (!pVal)</span>
<a href="#l23.189"></a><span id="l23.189" class="difflineminus">-    pVal = CMapiApi::GetMapiProperty(m_lpMsg, PR_CREATION_TIME);</span>
<a href="#l23.190"></a><span id="l23.190" class="difflineplus">+  LPSPropValue pVal =</span>
<a href="#l23.191"></a><span id="l23.191" class="difflineplus">+      CMapiApi::GetMapiProperty(m_lpMsg, PR_MESSAGE_DELIVERY_TIME);</span>
<a href="#l23.192"></a><span id="l23.192" class="difflineplus">+  if (!pVal) pVal = CMapiApi::GetMapiProperty(m_lpMsg, PR_CREATION_TIME);</span>
<a href="#l23.193"></a><span id="l23.193">   if (pVal) {</span>
<a href="#l23.194"></a><span id="l23.194">     SYSTEMTIME st;</span>
<a href="#l23.195"></a><span id="l23.195">     // the following call returns UTC</span>
<a href="#l23.196"></a><span id="l23.196">     ::FileTimeToSystemTime(&amp;(pVal-&gt;Value.ft), &amp;st);</span>
<a href="#l23.197"></a><span id="l23.197">     CMapiApi::MAPIFreeBuffer(pVal);</span>
<a href="#l23.198"></a><span id="l23.198">     // FormatDateTime would append the local time zone, so don't use it.</span>
<a href="#l23.199"></a><span id="l23.199">     // Instead, we just append +0000 for GMT/UTC here.</span>
<a href="#l23.200"></a><span id="l23.200">     nsCString str;</span>
<a href="#l23.201"></a><span id="l23.201" class="difflineat">@@ -174,89 +158,85 @@ bool CMapiMessage::EnsureDate()</span>
<a href="#l23.202"></a><span id="l23.202">     str += &quot; +0000&quot;;</span>
<a href="#l23.203"></a><span id="l23.203">     m_headers.SetValue(CMapiMessageHeaders::hdrDate, str.get());</span>
<a href="#l23.204"></a><span id="l23.204">     return true;</span>
<a href="#l23.205"></a><span id="l23.205">   }</span>
<a href="#l23.206"></a><span id="l23.206"> </span>
<a href="#l23.207"></a><span id="l23.207">   return false;</span>
<a href="#l23.208"></a><span id="l23.208"> }</span>
<a href="#l23.209"></a><span id="l23.209"> </span>
<a href="#l23.210"></a><span id="l23.210" class="difflineminus">-void CMapiMessage::BuildFromLine(void)</span>
<a href="#l23.211"></a><span id="l23.211" class="difflineminus">-{</span>
<a href="#l23.212"></a><span id="l23.212" class="difflineplus">+void CMapiMessage::BuildFromLine(void) {</span>
<a href="#l23.213"></a><span id="l23.213">   m_fromLine = sFromLine;</span>
<a href="#l23.214"></a><span id="l23.214">   LPSPropValue pVal = CMapiApi::GetMapiProperty(m_lpMsg, PR_CREATION_TIME);</span>
<a href="#l23.215"></a><span id="l23.215">   if (pVal) {</span>
<a href="#l23.216"></a><span id="l23.216">     SYSTEMTIME st;</span>
<a href="#l23.217"></a><span id="l23.217">     ::FileTimeToSystemTime(&amp;(pVal-&gt;Value.ft), &amp;st);</span>
<a href="#l23.218"></a><span id="l23.218">     CMapiApi::MAPIFreeBuffer(pVal);</span>
<a href="#l23.219"></a><span id="l23.219">     FormatDateTime(st, m_fromLine, FALSE);</span>
<a href="#l23.220"></a><span id="l23.220" class="difflineminus">-  }</span>
<a href="#l23.221"></a><span id="l23.221" class="difflineminus">-  else</span>
<a href="#l23.222"></a><span id="l23.222" class="difflineplus">+  } else</span>
<a href="#l23.223"></a><span id="l23.223">     m_fromLine += sFromDate;</span>
<a href="#l23.224"></a><span id="l23.224"> </span>
<a href="#l23.225"></a><span id="l23.225">   m_fromLine += &quot;\x0D\x0A&quot;;</span>
<a href="#l23.226"></a><span id="l23.226"> }</span>
<a href="#l23.227"></a><span id="l23.227"> </span>
<a href="#l23.228"></a><span id="l23.228"> #ifndef dispidHeaderItem</span>
<a href="#l23.229"></a><span id="l23.229" class="difflineminus">-#define dispidHeaderItem 0x8578</span>
<a href="#l23.230"></a><span id="l23.230" class="difflineplus">+#  define dispidHeaderItem 0x8578</span>
<a href="#l23.231"></a><span id="l23.231"> #endif</span>
<a href="#l23.232"></a><span id="l23.232" class="difflineminus">-DEFINE_OLEGUID(PSETID_Common, MAKELONG(0x2000+(8),0x0006),0,0);</span>
<a href="#l23.233"></a><span id="l23.233" class="difflineplus">+DEFINE_OLEGUID(PSETID_Common, MAKELONG(0x2000 + (8), 0x0006), 0, 0);</span>
<a href="#l23.234"></a><span id="l23.234"> </span>
<a href="#l23.235"></a><span id="l23.235" class="difflineminus">-void CMapiMessage::GetDownloadState()</span>
<a href="#l23.236"></a><span id="l23.236" class="difflineminus">-{</span>
<a href="#l23.237"></a><span id="l23.237" class="difflineplus">+void CMapiMessage::GetDownloadState() {</span>
<a href="#l23.238"></a><span id="l23.238">   // See http://support.microsoft.com/kb/912239</span>
<a href="#l23.239"></a><span id="l23.239" class="difflineminus">-  HRESULT         hRes = S_OK;</span>
<a href="#l23.240"></a><span id="l23.240" class="difflineminus">-  ULONG           ulVal = 0;</span>
<a href="#l23.241"></a><span id="l23.241" class="difflineminus">-  LPSPropValue    lpPropVal = NULL;</span>
<a href="#l23.242"></a><span id="l23.242" class="difflineplus">+  HRESULT hRes = S_OK;</span>
<a href="#l23.243"></a><span id="l23.243" class="difflineplus">+  ULONG ulVal = 0;</span>
<a href="#l23.244"></a><span id="l23.244" class="difflineplus">+  LPSPropValue lpPropVal = NULL;</span>
<a href="#l23.245"></a><span id="l23.245">   LPSPropTagArray lpNamedPropTag = NULL;</span>
<a href="#l23.246"></a><span id="l23.246" class="difflineminus">-  MAPINAMEID      NamedID = {0};</span>
<a href="#l23.247"></a><span id="l23.247" class="difflineminus">-  LPMAPINAMEID    lpNamedID = NULL;</span>
<a href="#l23.248"></a><span id="l23.248" class="difflineplus">+  MAPINAMEID NamedID = {0};</span>
<a href="#l23.249"></a><span id="l23.249" class="difflineplus">+  LPMAPINAMEID lpNamedID = NULL;</span>
<a href="#l23.250"></a><span id="l23.250"> </span>
<a href="#l23.251"></a><span id="l23.251" class="difflineminus">-  NamedID.lpguid = (LPGUID) &amp;PSETID_Common;</span>
<a href="#l23.252"></a><span id="l23.252" class="difflineplus">+  NamedID.lpguid = (LPGUID)&amp;PSETID_Common;</span>
<a href="#l23.253"></a><span id="l23.253">   NamedID.ulKind = MNID_ID;</span>
<a href="#l23.254"></a><span id="l23.254">   NamedID.Kind.lID = dispidHeaderItem;</span>
<a href="#l23.255"></a><span id="l23.255">   lpNamedID = &amp;NamedID;</span>
<a href="#l23.256"></a><span id="l23.256"> </span>
<a href="#l23.257"></a><span id="l23.257">   hRes = m_lpMsg-&gt;GetIDsFromNames(1, &amp;lpNamedID, NULL, &amp;lpNamedPropTag);</span>
<a href="#l23.258"></a><span id="l23.258"> </span>
<a href="#l23.259"></a><span id="l23.259" class="difflineminus">-  if (lpNamedPropTag &amp;&amp; 1 == lpNamedPropTag-&gt;cValues)</span>
<a href="#l23.260"></a><span id="l23.260" class="difflineminus">-  {</span>
<a href="#l23.261"></a><span id="l23.261" class="difflineminus">-    lpNamedPropTag-&gt;aulPropTag[0] = CHANGE_PROP_TYPE(lpNamedPropTag-&gt;aulPropTag[0], PT_LONG);</span>
<a href="#l23.262"></a><span id="l23.262" class="difflineplus">+  if (lpNamedPropTag &amp;&amp; 1 == lpNamedPropTag-&gt;cValues) {</span>
<a href="#l23.263"></a><span id="l23.263" class="difflineplus">+    lpNamedPropTag-&gt;aulPropTag[0] =</span>
<a href="#l23.264"></a><span id="l23.264" class="difflineplus">+        CHANGE_PROP_TYPE(lpNamedPropTag-&gt;aulPropTag[0], PT_LONG);</span>
<a href="#l23.265"></a><span id="l23.265"> </span>
<a href="#l23.266"></a><span id="l23.266" class="difflineminus">-    //Get the value of the property.</span>
<a href="#l23.267"></a><span id="l23.267" class="difflineplus">+    // Get the value of the property.</span>
<a href="#l23.268"></a><span id="l23.268">     hRes = m_lpMsg-&gt;GetProps(lpNamedPropTag, 0, &amp;ulVal, &amp;lpPropVal);</span>
<a href="#l23.269"></a><span id="l23.269">     if (lpPropVal &amp;&amp; 1 == ulVal &amp;&amp; PT_LONG == PROP_TYPE(lpPropVal-&gt;ulPropTag) &amp;&amp;</span>
<a href="#l23.270"></a><span id="l23.270">         lpPropVal-&gt;Value.ul)</span>
<a href="#l23.271"></a><span id="l23.271">       m_dldStateHeadersOnly = true;</span>
<a href="#l23.272"></a><span id="l23.272">   }</span>
<a href="#l23.273"></a><span id="l23.273"> </span>
<a href="#l23.274"></a><span id="l23.274">   CMapiApi::MAPIFreeBuffer(lpPropVal);</span>
<a href="#l23.275"></a><span id="l23.275">   CMapiApi::MAPIFreeBuffer(lpNamedPropTag);</span>
<a href="#l23.276"></a><span id="l23.276"> }</span>
<a href="#l23.277"></a><span id="l23.277"> </span>
<a href="#l23.278"></a><span id="l23.278"> // Headers - fetch will get PR_TRANSPORT_MESSAGE_HEADERS</span>
<a href="#l23.279"></a><span id="l23.279"> // or if they do not exist will build a header from</span>
<a href="#l23.280"></a><span id="l23.280"> //  PR_DISPLAY_TO, _CC, _BCC</span>
<a href="#l23.281"></a><span id="l23.281"> //  PR_SUBJECT</span>
<a href="#l23.282"></a><span id="l23.282"> //  PR_MESSAGE_RECIPIENTS</span>
<a href="#l23.283"></a><span id="l23.283"> // and PR_CREATION_TIME if needed?</span>
<a href="#l23.284"></a><span id="l23.284" class="difflineminus">-bool CMapiMessage::FetchHeaders(void)</span>
<a href="#l23.285"></a><span id="l23.285" class="difflineminus">-{</span>
<a href="#l23.286"></a><span id="l23.286" class="difflineplus">+bool CMapiMessage::FetchHeaders(void) {</span>
<a href="#l23.287"></a><span id="l23.287">   ULONG tag = PR_TRANSPORT_MESSAGE_HEADERS_A;</span>
<a href="#l23.288"></a><span id="l23.288">   LPSPropValue pVal = CMapiApi::GetMapiProperty(m_lpMsg, tag);</span>
<a href="#l23.289"></a><span id="l23.289">   if (!pVal)</span>
<a href="#l23.290"></a><span id="l23.290" class="difflineminus">-    pVal = CMapiApi::GetMapiProperty(m_lpMsg, tag = PR_TRANSPORT_MESSAGE_HEADERS_W);</span>
<a href="#l23.291"></a><span id="l23.291" class="difflineplus">+    pVal = CMapiApi::GetMapiProperty(m_lpMsg,</span>
<a href="#l23.292"></a><span id="l23.292" class="difflineplus">+                                     tag = PR_TRANSPORT_MESSAGE_HEADERS_W);</span>
<a href="#l23.293"></a><span id="l23.293">   if (pVal) {</span>
<a href="#l23.294"></a><span id="l23.294">     if (CMapiApi::IsLargeProperty(pVal)) {</span>
<a href="#l23.295"></a><span id="l23.295">       nsCString headers;</span>
<a href="#l23.296"></a><span id="l23.296">       CMapiApi::GetLargeStringProperty(m_lpMsg, tag, headers);</span>
<a href="#l23.297"></a><span id="l23.297">       m_headers.Assign(headers.get());</span>
<a href="#l23.298"></a><span id="l23.298" class="difflineminus">-    }</span>
<a href="#l23.299"></a><span id="l23.299" class="difflineminus">-    else if ((PROP_TYPE(pVal-&gt;ulPropTag) == PT_STRING8) &amp;&amp;</span>
<a href="#l23.300"></a><span id="l23.300" class="difflineminus">-             (pVal-&gt;Value.lpszA) &amp;&amp; (*(pVal-&gt;Value.lpszA)))</span>
<a href="#l23.301"></a><span id="l23.301" class="difflineplus">+    } else if ((PROP_TYPE(pVal-&gt;ulPropTag) == PT_STRING8) &amp;&amp;</span>
<a href="#l23.302"></a><span id="l23.302" class="difflineplus">+               (pVal-&gt;Value.lpszA) &amp;&amp; (*(pVal-&gt;Value.lpszA)))</span>
<a href="#l23.303"></a><span id="l23.303">       m_headers.Assign(pVal-&gt;Value.lpszA);</span>
<a href="#l23.304"></a><span id="l23.304">     else if ((PROP_TYPE(pVal-&gt;ulPropTag) == PT_UNICODE) &amp;&amp;</span>
<a href="#l23.305"></a><span id="l23.305">              (pVal-&gt;Value.lpszW) &amp;&amp; (*(pVal-&gt;Value.lpszW))) {</span>
<a href="#l23.306"></a><span id="l23.306">       nsCString headers;</span>
<a href="#l23.307"></a><span id="l23.307">       LossyCopyUTF16toASCII(nsDependentString(pVal-&gt;Value.lpszW), headers);</span>
<a href="#l23.308"></a><span id="l23.308">       m_headers.Assign(headers.get());</span>
<a href="#l23.309"></a><span id="l23.309">     }</span>
<a href="#l23.310"></a><span id="l23.310"> </span>
<a href="#l23.311"></a><span id="l23.311" class="difflineat">@@ -275,396 +255,404 @@ bool CMapiMessage::FetchHeaders(void)</span>
<a href="#l23.312"></a><span id="l23.312"> </span>
<a href="#l23.313"></a><span id="l23.313">   return !m_headers.IsEmpty();</span>
<a href="#l23.314"></a><span id="l23.314"> }</span>
<a href="#l23.315"></a><span id="l23.315"> </span>
<a href="#l23.316"></a><span id="l23.316"> // Mime-Version: 1.0</span>
<a href="#l23.317"></a><span id="l23.317"> // Content-Type: text/plain; charset=&quot;US-ASCII&quot;</span>
<a href="#l23.318"></a><span id="l23.318"> // Content-Type: multipart/mixed; boundary=&quot;=====================_874475278==_&quot;</span>
<a href="#l23.319"></a><span id="l23.319"> </span>
<a href="#l23.320"></a><span id="l23.320" class="difflineminus">-void CMapiMessage::ProcessContentType()</span>
<a href="#l23.321"></a><span id="l23.321" class="difflineminus">-{</span>
<a href="#l23.322"></a><span id="l23.322" class="difflineplus">+void CMapiMessage::ProcessContentType() {</span>
<a href="#l23.323"></a><span id="l23.323">   m_mimeContentType.Truncate();</span>
<a href="#l23.324"></a><span id="l23.324">   m_mimeBoundary.Truncate();</span>
<a href="#l23.325"></a><span id="l23.325">   m_mimeCharset.Truncate();</span>
<a href="#l23.326"></a><span id="l23.326"> </span>
<a href="#l23.327"></a><span id="l23.327" class="difflineminus">-  const char* contentType = m_headers.Value(CMapiMessageHeaders::hdrContentType);</span>
<a href="#l23.328"></a><span id="l23.328" class="difflineminus">-  if (!contentType)</span>
<a href="#l23.329"></a><span id="l23.329" class="difflineminus">-    return;</span>
<a href="#l23.330"></a><span id="l23.330" class="difflineplus">+  const char* contentType =</span>
<a href="#l23.331"></a><span id="l23.331" class="difflineplus">+      m_headers.Value(CMapiMessageHeaders::hdrContentType);</span>
<a href="#l23.332"></a><span id="l23.332" class="difflineplus">+  if (!contentType) return;</span>
<a href="#l23.333"></a><span id="l23.333"> </span>
<a href="#l23.334"></a><span id="l23.334">   const char *begin = contentType, *end;</span>
<a href="#l23.335"></a><span id="l23.335">   nsCString tStr;</span>
<a href="#l23.336"></a><span id="l23.336"> </span>
<a href="#l23.337"></a><span id="l23.337">   // Note: this isn't a complete parser, the content type</span>
<a href="#l23.338"></a><span id="l23.338">   // we extract could have rfc822 comments in it</span>
<a href="#l23.339"></a><span id="l23.339" class="difflineminus">-  while (*begin &amp;&amp; IsSpace(*begin))</span>
<a href="#l23.340"></a><span id="l23.340" class="difflineminus">-    begin++;</span>
<a href="#l23.341"></a><span id="l23.341" class="difflineminus">-  if (!(*begin))</span>
<a href="#l23.342"></a><span id="l23.342" class="difflineminus">-    return;</span>
<a href="#l23.343"></a><span id="l23.343" class="difflineplus">+  while (*begin &amp;&amp; IsSpace(*begin)) begin++;</span>
<a href="#l23.344"></a><span id="l23.344" class="difflineplus">+  if (!(*begin)) return;</span>
<a href="#l23.345"></a><span id="l23.345">   end = begin;</span>
<a href="#l23.346"></a><span id="l23.346" class="difflineminus">-  while (*end &amp;&amp; (*end != ';'))</span>
<a href="#l23.347"></a><span id="l23.347" class="difflineminus">-    end++;</span>
<a href="#l23.348"></a><span id="l23.348" class="difflineminus">-  m_mimeContentType.Assign(begin, end-begin);</span>
<a href="#l23.349"></a><span id="l23.349" class="difflineminus">-  if (!(*end))</span>
<a href="#l23.350"></a><span id="l23.350" class="difflineminus">-    return;</span>
<a href="#l23.351"></a><span id="l23.351" class="difflineplus">+  while (*end &amp;&amp; (*end != ';')) end++;</span>
<a href="#l23.352"></a><span id="l23.352" class="difflineplus">+  m_mimeContentType.Assign(begin, end - begin);</span>
<a href="#l23.353"></a><span id="l23.353" class="difflineplus">+  if (!(*end)) return;</span>
<a href="#l23.354"></a><span id="l23.354">   // look for &quot;boundary=&quot;</span>
<a href="#l23.355"></a><span id="l23.355">   begin = end + 1;</span>
<a href="#l23.356"></a><span id="l23.356">   bool haveB;</span>
<a href="#l23.357"></a><span id="l23.357">   bool haveC;</span>
<a href="#l23.358"></a><span id="l23.358">   while (*begin) {</span>
<a href="#l23.359"></a><span id="l23.359">     haveB = false;</span>
<a href="#l23.360"></a><span id="l23.360">     haveC = false;</span>
<a href="#l23.361"></a><span id="l23.361" class="difflineminus">-    while (*begin &amp;&amp; IsSpace(*begin))</span>
<a href="#l23.362"></a><span id="l23.362" class="difflineminus">-      begin++;</span>
<a href="#l23.363"></a><span id="l23.363" class="difflineminus">-    if (!(*begin))</span>
<a href="#l23.364"></a><span id="l23.364" class="difflineminus">-      return;</span>
<a href="#l23.365"></a><span id="l23.365" class="difflineplus">+    while (*begin &amp;&amp; IsSpace(*begin)) begin++;</span>
<a href="#l23.366"></a><span id="l23.366" class="difflineplus">+    if (!(*begin)) return;</span>
<a href="#l23.367"></a><span id="l23.367">     end = begin;</span>
<a href="#l23.368"></a><span id="l23.368" class="difflineminus">-    while (*end &amp;&amp; (*end != '='))</span>
<a href="#l23.369"></a><span id="l23.369" class="difflineminus">-      end++;</span>
<a href="#l23.370"></a><span id="l23.370" class="difflineplus">+    while (*end &amp;&amp; (*end != '=')) end++;</span>
<a href="#l23.371"></a><span id="l23.371">     if (end - begin) {</span>
<a href="#l23.372"></a><span id="l23.372" class="difflineminus">-      tStr.Assign(begin, end-begin);</span>
<a href="#l23.373"></a><span id="l23.373" class="difflineplus">+      tStr.Assign(begin, end - begin);</span>
<a href="#l23.374"></a><span id="l23.374">       if (tStr.LowerCaseEqualsLiteral(&quot;boundary&quot;))</span>
<a href="#l23.375"></a><span id="l23.375">         haveB = true;</span>
<a href="#l23.376"></a><span id="l23.376">       else if (tStr.LowerCaseEqualsLiteral(&quot;charset&quot;))</span>
<a href="#l23.377"></a><span id="l23.377">         haveC = true;</span>
<a href="#l23.378"></a><span id="l23.378">     }</span>
<a href="#l23.379"></a><span id="l23.379" class="difflineminus">-    if (!(*end))</span>
<a href="#l23.380"></a><span id="l23.380" class="difflineminus">-      return;</span>
<a href="#l23.381"></a><span id="l23.381" class="difflineminus">-    begin = end+1;</span>
<a href="#l23.382"></a><span id="l23.382" class="difflineminus">-    while (*begin &amp;&amp; IsSpace(*begin))</span>
<a href="#l23.383"></a><span id="l23.383" class="difflineminus">-      begin++;</span>
<a href="#l23.384"></a><span id="l23.384" class="difflineplus">+    if (!(*end)) return;</span>
<a href="#l23.385"></a><span id="l23.385" class="difflineplus">+    begin = end + 1;</span>
<a href="#l23.386"></a><span id="l23.386" class="difflineplus">+    while (*begin &amp;&amp; IsSpace(*begin)) begin++;</span>
<a href="#l23.387"></a><span id="l23.387">     if (*begin == '&quot;') {</span>
<a href="#l23.388"></a><span id="l23.388">       begin++;</span>
<a href="#l23.389"></a><span id="l23.389">       bool slash = false;</span>
<a href="#l23.390"></a><span id="l23.390">       tStr.Truncate();</span>
<a href="#l23.391"></a><span id="l23.391">       while (*begin) {</span>
<a href="#l23.392"></a><span id="l23.392">         if (slash) {</span>
<a href="#l23.393"></a><span id="l23.393">           slash = false;</span>
<a href="#l23.394"></a><span id="l23.394">           tStr.Append(*begin);</span>
<a href="#l23.395"></a><span id="l23.395" class="difflineminus">-        }</span>
<a href="#l23.396"></a><span id="l23.396" class="difflineminus">-        else if (*begin == '&quot;')</span>
<a href="#l23.397"></a><span id="l23.397" class="difflineplus">+        } else if (*begin == '&quot;')</span>
<a href="#l23.398"></a><span id="l23.398">           break;</span>
<a href="#l23.399"></a><span id="l23.399">         else if (*begin != '\\')</span>
<a href="#l23.400"></a><span id="l23.400">           tStr.Append(*begin);</span>
<a href="#l23.401"></a><span id="l23.401">         else</span>
<a href="#l23.402"></a><span id="l23.402">           slash = true;</span>
<a href="#l23.403"></a><span id="l23.403">         begin++;</span>
<a href="#l23.404"></a><span id="l23.404">       }</span>
<a href="#l23.405"></a><span id="l23.405">       if (haveB) {</span>
<a href="#l23.406"></a><span id="l23.406">         m_mimeBoundary = tStr;</span>
<a href="#l23.407"></a><span id="l23.407">         haveB = false;</span>
<a href="#l23.408"></a><span id="l23.408">       }</span>
<a href="#l23.409"></a><span id="l23.409">       if (haveC) {</span>
<a href="#l23.410"></a><span id="l23.410">         m_mimeCharset = tStr;</span>
<a href="#l23.411"></a><span id="l23.411">         haveC = false;</span>
<a href="#l23.412"></a><span id="l23.412">       }</span>
<a href="#l23.413"></a><span id="l23.413" class="difflineminus">-      if (!(*begin))</span>
<a href="#l23.414"></a><span id="l23.414" class="difflineminus">-        return;</span>
<a href="#l23.415"></a><span id="l23.415" class="difflineplus">+      if (!(*begin)) return;</span>
<a href="#l23.416"></a><span id="l23.416">       begin++;</span>
<a href="#l23.417"></a><span id="l23.417">     }</span>
<a href="#l23.418"></a><span id="l23.418">     tStr.Truncate();</span>
<a href="#l23.419"></a><span id="l23.419">     while (*begin &amp;&amp; (*begin != ';')) {</span>
<a href="#l23.420"></a><span id="l23.420">       tStr.Append(*(begin++));</span>
<a href="#l23.421"></a><span id="l23.421">     }</span>
<a href="#l23.422"></a><span id="l23.422">     if (haveB) {</span>
<a href="#l23.423"></a><span id="l23.423">       tStr.Trim(kWhitespace);</span>
<a href="#l23.424"></a><span id="l23.424">       m_mimeBoundary = tStr;</span>
<a href="#l23.425"></a><span id="l23.425">     }</span>
<a href="#l23.426"></a><span id="l23.426">     if (haveC) {</span>
<a href="#l23.427"></a><span id="l23.427">       tStr.Trim(kWhitespace);</span>
<a href="#l23.428"></a><span id="l23.428">       m_mimeCharset = tStr;</span>
<a href="#l23.429"></a><span id="l23.429">     }</span>
<a href="#l23.430"></a><span id="l23.430" class="difflineminus">-    if (*begin)</span>
<a href="#l23.431"></a><span id="l23.431" class="difflineminus">-      begin++;</span>
<a href="#l23.432"></a><span id="l23.432" class="difflineplus">+    if (*begin) begin++;</span>
<a href="#l23.433"></a><span id="l23.433">   }</span>
<a href="#l23.434"></a><span id="l23.434"> }</span>
<a href="#l23.435"></a><span id="l23.435"> </span>
<a href="#l23.436"></a><span id="l23.436" class="difflineminus">-const char* CpToCharset(unsigned int cp)</span>
<a href="#l23.437"></a><span id="l23.437" class="difflineminus">-{</span>
<a href="#l23.438"></a><span id="l23.438" class="difflineplus">+const char* CpToCharset(unsigned int cp) {</span>
<a href="#l23.439"></a><span id="l23.439">   struct CODEPAGE_TO_CHARSET {</span>
<a href="#l23.440"></a><span id="l23.440">     unsigned long cp;</span>
<a href="#l23.441"></a><span id="l23.441">     const char* charset;</span>
<a href="#l23.442"></a><span id="l23.442">   };</span>
<a href="#l23.443"></a><span id="l23.443"> </span>
<a href="#l23.444"></a><span id="l23.444" class="difflineminus">-  // This table is based on http://msdn.microsoft.com/en-us/library/dd317756(v=VS.85).aspx#1;</span>
<a href="#l23.445"></a><span id="l23.445" class="difflineminus">-  // Please extend as appropriate. The codepage values are sorted ascending.</span>
<a href="#l23.446"></a><span id="l23.446" class="difflineminus">-  static const CODEPAGE_TO_CHARSET cptocharset[] =</span>
<a href="#l23.447"></a><span id="l23.447" class="difflineminus">-    {</span>
<a href="#l23.448"></a><span id="l23.448" class="difflineminus">-      {37, &quot;IBM037&quot;}, // IBM EBCDIC US-Canada</span>
<a href="#l23.449"></a><span id="l23.449" class="difflineminus">-      {437, &quot;IBM437&quot;}, //OEM United States</span>
<a href="#l23.450"></a><span id="l23.450" class="difflineminus">-      {500, &quot;IBM500&quot;}, //IBM EBCDIC International</span>
<a href="#l23.451"></a><span id="l23.451" class="difflineminus">-      {708, &quot;ASMO-708&quot;}, //Arabic (ASMO 708)</span>
<a href="#l23.452"></a><span id="l23.452" class="difflineminus">-      //709  Arabic (ASMO-449+, BCON V4)</span>
<a href="#l23.453"></a><span id="l23.453" class="difflineminus">-      //710  Arabic - Transparent Arabic</span>
<a href="#l23.454"></a><span id="l23.454" class="difflineminus">-      {720, &quot;DOS-720&quot;}, //Arabic (Transparent ASMO); Arabic (DOS)</span>
<a href="#l23.455"></a><span id="l23.455" class="difflineminus">-      {737, &quot;ibm737&quot;}, // OEM Greek (formerly 437G); Greek (DOS)</span>
<a href="#l23.456"></a><span id="l23.456" class="difflineminus">-      {775, &quot;ibm775&quot;}, // OEM Baltic; Baltic (DOS)</span>
<a href="#l23.457"></a><span id="l23.457" class="difflineminus">-      {850, &quot;ibm850&quot;}, // OEM Multilingual Latin 1; Western European (DOS)</span>
<a href="#l23.458"></a><span id="l23.458" class="difflineminus">-      {852, &quot;ibm852&quot;}, // OEM Latin 2; Central European (DOS)</span>
<a href="#l23.459"></a><span id="l23.459" class="difflineminus">-      {855, &quot;IBM855&quot;}, // OEM Cyrillic (primarily Russian)</span>
<a href="#l23.460"></a><span id="l23.460" class="difflineminus">-      {857, &quot;ibm857&quot;}, // OEM Turkish; Turkish (DOS)</span>
<a href="#l23.461"></a><span id="l23.461" class="difflineminus">-      {858, &quot;IBM00858&quot;}, // OEM Multilingual Latin 1 + Euro symbol</span>
<a href="#l23.462"></a><span id="l23.462" class="difflineminus">-      {860, &quot;IBM860&quot;}, // OEM Portuguese; Portuguese (DOS)</span>
<a href="#l23.463"></a><span id="l23.463" class="difflineminus">-      {861, &quot;ibm861&quot;}, // OEM Icelandic; Icelandic (DOS)</span>
<a href="#l23.464"></a><span id="l23.464" class="difflineminus">-      {862, &quot;DOS-862&quot;}, // OEM Hebrew; Hebrew (DOS)</span>
<a href="#l23.465"></a><span id="l23.465" class="difflineminus">-      {863, &quot;IBM863&quot;}, // OEM French Canadian; French Canadian (DOS)</span>
<a href="#l23.466"></a><span id="l23.466" class="difflineminus">-      {864, &quot;IBM864&quot;}, // OEM Arabic; Arabic (864)</span>
<a href="#l23.467"></a><span id="l23.467" class="difflineminus">-      {865, &quot;IBM865&quot;}, // OEM Nordic; Nordic (DOS)</span>
<a href="#l23.468"></a><span id="l23.468" class="difflineminus">-      {866, &quot;cp866&quot;}, // OEM Russian; Cyrillic (DOS)</span>
<a href="#l23.469"></a><span id="l23.469" class="difflineminus">-      {869, &quot;ibm869&quot;}, // OEM Modern Greek; Greek, Modern (DOS)</span>
<a href="#l23.470"></a><span id="l23.470" class="difflineminus">-      {870, &quot;IBM870&quot;}, // IBM EBCDIC Multilingual/ROECE (Latin 2); IBM EBCDIC Multilingual Latin 2</span>
<a href="#l23.471"></a><span id="l23.471" class="difflineminus">-      {874, &quot;windows-874&quot;}, // ANSI/OEM Thai (same as 28605, ISO 8859-15); Thai (Windows)</span>
<a href="#l23.472"></a><span id="l23.472" class="difflineminus">-      {875, &quot;cp875&quot;}, // IBM EBCDIC Greek Modern</span>
<a href="#l23.473"></a><span id="l23.473" class="difflineminus">-      {932, &quot;shift_jis&quot;}, // ANSI/OEM Japanese; Japanese (Shift-JIS)</span>
<a href="#l23.474"></a><span id="l23.474" class="difflineminus">-      {936, &quot;gb2312&quot;}, // ANSI/OEM Simplified Chinese (PRC, Singapore); Chinese Simplified (GB2312)</span>
<a href="#l23.475"></a><span id="l23.475" class="difflineminus">-      {949, &quot;ks_c_5601-1987&quot;}, // ANSI/OEM Korean (Unified Hangul Code)</span>
<a href="#l23.476"></a><span id="l23.476" class="difflineminus">-      {950, &quot;big5&quot;}, // ANSI/OEM Traditional Chinese (Taiwan; Hong Kong SAR, PRC); Chinese Traditional (Big5)</span>
<a href="#l23.477"></a><span id="l23.477" class="difflineminus">-      {1026, &quot;IBM1026&quot;}, // IBM EBCDIC Turkish (Latin 5)</span>
<a href="#l23.478"></a><span id="l23.478" class="difflineminus">-      {1047, &quot;IBM01047&quot;}, // IBM EBCDIC Latin 1/Open System</span>
<a href="#l23.479"></a><span id="l23.479" class="difflineminus">-      {1140, &quot;IBM01140&quot;}, // IBM EBCDIC US-Canada (037 + Euro symbol); IBM EBCDIC (US-Canada-Euro)</span>
<a href="#l23.480"></a><span id="l23.480" class="difflineminus">-      {1141, &quot;IBM01141&quot;}, // IBM EBCDIC Germany (20273 + Euro symbol); IBM EBCDIC (Germany-Euro)</span>
<a href="#l23.481"></a><span id="l23.481" class="difflineminus">-      {1142, &quot;IBM01142&quot;}, // IBM EBCDIC Denmark-Norway (20277 + Euro symbol); IBM EBCDIC (Denmark-Norway-Euro)</span>
<a href="#l23.482"></a><span id="l23.482" class="difflineminus">-      {1143, &quot;IBM01143&quot;}, // IBM EBCDIC Finland-Sweden (20278 + Euro symbol); IBM EBCDIC (Finland-Sweden-Euro)</span>
<a href="#l23.483"></a><span id="l23.483" class="difflineminus">-      {1144, &quot;IBM01144&quot;}, // IBM EBCDIC Italy (20280 + Euro symbol); IBM EBCDIC (Italy-Euro)</span>
<a href="#l23.484"></a><span id="l23.484" class="difflineminus">-      {1145, &quot;IBM01145&quot;}, // IBM EBCDIC Latin America-Spain (20284 + Euro symbol); IBM EBCDIC (Spain-Euro)</span>
<a href="#l23.485"></a><span id="l23.485" class="difflineminus">-      {1146, &quot;IBM01146&quot;}, // IBM EBCDIC United Kingdom (20285 + Euro symbol); IBM EBCDIC (UK-Euro)</span>
<a href="#l23.486"></a><span id="l23.486" class="difflineminus">-      {1147, &quot;IBM01147&quot;}, // IBM EBCDIC France (20297 + Euro symbol); IBM EBCDIC (France-Euro)</span>
<a href="#l23.487"></a><span id="l23.487" class="difflineminus">-      {1148, &quot;IBM01148&quot;}, // IBM EBCDIC International (500 + Euro symbol); IBM EBCDIC (International-Euro)</span>
<a href="#l23.488"></a><span id="l23.488" class="difflineminus">-      {1149, &quot;IBM01149&quot;}, // IBM EBCDIC Icelandic (20871 + Euro symbol); IBM EBCDIC (Icelandic-Euro)</span>
<a href="#l23.489"></a><span id="l23.489" class="difflineminus">-      {1200, &quot;utf-16&quot;}, // Unicode UTF-16, little endian byte order (BMP of ISO 10646); available only to managed applications</span>
<a href="#l23.490"></a><span id="l23.490" class="difflineminus">-      {1201, &quot;unicodeFFFE&quot;}, // Unicode UTF-16, big endian byte order; available only to managed applications</span>
<a href="#l23.491"></a><span id="l23.491" class="difflineminus">-      {1250, &quot;windows-1250&quot;}, // ANSI Central European; Central European (Windows)</span>
<a href="#l23.492"></a><span id="l23.492" class="difflineminus">-      {1251, &quot;windows-1251&quot;}, // ANSI Cyrillic; Cyrillic (Windows)</span>
<a href="#l23.493"></a><span id="l23.493" class="difflineminus">-      {1252, &quot;windows-1252&quot;}, // ANSI Latin 1; Western European (Windows)</span>
<a href="#l23.494"></a><span id="l23.494" class="difflineminus">-      {1253, &quot;windows-1253&quot;}, // ANSI Greek; Greek (Windows)</span>
<a href="#l23.495"></a><span id="l23.495" class="difflineminus">-      {1254, &quot;windows-1254&quot;}, // ANSI Turkish; Turkish (Windows)</span>
<a href="#l23.496"></a><span id="l23.496" class="difflineminus">-      {1255, &quot;windows-1255&quot;}, // ANSI Hebrew; Hebrew (Windows)</span>
<a href="#l23.497"></a><span id="l23.497" class="difflineminus">-      {1256, &quot;windows-1256&quot;}, // ANSI Arabic; Arabic (Windows)</span>
<a href="#l23.498"></a><span id="l23.498" class="difflineminus">-      {1257, &quot;windows-1257&quot;}, // ANSI Baltic; Baltic (Windows)</span>
<a href="#l23.499"></a><span id="l23.499" class="difflineminus">-      {1258, &quot;windows-1258&quot;}, // ANSI/OEM Vietnamese; Vietnamese (Windows)</span>
<a href="#l23.500"></a><span id="l23.500" class="difflineminus">-      {1361, &quot;Johab&quot;}, // Korean (Johab)</span>
<a href="#l23.501"></a><span id="l23.501" class="difflineminus">-      {10000, &quot;macintosh&quot;}, // MAC Roman; Western European (Mac)</span>
<a href="#l23.502"></a><span id="l23.502" class="difflineminus">-      {10001, &quot;x-mac-japanese&quot;}, // Japanese (Mac)</span>
<a href="#l23.503"></a><span id="l23.503" class="difflineminus">-      {10002, &quot;x-mac-chinesetrad&quot;}, // MAC Traditional Chinese (Big5); Chinese Traditional (Mac)</span>
<a href="#l23.504"></a><span id="l23.504" class="difflineminus">-      {10003, &quot;x-mac-korean&quot;}, // Korean (Mac)</span>
<a href="#l23.505"></a><span id="l23.505" class="difflineminus">-      {10004, &quot;x-mac-arabic&quot;}, // Arabic (Mac)</span>
<a href="#l23.506"></a><span id="l23.506" class="difflineminus">-      {10005, &quot;x-mac-hebrew&quot;}, // Hebrew (Mac)</span>
<a href="#l23.507"></a><span id="l23.507" class="difflineminus">-      {10006, &quot;x-mac-greek&quot;}, // Greek (Mac)</span>
<a href="#l23.508"></a><span id="l23.508" class="difflineminus">-      {10007, &quot;x-mac-cyrillic&quot;}, // Cyrillic (Mac)</span>
<a href="#l23.509"></a><span id="l23.509" class="difflineminus">-      {10008, &quot;x-mac-chinesesimp&quot;}, // MAC Simplified Chinese (GB 2312); Chinese Simplified (Mac)</span>
<a href="#l23.510"></a><span id="l23.510" class="difflineminus">-      {10010, &quot;x-mac-romanian&quot;}, // Romanian (Mac)</span>
<a href="#l23.511"></a><span id="l23.511" class="difflineminus">-      {10017, &quot;x-mac-ukrainian&quot;}, // Ukrainian (Mac)</span>
<a href="#l23.512"></a><span id="l23.512" class="difflineminus">-      {10021, &quot;x-mac-thai&quot;}, // Thai (Mac)</span>
<a href="#l23.513"></a><span id="l23.513" class="difflineminus">-      {10029, &quot;x-mac-ce&quot;}, // MAC Latin 2; Central European (Mac)</span>
<a href="#l23.514"></a><span id="l23.514" class="difflineminus">-      {10079, &quot;x-mac-icelandic&quot;}, // Icelandic (Mac)</span>
<a href="#l23.515"></a><span id="l23.515" class="difflineminus">-      {10081, &quot;x-mac-turkish&quot;}, // Turkish (Mac)</span>
<a href="#l23.516"></a><span id="l23.516" class="difflineminus">-      {10082, &quot;x-mac-croatian&quot;}, // Croatian (Mac)</span>
<a href="#l23.517"></a><span id="l23.517" class="difflineminus">-      // Unicode UTF-32, little endian byte order; available only to managed applications</span>
<a href="#l23.518"></a><span id="l23.518" class="difflineminus">-      // impossible in 8-bit mail</span>
<a href="#l23.519"></a><span id="l23.519" class="difflineplus">+  // This table is based on</span>
<a href="#l23.520"></a><span id="l23.520" class="difflineplus">+  // http://msdn.microsoft.com/en-us/library/dd317756(v=VS.85).aspx#1; Please</span>
<a href="#l23.521"></a><span id="l23.521" class="difflineplus">+  // extend as appropriate. The codepage values are sorted ascending.</span>
<a href="#l23.522"></a><span id="l23.522" class="difflineplus">+  static const CODEPAGE_TO_CHARSET cptocharset[] = {</span>
<a href="#l23.523"></a><span id="l23.523" class="difflineplus">+      {37, &quot;IBM037&quot;},     // IBM EBCDIC US-Canada</span>
<a href="#l23.524"></a><span id="l23.524" class="difflineplus">+      {437, &quot;IBM437&quot;},    // OEM United States</span>
<a href="#l23.525"></a><span id="l23.525" class="difflineplus">+      {500, &quot;IBM500&quot;},    // IBM EBCDIC International</span>
<a href="#l23.526"></a><span id="l23.526" class="difflineplus">+      {708, &quot;ASMO-708&quot;},  // Arabic (ASMO 708)</span>
<a href="#l23.527"></a><span id="l23.527" class="difflineplus">+      // 709  Arabic (ASMO-449+, BCON V4)</span>
<a href="#l23.528"></a><span id="l23.528" class="difflineplus">+      // 710  Arabic - Transparent Arabic</span>
<a href="#l23.529"></a><span id="l23.529" class="difflineplus">+      {720, &quot;DOS-720&quot;},   // Arabic (Transparent ASMO); Arabic (DOS)</span>
<a href="#l23.530"></a><span id="l23.530" class="difflineplus">+      {737, &quot;ibm737&quot;},    // OEM Greek (formerly 437G); Greek (DOS)</span>
<a href="#l23.531"></a><span id="l23.531" class="difflineplus">+      {775, &quot;ibm775&quot;},    // OEM Baltic; Baltic (DOS)</span>
<a href="#l23.532"></a><span id="l23.532" class="difflineplus">+      {850, &quot;ibm850&quot;},    // OEM Multilingual Latin 1; Western European (DOS)</span>
<a href="#l23.533"></a><span id="l23.533" class="difflineplus">+      {852, &quot;ibm852&quot;},    // OEM Latin 2; Central European (DOS)</span>
<a href="#l23.534"></a><span id="l23.534" class="difflineplus">+      {855, &quot;IBM855&quot;},    // OEM Cyrillic (primarily Russian)</span>
<a href="#l23.535"></a><span id="l23.535" class="difflineplus">+      {857, &quot;ibm857&quot;},    // OEM Turkish; Turkish (DOS)</span>
<a href="#l23.536"></a><span id="l23.536" class="difflineplus">+      {858, &quot;IBM00858&quot;},  // OEM Multilingual Latin 1 + Euro symbol</span>
<a href="#l23.537"></a><span id="l23.537" class="difflineplus">+      {860, &quot;IBM860&quot;},    // OEM Portuguese; Portuguese (DOS)</span>
<a href="#l23.538"></a><span id="l23.538" class="difflineplus">+      {861, &quot;ibm861&quot;},    // OEM Icelandic; Icelandic (DOS)</span>
<a href="#l23.539"></a><span id="l23.539" class="difflineplus">+      {862, &quot;DOS-862&quot;},   // OEM Hebrew; Hebrew (DOS)</span>
<a href="#l23.540"></a><span id="l23.540" class="difflineplus">+      {863, &quot;IBM863&quot;},    // OEM French Canadian; French Canadian (DOS)</span>
<a href="#l23.541"></a><span id="l23.541" class="difflineplus">+      {864, &quot;IBM864&quot;},    // OEM Arabic; Arabic (864)</span>
<a href="#l23.542"></a><span id="l23.542" class="difflineplus">+      {865, &quot;IBM865&quot;},    // OEM Nordic; Nordic (DOS)</span>
<a href="#l23.543"></a><span id="l23.543" class="difflineplus">+      {866, &quot;cp866&quot;},     // OEM Russian; Cyrillic (DOS)</span>
<a href="#l23.544"></a><span id="l23.544" class="difflineplus">+      {869, &quot;ibm869&quot;},    // OEM Modern Greek; Greek, Modern (DOS)</span>
<a href="#l23.545"></a><span id="l23.545" class="difflineplus">+      {870, &quot;IBM870&quot;},    // IBM EBCDIC Multilingual/ROECE (Latin 2); IBM EBCDIC</span>
<a href="#l23.546"></a><span id="l23.546" class="difflineplus">+                          // Multilingual Latin 2</span>
<a href="#l23.547"></a><span id="l23.547" class="difflineplus">+      {874, &quot;windows-874&quot;},  // ANSI/OEM Thai (same as 28605, ISO 8859-15); Thai</span>
<a href="#l23.548"></a><span id="l23.548" class="difflineplus">+                             // (Windows)</span>
<a href="#l23.549"></a><span id="l23.549" class="difflineplus">+      {875, &quot;cp875&quot;},        // IBM EBCDIC Greek Modern</span>
<a href="#l23.550"></a><span id="l23.550" class="difflineplus">+      {932, &quot;shift_jis&quot;},    // ANSI/OEM Japanese; Japanese (Shift-JIS)</span>
<a href="#l23.551"></a><span id="l23.551" class="difflineplus">+      {936, &quot;gb2312&quot;},  // ANSI/OEM Simplified Chinese (PRC, Singapore); Chinese</span>
<a href="#l23.552"></a><span id="l23.552" class="difflineplus">+                        // Simplified (GB2312)</span>
<a href="#l23.553"></a><span id="l23.553" class="difflineplus">+      {949, &quot;ks_c_5601-1987&quot;},  // ANSI/OEM Korean (Unified Hangul Code)</span>
<a href="#l23.554"></a><span id="l23.554" class="difflineplus">+      {950, &quot;big5&quot;},  // ANSI/OEM Traditional Chinese (Taiwan; Hong Kong SAR,</span>
<a href="#l23.555"></a><span id="l23.555" class="difflineplus">+                      // PRC); Chinese Traditional (Big5)</span>
<a href="#l23.556"></a><span id="l23.556" class="difflineplus">+      {1026, &quot;IBM1026&quot;},   // IBM EBCDIC Turkish (Latin 5)</span>
<a href="#l23.557"></a><span id="l23.557" class="difflineplus">+      {1047, &quot;IBM01047&quot;},  // IBM EBCDIC Latin 1/Open System</span>
<a href="#l23.558"></a><span id="l23.558" class="difflineplus">+      {1140, &quot;IBM01140&quot;},  // IBM EBCDIC US-Canada (037 + Euro symbol); IBM</span>
<a href="#l23.559"></a><span id="l23.559" class="difflineplus">+                           // EBCDIC (US-Canada-Euro)</span>
<a href="#l23.560"></a><span id="l23.560" class="difflineplus">+      {1141, &quot;IBM01141&quot;},  // IBM EBCDIC Germany (20273 + Euro symbol); IBM</span>
<a href="#l23.561"></a><span id="l23.561" class="difflineplus">+                           // EBCDIC (Germany-Euro)</span>
<a href="#l23.562"></a><span id="l23.562" class="difflineplus">+      {1142, &quot;IBM01142&quot;},  // IBM EBCDIC Denmark-Norway (20277 + Euro symbol);</span>
<a href="#l23.563"></a><span id="l23.563" class="difflineplus">+                           // IBM EBCDIC (Denmark-Norway-Euro)</span>
<a href="#l23.564"></a><span id="l23.564" class="difflineplus">+      {1143, &quot;IBM01143&quot;},  // IBM EBCDIC Finland-Sweden (20278 + Euro symbol);</span>
<a href="#l23.565"></a><span id="l23.565" class="difflineplus">+                           // IBM EBCDIC (Finland-Sweden-Euro)</span>
<a href="#l23.566"></a><span id="l23.566" class="difflineplus">+      {1144, &quot;IBM01144&quot;},  // IBM EBCDIC Italy (20280 + Euro symbol); IBM EBCDIC</span>
<a href="#l23.567"></a><span id="l23.567" class="difflineplus">+                           // (Italy-Euro)</span>
<a href="#l23.568"></a><span id="l23.568" class="difflineplus">+      {1145, &quot;IBM01145&quot;},  // IBM EBCDIC Latin America-Spain (20284 + Euro</span>
<a href="#l23.569"></a><span id="l23.569" class="difflineplus">+                           // symbol); IBM EBCDIC (Spain-Euro)</span>
<a href="#l23.570"></a><span id="l23.570" class="difflineplus">+      {1146, &quot;IBM01146&quot;},  // IBM EBCDIC United Kingdom (20285 + Euro symbol);</span>
<a href="#l23.571"></a><span id="l23.571" class="difflineplus">+                           // IBM EBCDIC (UK-Euro)</span>
<a href="#l23.572"></a><span id="l23.572" class="difflineplus">+      {1147, &quot;IBM01147&quot;},  // IBM EBCDIC France (20297 + Euro symbol); IBM</span>
<a href="#l23.573"></a><span id="l23.573" class="difflineplus">+                           // EBCDIC (France-Euro)</span>
<a href="#l23.574"></a><span id="l23.574" class="difflineplus">+      {1148, &quot;IBM01148&quot;},  // IBM EBCDIC International (500 + Euro symbol); IBM</span>
<a href="#l23.575"></a><span id="l23.575" class="difflineplus">+                           // EBCDIC (International-Euro)</span>
<a href="#l23.576"></a><span id="l23.576" class="difflineplus">+      {1149, &quot;IBM01149&quot;},  // IBM EBCDIC Icelandic (20871 + Euro symbol); IBM</span>
<a href="#l23.577"></a><span id="l23.577" class="difflineplus">+                           // EBCDIC (Icelandic-Euro)</span>
<a href="#l23.578"></a><span id="l23.578" class="difflineplus">+      {1200, &quot;utf-16&quot;},  // Unicode UTF-16, little endian byte order (BMP of ISO</span>
<a href="#l23.579"></a><span id="l23.579" class="difflineplus">+                         // 10646); available only to managed applications</span>
<a href="#l23.580"></a><span id="l23.580" class="difflineplus">+      {1201, &quot;unicodeFFFE&quot;},  // Unicode UTF-16, big endian byte order;</span>
<a href="#l23.581"></a><span id="l23.581" class="difflineplus">+                              // available only to managed applications</span>
<a href="#l23.582"></a><span id="l23.582" class="difflineplus">+      {1250,</span>
<a href="#l23.583"></a><span id="l23.583" class="difflineplus">+       &quot;windows-1250&quot;},  // ANSI Central European; Central European (Windows)</span>
<a href="#l23.584"></a><span id="l23.584" class="difflineplus">+      {1251, &quot;windows-1251&quot;},     // ANSI Cyrillic; Cyrillic (Windows)</span>
<a href="#l23.585"></a><span id="l23.585" class="difflineplus">+      {1252, &quot;windows-1252&quot;},     // ANSI Latin 1; Western European (Windows)</span>
<a href="#l23.586"></a><span id="l23.586" class="difflineplus">+      {1253, &quot;windows-1253&quot;},     // ANSI Greek; Greek (Windows)</span>
<a href="#l23.587"></a><span id="l23.587" class="difflineplus">+      {1254, &quot;windows-1254&quot;},     // ANSI Turkish; Turkish (Windows)</span>
<a href="#l23.588"></a><span id="l23.588" class="difflineplus">+      {1255, &quot;windows-1255&quot;},     // ANSI Hebrew; Hebrew (Windows)</span>
<a href="#l23.589"></a><span id="l23.589" class="difflineplus">+      {1256, &quot;windows-1256&quot;},     // ANSI Arabic; Arabic (Windows)</span>
<a href="#l23.590"></a><span id="l23.590" class="difflineplus">+      {1257, &quot;windows-1257&quot;},     // ANSI Baltic; Baltic (Windows)</span>
<a href="#l23.591"></a><span id="l23.591" class="difflineplus">+      {1258, &quot;windows-1258&quot;},     // ANSI/OEM Vietnamese; Vietnamese (Windows)</span>
<a href="#l23.592"></a><span id="l23.592" class="difflineplus">+      {1361, &quot;Johab&quot;},            // Korean (Johab)</span>
<a href="#l23.593"></a><span id="l23.593" class="difflineplus">+      {10000, &quot;macintosh&quot;},       // MAC Roman; Western European (Mac)</span>
<a href="#l23.594"></a><span id="l23.594" class="difflineplus">+      {10001, &quot;x-mac-japanese&quot;},  // Japanese (Mac)</span>
<a href="#l23.595"></a><span id="l23.595" class="difflineplus">+      {10002, &quot;x-mac-chinesetrad&quot;},  // MAC Traditional Chinese (Big5); Chinese</span>
<a href="#l23.596"></a><span id="l23.596" class="difflineplus">+                                     // Traditional (Mac)</span>
<a href="#l23.597"></a><span id="l23.597" class="difflineplus">+      {10003, &quot;x-mac-korean&quot;},       // Korean (Mac)</span>
<a href="#l23.598"></a><span id="l23.598" class="difflineplus">+      {10004, &quot;x-mac-arabic&quot;},       // Arabic (Mac)</span>
<a href="#l23.599"></a><span id="l23.599" class="difflineplus">+      {10005, &quot;x-mac-hebrew&quot;},       // Hebrew (Mac)</span>
<a href="#l23.600"></a><span id="l23.600" class="difflineplus">+      {10006, &quot;x-mac-greek&quot;},        // Greek (Mac)</span>
<a href="#l23.601"></a><span id="l23.601" class="difflineplus">+      {10007, &quot;x-mac-cyrillic&quot;},     // Cyrillic (Mac)</span>
<a href="#l23.602"></a><span id="l23.602" class="difflineplus">+      {10008, &quot;x-mac-chinesesimp&quot;},  // MAC Simplified Chinese (GB 2312);</span>
<a href="#l23.603"></a><span id="l23.603" class="difflineplus">+                                     // Chinese Simplified (Mac)</span>
<a href="#l23.604"></a><span id="l23.604" class="difflineplus">+      {10010, &quot;x-mac-romanian&quot;},     // Romanian (Mac)</span>
<a href="#l23.605"></a><span id="l23.605" class="difflineplus">+      {10017, &quot;x-mac-ukrainian&quot;},    // Ukrainian (Mac)</span>
<a href="#l23.606"></a><span id="l23.606" class="difflineplus">+      {10021, &quot;x-mac-thai&quot;},         // Thai (Mac)</span>
<a href="#l23.607"></a><span id="l23.607" class="difflineplus">+      {10029, &quot;x-mac-ce&quot;},           // MAC Latin 2; Central European (Mac)</span>
<a href="#l23.608"></a><span id="l23.608" class="difflineplus">+      {10079, &quot;x-mac-icelandic&quot;},    // Icelandic (Mac)</span>
<a href="#l23.609"></a><span id="l23.609" class="difflineplus">+      {10081, &quot;x-mac-turkish&quot;},      // Turkish (Mac)</span>
<a href="#l23.610"></a><span id="l23.610" class="difflineplus">+      {10082, &quot;x-mac-croatian&quot;},     // Croatian (Mac)</span>
<a href="#l23.611"></a><span id="l23.611" class="difflineplus">+      // Unicode UTF-32, little endian byte order; available only to managed</span>
<a href="#l23.612"></a><span id="l23.612" class="difflineplus">+      // applications impossible in 8-bit mail</span>
<a href="#l23.613"></a><span id="l23.613">       {12000, &quot;utf-32&quot;},</span>
<a href="#l23.614"></a><span id="l23.614" class="difflineminus">-       // Unicode UTF-32, big endian byte order; available only to managed applications</span>
<a href="#l23.615"></a><span id="l23.615" class="difflineminus">-       // impossible in 8-bit mail</span>
<a href="#l23.616"></a><span id="l23.616" class="difflineplus">+      // Unicode UTF-32, big endian byte order; available only to managed</span>
<a href="#l23.617"></a><span id="l23.617" class="difflineplus">+      // applications impossible in 8-bit mail</span>
<a href="#l23.618"></a><span id="l23.618">       {12001, &quot;utf-32BE&quot;},</span>
<a href="#l23.619"></a><span id="l23.619" class="difflineminus">-      {20000, &quot;x-Chinese_CNS&quot;}, // CNS Taiwan; Chinese Traditional (CNS)</span>
<a href="#l23.620"></a><span id="l23.620" class="difflineminus">-      {20001, &quot;x-cp20001&quot;}, // TCA Taiwan</span>
<a href="#l23.621"></a><span id="l23.621" class="difflineminus">-      {20002, &quot;x_Chinese-Eten&quot;}, // Eten Taiwan; Chinese Traditional (Eten)</span>
<a href="#l23.622"></a><span id="l23.622" class="difflineminus">-      {20003, &quot;x-cp20003&quot;}, // IBM5550 Taiwan</span>
<a href="#l23.623"></a><span id="l23.623" class="difflineminus">-      {20004, &quot;x-cp20004&quot;}, // TeleText Taiwan</span>
<a href="#l23.624"></a><span id="l23.624" class="difflineminus">-      {20005, &quot;x-cp20005&quot;}, // Wang Taiwan</span>
<a href="#l23.625"></a><span id="l23.625" class="difflineminus">-      {20105, &quot;x-IA5&quot;}, // IA5 (IRV International Alphabet No. 5, 7-bit); Western European (IA5)</span>
<a href="#l23.626"></a><span id="l23.626" class="difflineminus">-      {20106, &quot;x-IA5-German&quot;}, // IA5 German (7-bit)</span>
<a href="#l23.627"></a><span id="l23.627" class="difflineminus">-      {20107, &quot;x-IA5-Swedish&quot;}, // IA5 Swedish (7-bit)</span>
<a href="#l23.628"></a><span id="l23.628" class="difflineminus">-      {20108, &quot;x-IA5-Norwegian&quot;}, // IA5 Norwegian (7-bit)</span>
<a href="#l23.629"></a><span id="l23.629" class="difflineminus">-      {20127, &quot;us-ascii&quot;}, // US-ASCII (7-bit)</span>
<a href="#l23.630"></a><span id="l23.630" class="difflineminus">-      {20261, &quot;x-cp20261&quot;}, // T.61</span>
<a href="#l23.631"></a><span id="l23.631" class="difflineminus">-      {20269, &quot;x-cp20269&quot;}, // ISO 6937 Non-Spacing Accent</span>
<a href="#l23.632"></a><span id="l23.632" class="difflineminus">-      {20273, &quot;IBM273&quot;}, // IBM EBCDIC Germany</span>
<a href="#l23.633"></a><span id="l23.633" class="difflineminus">-      {20277, &quot;IBM277&quot;}, // IBM EBCDIC Denmark-Norway</span>
<a href="#l23.634"></a><span id="l23.634" class="difflineminus">-      {20278, &quot;IBM278&quot;}, // IBM EBCDIC Finland-Sweden</span>
<a href="#l23.635"></a><span id="l23.635" class="difflineminus">-      {20280, &quot;IBM280&quot;}, // IBM EBCDIC Italy</span>
<a href="#l23.636"></a><span id="l23.636" class="difflineminus">-      {20284, &quot;IBM284&quot;}, // IBM EBCDIC Latin America-Spain</span>
<a href="#l23.637"></a><span id="l23.637" class="difflineminus">-      {20285, &quot;IBM285&quot;}, // IBM EBCDIC United Kingdom</span>
<a href="#l23.638"></a><span id="l23.638" class="difflineminus">-      {20290, &quot;IBM290&quot;}, // IBM EBCDIC Japanese Katakana Extended</span>
<a href="#l23.639"></a><span id="l23.639" class="difflineminus">-      {20297, &quot;IBM297&quot;}, // IBM EBCDIC France</span>
<a href="#l23.640"></a><span id="l23.640" class="difflineminus">-      {20420, &quot;IBM420&quot;}, // IBM EBCDIC Arabic</span>
<a href="#l23.641"></a><span id="l23.641" class="difflineminus">-      {20423, &quot;IBM423&quot;}, // IBM EBCDIC Greek</span>
<a href="#l23.642"></a><span id="l23.642" class="difflineminus">-      {20424, &quot;IBM424&quot;}, // IBM EBCDIC Hebrew</span>
<a href="#l23.643"></a><span id="l23.643" class="difflineminus">-      {20833, &quot;x-EBCDIC-KoreanExtended&quot;}, // IBM EBCDIC Korean Extended</span>
<a href="#l23.644"></a><span id="l23.644" class="difflineminus">-      {20838, &quot;IBM-Thai&quot;}, // IBM EBCDIC Thai</span>
<a href="#l23.645"></a><span id="l23.645" class="difflineminus">-      {20866, &quot;koi8-r&quot;}, // Russian (KOI8-R); Cyrillic (KOI8-R)</span>
<a href="#l23.646"></a><span id="l23.646" class="difflineminus">-      {20871, &quot;IBM871&quot;}, // IBM EBCDIC Icelandic</span>
<a href="#l23.647"></a><span id="l23.647" class="difflineminus">-      {20880, &quot;IBM880&quot;}, // IBM EBCDIC Cyrillic Russian</span>
<a href="#l23.648"></a><span id="l23.648" class="difflineminus">-      {20905, &quot;IBM905&quot;}, // IBM EBCDIC Turkish</span>
<a href="#l23.649"></a><span id="l23.649" class="difflineminus">-      {20924, &quot;IBM00924&quot;}, // IBM EBCDIC Latin 1/Open System (1047 + Euro symbol)</span>
<a href="#l23.650"></a><span id="l23.650" class="difflineminus">-      {20932, &quot;EUC-JP&quot;}, // Japanese (JIS 0208-1990 and 0121-1990)</span>
<a href="#l23.651"></a><span id="l23.651" class="difflineminus">-      {20936, &quot;x-cp20936&quot;}, // Simplified Chinese (GB2312); Chinese Simplified (GB2312-80)</span>
<a href="#l23.652"></a><span id="l23.652" class="difflineminus">-      {20949, &quot;x-cp20949&quot;}, // Korean Wansung</span>
<a href="#l23.653"></a><span id="l23.653" class="difflineminus">-      {21025, &quot;cp1025&quot;}, // IBM EBCDIC Cyrillic Serbian-Bulgarian</span>
<a href="#l23.654"></a><span id="l23.654" class="difflineminus">-      //21027  (deprecated)</span>
<a href="#l23.655"></a><span id="l23.655" class="difflineminus">-      {21866, &quot;koi8-u&quot;}, // Ukrainian (KOI8-U); Cyrillic (KOI8-U)</span>
<a href="#l23.656"></a><span id="l23.656" class="difflineminus">-      {28591, &quot;iso-8859-1&quot;}, // ISO 8859-1 Latin 1; Western European (ISO)</span>
<a href="#l23.657"></a><span id="l23.657" class="difflineminus">-      {28592, &quot;iso-8859-2&quot;}, // ISO 8859-2 Central European; Central European (ISO)</span>
<a href="#l23.658"></a><span id="l23.658" class="difflineminus">-      {28593, &quot;iso-8859-3&quot;}, // ISO 8859-3 Latin 3</span>
<a href="#l23.659"></a><span id="l23.659" class="difflineminus">-      {28594, &quot;iso-8859-4&quot;}, // ISO 8859-4 Baltic</span>
<a href="#l23.660"></a><span id="l23.660" class="difflineminus">-      {28595, &quot;iso-8859-5&quot;}, // ISO 8859-5 Cyrillic</span>
<a href="#l23.661"></a><span id="l23.661" class="difflineminus">-      {28596, &quot;iso-8859-6&quot;}, // ISO 8859-6 Arabic</span>
<a href="#l23.662"></a><span id="l23.662" class="difflineminus">-      {28597, &quot;iso-8859-7&quot;}, // ISO 8859-7 Greek</span>
<a href="#l23.663"></a><span id="l23.663" class="difflineminus">-      {28598, &quot;iso-8859-8&quot;}, // ISO 8859-8 Hebrew; Hebrew (ISO-Visual)</span>
<a href="#l23.664"></a><span id="l23.664" class="difflineminus">-      {28599, &quot;iso-8859-9&quot;}, // ISO 8859-9 Turkish</span>
<a href="#l23.665"></a><span id="l23.665" class="difflineminus">-      {28603, &quot;iso-8859-13&quot;}, // ISO 8859-13 Estonian</span>
<a href="#l23.666"></a><span id="l23.666" class="difflineminus">-      {28605, &quot;iso-8859-15&quot;}, // ISO 8859-15 Latin 9</span>
<a href="#l23.667"></a><span id="l23.667" class="difflineminus">-      {29001, &quot;x-Europa&quot;}, // Europa 3</span>
<a href="#l23.668"></a><span id="l23.668" class="difflineminus">-      {38598, &quot;iso-8859-8-i&quot;}, // ISO 8859-8 Hebrew; Hebrew (ISO-Logical)</span>
<a href="#l23.669"></a><span id="l23.669" class="difflineminus">-      {50220, &quot;iso-2022-jp&quot;}, // ISO 2022 Japanese with no halfwidth Katakana; Japanese (JIS)</span>
<a href="#l23.670"></a><span id="l23.670" class="difflineminus">-      {50221, &quot;csISO2022JP&quot;}, // ISO 2022 Japanese with halfwidth Katakana; Japanese (JIS-Allow 1 byte Kana)</span>
<a href="#l23.671"></a><span id="l23.671" class="difflineminus">-      {50222, &quot;iso-2022-jp&quot;}, // ISO 2022 Japanese JIS X 0201-1989; Japanese (JIS-Allow 1 byte Kana - SO/SI)</span>
<a href="#l23.672"></a><span id="l23.672" class="difflineminus">-      {50225, &quot;iso-2022-kr&quot;}, // ISO 2022 Korean</span>
<a href="#l23.673"></a><span id="l23.673" class="difflineminus">-      {50227, &quot;x-cp50227&quot;}, // ISO 2022 Simplified Chinese; Chinese Simplified (ISO 2022)</span>
<a href="#l23.674"></a><span id="l23.674" class="difflineminus">-      //50229  ISO 2022 Traditional Chinese</span>
<a href="#l23.675"></a><span id="l23.675" class="difflineminus">-      //50930  EBCDIC Japanese (Katakana) Extended</span>
<a href="#l23.676"></a><span id="l23.676" class="difflineminus">-      //50931  EBCDIC US-Canada and Japanese</span>
<a href="#l23.677"></a><span id="l23.677" class="difflineminus">-      //50933  EBCDIC Korean Extended and Korean</span>
<a href="#l23.678"></a><span id="l23.678" class="difflineminus">-      //50935  EBCDIC Simplified Chinese Extended and Simplified Chinese</span>
<a href="#l23.679"></a><span id="l23.679" class="difflineminus">-      //50936  EBCDIC Simplified Chinese</span>
<a href="#l23.680"></a><span id="l23.680" class="difflineminus">-      //50937  EBCDIC US-Canada and Traditional Chinese</span>
<a href="#l23.681"></a><span id="l23.681" class="difflineminus">-      //50939  EBCDIC Japanese (Latin) Extended and Japanese</span>
<a href="#l23.682"></a><span id="l23.682" class="difflineminus">-      {51932, &quot;euc-jp&quot;}, // EUC Japanese</span>
<a href="#l23.683"></a><span id="l23.683" class="difflineminus">-      {51936, &quot;EUC-CN&quot;}, // EUC Simplified Chinese; Chinese Simplified (EUC)</span>
<a href="#l23.684"></a><span id="l23.684" class="difflineminus">-      {51949, &quot;euc-kr&quot;}, // EUC Korean</span>
<a href="#l23.685"></a><span id="l23.685" class="difflineminus">-      //51950  EUC Traditional Chinese</span>
<a href="#l23.686"></a><span id="l23.686" class="difflineminus">-      {52936, &quot;hz-gb-2312&quot;}, // HZ-GB2312 Simplified Chinese; Chinese Simplified (HZ)</span>
<a href="#l23.687"></a><span id="l23.687" class="difflineminus">-      {54936, &quot;GB18030&quot;}, // Windows XP and later: GB18030 Simplified Chinese (4 byte); Chinese Simplified (GB18030)</span>
<a href="#l23.688"></a><span id="l23.688" class="difflineminus">-      {57002, &quot;x-iscii-de&quot;}, // ISCII Devanagari</span>
<a href="#l23.689"></a><span id="l23.689" class="difflineminus">-      {57003, &quot;x-iscii-be&quot;}, // ISCII Bengali</span>
<a href="#l23.690"></a><span id="l23.690" class="difflineminus">-      {57004, &quot;x-iscii-ta&quot;}, // ISCII Tamil</span>
<a href="#l23.691"></a><span id="l23.691" class="difflineminus">-      {57005, &quot;x-iscii-te&quot;}, // ISCII Telugu</span>
<a href="#l23.692"></a><span id="l23.692" class="difflineminus">-      {57006, &quot;x-iscii-as&quot;}, // ISCII Assamese</span>
<a href="#l23.693"></a><span id="l23.693" class="difflineminus">-      {57007, &quot;x-iscii-or&quot;}, // ISCII Oriya (Odia)</span>
<a href="#l23.694"></a><span id="l23.694" class="difflineminus">-      {57008, &quot;x-iscii-ka&quot;}, // ISCII Kannada</span>
<a href="#l23.695"></a><span id="l23.695" class="difflineminus">-      {57009, &quot;x-iscii-ma&quot;}, // ISCII Malayalam</span>
<a href="#l23.696"></a><span id="l23.696" class="difflineminus">-      {57010, &quot;x-iscii-gu&quot;}, // ISCII Gujarati</span>
<a href="#l23.697"></a><span id="l23.697" class="difflineminus">-      {57011, &quot;x-iscii-pa&quot;}, // ISCII Punjabi</span>
<a href="#l23.698"></a><span id="l23.698" class="difflineminus">-      {65000, &quot;utf-7&quot;}, // Unicode (UTF-7)</span>
<a href="#l23.699"></a><span id="l23.699" class="difflineminus">-      {65001, &quot;utf-8&quot;}, // Unicode (UTF-8)</span>
<a href="#l23.700"></a><span id="l23.700" class="difflineminus">-    };</span>
<a href="#l23.701"></a><span id="l23.701" class="difflineplus">+      {20000, &quot;x-Chinese_CNS&quot;},   // CNS Taiwan; Chinese Traditional (CNS)</span>
<a href="#l23.702"></a><span id="l23.702" class="difflineplus">+      {20001, &quot;x-cp20001&quot;},       // TCA Taiwan</span>
<a href="#l23.703"></a><span id="l23.703" class="difflineplus">+      {20002, &quot;x_Chinese-Eten&quot;},  // Eten Taiwan; Chinese Traditional (Eten)</span>
<a href="#l23.704"></a><span id="l23.704" class="difflineplus">+      {20003, &quot;x-cp20003&quot;},       // IBM5550 Taiwan</span>
<a href="#l23.705"></a><span id="l23.705" class="difflineplus">+      {20004, &quot;x-cp20004&quot;},       // TeleText Taiwan</span>
<a href="#l23.706"></a><span id="l23.706" class="difflineplus">+      {20005, &quot;x-cp20005&quot;},       // Wang Taiwan</span>
<a href="#l23.707"></a><span id="l23.707" class="difflineplus">+      {20105, &quot;x-IA5&quot;},  // IA5 (IRV International Alphabet No. 5, 7-bit);</span>
<a href="#l23.708"></a><span id="l23.708" class="difflineplus">+                         // Western European (IA5)</span>
<a href="#l23.709"></a><span id="l23.709" class="difflineplus">+      {20106, &quot;x-IA5-German&quot;},     // IA5 German (7-bit)</span>
<a href="#l23.710"></a><span id="l23.710" class="difflineplus">+      {20107, &quot;x-IA5-Swedish&quot;},    // IA5 Swedish (7-bit)</span>
<a href="#l23.711"></a><span id="l23.711" class="difflineplus">+      {20108, &quot;x-IA5-Norwegian&quot;},  // IA5 Norwegian (7-bit)</span>
<a href="#l23.712"></a><span id="l23.712" class="difflineplus">+      {20127, &quot;us-ascii&quot;},         // US-ASCII (7-bit)</span>
<a href="#l23.713"></a><span id="l23.713" class="difflineplus">+      {20261, &quot;x-cp20261&quot;},        // T.61</span>
<a href="#l23.714"></a><span id="l23.714" class="difflineplus">+      {20269, &quot;x-cp20269&quot;},        // ISO 6937 Non-Spacing Accent</span>
<a href="#l23.715"></a><span id="l23.715" class="difflineplus">+      {20273, &quot;IBM273&quot;},           // IBM EBCDIC Germany</span>
<a href="#l23.716"></a><span id="l23.716" class="difflineplus">+      {20277, &quot;IBM277&quot;},           // IBM EBCDIC Denmark-Norway</span>
<a href="#l23.717"></a><span id="l23.717" class="difflineplus">+      {20278, &quot;IBM278&quot;},           // IBM EBCDIC Finland-Sweden</span>
<a href="#l23.718"></a><span id="l23.718" class="difflineplus">+      {20280, &quot;IBM280&quot;},           // IBM EBCDIC Italy</span>
<a href="#l23.719"></a><span id="l23.719" class="difflineplus">+      {20284, &quot;IBM284&quot;},           // IBM EBCDIC Latin America-Spain</span>
<a href="#l23.720"></a><span id="l23.720" class="difflineplus">+      {20285, &quot;IBM285&quot;},           // IBM EBCDIC United Kingdom</span>
<a href="#l23.721"></a><span id="l23.721" class="difflineplus">+      {20290, &quot;IBM290&quot;},           // IBM EBCDIC Japanese Katakana Extended</span>
<a href="#l23.722"></a><span id="l23.722" class="difflineplus">+      {20297, &quot;IBM297&quot;},           // IBM EBCDIC France</span>
<a href="#l23.723"></a><span id="l23.723" class="difflineplus">+      {20420, &quot;IBM420&quot;},           // IBM EBCDIC Arabic</span>
<a href="#l23.724"></a><span id="l23.724" class="difflineplus">+      {20423, &quot;IBM423&quot;},           // IBM EBCDIC Greek</span>
<a href="#l23.725"></a><span id="l23.725" class="difflineplus">+      {20424, &quot;IBM424&quot;},           // IBM EBCDIC Hebrew</span>
<a href="#l23.726"></a><span id="l23.726" class="difflineplus">+      {20833, &quot;x-EBCDIC-KoreanExtended&quot;},  // IBM EBCDIC Korean Extended</span>
<a href="#l23.727"></a><span id="l23.727" class="difflineplus">+      {20838, &quot;IBM-Thai&quot;},                 // IBM EBCDIC Thai</span>
<a href="#l23.728"></a><span id="l23.728" class="difflineplus">+      {20866, &quot;koi8-r&quot;},  // Russian (KOI8-R); Cyrillic (KOI8-R)</span>
<a href="#l23.729"></a><span id="l23.729" class="difflineplus">+      {20871, &quot;IBM871&quot;},  // IBM EBCDIC Icelandic</span>
<a href="#l23.730"></a><span id="l23.730" class="difflineplus">+      {20880, &quot;IBM880&quot;},  // IBM EBCDIC Cyrillic Russian</span>
<a href="#l23.731"></a><span id="l23.731" class="difflineplus">+      {20905, &quot;IBM905&quot;},  // IBM EBCDIC Turkish</span>
<a href="#l23.732"></a><span id="l23.732" class="difflineplus">+      {20924,</span>
<a href="#l23.733"></a><span id="l23.733" class="difflineplus">+       &quot;IBM00924&quot;},       // IBM EBCDIC Latin 1/Open System (1047 + Euro symbol)</span>
<a href="#l23.734"></a><span id="l23.734" class="difflineplus">+      {20932, &quot;EUC-JP&quot;},  // Japanese (JIS 0208-1990 and 0121-1990)</span>
<a href="#l23.735"></a><span id="l23.735" class="difflineplus">+      {20936, &quot;x-cp20936&quot;},  // Simplified Chinese (GB2312); Chinese Simplified</span>
<a href="#l23.736"></a><span id="l23.736" class="difflineplus">+                             // (GB2312-80)</span>
<a href="#l23.737"></a><span id="l23.737" class="difflineplus">+      {20949, &quot;x-cp20949&quot;},  // Korean Wansung</span>
<a href="#l23.738"></a><span id="l23.738" class="difflineplus">+      {21025, &quot;cp1025&quot;},     // IBM EBCDIC Cyrillic Serbian-Bulgarian</span>
<a href="#l23.739"></a><span id="l23.739" class="difflineplus">+      // 21027  (deprecated)</span>
<a href="#l23.740"></a><span id="l23.740" class="difflineplus">+      {21866, &quot;koi8-u&quot;},      // Ukrainian (KOI8-U); Cyrillic (KOI8-U)</span>
<a href="#l23.741"></a><span id="l23.741" class="difflineplus">+      {28591, &quot;iso-8859-1&quot;},  // ISO 8859-1 Latin 1; Western European (ISO)</span>
<a href="#l23.742"></a><span id="l23.742" class="difflineplus">+      {28592,</span>
<a href="#l23.743"></a><span id="l23.743" class="difflineplus">+       &quot;iso-8859-2&quot;},  // ISO 8859-2 Central European; Central European (ISO)</span>
<a href="#l23.744"></a><span id="l23.744" class="difflineplus">+      {28593, &quot;iso-8859-3&quot;},    // ISO 8859-3 Latin 3</span>
<a href="#l23.745"></a><span id="l23.745" class="difflineplus">+      {28594, &quot;iso-8859-4&quot;},    // ISO 8859-4 Baltic</span>
<a href="#l23.746"></a><span id="l23.746" class="difflineplus">+      {28595, &quot;iso-8859-5&quot;},    // ISO 8859-5 Cyrillic</span>
<a href="#l23.747"></a><span id="l23.747" class="difflineplus">+      {28596, &quot;iso-8859-6&quot;},    // ISO 8859-6 Arabic</span>
<a href="#l23.748"></a><span id="l23.748" class="difflineplus">+      {28597, &quot;iso-8859-7&quot;},    // ISO 8859-7 Greek</span>
<a href="#l23.749"></a><span id="l23.749" class="difflineplus">+      {28598, &quot;iso-8859-8&quot;},    // ISO 8859-8 Hebrew; Hebrew (ISO-Visual)</span>
<a href="#l23.750"></a><span id="l23.750" class="difflineplus">+      {28599, &quot;iso-8859-9&quot;},    // ISO 8859-9 Turkish</span>
<a href="#l23.751"></a><span id="l23.751" class="difflineplus">+      {28603, &quot;iso-8859-13&quot;},   // ISO 8859-13 Estonian</span>
<a href="#l23.752"></a><span id="l23.752" class="difflineplus">+      {28605, &quot;iso-8859-15&quot;},   // ISO 8859-15 Latin 9</span>
<a href="#l23.753"></a><span id="l23.753" class="difflineplus">+      {29001, &quot;x-Europa&quot;},      // Europa 3</span>
<a href="#l23.754"></a><span id="l23.754" class="difflineplus">+      {38598, &quot;iso-8859-8-i&quot;},  // ISO 8859-8 Hebrew; Hebrew (ISO-Logical)</span>
<a href="#l23.755"></a><span id="l23.755" class="difflineplus">+      {50220, &quot;iso-2022-jp&quot;},   // ISO 2022 Japanese with no halfwidth Katakana;</span>
<a href="#l23.756"></a><span id="l23.756" class="difflineplus">+                                // Japanese (JIS)</span>
<a href="#l23.757"></a><span id="l23.757" class="difflineplus">+      {50221, &quot;csISO2022JP&quot;},   // ISO 2022 Japanese with halfwidth Katakana;</span>
<a href="#l23.758"></a><span id="l23.758" class="difflineplus">+                                // Japanese (JIS-Allow 1 byte Kana)</span>
<a href="#l23.759"></a><span id="l23.759" class="difflineplus">+      {50222, &quot;iso-2022-jp&quot;},   // ISO 2022 Japanese JIS X 0201-1989; Japanese</span>
<a href="#l23.760"></a><span id="l23.760" class="difflineplus">+                                // (JIS-Allow 1 byte Kana - SO/SI)</span>
<a href="#l23.761"></a><span id="l23.761" class="difflineplus">+      {50225, &quot;iso-2022-kr&quot;},   // ISO 2022 Korean</span>
<a href="#l23.762"></a><span id="l23.762" class="difflineplus">+      {50227, &quot;x-cp50227&quot;},  // ISO 2022 Simplified Chinese; Chinese Simplified</span>
<a href="#l23.763"></a><span id="l23.763" class="difflineplus">+                             // (ISO 2022)</span>
<a href="#l23.764"></a><span id="l23.764" class="difflineplus">+      // 50229  ISO 2022 Traditional Chinese</span>
<a href="#l23.765"></a><span id="l23.765" class="difflineplus">+      // 50930  EBCDIC Japanese (Katakana) Extended</span>
<a href="#l23.766"></a><span id="l23.766" class="difflineplus">+      // 50931  EBCDIC US-Canada and Japanese</span>
<a href="#l23.767"></a><span id="l23.767" class="difflineplus">+      // 50933  EBCDIC Korean Extended and Korean</span>
<a href="#l23.768"></a><span id="l23.768" class="difflineplus">+      // 50935  EBCDIC Simplified Chinese Extended and Simplified Chinese</span>
<a href="#l23.769"></a><span id="l23.769" class="difflineplus">+      // 50936  EBCDIC Simplified Chinese</span>
<a href="#l23.770"></a><span id="l23.770" class="difflineplus">+      // 50937  EBCDIC US-Canada and Traditional Chinese</span>
<a href="#l23.771"></a><span id="l23.771" class="difflineplus">+      // 50939  EBCDIC Japanese (Latin) Extended and Japanese</span>
<a href="#l23.772"></a><span id="l23.772" class="difflineplus">+      {51932, &quot;euc-jp&quot;},  // EUC Japanese</span>
<a href="#l23.773"></a><span id="l23.773" class="difflineplus">+      {51936, &quot;EUC-CN&quot;},  // EUC Simplified Chinese; Chinese Simplified (EUC)</span>
<a href="#l23.774"></a><span id="l23.774" class="difflineplus">+      {51949, &quot;euc-kr&quot;},  // EUC Korean</span>
<a href="#l23.775"></a><span id="l23.775" class="difflineplus">+      // 51950  EUC Traditional Chinese</span>
<a href="#l23.776"></a><span id="l23.776" class="difflineplus">+      {52936,</span>
<a href="#l23.777"></a><span id="l23.777" class="difflineplus">+       &quot;hz-gb-2312&quot;},  // HZ-GB2312 Simplified Chinese; Chinese Simplified (HZ)</span>
<a href="#l23.778"></a><span id="l23.778" class="difflineplus">+      {54936, &quot;GB18030&quot;},  // Windows XP and later: GB18030 Simplified Chinese</span>
<a href="#l23.779"></a><span id="l23.779" class="difflineplus">+                           // (4 byte); Chinese Simplified (GB18030)</span>
<a href="#l23.780"></a><span id="l23.780" class="difflineplus">+      {57002, &quot;x-iscii-de&quot;},  // ISCII Devanagari</span>
<a href="#l23.781"></a><span id="l23.781" class="difflineplus">+      {57003, &quot;x-iscii-be&quot;},  // ISCII Bengali</span>
<a href="#l23.782"></a><span id="l23.782" class="difflineplus">+      {57004, &quot;x-iscii-ta&quot;},  // ISCII Tamil</span>
<a href="#l23.783"></a><span id="l23.783" class="difflineplus">+      {57005, &quot;x-iscii-te&quot;},  // ISCII Telugu</span>
<a href="#l23.784"></a><span id="l23.784" class="difflineplus">+      {57006, &quot;x-iscii-as&quot;},  // ISCII Assamese</span>
<a href="#l23.785"></a><span id="l23.785" class="difflineplus">+      {57007, &quot;x-iscii-or&quot;},  // ISCII Oriya (Odia)</span>
<a href="#l23.786"></a><span id="l23.786" class="difflineplus">+      {57008, &quot;x-iscii-ka&quot;},  // ISCII Kannada</span>
<a href="#l23.787"></a><span id="l23.787" class="difflineplus">+      {57009, &quot;x-iscii-ma&quot;},  // ISCII Malayalam</span>
<a href="#l23.788"></a><span id="l23.788" class="difflineplus">+      {57010, &quot;x-iscii-gu&quot;},  // ISCII Gujarati</span>
<a href="#l23.789"></a><span id="l23.789" class="difflineplus">+      {57011, &quot;x-iscii-pa&quot;},  // ISCII Punjabi</span>
<a href="#l23.790"></a><span id="l23.790" class="difflineplus">+      {65000, &quot;utf-7&quot;},       // Unicode (UTF-7)</span>
<a href="#l23.791"></a><span id="l23.791" class="difflineplus">+      {65001, &quot;utf-8&quot;},       // Unicode (UTF-8)</span>
<a href="#l23.792"></a><span id="l23.792" class="difflineplus">+  };</span>
<a href="#l23.793"></a><span id="l23.793"> </span>
<a href="#l23.794"></a><span id="l23.794">   // Binary search</span>
<a href="#l23.795"></a><span id="l23.795" class="difflineminus">-  int begin = 0, end = sizeof(cptocharset)/sizeof(cptocharset[0])-1;</span>
<a href="#l23.796"></a><span id="l23.796" class="difflineplus">+  int begin = 0, end = sizeof(cptocharset) / sizeof(cptocharset[0]) - 1;</span>
<a href="#l23.797"></a><span id="l23.797">   while (begin &lt;= end) {</span>
<a href="#l23.798"></a><span id="l23.798" class="difflineminus">-    int mid = (begin+end)/2;</span>
<a href="#l23.799"></a><span id="l23.799" class="difflineplus">+    int mid = (begin + end) / 2;</span>
<a href="#l23.800"></a><span id="l23.800">     unsigned int mid_cp = cptocharset[mid].cp;</span>
<a href="#l23.801"></a><span id="l23.801" class="difflineminus">-    if (cp == mid_cp)</span>
<a href="#l23.802"></a><span id="l23.802" class="difflineminus">-      return cptocharset[mid].charset;</span>
<a href="#l23.803"></a><span id="l23.803" class="difflineplus">+    if (cp == mid_cp) return cptocharset[mid].charset;</span>
<a href="#l23.804"></a><span id="l23.804">     if (cp &lt; mid_cp)</span>
<a href="#l23.805"></a><span id="l23.805">       end = mid - 1;</span>
<a href="#l23.806"></a><span id="l23.806" class="difflineminus">-    else // cp &gt; cptocharset[mid].cp</span>
<a href="#l23.807"></a><span id="l23.807" class="difflineplus">+    else  // cp &gt; cptocharset[mid].cp</span>
<a href="#l23.808"></a><span id="l23.808">       begin = mid + 1;</span>
<a href="#l23.809"></a><span id="l23.809">   }</span>
<a href="#l23.810"></a><span id="l23.810" class="difflineminus">-  return 0; // not found</span>
<a href="#l23.811"></a><span id="l23.811" class="difflineplus">+  return 0;  // not found</span>
<a href="#l23.812"></a><span id="l23.812"> }</span>
<a href="#l23.813"></a><span id="l23.813"> </span>
<a href="#l23.814"></a><span id="l23.814"> // This function returns true only if the unicode (utf-16) text can be</span>
<a href="#l23.815"></a><span id="l23.815"> // losslessly represented in specified charset</span>
<a href="#l23.816"></a><span id="l23.816" class="difflineminus">-bool CMapiMessage::CheckBodyInCharsetRange(const char* charset)</span>
<a href="#l23.817"></a><span id="l23.817" class="difflineminus">-{</span>
<a href="#l23.818"></a><span id="l23.818" class="difflineminus">-  if (m_body.IsEmpty())</span>
<a href="#l23.819"></a><span id="l23.819" class="difflineminus">-    return true;</span>
<a href="#l23.820"></a><span id="l23.820" class="difflineminus">-  if (!_stricmp(charset, &quot;utf-8&quot;))</span>
<a href="#l23.821"></a><span id="l23.821" class="difflineminus">-    return true;</span>
<a href="#l23.822"></a><span id="l23.822" class="difflineplus">+bool CMapiMessage::CheckBodyInCharsetRange(const char* charset) {</span>
<a href="#l23.823"></a><span id="l23.823" class="difflineplus">+  if (m_body.IsEmpty()) return true;</span>
<a href="#l23.824"></a><span id="l23.824" class="difflineplus">+  if (!_stricmp(charset, &quot;utf-8&quot;)) return true;</span>
<a href="#l23.825"></a><span id="l23.825"> </span>
<a href="#l23.826"></a><span id="l23.826" class="difflineminus">-  auto encoding = mozilla::Encoding::ForLabelNoReplacement(nsDependentCString(charset));</span>
<a href="#l23.827"></a><span id="l23.827" class="difflineminus">-  if (!encoding)</span>
<a href="#l23.828"></a><span id="l23.828" class="difflineminus">-    return false;</span>
<a href="#l23.829"></a><span id="l23.829" class="difflineplus">+  auto encoding =</span>
<a href="#l23.830"></a><span id="l23.830" class="difflineplus">+      mozilla::Encoding::ForLabelNoReplacement(nsDependentCString(charset));</span>
<a href="#l23.831"></a><span id="l23.831" class="difflineplus">+  if (!encoding) return false;</span>
<a href="#l23.832"></a><span id="l23.832">   auto encoder = encoding-&gt;NewEncoder();</span>
<a href="#l23.833"></a><span id="l23.833"> </span>
<a href="#l23.834"></a><span id="l23.834">   uint8_t buffer[512];</span>
<a href="#l23.835"></a><span id="l23.835">   auto src = mozilla::MakeSpan(m_body);</span>
<a href="#l23.836"></a><span id="l23.836">   auto dst = mozilla::MakeSpan(buffer);</span>
<a href="#l23.837"></a><span id="l23.837">   while (true) {</span>
<a href="#l23.838"></a><span id="l23.838">     uint32_t result;</span>
<a href="#l23.839"></a><span id="l23.839">     size_t read;</span>
<a href="#l23.840"></a><span id="l23.840">     size_t written;</span>
<a href="#l23.841"></a><span id="l23.841">     mozilla::Tie(result, read, written) =</span>
<a href="#l23.842"></a><span id="l23.842" class="difflineminus">-      encoder-&gt;EncodeFromUTF16WithoutReplacement(src, dst, false);</span>
<a href="#l23.843"></a><span id="l23.843" class="difflineplus">+        encoder-&gt;EncodeFromUTF16WithoutReplacement(src, dst, false);</span>
<a href="#l23.844"></a><span id="l23.844">     if (result == mozilla::kInputEmpty) {</span>
<a href="#l23.845"></a><span id="l23.845">       // All converted successfully.</span>
<a href="#l23.846"></a><span id="l23.846">       break;</span>
<a href="#l23.847"></a><span id="l23.847">     } else if (result != mozilla::kOutputFull) {</span>
<a href="#l23.848"></a><span id="l23.848">       // Didn't use all the input but the output isn't full, hence</span>
<a href="#l23.849"></a><span id="l23.849">       // there was an unencodable character.</span>
<a href="#l23.850"></a><span id="l23.850">       return false;</span>
<a href="#l23.851"></a><span id="l23.851">     }</span>
<a href="#l23.852"></a><span id="l23.852">     src = src.From(read);</span>
<a href="#l23.853"></a><span id="l23.853">     // dst = dst.From(written); // Just overwrite output since we don't need it.</span>
<a href="#l23.854"></a><span id="l23.854">   }</span>
<a href="#l23.855"></a><span id="l23.855"> </span>
<a href="#l23.856"></a><span id="l23.856">   return true;</span>
<a href="#l23.857"></a><span id="l23.857"> }</span>
<a href="#l23.858"></a><span id="l23.858"> </span>
<a href="#l23.859"></a><span id="l23.859" class="difflineminus">-bool CaseInsensitiveComp (wchar_t elem1, wchar_t elem2)</span>
<a href="#l23.860"></a><span id="l23.860" class="difflineminus">-{</span>
<a href="#l23.861"></a><span id="l23.861" class="difflineplus">+bool CaseInsensitiveComp(wchar_t elem1, wchar_t elem2) {</span>
<a href="#l23.862"></a><span id="l23.862">   return _wcsnicmp(&amp;elem1, &amp;elem2, 1) == 0;</span>
<a href="#l23.863"></a><span id="l23.863"> }</span>
<a href="#l23.864"></a><span id="l23.864"> </span>
<a href="#l23.865"></a><span id="l23.865" class="difflineminus">-void ExtractMetaCharset(const wchar_t* body, int bodySz, /*out*/nsCString&amp; charset)</span>
<a href="#l23.866"></a><span id="l23.866" class="difflineminus">-{</span>
<a href="#l23.867"></a><span id="l23.867" class="difflineplus">+void ExtractMetaCharset(const wchar_t* body, int bodySz,</span>
<a href="#l23.868"></a><span id="l23.868" class="difflineplus">+                        /*out*/ nsCString&amp; charset) {</span>
<a href="#l23.869"></a><span id="l23.869">   charset.Truncate();</span>
<a href="#l23.870"></a><span id="l23.870" class="difflineminus">-  const wchar_t* body_end = body+bodySz;</span>
<a href="#l23.871"></a><span id="l23.871" class="difflineplus">+  const wchar_t* body_end = body + bodySz;</span>
<a href="#l23.872"></a><span id="l23.872">   const wchar_t str_eohd[] = L&quot;/head&quot;;</span>
<a href="#l23.873"></a><span id="l23.873" class="difflineminus">-  const wchar_t *str_eohd_end = str_eohd+sizeof(str_eohd)/sizeof(str_eohd[0])-1;</span>
<a href="#l23.874"></a><span id="l23.874" class="difflineminus">-  const wchar_t* eohd_pos = std::search(body, body_end, str_eohd, str_eohd_end,</span>
<a href="#l23.875"></a><span id="l23.875" class="difflineminus">-                                        CaseInsensitiveComp);</span>
<a href="#l23.876"></a><span id="l23.876" class="difflineminus">-  if (eohd_pos == body_end) // No header!</span>
<a href="#l23.877"></a><span id="l23.877" class="difflineplus">+  const wchar_t* str_eohd_end =</span>
<a href="#l23.878"></a><span id="l23.878" class="difflineplus">+      str_eohd + sizeof(str_eohd) / sizeof(str_eohd[0]) - 1;</span>
<a href="#l23.879"></a><span id="l23.879" class="difflineplus">+  const wchar_t* eohd_pos =</span>
<a href="#l23.880"></a><span id="l23.880" class="difflineplus">+      std::search(body, body_end, str_eohd, str_eohd_end, CaseInsensitiveComp);</span>
<a href="#l23.881"></a><span id="l23.881" class="difflineplus">+  if (eohd_pos == body_end)  // No header!</span>
<a href="#l23.882"></a><span id="l23.882">     return;</span>
<a href="#l23.883"></a><span id="l23.883">   const wchar_t str_chset[] = L&quot;charset=&quot;;</span>
<a href="#l23.884"></a><span id="l23.884" class="difflineminus">-  const wchar_t *str_chset_end =</span>
<a href="#l23.885"></a><span id="l23.885" class="difflineminus">-    str_chset + sizeof(str_chset)/sizeof(str_chset[0])-1;</span>
<a href="#l23.886"></a><span id="l23.886" class="difflineplus">+  const wchar_t* str_chset_end =</span>
<a href="#l23.887"></a><span id="l23.887" class="difflineplus">+      str_chset + sizeof(str_chset) / sizeof(str_chset[0]) - 1;</span>
<a href="#l23.888"></a><span id="l23.888">   const wchar_t* chset_pos = std::search(body, eohd_pos, str_chset,</span>
<a href="#l23.889"></a><span id="l23.889">                                          str_chset_end, CaseInsensitiveComp);</span>
<a href="#l23.890"></a><span id="l23.890" class="difflineminus">-  if (chset_pos == eohd_pos) // No charset!</span>
<a href="#l23.891"></a><span id="l23.891" class="difflineplus">+  if (chset_pos == eohd_pos)  // No charset!</span>
<a href="#l23.892"></a><span id="l23.892">     return;</span>
<a href="#l23.893"></a><span id="l23.893">   chset_pos += 8;</span>
<a href="#l23.894"></a><span id="l23.894"> </span>
<a href="#l23.895"></a><span id="l23.895">   // remove everything from the string after the next ; or &quot; or space,</span>
<a href="#l23.896"></a><span id="l23.896">   // whichever comes first.</span>
<a href="#l23.897"></a><span id="l23.897">   // The initial string looks something like</span>
<a href="#l23.898"></a><span id="l23.898">   // &lt;META content=&quot;text/html; charset=utf-8&quot; http-equiv=Content-Type&gt;</span>
<a href="#l23.899"></a><span id="l23.899">   // &lt;META content=&quot;text/html; charset=utf-8;&quot; http-equiv=Content-Type&gt;</span>
<a href="#l23.900"></a><span id="l23.900">   // &lt;META content=&quot;text/html; charset=utf-8 ;&quot; http-equiv=Content-Type&gt;</span>
<a href="#l23.901"></a><span id="l23.901">   // &lt;META content=&quot;text/html; charset=utf-8 &quot; http-equiv=Content-Type&gt;</span>
<a href="#l23.902"></a><span id="l23.902" class="difflineminus">-  const wchar_t term[] = L&quot;;\&quot; &quot;, *term_end= term+sizeof(term)/sizeof(term[0])-1;</span>
<a href="#l23.903"></a><span id="l23.903" class="difflineminus">-  const wchar_t* chset_end = std::find_first_of(chset_pos, eohd_pos, term,</span>
<a href="#l23.904"></a><span id="l23.904" class="difflineminus">-                                                term_end);</span>
<a href="#l23.905"></a><span id="l23.905" class="difflineplus">+  const wchar_t term[] = L&quot;;\&quot; &quot;,</span>
<a href="#l23.906"></a><span id="l23.906" class="difflineplus">+                *term_end = term + sizeof(term) / sizeof(term[0]) - 1;</span>
<a href="#l23.907"></a><span id="l23.907" class="difflineplus">+  const wchar_t* chset_end =</span>
<a href="#l23.908"></a><span id="l23.908" class="difflineplus">+      std::find_first_of(chset_pos, eohd_pos, term, term_end);</span>
<a href="#l23.909"></a><span id="l23.909">   if (chset_end != eohd_pos)</span>
<a href="#l23.910"></a><span id="l23.910" class="difflineminus">-    LossyCopyUTF16toASCII(Substring(char16ptr_t(chset_pos),</span>
<a href="#l23.911"></a><span id="l23.911" class="difflineminus">-                                    char16ptr_t(chset_end)),</span>
<a href="#l23.912"></a><span id="l23.912" class="difflineminus">-                                    charset);</span>
<a href="#l23.913"></a><span id="l23.913" class="difflineplus">+    LossyCopyUTF16toASCII(</span>
<a href="#l23.914"></a><span id="l23.914" class="difflineplus">+        Substring(char16ptr_t(chset_pos), char16ptr_t(chset_end)), charset);</span>
<a href="#l23.915"></a><span id="l23.915"> }</span>
<a href="#l23.916"></a><span id="l23.916"> </span>
<a href="#l23.917"></a><span id="l23.917" class="difflineminus">-bool CMapiMessage::FetchBody(void)</span>
<a href="#l23.918"></a><span id="l23.918" class="difflineminus">-{</span>
<a href="#l23.919"></a><span id="l23.919" class="difflineplus">+bool CMapiMessage::FetchBody(void) {</span>
<a href="#l23.920"></a><span id="l23.920">   m_bodyIsHtml = false;</span>
<a href="#l23.921"></a><span id="l23.921">   m_body.Truncate();</span>
<a href="#l23.922"></a><span id="l23.922"> </span>
<a href="#l23.923"></a><span id="l23.923" class="difflineminus">-  // Get the Outlook codepage info; if unsuccessful then it defaults to 0 (CP_ACP) -&gt; system default</span>
<a href="#l23.924"></a><span id="l23.924" class="difflineminus">-  // Maybe we can use this info later?</span>
<a href="#l23.925"></a><span id="l23.925" class="difflineminus">-  unsigned int codepage=0;</span>
<a href="#l23.926"></a><span id="l23.926" class="difflineplus">+  // Get the Outlook codepage info; if unsuccessful then it defaults to 0</span>
<a href="#l23.927"></a><span id="l23.927" class="difflineplus">+  // (CP_ACP) -&gt; system default Maybe we can use this info later?</span>
<a href="#l23.928"></a><span id="l23.928" class="difflineplus">+  unsigned int codepage = 0;</span>
<a href="#l23.929"></a><span id="l23.929">   LPSPropValue pVal = CMapiApi::GetMapiProperty(m_lpMsg, PR_INTERNET_CPID);</span>
<a href="#l23.930"></a><span id="l23.930">   if (pVal) {</span>
<a href="#l23.931"></a><span id="l23.931" class="difflineminus">-    if (PROP_TYPE(pVal-&gt;ulPropTag) == PT_LONG)</span>
<a href="#l23.932"></a><span id="l23.932" class="difflineminus">-      codepage = pVal-&gt;Value.l;</span>
<a href="#l23.933"></a><span id="l23.933" class="difflineplus">+    if (PROP_TYPE(pVal-&gt;ulPropTag) == PT_LONG) codepage = pVal-&gt;Value.l;</span>
<a href="#l23.934"></a><span id="l23.934">     CMapiApi::MAPIFreeBuffer(pVal);</span>
<a href="#l23.935"></a><span id="l23.935">   }</span>
<a href="#l23.936"></a><span id="l23.936"> </span>
<a href="#l23.937"></a><span id="l23.937">   unsigned long nativeBodyType = 0;</span>
<a href="#l23.938"></a><span id="l23.938">   if (CMapiApi::GetRTFPropertyDecodedAsUTF16(m_lpMsg, m_body, nativeBodyType,</span>
<a href="#l23.939"></a><span id="l23.939">                                              codepage)) {</span>
<a href="#l23.940"></a><span id="l23.940">     m_bodyIsHtml = nativeBodyType == MAPI_NATIVE_BODY_TYPE_HTML;</span>
<a href="#l23.941"></a><span id="l23.941" class="difflineminus">-  }</span>
<a href="#l23.942"></a><span id="l23.942" class="difflineminus">-  else { // Cannot get RTF version</span>
<a href="#l23.943"></a><span id="l23.943" class="difflineplus">+  } else {  // Cannot get RTF version</span>
<a href="#l23.944"></a><span id="l23.944">     // Is it html?</span>
<a href="#l23.945"></a><span id="l23.945">     pVal = CMapiApi::GetMapiProperty(m_lpMsg, PR_BODY_HTML_W);</span>
<a href="#l23.946"></a><span id="l23.946">     if (pVal) {</span>
<a href="#l23.947"></a><span id="l23.947">       if (CMapiApi::IsLargeProperty(pVal))</span>
<a href="#l23.948"></a><span id="l23.948">         CMapiApi::GetLargeStringProperty(m_lpMsg, PR_BODY_HTML_W, m_body);</span>
<a href="#l23.949"></a><span id="l23.949">       else if ((PROP_TYPE(pVal-&gt;ulPropTag) == PT_UNICODE) &amp;&amp;</span>
<a href="#l23.950"></a><span id="l23.950">                (pVal-&gt;Value.lpszW) &amp;&amp; (*(pVal-&gt;Value.lpszW)))</span>
<a href="#l23.951"></a><span id="l23.951">         m_body.Assign(pVal-&gt;Value.lpszW);</span>
<a href="#l23.952"></a><span id="l23.952" class="difflineat">@@ -677,133 +665,123 @@ bool CMapiMessage::FetchBody(void)</span>
<a href="#l23.953"></a><span id="l23.953">     //</span>
<a href="#l23.954"></a><span id="l23.954">     // Sadly there are cases where this string is returned despite the fact</span>
<a href="#l23.955"></a><span id="l23.955">     // that the message is indeed HTML.</span>
<a href="#l23.956"></a><span id="l23.956">     //</span>
<a href="#l23.957"></a><span id="l23.957">     // To detect the &quot;true&quot; plain text messages, we look for our string</span>
<a href="#l23.958"></a><span id="l23.958">     // immediately following the &lt;BODY&gt; tag.</span>
<a href="#l23.959"></a><span id="l23.959">     if (!m_body.IsEmpty() &amp;&amp;</span>
<a href="#l23.960"></a><span id="l23.960">         m_body.Find(&quot;&lt;BODY&gt;\r\n&lt;!-- Converted from text/plain format --&gt;&quot;) ==</span>
<a href="#l23.961"></a><span id="l23.961" class="difflineminus">-        kNotFound) {</span>
<a href="#l23.962"></a><span id="l23.962" class="difflineplus">+            kNotFound) {</span>
<a href="#l23.963"></a><span id="l23.963">       m_bodyIsHtml = true;</span>
<a href="#l23.964"></a><span id="l23.964" class="difflineminus">-    }</span>
<a href="#l23.965"></a><span id="l23.965" class="difflineminus">-    else {</span>
<a href="#l23.966"></a><span id="l23.966" class="difflineplus">+    } else {</span>
<a href="#l23.967"></a><span id="l23.967">       pVal = CMapiApi::GetMapiProperty(m_lpMsg, PR_BODY_W);</span>
<a href="#l23.968"></a><span id="l23.968">       if (pVal) {</span>
<a href="#l23.969"></a><span id="l23.969">         if (CMapiApi::IsLargeProperty(pVal))</span>
<a href="#l23.970"></a><span id="l23.970">           CMapiApi::GetLargeStringProperty(m_lpMsg, PR_BODY_W, m_body);</span>
<a href="#l23.971"></a><span id="l23.971">         else if ((PROP_TYPE(pVal-&gt;ulPropTag) == PT_UNICODE) &amp;&amp;</span>
<a href="#l23.972"></a><span id="l23.972">                  (pVal-&gt;Value.lpszW) &amp;&amp; (*(pVal-&gt;Value.lpszW)))</span>
<a href="#l23.973"></a><span id="l23.973">           m_body.Assign(pVal-&gt;Value.lpszW);</span>
<a href="#l23.974"></a><span id="l23.974">         CMapiApi::MAPIFreeBuffer(pVal);</span>
<a href="#l23.975"></a><span id="l23.975">       }</span>
<a href="#l23.976"></a><span id="l23.976">     }</span>
<a href="#l23.977"></a><span id="l23.977">   }</span>
<a href="#l23.978"></a><span id="l23.978"> </span>
<a href="#l23.979"></a><span id="l23.979">   // OK, now let's restore the original encoding!</span>
<a href="#l23.980"></a><span id="l23.980" class="difflineminus">-  // 1. We may have a header defining the charset (we already called the FetchHeaders(), and there ProcessHeaders();</span>
<a href="#l23.981"></a><span id="l23.981" class="difflineminus">-  //    in this case, the m_mimeCharset is set. See nsOutlookMail::ImportMailbox())</span>
<a href="#l23.982"></a><span id="l23.982" class="difflineminus">-  // 2. We may have the codepage walue provided by Outlook (&quot;codepage&quot; at the very beginning of this function)</span>
<a href="#l23.983"></a><span id="l23.983" class="difflineplus">+  // 1. We may have a header defining the charset (we already called the</span>
<a href="#l23.984"></a><span id="l23.984" class="difflineplus">+  // FetchHeaders(), and there ProcessHeaders();</span>
<a href="#l23.985"></a><span id="l23.985" class="difflineplus">+  //    in this case, the m_mimeCharset is set. See</span>
<a href="#l23.986"></a><span id="l23.986" class="difflineplus">+  //    nsOutlookMail::ImportMailbox())</span>
<a href="#l23.987"></a><span id="l23.987" class="difflineplus">+  // 2. We may have the codepage walue provided by Outlook (&quot;codepage&quot; at the</span>
<a href="#l23.988"></a><span id="l23.988" class="difflineplus">+  // very beginning of this function)</span>
<a href="#l23.989"></a><span id="l23.989">   // 3. We may have an HTML charset header.</span>
<a href="#l23.990"></a><span id="l23.990"> </span>
<a href="#l23.991"></a><span id="l23.991">   bool bFoundCharset = false;</span>
<a href="#l23.992"></a><span id="l23.992"> </span>
<a href="#l23.993"></a><span id="l23.993" class="difflineminus">-  if (!m_mimeCharset.IsEmpty()) // The top-level header data</span>
<a href="#l23.994"></a><span id="l23.994" class="difflineplus">+  if (!m_mimeCharset.IsEmpty())  // The top-level header data</span>
<a href="#l23.995"></a><span id="l23.995">     bFoundCharset = CheckBodyInCharsetRange(m_mimeCharset.get());</span>
<a href="#l23.996"></a><span id="l23.996">   // No valid charset in the message header - try the HTML header.</span>
<a href="#l23.997"></a><span id="l23.997">   // arguably may be useless</span>
<a href="#l23.998"></a><span id="l23.998">   if (!bFoundCharset &amp;&amp; m_bodyIsHtml) {</span>
<a href="#l23.999"></a><span id="l23.999">     ExtractMetaCharset(m_body.get(), m_body.Length(), m_mimeCharset);</span>
<a href="#l23.1000"></a><span id="l23.1000">     if (!m_mimeCharset.IsEmpty())</span>
<a href="#l23.1001"></a><span id="l23.1001">       bFoundCharset = CheckBodyInCharsetRange(m_mimeCharset.get());</span>
<a href="#l23.1002"></a><span id="l23.1002">   }</span>
<a href="#l23.1003"></a><span id="l23.1003">   // Get from Outlook (seems like it keeps the MIME part header encoding info)</span>
<a href="#l23.1004"></a><span id="l23.1004">   if (!bFoundCharset &amp;&amp; codepage) {</span>
<a href="#l23.1005"></a><span id="l23.1005">     const char* charset = CpToCharset(codepage);</span>
<a href="#l23.1006"></a><span id="l23.1006">     if (charset) {</span>
<a href="#l23.1007"></a><span id="l23.1007">       bFoundCharset = CheckBodyInCharsetRange(charset);</span>
<a href="#l23.1008"></a><span id="l23.1008" class="difflineminus">-      if (bFoundCharset)</span>
<a href="#l23.1009"></a><span id="l23.1009" class="difflineminus">-        m_mimeCharset.Assign(charset);</span>
<a href="#l23.1010"></a><span id="l23.1010" class="difflineplus">+      if (bFoundCharset) m_mimeCharset.Assign(charset);</span>
<a href="#l23.1011"></a><span id="l23.1011">     }</span>
<a href="#l23.1012"></a><span id="l23.1012">   }</span>
<a href="#l23.1013"></a><span id="l23.1013" class="difflineminus">-  if (!bFoundCharset) { // Use system default</span>
<a href="#l23.1014"></a><span id="l23.1014" class="difflineplus">+  if (!bFoundCharset) {  // Use system default</span>
<a href="#l23.1015"></a><span id="l23.1015">     const nsCString charset(nsMsgI18NFileSystemCharset());</span>
<a href="#l23.1016"></a><span id="l23.1016">     if (!charset.IsEmpty()) {</span>
<a href="#l23.1017"></a><span id="l23.1017">       bFoundCharset = CheckBodyInCharsetRange(charset.get());</span>
<a href="#l23.1018"></a><span id="l23.1018" class="difflineminus">-      if (bFoundCharset)</span>
<a href="#l23.1019"></a><span id="l23.1019" class="difflineminus">-        m_mimeCharset = charset;</span>
<a href="#l23.1020"></a><span id="l23.1020" class="difflineplus">+      if (bFoundCharset) m_mimeCharset = charset;</span>
<a href="#l23.1021"></a><span id="l23.1021">     }</span>
<a href="#l23.1022"></a><span id="l23.1022">   }</span>
<a href="#l23.1023"></a><span id="l23.1023" class="difflineminus">-  if (!bFoundCharset) // Everything else failed, let's use the lossless utf-8...</span>
<a href="#l23.1024"></a><span id="l23.1024" class="difflineplus">+  if (!bFoundCharset)  // Everything else failed, let's use the lossless</span>
<a href="#l23.1025"></a><span id="l23.1025" class="difflineplus">+                       // utf-8...</span>
<a href="#l23.1026"></a><span id="l23.1026">     m_mimeCharset.AssignLiteral(&quot;utf-8&quot;);</span>
<a href="#l23.1027"></a><span id="l23.1027"> </span>
<a href="#l23.1028"></a><span id="l23.1028">   MAPI_DUMP_STRING(m_body.get());</span>
<a href="#l23.1029"></a><span id="l23.1029">   MAPI_TRACE0(&quot;\r\n&quot;);</span>
<a href="#l23.1030"></a><span id="l23.1030"> </span>
<a href="#l23.1031"></a><span id="l23.1031">   return true;</span>
<a href="#l23.1032"></a><span id="l23.1032"> }</span>
<a href="#l23.1033"></a><span id="l23.1033"> </span>
<a href="#l23.1034"></a><span id="l23.1034" class="difflineminus">-void CMapiMessage::GetBody(nsCString&amp; dest) const</span>
<a href="#l23.1035"></a><span id="l23.1035" class="difflineminus">-{</span>
<a href="#l23.1036"></a><span id="l23.1036" class="difflineplus">+void CMapiMessage::GetBody(nsCString&amp; dest) const {</span>
<a href="#l23.1037"></a><span id="l23.1037">   nsMsgI18NConvertFromUnicode(m_mimeCharset, m_body, dest);</span>
<a href="#l23.1038"></a><span id="l23.1038"> }</span>
<a href="#l23.1039"></a><span id="l23.1039"> </span>
<a href="#l23.1040"></a><span id="l23.1040" class="difflineminus">-void CMapiMessage::FetchFlags(void)</span>
<a href="#l23.1041"></a><span id="l23.1041" class="difflineminus">-{</span>
<a href="#l23.1042"></a><span id="l23.1042" class="difflineplus">+void CMapiMessage::FetchFlags(void) {</span>
<a href="#l23.1043"></a><span id="l23.1043">   LPSPropValue pVal = CMapiApi::GetMapiProperty(m_lpMsg, PR_MESSAGE_FLAGS);</span>
<a href="#l23.1044"></a><span id="l23.1044" class="difflineminus">-  if (pVal)</span>
<a href="#l23.1045"></a><span id="l23.1045" class="difflineminus">-    m_msgFlags = CMapiApi::GetLongFromProp(pVal);</span>
<a href="#l23.1046"></a><span id="l23.1046" class="difflineplus">+  if (pVal) m_msgFlags = CMapiApi::GetLongFromProp(pVal);</span>
<a href="#l23.1047"></a><span id="l23.1047">   pVal = CMapiApi::GetMapiProperty(m_lpMsg, PR_LAST_VERB_EXECUTED);</span>
<a href="#l23.1048"></a><span id="l23.1048" class="difflineminus">-  if (pVal)</span>
<a href="#l23.1049"></a><span id="l23.1049" class="difflineminus">-    m_msgLastVerb = CMapiApi::GetLongFromProp(pVal);</span>
<a href="#l23.1050"></a><span id="l23.1050" class="difflineplus">+  if (pVal) m_msgLastVerb = CMapiApi::GetLongFromProp(pVal);</span>
<a href="#l23.1051"></a><span id="l23.1051"> }</span>
<a href="#l23.1052"></a><span id="l23.1052"> </span>
<a href="#l23.1053"></a><span id="l23.1053" class="difflineminus">-enum {</span>
<a href="#l23.1054"></a><span id="l23.1054" class="difflineminus">-  ieidPR_ATTACH_NUM = 0,</span>
<a href="#l23.1055"></a><span id="l23.1055" class="difflineminus">-  ieidAttachMax</span>
<a href="#l23.1056"></a><span id="l23.1056" class="difflineminus">-};</span>
<a href="#l23.1057"></a><span id="l23.1057" class="difflineplus">+enum { ieidPR_ATTACH_NUM = 0, ieidAttachMax };</span>
<a href="#l23.1058"></a><span id="l23.1058"> </span>
<a href="#l23.1059"></a><span id="l23.1059" class="difflineminus">-static const SizedSPropTagArray(ieidAttachMax, ptaEid)=</span>
<a href="#l23.1060"></a><span id="l23.1060" class="difflineminus">-{</span>
<a href="#l23.1061"></a><span id="l23.1061" class="difflineminus">-  ieidAttachMax,</span>
<a href="#l23.1062"></a><span id="l23.1062" class="difflineminus">-  {</span>
<a href="#l23.1063"></a><span id="l23.1063" class="difflineminus">-    PR_ATTACH_NUM</span>
<a href="#l23.1064"></a><span id="l23.1064" class="difflineminus">-  }</span>
<a href="#l23.1065"></a><span id="l23.1065" class="difflineminus">-};</span>
<a href="#l23.1066"></a><span id="l23.1066" class="difflineplus">+static const SizedSPropTagArray(ieidAttachMax, ptaEid) = {ieidAttachMax,</span>
<a href="#l23.1067"></a><span id="l23.1067" class="difflineplus">+                                                          {PR_ATTACH_NUM}};</span>
<a href="#l23.1068"></a><span id="l23.1068"> </span>
<a href="#l23.1069"></a><span id="l23.1069" class="difflineminus">-bool CMapiMessage::IterateAttachTable(LPMAPITABLE lpTable)</span>
<a href="#l23.1070"></a><span id="l23.1070" class="difflineminus">-{</span>
<a href="#l23.1071"></a><span id="l23.1071" class="difflineplus">+bool CMapiMessage::IterateAttachTable(LPMAPITABLE lpTable) {</span>
<a href="#l23.1072"></a><span id="l23.1072">   ULONG rowCount;</span>
<a href="#l23.1073"></a><span id="l23.1073">   HRESULT hr = lpTable-&gt;GetRowCount(0, &amp;rowCount);</span>
<a href="#l23.1074"></a><span id="l23.1074">   if (!rowCount) {</span>
<a href="#l23.1075"></a><span id="l23.1075">     return true;</span>
<a href="#l23.1076"></a><span id="l23.1076">   }</span>
<a href="#l23.1077"></a><span id="l23.1077"> </span>
<a href="#l23.1078"></a><span id="l23.1078">   hr = lpTable-&gt;SetColumns((LPSPropTagArray)&amp;ptaEid, 0);</span>
<a href="#l23.1079"></a><span id="l23.1079">   if (FAILED(hr)) {</span>
<a href="#l23.1080"></a><span id="l23.1080" class="difflineminus">-    MAPI_TRACE2(&quot;SetColumns for attachment table failed: 0x%lx, %d\r\n&quot;, (long)hr, (int)hr);</span>
<a href="#l23.1081"></a><span id="l23.1081" class="difflineplus">+    MAPI_TRACE2(&quot;SetColumns for attachment table failed: 0x%lx, %d\r\n&quot;,</span>
<a href="#l23.1082"></a><span id="l23.1082" class="difflineplus">+                (long)hr, (int)hr);</span>
<a href="#l23.1083"></a><span id="l23.1083">     return false;</span>
<a href="#l23.1084"></a><span id="l23.1084">   }</span>
<a href="#l23.1085"></a><span id="l23.1085"> </span>
<a href="#l23.1086"></a><span id="l23.1086">   hr = lpTable-&gt;SeekRow(BOOKMARK_BEGINNING, 0, NULL);</span>
<a href="#l23.1087"></a><span id="l23.1087">   if (FAILED(hr)) {</span>
<a href="#l23.1088"></a><span id="l23.1088" class="difflineminus">-    MAPI_TRACE2(&quot;SeekRow for attachment table failed: 0x%lx, %d\r\n&quot;, (long)hr, (int)hr);</span>
<a href="#l23.1089"></a><span id="l23.1089" class="difflineplus">+    MAPI_TRACE2(&quot;SeekRow for attachment table failed: 0x%lx, %d\r\n&quot;, (long)hr,</span>
<a href="#l23.1090"></a><span id="l23.1090" class="difflineplus">+                (int)hr);</span>
<a href="#l23.1091"></a><span id="l23.1091">     return false;</span>
<a href="#l23.1092"></a><span id="l23.1092">   }</span>
<a href="#l23.1093"></a><span id="l23.1093"> </span>
<a href="#l23.1094"></a><span id="l23.1094">   int cNumRows = 0;</span>
<a href="#l23.1095"></a><span id="l23.1095">   LPSRowSet lpRow;</span>
<a href="#l23.1096"></a><span id="l23.1096">   bool bResult = true;</span>
<a href="#l23.1097"></a><span id="l23.1097">   do {</span>
<a href="#l23.1098"></a><span id="l23.1098" class="difflineminus">-</span>
<a href="#l23.1099"></a><span id="l23.1099">     lpRow = NULL;</span>
<a href="#l23.1100"></a><span id="l23.1100">     hr = lpTable-&gt;QueryRows(1, 0, &amp;lpRow);</span>
<a href="#l23.1101"></a><span id="l23.1101"> </span>
<a href="#l23.1102"></a><span id="l23.1102" class="difflineminus">-    if(HR_FAILED(hr)) {</span>
<a href="#l23.1103"></a><span id="l23.1103" class="difflineminus">-      MAPI_TRACE2(&quot;QueryRows for attachment table failed: 0x%lx, %d\n&quot;, (long)hr, (int)hr);</span>
<a href="#l23.1104"></a><span id="l23.1104" class="difflineplus">+    if (HR_FAILED(hr)) {</span>
<a href="#l23.1105"></a><span id="l23.1105" class="difflineplus">+      MAPI_TRACE2(&quot;QueryRows for attachment table failed: 0x%lx, %d\n&quot;,</span>
<a href="#l23.1106"></a><span id="l23.1106" class="difflineplus">+                  (long)hr, (int)hr);</span>
<a href="#l23.1107"></a><span id="l23.1107">       bResult = false;</span>
<a href="#l23.1108"></a><span id="l23.1108">       break;</span>
<a href="#l23.1109"></a><span id="l23.1109">     }</span>
<a href="#l23.1110"></a><span id="l23.1110"> </span>
<a href="#l23.1111"></a><span id="l23.1111">     if (lpRow) {</span>
<a href="#l23.1112"></a><span id="l23.1112">       cNumRows = lpRow-&gt;cRows;</span>
<a href="#l23.1113"></a><span id="l23.1113"> </span>
<a href="#l23.1114"></a><span id="l23.1114">       if (cNumRows) {</span>
<a href="#l23.1115"></a><span id="l23.1115" class="difflineat">@@ -814,193 +792,187 @@ bool CMapiMessage::IterateAttachTable(LP</span>
<a href="#l23.1116"></a><span id="l23.1116">       CMapiApi::FreeProws(lpRow);</span>
<a href="#l23.1117"></a><span id="l23.1117">     }</span>
<a href="#l23.1118"></a><span id="l23.1118"> </span>
<a href="#l23.1119"></a><span id="l23.1119">   } while (SUCCEEDED(hr) &amp;&amp; cNumRows &amp;&amp; lpRow);</span>
<a href="#l23.1120"></a><span id="l23.1120"> </span>
<a href="#l23.1121"></a><span id="l23.1121">   return bResult;</span>
<a href="#l23.1122"></a><span id="l23.1122"> }</span>
<a href="#l23.1123"></a><span id="l23.1123"> </span>
<a href="#l23.1124"></a><span id="l23.1124" class="difflineminus">-bool CMapiMessage::GetTmpFile(/*out*/ nsIFile **aResult)</span>
<a href="#l23.1125"></a><span id="l23.1125" class="difflineminus">-{</span>
<a href="#l23.1126"></a><span id="l23.1126" class="difflineplus">+bool CMapiMessage::GetTmpFile(/*out*/ nsIFile** aResult) {</span>
<a href="#l23.1127"></a><span id="l23.1127">   nsCOMPtr&lt;nsIFile&gt; tmpFile;</span>
<a href="#l23.1128"></a><span id="l23.1128" class="difflineminus">-  nsresult rv = GetSpecialDirectoryWithFileName(NS_OS_TEMP_DIR,</span>
<a href="#l23.1129"></a><span id="l23.1129" class="difflineminus">-    &quot;mapiattach.tmp&quot;,</span>
<a href="#l23.1130"></a><span id="l23.1130" class="difflineminus">-    getter_AddRefs(tmpFile));</span>
<a href="#l23.1131"></a><span id="l23.1131" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l23.1132"></a><span id="l23.1132" class="difflineminus">-    return false;</span>
<a href="#l23.1133"></a><span id="l23.1133" class="difflineplus">+  nsresult rv = GetSpecialDirectoryWithFileName(</span>
<a href="#l23.1134"></a><span id="l23.1134" class="difflineplus">+      NS_OS_TEMP_DIR, &quot;mapiattach.tmp&quot;, getter_AddRefs(tmpFile));</span>
<a href="#l23.1135"></a><span id="l23.1135" class="difflineplus">+  if (NS_FAILED(rv)) return false;</span>
<a href="#l23.1136"></a><span id="l23.1136"> </span>
<a href="#l23.1137"></a><span id="l23.1137">   rv = tmpFile-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 00600);</span>
<a href="#l23.1138"></a><span id="l23.1138" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l23.1139"></a><span id="l23.1139" class="difflineminus">-    return false;</span>
<a href="#l23.1140"></a><span id="l23.1140" class="difflineplus">+  if (NS_FAILED(rv)) return false;</span>
<a href="#l23.1141"></a><span id="l23.1141"> </span>
<a href="#l23.1142"></a><span id="l23.1142">   tmpFile.forget(aResult);</span>
<a href="#l23.1143"></a><span id="l23.1143">   return true;</span>
<a href="#l23.1144"></a><span id="l23.1144"> }</span>
<a href="#l23.1145"></a><span id="l23.1145"> </span>
<a href="#l23.1146"></a><span id="l23.1146" class="difflineminus">-bool CMapiMessage::CopyMsgAttachToFile(LPATTACH lpAttach, /*out*/ nsIFile **tmp_file)</span>
<a href="#l23.1147"></a><span id="l23.1147" class="difflineminus">-{</span>
<a href="#l23.1148"></a><span id="l23.1148" class="difflineminus">-  LPMESSAGE  lpMsg;</span>
<a href="#l23.1149"></a><span id="l23.1149" class="difflineplus">+bool CMapiMessage::CopyMsgAttachToFile(LPATTACH lpAttach,</span>
<a href="#l23.1150"></a><span id="l23.1150" class="difflineplus">+                                       /*out*/ nsIFile** tmp_file) {</span>
<a href="#l23.1151"></a><span id="l23.1151" class="difflineplus">+  LPMESSAGE lpMsg;</span>
<a href="#l23.1152"></a><span id="l23.1152">   HRESULT hr = lpAttach-&gt;OpenProperty(PR_ATTACH_DATA_OBJ, &amp;IID_IMessage, 0, 0,</span>
<a href="#l23.1153"></a><span id="l23.1153" class="difflineminus">-                                      reinterpret_cast&lt;LPUNKNOWN *&gt;(&amp;lpMsg));</span>
<a href="#l23.1154"></a><span id="l23.1154" class="difflineminus">-  if (HR_FAILED(hr))</span>
<a href="#l23.1155"></a><span id="l23.1155" class="difflineminus">-    return false;</span>
<a href="#l23.1156"></a><span id="l23.1156" class="difflineplus">+                                      reinterpret_cast&lt;LPUNKNOWN*&gt;(&amp;lpMsg));</span>
<a href="#l23.1157"></a><span id="l23.1157" class="difflineplus">+  if (HR_FAILED(hr)) return false;</span>
<a href="#l23.1158"></a><span id="l23.1158"> </span>
<a href="#l23.1159"></a><span id="l23.1159" class="difflineminus">-  if (!GetTmpFile(tmp_file))</span>
<a href="#l23.1160"></a><span id="l23.1160" class="difflineminus">-    return false;</span>
<a href="#l23.1161"></a><span id="l23.1161" class="difflineplus">+  if (!GetTmpFile(tmp_file)) return false;</span>
<a href="#l23.1162"></a><span id="l23.1162"> </span>
<a href="#l23.1163"></a><span id="l23.1163">   nsCOMPtr&lt;nsIOutputStream&gt; destOutputStream;</span>
<a href="#l23.1164"></a><span id="l23.1164" class="difflineminus">-  nsresult rv = MsgNewBufferedFileOutputStream(getter_AddRefs(destOutputStream), *tmp_file, -1, 0600);</span>
<a href="#l23.1165"></a><span id="l23.1165" class="difflineplus">+  nsresult rv = MsgNewBufferedFileOutputStream(getter_AddRefs(destOutputStream),</span>
<a href="#l23.1166"></a><span id="l23.1166" class="difflineplus">+                                               *tmp_file, -1, 0600);</span>
<a href="#l23.1167"></a><span id="l23.1167">   if (NS_SUCCEEDED(rv))</span>
<a href="#l23.1168"></a><span id="l23.1168" class="difflineminus">-    rv = ImportMailboxRunnable::ImportMessage(lpMsg, destOutputStream, nsIMsgSend::nsMsgSaveAsDraft);</span>
<a href="#l23.1169"></a><span id="l23.1169" class="difflineplus">+    rv = ImportMailboxRunnable::ImportMessage(lpMsg, destOutputStream,</span>
<a href="#l23.1170"></a><span id="l23.1170" class="difflineplus">+                                              nsIMsgSend::nsMsgSaveAsDraft);</span>
<a href="#l23.1171"></a><span id="l23.1171"> </span>
<a href="#l23.1172"></a><span id="l23.1172">   if (NS_FAILED(rv)) {</span>
<a href="#l23.1173"></a><span id="l23.1173">     (*tmp_file)-&gt;Remove(false);</span>
<a href="#l23.1174"></a><span id="l23.1174">     (*tmp_file)-&gt;Release();</span>
<a href="#l23.1175"></a><span id="l23.1175">     *tmp_file = 0;</span>
<a href="#l23.1176"></a><span id="l23.1176">   }</span>
<a href="#l23.1177"></a><span id="l23.1177"> </span>
<a href="#l23.1178"></a><span id="l23.1178">   return NS_SUCCEEDED(rv);</span>
<a href="#l23.1179"></a><span id="l23.1179"> }</span>
<a href="#l23.1180"></a><span id="l23.1180"> </span>
<a href="#l23.1181"></a><span id="l23.1181" class="difflineminus">-bool CMapiMessage::CopyBinAttachToFile(LPATTACH lpAttach,</span>
<a href="#l23.1182"></a><span id="l23.1182" class="difflineminus">-                                       nsIFile **tmp_file)</span>
<a href="#l23.1183"></a><span id="l23.1183" class="difflineminus">-{</span>
<a href="#l23.1184"></a><span id="l23.1184" class="difflineplus">+bool CMapiMessage::CopyBinAttachToFile(LPATTACH lpAttach, nsIFile** tmp_file) {</span>
<a href="#l23.1185"></a><span id="l23.1185">   nsCOMPtr&lt;nsIFile&gt; _tmp_file;</span>
<a href="#l23.1186"></a><span id="l23.1186" class="difflineminus">-  nsresult rv = GetSpecialDirectoryWithFileName(NS_OS_TEMP_DIR,</span>
<a href="#l23.1187"></a><span id="l23.1187" class="difflineminus">-    &quot;mapiattach.tmp&quot;,</span>
<a href="#l23.1188"></a><span id="l23.1188" class="difflineminus">-    getter_AddRefs(_tmp_file));</span>
<a href="#l23.1189"></a><span id="l23.1189" class="difflineplus">+  nsresult rv = GetSpecialDirectoryWithFileName(</span>
<a href="#l23.1190"></a><span id="l23.1190" class="difflineplus">+      NS_OS_TEMP_DIR, &quot;mapiattach.tmp&quot;, getter_AddRefs(_tmp_file));</span>
<a href="#l23.1191"></a><span id="l23.1191">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l23.1192"></a><span id="l23.1192"> </span>
<a href="#l23.1193"></a><span id="l23.1193">   rv = _tmp_file-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 00600);</span>
<a href="#l23.1194"></a><span id="l23.1194">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l23.1195"></a><span id="l23.1195"> </span>
<a href="#l23.1196"></a><span id="l23.1196">   nsString tmpPath = _tmp_file-&gt;NativePath();</span>
<a href="#l23.1197"></a><span id="l23.1197">   // We have to use native charset unless we migrate to Outlook 2013 &quot;W&quot; API.</span>
<a href="#l23.1198"></a><span id="l23.1198">   nsCString tmpNativePath;</span>
<a href="#l23.1199"></a><span id="l23.1199">   rv = NS_CopyUnicodeToNative(tmpPath, tmpNativePath);</span>
<a href="#l23.1200"></a><span id="l23.1200">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l23.1201"></a><span id="l23.1201">   LPSTREAM lpStreamFile;</span>
<a href="#l23.1202"></a><span id="l23.1202" class="difflineminus">-  HRESULT hr = CMapiApi::OpenStreamOnFile(gpMapiAllocateBuffer, gpMapiFreeBuffer, STGM_READWRITE | STGM_CREATE,</span>
<a href="#l23.1203"></a><span id="l23.1203" class="difflineminus">-    tmpNativePath.get(), NULL, &amp;lpStreamFile);</span>
<a href="#l23.1204"></a><span id="l23.1204" class="difflineplus">+  HRESULT hr = CMapiApi::OpenStreamOnFile(</span>
<a href="#l23.1205"></a><span id="l23.1205" class="difflineplus">+      gpMapiAllocateBuffer, gpMapiFreeBuffer, STGM_READWRITE | STGM_CREATE,</span>
<a href="#l23.1206"></a><span id="l23.1206" class="difflineplus">+      tmpNativePath.get(), NULL, &amp;lpStreamFile);</span>
<a href="#l23.1207"></a><span id="l23.1207">   if (HR_FAILED(hr)) {</span>
<a href="#l23.1208"></a><span id="l23.1208">     MAPI_TRACE1(&quot;~~ERROR~~ OpenStreamOnFile failed - temp path: %s\r\n&quot;,</span>
<a href="#l23.1209"></a><span id="l23.1209">                 tmpNativePath.get());</span>
<a href="#l23.1210"></a><span id="l23.1210">     return false;</span>
<a href="#l23.1211"></a><span id="l23.1211">   }</span>
<a href="#l23.1212"></a><span id="l23.1212"> </span>
<a href="#l23.1213"></a><span id="l23.1213">   bool bResult = true;</span>
<a href="#l23.1214"></a><span id="l23.1214">   LPSTREAM lpAttachStream;</span>
<a href="#l23.1215"></a><span id="l23.1215" class="difflineminus">-  hr = lpAttach-&gt;OpenProperty(PR_ATTACH_DATA_BIN, &amp;IID_IStream, 0, 0, (LPUNKNOWN *)&amp;lpAttachStream);</span>
<a href="#l23.1216"></a><span id="l23.1216" class="difflineplus">+  hr = lpAttach-&gt;OpenProperty(PR_ATTACH_DATA_BIN, &amp;IID_IStream, 0, 0,</span>
<a href="#l23.1217"></a><span id="l23.1217" class="difflineplus">+                              (LPUNKNOWN*)&amp;lpAttachStream);</span>
<a href="#l23.1218"></a><span id="l23.1218"> </span>
<a href="#l23.1219"></a><span id="l23.1219">   if (HR_FAILED(hr)) {</span>
<a href="#l23.1220"></a><span id="l23.1220">     MAPI_TRACE0(&quot;~~ERROR~~ OpenProperty failed for PR_ATTACH_DATA_BIN.\r\n&quot;);</span>
<a href="#l23.1221"></a><span id="l23.1221">     lpAttachStream = NULL;</span>
<a href="#l23.1222"></a><span id="l23.1222">     bResult = false;</span>
<a href="#l23.1223"></a><span id="l23.1223" class="difflineminus">-  }</span>
<a href="#l23.1224"></a><span id="l23.1224" class="difflineminus">-  else {</span>
<a href="#l23.1225"></a><span id="l23.1225" class="difflineplus">+  } else {</span>
<a href="#l23.1226"></a><span id="l23.1226">     STATSTG st;</span>
<a href="#l23.1227"></a><span id="l23.1227">     hr = lpAttachStream-&gt;Stat(&amp;st, STATFLAG_NONAME);</span>
<a href="#l23.1228"></a><span id="l23.1228">     if (HR_FAILED(hr)) {</span>
<a href="#l23.1229"></a><span id="l23.1229">       MAPI_TRACE0(&quot;~~ERROR~~ Stat failed for attachment stream\r\n&quot;);</span>
<a href="#l23.1230"></a><span id="l23.1230">       bResult = false;</span>
<a href="#l23.1231"></a><span id="l23.1231" class="difflineminus">-    }</span>
<a href="#l23.1232"></a><span id="l23.1232" class="difflineminus">-    else {</span>
<a href="#l23.1233"></a><span id="l23.1233" class="difflineplus">+    } else {</span>
<a href="#l23.1234"></a><span id="l23.1234">       hr = lpAttachStream-&gt;CopyTo(lpStreamFile, st.cbSize, NULL, NULL);</span>
<a href="#l23.1235"></a><span id="l23.1235">       if (HR_FAILED(hr)) {</span>
<a href="#l23.1236"></a><span id="l23.1236">         MAPI_TRACE0(&quot;~~ERROR~~ Attach Stream CopyTo temp file failed.\r\n&quot;);</span>
<a href="#l23.1237"></a><span id="l23.1237">         bResult = false;</span>
<a href="#l23.1238"></a><span id="l23.1238">       }</span>
<a href="#l23.1239"></a><span id="l23.1239">     }</span>
<a href="#l23.1240"></a><span id="l23.1240">   }</span>
<a href="#l23.1241"></a><span id="l23.1241"> </span>
<a href="#l23.1242"></a><span id="l23.1242" class="difflineminus">-  if (lpAttachStream)</span>
<a href="#l23.1243"></a><span id="l23.1243" class="difflineminus">-    lpAttachStream-&gt;Release();</span>
<a href="#l23.1244"></a><span id="l23.1244" class="difflineplus">+  if (lpAttachStream) lpAttachStream-&gt;Release();</span>
<a href="#l23.1245"></a><span id="l23.1245">   lpStreamFile-&gt;Release();</span>
<a href="#l23.1246"></a><span id="l23.1246">   if (!bResult)</span>
<a href="#l23.1247"></a><span id="l23.1247">     _tmp_file-&gt;Remove(false);</span>
<a href="#l23.1248"></a><span id="l23.1248">   else</span>
<a href="#l23.1249"></a><span id="l23.1249">     _tmp_file.forget(tmp_file);</span>
<a href="#l23.1250"></a><span id="l23.1250"> </span>
<a href="#l23.1251"></a><span id="l23.1251">   return bResult;</span>
<a href="#l23.1252"></a><span id="l23.1252"> }</span>
<a href="#l23.1253"></a><span id="l23.1253"> </span>
<a href="#l23.1254"></a><span id="l23.1254" class="difflineminus">-bool CMapiMessage::GetURL(nsIFile *aFile, nsIURI **url)</span>
<a href="#l23.1255"></a><span id="l23.1255" class="difflineminus">-{</span>
<a href="#l23.1256"></a><span id="l23.1256" class="difflineminus">-  if (!m_pIOService)</span>
<a href="#l23.1257"></a><span id="l23.1257" class="difflineminus">-    return false;</span>
<a href="#l23.1258"></a><span id="l23.1258" class="difflineplus">+bool CMapiMessage::GetURL(nsIFile* aFile, nsIURI** url) {</span>
<a href="#l23.1259"></a><span id="l23.1259" class="difflineplus">+  if (!m_pIOService) return false;</span>
<a href="#l23.1260"></a><span id="l23.1260"> </span>
<a href="#l23.1261"></a><span id="l23.1261">   nsresult rv = m_pIOService-&gt;NewFileURI(aFile, url);</span>
<a href="#l23.1262"></a><span id="l23.1262">   return NS_SUCCEEDED(rv);</span>
<a href="#l23.1263"></a><span id="l23.1263"> }</span>
<a href="#l23.1264"></a><span id="l23.1264"> </span>
<a href="#l23.1265"></a><span id="l23.1265" class="difflineminus">-bool CMapiMessage::AddAttachment(DWORD aNum)</span>
<a href="#l23.1266"></a><span id="l23.1266" class="difflineminus">-{</span>
<a href="#l23.1267"></a><span id="l23.1267" class="difflineplus">+bool CMapiMessage::AddAttachment(DWORD aNum) {</span>
<a href="#l23.1268"></a><span id="l23.1268">   LPATTACH lpAttach = NULL;</span>
<a href="#l23.1269"></a><span id="l23.1269">   HRESULT hr = m_lpMsg-&gt;OpenAttach(aNum, NULL, 0, &amp;lpAttach);</span>
<a href="#l23.1270"></a><span id="l23.1270">   if (HR_FAILED(hr)) {</span>
<a href="#l23.1271"></a><span id="l23.1271" class="difflineminus">-    MAPI_TRACE2(&quot;\t\t****Attachment error, unable to open attachment: %d, 0x%lx\r\n&quot;, idx, hr);</span>
<a href="#l23.1272"></a><span id="l23.1272" class="difflineplus">+    MAPI_TRACE2(</span>
<a href="#l23.1273"></a><span id="l23.1273" class="difflineplus">+        &quot;\t\t****Attachment error, unable to open attachment: %d, 0x%lx\r\n&quot;,</span>
<a href="#l23.1274"></a><span id="l23.1274" class="difflineplus">+        idx, hr);</span>
<a href="#l23.1275"></a><span id="l23.1275">     return false;</span>
<a href="#l23.1276"></a><span id="l23.1276">   }</span>
<a href="#l23.1277"></a><span id="l23.1277"> </span>
<a href="#l23.1278"></a><span id="l23.1278">   bool bResult = false;</span>
<a href="#l23.1279"></a><span id="l23.1279" class="difflineminus">-  attach_data *data = new attach_data;</span>
<a href="#l23.1280"></a><span id="l23.1280" class="difflineplus">+  attach_data* data = new attach_data;</span>
<a href="#l23.1281"></a><span id="l23.1281">   ULONG aMethod;</span>
<a href="#l23.1282"></a><span id="l23.1282">   if (data) {</span>
<a href="#l23.1283"></a><span id="l23.1283">     bResult = true;</span>
<a href="#l23.1284"></a><span id="l23.1284"> </span>
<a href="#l23.1285"></a><span id="l23.1285">     // 1. Get the file that contains the attachment data</span>
<a href="#l23.1286"></a><span id="l23.1286">     LPSPropValue pVal = CMapiApi::GetMapiProperty(lpAttach, PR_ATTACH_METHOD);</span>
<a href="#l23.1287"></a><span id="l23.1287">     if (pVal) {</span>
<a href="#l23.1288"></a><span id="l23.1288">       aMethod = CMapiApi::GetLongFromProp(pVal);</span>
<a href="#l23.1289"></a><span id="l23.1289">       switch (aMethod) {</span>
<a href="#l23.1290"></a><span id="l23.1290" class="difflineminus">-      case ATTACH_BY_VALUE:</span>
<a href="#l23.1291"></a><span id="l23.1291" class="difflineminus">-        MAPI_TRACE1(&quot;\t\t** Attachment #%d by value.\r\n&quot;, aNum);</span>
<a href="#l23.1292"></a><span id="l23.1292" class="difflineminus">-        bResult = CopyBinAttachToFile(lpAttach, getter_AddRefs(data-&gt;tmp_file));</span>
<a href="#l23.1293"></a><span id="l23.1293" class="difflineminus">-        data-&gt;delete_file = true;</span>
<a href="#l23.1294"></a><span id="l23.1294" class="difflineminus">-        break;</span>
<a href="#l23.1295"></a><span id="l23.1295" class="difflineminus">-      case ATTACH_BY_REFERENCE:</span>
<a href="#l23.1296"></a><span id="l23.1296" class="difflineminus">-      case ATTACH_BY_REF_RESOLVE:</span>
<a href="#l23.1297"></a><span id="l23.1297" class="difflineminus">-      case ATTACH_BY_REF_ONLY:</span>
<a href="#l23.1298"></a><span id="l23.1298" class="difflineminus">-        pVal = CMapiApi::GetMapiProperty(lpAttach, PR_ATTACH_PATHNAME_W);</span>
<a href="#l23.1299"></a><span id="l23.1299" class="difflineminus">-        if (pVal) {</span>
<a href="#l23.1300"></a><span id="l23.1300" class="difflineminus">-          nsCString path;</span>
<a href="#l23.1301"></a><span id="l23.1301" class="difflineminus">-          CMapiApi::GetStringFromProp(pVal, path);</span>
<a href="#l23.1302"></a><span id="l23.1302" class="difflineminus">-          nsresult rv;</span>
<a href="#l23.1303"></a><span id="l23.1303" class="difflineminus">-          data-&gt;tmp_file = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l23.1304"></a><span id="l23.1304" class="difflineminus">-          if (NS_FAILED(rv) || !data-&gt;tmp_file) {</span>
<a href="#l23.1305"></a><span id="l23.1305" class="difflineminus">-            MAPI_TRACE0(&quot;*** Error creating file spec for attachment\n&quot;);</span>
<a href="#l23.1306"></a><span id="l23.1306" class="difflineminus">-            bResult = false;</span>
<a href="#l23.1307"></a><span id="l23.1307" class="difflineplus">+        case ATTACH_BY_VALUE:</span>
<a href="#l23.1308"></a><span id="l23.1308" class="difflineplus">+          MAPI_TRACE1(&quot;\t\t** Attachment #%d by value.\r\n&quot;, aNum);</span>
<a href="#l23.1309"></a><span id="l23.1309" class="difflineplus">+          bResult =</span>
<a href="#l23.1310"></a><span id="l23.1310" class="difflineplus">+              CopyBinAttachToFile(lpAttach, getter_AddRefs(data-&gt;tmp_file));</span>
<a href="#l23.1311"></a><span id="l23.1311" class="difflineplus">+          data-&gt;delete_file = true;</span>
<a href="#l23.1312"></a><span id="l23.1312" class="difflineplus">+          break;</span>
<a href="#l23.1313"></a><span id="l23.1313" class="difflineplus">+        case ATTACH_BY_REFERENCE:</span>
<a href="#l23.1314"></a><span id="l23.1314" class="difflineplus">+        case ATTACH_BY_REF_RESOLVE:</span>
<a href="#l23.1315"></a><span id="l23.1315" class="difflineplus">+        case ATTACH_BY_REF_ONLY:</span>
<a href="#l23.1316"></a><span id="l23.1316" class="difflineplus">+          pVal = CMapiApi::GetMapiProperty(lpAttach, PR_ATTACH_PATHNAME_W);</span>
<a href="#l23.1317"></a><span id="l23.1317" class="difflineplus">+          if (pVal) {</span>
<a href="#l23.1318"></a><span id="l23.1318" class="difflineplus">+            nsCString path;</span>
<a href="#l23.1319"></a><span id="l23.1319" class="difflineplus">+            CMapiApi::GetStringFromProp(pVal, path);</span>
<a href="#l23.1320"></a><span id="l23.1320" class="difflineplus">+            nsresult rv;</span>
<a href="#l23.1321"></a><span id="l23.1321" class="difflineplus">+            data-&gt;tmp_file = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l23.1322"></a><span id="l23.1322" class="difflineplus">+            if (NS_FAILED(rv) || !data-&gt;tmp_file) {</span>
<a href="#l23.1323"></a><span id="l23.1323" class="difflineplus">+              MAPI_TRACE0(&quot;*** Error creating file spec for attachment\n&quot;);</span>
<a href="#l23.1324"></a><span id="l23.1324" class="difflineplus">+              bResult = false;</span>
<a href="#l23.1325"></a><span id="l23.1325" class="difflineplus">+            } else</span>
<a href="#l23.1326"></a><span id="l23.1326" class="difflineplus">+              data-&gt;tmp_file-&gt;InitWithNativePath(path);</span>
<a href="#l23.1327"></a><span id="l23.1327">           }</span>
<a href="#l23.1328"></a><span id="l23.1328" class="difflineminus">-          else data-&gt;tmp_file-&gt;InitWithNativePath(path);</span>
<a href="#l23.1329"></a><span id="l23.1329" class="difflineminus">-        }</span>
<a href="#l23.1330"></a><span id="l23.1330" class="difflineminus">-        MAPI_TRACE2(&quot;\t\t** Attachment #%d by ref: %s\r\n&quot;,</span>
<a href="#l23.1331"></a><span id="l23.1331" class="difflineminus">-          aNum, m_attachPath.get());</span>
<a href="#l23.1332"></a><span id="l23.1332" class="difflineminus">-        break;</span>
<a href="#l23.1333"></a><span id="l23.1333" class="difflineminus">-      case ATTACH_EMBEDDED_MSG:</span>
<a href="#l23.1334"></a><span id="l23.1334" class="difflineminus">-        MAPI_TRACE1(&quot;\t\t** Attachment #%d by Embedded Message??\r\n&quot;, aNum);</span>
<a href="#l23.1335"></a><span id="l23.1335" class="difflineminus">-        // Convert the embedded IMessage from PR_ATTACH_DATA_OBJ to rfc822 attachment</span>
<a href="#l23.1336"></a><span id="l23.1336" class="difflineminus">-        // (see http://msdn.microsoft.com/en-us/library/cc842329.aspx)</span>
<a href="#l23.1337"></a><span id="l23.1337" class="difflineminus">-        // This is a recursive call.</span>
<a href="#l23.1338"></a><span id="l23.1338" class="difflineminus">-        bResult = CopyMsgAttachToFile(lpAttach, getter_AddRefs(data-&gt;tmp_file));</span>
<a href="#l23.1339"></a><span id="l23.1339" class="difflineminus">-        data-&gt;delete_file = true;</span>
<a href="#l23.1340"></a><span id="l23.1340" class="difflineminus">-        break;</span>
<a href="#l23.1341"></a><span id="l23.1341" class="difflineminus">-      case ATTACH_OLE:</span>
<a href="#l23.1342"></a><span id="l23.1342" class="difflineminus">-        MAPI_TRACE1(&quot;\t\t** Attachment #%d by OLE - yuck!!!\r\n&quot;, aNum);</span>
<a href="#l23.1343"></a><span id="l23.1343" class="difflineminus">-        break;</span>
<a href="#l23.1344"></a><span id="l23.1344" class="difflineminus">-      default:</span>
<a href="#l23.1345"></a><span id="l23.1345" class="difflineminus">-        MAPI_TRACE2(&quot;\t\t** Attachment #%d unknown attachment method - 0x%lx\r\n&quot;, aNum, aMethod);</span>
<a href="#l23.1346"></a><span id="l23.1346" class="difflineminus">-        bResult = false;</span>
<a href="#l23.1347"></a><span id="l23.1347" class="difflineplus">+          MAPI_TRACE2(&quot;\t\t** Attachment #%d by ref: %s\r\n&quot;, aNum,</span>
<a href="#l23.1348"></a><span id="l23.1348" class="difflineplus">+                      m_attachPath.get());</span>
<a href="#l23.1349"></a><span id="l23.1349" class="difflineplus">+          break;</span>
<a href="#l23.1350"></a><span id="l23.1350" class="difflineplus">+        case ATTACH_EMBEDDED_MSG:</span>
<a href="#l23.1351"></a><span id="l23.1351" class="difflineplus">+          MAPI_TRACE1(&quot;\t\t** Attachment #%d by Embedded Message??\r\n&quot;, aNum);</span>
<a href="#l23.1352"></a><span id="l23.1352" class="difflineplus">+          // Convert the embedded IMessage from PR_ATTACH_DATA_OBJ to rfc822</span>
<a href="#l23.1353"></a><span id="l23.1353" class="difflineplus">+          // attachment (see</span>
<a href="#l23.1354"></a><span id="l23.1354" class="difflineplus">+          // http://msdn.microsoft.com/en-us/library/cc842329.aspx) This is a</span>
<a href="#l23.1355"></a><span id="l23.1355" class="difflineplus">+          // recursive call.</span>
<a href="#l23.1356"></a><span id="l23.1356" class="difflineplus">+          bResult =</span>
<a href="#l23.1357"></a><span id="l23.1357" class="difflineplus">+              CopyMsgAttachToFile(lpAttach, getter_AddRefs(data-&gt;tmp_file));</span>
<a href="#l23.1358"></a><span id="l23.1358" class="difflineplus">+          data-&gt;delete_file = true;</span>
<a href="#l23.1359"></a><span id="l23.1359" class="difflineplus">+          break;</span>
<a href="#l23.1360"></a><span id="l23.1360" class="difflineplus">+        case ATTACH_OLE:</span>
<a href="#l23.1361"></a><span id="l23.1361" class="difflineplus">+          MAPI_TRACE1(&quot;\t\t** Attachment #%d by OLE - yuck!!!\r\n&quot;, aNum);</span>
<a href="#l23.1362"></a><span id="l23.1362" class="difflineplus">+          break;</span>
<a href="#l23.1363"></a><span id="l23.1363" class="difflineplus">+        default:</span>
<a href="#l23.1364"></a><span id="l23.1364" class="difflineplus">+          MAPI_TRACE2(</span>
<a href="#l23.1365"></a><span id="l23.1365" class="difflineplus">+              &quot;\t\t** Attachment #%d unknown attachment method - 0x%lx\r\n&quot;,</span>
<a href="#l23.1366"></a><span id="l23.1366" class="difflineplus">+              aNum, aMethod);</span>
<a href="#l23.1367"></a><span id="l23.1367" class="difflineplus">+          bResult = false;</span>
<a href="#l23.1368"></a><span id="l23.1368">       }</span>
<a href="#l23.1369"></a><span id="l23.1369" class="difflineminus">-    }</span>
<a href="#l23.1370"></a><span id="l23.1370" class="difflineminus">-    else</span>
<a href="#l23.1371"></a><span id="l23.1371" class="difflineplus">+    } else</span>
<a href="#l23.1372"></a><span id="l23.1372">       bResult = false;</span>
<a href="#l23.1373"></a><span id="l23.1373"> </span>
<a href="#l23.1374"></a><span id="l23.1374" class="difflineminus">-    if (bResult)</span>
<a href="#l23.1375"></a><span id="l23.1375" class="difflineminus">-      bResult = data-&gt;tmp_file;</span>
<a href="#l23.1376"></a><span id="l23.1376" class="difflineplus">+    if (bResult) bResult = data-&gt;tmp_file;</span>
<a href="#l23.1377"></a><span id="l23.1377"> </span>
<a href="#l23.1378"></a><span id="l23.1378">     if (bResult) {</span>
<a href="#l23.1379"></a><span id="l23.1379">       bool isFile = false;</span>
<a href="#l23.1380"></a><span id="l23.1380">       bool exists = false;</span>
<a href="#l23.1381"></a><span id="l23.1381">       data-&gt;tmp_file-&gt;Exists(&amp;exists);</span>
<a href="#l23.1382"></a><span id="l23.1382">       data-&gt;tmp_file-&gt;IsFile(&amp;isFile);</span>
<a href="#l23.1383"></a><span id="l23.1383"> </span>
<a href="#l23.1384"></a><span id="l23.1384">       if (!exists || !isFile) {</span>
<a href="#l23.1385"></a><span id="l23.1385" class="difflineat">@@ -1019,449 +991,403 @@ bool CMapiMessage::AddAttachment(DWORD a</span>
<a href="#l23.1386"></a><span id="l23.1386"> </span>
<a href="#l23.1387"></a><span id="l23.1387">       nsString fname, fext;</span>
<a href="#l23.1388"></a><span id="l23.1388">       pVal = CMapiApi::GetMapiProperty(lpAttach, PR_ATTACH_LONG_FILENAME_W);</span>
<a href="#l23.1389"></a><span id="l23.1389">       if (!pVal)</span>
<a href="#l23.1390"></a><span id="l23.1390">         pVal = CMapiApi::GetMapiProperty(lpAttach, PR_ATTACH_FILENAME_W);</span>
<a href="#l23.1391"></a><span id="l23.1391">       CMapiApi::GetStringFromProp(pVal, fname);</span>
<a href="#l23.1392"></a><span id="l23.1392">       pVal = CMapiApi::GetMapiProperty(lpAttach, PR_ATTACH_EXTENSION_W);</span>
<a href="#l23.1393"></a><span id="l23.1393">       CMapiApi::GetStringFromProp(pVal, fext);</span>
<a href="#l23.1394"></a><span id="l23.1394" class="difflineminus">-      MAPI_TRACE2(&quot;\t\t\t--- File name: %s, extension: %s\r\n&quot;,</span>
<a href="#l23.1395"></a><span id="l23.1395" class="difflineminus">-        fname.get(), fext.get());</span>
<a href="#l23.1396"></a><span id="l23.1396" class="difflineplus">+      MAPI_TRACE2(&quot;\t\t\t--- File name: %s, extension: %s\r\n&quot;, fname.get(),</span>
<a href="#l23.1397"></a><span id="l23.1397" class="difflineplus">+                  fext.get());</span>
<a href="#l23.1398"></a><span id="l23.1398"> </span>
<a href="#l23.1399"></a><span id="l23.1399">       if (fext.IsEmpty()) {</span>
<a href="#l23.1400"></a><span id="l23.1400">         int idx = fname.RFindChar(L'.');</span>
<a href="#l23.1401"></a><span id="l23.1401" class="difflineminus">-        if (idx != -1)</span>
<a href="#l23.1402"></a><span id="l23.1402" class="difflineminus">-          fext = Substring(fname, idx);</span>
<a href="#l23.1403"></a><span id="l23.1403" class="difflineminus">-      }</span>
<a href="#l23.1404"></a><span id="l23.1404" class="difflineminus">-      else if (fname.RFindChar(L'.') == -1) {</span>
<a href="#l23.1405"></a><span id="l23.1405" class="difflineplus">+        if (idx != -1) fext = Substring(fname, idx);</span>
<a href="#l23.1406"></a><span id="l23.1406" class="difflineplus">+      } else if (fname.RFindChar(L'.') == -1) {</span>
<a href="#l23.1407"></a><span id="l23.1407">         fname += L&quot;.&quot;;</span>
<a href="#l23.1408"></a><span id="l23.1408">         fname += fext;</span>
<a href="#l23.1409"></a><span id="l23.1409">       }</span>
<a href="#l23.1410"></a><span id="l23.1410">       if (fname.IsEmpty()) {</span>
<a href="#l23.1411"></a><span id="l23.1411">         // If no description use &quot;Attachment i&quot; format.</span>
<a href="#l23.1412"></a><span id="l23.1412">         fname = L&quot;Attachment &quot;;</span>
<a href="#l23.1413"></a><span id="l23.1413">         fname.AppendInt(static_cast&lt;uint32_t&gt;(aNum));</span>
<a href="#l23.1414"></a><span id="l23.1414">       }</span>
<a href="#l23.1415"></a><span id="l23.1415">       data-&gt;real_name = ToNewUTF8String(fname);</span>
<a href="#l23.1416"></a><span id="l23.1416"> </span>
<a href="#l23.1417"></a><span id="l23.1417">       nsCString tmp;</span>
<a href="#l23.1418"></a><span id="l23.1418" class="difflineminus">-       // We have converted it to the rfc822 document</span>
<a href="#l23.1419"></a><span id="l23.1419" class="difflineplus">+      // We have converted it to the rfc822 document</span>
<a href="#l23.1420"></a><span id="l23.1420">       if (aMethod == ATTACH_EMBEDDED_MSG) {</span>
<a href="#l23.1421"></a><span id="l23.1421">         data-&gt;type = NS_xstrdup(MESSAGE_RFC822);</span>
<a href="#l23.1422"></a><span id="l23.1422">       } else {</span>
<a href="#l23.1423"></a><span id="l23.1423">         pVal = CMapiApi::GetMapiProperty(lpAttach, PR_ATTACH_MIME_TAG_A);</span>
<a href="#l23.1424"></a><span id="l23.1424">         CMapiApi::GetStringFromProp(pVal, tmp);</span>
<a href="#l23.1425"></a><span id="l23.1425">         MAPI_TRACE1(&quot;\t\t\t--- Mime type: %s\r\n&quot;, tmp.get());</span>
<a href="#l23.1426"></a><span id="l23.1426">         if (tmp.IsEmpty()) {</span>
<a href="#l23.1427"></a><span id="l23.1427" class="difflineminus">-          uint8_t *pType = NULL;</span>
<a href="#l23.1428"></a><span id="l23.1428" class="difflineplus">+          uint8_t* pType = NULL;</span>
<a href="#l23.1429"></a><span id="l23.1429">           if (!fext.IsEmpty()) {</span>
<a href="#l23.1430"></a><span id="l23.1430">             pType = CMimeTypes::GetMimeType(fext);</span>
<a href="#l23.1431"></a><span id="l23.1431">           }</span>
<a href="#l23.1432"></a><span id="l23.1432">           if (pType)</span>
<a href="#l23.1433"></a><span id="l23.1433">             data-&gt;type = NS_xstrdup((PC_S8)pType);</span>
<a href="#l23.1434"></a><span id="l23.1434">           else</span>
<a href="#l23.1435"></a><span id="l23.1435">             data-&gt;type = NS_xstrdup(APPLICATION_OCTET_STREAM);</span>
<a href="#l23.1436"></a><span id="l23.1436" class="difflineminus">-        }</span>
<a href="#l23.1437"></a><span id="l23.1437" class="difflineminus">-        else</span>
<a href="#l23.1438"></a><span id="l23.1438" class="difflineplus">+        } else</span>
<a href="#l23.1439"></a><span id="l23.1439">           data-&gt;type = ToNewCString(tmp);</span>
<a href="#l23.1440"></a><span id="l23.1440">       }</span>
<a href="#l23.1441"></a><span id="l23.1441"> </span>
<a href="#l23.1442"></a><span id="l23.1442">       pVal = CMapiApi::GetMapiProperty(lpAttach, PR_ATTACH_CONTENT_ID_A);</span>
<a href="#l23.1443"></a><span id="l23.1443">       CMapiApi::GetStringFromProp(pVal, tmp);</span>
<a href="#l23.1444"></a><span id="l23.1444" class="difflineminus">-      if (!tmp.IsEmpty())</span>
<a href="#l23.1445"></a><span id="l23.1445" class="difflineminus">-        data-&gt;cid = ToNewCString(tmp);</span>
<a href="#l23.1446"></a><span id="l23.1446" class="difflineplus">+      if (!tmp.IsEmpty()) data-&gt;cid = ToNewCString(tmp);</span>
<a href="#l23.1447"></a><span id="l23.1447">     }</span>
<a href="#l23.1448"></a><span id="l23.1448">     if (bResult) {</span>
<a href="#l23.1449"></a><span id="l23.1449">       // Now we need to decide if this attachment is embedded or not.</span>
<a href="#l23.1450"></a><span id="l23.1450">       // At first, I tried to simply check for the presence of the Content-Id.</span>
<a href="#l23.1451"></a><span id="l23.1451" class="difflineminus">-      // But it turned out that this method is unreliable, since there exist cases</span>
<a href="#l23.1452"></a><span id="l23.1452" class="difflineminus">-      // when an attachment has a Content-Id while isn't embedded (even in a message</span>
<a href="#l23.1453"></a><span id="l23.1453" class="difflineminus">-      // with a plain-text body!). So next I tried to look for &lt;img&gt; tags that contain</span>
<a href="#l23.1454"></a><span id="l23.1454" class="difflineminus">-      // the found Content-Id. But this is unreliable, too, because there exist cases</span>
<a href="#l23.1455"></a><span id="l23.1455" class="difflineminus">-      // where other places of HTML reference the embedded messages (e.g. it may be</span>
<a href="#l23.1456"></a><span id="l23.1456" class="difflineminus">-      // a background of a table cell, or some CSS; further, it is possible that the</span>
<a href="#l23.1457"></a><span id="l23.1457" class="difflineminus">-      // reference to an embedded object is not in the main body, but in another</span>
<a href="#l23.1458"></a><span id="l23.1458" class="difflineminus">-      // embedded object - like body references a CSS attachment that in turn references</span>
<a href="#l23.1459"></a><span id="l23.1459" class="difflineminus">-      // a picture as a background of its element). From the other hand, it's unreliable</span>
<a href="#l23.1460"></a><span id="l23.1460" class="difflineminus">-      // to relax the search criteria to any occurrence of the Content-Id string in the body -</span>
<a href="#l23.1461"></a><span id="l23.1461" class="difflineminus">-      // partly because the string may be simply in a text or other non-referencing part,</span>
<a href="#l23.1462"></a><span id="l23.1462" class="difflineminus">-      // partly because of the abovementioned possibility that the reference is outside</span>
<a href="#l23.1463"></a><span id="l23.1463" class="difflineminus">-      // the body at all.</span>
<a href="#l23.1464"></a><span id="l23.1464" class="difflineminus">-      // There exist the PR_ATTACH_FLAGS property of the attachment. The MS documentation</span>
<a href="#l23.1465"></a><span id="l23.1465" class="difflineminus">-      // tells about two possible flags in it: ATT_INVISIBLE_IN_HTML and ATT_INVISIBLE_IN_RTF.</span>
<a href="#l23.1466"></a><span id="l23.1466" class="difflineminus">-      // There is at least one more undocumented flag: ATT_MHTML_REF. Some sources in Internet</span>
<a href="#l23.1467"></a><span id="l23.1467" class="difflineminus">-      // suggest simply check for the latter flag to distinguish between the embedded</span>
<a href="#l23.1468"></a><span id="l23.1468" class="difflineminus">-      // and ordinary attachments. But my observations indicate that even if the flags</span>
<a href="#l23.1469"></a><span id="l23.1469" class="difflineminus">-      // don't include ATT_MHTML_REF, the attachment is still may be embedded.</span>
<a href="#l23.1470"></a><span id="l23.1470" class="difflineminus">-      // However, my observations always show that the message is embedded if the flags</span>
<a href="#l23.1471"></a><span id="l23.1471" class="difflineminus">-      // is not 0.</span>
<a href="#l23.1472"></a><span id="l23.1472" class="difflineminus">-      // So now I will simply test for the non-zero flags to decide whether the attachment</span>
<a href="#l23.1473"></a><span id="l23.1473" class="difflineminus">-      // is embedded or not. Possible advantage is reliability (I hope).</span>
<a href="#l23.1474"></a><span id="l23.1474" class="difflineminus">-      // Another advantage is that it's much faster than search the body for Content-Id.</span>
<a href="#l23.1475"></a><span id="l23.1475" class="difflineplus">+      // But it turned out that this method is unreliable, since there exist</span>
<a href="#l23.1476"></a><span id="l23.1476" class="difflineplus">+      // cases when an attachment has a Content-Id while isn't embedded (even in</span>
<a href="#l23.1477"></a><span id="l23.1477" class="difflineplus">+      // a message with a plain-text body!). So next I tried to look for &lt;img&gt;</span>
<a href="#l23.1478"></a><span id="l23.1478" class="difflineplus">+      // tags that contain the found Content-Id. But this is unreliable, too,</span>
<a href="#l23.1479"></a><span id="l23.1479" class="difflineplus">+      // because there exist cases where other places of HTML reference the</span>
<a href="#l23.1480"></a><span id="l23.1480" class="difflineplus">+      // embedded messages (e.g. it may be a background of a table cell, or some</span>
<a href="#l23.1481"></a><span id="l23.1481" class="difflineplus">+      // CSS; further, it is possible that the reference to an embedded object</span>
<a href="#l23.1482"></a><span id="l23.1482" class="difflineplus">+      // is not in the main body, but in another embedded object - like body</span>
<a href="#l23.1483"></a><span id="l23.1483" class="difflineplus">+      // references a CSS attachment that in turn references a picture as a</span>
<a href="#l23.1484"></a><span id="l23.1484" class="difflineplus">+      // background of its element). From the other hand, it's unreliable to</span>
<a href="#l23.1485"></a><span id="l23.1485" class="difflineplus">+      // relax the search criteria to any occurrence of the Content-Id string in</span>
<a href="#l23.1486"></a><span id="l23.1486" class="difflineplus">+      // the body - partly because the string may be simply in a text or other</span>
<a href="#l23.1487"></a><span id="l23.1487" class="difflineplus">+      // non-referencing part, partly because of the abovementioned possibility</span>
<a href="#l23.1488"></a><span id="l23.1488" class="difflineplus">+      // that the reference is outside the body at all. There exist the</span>
<a href="#l23.1489"></a><span id="l23.1489" class="difflineplus">+      // PR_ATTACH_FLAGS property of the attachment. The MS documentation tells</span>
<a href="#l23.1490"></a><span id="l23.1490" class="difflineplus">+      // about two possible flags in it: ATT_INVISIBLE_IN_HTML and</span>
<a href="#l23.1491"></a><span id="l23.1491" class="difflineplus">+      // ATT_INVISIBLE_IN_RTF. There is at least one more undocumented flag:</span>
<a href="#l23.1492"></a><span id="l23.1492" class="difflineplus">+      // ATT_MHTML_REF. Some sources in Internet suggest simply check for the</span>
<a href="#l23.1493"></a><span id="l23.1493" class="difflineplus">+      // latter flag to distinguish between the embedded and ordinary</span>
<a href="#l23.1494"></a><span id="l23.1494" class="difflineplus">+      // attachments. But my observations indicate that even if the flags don't</span>
<a href="#l23.1495"></a><span id="l23.1495" class="difflineplus">+      // include ATT_MHTML_REF, the attachment is still may be embedded.</span>
<a href="#l23.1496"></a><span id="l23.1496" class="difflineplus">+      // However, my observations always show that the message is embedded if</span>
<a href="#l23.1497"></a><span id="l23.1497" class="difflineplus">+      // the flags is not 0. So now I will simply test for the non-zero flags to</span>
<a href="#l23.1498"></a><span id="l23.1498" class="difflineplus">+      // decide whether the attachment is embedded or not. Possible advantage is</span>
<a href="#l23.1499"></a><span id="l23.1499" class="difflineplus">+      // reliability (I hope). Another advantage is that it's much faster than</span>
<a href="#l23.1500"></a><span id="l23.1500" class="difflineplus">+      // search the body for Content-Id.</span>
<a href="#l23.1501"></a><span id="l23.1501"> </span>
<a href="#l23.1502"></a><span id="l23.1502">       DWORD flags = 0;</span>
<a href="#l23.1503"></a><span id="l23.1503"> </span>
<a href="#l23.1504"></a><span id="l23.1504">       pVal = CMapiApi::GetMapiProperty(lpAttach, PR_ATTACH_FLAGS);</span>
<a href="#l23.1505"></a><span id="l23.1505" class="difflineminus">-      if (pVal)</span>
<a href="#l23.1506"></a><span id="l23.1506" class="difflineminus">-        flags = CMapiApi::GetLongFromProp(pVal);</span>
<a href="#l23.1507"></a><span id="l23.1507" class="difflineminus">-      if (m_bodyIsHtml &amp;&amp; data-&gt;cid &amp;&amp; (flags != 0)) // this is the embedded attachment</span>
<a href="#l23.1508"></a><span id="l23.1508" class="difflineplus">+      if (pVal) flags = CMapiApi::GetLongFromProp(pVal);</span>
<a href="#l23.1509"></a><span id="l23.1509" class="difflineplus">+      if (m_bodyIsHtml &amp;&amp; data-&gt;cid &amp;&amp;</span>
<a href="#l23.1510"></a><span id="l23.1510" class="difflineplus">+          (flags != 0))  // this is the embedded attachment</span>
<a href="#l23.1511"></a><span id="l23.1511">         m_embattachments.push_back(data);</span>
<a href="#l23.1512"></a><span id="l23.1512" class="difflineminus">-      else // this is ordinary attachment</span>
<a href="#l23.1513"></a><span id="l23.1513" class="difflineplus">+      else  // this is ordinary attachment</span>
<a href="#l23.1514"></a><span id="l23.1514">         m_stdattachments.push_back(data);</span>
<a href="#l23.1515"></a><span id="l23.1515" class="difflineminus">-    }</span>
<a href="#l23.1516"></a><span id="l23.1516" class="difflineminus">-    else {</span>
<a href="#l23.1517"></a><span id="l23.1517" class="difflineplus">+    } else {</span>
<a href="#l23.1518"></a><span id="l23.1518">       delete data;</span>
<a href="#l23.1519"></a><span id="l23.1519">     }</span>
<a href="#l23.1520"></a><span id="l23.1520">   }</span>
<a href="#l23.1521"></a><span id="l23.1521"> </span>
<a href="#l23.1522"></a><span id="l23.1522">   lpAttach-&gt;Release();</span>
<a href="#l23.1523"></a><span id="l23.1523">   return bResult;</span>
<a href="#l23.1524"></a><span id="l23.1524"> }</span>
<a href="#l23.1525"></a><span id="l23.1525"> </span>
<a href="#l23.1526"></a><span id="l23.1526" class="difflineminus">-void CMapiMessage::ClearAttachment(attach_data* data)</span>
<a href="#l23.1527"></a><span id="l23.1527" class="difflineminus">-{</span>
<a href="#l23.1528"></a><span id="l23.1528" class="difflineminus">-  if (data-&gt;delete_file &amp;&amp; data-&gt;tmp_file)</span>
<a href="#l23.1529"></a><span id="l23.1529" class="difflineminus">-    data-&gt;tmp_file-&gt;Remove(false);</span>
<a href="#l23.1530"></a><span id="l23.1530" class="difflineplus">+void CMapiMessage::ClearAttachment(attach_data* data) {</span>
<a href="#l23.1531"></a><span id="l23.1531" class="difflineplus">+  if (data-&gt;delete_file &amp;&amp; data-&gt;tmp_file) data-&gt;tmp_file-&gt;Remove(false);</span>
<a href="#l23.1532"></a><span id="l23.1532"> </span>
<a href="#l23.1533"></a><span id="l23.1533" class="difflineminus">-  if (data-&gt;type)</span>
<a href="#l23.1534"></a><span id="l23.1534" class="difflineminus">-    free(data-&gt;type);</span>
<a href="#l23.1535"></a><span id="l23.1535" class="difflineminus">-  if (data-&gt;encoding)</span>
<a href="#l23.1536"></a><span id="l23.1536" class="difflineminus">-    free(data-&gt;encoding);</span>
<a href="#l23.1537"></a><span id="l23.1537" class="difflineminus">-  if (data-&gt;real_name)</span>
<a href="#l23.1538"></a><span id="l23.1538" class="difflineminus">-    free(data-&gt;real_name);</span>
<a href="#l23.1539"></a><span id="l23.1539" class="difflineminus">-  if (data-&gt;cid)</span>
<a href="#l23.1540"></a><span id="l23.1540" class="difflineminus">-    free(data-&gt;cid);</span>
<a href="#l23.1541"></a><span id="l23.1541" class="difflineplus">+  if (data-&gt;type) free(data-&gt;type);</span>
<a href="#l23.1542"></a><span id="l23.1542" class="difflineplus">+  if (data-&gt;encoding) free(data-&gt;encoding);</span>
<a href="#l23.1543"></a><span id="l23.1543" class="difflineplus">+  if (data-&gt;real_name) free(data-&gt;real_name);</span>
<a href="#l23.1544"></a><span id="l23.1544" class="difflineplus">+  if (data-&gt;cid) free(data-&gt;cid);</span>
<a href="#l23.1545"></a><span id="l23.1545"> </span>
<a href="#l23.1546"></a><span id="l23.1546">   delete data;</span>
<a href="#l23.1547"></a><span id="l23.1547"> }</span>
<a href="#l23.1548"></a><span id="l23.1548"> </span>
<a href="#l23.1549"></a><span id="l23.1549" class="difflineminus">-void CMapiMessage::ClearAttachments()</span>
<a href="#l23.1550"></a><span id="l23.1550" class="difflineminus">-{</span>
<a href="#l23.1551"></a><span id="l23.1551" class="difflineminus">-  std::for_each(m_stdattachments.begin(), m_stdattachments.end(), ClearAttachment);</span>
<a href="#l23.1552"></a><span id="l23.1552" class="difflineplus">+void CMapiMessage::ClearAttachments() {</span>
<a href="#l23.1553"></a><span id="l23.1553" class="difflineplus">+  std::for_each(m_stdattachments.begin(), m_stdattachments.end(),</span>
<a href="#l23.1554"></a><span id="l23.1554" class="difflineplus">+                ClearAttachment);</span>
<a href="#l23.1555"></a><span id="l23.1555">   m_stdattachments.clear();</span>
<a href="#l23.1556"></a><span id="l23.1556" class="difflineminus">-  std::for_each(m_embattachments.begin(), m_embattachments.end(), ClearAttachment);</span>
<a href="#l23.1557"></a><span id="l23.1557" class="difflineplus">+  std::for_each(m_embattachments.begin(), m_embattachments.end(),</span>
<a href="#l23.1558"></a><span id="l23.1558" class="difflineplus">+                ClearAttachment);</span>
<a href="#l23.1559"></a><span id="l23.1559">   m_embattachments.clear();</span>
<a href="#l23.1560"></a><span id="l23.1560"> }</span>
<a href="#l23.1561"></a><span id="l23.1561"> </span>
<a href="#l23.1562"></a><span id="l23.1562"> // This method must be called AFTER the retrieval of the body,</span>
<a href="#l23.1563"></a><span id="l23.1563"> // since the decision if an attachment is embedded or not is made</span>
<a href="#l23.1564"></a><span id="l23.1564"> // based on the body type and contents</span>
<a href="#l23.1565"></a><span id="l23.1565" class="difflineminus">-void CMapiMessage::ProcessAttachments()</span>
<a href="#l23.1566"></a><span id="l23.1566" class="difflineminus">-{</span>
<a href="#l23.1567"></a><span id="l23.1567" class="difflineplus">+void CMapiMessage::ProcessAttachments() {</span>
<a href="#l23.1568"></a><span id="l23.1568">   LPSPropValue pVal = CMapiApi::GetMapiProperty(m_lpMsg, PR_HASATTACH);</span>
<a href="#l23.1569"></a><span id="l23.1569">   bool hasAttach = true;</span>
<a href="#l23.1570"></a><span id="l23.1570"> </span>
<a href="#l23.1571"></a><span id="l23.1571">   if (pVal) {</span>
<a href="#l23.1572"></a><span id="l23.1572">     if (PROP_TYPE(pVal-&gt;ulPropTag) == PT_BOOLEAN)</span>
<a href="#l23.1573"></a><span id="l23.1573">       hasAttach = (pVal-&gt;Value.b != 0);</span>
<a href="#l23.1574"></a><span id="l23.1574">     CMapiApi::MAPIFreeBuffer(pVal);</span>
<a href="#l23.1575"></a><span id="l23.1575">   }</span>
<a href="#l23.1576"></a><span id="l23.1576"> </span>
<a href="#l23.1577"></a><span id="l23.1577" class="difflineminus">-  if (!hasAttach)</span>
<a href="#l23.1578"></a><span id="l23.1578" class="difflineminus">-    return;</span>
<a href="#l23.1579"></a><span id="l23.1579" class="difflineplus">+  if (!hasAttach) return;</span>
<a href="#l23.1580"></a><span id="l23.1580"> </span>
<a href="#l23.1581"></a><span id="l23.1581">   // Get the attachment table?</span>
<a href="#l23.1582"></a><span id="l23.1582">   LPMAPITABLE pTable = NULL;</span>
<a href="#l23.1583"></a><span id="l23.1583">   HRESULT hr = m_lpMsg-&gt;GetAttachmentTable(0, &amp;pTable);</span>
<a href="#l23.1584"></a><span id="l23.1584" class="difflineminus">-  if (FAILED(hr) || !pTable)</span>
<a href="#l23.1585"></a><span id="l23.1585" class="difflineminus">-    return;</span>
<a href="#l23.1586"></a><span id="l23.1586" class="difflineplus">+  if (FAILED(hr) || !pTable) return;</span>
<a href="#l23.1587"></a><span id="l23.1587">   IterateAttachTable(pTable);</span>
<a href="#l23.1588"></a><span id="l23.1588">   pTable-&gt;Release();</span>
<a href="#l23.1589"></a><span id="l23.1589"> }</span>
<a href="#l23.1590"></a><span id="l23.1590"> </span>
<a href="#l23.1591"></a><span id="l23.1591" class="difflineminus">-nsresult CMapiMessage::GetAttachments(nsIArray **aArray)</span>
<a href="#l23.1592"></a><span id="l23.1592" class="difflineminus">-{</span>
<a href="#l23.1593"></a><span id="l23.1593" class="difflineplus">+nsresult CMapiMessage::GetAttachments(nsIArray** aArray) {</span>
<a href="#l23.1594"></a><span id="l23.1594">   nsresult rv;</span>
<a href="#l23.1595"></a><span id="l23.1595" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; attachments (do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l23.1596"></a><span id="l23.1596" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; attachments(</span>
<a href="#l23.1597"></a><span id="l23.1597" class="difflineplus">+      do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l23.1598"></a><span id="l23.1598">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1599"></a><span id="l23.1599"> </span>
<a href="#l23.1600"></a><span id="l23.1600">   for (std::vector&lt;attach_data*&gt;::const_iterator it = m_stdattachments.begin();</span>
<a href="#l23.1601"></a><span id="l23.1601">        it != m_stdattachments.end(); it++) {</span>
<a href="#l23.1602"></a><span id="l23.1602" class="difflineminus">-    nsCOMPtr&lt;nsIMsgAttachedFile&gt; a(do_CreateInstance(NS_MSGATTACHEDFILE_CONTRACTID, &amp;rv));</span>
<a href="#l23.1603"></a><span id="l23.1603" class="difflineplus">+    nsCOMPtr&lt;nsIMsgAttachedFile&gt; a(</span>
<a href="#l23.1604"></a><span id="l23.1604" class="difflineplus">+        do_CreateInstance(NS_MSGATTACHEDFILE_CONTRACTID, &amp;rv));</span>
<a href="#l23.1605"></a><span id="l23.1605">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l23.1606"></a><span id="l23.1606">     a-&gt;SetOrigUrl((*it)-&gt;orig_url);</span>
<a href="#l23.1607"></a><span id="l23.1607">     a-&gt;SetTmpFile((*it)-&gt;tmp_file);</span>
<a href="#l23.1608"></a><span id="l23.1608">     a-&gt;SetEncoding(nsDependentCString((*it)-&gt;encoding));</span>
<a href="#l23.1609"></a><span id="l23.1609">     a-&gt;SetRealName(nsDependentCString((*it)-&gt;real_name));</span>
<a href="#l23.1610"></a><span id="l23.1610">     a-&gt;SetType(nsDependentCString((*it)-&gt;type));</span>
<a href="#l23.1611"></a><span id="l23.1611">     attachments-&gt;AppendElement(a);</span>
<a href="#l23.1612"></a><span id="l23.1612">   }</span>
<a href="#l23.1613"></a><span id="l23.1613">   attachments.forget(aArray);</span>
<a href="#l23.1614"></a><span id="l23.1614">   return rv;</span>
<a href="#l23.1615"></a><span id="l23.1615"> }</span>
<a href="#l23.1616"></a><span id="l23.1616"> </span>
<a href="#l23.1617"></a><span id="l23.1617" class="difflineminus">-bool CMapiMessage::GetEmbeddedAttachmentInfo(unsigned int i, nsIURI **uri,</span>
<a href="#l23.1618"></a><span id="l23.1618" class="difflineminus">-                                             const char **cid,</span>
<a href="#l23.1619"></a><span id="l23.1619" class="difflineminus">-                                             const char **name) const</span>
<a href="#l23.1620"></a><span id="l23.1620" class="difflineminus">-{</span>
<a href="#l23.1621"></a><span id="l23.1621" class="difflineminus">-  if ((i &lt; 0) || (i &gt;= m_embattachments.size()))</span>
<a href="#l23.1622"></a><span id="l23.1622" class="difflineminus">-    return false;</span>
<a href="#l23.1623"></a><span id="l23.1623" class="difflineplus">+bool CMapiMessage::GetEmbeddedAttachmentInfo(unsigned int i, nsIURI** uri,</span>
<a href="#l23.1624"></a><span id="l23.1624" class="difflineplus">+                                             const char** cid,</span>
<a href="#l23.1625"></a><span id="l23.1625" class="difflineplus">+                                             const char** name) const {</span>
<a href="#l23.1626"></a><span id="l23.1626" class="difflineplus">+  if ((i &lt; 0) || (i &gt;= m_embattachments.size())) return false;</span>
<a href="#l23.1627"></a><span id="l23.1627">   attach_data* data = m_embattachments[i];</span>
<a href="#l23.1628"></a><span id="l23.1628" class="difflineminus">-  if (!data)</span>
<a href="#l23.1629"></a><span id="l23.1629" class="difflineminus">-    return false;</span>
<a href="#l23.1630"></a><span id="l23.1630" class="difflineplus">+  if (!data) return false;</span>
<a href="#l23.1631"></a><span id="l23.1631">   *uri = data-&gt;orig_url;</span>
<a href="#l23.1632"></a><span id="l23.1632">   *cid = data-&gt;cid;</span>
<a href="#l23.1633"></a><span id="l23.1633">   *name = data-&gt;real_name;</span>
<a href="#l23.1634"></a><span id="l23.1634">   return true;</span>
<a href="#l23.1635"></a><span id="l23.1635"> }</span>
<a href="#l23.1636"></a><span id="l23.1636"> </span>
<a href="#l23.1637"></a><span id="l23.1637"> //////////////////////////////////////////////////////</span>
<a href="#l23.1638"></a><span id="l23.1638"> </span>
<a href="#l23.1639"></a><span id="l23.1639"> // begin and end MUST point to the same string</span>
<a href="#l23.1640"></a><span id="l23.1640" class="difflineminus">-char* dup(const char* begin, const char* end)</span>
<a href="#l23.1641"></a><span id="l23.1641" class="difflineminus">-{</span>
<a href="#l23.1642"></a><span id="l23.1642" class="difflineminus">-  if (begin &gt;= end)</span>
<a href="#l23.1643"></a><span id="l23.1643" class="difflineminus">-    return 0;</span>
<a href="#l23.1644"></a><span id="l23.1644" class="difflineminus">-  char* str = new char[end-begin+1];</span>
<a href="#l23.1645"></a><span id="l23.1645" class="difflineminus">-  memcpy(str, begin, (end-begin)*sizeof(begin[0]));</span>
<a href="#l23.1646"></a><span id="l23.1646" class="difflineplus">+char* dup(const char* begin, const char* end) {</span>
<a href="#l23.1647"></a><span id="l23.1647" class="difflineplus">+  if (begin &gt;= end) return 0;</span>
<a href="#l23.1648"></a><span id="l23.1648" class="difflineplus">+  char* str = new char[end - begin + 1];</span>
<a href="#l23.1649"></a><span id="l23.1649" class="difflineplus">+  memcpy(str, begin, (end - begin) * sizeof(begin[0]));</span>
<a href="#l23.1650"></a><span id="l23.1650">   str[end - begin] = 0;</span>
<a href="#l23.1651"></a><span id="l23.1651">   return str;</span>
<a href="#l23.1652"></a><span id="l23.1652"> }</span>
<a href="#l23.1653"></a><span id="l23.1653"> </span>
<a href="#l23.1654"></a><span id="l23.1654"> // See RFC822</span>
<a href="#l23.1655"></a><span id="l23.1655"> // 9 = '\t', 32 = ' '.</span>
<a href="#l23.1656"></a><span id="l23.1656"> inline bool IsPrintableASCII(char c) { return (c &gt; ' ') &amp;&amp; (c &lt; 127); }</span>
<a href="#l23.1657"></a><span id="l23.1657"> inline bool IsWSP(char c) { return (c == ' ') || (c == '\t'); }</span>
<a href="#l23.1658"></a><span id="l23.1658"> </span>
<a href="#l23.1659"></a><span id="l23.1659"> CMapiMessageHeaders::CHeaderField::CHeaderField(const char* begin, int len)</span>
<a href="#l23.1660"></a><span id="l23.1660" class="difflineminus">-  : m_fname(0), m_fbody(0), m_fbody_utf8(false)</span>
<a href="#l23.1661"></a><span id="l23.1661" class="difflineminus">-{</span>
<a href="#l23.1662"></a><span id="l23.1662" class="difflineminus">-  const char *end = begin+len, *fname_end = begin;</span>
<a href="#l23.1663"></a><span id="l23.1663" class="difflineminus">-  while ((fname_end &lt; end) &amp;&amp; IsPrintableASCII(*fname_end) &amp;&amp; (*fname_end != ':'))</span>
<a href="#l23.1664"></a><span id="l23.1664" class="difflineplus">+    : m_fname(0), m_fbody(0), m_fbody_utf8(false) {</span>
<a href="#l23.1665"></a><span id="l23.1665" class="difflineplus">+  const char *end = begin + len, *fname_end = begin;</span>
<a href="#l23.1666"></a><span id="l23.1666" class="difflineplus">+  while ((fname_end &lt; end) &amp;&amp; IsPrintableASCII(*fname_end) &amp;&amp;</span>
<a href="#l23.1667"></a><span id="l23.1667" class="difflineplus">+         (*fname_end != ':'))</span>
<a href="#l23.1668"></a><span id="l23.1668">     ++fname_end;</span>
<a href="#l23.1669"></a><span id="l23.1669" class="difflineminus">-  if ((fname_end == end) || (*fname_end != ':'))</span>
<a href="#l23.1670"></a><span id="l23.1670" class="difflineminus">-    return; // Not a valid header!</span>
<a href="#l23.1671"></a><span id="l23.1671" class="difflineminus">-  m_fname = dup(begin, fname_end+1); // including colon</span>
<a href="#l23.1672"></a><span id="l23.1672" class="difflineminus">-  m_fbody = dup(fname_end+1, end);</span>
<a href="#l23.1673"></a><span id="l23.1673" class="difflineplus">+  if ((fname_end == end) || (*fname_end != ':')) return;  // Not a valid header!</span>
<a href="#l23.1674"></a><span id="l23.1674" class="difflineplus">+  m_fname = dup(begin, fname_end + 1);                    // including colon</span>
<a href="#l23.1675"></a><span id="l23.1675" class="difflineplus">+  m_fbody = dup(fname_end + 1, end);</span>
<a href="#l23.1676"></a><span id="l23.1676"> }</span>
<a href="#l23.1677"></a><span id="l23.1677"> </span>
<a href="#l23.1678"></a><span id="l23.1678" class="difflineminus">-CMapiMessageHeaders::CHeaderField::CHeaderField(const char* name, const char* body, bool utf8)</span>
<a href="#l23.1679"></a><span id="l23.1679" class="difflineminus">-  : m_fname(dup(name, name+strlen(name))), m_fbody(dup(body, body+strlen(body))), m_fbody_utf8(utf8)</span>
<a href="#l23.1680"></a><span id="l23.1680" class="difflineminus">-{</span>
<a href="#l23.1681"></a><span id="l23.1681" class="difflineminus">-}</span>
<a href="#l23.1682"></a><span id="l23.1682" class="difflineplus">+CMapiMessageHeaders::CHeaderField::CHeaderField(const char* name,</span>
<a href="#l23.1683"></a><span id="l23.1683" class="difflineplus">+                                                const char* body, bool utf8)</span>
<a href="#l23.1684"></a><span id="l23.1684" class="difflineplus">+    : m_fname(dup(name, name + strlen(name))),</span>
<a href="#l23.1685"></a><span id="l23.1685" class="difflineplus">+      m_fbody(dup(body, body + strlen(body))),</span>
<a href="#l23.1686"></a><span id="l23.1686" class="difflineplus">+      m_fbody_utf8(utf8) {}</span>
<a href="#l23.1687"></a><span id="l23.1687"> </span>
<a href="#l23.1688"></a><span id="l23.1688" class="difflineminus">-CMapiMessageHeaders::CHeaderField::~CHeaderField()</span>
<a href="#l23.1689"></a><span id="l23.1689" class="difflineminus">-{</span>
<a href="#l23.1690"></a><span id="l23.1690" class="difflineplus">+CMapiMessageHeaders::CHeaderField::~CHeaderField() {</span>
<a href="#l23.1691"></a><span id="l23.1691">   delete[] m_fname;</span>
<a href="#l23.1692"></a><span id="l23.1692">   delete[] m_fbody;</span>
<a href="#l23.1693"></a><span id="l23.1693"> }</span>
<a href="#l23.1694"></a><span id="l23.1694"> </span>
<a href="#l23.1695"></a><span id="l23.1695" class="difflineminus">-void CMapiMessageHeaders::CHeaderField::set_fbody(const char* txt)</span>
<a href="#l23.1696"></a><span id="l23.1696" class="difflineminus">-{</span>
<a href="#l23.1697"></a><span id="l23.1697" class="difflineminus">-  if (m_fbody == txt)</span>
<a href="#l23.1698"></a><span id="l23.1698" class="difflineminus">-    return; // to avoid assigning to self</span>
<a href="#l23.1699"></a><span id="l23.1699" class="difflineplus">+void CMapiMessageHeaders::CHeaderField::set_fbody(const char* txt) {</span>
<a href="#l23.1700"></a><span id="l23.1700" class="difflineplus">+  if (m_fbody == txt) return;  // to avoid assigning to self</span>
<a href="#l23.1701"></a><span id="l23.1701">   char* oldbody = m_fbody;</span>
<a href="#l23.1702"></a><span id="l23.1702" class="difflineminus">-  m_fbody = dup(txt, txt+strlen(txt));</span>
<a href="#l23.1703"></a><span id="l23.1703" class="difflineplus">+  m_fbody = dup(txt, txt + strlen(txt));</span>
<a href="#l23.1704"></a><span id="l23.1704">   delete[] oldbody;</span>
<a href="#l23.1705"></a><span id="l23.1705">   m_fbody_utf8 = true;</span>
<a href="#l23.1706"></a><span id="l23.1706"> }</span>
<a href="#l23.1707"></a><span id="l23.1707"> </span>
<a href="#l23.1708"></a><span id="l23.1708" class="difflineminus">-void CMapiMessageHeaders::CHeaderField::GetUnfoldedString(nsString&amp; dest,</span>
<a href="#l23.1709"></a><span id="l23.1709" class="difflineminus">-                                          const char* fallbackCharset) const</span>
<a href="#l23.1710"></a><span id="l23.1710" class="difflineminus">-{</span>
<a href="#l23.1711"></a><span id="l23.1711" class="difflineplus">+void CMapiMessageHeaders::CHeaderField::GetUnfoldedString(</span>
<a href="#l23.1712"></a><span id="l23.1712" class="difflineplus">+    nsString&amp; dest, const char* fallbackCharset) const {</span>
<a href="#l23.1713"></a><span id="l23.1713">   dest.Truncate();</span>
<a href="#l23.1714"></a><span id="l23.1714" class="difflineminus">-  if (!m_fbody)</span>
<a href="#l23.1715"></a><span id="l23.1715" class="difflineminus">-    return;</span>
<a href="#l23.1716"></a><span id="l23.1716" class="difflineplus">+  if (!m_fbody) return;</span>
<a href="#l23.1717"></a><span id="l23.1717"> </span>
<a href="#l23.1718"></a><span id="l23.1718">   nsCString unfolded;</span>
<a href="#l23.1719"></a><span id="l23.1719">   const char* pos = m_fbody;</span>
<a href="#l23.1720"></a><span id="l23.1720">   while (*pos) {</span>
<a href="#l23.1721"></a><span id="l23.1721" class="difflineminus">-    if ((*pos == nsCRT::CR) &amp;&amp; (*(pos+1) == nsCRT::LF) &amp;&amp; IsWSP(*(pos+2)))</span>
<a href="#l23.1722"></a><span id="l23.1722" class="difflineminus">-      pos += 2; // Skip CRLF if it is followed by SPACE or TAB</span>
<a href="#l23.1723"></a><span id="l23.1723" class="difflineplus">+    if ((*pos == nsCRT::CR) &amp;&amp; (*(pos + 1) == nsCRT::LF) &amp;&amp; IsWSP(*(pos + 2)))</span>
<a href="#l23.1724"></a><span id="l23.1724" class="difflineplus">+      pos += 2;  // Skip CRLF if it is followed by SPACE or TAB</span>
<a href="#l23.1725"></a><span id="l23.1725">     else</span>
<a href="#l23.1726"></a><span id="l23.1726">       unfolded.Append(*(pos++));</span>
<a href="#l23.1727"></a><span id="l23.1727">   }</span>
<a href="#l23.1728"></a><span id="l23.1728">   if (m_fbody_utf8)</span>
<a href="#l23.1729"></a><span id="l23.1729">     CopyUTF8toUTF16(unfolded, dest);</span>
<a href="#l23.1730"></a><span id="l23.1730">   else</span>
<a href="#l23.1731"></a><span id="l23.1731" class="difflineminus">-    nsMsgI18NConvertToUnicode(fallbackCharset ?</span>
<a href="#l23.1732"></a><span id="l23.1732" class="difflineminus">-                                nsDependentCString(fallbackCharset) :</span>
<a href="#l23.1733"></a><span id="l23.1733" class="difflineminus">-                                EmptyCString(),</span>
<a href="#l23.1734"></a><span id="l23.1734" class="difflineminus">-                              unfolded,</span>
<a href="#l23.1735"></a><span id="l23.1735" class="difflineminus">-                              dest);</span>
<a href="#l23.1736"></a><span id="l23.1736" class="difflineplus">+    nsMsgI18NConvertToUnicode(</span>
<a href="#l23.1737"></a><span id="l23.1737" class="difflineplus">+        fallbackCharset ? nsDependentCString(fallbackCharset) : EmptyCString(),</span>
<a href="#l23.1738"></a><span id="l23.1738" class="difflineplus">+        unfolded, dest);</span>
<a href="#l23.1739"></a><span id="l23.1739"> }</span>
<a href="#l23.1740"></a><span id="l23.1740"> </span>
<a href="#l23.1741"></a><span id="l23.1741"> ////////////////////////////////////////</span>
<a href="#l23.1742"></a><span id="l23.1742"> </span>
<a href="#l23.1743"></a><span id="l23.1743"> const char* CMapiMessageHeaders::Specials[hdrMax] = {</span>
<a href="#l23.1744"></a><span id="l23.1744" class="difflineminus">-  &quot;Date:&quot;,</span>
<a href="#l23.1745"></a><span id="l23.1745" class="difflineminus">-  &quot;From:&quot;,</span>
<a href="#l23.1746"></a><span id="l23.1746" class="difflineminus">-  &quot;Sender:&quot;,</span>
<a href="#l23.1747"></a><span id="l23.1747" class="difflineminus">-  &quot;Reply-To:&quot;,</span>
<a href="#l23.1748"></a><span id="l23.1748" class="difflineminus">-  &quot;To:&quot;,</span>
<a href="#l23.1749"></a><span id="l23.1749" class="difflineminus">-  &quot;Cc:&quot;,</span>
<a href="#l23.1750"></a><span id="l23.1750" class="difflineminus">-  &quot;Bcc:&quot;,</span>
<a href="#l23.1751"></a><span id="l23.1751" class="difflineminus">-  &quot;Message-ID:&quot;,</span>
<a href="#l23.1752"></a><span id="l23.1752" class="difflineminus">-  &quot;Subject:&quot;,</span>
<a href="#l23.1753"></a><span id="l23.1753" class="difflineminus">-  &quot;Mime-Version:&quot;,</span>
<a href="#l23.1754"></a><span id="l23.1754" class="difflineminus">-  &quot;Content-Type:&quot;,</span>
<a href="#l23.1755"></a><span id="l23.1755" class="difflineminus">-  &quot;Content-Transfer-Encoding:&quot;</span>
<a href="#l23.1756"></a><span id="l23.1756" class="difflineminus">-};</span>
<a href="#l23.1757"></a><span id="l23.1757" class="difflineplus">+    &quot;Date:&quot;,    &quot;From:&quot;,         &quot;Sender:&quot;,       &quot;Reply-To:&quot;,</span>
<a href="#l23.1758"></a><span id="l23.1758" class="difflineplus">+    &quot;To:&quot;,      &quot;Cc:&quot;,           &quot;Bcc:&quot;,          &quot;Message-ID:&quot;,</span>
<a href="#l23.1759"></a><span id="l23.1759" class="difflineplus">+    &quot;Subject:&quot;, &quot;Mime-Version:&quot;, &quot;Content-Type:&quot;, &quot;Content-Transfer-Encoding:&quot;};</span>
<a href="#l23.1760"></a><span id="l23.1760"> </span>
<a href="#l23.1761"></a><span id="l23.1761" class="difflineminus">-CMapiMessageHeaders::~CMapiMessageHeaders()</span>
<a href="#l23.1762"></a><span id="l23.1762" class="difflineminus">-{</span>
<a href="#l23.1763"></a><span id="l23.1763" class="difflineminus">-  ClearHeaderFields();</span>
<a href="#l23.1764"></a><span id="l23.1764" class="difflineminus">-}</span>
<a href="#l23.1765"></a><span id="l23.1765" class="difflineplus">+CMapiMessageHeaders::~CMapiMessageHeaders() { ClearHeaderFields(); }</span>
<a href="#l23.1766"></a><span id="l23.1766"> </span>
<a href="#l23.1767"></a><span id="l23.1767"> void CMapiMessageHeaders::Delete(CHeaderField* p) { delete p; }</span>
<a href="#l23.1768"></a><span id="l23.1768"> </span>
<a href="#l23.1769"></a><span id="l23.1769" class="difflineminus">-void CMapiMessageHeaders::ClearHeaderFields()</span>
<a href="#l23.1770"></a><span id="l23.1770" class="difflineminus">-{</span>
<a href="#l23.1771"></a><span id="l23.1771" class="difflineplus">+void CMapiMessageHeaders::ClearHeaderFields() {</span>
<a href="#l23.1772"></a><span id="l23.1772">   std::for_each(m_headerFields.begin(), m_headerFields.end(), Delete);</span>
<a href="#l23.1773"></a><span id="l23.1773">   m_headerFields.clear();</span>
<a href="#l23.1774"></a><span id="l23.1774"> }</span>
<a href="#l23.1775"></a><span id="l23.1775"> </span>
<a href="#l23.1776"></a><span id="l23.1776" class="difflineminus">-void CMapiMessageHeaders::Assign(const char* headers)</span>
<a href="#l23.1777"></a><span id="l23.1777" class="difflineminus">-{</span>
<a href="#l23.1778"></a><span id="l23.1778" class="difflineminus">-  for (int i=0; i&lt;hdrMax; i++)</span>
<a href="#l23.1779"></a><span id="l23.1779" class="difflineminus">-    m_SpecialHeaders[i] = 0;</span>
<a href="#l23.1780"></a><span id="l23.1780" class="difflineplus">+void CMapiMessageHeaders::Assign(const char* headers) {</span>
<a href="#l23.1781"></a><span id="l23.1781" class="difflineplus">+  for (int i = 0; i &lt; hdrMax; i++) m_SpecialHeaders[i] = 0;</span>
<a href="#l23.1782"></a><span id="l23.1782">   ClearHeaderFields();</span>
<a href="#l23.1783"></a><span id="l23.1783" class="difflineminus">-  if (!headers)</span>
<a href="#l23.1784"></a><span id="l23.1784" class="difflineminus">-    return;</span>
<a href="#l23.1785"></a><span id="l23.1785" class="difflineplus">+  if (!headers) return;</span>
<a href="#l23.1786"></a><span id="l23.1786"> </span>
<a href="#l23.1787"></a><span id="l23.1787" class="difflineminus">-  const char *start=headers, *end=headers;</span>
<a href="#l23.1788"></a><span id="l23.1788" class="difflineplus">+  const char *start = headers, *end = headers;</span>
<a href="#l23.1789"></a><span id="l23.1789">   while (*end) {</span>
<a href="#l23.1790"></a><span id="l23.1790" class="difflineminus">-    if ((*end == nsCRT::CR) &amp;&amp; (*(end+1) == nsCRT::LF)) {</span>
<a href="#l23.1791"></a><span id="l23.1791" class="difflineminus">-      if (!IsWSP(*(end+2))) { // Not SPACE nor TAB (avoid FSP) -&gt; next header or EOF</span>
<a href="#l23.1792"></a><span id="l23.1792" class="difflineminus">-        Add(new CHeaderField(start, end-start));</span>
<a href="#l23.1793"></a><span id="l23.1793" class="difflineplus">+    if ((*end == nsCRT::CR) &amp;&amp; (*(end + 1) == nsCRT::LF)) {</span>
<a href="#l23.1794"></a><span id="l23.1794" class="difflineplus">+      if (!IsWSP(</span>
<a href="#l23.1795"></a><span id="l23.1795" class="difflineplus">+              *(end +</span>
<a href="#l23.1796"></a><span id="l23.1796" class="difflineplus">+                2))) {  // Not SPACE nor TAB (avoid FSP) -&gt; next header or EOF</span>
<a href="#l23.1797"></a><span id="l23.1797" class="difflineplus">+        Add(new CHeaderField(start, end - start));</span>
<a href="#l23.1798"></a><span id="l23.1798">         start = ++end + 1;</span>
<a href="#l23.1799"></a><span id="l23.1799">       }</span>
<a href="#l23.1800"></a><span id="l23.1800">     }</span>
<a href="#l23.1801"></a><span id="l23.1801">     ++end;</span>
<a href="#l23.1802"></a><span id="l23.1802">   }</span>
<a href="#l23.1803"></a><span id="l23.1803"> </span>
<a href="#l23.1804"></a><span id="l23.1804" class="difflineminus">-  if (start &lt; end) { // Last header left</span>
<a href="#l23.1805"></a><span id="l23.1805" class="difflineminus">-    Add(new CHeaderField(start, end-start));</span>
<a href="#l23.1806"></a><span id="l23.1806" class="difflineplus">+  if (start &lt; end) {  // Last header left</span>
<a href="#l23.1807"></a><span id="l23.1807" class="difflineplus">+    Add(new CHeaderField(start, end - start));</span>
<a href="#l23.1808"></a><span id="l23.1808">   }</span>
<a href="#l23.1809"></a><span id="l23.1809"> }</span>
<a href="#l23.1810"></a><span id="l23.1810"> </span>
<a href="#l23.1811"></a><span id="l23.1811" class="difflineminus">-void CMapiMessageHeaders::Add(CHeaderField* f)</span>
<a href="#l23.1812"></a><span id="l23.1812" class="difflineminus">-{</span>
<a href="#l23.1813"></a><span id="l23.1813" class="difflineminus">-  if (!f)</span>
<a href="#l23.1814"></a><span id="l23.1814" class="difflineminus">-    return;</span>
<a href="#l23.1815"></a><span id="l23.1815" class="difflineplus">+void CMapiMessageHeaders::Add(CHeaderField* f) {</span>
<a href="#l23.1816"></a><span id="l23.1816" class="difflineplus">+  if (!f) return;</span>
<a href="#l23.1817"></a><span id="l23.1817">   if (!f-&gt;Valid()) {</span>
<a href="#l23.1818"></a><span id="l23.1818">     delete f;</span>
<a href="#l23.1819"></a><span id="l23.1819">     return;</span>
<a href="#l23.1820"></a><span id="l23.1820">   }</span>
<a href="#l23.1821"></a><span id="l23.1821"> </span>
<a href="#l23.1822"></a><span id="l23.1822">   SpecialHeader idx = CheckSpecialHeader(f-&gt;fname());</span>
<a href="#l23.1823"></a><span id="l23.1823">   if (idx != hdrNone) {</span>
<a href="#l23.1824"></a><span id="l23.1824">     // Now check if the special header was already inserted;</span>
<a href="#l23.1825"></a><span id="l23.1825">     // if so, remove previous and add this new</span>
<a href="#l23.1826"></a><span id="l23.1826">     CHeaderField* PrevSpecial = m_SpecialHeaders[idx];</span>
<a href="#l23.1827"></a><span id="l23.1827">     if (PrevSpecial) {</span>
<a href="#l23.1828"></a><span id="l23.1828" class="difflineminus">-      std::vector&lt;CHeaderField*&gt;::iterator iter = std::find(m_headerFields.begin(), m_headerFields.end(), PrevSpecial);</span>
<a href="#l23.1829"></a><span id="l23.1829" class="difflineminus">-      if (iter != m_headerFields.end())</span>
<a href="#l23.1830"></a><span id="l23.1830" class="difflineminus">-        m_headerFields.erase(iter);</span>
<a href="#l23.1831"></a><span id="l23.1831" class="difflineplus">+      std::vector&lt;CHeaderField*&gt;::iterator iter =</span>
<a href="#l23.1832"></a><span id="l23.1832" class="difflineplus">+          std::find(m_headerFields.begin(), m_headerFields.end(), PrevSpecial);</span>
<a href="#l23.1833"></a><span id="l23.1833" class="difflineplus">+      if (iter != m_headerFields.end()) m_headerFields.erase(iter);</span>
<a href="#l23.1834"></a><span id="l23.1834">       delete PrevSpecial;</span>
<a href="#l23.1835"></a><span id="l23.1835">     }</span>
<a href="#l23.1836"></a><span id="l23.1836">     m_SpecialHeaders[idx] = f;</span>
<a href="#l23.1837"></a><span id="l23.1837">   }</span>
<a href="#l23.1838"></a><span id="l23.1838">   m_headerFields.push_back(f);</span>
<a href="#l23.1839"></a><span id="l23.1839"> }</span>
<a href="#l23.1840"></a><span id="l23.1840"> </span>
<a href="#l23.1841"></a><span id="l23.1841" class="difflineminus">-CMapiMessageHeaders::SpecialHeader CMapiMessageHeaders::CheckSpecialHeader(const char* fname)</span>
<a href="#l23.1842"></a><span id="l23.1842" class="difflineminus">-{</span>
<a href="#l23.1843"></a><span id="l23.1843" class="difflineplus">+CMapiMessageHeaders::SpecialHeader CMapiMessageHeaders::CheckSpecialHeader(</span>
<a href="#l23.1844"></a><span id="l23.1844" class="difflineplus">+    const char* fname) {</span>
<a href="#l23.1845"></a><span id="l23.1845">   for (int i = hdrFirst; i &lt; hdrMax; i++)</span>
<a href="#l23.1846"></a><span id="l23.1846" class="difflineminus">-    if (stricmp(fname, Specials[i]) == 0)</span>
<a href="#l23.1847"></a><span id="l23.1847" class="difflineminus">-      return static_cast&lt;SpecialHeader&gt;(i);</span>
<a href="#l23.1848"></a><span id="l23.1848" class="difflineplus">+    if (stricmp(fname, Specials[i]) == 0) return static_cast&lt;SpecialHeader&gt;(i);</span>
<a href="#l23.1849"></a><span id="l23.1849"> </span>
<a href="#l23.1850"></a><span id="l23.1850">   return hdrNone;</span>
<a href="#l23.1851"></a><span id="l23.1851"> }</span>
<a href="#l23.1852"></a><span id="l23.1852"> </span>
<a href="#l23.1853"></a><span id="l23.1853" class="difflineminus">-const CMapiMessageHeaders::CHeaderField* CMapiMessageHeaders::CFind(const char* name) const</span>
<a href="#l23.1854"></a><span id="l23.1854" class="difflineminus">-{</span>
<a href="#l23.1855"></a><span id="l23.1855" class="difflineplus">+const CMapiMessageHeaders::CHeaderField* CMapiMessageHeaders::CFind(</span>
<a href="#l23.1856"></a><span id="l23.1856" class="difflineplus">+    const char* name) const {</span>
<a href="#l23.1857"></a><span id="l23.1857">   SpecialHeader special = CheckSpecialHeader(name);</span>
<a href="#l23.1858"></a><span id="l23.1858">   if ((special &gt; hdrNone) &amp;&amp; (special &lt; hdrMax))</span>
<a href="#l23.1859"></a><span id="l23.1859" class="difflineminus">-    return m_SpecialHeaders[special]; // No need to search further, because it MUST be here</span>
<a href="#l23.1860"></a><span id="l23.1860" class="difflineplus">+    return m_SpecialHeaders[special];  // No need to search further, because it</span>
<a href="#l23.1861"></a><span id="l23.1861" class="difflineplus">+                                       // MUST be here</span>
<a href="#l23.1862"></a><span id="l23.1862"> </span>
<a href="#l23.1863"></a><span id="l23.1863" class="difflineminus">-  std::vector&lt;CHeaderField*&gt;::const_iterator iter = std::find_if(m_headerFields.begin(), m_headerFields.end(), fname_equals(name));</span>
<a href="#l23.1864"></a><span id="l23.1864" class="difflineminus">-  if (iter == m_headerFields.end())</span>
<a href="#l23.1865"></a><span id="l23.1865" class="difflineminus">-    return 0;</span>
<a href="#l23.1866"></a><span id="l23.1866" class="difflineplus">+  std::vector&lt;CHeaderField*&gt;::const_iterator iter = std::find_if(</span>
<a href="#l23.1867"></a><span id="l23.1867" class="difflineplus">+      m_headerFields.begin(), m_headerFields.end(), fname_equals(name));</span>
<a href="#l23.1868"></a><span id="l23.1868" class="difflineplus">+  if (iter == m_headerFields.end()) return 0;</span>
<a href="#l23.1869"></a><span id="l23.1869">   return *iter;</span>
<a href="#l23.1870"></a><span id="l23.1870"> }</span>
<a href="#l23.1871"></a><span id="l23.1871"> </span>
<a href="#l23.1872"></a><span id="l23.1872" class="difflineminus">-const char* CMapiMessageHeaders::SpecialName(SpecialHeader special)</span>
<a href="#l23.1873"></a><span id="l23.1873" class="difflineminus">-{</span>
<a href="#l23.1874"></a><span id="l23.1874" class="difflineminus">-  if ((special &lt;= hdrNone) || (special &gt;= hdrMax))</span>
<a href="#l23.1875"></a><span id="l23.1875" class="difflineminus">-    return 0;</span>
<a href="#l23.1876"></a><span id="l23.1876" class="difflineplus">+const char* CMapiMessageHeaders::SpecialName(SpecialHeader special) {</span>
<a href="#l23.1877"></a><span id="l23.1877" class="difflineplus">+  if ((special &lt;= hdrNone) || (special &gt;= hdrMax)) return 0;</span>
<a href="#l23.1878"></a><span id="l23.1878">   return Specials[special];</span>
<a href="#l23.1879"></a><span id="l23.1879"> }</span>
<a href="#l23.1880"></a><span id="l23.1880"> </span>
<a href="#l23.1881"></a><span id="l23.1881" class="difflineminus">-const char* CMapiMessageHeaders::Value(SpecialHeader special) const</span>
<a href="#l23.1882"></a><span id="l23.1882" class="difflineminus">-{</span>
<a href="#l23.1883"></a><span id="l23.1883" class="difflineminus">-  if ((special &lt;= hdrNone) || (special &gt;= hdrMax))</span>
<a href="#l23.1884"></a><span id="l23.1884" class="difflineminus">-    return 0;</span>
<a href="#l23.1885"></a><span id="l23.1885" class="difflineplus">+const char* CMapiMessageHeaders::Value(SpecialHeader special) const {</span>
<a href="#l23.1886"></a><span id="l23.1886" class="difflineplus">+  if ((special &lt;= hdrNone) || (special &gt;= hdrMax)) return 0;</span>
<a href="#l23.1887"></a><span id="l23.1887">   return (m_SpecialHeaders[special]) ? m_SpecialHeaders[special]-&gt;fbody() : 0;</span>
<a href="#l23.1888"></a><span id="l23.1888"> }</span>
<a href="#l23.1889"></a><span id="l23.1889"> </span>
<a href="#l23.1890"></a><span id="l23.1890" class="difflineminus">-const char* CMapiMessageHeaders::Value(const char* name) const</span>
<a href="#l23.1891"></a><span id="l23.1891" class="difflineminus">-{</span>
<a href="#l23.1892"></a><span id="l23.1892" class="difflineplus">+const char* CMapiMessageHeaders::Value(const char* name) const {</span>
<a href="#l23.1893"></a><span id="l23.1893">   const CHeaderField* result = CFind(name);</span>
<a href="#l23.1894"></a><span id="l23.1894">   return result ? result-&gt;fbody() : 0;</span>
<a href="#l23.1895"></a><span id="l23.1895"> }</span>
<a href="#l23.1896"></a><span id="l23.1896"> </span>
<a href="#l23.1897"></a><span id="l23.1897" class="difflineminus">-void CMapiMessageHeaders::UnfoldValue(const char* name, nsString&amp; dest, const char* fallbackCharset) const</span>
<a href="#l23.1898"></a><span id="l23.1898" class="difflineminus">-{</span>
<a href="#l23.1899"></a><span id="l23.1899" class="difflineplus">+void CMapiMessageHeaders::UnfoldValue(const char* name, nsString&amp; dest,</span>
<a href="#l23.1900"></a><span id="l23.1900" class="difflineplus">+                                      const char* fallbackCharset) const {</span>
<a href="#l23.1901"></a><span id="l23.1901">   const CHeaderField* result = CFind(name);</span>
<a href="#l23.1902"></a><span id="l23.1902">   if (result)</span>
<a href="#l23.1903"></a><span id="l23.1903">     result-&gt;GetUnfoldedString(dest, fallbackCharset);</span>
<a href="#l23.1904"></a><span id="l23.1904">   else</span>
<a href="#l23.1905"></a><span id="l23.1905">     dest.Truncate();</span>
<a href="#l23.1906"></a><span id="l23.1906"> }</span>
<a href="#l23.1907"></a><span id="l23.1907"> </span>
<a href="#l23.1908"></a><span id="l23.1908" class="difflineminus">-void CMapiMessageHeaders::UnfoldValue(SpecialHeader special, nsString&amp; dest, const char* fallbackCharset) const</span>
<a href="#l23.1909"></a><span id="l23.1909" class="difflineminus">-{</span>
<a href="#l23.1910"></a><span id="l23.1910" class="difflineminus">-  if ((special &lt;= hdrNone) || (special &gt;= hdrMax) || (!m_SpecialHeaders[special]))</span>
<a href="#l23.1911"></a><span id="l23.1911" class="difflineplus">+void CMapiMessageHeaders::UnfoldValue(SpecialHeader special, nsString&amp; dest,</span>
<a href="#l23.1912"></a><span id="l23.1912" class="difflineplus">+                                      const char* fallbackCharset) const {</span>
<a href="#l23.1913"></a><span id="l23.1913" class="difflineplus">+  if ((special &lt;= hdrNone) || (special &gt;= hdrMax) ||</span>
<a href="#l23.1914"></a><span id="l23.1914" class="difflineplus">+      (!m_SpecialHeaders[special]))</span>
<a href="#l23.1915"></a><span id="l23.1915">     dest.Truncate();</span>
<a href="#l23.1916"></a><span id="l23.1916">   else</span>
<a href="#l23.1917"></a><span id="l23.1917">     m_SpecialHeaders[special]-&gt;GetUnfoldedString(dest, fallbackCharset);</span>
<a href="#l23.1918"></a><span id="l23.1918"> }</span>
<a href="#l23.1919"></a><span id="l23.1919"> </span>
<a href="#l23.1920"></a><span id="l23.1920" class="difflineminus">-int CMapiMessageHeaders::SetValue(const char* name, const char* value, bool replace)</span>
<a href="#l23.1921"></a><span id="l23.1921" class="difflineminus">-{</span>
<a href="#l23.1922"></a><span id="l23.1922" class="difflineplus">+int CMapiMessageHeaders::SetValue(const char* name, const char* value,</span>
<a href="#l23.1923"></a><span id="l23.1923" class="difflineplus">+                                  bool replace) {</span>
<a href="#l23.1924"></a><span id="l23.1924">   if (!replace) {</span>
<a href="#l23.1925"></a><span id="l23.1925">     CHeaderField* result = Find(name);</span>
<a href="#l23.1926"></a><span id="l23.1926">     if (result) {</span>
<a href="#l23.1927"></a><span id="l23.1927">       result-&gt;set_fbody(value);</span>
<a href="#l23.1928"></a><span id="l23.1928">       return 0;</span>
<a href="#l23.1929"></a><span id="l23.1929">     }</span>
<a href="#l23.1930"></a><span id="l23.1930">   }</span>
<a href="#l23.1931"></a><span id="l23.1931">   Add(new CHeaderField(name, value, true));</span>
<a href="#l23.1932"></a><span id="l23.1932" class="difflineminus">-  return 0; // No sensible result is returned; maybe do something senseful later</span>
<a href="#l23.1933"></a><span id="l23.1933" class="difflineplus">+  return 0;  // No sensible result is returned; maybe do something senseful</span>
<a href="#l23.1934"></a><span id="l23.1934" class="difflineplus">+             // later</span>
<a href="#l23.1935"></a><span id="l23.1935"> }</span>
<a href="#l23.1936"></a><span id="l23.1936"> </span>
<a href="#l23.1937"></a><span id="l23.1937" class="difflineminus">-int CMapiMessageHeaders::SetValue(SpecialHeader special, const char* value)</span>
<a href="#l23.1938"></a><span id="l23.1938" class="difflineminus">-{</span>
<a href="#l23.1939"></a><span id="l23.1939" class="difflineplus">+int CMapiMessageHeaders::SetValue(SpecialHeader special, const char* value) {</span>
<a href="#l23.1940"></a><span id="l23.1940">   CHeaderField* result = m_SpecialHeaders[special];</span>
<a href="#l23.1941"></a><span id="l23.1941">   if (result)</span>
<a href="#l23.1942"></a><span id="l23.1942">     result-&gt;set_fbody(value);</span>
<a href="#l23.1943"></a><span id="l23.1943">   else</span>
<a href="#l23.1944"></a><span id="l23.1944">     Add(new CHeaderField(Specials[special], value, true));</span>
<a href="#l23.1945"></a><span id="l23.1945">   return 0;</span>
<a href="#l23.1946"></a><span id="l23.1946"> }</span>
<a href="#l23.1947"></a><span id="l23.1947"> </span>
<a href="#l23.1948"></a><span id="l23.1948" class="difflineminus">-void CMapiMessageHeaders::write_to_stream::operator () (const CHeaderField* f)</span>
<a href="#l23.1949"></a><span id="l23.1949" class="difflineminus">-{</span>
<a href="#l23.1950"></a><span id="l23.1950" class="difflineminus">-  if (!f || NS_FAILED(m_rv))</span>
<a href="#l23.1951"></a><span id="l23.1951" class="difflineminus">-    return;</span>
<a href="#l23.1952"></a><span id="l23.1952" class="difflineplus">+void CMapiMessageHeaders::write_to_stream::operator()(const CHeaderField* f) {</span>
<a href="#l23.1953"></a><span id="l23.1953" class="difflineplus">+  if (!f || NS_FAILED(m_rv)) return;</span>
<a href="#l23.1954"></a><span id="l23.1954"> </span>
<a href="#l23.1955"></a><span id="l23.1955">   uint32_t written;</span>
<a href="#l23.1956"></a><span id="l23.1956">   m_rv = m_pDst-&gt;Write(f-&gt;fname(), strlen(f-&gt;fname()), &amp;written);</span>
<a href="#l23.1957"></a><span id="l23.1957">   NS_ENSURE_SUCCESS_VOID(m_rv);</span>
<a href="#l23.1958"></a><span id="l23.1958">   if (f-&gt;fbody()) {</span>
<a href="#l23.1959"></a><span id="l23.1959">     m_rv = m_pDst-&gt;Write(f-&gt;fbody(), strlen(f-&gt;fbody()), &amp;written);</span>
<a href="#l23.1960"></a><span id="l23.1960">     NS_ENSURE_SUCCESS_VOID(m_rv);</span>
<a href="#l23.1961"></a><span id="l23.1961">   }</span>
<a href="#l23.1962"></a><span id="l23.1962">   m_rv = m_pDst-&gt;Write(&quot;\x0D\x0A&quot;, 2, &amp;written);</span>
<a href="#l23.1963"></a><span id="l23.1963"> }</span>
<a href="#l23.1964"></a><span id="l23.1964"> </span>
<a href="#l23.1965"></a><span id="l23.1965" class="difflineminus">-nsresult CMapiMessageHeaders::ToStream(nsIOutputStream *pDst) const</span>
<a href="#l23.1966"></a><span id="l23.1966" class="difflineminus">-{</span>
<a href="#l23.1967"></a><span id="l23.1967" class="difflineplus">+nsresult CMapiMessageHeaders::ToStream(nsIOutputStream* pDst) const {</span>
<a href="#l23.1968"></a><span id="l23.1968">   nsresult rv = std::for_each(m_headerFields.begin(), m_headerFields.end(),</span>
<a href="#l23.1969"></a><span id="l23.1969">                               write_to_stream(pDst));</span>
<a href="#l23.1970"></a><span id="l23.1970">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l23.1971"></a><span id="l23.1971">     uint32_t written;</span>
<a href="#l23.1972"></a><span id="l23.1972" class="difflineminus">-    rv = pDst-&gt;Write(&quot;\x0D\x0A&quot;, 2, &amp;written); // Separator line</span>
<a href="#l23.1973"></a><span id="l23.1973" class="difflineplus">+    rv = pDst-&gt;Write(&quot;\x0D\x0A&quot;, 2, &amp;written);  // Separator line</span>
<a href="#l23.1974"></a><span id="l23.1974">   }</span>
<a href="#l23.1975"></a><span id="l23.1975">   return rv;</span>
<a href="#l23.1976"></a><span id="l23.1976"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/import/outlook/src/MapiMessage.h</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/import/outlook/src/MapiMessage.h</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -8,264 +8,282 @@</span>
<a href="#l24.4"></a><span id="l24.4"> #include &quot;nsTArray.h&quot;</span>
<a href="#l24.5"></a><span id="l24.5"> #include &quot;nsString.h&quot;</span>
<a href="#l24.6"></a><span id="l24.6"> #include &quot;nsIFile.h&quot;</span>
<a href="#l24.7"></a><span id="l24.7"> #include &quot;MapiApi.h&quot;</span>
<a href="#l24.8"></a><span id="l24.8"> </span>
<a href="#l24.9"></a><span id="l24.9"> #include &lt;vector&gt;</span>
<a href="#l24.10"></a><span id="l24.10"> </span>
<a href="#l24.11"></a><span id="l24.11"> #ifndef PR_LAST_VERB_EXECUTED</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-#define PR_LAST_VERB_EXECUTED PROP_TAG(PT_LONG, 0x1081)</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+#  define PR_LAST_VERB_EXECUTED PROP_TAG(PT_LONG, 0x1081)</span>
<a href="#l24.14"></a><span id="l24.14"> #endif</span>
<a href="#l24.15"></a><span id="l24.15"> </span>
<a href="#l24.16"></a><span id="l24.16"> #define EXCHIVERB_REPLYTOSENDER (102)</span>
<a href="#l24.17"></a><span id="l24.17" class="difflineminus">-#define EXCHIVERB_REPLYTOALL    (103)</span>
<a href="#l24.18"></a><span id="l24.18" class="difflineminus">-#define EXCHIVERB_FORWARD       (104)</span>
<a href="#l24.19"></a><span id="l24.19" class="difflineplus">+#define EXCHIVERB_REPLYTOALL (103)</span>
<a href="#l24.20"></a><span id="l24.20" class="difflineplus">+#define EXCHIVERB_FORWARD (104)</span>
<a href="#l24.21"></a><span id="l24.21"> </span>
<a href="#l24.22"></a><span id="l24.22"> #ifndef PR_ATTACH_CONTENT_ID</span>
<a href="#l24.23"></a><span id="l24.23" class="difflineminus">-#define PR_ATTACH_CONTENT_ID PROP_TAG(PT_TSTRING, 0x3712)</span>
<a href="#l24.24"></a><span id="l24.24" class="difflineplus">+#  define PR_ATTACH_CONTENT_ID PROP_TAG(PT_TSTRING, 0x3712)</span>
<a href="#l24.25"></a><span id="l24.25"> #endif</span>
<a href="#l24.26"></a><span id="l24.26"> #ifndef PR_ATTACH_CONTENT_ID_W</span>
<a href="#l24.27"></a><span id="l24.27" class="difflineminus">-#define PR_ATTACH_CONTENT_ID_W PROP_TAG(PT_UNICODE, 0x3712)</span>
<a href="#l24.28"></a><span id="l24.28" class="difflineplus">+#  define PR_ATTACH_CONTENT_ID_W PROP_TAG(PT_UNICODE, 0x3712)</span>
<a href="#l24.29"></a><span id="l24.29"> #endif</span>
<a href="#l24.30"></a><span id="l24.30"> #ifndef PR_ATTACH_CONTENT_ID_A</span>
<a href="#l24.31"></a><span id="l24.31" class="difflineminus">-#define PR_ATTACH_CONTENT_ID_A PROP_TAG(PT_STRING8, 0x3712)</span>
<a href="#l24.32"></a><span id="l24.32" class="difflineplus">+#  define PR_ATTACH_CONTENT_ID_A PROP_TAG(PT_STRING8, 0x3712)</span>
<a href="#l24.33"></a><span id="l24.33"> #endif</span>
<a href="#l24.34"></a><span id="l24.34"> </span>
<a href="#l24.35"></a><span id="l24.35"> #ifndef PR_ATTACH_FLAGS</span>
<a href="#l24.36"></a><span id="l24.36" class="difflineminus">-#define PR_ATTACH_FLAGS PROP_TAG(PT_LONG, 0x3714)</span>
<a href="#l24.37"></a><span id="l24.37" class="difflineplus">+#  define PR_ATTACH_FLAGS PROP_TAG(PT_LONG, 0x3714)</span>
<a href="#l24.38"></a><span id="l24.38"> #endif</span>
<a href="#l24.39"></a><span id="l24.39"> </span>
<a href="#l24.40"></a><span id="l24.40"> #ifndef ATT_INVISIBLE_IN_HTML</span>
<a href="#l24.41"></a><span id="l24.41" class="difflineminus">-#define ATT_INVISIBLE_IN_HTML (0x1)</span>
<a href="#l24.42"></a><span id="l24.42" class="difflineplus">+#  define ATT_INVISIBLE_IN_HTML (0x1)</span>
<a href="#l24.43"></a><span id="l24.43"> #endif</span>
<a href="#l24.44"></a><span id="l24.44"> #ifndef ATT_INVISIBLE_IN_RTF</span>
<a href="#l24.45"></a><span id="l24.45" class="difflineminus">-#define ATT_INVISIBLE_IN_RTF  (0x2)</span>
<a href="#l24.46"></a><span id="l24.46" class="difflineplus">+#  define ATT_INVISIBLE_IN_RTF (0x2)</span>
<a href="#l24.47"></a><span id="l24.47"> #endif</span>
<a href="#l24.48"></a><span id="l24.48"> #ifndef ATT_MHTML_REF</span>
<a href="#l24.49"></a><span id="l24.49" class="difflineminus">-#define ATT_MHTML_REF         (0x4)</span>
<a href="#l24.50"></a><span id="l24.50" class="difflineplus">+#  define ATT_MHTML_REF (0x4)</span>
<a href="#l24.51"></a><span id="l24.51"> #endif</span>
<a href="#l24.52"></a><span id="l24.52"> </span>
<a href="#l24.53"></a><span id="l24.53"> //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l24.54"></a><span id="l24.54"> </span>
<a href="#l24.55"></a><span id="l24.55"> class CMapiMessageHeaders {</span>
<a href="#l24.56"></a><span id="l24.56" class="difflineminus">-public:</span>
<a href="#l24.57"></a><span id="l24.57" class="difflineplus">+ public:</span>
<a href="#l24.58"></a><span id="l24.58">   // Special headers that MUST appear at most once (see RFC822)</span>
<a href="#l24.59"></a><span id="l24.59" class="difflineminus">-  enum SpecialHeader { hdrNone=-1, hdrFirst = 0, // utility values</span>
<a href="#l24.60"></a><span id="l24.60" class="difflineminus">-                       hdrDate=hdrFirst,</span>
<a href="#l24.61"></a><span id="l24.61" class="difflineminus">-                       hdrFrom,</span>
<a href="#l24.62"></a><span id="l24.62" class="difflineminus">-                       hdrSender,</span>
<a href="#l24.63"></a><span id="l24.63" class="difflineminus">-                       hdrReplyTo,</span>
<a href="#l24.64"></a><span id="l24.64" class="difflineminus">-                       hdrTo,</span>
<a href="#l24.65"></a><span id="l24.65" class="difflineminus">-                       hdrCc,</span>
<a href="#l24.66"></a><span id="l24.66" class="difflineminus">-                       hdrBcc,</span>
<a href="#l24.67"></a><span id="l24.67" class="difflineminus">-                       hdrMessageID,</span>
<a href="#l24.68"></a><span id="l24.68" class="difflineminus">-                       hdrSubject,</span>
<a href="#l24.69"></a><span id="l24.69" class="difflineminus">-                       hdrMimeVersion,</span>
<a href="#l24.70"></a><span id="l24.70" class="difflineminus">-                       hdrContentType,</span>
<a href="#l24.71"></a><span id="l24.71" class="difflineminus">-                       hdrContentTransferEncoding,</span>
<a href="#l24.72"></a><span id="l24.72" class="difflineminus">-                       hdrMax // utility value</span>
<a href="#l24.73"></a><span id="l24.73" class="difflineminus">-                     };</span>
<a href="#l24.74"></a><span id="l24.74" class="difflineplus">+  enum SpecialHeader {</span>
<a href="#l24.75"></a><span id="l24.75" class="difflineplus">+    hdrNone = -1,</span>
<a href="#l24.76"></a><span id="l24.76" class="difflineplus">+    hdrFirst = 0,  // utility values</span>
<a href="#l24.77"></a><span id="l24.77" class="difflineplus">+    hdrDate = hdrFirst,</span>
<a href="#l24.78"></a><span id="l24.78" class="difflineplus">+    hdrFrom,</span>
<a href="#l24.79"></a><span id="l24.79" class="difflineplus">+    hdrSender,</span>
<a href="#l24.80"></a><span id="l24.80" class="difflineplus">+    hdrReplyTo,</span>
<a href="#l24.81"></a><span id="l24.81" class="difflineplus">+    hdrTo,</span>
<a href="#l24.82"></a><span id="l24.82" class="difflineplus">+    hdrCc,</span>
<a href="#l24.83"></a><span id="l24.83" class="difflineplus">+    hdrBcc,</span>
<a href="#l24.84"></a><span id="l24.84" class="difflineplus">+    hdrMessageID,</span>
<a href="#l24.85"></a><span id="l24.85" class="difflineplus">+    hdrSubject,</span>
<a href="#l24.86"></a><span id="l24.86" class="difflineplus">+    hdrMimeVersion,</span>
<a href="#l24.87"></a><span id="l24.87" class="difflineplus">+    hdrContentType,</span>
<a href="#l24.88"></a><span id="l24.88" class="difflineplus">+    hdrContentTransferEncoding,</span>
<a href="#l24.89"></a><span id="l24.89" class="difflineplus">+    hdrMax  // utility value</span>
<a href="#l24.90"></a><span id="l24.90" class="difflineplus">+  };</span>
<a href="#l24.91"></a><span id="l24.91"> </span>
<a href="#l24.92"></a><span id="l24.92">   explicit CMapiMessageHeaders(const char* headers = 0) { Assign(headers); }</span>
<a href="#l24.93"></a><span id="l24.93">   ~CMapiMessageHeaders();</span>
<a href="#l24.94"></a><span id="l24.94">   void Assign(const char* headers);</span>
<a href="#l24.95"></a><span id="l24.95"> </span>
<a href="#l24.96"></a><span id="l24.96">   inline bool IsEmpty() const { return m_headerFields.empty(); }</span>
<a href="#l24.97"></a><span id="l24.97">   // if no such header exists then 0 is returned, else the first value returned</span>
<a href="#l24.98"></a><span id="l24.98">   const char* Value(const char* name) const;</span>
<a href="#l24.99"></a><span id="l24.99">   // if no such header exists then 0 is returned</span>
<a href="#l24.100"></a><span id="l24.100">   const char* Value(SpecialHeader special) const;</span>
<a href="#l24.101"></a><span id="l24.101"> </span>
<a href="#l24.102"></a><span id="l24.102" class="difflineminus">-  void UnfoldValue(const char* name, nsString&amp; dest, const char* fallbackCharset) const;</span>
<a href="#l24.103"></a><span id="l24.103" class="difflineminus">-  void UnfoldValue(SpecialHeader special, nsString&amp; dest, const char* fallbackCharset) const;</span>
<a href="#l24.104"></a><span id="l24.104" class="difflineplus">+  void UnfoldValue(const char* name, nsString&amp; dest,</span>
<a href="#l24.105"></a><span id="l24.105" class="difflineplus">+                   const char* fallbackCharset) const;</span>
<a href="#l24.106"></a><span id="l24.106" class="difflineplus">+  void UnfoldValue(SpecialHeader special, nsString&amp; dest,</span>
<a href="#l24.107"></a><span id="l24.107" class="difflineplus">+                   const char* fallbackCharset) const;</span>
<a href="#l24.108"></a><span id="l24.108"> </span>
<a href="#l24.109"></a><span id="l24.109">   // value must be utf-8 or 7-bit; supposed that this function will be called</span>
<a href="#l24.110"></a><span id="l24.110">   // when the charset of the value is known</span>
<a href="#l24.111"></a><span id="l24.111">   // TODO: if replace is set, then all headers with this name will be removed</span>
<a href="#l24.112"></a><span id="l24.112">   //  and one with this value will be added, otherwise a new header is added</span>
<a href="#l24.113"></a><span id="l24.113">   // (Unnecessary for now)</span>
<a href="#l24.114"></a><span id="l24.114">   int SetValue(const char* name, const char* value, bool replace = true);</span>
<a href="#l24.115"></a><span id="l24.115">   int SetValue(SpecialHeader special, const char* value);</span>
<a href="#l24.116"></a><span id="l24.116"> </span>
<a href="#l24.117"></a><span id="l24.117">   static const char* SpecialName(SpecialHeader special);</span>
<a href="#l24.118"></a><span id="l24.118"> </span>
<a href="#l24.119"></a><span id="l24.119" class="difflineminus">-  nsresult ToStream(nsIOutputStream *pDst) const;</span>
<a href="#l24.120"></a><span id="l24.120" class="difflineminus">-private:</span>
<a href="#l24.121"></a><span id="l24.121" class="difflineplus">+  nsresult ToStream(nsIOutputStream* pDst) const;</span>
<a href="#l24.122"></a><span id="l24.122" class="difflineplus">+</span>
<a href="#l24.123"></a><span id="l24.123" class="difflineplus">+ private:</span>
<a href="#l24.124"></a><span id="l24.124">   class CHeaderField {</span>
<a href="#l24.125"></a><span id="l24.125" class="difflineminus">-  public:</span>
<a href="#l24.126"></a><span id="l24.126" class="difflineplus">+   public:</span>
<a href="#l24.127"></a><span id="l24.127">     CHeaderField(const char* begin, int len);</span>
<a href="#l24.128"></a><span id="l24.128">     CHeaderField(const char* name, const char* body, bool utf8 = false);</span>
<a href="#l24.129"></a><span id="l24.129">     ~CHeaderField();</span>
<a href="#l24.130"></a><span id="l24.130">     inline bool Valid() const { return m_fname; }</span>
<a href="#l24.131"></a><span id="l24.131">     inline const char* fname() const { return m_fname; }</span>
<a href="#l24.132"></a><span id="l24.132">     inline const char* fbody() const { return m_fbody; }</span>
<a href="#l24.133"></a><span id="l24.133"> </span>
<a href="#l24.134"></a><span id="l24.134">     // txt must be utf-8 or 7-bit; supposed that this function will be called</span>
<a href="#l24.135"></a><span id="l24.135">     // when the charset of the txt is known</span>
<a href="#l24.136"></a><span id="l24.136">     void set_fbody(const char* txt);</span>
<a href="#l24.137"></a><span id="l24.137"> </span>
<a href="#l24.138"></a><span id="l24.138">     void GetUnfoldedString(nsString&amp; dest, const char* fallbackCharset) const;</span>
<a href="#l24.139"></a><span id="l24.139" class="difflineminus">-  private:</span>
<a href="#l24.140"></a><span id="l24.140" class="difflineplus">+</span>
<a href="#l24.141"></a><span id="l24.141" class="difflineplus">+   private:</span>
<a href="#l24.142"></a><span id="l24.142">     char* m_fname;</span>
<a href="#l24.143"></a><span id="l24.143">     char* m_fbody;</span>
<a href="#l24.144"></a><span id="l24.144">     bool m_fbody_utf8;</span>
<a href="#l24.145"></a><span id="l24.145" class="difflineminus">-  }; //class HeaderField</span>
<a href="#l24.146"></a><span id="l24.146" class="difflineplus">+  };  // class HeaderField</span>
<a href="#l24.147"></a><span id="l24.147"> </span>
<a href="#l24.148"></a><span id="l24.148">   class write_to_stream {</span>
<a href="#l24.149"></a><span id="l24.149" class="difflineminus">-  public:</span>
<a href="#l24.150"></a><span id="l24.150" class="difflineminus">-    explicit write_to_stream(nsIOutputStream *pDst) : m_pDst(pDst), m_rv(NS_OK) {}</span>
<a href="#l24.151"></a><span id="l24.151" class="difflineminus">-    void operator () (const CHeaderField* f);</span>
<a href="#l24.152"></a><span id="l24.152" class="difflineplus">+   public:</span>
<a href="#l24.153"></a><span id="l24.153" class="difflineplus">+    explicit write_to_stream(nsIOutputStream* pDst)</span>
<a href="#l24.154"></a><span id="l24.154" class="difflineplus">+        : m_pDst(pDst), m_rv(NS_OK) {}</span>
<a href="#l24.155"></a><span id="l24.155" class="difflineplus">+    void operator()(const CHeaderField* f);</span>
<a href="#l24.156"></a><span id="l24.156">     inline operator nsresult() const { return m_rv; }</span>
<a href="#l24.157"></a><span id="l24.157" class="difflineminus">-  private:</span>
<a href="#l24.158"></a><span id="l24.158" class="difflineminus">-    nsIOutputStream *m_pDst;</span>
<a href="#l24.159"></a><span id="l24.159" class="difflineplus">+</span>
<a href="#l24.160"></a><span id="l24.160" class="difflineplus">+   private:</span>
<a href="#l24.161"></a><span id="l24.161" class="difflineplus">+    nsIOutputStream* m_pDst;</span>
<a href="#l24.162"></a><span id="l24.162">     nsresult m_rv;</span>
<a href="#l24.163"></a><span id="l24.163">   };</span>
<a href="#l24.164"></a><span id="l24.164"> </span>
<a href="#l24.165"></a><span id="l24.165">   // Search helper</span>
<a href="#l24.166"></a><span id="l24.166">   class fname_equals {</span>
<a href="#l24.167"></a><span id="l24.167" class="difflineminus">-  public:</span>
<a href="#l24.168"></a><span id="l24.168" class="difflineplus">+   public:</span>
<a href="#l24.169"></a><span id="l24.169">     explicit fname_equals(const char* search) : m_search(search) {}</span>
<a href="#l24.170"></a><span id="l24.170" class="difflineminus">-    inline bool operator () (const CHeaderField* f) const { return stricmp(f-&gt;fname(), m_search) == 0; }</span>
<a href="#l24.171"></a><span id="l24.171" class="difflineminus">-  private:</span>
<a href="#l24.172"></a><span id="l24.172" class="difflineplus">+    inline bool operator()(const CHeaderField* f) const {</span>
<a href="#l24.173"></a><span id="l24.173" class="difflineplus">+      return stricmp(f-&gt;fname(), m_search) == 0;</span>
<a href="#l24.174"></a><span id="l24.174" class="difflineplus">+    }</span>
<a href="#l24.175"></a><span id="l24.175" class="difflineplus">+</span>
<a href="#l24.176"></a><span id="l24.176" class="difflineplus">+   private:</span>
<a href="#l24.177"></a><span id="l24.177">     const char* m_search;</span>
<a href="#l24.178"></a><span id="l24.178" class="difflineminus">-  }; // class fname_equals</span>
<a href="#l24.179"></a><span id="l24.179" class="difflineplus">+  };  // class fname_equals</span>
<a href="#l24.180"></a><span id="l24.180"> </span>
<a href="#l24.181"></a><span id="l24.181">   // The common array of special headers' names</span>
<a href="#l24.182"></a><span id="l24.182">   static const char* Specials[hdrMax];</span>
<a href="#l24.183"></a><span id="l24.183"> </span>
<a href="#l24.184"></a><span id="l24.184">   std::vector&lt;CHeaderField*&gt; m_headerFields;</span>
<a href="#l24.185"></a><span id="l24.185" class="difflineminus">-  CHeaderField* m_SpecialHeaders[hdrMax]; // Pointers into the m_headerFields</span>
<a href="#l24.186"></a><span id="l24.186" class="difflineplus">+  CHeaderField* m_SpecialHeaders[hdrMax];  // Pointers into the m_headerFields</span>
<a href="#l24.187"></a><span id="l24.187"> </span>
<a href="#l24.188"></a><span id="l24.188">   void ClearHeaderFields();</span>
<a href="#l24.189"></a><span id="l24.189">   void Add(CHeaderField* f);</span>
<a href="#l24.190"></a><span id="l24.190">   static void Delete(CHeaderField* p);</span>
<a href="#l24.191"></a><span id="l24.191">   static SpecialHeader CheckSpecialHeader(const char* fname);</span>
<a href="#l24.192"></a><span id="l24.192">   const CHeaderField* CFind(const char* name) const;</span>
<a href="#l24.193"></a><span id="l24.193" class="difflineminus">-  inline CHeaderField* Find(const char* name) { return const_cast&lt;CHeaderField*&gt;(CFind(name)); }</span>
<a href="#l24.194"></a><span id="l24.194" class="difflineplus">+  inline CHeaderField* Find(const char* name) {</span>
<a href="#l24.195"></a><span id="l24.195" class="difflineplus">+    return const_cast&lt;CHeaderField*&gt;(CFind(name));</span>
<a href="#l24.196"></a><span id="l24.196" class="difflineplus">+  }</span>
<a href="#l24.197"></a><span id="l24.197"> </span>
<a href="#l24.198"></a><span id="l24.198" class="difflineminus">-}; // class CMapiMessageHeaders</span>
<a href="#l24.199"></a><span id="l24.199" class="difflineplus">+};  // class CMapiMessageHeaders</span>
<a href="#l24.200"></a><span id="l24.200"> </span>
<a href="#l24.201"></a><span id="l24.201"> //////////////////////////////////////////////////////</span>
<a href="#l24.202"></a><span id="l24.202"> </span>
<a href="#l24.203"></a><span id="l24.203"> class CMapiMessage {</span>
<a href="#l24.204"></a><span id="l24.204" class="difflineminus">-public:</span>
<a href="#l24.205"></a><span id="l24.205" class="difflineplus">+ public:</span>
<a href="#l24.206"></a><span id="l24.206">   explicit CMapiMessage(LPMESSAGE lpMsg);</span>
<a href="#l24.207"></a><span id="l24.207">   ~CMapiMessage();</span>
<a href="#l24.208"></a><span id="l24.208"> </span>
<a href="#l24.209"></a><span id="l24.209">   // Attachments</span>
<a href="#l24.210"></a><span id="l24.210">   // Ordinary (not embedded) attachments.</span>
<a href="#l24.211"></a><span id="l24.211" class="difflineminus">-  nsresult GetAttachments(nsIArray **aArray);</span>
<a href="#l24.212"></a><span id="l24.212" class="difflineplus">+  nsresult GetAttachments(nsIArray** aArray);</span>
<a href="#l24.213"></a><span id="l24.213">   // Embedded attachments</span>
<a href="#l24.214"></a><span id="l24.214">   size_t EmbeddedAttachmentsCount() const { return m_embattachments.size(); }</span>
<a href="#l24.215"></a><span id="l24.215" class="difflineminus">-  bool GetEmbeddedAttachmentInfo(unsigned int i, nsIURI **uri, const char **cid,</span>
<a href="#l24.216"></a><span id="l24.216" class="difflineminus">-                                 const char **name) const;</span>
<a href="#l24.217"></a><span id="l24.217" class="difflineplus">+  bool GetEmbeddedAttachmentInfo(unsigned int i, nsIURI** uri, const char** cid,</span>
<a href="#l24.218"></a><span id="l24.218" class="difflineplus">+                                 const char** name) const;</span>
<a href="#l24.219"></a><span id="l24.219">   // We don't check MSGFLAG_HASATTACH, since it returns true even if there are</span>
<a href="#l24.220"></a><span id="l24.220">   // only embedded attachmentsin the message. TB only counts the ordinary</span>
<a href="#l24.221"></a><span id="l24.221">   // attachments when shows the message status, so here we check only for the</span>
<a href="#l24.222"></a><span id="l24.222">   // ordinary attachments.</span>
<a href="#l24.223"></a><span id="l24.223">   inline bool HasAttach() const { return !m_stdattachments.empty(); }</span>
<a href="#l24.224"></a><span id="l24.224"> </span>
<a href="#l24.225"></a><span id="l24.225">   // Retrieve info for message</span>
<a href="#l24.226"></a><span id="l24.226" class="difflineminus">-  inline bool BodyIsHtml(void) const { return m_bodyIsHtml;}</span>
<a href="#l24.227"></a><span id="l24.227" class="difflineminus">-  const char *GetFromLine(int&amp; len) const {</span>
<a href="#l24.228"></a><span id="l24.228" class="difflineplus">+  inline bool BodyIsHtml(void) const { return m_bodyIsHtml; }</span>
<a href="#l24.229"></a><span id="l24.229" class="difflineplus">+  const char* GetFromLine(int&amp; len) const {</span>
<a href="#l24.230"></a><span id="l24.230">     if (m_fromLine.IsEmpty())</span>
<a href="#l24.231"></a><span id="l24.231">       return NULL;</span>
<a href="#l24.232"></a><span id="l24.232">     else {</span>
<a href="#l24.233"></a><span id="l24.233">       len = m_fromLine.Length();</span>
<a href="#l24.234"></a><span id="l24.234" class="difflineminus">-      return m_fromLine.get();}</span>
<a href="#l24.235"></a><span id="l24.235" class="difflineplus">+      return m_fromLine.get();</span>
<a href="#l24.236"></a><span id="l24.236" class="difflineplus">+    }</span>
<a href="#l24.237"></a><span id="l24.237">   }</span>
<a href="#l24.238"></a><span id="l24.238" class="difflineminus">-  inline CMapiMessageHeaders *GetHeaders() { return &amp;m_headers; }</span>
<a href="#l24.239"></a><span id="l24.239" class="difflineminus">-  inline const wchar_t *GetBody(void) const { return m_body.get(); }</span>
<a href="#l24.240"></a><span id="l24.240" class="difflineplus">+  inline CMapiMessageHeaders* GetHeaders() { return &amp;m_headers; }</span>
<a href="#l24.241"></a><span id="l24.241" class="difflineplus">+  inline const wchar_t* GetBody(void) const { return m_body.get(); }</span>
<a href="#l24.242"></a><span id="l24.242">   inline size_t GetBodyLen(void) const { return m_body.Length(); }</span>
<a href="#l24.243"></a><span id="l24.243">   void GetBody(nsCString&amp; dest) const;</span>
<a href="#l24.244"></a><span id="l24.244" class="difflineminus">-  inline const char *GetBodyCharset(void) const { return m_mimeCharset.get();}</span>
<a href="#l24.245"></a><span id="l24.245" class="difflineplus">+  inline const char* GetBodyCharset(void) const { return m_mimeCharset.get(); }</span>
<a href="#l24.246"></a><span id="l24.246">   inline bool IsRead() const { return m_msgFlags &amp; MSGFLAG_READ; }</span>
<a href="#l24.247"></a><span id="l24.247">   inline bool IsReplied() const {</span>
<a href="#l24.248"></a><span id="l24.248">     return (m_msgLastVerb == EXCHIVERB_REPLYTOSENDER) ||</span>
<a href="#l24.249"></a><span id="l24.249" class="difflineminus">-           (m_msgLastVerb == EXCHIVERB_REPLYTOALL); }</span>
<a href="#l24.250"></a><span id="l24.250" class="difflineminus">-  inline bool IsForvarded() const {</span>
<a href="#l24.251"></a><span id="l24.251" class="difflineminus">-    return m_msgLastVerb == EXCHIVERB_FORWARD; }</span>
<a href="#l24.252"></a><span id="l24.252" class="difflineplus">+           (m_msgLastVerb == EXCHIVERB_REPLYTOALL);</span>
<a href="#l24.253"></a><span id="l24.253" class="difflineplus">+  }</span>
<a href="#l24.254"></a><span id="l24.254" class="difflineplus">+  inline bool IsForvarded() const { return m_msgLastVerb == EXCHIVERB_FORWARD; }</span>
<a href="#l24.255"></a><span id="l24.255"> </span>
<a href="#l24.256"></a><span id="l24.256" class="difflineminus">-  bool    HasContentHeader(void) const {</span>
<a href="#l24.257"></a><span id="l24.257" class="difflineminus">-    return !m_mimeContentType.IsEmpty();}</span>
<a href="#l24.258"></a><span id="l24.258" class="difflineminus">-  bool    HasMimeVersion(void) const {</span>
<a href="#l24.259"></a><span id="l24.259" class="difflineminus">-    return m_headers.Value(CMapiMessageHeaders::hdrMimeVersion); }</span>
<a href="#l24.260"></a><span id="l24.260" class="difflineminus">-  const char *GetMimeContent(void) const { return m_mimeContentType.get();}</span>
<a href="#l24.261"></a><span id="l24.261" class="difflineminus">-  int32_t     GetMimeContentLen(void) const { return m_mimeContentType.Length();}</span>
<a href="#l24.262"></a><span id="l24.262" class="difflineminus">-  const char *GetMimeBoundary(void) const { return m_mimeBoundary.get();}</span>
<a href="#l24.263"></a><span id="l24.263" class="difflineplus">+  bool HasContentHeader(void) const { return !m_mimeContentType.IsEmpty(); }</span>
<a href="#l24.264"></a><span id="l24.264" class="difflineplus">+  bool HasMimeVersion(void) const {</span>
<a href="#l24.265"></a><span id="l24.265" class="difflineplus">+    return m_headers.Value(CMapiMessageHeaders::hdrMimeVersion);</span>
<a href="#l24.266"></a><span id="l24.266" class="difflineplus">+  }</span>
<a href="#l24.267"></a><span id="l24.267" class="difflineplus">+  const char* GetMimeContent(void) const { return m_mimeContentType.get(); }</span>
<a href="#l24.268"></a><span id="l24.268" class="difflineplus">+  int32_t GetMimeContentLen(void) const { return m_mimeContentType.Length(); }</span>
<a href="#l24.269"></a><span id="l24.269" class="difflineplus">+  const char* GetMimeBoundary(void) const { return m_mimeBoundary.get(); }</span>
<a href="#l24.270"></a><span id="l24.270"> </span>
<a href="#l24.271"></a><span id="l24.271" class="difflineminus">-   // The only required part of a message is its header</span>
<a href="#l24.272"></a><span id="l24.272" class="difflineplus">+  // The only required part of a message is its header</span>
<a href="#l24.273"></a><span id="l24.273">   inline bool ValidState() const { return !m_headers.IsEmpty(); }</span>
<a href="#l24.274"></a><span id="l24.274">   inline bool FullMessageDownloaded() const { return !m_dldStateHeadersOnly; }</span>
<a href="#l24.275"></a><span id="l24.275"> </span>
<a href="#l24.276"></a><span id="l24.276" class="difflineminus">-private:</span>
<a href="#l24.277"></a><span id="l24.277" class="difflineplus">+ private:</span>
<a href="#l24.278"></a><span id="l24.278">   struct attach_data {</span>
<a href="#l24.279"></a><span id="l24.279">     nsCOMPtr&lt;nsIURI&gt; orig_url;</span>
<a href="#l24.280"></a><span id="l24.280">     nsCOMPtr&lt;nsIFile&gt; tmp_file;</span>
<a href="#l24.281"></a><span id="l24.281" class="difflineminus">-    char *type;</span>
<a href="#l24.282"></a><span id="l24.282" class="difflineminus">-    char *encoding;</span>
<a href="#l24.283"></a><span id="l24.283" class="difflineminus">-    char *real_name;</span>
<a href="#l24.284"></a><span id="l24.284" class="difflineminus">-    char *cid;</span>
<a href="#l24.285"></a><span id="l24.285" class="difflineplus">+    char* type;</span>
<a href="#l24.286"></a><span id="l24.286" class="difflineplus">+    char* encoding;</span>
<a href="#l24.287"></a><span id="l24.287" class="difflineplus">+    char* real_name;</span>
<a href="#l24.288"></a><span id="l24.288" class="difflineplus">+    char* cid;</span>
<a href="#l24.289"></a><span id="l24.289">     bool delete_file;</span>
<a href="#l24.290"></a><span id="l24.290" class="difflineminus">-    attach_data() : type(0), encoding(0), real_name(0), cid(0), delete_file(false) {}</span>
<a href="#l24.291"></a><span id="l24.291" class="difflineplus">+    attach_data()</span>
<a href="#l24.292"></a><span id="l24.292" class="difflineplus">+        : type(0), encoding(0), real_name(0), cid(0), delete_file(false) {}</span>
<a href="#l24.293"></a><span id="l24.293">   };</span>
<a href="#l24.294"></a><span id="l24.294"> </span>
<a href="#l24.295"></a><span id="l24.295" class="difflineminus">-  static const nsCString    m_whitespace;</span>
<a href="#l24.296"></a><span id="l24.296" class="difflineplus">+  static const nsCString m_whitespace;</span>
<a href="#l24.297"></a><span id="l24.297"> </span>
<a href="#l24.298"></a><span id="l24.298" class="difflineminus">-  LPMESSAGE    m_lpMsg;</span>
<a href="#l24.299"></a><span id="l24.299" class="difflineplus">+  LPMESSAGE m_lpMsg;</span>
<a href="#l24.300"></a><span id="l24.300"> </span>
<a href="#l24.301"></a><span id="l24.301" class="difflineminus">-  bool         m_dldStateHeadersOnly; // if the message has not been downloaded yet</span>
<a href="#l24.302"></a><span id="l24.302" class="difflineminus">-  CMapiMessageHeaders     m_headers;</span>
<a href="#l24.303"></a><span id="l24.303" class="difflineminus">-  nsCString    m_fromLine; // utf-8</span>
<a href="#l24.304"></a><span id="l24.304" class="difflineminus">-  nsCString    m_mimeContentType; // utf-8</span>
<a href="#l24.305"></a><span id="l24.305" class="difflineminus">-  nsCString    m_mimeBoundary; // utf-8</span>
<a href="#l24.306"></a><span id="l24.306" class="difflineminus">-  nsCString    m_mimeCharset; // utf-8</span>
<a href="#l24.307"></a><span id="l24.307" class="difflineplus">+  bool m_dldStateHeadersOnly;  // if the message has not been downloaded yet</span>
<a href="#l24.308"></a><span id="l24.308" class="difflineplus">+  CMapiMessageHeaders m_headers;</span>
<a href="#l24.309"></a><span id="l24.309" class="difflineplus">+  nsCString m_fromLine;         // utf-8</span>
<a href="#l24.310"></a><span id="l24.310" class="difflineplus">+  nsCString m_mimeContentType;  // utf-8</span>
<a href="#l24.311"></a><span id="l24.311" class="difflineplus">+  nsCString m_mimeBoundary;     // utf-8</span>
<a href="#l24.312"></a><span id="l24.312" class="difflineplus">+  nsCString m_mimeCharset;      // utf-8</span>
<a href="#l24.313"></a><span id="l24.313"> </span>
<a href="#l24.314"></a><span id="l24.314">   std::vector&lt;attach_data*&gt; m_stdattachments;</span>
<a href="#l24.315"></a><span id="l24.315" class="difflineminus">-  std::vector&lt;attach_data*&gt; m_embattachments; // Embedded</span>
<a href="#l24.316"></a><span id="l24.316" class="difflineplus">+  std::vector&lt;attach_data*&gt; m_embattachments;  // Embedded</span>
<a href="#l24.317"></a><span id="l24.317"> </span>
<a href="#l24.318"></a><span id="l24.318" class="difflineminus">-  nsString     m_body; // to be converted from UTF-16 using m_mimeCharset</span>
<a href="#l24.319"></a><span id="l24.319" class="difflineminus">-  bool         m_bodyIsHtml;</span>
<a href="#l24.320"></a><span id="l24.320" class="difflineplus">+  nsString m_body;  // to be converted from UTF-16 using m_mimeCharset</span>
<a href="#l24.321"></a><span id="l24.321" class="difflineplus">+  bool m_bodyIsHtml;</span>
<a href="#l24.322"></a><span id="l24.322"> </span>
<a href="#l24.323"></a><span id="l24.323">   uint32_t m_msgFlags;</span>
<a href="#l24.324"></a><span id="l24.324">   uint32_t m_msgLastVerb;</span>
<a href="#l24.325"></a><span id="l24.325"> </span>
<a href="#l24.326"></a><span id="l24.326">   nsCOMPtr&lt;nsIIOService&gt; m_pIOService;</span>
<a href="#l24.327"></a><span id="l24.327"> </span>
<a href="#l24.328"></a><span id="l24.328" class="difflineminus">-  void    GetDownloadState();</span>
<a href="#l24.329"></a><span id="l24.329" class="difflineplus">+  void GetDownloadState();</span>
<a href="#l24.330"></a><span id="l24.330"> </span>
<a href="#l24.331"></a><span id="l24.331">   // Headers - fetch will get PR_TRANSPORT_MESSAGE_HEADERS</span>
<a href="#l24.332"></a><span id="l24.332">   // or if they do not exist will build a header from</span>
<a href="#l24.333"></a><span id="l24.333">   //  PR_DISPLAY_TO, _CC, _BCC</span>
<a href="#l24.334"></a><span id="l24.334">   //  PR_SUBJECT</span>
<a href="#l24.335"></a><span id="l24.335">   //  PR_MESSAGE_RECIPIENTS</span>
<a href="#l24.336"></a><span id="l24.336">   // and PR_CREATION_TIME if needed?</span>
<a href="#l24.337"></a><span id="l24.337" class="difflineminus">-  bool    FetchHeaders(void);</span>
<a href="#l24.338"></a><span id="l24.338" class="difflineminus">-  bool    FetchBody(void);</span>
<a href="#l24.339"></a><span id="l24.339" class="difflineminus">-  void    FetchFlags(void);</span>
<a href="#l24.340"></a><span id="l24.340" class="difflineplus">+  bool FetchHeaders(void);</span>
<a href="#l24.341"></a><span id="l24.341" class="difflineplus">+  bool FetchBody(void);</span>
<a href="#l24.342"></a><span id="l24.342" class="difflineplus">+  void FetchFlags(void);</span>
<a href="#l24.343"></a><span id="l24.343"> </span>
<a href="#l24.344"></a><span id="l24.344" class="difflineminus">-  static bool GetTmpFile(/*out*/ nsIFile **aResult);</span>
<a href="#l24.345"></a><span id="l24.345" class="difflineminus">-  static bool CopyMsgAttachToFile(LPATTACH lpAttach, /*out*/ nsIFile **tmp_file);</span>
<a href="#l24.346"></a><span id="l24.346" class="difflineminus">-  static bool CopyBinAttachToFile(LPATTACH lpAttach, nsIFile **tmp_file);</span>
<a href="#l24.347"></a><span id="l24.347" class="difflineplus">+  static bool GetTmpFile(/*out*/ nsIFile** aResult);</span>
<a href="#l24.348"></a><span id="l24.348" class="difflineplus">+  static bool CopyMsgAttachToFile(LPATTACH lpAttach,</span>
<a href="#l24.349"></a><span id="l24.349" class="difflineplus">+                                  /*out*/ nsIFile** tmp_file);</span>
<a href="#l24.350"></a><span id="l24.350" class="difflineplus">+  static bool CopyBinAttachToFile(LPATTACH lpAttach, nsIFile** tmp_file);</span>
<a href="#l24.351"></a><span id="l24.351"> </span>
<a href="#l24.352"></a><span id="l24.352">   static void ClearAttachment(attach_data* data);</span>
<a href="#l24.353"></a><span id="l24.353" class="difflineminus">-  void    ClearAttachments();</span>
<a href="#l24.354"></a><span id="l24.354" class="difflineminus">-  bool    AddAttachment(DWORD aNum);</span>
<a href="#l24.355"></a><span id="l24.355" class="difflineminus">-  bool    IterateAttachTable(LPMAPITABLE tbl);</span>
<a href="#l24.356"></a><span id="l24.356" class="difflineminus">-  bool    GetURL(nsIFile *aFile, nsIURI **url);</span>
<a href="#l24.357"></a><span id="l24.357" class="difflineminus">-  void    ProcessAttachments();</span>
<a href="#l24.358"></a><span id="l24.358" class="difflineplus">+  void ClearAttachments();</span>
<a href="#l24.359"></a><span id="l24.359" class="difflineplus">+  bool AddAttachment(DWORD aNum);</span>
<a href="#l24.360"></a><span id="l24.360" class="difflineplus">+  bool IterateAttachTable(LPMAPITABLE tbl);</span>
<a href="#l24.361"></a><span id="l24.361" class="difflineplus">+  bool GetURL(nsIFile* aFile, nsIURI** url);</span>
<a href="#l24.362"></a><span id="l24.362" class="difflineplus">+  void ProcessAttachments();</span>
<a href="#l24.363"></a><span id="l24.363"> </span>
<a href="#l24.364"></a><span id="l24.364" class="difflineminus">-  bool    EnsureHeader(CMapiMessageHeaders::SpecialHeader special, ULONG mapiTag);</span>
<a href="#l24.365"></a><span id="l24.365" class="difflineminus">-  bool    EnsureDate();</span>
<a href="#l24.366"></a><span id="l24.366" class="difflineplus">+  bool EnsureHeader(CMapiMessageHeaders::SpecialHeader special, ULONG mapiTag);</span>
<a href="#l24.367"></a><span id="l24.367" class="difflineplus">+  bool EnsureDate();</span>
<a href="#l24.368"></a><span id="l24.368"> </span>
<a href="#l24.369"></a><span id="l24.369" class="difflineminus">-  void    ProcessContentType();</span>
<a href="#l24.370"></a><span id="l24.370" class="difflineminus">-  bool    CheckBodyInCharsetRange(const char* charset);</span>
<a href="#l24.371"></a><span id="l24.371" class="difflineminus">-  void    FormatDateTime(SYSTEMTIME&amp; tm, nsCString&amp; s, bool includeTZ = true);</span>
<a href="#l24.372"></a><span id="l24.372" class="difflineminus">-  void    BuildFromLine(void);</span>
<a href="#l24.373"></a><span id="l24.373" class="difflineplus">+  void ProcessContentType();</span>
<a href="#l24.374"></a><span id="l24.374" class="difflineplus">+  bool CheckBodyInCharsetRange(const char* charset);</span>
<a href="#l24.375"></a><span id="l24.375" class="difflineplus">+  void FormatDateTime(SYSTEMTIME&amp; tm, nsCString&amp; s, bool includeTZ = true);</span>
<a href="#l24.376"></a><span id="l24.376" class="difflineplus">+  void BuildFromLine(void);</span>
<a href="#l24.377"></a><span id="l24.377"> </span>
<a href="#l24.378"></a><span id="l24.378">   inline static bool IsSpace(char c) {</span>
<a href="#l24.379"></a><span id="l24.379" class="difflineminus">-    return c == ' ' || c == '\r' || c == '\n' || c == '\b' || c == '\t';}</span>
<a href="#l24.380"></a><span id="l24.380" class="difflineplus">+    return c == ' ' || c == '\r' || c == '\n' || c == '\b' || c == '\t';</span>
<a href="#l24.381"></a><span id="l24.381" class="difflineplus">+  }</span>
<a href="#l24.382"></a><span id="l24.382">   inline static bool IsSpace(wchar_t c) {</span>
<a href="#l24.383"></a><span id="l24.383" class="difflineminus">-    return ((c &amp; 0xFF) == c) &amp;&amp; IsSpace(static_cast&lt;char&gt;(c)); } // Avoid false detections</span>
<a href="#l24.384"></a><span id="l24.384" class="difflineplus">+    return ((c &amp; 0xFF) == c) &amp;&amp; IsSpace(static_cast&lt;char&gt;(c));</span>
<a href="#l24.385"></a><span id="l24.385" class="difflineplus">+  }  // Avoid false detections</span>
<a href="#l24.386"></a><span id="l24.386"> };</span>
<a href="#l24.387"></a><span id="l24.387"> </span>
<a href="#l24.388"></a><span id="l24.388"> #endif /* MapiMessage_h__ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/import/outlook/src/MapiMimeTypes.cpp</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/import/outlook/src/MapiMimeTypes.cpp</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -4,93 +4,84 @@</span>
<a href="#l25.4"></a><span id="l25.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l25.5"></a><span id="l25.5"> </span>
<a href="#l25.6"></a><span id="l25.6"> #include &quot;nscore.h&quot;</span>
<a href="#l25.7"></a><span id="l25.7"> #include &quot;nsString.h&quot;</span>
<a href="#l25.8"></a><span id="l25.8"> #include &quot;MapiMimeTypes.h&quot;</span>
<a href="#l25.9"></a><span id="l25.9"> </span>
<a href="#l25.10"></a><span id="l25.10"> uint8_t CMimeTypes::m_mimeBuffer[kMaxMimeTypeSize];</span>
<a href="#l25.11"></a><span id="l25.11"> </span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">-BOOL CMimeTypes::GetKey(HKEY root, LPCTSTR pName, PHKEY pKey)</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineminus">-{</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineminus">-  LONG result = RegOpenKeyEx(root, pName, 0, KEY_QUERY_VALUE | KEY_ENUMERATE_SUB_KEYS, pKey);</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineplus">+BOOL CMimeTypes::GetKey(HKEY root, LPCTSTR pName, PHKEY pKey) {</span>
<a href="#l25.17"></a><span id="l25.17" class="difflineplus">+  LONG result = RegOpenKeyEx(root, pName, 0,</span>
<a href="#l25.18"></a><span id="l25.18" class="difflineplus">+                             KEY_QUERY_VALUE | KEY_ENUMERATE_SUB_KEYS, pKey);</span>
<a href="#l25.19"></a><span id="l25.19">   return result == ERROR_SUCCESS;</span>
<a href="#l25.20"></a><span id="l25.20"> }</span>
<a href="#l25.21"></a><span id="l25.21"> </span>
<a href="#l25.22"></a><span id="l25.22" class="difflineminus">-BOOL CMimeTypes::GetValueBytes(HKEY rootKey, LPCTSTR pValName, LPBYTE *ppBytes)</span>
<a href="#l25.23"></a><span id="l25.23" class="difflineminus">-{</span>
<a href="#l25.24"></a><span id="l25.24" class="difflineminus">-  LONG  err;</span>
<a href="#l25.25"></a><span id="l25.25" class="difflineminus">-  DWORD  bufSz;</span>
<a href="#l25.26"></a><span id="l25.26" class="difflineplus">+BOOL CMimeTypes::GetValueBytes(HKEY rootKey, LPCTSTR pValName,</span>
<a href="#l25.27"></a><span id="l25.27" class="difflineplus">+                               LPBYTE* ppBytes) {</span>
<a href="#l25.28"></a><span id="l25.28" class="difflineplus">+  LONG err;</span>
<a href="#l25.29"></a><span id="l25.29" class="difflineplus">+  DWORD bufSz;</span>
<a href="#l25.30"></a><span id="l25.30"> </span>
<a href="#l25.31"></a><span id="l25.31">   *ppBytes = NULL;</span>
<a href="#l25.32"></a><span id="l25.32">   // Get the installed directory</span>
<a href="#l25.33"></a><span id="l25.33">   err = RegQueryValueEx(rootKey, pValName, NULL, NULL, NULL, &amp;bufSz);</span>
<a href="#l25.34"></a><span id="l25.34">   if (err == ERROR_SUCCESS) {</span>
<a href="#l25.35"></a><span id="l25.35">     *ppBytes = new BYTE[bufSz];</span>
<a href="#l25.36"></a><span id="l25.36">     err = RegQueryValueEx(rootKey, pValName, NULL, NULL, *ppBytes, &amp;bufSz);</span>
<a href="#l25.37"></a><span id="l25.37">     if (err == ERROR_SUCCESS) {</span>
<a href="#l25.38"></a><span id="l25.38">       return TRUE;</span>
<a href="#l25.39"></a><span id="l25.39">     }</span>
<a href="#l25.40"></a><span id="l25.40">     delete *ppBytes;</span>
<a href="#l25.41"></a><span id="l25.41">     *ppBytes = NULL;</span>
<a href="#l25.42"></a><span id="l25.42">   }</span>
<a href="#l25.43"></a><span id="l25.43">   return FALSE;</span>
<a href="#l25.44"></a><span id="l25.44"> }</span>
<a href="#l25.45"></a><span id="l25.45"> </span>
<a href="#l25.46"></a><span id="l25.46" class="difflineminus">-void CMimeTypes::ReleaseValueBytes(LPBYTE pBytes)</span>
<a href="#l25.47"></a><span id="l25.47" class="difflineminus">-{</span>
<a href="#l25.48"></a><span id="l25.48" class="difflineminus">-  if (pBytes)</span>
<a href="#l25.49"></a><span id="l25.49" class="difflineminus">-    delete pBytes;</span>
<a href="#l25.50"></a><span id="l25.50" class="difflineplus">+void CMimeTypes::ReleaseValueBytes(LPBYTE pBytes) {</span>
<a href="#l25.51"></a><span id="l25.51" class="difflineplus">+  if (pBytes) delete pBytes;</span>
<a href="#l25.52"></a><span id="l25.52"> }</span>
<a href="#l25.53"></a><span id="l25.53"> </span>
<a href="#l25.54"></a><span id="l25.54" class="difflineminus">-BOOL CMimeTypes::GetMimeTypeFromReg(const nsCString&amp; ext, LPBYTE *ppBytes)</span>
<a href="#l25.55"></a><span id="l25.55" class="difflineminus">-{</span>
<a href="#l25.56"></a><span id="l25.56" class="difflineminus">-  HKEY  extensionKey;</span>
<a href="#l25.57"></a><span id="l25.57" class="difflineminus">-  BOOL  result = FALSE;</span>
<a href="#l25.58"></a><span id="l25.58" class="difflineplus">+BOOL CMimeTypes::GetMimeTypeFromReg(const nsCString&amp; ext, LPBYTE* ppBytes) {</span>
<a href="#l25.59"></a><span id="l25.59" class="difflineplus">+  HKEY extensionKey;</span>
<a href="#l25.60"></a><span id="l25.60" class="difflineplus">+  BOOL result = FALSE;</span>
<a href="#l25.61"></a><span id="l25.61">   *ppBytes = NULL;</span>
<a href="#l25.62"></a><span id="l25.62">   if (GetKey(HKEY_CLASSES_ROOT, ext.get(), &amp;extensionKey)) {</span>
<a href="#l25.63"></a><span id="l25.63">     result = GetValueBytes(extensionKey, &quot;Content Type&quot;, ppBytes);</span>
<a href="#l25.64"></a><span id="l25.64">     RegCloseKey(extensionKey);</span>
<a href="#l25.65"></a><span id="l25.65">   }</span>
<a href="#l25.66"></a><span id="l25.66"> </span>
<a href="#l25.67"></a><span id="l25.67">   return result;</span>
<a href="#l25.68"></a><span id="l25.68"> }</span>
<a href="#l25.69"></a><span id="l25.69"> </span>
<a href="#l25.70"></a><span id="l25.70" class="difflineminus">-uint8_t * CMimeTypes::GetMimeType(const nsString&amp; theExt)</span>
<a href="#l25.71"></a><span id="l25.71" class="difflineminus">-{</span>
<a href="#l25.72"></a><span id="l25.72" class="difflineplus">+uint8_t* CMimeTypes::GetMimeType(const nsString&amp; theExt) {</span>
<a href="#l25.73"></a><span id="l25.73">   nsCString ext;</span>
<a href="#l25.74"></a><span id="l25.74">   LossyCopyUTF16toASCII(theExt, ext);</span>
<a href="#l25.75"></a><span id="l25.75">   return GetMimeType(ext);</span>
<a href="#l25.76"></a><span id="l25.76"> }</span>
<a href="#l25.77"></a><span id="l25.77"> </span>
<a href="#l25.78"></a><span id="l25.78" class="difflineminus">-uint8_t * CMimeTypes::GetMimeType(const nsCString&amp; theExt)</span>
<a href="#l25.79"></a><span id="l25.79" class="difflineminus">-{</span>
<a href="#l25.80"></a><span id="l25.80" class="difflineminus">-  nsCString  ext = theExt;</span>
<a href="#l25.81"></a><span id="l25.81" class="difflineplus">+uint8_t* CMimeTypes::GetMimeType(const nsCString&amp; theExt) {</span>
<a href="#l25.82"></a><span id="l25.82" class="difflineplus">+  nsCString ext = theExt;</span>
<a href="#l25.83"></a><span id="l25.83">   if (ext.Length()) {</span>
<a href="#l25.84"></a><span id="l25.84">     if (ext.First() != '.') {</span>
<a href="#l25.85"></a><span id="l25.85">       ext = &quot;.&quot;;</span>
<a href="#l25.86"></a><span id="l25.86">       ext += theExt;</span>
<a href="#l25.87"></a><span id="l25.87">     }</span>
<a href="#l25.88"></a><span id="l25.88">   }</span>
<a href="#l25.89"></a><span id="l25.89"> </span>
<a href="#l25.90"></a><span id="l25.90" class="difflineminus">-</span>
<a href="#l25.91"></a><span id="l25.91" class="difflineminus">-  BOOL  result = FALSE;</span>
<a href="#l25.92"></a><span id="l25.92" class="difflineminus">-  int    len;</span>
<a href="#l25.93"></a><span id="l25.93" class="difflineplus">+  BOOL result = FALSE;</span>
<a href="#l25.94"></a><span id="l25.94" class="difflineplus">+  int len;</span>
<a href="#l25.95"></a><span id="l25.95"> </span>
<a href="#l25.96"></a><span id="l25.96" class="difflineminus">-  if (!ext.Length())</span>
<a href="#l25.97"></a><span id="l25.97" class="difflineminus">-    return NULL;</span>
<a href="#l25.98"></a><span id="l25.98" class="difflineminus">-  LPBYTE  pByte;</span>
<a href="#l25.99"></a><span id="l25.99" class="difflineplus">+  if (!ext.Length()) return NULL;</span>
<a href="#l25.100"></a><span id="l25.100" class="difflineplus">+  LPBYTE pByte;</span>
<a href="#l25.101"></a><span id="l25.101">   if (GetMimeTypeFromReg(ext, &amp;pByte)) {</span>
<a href="#l25.102"></a><span id="l25.102" class="difflineminus">-    len = strlen((const char *) pByte);</span>
<a href="#l25.103"></a><span id="l25.103" class="difflineplus">+    len = strlen((const char*)pByte);</span>
<a href="#l25.104"></a><span id="l25.104">     if (len &amp;&amp; (len &lt; kMaxMimeTypeSize)) {</span>
<a href="#l25.105"></a><span id="l25.105">       memcpy(m_mimeBuffer, pByte, len);</span>
<a href="#l25.106"></a><span id="l25.106">       m_mimeBuffer[len] = 0;</span>
<a href="#l25.107"></a><span id="l25.107">       result = TRUE;</span>
<a href="#l25.108"></a><span id="l25.108">     }</span>
<a href="#l25.109"></a><span id="l25.109">     ReleaseValueBytes(pByte);</span>
<a href="#l25.110"></a><span id="l25.110">   }</span>
<a href="#l25.111"></a><span id="l25.111"> </span>
<a href="#l25.112"></a><span id="l25.112" class="difflineminus">-  if (result)</span>
<a href="#l25.113"></a><span id="l25.113" class="difflineminus">-    return m_mimeBuffer;</span>
<a href="#l25.114"></a><span id="l25.114" class="difflineplus">+  if (result) return m_mimeBuffer;</span>
<a href="#l25.115"></a><span id="l25.115"> </span>
<a href="#l25.116"></a><span id="l25.116">   return NULL;</span>
<a href="#l25.117"></a><span id="l25.117"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/import/outlook/src/MapiMimeTypes.h</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/import/outlook/src/MapiMimeTypes.h</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -3,29 +3,26 @@</span>
<a href="#l26.4"></a><span id="l26.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l26.5"></a><span id="l26.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l26.6"></a><span id="l26.6"> </span>
<a href="#l26.7"></a><span id="l26.7"> #ifndef MapiMimeTypes_h___</span>
<a href="#l26.8"></a><span id="l26.8"> #define MapiMimeTypes_h___</span>
<a href="#l26.9"></a><span id="l26.9"> </span>
<a href="#l26.10"></a><span id="l26.10"> #include &lt;windows.h&gt;</span>
<a href="#l26.11"></a><span id="l26.11"> </span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-#define kMaxMimeTypeSize  256</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+#define kMaxMimeTypeSize 256</span>
<a href="#l26.14"></a><span id="l26.14"> </span>
<a href="#l26.15"></a><span id="l26.15"> class CMimeTypes {</span>
<a href="#l26.16"></a><span id="l26.16" class="difflineminus">-public:</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineplus">+ public:</span>
<a href="#l26.18"></a><span id="l26.18" class="difflineplus">+  static uint8_t* GetMimeType(const nsCString&amp; theExt);</span>
<a href="#l26.19"></a><span id="l26.19" class="difflineplus">+  static uint8_t* GetMimeType(const nsString&amp; theExt);</span>
<a href="#l26.20"></a><span id="l26.20"> </span>
<a href="#l26.21"></a><span id="l26.21" class="difflineminus">-static uint8_t *  GetMimeType(const nsCString&amp; theExt);</span>
<a href="#l26.22"></a><span id="l26.22" class="difflineminus">-static uint8_t *  GetMimeType(const nsString&amp; theExt);</span>
<a href="#l26.23"></a><span id="l26.23" class="difflineminus">-</span>
<a href="#l26.24"></a><span id="l26.24" class="difflineminus">-protected:</span>
<a href="#l26.25"></a><span id="l26.25" class="difflineplus">+ protected:</span>
<a href="#l26.26"></a><span id="l26.26">   // Registry stuff</span>
<a href="#l26.27"></a><span id="l26.27" class="difflineminus">-static BOOL  GetKey(HKEY root, LPCTSTR pName, PHKEY pKey);</span>
<a href="#l26.28"></a><span id="l26.28" class="difflineminus">-static BOOL  GetValueBytes(HKEY rootKey, LPCTSTR pValName, LPBYTE *ppBytes);</span>
<a href="#l26.29"></a><span id="l26.29" class="difflineminus">-static void  ReleaseValueBytes(LPBYTE pBytes);</span>
<a href="#l26.30"></a><span id="l26.30" class="difflineminus">-static BOOL  GetMimeTypeFromReg(const nsCString&amp; ext, LPBYTE *ppBytes);</span>
<a href="#l26.31"></a><span id="l26.31" class="difflineplus">+  static BOOL GetKey(HKEY root, LPCTSTR pName, PHKEY pKey);</span>
<a href="#l26.32"></a><span id="l26.32" class="difflineplus">+  static BOOL GetValueBytes(HKEY rootKey, LPCTSTR pValName, LPBYTE* ppBytes);</span>
<a href="#l26.33"></a><span id="l26.33" class="difflineplus">+  static void ReleaseValueBytes(LPBYTE pBytes);</span>
<a href="#l26.34"></a><span id="l26.34" class="difflineplus">+  static BOOL GetMimeTypeFromReg(const nsCString&amp; ext, LPBYTE* ppBytes);</span>
<a href="#l26.35"></a><span id="l26.35"> </span>
<a href="#l26.36"></a><span id="l26.36" class="difflineminus">-</span>
<a href="#l26.37"></a><span id="l26.37" class="difflineminus">-static uint8_t          m_mimeBuffer[kMaxMimeTypeSize];</span>
<a href="#l26.38"></a><span id="l26.38" class="difflineplus">+  static uint8_t m_mimeBuffer[kMaxMimeTypeSize];</span>
<a href="#l26.39"></a><span id="l26.39"> };</span>
<a href="#l26.40"></a><span id="l26.40"> </span>
<a href="#l26.41"></a><span id="l26.41"> #endif /* MapiMimeTypes_h__ */</span>
<a href="#l26.42"></a><span id="l26.42" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/import/outlook/src/MapiTagStrs.cpp</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/import/outlook/src/MapiTagStrs.cpp</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -1,1070 +1,1474 @@</span>
<a href="#l27.4"></a><span id="l27.4" class="difflineminus">-/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l27.5"></a><span id="l27.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l27.6"></a><span id="l27.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l27.7"></a><span id="l27.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l27.8"></a><span id="l27.8" class="difflineplus">+  /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l27.9"></a><span id="l27.9" class="difflineplus">+   */</span>
<a href="#l27.10"></a><span id="l27.10" class="difflineplus">+  /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l27.11"></a><span id="l27.11" class="difflineplus">+   * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineplus">+   * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l27.13"></a><span id="l27.13"> </span>
<a href="#l27.14"></a><span id="l27.14" class="difflineminus">-/*</span>
<a href="#l27.15"></a><span id="l27.15" class="difflineminus">- *  Message envelope properties</span>
<a href="#l27.16"></a><span id="l27.16" class="difflineminus">- */</span>
<a href="#l27.17"></a><span id="l27.17" class="difflineplus">+  /*</span>
<a href="#l27.18"></a><span id="l27.18" class="difflineplus">+   *  Message envelope properties</span>
<a href="#l27.19"></a><span id="l27.19" class="difflineplus">+   */</span>
<a href="#l27.20"></a><span id="l27.20"> </span>
<a href="#l27.21"></a><span id="l27.21"> case PR_ACKNOWLEDGEMENT_MODE:</span>
<a href="#l27.22"></a><span id="l27.22" class="difflineminus">-  s = &quot;PR_ACKNOWLEDGEMENT_MODE&quot;; break;</span>
<a href="#l27.23"></a><span id="l27.23" class="difflineplus">+  s = &quot;PR_ACKNOWLEDGEMENT_MODE&quot;;</span>
<a href="#l27.24"></a><span id="l27.24" class="difflineplus">+  break;</span>
<a href="#l27.25"></a><span id="l27.25"> case PR_ALTERNATE_RECIPIENT_ALLOWED:</span>
<a href="#l27.26"></a><span id="l27.26" class="difflineminus">-  s = &quot;PR_ALTERNATE_RECIPIENT_ALLOWED&quot;; break;</span>
<a href="#l27.27"></a><span id="l27.27" class="difflineplus">+  s = &quot;PR_ALTERNATE_RECIPIENT_ALLOWED&quot;;</span>
<a href="#l27.28"></a><span id="l27.28" class="difflineplus">+  break;</span>
<a href="#l27.29"></a><span id="l27.29"> case PR_AUTHORIZING_USERS:</span>
<a href="#l27.30"></a><span id="l27.30" class="difflineminus">-  s = &quot;PR_AUTHORIZING_USERS&quot;; break;</span>
<a href="#l27.31"></a><span id="l27.31" class="difflineplus">+  s = &quot;PR_AUTHORIZING_USERS&quot;;</span>
<a href="#l27.32"></a><span id="l27.32" class="difflineplus">+  break;</span>
<a href="#l27.33"></a><span id="l27.33"> case PR_AUTO_FORWARD_COMMENT:</span>
<a href="#l27.34"></a><span id="l27.34" class="difflineminus">-  s = &quot;PR_AUTO_FORWARD_COMMENT&quot;; break;</span>
<a href="#l27.35"></a><span id="l27.35" class="difflineplus">+  s = &quot;PR_AUTO_FORWARD_COMMENT&quot;;</span>
<a href="#l27.36"></a><span id="l27.36" class="difflineplus">+  break;</span>
<a href="#l27.37"></a><span id="l27.37"> case PR_AUTO_FORWARDED:</span>
<a href="#l27.38"></a><span id="l27.38" class="difflineminus">-  s = &quot;PR_AUTO_FORWARDED&quot;; break;</span>
<a href="#l27.39"></a><span id="l27.39" class="difflineplus">+  s = &quot;PR_AUTO_FORWARDED&quot;;</span>
<a href="#l27.40"></a><span id="l27.40" class="difflineplus">+  break;</span>
<a href="#l27.41"></a><span id="l27.41"> case PR_CONTENT_CONFIDENTIALITY_ALGORITHM_ID:</span>
<a href="#l27.42"></a><span id="l27.42" class="difflineminus">-  s = &quot;PR_CONTENT_CONFIDENTIALITY_ALGORITHM_ID&quot;; break;</span>
<a href="#l27.43"></a><span id="l27.43" class="difflineplus">+  s = &quot;PR_CONTENT_CONFIDENTIALITY_ALGORITHM_ID&quot;;</span>
<a href="#l27.44"></a><span id="l27.44" class="difflineplus">+  break;</span>
<a href="#l27.45"></a><span id="l27.45"> case PR_CONTENT_CORRELATOR:</span>
<a href="#l27.46"></a><span id="l27.46" class="difflineminus">-  s = &quot;PR_CONTENT_CORRELATOR&quot;; break;</span>
<a href="#l27.47"></a><span id="l27.47" class="difflineplus">+  s = &quot;PR_CONTENT_CORRELATOR&quot;;</span>
<a href="#l27.48"></a><span id="l27.48" class="difflineplus">+  break;</span>
<a href="#l27.49"></a><span id="l27.49"> case PR_CONTENT_IDENTIFIER:</span>
<a href="#l27.50"></a><span id="l27.50" class="difflineminus">-  s = &quot;PR_CONTENT_IDENTIFIER&quot;; break;</span>
<a href="#l27.51"></a><span id="l27.51" class="difflineplus">+  s = &quot;PR_CONTENT_IDENTIFIER&quot;;</span>
<a href="#l27.52"></a><span id="l27.52" class="difflineplus">+  break;</span>
<a href="#l27.53"></a><span id="l27.53"> case PR_CONTENT_LENGTH:</span>
<a href="#l27.54"></a><span id="l27.54" class="difflineminus">-  s = &quot;PR_CONTENT_LENGTH&quot;; break;</span>
<a href="#l27.55"></a><span id="l27.55" class="difflineplus">+  s = &quot;PR_CONTENT_LENGTH&quot;;</span>
<a href="#l27.56"></a><span id="l27.56" class="difflineplus">+  break;</span>
<a href="#l27.57"></a><span id="l27.57"> case PR_CONTENT_RETURN_REQUESTED:</span>
<a href="#l27.58"></a><span id="l27.58" class="difflineminus">-  s = &quot;PR_CONTENT_RETURN_REQUESTED&quot;; break;</span>
<a href="#l27.59"></a><span id="l27.59" class="difflineminus">-</span>
<a href="#l27.60"></a><span id="l27.60" class="difflineminus">-</span>
<a href="#l27.61"></a><span id="l27.61" class="difflineplus">+  s = &quot;PR_CONTENT_RETURN_REQUESTED&quot;;</span>
<a href="#l27.62"></a><span id="l27.62" class="difflineplus">+  break;</span>
<a href="#l27.63"></a><span id="l27.63"> </span>
<a href="#l27.64"></a><span id="l27.64"> case PR_CONVERSATION_KEY:</span>
<a href="#l27.65"></a><span id="l27.65" class="difflineminus">-  s = &quot;PR_CONVERSATION_KEY&quot;; break;</span>
<a href="#l27.66"></a><span id="l27.66" class="difflineplus">+  s = &quot;PR_CONVERSATION_KEY&quot;;</span>
<a href="#l27.67"></a><span id="l27.67" class="difflineplus">+  break;</span>
<a href="#l27.68"></a><span id="l27.68"> </span>
<a href="#l27.69"></a><span id="l27.69"> case PR_CONVERSION_EITS:</span>
<a href="#l27.70"></a><span id="l27.70" class="difflineminus">-  s = &quot;PR_CONVERSION_EITS&quot;; break;</span>
<a href="#l27.71"></a><span id="l27.71" class="difflineplus">+  s = &quot;PR_CONVERSION_EITS&quot;;</span>
<a href="#l27.72"></a><span id="l27.72" class="difflineplus">+  break;</span>
<a href="#l27.73"></a><span id="l27.73"> case PR_CONVERSION_WITH_LOSS_PROHIBITED:</span>
<a href="#l27.74"></a><span id="l27.74" class="difflineminus">-  s = &quot;PR_CONVERSION_WITH_LOSS_PROHIBITED&quot;; break;</span>
<a href="#l27.75"></a><span id="l27.75" class="difflineplus">+  s = &quot;PR_CONVERSION_WITH_LOSS_PROHIBITED&quot;;</span>
<a href="#l27.76"></a><span id="l27.76" class="difflineplus">+  break;</span>
<a href="#l27.77"></a><span id="l27.77"> case PR_CONVERTED_EITS:</span>
<a href="#l27.78"></a><span id="l27.78" class="difflineminus">-  s = &quot;PR_CONVERTED_EITS&quot;; break;</span>
<a href="#l27.79"></a><span id="l27.79" class="difflineplus">+  s = &quot;PR_CONVERTED_EITS&quot;;</span>
<a href="#l27.80"></a><span id="l27.80" class="difflineplus">+  break;</span>
<a href="#l27.81"></a><span id="l27.81"> case PR_DEFERRED_DELIVERY_TIME:</span>
<a href="#l27.82"></a><span id="l27.82" class="difflineminus">-  s = &quot;PR_DEFERRED_DELIVERY_TIME&quot;; break;</span>
<a href="#l27.83"></a><span id="l27.83" class="difflineplus">+  s = &quot;PR_DEFERRED_DELIVERY_TIME&quot;;</span>
<a href="#l27.84"></a><span id="l27.84" class="difflineplus">+  break;</span>
<a href="#l27.85"></a><span id="l27.85"> case PR_DELIVER_TIME:</span>
<a href="#l27.86"></a><span id="l27.86" class="difflineminus">-  s = &quot;PR_DELIVER_TIME&quot;; break;</span>
<a href="#l27.87"></a><span id="l27.87" class="difflineplus">+  s = &quot;PR_DELIVER_TIME&quot;;</span>
<a href="#l27.88"></a><span id="l27.88" class="difflineplus">+  break;</span>
<a href="#l27.89"></a><span id="l27.89"> case PR_DISCARD_REASON:</span>
<a href="#l27.90"></a><span id="l27.90" class="difflineminus">-  s = &quot;PR_DISCARD_REASON&quot;; break;</span>
<a href="#l27.91"></a><span id="l27.91" class="difflineplus">+  s = &quot;PR_DISCARD_REASON&quot;;</span>
<a href="#l27.92"></a><span id="l27.92" class="difflineplus">+  break;</span>
<a href="#l27.93"></a><span id="l27.93"> case PR_DISCLOSURE_OF_RECIPIENTS:</span>
<a href="#l27.94"></a><span id="l27.94" class="difflineminus">-  s = &quot;PR_DISCLOSURE_OF_RECIPIENTS&quot;; break;</span>
<a href="#l27.95"></a><span id="l27.95" class="difflineplus">+  s = &quot;PR_DISCLOSURE_OF_RECIPIENTS&quot;;</span>
<a href="#l27.96"></a><span id="l27.96" class="difflineplus">+  break;</span>
<a href="#l27.97"></a><span id="l27.97"> case PR_DL_EXPANSION_HISTORY:</span>
<a href="#l27.98"></a><span id="l27.98" class="difflineminus">-  s = &quot;PR_DL_EXPANSION_HISTORY&quot;; break;</span>
<a href="#l27.99"></a><span id="l27.99" class="difflineplus">+  s = &quot;PR_DL_EXPANSION_HISTORY&quot;;</span>
<a href="#l27.100"></a><span id="l27.100" class="difflineplus">+  break;</span>
<a href="#l27.101"></a><span id="l27.101"> case PR_DL_EXPANSION_PROHIBITED:</span>
<a href="#l27.102"></a><span id="l27.102" class="difflineminus">-  s = &quot;PR_DL_EXPANSION_PROHIBITED&quot;; break;</span>
<a href="#l27.103"></a><span id="l27.103" class="difflineplus">+  s = &quot;PR_DL_EXPANSION_PROHIBITED&quot;;</span>
<a href="#l27.104"></a><span id="l27.104" class="difflineplus">+  break;</span>
<a href="#l27.105"></a><span id="l27.105"> case PR_EXPIRY_TIME:</span>
<a href="#l27.106"></a><span id="l27.106" class="difflineminus">-  s = &quot;PR_EXPIRY_TIME&quot;; break;</span>
<a href="#l27.107"></a><span id="l27.107" class="difflineplus">+  s = &quot;PR_EXPIRY_TIME&quot;;</span>
<a href="#l27.108"></a><span id="l27.108" class="difflineplus">+  break;</span>
<a href="#l27.109"></a><span id="l27.109"> case PR_IMPLICIT_CONVERSION_PROHIBITED:</span>
<a href="#l27.110"></a><span id="l27.110" class="difflineminus">-  s = &quot;PR_IMPLICIT_CONVERSION_PROHIBITED&quot;; break;</span>
<a href="#l27.111"></a><span id="l27.111" class="difflineplus">+  s = &quot;PR_IMPLICIT_CONVERSION_PROHIBITED&quot;;</span>
<a href="#l27.112"></a><span id="l27.112" class="difflineplus">+  break;</span>
<a href="#l27.113"></a><span id="l27.113"> case PR_IMPORTANCE:</span>
<a href="#l27.114"></a><span id="l27.114" class="difflineminus">-  s = &quot;PR_IMPORTANCE&quot;; break;</span>
<a href="#l27.115"></a><span id="l27.115" class="difflineplus">+  s = &quot;PR_IMPORTANCE&quot;;</span>
<a href="#l27.116"></a><span id="l27.116" class="difflineplus">+  break;</span>
<a href="#l27.117"></a><span id="l27.117"> case PR_IPM_ID:</span>
<a href="#l27.118"></a><span id="l27.118" class="difflineminus">-  s = &quot;PR_IPM_ID&quot;; break;</span>
<a href="#l27.119"></a><span id="l27.119" class="difflineplus">+  s = &quot;PR_IPM_ID&quot;;</span>
<a href="#l27.120"></a><span id="l27.120" class="difflineplus">+  break;</span>
<a href="#l27.121"></a><span id="l27.121"> case PR_LATEST_DELIVERY_TIME:</span>
<a href="#l27.122"></a><span id="l27.122" class="difflineminus">-  s = &quot;PR_LATEST_DELIVERY_TIME&quot;; break;</span>
<a href="#l27.123"></a><span id="l27.123" class="difflineplus">+  s = &quot;PR_LATEST_DELIVERY_TIME&quot;;</span>
<a href="#l27.124"></a><span id="l27.124" class="difflineplus">+  break;</span>
<a href="#l27.125"></a><span id="l27.125"> case PR_MESSAGE_CLASS:</span>
<a href="#l27.126"></a><span id="l27.126" class="difflineminus">-  s = &quot;PR_MESSAGE_CLASS&quot;; break;</span>
<a href="#l27.127"></a><span id="l27.127" class="difflineplus">+  s = &quot;PR_MESSAGE_CLASS&quot;;</span>
<a href="#l27.128"></a><span id="l27.128" class="difflineplus">+  break;</span>
<a href="#l27.129"></a><span id="l27.129"> case PR_MESSAGE_DELIVERY_ID:</span>
<a href="#l27.130"></a><span id="l27.130" class="difflineminus">-  s = &quot;PR_MESSAGE_DELIVERY_ID&quot;; break;</span>
<a href="#l27.131"></a><span id="l27.131" class="difflineminus">-</span>
<a href="#l27.132"></a><span id="l27.132" class="difflineminus">-</span>
<a href="#l27.133"></a><span id="l27.133" class="difflineminus">-</span>
<a href="#l27.134"></a><span id="l27.134" class="difflineminus">-</span>
<a href="#l27.135"></a><span id="l27.135" class="difflineplus">+  s = &quot;PR_MESSAGE_DELIVERY_ID&quot;;</span>
<a href="#l27.136"></a><span id="l27.136" class="difflineplus">+  break;</span>
<a href="#l27.137"></a><span id="l27.137"> </span>
<a href="#l27.138"></a><span id="l27.138"> case PR_MESSAGE_SECURITY_LABEL:</span>
<a href="#l27.139"></a><span id="l27.139" class="difflineminus">-  s = &quot;PR_MESSAGE_SECURITY_LABEL&quot;; break;</span>
<a href="#l27.140"></a><span id="l27.140" class="difflineplus">+  s = &quot;PR_MESSAGE_SECURITY_LABEL&quot;;</span>
<a href="#l27.141"></a><span id="l27.141" class="difflineplus">+  break;</span>
<a href="#l27.142"></a><span id="l27.142"> case PR_OBSOLETED_IPMS:</span>
<a href="#l27.143"></a><span id="l27.143" class="difflineminus">-  s = &quot;PR_OBSOLETED_IPMS&quot;; break;</span>
<a href="#l27.144"></a><span id="l27.144" class="difflineplus">+  s = &quot;PR_OBSOLETED_IPMS&quot;;</span>
<a href="#l27.145"></a><span id="l27.145" class="difflineplus">+  break;</span>
<a href="#l27.146"></a><span id="l27.146"> case PR_ORIGINALLY_INTENDED_RECIPIENT_NAME:</span>
<a href="#l27.147"></a><span id="l27.147" class="difflineminus">-  s = &quot;PR_ORIGINALLY_INTENDED_RECIPIENT_NAME&quot;; break;</span>
<a href="#l27.148"></a><span id="l27.148" class="difflineplus">+  s = &quot;PR_ORIGINALLY_INTENDED_RECIPIENT_NAME&quot;;</span>
<a href="#l27.149"></a><span id="l27.149" class="difflineplus">+  break;</span>
<a href="#l27.150"></a><span id="l27.150"> case PR_ORIGINAL_EITS:</span>
<a href="#l27.151"></a><span id="l27.151" class="difflineminus">-  s = &quot;PR_ORIGINAL_EITS&quot;; break;</span>
<a href="#l27.152"></a><span id="l27.152" class="difflineplus">+  s = &quot;PR_ORIGINAL_EITS&quot;;</span>
<a href="#l27.153"></a><span id="l27.153" class="difflineplus">+  break;</span>
<a href="#l27.154"></a><span id="l27.154"> case PR_ORIGINATOR_CERTIFICATE:</span>
<a href="#l27.155"></a><span id="l27.155" class="difflineminus">-  s = &quot;PR_ORIGINATOR_CERTIFICATE&quot;; break;</span>
<a href="#l27.156"></a><span id="l27.156" class="difflineplus">+  s = &quot;PR_ORIGINATOR_CERTIFICATE&quot;;</span>
<a href="#l27.157"></a><span id="l27.157" class="difflineplus">+  break;</span>
<a href="#l27.158"></a><span id="l27.158"> case PR_ORIGINATOR_DELIVERY_REPORT_REQUESTED:</span>
<a href="#l27.159"></a><span id="l27.159" class="difflineminus">-  s = &quot;PR_ORIGINATOR_DELIVERY_REPORT_REQUESTED&quot;; break;</span>
<a href="#l27.160"></a><span id="l27.160" class="difflineplus">+  s = &quot;PR_ORIGINATOR_DELIVERY_REPORT_REQUESTED&quot;;</span>
<a href="#l27.161"></a><span id="l27.161" class="difflineplus">+  break;</span>
<a href="#l27.162"></a><span id="l27.162"> case PR_ORIGINATOR_RETURN_ADDRESS:</span>
<a href="#l27.163"></a><span id="l27.163" class="difflineminus">-  s = &quot;PR_ORIGINATOR_RETURN_ADDRESS&quot;; break;</span>
<a href="#l27.164"></a><span id="l27.164" class="difflineminus">-</span>
<a href="#l27.165"></a><span id="l27.165" class="difflineminus">-</span>
<a href="#l27.166"></a><span id="l27.166" class="difflineplus">+  s = &quot;PR_ORIGINATOR_RETURN_ADDRESS&quot;;</span>
<a href="#l27.167"></a><span id="l27.167" class="difflineplus">+  break;</span>
<a href="#l27.168"></a><span id="l27.168"> </span>
<a href="#l27.169"></a><span id="l27.169"> case PR_PARENT_KEY:</span>
<a href="#l27.170"></a><span id="l27.170" class="difflineminus">-  s = &quot;PR_PARENT_KEY&quot;; break;</span>
<a href="#l27.171"></a><span id="l27.171" class="difflineplus">+  s = &quot;PR_PARENT_KEY&quot;;</span>
<a href="#l27.172"></a><span id="l27.172" class="difflineplus">+  break;</span>
<a href="#l27.173"></a><span id="l27.173"> case PR_PRIORITY:</span>
<a href="#l27.174"></a><span id="l27.174" class="difflineminus">-  s = &quot;PR_PRIORITY&quot;; break;</span>
<a href="#l27.175"></a><span id="l27.175" class="difflineminus">-</span>
<a href="#l27.176"></a><span id="l27.176" class="difflineminus">-</span>
<a href="#l27.177"></a><span id="l27.177" class="difflineplus">+  s = &quot;PR_PRIORITY&quot;;</span>
<a href="#l27.178"></a><span id="l27.178" class="difflineplus">+  break;</span>
<a href="#l27.179"></a><span id="l27.179"> </span>
<a href="#l27.180"></a><span id="l27.180"> case PR_ORIGIN_CHECK:</span>
<a href="#l27.181"></a><span id="l27.181" class="difflineminus">-  s = &quot;PR_ORIGIN_CHECK&quot;; break;</span>
<a href="#l27.182"></a><span id="l27.182" class="difflineplus">+  s = &quot;PR_ORIGIN_CHECK&quot;;</span>
<a href="#l27.183"></a><span id="l27.183" class="difflineplus">+  break;</span>
<a href="#l27.184"></a><span id="l27.184"> case PR_PROOF_OF_SUBMISSION_REQUESTED:</span>
<a href="#l27.185"></a><span id="l27.185" class="difflineminus">-  s = &quot;PR_PROOF_OF_SUBMISSION_REQUESTED&quot;; break;</span>
<a href="#l27.186"></a><span id="l27.186" class="difflineplus">+  s = &quot;PR_PROOF_OF_SUBMISSION_REQUESTED&quot;;</span>
<a href="#l27.187"></a><span id="l27.187" class="difflineplus">+  break;</span>
<a href="#l27.188"></a><span id="l27.188"> case PR_READ_RECEIPT_REQUESTED:</span>
<a href="#l27.189"></a><span id="l27.189" class="difflineminus">-  s = &quot;PR_READ_RECEIPT_REQUESTED&quot;; break;</span>
<a href="#l27.190"></a><span id="l27.190" class="difflineplus">+  s = &quot;PR_READ_RECEIPT_REQUESTED&quot;;</span>
<a href="#l27.191"></a><span id="l27.191" class="difflineplus">+  break;</span>
<a href="#l27.192"></a><span id="l27.192"> case PR_RECEIPT_TIME:</span>
<a href="#l27.193"></a><span id="l27.193" class="difflineminus">-  s = &quot;PR_RECEIPT_TIME&quot;; break;</span>
<a href="#l27.194"></a><span id="l27.194" class="difflineplus">+  s = &quot;PR_RECEIPT_TIME&quot;;</span>
<a href="#l27.195"></a><span id="l27.195" class="difflineplus">+  break;</span>
<a href="#l27.196"></a><span id="l27.196"> case PR_RECIPIENT_REASSIGNMENT_PROHIBITED:</span>
<a href="#l27.197"></a><span id="l27.197" class="difflineminus">-  s = &quot;PR_RECIPIENT_REASSIGNMENT_PROHIBITED&quot;; break;</span>
<a href="#l27.198"></a><span id="l27.198" class="difflineplus">+  s = &quot;PR_RECIPIENT_REASSIGNMENT_PROHIBITED&quot;;</span>
<a href="#l27.199"></a><span id="l27.199" class="difflineplus">+  break;</span>
<a href="#l27.200"></a><span id="l27.200"> case PR_REDIRECTION_HISTORY:</span>
<a href="#l27.201"></a><span id="l27.201" class="difflineminus">-  s = &quot;PR_REDIRECTION_HISTORY&quot;; break;</span>
<a href="#l27.202"></a><span id="l27.202" class="difflineplus">+  s = &quot;PR_REDIRECTION_HISTORY&quot;;</span>
<a href="#l27.203"></a><span id="l27.203" class="difflineplus">+  break;</span>
<a href="#l27.204"></a><span id="l27.204"> case PR_RELATED_IPMS:</span>
<a href="#l27.205"></a><span id="l27.205" class="difflineminus">-  s = &quot;PR_RELATED_IPMS&quot;; break;</span>
<a href="#l27.206"></a><span id="l27.206" class="difflineplus">+  s = &quot;PR_RELATED_IPMS&quot;;</span>
<a href="#l27.207"></a><span id="l27.207" class="difflineplus">+  break;</span>
<a href="#l27.208"></a><span id="l27.208"> case PR_ORIGINAL_SENSITIVITY:</span>
<a href="#l27.209"></a><span id="l27.209" class="difflineminus">-  s = &quot;PR_ORIGINAL_SENSITIVITY&quot;; break;</span>
<a href="#l27.210"></a><span id="l27.210" class="difflineplus">+  s = &quot;PR_ORIGINAL_SENSITIVITY&quot;;</span>
<a href="#l27.211"></a><span id="l27.211" class="difflineplus">+  break;</span>
<a href="#l27.212"></a><span id="l27.212"> case PR_LANGUAGES:</span>
<a href="#l27.213"></a><span id="l27.213" class="difflineminus">-  s = &quot;PR_LANGUAGES&quot;; break;</span>
<a href="#l27.214"></a><span id="l27.214" class="difflineplus">+  s = &quot;PR_LANGUAGES&quot;;</span>
<a href="#l27.215"></a><span id="l27.215" class="difflineplus">+  break;</span>
<a href="#l27.216"></a><span id="l27.216"> case PR_REPLY_TIME:</span>
<a href="#l27.217"></a><span id="l27.217" class="difflineminus">-  s = &quot;PR_REPLY_TIME&quot;; break;</span>
<a href="#l27.218"></a><span id="l27.218" class="difflineplus">+  s = &quot;PR_REPLY_TIME&quot;;</span>
<a href="#l27.219"></a><span id="l27.219" class="difflineplus">+  break;</span>
<a href="#l27.220"></a><span id="l27.220"> case PR_REPORT_TAG:</span>
<a href="#l27.221"></a><span id="l27.221" class="difflineminus">-  s = &quot;PR_REPORT_TAG&quot;; break;</span>
<a href="#l27.222"></a><span id="l27.222" class="difflineplus">+  s = &quot;PR_REPORT_TAG&quot;;</span>
<a href="#l27.223"></a><span id="l27.223" class="difflineplus">+  break;</span>
<a href="#l27.224"></a><span id="l27.224"> case PR_REPORT_TIME:</span>
<a href="#l27.225"></a><span id="l27.225" class="difflineminus">-  s = &quot;PR_REPORT_TIME&quot;; break;</span>
<a href="#l27.226"></a><span id="l27.226" class="difflineplus">+  s = &quot;PR_REPORT_TIME&quot;;</span>
<a href="#l27.227"></a><span id="l27.227" class="difflineplus">+  break;</span>
<a href="#l27.228"></a><span id="l27.228"> case PR_RETURNED_IPM:</span>
<a href="#l27.229"></a><span id="l27.229" class="difflineminus">-  s = &quot;PR_RETURNED_IPM&quot;; break;</span>
<a href="#l27.230"></a><span id="l27.230" class="difflineplus">+  s = &quot;PR_RETURNED_IPM&quot;;</span>
<a href="#l27.231"></a><span id="l27.231" class="difflineplus">+  break;</span>
<a href="#l27.232"></a><span id="l27.232"> case PR_SECURITY:</span>
<a href="#l27.233"></a><span id="l27.233" class="difflineminus">-  s = &quot;PR_SECURITY&quot;; break;</span>
<a href="#l27.234"></a><span id="l27.234" class="difflineplus">+  s = &quot;PR_SECURITY&quot;;</span>
<a href="#l27.235"></a><span id="l27.235" class="difflineplus">+  break;</span>
<a href="#l27.236"></a><span id="l27.236"> case PR_INCOMPLETE_COPY:</span>
<a href="#l27.237"></a><span id="l27.237" class="difflineminus">-  s = &quot;PR_INCOMPLETE_COPY&quot;; break;</span>
<a href="#l27.238"></a><span id="l27.238" class="difflineplus">+  s = &quot;PR_INCOMPLETE_COPY&quot;;</span>
<a href="#l27.239"></a><span id="l27.239" class="difflineplus">+  break;</span>
<a href="#l27.240"></a><span id="l27.240"> case PR_SENSITIVITY:</span>
<a href="#l27.241"></a><span id="l27.241" class="difflineminus">-  s = &quot;PR_SENSITIVITY&quot;; break;</span>
<a href="#l27.242"></a><span id="l27.242" class="difflineplus">+  s = &quot;PR_SENSITIVITY&quot;;</span>
<a href="#l27.243"></a><span id="l27.243" class="difflineplus">+  break;</span>
<a href="#l27.244"></a><span id="l27.244"> case PR_SUBJECT:</span>
<a href="#l27.245"></a><span id="l27.245" class="difflineminus">-  s = &quot;PR_SUBJECT&quot;; break;</span>
<a href="#l27.246"></a><span id="l27.246" class="difflineplus">+  s = &quot;PR_SUBJECT&quot;;</span>
<a href="#l27.247"></a><span id="l27.247" class="difflineplus">+  break;</span>
<a href="#l27.248"></a><span id="l27.248"> case PR_SUBJECT_IPM:</span>
<a href="#l27.249"></a><span id="l27.249" class="difflineminus">-  s = &quot;PR_SUBJECT_IPM&quot;; break;</span>
<a href="#l27.250"></a><span id="l27.250" class="difflineplus">+  s = &quot;PR_SUBJECT_IPM&quot;;</span>
<a href="#l27.251"></a><span id="l27.251" class="difflineplus">+  break;</span>
<a href="#l27.252"></a><span id="l27.252"> case PR_CLIENT_SUBMIT_TIME:</span>
<a href="#l27.253"></a><span id="l27.253" class="difflineminus">-  s = &quot;PR_CLIENT_SUBMIT_TIME&quot;; break;</span>
<a href="#l27.254"></a><span id="l27.254" class="difflineplus">+  s = &quot;PR_CLIENT_SUBMIT_TIME&quot;;</span>
<a href="#l27.255"></a><span id="l27.255" class="difflineplus">+  break;</span>
<a href="#l27.256"></a><span id="l27.256"> case PR_REPORT_NAME:</span>
<a href="#l27.257"></a><span id="l27.257" class="difflineminus">-  s = &quot;PR_REPORT_NAME&quot;; break;</span>
<a href="#l27.258"></a><span id="l27.258" class="difflineplus">+  s = &quot;PR_REPORT_NAME&quot;;</span>
<a href="#l27.259"></a><span id="l27.259" class="difflineplus">+  break;</span>
<a href="#l27.260"></a><span id="l27.260"> case PR_SENT_REPRESENTING_SEARCH_KEY:</span>
<a href="#l27.261"></a><span id="l27.261" class="difflineminus">-  s = &quot;PR_SENT_REPRESENTING_SEARCH_KEY&quot;; break;</span>
<a href="#l27.262"></a><span id="l27.262" class="difflineplus">+  s = &quot;PR_SENT_REPRESENTING_SEARCH_KEY&quot;;</span>
<a href="#l27.263"></a><span id="l27.263" class="difflineplus">+  break;</span>
<a href="#l27.264"></a><span id="l27.264"> case PR_X400_CONTENT_TYPE:</span>
<a href="#l27.265"></a><span id="l27.265" class="difflineminus">-  s = &quot;PR_X400_CONTENT_TYPE&quot;; break;</span>
<a href="#l27.266"></a><span id="l27.266" class="difflineplus">+  s = &quot;PR_X400_CONTENT_TYPE&quot;;</span>
<a href="#l27.267"></a><span id="l27.267" class="difflineplus">+  break;</span>
<a href="#l27.268"></a><span id="l27.268"> case PR_SUBJECT_PREFIX:</span>
<a href="#l27.269"></a><span id="l27.269" class="difflineminus">-  s = &quot;PR_SUBJECT_PREFIX&quot;; break;</span>
<a href="#l27.270"></a><span id="l27.270" class="difflineplus">+  s = &quot;PR_SUBJECT_PREFIX&quot;;</span>
<a href="#l27.271"></a><span id="l27.271" class="difflineplus">+  break;</span>
<a href="#l27.272"></a><span id="l27.272"> case PR_NON_RECEIPT_REASON:</span>
<a href="#l27.273"></a><span id="l27.273" class="difflineminus">-  s = &quot;PR_NON_RECEIPT_REASON&quot;; break;</span>
<a href="#l27.274"></a><span id="l27.274" class="difflineplus">+  s = &quot;PR_NON_RECEIPT_REASON&quot;;</span>
<a href="#l27.275"></a><span id="l27.275" class="difflineplus">+  break;</span>
<a href="#l27.276"></a><span id="l27.276"> case PR_RECEIVED_BY_ENTRYID:</span>
<a href="#l27.277"></a><span id="l27.277" class="difflineminus">-  s = &quot;PR_RECEIVED_BY_ENTRYID&quot;; break;</span>
<a href="#l27.278"></a><span id="l27.278" class="difflineplus">+  s = &quot;PR_RECEIVED_BY_ENTRYID&quot;;</span>
<a href="#l27.279"></a><span id="l27.279" class="difflineplus">+  break;</span>
<a href="#l27.280"></a><span id="l27.280"> case PR_RECEIVED_BY_NAME:</span>
<a href="#l27.281"></a><span id="l27.281" class="difflineminus">-  s = &quot;PR_RECEIVED_BY_NAME&quot;; break;</span>
<a href="#l27.282"></a><span id="l27.282" class="difflineplus">+  s = &quot;PR_RECEIVED_BY_NAME&quot;;</span>
<a href="#l27.283"></a><span id="l27.283" class="difflineplus">+  break;</span>
<a href="#l27.284"></a><span id="l27.284"> case PR_SENT_REPRESENTING_ENTRYID:</span>
<a href="#l27.285"></a><span id="l27.285" class="difflineminus">-  s = &quot;PR_SENT_REPRESENTING_ENTRYID&quot;; break;</span>
<a href="#l27.286"></a><span id="l27.286" class="difflineplus">+  s = &quot;PR_SENT_REPRESENTING_ENTRYID&quot;;</span>
<a href="#l27.287"></a><span id="l27.287" class="difflineplus">+  break;</span>
<a href="#l27.288"></a><span id="l27.288"> case PR_SENT_REPRESENTING_NAME:</span>
<a href="#l27.289"></a><span id="l27.289" class="difflineminus">-  s = &quot;PR_SENT_REPRESENTING_NAME&quot;; break;</span>
<a href="#l27.290"></a><span id="l27.290" class="difflineplus">+  s = &quot;PR_SENT_REPRESENTING_NAME&quot;;</span>
<a href="#l27.291"></a><span id="l27.291" class="difflineplus">+  break;</span>
<a href="#l27.292"></a><span id="l27.292"> case PR_RCVD_REPRESENTING_ENTRYID:</span>
<a href="#l27.293"></a><span id="l27.293" class="difflineminus">-  s = &quot;PR_RCVD_REPRESENTING_ENTRYID&quot;; break;</span>
<a href="#l27.294"></a><span id="l27.294" class="difflineplus">+  s = &quot;PR_RCVD_REPRESENTING_ENTRYID&quot;;</span>
<a href="#l27.295"></a><span id="l27.295" class="difflineplus">+  break;</span>
<a href="#l27.296"></a><span id="l27.296"> case PR_RCVD_REPRESENTING_NAME:</span>
<a href="#l27.297"></a><span id="l27.297" class="difflineminus">-  s = &quot;PR_RCVD_REPRESENTING_NAME&quot;; break;</span>
<a href="#l27.298"></a><span id="l27.298" class="difflineplus">+  s = &quot;PR_RCVD_REPRESENTING_NAME&quot;;</span>
<a href="#l27.299"></a><span id="l27.299" class="difflineplus">+  break;</span>
<a href="#l27.300"></a><span id="l27.300"> case PR_REPORT_ENTRYID:</span>
<a href="#l27.301"></a><span id="l27.301" class="difflineminus">-  s = &quot;PR_REPORT_ENTRYID&quot;; break;</span>
<a href="#l27.302"></a><span id="l27.302" class="difflineplus">+  s = &quot;PR_REPORT_ENTRYID&quot;;</span>
<a href="#l27.303"></a><span id="l27.303" class="difflineplus">+  break;</span>
<a href="#l27.304"></a><span id="l27.304"> case PR_READ_RECEIPT_ENTRYID:</span>
<a href="#l27.305"></a><span id="l27.305" class="difflineminus">-  s = &quot;PR_READ_RECEIPT_ENTRYID&quot;; break;</span>
<a href="#l27.306"></a><span id="l27.306" class="difflineplus">+  s = &quot;PR_READ_RECEIPT_ENTRYID&quot;;</span>
<a href="#l27.307"></a><span id="l27.307" class="difflineplus">+  break;</span>
<a href="#l27.308"></a><span id="l27.308"> case PR_MESSAGE_SUBMISSION_ID:</span>
<a href="#l27.309"></a><span id="l27.309" class="difflineminus">-  s = &quot;PR_MESSAGE_SUBMISSION_ID&quot;; break;</span>
<a href="#l27.310"></a><span id="l27.310" class="difflineplus">+  s = &quot;PR_MESSAGE_SUBMISSION_ID&quot;;</span>
<a href="#l27.311"></a><span id="l27.311" class="difflineplus">+  break;</span>
<a href="#l27.312"></a><span id="l27.312"> case PR_PROVIDER_SUBMIT_TIME:</span>
<a href="#l27.313"></a><span id="l27.313" class="difflineminus">-  s = &quot;PR_PROVIDER_SUBMIT_TIME&quot;; break;</span>
<a href="#l27.314"></a><span id="l27.314" class="difflineplus">+  s = &quot;PR_PROVIDER_SUBMIT_TIME&quot;;</span>
<a href="#l27.315"></a><span id="l27.315" class="difflineplus">+  break;</span>
<a href="#l27.316"></a><span id="l27.316"> case PR_ORIGINAL_SUBJECT:</span>
<a href="#l27.317"></a><span id="l27.317" class="difflineminus">-  s = &quot;PR_ORIGINAL_SUBJECT&quot;; break;</span>
<a href="#l27.318"></a><span id="l27.318" class="difflineplus">+  s = &quot;PR_ORIGINAL_SUBJECT&quot;;</span>
<a href="#l27.319"></a><span id="l27.319" class="difflineplus">+  break;</span>
<a href="#l27.320"></a><span id="l27.320"> case PR_DISC_VAL:</span>
<a href="#l27.321"></a><span id="l27.321" class="difflineminus">-  s = &quot;PR_DISC_VAL&quot;; break;</span>
<a href="#l27.322"></a><span id="l27.322" class="difflineplus">+  s = &quot;PR_DISC_VAL&quot;;</span>
<a href="#l27.323"></a><span id="l27.323" class="difflineplus">+  break;</span>
<a href="#l27.324"></a><span id="l27.324"> case PR_ORIG_MESSAGE_CLASS:</span>
<a href="#l27.325"></a><span id="l27.325" class="difflineminus">-  s = &quot;PR_ORIG_MESSAGE_CLASS&quot;; break;</span>
<a href="#l27.326"></a><span id="l27.326" class="difflineplus">+  s = &quot;PR_ORIG_MESSAGE_CLASS&quot;;</span>
<a href="#l27.327"></a><span id="l27.327" class="difflineplus">+  break;</span>
<a href="#l27.328"></a><span id="l27.328"> case PR_ORIGINAL_AUTHOR_ENTRYID:</span>
<a href="#l27.329"></a><span id="l27.329" class="difflineminus">-  s = &quot;PR_ORIGINAL_AUTHOR_ENTRYID&quot;; break;</span>
<a href="#l27.330"></a><span id="l27.330" class="difflineplus">+  s = &quot;PR_ORIGINAL_AUTHOR_ENTRYID&quot;;</span>
<a href="#l27.331"></a><span id="l27.331" class="difflineplus">+  break;</span>
<a href="#l27.332"></a><span id="l27.332"> case PR_ORIGINAL_AUTHOR_NAME:</span>
<a href="#l27.333"></a><span id="l27.333" class="difflineminus">-  s = &quot;PR_ORIGINAL_AUTHOR_NAME&quot;; break;</span>
<a href="#l27.334"></a><span id="l27.334" class="difflineplus">+  s = &quot;PR_ORIGINAL_AUTHOR_NAME&quot;;</span>
<a href="#l27.335"></a><span id="l27.335" class="difflineplus">+  break;</span>
<a href="#l27.336"></a><span id="l27.336"> case PR_ORIGINAL_SUBMIT_TIME:</span>
<a href="#l27.337"></a><span id="l27.337" class="difflineminus">-  s = &quot;PR_ORIGINAL_SUBMIT_TIME&quot;; break;</span>
<a href="#l27.338"></a><span id="l27.338" class="difflineplus">+  s = &quot;PR_ORIGINAL_SUBMIT_TIME&quot;;</span>
<a href="#l27.339"></a><span id="l27.339" class="difflineplus">+  break;</span>
<a href="#l27.340"></a><span id="l27.340"> case PR_REPLY_RECIPIENT_ENTRIES:</span>
<a href="#l27.341"></a><span id="l27.341" class="difflineminus">-  s = &quot;PR_REPLY_RECIPIENT_ENTRIES&quot;; break;</span>
<a href="#l27.342"></a><span id="l27.342" class="difflineplus">+  s = &quot;PR_REPLY_RECIPIENT_ENTRIES&quot;;</span>
<a href="#l27.343"></a><span id="l27.343" class="difflineplus">+  break;</span>
<a href="#l27.344"></a><span id="l27.344"> case PR_REPLY_RECIPIENT_NAMES:</span>
<a href="#l27.345"></a><span id="l27.345" class="difflineminus">-  s = &quot;PR_REPLY_RECIPIENT_NAMES&quot;; break;</span>
<a href="#l27.346"></a><span id="l27.346" class="difflineplus">+  s = &quot;PR_REPLY_RECIPIENT_NAMES&quot;;</span>
<a href="#l27.347"></a><span id="l27.347" class="difflineplus">+  break;</span>
<a href="#l27.348"></a><span id="l27.348"> </span>
<a href="#l27.349"></a><span id="l27.349"> case PR_RECEIVED_BY_SEARCH_KEY:</span>
<a href="#l27.350"></a><span id="l27.350" class="difflineminus">-  s = &quot;PR_RECEIVED_BY_SEARCH_KEY&quot;; break;</span>
<a href="#l27.351"></a><span id="l27.351" class="difflineplus">+  s = &quot;PR_RECEIVED_BY_SEARCH_KEY&quot;;</span>
<a href="#l27.352"></a><span id="l27.352" class="difflineplus">+  break;</span>
<a href="#l27.353"></a><span id="l27.353"> case PR_RCVD_REPRESENTING_SEARCH_KEY:</span>
<a href="#l27.354"></a><span id="l27.354" class="difflineminus">-  s = &quot;PR_RCVD_REPRESENTING_SEARCH_KEY&quot;; break;</span>
<a href="#l27.355"></a><span id="l27.355" class="difflineplus">+  s = &quot;PR_RCVD_REPRESENTING_SEARCH_KEY&quot;;</span>
<a href="#l27.356"></a><span id="l27.356" class="difflineplus">+  break;</span>
<a href="#l27.357"></a><span id="l27.357"> case PR_READ_RECEIPT_SEARCH_KEY:</span>
<a href="#l27.358"></a><span id="l27.358" class="difflineminus">-  s = &quot;PR_READ_RECEIPT_SEARCH_KEY&quot;; break;</span>
<a href="#l27.359"></a><span id="l27.359" class="difflineplus">+  s = &quot;PR_READ_RECEIPT_SEARCH_KEY&quot;;</span>
<a href="#l27.360"></a><span id="l27.360" class="difflineplus">+  break;</span>
<a href="#l27.361"></a><span id="l27.361"> case PR_REPORT_SEARCH_KEY:</span>
<a href="#l27.362"></a><span id="l27.362" class="difflineminus">-  s = &quot;PR_REPORT_SEARCH_KEY&quot;; break;</span>
<a href="#l27.363"></a><span id="l27.363" class="difflineplus">+  s = &quot;PR_REPORT_SEARCH_KEY&quot;;</span>
<a href="#l27.364"></a><span id="l27.364" class="difflineplus">+  break;</span>
<a href="#l27.365"></a><span id="l27.365"> case PR_ORIGINAL_DELIVERY_TIME:</span>
<a href="#l27.366"></a><span id="l27.366" class="difflineminus">-  s = &quot;PR_ORIGINAL_DELIVERY_TIME&quot;; break;</span>
<a href="#l27.367"></a><span id="l27.367" class="difflineplus">+  s = &quot;PR_ORIGINAL_DELIVERY_TIME&quot;;</span>
<a href="#l27.368"></a><span id="l27.368" class="difflineplus">+  break;</span>
<a href="#l27.369"></a><span id="l27.369"> case PR_ORIGINAL_AUTHOR_SEARCH_KEY:</span>
<a href="#l27.370"></a><span id="l27.370" class="difflineminus">-  s = &quot;PR_ORIGINAL_AUTHOR_SEARCH_KEY&quot;; break;</span>
<a href="#l27.371"></a><span id="l27.371" class="difflineplus">+  s = &quot;PR_ORIGINAL_AUTHOR_SEARCH_KEY&quot;;</span>
<a href="#l27.372"></a><span id="l27.372" class="difflineplus">+  break;</span>
<a href="#l27.373"></a><span id="l27.373"> </span>
<a href="#l27.374"></a><span id="l27.374"> case PR_MESSAGE_TO_ME:</span>
<a href="#l27.375"></a><span id="l27.375" class="difflineminus">-  s = &quot;PR_MESSAGE_TO_ME&quot;; break;</span>
<a href="#l27.376"></a><span id="l27.376" class="difflineplus">+  s = &quot;PR_MESSAGE_TO_ME&quot;;</span>
<a href="#l27.377"></a><span id="l27.377" class="difflineplus">+  break;</span>
<a href="#l27.378"></a><span id="l27.378"> case PR_MESSAGE_CC_ME:</span>
<a href="#l27.379"></a><span id="l27.379" class="difflineminus">-  s = &quot;PR_MESSAGE_CC_ME&quot;; break;</span>
<a href="#l27.380"></a><span id="l27.380" class="difflineplus">+  s = &quot;PR_MESSAGE_CC_ME&quot;;</span>
<a href="#l27.381"></a><span id="l27.381" class="difflineplus">+  break;</span>
<a href="#l27.382"></a><span id="l27.382"> case PR_MESSAGE_RECIP_ME:</span>
<a href="#l27.383"></a><span id="l27.383" class="difflineminus">-  s = &quot;PR_MESSAGE_RECIP_ME&quot;; break;</span>
<a href="#l27.384"></a><span id="l27.384" class="difflineplus">+  s = &quot;PR_MESSAGE_RECIP_ME&quot;;</span>
<a href="#l27.385"></a><span id="l27.385" class="difflineplus">+  break;</span>
<a href="#l27.386"></a><span id="l27.386"> </span>
<a href="#l27.387"></a><span id="l27.387"> case PR_ORIGINAL_SENDER_NAME:</span>
<a href="#l27.388"></a><span id="l27.388" class="difflineminus">-  s = &quot;PR_ORIGINAL_SENDER_NAME&quot;; break;</span>
<a href="#l27.389"></a><span id="l27.389" class="difflineplus">+  s = &quot;PR_ORIGINAL_SENDER_NAME&quot;;</span>
<a href="#l27.390"></a><span id="l27.390" class="difflineplus">+  break;</span>
<a href="#l27.391"></a><span id="l27.391"> case PR_ORIGINAL_SENDER_ENTRYID:</span>
<a href="#l27.392"></a><span id="l27.392" class="difflineminus">-  s = &quot;PR_ORIGINAL_SENDER_ENTRYID&quot;; break;</span>
<a href="#l27.393"></a><span id="l27.393" class="difflineplus">+  s = &quot;PR_ORIGINAL_SENDER_ENTRYID&quot;;</span>
<a href="#l27.394"></a><span id="l27.394" class="difflineplus">+  break;</span>
<a href="#l27.395"></a><span id="l27.395"> case PR_ORIGINAL_SENDER_SEARCH_KEY:</span>
<a href="#l27.396"></a><span id="l27.396" class="difflineminus">-  s = &quot;PR_ORIGINAL_SENDER_SEARCH_KEY&quot;; break;</span>
<a href="#l27.397"></a><span id="l27.397" class="difflineplus">+  s = &quot;PR_ORIGINAL_SENDER_SEARCH_KEY&quot;;</span>
<a href="#l27.398"></a><span id="l27.398" class="difflineplus">+  break;</span>
<a href="#l27.399"></a><span id="l27.399"> case PR_ORIGINAL_SENT_REPRESENTING_NAME:</span>
<a href="#l27.400"></a><span id="l27.400" class="difflineminus">-  s = &quot;PR_ORIGINAL_SENT_REPRESENTING_NAME&quot;; break;</span>
<a href="#l27.401"></a><span id="l27.401" class="difflineplus">+  s = &quot;PR_ORIGINAL_SENT_REPRESENTING_NAME&quot;;</span>
<a href="#l27.402"></a><span id="l27.402" class="difflineplus">+  break;</span>
<a href="#l27.403"></a><span id="l27.403"> case PR_ORIGINAL_SENT_REPRESENTING_ENTRYID:</span>
<a href="#l27.404"></a><span id="l27.404" class="difflineminus">-  s = &quot;PR_ORIGINAL_SENT_REPRESENTING_ENTRYID&quot;; break;</span>
<a href="#l27.405"></a><span id="l27.405" class="difflineplus">+  s = &quot;PR_ORIGINAL_SENT_REPRESENTING_ENTRYID&quot;;</span>
<a href="#l27.406"></a><span id="l27.406" class="difflineplus">+  break;</span>
<a href="#l27.407"></a><span id="l27.407"> case PR_ORIGINAL_SENT_REPRESENTING_SEARCH_KEY:</span>
<a href="#l27.408"></a><span id="l27.408" class="difflineminus">-  s = &quot;PR_ORIGINAL_SENT_REPRESENTING_SEARCH_KEY&quot;; break;</span>
<a href="#l27.409"></a><span id="l27.409" class="difflineplus">+  s = &quot;PR_ORIGINAL_SENT_REPRESENTING_SEARCH_KEY&quot;;</span>
<a href="#l27.410"></a><span id="l27.410" class="difflineplus">+  break;</span>
<a href="#l27.411"></a><span id="l27.411"> </span>
<a href="#l27.412"></a><span id="l27.412"> case PR_START_DATE:</span>
<a href="#l27.413"></a><span id="l27.413" class="difflineminus">-  s = &quot;PR_START_DATE&quot;; break;</span>
<a href="#l27.414"></a><span id="l27.414" class="difflineplus">+  s = &quot;PR_START_DATE&quot;;</span>
<a href="#l27.415"></a><span id="l27.415" class="difflineplus">+  break;</span>
<a href="#l27.416"></a><span id="l27.416"> case PR_END_DATE:</span>
<a href="#l27.417"></a><span id="l27.417" class="difflineminus">-  s = &quot;PR_END_DATE&quot;; break;</span>
<a href="#l27.418"></a><span id="l27.418" class="difflineplus">+  s = &quot;PR_END_DATE&quot;;</span>
<a href="#l27.419"></a><span id="l27.419" class="difflineplus">+  break;</span>
<a href="#l27.420"></a><span id="l27.420"> case PR_OWNER_APPT_ID:</span>
<a href="#l27.421"></a><span id="l27.421" class="difflineminus">-  s = &quot;PR_OWNER_APPT_ID&quot;; break;</span>
<a href="#l27.422"></a><span id="l27.422" class="difflineplus">+  s = &quot;PR_OWNER_APPT_ID&quot;;</span>
<a href="#l27.423"></a><span id="l27.423" class="difflineplus">+  break;</span>
<a href="#l27.424"></a><span id="l27.424"> case PR_RESPONSE_REQUESTED:</span>
<a href="#l27.425"></a><span id="l27.425" class="difflineminus">-  s = &quot;PR_RESPONSE_REQUESTED&quot;; break;</span>
<a href="#l27.426"></a><span id="l27.426" class="difflineplus">+  s = &quot;PR_RESPONSE_REQUESTED&quot;;</span>
<a href="#l27.427"></a><span id="l27.427" class="difflineplus">+  break;</span>
<a href="#l27.428"></a><span id="l27.428"> </span>
<a href="#l27.429"></a><span id="l27.429"> case PR_SENT_REPRESENTING_ADDRTYPE:</span>
<a href="#l27.430"></a><span id="l27.430" class="difflineminus">-  s = &quot;PR_SENT_REPRESENTING_ADDRTYPE&quot;; break;</span>
<a href="#l27.431"></a><span id="l27.431" class="difflineplus">+  s = &quot;PR_SENT_REPRESENTING_ADDRTYPE&quot;;</span>
<a href="#l27.432"></a><span id="l27.432" class="difflineplus">+  break;</span>
<a href="#l27.433"></a><span id="l27.433"> case PR_SENT_REPRESENTING_EMAIL_ADDRESS:</span>
<a href="#l27.434"></a><span id="l27.434" class="difflineminus">-  s = &quot;PR_SENT_REPRESENTING_EMAIL_ADDRESS&quot;; break;</span>
<a href="#l27.435"></a><span id="l27.435" class="difflineplus">+  s = &quot;PR_SENT_REPRESENTING_EMAIL_ADDRESS&quot;;</span>
<a href="#l27.436"></a><span id="l27.436" class="difflineplus">+  break;</span>
<a href="#l27.437"></a><span id="l27.437"> </span>
<a href="#l27.438"></a><span id="l27.438"> case PR_ORIGINAL_SENDER_ADDRTYPE:</span>
<a href="#l27.439"></a><span id="l27.439" class="difflineminus">-  s = &quot;PR_ORIGINAL_SENDER_ADDRTYPE&quot;; break;</span>
<a href="#l27.440"></a><span id="l27.440" class="difflineplus">+  s = &quot;PR_ORIGINAL_SENDER_ADDRTYPE&quot;;</span>
<a href="#l27.441"></a><span id="l27.441" class="difflineplus">+  break;</span>
<a href="#l27.442"></a><span id="l27.442"> case PR_ORIGINAL_SENDER_EMAIL_ADDRESS:</span>
<a href="#l27.443"></a><span id="l27.443" class="difflineminus">-  s = &quot;PR_ORIGINAL_SENDER_EMAIL_ADDRESS&quot;; break;</span>
<a href="#l27.444"></a><span id="l27.444" class="difflineplus">+  s = &quot;PR_ORIGINAL_SENDER_EMAIL_ADDRESS&quot;;</span>
<a href="#l27.445"></a><span id="l27.445" class="difflineplus">+  break;</span>
<a href="#l27.446"></a><span id="l27.446"> </span>
<a href="#l27.447"></a><span id="l27.447"> case PR_ORIGINAL_SENT_REPRESENTING_ADDRTYPE:</span>
<a href="#l27.448"></a><span id="l27.448" class="difflineminus">-  s = &quot;PR_ORIGINAL_SENT_REPRESENTING_ADDRTYPE&quot;; break;</span>
<a href="#l27.449"></a><span id="l27.449" class="difflineplus">+  s = &quot;PR_ORIGINAL_SENT_REPRESENTING_ADDRTYPE&quot;;</span>
<a href="#l27.450"></a><span id="l27.450" class="difflineplus">+  break;</span>
<a href="#l27.451"></a><span id="l27.451"> case PR_ORIGINAL_SENT_REPRESENTING_EMAIL_ADDRESS:</span>
<a href="#l27.452"></a><span id="l27.452" class="difflineminus">-  s = &quot;PR_ORIGINAL_SENT_REPRESENTING_EMAIL_ADDRESS&quot;; break;</span>
<a href="#l27.453"></a><span id="l27.453" class="difflineplus">+  s = &quot;PR_ORIGINAL_SENT_REPRESENTING_EMAIL_ADDRESS&quot;;</span>
<a href="#l27.454"></a><span id="l27.454" class="difflineplus">+  break;</span>
<a href="#l27.455"></a><span id="l27.455"> </span>
<a href="#l27.456"></a><span id="l27.456"> case PR_CONVERSATION_TOPIC:</span>
<a href="#l27.457"></a><span id="l27.457" class="difflineminus">-  s = &quot;PR_CONVERSATION_TOPIC&quot;; break;</span>
<a href="#l27.458"></a><span id="l27.458" class="difflineplus">+  s = &quot;PR_CONVERSATION_TOPIC&quot;;</span>
<a href="#l27.459"></a><span id="l27.459" class="difflineplus">+  break;</span>
<a href="#l27.460"></a><span id="l27.460"> case PR_CONVERSATION_INDEX:</span>
<a href="#l27.461"></a><span id="l27.461" class="difflineminus">-  s = &quot;PR_CONVERSATION_INDEX&quot;; break;</span>
<a href="#l27.462"></a><span id="l27.462" class="difflineplus">+  s = &quot;PR_CONVERSATION_INDEX&quot;;</span>
<a href="#l27.463"></a><span id="l27.463" class="difflineplus">+  break;</span>
<a href="#l27.464"></a><span id="l27.464"> </span>
<a href="#l27.465"></a><span id="l27.465"> case PR_ORIGINAL_DISPLAY_BCC:</span>
<a href="#l27.466"></a><span id="l27.466" class="difflineminus">-  s = &quot;PR_ORIGINAL_DISPLAY_BCC&quot;; break;</span>
<a href="#l27.467"></a><span id="l27.467" class="difflineplus">+  s = &quot;PR_ORIGINAL_DISPLAY_BCC&quot;;</span>
<a href="#l27.468"></a><span id="l27.468" class="difflineplus">+  break;</span>
<a href="#l27.469"></a><span id="l27.469"> case PR_ORIGINAL_DISPLAY_CC:</span>
<a href="#l27.470"></a><span id="l27.470" class="difflineminus">-  s = &quot;PR_ORIGINAL_DISPLAY_CC&quot;; break;</span>
<a href="#l27.471"></a><span id="l27.471" class="difflineplus">+  s = &quot;PR_ORIGINAL_DISPLAY_CC&quot;;</span>
<a href="#l27.472"></a><span id="l27.472" class="difflineplus">+  break;</span>
<a href="#l27.473"></a><span id="l27.473"> case PR_ORIGINAL_DISPLAY_TO:</span>
<a href="#l27.474"></a><span id="l27.474" class="difflineminus">-  s = &quot;PR_ORIGINAL_DISPLAY_TO&quot;; break;</span>
<a href="#l27.475"></a><span id="l27.475" class="difflineplus">+  s = &quot;PR_ORIGINAL_DISPLAY_TO&quot;;</span>
<a href="#l27.476"></a><span id="l27.476" class="difflineplus">+  break;</span>
<a href="#l27.477"></a><span id="l27.477"> </span>
<a href="#l27.478"></a><span id="l27.478"> case PR_RECEIVED_BY_ADDRTYPE:</span>
<a href="#l27.479"></a><span id="l27.479" class="difflineminus">-  s = &quot;PR_RECEIVED_BY_ADDRTYPE&quot;; break;</span>
<a href="#l27.480"></a><span id="l27.480" class="difflineplus">+  s = &quot;PR_RECEIVED_BY_ADDRTYPE&quot;;</span>
<a href="#l27.481"></a><span id="l27.481" class="difflineplus">+  break;</span>
<a href="#l27.482"></a><span id="l27.482"> case PR_RECEIVED_BY_EMAIL_ADDRESS:</span>
<a href="#l27.483"></a><span id="l27.483" class="difflineminus">-  s = &quot;PR_RECEIVED_BY_EMAIL_ADDRESS&quot;; break;</span>
<a href="#l27.484"></a><span id="l27.484" class="difflineplus">+  s = &quot;PR_RECEIVED_BY_EMAIL_ADDRESS&quot;;</span>
<a href="#l27.485"></a><span id="l27.485" class="difflineplus">+  break;</span>
<a href="#l27.486"></a><span id="l27.486"> </span>
<a href="#l27.487"></a><span id="l27.487"> case PR_RCVD_REPRESENTING_ADDRTYPE:</span>
<a href="#l27.488"></a><span id="l27.488" class="difflineminus">-  s = &quot;PR_RCVD_REPRESENTING_ADDRTYPE&quot;; break;</span>
<a href="#l27.489"></a><span id="l27.489" class="difflineplus">+  s = &quot;PR_RCVD_REPRESENTING_ADDRTYPE&quot;;</span>
<a href="#l27.490"></a><span id="l27.490" class="difflineplus">+  break;</span>
<a href="#l27.491"></a><span id="l27.491"> case PR_RCVD_REPRESENTING_EMAIL_ADDRESS:</span>
<a href="#l27.492"></a><span id="l27.492" class="difflineminus">-  s = &quot;PR_RCVD_REPRESENTING_EMAIL_ADDRESS&quot;; break;</span>
<a href="#l27.493"></a><span id="l27.493" class="difflineplus">+  s = &quot;PR_RCVD_REPRESENTING_EMAIL_ADDRESS&quot;;</span>
<a href="#l27.494"></a><span id="l27.494" class="difflineplus">+  break;</span>
<a href="#l27.495"></a><span id="l27.495"> </span>
<a href="#l27.496"></a><span id="l27.496"> case PR_ORIGINAL_AUTHOR_ADDRTYPE:</span>
<a href="#l27.497"></a><span id="l27.497" class="difflineminus">-  s = &quot;PR_ORIGINAL_AUTHOR_ADDRTYPE&quot;; break;</span>
<a href="#l27.498"></a><span id="l27.498" class="difflineplus">+  s = &quot;PR_ORIGINAL_AUTHOR_ADDRTYPE&quot;;</span>
<a href="#l27.499"></a><span id="l27.499" class="difflineplus">+  break;</span>
<a href="#l27.500"></a><span id="l27.500"> case PR_ORIGINAL_AUTHOR_EMAIL_ADDRESS:</span>
<a href="#l27.501"></a><span id="l27.501" class="difflineminus">-  s = &quot;PR_ORIGINAL_AUTHOR_EMAIL_ADDRESS&quot;; break;</span>
<a href="#l27.502"></a><span id="l27.502" class="difflineplus">+  s = &quot;PR_ORIGINAL_AUTHOR_EMAIL_ADDRESS&quot;;</span>
<a href="#l27.503"></a><span id="l27.503" class="difflineplus">+  break;</span>
<a href="#l27.504"></a><span id="l27.504"> </span>
<a href="#l27.505"></a><span id="l27.505"> case PR_ORIGINALLY_INTENDED_RECIP_ADDRTYPE:</span>
<a href="#l27.506"></a><span id="l27.506" class="difflineminus">-  s = &quot;PR_ORIGINALLY_INTENDED_RECIP_ADDRTYPE&quot;; break;</span>
<a href="#l27.507"></a><span id="l27.507" class="difflineplus">+  s = &quot;PR_ORIGINALLY_INTENDED_RECIP_ADDRTYPE&quot;;</span>
<a href="#l27.508"></a><span id="l27.508" class="difflineplus">+  break;</span>
<a href="#l27.509"></a><span id="l27.509"> case PR_ORIGINALLY_INTENDED_RECIP_EMAIL_ADDRESS:</span>
<a href="#l27.510"></a><span id="l27.510" class="difflineminus">-  s = &quot;PR_ORIGINALLY_INTENDED_RECIP_EMAIL_ADDRESS&quot;; break;</span>
<a href="#l27.511"></a><span id="l27.511" class="difflineplus">+  s = &quot;PR_ORIGINALLY_INTENDED_RECIP_EMAIL_ADDRESS&quot;;</span>
<a href="#l27.512"></a><span id="l27.512" class="difflineplus">+  break;</span>
<a href="#l27.513"></a><span id="l27.513"> </span>
<a href="#l27.514"></a><span id="l27.514"> case PR_TRANSPORT_MESSAGE_HEADERS:</span>
<a href="#l27.515"></a><span id="l27.515" class="difflineminus">-  s = &quot;PR_TRANSPORT_MESSAGE_HEADERS&quot;; break;</span>
<a href="#l27.516"></a><span id="l27.516" class="difflineplus">+  s = &quot;PR_TRANSPORT_MESSAGE_HEADERS&quot;;</span>
<a href="#l27.517"></a><span id="l27.517" class="difflineplus">+  break;</span>
<a href="#l27.518"></a><span id="l27.518"> </span>
<a href="#l27.519"></a><span id="l27.519"> case PR_DELEGATION:</span>
<a href="#l27.520"></a><span id="l27.520" class="difflineminus">-  s = &quot;PR_DELEGATION&quot;; break;</span>
<a href="#l27.521"></a><span id="l27.521" class="difflineplus">+  s = &quot;PR_DELEGATION&quot;;</span>
<a href="#l27.522"></a><span id="l27.522" class="difflineplus">+  break;</span>
<a href="#l27.523"></a><span id="l27.523"> </span>
<a href="#l27.524"></a><span id="l27.524"> case PR_TNEF_CORRELATION_KEY:</span>
<a href="#l27.525"></a><span id="l27.525" class="difflineminus">-  s = &quot;PR_TNEF_CORRELATION_KEY&quot;; break;</span>
<a href="#l27.526"></a><span id="l27.526" class="difflineminus">-</span>
<a href="#l27.527"></a><span id="l27.527" class="difflineminus">-</span>
<a href="#l27.528"></a><span id="l27.528" class="difflineplus">+  s = &quot;PR_TNEF_CORRELATION_KEY&quot;;</span>
<a href="#l27.529"></a><span id="l27.529" class="difflineplus">+  break;</span>
<a href="#l27.530"></a><span id="l27.530"> </span>
<a href="#l27.531"></a><span id="l27.531" class="difflineminus">-/*</span>
<a href="#l27.532"></a><span id="l27.532" class="difflineminus">- *  Message content properties</span>
<a href="#l27.533"></a><span id="l27.533" class="difflineminus">- */</span>
<a href="#l27.534"></a><span id="l27.534" class="difflineplus">+  /*</span>
<a href="#l27.535"></a><span id="l27.535" class="difflineplus">+   *  Message content properties</span>
<a href="#l27.536"></a><span id="l27.536" class="difflineplus">+   */</span>
<a href="#l27.537"></a><span id="l27.537"> </span>
<a href="#l27.538"></a><span id="l27.538"> case PR_BODY:</span>
<a href="#l27.539"></a><span id="l27.539" class="difflineminus">-  s = &quot;PR_BODY&quot;; break;</span>
<a href="#l27.540"></a><span id="l27.540" class="difflineplus">+  s = &quot;PR_BODY&quot;;</span>
<a href="#l27.541"></a><span id="l27.541" class="difflineplus">+  break;</span>
<a href="#l27.542"></a><span id="l27.542"> case PR_REPORT_TEXT:</span>
<a href="#l27.543"></a><span id="l27.543" class="difflineminus">-  s = &quot;PR_REPORT_TEXT&quot;; break;</span>
<a href="#l27.544"></a><span id="l27.544" class="difflineplus">+  s = &quot;PR_REPORT_TEXT&quot;;</span>
<a href="#l27.545"></a><span id="l27.545" class="difflineplus">+  break;</span>
<a href="#l27.546"></a><span id="l27.546"> case PR_ORIGINATOR_AND_DL_EXPANSION_HISTORY:</span>
<a href="#l27.547"></a><span id="l27.547" class="difflineminus">-  s = &quot;PR_ORIGINATOR_AND_DL_EXPANSION_HISTORY&quot;; break;</span>
<a href="#l27.548"></a><span id="l27.548" class="difflineplus">+  s = &quot;PR_ORIGINATOR_AND_DL_EXPANSION_HISTORY&quot;;</span>
<a href="#l27.549"></a><span id="l27.549" class="difflineplus">+  break;</span>
<a href="#l27.550"></a><span id="l27.550"> case PR_REPORTING_DL_NAME:</span>
<a href="#l27.551"></a><span id="l27.551" class="difflineminus">-  s = &quot;PR_REPORTING_DL_NAME&quot;; break;</span>
<a href="#l27.552"></a><span id="l27.552" class="difflineplus">+  s = &quot;PR_REPORTING_DL_NAME&quot;;</span>
<a href="#l27.553"></a><span id="l27.553" class="difflineplus">+  break;</span>
<a href="#l27.554"></a><span id="l27.554"> case PR_REPORTING_MTA_CERTIFICATE:</span>
<a href="#l27.555"></a><span id="l27.555" class="difflineminus">-  s = &quot;PR_REPORTING_MTA_CERTIFICATE&quot;; break;</span>
<a href="#l27.556"></a><span id="l27.556" class="difflineplus">+  s = &quot;PR_REPORTING_MTA_CERTIFICATE&quot;;</span>
<a href="#l27.557"></a><span id="l27.557" class="difflineplus">+  break;</span>
<a href="#l27.558"></a><span id="l27.558"> </span>
<a href="#l27.559"></a><span id="l27.559" class="difflineminus">-/*  Removed PR_REPORT_ORIGIN_AUTHENTICATION_CHECK with DCR 3865, use PR_ORIGIN_CHECK */</span>
<a href="#l27.560"></a><span id="l27.560" class="difflineplus">+  /*  Removed PR_REPORT_ORIGIN_AUTHENTICATION_CHECK with DCR 3865, use</span>
<a href="#l27.561"></a><span id="l27.561" class="difflineplus">+   * PR_ORIGIN_CHECK */</span>
<a href="#l27.562"></a><span id="l27.562"> </span>
<a href="#l27.563"></a><span id="l27.563"> case PR_RTF_SYNC_BODY_CRC:</span>
<a href="#l27.564"></a><span id="l27.564" class="difflineminus">-  s = &quot;PR_RTF_SYNC_BODY_CRC&quot;; break;</span>
<a href="#l27.565"></a><span id="l27.565" class="difflineplus">+  s = &quot;PR_RTF_SYNC_BODY_CRC&quot;;</span>
<a href="#l27.566"></a><span id="l27.566" class="difflineplus">+  break;</span>
<a href="#l27.567"></a><span id="l27.567"> case PR_RTF_SYNC_BODY_COUNT:</span>
<a href="#l27.568"></a><span id="l27.568" class="difflineminus">-  s = &quot;PR_RTF_SYNC_BODY_COUNT&quot;; break;</span>
<a href="#l27.569"></a><span id="l27.569" class="difflineplus">+  s = &quot;PR_RTF_SYNC_BODY_COUNT&quot;;</span>
<a href="#l27.570"></a><span id="l27.570" class="difflineplus">+  break;</span>
<a href="#l27.571"></a><span id="l27.571"> case PR_RTF_SYNC_BODY_TAG:</span>
<a href="#l27.572"></a><span id="l27.572" class="difflineminus">-  s = &quot;PR_RTF_SYNC_BODY_TAG&quot;; break;</span>
<a href="#l27.573"></a><span id="l27.573" class="difflineplus">+  s = &quot;PR_RTF_SYNC_BODY_TAG&quot;;</span>
<a href="#l27.574"></a><span id="l27.574" class="difflineplus">+  break;</span>
<a href="#l27.575"></a><span id="l27.575"> case PR_RTF_COMPRESSED:</span>
<a href="#l27.576"></a><span id="l27.576" class="difflineminus">-  s = &quot;PR_RTF_COMPRESSED&quot;; break;</span>
<a href="#l27.577"></a><span id="l27.577" class="difflineplus">+  s = &quot;PR_RTF_COMPRESSED&quot;;</span>
<a href="#l27.578"></a><span id="l27.578" class="difflineplus">+  break;</span>
<a href="#l27.579"></a><span id="l27.579"> case PR_RTF_SYNC_PREFIX_COUNT:</span>
<a href="#l27.580"></a><span id="l27.580" class="difflineminus">-  s = &quot;PR_RTF_SYNC_PREFIX_COUNT&quot;; break;</span>
<a href="#l27.581"></a><span id="l27.581" class="difflineplus">+  s = &quot;PR_RTF_SYNC_PREFIX_COUNT&quot;;</span>
<a href="#l27.582"></a><span id="l27.582" class="difflineplus">+  break;</span>
<a href="#l27.583"></a><span id="l27.583"> case PR_RTF_SYNC_TRAILING_COUNT:</span>
<a href="#l27.584"></a><span id="l27.584" class="difflineminus">-  s = &quot;PR_RTF_SYNC_TRAILING_COUNT&quot;; break;</span>
<a href="#l27.585"></a><span id="l27.585" class="difflineplus">+  s = &quot;PR_RTF_SYNC_TRAILING_COUNT&quot;;</span>
<a href="#l27.586"></a><span id="l27.586" class="difflineplus">+  break;</span>
<a href="#l27.587"></a><span id="l27.587"> case PR_ORIGINALLY_INTENDED_RECIP_ENTRYID:</span>
<a href="#l27.588"></a><span id="l27.588" class="difflineminus">-  s = &quot;PR_ORIGINALLY_INTENDED_RECIP_ENTRYID&quot;; break;</span>
<a href="#l27.589"></a><span id="l27.589" class="difflineplus">+  s = &quot;PR_ORIGINALLY_INTENDED_RECIP_ENTRYID&quot;;</span>
<a href="#l27.590"></a><span id="l27.590" class="difflineplus">+  break;</span>
<a href="#l27.591"></a><span id="l27.591"> </span>
<a href="#l27.592"></a><span id="l27.592" class="difflineminus">-/*</span>
<a href="#l27.593"></a><span id="l27.593" class="difflineminus">- *  Reserved 0x1100-0x1200</span>
<a href="#l27.594"></a><span id="l27.594" class="difflineminus">- */</span>
<a href="#l27.595"></a><span id="l27.595" class="difflineplus">+  /*</span>
<a href="#l27.596"></a><span id="l27.596" class="difflineplus">+   *  Reserved 0x1100-0x1200</span>
<a href="#l27.597"></a><span id="l27.597" class="difflineplus">+   */</span>
<a href="#l27.598"></a><span id="l27.598"> </span>
<a href="#l27.599"></a><span id="l27.599" class="difflineminus">-</span>
<a href="#l27.600"></a><span id="l27.600" class="difflineminus">-/*</span>
<a href="#l27.601"></a><span id="l27.601" class="difflineminus">- *  Message recipient properties</span>
<a href="#l27.602"></a><span id="l27.602" class="difflineminus">- */</span>
<a href="#l27.603"></a><span id="l27.603" class="difflineplus">+  /*</span>
<a href="#l27.604"></a><span id="l27.604" class="difflineplus">+   *  Message recipient properties</span>
<a href="#l27.605"></a><span id="l27.605" class="difflineplus">+   */</span>
<a href="#l27.606"></a><span id="l27.606"> </span>
<a href="#l27.607"></a><span id="l27.607"> case PR_CONTENT_INTEGRITY_CHECK:</span>
<a href="#l27.608"></a><span id="l27.608" class="difflineminus">-  s = &quot;PR_CONTENT_INTEGRITY_CHECK&quot;; break;</span>
<a href="#l27.609"></a><span id="l27.609" class="difflineplus">+  s = &quot;PR_CONTENT_INTEGRITY_CHECK&quot;;</span>
<a href="#l27.610"></a><span id="l27.610" class="difflineplus">+  break;</span>
<a href="#l27.611"></a><span id="l27.611"> case PR_EXPLICIT_CONVERSION:</span>
<a href="#l27.612"></a><span id="l27.612" class="difflineminus">-  s = &quot;PR_EXPLICIT_CONVERSION&quot;; break;</span>
<a href="#l27.613"></a><span id="l27.613" class="difflineplus">+  s = &quot;PR_EXPLICIT_CONVERSION&quot;;</span>
<a href="#l27.614"></a><span id="l27.614" class="difflineplus">+  break;</span>
<a href="#l27.615"></a><span id="l27.615"> case PR_IPM_RETURN_REQUESTED:</span>
<a href="#l27.616"></a><span id="l27.616" class="difflineminus">-  s = &quot;PR_IPM_RETURN_REQUESTED&quot;; break;</span>
<a href="#l27.617"></a><span id="l27.617" class="difflineplus">+  s = &quot;PR_IPM_RETURN_REQUESTED&quot;;</span>
<a href="#l27.618"></a><span id="l27.618" class="difflineplus">+  break;</span>
<a href="#l27.619"></a><span id="l27.619"> case PR_MESSAGE_TOKEN:</span>
<a href="#l27.620"></a><span id="l27.620" class="difflineminus">-  s = &quot;PR_MESSAGE_TOKEN&quot;; break;</span>
<a href="#l27.621"></a><span id="l27.621" class="difflineplus">+  s = &quot;PR_MESSAGE_TOKEN&quot;;</span>
<a href="#l27.622"></a><span id="l27.622" class="difflineplus">+  break;</span>
<a href="#l27.623"></a><span id="l27.623"> case PR_NDR_REASON_CODE:</span>
<a href="#l27.624"></a><span id="l27.624" class="difflineminus">-  s = &quot;PR_NDR_REASON_CODE&quot;; break;</span>
<a href="#l27.625"></a><span id="l27.625" class="difflineplus">+  s = &quot;PR_NDR_REASON_CODE&quot;;</span>
<a href="#l27.626"></a><span id="l27.626" class="difflineplus">+  break;</span>
<a href="#l27.627"></a><span id="l27.627"> case PR_NDR_DIAG_CODE:</span>
<a href="#l27.628"></a><span id="l27.628" class="difflineminus">-  s = &quot;PR_NDR_DIAG_CODE&quot;; break;</span>
<a href="#l27.629"></a><span id="l27.629" class="difflineplus">+  s = &quot;PR_NDR_DIAG_CODE&quot;;</span>
<a href="#l27.630"></a><span id="l27.630" class="difflineplus">+  break;</span>
<a href="#l27.631"></a><span id="l27.631"> case PR_NON_RECEIPT_NOTIFICATION_REQUESTED:</span>
<a href="#l27.632"></a><span id="l27.632" class="difflineminus">-  s = &quot;PR_NON_RECEIPT_NOTIFICATION_REQUESTED&quot;; break;</span>
<a href="#l27.633"></a><span id="l27.633" class="difflineplus">+  s = &quot;PR_NON_RECEIPT_NOTIFICATION_REQUESTED&quot;;</span>
<a href="#l27.634"></a><span id="l27.634" class="difflineplus">+  break;</span>
<a href="#l27.635"></a><span id="l27.635"> case PR_DELIVERY_POINT:</span>
<a href="#l27.636"></a><span id="l27.636" class="difflineminus">-  s = &quot;PR_DELIVERY_POINT&quot;; break;</span>
<a href="#l27.637"></a><span id="l27.637" class="difflineplus">+  s = &quot;PR_DELIVERY_POINT&quot;;</span>
<a href="#l27.638"></a><span id="l27.638" class="difflineplus">+  break;</span>
<a href="#l27.639"></a><span id="l27.639"> </span>
<a href="#l27.640"></a><span id="l27.640"> case PR_ORIGINATOR_NON_DELIVERY_REPORT_REQUESTED:</span>
<a href="#l27.641"></a><span id="l27.641" class="difflineminus">-  s = &quot;PR_ORIGINATOR_NON_DELIVERY_REPORT_REQUESTED&quot;; break;</span>
<a href="#l27.642"></a><span id="l27.642" class="difflineplus">+  s = &quot;PR_ORIGINATOR_NON_DELIVERY_REPORT_REQUESTED&quot;;</span>
<a href="#l27.643"></a><span id="l27.643" class="difflineplus">+  break;</span>
<a href="#l27.644"></a><span id="l27.644"> case PR_ORIGINATOR_REQUESTED_ALTERNATE_RECIPIENT:</span>
<a href="#l27.645"></a><span id="l27.645" class="difflineminus">-  s = &quot;PR_ORIGINATOR_REQUESTED_ALTERNATE_RECIPIENT&quot;; break;</span>
<a href="#l27.646"></a><span id="l27.646" class="difflineplus">+  s = &quot;PR_ORIGINATOR_REQUESTED_ALTERNATE_RECIPIENT&quot;;</span>
<a href="#l27.647"></a><span id="l27.647" class="difflineplus">+  break;</span>
<a href="#l27.648"></a><span id="l27.648"> case PR_PHYSICAL_DELIVERY_BUREAU_FAX_DELIVERY:</span>
<a href="#l27.649"></a><span id="l27.649" class="difflineminus">-  s = &quot;PR_PHYSICAL_DELIVERY_BUREAU_FAX_DELIVERY&quot;; break;</span>
<a href="#l27.650"></a><span id="l27.650" class="difflineplus">+  s = &quot;PR_PHYSICAL_DELIVERY_BUREAU_FAX_DELIVERY&quot;;</span>
<a href="#l27.651"></a><span id="l27.651" class="difflineplus">+  break;</span>
<a href="#l27.652"></a><span id="l27.652"> case PR_PHYSICAL_DELIVERY_MODE:</span>
<a href="#l27.653"></a><span id="l27.653" class="difflineminus">-  s = &quot;PR_PHYSICAL_DELIVERY_MODE&quot;; break;</span>
<a href="#l27.654"></a><span id="l27.654" class="difflineplus">+  s = &quot;PR_PHYSICAL_DELIVERY_MODE&quot;;</span>
<a href="#l27.655"></a><span id="l27.655" class="difflineplus">+  break;</span>
<a href="#l27.656"></a><span id="l27.656"> case PR_PHYSICAL_DELIVERY_REPORT_REQUEST:</span>
<a href="#l27.657"></a><span id="l27.657" class="difflineminus">-  s = &quot;PR_PHYSICAL_DELIVERY_REPORT_REQUEST&quot;; break;</span>
<a href="#l27.658"></a><span id="l27.658" class="difflineplus">+  s = &quot;PR_PHYSICAL_DELIVERY_REPORT_REQUEST&quot;;</span>
<a href="#l27.659"></a><span id="l27.659" class="difflineplus">+  break;</span>
<a href="#l27.660"></a><span id="l27.660"> case PR_PHYSICAL_FORWARDING_ADDRESS:</span>
<a href="#l27.661"></a><span id="l27.661" class="difflineminus">-  s = &quot;PR_PHYSICAL_FORWARDING_ADDRESS&quot;; break;</span>
<a href="#l27.662"></a><span id="l27.662" class="difflineplus">+  s = &quot;PR_PHYSICAL_FORWARDING_ADDRESS&quot;;</span>
<a href="#l27.663"></a><span id="l27.663" class="difflineplus">+  break;</span>
<a href="#l27.664"></a><span id="l27.664"> case PR_PHYSICAL_FORWARDING_ADDRESS_REQUESTED:</span>
<a href="#l27.665"></a><span id="l27.665" class="difflineminus">-  s = &quot;PR_PHYSICAL_FORWARDING_ADDRESS_REQUESTED&quot;; break;</span>
<a href="#l27.666"></a><span id="l27.666" class="difflineplus">+  s = &quot;PR_PHYSICAL_FORWARDING_ADDRESS_REQUESTED&quot;;</span>
<a href="#l27.667"></a><span id="l27.667" class="difflineplus">+  break;</span>
<a href="#l27.668"></a><span id="l27.668"> case PR_PHYSICAL_FORWARDING_PROHIBITED:</span>
<a href="#l27.669"></a><span id="l27.669" class="difflineminus">-  s = &quot;PR_PHYSICAL_FORWARDING_PROHIBITED&quot;; break;</span>
<a href="#l27.670"></a><span id="l27.670" class="difflineplus">+  s = &quot;PR_PHYSICAL_FORWARDING_PROHIBITED&quot;;</span>
<a href="#l27.671"></a><span id="l27.671" class="difflineplus">+  break;</span>
<a href="#l27.672"></a><span id="l27.672"> case PR_PHYSICAL_RENDITION_ATTRIBUTES:</span>
<a href="#l27.673"></a><span id="l27.673" class="difflineminus">-  s = &quot;PR_PHYSICAL_RENDITION_ATTRIBUTES&quot;; break;</span>
<a href="#l27.674"></a><span id="l27.674" class="difflineplus">+  s = &quot;PR_PHYSICAL_RENDITION_ATTRIBUTES&quot;;</span>
<a href="#l27.675"></a><span id="l27.675" class="difflineplus">+  break;</span>
<a href="#l27.676"></a><span id="l27.676"> case PR_PROOF_OF_DELIVERY:</span>
<a href="#l27.677"></a><span id="l27.677" class="difflineminus">-  s = &quot;PR_PROOF_OF_DELIVERY&quot;; break;</span>
<a href="#l27.678"></a><span id="l27.678" class="difflineplus">+  s = &quot;PR_PROOF_OF_DELIVERY&quot;;</span>
<a href="#l27.679"></a><span id="l27.679" class="difflineplus">+  break;</span>
<a href="#l27.680"></a><span id="l27.680"> case PR_PROOF_OF_DELIVERY_REQUESTED:</span>
<a href="#l27.681"></a><span id="l27.681" class="difflineminus">-  s = &quot;PR_PROOF_OF_DELIVERY_REQUESTED&quot;; break;</span>
<a href="#l27.682"></a><span id="l27.682" class="difflineplus">+  s = &quot;PR_PROOF_OF_DELIVERY_REQUESTED&quot;;</span>
<a href="#l27.683"></a><span id="l27.683" class="difflineplus">+  break;</span>
<a href="#l27.684"></a><span id="l27.684"> case PR_RECIPIENT_CERTIFICATE:</span>
<a href="#l27.685"></a><span id="l27.685" class="difflineminus">-  s = &quot;PR_RECIPIENT_CERTIFICATE&quot;; break;</span>
<a href="#l27.686"></a><span id="l27.686" class="difflineplus">+  s = &quot;PR_RECIPIENT_CERTIFICATE&quot;;</span>
<a href="#l27.687"></a><span id="l27.687" class="difflineplus">+  break;</span>
<a href="#l27.688"></a><span id="l27.688"> case PR_RECIPIENT_NUMBER_FOR_ADVICE:</span>
<a href="#l27.689"></a><span id="l27.689" class="difflineminus">-  s = &quot;PR_RECIPIENT_NUMBER_FOR_ADVICE&quot;; break;</span>
<a href="#l27.690"></a><span id="l27.690" class="difflineplus">+  s = &quot;PR_RECIPIENT_NUMBER_FOR_ADVICE&quot;;</span>
<a href="#l27.691"></a><span id="l27.691" class="difflineplus">+  break;</span>
<a href="#l27.692"></a><span id="l27.692"> case PR_RECIPIENT_TYPE:</span>
<a href="#l27.693"></a><span id="l27.693" class="difflineminus">-  s = &quot;PR_RECIPIENT_TYPE&quot;; break;</span>
<a href="#l27.694"></a><span id="l27.694" class="difflineplus">+  s = &quot;PR_RECIPIENT_TYPE&quot;;</span>
<a href="#l27.695"></a><span id="l27.695" class="difflineplus">+  break;</span>
<a href="#l27.696"></a><span id="l27.696"> case PR_REGISTERED_MAIL_TYPE:</span>
<a href="#l27.697"></a><span id="l27.697" class="difflineminus">-  s = &quot;PR_REGISTERED_MAIL_TYPE&quot;; break;</span>
<a href="#l27.698"></a><span id="l27.698" class="difflineplus">+  s = &quot;PR_REGISTERED_MAIL_TYPE&quot;;</span>
<a href="#l27.699"></a><span id="l27.699" class="difflineplus">+  break;</span>
<a href="#l27.700"></a><span id="l27.700"> case PR_REPLY_REQUESTED:</span>
<a href="#l27.701"></a><span id="l27.701" class="difflineminus">-  s = &quot;PR_REPLY_REQUESTED&quot;; break;</span>
<a href="#l27.702"></a><span id="l27.702" class="difflineplus">+  s = &quot;PR_REPLY_REQUESTED&quot;;</span>
<a href="#l27.703"></a><span id="l27.703" class="difflineplus">+  break;</span>
<a href="#l27.704"></a><span id="l27.704"> case PR_REQUESTED_DELIVERY_METHOD:</span>
<a href="#l27.705"></a><span id="l27.705" class="difflineminus">-  s = &quot;PR_REQUESTED_DELIVERY_METHOD&quot;; break;</span>
<a href="#l27.706"></a><span id="l27.706" class="difflineplus">+  s = &quot;PR_REQUESTED_DELIVERY_METHOD&quot;;</span>
<a href="#l27.707"></a><span id="l27.707" class="difflineplus">+  break;</span>
<a href="#l27.708"></a><span id="l27.708"> case PR_SENDER_ENTRYID:</span>
<a href="#l27.709"></a><span id="l27.709" class="difflineminus">-  s = &quot;PR_SENDER_ENTRYID&quot;; break;</span>
<a href="#l27.710"></a><span id="l27.710" class="difflineplus">+  s = &quot;PR_SENDER_ENTRYID&quot;;</span>
<a href="#l27.711"></a><span id="l27.711" class="difflineplus">+  break;</span>
<a href="#l27.712"></a><span id="l27.712"> case PR_SENDER_NAME:</span>
<a href="#l27.713"></a><span id="l27.713" class="difflineminus">-  s = &quot;PR_SENDER_NAME&quot;; break;</span>
<a href="#l27.714"></a><span id="l27.714" class="difflineplus">+  s = &quot;PR_SENDER_NAME&quot;;</span>
<a href="#l27.715"></a><span id="l27.715" class="difflineplus">+  break;</span>
<a href="#l27.716"></a><span id="l27.716"> case PR_SUPPLEMENTARY_INFO:</span>
<a href="#l27.717"></a><span id="l27.717" class="difflineminus">-  s = &quot;PR_SUPPLEMENTARY_INFO&quot;; break;</span>
<a href="#l27.718"></a><span id="l27.718" class="difflineplus">+  s = &quot;PR_SUPPLEMENTARY_INFO&quot;;</span>
<a href="#l27.719"></a><span id="l27.719" class="difflineplus">+  break;</span>
<a href="#l27.720"></a><span id="l27.720"> case PR_TYPE_OF_MTS_USER:</span>
<a href="#l27.721"></a><span id="l27.721" class="difflineminus">-  s = &quot;PR_TYPE_OF_MTS_USER&quot;; break;</span>
<a href="#l27.722"></a><span id="l27.722" class="difflineplus">+  s = &quot;PR_TYPE_OF_MTS_USER&quot;;</span>
<a href="#l27.723"></a><span id="l27.723" class="difflineplus">+  break;</span>
<a href="#l27.724"></a><span id="l27.724"> case PR_SENDER_SEARCH_KEY:</span>
<a href="#l27.725"></a><span id="l27.725" class="difflineminus">-  s = &quot;PR_SENDER_SEARCH_KEY&quot;; break;</span>
<a href="#l27.726"></a><span id="l27.726" class="difflineplus">+  s = &quot;PR_SENDER_SEARCH_KEY&quot;;</span>
<a href="#l27.727"></a><span id="l27.727" class="difflineplus">+  break;</span>
<a href="#l27.728"></a><span id="l27.728"> case PR_SENDER_ADDRTYPE:</span>
<a href="#l27.729"></a><span id="l27.729" class="difflineminus">-  s = &quot;PR_SENDER_ADDRTYPE&quot;; break;</span>
<a href="#l27.730"></a><span id="l27.730" class="difflineplus">+  s = &quot;PR_SENDER_ADDRTYPE&quot;;</span>
<a href="#l27.731"></a><span id="l27.731" class="difflineplus">+  break;</span>
<a href="#l27.732"></a><span id="l27.732"> case PR_SENDER_EMAIL_ADDRESS:</span>
<a href="#l27.733"></a><span id="l27.733" class="difflineminus">-  s = &quot;PR_SENDER_EMAIL_ADDRESS&quot;; break;</span>
<a href="#l27.734"></a><span id="l27.734" class="difflineminus">-</span>
<a href="#l27.735"></a><span id="l27.735" class="difflineminus">-/*</span>
<a href="#l27.736"></a><span id="l27.736" class="difflineminus">- *  Message non-transmittable properties</span>
<a href="#l27.737"></a><span id="l27.737" class="difflineminus">- */</span>
<a href="#l27.738"></a><span id="l27.738" class="difflineplus">+  s = &quot;PR_SENDER_EMAIL_ADDRESS&quot;;</span>
<a href="#l27.739"></a><span id="l27.739" class="difflineplus">+  break;</span>
<a href="#l27.740"></a><span id="l27.740"> </span>
<a href="#l27.741"></a><span id="l27.741" class="difflineminus">-/*</span>
<a href="#l27.742"></a><span id="l27.742" class="difflineminus">- * The two tags, PR_MESSAGE_RECIPIENTS and PR_MESSAGE_ATTACHMENTS,</span>
<a href="#l27.743"></a><span id="l27.743" class="difflineminus">- * are to be used in the exclude list passed to</span>
<a href="#l27.744"></a><span id="l27.744" class="difflineminus">- * IMessage::CopyTo when the caller wants either the recipients or attachments</span>
<a href="#l27.745"></a><span id="l27.745" class="difflineminus">- * of the message to not get copied.  It is also used in the ProblemArray</span>
<a href="#l27.746"></a><span id="l27.746" class="difflineminus">- * return from IMessage::CopyTo when an error is encountered copying them</span>
<a href="#l27.747"></a><span id="l27.747" class="difflineminus">- */</span>
<a href="#l27.748"></a><span id="l27.748" class="difflineplus">+  /*</span>
<a href="#l27.749"></a><span id="l27.749" class="difflineplus">+   *  Message non-transmittable properties</span>
<a href="#l27.750"></a><span id="l27.750" class="difflineplus">+   */</span>
<a href="#l27.751"></a><span id="l27.751" class="difflineplus">+</span>
<a href="#l27.752"></a><span id="l27.752" class="difflineplus">+  /*</span>
<a href="#l27.753"></a><span id="l27.753" class="difflineplus">+   * The two tags, PR_MESSAGE_RECIPIENTS and PR_MESSAGE_ATTACHMENTS,</span>
<a href="#l27.754"></a><span id="l27.754" class="difflineplus">+   * are to be used in the exclude list passed to</span>
<a href="#l27.755"></a><span id="l27.755" class="difflineplus">+   * IMessage::CopyTo when the caller wants either the recipients or attachments</span>
<a href="#l27.756"></a><span id="l27.756" class="difflineplus">+   * of the message to not get copied.  It is also used in the ProblemArray</span>
<a href="#l27.757"></a><span id="l27.757" class="difflineplus">+   * return from IMessage::CopyTo when an error is encountered copying them</span>
<a href="#l27.758"></a><span id="l27.758" class="difflineplus">+   */</span>
<a href="#l27.759"></a><span id="l27.759"> </span>
<a href="#l27.760"></a><span id="l27.760"> case PR_CURRENT_VERSION:</span>
<a href="#l27.761"></a><span id="l27.761" class="difflineminus">-  s = &quot;PR_CURRENT_VERSION&quot;; break;</span>
<a href="#l27.762"></a><span id="l27.762" class="difflineplus">+  s = &quot;PR_CURRENT_VERSION&quot;;</span>
<a href="#l27.763"></a><span id="l27.763" class="difflineplus">+  break;</span>
<a href="#l27.764"></a><span id="l27.764"> case PR_DELETE_AFTER_SUBMIT:</span>
<a href="#l27.765"></a><span id="l27.765" class="difflineminus">-  s = &quot;PR_DELETE_AFTER_SUBMIT&quot;; break;</span>
<a href="#l27.766"></a><span id="l27.766" class="difflineplus">+  s = &quot;PR_DELETE_AFTER_SUBMIT&quot;;</span>
<a href="#l27.767"></a><span id="l27.767" class="difflineplus">+  break;</span>
<a href="#l27.768"></a><span id="l27.768"> case PR_DISPLAY_BCC:</span>
<a href="#l27.769"></a><span id="l27.769" class="difflineminus">-  s = &quot;PR_DISPLAY_BCC&quot;; break;</span>
<a href="#l27.770"></a><span id="l27.770" class="difflineplus">+  s = &quot;PR_DISPLAY_BCC&quot;;</span>
<a href="#l27.771"></a><span id="l27.771" class="difflineplus">+  break;</span>
<a href="#l27.772"></a><span id="l27.772"> case PR_DISPLAY_CC:</span>
<a href="#l27.773"></a><span id="l27.773" class="difflineminus">-  s = &quot;PR_DISPLAY_CC&quot;; break;</span>
<a href="#l27.774"></a><span id="l27.774" class="difflineplus">+  s = &quot;PR_DISPLAY_CC&quot;;</span>
<a href="#l27.775"></a><span id="l27.775" class="difflineplus">+  break;</span>
<a href="#l27.776"></a><span id="l27.776"> case PR_DISPLAY_TO:</span>
<a href="#l27.777"></a><span id="l27.777" class="difflineminus">-  s = &quot;PR_DISPLAY_TO&quot;; break;</span>
<a href="#l27.778"></a><span id="l27.778" class="difflineplus">+  s = &quot;PR_DISPLAY_TO&quot;;</span>
<a href="#l27.779"></a><span id="l27.779" class="difflineplus">+  break;</span>
<a href="#l27.780"></a><span id="l27.780"> case PR_PARENT_DISPLAY:</span>
<a href="#l27.781"></a><span id="l27.781" class="difflineminus">-  s = &quot;PR_PARENT_DISPLAY&quot;; break;</span>
<a href="#l27.782"></a><span id="l27.782" class="difflineplus">+  s = &quot;PR_PARENT_DISPLAY&quot;;</span>
<a href="#l27.783"></a><span id="l27.783" class="difflineplus">+  break;</span>
<a href="#l27.784"></a><span id="l27.784"> case PR_MESSAGE_DELIVERY_TIME:</span>
<a href="#l27.785"></a><span id="l27.785" class="difflineminus">-  s = &quot;PR_MESSAGE_DELIVERY_TIME&quot;; break;</span>
<a href="#l27.786"></a><span id="l27.786" class="difflineplus">+  s = &quot;PR_MESSAGE_DELIVERY_TIME&quot;;</span>
<a href="#l27.787"></a><span id="l27.787" class="difflineplus">+  break;</span>
<a href="#l27.788"></a><span id="l27.788"> case PR_MESSAGE_FLAGS:</span>
<a href="#l27.789"></a><span id="l27.789" class="difflineminus">-  s = &quot;PR_MESSAGE_FLAGS&quot;; break;</span>
<a href="#l27.790"></a><span id="l27.790" class="difflineplus">+  s = &quot;PR_MESSAGE_FLAGS&quot;;</span>
<a href="#l27.791"></a><span id="l27.791" class="difflineplus">+  break;</span>
<a href="#l27.792"></a><span id="l27.792"> case PR_MESSAGE_SIZE:</span>
<a href="#l27.793"></a><span id="l27.793" class="difflineminus">-  s = &quot;PR_MESSAGE_SIZE&quot;; break;</span>
<a href="#l27.794"></a><span id="l27.794" class="difflineplus">+  s = &quot;PR_MESSAGE_SIZE&quot;;</span>
<a href="#l27.795"></a><span id="l27.795" class="difflineplus">+  break;</span>
<a href="#l27.796"></a><span id="l27.796"> case PR_PARENT_ENTRYID:</span>
<a href="#l27.797"></a><span id="l27.797" class="difflineminus">-  s = &quot;PR_PARENT_ENTRYID&quot;; break;</span>
<a href="#l27.798"></a><span id="l27.798" class="difflineplus">+  s = &quot;PR_PARENT_ENTRYID&quot;;</span>
<a href="#l27.799"></a><span id="l27.799" class="difflineplus">+  break;</span>
<a href="#l27.800"></a><span id="l27.800"> case PR_SENTMAIL_ENTRYID:</span>
<a href="#l27.801"></a><span id="l27.801" class="difflineminus">-  s = &quot;PR_SENTMAIL_ENTRYID&quot;; break;</span>
<a href="#l27.802"></a><span id="l27.802" class="difflineplus">+  s = &quot;PR_SENTMAIL_ENTRYID&quot;;</span>
<a href="#l27.803"></a><span id="l27.803" class="difflineplus">+  break;</span>
<a href="#l27.804"></a><span id="l27.804"> case PR_CORRELATE:</span>
<a href="#l27.805"></a><span id="l27.805" class="difflineminus">-  s = &quot;PR_CORRELATE&quot;; break;</span>
<a href="#l27.806"></a><span id="l27.806" class="difflineplus">+  s = &quot;PR_CORRELATE&quot;;</span>
<a href="#l27.807"></a><span id="l27.807" class="difflineplus">+  break;</span>
<a href="#l27.808"></a><span id="l27.808"> case PR_CORRELATE_MTSID:</span>
<a href="#l27.809"></a><span id="l27.809" class="difflineminus">-  s = &quot;PR_CORRELATE_MTSID&quot;; break;</span>
<a href="#l27.810"></a><span id="l27.810" class="difflineplus">+  s = &quot;PR_CORRELATE_MTSID&quot;;</span>
<a href="#l27.811"></a><span id="l27.811" class="difflineplus">+  break;</span>
<a href="#l27.812"></a><span id="l27.812"> case PR_DISCRETE_VALUES:</span>
<a href="#l27.813"></a><span id="l27.813" class="difflineminus">-  s = &quot;PR_DISCRETE_VALUES&quot;; break;</span>
<a href="#l27.814"></a><span id="l27.814" class="difflineplus">+  s = &quot;PR_DISCRETE_VALUES&quot;;</span>
<a href="#l27.815"></a><span id="l27.815" class="difflineplus">+  break;</span>
<a href="#l27.816"></a><span id="l27.816"> case PR_RESPONSIBILITY:</span>
<a href="#l27.817"></a><span id="l27.817" class="difflineminus">-  s = &quot;PR_RESPONSIBILITY&quot;; break;</span>
<a href="#l27.818"></a><span id="l27.818" class="difflineplus">+  s = &quot;PR_RESPONSIBILITY&quot;;</span>
<a href="#l27.819"></a><span id="l27.819" class="difflineplus">+  break;</span>
<a href="#l27.820"></a><span id="l27.820"> case PR_SPOOLER_STATUS:</span>
<a href="#l27.821"></a><span id="l27.821" class="difflineminus">-  s = &quot;PR_SPOOLER_STATUS&quot;; break;</span>
<a href="#l27.822"></a><span id="l27.822" class="difflineplus">+  s = &quot;PR_SPOOLER_STATUS&quot;;</span>
<a href="#l27.823"></a><span id="l27.823" class="difflineplus">+  break;</span>
<a href="#l27.824"></a><span id="l27.824"> case PR_TRANSPORT_STATUS:</span>
<a href="#l27.825"></a><span id="l27.825" class="difflineminus">-  s = &quot;PR_TRANSPORT_STATUS&quot;; break;</span>
<a href="#l27.826"></a><span id="l27.826" class="difflineplus">+  s = &quot;PR_TRANSPORT_STATUS&quot;;</span>
<a href="#l27.827"></a><span id="l27.827" class="difflineplus">+  break;</span>
<a href="#l27.828"></a><span id="l27.828"> case PR_MESSAGE_RECIPIENTS:</span>
<a href="#l27.829"></a><span id="l27.829" class="difflineminus">-  s = &quot;PR_MESSAGE_RECIPIENTS&quot;; break;</span>
<a href="#l27.830"></a><span id="l27.830" class="difflineplus">+  s = &quot;PR_MESSAGE_RECIPIENTS&quot;;</span>
<a href="#l27.831"></a><span id="l27.831" class="difflineplus">+  break;</span>
<a href="#l27.832"></a><span id="l27.832"> case PR_MESSAGE_ATTACHMENTS:</span>
<a href="#l27.833"></a><span id="l27.833" class="difflineminus">-  s = &quot;PR_MESSAGE_ATTACHMENTS&quot;; break;</span>
<a href="#l27.834"></a><span id="l27.834" class="difflineplus">+  s = &quot;PR_MESSAGE_ATTACHMENTS&quot;;</span>
<a href="#l27.835"></a><span id="l27.835" class="difflineplus">+  break;</span>
<a href="#l27.836"></a><span id="l27.836"> case PR_SUBMIT_FLAGS:</span>
<a href="#l27.837"></a><span id="l27.837" class="difflineminus">-  s = &quot;PR_SUBMIT_FLAGS&quot;; break;</span>
<a href="#l27.838"></a><span id="l27.838" class="difflineplus">+  s = &quot;PR_SUBMIT_FLAGS&quot;;</span>
<a href="#l27.839"></a><span id="l27.839" class="difflineplus">+  break;</span>
<a href="#l27.840"></a><span id="l27.840"> case PR_RECIPIENT_STATUS:</span>
<a href="#l27.841"></a><span id="l27.841" class="difflineminus">-  s = &quot;PR_RECIPIENT_STATUS&quot;; break;</span>
<a href="#l27.842"></a><span id="l27.842" class="difflineplus">+  s = &quot;PR_RECIPIENT_STATUS&quot;;</span>
<a href="#l27.843"></a><span id="l27.843" class="difflineplus">+  break;</span>
<a href="#l27.844"></a><span id="l27.844"> case PR_TRANSPORT_KEY:</span>
<a href="#l27.845"></a><span id="l27.845" class="difflineminus">-  s = &quot;PR_TRANSPORT_KEY&quot;; break;</span>
<a href="#l27.846"></a><span id="l27.846" class="difflineplus">+  s = &quot;PR_TRANSPORT_KEY&quot;;</span>
<a href="#l27.847"></a><span id="l27.847" class="difflineplus">+  break;</span>
<a href="#l27.848"></a><span id="l27.848"> case PR_MSG_STATUS:</span>
<a href="#l27.849"></a><span id="l27.849" class="difflineminus">-  s = &quot;PR_MSG_STATUS&quot;; break;</span>
<a href="#l27.850"></a><span id="l27.850" class="difflineplus">+  s = &quot;PR_MSG_STATUS&quot;;</span>
<a href="#l27.851"></a><span id="l27.851" class="difflineplus">+  break;</span>
<a href="#l27.852"></a><span id="l27.852"> case PR_MESSAGE_DOWNLOAD_TIME:</span>
<a href="#l27.853"></a><span id="l27.853" class="difflineminus">-  s = &quot;PR_MESSAGE_DOWNLOAD_TIME&quot;; break;</span>
<a href="#l27.854"></a><span id="l27.854" class="difflineplus">+  s = &quot;PR_MESSAGE_DOWNLOAD_TIME&quot;;</span>
<a href="#l27.855"></a><span id="l27.855" class="difflineplus">+  break;</span>
<a href="#l27.856"></a><span id="l27.856"> case PR_CREATION_VERSION:</span>
<a href="#l27.857"></a><span id="l27.857" class="difflineminus">-  s = &quot;PR_CREATION_VERSION&quot;; break;</span>
<a href="#l27.858"></a><span id="l27.858" class="difflineplus">+  s = &quot;PR_CREATION_VERSION&quot;;</span>
<a href="#l27.859"></a><span id="l27.859" class="difflineplus">+  break;</span>
<a href="#l27.860"></a><span id="l27.860"> case PR_MODIFY_VERSION:</span>
<a href="#l27.861"></a><span id="l27.861" class="difflineminus">-  s = &quot;PR_MODIFY_VERSION&quot;; break;</span>
<a href="#l27.862"></a><span id="l27.862" class="difflineplus">+  s = &quot;PR_MODIFY_VERSION&quot;;</span>
<a href="#l27.863"></a><span id="l27.863" class="difflineplus">+  break;</span>
<a href="#l27.864"></a><span id="l27.864"> case PR_HASATTACH:</span>
<a href="#l27.865"></a><span id="l27.865" class="difflineminus">-  s = &quot;PR_HASATTACH&quot;; break;</span>
<a href="#l27.866"></a><span id="l27.866" class="difflineplus">+  s = &quot;PR_HASATTACH&quot;;</span>
<a href="#l27.867"></a><span id="l27.867" class="difflineplus">+  break;</span>
<a href="#l27.868"></a><span id="l27.868"> case PR_BODY_CRC:</span>
<a href="#l27.869"></a><span id="l27.869" class="difflineminus">-  s = &quot;PR_BODY_CRC&quot;; break;</span>
<a href="#l27.870"></a><span id="l27.870" class="difflineplus">+  s = &quot;PR_BODY_CRC&quot;;</span>
<a href="#l27.871"></a><span id="l27.871" class="difflineplus">+  break;</span>
<a href="#l27.872"></a><span id="l27.872"> case PR_NORMALIZED_SUBJECT:</span>
<a href="#l27.873"></a><span id="l27.873" class="difflineminus">-  s = &quot;PR_NORMALIZED_SUBJECT&quot;; break;</span>
<a href="#l27.874"></a><span id="l27.874" class="difflineplus">+  s = &quot;PR_NORMALIZED_SUBJECT&quot;;</span>
<a href="#l27.875"></a><span id="l27.875" class="difflineplus">+  break;</span>
<a href="#l27.876"></a><span id="l27.876"> case PR_RTF_IN_SYNC:</span>
<a href="#l27.877"></a><span id="l27.877" class="difflineminus">-  s = &quot;PR_RTF_IN_SYNC&quot;; break;</span>
<a href="#l27.878"></a><span id="l27.878" class="difflineplus">+  s = &quot;PR_RTF_IN_SYNC&quot;;</span>
<a href="#l27.879"></a><span id="l27.879" class="difflineplus">+  break;</span>
<a href="#l27.880"></a><span id="l27.880"> case PR_ATTACH_SIZE:</span>
<a href="#l27.881"></a><span id="l27.881" class="difflineminus">-  s = &quot;PR_ATTACH_SIZE&quot;; break;</span>
<a href="#l27.882"></a><span id="l27.882" class="difflineplus">+  s = &quot;PR_ATTACH_SIZE&quot;;</span>
<a href="#l27.883"></a><span id="l27.883" class="difflineplus">+  break;</span>
<a href="#l27.884"></a><span id="l27.884"> case PR_ATTACH_NUM:</span>
<a href="#l27.885"></a><span id="l27.885" class="difflineminus">-  s = &quot;PR_ATTACH_NUM&quot;; break;</span>
<a href="#l27.886"></a><span id="l27.886" class="difflineplus">+  s = &quot;PR_ATTACH_NUM&quot;;</span>
<a href="#l27.887"></a><span id="l27.887" class="difflineplus">+  break;</span>
<a href="#l27.888"></a><span id="l27.888"> case PR_PREPROCESS:</span>
<a href="#l27.889"></a><span id="l27.889" class="difflineminus">-  s = &quot;PR_PREPROCESS&quot;; break;</span>
<a href="#l27.890"></a><span id="l27.890" class="difflineplus">+  s = &quot;PR_PREPROCESS&quot;;</span>
<a href="#l27.891"></a><span id="l27.891" class="difflineplus">+  break;</span>
<a href="#l27.892"></a><span id="l27.892"> </span>
<a href="#l27.893"></a><span id="l27.893" class="difflineminus">-/* PR_ORIGINAL_DISPLAY_TO, _CC, and _BCC moved to transmittible range 03/09/95 */</span>
<a href="#l27.894"></a><span id="l27.894" class="difflineplus">+  /* PR_ORIGINAL_DISPLAY_TO, _CC, and _BCC moved to transmittible range 03/09/95</span>
<a href="#l27.895"></a><span id="l27.895" class="difflineplus">+   */</span>
<a href="#l27.896"></a><span id="l27.896"> </span>
<a href="#l27.897"></a><span id="l27.897"> case PR_ORIGINATING_MTA_CERTIFICATE:</span>
<a href="#l27.898"></a><span id="l27.898" class="difflineminus">-  s = &quot;PR_ORIGINATING_MTA_CERTIFICATE&quot;; break;</span>
<a href="#l27.899"></a><span id="l27.899" class="difflineplus">+  s = &quot;PR_ORIGINATING_MTA_CERTIFICATE&quot;;</span>
<a href="#l27.900"></a><span id="l27.900" class="difflineplus">+  break;</span>
<a href="#l27.901"></a><span id="l27.901"> case PR_PROOF_OF_SUBMISSION:</span>
<a href="#l27.902"></a><span id="l27.902" class="difflineminus">-  s = &quot;PR_PROOF_OF_SUBMISSION&quot;; break;</span>
<a href="#l27.903"></a><span id="l27.903" class="difflineminus">-</span>
<a href="#l27.904"></a><span id="l27.904" class="difflineplus">+  s = &quot;PR_PROOF_OF_SUBMISSION&quot;;</span>
<a href="#l27.905"></a><span id="l27.905" class="difflineplus">+  break;</span>
<a href="#l27.906"></a><span id="l27.906"> </span>
<a href="#l27.907"></a><span id="l27.907" class="difflineminus">-/*</span>
<a href="#l27.908"></a><span id="l27.908" class="difflineminus">- * The range of non-message and non-recipient property IDs (0x3000 - 0x3FFF) is</span>
<a href="#l27.909"></a><span id="l27.909" class="difflineminus">- * further broken down into ranges to make assigning new property IDs easier.</span>
<a href="#l27.910"></a><span id="l27.910" class="difflineminus">- *</span>
<a href="#l27.911"></a><span id="l27.911" class="difflineminus">- *  From    To      Kind of property</span>
<a href="#l27.912"></a><span id="l27.912" class="difflineminus">- *  --------------------------------</span>
<a href="#l27.913"></a><span id="l27.913" class="difflineminus">- *  3000    32FF    MAPI_defined common property</span>
<a href="#l27.914"></a><span id="l27.914" class="difflineminus">- *  3200    33FF    MAPI_defined form property</span>
<a href="#l27.915"></a><span id="l27.915" class="difflineminus">- *  3400    35FF    MAPI_defined message store property</span>
<a href="#l27.916"></a><span id="l27.916" class="difflineminus">- *  3600    36FF    MAPI_defined Folder or AB Container property</span>
<a href="#l27.917"></a><span id="l27.917" class="difflineminus">- *  3700    38FF    MAPI_defined attachment property</span>
<a href="#l27.918"></a><span id="l27.918" class="difflineminus">- *  3900    39FF    MAPI_defined address book property</span>
<a href="#l27.919"></a><span id="l27.919" class="difflineminus">- *  3A00    3BFF    MAPI_defined mailuser property</span>
<a href="#l27.920"></a><span id="l27.920" class="difflineminus">- *  3C00    3CFF    MAPI_defined DistList property</span>
<a href="#l27.921"></a><span id="l27.921" class="difflineminus">- *  3D00    3DFF    MAPI_defined Profile Section property</span>
<a href="#l27.922"></a><span id="l27.922" class="difflineminus">- *  3E00    3EFF    MAPI_defined Status property</span>
<a href="#l27.923"></a><span id="l27.923" class="difflineminus">- *  3F00    3FFF    MAPI_defined display table property</span>
<a href="#l27.924"></a><span id="l27.924" class="difflineminus">- */</span>
<a href="#l27.925"></a><span id="l27.925" class="difflineplus">+  /*</span>
<a href="#l27.926"></a><span id="l27.926" class="difflineplus">+   * The range of non-message and non-recipient property IDs (0x3000 - 0x3FFF)</span>
<a href="#l27.927"></a><span id="l27.927" class="difflineplus">+   * is further broken down into ranges to make assigning new property IDs</span>
<a href="#l27.928"></a><span id="l27.928" class="difflineplus">+   * easier.</span>
<a href="#l27.929"></a><span id="l27.929" class="difflineplus">+   *</span>
<a href="#l27.930"></a><span id="l27.930" class="difflineplus">+   *  From    To      Kind of property</span>
<a href="#l27.931"></a><span id="l27.931" class="difflineplus">+   *  --------------------------------</span>
<a href="#l27.932"></a><span id="l27.932" class="difflineplus">+   *  3000    32FF    MAPI_defined common property</span>
<a href="#l27.933"></a><span id="l27.933" class="difflineplus">+   *  3200    33FF    MAPI_defined form property</span>
<a href="#l27.934"></a><span id="l27.934" class="difflineplus">+   *  3400    35FF    MAPI_defined message store property</span>
<a href="#l27.935"></a><span id="l27.935" class="difflineplus">+   *  3600    36FF    MAPI_defined Folder or AB Container property</span>
<a href="#l27.936"></a><span id="l27.936" class="difflineplus">+   *  3700    38FF    MAPI_defined attachment property</span>
<a href="#l27.937"></a><span id="l27.937" class="difflineplus">+   *  3900    39FF    MAPI_defined address book property</span>
<a href="#l27.938"></a><span id="l27.938" class="difflineplus">+   *  3A00    3BFF    MAPI_defined mailuser property</span>
<a href="#l27.939"></a><span id="l27.939" class="difflineplus">+   *  3C00    3CFF    MAPI_defined DistList property</span>
<a href="#l27.940"></a><span id="l27.940" class="difflineplus">+   *  3D00    3DFF    MAPI_defined Profile Section property</span>
<a href="#l27.941"></a><span id="l27.941" class="difflineplus">+   *  3E00    3EFF    MAPI_defined Status property</span>
<a href="#l27.942"></a><span id="l27.942" class="difflineplus">+   *  3F00    3FFF    MAPI_defined display table property</span>
<a href="#l27.943"></a><span id="l27.943" class="difflineplus">+   */</span>
<a href="#l27.944"></a><span id="l27.944"> </span>
<a href="#l27.945"></a><span id="l27.945" class="difflineminus">-/*</span>
<a href="#l27.946"></a><span id="l27.946" class="difflineminus">- *  Properties common to numerous MAPI objects.</span>
<a href="#l27.947"></a><span id="l27.947" class="difflineminus">- *</span>
<a href="#l27.948"></a><span id="l27.948" class="difflineminus">- *  Those properties that can appear on messages are in the</span>
<a href="#l27.949"></a><span id="l27.949" class="difflineminus">- *  non-transmittable range for messages. They start at the high</span>
<a href="#l27.950"></a><span id="l27.950" class="difflineminus">- *  end of that range and work down.</span>
<a href="#l27.951"></a><span id="l27.951" class="difflineminus">- *</span>
<a href="#l27.952"></a><span id="l27.952" class="difflineminus">- *  Properties that never appear on messages are defined in the common</span>
<a href="#l27.953"></a><span id="l27.953" class="difflineminus">- *  property range (see above).</span>
<a href="#l27.954"></a><span id="l27.954" class="difflineminus">- */</span>
<a href="#l27.955"></a><span id="l27.955" class="difflineplus">+  /*</span>
<a href="#l27.956"></a><span id="l27.956" class="difflineplus">+   *  Properties common to numerous MAPI objects.</span>
<a href="#l27.957"></a><span id="l27.957" class="difflineplus">+   *</span>
<a href="#l27.958"></a><span id="l27.958" class="difflineplus">+   *  Those properties that can appear on messages are in the</span>
<a href="#l27.959"></a><span id="l27.959" class="difflineplus">+   *  non-transmittable range for messages. They start at the high</span>
<a href="#l27.960"></a><span id="l27.960" class="difflineplus">+   *  end of that range and work down.</span>
<a href="#l27.961"></a><span id="l27.961" class="difflineplus">+   *</span>
<a href="#l27.962"></a><span id="l27.962" class="difflineplus">+   *  Properties that never appear on messages are defined in the common</span>
<a href="#l27.963"></a><span id="l27.963" class="difflineplus">+   *  property range (see above).</span>
<a href="#l27.964"></a><span id="l27.964" class="difflineplus">+   */</span>
<a href="#l27.965"></a><span id="l27.965"> </span>
<a href="#l27.966"></a><span id="l27.966" class="difflineminus">-/*</span>
<a href="#l27.967"></a><span id="l27.967" class="difflineminus">- * properties that are common to multiple objects (including message objects)</span>
<a href="#l27.968"></a><span id="l27.968" class="difflineminus">- * -- these ids are in the non-transmittable range</span>
<a href="#l27.969"></a><span id="l27.969" class="difflineminus">- */</span>
<a href="#l27.970"></a><span id="l27.970" class="difflineplus">+  /*</span>
<a href="#l27.971"></a><span id="l27.971" class="difflineplus">+   * properties that are common to multiple objects (including message objects)</span>
<a href="#l27.972"></a><span id="l27.972" class="difflineplus">+   * -- these ids are in the non-transmittable range</span>
<a href="#l27.973"></a><span id="l27.973" class="difflineplus">+   */</span>
<a href="#l27.974"></a><span id="l27.974"> </span>
<a href="#l27.975"></a><span id="l27.975"> case PR_ENTRYID:</span>
<a href="#l27.976"></a><span id="l27.976" class="difflineminus">-  s = &quot;PR_ENTRYID&quot;; break;</span>
<a href="#l27.977"></a><span id="l27.977" class="difflineplus">+  s = &quot;PR_ENTRYID&quot;;</span>
<a href="#l27.978"></a><span id="l27.978" class="difflineplus">+  break;</span>
<a href="#l27.979"></a><span id="l27.979"> case PR_OBJECT_TYPE:</span>
<a href="#l27.980"></a><span id="l27.980" class="difflineminus">-  s = &quot;PR_OBJECT_TYPE&quot;; break;</span>
<a href="#l27.981"></a><span id="l27.981" class="difflineplus">+  s = &quot;PR_OBJECT_TYPE&quot;;</span>
<a href="#l27.982"></a><span id="l27.982" class="difflineplus">+  break;</span>
<a href="#l27.983"></a><span id="l27.983"> case PR_ICON:</span>
<a href="#l27.984"></a><span id="l27.984" class="difflineminus">-  s = &quot;PR_ICON&quot;; break;</span>
<a href="#l27.985"></a><span id="l27.985" class="difflineplus">+  s = &quot;PR_ICON&quot;;</span>
<a href="#l27.986"></a><span id="l27.986" class="difflineplus">+  break;</span>
<a href="#l27.987"></a><span id="l27.987"> case PR_MINI_ICON:</span>
<a href="#l27.988"></a><span id="l27.988" class="difflineminus">-  s = &quot;PR_MINI_ICON&quot;; break;</span>
<a href="#l27.989"></a><span id="l27.989" class="difflineplus">+  s = &quot;PR_MINI_ICON&quot;;</span>
<a href="#l27.990"></a><span id="l27.990" class="difflineplus">+  break;</span>
<a href="#l27.991"></a><span id="l27.991"> case PR_STORE_ENTRYID:</span>
<a href="#l27.992"></a><span id="l27.992" class="difflineminus">-  s = &quot;PR_STORE_ENTRYID&quot;; break;</span>
<a href="#l27.993"></a><span id="l27.993" class="difflineplus">+  s = &quot;PR_STORE_ENTRYID&quot;;</span>
<a href="#l27.994"></a><span id="l27.994" class="difflineplus">+  break;</span>
<a href="#l27.995"></a><span id="l27.995"> case PR_STORE_RECORD_KEY:</span>
<a href="#l27.996"></a><span id="l27.996" class="difflineminus">-  s = &quot;PR_STORE_RECORD_KEY&quot;; break;</span>
<a href="#l27.997"></a><span id="l27.997" class="difflineplus">+  s = &quot;PR_STORE_RECORD_KEY&quot;;</span>
<a href="#l27.998"></a><span id="l27.998" class="difflineplus">+  break;</span>
<a href="#l27.999"></a><span id="l27.999"> case PR_RECORD_KEY:</span>
<a href="#l27.1000"></a><span id="l27.1000" class="difflineminus">-  s = &quot;PR_RECORD_KEY&quot;; break;</span>
<a href="#l27.1001"></a><span id="l27.1001" class="difflineplus">+  s = &quot;PR_RECORD_KEY&quot;;</span>
<a href="#l27.1002"></a><span id="l27.1002" class="difflineplus">+  break;</span>
<a href="#l27.1003"></a><span id="l27.1003"> case PR_MAPPING_SIGNATURE:</span>
<a href="#l27.1004"></a><span id="l27.1004" class="difflineminus">-  s = &quot;PR_MAPPING_SIGNATURE&quot;; break;</span>
<a href="#l27.1005"></a><span id="l27.1005" class="difflineplus">+  s = &quot;PR_MAPPING_SIGNATURE&quot;;</span>
<a href="#l27.1006"></a><span id="l27.1006" class="difflineplus">+  break;</span>
<a href="#l27.1007"></a><span id="l27.1007"> case PR_ACCESS_LEVEL:</span>
<a href="#l27.1008"></a><span id="l27.1008" class="difflineminus">-  s = &quot;PR_ACCESS_LEVEL&quot;; break;</span>
<a href="#l27.1009"></a><span id="l27.1009" class="difflineplus">+  s = &quot;PR_ACCESS_LEVEL&quot;;</span>
<a href="#l27.1010"></a><span id="l27.1010" class="difflineplus">+  break;</span>
<a href="#l27.1011"></a><span id="l27.1011"> case PR_INSTANCE_KEY:</span>
<a href="#l27.1012"></a><span id="l27.1012" class="difflineminus">-  s = &quot;PR_INSTANCE_KEY&quot;; break;</span>
<a href="#l27.1013"></a><span id="l27.1013" class="difflineplus">+  s = &quot;PR_INSTANCE_KEY&quot;;</span>
<a href="#l27.1014"></a><span id="l27.1014" class="difflineplus">+  break;</span>
<a href="#l27.1015"></a><span id="l27.1015"> case PR_ROW_TYPE:</span>
<a href="#l27.1016"></a><span id="l27.1016" class="difflineminus">-  s = &quot;PR_ROW_TYPE&quot;; break;</span>
<a href="#l27.1017"></a><span id="l27.1017" class="difflineplus">+  s = &quot;PR_ROW_TYPE&quot;;</span>
<a href="#l27.1018"></a><span id="l27.1018" class="difflineplus">+  break;</span>
<a href="#l27.1019"></a><span id="l27.1019"> case PR_ACCESS:</span>
<a href="#l27.1020"></a><span id="l27.1020" class="difflineminus">-  s = &quot;PR_ACCESS&quot;; break;</span>
<a href="#l27.1021"></a><span id="l27.1021" class="difflineplus">+  s = &quot;PR_ACCESS&quot;;</span>
<a href="#l27.1022"></a><span id="l27.1022" class="difflineplus">+  break;</span>
<a href="#l27.1023"></a><span id="l27.1023"> </span>
<a href="#l27.1024"></a><span id="l27.1024" class="difflineminus">-/*</span>
<a href="#l27.1025"></a><span id="l27.1025" class="difflineminus">- * properties that are common to multiple objects (usually not including message objects)</span>
<a href="#l27.1026"></a><span id="l27.1026" class="difflineminus">- * -- these ids are in the transmittable range</span>
<a href="#l27.1027"></a><span id="l27.1027" class="difflineminus">- */</span>
<a href="#l27.1028"></a><span id="l27.1028" class="difflineplus">+  /*</span>
<a href="#l27.1029"></a><span id="l27.1029" class="difflineplus">+   * properties that are common to multiple objects (usually not including</span>
<a href="#l27.1030"></a><span id="l27.1030" class="difflineplus">+   * message objects)</span>
<a href="#l27.1031"></a><span id="l27.1031" class="difflineplus">+   * -- these ids are in the transmittable range</span>
<a href="#l27.1032"></a><span id="l27.1032" class="difflineplus">+   */</span>
<a href="#l27.1033"></a><span id="l27.1033"> </span>
<a href="#l27.1034"></a><span id="l27.1034"> case PR_ROWID:</span>
<a href="#l27.1035"></a><span id="l27.1035" class="difflineminus">-  s = &quot;PR_ROWID&quot;; break;</span>
<a href="#l27.1036"></a><span id="l27.1036" class="difflineplus">+  s = &quot;PR_ROWID&quot;;</span>
<a href="#l27.1037"></a><span id="l27.1037" class="difflineplus">+  break;</span>
<a href="#l27.1038"></a><span id="l27.1038"> case PR_DISPLAY_NAME:</span>
<a href="#l27.1039"></a><span id="l27.1039" class="difflineminus">-  s = &quot;PR_DISPLAY_NAME&quot;; break;</span>
<a href="#l27.1040"></a><span id="l27.1040" class="difflineplus">+  s = &quot;PR_DISPLAY_NAME&quot;;</span>
<a href="#l27.1041"></a><span id="l27.1041" class="difflineplus">+  break;</span>
<a href="#l27.1042"></a><span id="l27.1042"> case PR_ADDRTYPE:</span>
<a href="#l27.1043"></a><span id="l27.1043" class="difflineminus">-  s = &quot;PR_ADDRTYPE&quot;; break;</span>
<a href="#l27.1044"></a><span id="l27.1044" class="difflineplus">+  s = &quot;PR_ADDRTYPE&quot;;</span>
<a href="#l27.1045"></a><span id="l27.1045" class="difflineplus">+  break;</span>
<a href="#l27.1046"></a><span id="l27.1046"> case PR_EMAIL_ADDRESS:</span>
<a href="#l27.1047"></a><span id="l27.1047" class="difflineminus">-  s = &quot;PR_EMAIL_ADDRESS&quot;; break;</span>
<a href="#l27.1048"></a><span id="l27.1048" class="difflineplus">+  s = &quot;PR_EMAIL_ADDRESS&quot;;</span>
<a href="#l27.1049"></a><span id="l27.1049" class="difflineplus">+  break;</span>
<a href="#l27.1050"></a><span id="l27.1050"> case PR_COMMENT:</span>
<a href="#l27.1051"></a><span id="l27.1051" class="difflineminus">-  s = &quot;PR_COMMENT&quot;; break;</span>
<a href="#l27.1052"></a><span id="l27.1052" class="difflineplus">+  s = &quot;PR_COMMENT&quot;;</span>
<a href="#l27.1053"></a><span id="l27.1053" class="difflineplus">+  break;</span>
<a href="#l27.1054"></a><span id="l27.1054"> case PR_DEPTH:</span>
<a href="#l27.1055"></a><span id="l27.1055" class="difflineminus">-  s = &quot;PR_DEPTH&quot;; break;</span>
<a href="#l27.1056"></a><span id="l27.1056" class="difflineplus">+  s = &quot;PR_DEPTH&quot;;</span>
<a href="#l27.1057"></a><span id="l27.1057" class="difflineplus">+  break;</span>
<a href="#l27.1058"></a><span id="l27.1058"> case PR_PROVIDER_DISPLAY:</span>
<a href="#l27.1059"></a><span id="l27.1059" class="difflineminus">-  s = &quot;PR_PROVIDER_DISPLAY&quot;; break;</span>
<a href="#l27.1060"></a><span id="l27.1060" class="difflineplus">+  s = &quot;PR_PROVIDER_DISPLAY&quot;;</span>
<a href="#l27.1061"></a><span id="l27.1061" class="difflineplus">+  break;</span>
<a href="#l27.1062"></a><span id="l27.1062"> case PR_CREATION_TIME:</span>
<a href="#l27.1063"></a><span id="l27.1063" class="difflineminus">-  s = &quot;PR_CREATION_TIME&quot;; break;</span>
<a href="#l27.1064"></a><span id="l27.1064" class="difflineplus">+  s = &quot;PR_CREATION_TIME&quot;;</span>
<a href="#l27.1065"></a><span id="l27.1065" class="difflineplus">+  break;</span>
<a href="#l27.1066"></a><span id="l27.1066"> case PR_LAST_MODIFICATION_TIME:</span>
<a href="#l27.1067"></a><span id="l27.1067" class="difflineminus">-  s = &quot;PR_LAST_MODIFICATION_TIME&quot;; break;</span>
<a href="#l27.1068"></a><span id="l27.1068" class="difflineplus">+  s = &quot;PR_LAST_MODIFICATION_TIME&quot;;</span>
<a href="#l27.1069"></a><span id="l27.1069" class="difflineplus">+  break;</span>
<a href="#l27.1070"></a><span id="l27.1070"> case PR_RESOURCE_FLAGS:</span>
<a href="#l27.1071"></a><span id="l27.1071" class="difflineminus">-  s = &quot;PR_RESOURCE_FLAGS&quot;; break;</span>
<a href="#l27.1072"></a><span id="l27.1072" class="difflineplus">+  s = &quot;PR_RESOURCE_FLAGS&quot;;</span>
<a href="#l27.1073"></a><span id="l27.1073" class="difflineplus">+  break;</span>
<a href="#l27.1074"></a><span id="l27.1074"> case PR_PROVIDER_DLL_NAME:</span>
<a href="#l27.1075"></a><span id="l27.1075" class="difflineminus">-  s = &quot;PR_PROVIDER_DLL_NAME&quot;; break;</span>
<a href="#l27.1076"></a><span id="l27.1076" class="difflineplus">+  s = &quot;PR_PROVIDER_DLL_NAME&quot;;</span>
<a href="#l27.1077"></a><span id="l27.1077" class="difflineplus">+  break;</span>
<a href="#l27.1078"></a><span id="l27.1078"> case PR_SEARCH_KEY:</span>
<a href="#l27.1079"></a><span id="l27.1079" class="difflineminus">-  s = &quot;PR_SEARCH_KEY&quot;; break;</span>
<a href="#l27.1080"></a><span id="l27.1080" class="difflineplus">+  s = &quot;PR_SEARCH_KEY&quot;;</span>
<a href="#l27.1081"></a><span id="l27.1081" class="difflineplus">+  break;</span>
<a href="#l27.1082"></a><span id="l27.1082"> case PR_PROVIDER_UID:</span>
<a href="#l27.1083"></a><span id="l27.1083" class="difflineminus">-  s = &quot;PR_PROVIDER_UID&quot;; break;</span>
<a href="#l27.1084"></a><span id="l27.1084" class="difflineplus">+  s = &quot;PR_PROVIDER_UID&quot;;</span>
<a href="#l27.1085"></a><span id="l27.1085" class="difflineplus">+  break;</span>
<a href="#l27.1086"></a><span id="l27.1086"> case PR_PROVIDER_ORDINAL:</span>
<a href="#l27.1087"></a><span id="l27.1087" class="difflineminus">-  s = &quot;PR_PROVIDER_ORDINAL&quot;; break;</span>
<a href="#l27.1088"></a><span id="l27.1088" class="difflineplus">+  s = &quot;PR_PROVIDER_ORDINAL&quot;;</span>
<a href="#l27.1089"></a><span id="l27.1089" class="difflineplus">+  break;</span>
<a href="#l27.1090"></a><span id="l27.1090"> </span>
<a href="#l27.1091"></a><span id="l27.1091"> /*</span>
<a href="#l27.1092"></a><span id="l27.1092">  *  MAPI Form properties</span>
<a href="#l27.1093"></a><span id="l27.1093">  */</span>
<a href="#l27.1094"></a><span id="l27.1094"> case PR_FORM_VERSION:</span>
<a href="#l27.1095"></a><span id="l27.1095" class="difflineminus">-  s = &quot;PR_FORM_VERSION&quot;; break;</span>
<a href="#l27.1096"></a><span id="l27.1096" class="difflineplus">+  s = &quot;PR_FORM_VERSION&quot;;</span>
<a href="#l27.1097"></a><span id="l27.1097" class="difflineplus">+  break;</span>
<a href="#l27.1098"></a><span id="l27.1098"> case PR_FORM_CLSID:</span>
<a href="#l27.1099"></a><span id="l27.1099" class="difflineminus">-  s = &quot;PR_FORM_CLSID&quot;; break;</span>
<a href="#l27.1100"></a><span id="l27.1100" class="difflineplus">+  s = &quot;PR_FORM_CLSID&quot;;</span>
<a href="#l27.1101"></a><span id="l27.1101" class="difflineplus">+  break;</span>
<a href="#l27.1102"></a><span id="l27.1102"> case PR_FORM_CONTACT_NAME:</span>
<a href="#l27.1103"></a><span id="l27.1103" class="difflineminus">-  s = &quot;PR_FORM_CONTACT_NAME&quot;; break;</span>
<a href="#l27.1104"></a><span id="l27.1104" class="difflineplus">+  s = &quot;PR_FORM_CONTACT_NAME&quot;;</span>
<a href="#l27.1105"></a><span id="l27.1105" class="difflineplus">+  break;</span>
<a href="#l27.1106"></a><span id="l27.1106"> case PR_FORM_CATEGORY:</span>
<a href="#l27.1107"></a><span id="l27.1107" class="difflineminus">-  s = &quot;PR_FORM_CATEGORY&quot;; break;</span>
<a href="#l27.1108"></a><span id="l27.1108" class="difflineplus">+  s = &quot;PR_FORM_CATEGORY&quot;;</span>
<a href="#l27.1109"></a><span id="l27.1109" class="difflineplus">+  break;</span>
<a href="#l27.1110"></a><span id="l27.1110"> case PR_FORM_CATEGORY_SUB:</span>
<a href="#l27.1111"></a><span id="l27.1111" class="difflineminus">-  s = &quot;PR_FORM_CATEGORY_SUB&quot;; break;</span>
<a href="#l27.1112"></a><span id="l27.1112" class="difflineplus">+  s = &quot;PR_FORM_CATEGORY_SUB&quot;;</span>
<a href="#l27.1113"></a><span id="l27.1113" class="difflineplus">+  break;</span>
<a href="#l27.1114"></a><span id="l27.1114"> case PR_FORM_HOST_MAP:</span>
<a href="#l27.1115"></a><span id="l27.1115" class="difflineminus">-  s = &quot;PR_FORM_HOST_MAP&quot;; break;</span>
<a href="#l27.1116"></a><span id="l27.1116" class="difflineplus">+  s = &quot;PR_FORM_HOST_MAP&quot;;</span>
<a href="#l27.1117"></a><span id="l27.1117" class="difflineplus">+  break;</span>
<a href="#l27.1118"></a><span id="l27.1118"> case PR_FORM_HIDDEN:</span>
<a href="#l27.1119"></a><span id="l27.1119" class="difflineminus">-  s = &quot;PR_FORM_HIDDEN&quot;; break;</span>
<a href="#l27.1120"></a><span id="l27.1120" class="difflineplus">+  s = &quot;PR_FORM_HIDDEN&quot;;</span>
<a href="#l27.1121"></a><span id="l27.1121" class="difflineplus">+  break;</span>
<a href="#l27.1122"></a><span id="l27.1122"> case PR_FORM_DESIGNER_NAME:</span>
<a href="#l27.1123"></a><span id="l27.1123" class="difflineminus">-  s = &quot;PR_FORM_DESIGNER_NAME&quot;; break;</span>
<a href="#l27.1124"></a><span id="l27.1124" class="difflineplus">+  s = &quot;PR_FORM_DESIGNER_NAME&quot;;</span>
<a href="#l27.1125"></a><span id="l27.1125" class="difflineplus">+  break;</span>
<a href="#l27.1126"></a><span id="l27.1126"> case PR_FORM_DESIGNER_GUID:</span>
<a href="#l27.1127"></a><span id="l27.1127" class="difflineminus">-  s = &quot;PR_FORM_DESIGNER_GUID&quot;; break;</span>
<a href="#l27.1128"></a><span id="l27.1128" class="difflineplus">+  s = &quot;PR_FORM_DESIGNER_GUID&quot;;</span>
<a href="#l27.1129"></a><span id="l27.1129" class="difflineplus">+  break;</span>
<a href="#l27.1130"></a><span id="l27.1130"> case PR_FORM_MESSAGE_BEHAVIOR:</span>
<a href="#l27.1131"></a><span id="l27.1131" class="difflineminus">-  s = &quot;PR_FORM_MESSAGE_BEHAVIOR&quot;; break;</span>
<a href="#l27.1132"></a><span id="l27.1132" class="difflineplus">+  s = &quot;PR_FORM_MESSAGE_BEHAVIOR&quot;;</span>
<a href="#l27.1133"></a><span id="l27.1133" class="difflineplus">+  break;</span>
<a href="#l27.1134"></a><span id="l27.1134"> </span>
<a href="#l27.1135"></a><span id="l27.1135" class="difflineminus">-/*</span>
<a href="#l27.1136"></a><span id="l27.1136" class="difflineminus">- *  Message store properties</span>
<a href="#l27.1137"></a><span id="l27.1137" class="difflineminus">- */</span>
<a href="#l27.1138"></a><span id="l27.1138" class="difflineplus">+  /*</span>
<a href="#l27.1139"></a><span id="l27.1139" class="difflineplus">+   *  Message store properties</span>
<a href="#l27.1140"></a><span id="l27.1140" class="difflineplus">+   */</span>
<a href="#l27.1141"></a><span id="l27.1141"> </span>
<a href="#l27.1142"></a><span id="l27.1142"> case PR_DEFAULT_STORE:</span>
<a href="#l27.1143"></a><span id="l27.1143" class="difflineminus">-  s = &quot;PR_DEFAULT_STORE&quot;; break;</span>
<a href="#l27.1144"></a><span id="l27.1144" class="difflineplus">+  s = &quot;PR_DEFAULT_STORE&quot;;</span>
<a href="#l27.1145"></a><span id="l27.1145" class="difflineplus">+  break;</span>
<a href="#l27.1146"></a><span id="l27.1146"> case PR_STORE_SUPPORT_MASK:</span>
<a href="#l27.1147"></a><span id="l27.1147" class="difflineminus">-  s = &quot;PR_STORE_SUPPORT_MASK&quot;; break;</span>
<a href="#l27.1148"></a><span id="l27.1148" class="difflineplus">+  s = &quot;PR_STORE_SUPPORT_MASK&quot;;</span>
<a href="#l27.1149"></a><span id="l27.1149" class="difflineplus">+  break;</span>
<a href="#l27.1150"></a><span id="l27.1150"> case PR_STORE_STATE:</span>
<a href="#l27.1151"></a><span id="l27.1151" class="difflineminus">-  s = &quot;PR_STORE_STATE&quot;; break;</span>
<a href="#l27.1152"></a><span id="l27.1152" class="difflineplus">+  s = &quot;PR_STORE_STATE&quot;;</span>
<a href="#l27.1153"></a><span id="l27.1153" class="difflineplus">+  break;</span>
<a href="#l27.1154"></a><span id="l27.1154"> </span>
<a href="#l27.1155"></a><span id="l27.1155"> case PR_IPM_SUBTREE_SEARCH_KEY:</span>
<a href="#l27.1156"></a><span id="l27.1156" class="difflineminus">-  s = &quot;PR_IPM_SUBTREE_SEARCH_KEY&quot;; break;</span>
<a href="#l27.1157"></a><span id="l27.1157" class="difflineplus">+  s = &quot;PR_IPM_SUBTREE_SEARCH_KEY&quot;;</span>
<a href="#l27.1158"></a><span id="l27.1158" class="difflineplus">+  break;</span>
<a href="#l27.1159"></a><span id="l27.1159"> case PR_IPM_OUTBOX_SEARCH_KEY:</span>
<a href="#l27.1160"></a><span id="l27.1160" class="difflineminus">-  s = &quot;PR_IPM_OUTBOX_SEARCH_KEY&quot;; break;</span>
<a href="#l27.1161"></a><span id="l27.1161" class="difflineplus">+  s = &quot;PR_IPM_OUTBOX_SEARCH_KEY&quot;;</span>
<a href="#l27.1162"></a><span id="l27.1162" class="difflineplus">+  break;</span>
<a href="#l27.1163"></a><span id="l27.1163"> case PR_IPM_WASTEBASKET_SEARCH_KEY:</span>
<a href="#l27.1164"></a><span id="l27.1164" class="difflineminus">-  s = &quot;PR_IPM_WASTEBASKET_SEARCH_KEY&quot;; break;</span>
<a href="#l27.1165"></a><span id="l27.1165" class="difflineplus">+  s = &quot;PR_IPM_WASTEBASKET_SEARCH_KEY&quot;;</span>
<a href="#l27.1166"></a><span id="l27.1166" class="difflineplus">+  break;</span>
<a href="#l27.1167"></a><span id="l27.1167"> case PR_IPM_SENTMAIL_SEARCH_KEY:</span>
<a href="#l27.1168"></a><span id="l27.1168" class="difflineminus">-  s = &quot;PR_IPM_SENTMAIL_SEARCH_KEY&quot;; break;</span>
<a href="#l27.1169"></a><span id="l27.1169" class="difflineplus">+  s = &quot;PR_IPM_SENTMAIL_SEARCH_KEY&quot;;</span>
<a href="#l27.1170"></a><span id="l27.1170" class="difflineplus">+  break;</span>
<a href="#l27.1171"></a><span id="l27.1171"> case PR_MDB_PROVIDER:</span>
<a href="#l27.1172"></a><span id="l27.1172" class="difflineminus">-  s = &quot;PR_MDB_PROVIDER&quot;; break;</span>
<a href="#l27.1173"></a><span id="l27.1173" class="difflineplus">+  s = &quot;PR_MDB_PROVIDER&quot;;</span>
<a href="#l27.1174"></a><span id="l27.1174" class="difflineplus">+  break;</span>
<a href="#l27.1175"></a><span id="l27.1175"> case PR_RECEIVE_FOLDER_SETTINGS:</span>
<a href="#l27.1176"></a><span id="l27.1176" class="difflineminus">-  s = &quot;PR_RECEIVE_FOLDER_SETTINGS&quot;; break;</span>
<a href="#l27.1177"></a><span id="l27.1177" class="difflineplus">+  s = &quot;PR_RECEIVE_FOLDER_SETTINGS&quot;;</span>
<a href="#l27.1178"></a><span id="l27.1178" class="difflineplus">+  break;</span>
<a href="#l27.1179"></a><span id="l27.1179"> </span>
<a href="#l27.1180"></a><span id="l27.1180"> case PR_VALID_FOLDER_MASK:</span>
<a href="#l27.1181"></a><span id="l27.1181" class="difflineminus">-  s = &quot;PR_VALID_FOLDER_MASK&quot;; break;</span>
<a href="#l27.1182"></a><span id="l27.1182" class="difflineplus">+  s = &quot;PR_VALID_FOLDER_MASK&quot;;</span>
<a href="#l27.1183"></a><span id="l27.1183" class="difflineplus">+  break;</span>
<a href="#l27.1184"></a><span id="l27.1184"> case PR_IPM_SUBTREE_ENTRYID:</span>
<a href="#l27.1185"></a><span id="l27.1185" class="difflineminus">-  s = &quot;PR_IPM_SUBTREE_ENTRYID&quot;; break;</span>
<a href="#l27.1186"></a><span id="l27.1186" class="difflineplus">+  s = &quot;PR_IPM_SUBTREE_ENTRYID&quot;;</span>
<a href="#l27.1187"></a><span id="l27.1187" class="difflineplus">+  break;</span>
<a href="#l27.1188"></a><span id="l27.1188"> </span>
<a href="#l27.1189"></a><span id="l27.1189"> case PR_IPM_OUTBOX_ENTRYID:</span>
<a href="#l27.1190"></a><span id="l27.1190" class="difflineminus">-  s = &quot;PR_IPM_OUTBOX_ENTRYID&quot;; break;</span>
<a href="#l27.1191"></a><span id="l27.1191" class="difflineplus">+  s = &quot;PR_IPM_OUTBOX_ENTRYID&quot;;</span>
<a href="#l27.1192"></a><span id="l27.1192" class="difflineplus">+  break;</span>
<a href="#l27.1193"></a><span id="l27.1193"> case PR_IPM_WASTEBASKET_ENTRYID:</span>
<a href="#l27.1194"></a><span id="l27.1194" class="difflineminus">-  s = &quot;PR_IPM_WASTEBASKET_ENTRYID&quot;; break;</span>
<a href="#l27.1195"></a><span id="l27.1195" class="difflineplus">+  s = &quot;PR_IPM_WASTEBASKET_ENTRYID&quot;;</span>
<a href="#l27.1196"></a><span id="l27.1196" class="difflineplus">+  break;</span>
<a href="#l27.1197"></a><span id="l27.1197"> case PR_IPM_SENTMAIL_ENTRYID:</span>
<a href="#l27.1198"></a><span id="l27.1198" class="difflineminus">-  s = &quot;PR_IPM_SENTMAIL_ENTRYID&quot;; break;</span>
<a href="#l27.1199"></a><span id="l27.1199" class="difflineplus">+  s = &quot;PR_IPM_SENTMAIL_ENTRYID&quot;;</span>
<a href="#l27.1200"></a><span id="l27.1200" class="difflineplus">+  break;</span>
<a href="#l27.1201"></a><span id="l27.1201"> case PR_VIEWS_ENTRYID:</span>
<a href="#l27.1202"></a><span id="l27.1202" class="difflineminus">-  s = &quot;PR_VIEWS_ENTRYID&quot;; break;</span>
<a href="#l27.1203"></a><span id="l27.1203" class="difflineplus">+  s = &quot;PR_VIEWS_ENTRYID&quot;;</span>
<a href="#l27.1204"></a><span id="l27.1204" class="difflineplus">+  break;</span>
<a href="#l27.1205"></a><span id="l27.1205"> case PR_COMMON_VIEWS_ENTRYID:</span>
<a href="#l27.1206"></a><span id="l27.1206" class="difflineminus">-  s = &quot;PR_COMMON_VIEWS_ENTRYID&quot;; break;</span>
<a href="#l27.1207"></a><span id="l27.1207" class="difflineplus">+  s = &quot;PR_COMMON_VIEWS_ENTRYID&quot;;</span>
<a href="#l27.1208"></a><span id="l27.1208" class="difflineplus">+  break;</span>
<a href="#l27.1209"></a><span id="l27.1209"> case PR_FINDER_ENTRYID:</span>
<a href="#l27.1210"></a><span id="l27.1210" class="difflineminus">-  s = &quot;PR_FINDER_ENTRYID&quot;; break;</span>
<a href="#l27.1211"></a><span id="l27.1211" class="difflineplus">+  s = &quot;PR_FINDER_ENTRYID&quot;;</span>
<a href="#l27.1212"></a><span id="l27.1212" class="difflineplus">+  break;</span>
<a href="#l27.1213"></a><span id="l27.1213"> </span>
<a href="#l27.1214"></a><span id="l27.1214" class="difflineminus">-/* Proptags 0x35E8-0x35FF reserved for folders &quot;guaranteed&quot; by PR_VALID_FOLDER_MASK */</span>
<a href="#l27.1215"></a><span id="l27.1215" class="difflineminus">-</span>
<a href="#l27.1216"></a><span id="l27.1216" class="difflineplus">+  /* Proptags 0x35E8-0x35FF reserved for folders &quot;guaranteed&quot; by</span>
<a href="#l27.1217"></a><span id="l27.1217" class="difflineplus">+   * PR_VALID_FOLDER_MASK */</span>
<a href="#l27.1218"></a><span id="l27.1218"> </span>
<a href="#l27.1219"></a><span id="l27.1219" class="difflineminus">-/*</span>
<a href="#l27.1220"></a><span id="l27.1220" class="difflineminus">- *  Folder and AB Container properties</span>
<a href="#l27.1221"></a><span id="l27.1221" class="difflineminus">- */</span>
<a href="#l27.1222"></a><span id="l27.1222" class="difflineplus">+  /*</span>
<a href="#l27.1223"></a><span id="l27.1223" class="difflineplus">+   *  Folder and AB Container properties</span>
<a href="#l27.1224"></a><span id="l27.1224" class="difflineplus">+   */</span>
<a href="#l27.1225"></a><span id="l27.1225"> </span>
<a href="#l27.1226"></a><span id="l27.1226"> case PR_CONTAINER_FLAGS:</span>
<a href="#l27.1227"></a><span id="l27.1227" class="difflineminus">-  s = &quot;PR_CONTAINER_FLAGS&quot;; break;</span>
<a href="#l27.1228"></a><span id="l27.1228" class="difflineplus">+  s = &quot;PR_CONTAINER_FLAGS&quot;;</span>
<a href="#l27.1229"></a><span id="l27.1229" class="difflineplus">+  break;</span>
<a href="#l27.1230"></a><span id="l27.1230"> case PR_FOLDER_TYPE:</span>
<a href="#l27.1231"></a><span id="l27.1231" class="difflineminus">-  s = &quot;PR_FOLDER_TYPE&quot;; break;</span>
<a href="#l27.1232"></a><span id="l27.1232" class="difflineplus">+  s = &quot;PR_FOLDER_TYPE&quot;;</span>
<a href="#l27.1233"></a><span id="l27.1233" class="difflineplus">+  break;</span>
<a href="#l27.1234"></a><span id="l27.1234"> case PR_CONTENT_COUNT:</span>
<a href="#l27.1235"></a><span id="l27.1235" class="difflineminus">-  s = &quot;PR_CONTENT_COUNT&quot;; break;</span>
<a href="#l27.1236"></a><span id="l27.1236" class="difflineplus">+  s = &quot;PR_CONTENT_COUNT&quot;;</span>
<a href="#l27.1237"></a><span id="l27.1237" class="difflineplus">+  break;</span>
<a href="#l27.1238"></a><span id="l27.1238"> case PR_CONTENT_UNREAD:</span>
<a href="#l27.1239"></a><span id="l27.1239" class="difflineminus">-  s = &quot;PR_CONTENT_UNREAD&quot;; break;</span>
<a href="#l27.1240"></a><span id="l27.1240" class="difflineplus">+  s = &quot;PR_CONTENT_UNREAD&quot;;</span>
<a href="#l27.1241"></a><span id="l27.1241" class="difflineplus">+  break;</span>
<a href="#l27.1242"></a><span id="l27.1242"> case PR_CREATE_TEMPLATES:</span>
<a href="#l27.1243"></a><span id="l27.1243" class="difflineminus">-  s = &quot;PR_CREATE_TEMPLATES&quot;; break;</span>
<a href="#l27.1244"></a><span id="l27.1244" class="difflineplus">+  s = &quot;PR_CREATE_TEMPLATES&quot;;</span>
<a href="#l27.1245"></a><span id="l27.1245" class="difflineplus">+  break;</span>
<a href="#l27.1246"></a><span id="l27.1246"> case PR_DETAILS_TABLE:</span>
<a href="#l27.1247"></a><span id="l27.1247" class="difflineminus">-  s = &quot;PR_DETAILS_TABLE&quot;; break;</span>
<a href="#l27.1248"></a><span id="l27.1248" class="difflineplus">+  s = &quot;PR_DETAILS_TABLE&quot;;</span>
<a href="#l27.1249"></a><span id="l27.1249" class="difflineplus">+  break;</span>
<a href="#l27.1250"></a><span id="l27.1250"> case PR_SEARCH:</span>
<a href="#l27.1251"></a><span id="l27.1251" class="difflineminus">-  s = &quot;PR_SEARCH&quot;; break;</span>
<a href="#l27.1252"></a><span id="l27.1252" class="difflineplus">+  s = &quot;PR_SEARCH&quot;;</span>
<a href="#l27.1253"></a><span id="l27.1253" class="difflineplus">+  break;</span>
<a href="#l27.1254"></a><span id="l27.1254"> case PR_SELECTABLE:</span>
<a href="#l27.1255"></a><span id="l27.1255" class="difflineminus">-  s = &quot;PR_SELECTABLE&quot;; break;</span>
<a href="#l27.1256"></a><span id="l27.1256" class="difflineplus">+  s = &quot;PR_SELECTABLE&quot;;</span>
<a href="#l27.1257"></a><span id="l27.1257" class="difflineplus">+  break;</span>
<a href="#l27.1258"></a><span id="l27.1258"> case PR_SUBFOLDERS:</span>
<a href="#l27.1259"></a><span id="l27.1259" class="difflineminus">-  s = &quot;PR_SUBFOLDERS&quot;; break;</span>
<a href="#l27.1260"></a><span id="l27.1260" class="difflineplus">+  s = &quot;PR_SUBFOLDERS&quot;;</span>
<a href="#l27.1261"></a><span id="l27.1261" class="difflineplus">+  break;</span>
<a href="#l27.1262"></a><span id="l27.1262"> case PR_STATUS:</span>
<a href="#l27.1263"></a><span id="l27.1263" class="difflineminus">-  s = &quot;PR_STATUS&quot;; break;</span>
<a href="#l27.1264"></a><span id="l27.1264" class="difflineplus">+  s = &quot;PR_STATUS&quot;;</span>
<a href="#l27.1265"></a><span id="l27.1265" class="difflineplus">+  break;</span>
<a href="#l27.1266"></a><span id="l27.1266"> case PR_ANR:</span>
<a href="#l27.1267"></a><span id="l27.1267" class="difflineminus">-  s = &quot;PR_ANR&quot;; break;</span>
<a href="#l27.1268"></a><span id="l27.1268" class="difflineplus">+  s = &quot;PR_ANR&quot;;</span>
<a href="#l27.1269"></a><span id="l27.1269" class="difflineplus">+  break;</span>
<a href="#l27.1270"></a><span id="l27.1270"> case PR_CONTENTS_SORT_ORDER:</span>
<a href="#l27.1271"></a><span id="l27.1271" class="difflineminus">-  s = &quot;PR_CONTENTS_SORT_ORDER&quot;; break;</span>
<a href="#l27.1272"></a><span id="l27.1272" class="difflineplus">+  s = &quot;PR_CONTENTS_SORT_ORDER&quot;;</span>
<a href="#l27.1273"></a><span id="l27.1273" class="difflineplus">+  break;</span>
<a href="#l27.1274"></a><span id="l27.1274"> case PR_CONTAINER_HIERARCHY:</span>
<a href="#l27.1275"></a><span id="l27.1275" class="difflineminus">-  s = &quot;PR_CONTAINER_HIERARCHY&quot;; break;</span>
<a href="#l27.1276"></a><span id="l27.1276" class="difflineplus">+  s = &quot;PR_CONTAINER_HIERARCHY&quot;;</span>
<a href="#l27.1277"></a><span id="l27.1277" class="difflineplus">+  break;</span>
<a href="#l27.1278"></a><span id="l27.1278"> case PR_CONTAINER_CONTENTS:</span>
<a href="#l27.1279"></a><span id="l27.1279" class="difflineminus">-  s = &quot;PR_CONTAINER_CONTENTS&quot;; break;</span>
<a href="#l27.1280"></a><span id="l27.1280" class="difflineplus">+  s = &quot;PR_CONTAINER_CONTENTS&quot;;</span>
<a href="#l27.1281"></a><span id="l27.1281" class="difflineplus">+  break;</span>
<a href="#l27.1282"></a><span id="l27.1282"> case PR_FOLDER_ASSOCIATED_CONTENTS:</span>
<a href="#l27.1283"></a><span id="l27.1283" class="difflineminus">-  s = &quot;PR_FOLDER_ASSOCIATED_CONTENTS&quot;; break;</span>
<a href="#l27.1284"></a><span id="l27.1284" class="difflineplus">+  s = &quot;PR_FOLDER_ASSOCIATED_CONTENTS&quot;;</span>
<a href="#l27.1285"></a><span id="l27.1285" class="difflineplus">+  break;</span>
<a href="#l27.1286"></a><span id="l27.1286"> case PR_DEF_CREATE_DL:</span>
<a href="#l27.1287"></a><span id="l27.1287" class="difflineminus">-  s = &quot;PR_DEF_CREATE_DL&quot;; break;</span>
<a href="#l27.1288"></a><span id="l27.1288" class="difflineplus">+  s = &quot;PR_DEF_CREATE_DL&quot;;</span>
<a href="#l27.1289"></a><span id="l27.1289" class="difflineplus">+  break;</span>
<a href="#l27.1290"></a><span id="l27.1290"> case PR_DEF_CREATE_MAILUSER:</span>
<a href="#l27.1291"></a><span id="l27.1291" class="difflineminus">-  s = &quot;PR_DEF_CREATE_MAILUSER&quot;; break;</span>
<a href="#l27.1292"></a><span id="l27.1292" class="difflineplus">+  s = &quot;PR_DEF_CREATE_MAILUSER&quot;;</span>
<a href="#l27.1293"></a><span id="l27.1293" class="difflineplus">+  break;</span>
<a href="#l27.1294"></a><span id="l27.1294"> case PR_CONTAINER_CLASS:</span>
<a href="#l27.1295"></a><span id="l27.1295" class="difflineminus">-  s = &quot;PR_CONTAINER_CLASS&quot;; break;</span>
<a href="#l27.1296"></a><span id="l27.1296" class="difflineplus">+  s = &quot;PR_CONTAINER_CLASS&quot;;</span>
<a href="#l27.1297"></a><span id="l27.1297" class="difflineplus">+  break;</span>
<a href="#l27.1298"></a><span id="l27.1298"> case PR_CONTAINER_MODIFY_VERSION:</span>
<a href="#l27.1299"></a><span id="l27.1299" class="difflineminus">-  s = &quot;PR_CONTAINER_MODIFY_VERSION&quot;; break;</span>
<a href="#l27.1300"></a><span id="l27.1300" class="difflineplus">+  s = &quot;PR_CONTAINER_MODIFY_VERSION&quot;;</span>
<a href="#l27.1301"></a><span id="l27.1301" class="difflineplus">+  break;</span>
<a href="#l27.1302"></a><span id="l27.1302"> case PR_AB_PROVIDER_ID:</span>
<a href="#l27.1303"></a><span id="l27.1303" class="difflineminus">-  s = &quot;PR_AB_PROVIDER_ID&quot;; break;</span>
<a href="#l27.1304"></a><span id="l27.1304" class="difflineplus">+  s = &quot;PR_AB_PROVIDER_ID&quot;;</span>
<a href="#l27.1305"></a><span id="l27.1305" class="difflineplus">+  break;</span>
<a href="#l27.1306"></a><span id="l27.1306"> case PR_DEFAULT_VIEW_ENTRYID:</span>
<a href="#l27.1307"></a><span id="l27.1307" class="difflineminus">-  s = &quot;PR_DEFAULT_VIEW_ENTRYID&quot;; break;</span>
<a href="#l27.1308"></a><span id="l27.1308" class="difflineplus">+  s = &quot;PR_DEFAULT_VIEW_ENTRYID&quot;;</span>
<a href="#l27.1309"></a><span id="l27.1309" class="difflineplus">+  break;</span>
<a href="#l27.1310"></a><span id="l27.1310"> case PR_ASSOC_CONTENT_COUNT:</span>
<a href="#l27.1311"></a><span id="l27.1311" class="difflineminus">-  s = &quot;PR_ASSOC_CONTENT_COUNT&quot;; break;</span>
<a href="#l27.1312"></a><span id="l27.1312" class="difflineminus">-</span>
<a href="#l27.1313"></a><span id="l27.1313" class="difflineminus">-/* Reserved 0x36C0-0x36FF */</span>
<a href="#l27.1314"></a><span id="l27.1314" class="difflineplus">+  s = &quot;PR_ASSOC_CONTENT_COUNT&quot;;</span>
<a href="#l27.1315"></a><span id="l27.1315" class="difflineplus">+  break;</span>
<a href="#l27.1316"></a><span id="l27.1316"> </span>
<a href="#l27.1317"></a><span id="l27.1317" class="difflineminus">-/*</span>
<a href="#l27.1318"></a><span id="l27.1318" class="difflineminus">- *  Attachment properties</span>
<a href="#l27.1319"></a><span id="l27.1319" class="difflineminus">- */</span>
<a href="#l27.1320"></a><span id="l27.1320" class="difflineplus">+  /* Reserved 0x36C0-0x36FF */</span>
<a href="#l27.1321"></a><span id="l27.1321" class="difflineplus">+</span>
<a href="#l27.1322"></a><span id="l27.1322" class="difflineplus">+  /*</span>
<a href="#l27.1323"></a><span id="l27.1323" class="difflineplus">+   *  Attachment properties</span>
<a href="#l27.1324"></a><span id="l27.1324" class="difflineplus">+   */</span>
<a href="#l27.1325"></a><span id="l27.1325"> </span>
<a href="#l27.1326"></a><span id="l27.1326"> case PR_ATTACHMENT_X400_PARAMETERS:</span>
<a href="#l27.1327"></a><span id="l27.1327" class="difflineminus">-  s = &quot;PR_ATTACHMENT_X400_PARAMETERS&quot;; break;</span>
<a href="#l27.1328"></a><span id="l27.1328" class="difflineplus">+  s = &quot;PR_ATTACHMENT_X400_PARAMETERS&quot;;</span>
<a href="#l27.1329"></a><span id="l27.1329" class="difflineplus">+  break;</span>
<a href="#l27.1330"></a><span id="l27.1330"> case PR_ATTACH_DATA_OBJ:</span>
<a href="#l27.1331"></a><span id="l27.1331" class="difflineminus">-  s = &quot;PR_ATTACH_DATA_OBJ&quot;; break;</span>
<a href="#l27.1332"></a><span id="l27.1332" class="difflineplus">+  s = &quot;PR_ATTACH_DATA_OBJ&quot;;</span>
<a href="#l27.1333"></a><span id="l27.1333" class="difflineplus">+  break;</span>
<a href="#l27.1334"></a><span id="l27.1334"> case PR_ATTACH_DATA_BIN:</span>
<a href="#l27.1335"></a><span id="l27.1335" class="difflineminus">-  s = &quot;PR_ATTACH_DATA_BIN&quot;; break;</span>
<a href="#l27.1336"></a><span id="l27.1336" class="difflineplus">+  s = &quot;PR_ATTACH_DATA_BIN&quot;;</span>
<a href="#l27.1337"></a><span id="l27.1337" class="difflineplus">+  break;</span>
<a href="#l27.1338"></a><span id="l27.1338"> case PR_ATTACH_ENCODING:</span>
<a href="#l27.1339"></a><span id="l27.1339" class="difflineminus">-  s = &quot;PR_ATTACH_ENCODING&quot;; break;</span>
<a href="#l27.1340"></a><span id="l27.1340" class="difflineplus">+  s = &quot;PR_ATTACH_ENCODING&quot;;</span>
<a href="#l27.1341"></a><span id="l27.1341" class="difflineplus">+  break;</span>
<a href="#l27.1342"></a><span id="l27.1342"> case PR_ATTACH_EXTENSION:</span>
<a href="#l27.1343"></a><span id="l27.1343" class="difflineminus">-  s = &quot;PR_ATTACH_EXTENSION&quot;; break;</span>
<a href="#l27.1344"></a><span id="l27.1344" class="difflineplus">+  s = &quot;PR_ATTACH_EXTENSION&quot;;</span>
<a href="#l27.1345"></a><span id="l27.1345" class="difflineplus">+  break;</span>
<a href="#l27.1346"></a><span id="l27.1346"> case PR_ATTACH_FILENAME:</span>
<a href="#l27.1347"></a><span id="l27.1347" class="difflineminus">-  s = &quot;PR_ATTACH_FILENAME&quot;; break;</span>
<a href="#l27.1348"></a><span id="l27.1348" class="difflineplus">+  s = &quot;PR_ATTACH_FILENAME&quot;;</span>
<a href="#l27.1349"></a><span id="l27.1349" class="difflineplus">+  break;</span>
<a href="#l27.1350"></a><span id="l27.1350"> case PR_ATTACH_METHOD:</span>
<a href="#l27.1351"></a><span id="l27.1351" class="difflineminus">-  s = &quot;PR_ATTACH_METHOD&quot;; break;</span>
<a href="#l27.1352"></a><span id="l27.1352" class="difflineplus">+  s = &quot;PR_ATTACH_METHOD&quot;;</span>
<a href="#l27.1353"></a><span id="l27.1353" class="difflineplus">+  break;</span>
<a href="#l27.1354"></a><span id="l27.1354"> case PR_ATTACH_LONG_FILENAME:</span>
<a href="#l27.1355"></a><span id="l27.1355" class="difflineminus">-  s = &quot;PR_ATTACH_LONG_FILENAME&quot;; break;</span>
<a href="#l27.1356"></a><span id="l27.1356" class="difflineplus">+  s = &quot;PR_ATTACH_LONG_FILENAME&quot;;</span>
<a href="#l27.1357"></a><span id="l27.1357" class="difflineplus">+  break;</span>
<a href="#l27.1358"></a><span id="l27.1358"> case PR_ATTACH_PATHNAME:</span>
<a href="#l27.1359"></a><span id="l27.1359" class="difflineminus">-  s = &quot;PR_ATTACH_PATHNAME&quot;; break;</span>
<a href="#l27.1360"></a><span id="l27.1360" class="difflineplus">+  s = &quot;PR_ATTACH_PATHNAME&quot;;</span>
<a href="#l27.1361"></a><span id="l27.1361" class="difflineplus">+  break;</span>
<a href="#l27.1362"></a><span id="l27.1362"> case PR_ATTACH_RENDERING:</span>
<a href="#l27.1363"></a><span id="l27.1363" class="difflineminus">-  s = &quot;PR_ATTACH_RENDERING&quot;; break;</span>
<a href="#l27.1364"></a><span id="l27.1364" class="difflineplus">+  s = &quot;PR_ATTACH_RENDERING&quot;;</span>
<a href="#l27.1365"></a><span id="l27.1365" class="difflineplus">+  break;</span>
<a href="#l27.1366"></a><span id="l27.1366"> case PR_ATTACH_TAG:</span>
<a href="#l27.1367"></a><span id="l27.1367" class="difflineminus">-  s = &quot;PR_ATTACH_TAG&quot;; break;</span>
<a href="#l27.1368"></a><span id="l27.1368" class="difflineplus">+  s = &quot;PR_ATTACH_TAG&quot;;</span>
<a href="#l27.1369"></a><span id="l27.1369" class="difflineplus">+  break;</span>
<a href="#l27.1370"></a><span id="l27.1370"> case PR_RENDERING_POSITION:</span>
<a href="#l27.1371"></a><span id="l27.1371" class="difflineminus">-  s = &quot;PR_RENDERING_POSITION&quot;; break;</span>
<a href="#l27.1372"></a><span id="l27.1372" class="difflineplus">+  s = &quot;PR_RENDERING_POSITION&quot;;</span>
<a href="#l27.1373"></a><span id="l27.1373" class="difflineplus">+  break;</span>
<a href="#l27.1374"></a><span id="l27.1374"> case PR_ATTACH_TRANSPORT_NAME:</span>
<a href="#l27.1375"></a><span id="l27.1375" class="difflineminus">-  s = &quot;PR_ATTACH_TRANSPORT_NAME&quot;; break;</span>
<a href="#l27.1376"></a><span id="l27.1376" class="difflineplus">+  s = &quot;PR_ATTACH_TRANSPORT_NAME&quot;;</span>
<a href="#l27.1377"></a><span id="l27.1377" class="difflineplus">+  break;</span>
<a href="#l27.1378"></a><span id="l27.1378"> case PR_ATTACH_LONG_PATHNAME:</span>
<a href="#l27.1379"></a><span id="l27.1379" class="difflineminus">-  s = &quot;PR_ATTACH_LONG_PATHNAME&quot;; break;</span>
<a href="#l27.1380"></a><span id="l27.1380" class="difflineplus">+  s = &quot;PR_ATTACH_LONG_PATHNAME&quot;;</span>
<a href="#l27.1381"></a><span id="l27.1381" class="difflineplus">+  break;</span>
<a href="#l27.1382"></a><span id="l27.1382"> case PR_ATTACH_MIME_TAG:</span>
<a href="#l27.1383"></a><span id="l27.1383" class="difflineminus">-  s = &quot;PR_ATTACH_MIME_TAG&quot;; break;</span>
<a href="#l27.1384"></a><span id="l27.1384" class="difflineplus">+  s = &quot;PR_ATTACH_MIME_TAG&quot;;</span>
<a href="#l27.1385"></a><span id="l27.1385" class="difflineplus">+  break;</span>
<a href="#l27.1386"></a><span id="l27.1386"> case PR_ATTACH_ADDITIONAL_INFO:</span>
<a href="#l27.1387"></a><span id="l27.1387" class="difflineminus">-  s = &quot;PR_ATTACH_ADDITIONAL_INFO&quot;; break;</span>
<a href="#l27.1388"></a><span id="l27.1388" class="difflineplus">+  s = &quot;PR_ATTACH_ADDITIONAL_INFO&quot;;</span>
<a href="#l27.1389"></a><span id="l27.1389" class="difflineplus">+  break;</span>
<a href="#l27.1390"></a><span id="l27.1390"> </span>
<a href="#l27.1391"></a><span id="l27.1391" class="difflineminus">-/*</span>
<a href="#l27.1392"></a><span id="l27.1392" class="difflineminus">- *  AB Object properties</span>
<a href="#l27.1393"></a><span id="l27.1393" class="difflineminus">- */</span>
<a href="#l27.1394"></a><span id="l27.1394" class="difflineplus">+  /*</span>
<a href="#l27.1395"></a><span id="l27.1395" class="difflineplus">+   *  AB Object properties</span>
<a href="#l27.1396"></a><span id="l27.1396" class="difflineplus">+   */</span>
<a href="#l27.1397"></a><span id="l27.1397"> </span>
<a href="#l27.1398"></a><span id="l27.1398"> case PR_DISPLAY_TYPE:</span>
<a href="#l27.1399"></a><span id="l27.1399" class="difflineminus">-  s = &quot;PR_DISPLAY_TYPE&quot;; break;</span>
<a href="#l27.1400"></a><span id="l27.1400" class="difflineplus">+  s = &quot;PR_DISPLAY_TYPE&quot;;</span>
<a href="#l27.1401"></a><span id="l27.1401" class="difflineplus">+  break;</span>
<a href="#l27.1402"></a><span id="l27.1402"> case PR_TEMPLATEID:</span>
<a href="#l27.1403"></a><span id="l27.1403" class="difflineminus">-  s = &quot;PR_TEMPLATEID&quot;; break;</span>
<a href="#l27.1404"></a><span id="l27.1404" class="difflineplus">+  s = &quot;PR_TEMPLATEID&quot;;</span>
<a href="#l27.1405"></a><span id="l27.1405" class="difflineplus">+  break;</span>
<a href="#l27.1406"></a><span id="l27.1406"> case PR_PRIMARY_CAPABILITY:</span>
<a href="#l27.1407"></a><span id="l27.1407" class="difflineminus">-  s = &quot;PR_PRIMARY_CAPABILITY&quot;; break;</span>
<a href="#l27.1408"></a><span id="l27.1408" class="difflineminus">-</span>
<a href="#l27.1409"></a><span id="l27.1409" class="difflineplus">+  s = &quot;PR_PRIMARY_CAPABILITY&quot;;</span>
<a href="#l27.1410"></a><span id="l27.1410" class="difflineplus">+  break;</span>
<a href="#l27.1411"></a><span id="l27.1411"> </span>
<a href="#l27.1412"></a><span id="l27.1412"> /*</span>
<a href="#l27.1413"></a><span id="l27.1413">  *  Mail user properties</span>
<a href="#l27.1414"></a><span id="l27.1414">  */</span>
<a href="#l27.1415"></a><span id="l27.1415"> case PR_7BIT_DISPLAY_NAME:</span>
<a href="#l27.1416"></a><span id="l27.1416" class="difflineminus">-  s = &quot;PR_7BIT_DISPLAY_NAME&quot;; break;</span>
<a href="#l27.1417"></a><span id="l27.1417" class="difflineplus">+  s = &quot;PR_7BIT_DISPLAY_NAME&quot;;</span>
<a href="#l27.1418"></a><span id="l27.1418" class="difflineplus">+  break;</span>
<a href="#l27.1419"></a><span id="l27.1419"> case PR_ACCOUNT:</span>
<a href="#l27.1420"></a><span id="l27.1420" class="difflineminus">-  s = &quot;PR_ACCOUNT&quot;; break;</span>
<a href="#l27.1421"></a><span id="l27.1421" class="difflineplus">+  s = &quot;PR_ACCOUNT&quot;;</span>
<a href="#l27.1422"></a><span id="l27.1422" class="difflineplus">+  break;</span>
<a href="#l27.1423"></a><span id="l27.1423"> case PR_ALTERNATE_RECIPIENT:</span>
<a href="#l27.1424"></a><span id="l27.1424" class="difflineminus">-  s = &quot;PR_ALTERNATE_RECIPIENT&quot;; break;</span>
<a href="#l27.1425"></a><span id="l27.1425" class="difflineplus">+  s = &quot;PR_ALTERNATE_RECIPIENT&quot;;</span>
<a href="#l27.1426"></a><span id="l27.1426" class="difflineplus">+  break;</span>
<a href="#l27.1427"></a><span id="l27.1427"> case PR_CALLBACK_TELEPHONE_NUMBER:</span>
<a href="#l27.1428"></a><span id="l27.1428" class="difflineminus">-  s = &quot;PR_CALLBACK_TELEPHONE_NUMBER&quot;; break;</span>
<a href="#l27.1429"></a><span id="l27.1429" class="difflineplus">+  s = &quot;PR_CALLBACK_TELEPHONE_NUMBER&quot;;</span>
<a href="#l27.1430"></a><span id="l27.1430" class="difflineplus">+  break;</span>
<a href="#l27.1431"></a><span id="l27.1431"> case PR_CONVERSION_PROHIBITED:</span>
<a href="#l27.1432"></a><span id="l27.1432" class="difflineminus">-  s = &quot;PR_CONVERSION_PROHIBITED&quot;; break;</span>
<a href="#l27.1433"></a><span id="l27.1433" class="difflineplus">+  s = &quot;PR_CONVERSION_PROHIBITED&quot;;</span>
<a href="#l27.1434"></a><span id="l27.1434" class="difflineplus">+  break;</span>
<a href="#l27.1435"></a><span id="l27.1435"> case PR_DISCLOSE_RECIPIENTS:</span>
<a href="#l27.1436"></a><span id="l27.1436" class="difflineminus">-  s = &quot;PR_DISCLOSE_RECIPIENTS&quot;; break;</span>
<a href="#l27.1437"></a><span id="l27.1437" class="difflineplus">+  s = &quot;PR_DISCLOSE_RECIPIENTS&quot;;</span>
<a href="#l27.1438"></a><span id="l27.1438" class="difflineplus">+  break;</span>
<a href="#l27.1439"></a><span id="l27.1439"> case PR_GENERATION:</span>
<a href="#l27.1440"></a><span id="l27.1440" class="difflineminus">-  s = &quot;PR_GENERATION&quot;; break;</span>
<a href="#l27.1441"></a><span id="l27.1441" class="difflineplus">+  s = &quot;PR_GENERATION&quot;;</span>
<a href="#l27.1442"></a><span id="l27.1442" class="difflineplus">+  break;</span>
<a href="#l27.1443"></a><span id="l27.1443"> case PR_GIVEN_NAME:</span>
<a href="#l27.1444"></a><span id="l27.1444" class="difflineminus">-  s = &quot;PR_GIVEN_NAME&quot;; break;</span>
<a href="#l27.1445"></a><span id="l27.1445" class="difflineplus">+  s = &quot;PR_GIVEN_NAME&quot;;</span>
<a href="#l27.1446"></a><span id="l27.1446" class="difflineplus">+  break;</span>
<a href="#l27.1447"></a><span id="l27.1447"> case PR_GOVERNMENT_ID_NUMBER:</span>
<a href="#l27.1448"></a><span id="l27.1448" class="difflineminus">-  s = &quot;PR_GOVERNMENT_ID_NUMBER&quot;; break;</span>
<a href="#l27.1449"></a><span id="l27.1449" class="difflineplus">+  s = &quot;PR_GOVERNMENT_ID_NUMBER&quot;;</span>
<a href="#l27.1450"></a><span id="l27.1450" class="difflineplus">+  break;</span>
<a href="#l27.1451"></a><span id="l27.1451"> case PR_BUSINESS_TELEPHONE_NUMBER:</span>
<a href="#l27.1452"></a><span id="l27.1452" class="difflineminus">-  s = &quot;PR_BUSINESS_TELEPHONE_NUMBER or PR_OFFICE_TELEPHONE_NUMBER&quot;; break;</span>
<a href="#l27.1453"></a><span id="l27.1453" class="difflineplus">+  s = &quot;PR_BUSINESS_TELEPHONE_NUMBER or PR_OFFICE_TELEPHONE_NUMBER&quot;;</span>
<a href="#l27.1454"></a><span id="l27.1454" class="difflineplus">+  break;</span>
<a href="#l27.1455"></a><span id="l27.1455"> case PR_HOME_TELEPHONE_NUMBER:</span>
<a href="#l27.1456"></a><span id="l27.1456" class="difflineminus">-  s = &quot;PR_HOME_TELEPHONE_NUMBER&quot;; break;</span>
<a href="#l27.1457"></a><span id="l27.1457" class="difflineplus">+  s = &quot;PR_HOME_TELEPHONE_NUMBER&quot;;</span>
<a href="#l27.1458"></a><span id="l27.1458" class="difflineplus">+  break;</span>
<a href="#l27.1459"></a><span id="l27.1459"> case PR_INITIALS:</span>
<a href="#l27.1460"></a><span id="l27.1460" class="difflineminus">-  s = &quot;PR_INITIALS&quot;; break;</span>
<a href="#l27.1461"></a><span id="l27.1461" class="difflineplus">+  s = &quot;PR_INITIALS&quot;;</span>
<a href="#l27.1462"></a><span id="l27.1462" class="difflineplus">+  break;</span>
<a href="#l27.1463"></a><span id="l27.1463"> case PR_KEYWORD:</span>
<a href="#l27.1464"></a><span id="l27.1464" class="difflineminus">-  s = &quot;PR_KEYWORD&quot;; break;</span>
<a href="#l27.1465"></a><span id="l27.1465" class="difflineplus">+  s = &quot;PR_KEYWORD&quot;;</span>
<a href="#l27.1466"></a><span id="l27.1466" class="difflineplus">+  break;</span>
<a href="#l27.1467"></a><span id="l27.1467"> case PR_LANGUAGE:</span>
<a href="#l27.1468"></a><span id="l27.1468" class="difflineminus">-  s = &quot;PR_LANGUAGE&quot;; break;</span>
<a href="#l27.1469"></a><span id="l27.1469" class="difflineplus">+  s = &quot;PR_LANGUAGE&quot;;</span>
<a href="#l27.1470"></a><span id="l27.1470" class="difflineplus">+  break;</span>
<a href="#l27.1471"></a><span id="l27.1471"> case PR_LOCATION:</span>
<a href="#l27.1472"></a><span id="l27.1472" class="difflineminus">-  s = &quot;PR_LOCATION&quot;; break;</span>
<a href="#l27.1473"></a><span id="l27.1473" class="difflineplus">+  s = &quot;PR_LOCATION&quot;;</span>
<a href="#l27.1474"></a><span id="l27.1474" class="difflineplus">+  break;</span>
<a href="#l27.1475"></a><span id="l27.1475"> case PR_MAIL_PERMISSION:</span>
<a href="#l27.1476"></a><span id="l27.1476" class="difflineminus">-  s = &quot;PR_MAIL_PERMISSION&quot;; break;</span>
<a href="#l27.1477"></a><span id="l27.1477" class="difflineplus">+  s = &quot;PR_MAIL_PERMISSION&quot;;</span>
<a href="#l27.1478"></a><span id="l27.1478" class="difflineplus">+  break;</span>
<a href="#l27.1479"></a><span id="l27.1479"> case PR_MHS_COMMON_NAME:</span>
<a href="#l27.1480"></a><span id="l27.1480" class="difflineminus">-  s = &quot;PR_MHS_COMMON_NAME&quot;; break;</span>
<a href="#l27.1481"></a><span id="l27.1481" class="difflineplus">+  s = &quot;PR_MHS_COMMON_NAME&quot;;</span>
<a href="#l27.1482"></a><span id="l27.1482" class="difflineplus">+  break;</span>
<a href="#l27.1483"></a><span id="l27.1483"> case PR_ORGANIZATIONAL_ID_NUMBER:</span>
<a href="#l27.1484"></a><span id="l27.1484" class="difflineminus">-  s = &quot;PR_ORGANIZATIONAL_ID_NUMBER&quot;; break;</span>
<a href="#l27.1485"></a><span id="l27.1485" class="difflineplus">+  s = &quot;PR_ORGANIZATIONAL_ID_NUMBER&quot;;</span>
<a href="#l27.1486"></a><span id="l27.1486" class="difflineplus">+  break;</span>
<a href="#l27.1487"></a><span id="l27.1487"> case PR_SURNAME:</span>
<a href="#l27.1488"></a><span id="l27.1488" class="difflineminus">-  s = &quot;PR_SURNAME&quot;; break;</span>
<a href="#l27.1489"></a><span id="l27.1489" class="difflineplus">+  s = &quot;PR_SURNAME&quot;;</span>
<a href="#l27.1490"></a><span id="l27.1490" class="difflineplus">+  break;</span>
<a href="#l27.1491"></a><span id="l27.1491"> case PR_ORIGINAL_ENTRYID:</span>
<a href="#l27.1492"></a><span id="l27.1492" class="difflineminus">-  s = &quot;PR_ORIGINAL_ENTRYID&quot;; break;</span>
<a href="#l27.1493"></a><span id="l27.1493" class="difflineplus">+  s = &quot;PR_ORIGINAL_ENTRYID&quot;;</span>
<a href="#l27.1494"></a><span id="l27.1494" class="difflineplus">+  break;</span>
<a href="#l27.1495"></a><span id="l27.1495"> case PR_ORIGINAL_DISPLAY_NAME:</span>
<a href="#l27.1496"></a><span id="l27.1496" class="difflineminus">-  s = &quot;PR_ORIGINAL_DISPLAY_NAME&quot;; break;</span>
<a href="#l27.1497"></a><span id="l27.1497" class="difflineplus">+  s = &quot;PR_ORIGINAL_DISPLAY_NAME&quot;;</span>
<a href="#l27.1498"></a><span id="l27.1498" class="difflineplus">+  break;</span>
<a href="#l27.1499"></a><span id="l27.1499"> case PR_ORIGINAL_SEARCH_KEY:</span>
<a href="#l27.1500"></a><span id="l27.1500" class="difflineminus">-  s = &quot;PR_ORIGINAL_SEARCH_KEY&quot;; break;</span>
<a href="#l27.1501"></a><span id="l27.1501" class="difflineplus">+  s = &quot;PR_ORIGINAL_SEARCH_KEY&quot;;</span>
<a href="#l27.1502"></a><span id="l27.1502" class="difflineplus">+  break;</span>
<a href="#l27.1503"></a><span id="l27.1503"> case PR_POSTAL_ADDRESS:</span>
<a href="#l27.1504"></a><span id="l27.1504" class="difflineminus">-  s = &quot;PR_POSTAL_ADDRESS&quot;; break;</span>
<a href="#l27.1505"></a><span id="l27.1505" class="difflineplus">+  s = &quot;PR_POSTAL_ADDRESS&quot;;</span>
<a href="#l27.1506"></a><span id="l27.1506" class="difflineplus">+  break;</span>
<a href="#l27.1507"></a><span id="l27.1507"> case PR_COMPANY_NAME:</span>
<a href="#l27.1508"></a><span id="l27.1508" class="difflineminus">-  s = &quot;PR_COMPANY_NAME&quot;; break;</span>
<a href="#l27.1509"></a><span id="l27.1509" class="difflineplus">+  s = &quot;PR_COMPANY_NAME&quot;;</span>
<a href="#l27.1510"></a><span id="l27.1510" class="difflineplus">+  break;</span>
<a href="#l27.1511"></a><span id="l27.1511"> case PR_TITLE:</span>
<a href="#l27.1512"></a><span id="l27.1512" class="difflineminus">-  s = &quot;PR_TITLE&quot;; break;</span>
<a href="#l27.1513"></a><span id="l27.1513" class="difflineplus">+  s = &quot;PR_TITLE&quot;;</span>
<a href="#l27.1514"></a><span id="l27.1514" class="difflineplus">+  break;</span>
<a href="#l27.1515"></a><span id="l27.1515"> case PR_DEPARTMENT_NAME:</span>
<a href="#l27.1516"></a><span id="l27.1516" class="difflineminus">-  s = &quot;PR_DEPARTMENT_NAME&quot;; break;</span>
<a href="#l27.1517"></a><span id="l27.1517" class="difflineplus">+  s = &quot;PR_DEPARTMENT_NAME&quot;;</span>
<a href="#l27.1518"></a><span id="l27.1518" class="difflineplus">+  break;</span>
<a href="#l27.1519"></a><span id="l27.1519"> case PR_OFFICE_LOCATION:</span>
<a href="#l27.1520"></a><span id="l27.1520" class="difflineminus">-  s = &quot;PR_OFFICE_LOCATION&quot;; break;</span>
<a href="#l27.1521"></a><span id="l27.1521" class="difflineplus">+  s = &quot;PR_OFFICE_LOCATION&quot;;</span>
<a href="#l27.1522"></a><span id="l27.1522" class="difflineplus">+  break;</span>
<a href="#l27.1523"></a><span id="l27.1523"> case PR_PRIMARY_TELEPHONE_NUMBER:</span>
<a href="#l27.1524"></a><span id="l27.1524" class="difflineminus">-  s = &quot;PR_PRIMARY_TELEPHONE_NUMBER&quot;; break;</span>
<a href="#l27.1525"></a><span id="l27.1525" class="difflineplus">+  s = &quot;PR_PRIMARY_TELEPHONE_NUMBER&quot;;</span>
<a href="#l27.1526"></a><span id="l27.1526" class="difflineplus">+  break;</span>
<a href="#l27.1527"></a><span id="l27.1527"> case PR_BUSINESS2_TELEPHONE_NUMBER:</span>
<a href="#l27.1528"></a><span id="l27.1528" class="difflineminus">-  s = &quot;PR_BUSINESS2_TELEPHONE_NUMBER or PR_OFFICE2_TELEPHONE_NUMBER&quot;; break;</span>
<a href="#l27.1529"></a><span id="l27.1529" class="difflineplus">+  s = &quot;PR_BUSINESS2_TELEPHONE_NUMBER or PR_OFFICE2_TELEPHONE_NUMBER&quot;;</span>
<a href="#l27.1530"></a><span id="l27.1530" class="difflineplus">+  break;</span>
<a href="#l27.1531"></a><span id="l27.1531"> case PR_MOBILE_TELEPHONE_NUMBER:</span>
<a href="#l27.1532"></a><span id="l27.1532" class="difflineminus">-  s = &quot;PR_MOBILE_TELEPHONE_NUMBER or PR_CELLULAR_TELEPHONE_NUMBER&quot;; break;</span>
<a href="#l27.1533"></a><span id="l27.1533" class="difflineplus">+  s = &quot;PR_MOBILE_TELEPHONE_NUMBER or PR_CELLULAR_TELEPHONE_NUMBER&quot;;</span>
<a href="#l27.1534"></a><span id="l27.1534" class="difflineplus">+  break;</span>
<a href="#l27.1535"></a><span id="l27.1535"> case PR_RADIO_TELEPHONE_NUMBER:</span>
<a href="#l27.1536"></a><span id="l27.1536" class="difflineminus">-  s = &quot;PR_RADIO_TELEPHONE_NUMBER&quot;; break;</span>
<a href="#l27.1537"></a><span id="l27.1537" class="difflineplus">+  s = &quot;PR_RADIO_TELEPHONE_NUMBER&quot;;</span>
<a href="#l27.1538"></a><span id="l27.1538" class="difflineplus">+  break;</span>
<a href="#l27.1539"></a><span id="l27.1539"> case PR_CAR_TELEPHONE_NUMBER:</span>
<a href="#l27.1540"></a><span id="l27.1540" class="difflineminus">-  s = &quot;PR_CAR_TELEPHONE_NUMBER&quot;; break;</span>
<a href="#l27.1541"></a><span id="l27.1541" class="difflineplus">+  s = &quot;PR_CAR_TELEPHONE_NUMBER&quot;;</span>
<a href="#l27.1542"></a><span id="l27.1542" class="difflineplus">+  break;</span>
<a href="#l27.1543"></a><span id="l27.1543"> case PR_OTHER_TELEPHONE_NUMBER:</span>
<a href="#l27.1544"></a><span id="l27.1544" class="difflineminus">-  s = &quot;PR_OTHER_TELEPHONE_NUMBER&quot;; break;</span>
<a href="#l27.1545"></a><span id="l27.1545" class="difflineplus">+  s = &quot;PR_OTHER_TELEPHONE_NUMBER&quot;;</span>
<a href="#l27.1546"></a><span id="l27.1546" class="difflineplus">+  break;</span>
<a href="#l27.1547"></a><span id="l27.1547"> case PR_TRANSMITABLE_DISPLAY_NAME:</span>
<a href="#l27.1548"></a><span id="l27.1548" class="difflineminus">-  s = &quot;PR_TRANSMITABLE_DISPLAY_NAME&quot;; break;</span>
<a href="#l27.1549"></a><span id="l27.1549" class="difflineplus">+  s = &quot;PR_TRANSMITABLE_DISPLAY_NAME&quot;;</span>
<a href="#l27.1550"></a><span id="l27.1550" class="difflineplus">+  break;</span>
<a href="#l27.1551"></a><span id="l27.1551"> case PR_PAGER_TELEPHONE_NUMBER:</span>
<a href="#l27.1552"></a><span id="l27.1552" class="difflineminus">-  s = &quot;PR_PAGER_TELEPHONE_NUMBER or PR_BEEPER_TELEPHONE_NUMBER&quot;; break;</span>
<a href="#l27.1553"></a><span id="l27.1553" class="difflineplus">+  s = &quot;PR_PAGER_TELEPHONE_NUMBER or PR_BEEPER_TELEPHONE_NUMBER&quot;;</span>
<a href="#l27.1554"></a><span id="l27.1554" class="difflineplus">+  break;</span>
<a href="#l27.1555"></a><span id="l27.1555"> case PR_USER_CERTIFICATE:</span>
<a href="#l27.1556"></a><span id="l27.1556" class="difflineminus">-  s = &quot;PR_USER_CERTIFICATE&quot;; break;</span>
<a href="#l27.1557"></a><span id="l27.1557" class="difflineplus">+  s = &quot;PR_USER_CERTIFICATE&quot;;</span>
<a href="#l27.1558"></a><span id="l27.1558" class="difflineplus">+  break;</span>
<a href="#l27.1559"></a><span id="l27.1559"> case PR_PRIMARY_FAX_NUMBER:</span>
<a href="#l27.1560"></a><span id="l27.1560" class="difflineminus">-  s = &quot;PR_PRIMARY_FAX_NUMBER&quot;; break;</span>
<a href="#l27.1561"></a><span id="l27.1561" class="difflineplus">+  s = &quot;PR_PRIMARY_FAX_NUMBER&quot;;</span>
<a href="#l27.1562"></a><span id="l27.1562" class="difflineplus">+  break;</span>
<a href="#l27.1563"></a><span id="l27.1563"> case PR_BUSINESS_FAX_NUMBER:</span>
<a href="#l27.1564"></a><span id="l27.1564" class="difflineminus">-  s = &quot;PR_BUSINESS_FAX_NUMBER&quot;; break;</span>
<a href="#l27.1565"></a><span id="l27.1565" class="difflineplus">+  s = &quot;PR_BUSINESS_FAX_NUMBER&quot;;</span>
<a href="#l27.1566"></a><span id="l27.1566" class="difflineplus">+  break;</span>
<a href="#l27.1567"></a><span id="l27.1567"> case PR_HOME_FAX_NUMBER:</span>
<a href="#l27.1568"></a><span id="l27.1568" class="difflineminus">-  s = &quot;PR_HOME_FAX_NUMBER&quot;; break;</span>
<a href="#l27.1569"></a><span id="l27.1569" class="difflineplus">+  s = &quot;PR_HOME_FAX_NUMBER&quot;;</span>
<a href="#l27.1570"></a><span id="l27.1570" class="difflineplus">+  break;</span>
<a href="#l27.1571"></a><span id="l27.1571"> case PR_COUNTRY:</span>
<a href="#l27.1572"></a><span id="l27.1572" class="difflineminus">-  s = &quot;PR_COUNTRY or PR_BUSINESS_ADDRESS_COUNTRY&quot;; break;</span>
<a href="#l27.1573"></a><span id="l27.1573" class="difflineplus">+  s = &quot;PR_COUNTRY or PR_BUSINESS_ADDRESS_COUNTRY&quot;;</span>
<a href="#l27.1574"></a><span id="l27.1574" class="difflineplus">+  break;</span>
<a href="#l27.1575"></a><span id="l27.1575"> </span>
<a href="#l27.1576"></a><span id="l27.1576"> case PR_LOCALITY:</span>
<a href="#l27.1577"></a><span id="l27.1577" class="difflineminus">-  s = &quot;PR_LOCALITY or PR_BUSINESS_ADDRESS_CITY&quot;; break;</span>
<a href="#l27.1578"></a><span id="l27.1578" class="difflineplus">+  s = &quot;PR_LOCALITY or PR_BUSINESS_ADDRESS_CITY&quot;;</span>
<a href="#l27.1579"></a><span id="l27.1579" class="difflineplus">+  break;</span>
<a href="#l27.1580"></a><span id="l27.1580"> </span>
<a href="#l27.1581"></a><span id="l27.1581"> case PR_STATE_OR_PROVINCE:</span>
<a href="#l27.1582"></a><span id="l27.1582" class="difflineminus">-  s = &quot;PR_STATE_OR_PROVINCE or PR_BUSINESS_ADDRESS_STATE_OR_PROVINCE&quot;; break;</span>
<a href="#l27.1583"></a><span id="l27.1583" class="difflineplus">+  s = &quot;PR_STATE_OR_PROVINCE or PR_BUSINESS_ADDRESS_STATE_OR_PROVINCE&quot;;</span>
<a href="#l27.1584"></a><span id="l27.1584" class="difflineplus">+  break;</span>
<a href="#l27.1585"></a><span id="l27.1585"> </span>
<a href="#l27.1586"></a><span id="l27.1586"> case PR_STREET_ADDRESS:</span>
<a href="#l27.1587"></a><span id="l27.1587" class="difflineminus">-  s = &quot;PR_STREET_ADDRESS or PR_BUSINESS_ADDRESS_STREET&quot;; break;</span>
<a href="#l27.1588"></a><span id="l27.1588" class="difflineplus">+  s = &quot;PR_STREET_ADDRESS or PR_BUSINESS_ADDRESS_STREET&quot;;</span>
<a href="#l27.1589"></a><span id="l27.1589" class="difflineplus">+  break;</span>
<a href="#l27.1590"></a><span id="l27.1590"> </span>
<a href="#l27.1591"></a><span id="l27.1591"> case PR_POSTAL_CODE:</span>
<a href="#l27.1592"></a><span id="l27.1592" class="difflineminus">-  s = &quot;PR_POSTAL_CODE or PR_BUSINESS_ADDRESS_POSTAL_CODE&quot;; break;</span>
<a href="#l27.1593"></a><span id="l27.1593" class="difflineminus">-</span>
<a href="#l27.1594"></a><span id="l27.1594" class="difflineplus">+  s = &quot;PR_POSTAL_CODE or PR_BUSINESS_ADDRESS_POSTAL_CODE&quot;;</span>
<a href="#l27.1595"></a><span id="l27.1595" class="difflineplus">+  break;</span>
<a href="#l27.1596"></a><span id="l27.1596"> </span>
<a href="#l27.1597"></a><span id="l27.1597"> case PR_POST_OFFICE_BOX:</span>
<a href="#l27.1598"></a><span id="l27.1598" class="difflineminus">-  s = &quot;PR_POST_OFFICE_BOX or PR_BUSINESS_ADDRESS_POST_OFFICE_BOX&quot;; break;</span>
<a href="#l27.1599"></a><span id="l27.1599" class="difflineminus">-</span>
<a href="#l27.1600"></a><span id="l27.1600" class="difflineplus">+  s = &quot;PR_POST_OFFICE_BOX or PR_BUSINESS_ADDRESS_POST_OFFICE_BOX&quot;;</span>
<a href="#l27.1601"></a><span id="l27.1601" class="difflineplus">+  break;</span>
<a href="#l27.1602"></a><span id="l27.1602"> </span>
<a href="#l27.1603"></a><span id="l27.1603"> case PR_TELEX_NUMBER:</span>
<a href="#l27.1604"></a><span id="l27.1604" class="difflineminus">-  s = &quot;PR_TELEX_NUMBER&quot;; break;</span>
<a href="#l27.1605"></a><span id="l27.1605" class="difflineplus">+  s = &quot;PR_TELEX_NUMBER&quot;;</span>
<a href="#l27.1606"></a><span id="l27.1606" class="difflineplus">+  break;</span>
<a href="#l27.1607"></a><span id="l27.1607"> case PR_ISDN_NUMBER:</span>
<a href="#l27.1608"></a><span id="l27.1608" class="difflineminus">-  s = &quot;PR_ISDN_NUMBER&quot;; break;</span>
<a href="#l27.1609"></a><span id="l27.1609" class="difflineplus">+  s = &quot;PR_ISDN_NUMBER&quot;;</span>
<a href="#l27.1610"></a><span id="l27.1610" class="difflineplus">+  break;</span>
<a href="#l27.1611"></a><span id="l27.1611"> case PR_ASSISTANT_TELEPHONE_NUMBER:</span>
<a href="#l27.1612"></a><span id="l27.1612" class="difflineminus">-  s = &quot;PR_ASSISTANT_TELEPHONE_NUMBER&quot;; break;</span>
<a href="#l27.1613"></a><span id="l27.1613" class="difflineplus">+  s = &quot;PR_ASSISTANT_TELEPHONE_NUMBER&quot;;</span>
<a href="#l27.1614"></a><span id="l27.1614" class="difflineplus">+  break;</span>
<a href="#l27.1615"></a><span id="l27.1615"> case PR_HOME2_TELEPHONE_NUMBER:</span>
<a href="#l27.1616"></a><span id="l27.1616" class="difflineminus">-  s = &quot;PR_HOME2_TELEPHONE_NUMBER&quot;; break;</span>
<a href="#l27.1617"></a><span id="l27.1617" class="difflineplus">+  s = &quot;PR_HOME2_TELEPHONE_NUMBER&quot;;</span>
<a href="#l27.1618"></a><span id="l27.1618" class="difflineplus">+  break;</span>
<a href="#l27.1619"></a><span id="l27.1619"> case PR_ASSISTANT:</span>
<a href="#l27.1620"></a><span id="l27.1620" class="difflineminus">-  s = &quot;PR_ASSISTANT&quot;; break;</span>
<a href="#l27.1621"></a><span id="l27.1621" class="difflineplus">+  s = &quot;PR_ASSISTANT&quot;;</span>
<a href="#l27.1622"></a><span id="l27.1622" class="difflineplus">+  break;</span>
<a href="#l27.1623"></a><span id="l27.1623"> case PR_SEND_RICH_INFO:</span>
<a href="#l27.1624"></a><span id="l27.1624" class="difflineminus">-  s = &quot;PR_SEND_RICH_INFO&quot;; break;</span>
<a href="#l27.1625"></a><span id="l27.1625" class="difflineplus">+  s = &quot;PR_SEND_RICH_INFO&quot;;</span>
<a href="#l27.1626"></a><span id="l27.1626" class="difflineplus">+  break;</span>
<a href="#l27.1627"></a><span id="l27.1627"> </span>
<a href="#l27.1628"></a><span id="l27.1628"> case PR_WEDDING_ANNIVERSARY:</span>
<a href="#l27.1629"></a><span id="l27.1629" class="difflineminus">-  s = &quot;PR_WEDDING_ANNIVERSARY&quot;; break;</span>
<a href="#l27.1630"></a><span id="l27.1630" class="difflineplus">+  s = &quot;PR_WEDDING_ANNIVERSARY&quot;;</span>
<a href="#l27.1631"></a><span id="l27.1631" class="difflineplus">+  break;</span>
<a href="#l27.1632"></a><span id="l27.1632"> case PR_BIRTHDAY:</span>
<a href="#l27.1633"></a><span id="l27.1633" class="difflineminus">-  s = &quot;PR_BIRTHDAY&quot;; break;</span>
<a href="#l27.1634"></a><span id="l27.1634" class="difflineminus">-</span>
<a href="#l27.1635"></a><span id="l27.1635" class="difflineplus">+  s = &quot;PR_BIRTHDAY&quot;;</span>
<a href="#l27.1636"></a><span id="l27.1636" class="difflineplus">+  break;</span>
<a href="#l27.1637"></a><span id="l27.1637"> </span>
<a href="#l27.1638"></a><span id="l27.1638"> case PR_HOBBIES:</span>
<a href="#l27.1639"></a><span id="l27.1639" class="difflineminus">-  s = &quot;PR_HOBBIES&quot;; break;</span>
<a href="#l27.1640"></a><span id="l27.1640" class="difflineplus">+  s = &quot;PR_HOBBIES&quot;;</span>
<a href="#l27.1641"></a><span id="l27.1641" class="difflineplus">+  break;</span>
<a href="#l27.1642"></a><span id="l27.1642"> </span>
<a href="#l27.1643"></a><span id="l27.1643"> case PR_MIDDLE_NAME:</span>
<a href="#l27.1644"></a><span id="l27.1644" class="difflineminus">-  s = &quot;PR_MIDDLE_NAME&quot;; break;</span>
<a href="#l27.1645"></a><span id="l27.1645" class="difflineplus">+  s = &quot;PR_MIDDLE_NAME&quot;;</span>
<a href="#l27.1646"></a><span id="l27.1646" class="difflineplus">+  break;</span>
<a href="#l27.1647"></a><span id="l27.1647"> </span>
<a href="#l27.1648"></a><span id="l27.1648"> case PR_DISPLAY_NAME_PREFIX:</span>
<a href="#l27.1649"></a><span id="l27.1649" class="difflineminus">-  s = &quot;PR_DISPLAY_NAME_PREFIX&quot;; break;</span>
<a href="#l27.1650"></a><span id="l27.1650" class="difflineplus">+  s = &quot;PR_DISPLAY_NAME_PREFIX&quot;;</span>
<a href="#l27.1651"></a><span id="l27.1651" class="difflineplus">+  break;</span>
<a href="#l27.1652"></a><span id="l27.1652"> </span>
<a href="#l27.1653"></a><span id="l27.1653"> case PR_PROFESSION:</span>
<a href="#l27.1654"></a><span id="l27.1654" class="difflineminus">-  s = &quot;PR_PROFESSION&quot;; break;</span>
<a href="#l27.1655"></a><span id="l27.1655" class="difflineplus">+  s = &quot;PR_PROFESSION&quot;;</span>
<a href="#l27.1656"></a><span id="l27.1656" class="difflineplus">+  break;</span>
<a href="#l27.1657"></a><span id="l27.1657"> </span>
<a href="#l27.1658"></a><span id="l27.1658"> case PR_PREFERRED_BY_NAME:</span>
<a href="#l27.1659"></a><span id="l27.1659" class="difflineminus">-  s = &quot;PR_PREFERRED_BY_NAME&quot;; break;</span>
<a href="#l27.1660"></a><span id="l27.1660" class="difflineplus">+  s = &quot;PR_PREFERRED_BY_NAME&quot;;</span>
<a href="#l27.1661"></a><span id="l27.1661" class="difflineplus">+  break;</span>
<a href="#l27.1662"></a><span id="l27.1662"> </span>
<a href="#l27.1663"></a><span id="l27.1663"> case PR_SPOUSE_NAME:</span>
<a href="#l27.1664"></a><span id="l27.1664" class="difflineminus">-  s = &quot;PR_SPOUSE_NAME&quot;; break;</span>
<a href="#l27.1665"></a><span id="l27.1665" class="difflineplus">+  s = &quot;PR_SPOUSE_NAME&quot;;</span>
<a href="#l27.1666"></a><span id="l27.1666" class="difflineplus">+  break;</span>
<a href="#l27.1667"></a><span id="l27.1667"> </span>
<a href="#l27.1668"></a><span id="l27.1668"> case PR_COMPUTER_NETWORK_NAME:</span>
<a href="#l27.1669"></a><span id="l27.1669" class="difflineminus">-  s = &quot;PR_COMPUTER_NETWORK_NAME&quot;; break;</span>
<a href="#l27.1670"></a><span id="l27.1670" class="difflineplus">+  s = &quot;PR_COMPUTER_NETWORK_NAME&quot;;</span>
<a href="#l27.1671"></a><span id="l27.1671" class="difflineplus">+  break;</span>
<a href="#l27.1672"></a><span id="l27.1672"> </span>
<a href="#l27.1673"></a><span id="l27.1673"> case PR_CUSTOMER_ID:</span>
<a href="#l27.1674"></a><span id="l27.1674" class="difflineminus">-  s = &quot;PR_CUSTOMER_ID&quot;; break;</span>
<a href="#l27.1675"></a><span id="l27.1675" class="difflineplus">+  s = &quot;PR_CUSTOMER_ID&quot;;</span>
<a href="#l27.1676"></a><span id="l27.1676" class="difflineplus">+  break;</span>
<a href="#l27.1677"></a><span id="l27.1677"> </span>
<a href="#l27.1678"></a><span id="l27.1678"> case PR_TTYTDD_PHONE_NUMBER:</span>
<a href="#l27.1679"></a><span id="l27.1679" class="difflineminus">-  s = &quot;PR_TTYTDD_PHONE_NUMBER&quot;; break;</span>
<a href="#l27.1680"></a><span id="l27.1680" class="difflineplus">+  s = &quot;PR_TTYTDD_PHONE_NUMBER&quot;;</span>
<a href="#l27.1681"></a><span id="l27.1681" class="difflineplus">+  break;</span>
<a href="#l27.1682"></a><span id="l27.1682"> </span>
<a href="#l27.1683"></a><span id="l27.1683"> case PR_FTP_SITE:</span>
<a href="#l27.1684"></a><span id="l27.1684" class="difflineminus">-  s = &quot;PR_FTP_SITE&quot;; break;</span>
<a href="#l27.1685"></a><span id="l27.1685" class="difflineplus">+  s = &quot;PR_FTP_SITE&quot;;</span>
<a href="#l27.1686"></a><span id="l27.1686" class="difflineplus">+  break;</span>
<a href="#l27.1687"></a><span id="l27.1687"> </span>
<a href="#l27.1688"></a><span id="l27.1688"> case PR_GENDER:</span>
<a href="#l27.1689"></a><span id="l27.1689" class="difflineminus">-  s = &quot;PR_GENDER&quot;; break;</span>
<a href="#l27.1690"></a><span id="l27.1690" class="difflineplus">+  s = &quot;PR_GENDER&quot;;</span>
<a href="#l27.1691"></a><span id="l27.1691" class="difflineplus">+  break;</span>
<a href="#l27.1692"></a><span id="l27.1692"> </span>
<a href="#l27.1693"></a><span id="l27.1693"> case PR_MANAGER_NAME:</span>
<a href="#l27.1694"></a><span id="l27.1694" class="difflineminus">-  s = &quot;PR_MANAGER_NAME&quot;; break;</span>
<a href="#l27.1695"></a><span id="l27.1695" class="difflineplus">+  s = &quot;PR_MANAGER_NAME&quot;;</span>
<a href="#l27.1696"></a><span id="l27.1696" class="difflineplus">+  break;</span>
<a href="#l27.1697"></a><span id="l27.1697"> </span>
<a href="#l27.1698"></a><span id="l27.1698"> case PR_NICKNAME:</span>
<a href="#l27.1699"></a><span id="l27.1699" class="difflineminus">-  s = &quot;PR_NICKNAME&quot;; break;</span>
<a href="#l27.1700"></a><span id="l27.1700" class="difflineplus">+  s = &quot;PR_NICKNAME&quot;;</span>
<a href="#l27.1701"></a><span id="l27.1701" class="difflineplus">+  break;</span>
<a href="#l27.1702"></a><span id="l27.1702"> </span>
<a href="#l27.1703"></a><span id="l27.1703"> case PR_PERSONAL_HOME_PAGE:</span>
<a href="#l27.1704"></a><span id="l27.1704" class="difflineminus">-  s = &quot;PR_PERSONAL_HOME_PAGE&quot;; break;</span>
<a href="#l27.1705"></a><span id="l27.1705" class="difflineminus">-</span>
<a href="#l27.1706"></a><span id="l27.1706" class="difflineplus">+  s = &quot;PR_PERSONAL_HOME_PAGE&quot;;</span>
<a href="#l27.1707"></a><span id="l27.1707" class="difflineplus">+  break;</span>
<a href="#l27.1708"></a><span id="l27.1708"> </span>
<a href="#l27.1709"></a><span id="l27.1709"> case PR_BUSINESS_HOME_PAGE:</span>
<a href="#l27.1710"></a><span id="l27.1710" class="difflineminus">-  s = &quot;PR_BUSINESS_HOME_PAGE&quot;; break;</span>
<a href="#l27.1711"></a><span id="l27.1711" class="difflineplus">+  s = &quot;PR_BUSINESS_HOME_PAGE&quot;;</span>
<a href="#l27.1712"></a><span id="l27.1712" class="difflineplus">+  break;</span>
<a href="#l27.1713"></a><span id="l27.1713"> </span>
<a href="#l27.1714"></a><span id="l27.1714"> case PR_CONTACT_VERSION:</span>
<a href="#l27.1715"></a><span id="l27.1715" class="difflineminus">-  s = &quot;PR_CONTACT_VERSION&quot;; break;</span>
<a href="#l27.1716"></a><span id="l27.1716" class="difflineplus">+  s = &quot;PR_CONTACT_VERSION&quot;;</span>
<a href="#l27.1717"></a><span id="l27.1717" class="difflineplus">+  break;</span>
<a href="#l27.1718"></a><span id="l27.1718"> case PR_CONTACT_ENTRYIDS:</span>
<a href="#l27.1719"></a><span id="l27.1719" class="difflineminus">-  s = &quot;PR_CONTACT_ENTRYIDS&quot;; break;</span>
<a href="#l27.1720"></a><span id="l27.1720" class="difflineplus">+  s = &quot;PR_CONTACT_ENTRYIDS&quot;;</span>
<a href="#l27.1721"></a><span id="l27.1721" class="difflineplus">+  break;</span>
<a href="#l27.1722"></a><span id="l27.1722"> </span>
<a href="#l27.1723"></a><span id="l27.1723"> case PR_CONTACT_ADDRTYPES:</span>
<a href="#l27.1724"></a><span id="l27.1724" class="difflineminus">-  s = &quot;PR_CONTACT_ADDRTYPES&quot;; break;</span>
<a href="#l27.1725"></a><span id="l27.1725" class="difflineplus">+  s = &quot;PR_CONTACT_ADDRTYPES&quot;;</span>
<a href="#l27.1726"></a><span id="l27.1726" class="difflineplus">+  break;</span>
<a href="#l27.1727"></a><span id="l27.1727"> </span>
<a href="#l27.1728"></a><span id="l27.1728"> case PR_CONTACT_DEFAULT_ADDRESS_INDEX:</span>
<a href="#l27.1729"></a><span id="l27.1729" class="difflineminus">-  s = &quot;PR_CONTACT_DEFAULT_ADDRESS_INDEX&quot;; break;</span>
<a href="#l27.1730"></a><span id="l27.1730" class="difflineplus">+  s = &quot;PR_CONTACT_DEFAULT_ADDRESS_INDEX&quot;;</span>
<a href="#l27.1731"></a><span id="l27.1731" class="difflineplus">+  break;</span>
<a href="#l27.1732"></a><span id="l27.1732"> </span>
<a href="#l27.1733"></a><span id="l27.1733"> case PR_CONTACT_EMAIL_ADDRESSES:</span>
<a href="#l27.1734"></a><span id="l27.1734" class="difflineminus">-  s = &quot;PR_CONTACT_EMAIL_ADDRESSES&quot;; break;</span>
<a href="#l27.1735"></a><span id="l27.1735" class="difflineminus">-</span>
<a href="#l27.1736"></a><span id="l27.1736" class="difflineplus">+  s = &quot;PR_CONTACT_EMAIL_ADDRESSES&quot;;</span>
<a href="#l27.1737"></a><span id="l27.1737" class="difflineplus">+  break;</span>
<a href="#l27.1738"></a><span id="l27.1738"> </span>
<a href="#l27.1739"></a><span id="l27.1739"> case PR_COMPANY_MAIN_PHONE_NUMBER:</span>
<a href="#l27.1740"></a><span id="l27.1740" class="difflineminus">-  s = &quot;PR_COMPANY_MAIN_PHONE_NUMBER&quot;; break;</span>
<a href="#l27.1741"></a><span id="l27.1741" class="difflineplus">+  s = &quot;PR_COMPANY_MAIN_PHONE_NUMBER&quot;;</span>
<a href="#l27.1742"></a><span id="l27.1742" class="difflineplus">+  break;</span>
<a href="#l27.1743"></a><span id="l27.1743"> </span>
<a href="#l27.1744"></a><span id="l27.1744"> case PR_CHILDRENS_NAMES:</span>
<a href="#l27.1745"></a><span id="l27.1745" class="difflineminus">-  s = &quot;PR_CHILDRENS_NAMES&quot;; break;</span>
<a href="#l27.1746"></a><span id="l27.1746" class="difflineminus">-</span>
<a href="#l27.1747"></a><span id="l27.1747" class="difflineminus">-</span>
<a href="#l27.1748"></a><span id="l27.1748" class="difflineplus">+  s = &quot;PR_CHILDRENS_NAMES&quot;;</span>
<a href="#l27.1749"></a><span id="l27.1749" class="difflineplus">+  break;</span>
<a href="#l27.1750"></a><span id="l27.1750"> </span>
<a href="#l27.1751"></a><span id="l27.1751"> case PR_HOME_ADDRESS_CITY:</span>
<a href="#l27.1752"></a><span id="l27.1752" class="difflineminus">-  s = &quot;PR_HOME_ADDRESS_CITY&quot;; break;</span>
<a href="#l27.1753"></a><span id="l27.1753" class="difflineplus">+  s = &quot;PR_HOME_ADDRESS_CITY&quot;;</span>
<a href="#l27.1754"></a><span id="l27.1754" class="difflineplus">+  break;</span>
<a href="#l27.1755"></a><span id="l27.1755"> </span>
<a href="#l27.1756"></a><span id="l27.1756"> case PR_HOME_ADDRESS_COUNTRY:</span>
<a href="#l27.1757"></a><span id="l27.1757" class="difflineminus">-  s = &quot;PR_HOME_ADDRESS_COUNTRY&quot;; break;</span>
<a href="#l27.1758"></a><span id="l27.1758" class="difflineplus">+  s = &quot;PR_HOME_ADDRESS_COUNTRY&quot;;</span>
<a href="#l27.1759"></a><span id="l27.1759" class="difflineplus">+  break;</span>
<a href="#l27.1760"></a><span id="l27.1760"> </span>
<a href="#l27.1761"></a><span id="l27.1761"> case PR_HOME_ADDRESS_POSTAL_CODE:</span>
<a href="#l27.1762"></a><span id="l27.1762" class="difflineminus">-  s = &quot;PR_HOME_ADDRESS_POSTAL_CODE&quot;; break;</span>
<a href="#l27.1763"></a><span id="l27.1763" class="difflineplus">+  s = &quot;PR_HOME_ADDRESS_POSTAL_CODE&quot;;</span>
<a href="#l27.1764"></a><span id="l27.1764" class="difflineplus">+  break;</span>
<a href="#l27.1765"></a><span id="l27.1765"> </span>
<a href="#l27.1766"></a><span id="l27.1766"> case PR_HOME_ADDRESS_STATE_OR_PROVINCE:</span>
<a href="#l27.1767"></a><span id="l27.1767" class="difflineminus">-  s = &quot;PR_HOME_ADDRESS_STATE_OR_PROVINCE&quot;; break;</span>
<a href="#l27.1768"></a><span id="l27.1768" class="difflineplus">+  s = &quot;PR_HOME_ADDRESS_STATE_OR_PROVINCE&quot;;</span>
<a href="#l27.1769"></a><span id="l27.1769" class="difflineplus">+  break;</span>
<a href="#l27.1770"></a><span id="l27.1770"> </span>
<a href="#l27.1771"></a><span id="l27.1771"> case PR_HOME_ADDRESS_STREET:</span>
<a href="#l27.1772"></a><span id="l27.1772" class="difflineminus">-  s = &quot;PR_HOME_ADDRESS_STREET&quot;; break;</span>
<a href="#l27.1773"></a><span id="l27.1773" class="difflineplus">+  s = &quot;PR_HOME_ADDRESS_STREET&quot;;</span>
<a href="#l27.1774"></a><span id="l27.1774" class="difflineplus">+  break;</span>
<a href="#l27.1775"></a><span id="l27.1775"> </span>
<a href="#l27.1776"></a><span id="l27.1776"> case PR_HOME_ADDRESS_POST_OFFICE_BOX:</span>
<a href="#l27.1777"></a><span id="l27.1777" class="difflineminus">-  s = &quot;PR_HOME_ADDRESS_POST_OFFICE_BOX&quot;; break;</span>
<a href="#l27.1778"></a><span id="l27.1778" class="difflineplus">+  s = &quot;PR_HOME_ADDRESS_POST_OFFICE_BOX&quot;;</span>
<a href="#l27.1779"></a><span id="l27.1779" class="difflineplus">+  break;</span>
<a href="#l27.1780"></a><span id="l27.1780"> </span>
<a href="#l27.1781"></a><span id="l27.1781"> case PR_OTHER_ADDRESS_CITY:</span>
<a href="#l27.1782"></a><span id="l27.1782" class="difflineminus">-  s = &quot;PR_OTHER_ADDRESS_CITY&quot;; break;</span>
<a href="#l27.1783"></a><span id="l27.1783" class="difflineplus">+  s = &quot;PR_OTHER_ADDRESS_CITY&quot;;</span>
<a href="#l27.1784"></a><span id="l27.1784" class="difflineplus">+  break;</span>
<a href="#l27.1785"></a><span id="l27.1785"> </span>
<a href="#l27.1786"></a><span id="l27.1786"> case PR_OTHER_ADDRESS_COUNTRY:</span>
<a href="#l27.1787"></a><span id="l27.1787" class="difflineminus">-  s = &quot;PR_OTHER_ADDRESS_COUNTRY&quot;; break;</span>
<a href="#l27.1788"></a><span id="l27.1788" class="difflineplus">+  s = &quot;PR_OTHER_ADDRESS_COUNTRY&quot;;</span>
<a href="#l27.1789"></a><span id="l27.1789" class="difflineplus">+  break;</span>
<a href="#l27.1790"></a><span id="l27.1790"> </span>
<a href="#l27.1791"></a><span id="l27.1791"> case PR_OTHER_ADDRESS_POSTAL_CODE:</span>
<a href="#l27.1792"></a><span id="l27.1792" class="difflineminus">-  s = &quot;PR_OTHER_ADDRESS_POSTAL_CODE&quot;; break;</span>
<a href="#l27.1793"></a><span id="l27.1793" class="difflineplus">+  s = &quot;PR_OTHER_ADDRESS_POSTAL_CODE&quot;;</span>
<a href="#l27.1794"></a><span id="l27.1794" class="difflineplus">+  break;</span>
<a href="#l27.1795"></a><span id="l27.1795"> </span>
<a href="#l27.1796"></a><span id="l27.1796"> case PR_OTHER_ADDRESS_STATE_OR_PROVINCE:</span>
<a href="#l27.1797"></a><span id="l27.1797" class="difflineminus">-  s = &quot;PR_OTHER_ADDRESS_STATE_OR_PROVINCE&quot;; break;</span>
<a href="#l27.1798"></a><span id="l27.1798" class="difflineplus">+  s = &quot;PR_OTHER_ADDRESS_STATE_OR_PROVINCE&quot;;</span>
<a href="#l27.1799"></a><span id="l27.1799" class="difflineplus">+  break;</span>
<a href="#l27.1800"></a><span id="l27.1800"> </span>
<a href="#l27.1801"></a><span id="l27.1801"> case PR_OTHER_ADDRESS_STREET:</span>
<a href="#l27.1802"></a><span id="l27.1802" class="difflineminus">-  s = &quot;PR_OTHER_ADDRESS_STREET&quot;; break;</span>
<a href="#l27.1803"></a><span id="l27.1803" class="difflineplus">+  s = &quot;PR_OTHER_ADDRESS_STREET&quot;;</span>
<a href="#l27.1804"></a><span id="l27.1804" class="difflineplus">+  break;</span>
<a href="#l27.1805"></a><span id="l27.1805"> </span>
<a href="#l27.1806"></a><span id="l27.1806"> case PR_OTHER_ADDRESS_POST_OFFICE_BOX:</span>
<a href="#l27.1807"></a><span id="l27.1807" class="difflineminus">-  s = &quot;PR_OTHER_ADDRESS_POST_OFFICE_BOX&quot;; break;</span>
<a href="#l27.1808"></a><span id="l27.1808" class="difflineminus">-</span>
<a href="#l27.1809"></a><span id="l27.1809" class="difflineplus">+  s = &quot;PR_OTHER_ADDRESS_POST_OFFICE_BOX&quot;;</span>
<a href="#l27.1810"></a><span id="l27.1810" class="difflineplus">+  break;</span>
<a href="#l27.1811"></a><span id="l27.1811"> </span>
<a href="#l27.1812"></a><span id="l27.1812" class="difflineminus">-/*</span>
<a href="#l27.1813"></a><span id="l27.1813" class="difflineminus">- *  Profile section properties</span>
<a href="#l27.1814"></a><span id="l27.1814" class="difflineminus">- */</span>
<a href="#l27.1815"></a><span id="l27.1815" class="difflineplus">+  /*</span>
<a href="#l27.1816"></a><span id="l27.1816" class="difflineplus">+   *  Profile section properties</span>
<a href="#l27.1817"></a><span id="l27.1817" class="difflineplus">+   */</span>
<a href="#l27.1818"></a><span id="l27.1818"> </span>
<a href="#l27.1819"></a><span id="l27.1819"> case PR_STORE_PROVIDERS:</span>
<a href="#l27.1820"></a><span id="l27.1820" class="difflineminus">-  s = &quot;PR_STORE_PROVIDERS&quot;; break;</span>
<a href="#l27.1821"></a><span id="l27.1821" class="difflineplus">+  s = &quot;PR_STORE_PROVIDERS&quot;;</span>
<a href="#l27.1822"></a><span id="l27.1822" class="difflineplus">+  break;</span>
<a href="#l27.1823"></a><span id="l27.1823"> case PR_AB_PROVIDERS:</span>
<a href="#l27.1824"></a><span id="l27.1824" class="difflineminus">-  s = &quot;PR_AB_PROVIDERS&quot;; break;</span>
<a href="#l27.1825"></a><span id="l27.1825" class="difflineplus">+  s = &quot;PR_AB_PROVIDERS&quot;;</span>
<a href="#l27.1826"></a><span id="l27.1826" class="difflineplus">+  break;</span>
<a href="#l27.1827"></a><span id="l27.1827"> case PR_TRANSPORT_PROVIDERS:</span>
<a href="#l27.1828"></a><span id="l27.1828" class="difflineminus">-  s = &quot;PR_TRANSPORT_PROVIDERS&quot;; break;</span>
<a href="#l27.1829"></a><span id="l27.1829" class="difflineplus">+  s = &quot;PR_TRANSPORT_PROVIDERS&quot;;</span>
<a href="#l27.1830"></a><span id="l27.1830" class="difflineplus">+  break;</span>
<a href="#l27.1831"></a><span id="l27.1831"> </span>
<a href="#l27.1832"></a><span id="l27.1832"> case PR_DEFAULT_PROFILE:</span>
<a href="#l27.1833"></a><span id="l27.1833" class="difflineminus">-  s = &quot;PR_DEFAULT_PROFILE&quot;; break;</span>
<a href="#l27.1834"></a><span id="l27.1834" class="difflineplus">+  s = &quot;PR_DEFAULT_PROFILE&quot;;</span>
<a href="#l27.1835"></a><span id="l27.1835" class="difflineplus">+  break;</span>
<a href="#l27.1836"></a><span id="l27.1836"> case PR_AB_SEARCH_PATH:</span>
<a href="#l27.1837"></a><span id="l27.1837" class="difflineminus">-  s = &quot;PR_AB_SEARCH_PATH&quot;; break;</span>
<a href="#l27.1838"></a><span id="l27.1838" class="difflineplus">+  s = &quot;PR_AB_SEARCH_PATH&quot;;</span>
<a href="#l27.1839"></a><span id="l27.1839" class="difflineplus">+  break;</span>
<a href="#l27.1840"></a><span id="l27.1840"> case PR_AB_DEFAULT_DIR:</span>
<a href="#l27.1841"></a><span id="l27.1841" class="difflineminus">-  s = &quot;PR_AB_DEFAULT_DIR&quot;; break;</span>
<a href="#l27.1842"></a><span id="l27.1842" class="difflineplus">+  s = &quot;PR_AB_DEFAULT_DIR&quot;;</span>
<a href="#l27.1843"></a><span id="l27.1843" class="difflineplus">+  break;</span>
<a href="#l27.1844"></a><span id="l27.1844"> case PR_AB_DEFAULT_PAB:</span>
<a href="#l27.1845"></a><span id="l27.1845" class="difflineminus">-  s = &quot;PR_AB_DEFAULT_PAB&quot;; break;</span>
<a href="#l27.1846"></a><span id="l27.1846" class="difflineplus">+  s = &quot;PR_AB_DEFAULT_PAB&quot;;</span>
<a href="#l27.1847"></a><span id="l27.1847" class="difflineplus">+  break;</span>
<a href="#l27.1848"></a><span id="l27.1848"> </span>
<a href="#l27.1849"></a><span id="l27.1849"> case PR_FILTERING_HOOKS:</span>
<a href="#l27.1850"></a><span id="l27.1850" class="difflineminus">-  s = &quot;PR_FILTERING_HOOKS&quot;; break;</span>
<a href="#l27.1851"></a><span id="l27.1851" class="difflineplus">+  s = &quot;PR_FILTERING_HOOKS&quot;;</span>
<a href="#l27.1852"></a><span id="l27.1852" class="difflineplus">+  break;</span>
<a href="#l27.1853"></a><span id="l27.1853"> case PR_SERVICE_NAME:</span>
<a href="#l27.1854"></a><span id="l27.1854" class="difflineminus">-  s = &quot;PR_SERVICE_NAME&quot;; break;</span>
<a href="#l27.1855"></a><span id="l27.1855" class="difflineplus">+  s = &quot;PR_SERVICE_NAME&quot;;</span>
<a href="#l27.1856"></a><span id="l27.1856" class="difflineplus">+  break;</span>
<a href="#l27.1857"></a><span id="l27.1857"> case PR_SERVICE_DLL_NAME:</span>
<a href="#l27.1858"></a><span id="l27.1858" class="difflineminus">-  s = &quot;PR_SERVICE_DLL_NAME&quot;; break;</span>
<a href="#l27.1859"></a><span id="l27.1859" class="difflineplus">+  s = &quot;PR_SERVICE_DLL_NAME&quot;;</span>
<a href="#l27.1860"></a><span id="l27.1860" class="difflineplus">+  break;</span>
<a href="#l27.1861"></a><span id="l27.1861"> case PR_SERVICE_ENTRY_NAME:</span>
<a href="#l27.1862"></a><span id="l27.1862" class="difflineminus">-  s = &quot;PR_SERVICE_ENTRY_NAME&quot;; break;</span>
<a href="#l27.1863"></a><span id="l27.1863" class="difflineplus">+  s = &quot;PR_SERVICE_ENTRY_NAME&quot;;</span>
<a href="#l27.1864"></a><span id="l27.1864" class="difflineplus">+  break;</span>
<a href="#l27.1865"></a><span id="l27.1865"> case PR_SERVICE_UID:</span>
<a href="#l27.1866"></a><span id="l27.1866" class="difflineminus">-  s = &quot;PR_SERVICE_UID&quot;; break;</span>
<a href="#l27.1867"></a><span id="l27.1867" class="difflineplus">+  s = &quot;PR_SERVICE_UID&quot;;</span>
<a href="#l27.1868"></a><span id="l27.1868" class="difflineplus">+  break;</span>
<a href="#l27.1869"></a><span id="l27.1869"> case PR_SERVICE_EXTRA_UIDS:</span>
<a href="#l27.1870"></a><span id="l27.1870" class="difflineminus">-  s = &quot;PR_SERVICE_EXTRA_UIDS&quot;; break;</span>
<a href="#l27.1871"></a><span id="l27.1871" class="difflineplus">+  s = &quot;PR_SERVICE_EXTRA_UIDS&quot;;</span>
<a href="#l27.1872"></a><span id="l27.1872" class="difflineplus">+  break;</span>
<a href="#l27.1873"></a><span id="l27.1873"> case PR_SERVICES:</span>
<a href="#l27.1874"></a><span id="l27.1874" class="difflineminus">-  s = &quot;PR_SERVICES&quot;; break;</span>
<a href="#l27.1875"></a><span id="l27.1875" class="difflineplus">+  s = &quot;PR_SERVICES&quot;;</span>
<a href="#l27.1876"></a><span id="l27.1876" class="difflineplus">+  break;</span>
<a href="#l27.1877"></a><span id="l27.1877"> case PR_SERVICE_SUPPORT_FILES:</span>
<a href="#l27.1878"></a><span id="l27.1878" class="difflineminus">-  s = &quot;PR_SERVICE_SUPPORT_FILES&quot;; break;</span>
<a href="#l27.1879"></a><span id="l27.1879" class="difflineplus">+  s = &quot;PR_SERVICE_SUPPORT_FILES&quot;;</span>
<a href="#l27.1880"></a><span id="l27.1880" class="difflineplus">+  break;</span>
<a href="#l27.1881"></a><span id="l27.1881"> case PR_SERVICE_DELETE_FILES:</span>
<a href="#l27.1882"></a><span id="l27.1882" class="difflineminus">-  s = &quot;PR_SERVICE_DELETE_FILES&quot;; break;</span>
<a href="#l27.1883"></a><span id="l27.1883" class="difflineplus">+  s = &quot;PR_SERVICE_DELETE_FILES&quot;;</span>
<a href="#l27.1884"></a><span id="l27.1884" class="difflineplus">+  break;</span>
<a href="#l27.1885"></a><span id="l27.1885"> case PR_AB_SEARCH_PATH_UPDATE:</span>
<a href="#l27.1886"></a><span id="l27.1886" class="difflineminus">-  s = &quot;PR_AB_SEARCH_PATH_UPDATE&quot;; break;</span>
<a href="#l27.1887"></a><span id="l27.1887" class="difflineplus">+  s = &quot;PR_AB_SEARCH_PATH_UPDATE&quot;;</span>
<a href="#l27.1888"></a><span id="l27.1888" class="difflineplus">+  break;</span>
<a href="#l27.1889"></a><span id="l27.1889"> case PR_PROFILE_NAME:</span>
<a href="#l27.1890"></a><span id="l27.1890" class="difflineminus">-  s = &quot;PR_PROFILE_NAME&quot;; break;</span>
<a href="#l27.1891"></a><span id="l27.1891" class="difflineplus">+  s = &quot;PR_PROFILE_NAME&quot;;</span>
<a href="#l27.1892"></a><span id="l27.1892" class="difflineplus">+  break;</span>
<a href="#l27.1893"></a><span id="l27.1893"> </span>
<a href="#l27.1894"></a><span id="l27.1894" class="difflineminus">-/*</span>
<a href="#l27.1895"></a><span id="l27.1895" class="difflineminus">- *  Status object properties</span>
<a href="#l27.1896"></a><span id="l27.1896" class="difflineminus">- */</span>
<a href="#l27.1897"></a><span id="l27.1897" class="difflineplus">+  /*</span>
<a href="#l27.1898"></a><span id="l27.1898" class="difflineplus">+   *  Status object properties</span>
<a href="#l27.1899"></a><span id="l27.1899" class="difflineplus">+   */</span>
<a href="#l27.1900"></a><span id="l27.1900"> </span>
<a href="#l27.1901"></a><span id="l27.1901"> case PR_IDENTITY_DISPLAY:</span>
<a href="#l27.1902"></a><span id="l27.1902" class="difflineminus">-  s = &quot;PR_IDENTITY_DISPLAY&quot;; break;</span>
<a href="#l27.1903"></a><span id="l27.1903" class="difflineplus">+  s = &quot;PR_IDENTITY_DISPLAY&quot;;</span>
<a href="#l27.1904"></a><span id="l27.1904" class="difflineplus">+  break;</span>
<a href="#l27.1905"></a><span id="l27.1905"> case PR_IDENTITY_ENTRYID:</span>
<a href="#l27.1906"></a><span id="l27.1906" class="difflineminus">-  s = &quot;PR_IDENTITY_ENTRYID&quot;; break;</span>
<a href="#l27.1907"></a><span id="l27.1907" class="difflineplus">+  s = &quot;PR_IDENTITY_ENTRYID&quot;;</span>
<a href="#l27.1908"></a><span id="l27.1908" class="difflineplus">+  break;</span>
<a href="#l27.1909"></a><span id="l27.1909"> case PR_RESOURCE_METHODS:</span>
<a href="#l27.1910"></a><span id="l27.1910" class="difflineminus">-  s = &quot;PR_RESOURCE_METHODS&quot;; break;</span>
<a href="#l27.1911"></a><span id="l27.1911" class="difflineplus">+  s = &quot;PR_RESOURCE_METHODS&quot;;</span>
<a href="#l27.1912"></a><span id="l27.1912" class="difflineplus">+  break;</span>
<a href="#l27.1913"></a><span id="l27.1913"> case PR_RESOURCE_TYPE:</span>
<a href="#l27.1914"></a><span id="l27.1914" class="difflineminus">-  s = &quot;PR_RESOURCE_TYPE&quot;; break;</span>
<a href="#l27.1915"></a><span id="l27.1915" class="difflineplus">+  s = &quot;PR_RESOURCE_TYPE&quot;;</span>
<a href="#l27.1916"></a><span id="l27.1916" class="difflineplus">+  break;</span>
<a href="#l27.1917"></a><span id="l27.1917"> case PR_STATUS_CODE:</span>
<a href="#l27.1918"></a><span id="l27.1918" class="difflineminus">-  s = &quot;PR_STATUS_CODE&quot;; break;</span>
<a href="#l27.1919"></a><span id="l27.1919" class="difflineplus">+  s = &quot;PR_STATUS_CODE&quot;;</span>
<a href="#l27.1920"></a><span id="l27.1920" class="difflineplus">+  break;</span>
<a href="#l27.1921"></a><span id="l27.1921"> case PR_IDENTITY_SEARCH_KEY:</span>
<a href="#l27.1922"></a><span id="l27.1922" class="difflineminus">-  s = &quot;PR_IDENTITY_SEARCH_KEY&quot;; break;</span>
<a href="#l27.1923"></a><span id="l27.1923" class="difflineplus">+  s = &quot;PR_IDENTITY_SEARCH_KEY&quot;;</span>
<a href="#l27.1924"></a><span id="l27.1924" class="difflineplus">+  break;</span>
<a href="#l27.1925"></a><span id="l27.1925"> case PR_OWN_STORE_ENTRYID:</span>
<a href="#l27.1926"></a><span id="l27.1926" class="difflineminus">-  s = &quot;PR_OWN_STORE_ENTRYID&quot;; break;</span>
<a href="#l27.1927"></a><span id="l27.1927" class="difflineplus">+  s = &quot;PR_OWN_STORE_ENTRYID&quot;;</span>
<a href="#l27.1928"></a><span id="l27.1928" class="difflineplus">+  break;</span>
<a href="#l27.1929"></a><span id="l27.1929"> case PR_RESOURCE_PATH:</span>
<a href="#l27.1930"></a><span id="l27.1930" class="difflineminus">-  s = &quot;PR_RESOURCE_PATH&quot;; break;</span>
<a href="#l27.1931"></a><span id="l27.1931" class="difflineplus">+  s = &quot;PR_RESOURCE_PATH&quot;;</span>
<a href="#l27.1932"></a><span id="l27.1932" class="difflineplus">+  break;</span>
<a href="#l27.1933"></a><span id="l27.1933"> case PR_STATUS_STRING:</span>
<a href="#l27.1934"></a><span id="l27.1934" class="difflineminus">-  s = &quot;PR_STATUS_STRING&quot;; break;</span>
<a href="#l27.1935"></a><span id="l27.1935" class="difflineplus">+  s = &quot;PR_STATUS_STRING&quot;;</span>
<a href="#l27.1936"></a><span id="l27.1936" class="difflineplus">+  break;</span>
<a href="#l27.1937"></a><span id="l27.1937"> case PR_X400_DEFERRED_DELIVERY_CANCEL:</span>
<a href="#l27.1938"></a><span id="l27.1938" class="difflineminus">-  s = &quot;PR_X400_DEFERRED_DELIVERY_CANCEL&quot;; break;</span>
<a href="#l27.1939"></a><span id="l27.1939" class="difflineplus">+  s = &quot;PR_X400_DEFERRED_DELIVERY_CANCEL&quot;;</span>
<a href="#l27.1940"></a><span id="l27.1940" class="difflineplus">+  break;</span>
<a href="#l27.1941"></a><span id="l27.1941"> case PR_HEADER_FOLDER_ENTRYID:</span>
<a href="#l27.1942"></a><span id="l27.1942" class="difflineminus">-  s = &quot;PR_HEADER_FOLDER_ENTRYID&quot;; break;</span>
<a href="#l27.1943"></a><span id="l27.1943" class="difflineplus">+  s = &quot;PR_HEADER_FOLDER_ENTRYID&quot;;</span>
<a href="#l27.1944"></a><span id="l27.1944" class="difflineplus">+  break;</span>
<a href="#l27.1945"></a><span id="l27.1945"> case PR_REMOTE_PROGRESS:</span>
<a href="#l27.1946"></a><span id="l27.1946" class="difflineminus">-  s = &quot;PR_REMOTE_PROGRESS&quot;; break;</span>
<a href="#l27.1947"></a><span id="l27.1947" class="difflineplus">+  s = &quot;PR_REMOTE_PROGRESS&quot;;</span>
<a href="#l27.1948"></a><span id="l27.1948" class="difflineplus">+  break;</span>
<a href="#l27.1949"></a><span id="l27.1949"> case PR_REMOTE_PROGRESS_TEXT:</span>
<a href="#l27.1950"></a><span id="l27.1950" class="difflineminus">-  s = &quot;PR_REMOTE_PROGRESS_TEXT&quot;; break;</span>
<a href="#l27.1951"></a><span id="l27.1951" class="difflineplus">+  s = &quot;PR_REMOTE_PROGRESS_TEXT&quot;;</span>
<a href="#l27.1952"></a><span id="l27.1952" class="difflineplus">+  break;</span>
<a href="#l27.1953"></a><span id="l27.1953"> case PR_REMOTE_VALIDATE_OK:</span>
<a href="#l27.1954"></a><span id="l27.1954" class="difflineminus">-  s = &quot;PR_REMOTE_VALIDATE_OK&quot;; break;</span>
<a href="#l27.1955"></a><span id="l27.1955" class="difflineplus">+  s = &quot;PR_REMOTE_VALIDATE_OK&quot;;</span>
<a href="#l27.1956"></a><span id="l27.1956" class="difflineplus">+  break;</span>
<a href="#l27.1957"></a><span id="l27.1957"> </span>
<a href="#l27.1958"></a><span id="l27.1958" class="difflineminus">-/*</span>
<a href="#l27.1959"></a><span id="l27.1959" class="difflineminus">- * Display table properties</span>
<a href="#l27.1960"></a><span id="l27.1960" class="difflineminus">- */</span>
<a href="#l27.1961"></a><span id="l27.1961" class="difflineplus">+  /*</span>
<a href="#l27.1962"></a><span id="l27.1962" class="difflineplus">+   * Display table properties</span>
<a href="#l27.1963"></a><span id="l27.1963" class="difflineplus">+   */</span>
<a href="#l27.1964"></a><span id="l27.1964"> </span>
<a href="#l27.1965"></a><span id="l27.1965"> case PR_CONTROL_FLAGS:</span>
<a href="#l27.1966"></a><span id="l27.1966" class="difflineminus">-  s = &quot;PR_CONTROL_FLAGS&quot;; break;</span>
<a href="#l27.1967"></a><span id="l27.1967" class="difflineplus">+  s = &quot;PR_CONTROL_FLAGS&quot;;</span>
<a href="#l27.1968"></a><span id="l27.1968" class="difflineplus">+  break;</span>
<a href="#l27.1969"></a><span id="l27.1969"> case PR_CONTROL_STRUCTURE:</span>
<a href="#l27.1970"></a><span id="l27.1970" class="difflineminus">-  s = &quot;PR_CONTROL_STRUCTURE&quot;; break;</span>
<a href="#l27.1971"></a><span id="l27.1971" class="difflineplus">+  s = &quot;PR_CONTROL_STRUCTURE&quot;;</span>
<a href="#l27.1972"></a><span id="l27.1972" class="difflineplus">+  break;</span>
<a href="#l27.1973"></a><span id="l27.1973"> case PR_CONTROL_TYPE:</span>
<a href="#l27.1974"></a><span id="l27.1974" class="difflineminus">-  s = &quot;PR_CONTROL_TYPE&quot;; break;</span>
<a href="#l27.1975"></a><span id="l27.1975" class="difflineplus">+  s = &quot;PR_CONTROL_TYPE&quot;;</span>
<a href="#l27.1976"></a><span id="l27.1976" class="difflineplus">+  break;</span>
<a href="#l27.1977"></a><span id="l27.1977"> case PR_DELTAX:</span>
<a href="#l27.1978"></a><span id="l27.1978" class="difflineminus">-  s = &quot;PR_DELTAX&quot;; break;</span>
<a href="#l27.1979"></a><span id="l27.1979" class="difflineplus">+  s = &quot;PR_DELTAX&quot;;</span>
<a href="#l27.1980"></a><span id="l27.1980" class="difflineplus">+  break;</span>
<a href="#l27.1981"></a><span id="l27.1981"> case PR_DELTAY:</span>
<a href="#l27.1982"></a><span id="l27.1982" class="difflineminus">-  s = &quot;PR_DELTAY&quot;; break;</span>
<a href="#l27.1983"></a><span id="l27.1983" class="difflineplus">+  s = &quot;PR_DELTAY&quot;;</span>
<a href="#l27.1984"></a><span id="l27.1984" class="difflineplus">+  break;</span>
<a href="#l27.1985"></a><span id="l27.1985"> case PR_XPOS:</span>
<a href="#l27.1986"></a><span id="l27.1986" class="difflineminus">-  s = &quot;PR_XPOS&quot;; break;</span>
<a href="#l27.1987"></a><span id="l27.1987" class="difflineplus">+  s = &quot;PR_XPOS&quot;;</span>
<a href="#l27.1988"></a><span id="l27.1988" class="difflineplus">+  break;</span>
<a href="#l27.1989"></a><span id="l27.1989"> case PR_YPOS:</span>
<a href="#l27.1990"></a><span id="l27.1990" class="difflineminus">-  s = &quot;PR_YPOS&quot;; break;</span>
<a href="#l27.1991"></a><span id="l27.1991" class="difflineplus">+  s = &quot;PR_YPOS&quot;;</span>
<a href="#l27.1992"></a><span id="l27.1992" class="difflineplus">+  break;</span>
<a href="#l27.1993"></a><span id="l27.1993"> case PR_CONTROL_ID:</span>
<a href="#l27.1994"></a><span id="l27.1994" class="difflineminus">-  s = &quot;PR_CONTROL_ID&quot;; break;</span>
<a href="#l27.1995"></a><span id="l27.1995" class="difflineplus">+  s = &quot;PR_CONTROL_ID&quot;;</span>
<a href="#l27.1996"></a><span id="l27.1996" class="difflineplus">+  break;</span>
<a href="#l27.1997"></a><span id="l27.1997"> case PR_INITIAL_DETAILS_PANE:</span>
<a href="#l27.1998"></a><span id="l27.1998" class="difflineminus">-  s = &quot;PR_INITIAL_DETAILS_PANE&quot;; break;</span>
<a href="#l27.1999"></a><span id="l27.1999" class="difflineminus">-/*</span>
<a href="#l27.2000"></a><span id="l27.2000" class="difflineminus">- * Secure property id range</span>
<a href="#l27.2001"></a><span id="l27.2001" class="difflineminus">- */</span>
<a href="#l27.2002"></a><span id="l27.2002" class="difflineplus">+  s = &quot;PR_INITIAL_DETAILS_PANE&quot;;</span>
<a href="#l27.2003"></a><span id="l27.2003" class="difflineplus">+  break;</span>
<a href="#l27.2004"></a><span id="l27.2004" class="difflineplus">+  /*</span>
<a href="#l27.2005"></a><span id="l27.2005" class="difflineplus">+   * Secure property id range</span>
<a href="#l27.2006"></a><span id="l27.2006" class="difflineplus">+   */</span>
<a href="#l27.2007"></a><span id="l27.2007"> </span>
<a href="#l27.2008"></a><span id="l27.2008"> case PROP_ID_SECURE_MIN:</span>
<a href="#l27.2009"></a><span id="l27.2009" class="difflineminus">-  s = &quot;PROP_ID_SECURE_MIN&quot;; break;</span>
<a href="#l27.2010"></a><span id="l27.2010" class="difflineplus">+  s = &quot;PROP_ID_SECURE_MIN&quot;;</span>
<a href="#l27.2011"></a><span id="l27.2011" class="difflineplus">+  break;</span>
<a href="#l27.2012"></a><span id="l27.2012"> case PROP_ID_SECURE_MAX:</span>
<a href="#l27.2013"></a><span id="l27.2013" class="difflineminus">-  s = &quot;PROP_ID_SECURE_MAX&quot;; break;</span>
<a href="#l27.2014"></a><span id="l27.2014" class="difflineplus">+  s = &quot;PROP_ID_SECURE_MAX&quot;;</span>
<a href="#l27.2015"></a><span id="l27.2015" class="difflineplus">+  break;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mailnews/import/outlook/src/nsOutlookCompose.cpp</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mailnews/import/outlook/src/nsOutlookCompose.cpp</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -38,217 +38,232 @@</span>
<a href="#l28.4"></a><span id="l28.4"> #include &quot;nsThreadUtils.h&quot;</span>
<a href="#l28.5"></a><span id="l28.5"> </span>
<a href="#l28.6"></a><span id="l28.6"> #include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l28.7"></a><span id="l28.7"> #include &quot;nsMsgLocalFolderHdrs.h&quot;</span>
<a href="#l28.8"></a><span id="l28.8"> </span>
<a href="#l28.9"></a><span id="l28.9"> static NS_DEFINE_CID(kMsgCompFieldsCID, NS_MSGCOMPFIELDS_CID);</span>
<a href="#l28.10"></a><span id="l28.10"> </span>
<a href="#l28.11"></a><span id="l28.11"> #ifdef IMPORT_DEBUG</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-static const char *p_test_headers =</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineminus">-&quot;Received: from netppl.invalid (IDENT:monitor@get.freebsd.because.microsoftsucks.invalid [209.3.31.115])\n\</span>
<a href="#l28.14"></a><span id="l28.14" class="difflineplus">+static const char* p_test_headers =</span>
<a href="#l28.15"></a><span id="l28.15" class="difflineplus">+    &quot;Received: from netppl.invalid (IDENT:monitor@get.freebsd.because.microsoftsucks.invalid [209.3.31.115])\n\</span>
<a href="#l28.16"></a><span id="l28.16">  by mail4.sirius.invalid (8.9.1/8.9.1) with SMTP id PAA27232;\n\</span>
<a href="#l28.17"></a><span id="l28.17">  Mon, 17 May 1999 15:27:43 -0700 (PDT)\n\</span>
<a href="#l28.18"></a><span id="l28.18"> Message-ID: &lt;ikGD3jRTsKklU.Ggm2HmE2A1Jsqd0p@netppl.invalid&gt;\n\</span>
<a href="#l28.19"></a><span id="l28.19"> From: \&quot;adsales@qualityservice.invalid\&quot; &lt;adsales@qualityservice.invalid&gt;\n\</span>
<a href="#l28.20"></a><span id="l28.20"> Subject: Re: Your College Diploma (36822)\n\</span>
<a href="#l28.21"></a><span id="l28.21"> Date: Mon, 17 May 1999 15:09:29 -0400 (EDT)\n\</span>
<a href="#l28.22"></a><span id="l28.22"> MIME-Version: 1.0\n\</span>
<a href="#l28.23"></a><span id="l28.23"> Content-Type: TEXT/PLAIN; charset=\&quot;US-ASCII\&quot;\n\</span>
<a href="#l28.24"></a><span id="l28.24"> Content-Transfer-Encoding: 7bit\n\</span>
<a href="#l28.25"></a><span id="l28.25"> X-UIDL: 19990517.152941\n\</span>
<a href="#l28.26"></a><span id="l28.26"> Status: RO&quot;;</span>
<a href="#l28.27"></a><span id="l28.27"> </span>
<a href="#l28.28"></a><span id="l28.28" class="difflineminus">-static const char *p_test_body =</span>
<a href="#l28.29"></a><span id="l28.29" class="difflineminus">-&quot;Hello world?\n\</span>
<a href="#l28.30"></a><span id="l28.30" class="difflineplus">+static const char* p_test_body =</span>
<a href="#l28.31"></a><span id="l28.31" class="difflineplus">+    &quot;Hello world?\n\</span>
<a href="#l28.32"></a><span id="l28.32"> &quot;;</span>
<a href="#l28.33"></a><span id="l28.33"> #else</span>
<a href="#l28.34"></a><span id="l28.34" class="difflineminus">-#define p_test_headers nullptr</span>
<a href="#l28.35"></a><span id="l28.35" class="difflineminus">-#define p_test_body nullptr</span>
<a href="#l28.36"></a><span id="l28.36" class="difflineplus">+#  define p_test_headers nullptr</span>
<a href="#l28.37"></a><span id="l28.37" class="difflineplus">+#  define p_test_body nullptr</span>
<a href="#l28.38"></a><span id="l28.38"> #endif</span>
<a href="#l28.39"></a><span id="l28.39"> </span>
<a href="#l28.40"></a><span id="l28.40"> #define kWhitespace &quot;\b\t\r\n &quot;</span>
<a href="#l28.41"></a><span id="l28.41"> </span>
<a href="#l28.42"></a><span id="l28.42"> //////////////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l28.43"></a><span id="l28.43"> </span>
<a href="#l28.44"></a><span id="l28.44" class="difflineminus">-// A replacement for SimpleBufferTonyRCopiedTwice round-robin buffer and ReadFileState classes</span>
<a href="#l28.45"></a><span id="l28.45" class="difflineplus">+// A replacement for SimpleBufferTonyRCopiedTwice round-robin buffer and</span>
<a href="#l28.46"></a><span id="l28.46" class="difflineplus">+// ReadFileState classes</span>
<a href="#l28.47"></a><span id="l28.47"> class CCompositionFile {</span>
<a href="#l28.48"></a><span id="l28.48" class="difflineminus">-public:</span>
<a href="#l28.49"></a><span id="l28.49" class="difflineplus">+ public:</span>
<a href="#l28.50"></a><span id="l28.50">   // fifoBuffer is used for memory allocation optimization</span>
<a href="#l28.51"></a><span id="l28.51">   // convertCRs controls if we want to convert standalone CRs to CRLFs</span>
<a href="#l28.52"></a><span id="l28.52" class="difflineminus">-  CCompositionFile(nsIFile* aFile, void* fifoBuffer, uint32_t fifoBufferSize, bool convertCRs=false);</span>
<a href="#l28.53"></a><span id="l28.53" class="difflineplus">+  CCompositionFile(nsIFile* aFile, void* fifoBuffer, uint32_t fifoBufferSize,</span>
<a href="#l28.54"></a><span id="l28.54" class="difflineplus">+                   bool convertCRs = false);</span>
<a href="#l28.55"></a><span id="l28.55"> </span>
<a href="#l28.56"></a><span id="l28.56">   explicit operator bool() const { return m_fileSize &amp;&amp; m_pInputStream; }</span>
<a href="#l28.57"></a><span id="l28.57"> </span>
<a href="#l28.58"></a><span id="l28.58" class="difflineminus">-  // Reads up to and including the term sequence, or entire file if term isn't found</span>
<a href="#l28.59"></a><span id="l28.59" class="difflineminus">-  // termSize may be used to include NULLs in the terminator sequences.</span>
<a href="#l28.60"></a><span id="l28.60" class="difflineminus">-  // termSize value of -1 means &quot;zero-terminated string&quot; -&gt; size is calculated with strlen</span>
<a href="#l28.61"></a><span id="l28.61" class="difflineminus">-  nsresult ToString(nsCString&amp; dest, const char* term=0, int termSize=-1);</span>
<a href="#l28.62"></a><span id="l28.62" class="difflineminus">-  nsresult ToStream(nsIOutputStream *dest, const char* term=0, int termSize=-1);</span>
<a href="#l28.63"></a><span id="l28.63" class="difflineplus">+  // Reads up to and including the term sequence, or entire file if term isn't</span>
<a href="#l28.64"></a><span id="l28.64" class="difflineplus">+  // found termSize may be used to include NULLs in the terminator sequences.</span>
<a href="#l28.65"></a><span id="l28.65" class="difflineplus">+  // termSize value of -1 means &quot;zero-terminated string&quot; -&gt; size is calculated</span>
<a href="#l28.66"></a><span id="l28.66" class="difflineplus">+  // with strlen</span>
<a href="#l28.67"></a><span id="l28.67" class="difflineplus">+  nsresult ToString(nsCString&amp; dest, const char* term = 0, int termSize = -1);</span>
<a href="#l28.68"></a><span id="l28.68" class="difflineplus">+  nsresult ToStream(nsIOutputStream* dest, const char* term = 0,</span>
<a href="#l28.69"></a><span id="l28.69" class="difflineplus">+                    int termSize = -1);</span>
<a href="#l28.70"></a><span id="l28.70">   char LastChar() { return m_lastChar; }</span>
<a href="#l28.71"></a><span id="l28.71" class="difflineminus">-private:</span>
<a href="#l28.72"></a><span id="l28.72" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt;  m_pFile;</span>
<a href="#l28.73"></a><span id="l28.73" class="difflineplus">+</span>
<a href="#l28.74"></a><span id="l28.74" class="difflineplus">+ private:</span>
<a href="#l28.75"></a><span id="l28.75" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; m_pFile;</span>
<a href="#l28.76"></a><span id="l28.76">   nsCOMPtr&lt;nsIInputStream&gt; m_pInputStream;</span>
<a href="#l28.77"></a><span id="l28.77">   int64_t m_fileSize;</span>
<a href="#l28.78"></a><span id="l28.78">   int64_t m_fileReadPos;</span>
<a href="#l28.79"></a><span id="l28.79">   char* m_fifoBuffer;</span>
<a href="#l28.80"></a><span id="l28.80">   uint32_t m_fifoBufferSize;</span>
<a href="#l28.81"></a><span id="l28.81" class="difflineminus">-  char* m_fifoBufferReadPos; // next character to read</span>
<a href="#l28.82"></a><span id="l28.82" class="difflineminus">-  char* m_fifoBufferWrittenPos; // if we have read less than buffer size then this will show it</span>
<a href="#l28.83"></a><span id="l28.83" class="difflineplus">+  char* m_fifoBufferReadPos;     // next character to read</span>
<a href="#l28.84"></a><span id="l28.84" class="difflineplus">+  char* m_fifoBufferWrittenPos;  // if we have read less than buffer size then</span>
<a href="#l28.85"></a><span id="l28.85" class="difflineplus">+                                 // this will show it</span>
<a href="#l28.86"></a><span id="l28.86">   bool m_convertCRs;</span>
<a href="#l28.87"></a><span id="l28.87">   char m_lastChar;</span>
<a href="#l28.88"></a><span id="l28.88"> </span>
<a href="#l28.89"></a><span id="l28.89">   nsresult EnsureHasDataInBuffer();</span>
<a href="#l28.90"></a><span id="l28.90" class="difflineminus">-  template &lt;class _OutFn&gt; nsresult ToDest(_OutFn dest, const char* term, int termSize);</span>
<a href="#l28.91"></a><span id="l28.91" class="difflineplus">+  template &lt;class _OutFn&gt;</span>
<a href="#l28.92"></a><span id="l28.92" class="difflineplus">+  nsresult ToDest(_OutFn dest, const char* term, int termSize);</span>
<a href="#l28.93"></a><span id="l28.93"> };</span>
<a href="#l28.94"></a><span id="l28.94"> </span>
<a href="#l28.95"></a><span id="l28.95"> //////////////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l28.96"></a><span id="l28.96"> </span>
<a href="#l28.97"></a><span id="l28.97"> // First off, a listener</span>
<a href="#l28.98"></a><span id="l28.98" class="difflineminus">-class OutlookSendListener : public nsIMsgSendListener</span>
<a href="#l28.99"></a><span id="l28.99" class="difflineminus">-{</span>
<a href="#l28.100"></a><span id="l28.100" class="difflineminus">-public:</span>
<a href="#l28.101"></a><span id="l28.101" class="difflineminus">-  OutlookSendListener() {</span>
<a href="#l28.102"></a><span id="l28.102" class="difflineminus">-    m_done = false;</span>
<a href="#l28.103"></a><span id="l28.103" class="difflineminus">-  }</span>
<a href="#l28.104"></a><span id="l28.104" class="difflineplus">+class OutlookSendListener : public nsIMsgSendListener {</span>
<a href="#l28.105"></a><span id="l28.105" class="difflineplus">+ public:</span>
<a href="#l28.106"></a><span id="l28.106" class="difflineplus">+  OutlookSendListener() { m_done = false; }</span>
<a href="#l28.107"></a><span id="l28.107"> </span>
<a href="#l28.108"></a><span id="l28.108">   // nsISupports interface</span>
<a href="#l28.109"></a><span id="l28.109">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l28.110"></a><span id="l28.110"> </span>
<a href="#l28.111"></a><span id="l28.111">   /* void OnStartSending (in string aMsgID, in uint32_t aMsgSize); */</span>
<a href="#l28.112"></a><span id="l28.112" class="difflineminus">-  NS_IMETHOD OnStartSending(const char *aMsgID, uint32_t aMsgSize) {return NS_OK;}</span>
<a href="#l28.113"></a><span id="l28.113" class="difflineplus">+  NS_IMETHOD OnStartSending(const char* aMsgID, uint32_t aMsgSize) {</span>
<a href="#l28.114"></a><span id="l28.114" class="difflineplus">+    return NS_OK;</span>
<a href="#l28.115"></a><span id="l28.115" class="difflineplus">+  }</span>
<a href="#l28.116"></a><span id="l28.116"> </span>
<a href="#l28.117"></a><span id="l28.117" class="difflineminus">-  /* void OnProgress (in string aMsgID, in uint32_t aProgress, in uint32_t aProgressMax); */</span>
<a href="#l28.118"></a><span id="l28.118" class="difflineminus">-  NS_IMETHOD OnProgress(const char *aMsgID, uint32_t aProgress, uint32_t aProgressMax) {return NS_OK;}</span>
<a href="#l28.119"></a><span id="l28.119" class="difflineplus">+  /* void OnProgress (in string aMsgID, in uint32_t aProgress, in uint32_t</span>
<a href="#l28.120"></a><span id="l28.120" class="difflineplus">+   * aProgressMax); */</span>
<a href="#l28.121"></a><span id="l28.121" class="difflineplus">+  NS_IMETHOD OnProgress(const char* aMsgID, uint32_t aProgress,</span>
<a href="#l28.122"></a><span id="l28.122" class="difflineplus">+                        uint32_t aProgressMax) {</span>
<a href="#l28.123"></a><span id="l28.123" class="difflineplus">+    return NS_OK;</span>
<a href="#l28.124"></a><span id="l28.124" class="difflineplus">+  }</span>
<a href="#l28.125"></a><span id="l28.125"> </span>
<a href="#l28.126"></a><span id="l28.126">   /* void OnStatus (in string aMsgID, in wstring aMsg); */</span>
<a href="#l28.127"></a><span id="l28.127" class="difflineminus">-  NS_IMETHOD OnStatus(const char *aMsgID, const char16_t *aMsg) {return NS_OK;}</span>
<a href="#l28.128"></a><span id="l28.128" class="difflineplus">+  NS_IMETHOD OnStatus(const char* aMsgID, const char16_t* aMsg) {</span>
<a href="#l28.129"></a><span id="l28.129" class="difflineplus">+    return NS_OK;</span>
<a href="#l28.130"></a><span id="l28.130" class="difflineplus">+  }</span>
<a href="#l28.131"></a><span id="l28.131"> </span>
<a href="#l28.132"></a><span id="l28.132" class="difflineminus">-  /* void OnStopSending (in string aMsgID, in nsresult aStatus, in wstring aMsg, in nsIFile returnFile); */</span>
<a href="#l28.133"></a><span id="l28.133" class="difflineminus">-  NS_IMETHOD OnStopSending(const char *aMsgID, nsresult aStatus, const char16_t *aMsg,</span>
<a href="#l28.134"></a><span id="l28.134" class="difflineminus">-               nsIFile *returnFile) {</span>
<a href="#l28.135"></a><span id="l28.135" class="difflineplus">+  /* void OnStopSending (in string aMsgID, in nsresult aStatus, in wstring aMsg,</span>
<a href="#l28.136"></a><span id="l28.136" class="difflineplus">+   * in nsIFile returnFile); */</span>
<a href="#l28.137"></a><span id="l28.137" class="difflineplus">+  NS_IMETHOD OnStopSending(const char* aMsgID, nsresult aStatus,</span>
<a href="#l28.138"></a><span id="l28.138" class="difflineplus">+                           const char16_t* aMsg, nsIFile* returnFile) {</span>
<a href="#l28.139"></a><span id="l28.139">     m_done = true;</span>
<a href="#l28.140"></a><span id="l28.140">     m_location = returnFile;</span>
<a href="#l28.141"></a><span id="l28.141">     return NS_OK;</span>
<a href="#l28.142"></a><span id="l28.142">   }</span>
<a href="#l28.143"></a><span id="l28.143"> </span>
<a href="#l28.144"></a><span id="l28.144" class="difflineminus">-   /* void OnSendNotPerformed */</span>
<a href="#l28.145"></a><span id="l28.145" class="difflineminus">-   NS_IMETHOD OnSendNotPerformed(const char *aMsgID, nsresult aStatus) {return NS_OK;}</span>
<a href="#l28.146"></a><span id="l28.146" class="difflineplus">+  /* void OnSendNotPerformed */</span>
<a href="#l28.147"></a><span id="l28.147" class="difflineplus">+  NS_IMETHOD OnSendNotPerformed(const char* aMsgID, nsresult aStatus) {</span>
<a href="#l28.148"></a><span id="l28.148" class="difflineplus">+    return NS_OK;</span>
<a href="#l28.149"></a><span id="l28.149" class="difflineplus">+  }</span>
<a href="#l28.150"></a><span id="l28.150"> </span>
<a href="#l28.151"></a><span id="l28.151">   /* void OnGetDraftFolderURI (); */</span>
<a href="#l28.152"></a><span id="l28.152" class="difflineminus">-  NS_IMETHOD OnGetDraftFolderURI(const char *aFolderURI) {return NS_OK;}</span>
<a href="#l28.153"></a><span id="l28.153" class="difflineplus">+  NS_IMETHOD OnGetDraftFolderURI(const char* aFolderURI) { return NS_OK; }</span>
<a href="#l28.154"></a><span id="l28.154"> </span>
<a href="#l28.155"></a><span id="l28.155" class="difflineminus">-  static nsresult CreateSendListener(nsIMsgSendListener **ppListener);</span>
<a href="#l28.156"></a><span id="l28.156" class="difflineminus">-  void Reset() { m_done = false; m_location = nullptr; }</span>
<a href="#l28.157"></a><span id="l28.157" class="difflineplus">+  static nsresult CreateSendListener(nsIMsgSendListener** ppListener);</span>
<a href="#l28.158"></a><span id="l28.158" class="difflineplus">+  void Reset() {</span>
<a href="#l28.159"></a><span id="l28.159" class="difflineplus">+    m_done = false;</span>
<a href="#l28.160"></a><span id="l28.160" class="difflineplus">+    m_location = nullptr;</span>
<a href="#l28.161"></a><span id="l28.161" class="difflineplus">+  }</span>
<a href="#l28.162"></a><span id="l28.162"> </span>
<a href="#l28.163"></a><span id="l28.163" class="difflineminus">-public:</span>
<a href="#l28.164"></a><span id="l28.164" class="difflineplus">+ public:</span>
<a href="#l28.165"></a><span id="l28.165">   virtual ~OutlookSendListener() {}</span>
<a href="#l28.166"></a><span id="l28.166"> </span>
<a href="#l28.167"></a><span id="l28.167">   bool m_done;</span>
<a href="#l28.168"></a><span id="l28.168">   nsCOMPtr&lt;nsIFile&gt; m_location;</span>
<a href="#l28.169"></a><span id="l28.169"> };</span>
<a href="#l28.170"></a><span id="l28.170"> </span>
<a href="#l28.171"></a><span id="l28.171"> NS_IMPL_ISUPPORTS(OutlookSendListener, nsIMsgSendListener)</span>
<a href="#l28.172"></a><span id="l28.172"> </span>
<a href="#l28.173"></a><span id="l28.173" class="difflineminus">-nsresult OutlookSendListener::CreateSendListener(nsIMsgSendListener **ppListener)</span>
<a href="#l28.174"></a><span id="l28.174" class="difflineminus">-{</span>
<a href="#l28.175"></a><span id="l28.175" class="difflineplus">+nsresult OutlookSendListener::CreateSendListener(</span>
<a href="#l28.176"></a><span id="l28.176" class="difflineplus">+    nsIMsgSendListener** ppListener) {</span>
<a href="#l28.177"></a><span id="l28.177">   NS_ENSURE_ARG_POINTER(ppListener);</span>
<a href="#l28.178"></a><span id="l28.178">   NS_ADDREF(*ppListener = new OutlookSendListener());</span>
<a href="#l28.179"></a><span id="l28.179">   return NS_OK;</span>
<a href="#l28.180"></a><span id="l28.180"> }</span>
<a href="#l28.181"></a><span id="l28.181"> </span>
<a href="#l28.182"></a><span id="l28.182"> /////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l28.183"></a><span id="l28.183"> /////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l28.184"></a><span id="l28.184"> /////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l28.185"></a><span id="l28.185"> /////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l28.186"></a><span id="l28.186"> </span>
<a href="#l28.187"></a><span id="l28.187" class="difflineminus">-nsOutlookCompose::nsOutlookCompose()</span>
<a href="#l28.188"></a><span id="l28.188" class="difflineminus">-{</span>
<a href="#l28.189"></a><span id="l28.189" class="difflineplus">+nsOutlookCompose::nsOutlookCompose() {</span>
<a href="#l28.190"></a><span id="l28.190">   m_optimizationBuffer = new char[FILE_IO_BUFFER_SIZE];</span>
<a href="#l28.191"></a><span id="l28.191"> }</span>
<a href="#l28.192"></a><span id="l28.192"> </span>
<a href="#l28.193"></a><span id="l28.193" class="difflineminus">-nsOutlookCompose::~nsOutlookCompose()</span>
<a href="#l28.194"></a><span id="l28.194" class="difflineminus">-{</span>
<a href="#l28.195"></a><span id="l28.195" class="difflineplus">+nsOutlookCompose::~nsOutlookCompose() {</span>
<a href="#l28.196"></a><span id="l28.196">   if (m_pIdentity) {</span>
<a href="#l28.197"></a><span id="l28.197">     nsresult rv = m_pIdentity-&gt;ClearAllValues();</span>
<a href="#l28.198"></a><span id="l28.198" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to clear values&quot;);</span>
<a href="#l28.199"></a><span id="l28.199" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l28.200"></a><span id="l28.200" class="difflineminus">-      return;</span>
<a href="#l28.201"></a><span id="l28.201" class="difflineplus">+    NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to clear values&quot;);</span>
<a href="#l28.202"></a><span id="l28.202" class="difflineplus">+    if (NS_FAILED(rv)) return;</span>
<a href="#l28.203"></a><span id="l28.203">   }</span>
<a href="#l28.204"></a><span id="l28.204">   delete[] m_optimizationBuffer;</span>
<a href="#l28.205"></a><span id="l28.205"> }</span>
<a href="#l28.206"></a><span id="l28.206"> </span>
<a href="#l28.207"></a><span id="l28.207"> nsCOMPtr&lt;nsIMsgIdentity&gt; nsOutlookCompose::m_pIdentity = nullptr;</span>
<a href="#l28.208"></a><span id="l28.208"> </span>
<a href="#l28.209"></a><span id="l28.209" class="difflineminus">-nsresult nsOutlookCompose::CreateIdentity(void)</span>
<a href="#l28.210"></a><span id="l28.210" class="difflineminus">-{</span>
<a href="#l28.211"></a><span id="l28.211" class="difflineminus">-  if (m_pIdentity)</span>
<a href="#l28.212"></a><span id="l28.212" class="difflineminus">-    return NS_OK;</span>
<a href="#l28.213"></a><span id="l28.213" class="difflineplus">+nsresult nsOutlookCompose::CreateIdentity(void) {</span>
<a href="#l28.214"></a><span id="l28.214" class="difflineplus">+  if (m_pIdentity) return NS_OK;</span>
<a href="#l28.215"></a><span id="l28.215"> </span>
<a href="#l28.216"></a><span id="l28.216">   nsresult rv;</span>
<a href="#l28.217"></a><span id="l28.217">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accMgr =</span>
<a href="#l28.218"></a><span id="l28.218" class="difflineminus">-    do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l28.219"></a><span id="l28.219" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l28.220"></a><span id="l28.220">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.221"></a><span id="l28.221">   rv = accMgr-&gt;CreateIdentity(getter_AddRefs(m_pIdentity));</span>
<a href="#l28.222"></a><span id="l28.222">   nsString name;</span>
<a href="#l28.223"></a><span id="l28.223">   name.AssignLiteral(&quot;Import Identity&quot;);</span>
<a href="#l28.224"></a><span id="l28.224">   if (m_pIdentity) {</span>
<a href="#l28.225"></a><span id="l28.225">     m_pIdentity-&gt;SetFullName(name);</span>
<a href="#l28.226"></a><span id="l28.226">     m_pIdentity-&gt;SetEmail(NS_LITERAL_CSTRING(&quot;import@service.invalid&quot;));</span>
<a href="#l28.227"></a><span id="l28.227">   }</span>
<a href="#l28.228"></a><span id="l28.228">   return rv;</span>
<a href="#l28.229"></a><span id="l28.229"> }</span>
<a href="#l28.230"></a><span id="l28.230"> </span>
<a href="#l28.231"></a><span id="l28.231" class="difflineminus">-void nsOutlookCompose::ReleaseIdentity()</span>
<a href="#l28.232"></a><span id="l28.232" class="difflineminus">-{</span>
<a href="#l28.233"></a><span id="l28.233" class="difflineminus">-  m_pIdentity = nullptr;</span>
<a href="#l28.234"></a><span id="l28.234" class="difflineminus">-}</span>
<a href="#l28.235"></a><span id="l28.235" class="difflineplus">+void nsOutlookCompose::ReleaseIdentity() { m_pIdentity = nullptr; }</span>
<a href="#l28.236"></a><span id="l28.236"> </span>
<a href="#l28.237"></a><span id="l28.237" class="difflineminus">-nsresult nsOutlookCompose::CreateComponents(void)</span>
<a href="#l28.238"></a><span id="l28.238" class="difflineminus">-{</span>
<a href="#l28.239"></a><span id="l28.239" class="difflineplus">+nsresult nsOutlookCompose::CreateComponents(void) {</span>
<a href="#l28.240"></a><span id="l28.240">   nsresult rv = NS_OK;</span>
<a href="#l28.241"></a><span id="l28.241"> </span>
<a href="#l28.242"></a><span id="l28.242">   m_pMsgFields = nullptr;</span>
<a href="#l28.243"></a><span id="l28.243">   if (!m_pListener)</span>
<a href="#l28.244"></a><span id="l28.244">     rv = OutlookSendListener::CreateSendListener(getter_AddRefs(m_pListener));</span>
<a href="#l28.245"></a><span id="l28.245"> </span>
<a href="#l28.246"></a><span id="l28.246">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l28.247"></a><span id="l28.247" class="difflineminus">-      m_pMsgFields = do_CreateInstance(kMsgCompFieldsCID, &amp;rv);</span>
<a href="#l28.248"></a><span id="l28.248" class="difflineplus">+    m_pMsgFields = do_CreateInstance(kMsgCompFieldsCID, &amp;rv);</span>
<a href="#l28.249"></a><span id="l28.249">     if (NS_SUCCEEDED(rv) &amp;&amp; m_pMsgFields) {</span>
<a href="#l28.250"></a><span id="l28.250">       // IMPORT_LOG0(&quot;nsOutlookCompose - CreateComponents succeeded\n&quot;);</span>
<a href="#l28.251"></a><span id="l28.251">       m_pMsgFields-&gt;SetForcePlainText(false);</span>
<a href="#l28.252"></a><span id="l28.252">       return NS_OK;</span>
<a href="#l28.253"></a><span id="l28.253">     }</span>
<a href="#l28.254"></a><span id="l28.254">   }</span>
<a href="#l28.255"></a><span id="l28.255"> </span>
<a href="#l28.256"></a><span id="l28.256">   return NS_ERROR_FAILURE;</span>
<a href="#l28.257"></a><span id="l28.257"> }</span>
<a href="#l28.258"></a><span id="l28.258"> </span>
<a href="#l28.259"></a><span id="l28.259" class="difflineminus">-nsresult nsOutlookCompose::ComposeTheMessage(nsMsgDeliverMode mode, CMapiMessage &amp;msg, nsIFile **pMsg)</span>
<a href="#l28.260"></a><span id="l28.260" class="difflineminus">-{</span>
<a href="#l28.261"></a><span id="l28.261" class="difflineplus">+nsresult nsOutlookCompose::ComposeTheMessage(nsMsgDeliverMode mode,</span>
<a href="#l28.262"></a><span id="l28.262" class="difflineplus">+                                             CMapiMessage&amp; msg,</span>
<a href="#l28.263"></a><span id="l28.263" class="difflineplus">+                                             nsIFile** pMsg) {</span>
<a href="#l28.264"></a><span id="l28.264">   nsresult rv = CreateComponents();</span>
<a href="#l28.265"></a><span id="l28.265">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.266"></a><span id="l28.266">   rv = CreateIdentity();</span>
<a href="#l28.267"></a><span id="l28.267">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.268"></a><span id="l28.268"> </span>
<a href="#l28.269"></a><span id="l28.269">   // IMPORT_LOG0(&quot;Outlook Compose created necessary components\n&quot;);</span>
<a href="#l28.270"></a><span id="l28.270"> </span>
<a href="#l28.271"></a><span id="l28.271">   CMapiMessageHeaders* headers = msg.GetHeaders();</span>
<a href="#l28.272"></a><span id="l28.272"> </span>
<a href="#l28.273"></a><span id="l28.273">   nsString unival;</span>
<a href="#l28.274"></a><span id="l28.274" class="difflineminus">-  headers-&gt;UnfoldValue(CMapiMessageHeaders::hdrFrom, unival, msg.GetBodyCharset());</span>
<a href="#l28.275"></a><span id="l28.275" class="difflineplus">+  headers-&gt;UnfoldValue(CMapiMessageHeaders::hdrFrom, unival,</span>
<a href="#l28.276"></a><span id="l28.276" class="difflineplus">+                       msg.GetBodyCharset());</span>
<a href="#l28.277"></a><span id="l28.277">   m_pMsgFields-&gt;SetFrom(unival);</span>
<a href="#l28.278"></a><span id="l28.278" class="difflineminus">-  headers-&gt;UnfoldValue(CMapiMessageHeaders::hdrTo, unival, msg.GetBodyCharset());</span>
<a href="#l28.279"></a><span id="l28.279" class="difflineplus">+  headers-&gt;UnfoldValue(CMapiMessageHeaders::hdrTo, unival,</span>
<a href="#l28.280"></a><span id="l28.280" class="difflineplus">+                       msg.GetBodyCharset());</span>
<a href="#l28.281"></a><span id="l28.281">   m_pMsgFields-&gt;SetTo(unival);</span>
<a href="#l28.282"></a><span id="l28.282" class="difflineminus">-  headers-&gt;UnfoldValue(CMapiMessageHeaders::hdrSubject, unival, msg.GetBodyCharset());</span>
<a href="#l28.283"></a><span id="l28.283" class="difflineplus">+  headers-&gt;UnfoldValue(CMapiMessageHeaders::hdrSubject, unival,</span>
<a href="#l28.284"></a><span id="l28.284" class="difflineplus">+                       msg.GetBodyCharset());</span>
<a href="#l28.285"></a><span id="l28.285">   m_pMsgFields-&gt;SetSubject(unival);</span>
<a href="#l28.286"></a><span id="l28.286">   m_pMsgFields-&gt;SetCharacterSet(msg.GetBodyCharset());</span>
<a href="#l28.287"></a><span id="l28.287" class="difflineminus">-  headers-&gt;UnfoldValue(CMapiMessageHeaders::hdrCc, unival, msg.GetBodyCharset());</span>
<a href="#l28.288"></a><span id="l28.288" class="difflineplus">+  headers-&gt;UnfoldValue(CMapiMessageHeaders::hdrCc, unival,</span>
<a href="#l28.289"></a><span id="l28.289" class="difflineplus">+                       msg.GetBodyCharset());</span>
<a href="#l28.290"></a><span id="l28.290">   m_pMsgFields-&gt;SetCc(unival);</span>
<a href="#l28.291"></a><span id="l28.291" class="difflineminus">-  headers-&gt;UnfoldValue(CMapiMessageHeaders::hdrReplyTo, unival, msg.GetBodyCharset());</span>
<a href="#l28.292"></a><span id="l28.292" class="difflineplus">+  headers-&gt;UnfoldValue(CMapiMessageHeaders::hdrReplyTo, unival,</span>
<a href="#l28.293"></a><span id="l28.293" class="difflineplus">+                       msg.GetBodyCharset());</span>
<a href="#l28.294"></a><span id="l28.294">   m_pMsgFields-&gt;SetReplyTo(unival);</span>
<a href="#l28.295"></a><span id="l28.295">   m_pMsgFields-&gt;SetMessageId(headers-&gt;Value(CMapiMessageHeaders::hdrMessageID));</span>
<a href="#l28.296"></a><span id="l28.296"> </span>
<a href="#l28.297"></a><span id="l28.297">   // We only use those headers that may need to be processed by Thunderbird</span>
<a href="#l28.298"></a><span id="l28.298">   // to create a good rfc822 document, or need to be encoded (like To and Cc).</span>
<a href="#l28.299"></a><span id="l28.299">   // These will replace the originals on import. All the other headers</span>
<a href="#l28.300"></a><span id="l28.300">   // will be copied to the destination unaltered in CopyComposedMessage().</span>
<a href="#l28.301"></a><span id="l28.301"> </span>
<a href="#l28.302"></a><span id="l28.302" class="difflineat">@@ -256,212 +271,213 @@ nsresult nsOutlookCompose::ComposeTheMes</span>
<a href="#l28.303"></a><span id="l28.303">   msg.GetAttachments(getter_AddRefs(pAttach));</span>
<a href="#l28.304"></a><span id="l28.304"> </span>
<a href="#l28.305"></a><span id="l28.305">   nsString bodyW;</span>
<a href="#l28.306"></a><span id="l28.306">   bodyW = msg.GetBody();</span>
<a href="#l28.307"></a><span id="l28.307"> </span>
<a href="#l28.308"></a><span id="l28.308">   nsCOMPtr&lt;nsIMutableArray&gt; embeddedObjects;</span>
<a href="#l28.309"></a><span id="l28.309"> </span>
<a href="#l28.310"></a><span id="l28.310">   if (msg.BodyIsHtml()) {</span>
<a href="#l28.311"></a><span id="l28.311" class="difflineminus">-    for (unsigned int i = 0; i &lt;msg.EmbeddedAttachmentsCount(); i++) {</span>
<a href="#l28.312"></a><span id="l28.312" class="difflineminus">-      nsIURI *uri;</span>
<a href="#l28.313"></a><span id="l28.313" class="difflineplus">+    for (unsigned int i = 0; i &lt; msg.EmbeddedAttachmentsCount(); i++) {</span>
<a href="#l28.314"></a><span id="l28.314" class="difflineplus">+      nsIURI* uri;</span>
<a href="#l28.315"></a><span id="l28.315">       const char* cid;</span>
<a href="#l28.316"></a><span id="l28.316">       const char* name;</span>
<a href="#l28.317"></a><span id="l28.317">       if (msg.GetEmbeddedAttachmentInfo(i, &amp;uri, &amp;cid, &amp;name)) {</span>
<a href="#l28.318"></a><span id="l28.318">         if (!embeddedObjects) {</span>
<a href="#l28.319"></a><span id="l28.319">           embeddedObjects = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l28.320"></a><span id="l28.320">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.321"></a><span id="l28.321">         }</span>
<a href="#l28.322"></a><span id="l28.322">         nsCOMPtr&lt;nsIMsgEmbeddedImageData&gt; imageData =</span>
<a href="#l28.323"></a><span id="l28.323" class="difflineminus">-          new nsImportEmbeddedImageData(uri, nsDependentCString(cid),</span>
<a href="#l28.324"></a><span id="l28.324" class="difflineminus">-                                     nsDependentCString(name));</span>
<a href="#l28.325"></a><span id="l28.325" class="difflineplus">+            new nsImportEmbeddedImageData(uri, nsDependentCString(cid),</span>
<a href="#l28.326"></a><span id="l28.326" class="difflineplus">+                                          nsDependentCString(name));</span>
<a href="#l28.327"></a><span id="l28.327">         embeddedObjects-&gt;AppendElement(imageData);</span>
<a href="#l28.328"></a><span id="l28.328">       }</span>
<a href="#l28.329"></a><span id="l28.329">     }</span>
<a href="#l28.330"></a><span id="l28.330">   }</span>
<a href="#l28.331"></a><span id="l28.331"> </span>
<a href="#l28.332"></a><span id="l28.332">   nsCString bodyA;</span>
<a href="#l28.333"></a><span id="l28.333" class="difflineminus">-  const char *charset = msg.GetBodyCharset();</span>
<a href="#l28.334"></a><span id="l28.334" class="difflineminus">-  nsMsgI18NConvertFromUnicode(charset ? nsDependentCString(charset) : EmptyCString(), bodyW, bodyA);</span>
<a href="#l28.335"></a><span id="l28.335" class="difflineplus">+  const char* charset = msg.GetBodyCharset();</span>
<a href="#l28.336"></a><span id="l28.336" class="difflineplus">+  nsMsgI18NConvertFromUnicode(</span>
<a href="#l28.337"></a><span id="l28.337" class="difflineplus">+      charset ? nsDependentCString(charset) : EmptyCString(), bodyW, bodyA);</span>
<a href="#l28.338"></a><span id="l28.338"> </span>
<a href="#l28.339"></a><span id="l28.339" class="difflineminus">-  nsCOMPtr&lt;nsIImportService&gt; impService(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l28.340"></a><span id="l28.340" class="difflineplus">+  nsCOMPtr&lt;nsIImportService&gt; impService(</span>
<a href="#l28.341"></a><span id="l28.341" class="difflineplus">+      do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l28.342"></a><span id="l28.342">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.343"></a><span id="l28.343"> </span>
<a href="#l28.344"></a><span id="l28.344" class="difflineminus">-  // nsIImportService::CreateRFC822Message creates a runnable and dispatches to the main thread.</span>
<a href="#l28.345"></a><span id="l28.345" class="difflineplus">+  // nsIImportService::CreateRFC822Message creates a runnable and dispatches to</span>
<a href="#l28.346"></a><span id="l28.346" class="difflineplus">+  // the main thread.</span>
<a href="#l28.347"></a><span id="l28.347">   rv = impService-&gt;CreateRFC822Message(</span>
<a href="#l28.348"></a><span id="l28.348" class="difflineminus">-                        m_pIdentity,                  // dummy identity</span>
<a href="#l28.349"></a><span id="l28.349" class="difflineminus">-                        m_pMsgFields,                 // message fields</span>
<a href="#l28.350"></a><span id="l28.350" class="difflineminus">-                        msg.BodyIsHtml() ? &quot;text/html&quot; : &quot;text/plain&quot;,</span>
<a href="#l28.351"></a><span id="l28.351" class="difflineminus">-                        bodyA,                        // body pointer</span>
<a href="#l28.352"></a><span id="l28.352" class="difflineminus">-                        mode == nsIMsgSend::nsMsgSaveAsDraft,</span>
<a href="#l28.353"></a><span id="l28.353" class="difflineminus">-                        pAttach,                      // local attachments</span>
<a href="#l28.354"></a><span id="l28.354" class="difflineminus">-                        embeddedObjects,</span>
<a href="#l28.355"></a><span id="l28.355" class="difflineminus">-                        m_pListener);                 // listener</span>
<a href="#l28.356"></a><span id="l28.356" class="difflineplus">+      m_pIdentity,   // dummy identity</span>
<a href="#l28.357"></a><span id="l28.357" class="difflineplus">+      m_pMsgFields,  // message fields</span>
<a href="#l28.358"></a><span id="l28.358" class="difflineplus">+      msg.BodyIsHtml() ? &quot;text/html&quot; : &quot;text/plain&quot;,</span>
<a href="#l28.359"></a><span id="l28.359" class="difflineplus">+      bodyA,  // body pointer</span>
<a href="#l28.360"></a><span id="l28.360" class="difflineplus">+      mode == nsIMsgSend::nsMsgSaveAsDraft,</span>
<a href="#l28.361"></a><span id="l28.361" class="difflineplus">+      pAttach,  // local attachments</span>
<a href="#l28.362"></a><span id="l28.362" class="difflineplus">+      embeddedObjects,</span>
<a href="#l28.363"></a><span id="l28.363" class="difflineplus">+      m_pListener);  // listener</span>
<a href="#l28.364"></a><span id="l28.364"> </span>
<a href="#l28.365"></a><span id="l28.365" class="difflineminus">-  OutlookSendListener *pListen = static_cast&lt;OutlookSendListener *&gt;(m_pListener.get());</span>
<a href="#l28.366"></a><span id="l28.366" class="difflineplus">+  OutlookSendListener* pListen =</span>
<a href="#l28.367"></a><span id="l28.367" class="difflineplus">+      static_cast&lt;OutlookSendListener*&gt;(m_pListener.get());</span>
<a href="#l28.368"></a><span id="l28.368">   if (NS_FAILED(rv)) {</span>
<a href="#l28.369"></a><span id="l28.369">     IMPORT_LOG1(&quot;*** Error, CreateAndSendMessage FAILED: 0x%lx\n&quot;, rv);</span>
<a href="#l28.370"></a><span id="l28.370" class="difflineminus">-  }</span>
<a href="#l28.371"></a><span id="l28.371" class="difflineminus">-  else {</span>
<a href="#l28.372"></a><span id="l28.372" class="difflineplus">+  } else {</span>
<a href="#l28.373"></a><span id="l28.373">     // Wait for the listener to get done.</span>
<a href="#l28.374"></a><span id="l28.374">     nsCOMPtr&lt;nsIThread&gt; thread(do_GetCurrentThread());</span>
<a href="#l28.375"></a><span id="l28.375">     while (!pListen-&gt;m_done) {</span>
<a href="#l28.376"></a><span id="l28.376">       NS_ProcessPendingEvents(thread);</span>
<a href="#l28.377"></a><span id="l28.377">     }</span>
<a href="#l28.378"></a><span id="l28.378">   }</span>
<a href="#l28.379"></a><span id="l28.379"> </span>
<a href="#l28.380"></a><span id="l28.380">   if (pListen-&gt;m_location) {</span>
<a href="#l28.381"></a><span id="l28.381">     pListen-&gt;m_location-&gt;Clone(pMsg);</span>
<a href="#l28.382"></a><span id="l28.382">     rv = NS_OK;</span>
<a href="#l28.383"></a><span id="l28.383" class="difflineminus">-  }</span>
<a href="#l28.384"></a><span id="l28.384" class="difflineminus">-  else {</span>
<a href="#l28.385"></a><span id="l28.385" class="difflineplus">+  } else {</span>
<a href="#l28.386"></a><span id="l28.386">     rv = NS_ERROR_FAILURE;</span>
<a href="#l28.387"></a><span id="l28.387">     IMPORT_LOG0(&quot;*** Error, Outlook compose unsuccessful\n&quot;);</span>
<a href="#l28.388"></a><span id="l28.388">   }</span>
<a href="#l28.389"></a><span id="l28.389"> </span>
<a href="#l28.390"></a><span id="l28.390">   pListen-&gt;Reset();</span>
<a href="#l28.391"></a><span id="l28.391">   return rv;</span>
<a href="#l28.392"></a><span id="l28.392"> }</span>
<a href="#l28.393"></a><span id="l28.393"> </span>
<a href="#l28.394"></a><span id="l28.394" class="difflineminus">-nsresult nsOutlookCompose::CopyComposedMessage(nsIFile *pSrc,</span>
<a href="#l28.395"></a><span id="l28.395" class="difflineminus">-                                               nsIOutputStream *pDst,</span>
<a href="#l28.396"></a><span id="l28.396" class="difflineminus">-                                               CMapiMessage&amp; origMsg)</span>
<a href="#l28.397"></a><span id="l28.397" class="difflineminus">-{</span>
<a href="#l28.398"></a><span id="l28.398" class="difflineplus">+nsresult nsOutlookCompose::CopyComposedMessage(nsIFile* pSrc,</span>
<a href="#l28.399"></a><span id="l28.399" class="difflineplus">+                                               nsIOutputStream* pDst,</span>
<a href="#l28.400"></a><span id="l28.400" class="difflineplus">+                                               CMapiMessage&amp; origMsg) {</span>
<a href="#l28.401"></a><span id="l28.401">   // I'm unsure if we really need the convertCRs feature here.</span>
<a href="#l28.402"></a><span id="l28.402" class="difflineminus">-  // The headers in the file are generated by TB, the body was generated by rtf reader that always used CRLF,</span>
<a href="#l28.403"></a><span id="l28.403" class="difflineminus">-  // and the attachments were processed by TB either... However, I let it stay as it was in the original code.</span>
<a href="#l28.404"></a><span id="l28.404" class="difflineplus">+  // The headers in the file are generated by TB, the body was generated by rtf</span>
<a href="#l28.405"></a><span id="l28.405" class="difflineplus">+  // reader that always used CRLF, and the attachments were processed by TB</span>
<a href="#l28.406"></a><span id="l28.406" class="difflineplus">+  // either... However, I let it stay as it was in the original code.</span>
<a href="#l28.407"></a><span id="l28.407">   CCompositionFile f(pSrc, m_optimizationBuffer, FILE_IO_BUFFER_SIZE, true);</span>
<a href="#l28.408"></a><span id="l28.408">   if (!f) {</span>
<a href="#l28.409"></a><span id="l28.409">     IMPORT_LOG0(&quot;*** Error, unexpected zero file size for composed message\n&quot;);</span>
<a href="#l28.410"></a><span id="l28.410">     return NS_ERROR_FAILURE;</span>
<a href="#l28.411"></a><span id="l28.411">   }</span>
<a href="#l28.412"></a><span id="l28.412"> </span>
<a href="#l28.413"></a><span id="l28.413" class="difflineminus">-  // The &quot;From ...&quot; separates the messages. Without it, TB cannot see the messages in the mailbox file.</span>
<a href="#l28.414"></a><span id="l28.414" class="difflineminus">-  // Thus, the lines that look like &quot;From ...&quot; in the message must be escaped (see EscapeFromSpaceLine())</span>
<a href="#l28.415"></a><span id="l28.415" class="difflineplus">+  // The &quot;From ...&quot; separates the messages. Without it, TB cannot see the</span>
<a href="#l28.416"></a><span id="l28.416" class="difflineplus">+  // messages in the mailbox file. Thus, the lines that look like &quot;From ...&quot; in</span>
<a href="#l28.417"></a><span id="l28.417" class="difflineplus">+  // the message must be escaped (see EscapeFromSpaceLine())</span>
<a href="#l28.418"></a><span id="l28.418">   int fromLineLen;</span>
<a href="#l28.419"></a><span id="l28.419">   const char* fromLine = origMsg.GetFromLine(fromLineLen);</span>
<a href="#l28.420"></a><span id="l28.420">   uint32_t written;</span>
<a href="#l28.421"></a><span id="l28.421">   nsresult rv = pDst-&gt;Write(fromLine, fromLineLen, &amp;written);</span>
<a href="#l28.422"></a><span id="l28.422"> </span>
<a href="#l28.423"></a><span id="l28.423">   // Bug 219269</span>
<a href="#l28.424"></a><span id="l28.424">   // Write out the x-mozilla-status headers.</span>
<a href="#l28.425"></a><span id="l28.425">   char statusLine[50];</span>
<a href="#l28.426"></a><span id="l28.426">   uint32_t msgFlags = 0;</span>
<a href="#l28.427"></a><span id="l28.427" class="difflineminus">-  if (origMsg.IsRead())</span>
<a href="#l28.428"></a><span id="l28.428" class="difflineminus">-    msgFlags |= nsMsgMessageFlags::Read;</span>
<a href="#l28.429"></a><span id="l28.429" class="difflineminus">-  if (!origMsg.FullMessageDownloaded())</span>
<a href="#l28.430"></a><span id="l28.430" class="difflineminus">-    msgFlags |= nsMsgMessageFlags::Partial;</span>
<a href="#l28.431"></a><span id="l28.431" class="difflineminus">-  if (origMsg.IsForvarded())</span>
<a href="#l28.432"></a><span id="l28.432" class="difflineminus">-    msgFlags |= nsMsgMessageFlags::Forwarded;</span>
<a href="#l28.433"></a><span id="l28.433" class="difflineminus">-  if (origMsg.IsReplied())</span>
<a href="#l28.434"></a><span id="l28.434" class="difflineminus">-    msgFlags |= nsMsgMessageFlags::Replied;</span>
<a href="#l28.435"></a><span id="l28.435" class="difflineminus">-  if (origMsg.HasAttach())</span>
<a href="#l28.436"></a><span id="l28.436" class="difflineminus">-    msgFlags |= nsMsgMessageFlags::Attachment;</span>
<a href="#l28.437"></a><span id="l28.437" class="difflineminus">-  _snprintf(statusLine, sizeof(statusLine), X_MOZILLA_STATUS_FORMAT MSG_LINEBREAK, msgFlags &amp; 0xFFFF);</span>
<a href="#l28.438"></a><span id="l28.438" class="difflineplus">+  if (origMsg.IsRead()) msgFlags |= nsMsgMessageFlags::Read;</span>
<a href="#l28.439"></a><span id="l28.439" class="difflineplus">+  if (!origMsg.FullMessageDownloaded()) msgFlags |= nsMsgMessageFlags::Partial;</span>
<a href="#l28.440"></a><span id="l28.440" class="difflineplus">+  if (origMsg.IsForvarded()) msgFlags |= nsMsgMessageFlags::Forwarded;</span>
<a href="#l28.441"></a><span id="l28.441" class="difflineplus">+  if (origMsg.IsReplied()) msgFlags |= nsMsgMessageFlags::Replied;</span>
<a href="#l28.442"></a><span id="l28.442" class="difflineplus">+  if (origMsg.HasAttach()) msgFlags |= nsMsgMessageFlags::Attachment;</span>
<a href="#l28.443"></a><span id="l28.443" class="difflineplus">+  _snprintf(statusLine, sizeof(statusLine),</span>
<a href="#l28.444"></a><span id="l28.444" class="difflineplus">+            X_MOZILLA_STATUS_FORMAT MSG_LINEBREAK, msgFlags &amp; 0xFFFF);</span>
<a href="#l28.445"></a><span id="l28.445">   rv = pDst-&gt;Write(statusLine, strlen(statusLine), &amp;written);</span>
<a href="#l28.446"></a><span id="l28.446" class="difflineminus">-  _snprintf(statusLine, sizeof(statusLine), X_MOZILLA_STATUS2_FORMAT MSG_LINEBREAK, msgFlags &amp; 0xFFFF0000);</span>
<a href="#l28.447"></a><span id="l28.447" class="difflineplus">+  _snprintf(statusLine, sizeof(statusLine),</span>
<a href="#l28.448"></a><span id="l28.448" class="difflineplus">+            X_MOZILLA_STATUS2_FORMAT MSG_LINEBREAK, msgFlags &amp; 0xFFFF0000);</span>
<a href="#l28.449"></a><span id="l28.449">   rv = pDst-&gt;Write(statusLine, strlen(statusLine), &amp;written);</span>
<a href="#l28.450"></a><span id="l28.450">   // End Bug 219269</span>
<a href="#l28.451"></a><span id="l28.451"> </span>
<a href="#l28.452"></a><span id="l28.452">   // well, isn't this a hoot!</span>
<a href="#l28.453"></a><span id="l28.453">   // Read the headers from the new message, get the ones we like</span>
<a href="#l28.454"></a><span id="l28.454">   // and write out only the headers we want from the new message,</span>
<a href="#l28.455"></a><span id="l28.455">   // along with all of the other headers from the &quot;old&quot; message!</span>
<a href="#l28.456"></a><span id="l28.456"> </span>
<a href="#l28.457"></a><span id="l28.457">   nsCString newHeadersStr;</span>
<a href="#l28.458"></a><span id="l28.458" class="difflineminus">-  rv = f.ToString(newHeadersStr, MSG_LINEBREAK MSG_LINEBREAK); // Read all the headers</span>
<a href="#l28.459"></a><span id="l28.459" class="difflineplus">+  rv = f.ToString(newHeadersStr,</span>
<a href="#l28.460"></a><span id="l28.460" class="difflineplus">+                  MSG_LINEBREAK MSG_LINEBREAK);  // Read all the headers</span>
<a href="#l28.461"></a><span id="l28.461">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.462"></a><span id="l28.462" class="difflineminus">-  UpdateHeaders(*origMsg.GetHeaders(), CMapiMessageHeaders(newHeadersStr.get()));</span>
<a href="#l28.463"></a><span id="l28.463" class="difflineplus">+  UpdateHeaders(*origMsg.GetHeaders(),</span>
<a href="#l28.464"></a><span id="l28.464" class="difflineplus">+                CMapiMessageHeaders(newHeadersStr.get()));</span>
<a href="#l28.465"></a><span id="l28.465">   rv = origMsg.GetHeaders()-&gt;ToStream(pDst);</span>
<a href="#l28.466"></a><span id="l28.466">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.467"></a><span id="l28.467"> </span>
<a href="#l28.468"></a><span id="l28.468" class="difflineminus">-  // I use the terminating sequence here to avoid a possible situation when a &quot;From &quot; line</span>
<a href="#l28.469"></a><span id="l28.469" class="difflineminus">-  // gets split over two sequential reads and thus will not be escaped.</span>
<a href="#l28.470"></a><span id="l28.470" class="difflineminus">-  // This is done by reading up to CRLF (one line every time), though it may be slower</span>
<a href="#l28.471"></a><span id="l28.471" class="difflineplus">+  // I use the terminating sequence here to avoid a possible situation when a</span>
<a href="#l28.472"></a><span id="l28.472" class="difflineplus">+  // &quot;From &quot; line gets split over two sequential reads and thus will not be</span>
<a href="#l28.473"></a><span id="l28.473" class="difflineplus">+  // escaped. This is done by reading up to CRLF (one line every time), though</span>
<a href="#l28.474"></a><span id="l28.474" class="difflineplus">+  // it may be slower</span>
<a href="#l28.475"></a><span id="l28.475"> </span>
<a href="#l28.476"></a><span id="l28.476">   // Here I revert the changes that were made when the multipart/related message</span>
<a href="#l28.477"></a><span id="l28.477">   // was composed in nsMsgSend::ProcessMultipartRelated() - the Content-Ids of</span>
<a href="#l28.478"></a><span id="l28.478">   // attachments were replaced with new ones.</span>
<a href="#l28.479"></a><span id="l28.479">   nsCString line;</span>
<a href="#l28.480"></a><span id="l28.480">   while (NS_SUCCEEDED(f.ToString(line, MSG_LINEBREAK))) {</span>
<a href="#l28.481"></a><span id="l28.481" class="difflineminus">-    EscapeFromSpaceLine(pDst, const_cast&lt;char*&gt;(line.get()), line.get()+line.Length());</span>
<a href="#l28.482"></a><span id="l28.482" class="difflineplus">+    EscapeFromSpaceLine(pDst, const_cast&lt;char*&gt;(line.get()),</span>
<a href="#l28.483"></a><span id="l28.483" class="difflineplus">+                        line.get() + line.Length());</span>
<a href="#l28.484"></a><span id="l28.484">   }</span>
<a href="#l28.485"></a><span id="l28.485"> </span>
<a href="#l28.486"></a><span id="l28.486">   if (f.LastChar() != nsCRT::LF) {</span>
<a href="#l28.487"></a><span id="l28.487">     rv = pDst-&gt;Write(MSG_LINEBREAK, 2, &amp;written);</span>
<a href="#l28.488"></a><span id="l28.488" class="difflineminus">-    if (written != 2)</span>
<a href="#l28.489"></a><span id="l28.489" class="difflineminus">-      rv = NS_ERROR_FAILURE;</span>
<a href="#l28.490"></a><span id="l28.490" class="difflineplus">+    if (written != 2) rv = NS_ERROR_FAILURE;</span>
<a href="#l28.491"></a><span id="l28.491">   }</span>
<a href="#l28.492"></a><span id="l28.492"> </span>
<a href="#l28.493"></a><span id="l28.493">   return rv;</span>
<a href="#l28.494"></a><span id="l28.494"> }</span>
<a href="#l28.495"></a><span id="l28.495"> </span>
<a href="#l28.496"></a><span id="l28.496"> nsresult nsOutlookCompose::ProcessMessage(nsMsgDeliverMode mode,</span>
<a href="#l28.497"></a><span id="l28.497" class="difflineminus">-                                          CMapiMessage &amp;msg,</span>
<a href="#l28.498"></a><span id="l28.498" class="difflineminus">-                                          nsIOutputStream *pDst)</span>
<a href="#l28.499"></a><span id="l28.499" class="difflineminus">-{</span>
<a href="#l28.500"></a><span id="l28.500" class="difflineplus">+                                          CMapiMessage&amp; msg,</span>
<a href="#l28.501"></a><span id="l28.501" class="difflineplus">+                                          nsIOutputStream* pDst) {</span>
<a href="#l28.502"></a><span id="l28.502">   nsCOMPtr&lt;nsIFile&gt; compositionFile;</span>
<a href="#l28.503"></a><span id="l28.503">   nsresult rv = ComposeTheMessage(mode, msg, getter_AddRefs(compositionFile));</span>
<a href="#l28.504"></a><span id="l28.504">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.505"></a><span id="l28.505">   rv = CopyComposedMessage(compositionFile, pDst, msg);</span>
<a href="#l28.506"></a><span id="l28.506">   compositionFile-&gt;Remove(false);</span>
<a href="#l28.507"></a><span id="l28.507">   if (NS_FAILED(rv)) {</span>
<a href="#l28.508"></a><span id="l28.508">     IMPORT_LOG0(&quot;*** Error copying composed message to destination mailbox\n&quot;);</span>
<a href="#l28.509"></a><span id="l28.509">   }</span>
<a href="#l28.510"></a><span id="l28.510">   return rv;</span>
<a href="#l28.511"></a><span id="l28.511"> }</span>
<a href="#l28.512"></a><span id="l28.512"> </span>
<a href="#l28.513"></a><span id="l28.513"> void nsOutlookCompose::UpdateHeader(CMapiMessageHeaders&amp; oldHeaders,</span>
<a href="#l28.514"></a><span id="l28.514">                                     const CMapiMessageHeaders&amp; newHeaders,</span>
<a href="#l28.515"></a><span id="l28.515">                                     CMapiMessageHeaders::SpecialHeader header,</span>
<a href="#l28.516"></a><span id="l28.516" class="difflineminus">-                                    bool addIfAbsent)</span>
<a href="#l28.517"></a><span id="l28.517" class="difflineminus">-{</span>
<a href="#l28.518"></a><span id="l28.518" class="difflineplus">+                                    bool addIfAbsent) {</span>
<a href="#l28.519"></a><span id="l28.519">   const char* oldVal = oldHeaders.Value(header);</span>
<a href="#l28.520"></a><span id="l28.520" class="difflineminus">-  if (!addIfAbsent &amp;&amp; !oldVal)</span>
<a href="#l28.521"></a><span id="l28.521" class="difflineminus">-    return;</span>
<a href="#l28.522"></a><span id="l28.522" class="difflineplus">+  if (!addIfAbsent &amp;&amp; !oldVal) return;</span>
<a href="#l28.523"></a><span id="l28.523">   const char* newVal = newHeaders.Value(header);</span>
<a href="#l28.524"></a><span id="l28.524" class="difflineminus">-  if (!newVal)</span>
<a href="#l28.525"></a><span id="l28.525" class="difflineminus">-    return;</span>
<a href="#l28.526"></a><span id="l28.526" class="difflineminus">-  // Bug 145150 - Turn &quot;Content-Type: application/ms-tnef&quot; into &quot;Content-Type: text/plain&quot;</span>
<a href="#l28.527"></a><span id="l28.527" class="difflineminus">-  //              so the body text can be displayed normally (instead of in an attachment).</span>
<a href="#l28.528"></a><span id="l28.528" class="difflineplus">+  if (!newVal) return;</span>
<a href="#l28.529"></a><span id="l28.529" class="difflineplus">+  // Bug 145150 - Turn &quot;Content-Type: application/ms-tnef&quot; into &quot;Content-Type:</span>
<a href="#l28.530"></a><span id="l28.530" class="difflineplus">+  // text/plain&quot;</span>
<a href="#l28.531"></a><span id="l28.531" class="difflineplus">+  //              so the body text can be displayed normally (instead of in an</span>
<a href="#l28.532"></a><span id="l28.532" class="difflineplus">+  //              attachment).</span>
<a href="#l28.533"></a><span id="l28.533">   if (header == CMapiMessageHeaders::hdrContentType)</span>
<a href="#l28.534"></a><span id="l28.534" class="difflineminus">-    if (stricmp(newVal, &quot;application/ms-tnef&quot;) == 0)</span>
<a href="#l28.535"></a><span id="l28.535" class="difflineminus">-      newVal = &quot;text/plain&quot;;</span>
<a href="#l28.536"></a><span id="l28.536" class="difflineplus">+    if (stricmp(newVal, &quot;application/ms-tnef&quot;) == 0) newVal = &quot;text/plain&quot;;</span>
<a href="#l28.537"></a><span id="l28.537">   // End Bug 145150</span>
<a href="#l28.538"></a><span id="l28.538">   if (oldVal) {</span>
<a href="#l28.539"></a><span id="l28.539" class="difflineminus">-    if (strcmp(oldVal, newVal) == 0)</span>
<a href="#l28.540"></a><span id="l28.540" class="difflineminus">-      return;</span>
<a href="#l28.541"></a><span id="l28.541" class="difflineplus">+    if (strcmp(oldVal, newVal) == 0) return;</span>
<a href="#l28.542"></a><span id="l28.542">     // Backup the old header value</span>
<a href="#l28.543"></a><span id="l28.543">     nsCString backupHdrName(&quot;X-MozillaBackup-&quot;);</span>
<a href="#l28.544"></a><span id="l28.544">     backupHdrName += CMapiMessageHeaders::SpecialName(header);</span>
<a href="#l28.545"></a><span id="l28.545">     oldHeaders.SetValue(backupHdrName.get(), oldVal, false);</span>
<a href="#l28.546"></a><span id="l28.546">   }</span>
<a href="#l28.547"></a><span id="l28.547">   // Now replace it with new value</span>
<a href="#l28.548"></a><span id="l28.548">   oldHeaders.SetValue(header, newVal);</span>
<a href="#l28.549"></a><span id="l28.549"> }</span>
<a href="#l28.550"></a><span id="l28.550"> </span>
<a href="#l28.551"></a><span id="l28.551" class="difflineminus">-void nsOutlookCompose::UpdateHeaders(CMapiMessageHeaders&amp; oldHeaders, const CMapiMessageHeaders&amp; newHeaders)</span>
<a href="#l28.552"></a><span id="l28.552" class="difflineminus">-{</span>
<a href="#l28.553"></a><span id="l28.553" class="difflineplus">+void nsOutlookCompose::UpdateHeaders(CMapiMessageHeaders&amp; oldHeaders,</span>
<a href="#l28.554"></a><span id="l28.554" class="difflineplus">+                                     const CMapiMessageHeaders&amp; newHeaders) {</span>
<a href="#l28.555"></a><span id="l28.555">   // Well, ain't this a peach?</span>
<a href="#l28.556"></a><span id="l28.556" class="difflineminus">-  // This is rather disgusting but there really isn't much to be done about it....</span>
<a href="#l28.557"></a><span id="l28.557" class="difflineplus">+  // This is rather disgusting but there really isn't much to be done about</span>
<a href="#l28.558"></a><span id="l28.558" class="difflineplus">+  // it....</span>
<a href="#l28.559"></a><span id="l28.559"> </span>
<a href="#l28.560"></a><span id="l28.560">   // 1. For each &quot;old&quot; header, replace it with the new one if we want,</span>
<a href="#l28.561"></a><span id="l28.561">   // then right it out.</span>
<a href="#l28.562"></a><span id="l28.562">   // 2. Then if we haven't written the &quot;important&quot; new headers, write them out</span>
<a href="#l28.563"></a><span id="l28.563">   // 3. Terminate the headers with an extra eol.</span>
<a href="#l28.564"></a><span id="l28.564"> </span>
<a href="#l28.565"></a><span id="l28.565">   // Important headers:</span>
<a href="#l28.566"></a><span id="l28.566">   //  &quot;Content-type&quot;,</span>
<a href="#l28.567"></a><span id="l28.567">   //  &quot;MIME-Version&quot;,</span>
<a href="#l28.568"></a><span id="l28.568">   //  &quot;Content-transfer-encoding&quot;</span>
<a href="#l28.569"></a><span id="l28.569">   // consider &quot;X-Accept-Language&quot;?</span>
<a href="#l28.570"></a><span id="l28.570"> </span>
<a href="#l28.571"></a><span id="l28.571">   UpdateHeader(oldHeaders, newHeaders, CMapiMessageHeaders::hdrContentType);</span>
<a href="#l28.572"></a><span id="l28.572">   UpdateHeader(oldHeaders, newHeaders, CMapiMessageHeaders::hdrMimeVersion);</span>
<a href="#l28.573"></a><span id="l28.573" class="difflineminus">-  UpdateHeader(oldHeaders, newHeaders, CMapiMessageHeaders::hdrContentTransferEncoding);</span>
<a href="#l28.574"></a><span id="l28.574" class="difflineplus">+  UpdateHeader(oldHeaders, newHeaders,</span>
<a href="#l28.575"></a><span id="l28.575" class="difflineplus">+               CMapiMessageHeaders::hdrContentTransferEncoding);</span>
<a href="#l28.576"></a><span id="l28.576"> </span>
<a href="#l28.577"></a><span id="l28.577">   // Other replaced headers (only if they exist):</span>
<a href="#l28.578"></a><span id="l28.578">   //  &quot;From&quot;,</span>
<a href="#l28.579"></a><span id="l28.579">   //  &quot;To&quot;,</span>
<a href="#l28.580"></a><span id="l28.580">   //  &quot;Subject&quot;,</span>
<a href="#l28.581"></a><span id="l28.581">   //  &quot;Reply-to&quot;,</span>
<a href="#l28.582"></a><span id="l28.582">   //  &quot;Cc&quot;</span>
<a href="#l28.583"></a><span id="l28.583"> </span>
<a href="#l28.584"></a><span id="l28.584" class="difflineat">@@ -471,176 +487,175 @@ void nsOutlookCompose::UpdateHeaders(CMa</span>
<a href="#l28.585"></a><span id="l28.585">   UpdateHeader(oldHeaders, newHeaders, CMapiMessageHeaders::hdrReplyTo, false);</span>
<a href="#l28.586"></a><span id="l28.586">   UpdateHeader(oldHeaders, newHeaders, CMapiMessageHeaders::hdrCc, false);</span>
<a href="#l28.587"></a><span id="l28.587"> }</span>
<a href="#l28.588"></a><span id="l28.588"> </span>
<a href="#l28.589"></a><span id="l28.589"> //////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l28.590"></a><span id="l28.590"> </span>
<a href="#l28.591"></a><span id="l28.591"> CCompositionFile::CCompositionFile(nsIFile* aFile, void* fifoBuffer,</span>
<a href="#l28.592"></a><span id="l28.592">                                    uint32_t fifoBufferSize, bool convertCRs)</span>
<a href="#l28.593"></a><span id="l28.593" class="difflineminus">-  : m_pFile(aFile), m_fileSize(0), m_fileReadPos(0),</span>
<a href="#l28.594"></a><span id="l28.594" class="difflineminus">-    m_fifoBuffer(static_cast&lt;char*&gt;(fifoBuffer)),</span>
<a href="#l28.595"></a><span id="l28.595" class="difflineminus">-    m_fifoBufferSize(fifoBufferSize),</span>
<a href="#l28.596"></a><span id="l28.596" class="difflineminus">-    m_fifoBufferReadPos(static_cast&lt;char*&gt;(fifoBuffer)),</span>
<a href="#l28.597"></a><span id="l28.597" class="difflineminus">-    m_fifoBufferWrittenPos(static_cast&lt;char*&gt;(fifoBuffer)),</span>
<a href="#l28.598"></a><span id="l28.598" class="difflineminus">-    m_convertCRs(convertCRs),</span>
<a href="#l28.599"></a><span id="l28.599" class="difflineminus">-    m_lastChar(0)</span>
<a href="#l28.600"></a><span id="l28.600" class="difflineminus">-{</span>
<a href="#l28.601"></a><span id="l28.601" class="difflineplus">+    : m_pFile(aFile),</span>
<a href="#l28.602"></a><span id="l28.602" class="difflineplus">+      m_fileSize(0),</span>
<a href="#l28.603"></a><span id="l28.603" class="difflineplus">+      m_fileReadPos(0),</span>
<a href="#l28.604"></a><span id="l28.604" class="difflineplus">+      m_fifoBuffer(static_cast&lt;char*&gt;(fifoBuffer)),</span>
<a href="#l28.605"></a><span id="l28.605" class="difflineplus">+      m_fifoBufferSize(fifoBufferSize),</span>
<a href="#l28.606"></a><span id="l28.606" class="difflineplus">+      m_fifoBufferReadPos(static_cast&lt;char*&gt;(fifoBuffer)),</span>
<a href="#l28.607"></a><span id="l28.607" class="difflineplus">+      m_fifoBufferWrittenPos(static_cast&lt;char*&gt;(fifoBuffer)),</span>
<a href="#l28.608"></a><span id="l28.608" class="difflineplus">+      m_convertCRs(convertCRs),</span>
<a href="#l28.609"></a><span id="l28.609" class="difflineplus">+      m_lastChar(0) {</span>
<a href="#l28.610"></a><span id="l28.610">   m_pFile-&gt;GetFileSize(&amp;m_fileSize);</span>
<a href="#l28.611"></a><span id="l28.611">   if (!m_fileSize) {</span>
<a href="#l28.612"></a><span id="l28.612">     IMPORT_LOG0(&quot;*** Error, unexpected zero file size for composed message\n&quot;);</span>
<a href="#l28.613"></a><span id="l28.613">     return;</span>
<a href="#l28.614"></a><span id="l28.614">   }</span>
<a href="#l28.615"></a><span id="l28.615"> </span>
<a href="#l28.616"></a><span id="l28.616" class="difflineminus">-  nsresult rv = NS_NewLocalFileInputStream(getter_AddRefs(m_pInputStream), m_pFile);</span>
<a href="#l28.617"></a><span id="l28.617" class="difflineplus">+  nsresult rv =</span>
<a href="#l28.618"></a><span id="l28.618" class="difflineplus">+      NS_NewLocalFileInputStream(getter_AddRefs(m_pInputStream), m_pFile);</span>
<a href="#l28.619"></a><span id="l28.619">   if (NS_FAILED(rv)) {</span>
<a href="#l28.620"></a><span id="l28.620">     IMPORT_LOG0(&quot;*** Error, unable to open composed message file\n&quot;);</span>
<a href="#l28.621"></a><span id="l28.621">     return;</span>
<a href="#l28.622"></a><span id="l28.622">   }</span>
<a href="#l28.623"></a><span id="l28.623"> }</span>
<a href="#l28.624"></a><span id="l28.624"> </span>
<a href="#l28.625"></a><span id="l28.625" class="difflineminus">-nsresult CCompositionFile::EnsureHasDataInBuffer()</span>
<a href="#l28.626"></a><span id="l28.626" class="difflineminus">-{</span>
<a href="#l28.627"></a><span id="l28.627" class="difflineminus">-  if (m_fifoBufferReadPos &lt; m_fifoBufferWrittenPos)</span>
<a href="#l28.628"></a><span id="l28.628" class="difflineminus">-    return NS_OK;</span>
<a href="#l28.629"></a><span id="l28.629" class="difflineplus">+nsresult CCompositionFile::EnsureHasDataInBuffer() {</span>
<a href="#l28.630"></a><span id="l28.630" class="difflineplus">+  if (m_fifoBufferReadPos &lt; m_fifoBufferWrittenPos) return NS_OK;</span>
<a href="#l28.631"></a><span id="l28.631">   // Populate the buffer with new data!</span>
<a href="#l28.632"></a><span id="l28.632">   uint32_t count = m_fifoBufferSize;</span>
<a href="#l28.633"></a><span id="l28.633" class="difflineminus">-  if ((m_fileReadPos + count) &gt; m_fileSize)</span>
<a href="#l28.634"></a><span id="l28.634" class="difflineminus">-    count = m_fileSize - m_fileReadPos;</span>
<a href="#l28.635"></a><span id="l28.635" class="difflineminus">-  if (!count)</span>
<a href="#l28.636"></a><span id="l28.636" class="difflineminus">-    return NS_ERROR_FAILURE; // Isn't there a &quot;No more data&quot; error?</span>
<a href="#l28.637"></a><span id="l28.637" class="difflineplus">+  if ((m_fileReadPos + count) &gt; m_fileSize) count = m_fileSize - m_fileReadPos;</span>
<a href="#l28.638"></a><span id="l28.638" class="difflineplus">+  if (!count) return NS_ERROR_FAILURE;  // Isn't there a &quot;No more data&quot; error?</span>
<a href="#l28.639"></a><span id="l28.639"> </span>
<a href="#l28.640"></a><span id="l28.640">   uint32_t bytesRead = 0;</span>
<a href="#l28.641"></a><span id="l28.641">   nsresult rv = m_pInputStream-&gt;Read(m_fifoBuffer, count, &amp;bytesRead);</span>
<a href="#l28.642"></a><span id="l28.642">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.643"></a><span id="l28.643" class="difflineminus">-  if (!bytesRead || (bytesRead &gt; count))</span>
<a href="#l28.644"></a><span id="l28.644" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l28.645"></a><span id="l28.645" class="difflineminus">-  m_fifoBufferWrittenPos = m_fifoBuffer+bytesRead;</span>
<a href="#l28.646"></a><span id="l28.646" class="difflineplus">+  if (!bytesRead || (bytesRead &gt; count)) return NS_ERROR_FAILURE;</span>
<a href="#l28.647"></a><span id="l28.647" class="difflineplus">+  m_fifoBufferWrittenPos = m_fifoBuffer + bytesRead;</span>
<a href="#l28.648"></a><span id="l28.648">   m_fifoBufferReadPos = m_fifoBuffer;</span>
<a href="#l28.649"></a><span id="l28.649">   m_fileReadPos += bytesRead;</span>
<a href="#l28.650"></a><span id="l28.650"> </span>
<a href="#l28.651"></a><span id="l28.651">   return NS_OK;</span>
<a href="#l28.652"></a><span id="l28.652"> }</span>
<a href="#l28.653"></a><span id="l28.653"> </span>
<a href="#l28.654"></a><span id="l28.654"> class CTermGuard {</span>
<a href="#l28.655"></a><span id="l28.655" class="difflineminus">-public:</span>
<a href="#l28.656"></a><span id="l28.656" class="difflineplus">+ public:</span>
<a href="#l28.657"></a><span id="l28.657">   CTermGuard(const char* term, int termSize)</span>
<a href="#l28.658"></a><span id="l28.658" class="difflineminus">-    : m_term(term),</span>
<a href="#l28.659"></a><span id="l28.659" class="difflineminus">-    m_termSize(term ? ((termSize!=-1) ? termSize : strlen(term)) : 0),</span>
<a href="#l28.660"></a><span id="l28.660" class="difflineminus">-    m_matchPos(0)</span>
<a href="#l28.661"></a><span id="l28.661" class="difflineminus">-  {}</span>
<a href="#l28.662"></a><span id="l28.662" class="difflineplus">+      : m_term(term),</span>
<a href="#l28.663"></a><span id="l28.663" class="difflineplus">+        m_termSize(term ? ((termSize != -1) ? termSize : strlen(term)) : 0),</span>
<a href="#l28.664"></a><span id="l28.664" class="difflineplus">+        m_matchPos(0) {}</span>
<a href="#l28.665"></a><span id="l28.665"> </span>
<a href="#l28.666"></a><span id="l28.666" class="difflineminus">-   // if the guard triggered</span>
<a href="#l28.667"></a><span id="l28.667" class="difflineplus">+  // if the guard triggered</span>
<a href="#l28.668"></a><span id="l28.668">   inline bool IsTriggered() const {</span>
<a href="#l28.669"></a><span id="l28.669" class="difflineminus">-    return m_termSize &amp;&amp; (m_matchPos == m_termSize); }</span>
<a href="#l28.670"></a><span id="l28.670" class="difflineplus">+    return m_termSize &amp;&amp; (m_matchPos == m_termSize);</span>
<a href="#l28.671"></a><span id="l28.671" class="difflineplus">+  }</span>
<a href="#l28.672"></a><span id="l28.672">   // indicates if the guard has something to check</span>
<a href="#l28.673"></a><span id="l28.673">   inline bool IsChecking() const { return m_termSize; }</span>
<a href="#l28.674"></a><span id="l28.674"> </span>
<a href="#l28.675"></a><span id="l28.675" class="difflineminus">-  bool Check(char c) // returns true only if the whole sequence passed</span>
<a href="#l28.676"></a><span id="l28.676" class="difflineplus">+  bool Check(char c)  // returns true only if the whole sequence passed</span>
<a href="#l28.677"></a><span id="l28.677">   {</span>
<a href="#l28.678"></a><span id="l28.678" class="difflineminus">-    if (!m_termSize) // no guard</span>
<a href="#l28.679"></a><span id="l28.679" class="difflineplus">+    if (!m_termSize)  // no guard</span>
<a href="#l28.680"></a><span id="l28.680">       return false;</span>
<a href="#l28.681"></a><span id="l28.681" class="difflineminus">-    if (m_matchPos &gt;= m_termSize) // check past success!</span>
<a href="#l28.682"></a><span id="l28.682" class="difflineplus">+    if (m_matchPos &gt;= m_termSize)  // check past success!</span>
<a href="#l28.683"></a><span id="l28.683">       m_matchPos = 0;</span>
<a href="#l28.684"></a><span id="l28.684" class="difflineminus">-    if (m_term[m_matchPos] != c) // Reset sequence</span>
<a href="#l28.685"></a><span id="l28.685" class="difflineplus">+    if (m_term[m_matchPos] != c)  // Reset sequence</span>
<a href="#l28.686"></a><span id="l28.686">       m_matchPos = 0;</span>
<a href="#l28.687"></a><span id="l28.687" class="difflineminus">-    if (m_term[m_matchPos] == c) { // Sequence continues</span>
<a href="#l28.688"></a><span id="l28.688" class="difflineminus">-      return ++m_matchPos == m_termSize; // If equal then sequence complete!</span>
<a href="#l28.689"></a><span id="l28.689" class="difflineplus">+    if (m_term[m_matchPos] == c) {        // Sequence continues</span>
<a href="#l28.690"></a><span id="l28.690" class="difflineplus">+      return ++m_matchPos == m_termSize;  // If equal then sequence complete!</span>
<a href="#l28.691"></a><span id="l28.691">     }</span>
<a href="#l28.692"></a><span id="l28.692">     // Sequence broken</span>
<a href="#l28.693"></a><span id="l28.693">     return false;</span>
<a href="#l28.694"></a><span id="l28.694">   }</span>
<a href="#l28.695"></a><span id="l28.695" class="difflineminus">-private:</span>
<a href="#l28.696"></a><span id="l28.696" class="difflineplus">+</span>
<a href="#l28.697"></a><span id="l28.697" class="difflineplus">+ private:</span>
<a href="#l28.698"></a><span id="l28.698">   const char* m_term;</span>
<a href="#l28.699"></a><span id="l28.699">   int m_termSize;</span>
<a href="#l28.700"></a><span id="l28.700">   int m_matchPos;</span>
<a href="#l28.701"></a><span id="l28.701"> };</span>
<a href="#l28.702"></a><span id="l28.702"> </span>
<a href="#l28.703"></a><span id="l28.703"> template &lt;class _OutFn&gt;</span>
<a href="#l28.704"></a><span id="l28.704" class="difflineminus">-nsresult CCompositionFile::ToDest(_OutFn dest, const char* term, int termSize)</span>
<a href="#l28.705"></a><span id="l28.705" class="difflineminus">-{</span>
<a href="#l28.706"></a><span id="l28.706" class="difflineplus">+nsresult CCompositionFile::ToDest(_OutFn dest, const char* term, int termSize) {</span>
<a href="#l28.707"></a><span id="l28.707">   CTermGuard guard(term, termSize);</span>
<a href="#l28.708"></a><span id="l28.708"> </span>
<a href="#l28.709"></a><span id="l28.709">   // We already know the required string size, so reduce future reallocations</span>
<a href="#l28.710"></a><span id="l28.710">   if (!guard.IsChecking() &amp;&amp; !m_convertCRs)</span>
<a href="#l28.711"></a><span id="l28.711">     dest.SetCapacity(m_fileSize - m_fileReadPos);</span>
<a href="#l28.712"></a><span id="l28.712"> </span>
<a href="#l28.713"></a><span id="l28.713">   bool wasCR = false;</span>
<a href="#l28.714"></a><span id="l28.714">   char c = 0;</span>
<a href="#l28.715"></a><span id="l28.715">   nsresult rv;</span>
<a href="#l28.716"></a><span id="l28.716">   while (NS_SUCCEEDED(rv = EnsureHasDataInBuffer())) {</span>
<a href="#l28.717"></a><span id="l28.717" class="difflineminus">-    if (!guard.IsChecking() &amp;&amp; !m_convertCRs) { // Use efficient algorithm</span>
<a href="#l28.718"></a><span id="l28.718" class="difflineminus">-      dest.Append(m_fifoBufferReadPos, m_fifoBufferWrittenPos-m_fifoBufferReadPos);</span>
<a href="#l28.719"></a><span id="l28.719" class="difflineminus">-    }</span>
<a href="#l28.720"></a><span id="l28.720" class="difflineminus">-    else { // Check character by character to convert CRs and find terminating sequence</span>
<a href="#l28.721"></a><span id="l28.721" class="difflineplus">+    if (!guard.IsChecking() &amp;&amp; !m_convertCRs) {  // Use efficient algorithm</span>
<a href="#l28.722"></a><span id="l28.722" class="difflineplus">+      dest.Append(m_fifoBufferReadPos,</span>
<a href="#l28.723"></a><span id="l28.723" class="difflineplus">+                  m_fifoBufferWrittenPos - m_fifoBufferReadPos);</span>
<a href="#l28.724"></a><span id="l28.724" class="difflineplus">+    } else {  // Check character by character to convert CRs and find</span>
<a href="#l28.725"></a><span id="l28.725" class="difflineplus">+              // terminating sequence</span>
<a href="#l28.726"></a><span id="l28.726">       while (m_fifoBufferReadPos &lt; m_fifoBufferWrittenPos) {</span>
<a href="#l28.727"></a><span id="l28.727">         c = *m_fifoBufferReadPos;</span>
<a href="#l28.728"></a><span id="l28.728">         if (m_convertCRs &amp;&amp; wasCR) {</span>
<a href="#l28.729"></a><span id="l28.729">           wasCR = false;</span>
<a href="#l28.730"></a><span id="l28.730">           if (c != nsCRT::LF) {</span>
<a href="#l28.731"></a><span id="l28.731">             const char kTmpLF = nsCRT::LF;</span>
<a href="#l28.732"></a><span id="l28.732">             dest.Append(&amp;kTmpLF, 1);</span>
<a href="#l28.733"></a><span id="l28.733">             if (guard.Check(nsCRT::LF)) {</span>
<a href="#l28.734"></a><span id="l28.734" class="difflineminus">-              c = nsCRT::LF; // save last char</span>
<a href="#l28.735"></a><span id="l28.735" class="difflineplus">+              c = nsCRT::LF;  // save last char</span>
<a href="#l28.736"></a><span id="l28.736">               break;</span>
<a href="#l28.737"></a><span id="l28.737">             }</span>
<a href="#l28.738"></a><span id="l28.738">           }</span>
<a href="#l28.739"></a><span id="l28.739">         }</span>
<a href="#l28.740"></a><span id="l28.740">         dest.Append(&amp;c, 1);</span>
<a href="#l28.741"></a><span id="l28.741">         m_fifoBufferReadPos++;</span>
<a href="#l28.742"></a><span id="l28.742"> </span>
<a href="#l28.743"></a><span id="l28.743" class="difflineminus">-        if (guard.Check(c))</span>
<a href="#l28.744"></a><span id="l28.744" class="difflineminus">-          break;</span>
<a href="#l28.745"></a><span id="l28.745" class="difflineplus">+        if (guard.Check(c)) break;</span>
<a href="#l28.746"></a><span id="l28.746"> </span>
<a href="#l28.747"></a><span id="l28.747" class="difflineminus">-        if (m_convertCRs &amp;&amp; (c == nsCRT::CR))</span>
<a href="#l28.748"></a><span id="l28.748" class="difflineminus">-          wasCR = true;</span>
<a href="#l28.749"></a><span id="l28.749" class="difflineplus">+        if (m_convertCRs &amp;&amp; (c == nsCRT::CR)) wasCR = true;</span>
<a href="#l28.750"></a><span id="l28.750">       }</span>
<a href="#l28.751"></a><span id="l28.751" class="difflineminus">-      if (guard.IsTriggered())</span>
<a href="#l28.752"></a><span id="l28.752" class="difflineminus">-        break;</span>
<a href="#l28.753"></a><span id="l28.753" class="difflineplus">+      if (guard.IsTriggered()) break;</span>
<a href="#l28.754"></a><span id="l28.754">     }</span>
<a href="#l28.755"></a><span id="l28.755">   }</span>
<a href="#l28.756"></a><span id="l28.756"> </span>
<a href="#l28.757"></a><span id="l28.757" class="difflineminus">-  // check for trailing CR (only if caller didn't specify the terminating sequence that ends with CR -</span>
<a href="#l28.758"></a><span id="l28.758" class="difflineminus">-  // in this case he knows what he does!)</span>
<a href="#l28.759"></a><span id="l28.759" class="difflineplus">+  // check for trailing CR (only if caller didn't specify the terminating</span>
<a href="#l28.760"></a><span id="l28.760" class="difflineplus">+  // sequence that ends with CR - in this case he knows what he does!)</span>
<a href="#l28.761"></a><span id="l28.761">   if (m_convertCRs &amp;&amp; !guard.IsTriggered() &amp;&amp; (c == nsCRT::CR)) {</span>
<a href="#l28.762"></a><span id="l28.762">     c = nsCRT::LF;</span>
<a href="#l28.763"></a><span id="l28.763">     dest.Append(&amp;c, 1);</span>
<a href="#l28.764"></a><span id="l28.764">   }</span>
<a href="#l28.765"></a><span id="l28.765"> </span>
<a href="#l28.766"></a><span id="l28.766">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l28.767"></a><span id="l28.767"> </span>
<a href="#l28.768"></a><span id="l28.768">   m_lastChar = c;</span>
<a href="#l28.769"></a><span id="l28.769">   return NS_OK;</span>
<a href="#l28.770"></a><span id="l28.770"> }</span>
<a href="#l28.771"></a><span id="l28.771"> </span>
<a href="#l28.772"></a><span id="l28.772"> class dest_nsCString {</span>
<a href="#l28.773"></a><span id="l28.773" class="difflineminus">-public:</span>
<a href="#l28.774"></a><span id="l28.774" class="difflineplus">+ public:</span>
<a href="#l28.775"></a><span id="l28.775">   explicit dest_nsCString(nsCString&amp; str) : m_str(str) { m_str.Truncate(); }</span>
<a href="#l28.776"></a><span id="l28.776">   void SetCapacity(int32_t sz) { m_str.SetCapacity(sz); }</span>
<a href="#l28.777"></a><span id="l28.777">   nsresult Append(const char* buf, uint32_t count) {</span>
<a href="#l28.778"></a><span id="l28.778" class="difflineminus">-    m_str.Append(buf, count); return NS_OK; }</span>
<a href="#l28.779"></a><span id="l28.779" class="difflineminus">-private:</span>
<a href="#l28.780"></a><span id="l28.780" class="difflineplus">+    m_str.Append(buf, count);</span>
<a href="#l28.781"></a><span id="l28.781" class="difflineplus">+    return NS_OK;</span>
<a href="#l28.782"></a><span id="l28.782" class="difflineplus">+  }</span>
<a href="#l28.783"></a><span id="l28.783" class="difflineplus">+</span>
<a href="#l28.784"></a><span id="l28.784" class="difflineplus">+ private:</span>
<a href="#l28.785"></a><span id="l28.785">   nsCString&amp; m_str;</span>
<a href="#l28.786"></a><span id="l28.786"> };</span>
<a href="#l28.787"></a><span id="l28.787"> </span>
<a href="#l28.788"></a><span id="l28.788"> class dest_Stream {</span>
<a href="#l28.789"></a><span id="l28.789" class="difflineminus">-public:</span>
<a href="#l28.790"></a><span id="l28.790" class="difflineminus">-  explicit dest_Stream(nsIOutputStream *dest) : m_stream(dest) {}</span>
<a href="#l28.791"></a><span id="l28.791" class="difflineminus">-  void SetCapacity(int32_t) { /*do nothing*/ }</span>
<a href="#l28.792"></a><span id="l28.792" class="difflineplus">+ public:</span>
<a href="#l28.793"></a><span id="l28.793" class="difflineplus">+  explicit dest_Stream(nsIOutputStream* dest) : m_stream(dest) {}</span>
<a href="#l28.794"></a><span id="l28.794" class="difflineplus">+  void SetCapacity(int32_t) { /*do nothing*/</span>
<a href="#l28.795"></a><span id="l28.795" class="difflineplus">+  }</span>
<a href="#l28.796"></a><span id="l28.796">   // const_cast here is due to the poor design of the EscapeFromSpaceLine()</span>
<a href="#l28.797"></a><span id="l28.797">   // that requires a non-constant pointer while doesn't modify its data</span>
<a href="#l28.798"></a><span id="l28.798">   nsresult Append(const char* buf, uint32_t count) {</span>
<a href="#l28.799"></a><span id="l28.799" class="difflineminus">-    return EscapeFromSpaceLine(m_stream, const_cast&lt;char*&gt;(buf), buf+count); }</span>
<a href="#l28.800"></a><span id="l28.800" class="difflineminus">-private:</span>
<a href="#l28.801"></a><span id="l28.801" class="difflineminus">-  nsIOutputStream *m_stream;</span>
<a href="#l28.802"></a><span id="l28.802" class="difflineplus">+    return EscapeFromSpaceLine(m_stream, const_cast&lt;char*&gt;(buf), buf + count);</span>
<a href="#l28.803"></a><span id="l28.803" class="difflineplus">+  }</span>
<a href="#l28.804"></a><span id="l28.804" class="difflineplus">+</span>
<a href="#l28.805"></a><span id="l28.805" class="difflineplus">+ private:</span>
<a href="#l28.806"></a><span id="l28.806" class="difflineplus">+  nsIOutputStream* m_stream;</span>
<a href="#l28.807"></a><span id="l28.807"> };</span>
<a href="#l28.808"></a><span id="l28.808"> </span>
<a href="#l28.809"></a><span id="l28.809"> nsresult CCompositionFile::ToString(nsCString&amp; dest, const char* term,</span>
<a href="#l28.810"></a><span id="l28.810" class="difflineminus">-                                    int termSize)</span>
<a href="#l28.811"></a><span id="l28.811" class="difflineminus">-{</span>
<a href="#l28.812"></a><span id="l28.812" class="difflineplus">+                                    int termSize) {</span>
<a href="#l28.813"></a><span id="l28.813">   return ToDest(dest_nsCString(dest), term, termSize);</span>
<a href="#l28.814"></a><span id="l28.814"> }</span>
<a href="#l28.815"></a><span id="l28.815"> </span>
<a href="#l28.816"></a><span id="l28.816" class="difflineminus">-nsresult CCompositionFile::ToStream(nsIOutputStream *dest, const char* term,</span>
<a href="#l28.817"></a><span id="l28.817" class="difflineminus">-                                    int termSize)</span>
<a href="#l28.818"></a><span id="l28.818" class="difflineminus">-{</span>
<a href="#l28.819"></a><span id="l28.819" class="difflineplus">+nsresult CCompositionFile::ToStream(nsIOutputStream* dest, const char* term,</span>
<a href="#l28.820"></a><span id="l28.820" class="difflineplus">+                                    int termSize) {</span>
<a href="#l28.821"></a><span id="l28.821">   return ToDest(dest_Stream(dest), term, termSize);</span>
<a href="#l28.822"></a><span id="l28.822"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mailnews/import/outlook/src/nsOutlookCompose.h</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mailnews/import/outlook/src/nsOutlookCompose.h</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -23,33 +23,41 @@ class nsIMsgSendListener;</span>
<a href="#l29.4"></a><span id="l29.4"> </span>
<a href="#l29.5"></a><span id="l29.5"> #include &quot;MapiMessage.h&quot;</span>
<a href="#l29.6"></a><span id="l29.6"> </span>
<a href="#l29.7"></a><span id="l29.7"> #include &lt;list&gt;</span>
<a href="#l29.8"></a><span id="l29.8"> </span>
<a href="#l29.9"></a><span id="l29.9"> ///////////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l29.10"></a><span id="l29.10"> </span>
<a href="#l29.11"></a><span id="l29.11"> class nsOutlookCompose {</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-public:</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineplus">+ public:</span>
<a href="#l29.14"></a><span id="l29.14">   nsOutlookCompose();</span>
<a href="#l29.15"></a><span id="l29.15">   ~nsOutlookCompose();</span>
<a href="#l29.16"></a><span id="l29.16"> </span>
<a href="#l29.17"></a><span id="l29.17" class="difflineminus">-  nsresult ProcessMessage(nsMsgDeliverMode mode, CMapiMessage &amp;msg, nsIOutputStream *pDst);</span>
<a href="#l29.18"></a><span id="l29.18" class="difflineplus">+  nsresult ProcessMessage(nsMsgDeliverMode mode, CMapiMessage&amp; msg,</span>
<a href="#l29.19"></a><span id="l29.19" class="difflineplus">+                          nsIOutputStream* pDst);</span>
<a href="#l29.20"></a><span id="l29.20">   static nsresult CreateIdentity(void);</span>
<a href="#l29.21"></a><span id="l29.21">   static void ReleaseIdentity(void);</span>
<a href="#l29.22"></a><span id="l29.22" class="difflineminus">-private:</span>
<a href="#l29.23"></a><span id="l29.23" class="difflineminus">-  nsresult  CreateComponents(void);</span>
<a href="#l29.24"></a><span id="l29.24" class="difflineplus">+</span>
<a href="#l29.25"></a><span id="l29.25" class="difflineplus">+ private:</span>
<a href="#l29.26"></a><span id="l29.26" class="difflineplus">+  nsresult CreateComponents(void);</span>
<a href="#l29.27"></a><span id="l29.27"> </span>
<a href="#l29.28"></a><span id="l29.28" class="difflineminus">-  void      UpdateHeader(CMapiMessageHeaders&amp; oldHeaders, const CMapiMessageHeaders&amp; newHeaders, CMapiMessageHeaders::SpecialHeader header, bool addIfAbsent = true);</span>
<a href="#l29.29"></a><span id="l29.29" class="difflineminus">-  void      UpdateHeaders(CMapiMessageHeaders&amp; oldHeaders, const CMapiMessageHeaders&amp; newHeaders);</span>
<a href="#l29.30"></a><span id="l29.30" class="difflineplus">+  void UpdateHeader(CMapiMessageHeaders&amp; oldHeaders,</span>
<a href="#l29.31"></a><span id="l29.31" class="difflineplus">+                    const CMapiMessageHeaders&amp; newHeaders,</span>
<a href="#l29.32"></a><span id="l29.32" class="difflineplus">+                    CMapiMessageHeaders::SpecialHeader header,</span>
<a href="#l29.33"></a><span id="l29.33" class="difflineplus">+                    bool addIfAbsent = true);</span>
<a href="#l29.34"></a><span id="l29.34" class="difflineplus">+  void UpdateHeaders(CMapiMessageHeaders&amp; oldHeaders,</span>
<a href="#l29.35"></a><span id="l29.35" class="difflineplus">+                     const CMapiMessageHeaders&amp; newHeaders);</span>
<a href="#l29.36"></a><span id="l29.36"> </span>
<a href="#l29.37"></a><span id="l29.37" class="difflineminus">-  nsresult  ComposeTheMessage(nsMsgDeliverMode mode, CMapiMessage &amp;msg, nsIFile **pMsg);</span>
<a href="#l29.38"></a><span id="l29.38" class="difflineminus">-  nsresult  CopyComposedMessage(nsIFile *pSrc, nsIOutputStream *pDst, CMapiMessage&amp; origMsg);</span>
<a href="#l29.39"></a><span id="l29.39" class="difflineplus">+  nsresult ComposeTheMessage(nsMsgDeliverMode mode, CMapiMessage&amp; msg,</span>
<a href="#l29.40"></a><span id="l29.40" class="difflineplus">+                             nsIFile** pMsg);</span>
<a href="#l29.41"></a><span id="l29.41" class="difflineplus">+  nsresult CopyComposedMessage(nsIFile* pSrc, nsIOutputStream* pDst,</span>
<a href="#l29.42"></a><span id="l29.42" class="difflineplus">+                               CMapiMessage&amp; origMsg);</span>
<a href="#l29.43"></a><span id="l29.43"> </span>
<a href="#l29.44"></a><span id="l29.44" class="difflineminus">-private:</span>
<a href="#l29.45"></a><span id="l29.45" class="difflineplus">+ private:</span>
<a href="#l29.46"></a><span id="l29.46">   nsCOMPtr&lt;nsIMsgSendListener&gt; m_pListener;</span>
<a href="#l29.47"></a><span id="l29.47">   nsCOMPtr&lt;nsIMsgCompFields&gt; m_pMsgFields;</span>
<a href="#l29.48"></a><span id="l29.48">   static nsCOMPtr&lt;nsIMsgIdentity&gt; m_pIdentity;</span>
<a href="#l29.49"></a><span id="l29.49">   char* m_optimizationBuffer;</span>
<a href="#l29.50"></a><span id="l29.50" class="difflineminus">-  nsCOMPtr&lt;nsIImportService&gt;  m_pImportService;</span>
<a href="#l29.51"></a><span id="l29.51" class="difflineplus">+  nsCOMPtr&lt;nsIImportService&gt; m_pImportService;</span>
<a href="#l29.52"></a><span id="l29.52"> };</span>
<a href="#l29.53"></a><span id="l29.53"> </span>
<a href="#l29.54"></a><span id="l29.54"> #endif /* nsOutlookCompose_h__ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mailnews/import/outlook/src/nsOutlookImport.cpp</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mailnews/import/outlook/src/nsOutlookImport.cpp</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -26,194 +26,190 @@</span>
<a href="#l30.4"></a><span id="l30.4"> #include &quot;nsOutlookStringBundle.h&quot;</span>
<a href="#l30.5"></a><span id="l30.5"> #include &quot;ImportDebug.h&quot;</span>
<a href="#l30.6"></a><span id="l30.6"> #include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l30.7"></a><span id="l30.7"> </span>
<a href="#l30.8"></a><span id="l30.8"> #include &quot;nsOutlookMail.h&quot;</span>
<a href="#l30.9"></a><span id="l30.9"> </span>
<a href="#l30.10"></a><span id="l30.10"> #include &quot;MapiApi.h&quot;</span>
<a href="#l30.11"></a><span id="l30.11"> </span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-class ImportOutlookMailImpl : public nsIImportMail</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineminus">-{</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineminus">-public:</span>
<a href="#l30.15"></a><span id="l30.15" class="difflineplus">+class ImportOutlookMailImpl : public nsIImportMail {</span>
<a href="#l30.16"></a><span id="l30.16" class="difflineplus">+ public:</span>
<a href="#l30.17"></a><span id="l30.17">   ImportOutlookMailImpl();</span>
<a href="#l30.18"></a><span id="l30.18"> </span>
<a href="#l30.19"></a><span id="l30.19" class="difflineminus">-  static nsresult Create(nsIImportMail** aImport);</span>
<a href="#l30.20"></a><span id="l30.20" class="difflineplus">+  static nsresult Create(nsIImportMail **aImport);</span>
<a href="#l30.21"></a><span id="l30.21"> </span>
<a href="#l30.22"></a><span id="l30.22">   // nsISupports interface</span>
<a href="#l30.23"></a><span id="l30.23">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l30.24"></a><span id="l30.24"> </span>
<a href="#l30.25"></a><span id="l30.25">   // nsIImportmail interface</span>
<a href="#l30.26"></a><span id="l30.26"> </span>
<a href="#l30.27"></a><span id="l30.27" class="difflineminus">-  /* void GetDefaultLocation (out nsIFile location, out boolean found, out boolean userVerify); */</span>
<a href="#l30.28"></a><span id="l30.28" class="difflineminus">-  NS_IMETHOD GetDefaultLocation(nsIFile **location, bool *found, bool *userVerify);</span>
<a href="#l30.29"></a><span id="l30.29" class="difflineplus">+  /* void GetDefaultLocation (out nsIFile location, out boolean found, out</span>
<a href="#l30.30"></a><span id="l30.30" class="difflineplus">+   * boolean userVerify); */</span>
<a href="#l30.31"></a><span id="l30.31" class="difflineplus">+  NS_IMETHOD GetDefaultLocation(nsIFile **location, bool *found,</span>
<a href="#l30.32"></a><span id="l30.32" class="difflineplus">+                                bool *userVerify);</span>
<a href="#l30.33"></a><span id="l30.33"> </span>
<a href="#l30.34"></a><span id="l30.34">   /* nsIArray FindMailboxes (in nsIFile location); */</span>
<a href="#l30.35"></a><span id="l30.35">   NS_IMETHOD FindMailboxes(nsIFile *location, nsIArray **_retval);</span>
<a href="#l30.36"></a><span id="l30.36"> </span>
<a href="#l30.37"></a><span id="l30.37">   NS_IMETHOD ImportMailbox(nsIImportMailboxDescriptor *source,</span>
<a href="#l30.38"></a><span id="l30.38" class="difflineminus">-                           nsIMsgFolder *dstFolder,</span>
<a href="#l30.39"></a><span id="l30.39" class="difflineminus">-                           char16_t **pErrorLog, char16_t **pSuccessLog,</span>
<a href="#l30.40"></a><span id="l30.40" class="difflineminus">-                           bool *fatalError);</span>
<a href="#l30.41"></a><span id="l30.41" class="difflineplus">+                           nsIMsgFolder *dstFolder, char16_t **pErrorLog,</span>
<a href="#l30.42"></a><span id="l30.42" class="difflineplus">+                           char16_t **pSuccessLog, bool *fatalError);</span>
<a href="#l30.43"></a><span id="l30.43"> </span>
<a href="#l30.44"></a><span id="l30.44">   /* unsigned long GetImportProgress (); */</span>
<a href="#l30.45"></a><span id="l30.45">   NS_IMETHOD GetImportProgress(uint32_t *_retval);</span>
<a href="#l30.46"></a><span id="l30.46"> </span>
<a href="#l30.47"></a><span id="l30.47" class="difflineminus">-  NS_IMETHOD TranslateFolderName(const nsAString &amp; aFolderName, nsAString &amp; _retval);</span>
<a href="#l30.48"></a><span id="l30.48" class="difflineplus">+  NS_IMETHOD TranslateFolderName(const nsAString &amp;aFolderName,</span>
<a href="#l30.49"></a><span id="l30.49" class="difflineplus">+                                 nsAString &amp;_retval);</span>
<a href="#l30.50"></a><span id="l30.50"> </span>
<a href="#l30.51"></a><span id="l30.51" class="difflineminus">-public:</span>
<a href="#l30.52"></a><span id="l30.52" class="difflineminus">-  static void  ReportSuccess(nsString&amp; name, int32_t count, nsString *pStream);</span>
<a href="#l30.53"></a><span id="l30.53" class="difflineminus">-  static void ReportError(int32_t errorNum, nsString&amp; name, nsString *pStream);</span>
<a href="#l30.54"></a><span id="l30.54" class="difflineminus">-  static void  AddLinebreak(nsString *pStream);</span>
<a href="#l30.55"></a><span id="l30.55" class="difflineminus">-  static void  SetLogs(nsString&amp; success, nsString&amp; error, char16_t **pError, char16_t **pSuccess);</span>
<a href="#l30.56"></a><span id="l30.56" class="difflineplus">+ public:</span>
<a href="#l30.57"></a><span id="l30.57" class="difflineplus">+  static void ReportSuccess(nsString &amp;name, int32_t count, nsString *pStream);</span>
<a href="#l30.58"></a><span id="l30.58" class="difflineplus">+  static void ReportError(int32_t errorNum, nsString &amp;name, nsString *pStream);</span>
<a href="#l30.59"></a><span id="l30.59" class="difflineplus">+  static void AddLinebreak(nsString *pStream);</span>
<a href="#l30.60"></a><span id="l30.60" class="difflineplus">+  static void SetLogs(nsString &amp;success, nsString &amp;error, char16_t **pError,</span>
<a href="#l30.61"></a><span id="l30.61" class="difflineplus">+                      char16_t **pSuccess);</span>
<a href="#l30.62"></a><span id="l30.62"> </span>
<a href="#l30.63"></a><span id="l30.63" class="difflineminus">-private:</span>
<a href="#l30.64"></a><span id="l30.64" class="difflineplus">+ private:</span>
<a href="#l30.65"></a><span id="l30.65">   virtual ~ImportOutlookMailImpl();</span>
<a href="#l30.66"></a><span id="l30.66" class="difflineminus">-  nsOutlookMail  m_mail;</span>
<a href="#l30.67"></a><span id="l30.67" class="difflineminus">-  uint32_t    m_bytesDone;</span>
<a href="#l30.68"></a><span id="l30.68" class="difflineplus">+  nsOutlookMail m_mail;</span>
<a href="#l30.69"></a><span id="l30.69" class="difflineplus">+  uint32_t m_bytesDone;</span>
<a href="#l30.70"></a><span id="l30.70"> };</span>
<a href="#l30.71"></a><span id="l30.71"> </span>
<a href="#l30.72"></a><span id="l30.72" class="difflineminus">-</span>
<a href="#l30.73"></a><span id="l30.73" class="difflineminus">-class ImportOutlookAddressImpl : public nsIImportAddressBooks</span>
<a href="#l30.74"></a><span id="l30.74" class="difflineminus">-{</span>
<a href="#l30.75"></a><span id="l30.75" class="difflineminus">-public:</span>
<a href="#l30.76"></a><span id="l30.76" class="difflineplus">+class ImportOutlookAddressImpl : public nsIImportAddressBooks {</span>
<a href="#l30.77"></a><span id="l30.77" class="difflineplus">+ public:</span>
<a href="#l30.78"></a><span id="l30.78">   ImportOutlookAddressImpl();</span>
<a href="#l30.79"></a><span id="l30.79"> </span>
<a href="#l30.80"></a><span id="l30.80" class="difflineminus">-  static nsresult Create(nsIImportAddressBooks** aImport);</span>
<a href="#l30.81"></a><span id="l30.81" class="difflineplus">+  static nsresult Create(nsIImportAddressBooks **aImport);</span>
<a href="#l30.82"></a><span id="l30.82"> </span>
<a href="#l30.83"></a><span id="l30.83">   // nsISupports interface</span>
<a href="#l30.84"></a><span id="l30.84">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l30.85"></a><span id="l30.85"> </span>
<a href="#l30.86"></a><span id="l30.86">   // nsIImportAddressBooks interface</span>
<a href="#l30.87"></a><span id="l30.87"> </span>
<a href="#l30.88"></a><span id="l30.88" class="difflineminus">-  NS_IMETHOD GetSupportsMultiple(bool *_retval) { *_retval = true; return NS_OK;}</span>
<a href="#l30.89"></a><span id="l30.89" class="difflineplus">+  NS_IMETHOD GetSupportsMultiple(bool *_retval) {</span>
<a href="#l30.90"></a><span id="l30.90" class="difflineplus">+    *_retval = true;</span>
<a href="#l30.91"></a><span id="l30.91" class="difflineplus">+    return NS_OK;</span>
<a href="#l30.92"></a><span id="l30.92" class="difflineplus">+  }</span>
<a href="#l30.93"></a><span id="l30.93"> </span>
<a href="#l30.94"></a><span id="l30.94">   NS_IMETHOD GetAutoFind(char16_t **description, bool *_retval);</span>
<a href="#l30.95"></a><span id="l30.95"> </span>
<a href="#l30.96"></a><span id="l30.96" class="difflineminus">-  NS_IMETHOD GetNeedsFieldMap(nsIFile *location, bool *_retval) { *_retval = false; return NS_OK;}</span>
<a href="#l30.97"></a><span id="l30.97" class="difflineplus">+  NS_IMETHOD GetNeedsFieldMap(nsIFile *location, bool *_retval) {</span>
<a href="#l30.98"></a><span id="l30.98" class="difflineplus">+    *_retval = false;</span>
<a href="#l30.99"></a><span id="l30.99" class="difflineplus">+    return NS_OK;</span>
<a href="#l30.100"></a><span id="l30.100" class="difflineplus">+  }</span>
<a href="#l30.101"></a><span id="l30.101"> </span>
<a href="#l30.102"></a><span id="l30.102" class="difflineminus">-  NS_IMETHOD GetDefaultLocation(nsIFile **location, bool *found, bool *userVerify)</span>
<a href="#l30.103"></a><span id="l30.103" class="difflineminus">-    { return NS_ERROR_FAILURE;}</span>
<a href="#l30.104"></a><span id="l30.104" class="difflineplus">+  NS_IMETHOD GetDefaultLocation(nsIFile **location, bool *found,</span>
<a href="#l30.105"></a><span id="l30.105" class="difflineplus">+                                bool *userVerify) {</span>
<a href="#l30.106"></a><span id="l30.106" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l30.107"></a><span id="l30.107" class="difflineplus">+  }</span>
<a href="#l30.108"></a><span id="l30.108"> </span>
<a href="#l30.109"></a><span id="l30.109">   NS_IMETHOD FindAddressBooks(nsIFile *location, nsIArray **_retval);</span>
<a href="#l30.110"></a><span id="l30.110"> </span>
<a href="#l30.111"></a><span id="l30.111" class="difflineminus">-  NS_IMETHOD InitFieldMap(nsIImportFieldMap *fieldMap)</span>
<a href="#l30.112"></a><span id="l30.112" class="difflineminus">-    { return NS_ERROR_FAILURE; }</span>
<a href="#l30.113"></a><span id="l30.113" class="difflineplus">+  NS_IMETHOD InitFieldMap(nsIImportFieldMap *fieldMap) {</span>
<a href="#l30.114"></a><span id="l30.114" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l30.115"></a><span id="l30.115" class="difflineplus">+  }</span>
<a href="#l30.116"></a><span id="l30.116"> </span>
<a href="#l30.117"></a><span id="l30.117">   NS_IMETHOD ImportAddressBook(nsIImportABDescriptor *source,</span>
<a href="#l30.118"></a><span id="l30.118">                                nsIAddrDatabase *destination,</span>
<a href="#l30.119"></a><span id="l30.119">                                nsIImportFieldMap *fieldMap,</span>
<a href="#l30.120"></a><span id="l30.120">                                nsISupports *aSupportService,</span>
<a href="#l30.121"></a><span id="l30.121" class="difflineminus">-                               char16_t **errorLog,</span>
<a href="#l30.122"></a><span id="l30.122" class="difflineminus">-                               char16_t **successLog,</span>
<a href="#l30.123"></a><span id="l30.123" class="difflineplus">+                               char16_t **errorLog, char16_t **successLog,</span>
<a href="#l30.124"></a><span id="l30.124">                                bool *fatalError);</span>
<a href="#l30.125"></a><span id="l30.125"> </span>
<a href="#l30.126"></a><span id="l30.126">   NS_IMETHOD GetImportProgress(uint32_t *_retval);</span>
<a href="#l30.127"></a><span id="l30.127"> </span>
<a href="#l30.128"></a><span id="l30.128" class="difflineminus">-  NS_IMETHOD GetSampleData(int32_t index, bool *pFound, char16_t **pStr)</span>
<a href="#l30.129"></a><span id="l30.129" class="difflineminus">-    { return NS_ERROR_FAILURE;}</span>
<a href="#l30.130"></a><span id="l30.130" class="difflineplus">+  NS_IMETHOD GetSampleData(int32_t index, bool *pFound, char16_t **pStr) {</span>
<a href="#l30.131"></a><span id="l30.131" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l30.132"></a><span id="l30.132" class="difflineplus">+  }</span>
<a href="#l30.133"></a><span id="l30.133"> </span>
<a href="#l30.134"></a><span id="l30.134">   NS_IMETHOD SetSampleLocation(nsIFile *) { return NS_OK; }</span>
<a href="#l30.135"></a><span id="l30.135"> </span>
<a href="#l30.136"></a><span id="l30.136" class="difflineminus">-private:</span>
<a href="#l30.137"></a><span id="l30.137" class="difflineplus">+ private:</span>
<a href="#l30.138"></a><span id="l30.138">   virtual ~ImportOutlookAddressImpl();</span>
<a href="#l30.139"></a><span id="l30.139" class="difflineminus">-  void  ReportSuccess(nsString&amp; name, nsString *pStream);</span>
<a href="#l30.140"></a><span id="l30.140" class="difflineplus">+  void ReportSuccess(nsString &amp;name, nsString *pStream);</span>
<a href="#l30.141"></a><span id="l30.141"> </span>
<a href="#l30.142"></a><span id="l30.142" class="difflineminus">-private:</span>
<a href="#l30.143"></a><span id="l30.143" class="difflineminus">-  uint32_t    m_msgCount;</span>
<a href="#l30.144"></a><span id="l30.144" class="difflineminus">-  uint32_t    m_msgTotal;</span>
<a href="#l30.145"></a><span id="l30.145" class="difflineminus">-  nsOutlookMail  m_address;</span>
<a href="#l30.146"></a><span id="l30.146" class="difflineplus">+ private:</span>
<a href="#l30.147"></a><span id="l30.147" class="difflineplus">+  uint32_t m_msgCount;</span>
<a href="#l30.148"></a><span id="l30.148" class="difflineplus">+  uint32_t m_msgTotal;</span>
<a href="#l30.149"></a><span id="l30.149" class="difflineplus">+  nsOutlookMail m_address;</span>
<a href="#l30.150"></a><span id="l30.150"> };</span>
<a href="#l30.151"></a><span id="l30.151"> ////////////////////////////////////////////////////////////////////////</span>
<a href="#l30.152"></a><span id="l30.152"> </span>
<a href="#l30.153"></a><span id="l30.153" class="difflineminus">-</span>
<a href="#l30.154"></a><span id="l30.154"> ////////////////////////////////////////////////////////////////////////</span>
<a href="#l30.155"></a><span id="l30.155"> </span>
<a href="#l30.156"></a><span id="l30.156" class="difflineminus">-</span>
<a href="#l30.157"></a><span id="l30.157" class="difflineminus">-nsOutlookImport::nsOutlookImport()</span>
<a href="#l30.158"></a><span id="l30.158" class="difflineminus">-{</span>
<a href="#l30.159"></a><span id="l30.159" class="difflineplus">+nsOutlookImport::nsOutlookImport() {</span>
<a href="#l30.160"></a><span id="l30.160">   IMPORT_LOG0(&quot;nsOutlookImport Module Created\n&quot;);</span>
<a href="#l30.161"></a><span id="l30.161"> </span>
<a href="#l30.162"></a><span id="l30.162">   nsOutlookStringBundle::GetStringBundle();</span>
<a href="#l30.163"></a><span id="l30.163"> }</span>
<a href="#l30.164"></a><span id="l30.164"> </span>
<a href="#l30.165"></a><span id="l30.165" class="difflineminus">-</span>
<a href="#l30.166"></a><span id="l30.166" class="difflineminus">-nsOutlookImport::~nsOutlookImport()</span>
<a href="#l30.167"></a><span id="l30.167" class="difflineminus">-{</span>
<a href="#l30.168"></a><span id="l30.168" class="difflineplus">+nsOutlookImport::~nsOutlookImport() {</span>
<a href="#l30.169"></a><span id="l30.169">   IMPORT_LOG0(&quot;nsOutlookImport Module Deleted\n&quot;);</span>
<a href="#l30.170"></a><span id="l30.170"> }</span>
<a href="#l30.171"></a><span id="l30.171"> </span>
<a href="#l30.172"></a><span id="l30.172"> NS_IMPL_ISUPPORTS(nsOutlookImport, nsIImportModule)</span>
<a href="#l30.173"></a><span id="l30.173"> </span>
<a href="#l30.174"></a><span id="l30.174" class="difflineminus">-NS_IMETHODIMP nsOutlookImport::GetName(char16_t **name)</span>
<a href="#l30.175"></a><span id="l30.175" class="difflineminus">-{</span>
<a href="#l30.176"></a><span id="l30.176" class="difflineplus">+NS_IMETHODIMP nsOutlookImport::GetName(char16_t **name) {</span>
<a href="#l30.177"></a><span id="l30.177">   NS_ASSERTION(name != nullptr, &quot;null ptr&quot;);</span>
<a href="#l30.178"></a><span id="l30.178" class="difflineminus">-  if (! name)</span>
<a href="#l30.179"></a><span id="l30.179" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l30.180"></a><span id="l30.180" class="difflineplus">+  if (!name) return NS_ERROR_NULL_POINTER;</span>
<a href="#l30.181"></a><span id="l30.181"> </span>
<a href="#l30.182"></a><span id="l30.182">   *name = nsOutlookStringBundle::GetStringByID(OUTLOOKIMPORT_NAME);</span>
<a href="#l30.183"></a><span id="l30.183">   return NS_OK;</span>
<a href="#l30.184"></a><span id="l30.184"> }</span>
<a href="#l30.185"></a><span id="l30.185"> </span>
<a href="#l30.186"></a><span id="l30.186" class="difflineminus">-NS_IMETHODIMP nsOutlookImport::GetDescription(char16_t **name)</span>
<a href="#l30.187"></a><span id="l30.187" class="difflineminus">-{</span>
<a href="#l30.188"></a><span id="l30.188" class="difflineplus">+NS_IMETHODIMP nsOutlookImport::GetDescription(char16_t **name) {</span>
<a href="#l30.189"></a><span id="l30.189">   NS_ASSERTION(name != nullptr, &quot;null ptr&quot;);</span>
<a href="#l30.190"></a><span id="l30.190" class="difflineminus">-  if (!name)</span>
<a href="#l30.191"></a><span id="l30.191" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l30.192"></a><span id="l30.192" class="difflineplus">+  if (!name) return NS_ERROR_NULL_POINTER;</span>
<a href="#l30.193"></a><span id="l30.193"> </span>
<a href="#l30.194"></a><span id="l30.194">   *name = nsOutlookStringBundle::GetStringByID(OUTLOOKIMPORT_DESCRIPTION);</span>
<a href="#l30.195"></a><span id="l30.195"> </span>
<a href="#l30.196"></a><span id="l30.196">   return NS_OK;</span>
<a href="#l30.197"></a><span id="l30.197"> }</span>
<a href="#l30.198"></a><span id="l30.198"> </span>
<a href="#l30.199"></a><span id="l30.199" class="difflineminus">-NS_IMETHODIMP nsOutlookImport::GetSupports(char **supports)</span>
<a href="#l30.200"></a><span id="l30.200" class="difflineminus">-{</span>
<a href="#l30.201"></a><span id="l30.201" class="difflineplus">+NS_IMETHODIMP nsOutlookImport::GetSupports(char **supports) {</span>
<a href="#l30.202"></a><span id="l30.202">   NS_ASSERTION(supports != nullptr, &quot;null ptr&quot;);</span>
<a href="#l30.203"></a><span id="l30.203" class="difflineminus">-  if (! supports)</span>
<a href="#l30.204"></a><span id="l30.204" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l30.205"></a><span id="l30.205" class="difflineplus">+  if (!supports) return NS_ERROR_NULL_POINTER;</span>
<a href="#l30.206"></a><span id="l30.206"> </span>
<a href="#l30.207"></a><span id="l30.207">   *supports = strdup(kOutlookSupportsString);</span>
<a href="#l30.208"></a><span id="l30.208">   return NS_OK;</span>
<a href="#l30.209"></a><span id="l30.209"> }</span>
<a href="#l30.210"></a><span id="l30.210"> </span>
<a href="#l30.211"></a><span id="l30.211" class="difflineminus">-NS_IMETHODIMP nsOutlookImport::GetSupportsUpgrade(bool *pUpgrade)</span>
<a href="#l30.212"></a><span id="l30.212" class="difflineminus">-{</span>
<a href="#l30.213"></a><span id="l30.213" class="difflineplus">+NS_IMETHODIMP nsOutlookImport::GetSupportsUpgrade(bool *pUpgrade) {</span>
<a href="#l30.214"></a><span id="l30.214">   NS_ASSERTION(pUpgrade != nullptr, &quot;null ptr&quot;);</span>
<a href="#l30.215"></a><span id="l30.215" class="difflineminus">-  if (! pUpgrade)</span>
<a href="#l30.216"></a><span id="l30.216" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l30.217"></a><span id="l30.217" class="difflineplus">+  if (!pUpgrade) return NS_ERROR_NULL_POINTER;</span>
<a href="#l30.218"></a><span id="l30.218"> </span>
<a href="#l30.219"></a><span id="l30.219">   *pUpgrade = true;</span>
<a href="#l30.220"></a><span id="l30.220">   return NS_OK;</span>
<a href="#l30.221"></a><span id="l30.221"> }</span>
<a href="#l30.222"></a><span id="l30.222"> </span>
<a href="#l30.223"></a><span id="l30.223" class="difflineminus">-NS_IMETHODIMP nsOutlookImport::GetImportInterface(const char *pImportType, nsISupports **ppInterface)</span>
<a href="#l30.224"></a><span id="l30.224" class="difflineminus">-{</span>
<a href="#l30.225"></a><span id="l30.225" class="difflineplus">+NS_IMETHODIMP nsOutlookImport::GetImportInterface(const char *pImportType,</span>
<a href="#l30.226"></a><span id="l30.226" class="difflineplus">+                                                  nsISupports **ppInterface) {</span>
<a href="#l30.227"></a><span id="l30.227">   NS_ASSERTION(pImportType != nullptr, &quot;null ptr&quot;);</span>
<a href="#l30.228"></a><span id="l30.228" class="difflineminus">-  if (! pImportType)</span>
<a href="#l30.229"></a><span id="l30.229" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l30.230"></a><span id="l30.230" class="difflineplus">+  if (!pImportType) return NS_ERROR_NULL_POINTER;</span>
<a href="#l30.231"></a><span id="l30.231">   NS_ASSERTION(ppInterface != nullptr, &quot;null ptr&quot;);</span>
<a href="#l30.232"></a><span id="l30.232" class="difflineminus">-  if (! ppInterface)</span>
<a href="#l30.233"></a><span id="l30.233" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l30.234"></a><span id="l30.234" class="difflineplus">+  if (!ppInterface) return NS_ERROR_NULL_POINTER;</span>
<a href="#l30.235"></a><span id="l30.235"> </span>
<a href="#l30.236"></a><span id="l30.236">   *ppInterface = nullptr;</span>
<a href="#l30.237"></a><span id="l30.237" class="difflineminus">-  nsresult  rv;</span>
<a href="#l30.238"></a><span id="l30.238" class="difflineplus">+  nsresult rv;</span>
<a href="#l30.239"></a><span id="l30.239">   if (!strcmp(pImportType, &quot;mail&quot;)) {</span>
<a href="#l30.240"></a><span id="l30.240">     // create the nsIImportMail interface and return it!</span>
<a href="#l30.241"></a><span id="l30.241">     nsCOMPtr&lt;nsIImportMail&gt; pMail;</span>
<a href="#l30.242"></a><span id="l30.242">     nsCOMPtr&lt;nsIImportGeneric&gt; pGeneric;</span>
<a href="#l30.243"></a><span id="l30.243">     rv = ImportOutlookMailImpl::Create(getter_AddRefs(pMail));</span>
<a href="#l30.244"></a><span id="l30.244">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l30.245"></a><span id="l30.245" class="difflineminus">-      nsCOMPtr&lt;nsIImportService&gt; impSvc(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l30.246"></a><span id="l30.246" class="difflineplus">+      nsCOMPtr&lt;nsIImportService&gt; impSvc(</span>
<a href="#l30.247"></a><span id="l30.247" class="difflineplus">+          do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l30.248"></a><span id="l30.248">       if (NS_SUCCEEDED(rv)) {</span>
<a href="#l30.249"></a><span id="l30.249">         rv = impSvc-&gt;CreateNewGenericMail(getter_AddRefs(pGeneric));</span>
<a href="#l30.250"></a><span id="l30.250">         if (NS_SUCCEEDED(rv)) {</span>
<a href="#l30.251"></a><span id="l30.251">           pGeneric-&gt;SetData(&quot;mailInterface&quot;, pMail);</span>
<a href="#l30.252"></a><span id="l30.252">           nsString name;</span>
<a href="#l30.253"></a><span id="l30.253">           nsOutlookStringBundle::GetStringByID(OUTLOOKIMPORT_NAME, name);</span>
<a href="#l30.254"></a><span id="l30.254" class="difflineminus">-          nsCOMPtr&lt;nsISupportsString&gt; nameString (do_CreateInstance(NS_SUPPORTS_STRING_CONTRACTID, &amp;rv));</span>
<a href="#l30.255"></a><span id="l30.255" class="difflineplus">+          nsCOMPtr&lt;nsISupportsString&gt; nameString(</span>
<a href="#l30.256"></a><span id="l30.256" class="difflineplus">+              do_CreateInstance(NS_SUPPORTS_STRING_CONTRACTID, &amp;rv));</span>
<a href="#l30.257"></a><span id="l30.257">           if (NS_SUCCEEDED(rv)) {</span>
<a href="#l30.258"></a><span id="l30.258">             nameString-&gt;SetData(name);</span>
<a href="#l30.259"></a><span id="l30.259">             pGeneric-&gt;SetData(&quot;name&quot;, nameString);</span>
<a href="#l30.260"></a><span id="l30.260">             nsCOMPtr&lt;nsISupports&gt; pInterface(do_QueryInterface(pGeneric));</span>
<a href="#l30.261"></a><span id="l30.261">             pInterface.forget(ppInterface);</span>
<a href="#l30.262"></a><span id="l30.262">           }</span>
<a href="#l30.263"></a><span id="l30.263">         }</span>
<a href="#l30.264"></a><span id="l30.264">       }</span>
<a href="#l30.265"></a><span id="l30.265" class="difflineat">@@ -222,17 +218,18 @@ NS_IMETHODIMP nsOutlookImport::GetImport</span>
<a href="#l30.266"></a><span id="l30.266">   }</span>
<a href="#l30.267"></a><span id="l30.267"> </span>
<a href="#l30.268"></a><span id="l30.268">   if (!strcmp(pImportType, &quot;addressbook&quot;)) {</span>
<a href="#l30.269"></a><span id="l30.269">     // create the nsIImportAddressBook interface and return it!</span>
<a href="#l30.270"></a><span id="l30.270">     nsCOMPtr&lt;nsIImportAddressBooks&gt; pAddress;</span>
<a href="#l30.271"></a><span id="l30.271">     nsCOMPtr&lt;nsIImportGeneric&gt; pGeneric;</span>
<a href="#l30.272"></a><span id="l30.272">     rv = ImportOutlookAddressImpl::Create(getter_AddRefs(pAddress));</span>
<a href="#l30.273"></a><span id="l30.273">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l30.274"></a><span id="l30.274" class="difflineminus">-      nsCOMPtr&lt;nsIImportService&gt; impSvc(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l30.275"></a><span id="l30.275" class="difflineplus">+      nsCOMPtr&lt;nsIImportService&gt; impSvc(</span>
<a href="#l30.276"></a><span id="l30.276" class="difflineplus">+          do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l30.277"></a><span id="l30.277">       if (NS_SUCCEEDED(rv)) {</span>
<a href="#l30.278"></a><span id="l30.278">         rv = impSvc-&gt;CreateNewGenericAddressBooks(getter_AddRefs(pGeneric));</span>
<a href="#l30.279"></a><span id="l30.279">         if (NS_SUCCEEDED(rv)) {</span>
<a href="#l30.280"></a><span id="l30.280">           pGeneric-&gt;SetData(&quot;addressInterface&quot;, pAddress);</span>
<a href="#l30.281"></a><span id="l30.281">           nsCOMPtr&lt;nsISupports&gt; pInterface(do_QueryInterface(pGeneric));</span>
<a href="#l30.282"></a><span id="l30.282">           pInterface.forget(ppInterface);</span>
<a href="#l30.283"></a><span id="l30.283">         }</span>
<a href="#l30.284"></a><span id="l30.284">       }</span>
<a href="#l30.285"></a><span id="l30.285" class="difflineat">@@ -249,157 +246,139 @@ NS_IMETHODIMP nsOutlookImport::GetImport</span>
<a href="#l30.286"></a><span id="l30.286">     }</span>
<a href="#l30.287"></a><span id="l30.287">     return rv;</span>
<a href="#l30.288"></a><span id="l30.288">   }</span>
<a href="#l30.289"></a><span id="l30.289"> </span>
<a href="#l30.290"></a><span id="l30.290">   return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l30.291"></a><span id="l30.291"> }</span>
<a href="#l30.292"></a><span id="l30.292"> </span>
<a href="#l30.293"></a><span id="l30.293"> /////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l30.294"></a><span id="l30.294" class="difflineminus">-nsresult ImportOutlookMailImpl::Create(nsIImportMail** aImport)</span>
<a href="#l30.295"></a><span id="l30.295" class="difflineminus">-{</span>
<a href="#l30.296"></a><span id="l30.296" class="difflineplus">+nsresult ImportOutlookMailImpl::Create(nsIImportMail **aImport) {</span>
<a href="#l30.297"></a><span id="l30.297">   NS_ENSURE_ARG_POINTER(aImport);</span>
<a href="#l30.298"></a><span id="l30.298">   NS_ADDREF(*aImport = new ImportOutlookMailImpl());</span>
<a href="#l30.299"></a><span id="l30.299">   return NS_OK;</span>
<a href="#l30.300"></a><span id="l30.300"> }</span>
<a href="#l30.301"></a><span id="l30.301"> </span>
<a href="#l30.302"></a><span id="l30.302" class="difflineminus">-ImportOutlookMailImpl::ImportOutlookMailImpl()</span>
<a href="#l30.303"></a><span id="l30.303" class="difflineminus">-{</span>
<a href="#l30.304"></a><span id="l30.304" class="difflineplus">+ImportOutlookMailImpl::ImportOutlookMailImpl() {</span>
<a href="#l30.305"></a><span id="l30.305">   nsOutlookCompose::CreateIdentity();</span>
<a href="#l30.306"></a><span id="l30.306"> }</span>
<a href="#l30.307"></a><span id="l30.307"> </span>
<a href="#l30.308"></a><span id="l30.308" class="difflineminus">-ImportOutlookMailImpl::~ImportOutlookMailImpl()</span>
<a href="#l30.309"></a><span id="l30.309" class="difflineminus">-{</span>
<a href="#l30.310"></a><span id="l30.310" class="difflineplus">+ImportOutlookMailImpl::~ImportOutlookMailImpl() {</span>
<a href="#l30.311"></a><span id="l30.311">   nsOutlookCompose::ReleaseIdentity();</span>
<a href="#l30.312"></a><span id="l30.312"> }</span>
<a href="#l30.313"></a><span id="l30.313"> </span>
<a href="#l30.314"></a><span id="l30.314"> NS_IMPL_ISUPPORTS(ImportOutlookMailImpl, nsIImportMail)</span>
<a href="#l30.315"></a><span id="l30.315"> </span>
<a href="#l30.316"></a><span id="l30.316" class="difflineminus">-NS_IMETHODIMP ImportOutlookMailImpl::GetDefaultLocation(nsIFile **ppLoc, bool *found, bool *userVerify)</span>
<a href="#l30.317"></a><span id="l30.317" class="difflineminus">-{</span>
<a href="#l30.318"></a><span id="l30.318" class="difflineplus">+NS_IMETHODIMP ImportOutlookMailImpl::GetDefaultLocation(nsIFile **ppLoc,</span>
<a href="#l30.319"></a><span id="l30.319" class="difflineplus">+                                                        bool *found,</span>
<a href="#l30.320"></a><span id="l30.320" class="difflineplus">+                                                        bool *userVerify) {</span>
<a href="#l30.321"></a><span id="l30.321">   NS_ASSERTION(ppLoc != nullptr, &quot;null ptr&quot;);</span>
<a href="#l30.322"></a><span id="l30.322">   NS_ASSERTION(found != nullptr, &quot;null ptr&quot;);</span>
<a href="#l30.323"></a><span id="l30.323">   NS_ASSERTION(userVerify != nullptr, &quot;null ptr&quot;);</span>
<a href="#l30.324"></a><span id="l30.324" class="difflineminus">-  if (!ppLoc || !found || !userVerify)</span>
<a href="#l30.325"></a><span id="l30.325" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l30.326"></a><span id="l30.326" class="difflineplus">+  if (!ppLoc || !found || !userVerify) return NS_ERROR_NULL_POINTER;</span>
<a href="#l30.327"></a><span id="l30.327"> </span>
<a href="#l30.328"></a><span id="l30.328">   *found = false;</span>
<a href="#l30.329"></a><span id="l30.329">   *ppLoc = nullptr;</span>
<a href="#l30.330"></a><span id="l30.330">   *userVerify = false;</span>
<a href="#l30.331"></a><span id="l30.331">   // We need to verify here that we can get the mail, if true then</span>
<a href="#l30.332"></a><span id="l30.332">   // return a dummy location, otherwise return no location</span>
<a href="#l30.333"></a><span id="l30.333" class="difflineminus">-  CMapiApi  mapi;</span>
<a href="#l30.334"></a><span id="l30.334" class="difflineminus">-  if (!mapi.Initialize())</span>
<a href="#l30.335"></a><span id="l30.335" class="difflineminus">-    return NS_OK;</span>
<a href="#l30.336"></a><span id="l30.336" class="difflineminus">-  if (!mapi.LogOn())</span>
<a href="#l30.337"></a><span id="l30.337" class="difflineminus">-    return NS_OK;</span>
<a href="#l30.338"></a><span id="l30.338" class="difflineplus">+  CMapiApi mapi;</span>
<a href="#l30.339"></a><span id="l30.339" class="difflineplus">+  if (!mapi.Initialize()) return NS_OK;</span>
<a href="#l30.340"></a><span id="l30.340" class="difflineplus">+  if (!mapi.LogOn()) return NS_OK;</span>
<a href="#l30.341"></a><span id="l30.341" class="difflineplus">+</span>
<a href="#l30.342"></a><span id="l30.342" class="difflineplus">+  CMapiFolderList store;</span>
<a href="#l30.343"></a><span id="l30.343" class="difflineplus">+  if (!mapi.IterateStores(store)) return NS_OK;</span>
<a href="#l30.344"></a><span id="l30.344"> </span>
<a href="#l30.345"></a><span id="l30.345" class="difflineminus">-  CMapiFolderList  store;</span>
<a href="#l30.346"></a><span id="l30.346" class="difflineminus">-  if (!mapi.IterateStores(store))</span>
<a href="#l30.347"></a><span id="l30.347" class="difflineminus">-    return NS_OK;</span>
<a href="#l30.348"></a><span id="l30.348" class="difflineplus">+  if (store.GetSize() == 0) return NS_OK;</span>
<a href="#l30.349"></a><span id="l30.349"> </span>
<a href="#l30.350"></a><span id="l30.350" class="difflineminus">-  if (store.GetSize() == 0)</span>
<a href="#l30.351"></a><span id="l30.351" class="difflineminus">-    return NS_OK;</span>
<a href="#l30.352"></a><span id="l30.352" class="difflineminus">-</span>
<a href="#l30.353"></a><span id="l30.353" class="difflineminus">-</span>
<a href="#l30.354"></a><span id="l30.354" class="difflineminus">-  nsresult  rv;</span>
<a href="#l30.355"></a><span id="l30.355" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; resultFile = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l30.356"></a><span id="l30.356" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l30.357"></a><span id="l30.357" class="difflineminus">-    return rv;</span>
<a href="#l30.358"></a><span id="l30.358" class="difflineplus">+  nsresult rv;</span>
<a href="#l30.359"></a><span id="l30.359" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; resultFile =</span>
<a href="#l30.360"></a><span id="l30.360" class="difflineplus">+      do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l30.361"></a><span id="l30.361" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l30.362"></a><span id="l30.362"> </span>
<a href="#l30.363"></a><span id="l30.363">   *found = true;</span>
<a href="#l30.364"></a><span id="l30.364">   resultFile.forget(ppLoc);</span>
<a href="#l30.365"></a><span id="l30.365">   *userVerify = false;</span>
<a href="#l30.366"></a><span id="l30.366"> </span>
<a href="#l30.367"></a><span id="l30.367">   return NS_OK;</span>
<a href="#l30.368"></a><span id="l30.368"> }</span>
<a href="#l30.369"></a><span id="l30.369"> </span>
<a href="#l30.370"></a><span id="l30.370" class="difflineminus">-</span>
<a href="#l30.371"></a><span id="l30.371" class="difflineminus">-NS_IMETHODIMP ImportOutlookMailImpl::FindMailboxes(nsIFile *pLoc, nsIArray **ppArray)</span>
<a href="#l30.372"></a><span id="l30.372" class="difflineminus">-{</span>
<a href="#l30.373"></a><span id="l30.373" class="difflineplus">+NS_IMETHODIMP ImportOutlookMailImpl::FindMailboxes(nsIFile *pLoc,</span>
<a href="#l30.374"></a><span id="l30.374" class="difflineplus">+                                                   nsIArray **ppArray) {</span>
<a href="#l30.375"></a><span id="l30.375">   NS_ASSERTION(pLoc != nullptr, &quot;null ptr&quot;);</span>
<a href="#l30.376"></a><span id="l30.376">   NS_ASSERTION(ppArray != nullptr, &quot;null ptr&quot;);</span>
<a href="#l30.377"></a><span id="l30.377" class="difflineminus">-  if (!pLoc || !ppArray)</span>
<a href="#l30.378"></a><span id="l30.378" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l30.379"></a><span id="l30.379" class="difflineplus">+  if (!pLoc || !ppArray) return NS_ERROR_NULL_POINTER;</span>
<a href="#l30.380"></a><span id="l30.380">   return m_mail.GetMailFolders(ppArray);</span>
<a href="#l30.381"></a><span id="l30.381"> }</span>
<a href="#l30.382"></a><span id="l30.382"> </span>
<a href="#l30.383"></a><span id="l30.383" class="difflineminus">-void ImportOutlookMailImpl::AddLinebreak(nsString *pStream)</span>
<a href="#l30.384"></a><span id="l30.384" class="difflineminus">-{</span>
<a href="#l30.385"></a><span id="l30.385" class="difflineminus">-  if (pStream)</span>
<a href="#l30.386"></a><span id="l30.386" class="difflineminus">-    pStream-&gt;Append(char16_t('\n'));</span>
<a href="#l30.387"></a><span id="l30.387" class="difflineplus">+void ImportOutlookMailImpl::AddLinebreak(nsString *pStream) {</span>
<a href="#l30.388"></a><span id="l30.388" class="difflineplus">+  if (pStream) pStream-&gt;Append(char16_t('\n'));</span>
<a href="#l30.389"></a><span id="l30.389"> }</span>
<a href="#l30.390"></a><span id="l30.390"> </span>
<a href="#l30.391"></a><span id="l30.391" class="difflineminus">-void ImportOutlookMailImpl::ReportSuccess(nsString&amp; name, int32_t count, nsString *pStream)</span>
<a href="#l30.392"></a><span id="l30.392" class="difflineminus">-{</span>
<a href="#l30.393"></a><span id="l30.393" class="difflineminus">-  if (!pStream)</span>
<a href="#l30.394"></a><span id="l30.394" class="difflineminus">-    return;</span>
<a href="#l30.395"></a><span id="l30.395" class="difflineplus">+void ImportOutlookMailImpl::ReportSuccess(nsString &amp;name, int32_t count,</span>
<a href="#l30.396"></a><span id="l30.396" class="difflineplus">+                                          nsString *pStream) {</span>
<a href="#l30.397"></a><span id="l30.397" class="difflineplus">+  if (!pStream) return;</span>
<a href="#l30.398"></a><span id="l30.398">   // load the success string</span>
<a href="#l30.399"></a><span id="l30.399" class="difflineminus">-  char16_t *pFmt = nsOutlookStringBundle::GetStringByID(OUTLOOKIMPORT_MAILBOX_SUCCESS);</span>
<a href="#l30.400"></a><span id="l30.400" class="difflineplus">+  char16_t *pFmt =</span>
<a href="#l30.401"></a><span id="l30.401" class="difflineplus">+      nsOutlookStringBundle::GetStringByID(OUTLOOKIMPORT_MAILBOX_SUCCESS);</span>
<a href="#l30.402"></a><span id="l30.402">   nsString pText;</span>
<a href="#l30.403"></a><span id="l30.403">   nsTextFormatter::ssprintf(pText, pFmt, name.get(), count);</span>
<a href="#l30.404"></a><span id="l30.404">   pStream-&gt;Append(pText);</span>
<a href="#l30.405"></a><span id="l30.405">   nsOutlookStringBundle::FreeString(pFmt);</span>
<a href="#l30.406"></a><span id="l30.406">   AddLinebreak(pStream);</span>
<a href="#l30.407"></a><span id="l30.407"> }</span>
<a href="#l30.408"></a><span id="l30.408"> </span>
<a href="#l30.409"></a><span id="l30.409" class="difflineminus">-void ImportOutlookMailImpl::ReportError(int32_t errorNum, nsString&amp; name, nsString *pStream)</span>
<a href="#l30.410"></a><span id="l30.410" class="difflineminus">-{</span>
<a href="#l30.411"></a><span id="l30.411" class="difflineminus">-  if (!pStream)</span>
<a href="#l30.412"></a><span id="l30.412" class="difflineminus">-    return;</span>
<a href="#l30.413"></a><span id="l30.413" class="difflineplus">+void ImportOutlookMailImpl::ReportError(int32_t errorNum, nsString &amp;name,</span>
<a href="#l30.414"></a><span id="l30.414" class="difflineplus">+                                        nsString *pStream) {</span>
<a href="#l30.415"></a><span id="l30.415" class="difflineplus">+  if (!pStream) return;</span>
<a href="#l30.416"></a><span id="l30.416">   // load the error string</span>
<a href="#l30.417"></a><span id="l30.417">   char16_t *pFmt = nsOutlookStringBundle::GetStringByID(errorNum);</span>
<a href="#l30.418"></a><span id="l30.418">   nsString pText;</span>
<a href="#l30.419"></a><span id="l30.419">   nsTextFormatter::ssprintf(pText, pFmt, name.get());</span>
<a href="#l30.420"></a><span id="l30.420">   pStream-&gt;Append(pText);</span>
<a href="#l30.421"></a><span id="l30.421">   nsOutlookStringBundle::FreeString(pFmt);</span>
<a href="#l30.422"></a><span id="l30.422">   AddLinebreak(pStream);</span>
<a href="#l30.423"></a><span id="l30.423"> }</span>
<a href="#l30.424"></a><span id="l30.424"> </span>
<a href="#l30.425"></a><span id="l30.425" class="difflineminus">-</span>
<a href="#l30.426"></a><span id="l30.426" class="difflineminus">-void ImportOutlookMailImpl::SetLogs(nsString&amp; success, nsString&amp; error, char16_t **pError, char16_t **pSuccess)</span>
<a href="#l30.427"></a><span id="l30.427" class="difflineminus">-{</span>
<a href="#l30.428"></a><span id="l30.428" class="difflineminus">-  if (pError)</span>
<a href="#l30.429"></a><span id="l30.429" class="difflineminus">-    *pError = ToNewUnicode(error);</span>
<a href="#l30.430"></a><span id="l30.430" class="difflineminus">-  if (pSuccess)</span>
<a href="#l30.431"></a><span id="l30.431" class="difflineminus">-    *pSuccess = ToNewUnicode(success);</span>
<a href="#l30.432"></a><span id="l30.432" class="difflineplus">+void ImportOutlookMailImpl::SetLogs(nsString &amp;success, nsString &amp;error,</span>
<a href="#l30.433"></a><span id="l30.433" class="difflineplus">+                                    char16_t **pError, char16_t **pSuccess) {</span>
<a href="#l30.434"></a><span id="l30.434" class="difflineplus">+  if (pError) *pError = ToNewUnicode(error);</span>
<a href="#l30.435"></a><span id="l30.435" class="difflineplus">+  if (pSuccess) *pSuccess = ToNewUnicode(success);</span>
<a href="#l30.436"></a><span id="l30.436"> }</span>
<a href="#l30.437"></a><span id="l30.437"> </span>
<a href="#l30.438"></a><span id="l30.438"> NS_IMETHODIMP</span>
<a href="#l30.439"></a><span id="l30.439"> ImportOutlookMailImpl::ImportMailbox(nsIImportMailboxDescriptor *pSource,</span>
<a href="#l30.440"></a><span id="l30.440">                                      nsIMsgFolder *dstFolder,</span>
<a href="#l30.441"></a><span id="l30.441">                                      char16_t **pErrorLog,</span>
<a href="#l30.442"></a><span id="l30.442" class="difflineminus">-                                     char16_t **pSuccessLog,</span>
<a href="#l30.443"></a><span id="l30.443" class="difflineminus">-                                     bool *fatalError)</span>
<a href="#l30.444"></a><span id="l30.444" class="difflineminus">-{</span>
<a href="#l30.445"></a><span id="l30.445" class="difflineplus">+                                     char16_t **pSuccessLog, bool *fatalError) {</span>
<a href="#l30.446"></a><span id="l30.446">   NS_ENSURE_ARG_POINTER(pSource);</span>
<a href="#l30.447"></a><span id="l30.447">   NS_ENSURE_ARG_POINTER(dstFolder);</span>
<a href="#l30.448"></a><span id="l30.448">   NS_ENSURE_ARG_POINTER(fatalError);</span>
<a href="#l30.449"></a><span id="l30.449"> </span>
<a href="#l30.450"></a><span id="l30.450" class="difflineminus">-  nsString  success;</span>
<a href="#l30.451"></a><span id="l30.451" class="difflineminus">-  nsString  error;</span>
<a href="#l30.452"></a><span id="l30.452" class="difflineplus">+  nsString success;</span>
<a href="#l30.453"></a><span id="l30.453" class="difflineplus">+  nsString error;</span>
<a href="#l30.454"></a><span id="l30.454">   bool abort = false;</span>
<a href="#l30.455"></a><span id="l30.455">   nsString name;</span>
<a href="#l30.456"></a><span id="l30.456">   char16_t *pName;</span>
<a href="#l30.457"></a><span id="l30.457" class="difflineminus">-  if (NS_SUCCEEDED( pSource-&gt;GetDisplayName( &amp;pName))) {</span>
<a href="#l30.458"></a><span id="l30.458" class="difflineplus">+  if (NS_SUCCEEDED(pSource-&gt;GetDisplayName(&amp;pName))) {</span>
<a href="#l30.459"></a><span id="l30.459">     name = pName;</span>
<a href="#l30.460"></a><span id="l30.460" class="difflineminus">-    free( pName);</span>
<a href="#l30.461"></a><span id="l30.461" class="difflineminus">- }</span>
<a href="#l30.462"></a><span id="l30.462" class="difflineplus">+    free(pName);</span>
<a href="#l30.463"></a><span id="l30.463" class="difflineplus">+  }</span>
<a href="#l30.464"></a><span id="l30.464"> </span>
<a href="#l30.465"></a><span id="l30.465">   uint32_t mailSize = 0;</span>
<a href="#l30.466"></a><span id="l30.466">   pSource-&gt;GetSize(&amp;mailSize);</span>
<a href="#l30.467"></a><span id="l30.467">   if (mailSize == 0) {</span>
<a href="#l30.468"></a><span id="l30.468">     ReportSuccess(name, 0, &amp;success);</span>
<a href="#l30.469"></a><span id="l30.469">     SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l30.470"></a><span id="l30.470">     return NS_OK;</span>
<a href="#l30.471"></a><span id="l30.471">   }</span>
<a href="#l30.472"></a><span id="l30.472"> </span>
<a href="#l30.473"></a><span id="l30.473">   uint32_t index = 0;</span>
<a href="#l30.474"></a><span id="l30.474">   pSource-&gt;GetIdentifier(&amp;index);</span>
<a href="#l30.475"></a><span id="l30.475" class="difflineminus">-  int32_t  msgCount = 0;</span>
<a href="#l30.476"></a><span id="l30.476" class="difflineplus">+  int32_t msgCount = 0;</span>
<a href="#l30.477"></a><span id="l30.477">   nsresult rv = NS_OK;</span>
<a href="#l30.478"></a><span id="l30.478"> </span>
<a href="#l30.479"></a><span id="l30.479">   m_bytesDone = 0;</span>
<a href="#l30.480"></a><span id="l30.480"> </span>
<a href="#l30.481"></a><span id="l30.481">   rv = m_mail.ImportMailbox(&amp;m_bytesDone, &amp;abort, (int32_t)index, name.get(),</span>
<a href="#l30.482"></a><span id="l30.482">                             dstFolder, &amp;msgCount);</span>
<a href="#l30.483"></a><span id="l30.483"> </span>
<a href="#l30.484"></a><span id="l30.484">   if (NS_SUCCEEDED(rv))</span>
<a href="#l30.485"></a><span id="l30.485" class="difflineat">@@ -407,156 +386,140 @@ ImportOutlookMailImpl::ImportMailbox(nsI</span>
<a href="#l30.486"></a><span id="l30.486">   else</span>
<a href="#l30.487"></a><span id="l30.487">     ReportError(OUTLOOKIMPORT_MAILBOX_CONVERTERROR, name, &amp;error);</span>
<a href="#l30.488"></a><span id="l30.488"> </span>
<a href="#l30.489"></a><span id="l30.489">   SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l30.490"></a><span id="l30.490"> </span>
<a href="#l30.491"></a><span id="l30.491">   return rv;</span>
<a href="#l30.492"></a><span id="l30.492"> }</span>
<a href="#l30.493"></a><span id="l30.493"> </span>
<a href="#l30.494"></a><span id="l30.494" class="difflineminus">-</span>
<a href="#l30.495"></a><span id="l30.495" class="difflineminus">-NS_IMETHODIMP ImportOutlookMailImpl::GetImportProgress(uint32_t *pDoneSoFar)</span>
<a href="#l30.496"></a><span id="l30.496" class="difflineminus">-{</span>
<a href="#l30.497"></a><span id="l30.497" class="difflineplus">+NS_IMETHODIMP ImportOutlookMailImpl::GetImportProgress(uint32_t *pDoneSoFar) {</span>
<a href="#l30.498"></a><span id="l30.498">   NS_ASSERTION(pDoneSoFar != nullptr, &quot;null ptr&quot;);</span>
<a href="#l30.499"></a><span id="l30.499" class="difflineminus">-  if (! pDoneSoFar)</span>
<a href="#l30.500"></a><span id="l30.500" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l30.501"></a><span id="l30.501" class="difflineplus">+  if (!pDoneSoFar) return NS_ERROR_NULL_POINTER;</span>
<a href="#l30.502"></a><span id="l30.502"> </span>
<a href="#l30.503"></a><span id="l30.503">   *pDoneSoFar = m_bytesDone;</span>
<a href="#l30.504"></a><span id="l30.504">   return NS_OK;</span>
<a href="#l30.505"></a><span id="l30.505"> }</span>
<a href="#l30.506"></a><span id="l30.506"> </span>
<a href="#l30.507"></a><span id="l30.507" class="difflineminus">-NS_IMETHODIMP ImportOutlookMailImpl::TranslateFolderName(const nsAString &amp; aFolderName, nsAString &amp; _retval)</span>
<a href="#l30.508"></a><span id="l30.508" class="difflineminus">-{</span>
<a href="#l30.509"></a><span id="l30.509" class="difflineplus">+NS_IMETHODIMP ImportOutlookMailImpl::TranslateFolderName(</span>
<a href="#l30.510"></a><span id="l30.510" class="difflineplus">+    const nsAString &amp;aFolderName, nsAString &amp;_retval) {</span>
<a href="#l30.511"></a><span id="l30.511">   if (aFolderName.LowerCaseEqualsLiteral(&quot;deleted items&quot;))</span>
<a href="#l30.512"></a><span id="l30.512">     _retval = NS_LITERAL_STRING(kDestTrashFolderName);</span>
<a href="#l30.513"></a><span id="l30.513">   else if (aFolderName.LowerCaseEqualsLiteral(&quot;sent items&quot;))</span>
<a href="#l30.514"></a><span id="l30.514">     _retval = NS_LITERAL_STRING(kDestSentFolderName);</span>
<a href="#l30.515"></a><span id="l30.515">   else if (aFolderName.LowerCaseEqualsLiteral(&quot;outbox&quot;))</span>
<a href="#l30.516"></a><span id="l30.516">     _retval = NS_LITERAL_STRING(kDestUnsentMessagesFolderName);</span>
<a href="#l30.517"></a><span id="l30.517">   else</span>
<a href="#l30.518"></a><span id="l30.518">     _retval = aFolderName;</span>
<a href="#l30.519"></a><span id="l30.519">   return NS_OK;</span>
<a href="#l30.520"></a><span id="l30.520"> }</span>
<a href="#l30.521"></a><span id="l30.521"> </span>
<a href="#l30.522"></a><span id="l30.522" class="difflineminus">-nsresult ImportOutlookAddressImpl::Create(nsIImportAddressBooks** aImport)</span>
<a href="#l30.523"></a><span id="l30.523" class="difflineminus">-{</span>
<a href="#l30.524"></a><span id="l30.524" class="difflineplus">+nsresult ImportOutlookAddressImpl::Create(nsIImportAddressBooks **aImport) {</span>
<a href="#l30.525"></a><span id="l30.525">   NS_ENSURE_ARG_POINTER(aImport);</span>
<a href="#l30.526"></a><span id="l30.526">   NS_ADDREF(*aImport = new ImportOutlookAddressImpl());</span>
<a href="#l30.527"></a><span id="l30.527">   return NS_OK;</span>
<a href="#l30.528"></a><span id="l30.528"> }</span>
<a href="#l30.529"></a><span id="l30.529"> </span>
<a href="#l30.530"></a><span id="l30.530" class="difflineminus">-ImportOutlookAddressImpl::ImportOutlookAddressImpl()</span>
<a href="#l30.531"></a><span id="l30.531" class="difflineminus">-{</span>
<a href="#l30.532"></a><span id="l30.532" class="difflineplus">+ImportOutlookAddressImpl::ImportOutlookAddressImpl() {</span>
<a href="#l30.533"></a><span id="l30.533">   m_msgCount = 0;</span>
<a href="#l30.534"></a><span id="l30.534">   m_msgTotal = 0;</span>
<a href="#l30.535"></a><span id="l30.535"> }</span>
<a href="#l30.536"></a><span id="l30.536"> </span>
<a href="#l30.537"></a><span id="l30.537" class="difflineminus">-ImportOutlookAddressImpl::~ImportOutlookAddressImpl()</span>
<a href="#l30.538"></a><span id="l30.538" class="difflineminus">-{</span>
<a href="#l30.539"></a><span id="l30.539" class="difflineminus">-}</span>
<a href="#l30.540"></a><span id="l30.540" class="difflineplus">+ImportOutlookAddressImpl::~ImportOutlookAddressImpl() {}</span>
<a href="#l30.541"></a><span id="l30.541"> </span>
<a href="#l30.542"></a><span id="l30.542"> NS_IMPL_ISUPPORTS(ImportOutlookAddressImpl, nsIImportAddressBooks)</span>
<a href="#l30.543"></a><span id="l30.543"> </span>
<a href="#l30.544"></a><span id="l30.544" class="difflineminus">-NS_IMETHODIMP ImportOutlookAddressImpl::GetAutoFind(char16_t **description, bool *_retval)</span>
<a href="#l30.545"></a><span id="l30.545" class="difflineminus">-{</span>
<a href="#l30.546"></a><span id="l30.546" class="difflineplus">+NS_IMETHODIMP ImportOutlookAddressImpl::GetAutoFind(char16_t **description,</span>
<a href="#l30.547"></a><span id="l30.547" class="difflineplus">+                                                    bool *_retval) {</span>
<a href="#l30.548"></a><span id="l30.548">   NS_ASSERTION(description != nullptr, &quot;null ptr&quot;);</span>
<a href="#l30.549"></a><span id="l30.549">   NS_ASSERTION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l30.550"></a><span id="l30.550" class="difflineminus">-  if (! description || !_retval)</span>
<a href="#l30.551"></a><span id="l30.551" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l30.552"></a><span id="l30.552" class="difflineplus">+  if (!description || !_retval) return NS_ERROR_NULL_POINTER;</span>
<a href="#l30.553"></a><span id="l30.553"> </span>
<a href="#l30.554"></a><span id="l30.554">   *_retval = true;</span>
<a href="#l30.555"></a><span id="l30.555">   nsString str;</span>
<a href="#l30.556"></a><span id="l30.556">   nsOutlookStringBundle::GetStringByID(OUTLOOKIMPORT_ADDRNAME, str);</span>
<a href="#l30.557"></a><span id="l30.557">   *description = ToNewUnicode(str);</span>
<a href="#l30.558"></a><span id="l30.558">   return NS_OK;</span>
<a href="#l30.559"></a><span id="l30.559"> }</span>
<a href="#l30.560"></a><span id="l30.560"> </span>
<a href="#l30.561"></a><span id="l30.561" class="difflineminus">-NS_IMETHODIMP ImportOutlookAddressImpl::FindAddressBooks(nsIFile *location, nsIArray **_retval)</span>
<a href="#l30.562"></a><span id="l30.562" class="difflineminus">-{</span>
<a href="#l30.563"></a><span id="l30.563" class="difflineplus">+NS_IMETHODIMP ImportOutlookAddressImpl::FindAddressBooks(nsIFile *location,</span>
<a href="#l30.564"></a><span id="l30.564" class="difflineplus">+                                                         nsIArray **_retval) {</span>
<a href="#l30.565"></a><span id="l30.565">   NS_ASSERTION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l30.566"></a><span id="l30.566" class="difflineminus">-  if (!_retval)</span>
<a href="#l30.567"></a><span id="l30.567" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l30.568"></a><span id="l30.568" class="difflineplus">+  if (!_retval) return NS_ERROR_NULL_POINTER;</span>
<a href="#l30.569"></a><span id="l30.569"> </span>
<a href="#l30.570"></a><span id="l30.570">   return m_address.GetAddressBooks(_retval);</span>
<a href="#l30.571"></a><span id="l30.571"> }</span>
<a href="#l30.572"></a><span id="l30.572"> </span>
<a href="#l30.573"></a><span id="l30.573" class="difflineminus">-NS_IMETHODIMP ImportOutlookAddressImpl::ImportAddressBook(nsIImportABDescriptor *source,</span>
<a href="#l30.574"></a><span id="l30.574" class="difflineminus">-                                                          nsIAddrDatabase *destination,</span>
<a href="#l30.575"></a><span id="l30.575" class="difflineminus">-                                                          nsIImportFieldMap *fieldMap,</span>
<a href="#l30.576"></a><span id="l30.576" class="difflineminus">-                                                          nsISupports *aSupportService,</span>
<a href="#l30.577"></a><span id="l30.577" class="difflineminus">-                                                          char16_t **pErrorLog,</span>
<a href="#l30.578"></a><span id="l30.578" class="difflineminus">-                                                          char16_t **pSuccessLog,</span>
<a href="#l30.579"></a><span id="l30.579" class="difflineminus">-                                                          bool *fatalError)</span>
<a href="#l30.580"></a><span id="l30.580" class="difflineminus">-{</span>
<a href="#l30.581"></a><span id="l30.581" class="difflineplus">+NS_IMETHODIMP ImportOutlookAddressImpl::ImportAddressBook(</span>
<a href="#l30.582"></a><span id="l30.582" class="difflineplus">+    nsIImportABDescriptor *source, nsIAddrDatabase *destination,</span>
<a href="#l30.583"></a><span id="l30.583" class="difflineplus">+    nsIImportFieldMap *fieldMap, nsISupports *aSupportService,</span>
<a href="#l30.584"></a><span id="l30.584" class="difflineplus">+    char16_t **pErrorLog, char16_t **pSuccessLog, bool *fatalError) {</span>
<a href="#l30.585"></a><span id="l30.585">   m_msgCount = 0;</span>
<a href="#l30.586"></a><span id="l30.586">   m_msgTotal = 0;</span>
<a href="#l30.587"></a><span id="l30.587">   NS_ASSERTION(source != nullptr, &quot;null ptr&quot;);</span>
<a href="#l30.588"></a><span id="l30.588">   NS_ASSERTION(destination != nullptr, &quot;null ptr&quot;);</span>
<a href="#l30.589"></a><span id="l30.589">   NS_ASSERTION(fatalError != nullptr, &quot;null ptr&quot;);</span>
<a href="#l30.590"></a><span id="l30.590"> </span>
<a href="#l30.591"></a><span id="l30.591" class="difflineminus">-  nsString  success;</span>
<a href="#l30.592"></a><span id="l30.592" class="difflineminus">-  nsString  error;</span>
<a href="#l30.593"></a><span id="l30.593" class="difflineminus">-    if (!source || !destination || !fatalError) {</span>
<a href="#l30.594"></a><span id="l30.594" class="difflineplus">+  nsString success;</span>
<a href="#l30.595"></a><span id="l30.595" class="difflineplus">+  nsString error;</span>
<a href="#l30.596"></a><span id="l30.596" class="difflineplus">+  if (!source || !destination || !fatalError) {</span>
<a href="#l30.597"></a><span id="l30.597">     IMPORT_LOG0(&quot;*** Bad param passed to outlook address import\n&quot;);</span>
<a href="#l30.598"></a><span id="l30.598">     nsOutlookStringBundle::GetStringByID(OUTLOOKIMPORT_ADDRESS_BADPARAM, error);</span>
<a href="#l30.599"></a><span id="l30.599" class="difflineminus">-    if (fatalError)</span>
<a href="#l30.600"></a><span id="l30.600" class="difflineminus">-      *fatalError = true;</span>
<a href="#l30.601"></a><span id="l30.601" class="difflineplus">+    if (fatalError) *fatalError = true;</span>
<a href="#l30.602"></a><span id="l30.602">     ImportOutlookMailImpl::SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l30.603"></a><span id="l30.603" class="difflineminus">-      return NS_ERROR_NULL_POINTER;</span>
<a href="#l30.604"></a><span id="l30.604" class="difflineplus">+    return NS_ERROR_NULL_POINTER;</span>
<a href="#l30.605"></a><span id="l30.605">   }</span>
<a href="#l30.606"></a><span id="l30.606"> </span>
<a href="#l30.607"></a><span id="l30.607" class="difflineminus">-    nsString name;</span>
<a href="#l30.608"></a><span id="l30.608" class="difflineminus">-    source-&gt;GetPreferredName(name);</span>
<a href="#l30.609"></a><span id="l30.609" class="difflineplus">+  nsString name;</span>
<a href="#l30.610"></a><span id="l30.610" class="difflineplus">+  source-&gt;GetPreferredName(name);</span>
<a href="#l30.611"></a><span id="l30.611"> </span>
<a href="#l30.612"></a><span id="l30.612" class="difflineminus">-  uint32_t  id;</span>
<a href="#l30.613"></a><span id="l30.613" class="difflineplus">+  uint32_t id;</span>
<a href="#l30.614"></a><span id="l30.614">   if (NS_FAILED(source-&gt;GetIdentifier(&amp;id))) {</span>
<a href="#l30.615"></a><span id="l30.615" class="difflineminus">-    ImportOutlookMailImpl::ReportError(OUTLOOKIMPORT_ADDRESS_BADSOURCEFILE, name, &amp;error);</span>
<a href="#l30.616"></a><span id="l30.616" class="difflineplus">+    ImportOutlookMailImpl::ReportError(OUTLOOKIMPORT_ADDRESS_BADSOURCEFILE,</span>
<a href="#l30.617"></a><span id="l30.617" class="difflineplus">+                                       name, &amp;error);</span>
<a href="#l30.618"></a><span id="l30.618">     ImportOutlookMailImpl::SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l30.619"></a><span id="l30.619">     return NS_ERROR_FAILURE;</span>
<a href="#l30.620"></a><span id="l30.620">   }</span>
<a href="#l30.621"></a><span id="l30.621"> </span>
<a href="#l30.622"></a><span id="l30.622">   nsresult rv = NS_OK;</span>
<a href="#l30.623"></a><span id="l30.623" class="difflineminus">-  rv = m_address.ImportAddresses(&amp;m_msgCount, &amp;m_msgTotal, name.get(), id, destination, error);</span>
<a href="#l30.624"></a><span id="l30.624" class="difflineplus">+  rv = m_address.ImportAddresses(&amp;m_msgCount, &amp;m_msgTotal, name.get(), id,</span>
<a href="#l30.625"></a><span id="l30.625" class="difflineplus">+                                 destination, error);</span>
<a href="#l30.626"></a><span id="l30.626">   if (NS_SUCCEEDED(rv) &amp;&amp; error.IsEmpty())</span>
<a href="#l30.627"></a><span id="l30.627">     ReportSuccess(name, &amp;success);</span>
<a href="#l30.628"></a><span id="l30.628">   else</span>
<a href="#l30.629"></a><span id="l30.629" class="difflineminus">-    ImportOutlookMailImpl::ReportError(OUTLOOKIMPORT_ADDRESS_CONVERTERROR, name, &amp;error);</span>
<a href="#l30.630"></a><span id="l30.630" class="difflineplus">+    ImportOutlookMailImpl::ReportError(OUTLOOKIMPORT_ADDRESS_CONVERTERROR, name,</span>
<a href="#l30.631"></a><span id="l30.631" class="difflineplus">+                                       &amp;error);</span>
<a href="#l30.632"></a><span id="l30.632"> </span>
<a href="#l30.633"></a><span id="l30.633">   ImportOutlookMailImpl::SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l30.634"></a><span id="l30.634">   IMPORT_LOG0(&quot;*** Returning from outlook address import\n&quot;);</span>
<a href="#l30.635"></a><span id="l30.635">   return destination-&gt;Commit(nsAddrDBCommitType::kLargeCommit);</span>
<a href="#l30.636"></a><span id="l30.636"> }</span>
<a href="#l30.637"></a><span id="l30.637"> </span>
<a href="#l30.638"></a><span id="l30.638" class="difflineminus">-</span>
<a href="#l30.639"></a><span id="l30.639" class="difflineminus">-NS_IMETHODIMP ImportOutlookAddressImpl::GetImportProgress(uint32_t *_retval)</span>
<a href="#l30.640"></a><span id="l30.640" class="difflineminus">-{</span>
<a href="#l30.641"></a><span id="l30.641" class="difflineplus">+NS_IMETHODIMP ImportOutlookAddressImpl::GetImportProgress(uint32_t *_retval) {</span>
<a href="#l30.642"></a><span id="l30.642">   NS_ASSERTION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l30.643"></a><span id="l30.643" class="difflineminus">-  if (!_retval)</span>
<a href="#l30.644"></a><span id="l30.644" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l30.645"></a><span id="l30.645" class="difflineplus">+  if (!_retval) return NS_ERROR_NULL_POINTER;</span>
<a href="#l30.646"></a><span id="l30.646"> </span>
<a href="#l30.647"></a><span id="l30.647">   uint32_t result = m_msgCount;</span>
<a href="#l30.648"></a><span id="l30.648">   if (m_msgTotal) {</span>
<a href="#l30.649"></a><span id="l30.649">     result *= 100;</span>
<a href="#l30.650"></a><span id="l30.650">     result /= m_msgTotal;</span>
<a href="#l30.651"></a><span id="l30.651" class="difflineminus">-  }</span>
<a href="#l30.652"></a><span id="l30.652" class="difflineminus">-  else</span>
<a href="#l30.653"></a><span id="l30.653" class="difflineplus">+  } else</span>
<a href="#l30.654"></a><span id="l30.654">     result = 0;</span>
<a href="#l30.655"></a><span id="l30.655"> </span>
<a href="#l30.656"></a><span id="l30.656" class="difflineminus">-  if (result &gt; 100)</span>
<a href="#l30.657"></a><span id="l30.657" class="difflineminus">-    result = 100;</span>
<a href="#l30.658"></a><span id="l30.658" class="difflineplus">+  if (result &gt; 100) result = 100;</span>
<a href="#l30.659"></a><span id="l30.659"> </span>
<a href="#l30.660"></a><span id="l30.660">   *_retval = result;</span>
<a href="#l30.661"></a><span id="l30.661"> </span>
<a href="#l30.662"></a><span id="l30.662">   return NS_OK;</span>
<a href="#l30.663"></a><span id="l30.663"> }</span>
<a href="#l30.664"></a><span id="l30.664"> </span>
<a href="#l30.665"></a><span id="l30.665" class="difflineminus">-void ImportOutlookAddressImpl::ReportSuccess(nsString&amp; name, nsString *pStream)</span>
<a href="#l30.666"></a><span id="l30.666" class="difflineminus">-{</span>
<a href="#l30.667"></a><span id="l30.667" class="difflineminus">-  if (!pStream)</span>
<a href="#l30.668"></a><span id="l30.668" class="difflineminus">-    return;</span>
<a href="#l30.669"></a><span id="l30.669" class="difflineplus">+void ImportOutlookAddressImpl::ReportSuccess(nsString &amp;name,</span>
<a href="#l30.670"></a><span id="l30.670" class="difflineplus">+                                             nsString *pStream) {</span>
<a href="#l30.671"></a><span id="l30.671" class="difflineplus">+  if (!pStream) return;</span>
<a href="#l30.672"></a><span id="l30.672">   // load the success string</span>
<a href="#l30.673"></a><span id="l30.673" class="difflineminus">-  char16_t *pFmt = nsOutlookStringBundle::GetStringByID(OUTLOOKIMPORT_ADDRESS_SUCCESS);</span>
<a href="#l30.674"></a><span id="l30.674" class="difflineplus">+  char16_t *pFmt =</span>
<a href="#l30.675"></a><span id="l30.675" class="difflineplus">+      nsOutlookStringBundle::GetStringByID(OUTLOOKIMPORT_ADDRESS_SUCCESS);</span>
<a href="#l30.676"></a><span id="l30.676">   nsString pText;</span>
<a href="#l30.677"></a><span id="l30.677">   nsTextFormatter::ssprintf(pText, pFmt, name.get());</span>
<a href="#l30.678"></a><span id="l30.678">   pStream-&gt;Append(pText);</span>
<a href="#l30.679"></a><span id="l30.679">   nsOutlookStringBundle::FreeString(pFmt);</span>
<a href="#l30.680"></a><span id="l30.680">   ImportOutlookMailImpl::AddLinebreak(pStream);</span>
<a href="#l30.681"></a><span id="l30.681"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mailnews/import/outlook/src/nsOutlookImport.h</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mailnews/import/outlook/src/nsOutlookImport.h</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -4,41 +4,35 @@</span>
<a href="#l31.4"></a><span id="l31.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l31.5"></a><span id="l31.5"> </span>
<a href="#l31.6"></a><span id="l31.6"> #ifndef nsOutlookImport_h___</span>
<a href="#l31.7"></a><span id="l31.7"> #define nsOutlookImport_h___</span>
<a href="#l31.8"></a><span id="l31.8"> </span>
<a href="#l31.9"></a><span id="l31.9"> #include &quot;nsIImportModule.h&quot;</span>
<a href="#l31.10"></a><span id="l31.10"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l31.11"></a><span id="l31.11"> </span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineminus">-#define NS_OUTLOOKIMPORT_CID          \</span>
<a href="#l31.14"></a><span id="l31.14" class="difflineminus">-{ /* 1DB469A0-8B00-11d3-A206-00A0CC26DA63 */      \</span>
<a href="#l31.15"></a><span id="l31.15" class="difflineminus">-  0x1db469a0, 0x8b00, 0x11d3,            \</span>
<a href="#l31.16"></a><span id="l31.16" class="difflineminus">-  {0xa2, 0x6, 0x0, 0xa0, 0xcc, 0x26, 0xda, 0x63 }}</span>
<a href="#l31.17"></a><span id="l31.17" class="difflineminus">-</span>
<a href="#l31.18"></a><span id="l31.18" class="difflineminus">-</span>
<a href="#l31.19"></a><span id="l31.19" class="difflineplus">+#define NS_OUTLOOKIMPORT_CID                       \</span>
<a href="#l31.20"></a><span id="l31.20" class="difflineplus">+  { /* 1DB469A0-8B00-11d3-A206-00A0CC26DA63 */     \</span>
<a href="#l31.21"></a><span id="l31.21" class="difflineplus">+    0x1db469a0, 0x8b00, 0x11d3, {                  \</span>
<a href="#l31.22"></a><span id="l31.22" class="difflineplus">+      0xa2, 0x6, 0x0, 0xa0, 0xcc, 0x26, 0xda, 0x63 \</span>
<a href="#l31.23"></a><span id="l31.23" class="difflineplus">+    }                                              \</span>
<a href="#l31.24"></a><span id="l31.24" class="difflineplus">+  }</span>
<a href="#l31.25"></a><span id="l31.25"> </span>
<a href="#l31.26"></a><span id="l31.26" class="difflineminus">-</span>
<a href="#l31.27"></a><span id="l31.27" class="difflineminus">-#define kOutlookSupportsString NS_IMPORT_MAIL_STR &quot;,&quot; NS_IMPORT_ADDRESS_STR &quot;,&quot; NS_IMPORT_SETTINGS_STR</span>
<a href="#l31.28"></a><span id="l31.28" class="difflineplus">+#define kOutlookSupportsString \</span>
<a href="#l31.29"></a><span id="l31.29" class="difflineplus">+  NS_IMPORT_MAIL_STR &quot;,&quot; NS_IMPORT_ADDRESS_STR &quot;,&quot; NS_IMPORT_SETTINGS_STR</span>
<a href="#l31.30"></a><span id="l31.30"> </span>
<a href="#l31.31"></a><span id="l31.31" class="difflineminus">-class nsOutlookImport : public nsIImportModule</span>
<a href="#l31.32"></a><span id="l31.32" class="difflineminus">-{</span>
<a href="#l31.33"></a><span id="l31.33" class="difflineminus">-public:</span>
<a href="#l31.34"></a><span id="l31.34" class="difflineminus">-</span>
<a href="#l31.35"></a><span id="l31.35" class="difflineplus">+class nsOutlookImport : public nsIImportModule {</span>
<a href="#l31.36"></a><span id="l31.36" class="difflineplus">+ public:</span>
<a href="#l31.37"></a><span id="l31.37">   nsOutlookImport();</span>
<a href="#l31.38"></a><span id="l31.38"> </span>
<a href="#l31.39"></a><span id="l31.39">   NS_DECL_ISUPPORTS</span>
<a href="#l31.40"></a><span id="l31.40"> </span>
<a href="#l31.41"></a><span id="l31.41">   ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l31.42"></a><span id="l31.42">   // we support the nsIImportModule interface</span>
<a href="#l31.43"></a><span id="l31.43">   ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l31.44"></a><span id="l31.44"> </span>
<a href="#l31.45"></a><span id="l31.45">   NS_DECL_NSIIMPORTMODULE</span>
<a href="#l31.46"></a><span id="l31.46"> </span>
<a href="#l31.47"></a><span id="l31.47" class="difflineminus">-protected:</span>
<a href="#l31.48"></a><span id="l31.48" class="difflineplus">+ protected:</span>
<a href="#l31.49"></a><span id="l31.49">   virtual ~nsOutlookImport();</span>
<a href="#l31.50"></a><span id="l31.50"> };</span>
<a href="#l31.51"></a><span id="l31.51"> </span>
<a href="#l31.52"></a><span id="l31.52" class="difflineminus">-</span>
<a href="#l31.53"></a><span id="l31.53" class="difflineminus">-</span>
<a href="#l31.54"></a><span id="l31.54" class="difflineminus">-</span>
<a href="#l31.55"></a><span id="l31.55"> #endif /* nsOutlookImport_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mailnews/import/outlook/src/nsOutlookMail.cpp</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mailnews/import/outlook/src/nsOutlookMail.cpp</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -26,144 +26,138 @@</span>
<a href="#l32.4"></a><span id="l32.4"> #include &quot;nsIMsgPluggableStore.h&quot;</span>
<a href="#l32.5"></a><span id="l32.5"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l32.6"></a><span id="l32.6"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l32.7"></a><span id="l32.7"> #include &quot;nsMsgI18N.h&quot;</span>
<a href="#l32.8"></a><span id="l32.8"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l32.9"></a><span id="l32.9"> </span>
<a href="#l32.10"></a><span id="l32.10"> /* ------------ Address book stuff ----------------- */</span>
<a href="#l32.11"></a><span id="l32.11"> typedef struct {</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-  int32_t    mozField;</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineminus">-  int32_t    multiLine;</span>
<a href="#l32.14"></a><span id="l32.14" class="difflineminus">-  ULONG    mapiTag;</span>
<a href="#l32.15"></a><span id="l32.15" class="difflineplus">+  int32_t mozField;</span>
<a href="#l32.16"></a><span id="l32.16" class="difflineplus">+  int32_t multiLine;</span>
<a href="#l32.17"></a><span id="l32.17" class="difflineplus">+  ULONG mapiTag;</span>
<a href="#l32.18"></a><span id="l32.18"> } MAPIFields;</span>
<a href="#l32.19"></a><span id="l32.19"> </span>
<a href="#l32.20"></a><span id="l32.20"> /*</span>
<a href="#l32.21"></a><span id="l32.21">   Fields in MAPI, not in Mozilla</span>
<a href="#l32.22"></a><span id="l32.22">   PR_OFFICE_LOCATION</span>
<a href="#l32.23"></a><span id="l32.23" class="difflineminus">-  FIX - PR_BIRTHDAY - stored as PT_SYSTIME - FIX to extract for moz address book birthday</span>
<a href="#l32.24"></a><span id="l32.24" class="difflineminus">-  PR_DISPLAY_NAME_PREFIX - Mr., Mrs. Dr., etc.</span>
<a href="#l32.25"></a><span id="l32.25" class="difflineminus">-  PR_SPOUSE_NAME</span>
<a href="#l32.26"></a><span id="l32.26" class="difflineminus">-  PR_GENDER - integer, not text</span>
<a href="#l32.27"></a><span id="l32.27" class="difflineminus">-  FIX - PR_CONTACT_EMAIL_ADDRESSES - multiuline strings for email addresses, needs</span>
<a href="#l32.28"></a><span id="l32.28" class="difflineminus">-    parsing to get secondary email address for mozilla</span>
<a href="#l32.29"></a><span id="l32.29" class="difflineplus">+  FIX - PR_BIRTHDAY - stored as PT_SYSTIME - FIX to extract for moz address book</span>
<a href="#l32.30"></a><span id="l32.30" class="difflineplus">+  birthday PR_DISPLAY_NAME_PREFIX - Mr., Mrs. Dr., etc. PR_SPOUSE_NAME PR_GENDER</span>
<a href="#l32.31"></a><span id="l32.31" class="difflineplus">+  - integer, not text FIX - PR_CONTACT_EMAIL_ADDRESSES - multiuline strings for</span>
<a href="#l32.32"></a><span id="l32.32" class="difflineplus">+  email addresses, needs parsing to get secondary email address for mozilla</span>
<a href="#l32.33"></a><span id="l32.33"> */</span>
<a href="#l32.34"></a><span id="l32.34"> </span>
<a href="#l32.35"></a><span id="l32.35" class="difflineminus">-#define kIsMultiLine  -2</span>
<a href="#l32.36"></a><span id="l32.36" class="difflineminus">-#define  kNoMultiLine  -1</span>
<a href="#l32.37"></a><span id="l32.37" class="difflineplus">+#define kIsMultiLine -2</span>
<a href="#l32.38"></a><span id="l32.38" class="difflineplus">+#define kNoMultiLine -1</span>
<a href="#l32.39"></a><span id="l32.39"> </span>
<a href="#l32.40"></a><span id="l32.40" class="difflineminus">-static MAPIFields  gMapiFields[] = {</span>
<a href="#l32.41"></a><span id="l32.41" class="difflineminus">-  { 35, kIsMultiLine, PR_BODY},</span>
<a href="#l32.42"></a><span id="l32.42" class="difflineminus">-  { 6, kNoMultiLine, PR_BUSINESS_TELEPHONE_NUMBER},</span>
<a href="#l32.43"></a><span id="l32.43" class="difflineminus">-  { 7, kNoMultiLine, PR_HOME_TELEPHONE_NUMBER},</span>
<a href="#l32.44"></a><span id="l32.44" class="difflineminus">-  { 25, kNoMultiLine, PR_COMPANY_NAME},</span>
<a href="#l32.45"></a><span id="l32.45" class="difflineminus">-  { 23, kNoMultiLine, PR_TITLE},</span>
<a href="#l32.46"></a><span id="l32.46" class="difflineminus">-  { 10, kNoMultiLine, PR_CELLULAR_TELEPHONE_NUMBER},</span>
<a href="#l32.47"></a><span id="l32.47" class="difflineminus">-  { 9, kNoMultiLine, PR_PAGER_TELEPHONE_NUMBER},</span>
<a href="#l32.48"></a><span id="l32.48" class="difflineminus">-  { 8, kNoMultiLine, PR_BUSINESS_FAX_NUMBER},</span>
<a href="#l32.49"></a><span id="l32.49" class="difflineminus">-  { 8, kNoMultiLine, PR_HOME_FAX_NUMBER},</span>
<a href="#l32.50"></a><span id="l32.50" class="difflineminus">-  { 22, kNoMultiLine, PR_COUNTRY},</span>
<a href="#l32.51"></a><span id="l32.51" class="difflineminus">-  { 19, kNoMultiLine, PR_LOCALITY},</span>
<a href="#l32.52"></a><span id="l32.52" class="difflineminus">-  { 20, kNoMultiLine, PR_STATE_OR_PROVINCE},</span>
<a href="#l32.53"></a><span id="l32.53" class="difflineminus">-  { 17, 18, PR_STREET_ADDRESS},</span>
<a href="#l32.54"></a><span id="l32.54" class="difflineminus">-  { 21, kNoMultiLine, PR_POSTAL_CODE},</span>
<a href="#l32.55"></a><span id="l32.55" class="difflineminus">-  { 27, kNoMultiLine, PR_PERSONAL_HOME_PAGE},</span>
<a href="#l32.56"></a><span id="l32.56" class="difflineminus">-  { 26, kNoMultiLine, PR_BUSINESS_HOME_PAGE},</span>
<a href="#l32.57"></a><span id="l32.57" class="difflineminus">-  { 13, kNoMultiLine, PR_HOME_ADDRESS_CITY},</span>
<a href="#l32.58"></a><span id="l32.58" class="difflineminus">-  { 16, kNoMultiLine, PR_HOME_ADDRESS_COUNTRY},</span>
<a href="#l32.59"></a><span id="l32.59" class="difflineminus">-  { 15, kNoMultiLine, PR_HOME_ADDRESS_POSTAL_CODE},</span>
<a href="#l32.60"></a><span id="l32.60" class="difflineminus">-  { 14, kNoMultiLine, PR_HOME_ADDRESS_STATE_OR_PROVINCE},</span>
<a href="#l32.61"></a><span id="l32.61" class="difflineminus">-  { 11, 12, PR_HOME_ADDRESS_STREET},</span>
<a href="#l32.62"></a><span id="l32.62" class="difflineminus">-  { 24, kNoMultiLine, PR_DEPARTMENT_NAME}</span>
<a href="#l32.63"></a><span id="l32.63" class="difflineminus">-};</span>
<a href="#l32.64"></a><span id="l32.64" class="difflineplus">+static MAPIFields gMapiFields[] = {</span>
<a href="#l32.65"></a><span id="l32.65" class="difflineplus">+    {35, kIsMultiLine, PR_BODY},</span>
<a href="#l32.66"></a><span id="l32.66" class="difflineplus">+    {6, kNoMultiLine, PR_BUSINESS_TELEPHONE_NUMBER},</span>
<a href="#l32.67"></a><span id="l32.67" class="difflineplus">+    {7, kNoMultiLine, PR_HOME_TELEPHONE_NUMBER},</span>
<a href="#l32.68"></a><span id="l32.68" class="difflineplus">+    {25, kNoMultiLine, PR_COMPANY_NAME},</span>
<a href="#l32.69"></a><span id="l32.69" class="difflineplus">+    {23, kNoMultiLine, PR_TITLE},</span>
<a href="#l32.70"></a><span id="l32.70" class="difflineplus">+    {10, kNoMultiLine, PR_CELLULAR_TELEPHONE_NUMBER},</span>
<a href="#l32.71"></a><span id="l32.71" class="difflineplus">+    {9, kNoMultiLine, PR_PAGER_TELEPHONE_NUMBER},</span>
<a href="#l32.72"></a><span id="l32.72" class="difflineplus">+    {8, kNoMultiLine, PR_BUSINESS_FAX_NUMBER},</span>
<a href="#l32.73"></a><span id="l32.73" class="difflineplus">+    {8, kNoMultiLine, PR_HOME_FAX_NUMBER},</span>
<a href="#l32.74"></a><span id="l32.74" class="difflineplus">+    {22, kNoMultiLine, PR_COUNTRY},</span>
<a href="#l32.75"></a><span id="l32.75" class="difflineplus">+    {19, kNoMultiLine, PR_LOCALITY},</span>
<a href="#l32.76"></a><span id="l32.76" class="difflineplus">+    {20, kNoMultiLine, PR_STATE_OR_PROVINCE},</span>
<a href="#l32.77"></a><span id="l32.77" class="difflineplus">+    {17, 18, PR_STREET_ADDRESS},</span>
<a href="#l32.78"></a><span id="l32.78" class="difflineplus">+    {21, kNoMultiLine, PR_POSTAL_CODE},</span>
<a href="#l32.79"></a><span id="l32.79" class="difflineplus">+    {27, kNoMultiLine, PR_PERSONAL_HOME_PAGE},</span>
<a href="#l32.80"></a><span id="l32.80" class="difflineplus">+    {26, kNoMultiLine, PR_BUSINESS_HOME_PAGE},</span>
<a href="#l32.81"></a><span id="l32.81" class="difflineplus">+    {13, kNoMultiLine, PR_HOME_ADDRESS_CITY},</span>
<a href="#l32.82"></a><span id="l32.82" class="difflineplus">+    {16, kNoMultiLine, PR_HOME_ADDRESS_COUNTRY},</span>
<a href="#l32.83"></a><span id="l32.83" class="difflineplus">+    {15, kNoMultiLine, PR_HOME_ADDRESS_POSTAL_CODE},</span>
<a href="#l32.84"></a><span id="l32.84" class="difflineplus">+    {14, kNoMultiLine, PR_HOME_ADDRESS_STATE_OR_PROVINCE},</span>
<a href="#l32.85"></a><span id="l32.85" class="difflineplus">+    {11, 12, PR_HOME_ADDRESS_STREET},</span>
<a href="#l32.86"></a><span id="l32.86" class="difflineplus">+    {24, kNoMultiLine, PR_DEPARTMENT_NAME}};</span>
<a href="#l32.87"></a><span id="l32.87"> /* ---------------------------------------------------- */</span>
<a href="#l32.88"></a><span id="l32.88"> </span>
<a href="#l32.89"></a><span id="l32.89" class="difflineminus">-</span>
<a href="#l32.90"></a><span id="l32.90" class="difflineminus">-#define  kCopyBufferSize    (16 * 1024)</span>
<a href="#l32.91"></a><span id="l32.91" class="difflineplus">+#define kCopyBufferSize (16 * 1024)</span>
<a href="#l32.92"></a><span id="l32.92"> </span>
<a href="#l32.93"></a><span id="l32.93"> // The email address in Outlook Contacts doesn't have a named</span>
<a href="#l32.94"></a><span id="l32.94"> // property,  we need to use this mapi name ID to access the email</span>
<a href="#l32.95"></a><span id="l32.95"> // The MAPINAMEID for email address has ulKind=MNID_ID</span>
<a href="#l32.96"></a><span id="l32.96"> // Outlook stores each email address in two IDs,  32899/32900 for Email1</span>
<a href="#l32.97"></a><span id="l32.97"> // 32915/32916 for Email2, 32931/32932 for Email3</span>
<a href="#l32.98"></a><span id="l32.98"> // Current we use OUTLOOK_EMAIL1_MAPI_ID1 for primary email</span>
<a href="#l32.99"></a><span id="l32.99"> // OUTLOOK_EMAIL2_MAPI_ID1 for secondary email</span>
<a href="#l32.100"></a><span id="l32.100" class="difflineminus">-#define  OUTLOOK_EMAIL1_MAPI_ID1 32899</span>
<a href="#l32.101"></a><span id="l32.101" class="difflineminus">-#define  OUTLOOK_EMAIL1_MAPI_ID2 32900</span>
<a href="#l32.102"></a><span id="l32.102" class="difflineminus">-#define  OUTLOOK_EMAIL2_MAPI_ID1 32915</span>
<a href="#l32.103"></a><span id="l32.103" class="difflineminus">-#define  OUTLOOK_EMAIL2_MAPI_ID2 32916</span>
<a href="#l32.104"></a><span id="l32.104" class="difflineminus">-#define  OUTLOOK_EMAIL3_MAPI_ID1 32931</span>
<a href="#l32.105"></a><span id="l32.105" class="difflineminus">-#define  OUTLOOK_EMAIL3_MAPI_ID2 32932</span>
<a href="#l32.106"></a><span id="l32.106" class="difflineplus">+#define OUTLOOK_EMAIL1_MAPI_ID1 32899</span>
<a href="#l32.107"></a><span id="l32.107" class="difflineplus">+#define OUTLOOK_EMAIL1_MAPI_ID2 32900</span>
<a href="#l32.108"></a><span id="l32.108" class="difflineplus">+#define OUTLOOK_EMAIL2_MAPI_ID1 32915</span>
<a href="#l32.109"></a><span id="l32.109" class="difflineplus">+#define OUTLOOK_EMAIL2_MAPI_ID2 32916</span>
<a href="#l32.110"></a><span id="l32.110" class="difflineplus">+#define OUTLOOK_EMAIL3_MAPI_ID1 32931</span>
<a href="#l32.111"></a><span id="l32.111" class="difflineplus">+#define OUTLOOK_EMAIL3_MAPI_ID2 32932</span>
<a href="#l32.112"></a><span id="l32.112"> </span>
<a href="#l32.113"></a><span id="l32.113" class="difflineminus">-nsOutlookMail::nsOutlookMail()</span>
<a href="#l32.114"></a><span id="l32.114" class="difflineminus">-{</span>
<a href="#l32.115"></a><span id="l32.115" class="difflineplus">+nsOutlookMail::nsOutlookMail() {</span>
<a href="#l32.116"></a><span id="l32.116">   m_gotAddresses = false;</span>
<a href="#l32.117"></a><span id="l32.117">   m_gotFolders = false;</span>
<a href="#l32.118"></a><span id="l32.118">   m_haveMapi = CMapiApi::LoadMapi();</span>
<a href="#l32.119"></a><span id="l32.119">   m_lpMdb = NULL;</span>
<a href="#l32.120"></a><span id="l32.120"> }</span>
<a href="#l32.121"></a><span id="l32.121"> </span>
<a href="#l32.122"></a><span id="l32.122" class="difflineminus">-nsOutlookMail::~nsOutlookMail()</span>
<a href="#l32.123"></a><span id="l32.123" class="difflineminus">-{</span>
<a href="#l32.124"></a><span id="l32.124" class="difflineminus">-//  EmptyAttachments();</span>
<a href="#l32.125"></a><span id="l32.125" class="difflineplus">+nsOutlookMail::~nsOutlookMail() {</span>
<a href="#l32.126"></a><span id="l32.126" class="difflineplus">+  //  EmptyAttachments();</span>
<a href="#l32.127"></a><span id="l32.127"> }</span>
<a href="#l32.128"></a><span id="l32.128"> </span>
<a href="#l32.129"></a><span id="l32.129" class="difflineminus">-nsresult nsOutlookMail::GetMailFolders(nsIArray **pArray)</span>
<a href="#l32.130"></a><span id="l32.130" class="difflineminus">-{</span>
<a href="#l32.131"></a><span id="l32.131" class="difflineplus">+nsresult nsOutlookMail::GetMailFolders(nsIArray **pArray) {</span>
<a href="#l32.132"></a><span id="l32.132">   if (!m_haveMapi) {</span>
<a href="#l32.133"></a><span id="l32.133">     IMPORT_LOG0(&quot;GetMailFolders called before Mapi is initialized\n&quot;);</span>
<a href="#l32.134"></a><span id="l32.134">     return NS_ERROR_FAILURE;</span>
<a href="#l32.135"></a><span id="l32.135">   }</span>
<a href="#l32.136"></a><span id="l32.136"> </span>
<a href="#l32.137"></a><span id="l32.137">   nsresult rv;</span>
<a href="#l32.138"></a><span id="l32.138">   nsCOMPtr&lt;nsIMutableArray&gt; array(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l32.139"></a><span id="l32.139">   if (NS_FAILED(rv)) {</span>
<a href="#l32.140"></a><span id="l32.140" class="difflineminus">-    IMPORT_LOG0(&quot;FAILED to allocate the nsIMutableArray for the mail folder list\n&quot;);</span>
<a href="#l32.141"></a><span id="l32.141" class="difflineplus">+    IMPORT_LOG0(</span>
<a href="#l32.142"></a><span id="l32.142" class="difflineplus">+        &quot;FAILED to allocate the nsIMutableArray for the mail folder list\n&quot;);</span>
<a href="#l32.143"></a><span id="l32.143">     return rv;</span>
<a href="#l32.144"></a><span id="l32.144">   }</span>
<a href="#l32.145"></a><span id="l32.145"> </span>
<a href="#l32.146"></a><span id="l32.146" class="difflineminus">-  nsCOMPtr&lt;nsIImportService&gt; impSvc(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l32.147"></a><span id="l32.147" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l32.148"></a><span id="l32.148" class="difflineminus">-    return rv;</span>
<a href="#l32.149"></a><span id="l32.149" class="difflineplus">+  nsCOMPtr&lt;nsIImportService&gt; impSvc(</span>
<a href="#l32.150"></a><span id="l32.150" class="difflineplus">+      do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l32.151"></a><span id="l32.151" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l32.152"></a><span id="l32.152"> </span>
<a href="#l32.153"></a><span id="l32.153">   m_gotFolders = true;</span>
<a href="#l32.154"></a><span id="l32.154"> </span>
<a href="#l32.155"></a><span id="l32.155">   m_folderList.ClearAll();</span>
<a href="#l32.156"></a><span id="l32.156"> </span>
<a href="#l32.157"></a><span id="l32.157">   m_mapi.Initialize();</span>
<a href="#l32.158"></a><span id="l32.158">   m_mapi.LogOn();</span>
<a href="#l32.159"></a><span id="l32.159"> </span>
<a href="#l32.160"></a><span id="l32.160" class="difflineminus">-  if (m_storeList.GetSize() == 0)</span>
<a href="#l32.161"></a><span id="l32.161" class="difflineminus">-    m_mapi.IterateStores(m_storeList);</span>
<a href="#l32.162"></a><span id="l32.162" class="difflineplus">+  if (m_storeList.GetSize() == 0) m_mapi.IterateStores(m_storeList);</span>
<a href="#l32.163"></a><span id="l32.163"> </span>
<a href="#l32.164"></a><span id="l32.164">   int i = 0;</span>
<a href="#l32.165"></a><span id="l32.165">   CMapiFolder *pFolder;</span>
<a href="#l32.166"></a><span id="l32.166">   if (m_storeList.GetSize() &gt; 1) {</span>
<a href="#l32.167"></a><span id="l32.167">     while ((pFolder = m_storeList.GetItem(i))) {</span>
<a href="#l32.168"></a><span id="l32.168">       CMapiFolder *pItem = new CMapiFolder(pFolder);</span>
<a href="#l32.169"></a><span id="l32.169">       pItem-&gt;SetDepth(1);</span>
<a href="#l32.170"></a><span id="l32.170">       m_folderList.AddItem(pItem);</span>
<a href="#l32.171"></a><span id="l32.171" class="difflineminus">-      if (!m_mapi.GetStoreFolders(pItem-&gt;GetCBEntryID(), pItem-&gt;GetEntryID(), m_folderList, 2)) {</span>
<a href="#l32.172"></a><span id="l32.172" class="difflineplus">+      if (!m_mapi.GetStoreFolders(pItem-&gt;GetCBEntryID(), pItem-&gt;GetEntryID(),</span>
<a href="#l32.173"></a><span id="l32.173" class="difflineplus">+                                  m_folderList, 2)) {</span>
<a href="#l32.174"></a><span id="l32.174">         IMPORT_LOG1(&quot;GetStoreFolders for index %d failed.\n&quot;, i);</span>
<a href="#l32.175"></a><span id="l32.175">       }</span>
<a href="#l32.176"></a><span id="l32.176">       i++;</span>
<a href="#l32.177"></a><span id="l32.177">     }</span>
<a href="#l32.178"></a><span id="l32.178" class="difflineminus">-  }</span>
<a href="#l32.179"></a><span id="l32.179" class="difflineminus">-  else {</span>
<a href="#l32.180"></a><span id="l32.180" class="difflineplus">+  } else {</span>
<a href="#l32.181"></a><span id="l32.181">     if ((pFolder = m_storeList.GetItem(i))) {</span>
<a href="#l32.182"></a><span id="l32.182" class="difflineminus">-      if (!m_mapi.GetStoreFolders(pFolder-&gt;GetCBEntryID(), pFolder-&gt;GetEntryID(), m_folderList, 1)) {</span>
<a href="#l32.183"></a><span id="l32.183" class="difflineplus">+      if (!m_mapi.GetStoreFolders(pFolder-&gt;GetCBEntryID(),</span>
<a href="#l32.184"></a><span id="l32.184" class="difflineplus">+                                  pFolder-&gt;GetEntryID(), m_folderList, 1)) {</span>
<a href="#l32.185"></a><span id="l32.185">         IMPORT_LOG1(&quot;GetStoreFolders for index %d failed.\n&quot;, i);</span>
<a href="#l32.186"></a><span id="l32.186">       }</span>
<a href="#l32.187"></a><span id="l32.187">     }</span>
<a href="#l32.188"></a><span id="l32.188">   }</span>
<a href="#l32.189"></a><span id="l32.189"> </span>
<a href="#l32.190"></a><span id="l32.190">   // Create the mailbox descriptors for the list of folders</span>
<a href="#l32.191"></a><span id="l32.191">   nsCOMPtr&lt;nsIImportMailboxDescriptor&gt; pID;</span>
<a href="#l32.192"></a><span id="l32.192" class="difflineminus">-  nsString            name;</span>
<a href="#l32.193"></a><span id="l32.193" class="difflineminus">-  nsString            uniName;</span>
<a href="#l32.194"></a><span id="l32.194" class="difflineplus">+  nsString name;</span>
<a href="#l32.195"></a><span id="l32.195" class="difflineplus">+  nsString uniName;</span>
<a href="#l32.196"></a><span id="l32.196"> </span>
<a href="#l32.197"></a><span id="l32.197">   for (i = 0; i &lt; m_folderList.GetSize(); i++) {</span>
<a href="#l32.198"></a><span id="l32.198">     pFolder = m_folderList.GetItem(i);</span>
<a href="#l32.199"></a><span id="l32.199">     rv = impSvc-&gt;CreateNewMailboxDescriptor(getter_AddRefs(pID));</span>
<a href="#l32.200"></a><span id="l32.200">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l32.201"></a><span id="l32.201">       pID-&gt;SetDepth(pFolder-&gt;GetDepth());</span>
<a href="#l32.202"></a><span id="l32.202">       pID-&gt;SetIdentifier(i);</span>
<a href="#l32.203"></a><span id="l32.203"> </span>
<a href="#l32.204"></a><span id="l32.204" class="difflineat">@@ -174,96 +168,94 @@ nsresult nsOutlookMail::GetMailFolders(n</span>
<a href="#l32.205"></a><span id="l32.205">       nsCOMPtr&lt;nsISupports&gt; pInterface(do_QueryInterface(pID));</span>
<a href="#l32.206"></a><span id="l32.206">       array-&gt;AppendElement(pInterface);</span>
<a href="#l32.207"></a><span id="l32.207">     }</span>
<a href="#l32.208"></a><span id="l32.208">   }</span>
<a href="#l32.209"></a><span id="l32.209">   array.forget(pArray);</span>
<a href="#l32.210"></a><span id="l32.210">   return NS_OK;</span>
<a href="#l32.211"></a><span id="l32.211"> }</span>
<a href="#l32.212"></a><span id="l32.212"> </span>
<a href="#l32.213"></a><span id="l32.213" class="difflineminus">-bool nsOutlookMail::IsAddressBookNameUnique(nsString&amp; name, nsString&amp; list)</span>
<a href="#l32.214"></a><span id="l32.214" class="difflineminus">-{</span>
<a href="#l32.215"></a><span id="l32.215" class="difflineminus">-  nsString    usedName;</span>
<a href="#l32.216"></a><span id="l32.216" class="difflineplus">+bool nsOutlookMail::IsAddressBookNameUnique(nsString &amp;name, nsString &amp;list) {</span>
<a href="#l32.217"></a><span id="l32.217" class="difflineplus">+  nsString usedName;</span>
<a href="#l32.218"></a><span id="l32.218">   usedName.Append('[');</span>
<a href="#l32.219"></a><span id="l32.219">   usedName.Append(name);</span>
<a href="#l32.220"></a><span id="l32.220">   usedName.AppendLiteral(&quot;],&quot;);</span>
<a href="#l32.221"></a><span id="l32.221"> </span>
<a href="#l32.222"></a><span id="l32.222">   return list.Find(usedName) == -1;</span>
<a href="#l32.223"></a><span id="l32.223"> }</span>
<a href="#l32.224"></a><span id="l32.224"> </span>
<a href="#l32.225"></a><span id="l32.225" class="difflineminus">-void nsOutlookMail::MakeAddressBookNameUnique(nsString&amp; name, nsString&amp; list)</span>
<a href="#l32.226"></a><span id="l32.226" class="difflineminus">-{</span>
<a href="#l32.227"></a><span id="l32.227" class="difflineminus">-  nsString    newName;</span>
<a href="#l32.228"></a><span id="l32.228" class="difflineminus">-  int        idx = 1;</span>
<a href="#l32.229"></a><span id="l32.229" class="difflineplus">+void nsOutlookMail::MakeAddressBookNameUnique(nsString &amp;name, nsString &amp;list) {</span>
<a href="#l32.230"></a><span id="l32.230" class="difflineplus">+  nsString newName;</span>
<a href="#l32.231"></a><span id="l32.231" class="difflineplus">+  int idx = 1;</span>
<a href="#l32.232"></a><span id="l32.232"> </span>
<a href="#l32.233"></a><span id="l32.233">   newName = name;</span>
<a href="#l32.234"></a><span id="l32.234">   while (!IsAddressBookNameUnique(newName, list)) {</span>
<a href="#l32.235"></a><span id="l32.235">     newName = name;</span>
<a href="#l32.236"></a><span id="l32.236">     newName.Append(char16_t(' '));</span>
<a href="#l32.237"></a><span id="l32.237" class="difflineminus">-    newName.AppendInt((int32_t) idx);</span>
<a href="#l32.238"></a><span id="l32.238" class="difflineplus">+    newName.AppendInt((int32_t)idx);</span>
<a href="#l32.239"></a><span id="l32.239">     idx++;</span>
<a href="#l32.240"></a><span id="l32.240">   }</span>
<a href="#l32.241"></a><span id="l32.241"> </span>
<a href="#l32.242"></a><span id="l32.242">   name = newName;</span>
<a href="#l32.243"></a><span id="l32.243">   list.Append('[');</span>
<a href="#l32.244"></a><span id="l32.244">   list.Append(name);</span>
<a href="#l32.245"></a><span id="l32.245">   list.AppendLiteral(&quot;],&quot;);</span>
<a href="#l32.246"></a><span id="l32.246"> }</span>
<a href="#l32.247"></a><span id="l32.247"> </span>
<a href="#l32.248"></a><span id="l32.248" class="difflineminus">-nsresult nsOutlookMail::GetAddressBooks(nsIArray **pArray)</span>
<a href="#l32.249"></a><span id="l32.249" class="difflineminus">-{</span>
<a href="#l32.250"></a><span id="l32.250" class="difflineplus">+nsresult nsOutlookMail::GetAddressBooks(nsIArray **pArray) {</span>
<a href="#l32.251"></a><span id="l32.251">   if (!m_haveMapi) {</span>
<a href="#l32.252"></a><span id="l32.252">     IMPORT_LOG0(&quot;GetAddressBooks called before Mapi is initialized\n&quot;);</span>
<a href="#l32.253"></a><span id="l32.253">     return NS_ERROR_FAILURE;</span>
<a href="#l32.254"></a><span id="l32.254">   }</span>
<a href="#l32.255"></a><span id="l32.255"> </span>
<a href="#l32.256"></a><span id="l32.256">   nsresult rv;</span>
<a href="#l32.257"></a><span id="l32.257">   nsCOMPtr&lt;nsIMutableArray&gt; array(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l32.258"></a><span id="l32.258">   if (NS_FAILED(rv)) {</span>
<a href="#l32.259"></a><span id="l32.259" class="difflineminus">-    IMPORT_LOG0(&quot;FAILED to allocate the nsIMutableArray for the address book list\n&quot;);</span>
<a href="#l32.260"></a><span id="l32.260" class="difflineplus">+    IMPORT_LOG0(</span>
<a href="#l32.261"></a><span id="l32.261" class="difflineplus">+        &quot;FAILED to allocate the nsIMutableArray for the address book list\n&quot;);</span>
<a href="#l32.262"></a><span id="l32.262">     return rv;</span>
<a href="#l32.263"></a><span id="l32.263">   }</span>
<a href="#l32.264"></a><span id="l32.264"> </span>
<a href="#l32.265"></a><span id="l32.265" class="difflineminus">-  nsCOMPtr&lt;nsIImportService&gt; impSvc(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l32.266"></a><span id="l32.266" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l32.267"></a><span id="l32.267" class="difflineminus">-    return rv;</span>
<a href="#l32.268"></a><span id="l32.268" class="difflineplus">+  nsCOMPtr&lt;nsIImportService&gt; impSvc(</span>
<a href="#l32.269"></a><span id="l32.269" class="difflineplus">+      do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l32.270"></a><span id="l32.270" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l32.271"></a><span id="l32.271"> </span>
<a href="#l32.272"></a><span id="l32.272">   m_gotAddresses = true;</span>
<a href="#l32.273"></a><span id="l32.273"> </span>
<a href="#l32.274"></a><span id="l32.274">   m_addressList.ClearAll();</span>
<a href="#l32.275"></a><span id="l32.275">   m_mapi.Initialize();</span>
<a href="#l32.276"></a><span id="l32.276">   m_mapi.LogOn();</span>
<a href="#l32.277"></a><span id="l32.277" class="difflineminus">-  if (m_storeList.GetSize() == 0)</span>
<a href="#l32.278"></a><span id="l32.278" class="difflineminus">-    m_mapi.IterateStores(m_storeList);</span>
<a href="#l32.279"></a><span id="l32.279" class="difflineplus">+  if (m_storeList.GetSize() == 0) m_mapi.IterateStores(m_storeList);</span>
<a href="#l32.280"></a><span id="l32.280"> </span>
<a href="#l32.281"></a><span id="l32.281">   int i = 0;</span>
<a href="#l32.282"></a><span id="l32.282">   CMapiFolder *pFolder;</span>
<a href="#l32.283"></a><span id="l32.283">   if (m_storeList.GetSize() &gt; 1) {</span>
<a href="#l32.284"></a><span id="l32.284">     while ((pFolder = m_storeList.GetItem(i))) {</span>
<a href="#l32.285"></a><span id="l32.285">       CMapiFolder *pItem = new CMapiFolder(pFolder);</span>
<a href="#l32.286"></a><span id="l32.286">       pItem-&gt;SetDepth(1);</span>
<a href="#l32.287"></a><span id="l32.287">       m_addressList.AddItem(pItem);</span>
<a href="#l32.288"></a><span id="l32.288" class="difflineminus">-      if (!m_mapi.GetStoreAddressFolders(pItem-&gt;GetCBEntryID(), pItem-&gt;GetEntryID(), m_addressList)) {</span>
<a href="#l32.289"></a><span id="l32.289" class="difflineplus">+      if (!m_mapi.GetStoreAddressFolders(pItem-&gt;GetCBEntryID(),</span>
<a href="#l32.290"></a><span id="l32.290" class="difflineplus">+                                         pItem-&gt;GetEntryID(), m_addressList)) {</span>
<a href="#l32.291"></a><span id="l32.291">         IMPORT_LOG1(&quot;GetStoreAddressFolders for index %d failed.\n&quot;, i);</span>
<a href="#l32.292"></a><span id="l32.292">       }</span>
<a href="#l32.293"></a><span id="l32.293">       i++;</span>
<a href="#l32.294"></a><span id="l32.294">     }</span>
<a href="#l32.295"></a><span id="l32.295" class="difflineminus">-  }</span>
<a href="#l32.296"></a><span id="l32.296" class="difflineminus">-  else {</span>
<a href="#l32.297"></a><span id="l32.297" class="difflineplus">+  } else {</span>
<a href="#l32.298"></a><span id="l32.298">     if ((pFolder = m_storeList.GetItem(i))) {</span>
<a href="#l32.299"></a><span id="l32.299" class="difflineminus">-      if (!m_mapi.GetStoreAddressFolders(pFolder-&gt;GetCBEntryID(), pFolder-&gt;GetEntryID(), m_addressList)) {</span>
<a href="#l32.300"></a><span id="l32.300" class="difflineplus">+      if (!m_mapi.GetStoreAddressFolders(</span>
<a href="#l32.301"></a><span id="l32.301" class="difflineplus">+              pFolder-&gt;GetCBEntryID(), pFolder-&gt;GetEntryID(), m_addressList)) {</span>
<a href="#l32.302"></a><span id="l32.302">         IMPORT_LOG1(&quot;GetStoreFolders for index %d failed.\n&quot;, i);</span>
<a href="#l32.303"></a><span id="l32.303">       }</span>
<a href="#l32.304"></a><span id="l32.304">     }</span>
<a href="#l32.305"></a><span id="l32.305">   }</span>
<a href="#l32.306"></a><span id="l32.306"> </span>
<a href="#l32.307"></a><span id="l32.307">   // Create the mailbox descriptors for the list of folders</span>
<a href="#l32.308"></a><span id="l32.308">   nsCOMPtr&lt;nsIImportABDescriptor&gt; pID;</span>
<a href="#l32.309"></a><span id="l32.309" class="difflineminus">-  nsString            name;</span>
<a href="#l32.310"></a><span id="l32.310" class="difflineminus">-  nsString            list;</span>
<a href="#l32.311"></a><span id="l32.311" class="difflineplus">+  nsString name;</span>
<a href="#l32.312"></a><span id="l32.312" class="difflineplus">+  nsString list;</span>
<a href="#l32.313"></a><span id="l32.313"> </span>
<a href="#l32.314"></a><span id="l32.314">   for (i = 0; i &lt; m_addressList.GetSize(); i++) {</span>
<a href="#l32.315"></a><span id="l32.315">     pFolder = m_addressList.GetItem(i);</span>
<a href="#l32.316"></a><span id="l32.316">     if (!pFolder-&gt;IsStore()) {</span>
<a href="#l32.317"></a><span id="l32.317">       rv = impSvc-&gt;CreateNewABDescriptor(getter_AddRefs(pID));</span>
<a href="#l32.318"></a><span id="l32.318">       if (NS_SUCCEEDED(rv)) {</span>
<a href="#l32.319"></a><span id="l32.319">         pID-&gt;SetIdentifier(i);</span>
<a href="#l32.320"></a><span id="l32.320">         pFolder-&gt;GetDisplayName(name);</span>
<a href="#l32.321"></a><span id="l32.321" class="difflineat">@@ -274,506 +266,484 @@ nsresult nsOutlookMail::GetAddressBooks(</span>
<a href="#l32.322"></a><span id="l32.322">         array-&gt;AppendElement(pInterface);</span>
<a href="#l32.323"></a><span id="l32.323">       }</span>
<a href="#l32.324"></a><span id="l32.324">     }</span>
<a href="#l32.325"></a><span id="l32.325">   }</span>
<a href="#l32.326"></a><span id="l32.326">   array.forget(pArray);</span>
<a href="#l32.327"></a><span id="l32.327">   return NS_OK;</span>
<a href="#l32.328"></a><span id="l32.328"> }</span>
<a href="#l32.329"></a><span id="l32.329"> </span>
<a href="#l32.330"></a><span id="l32.330" class="difflineminus">-void nsOutlookMail::OpenMessageStore(CMapiFolder *pNextFolder)</span>
<a href="#l32.331"></a><span id="l32.331" class="difflineminus">-{</span>
<a href="#l32.332"></a><span id="l32.332" class="difflineplus">+void nsOutlookMail::OpenMessageStore(CMapiFolder *pNextFolder) {</span>
<a href="#l32.333"></a><span id="l32.333">   // Open the store specified</span>
<a href="#l32.334"></a><span id="l32.334">   if (pNextFolder-&gt;IsStore()) {</span>
<a href="#l32.335"></a><span id="l32.335" class="difflineminus">-    if (!m_mapi.OpenStore(pNextFolder-&gt;GetCBEntryID(), pNextFolder-&gt;GetEntryID(), &amp;m_lpMdb)) {</span>
<a href="#l32.336"></a><span id="l32.336" class="difflineplus">+    if (!m_mapi.OpenStore(pNextFolder-&gt;GetCBEntryID(),</span>
<a href="#l32.337"></a><span id="l32.337" class="difflineplus">+                          pNextFolder-&gt;GetEntryID(), &amp;m_lpMdb)) {</span>
<a href="#l32.338"></a><span id="l32.338">       m_lpMdb = NULL;</span>
<a href="#l32.339"></a><span id="l32.339">       IMPORT_LOG0(&quot;CMapiApi::OpenStore failed\n&quot;);</span>
<a href="#l32.340"></a><span id="l32.340">     }</span>
<a href="#l32.341"></a><span id="l32.341"> </span>
<a href="#l32.342"></a><span id="l32.342">     return;</span>
<a href="#l32.343"></a><span id="l32.343">   }</span>
<a href="#l32.344"></a><span id="l32.344"> </span>
<a href="#l32.345"></a><span id="l32.345">   // Check to see if we should open the one and only store</span>
<a href="#l32.346"></a><span id="l32.346">   if (!m_lpMdb) {</span>
<a href="#l32.347"></a><span id="l32.347">     if (m_storeList.GetSize() == 1) {</span>
<a href="#l32.348"></a><span id="l32.348" class="difflineminus">-      CMapiFolder * pFolder = m_storeList.GetItem(0);</span>
<a href="#l32.349"></a><span id="l32.349" class="difflineplus">+      CMapiFolder *pFolder = m_storeList.GetItem(0);</span>
<a href="#l32.350"></a><span id="l32.350">       if (pFolder) {</span>
<a href="#l32.351"></a><span id="l32.351" class="difflineminus">-        if (!m_mapi.OpenStore(pFolder-&gt;GetCBEntryID(), pFolder-&gt;GetEntryID(), &amp;m_lpMdb)) {</span>
<a href="#l32.352"></a><span id="l32.352" class="difflineplus">+        if (!m_mapi.OpenStore(pFolder-&gt;GetCBEntryID(), pFolder-&gt;GetEntryID(),</span>
<a href="#l32.353"></a><span id="l32.353" class="difflineplus">+                              &amp;m_lpMdb)) {</span>
<a href="#l32.354"></a><span id="l32.354">           m_lpMdb = NULL;</span>
<a href="#l32.355"></a><span id="l32.355">           IMPORT_LOG0(&quot;CMapiApi::OpenStore failed\n&quot;);</span>
<a href="#l32.356"></a><span id="l32.356">         }</span>
<a href="#l32.357"></a><span id="l32.357" class="difflineminus">-      }</span>
<a href="#l32.358"></a><span id="l32.358" class="difflineminus">-      else {</span>
<a href="#l32.359"></a><span id="l32.359" class="difflineplus">+      } else {</span>
<a href="#l32.360"></a><span id="l32.360">         IMPORT_LOG0(&quot;Error retrieving the one &amp; only message store\n&quot;);</span>
<a href="#l32.361"></a><span id="l32.361">       }</span>
<a href="#l32.362"></a><span id="l32.362" class="difflineminus">-    }</span>
<a href="#l32.363"></a><span id="l32.363" class="difflineminus">-    else {</span>
<a href="#l32.364"></a><span id="l32.364" class="difflineminus">-      IMPORT_LOG0(&quot;*** Error importing a folder without a valid message store\n&quot;);</span>
<a href="#l32.365"></a><span id="l32.365" class="difflineplus">+    } else {</span>
<a href="#l32.366"></a><span id="l32.366" class="difflineplus">+      IMPORT_LOG0(</span>
<a href="#l32.367"></a><span id="l32.367" class="difflineplus">+          &quot;*** Error importing a folder without a valid message store\n&quot;);</span>
<a href="#l32.368"></a><span id="l32.368">     }</span>
<a href="#l32.369"></a><span id="l32.369">   }</span>
<a href="#l32.370"></a><span id="l32.370"> }</span>
<a href="#l32.371"></a><span id="l32.371"> </span>
<a href="#l32.372"></a><span id="l32.372"> // Roles and responsibilities:</span>
<a href="#l32.373"></a><span id="l32.373"> // nsOutlookMail</span>
<a href="#l32.374"></a><span id="l32.374"> //   - Connect to Outlook</span>
<a href="#l32.375"></a><span id="l32.375"> //   - Enumerate the mailboxes</span>
<a href="#l32.376"></a><span id="l32.376"> //   - Iterate the mailboxes</span>
<a href="#l32.377"></a><span id="l32.377"> //   - For each mail, create one nsOutlookCompose object</span>
<a href="#l32.378"></a><span id="l32.378"> //   - For each mail, create one CMapiMessage object</span>
<a href="#l32.379"></a><span id="l32.379"> //</span>
<a href="#l32.380"></a><span id="l32.380"> // nsOutlookCompose</span>
<a href="#l32.381"></a><span id="l32.381"> //   - Establish a TB session</span>
<a href="#l32.382"></a><span id="l32.382"> //   - Connect to all required services</span>
<a href="#l32.383"></a><span id="l32.383" class="difflineminus">-//   - Perform the composition of the RC822 document from the data gathered by CMapiMessage</span>
<a href="#l32.384"></a><span id="l32.384" class="difflineplus">+//   - Perform the composition of the RC822 document from the data gathered by</span>
<a href="#l32.385"></a><span id="l32.385" class="difflineplus">+//   CMapiMessage</span>
<a href="#l32.386"></a><span id="l32.386"> //   - Save the composed message to the TB mailbox</span>
<a href="#l32.387"></a><span id="l32.387"> //   - Ensure the proper cleanup</span>
<a href="#l32.388"></a><span id="l32.388"> //</span>
<a href="#l32.389"></a><span id="l32.389"> // CMapiMessage</span>
<a href="#l32.390"></a><span id="l32.390"> //   - Encapsulate the MAPI message interface</span>
<a href="#l32.391"></a><span id="l32.391"> //   - Gather the information required to (re)compose the message</span>
<a href="#l32.392"></a><span id="l32.392"> </span>
<a href="#l32.393"></a><span id="l32.393" class="difflineminus">-ImportMailboxRunnable::ImportMailboxRunnable(uint32_t *pDoneSoFar, bool *pAbort,</span>
<a href="#l32.394"></a><span id="l32.394" class="difflineminus">-                                             int32_t index, const char16_t *pName,</span>
<a href="#l32.395"></a><span id="l32.395" class="difflineminus">-                                             nsIMsgFolder *dstFolder,</span>
<a href="#l32.396"></a><span id="l32.396" class="difflineminus">-                                             int32_t *pMsgCount,</span>
<a href="#l32.397"></a><span id="l32.397" class="difflineminus">-                                             nsOutlookMail *aCaller) :</span>
<a href="#l32.398"></a><span id="l32.398" class="difflineminus">-  mozilla::Runnable(&quot;ImportMailboxRunnable&quot;),</span>
<a href="#l32.399"></a><span id="l32.399" class="difflineminus">-  mResult(NS_OK),</span>
<a href="#l32.400"></a><span id="l32.400" class="difflineminus">-  mCaller(aCaller),</span>
<a href="#l32.401"></a><span id="l32.401" class="difflineminus">-  mDoneSoFar(pDoneSoFar),</span>
<a href="#l32.402"></a><span id="l32.402" class="difflineminus">-  mAbort(pAbort),</span>
<a href="#l32.403"></a><span id="l32.403" class="difflineminus">-  mIndex(index),</span>
<a href="#l32.404"></a><span id="l32.404" class="difflineminus">-  mName(pName),</span>
<a href="#l32.405"></a><span id="l32.405" class="difflineminus">-  mDstFolder(dstFolder),</span>
<a href="#l32.406"></a><span id="l32.406" class="difflineminus">-  mMsgCount(pMsgCount)</span>
<a href="#l32.407"></a><span id="l32.407" class="difflineminus">-{</span>
<a href="#l32.408"></a><span id="l32.408" class="difflineminus">-}</span>
<a href="#l32.409"></a><span id="l32.409" class="difflineminus">-NS_IMETHODIMP ImportMailboxRunnable::Run()</span>
<a href="#l32.410"></a><span id="l32.410" class="difflineminus">-{</span>
<a href="#l32.411"></a><span id="l32.411" class="difflineplus">+ImportMailboxRunnable::ImportMailboxRunnable(</span>
<a href="#l32.412"></a><span id="l32.412" class="difflineplus">+    uint32_t *pDoneSoFar, bool *pAbort, int32_t index, const char16_t *pName,</span>
<a href="#l32.413"></a><span id="l32.413" class="difflineplus">+    nsIMsgFolder *dstFolder, int32_t *pMsgCount, nsOutlookMail *aCaller)</span>
<a href="#l32.414"></a><span id="l32.414" class="difflineplus">+    : mozilla::Runnable(&quot;ImportMailboxRunnable&quot;),</span>
<a href="#l32.415"></a><span id="l32.415" class="difflineplus">+      mResult(NS_OK),</span>
<a href="#l32.416"></a><span id="l32.416" class="difflineplus">+      mCaller(aCaller),</span>
<a href="#l32.417"></a><span id="l32.417" class="difflineplus">+      mDoneSoFar(pDoneSoFar),</span>
<a href="#l32.418"></a><span id="l32.418" class="difflineplus">+      mAbort(pAbort),</span>
<a href="#l32.419"></a><span id="l32.419" class="difflineplus">+      mIndex(index),</span>
<a href="#l32.420"></a><span id="l32.420" class="difflineplus">+      mName(pName),</span>
<a href="#l32.421"></a><span id="l32.421" class="difflineplus">+      mDstFolder(dstFolder),</span>
<a href="#l32.422"></a><span id="l32.422" class="difflineplus">+      mMsgCount(pMsgCount) {}</span>
<a href="#l32.423"></a><span id="l32.423" class="difflineplus">+NS_IMETHODIMP ImportMailboxRunnable::Run() {</span>
<a href="#l32.424"></a><span id="l32.424">   if ((mIndex &lt; 0) || (mIndex &gt;= mCaller-&gt;m_folderList.GetSize())) {</span>
<a href="#l32.425"></a><span id="l32.425">     IMPORT_LOG0(&quot;*** Bad mailbox identifier, unable to import\n&quot;);</span>
<a href="#l32.426"></a><span id="l32.426">     *mAbort = true;</span>
<a href="#l32.427"></a><span id="l32.427">     mResult = NS_ERROR_FAILURE;</span>
<a href="#l32.428"></a><span id="l32.428">     return NS_OK;  // Sync runnable must return OK.</span>
<a href="#l32.429"></a><span id="l32.429">   }</span>
<a href="#l32.430"></a><span id="l32.430"> </span>
<a href="#l32.431"></a><span id="l32.431" class="difflineminus">-  int32_t    dummyMsgCount = 0;</span>
<a href="#l32.432"></a><span id="l32.432" class="difflineplus">+  int32_t dummyMsgCount = 0;</span>
<a href="#l32.433"></a><span id="l32.433">   if (mMsgCount)</span>
<a href="#l32.434"></a><span id="l32.434">     *mMsgCount = 0;</span>
<a href="#l32.435"></a><span id="l32.435">   else</span>
<a href="#l32.436"></a><span id="l32.436">     mMsgCount = &amp;dummyMsgCount;</span>
<a href="#l32.437"></a><span id="l32.437"> </span>
<a href="#l32.438"></a><span id="l32.438">   CMapiFolder *pFolder = mCaller-&gt;m_folderList.GetItem(mIndex);</span>
<a href="#l32.439"></a><span id="l32.439">   mCaller-&gt;OpenMessageStore(pFolder);</span>
<a href="#l32.440"></a><span id="l32.440">   if (!mCaller-&gt;m_lpMdb) {</span>
<a href="#l32.441"></a><span id="l32.441" class="difflineminus">-    IMPORT_LOG1(&quot;*** Unable to obtain mapi message store for mailbox: %S\n&quot;, mName);</span>
<a href="#l32.442"></a><span id="l32.442" class="difflineplus">+    IMPORT_LOG1(&quot;*** Unable to obtain mapi message store for mailbox: %S\n&quot;,</span>
<a href="#l32.443"></a><span id="l32.443" class="difflineplus">+                mName);</span>
<a href="#l32.444"></a><span id="l32.444">     mResult = NS_ERROR_FAILURE;</span>
<a href="#l32.445"></a><span id="l32.445">     return NS_OK;  // Sync runnable must return OK.</span>
<a href="#l32.446"></a><span id="l32.446">   }</span>
<a href="#l32.447"></a><span id="l32.447"> </span>
<a href="#l32.448"></a><span id="l32.448" class="difflineminus">-  if (pFolder-&gt;IsStore())</span>
<a href="#l32.449"></a><span id="l32.449" class="difflineminus">-    return NS_OK;</span>
<a href="#l32.450"></a><span id="l32.450" class="difflineplus">+  if (pFolder-&gt;IsStore()) return NS_OK;</span>
<a href="#l32.451"></a><span id="l32.451"> </span>
<a href="#l32.452"></a><span id="l32.452">   // now what?</span>
<a href="#l32.453"></a><span id="l32.453" class="difflineminus">-  CMapiFolderContents    contents(mCaller-&gt;m_lpMdb, pFolder-&gt;GetCBEntryID(), pFolder-&gt;GetEntryID());</span>
<a href="#l32.454"></a><span id="l32.454" class="difflineplus">+  CMapiFolderContents contents(mCaller-&gt;m_lpMdb, pFolder-&gt;GetCBEntryID(),</span>
<a href="#l32.455"></a><span id="l32.455" class="difflineplus">+                               pFolder-&gt;GetEntryID());</span>
<a href="#l32.456"></a><span id="l32.456"> </span>
<a href="#l32.457"></a><span id="l32.457" class="difflineminus">-  BOOL    done = FALSE;</span>
<a href="#l32.458"></a><span id="l32.458" class="difflineminus">-  ULONG    cbEid;</span>
<a href="#l32.459"></a><span id="l32.459" class="difflineminus">-  LPENTRYID  lpEid;</span>
<a href="#l32.460"></a><span id="l32.460" class="difflineminus">-  ULONG    oType;</span>
<a href="#l32.461"></a><span id="l32.461" class="difflineminus">-  LPMESSAGE  lpMsg = nullptr;</span>
<a href="#l32.462"></a><span id="l32.462" class="difflineminus">-  ULONG    totalCount;</span>
<a href="#l32.463"></a><span id="l32.463" class="difflineminus">-  double  doneCalc;</span>
<a href="#l32.464"></a><span id="l32.464" class="difflineplus">+  BOOL done = FALSE;</span>
<a href="#l32.465"></a><span id="l32.465" class="difflineplus">+  ULONG cbEid;</span>
<a href="#l32.466"></a><span id="l32.466" class="difflineplus">+  LPENTRYID lpEid;</span>
<a href="#l32.467"></a><span id="l32.467" class="difflineplus">+  ULONG oType;</span>
<a href="#l32.468"></a><span id="l32.468" class="difflineplus">+  LPMESSAGE lpMsg = nullptr;</span>
<a href="#l32.469"></a><span id="l32.469" class="difflineplus">+  ULONG totalCount;</span>
<a href="#l32.470"></a><span id="l32.470" class="difflineplus">+  double doneCalc;</span>
<a href="#l32.471"></a><span id="l32.471"> </span>
<a href="#l32.472"></a><span id="l32.472">   nsCOMPtr&lt;nsIOutputStream&gt; outputStream;</span>
<a href="#l32.473"></a><span id="l32.473">   nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l32.474"></a><span id="l32.474">   nsresult rv = mDstFolder-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l32.475"></a><span id="l32.475">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.476"></a><span id="l32.476"> </span>
<a href="#l32.477"></a><span id="l32.477">   while (!done) {</span>
<a href="#l32.478"></a><span id="l32.478">     if (!contents.GetNext(&amp;cbEid, &amp;lpEid, &amp;oType, &amp;done)) {</span>
<a href="#l32.479"></a><span id="l32.479">       IMPORT_LOG1(&quot;*** Error iterating mailbox: %S\n&quot;, mName);</span>
<a href="#l32.480"></a><span id="l32.480">       mResult = NS_ERROR_FAILURE;</span>
<a href="#l32.481"></a><span id="l32.481">       return NS_OK;  // Sync runnable must return OK.</span>
<a href="#l32.482"></a><span id="l32.482">     }</span>
<a href="#l32.483"></a><span id="l32.483"> </span>
<a href="#l32.484"></a><span id="l32.484">     nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l32.485"></a><span id="l32.485">     bool reusable;</span>
<a href="#l32.486"></a><span id="l32.486"> </span>
<a href="#l32.487"></a><span id="l32.487" class="difflineminus">-    rv = msgStore-&gt;GetNewMsgOutputStream(mDstFolder, getter_AddRefs(msgHdr), &amp;reusable,</span>
<a href="#l32.488"></a><span id="l32.488" class="difflineplus">+    rv = msgStore-&gt;GetNewMsgOutputStream(mDstFolder, getter_AddRefs(msgHdr),</span>
<a href="#l32.489"></a><span id="l32.489" class="difflineplus">+                                         &amp;reusable,</span>
<a href="#l32.490"></a><span id="l32.490">                                          getter_AddRefs(outputStream));</span>
<a href="#l32.491"></a><span id="l32.491">     if (NS_FAILED(rv)) {</span>
<a href="#l32.492"></a><span id="l32.492">       IMPORT_LOG1(&quot;*** Error getting nsIOutputStream of mailbox: %S\n&quot;, mName);</span>
<a href="#l32.493"></a><span id="l32.493">       mResult = rv;</span>
<a href="#l32.494"></a><span id="l32.494">       return NS_OK;  // Sync runnable must return OK.</span>
<a href="#l32.495"></a><span id="l32.495">     }</span>
<a href="#l32.496"></a><span id="l32.496">     totalCount = contents.GetCount();</span>
<a href="#l32.497"></a><span id="l32.497">     doneCalc = *mMsgCount;</span>
<a href="#l32.498"></a><span id="l32.498">     doneCalc /= totalCount;</span>
<a href="#l32.499"></a><span id="l32.499">     doneCalc *= 1000;</span>
<a href="#l32.500"></a><span id="l32.500">     if (mDoneSoFar) {</span>
<a href="#l32.501"></a><span id="l32.501" class="difflineminus">-      *mDoneSoFar = (uint32_t) doneCalc;</span>
<a href="#l32.502"></a><span id="l32.502" class="difflineminus">-      if (*mDoneSoFar &gt; 1000)</span>
<a href="#l32.503"></a><span id="l32.503" class="difflineminus">-        *mDoneSoFar = 1000;</span>
<a href="#l32.504"></a><span id="l32.504" class="difflineplus">+      *mDoneSoFar = (uint32_t)doneCalc;</span>
<a href="#l32.505"></a><span id="l32.505" class="difflineplus">+      if (*mDoneSoFar &gt; 1000) *mDoneSoFar = 1000;</span>
<a href="#l32.506"></a><span id="l32.506">     }</span>
<a href="#l32.507"></a><span id="l32.507"> </span>
<a href="#l32.508"></a><span id="l32.508">     if (!done &amp;&amp; (oType == MAPI_MESSAGE)) {</span>
<a href="#l32.509"></a><span id="l32.509" class="difflineminus">-      if (!mCaller-&gt;m_mapi.OpenMdbEntry(mCaller-&gt;m_lpMdb, cbEid, lpEid, (LPUNKNOWN *) &amp;lpMsg)) {</span>
<a href="#l32.510"></a><span id="l32.510" class="difflineplus">+      if (!mCaller-&gt;m_mapi.OpenMdbEntry(mCaller-&gt;m_lpMdb, cbEid, lpEid,</span>
<a href="#l32.511"></a><span id="l32.511" class="difflineplus">+                                        (LPUNKNOWN *)&amp;lpMsg)) {</span>
<a href="#l32.512"></a><span id="l32.512">         IMPORT_LOG1(&quot;*** Error opening messages in mailbox: %S\n&quot;, mName);</span>
<a href="#l32.513"></a><span id="l32.513">         mResult = NS_ERROR_FAILURE;</span>
<a href="#l32.514"></a><span id="l32.514">         return NS_OK;  // Sync runnable must return OK.</span>
<a href="#l32.515"></a><span id="l32.515">       }</span>
<a href="#l32.516"></a><span id="l32.516"> </span>
<a href="#l32.517"></a><span id="l32.517">       // See if it's a drafts folder. Outlook doesn't allow drafts</span>
<a href="#l32.518"></a><span id="l32.518">       // folder to be configured so it's ok to hard code it here.</span>
<a href="#l32.519"></a><span id="l32.519">       nsAutoString folderName(mName);</span>
<a href="#l32.520"></a><span id="l32.520">       nsMsgDeliverMode mode = nsIMsgSend::nsMsgDeliverNow;</span>
<a href="#l32.521"></a><span id="l32.521">       mode = nsIMsgSend::nsMsgSaveAsDraft;</span>
<a href="#l32.522"></a><span id="l32.522">       if (folderName.LowerCaseEqualsLiteral(&quot;drafts&quot;))</span>
<a href="#l32.523"></a><span id="l32.523">         mode = nsIMsgSend::nsMsgSaveAsDraft;</span>
<a href="#l32.524"></a><span id="l32.524"> </span>
<a href="#l32.525"></a><span id="l32.525">       rv = ImportMessage(lpMsg, outputStream, mode);</span>
<a href="#l32.526"></a><span id="l32.526" class="difflineminus">-      if (NS_SUCCEEDED(rv)){ // No errors &amp; really imported</span>
<a href="#l32.527"></a><span id="l32.527" class="difflineminus">-         (*mMsgCount)++;</span>
<a href="#l32.528"></a><span id="l32.528" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {  // No errors &amp; really imported</span>
<a href="#l32.529"></a><span id="l32.529" class="difflineplus">+        (*mMsgCount)++;</span>
<a href="#l32.530"></a><span id="l32.530">         msgStore-&gt;FinishNewMessage(outputStream, msgHdr);</span>
<a href="#l32.531"></a><span id="l32.531" class="difflineminus">-      }</span>
<a href="#l32.532"></a><span id="l32.532" class="difflineminus">-      else {</span>
<a href="#l32.533"></a><span id="l32.533" class="difflineminus">-        IMPORT_LOG1( &quot;*** Error reading message from mailbox: %S\n&quot;, mName);</span>
<a href="#l32.534"></a><span id="l32.534" class="difflineplus">+      } else {</span>
<a href="#l32.535"></a><span id="l32.535" class="difflineplus">+        IMPORT_LOG1(&quot;*** Error reading message from mailbox: %S\n&quot;, mName);</span>
<a href="#l32.536"></a><span id="l32.536">         msgStore-&gt;DiscardNewMessage(outputStream, msgHdr);</span>
<a href="#l32.537"></a><span id="l32.537">       }</span>
<a href="#l32.538"></a><span id="l32.538" class="difflineminus">-      if (!reusable)</span>
<a href="#l32.539"></a><span id="l32.539" class="difflineminus">-        outputStream-&gt;Close();</span>
<a href="#l32.540"></a><span id="l32.540" class="difflineplus">+      if (!reusable) outputStream-&gt;Close();</span>
<a href="#l32.541"></a><span id="l32.541">     }</span>
<a href="#l32.542"></a><span id="l32.542">   }</span>
<a href="#l32.543"></a><span id="l32.543"> </span>
<a href="#l32.544"></a><span id="l32.544" class="difflineminus">-  if (outputStream)</span>
<a href="#l32.545"></a><span id="l32.545" class="difflineminus">-    outputStream-&gt;Close();</span>
<a href="#l32.546"></a><span id="l32.546" class="difflineplus">+  if (outputStream) outputStream-&gt;Close();</span>
<a href="#l32.547"></a><span id="l32.547">   return NS_OK;</span>
<a href="#l32.548"></a><span id="l32.548"> }</span>
<a href="#l32.549"></a><span id="l32.549"> </span>
<a href="#l32.550"></a><span id="l32.550" class="difflineminus">-nsresult ProxyImportMailbox(uint32_t *pDoneSoFar, bool *pAbort,</span>
<a href="#l32.551"></a><span id="l32.551" class="difflineminus">-                            int32_t index, const char16_t *pName,</span>
<a href="#l32.552"></a><span id="l32.552" class="difflineminus">-                            nsIMsgFolder *dstFolder,</span>
<a href="#l32.553"></a><span id="l32.553" class="difflineminus">-                            int32_t *pMsgCount,</span>
<a href="#l32.554"></a><span id="l32.554" class="difflineminus">-                            nsOutlookMail *aCaller)</span>
<a href="#l32.555"></a><span id="l32.555" class="difflineminus">-{</span>
<a href="#l32.556"></a><span id="l32.556" class="difflineminus">-  RefPtr&lt;ImportMailboxRunnable&gt; importMailbox =</span>
<a href="#l32.557"></a><span id="l32.557" class="difflineminus">-    new ImportMailboxRunnable(pDoneSoFar, pAbort, index, pName, dstFolder, pMsgCount, aCaller);</span>
<a href="#l32.558"></a><span id="l32.558" class="difflineplus">+nsresult ProxyImportMailbox(uint32_t *pDoneSoFar, bool *pAbort, int32_t index,</span>
<a href="#l32.559"></a><span id="l32.559" class="difflineplus">+                            const char16_t *pName, nsIMsgFolder *dstFolder,</span>
<a href="#l32.560"></a><span id="l32.560" class="difflineplus">+                            int32_t *pMsgCount, nsOutlookMail *aCaller) {</span>
<a href="#l32.561"></a><span id="l32.561" class="difflineplus">+  RefPtr&lt;ImportMailboxRunnable&gt; importMailbox = new ImportMailboxRunnable(</span>
<a href="#l32.562"></a><span id="l32.562" class="difflineplus">+      pDoneSoFar, pAbort, index, pName, dstFolder, pMsgCount, aCaller);</span>
<a href="#l32.563"></a><span id="l32.563">   nsresult rv = NS_DispatchToMainThread(importMailbox, NS_DISPATCH_SYNC);</span>
<a href="#l32.564"></a><span id="l32.564">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.565"></a><span id="l32.565"> </span>
<a href="#l32.566"></a><span id="l32.566">   return importMailbox-&gt;mResult;</span>
<a href="#l32.567"></a><span id="l32.567"> }</span>
<a href="#l32.568"></a><span id="l32.568"> </span>
<a href="#l32.569"></a><span id="l32.569"> nsresult nsOutlookMail::ImportMailbox(uint32_t *pDoneSoFar, bool *pAbort,</span>
<a href="#l32.570"></a><span id="l32.570">                                       int32_t index, const char16_t *pName,</span>
<a href="#l32.571"></a><span id="l32.571">                                       nsIMsgFolder *dstFolder,</span>
<a href="#l32.572"></a><span id="l32.572" class="difflineminus">-                                      int32_t *pMsgCount)</span>
<a href="#l32.573"></a><span id="l32.573" class="difflineminus">-{</span>
<a href="#l32.574"></a><span id="l32.574" class="difflineminus">-  return ProxyImportMailbox(pDoneSoFar, pAbort, index, pName, dstFolder, pMsgCount, this);</span>
<a href="#l32.575"></a><span id="l32.575" class="difflineplus">+                                      int32_t *pMsgCount) {</span>
<a href="#l32.576"></a><span id="l32.576" class="difflineplus">+  return ProxyImportMailbox(pDoneSoFar, pAbort, index, pName, dstFolder,</span>
<a href="#l32.577"></a><span id="l32.577" class="difflineplus">+                            pMsgCount, this);</span>
<a href="#l32.578"></a><span id="l32.578"> }</span>
<a href="#l32.579"></a><span id="l32.579"> </span>
<a href="#l32.580"></a><span id="l32.580" class="difflineminus">-nsresult ImportMailboxRunnable::ImportMessage(LPMESSAGE lpMsg, nsIOutputStream *pDest, nsMsgDeliverMode mode)</span>
<a href="#l32.581"></a><span id="l32.581" class="difflineminus">-{</span>
<a href="#l32.582"></a><span id="l32.582" class="difflineminus">-  CMapiMessage  msg(lpMsg);</span>
<a href="#l32.583"></a><span id="l32.583" class="difflineplus">+nsresult ImportMailboxRunnable::ImportMessage(LPMESSAGE lpMsg,</span>
<a href="#l32.584"></a><span id="l32.584" class="difflineplus">+                                              nsIOutputStream *pDest,</span>
<a href="#l32.585"></a><span id="l32.585" class="difflineplus">+                                              nsMsgDeliverMode mode) {</span>
<a href="#l32.586"></a><span id="l32.586" class="difflineplus">+  CMapiMessage msg(lpMsg);</span>
<a href="#l32.587"></a><span id="l32.587">   // If we wanted to skip messages that were downloaded in header only mode, we</span>
<a href="#l32.588"></a><span id="l32.588">   // would return NS_ERROR_FAILURE if !msg.FullMessageDownloaded. However, we</span>
<a href="#l32.589"></a><span id="l32.589">   // don't do this because it may cause seemingly wrong import results.</span>
<a href="#l32.590"></a><span id="l32.590" class="difflineminus">-  // A user will get less mails in his imported folder than were in the original folder,</span>
<a href="#l32.591"></a><span id="l32.591" class="difflineminus">-  // and this may make user feel like TB import is bad.</span>
<a href="#l32.592"></a><span id="l32.592" class="difflineminus">-  // In reality, the skipped messages are those that have not been downloaded yet, because</span>
<a href="#l32.593"></a><span id="l32.593" class="difflineminus">-  // they were downloaded in the &quot;headers-only&quot; mode. This is different from the case when</span>
<a href="#l32.594"></a><span id="l32.594" class="difflineminus">-  // the message is downloaded completely, but consists only of headers - in this case</span>
<a href="#l32.595"></a><span id="l32.595" class="difflineminus">-  // the message will be imported anyway.</span>
<a href="#l32.596"></a><span id="l32.596" class="difflineplus">+  // A user will get less mails in his imported folder than were in the original</span>
<a href="#l32.597"></a><span id="l32.597" class="difflineplus">+  // folder, and this may make user feel like TB import is bad. In reality, the</span>
<a href="#l32.598"></a><span id="l32.598" class="difflineplus">+  // skipped messages are those that have not been downloaded yet, because they</span>
<a href="#l32.599"></a><span id="l32.599" class="difflineplus">+  // were downloaded in the &quot;headers-only&quot; mode. This is different from the case</span>
<a href="#l32.600"></a><span id="l32.600" class="difflineplus">+  // when the message is downloaded completely, but consists only of headers -</span>
<a href="#l32.601"></a><span id="l32.601" class="difflineplus">+  // in this case the message will be imported anyway.</span>
<a href="#l32.602"></a><span id="l32.602"> </span>
<a href="#l32.603"></a><span id="l32.603" class="difflineminus">-  if (!msg.ValidState())</span>
<a href="#l32.604"></a><span id="l32.604" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l32.605"></a><span id="l32.605" class="difflineplus">+  if (!msg.ValidState()) return NS_ERROR_FAILURE;</span>
<a href="#l32.606"></a><span id="l32.606"> </span>
<a href="#l32.607"></a><span id="l32.607" class="difflineminus">-  // I have to create a composer for each message, since it turns out that if we create</span>
<a href="#l32.608"></a><span id="l32.608" class="difflineminus">-  // one composer for several messages, the Send Proxy object that is shared between those messages</span>
<a href="#l32.609"></a><span id="l32.609" class="difflineminus">-  // isn't reset properly (at least in the current implementation), which leads to crash.</span>
<a href="#l32.610"></a><span id="l32.610" class="difflineminus">-  // If there's a proper way to reinitialize the Send Proxy object,</span>
<a href="#l32.611"></a><span id="l32.611" class="difflineminus">-  // then we could slightly optimize the send process.</span>
<a href="#l32.612"></a><span id="l32.612" class="difflineplus">+  // I have to create a composer for each message, since it turns out that if we</span>
<a href="#l32.613"></a><span id="l32.613" class="difflineplus">+  // create one composer for several messages, the Send Proxy object that is</span>
<a href="#l32.614"></a><span id="l32.614" class="difflineplus">+  // shared between those messages isn't reset properly (at least in the current</span>
<a href="#l32.615"></a><span id="l32.615" class="difflineplus">+  // implementation), which leads to crash. If there's a proper way to</span>
<a href="#l32.616"></a><span id="l32.616" class="difflineplus">+  // reinitialize the Send Proxy object, then we could slightly optimize the</span>
<a href="#l32.617"></a><span id="l32.617" class="difflineplus">+  // send process.</span>
<a href="#l32.618"></a><span id="l32.618">   nsOutlookCompose compose;</span>
<a href="#l32.619"></a><span id="l32.619">   nsresult rv = compose.ProcessMessage(mode, msg, pDest);</span>
<a href="#l32.620"></a><span id="l32.620"> </span>
<a href="#l32.621"></a><span id="l32.621">   // Just for YUCKS, let's try an extra endline</span>
<a href="#l32.622"></a><span id="l32.622">   nsOutlookMail::WriteData(pDest, &quot;\x0D\x0A&quot;, 2);</span>
<a href="#l32.623"></a><span id="l32.623"> </span>
<a href="#l32.624"></a><span id="l32.624">   return rv;</span>
<a href="#l32.625"></a><span id="l32.625"> }</span>
<a href="#l32.626"></a><span id="l32.626"> </span>
<a href="#l32.627"></a><span id="l32.627" class="difflineminus">-BOOL nsOutlookMail::WriteData(nsIOutputStream *pDest, const char *pData, int32_t len)</span>
<a href="#l32.628"></a><span id="l32.628" class="difflineminus">-{</span>
<a href="#l32.629"></a><span id="l32.629" class="difflineminus">-  uint32_t    written;</span>
<a href="#l32.630"></a><span id="l32.630" class="difflineplus">+BOOL nsOutlookMail::WriteData(nsIOutputStream *pDest, const char *pData,</span>
<a href="#l32.631"></a><span id="l32.631" class="difflineplus">+                              int32_t len) {</span>
<a href="#l32.632"></a><span id="l32.632" class="difflineplus">+  uint32_t written;</span>
<a href="#l32.633"></a><span id="l32.633">   nsresult rv = pDest-&gt;Write(pData, len, &amp;written);</span>
<a href="#l32.634"></a><span id="l32.634">   return NS_SUCCEEDED(rv) &amp;&amp; written == len;</span>
<a href="#l32.635"></a><span id="l32.635"> }</span>
<a href="#l32.636"></a><span id="l32.636"> </span>
<a href="#l32.637"></a><span id="l32.637" class="difflineminus">-nsresult nsOutlookMail::ImportAddresses(uint32_t *pCount, uint32_t *pTotal, const char16_t *pName, uint32_t id, nsIAddrDatabase *pDb, nsString&amp; errors)</span>
<a href="#l32.638"></a><span id="l32.638" class="difflineminus">-{</span>
<a href="#l32.639"></a><span id="l32.639" class="difflineplus">+nsresult nsOutlookMail::ImportAddresses(uint32_t *pCount, uint32_t *pTotal,</span>
<a href="#l32.640"></a><span id="l32.640" class="difflineplus">+                                        const char16_t *pName, uint32_t id,</span>
<a href="#l32.641"></a><span id="l32.641" class="difflineplus">+                                        nsIAddrDatabase *pDb,</span>
<a href="#l32.642"></a><span id="l32.642" class="difflineplus">+                                        nsString &amp;errors) {</span>
<a href="#l32.643"></a><span id="l32.643">   if (id &gt;= (uint32_t)(m_addressList.GetSize())) {</span>
<a href="#l32.644"></a><span id="l32.644">     IMPORT_LOG0(&quot;*** Bad address identifier, unable to import\n&quot;);</span>
<a href="#l32.645"></a><span id="l32.645">     return NS_ERROR_FAILURE;</span>
<a href="#l32.646"></a><span id="l32.646">   }</span>
<a href="#l32.647"></a><span id="l32.647"> </span>
<a href="#l32.648"></a><span id="l32.648" class="difflineminus">-  uint32_t  dummyCount = 0;</span>
<a href="#l32.649"></a><span id="l32.649" class="difflineplus">+  uint32_t dummyCount = 0;</span>
<a href="#l32.650"></a><span id="l32.650">   if (pCount)</span>
<a href="#l32.651"></a><span id="l32.651">     *pCount = 0;</span>
<a href="#l32.652"></a><span id="l32.652">   else</span>
<a href="#l32.653"></a><span id="l32.653">     pCount = &amp;dummyCount;</span>
<a href="#l32.654"></a><span id="l32.654"> </span>
<a href="#l32.655"></a><span id="l32.655">   CMapiFolder *pFolder;</span>
<a href="#l32.656"></a><span id="l32.656">   if (id &gt; 0) {</span>
<a href="#l32.657"></a><span id="l32.657" class="difflineminus">-    int32_t idx = (int32_t) id;</span>
<a href="#l32.658"></a><span id="l32.658" class="difflineplus">+    int32_t idx = (int32_t)id;</span>
<a href="#l32.659"></a><span id="l32.659">     idx--;</span>
<a href="#l32.660"></a><span id="l32.660">     while (idx &gt;= 0) {</span>
<a href="#l32.661"></a><span id="l32.661">       pFolder = m_addressList.GetItem(idx);</span>
<a href="#l32.662"></a><span id="l32.662">       if (pFolder-&gt;IsStore()) {</span>
<a href="#l32.663"></a><span id="l32.663">         OpenMessageStore(pFolder);</span>
<a href="#l32.664"></a><span id="l32.664">         break;</span>
<a href="#l32.665"></a><span id="l32.665">       }</span>
<a href="#l32.666"></a><span id="l32.666">       idx--;</span>
<a href="#l32.667"></a><span id="l32.667">     }</span>
<a href="#l32.668"></a><span id="l32.668">   }</span>
<a href="#l32.669"></a><span id="l32.669"> </span>
<a href="#l32.670"></a><span id="l32.670">   pFolder = m_addressList.GetItem(id);</span>
<a href="#l32.671"></a><span id="l32.671">   OpenMessageStore(pFolder);</span>
<a href="#l32.672"></a><span id="l32.672">   if (!m_lpMdb) {</span>
<a href="#l32.673"></a><span id="l32.673" class="difflineminus">-    IMPORT_LOG1(&quot;*** Unable to obtain mapi message store for address book: %S\n&quot;, pName);</span>
<a href="#l32.674"></a><span id="l32.674" class="difflineplus">+    IMPORT_LOG1(</span>
<a href="#l32.675"></a><span id="l32.675" class="difflineplus">+        &quot;*** Unable to obtain mapi message store for address book: %S\n&quot;,</span>
<a href="#l32.676"></a><span id="l32.676" class="difflineplus">+        pName);</span>
<a href="#l32.677"></a><span id="l32.677">     return NS_ERROR_FAILURE;</span>
<a href="#l32.678"></a><span id="l32.678">   }</span>
<a href="#l32.679"></a><span id="l32.679"> </span>
<a href="#l32.680"></a><span id="l32.680" class="difflineminus">-  if (pFolder-&gt;IsStore())</span>
<a href="#l32.681"></a><span id="l32.681" class="difflineminus">-    return NS_OK;</span>
<a href="#l32.682"></a><span id="l32.682" class="difflineplus">+  if (pFolder-&gt;IsStore()) return NS_OK;</span>
<a href="#l32.683"></a><span id="l32.683" class="difflineplus">+</span>
<a href="#l32.684"></a><span id="l32.684" class="difflineplus">+  nsresult rv;</span>
<a href="#l32.685"></a><span id="l32.685"> </span>
<a href="#l32.686"></a><span id="l32.686" class="difflineminus">-  nsresult  rv;</span>
<a href="#l32.687"></a><span id="l32.687" class="difflineplus">+  nsCOMPtr&lt;nsIImportFieldMap&gt; pFieldMap;</span>
<a href="#l32.688"></a><span id="l32.688"> </span>
<a href="#l32.689"></a><span id="l32.689" class="difflineminus">-  nsCOMPtr&lt;nsIImportFieldMap&gt;    pFieldMap;</span>
<a href="#l32.690"></a><span id="l32.690" class="difflineminus">-</span>
<a href="#l32.691"></a><span id="l32.691" class="difflineminus">-  nsCOMPtr&lt;nsIImportService&gt; impSvc(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l32.692"></a><span id="l32.692" class="difflineplus">+  nsCOMPtr&lt;nsIImportService&gt; impSvc(</span>
<a href="#l32.693"></a><span id="l32.693" class="difflineplus">+      do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l32.694"></a><span id="l32.694">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l32.695"></a><span id="l32.695">     rv = impSvc-&gt;CreateNewFieldMap(getter_AddRefs(pFieldMap));</span>
<a href="#l32.696"></a><span id="l32.696">   }</span>
<a href="#l32.697"></a><span id="l32.697"> </span>
<a href="#l32.698"></a><span id="l32.698" class="difflineminus">-  CMapiFolderContents    contents(m_lpMdb, pFolder-&gt;GetCBEntryID(), pFolder-&gt;GetEntryID());</span>
<a href="#l32.699"></a><span id="l32.699" class="difflineplus">+  CMapiFolderContents contents(m_lpMdb, pFolder-&gt;GetCBEntryID(),</span>
<a href="#l32.700"></a><span id="l32.700" class="difflineplus">+                               pFolder-&gt;GetEntryID());</span>
<a href="#l32.701"></a><span id="l32.701"> </span>
<a href="#l32.702"></a><span id="l32.702" class="difflineminus">-  BOOL      done = FALSE;</span>
<a href="#l32.703"></a><span id="l32.703" class="difflineminus">-  ULONG      cbEid;</span>
<a href="#l32.704"></a><span id="l32.704" class="difflineminus">-  LPENTRYID    lpEid;</span>
<a href="#l32.705"></a><span id="l32.705" class="difflineminus">-  ULONG      oType;</span>
<a href="#l32.706"></a><span id="l32.706" class="difflineminus">-  LPMESSAGE    lpMsg;</span>
<a href="#l32.707"></a><span id="l32.707" class="difflineminus">-  nsCString    type;</span>
<a href="#l32.708"></a><span id="l32.708" class="difflineminus">-  LPSPropValue  pVal;</span>
<a href="#l32.709"></a><span id="l32.709" class="difflineminus">-  nsString    subject;</span>
<a href="#l32.710"></a><span id="l32.710" class="difflineplus">+  BOOL done = FALSE;</span>
<a href="#l32.711"></a><span id="l32.711" class="difflineplus">+  ULONG cbEid;</span>
<a href="#l32.712"></a><span id="l32.712" class="difflineplus">+  LPENTRYID lpEid;</span>
<a href="#l32.713"></a><span id="l32.713" class="difflineplus">+  ULONG oType;</span>
<a href="#l32.714"></a><span id="l32.714" class="difflineplus">+  LPMESSAGE lpMsg;</span>
<a href="#l32.715"></a><span id="l32.715" class="difflineplus">+  nsCString type;</span>
<a href="#l32.716"></a><span id="l32.716" class="difflineplus">+  LPSPropValue pVal;</span>
<a href="#l32.717"></a><span id="l32.717" class="difflineplus">+  nsString subject;</span>
<a href="#l32.718"></a><span id="l32.718"> </span>
<a href="#l32.719"></a><span id="l32.719">   while (!done) {</span>
<a href="#l32.720"></a><span id="l32.720">     (*pCount)++;</span>
<a href="#l32.721"></a><span id="l32.721"> </span>
<a href="#l32.722"></a><span id="l32.722">     if (!contents.GetNext(&amp;cbEid, &amp;lpEid, &amp;oType, &amp;done)) {</span>
<a href="#l32.723"></a><span id="l32.723">       IMPORT_LOG1(&quot;*** Error iterating address book: %S\n&quot;, pName);</span>
<a href="#l32.724"></a><span id="l32.724">       return NS_ERROR_FAILURE;</span>
<a href="#l32.725"></a><span id="l32.725">     }</span>
<a href="#l32.726"></a><span id="l32.726"> </span>
<a href="#l32.727"></a><span id="l32.727" class="difflineminus">-    if (pTotal &amp;&amp; (*pTotal == 0))</span>
<a href="#l32.728"></a><span id="l32.728" class="difflineminus">-      *pTotal = contents.GetCount();</span>
<a href="#l32.729"></a><span id="l32.729" class="difflineplus">+    if (pTotal &amp;&amp; (*pTotal == 0)) *pTotal = contents.GetCount();</span>
<a href="#l32.730"></a><span id="l32.730"> </span>
<a href="#l32.731"></a><span id="l32.731">     if (!done &amp;&amp; (oType == MAPI_MESSAGE)) {</span>
<a href="#l32.732"></a><span id="l32.732" class="difflineminus">-      if (!m_mapi.OpenMdbEntry(m_lpMdb, cbEid, lpEid, (LPUNKNOWN *) &amp;lpMsg)) {</span>
<a href="#l32.733"></a><span id="l32.733" class="difflineplus">+      if (!m_mapi.OpenMdbEntry(m_lpMdb, cbEid, lpEid, (LPUNKNOWN *)&amp;lpMsg)) {</span>
<a href="#l32.734"></a><span id="l32.734">         IMPORT_LOG1(&quot;*** Error opening messages in mailbox: %S\n&quot;, pName);</span>
<a href="#l32.735"></a><span id="l32.735">         return NS_ERROR_FAILURE;</span>
<a href="#l32.736"></a><span id="l32.736">       }</span>
<a href="#l32.737"></a><span id="l32.737"> </span>
<a href="#l32.738"></a><span id="l32.738">       // Get the PR_MESSAGE_CLASS attribute,</span>
<a href="#l32.739"></a><span id="l32.739">       // ensure that it is IPM.Contact</span>
<a href="#l32.740"></a><span id="l32.740">       pVal = m_mapi.GetMapiProperty(lpMsg, PR_MESSAGE_CLASS);</span>
<a href="#l32.741"></a><span id="l32.741">       if (pVal) {</span>
<a href="#l32.742"></a><span id="l32.742">         type.Truncate();</span>
<a href="#l32.743"></a><span id="l32.743">         m_mapi.GetStringFromProp(pVal, type);</span>
<a href="#l32.744"></a><span id="l32.744">         if (type.EqualsLiteral(&quot;IPM.Contact&quot;)) {</span>
<a href="#l32.745"></a><span id="l32.745">           // This is a contact, add it to the address book!</span>
<a href="#l32.746"></a><span id="l32.746">           subject.Truncate();</span>
<a href="#l32.747"></a><span id="l32.747">           pVal = m_mapi.GetMapiProperty(lpMsg, PR_SUBJECT);</span>
<a href="#l32.748"></a><span id="l32.748" class="difflineminus">-          if (pVal)</span>
<a href="#l32.749"></a><span id="l32.749" class="difflineminus">-            m_mapi.GetStringFromProp(pVal, subject);</span>
<a href="#l32.750"></a><span id="l32.750" class="difflineplus">+          if (pVal) m_mapi.GetStringFromProp(pVal, subject);</span>
<a href="#l32.751"></a><span id="l32.751"> </span>
<a href="#l32.752"></a><span id="l32.752" class="difflineminus">-          nsIMdbRow* newRow = nullptr;</span>
<a href="#l32.753"></a><span id="l32.753" class="difflineplus">+          nsIMdbRow *newRow = nullptr;</span>
<a href="#l32.754"></a><span id="l32.754">           pDb-&gt;GetNewRow(&amp;newRow);</span>
<a href="#l32.755"></a><span id="l32.755">           // FIXME: Check with Candice about releasing the newRow if it</span>
<a href="#l32.756"></a><span id="l32.756">           // isn't added to the database.  Candice's code in nsAddressBook</span>
<a href="#l32.757"></a><span id="l32.757">           // never releases it but that doesn't seem right to me!</span>
<a href="#l32.758"></a><span id="l32.758">           if (newRow) {</span>
<a href="#l32.759"></a><span id="l32.759">             if (BuildCard(subject.get(), pDb, newRow, lpMsg, pFieldMap)) {</span>
<a href="#l32.760"></a><span id="l32.760">               pDb-&gt;AddCardRowToDB(newRow);</span>
<a href="#l32.761"></a><span id="l32.761">             }</span>
<a href="#l32.762"></a><span id="l32.762">           }</span>
<a href="#l32.763"></a><span id="l32.763" class="difflineminus">-        }</span>
<a href="#l32.764"></a><span id="l32.764" class="difflineminus">-        else if (type.EqualsLiteral(&quot;IPM.DistList&quot;))</span>
<a href="#l32.765"></a><span id="l32.765" class="difflineminus">-        {</span>
<a href="#l32.766"></a><span id="l32.766" class="difflineplus">+        } else if (type.EqualsLiteral(&quot;IPM.DistList&quot;)) {</span>
<a href="#l32.767"></a><span id="l32.767">           // This is a list/group, add it to the address book!</span>
<a href="#l32.768"></a><span id="l32.768">           subject.Truncate();</span>
<a href="#l32.769"></a><span id="l32.769">           pVal = m_mapi.GetMapiProperty(lpMsg, PR_SUBJECT);</span>
<a href="#l32.770"></a><span id="l32.770" class="difflineminus">-          if (pVal)</span>
<a href="#l32.771"></a><span id="l32.771" class="difflineminus">-            m_mapi.GetStringFromProp(pVal, subject);</span>
<a href="#l32.772"></a><span id="l32.772" class="difflineplus">+          if (pVal) m_mapi.GetStringFromProp(pVal, subject);</span>
<a href="#l32.773"></a><span id="l32.773">           CreateList(subject.get(), pDb, lpMsg, pFieldMap);</span>
<a href="#l32.774"></a><span id="l32.774">         }</span>
<a href="#l32.775"></a><span id="l32.775">       }</span>
<a href="#l32.776"></a><span id="l32.776"> </span>
<a href="#l32.777"></a><span id="l32.777">       lpMsg-&gt;Release();</span>
<a href="#l32.778"></a><span id="l32.778">     }</span>
<a href="#l32.779"></a><span id="l32.779">   }</span>
<a href="#l32.780"></a><span id="l32.780"> </span>
<a href="#l32.781"></a><span id="l32.781">   rv = pDb-&gt;Commit(nsAddrDBCommitType::kLargeCommit);</span>
<a href="#l32.782"></a><span id="l32.782">   return rv;</span>
<a href="#l32.783"></a><span id="l32.783"> }</span>
<a href="#l32.784"></a><span id="l32.784" class="difflineminus">-nsresult nsOutlookMail::CreateList(const char16_t * pName,</span>
<a href="#l32.785"></a><span id="l32.785" class="difflineminus">-                                   nsIAddrDatabase *pDb,</span>
<a href="#l32.786"></a><span id="l32.786" class="difflineplus">+nsresult nsOutlookMail::CreateList(const char16_t *pName, nsIAddrDatabase *pDb,</span>
<a href="#l32.787"></a><span id="l32.787">                                    LPMAPIPROP pUserList,</span>
<a href="#l32.788"></a><span id="l32.788" class="difflineminus">-                                   nsIImportFieldMap *pFieldMap)</span>
<a href="#l32.789"></a><span id="l32.789" class="difflineminus">-{</span>
<a href="#l32.790"></a><span id="l32.790" class="difflineplus">+                                   nsIImportFieldMap *pFieldMap) {</span>
<a href="#l32.791"></a><span id="l32.791">   // If no name provided then we're done.</span>
<a href="#l32.792"></a><span id="l32.792" class="difflineminus">-  if (!pName || !(*pName))</span>
<a href="#l32.793"></a><span id="l32.793" class="difflineminus">-    return NS_OK;</span>
<a href="#l32.794"></a><span id="l32.794" class="difflineplus">+  if (!pName || !(*pName)) return NS_OK;</span>
<a href="#l32.795"></a><span id="l32.795"> </span>
<a href="#l32.796"></a><span id="l32.796">   nsresult rv = NS_ERROR_FAILURE;</span>
<a href="#l32.797"></a><span id="l32.797">   // Make sure we have db to work with.</span>
<a href="#l32.798"></a><span id="l32.798" class="difflineminus">-  if (!pDb)</span>
<a href="#l32.799"></a><span id="l32.799" class="difflineminus">-    return rv;</span>
<a href="#l32.800"></a><span id="l32.800" class="difflineplus">+  if (!pDb) return rv;</span>
<a href="#l32.801"></a><span id="l32.801"> </span>
<a href="#l32.802"></a><span id="l32.802" class="difflineminus">-  nsCOMPtr &lt;nsIMdbRow&gt; newListRow;</span>
<a href="#l32.803"></a><span id="l32.803" class="difflineplus">+  nsCOMPtr&lt;nsIMdbRow&gt; newListRow;</span>
<a href="#l32.804"></a><span id="l32.804">   rv = pDb-&gt;GetNewListRow(getter_AddRefs(newListRow));</span>
<a href="#l32.805"></a><span id="l32.805">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.806"></a><span id="l32.806">   nsAutoCString column;</span>
<a href="#l32.807"></a><span id="l32.807">   LossyCopyUTF16toASCII(nsDependentString(pName), column);</span>
<a href="#l32.808"></a><span id="l32.808">   rv = pDb-&gt;AddListName(newListRow, column.get());</span>
<a href="#l32.809"></a><span id="l32.809">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.810"></a><span id="l32.810"> </span>
<a href="#l32.811"></a><span id="l32.811" class="difflineminus">-  HRESULT             hr;</span>
<a href="#l32.812"></a><span id="l32.812" class="difflineplus">+  HRESULT hr;</span>
<a href="#l32.813"></a><span id="l32.813">   LPSPropValue value = NULL;</span>
<a href="#l32.814"></a><span id="l32.814">   ULONG valueCount = 0;</span>
<a href="#l32.815"></a><span id="l32.815"> </span>
<a href="#l32.816"></a><span id="l32.816">   LPSPropTagArray properties = NULL;</span>
<a href="#l32.817"></a><span id="l32.817" class="difflineminus">-  m_mapi.MAPIAllocateBuffer(CbNewSPropTagArray(1),</span>
<a href="#l32.818"></a><span id="l32.818" class="difflineminus">-    (void **)&amp;properties);</span>
<a href="#l32.819"></a><span id="l32.819" class="difflineplus">+  m_mapi.MAPIAllocateBuffer(CbNewSPropTagArray(1), (void **)&amp;properties);</span>
<a href="#l32.820"></a><span id="l32.820">   properties-&gt;cValues = 1;</span>
<a href="#l32.821"></a><span id="l32.821" class="difflineminus">-  properties-&gt;aulPropTag [0] = m_mapi.GetEmailPropertyTag(pUserList, 0x8054);</span>
<a href="#l32.822"></a><span id="l32.822" class="difflineplus">+  properties-&gt;aulPropTag[0] = m_mapi.GetEmailPropertyTag(pUserList, 0x8054);</span>
<a href="#l32.823"></a><span id="l32.823">   hr = pUserList-&gt;GetProps(properties, 0, &amp;valueCount, &amp;value);</span>
<a href="#l32.824"></a><span id="l32.824">   m_mapi.MAPIFreeBuffer(properties);</span>
<a href="#l32.825"></a><span id="l32.825" class="difflineminus">-  if (HR_FAILED(hr))</span>
<a href="#l32.826"></a><span id="l32.826" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l32.827"></a><span id="l32.827" class="difflineminus">-  if (!value)</span>
<a href="#l32.828"></a><span id="l32.828" class="difflineminus">-    return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l32.829"></a><span id="l32.829" class="difflineplus">+  if (HR_FAILED(hr)) return NS_ERROR_FAILURE;</span>
<a href="#l32.830"></a><span id="l32.830" class="difflineplus">+  if (!value) return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l32.831"></a><span id="l32.831">   // XXX from here out, value must be freed with MAPIFreeBuffer</span>
<a href="#l32.832"></a><span id="l32.832"> </span>
<a href="#l32.833"></a><span id="l32.833" class="difflineminus">-  SBinaryArray *sa=(SBinaryArray *)&amp;value-&gt;Value.bin;</span>
<a href="#l32.834"></a><span id="l32.834" class="difflineplus">+  SBinaryArray *sa = (SBinaryArray *)&amp;value-&gt;Value.bin;</span>
<a href="#l32.835"></a><span id="l32.835">   if (!sa || !sa-&gt;lpbin) {</span>
<a href="#l32.836"></a><span id="l32.836">     m_mapi.MAPIFreeBuffer(value);</span>
<a href="#l32.837"></a><span id="l32.837">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l32.838"></a><span id="l32.838">   }</span>
<a href="#l32.839"></a><span id="l32.839"> </span>
<a href="#l32.840"></a><span id="l32.840" class="difflineminus">-  LPENTRYID    lpEid;</span>
<a href="#l32.841"></a><span id="l32.841" class="difflineminus">-  ULONG        cbEid;</span>
<a href="#l32.842"></a><span id="l32.842" class="difflineminus">-  ULONG        idx;</span>
<a href="#l32.843"></a><span id="l32.843" class="difflineminus">-  LPMESSAGE    lpMsg;</span>
<a href="#l32.844"></a><span id="l32.844" class="difflineminus">-  nsCString    type;</span>
<a href="#l32.845"></a><span id="l32.845" class="difflineplus">+  LPENTRYID lpEid;</span>
<a href="#l32.846"></a><span id="l32.846" class="difflineplus">+  ULONG cbEid;</span>
<a href="#l32.847"></a><span id="l32.847" class="difflineplus">+  ULONG idx;</span>
<a href="#l32.848"></a><span id="l32.848" class="difflineplus">+  LPMESSAGE lpMsg;</span>
<a href="#l32.849"></a><span id="l32.849" class="difflineplus">+  nsCString type;</span>
<a href="#l32.850"></a><span id="l32.850">   LPSPropValue pVal;</span>
<a href="#l32.851"></a><span id="l32.851" class="difflineminus">-  nsString     subject;</span>
<a href="#l32.852"></a><span id="l32.852" class="difflineminus">-  ULONG        total;</span>
<a href="#l32.853"></a><span id="l32.853" class="difflineplus">+  nsString subject;</span>
<a href="#l32.854"></a><span id="l32.854" class="difflineplus">+  ULONG total;</span>
<a href="#l32.855"></a><span id="l32.855"> </span>
<a href="#l32.856"></a><span id="l32.856">   total = sa-&gt;cValues;</span>
<a href="#l32.857"></a><span id="l32.857" class="difflineminus">-  for (idx = 0; idx &lt; total; idx++)</span>
<a href="#l32.858"></a><span id="l32.858" class="difflineminus">-  {</span>
<a href="#l32.859"></a><span id="l32.859" class="difflineminus">-    lpEid= (LPENTRYID) sa-&gt;lpbin[idx].lpb;</span>
<a href="#l32.860"></a><span id="l32.860" class="difflineplus">+  for (idx = 0; idx &lt; total; idx++) {</span>
<a href="#l32.861"></a><span id="l32.861" class="difflineplus">+    lpEid = (LPENTRYID)sa-&gt;lpbin[idx].lpb;</span>
<a href="#l32.862"></a><span id="l32.862">     cbEid = sa-&gt;lpbin[idx].cb;</span>
<a href="#l32.863"></a><span id="l32.863"> </span>
<a href="#l32.864"></a><span id="l32.864" class="difflineminus">-    if (!m_mapi.OpenEntry(cbEid, lpEid, (LPUNKNOWN *) &amp;lpMsg))</span>
<a href="#l32.865"></a><span id="l32.865" class="difflineminus">-    {</span>
<a href="#l32.866"></a><span id="l32.866" class="difflineminus">-</span>
<a href="#l32.867"></a><span id="l32.867" class="difflineplus">+    if (!m_mapi.OpenEntry(cbEid, lpEid, (LPUNKNOWN *)&amp;lpMsg)) {</span>
<a href="#l32.868"></a><span id="l32.868">       IMPORT_LOG1(&quot;*** Error opening messages in mailbox: %S\n&quot;, pName);</span>
<a href="#l32.869"></a><span id="l32.869">       m_mapi.MAPIFreeBuffer(value);</span>
<a href="#l32.870"></a><span id="l32.870">       return NS_ERROR_FAILURE;</span>
<a href="#l32.871"></a><span id="l32.871">     }</span>
<a href="#l32.872"></a><span id="l32.872">     // This is a contact, add it to the address book!</span>
<a href="#l32.873"></a><span id="l32.873">     subject.Truncate();</span>
<a href="#l32.874"></a><span id="l32.874">     pVal = m_mapi.GetMapiProperty(lpMsg, PR_SUBJECT);</span>
<a href="#l32.875"></a><span id="l32.875" class="difflineminus">-    if (pVal)</span>
<a href="#l32.876"></a><span id="l32.876" class="difflineminus">-      m_mapi.GetStringFromProp(pVal, subject);</span>
<a href="#l32.877"></a><span id="l32.877" class="difflineplus">+    if (pVal) m_mapi.GetStringFromProp(pVal, subject);</span>
<a href="#l32.878"></a><span id="l32.878"> </span>
<a href="#l32.879"></a><span id="l32.879" class="difflineminus">-    nsCOMPtr &lt;nsIMdbRow&gt; newRow;</span>
<a href="#l32.880"></a><span id="l32.880" class="difflineminus">-    nsCOMPtr &lt;nsIMdbRow&gt; oldRow;</span>
<a href="#l32.881"></a><span id="l32.881" class="difflineplus">+    nsCOMPtr&lt;nsIMdbRow&gt; newRow;</span>
<a href="#l32.882"></a><span id="l32.882" class="difflineplus">+    nsCOMPtr&lt;nsIMdbRow&gt; oldRow;</span>
<a href="#l32.883"></a><span id="l32.883">     pDb-&gt;GetNewRow(getter_AddRefs(newRow));</span>
<a href="#l32.884"></a><span id="l32.884">     if (newRow) {</span>
<a href="#l32.885"></a><span id="l32.885" class="difflineminus">-      if (BuildCard(subject.get(), pDb, newRow, lpMsg, pFieldMap))</span>
<a href="#l32.886"></a><span id="l32.886" class="difflineminus">-      {</span>
<a href="#l32.887"></a><span id="l32.887" class="difflineminus">-        nsCOMPtr &lt;nsIAbCard&gt; userCard;</span>
<a href="#l32.888"></a><span id="l32.888" class="difflineminus">-        nsCOMPtr &lt;nsIAbCard&gt; newCard;</span>
<a href="#l32.889"></a><span id="l32.889" class="difflineplus">+      if (BuildCard(subject.get(), pDb, newRow, lpMsg, pFieldMap)) {</span>
<a href="#l32.890"></a><span id="l32.890" class="difflineplus">+        nsCOMPtr&lt;nsIAbCard&gt; userCard;</span>
<a href="#l32.891"></a><span id="l32.891" class="difflineplus">+        nsCOMPtr&lt;nsIAbCard&gt; newCard;</span>
<a href="#l32.892"></a><span id="l32.892">         userCard = do_CreateInstance(NS_ABMDBCARD_CONTRACTID, &amp;rv);</span>
<a href="#l32.893"></a><span id="l32.893">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.894"></a><span id="l32.894" class="difflineminus">-        pDb-&gt;InitCardFromRow(userCard,newRow);</span>
<a href="#l32.895"></a><span id="l32.895" class="difflineplus">+        pDb-&gt;InitCardFromRow(userCard, newRow);</span>
<a href="#l32.896"></a><span id="l32.896"> </span>
<a href="#l32.897"></a><span id="l32.897" class="difflineminus">-        //add card to db</span>
<a href="#l32.898"></a><span id="l32.898" class="difflineminus">-        pDb-&gt;FindRowByCard(userCard,getter_AddRefs(oldRow));</span>
<a href="#l32.899"></a><span id="l32.899" class="difflineplus">+        // add card to db</span>
<a href="#l32.900"></a><span id="l32.900" class="difflineplus">+        pDb-&gt;FindRowByCard(userCard, getter_AddRefs(oldRow));</span>
<a href="#l32.901"></a><span id="l32.901">         if (oldRow)</span>
<a href="#l32.902"></a><span id="l32.902">           newRow = oldRow;</span>
<a href="#l32.903"></a><span id="l32.903">         else</span>
<a href="#l32.904"></a><span id="l32.904">           pDb-&gt;AddCardRowToDB(newRow);</span>
<a href="#l32.905"></a><span id="l32.905"> </span>
<a href="#l32.906"></a><span id="l32.906" class="difflineminus">-        //add card list</span>
<a href="#l32.907"></a><span id="l32.907" class="difflineminus">-        pDb-&gt;AddListCardColumnsToRow(userCard,</span>
<a href="#l32.908"></a><span id="l32.908" class="difflineminus">-                                     newListRow,idx+1, getter_AddRefs(newCard),</span>
<a href="#l32.909"></a><span id="l32.909" class="difflineminus">-                                     true, nullptr, nullptr);</span>
<a href="#l32.910"></a><span id="l32.910" class="difflineplus">+        // add card list</span>
<a href="#l32.911"></a><span id="l32.911" class="difflineplus">+        pDb-&gt;AddListCardColumnsToRow(userCard, newListRow, idx + 1,</span>
<a href="#l32.912"></a><span id="l32.912" class="difflineplus">+                                     getter_AddRefs(newCard), true, nullptr,</span>
<a href="#l32.913"></a><span id="l32.913" class="difflineplus">+                                     nullptr);</span>
<a href="#l32.914"></a><span id="l32.914">       }</span>
<a href="#l32.915"></a><span id="l32.915">     }</span>
<a href="#l32.916"></a><span id="l32.916">   }</span>
<a href="#l32.917"></a><span id="l32.917">   m_mapi.MAPIFreeBuffer(value);</span>
<a href="#l32.918"></a><span id="l32.918"> </span>
<a href="#l32.919"></a><span id="l32.919">   rv = pDb-&gt;AddCardRowToDB(newListRow);</span>
<a href="#l32.920"></a><span id="l32.920">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.921"></a><span id="l32.921"> </span>
<a href="#l32.922"></a><span id="l32.922">   rv = pDb-&gt;SetListAddressTotal(newListRow, (uint32_t)total);</span>
<a href="#l32.923"></a><span id="l32.923">   rv = pDb-&gt;AddListDirNode(newListRow);</span>
<a href="#l32.924"></a><span id="l32.924">   return rv;</span>
<a href="#l32.925"></a><span id="l32.925"> }</span>
<a href="#l32.926"></a><span id="l32.926"> </span>
<a href="#l32.927"></a><span id="l32.927" class="difflineminus">-void nsOutlookMail::SanitizeValue(nsString&amp; val)</span>
<a href="#l32.928"></a><span id="l32.928" class="difflineminus">-{</span>
<a href="#l32.929"></a><span id="l32.929" class="difflineplus">+void nsOutlookMail::SanitizeValue(nsString &amp;val) {</span>
<a href="#l32.930"></a><span id="l32.930">   MsgReplaceSubstring(val, NS_LITERAL_STRING(&quot;\r\n&quot;), NS_LITERAL_STRING(&quot;, &quot;));</span>
<a href="#l32.931"></a><span id="l32.931">   MsgReplaceChar(val, &quot;\r\n&quot;, ',');</span>
<a href="#l32.932"></a><span id="l32.932"> }</span>
<a href="#l32.933"></a><span id="l32.933"> </span>
<a href="#l32.934"></a><span id="l32.934" class="difflineminus">-void nsOutlookMail::SplitString(nsString&amp; val1, nsString&amp; val2)</span>
<a href="#l32.935"></a><span id="l32.935" class="difflineminus">-{</span>
<a href="#l32.936"></a><span id="l32.936" class="difflineplus">+void nsOutlookMail::SplitString(nsString &amp;val1, nsString &amp;val2) {</span>
<a href="#l32.937"></a><span id="l32.937">   // Find the last line if there is more than one!</span>
<a href="#l32.938"></a><span id="l32.938">   int32_t idx = val1.RFind(&quot;\x0D\x0A&quot;);</span>
<a href="#l32.939"></a><span id="l32.939" class="difflineminus">-  int32_t  cnt = 2;</span>
<a href="#l32.940"></a><span id="l32.940" class="difflineplus">+  int32_t cnt = 2;</span>
<a href="#l32.941"></a><span id="l32.941">   if (idx == -1) {</span>
<a href="#l32.942"></a><span id="l32.942">     cnt = 1;</span>
<a href="#l32.943"></a><span id="l32.943">     idx = val1.RFindChar(13);</span>
<a href="#l32.944"></a><span id="l32.944">   }</span>
<a href="#l32.945"></a><span id="l32.945" class="difflineminus">-  if (idx == -1)</span>
<a href="#l32.946"></a><span id="l32.946" class="difflineminus">-    idx= val1.RFindChar(10);</span>
<a href="#l32.947"></a><span id="l32.947" class="difflineplus">+  if (idx == -1) idx = val1.RFindChar(10);</span>
<a href="#l32.948"></a><span id="l32.948">   if (idx != -1) {</span>
<a href="#l32.949"></a><span id="l32.949">     val2 = Substring(val1, idx + cnt);</span>
<a href="#l32.950"></a><span id="l32.950">     val1.SetLength(idx);</span>
<a href="#l32.951"></a><span id="l32.951">     SanitizeValue(val1);</span>
<a href="#l32.952"></a><span id="l32.952">   }</span>
<a href="#l32.953"></a><span id="l32.953"> }</span>
<a href="#l32.954"></a><span id="l32.954"> </span>
<a href="#l32.955"></a><span id="l32.955" class="difflineminus">-bool nsOutlookMail::BuildCard(const char16_t *pName, nsIAddrDatabase *pDb, nsIMdbRow *newRow, LPMAPIPROP pUser, nsIImportFieldMap *pFieldMap)</span>
<a href="#l32.956"></a><span id="l32.956" class="difflineminus">-{</span>
<a href="#l32.957"></a><span id="l32.957" class="difflineplus">+bool nsOutlookMail::BuildCard(const char16_t *pName, nsIAddrDatabase *pDb,</span>
<a href="#l32.958"></a><span id="l32.958" class="difflineplus">+                              nsIMdbRow *newRow, LPMAPIPROP pUser,</span>
<a href="#l32.959"></a><span id="l32.959" class="difflineplus">+                              nsIImportFieldMap *pFieldMap) {</span>
<a href="#l32.960"></a><span id="l32.960" class="difflineplus">+  nsString lastName;</span>
<a href="#l32.961"></a><span id="l32.961" class="difflineplus">+  nsString firstName;</span>
<a href="#l32.962"></a><span id="l32.962" class="difflineplus">+  nsString eMail;</span>
<a href="#l32.963"></a><span id="l32.963" class="difflineplus">+  nsString nickName;</span>
<a href="#l32.964"></a><span id="l32.964" class="difflineplus">+  nsString middleName;</span>
<a href="#l32.965"></a><span id="l32.965" class="difflineplus">+  nsString secondEMail;</span>
<a href="#l32.966"></a><span id="l32.966" class="difflineplus">+  ULONG emailTag;</span>
<a href="#l32.967"></a><span id="l32.967"> </span>
<a href="#l32.968"></a><span id="l32.968" class="difflineminus">-  nsString    lastName;</span>
<a href="#l32.969"></a><span id="l32.969" class="difflineminus">-  nsString    firstName;</span>
<a href="#l32.970"></a><span id="l32.970" class="difflineminus">-  nsString    eMail;</span>
<a href="#l32.971"></a><span id="l32.971" class="difflineminus">-  nsString    nickName;</span>
<a href="#l32.972"></a><span id="l32.972" class="difflineminus">-  nsString    middleName;</span>
<a href="#l32.973"></a><span id="l32.973" class="difflineminus">-  nsString    secondEMail;</span>
<a href="#l32.974"></a><span id="l32.974" class="difflineminus">-  ULONG       emailTag;</span>
<a href="#l32.975"></a><span id="l32.975" class="difflineminus">-</span>
<a href="#l32.976"></a><span id="l32.976" class="difflineminus">-  LPSPropValue  pProp = m_mapi.GetMapiProperty(pUser, PR_EMAIL_ADDRESS);</span>
<a href="#l32.977"></a><span id="l32.977" class="difflineplus">+  LPSPropValue pProp = m_mapi.GetMapiProperty(pUser, PR_EMAIL_ADDRESS);</span>
<a href="#l32.978"></a><span id="l32.978">   if (!pProp) {</span>
<a href="#l32.979"></a><span id="l32.979">     emailTag = m_mapi.GetEmailPropertyTag(pUser, OUTLOOK_EMAIL1_MAPI_ID1);</span>
<a href="#l32.980"></a><span id="l32.980">     if (emailTag) {</span>
<a href="#l32.981"></a><span id="l32.981">       pProp = m_mapi.GetMapiProperty(pUser, emailTag);</span>
<a href="#l32.982"></a><span id="l32.982">     }</span>
<a href="#l32.983"></a><span id="l32.983">   }</span>
<a href="#l32.984"></a><span id="l32.984">   if (pProp) {</span>
<a href="#l32.985"></a><span id="l32.985">     m_mapi.GetStringFromProp(pProp, eMail);</span>
<a href="#l32.986"></a><span id="l32.986" class="difflineat">@@ -809,17 +779,17 @@ bool nsOutlookMail::BuildCard(const char</span>
<a href="#l32.987"></a><span id="l32.987">   if (pProp) {</span>
<a href="#l32.988"></a><span id="l32.988">     m_mapi.GetStringFromProp(pProp, nickName);</span>
<a href="#l32.989"></a><span id="l32.989">     SanitizeValue(nickName);</span>
<a href="#l32.990"></a><span id="l32.990">   }</span>
<a href="#l32.991"></a><span id="l32.991">   if (firstName.IsEmpty() &amp;&amp; lastName.IsEmpty()) {</span>
<a href="#l32.992"></a><span id="l32.992">     firstName = pName;</span>
<a href="#l32.993"></a><span id="l32.993">   }</span>
<a href="#l32.994"></a><span id="l32.994"> </span>
<a href="#l32.995"></a><span id="l32.995" class="difflineminus">-  nsString  displayName;</span>
<a href="#l32.996"></a><span id="l32.996" class="difflineplus">+  nsString displayName;</span>
<a href="#l32.997"></a><span id="l32.997">   pProp = m_mapi.GetMapiProperty(pUser, PR_DISPLAY_NAME);</span>
<a href="#l32.998"></a><span id="l32.998">   if (pProp) {</span>
<a href="#l32.999"></a><span id="l32.999">     m_mapi.GetStringFromProp(pProp, displayName);</span>
<a href="#l32.1000"></a><span id="l32.1000">     SanitizeValue(displayName);</span>
<a href="#l32.1001"></a><span id="l32.1001">   }</span>
<a href="#l32.1002"></a><span id="l32.1002">   if (displayName.IsEmpty()) {</span>
<a href="#l32.1003"></a><span id="l32.1003">     if (firstName.IsEmpty())</span>
<a href="#l32.1004"></a><span id="l32.1004">       displayName = pName;</span>
<a href="#l32.1005"></a><span id="l32.1005" class="difflineat">@@ -854,40 +824,42 @@ bool nsOutlookMail::BuildCard(const char</span>
<a href="#l32.1006"></a><span id="l32.1006">     pDb-&gt;AddPrimaryEmail(newRow, NS_ConvertUTF16toUTF8(eMail).get());</span>
<a href="#l32.1007"></a><span id="l32.1007">   }</span>
<a href="#l32.1008"></a><span id="l32.1008">   if (!secondEMail.IsEmpty()) {</span>
<a href="#l32.1009"></a><span id="l32.1009">     pDb-&gt;Add2ndEmail(newRow, NS_ConvertUTF16toUTF8(secondEMail).get());</span>
<a href="#l32.1010"></a><span id="l32.1010">   }</span>
<a href="#l32.1011"></a><span id="l32.1011"> </span>
<a href="#l32.1012"></a><span id="l32.1012">   // Do all of the extra fields!</span>
<a href="#l32.1013"></a><span id="l32.1013"> </span>
<a href="#l32.1014"></a><span id="l32.1014" class="difflineminus">-  nsString  value;</span>
<a href="#l32.1015"></a><span id="l32.1015" class="difflineminus">-  nsString  line2;</span>
<a href="#l32.1016"></a><span id="l32.1016" class="difflineplus">+  nsString value;</span>
<a href="#l32.1017"></a><span id="l32.1017" class="difflineplus">+  nsString line2;</span>
<a href="#l32.1018"></a><span id="l32.1018"> </span>
<a href="#l32.1019"></a><span id="l32.1019">   if (pFieldMap) {</span>
<a href="#l32.1020"></a><span id="l32.1020">     int max = sizeof(gMapiFields) / sizeof(MAPIFields);</span>
<a href="#l32.1021"></a><span id="l32.1021">     for (int i = 0; i &lt; max; i++) {</span>
<a href="#l32.1022"></a><span id="l32.1022">       pProp = m_mapi.GetMapiProperty(pUser, gMapiFields[i].mapiTag);</span>
<a href="#l32.1023"></a><span id="l32.1023">       if (pProp) {</span>
<a href="#l32.1024"></a><span id="l32.1024">         m_mapi.GetStringFromProp(pProp, value);</span>
<a href="#l32.1025"></a><span id="l32.1025">         if (!value.IsEmpty()) {</span>
<a href="#l32.1026"></a><span id="l32.1026">           if (gMapiFields[i].multiLine == kNoMultiLine) {</span>
<a href="#l32.1027"></a><span id="l32.1027">             SanitizeValue(value);</span>
<a href="#l32.1028"></a><span id="l32.1028" class="difflineminus">-            pFieldMap-&gt;SetFieldValue(pDb, newRow, gMapiFields[i].mozField, value.get());</span>
<a href="#l32.1029"></a><span id="l32.1029" class="difflineminus">-          }</span>
<a href="#l32.1030"></a><span id="l32.1030" class="difflineminus">-          else if (gMapiFields[i].multiLine == kIsMultiLine) {</span>
<a href="#l32.1031"></a><span id="l32.1031" class="difflineminus">-            pFieldMap-&gt;SetFieldValue(pDb, newRow, gMapiFields[i].mozField, value.get());</span>
<a href="#l32.1032"></a><span id="l32.1032" class="difflineminus">-          }</span>
<a href="#l32.1033"></a><span id="l32.1033" class="difflineminus">-          else {</span>
<a href="#l32.1034"></a><span id="l32.1034" class="difflineplus">+            pFieldMap-&gt;SetFieldValue(pDb, newRow, gMapiFields[i].mozField,</span>
<a href="#l32.1035"></a><span id="l32.1035" class="difflineplus">+                                     value.get());</span>
<a href="#l32.1036"></a><span id="l32.1036" class="difflineplus">+          } else if (gMapiFields[i].multiLine == kIsMultiLine) {</span>
<a href="#l32.1037"></a><span id="l32.1037" class="difflineplus">+            pFieldMap-&gt;SetFieldValue(pDb, newRow, gMapiFields[i].mozField,</span>
<a href="#l32.1038"></a><span id="l32.1038" class="difflineplus">+                                     value.get());</span>
<a href="#l32.1039"></a><span id="l32.1039" class="difflineplus">+          } else {</span>
<a href="#l32.1040"></a><span id="l32.1040">             line2.Truncate();</span>
<a href="#l32.1041"></a><span id="l32.1041">             SplitString(value, line2);</span>
<a href="#l32.1042"></a><span id="l32.1042">             if (!value.IsEmpty())</span>
<a href="#l32.1043"></a><span id="l32.1043" class="difflineminus">-              pFieldMap-&gt;SetFieldValue(pDb, newRow, gMapiFields[i].mozField, value.get());</span>
<a href="#l32.1044"></a><span id="l32.1044" class="difflineplus">+              pFieldMap-&gt;SetFieldValue(pDb, newRow, gMapiFields[i].mozField,</span>
<a href="#l32.1045"></a><span id="l32.1045" class="difflineplus">+                                       value.get());</span>
<a href="#l32.1046"></a><span id="l32.1046">             if (!line2.IsEmpty())</span>
<a href="#l32.1047"></a><span id="l32.1047" class="difflineminus">-              pFieldMap-&gt;SetFieldValue(pDb, newRow, gMapiFields[i].multiLine, line2.get());</span>
<a href="#l32.1048"></a><span id="l32.1048" class="difflineplus">+              pFieldMap-&gt;SetFieldValue(pDb, newRow, gMapiFields[i].multiLine,</span>
<a href="#l32.1049"></a><span id="l32.1049" class="difflineplus">+                                       line2.get());</span>
<a href="#l32.1050"></a><span id="l32.1050">           }</span>
<a href="#l32.1051"></a><span id="l32.1051">         }</span>
<a href="#l32.1052"></a><span id="l32.1052">       }</span>
<a href="#l32.1053"></a><span id="l32.1053">     }</span>
<a href="#l32.1054"></a><span id="l32.1054">   }</span>
<a href="#l32.1055"></a><span id="l32.1055"> </span>
<a href="#l32.1056"></a><span id="l32.1056">   return true;</span>
<a href="#l32.1057"></a><span id="l32.1057"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/mailnews/import/outlook/src/nsOutlookMail.h</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/mailnews/import/outlook/src/nsOutlookMail.h</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -14,67 +14,69 @@</span>
<a href="#l33.4"></a><span id="l33.4"> #include &quot;MapiMessage.h&quot;</span>
<a href="#l33.5"></a><span id="l33.5"> #include &quot;nsIAddrDatabase.h&quot;</span>
<a href="#l33.6"></a><span id="l33.6"> #include &quot;nsThreadUtils.h&quot;</span>
<a href="#l33.7"></a><span id="l33.7"> </span>
<a href="#l33.8"></a><span id="l33.8"> class nsIAddrDatabase;</span>
<a href="#l33.9"></a><span id="l33.9"> class nsIImportFieldMap;</span>
<a href="#l33.10"></a><span id="l33.10"> </span>
<a href="#l33.11"></a><span id="l33.11"> class nsOutlookMail {</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-public:</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+ public:</span>
<a href="#l33.14"></a><span id="l33.14">   nsOutlookMail();</span>
<a href="#l33.15"></a><span id="l33.15">   ~nsOutlookMail();</span>
<a href="#l33.16"></a><span id="l33.16"> </span>
<a href="#l33.17"></a><span id="l33.17">   nsresult GetMailFolders(nsIArray **pArray);</span>
<a href="#l33.18"></a><span id="l33.18">   nsresult GetAddressBooks(nsIArray **pArray);</span>
<a href="#l33.19"></a><span id="l33.19">   nsresult ImportMailbox(uint32_t *pDoneSoFar, bool *pAbort, int32_t index,</span>
<a href="#l33.20"></a><span id="l33.20">                          const char16_t *pName, nsIMsgFolder *pDest,</span>
<a href="#l33.21"></a><span id="l33.21">                          int32_t *pMsgCount);</span>
<a href="#l33.22"></a><span id="l33.22" class="difflineminus">-  nsresult ImportAddresses(uint32_t *pCount, uint32_t *pTotal, const char16_t *pName, uint32_t id, nsIAddrDatabase *pDb, nsString&amp; errors);</span>
<a href="#l33.23"></a><span id="l33.23" class="difflineminus">-  void  OpenMessageStore(CMapiFolder *pNextFolder);</span>
<a href="#l33.24"></a><span id="l33.24" class="difflineminus">-  static BOOL  WriteData(nsIOutputStream *pDest, const char *pData, int32_t len);</span>
<a href="#l33.25"></a><span id="l33.25" class="difflineminus">-</span>
<a href="#l33.26"></a><span id="l33.26" class="difflineminus">-private:</span>
<a href="#l33.27"></a><span id="l33.27" class="difflineminus">-  bool      IsAddressBookNameUnique(nsString&amp; name, nsString&amp; list);</span>
<a href="#l33.28"></a><span id="l33.28" class="difflineminus">-  void      MakeAddressBookNameUnique(nsString&amp; name, nsString&amp; list);</span>
<a href="#l33.29"></a><span id="l33.29" class="difflineminus">-  void      SanitizeValue(nsString&amp; val);</span>
<a href="#l33.30"></a><span id="l33.30" class="difflineminus">-  void      SplitString(nsString&amp; val1, nsString&amp; val2);</span>
<a href="#l33.31"></a><span id="l33.31" class="difflineminus">-  bool      BuildCard(const char16_t *pName, nsIAddrDatabase *pDb, nsIMdbRow *newRow, LPMAPIPROP pUser, nsIImportFieldMap *pFieldMap);</span>
<a href="#l33.32"></a><span id="l33.32" class="difflineminus">-  nsresult  CreateList(const char16_t * pName, nsIAddrDatabase *pDb, LPMAPIPROP pUserList, nsIImportFieldMap *pFieldMap);</span>
<a href="#l33.33"></a><span id="l33.33" class="difflineplus">+  nsresult ImportAddresses(uint32_t *pCount, uint32_t *pTotal,</span>
<a href="#l33.34"></a><span id="l33.34" class="difflineplus">+                           const char16_t *pName, uint32_t id,</span>
<a href="#l33.35"></a><span id="l33.35" class="difflineplus">+                           nsIAddrDatabase *pDb, nsString &amp;errors);</span>
<a href="#l33.36"></a><span id="l33.36" class="difflineplus">+  void OpenMessageStore(CMapiFolder *pNextFolder);</span>
<a href="#l33.37"></a><span id="l33.37" class="difflineplus">+  static BOOL WriteData(nsIOutputStream *pDest, const char *pData, int32_t len);</span>
<a href="#l33.38"></a><span id="l33.38"> </span>
<a href="#l33.39"></a><span id="l33.39" class="difflineminus">-private:</span>
<a href="#l33.40"></a><span id="l33.40" class="difflineminus">-  bool              m_gotFolders;</span>
<a href="#l33.41"></a><span id="l33.41" class="difflineminus">-  bool              m_gotAddresses;</span>
<a href="#l33.42"></a><span id="l33.42" class="difflineminus">-  bool              m_haveMapi;</span>
<a href="#l33.43"></a><span id="l33.43" class="difflineminus">-  CMapiFolderList   m_addressList;</span>
<a href="#l33.44"></a><span id="l33.44" class="difflineminus">-  CMapiFolderList   m_storeList;</span>
<a href="#l33.45"></a><span id="l33.45" class="difflineplus">+ private:</span>
<a href="#l33.46"></a><span id="l33.46" class="difflineplus">+  bool IsAddressBookNameUnique(nsString &amp;name, nsString &amp;list);</span>
<a href="#l33.47"></a><span id="l33.47" class="difflineplus">+  void MakeAddressBookNameUnique(nsString &amp;name, nsString &amp;list);</span>
<a href="#l33.48"></a><span id="l33.48" class="difflineplus">+  void SanitizeValue(nsString &amp;val);</span>
<a href="#l33.49"></a><span id="l33.49" class="difflineplus">+  void SplitString(nsString &amp;val1, nsString &amp;val2);</span>
<a href="#l33.50"></a><span id="l33.50" class="difflineplus">+  bool BuildCard(const char16_t *pName, nsIAddrDatabase *pDb, nsIMdbRow *newRow,</span>
<a href="#l33.51"></a><span id="l33.51" class="difflineplus">+                 LPMAPIPROP pUser, nsIImportFieldMap *pFieldMap);</span>
<a href="#l33.52"></a><span id="l33.52" class="difflineplus">+  nsresult CreateList(const char16_t *pName, nsIAddrDatabase *pDb,</span>
<a href="#l33.53"></a><span id="l33.53" class="difflineplus">+                      LPMAPIPROP pUserList, nsIImportFieldMap *pFieldMap);</span>
<a href="#l33.54"></a><span id="l33.54"> </span>
<a href="#l33.55"></a><span id="l33.55" class="difflineminus">-public:</span>
<a href="#l33.56"></a><span id="l33.56" class="difflineplus">+ private:</span>
<a href="#l33.57"></a><span id="l33.57" class="difflineplus">+  bool m_gotFolders;</span>
<a href="#l33.58"></a><span id="l33.58" class="difflineplus">+  bool m_gotAddresses;</span>
<a href="#l33.59"></a><span id="l33.59" class="difflineplus">+  bool m_haveMapi;</span>
<a href="#l33.60"></a><span id="l33.60" class="difflineplus">+  CMapiFolderList m_addressList;</span>
<a href="#l33.61"></a><span id="l33.61" class="difflineplus">+  CMapiFolderList m_storeList;</span>
<a href="#l33.62"></a><span id="l33.62" class="difflineplus">+</span>
<a href="#l33.63"></a><span id="l33.63" class="difflineplus">+ public:</span>
<a href="#l33.64"></a><span id="l33.64">   // Needed for the proxy class.</span>
<a href="#l33.65"></a><span id="l33.65" class="difflineminus">-  CMapiApi          m_mapi;</span>
<a href="#l33.66"></a><span id="l33.66" class="difflineminus">-  CMapiFolderList   m_folderList;</span>
<a href="#l33.67"></a><span id="l33.67" class="difflineminus">-  LPMDB             m_lpMdb;</span>
<a href="#l33.68"></a><span id="l33.68" class="difflineplus">+  CMapiApi m_mapi;</span>
<a href="#l33.69"></a><span id="l33.69" class="difflineplus">+  CMapiFolderList m_folderList;</span>
<a href="#l33.70"></a><span id="l33.70" class="difflineplus">+  LPMDB m_lpMdb;</span>
<a href="#l33.71"></a><span id="l33.71"> };</span>
<a href="#l33.72"></a><span id="l33.72"> </span>
<a href="#l33.73"></a><span id="l33.73" class="difflineminus">-class ImportMailboxRunnable: public mozilla::Runnable</span>
<a href="#l33.74"></a><span id="l33.74" class="difflineminus">-{</span>
<a href="#l33.75"></a><span id="l33.75" class="difflineminus">-public:</span>
<a href="#l33.76"></a><span id="l33.76" class="difflineminus">-  ImportMailboxRunnable(uint32_t *pDoneSoFar, bool *pAbort,</span>
<a href="#l33.77"></a><span id="l33.77" class="difflineminus">-                        int32_t index, const char16_t *pName,</span>
<a href="#l33.78"></a><span id="l33.78" class="difflineminus">-                        nsIMsgFolder *dstFolder,</span>
<a href="#l33.79"></a><span id="l33.79" class="difflineminus">-                        int32_t *pMsgCount,</span>
<a href="#l33.80"></a><span id="l33.80" class="difflineminus">-                        nsOutlookMail *aCaller);</span>
<a href="#l33.81"></a><span id="l33.81" class="difflineplus">+class ImportMailboxRunnable : public mozilla::Runnable {</span>
<a href="#l33.82"></a><span id="l33.82" class="difflineplus">+ public:</span>
<a href="#l33.83"></a><span id="l33.83" class="difflineplus">+  ImportMailboxRunnable(uint32_t *pDoneSoFar, bool *pAbort, int32_t index,</span>
<a href="#l33.84"></a><span id="l33.84" class="difflineplus">+                        const char16_t *pName, nsIMsgFolder *dstFolder,</span>
<a href="#l33.85"></a><span id="l33.85" class="difflineplus">+                        int32_t *pMsgCount, nsOutlookMail *aCaller);</span>
<a href="#l33.86"></a><span id="l33.86">   NS_DECL_NSIRUNNABLE</span>
<a href="#l33.87"></a><span id="l33.87" class="difflineminus">-  static nsresult ImportMessage(LPMESSAGE lpMsg, nsIOutputStream *pDest, nsMsgDeliverMode mode);</span>
<a href="#l33.88"></a><span id="l33.88" class="difflineminus">-  nsresult          mResult;</span>
<a href="#l33.89"></a><span id="l33.89" class="difflineplus">+  static nsresult ImportMessage(LPMESSAGE lpMsg, nsIOutputStream *pDest,</span>
<a href="#l33.90"></a><span id="l33.90" class="difflineplus">+                                nsMsgDeliverMode mode);</span>
<a href="#l33.91"></a><span id="l33.91" class="difflineplus">+  nsresult mResult;</span>
<a href="#l33.92"></a><span id="l33.92"> </span>
<a href="#l33.93"></a><span id="l33.93" class="difflineminus">-private:</span>
<a href="#l33.94"></a><span id="l33.94" class="difflineminus">-  nsOutlookMail     *mCaller;</span>
<a href="#l33.95"></a><span id="l33.95" class="difflineminus">-  uint32_t          *mDoneSoFar;</span>
<a href="#l33.96"></a><span id="l33.96" class="difflineminus">-  bool              *mAbort;</span>
<a href="#l33.97"></a><span id="l33.97" class="difflineminus">-  int32_t           mIndex;</span>
<a href="#l33.98"></a><span id="l33.98" class="difflineminus">-  const char16_t    *mName;</span>
<a href="#l33.99"></a><span id="l33.99" class="difflineplus">+ private:</span>
<a href="#l33.100"></a><span id="l33.100" class="difflineplus">+  nsOutlookMail *mCaller;</span>
<a href="#l33.101"></a><span id="l33.101" class="difflineplus">+  uint32_t *mDoneSoFar;</span>
<a href="#l33.102"></a><span id="l33.102" class="difflineplus">+  bool *mAbort;</span>
<a href="#l33.103"></a><span id="l33.103" class="difflineplus">+  int32_t mIndex;</span>
<a href="#l33.104"></a><span id="l33.104" class="difflineplus">+  const char16_t *mName;</span>
<a href="#l33.105"></a><span id="l33.105">   nsCOMPtr&lt;nsIFile&gt; mMessageFile;</span>
<a href="#l33.106"></a><span id="l33.106">   nsCOMPtr&lt;nsIMsgFolder&gt; mDstFolder;</span>
<a href="#l33.107"></a><span id="l33.107" class="difflineminus">-  int32_t           *mMsgCount;</span>
<a href="#l33.108"></a><span id="l33.108" class="difflineplus">+  int32_t *mMsgCount;</span>
<a href="#l33.109"></a><span id="l33.109"> };</span>
<a href="#l33.110"></a><span id="l33.110"> </span>
<a href="#l33.111"></a><span id="l33.111"> #endif /* nsOutlookMail_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/mailnews/import/outlook/src/nsOutlookSettings.cpp</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/mailnews/import/outlook/src/nsOutlookSettings.cpp</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -24,185 +24,166 @@</span>
<a href="#l34.4"></a><span id="l34.4"> #include &quot;nsIPop3IncomingServer.h&quot;</span>
<a href="#l34.5"></a><span id="l34.5"> #include &quot;nsMsgI18N.h&quot;</span>
<a href="#l34.6"></a><span id="l34.6"> #include &lt;windows.h&gt;</span>
<a href="#l34.7"></a><span id="l34.7"> #include &quot;nsIWindowsRegKey.h&quot;</span>
<a href="#l34.8"></a><span id="l34.8"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l34.9"></a><span id="l34.9"> #include &quot;nsNativeCharsetUtils.h&quot;</span>
<a href="#l34.10"></a><span id="l34.10"> </span>
<a href="#l34.11"></a><span id="l34.11"> class OutlookSettings {</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-public:</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineplus">+ public:</span>
<a href="#l34.14"></a><span id="l34.14">   static nsresult FindAccountsKey(nsIWindowsRegKey **aKey);</span>
<a href="#l34.15"></a><span id="l34.15">   static nsresult QueryAccountSubKey(nsIWindowsRegKey **aKey);</span>
<a href="#l34.16"></a><span id="l34.16">   static nsresult GetDefaultMailAccountName(nsAString &amp;aName);</span>
<a href="#l34.17"></a><span id="l34.17"> </span>
<a href="#l34.18"></a><span id="l34.18">   static bool DoImport(nsIMsgAccount **aAccount);</span>
<a href="#l34.19"></a><span id="l34.19"> </span>
<a href="#l34.20"></a><span id="l34.20" class="difflineminus">-  static bool DoIMAPServer(nsIMsgAccountManager *aMgr,</span>
<a href="#l34.21"></a><span id="l34.21" class="difflineminus">-                           nsIWindowsRegKey *aKey,</span>
<a href="#l34.22"></a><span id="l34.22" class="difflineplus">+  static bool DoIMAPServer(nsIMsgAccountManager *aMgr, nsIWindowsRegKey *aKey,</span>
<a href="#l34.23"></a><span id="l34.23">                            const nsString &amp;aServerName,</span>
<a href="#l34.24"></a><span id="l34.24">                            nsIMsgAccount **aAccount);</span>
<a href="#l34.25"></a><span id="l34.25" class="difflineminus">-  static bool DoPOP3Server(nsIMsgAccountManager *aMgr,</span>
<a href="#l34.26"></a><span id="l34.26" class="difflineminus">-                           nsIWindowsRegKey *aKey,</span>
<a href="#l34.27"></a><span id="l34.27" class="difflineplus">+  static bool DoPOP3Server(nsIMsgAccountManager *aMgr, nsIWindowsRegKey *aKey,</span>
<a href="#l34.28"></a><span id="l34.28">                            const nsString &amp;aServerName,</span>
<a href="#l34.29"></a><span id="l34.29">                            nsIMsgAccount **aAccount);</span>
<a href="#l34.30"></a><span id="l34.30"> </span>
<a href="#l34.31"></a><span id="l34.31" class="difflineminus">-  static void SetIdentities(nsIMsgAccountManager *pMgr,</span>
<a href="#l34.32"></a><span id="l34.32" class="difflineminus">-                            nsIMsgAccount *pAcc,</span>
<a href="#l34.33"></a><span id="l34.33" class="difflineplus">+  static void SetIdentities(nsIMsgAccountManager *pMgr, nsIMsgAccount *pAcc,</span>
<a href="#l34.34"></a><span id="l34.34">                             nsIWindowsRegKey *aKey);</span>
<a href="#l34.35"></a><span id="l34.35"> </span>
<a href="#l34.36"></a><span id="l34.36" class="difflineminus">-  static nsresult SetSmtpServer(nsIMsgAccountManager *aMgr,</span>
<a href="#l34.37"></a><span id="l34.37" class="difflineminus">-                                nsIMsgAccount *aAcc,</span>
<a href="#l34.38"></a><span id="l34.38" class="difflineminus">-                                nsIMsgIdentity *aId,</span>
<a href="#l34.39"></a><span id="l34.39" class="difflineminus">-                                const nsString &amp;aServer,</span>
<a href="#l34.40"></a><span id="l34.40" class="difflineplus">+  static nsresult SetSmtpServer(nsIMsgAccountManager *aMgr, nsIMsgAccount *aAcc,</span>
<a href="#l34.41"></a><span id="l34.41" class="difflineplus">+                                nsIMsgIdentity *aId, const nsString &amp;aServer,</span>
<a href="#l34.42"></a><span id="l34.42">                                 const nsString &amp;aUser);</span>
<a href="#l34.43"></a><span id="l34.43" class="difflineminus">-  static nsresult SetSmtpServerKey(nsIMsgIdentity *aId,</span>
<a href="#l34.44"></a><span id="l34.44" class="difflineminus">-                                   nsISmtpServer *aServer);</span>
<a href="#l34.45"></a><span id="l34.45" class="difflineplus">+  static nsresult SetSmtpServerKey(nsIMsgIdentity *aId, nsISmtpServer *aServer);</span>
<a href="#l34.46"></a><span id="l34.46">   static nsresult GetAccountName(nsIWindowsRegKey *aKey,</span>
<a href="#l34.47"></a><span id="l34.47">                                  const nsString &amp;aDefaultName,</span>
<a href="#l34.48"></a><span id="l34.48">                                  nsAString &amp;aAccountName);</span>
<a href="#l34.49"></a><span id="l34.49"> };</span>
<a href="#l34.50"></a><span id="l34.50"> </span>
<a href="#l34.51"></a><span id="l34.51" class="difflineminus">-#define OUTLOOK2003_REGISTRY_KEY  &quot;Software\\Microsoft\\Office\\Outlook\\OMI Account Manager&quot;</span>
<a href="#l34.52"></a><span id="l34.52" class="difflineminus">-#define OUTLOOK98_REGISTRY_KEY  &quot;Software\\Microsoft\\Office\\8.0\\Outlook\\OMI Account Manager&quot;</span>
<a href="#l34.53"></a><span id="l34.53" class="difflineplus">+#define OUTLOOK2003_REGISTRY_KEY \</span>
<a href="#l34.54"></a><span id="l34.54" class="difflineplus">+  &quot;Software\\Microsoft\\Office\\Outlook\\OMI Account Manager&quot;</span>
<a href="#l34.55"></a><span id="l34.55" class="difflineplus">+#define OUTLOOK98_REGISTRY_KEY \</span>
<a href="#l34.56"></a><span id="l34.56" class="difflineplus">+  &quot;Software\\Microsoft\\Office\\8.0\\Outlook\\OMI Account Manager&quot;</span>
<a href="#l34.57"></a><span id="l34.57"> </span>
<a href="#l34.58"></a><span id="l34.58"> ////////////////////////////////////////////////////////////////////////</span>
<a href="#l34.59"></a><span id="l34.59" class="difflineminus">-nsresult nsOutlookSettings::Create(nsIImportSettings** aImport)</span>
<a href="#l34.60"></a><span id="l34.60" class="difflineminus">-{</span>
<a href="#l34.61"></a><span id="l34.61" class="difflineplus">+nsresult nsOutlookSettings::Create(nsIImportSettings **aImport) {</span>
<a href="#l34.62"></a><span id="l34.62">   NS_ENSURE_ARG_POINTER(aImport);</span>
<a href="#l34.63"></a><span id="l34.63">   NS_ADDREF(*aImport = new nsOutlookSettings());</span>
<a href="#l34.64"></a><span id="l34.64">   return NS_OK;</span>
<a href="#l34.65"></a><span id="l34.65"> }</span>
<a href="#l34.66"></a><span id="l34.66"> </span>
<a href="#l34.67"></a><span id="l34.67" class="difflineminus">-nsOutlookSettings::nsOutlookSettings()</span>
<a href="#l34.68"></a><span id="l34.68" class="difflineminus">-{</span>
<a href="#l34.69"></a><span id="l34.69" class="difflineminus">-}</span>
<a href="#l34.70"></a><span id="l34.70" class="difflineplus">+nsOutlookSettings::nsOutlookSettings() {}</span>
<a href="#l34.71"></a><span id="l34.71"> </span>
<a href="#l34.72"></a><span id="l34.72" class="difflineminus">-nsOutlookSettings::~nsOutlookSettings()</span>
<a href="#l34.73"></a><span id="l34.73" class="difflineminus">-{</span>
<a href="#l34.74"></a><span id="l34.74" class="difflineminus">-}</span>
<a href="#l34.75"></a><span id="l34.75" class="difflineplus">+nsOutlookSettings::~nsOutlookSettings() {}</span>
<a href="#l34.76"></a><span id="l34.76"> </span>
<a href="#l34.77"></a><span id="l34.77"> NS_IMPL_ISUPPORTS(nsOutlookSettings, nsIImportSettings)</span>
<a href="#l34.78"></a><span id="l34.78"> </span>
<a href="#l34.79"></a><span id="l34.79" class="difflineminus">-NS_IMETHODIMP nsOutlookSettings::AutoLocate(char16_t **description, nsIFile **location, bool *_retval)</span>
<a href="#l34.80"></a><span id="l34.80" class="difflineminus">-{</span>
<a href="#l34.81"></a><span id="l34.81" class="difflineminus">-    NS_ASSERTION(description != nullptr, &quot;null ptr&quot;);</span>
<a href="#l34.82"></a><span id="l34.82" class="difflineminus">-    NS_ASSERTION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l34.83"></a><span id="l34.83" class="difflineminus">-  if (!description || !_retval)</span>
<a href="#l34.84"></a><span id="l34.84" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l34.85"></a><span id="l34.85" class="difflineplus">+NS_IMETHODIMP nsOutlookSettings::AutoLocate(char16_t **description,</span>
<a href="#l34.86"></a><span id="l34.86" class="difflineplus">+                                            nsIFile **location, bool *_retval) {</span>
<a href="#l34.87"></a><span id="l34.87" class="difflineplus">+  NS_ASSERTION(description != nullptr, &quot;null ptr&quot;);</span>
<a href="#l34.88"></a><span id="l34.88" class="difflineplus">+  NS_ASSERTION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l34.89"></a><span id="l34.89" class="difflineplus">+  if (!description || !_retval) return NS_ERROR_NULL_POINTER;</span>
<a href="#l34.90"></a><span id="l34.90"> </span>
<a href="#l34.91"></a><span id="l34.91">   *description = nsOutlookStringBundle::GetStringByID(OUTLOOKIMPORT_NAME);</span>
<a href="#l34.92"></a><span id="l34.92">   *_retval = false;</span>
<a href="#l34.93"></a><span id="l34.93"> </span>
<a href="#l34.94"></a><span id="l34.94" class="difflineminus">-  if (location)</span>
<a href="#l34.95"></a><span id="l34.95" class="difflineminus">-    *location = nullptr;</span>
<a href="#l34.96"></a><span id="l34.96" class="difflineplus">+  if (location) *location = nullptr;</span>
<a href="#l34.97"></a><span id="l34.97"> </span>
<a href="#l34.98"></a><span id="l34.98">   // look for the registry key for the accounts</span>
<a href="#l34.99"></a><span id="l34.99">   nsCOMPtr&lt;nsIWindowsRegKey&gt; key;</span>
<a href="#l34.100"></a><span id="l34.100" class="difflineminus">-  *_retval = NS_SUCCEEDED(OutlookSettings::FindAccountsKey(getter_AddRefs(key)));</span>
<a href="#l34.101"></a><span id="l34.101" class="difflineplus">+  *_retval =</span>
<a href="#l34.102"></a><span id="l34.102" class="difflineplus">+      NS_SUCCEEDED(OutlookSettings::FindAccountsKey(getter_AddRefs(key)));</span>
<a href="#l34.103"></a><span id="l34.103"> </span>
<a href="#l34.104"></a><span id="l34.104">   return NS_OK;</span>
<a href="#l34.105"></a><span id="l34.105"> }</span>
<a href="#l34.106"></a><span id="l34.106"> </span>
<a href="#l34.107"></a><span id="l34.107" class="difflineminus">-NS_IMETHODIMP nsOutlookSettings::SetLocation(nsIFile *location)</span>
<a href="#l34.108"></a><span id="l34.108" class="difflineminus">-{</span>
<a href="#l34.109"></a><span id="l34.109" class="difflineplus">+NS_IMETHODIMP nsOutlookSettings::SetLocation(nsIFile *location) {</span>
<a href="#l34.110"></a><span id="l34.110">   return NS_OK;</span>
<a href="#l34.111"></a><span id="l34.111"> }</span>
<a href="#l34.112"></a><span id="l34.112"> </span>
<a href="#l34.113"></a><span id="l34.113" class="difflineminus">-NS_IMETHODIMP nsOutlookSettings::Import(nsIMsgAccount **localMailAccount, bool *_retval)</span>
<a href="#l34.114"></a><span id="l34.114" class="difflineminus">-{</span>
<a href="#l34.115"></a><span id="l34.115" class="difflineplus">+NS_IMETHODIMP nsOutlookSettings::Import(nsIMsgAccount **localMailAccount,</span>
<a href="#l34.116"></a><span id="l34.116" class="difflineplus">+                                        bool *_retval) {</span>
<a href="#l34.117"></a><span id="l34.117">   NS_ASSERTION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l34.118"></a><span id="l34.118"> </span>
<a href="#l34.119"></a><span id="l34.119">   if (OutlookSettings::DoImport(localMailAccount)) {</span>
<a href="#l34.120"></a><span id="l34.120">     *_retval = true;</span>
<a href="#l34.121"></a><span id="l34.121">     IMPORT_LOG0(&quot;Settings import appears successful\n&quot;);</span>
<a href="#l34.122"></a><span id="l34.122" class="difflineminus">-  }</span>
<a href="#l34.123"></a><span id="l34.123" class="difflineminus">-  else {</span>
<a href="#l34.124"></a><span id="l34.124" class="difflineplus">+  } else {</span>
<a href="#l34.125"></a><span id="l34.125">     *_retval = false;</span>
<a href="#l34.126"></a><span id="l34.126">     IMPORT_LOG0(&quot;Settings import returned FALSE\n&quot;);</span>
<a href="#l34.127"></a><span id="l34.127">   }</span>
<a href="#l34.128"></a><span id="l34.128"> </span>
<a href="#l34.129"></a><span id="l34.129">   return NS_OK;</span>
<a href="#l34.130"></a><span id="l34.130"> }</span>
<a href="#l34.131"></a><span id="l34.131"> </span>
<a href="#l34.132"></a><span id="l34.132" class="difflineminus">-</span>
<a href="#l34.133"></a><span id="l34.133" class="difflineminus">-nsresult OutlookSettings::FindAccountsKey(nsIWindowsRegKey **aKey)</span>
<a href="#l34.134"></a><span id="l34.134" class="difflineminus">-{</span>
<a href="#l34.135"></a><span id="l34.135" class="difflineplus">+nsresult OutlookSettings::FindAccountsKey(nsIWindowsRegKey **aKey) {</span>
<a href="#l34.136"></a><span id="l34.136">   nsresult rv;</span>
<a href="#l34.137"></a><span id="l34.137">   nsCOMPtr&lt;nsIWindowsRegKey&gt; key =</span>
<a href="#l34.138"></a><span id="l34.138" class="difflineminus">-    do_CreateInstance(&quot;@mozilla.org/windows-registry-key;1&quot;, &amp;rv);</span>
<a href="#l34.139"></a><span id="l34.139" class="difflineplus">+      do_CreateInstance(&quot;@mozilla.org/windows-registry-key;1&quot;, &amp;rv);</span>
<a href="#l34.140"></a><span id="l34.140">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.141"></a><span id="l34.141"> </span>
<a href="#l34.142"></a><span id="l34.142">   rv = key-&gt;Open(nsIWindowsRegKey::ROOT_KEY_CURRENT_USER,</span>
<a href="#l34.143"></a><span id="l34.143">                  NS_LITERAL_STRING(OUTLOOK2003_REGISTRY_KEY),</span>
<a href="#l34.144"></a><span id="l34.144">                  nsIWindowsRegKey::ACCESS_QUERY_VALUE |</span>
<a href="#l34.145"></a><span id="l34.145" class="difflineminus">-                 nsIWindowsRegKey::ACCESS_ENUMERATE_SUB_KEYS);</span>
<a href="#l34.146"></a><span id="l34.146" class="difflineplus">+                     nsIWindowsRegKey::ACCESS_ENUMERATE_SUB_KEYS);</span>
<a href="#l34.147"></a><span id="l34.147"> </span>
<a href="#l34.148"></a><span id="l34.148">   if (NS_FAILED(rv)) {</span>
<a href="#l34.149"></a><span id="l34.149">     rv = key-&gt;Open(nsIWindowsRegKey::ROOT_KEY_CURRENT_USER,</span>
<a href="#l34.150"></a><span id="l34.150">                    NS_LITERAL_STRING(OUTLOOK98_REGISTRY_KEY),</span>
<a href="#l34.151"></a><span id="l34.151">                    nsIWindowsRegKey::ACCESS_QUERY_VALUE |</span>
<a href="#l34.152"></a><span id="l34.152" class="difflineminus">-                   nsIWindowsRegKey::ACCESS_ENUMERATE_SUB_KEYS);</span>
<a href="#l34.153"></a><span id="l34.153" class="difflineplus">+                       nsIWindowsRegKey::ACCESS_ENUMERATE_SUB_KEYS);</span>
<a href="#l34.154"></a><span id="l34.154">   }</span>
<a href="#l34.155"></a><span id="l34.155"> </span>
<a href="#l34.156"></a><span id="l34.156" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l34.157"></a><span id="l34.157" class="difflineminus">-    key.forget(aKey);</span>
<a href="#l34.158"></a><span id="l34.158" class="difflineplus">+  if (NS_SUCCEEDED(rv)) key.forget(aKey);</span>
<a href="#l34.159"></a><span id="l34.159"> </span>
<a href="#l34.160"></a><span id="l34.160">   return rv;</span>
<a href="#l34.161"></a><span id="l34.161"> }</span>
<a href="#l34.162"></a><span id="l34.162"> </span>
<a href="#l34.163"></a><span id="l34.163" class="difflineminus">-nsresult OutlookSettings::QueryAccountSubKey(nsIWindowsRegKey **aKey)</span>
<a href="#l34.164"></a><span id="l34.164" class="difflineminus">-{</span>
<a href="#l34.165"></a><span id="l34.165" class="difflineplus">+nsresult OutlookSettings::QueryAccountSubKey(nsIWindowsRegKey **aKey) {</span>
<a href="#l34.166"></a><span id="l34.166">   nsresult rv;</span>
<a href="#l34.167"></a><span id="l34.167">   nsCOMPtr&lt;nsIWindowsRegKey&gt; key =</span>
<a href="#l34.168"></a><span id="l34.168" class="difflineminus">-    do_CreateInstance(&quot;@mozilla.org/windows-registry-key;1&quot;, &amp;rv);</span>
<a href="#l34.169"></a><span id="l34.169" class="difflineplus">+      do_CreateInstance(&quot;@mozilla.org/windows-registry-key;1&quot;, &amp;rv);</span>
<a href="#l34.170"></a><span id="l34.170">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.171"></a><span id="l34.171"> </span>
<a href="#l34.172"></a><span id="l34.172">   rv = key-&gt;Open(nsIWindowsRegKey::ROOT_KEY_CURRENT_USER,</span>
<a href="#l34.173"></a><span id="l34.173">                  NS_LITERAL_STRING(OUTLOOK2003_REGISTRY_KEY),</span>
<a href="#l34.174"></a><span id="l34.174">                  nsIWindowsRegKey::ACCESS_QUERY_VALUE |</span>
<a href="#l34.175"></a><span id="l34.175" class="difflineminus">-                 nsIWindowsRegKey::ACCESS_ENUMERATE_SUB_KEYS);</span>
<a href="#l34.176"></a><span id="l34.176" class="difflineplus">+                     nsIWindowsRegKey::ACCESS_ENUMERATE_SUB_KEYS);</span>
<a href="#l34.177"></a><span id="l34.177">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l34.178"></a><span id="l34.178">     key.forget(aKey);</span>
<a href="#l34.179"></a><span id="l34.179">     return rv;</span>
<a href="#l34.180"></a><span id="l34.180">   }</span>
<a href="#l34.181"></a><span id="l34.181"> </span>
<a href="#l34.182"></a><span id="l34.182">   rv = key-&gt;Open(nsIWindowsRegKey::ROOT_KEY_CURRENT_USER,</span>
<a href="#l34.183"></a><span id="l34.183">                  NS_LITERAL_STRING(OUTLOOK98_REGISTRY_KEY),</span>
<a href="#l34.184"></a><span id="l34.184">                  nsIWindowsRegKey::ACCESS_QUERY_VALUE |</span>
<a href="#l34.185"></a><span id="l34.185" class="difflineminus">-                 nsIWindowsRegKey::ACCESS_ENUMERATE_SUB_KEYS);</span>
<a href="#l34.186"></a><span id="l34.186" class="difflineplus">+                     nsIWindowsRegKey::ACCESS_ENUMERATE_SUB_KEYS);</span>
<a href="#l34.187"></a><span id="l34.187">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l34.188"></a><span id="l34.188">     key.forget(aKey);</span>
<a href="#l34.189"></a><span id="l34.189">     return rv;</span>
<a href="#l34.190"></a><span id="l34.190">   }</span>
<a href="#l34.191"></a><span id="l34.191"> </span>
<a href="#l34.192"></a><span id="l34.192">   return NS_ERROR_FAILURE;</span>
<a href="#l34.193"></a><span id="l34.193"> }</span>
<a href="#l34.194"></a><span id="l34.194"> </span>
<a href="#l34.195"></a><span id="l34.195" class="difflineminus">-nsresult OutlookSettings::GetDefaultMailAccountName(nsAString &amp;aName)</span>
<a href="#l34.196"></a><span id="l34.196" class="difflineminus">-{</span>
<a href="#l34.197"></a><span id="l34.197" class="difflineplus">+nsresult OutlookSettings::GetDefaultMailAccountName(nsAString &amp;aName) {</span>
<a href="#l34.198"></a><span id="l34.198">   nsCOMPtr&lt;nsIWindowsRegKey&gt; key;</span>
<a href="#l34.199"></a><span id="l34.199">   nsresult rv = QueryAccountSubKey(getter_AddRefs(key));</span>
<a href="#l34.200"></a><span id="l34.200" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l34.201"></a><span id="l34.201" class="difflineminus">-    return rv;</span>
<a href="#l34.202"></a><span id="l34.202" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l34.203"></a><span id="l34.203"> </span>
<a href="#l34.204"></a><span id="l34.204">   return key-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;Default Mail Account&quot;), aName);</span>
<a href="#l34.205"></a><span id="l34.205"> }</span>
<a href="#l34.206"></a><span id="l34.206"> </span>
<a href="#l34.207"></a><span id="l34.207" class="difflineminus">-bool OutlookSettings::DoImport(nsIMsgAccount **aAccount)</span>
<a href="#l34.208"></a><span id="l34.208" class="difflineminus">-{</span>
<a href="#l34.209"></a><span id="l34.209" class="difflineplus">+bool OutlookSettings::DoImport(nsIMsgAccount **aAccount) {</span>
<a href="#l34.210"></a><span id="l34.210">   nsCOMPtr&lt;nsIWindowsRegKey&gt; key;</span>
<a href="#l34.211"></a><span id="l34.211">   nsresult rv = OutlookSettings::FindAccountsKey(getter_AddRefs(key));</span>
<a href="#l34.212"></a><span id="l34.212">   if (NS_FAILED(rv)) {</span>
<a href="#l34.213"></a><span id="l34.213">     IMPORT_LOG0(&quot;*** Error finding Outlook registry account keys\n&quot;);</span>
<a href="#l34.214"></a><span id="l34.214">     return false;</span>
<a href="#l34.215"></a><span id="l34.215">   }</span>
<a href="#l34.216"></a><span id="l34.216"> </span>
<a href="#l34.217"></a><span id="l34.217">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accMgr =</span>
<a href="#l34.218"></a><span id="l34.218" class="difflineminus">-           do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l34.219"></a><span id="l34.219" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l34.220"></a><span id="l34.220">   if (NS_FAILED(rv)) {</span>
<a href="#l34.221"></a><span id="l34.221">     IMPORT_LOG0(&quot;*** Failed to create a account manager!\n&quot;);</span>
<a href="#l34.222"></a><span id="l34.222">     return false;</span>
<a href="#l34.223"></a><span id="l34.223">   }</span>
<a href="#l34.224"></a><span id="l34.224"> </span>
<a href="#l34.225"></a><span id="l34.225">   nsAutoString defMailName;</span>
<a href="#l34.226"></a><span id="l34.226">   rv = GetDefaultMailAccountName(defMailName);</span>
<a href="#l34.227"></a><span id="l34.227"> </span>
<a href="#l34.228"></a><span id="l34.228" class="difflineat">@@ -210,21 +191,19 @@ bool OutlookSettings::DoImport(nsIMsgAcc</span>
<a href="#l34.229"></a><span id="l34.229">   key-&gt;GetChildCount(&amp;childCount);</span>
<a href="#l34.230"></a><span id="l34.230"> </span>
<a href="#l34.231"></a><span id="l34.231">   uint32_t accounts = 0;</span>
<a href="#l34.232"></a><span id="l34.232">   uint32_t popCount = 0;</span>
<a href="#l34.233"></a><span id="l34.233">   for (uint32_t i = 0; i &lt; childCount; i++) {</span>
<a href="#l34.234"></a><span id="l34.234">     nsAutoString keyName;</span>
<a href="#l34.235"></a><span id="l34.235">     key-&gt;GetChildName(i, keyName);</span>
<a href="#l34.236"></a><span id="l34.236">     nsCOMPtr&lt;nsIWindowsRegKey&gt; subKey;</span>
<a href="#l34.237"></a><span id="l34.237" class="difflineminus">-    rv = key-&gt;OpenChild(keyName,</span>
<a href="#l34.238"></a><span id="l34.238" class="difflineminus">-                        nsIWindowsRegKey::ACCESS_QUERY_VALUE,</span>
<a href="#l34.239"></a><span id="l34.239" class="difflineplus">+    rv = key-&gt;OpenChild(keyName, nsIWindowsRegKey::ACCESS_QUERY_VALUE,</span>
<a href="#l34.240"></a><span id="l34.240">                         getter_AddRefs(subKey));</span>
<a href="#l34.241"></a><span id="l34.241" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l34.242"></a><span id="l34.242" class="difflineminus">-      continue;</span>
<a href="#l34.243"></a><span id="l34.243" class="difflineplus">+    if (NS_FAILED(rv)) continue;</span>
<a href="#l34.244"></a><span id="l34.244"> </span>
<a href="#l34.245"></a><span id="l34.245">     // Get the values for this account.</span>
<a href="#l34.246"></a><span id="l34.246">     nsAutoCString nativeKeyName;</span>
<a href="#l34.247"></a><span id="l34.247">     NS_CopyUnicodeToNative(keyName, nativeKeyName);</span>
<a href="#l34.248"></a><span id="l34.248">     IMPORT_LOG1(&quot;Opened Outlook account: %s\n&quot;, nativeKeyName.get());</span>
<a href="#l34.249"></a><span id="l34.249"> </span>
<a href="#l34.250"></a><span id="l34.250">     nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l34.251"></a><span id="l34.251">     nsAutoString value;</span>
<a href="#l34.252"></a><span id="l34.252" class="difflineat">@@ -257,208 +236,195 @@ bool OutlookSettings::DoImport(nsIMsgAcc</span>
<a href="#l34.253"></a><span id="l34.253">   rv = accMgr-&gt;SaveAccountInfo();</span>
<a href="#l34.254"></a><span id="l34.254">   NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Can't save account info to pref file&quot;);</span>
<a href="#l34.255"></a><span id="l34.255"> </span>
<a href="#l34.256"></a><span id="l34.256">   return accounts != 0;</span>
<a href="#l34.257"></a><span id="l34.257"> }</span>
<a href="#l34.258"></a><span id="l34.258"> </span>
<a href="#l34.259"></a><span id="l34.259"> nsresult OutlookSettings::GetAccountName(nsIWindowsRegKey *aKey,</span>
<a href="#l34.260"></a><span id="l34.260">                                          const nsString &amp;aDefaultName,</span>
<a href="#l34.261"></a><span id="l34.261" class="difflineminus">-                                         nsAString &amp;aAccountName)</span>
<a href="#l34.262"></a><span id="l34.262" class="difflineminus">-{</span>
<a href="#l34.263"></a><span id="l34.263" class="difflineplus">+                                         nsAString &amp;aAccountName) {</span>
<a href="#l34.264"></a><span id="l34.264">   nsresult rv;</span>
<a href="#l34.265"></a><span id="l34.265">   rv = aKey-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;Account Name&quot;), aAccountName);</span>
<a href="#l34.266"></a><span id="l34.266" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l34.267"></a><span id="l34.267" class="difflineminus">-    aAccountName.Assign(aDefaultName);</span>
<a href="#l34.268"></a><span id="l34.268" class="difflineplus">+  if (NS_FAILED(rv)) aAccountName.Assign(aDefaultName);</span>
<a href="#l34.269"></a><span id="l34.269"> </span>
<a href="#l34.270"></a><span id="l34.270">   return NS_OK;</span>
<a href="#l34.271"></a><span id="l34.271"> }</span>
<a href="#l34.272"></a><span id="l34.272"> </span>
<a href="#l34.273"></a><span id="l34.273"> bool OutlookSettings::DoIMAPServer(nsIMsgAccountManager *aMgr,</span>
<a href="#l34.274"></a><span id="l34.274">                                    nsIWindowsRegKey *aKey,</span>
<a href="#l34.275"></a><span id="l34.275">                                    const nsString &amp;aServerName,</span>
<a href="#l34.276"></a><span id="l34.276" class="difflineminus">-                                   nsIMsgAccount **aAccount)</span>
<a href="#l34.277"></a><span id="l34.277" class="difflineminus">-{</span>
<a href="#l34.278"></a><span id="l34.278" class="difflineplus">+                                   nsIMsgAccount **aAccount) {</span>
<a href="#l34.279"></a><span id="l34.279">   nsAutoString userName;</span>
<a href="#l34.280"></a><span id="l34.280">   nsresult rv;</span>
<a href="#l34.281"></a><span id="l34.281">   rv = aKey-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;IMAP User Name&quot;), userName);</span>
<a href="#l34.282"></a><span id="l34.282" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l34.283"></a><span id="l34.283" class="difflineminus">-    return false;</span>
<a href="#l34.284"></a><span id="l34.284" class="difflineplus">+  if (NS_FAILED(rv)) return false;</span>
<a href="#l34.285"></a><span id="l34.285"> </span>
<a href="#l34.286"></a><span id="l34.286">   bool result = false;</span>
<a href="#l34.287"></a><span id="l34.287"> </span>
<a href="#l34.288"></a><span id="l34.288">   // I now have a user name/server name pair, find out if it already exists?</span>
<a href="#l34.289"></a><span id="l34.289">   nsAutoCString nativeUserName;</span>
<a href="#l34.290"></a><span id="l34.290">   NS_CopyUnicodeToNative(userName, nativeUserName);</span>
<a href="#l34.291"></a><span id="l34.291">   nsAutoCString nativeServerName;</span>
<a href="#l34.292"></a><span id="l34.292">   NS_CopyUnicodeToNative(aServerName, nativeServerName);</span>
<a href="#l34.293"></a><span id="l34.293">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; in;</span>
<a href="#l34.294"></a><span id="l34.294" class="difflineminus">-  rv = aMgr-&gt;FindServer(nativeUserName,</span>
<a href="#l34.295"></a><span id="l34.295" class="difflineminus">-                        nativeServerName,</span>
<a href="#l34.296"></a><span id="l34.296" class="difflineminus">-                        NS_LITERAL_CSTRING(&quot;imap&quot;),</span>
<a href="#l34.297"></a><span id="l34.297" class="difflineminus">-                        getter_AddRefs(in));</span>
<a href="#l34.298"></a><span id="l34.298" class="difflineplus">+  rv = aMgr-&gt;FindServer(nativeUserName, nativeServerName,</span>
<a href="#l34.299"></a><span id="l34.299" class="difflineplus">+                        NS_LITERAL_CSTRING(&quot;imap&quot;), getter_AddRefs(in));</span>
<a href="#l34.300"></a><span id="l34.300">   if (NS_FAILED(rv) || (in == nullptr)) {</span>
<a href="#l34.301"></a><span id="l34.301">     // Create the incoming server and an account for it?</span>
<a href="#l34.302"></a><span id="l34.302" class="difflineminus">-    rv = aMgr-&gt;CreateIncomingServer(nativeUserName,</span>
<a href="#l34.303"></a><span id="l34.303" class="difflineminus">-                                    nativeServerName,</span>
<a href="#l34.304"></a><span id="l34.304" class="difflineplus">+    rv = aMgr-&gt;CreateIncomingServer(nativeUserName, nativeServerName,</span>
<a href="#l34.305"></a><span id="l34.305">                                     NS_LITERAL_CSTRING(&quot;imap&quot;),</span>
<a href="#l34.306"></a><span id="l34.306">                                     getter_AddRefs(in));</span>
<a href="#l34.307"></a><span id="l34.307">     if (NS_SUCCEEDED(rv) &amp;&amp; in) {</span>
<a href="#l34.308"></a><span id="l34.308">       rv = in-&gt;SetType(NS_LITERAL_CSTRING(&quot;imap&quot;));</span>
<a href="#l34.309"></a><span id="l34.309">       // TODO SSL, auth method</span>
<a href="#l34.310"></a><span id="l34.310"> </span>
<a href="#l34.311"></a><span id="l34.311">       IMPORT_LOG2(&quot;Created IMAP server named: %s, userName: %s\n&quot;,</span>
<a href="#l34.312"></a><span id="l34.312">                   nativeServerName.get(), nativeUserName.get());</span>
<a href="#l34.313"></a><span id="l34.313"> </span>
<a href="#l34.314"></a><span id="l34.314">       nsAutoString prettyName;</span>
<a href="#l34.315"></a><span id="l34.315">       if (NS_SUCCEEDED(GetAccountName(aKey, aServerName, prettyName)))</span>
<a href="#l34.316"></a><span id="l34.316">         rv = in-&gt;SetPrettyName(prettyName);</span>
<a href="#l34.317"></a><span id="l34.317">       // We have a server, create an account.</span>
<a href="#l34.318"></a><span id="l34.318" class="difflineminus">-      nsCOMPtr&lt;nsIMsgAccount&gt;  account;</span>
<a href="#l34.319"></a><span id="l34.319" class="difflineplus">+      nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l34.320"></a><span id="l34.320">       rv = aMgr-&gt;CreateAccount(getter_AddRefs(account));</span>
<a href="#l34.321"></a><span id="l34.321">       if (NS_SUCCEEDED(rv) &amp;&amp; account) {</span>
<a href="#l34.322"></a><span id="l34.322">         rv = account-&gt;SetIncomingServer(in);</span>
<a href="#l34.323"></a><span id="l34.323"> </span>
<a href="#l34.324"></a><span id="l34.324" class="difflineminus">-        IMPORT_LOG0(&quot;Created an account and set the IMAP server as the incoming server\n&quot;);</span>
<a href="#l34.325"></a><span id="l34.325" class="difflineplus">+        IMPORT_LOG0(</span>
<a href="#l34.326"></a><span id="l34.326" class="difflineplus">+            &quot;Created an account and set the IMAP server as the incoming &quot;</span>
<a href="#l34.327"></a><span id="l34.327" class="difflineplus">+            &quot;server\n&quot;);</span>
<a href="#l34.328"></a><span id="l34.328"> </span>
<a href="#l34.329"></a><span id="l34.329">         // Fiddle with the identities</span>
<a href="#l34.330"></a><span id="l34.330">         SetIdentities(aMgr, account, aKey);</span>
<a href="#l34.331"></a><span id="l34.331">         result = true;</span>
<a href="#l34.332"></a><span id="l34.332" class="difflineminus">-        if (aAccount)</span>
<a href="#l34.333"></a><span id="l34.333" class="difflineminus">-          account.forget(aAccount);</span>
<a href="#l34.334"></a><span id="l34.334" class="difflineplus">+        if (aAccount) account.forget(aAccount);</span>
<a href="#l34.335"></a><span id="l34.335">       }</span>
<a href="#l34.336"></a><span id="l34.336">     }</span>
<a href="#l34.337"></a><span id="l34.337" class="difflineminus">-  }</span>
<a href="#l34.338"></a><span id="l34.338" class="difflineminus">-  else</span>
<a href="#l34.339"></a><span id="l34.339" class="difflineplus">+  } else</span>
<a href="#l34.340"></a><span id="l34.340">     result = true;</span>
<a href="#l34.341"></a><span id="l34.341"> </span>
<a href="#l34.342"></a><span id="l34.342">   return result;</span>
<a href="#l34.343"></a><span id="l34.343"> }</span>
<a href="#l34.344"></a><span id="l34.344"> </span>
<a href="#l34.345"></a><span id="l34.345"> bool OutlookSettings::DoPOP3Server(nsIMsgAccountManager *aMgr,</span>
<a href="#l34.346"></a><span id="l34.346">                                    nsIWindowsRegKey *aKey,</span>
<a href="#l34.347"></a><span id="l34.347">                                    const nsString &amp;aServerName,</span>
<a href="#l34.348"></a><span id="l34.348" class="difflineminus">-                                   nsIMsgAccount **aAccount)</span>
<a href="#l34.349"></a><span id="l34.349" class="difflineminus">-{</span>
<a href="#l34.350"></a><span id="l34.350" class="difflineplus">+                                   nsIMsgAccount **aAccount) {</span>
<a href="#l34.351"></a><span id="l34.351">   nsAutoString userName;</span>
<a href="#l34.352"></a><span id="l34.352">   nsresult rv;</span>
<a href="#l34.353"></a><span id="l34.353">   rv = aKey-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;POP3 User Name&quot;), userName);</span>
<a href="#l34.354"></a><span id="l34.354" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l34.355"></a><span id="l34.355" class="difflineminus">-    return false;</span>
<a href="#l34.356"></a><span id="l34.356" class="difflineplus">+  if (NS_FAILED(rv)) return false;</span>
<a href="#l34.357"></a><span id="l34.357"> </span>
<a href="#l34.358"></a><span id="l34.358">   // I now have a user name/server name pair, find out if it already exists?</span>
<a href="#l34.359"></a><span id="l34.359">   nsAutoCString nativeUserName;</span>
<a href="#l34.360"></a><span id="l34.360">   NS_CopyUnicodeToNative(userName, nativeUserName);</span>
<a href="#l34.361"></a><span id="l34.361">   nsAutoCString nativeServerName;</span>
<a href="#l34.362"></a><span id="l34.362">   NS_CopyUnicodeToNative(aServerName, nativeServerName);</span>
<a href="#l34.363"></a><span id="l34.363">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; in;</span>
<a href="#l34.364"></a><span id="l34.364" class="difflineminus">-  rv = aMgr-&gt;FindServer(nativeUserName,</span>
<a href="#l34.365"></a><span id="l34.365" class="difflineminus">-                        nativeServerName,</span>
<a href="#l34.366"></a><span id="l34.366" class="difflineminus">-                        NS_LITERAL_CSTRING(&quot;pop3&quot;),</span>
<a href="#l34.367"></a><span id="l34.367" class="difflineminus">-                        getter_AddRefs(in));</span>
<a href="#l34.368"></a><span id="l34.368" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l34.369"></a><span id="l34.369" class="difflineminus">-    return true;</span>
<a href="#l34.370"></a><span id="l34.370" class="difflineplus">+  rv = aMgr-&gt;FindServer(nativeUserName, nativeServerName,</span>
<a href="#l34.371"></a><span id="l34.371" class="difflineplus">+                        NS_LITERAL_CSTRING(&quot;pop3&quot;), getter_AddRefs(in));</span>
<a href="#l34.372"></a><span id="l34.372" class="difflineplus">+  if (NS_SUCCEEDED(rv)) return true;</span>
<a href="#l34.373"></a><span id="l34.373"> </span>
<a href="#l34.374"></a><span id="l34.374">   // Create the incoming server and an account for it?</span>
<a href="#l34.375"></a><span id="l34.375" class="difflineminus">-  rv = aMgr-&gt;CreateIncomingServer(nativeUserName,</span>
<a href="#l34.376"></a><span id="l34.376" class="difflineminus">-                                  nativeServerName,</span>
<a href="#l34.377"></a><span id="l34.377" class="difflineplus">+  rv = aMgr-&gt;CreateIncomingServer(nativeUserName, nativeServerName,</span>
<a href="#l34.378"></a><span id="l34.378">                                   NS_LITERAL_CSTRING(&quot;pop3&quot;),</span>
<a href="#l34.379"></a><span id="l34.379">                                   getter_AddRefs(in));</span>
<a href="#l34.380"></a><span id="l34.380">   rv = in-&gt;SetType(NS_LITERAL_CSTRING(&quot;pop3&quot;));</span>
<a href="#l34.381"></a><span id="l34.381"> </span>
<a href="#l34.382"></a><span id="l34.382">   // TODO SSL, auth method</span>
<a href="#l34.383"></a><span id="l34.383"> </span>
<a href="#l34.384"></a><span id="l34.384">   nsCOMPtr&lt;nsIPop3IncomingServer&gt; pop3Server = do_QueryInterface(in);</span>
<a href="#l34.385"></a><span id="l34.385">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l34.386"></a><span id="l34.386"> </span>
<a href="#l34.387"></a><span id="l34.387">   // set local folders as the Inbox to use for this POP3 server</span>
<a href="#l34.388"></a><span id="l34.388">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; localFoldersServer;</span>
<a href="#l34.389"></a><span id="l34.389">   aMgr-&gt;GetLocalFoldersServer(getter_AddRefs(localFoldersServer));</span>
<a href="#l34.390"></a><span id="l34.390"> </span>
<a href="#l34.391"></a><span id="l34.391">   if (!localFoldersServer) {</span>
<a href="#l34.392"></a><span id="l34.392" class="difflineminus">-    // XXX: We may need to move this local folder creation code to the generic nsImportSettings code</span>
<a href="#l34.393"></a><span id="l34.393" class="difflineminus">-    // if the other import modules end up needing to do this too.</span>
<a href="#l34.394"></a><span id="l34.394" class="difflineminus">-    // if Local Folders does not exist already, create it</span>
<a href="#l34.395"></a><span id="l34.395" class="difflineplus">+    // XXX: We may need to move this local folder creation code to the generic</span>
<a href="#l34.396"></a><span id="l34.396" class="difflineplus">+    // nsImportSettings code if the other import modules end up needing to do</span>
<a href="#l34.397"></a><span id="l34.397" class="difflineplus">+    // this too. if Local Folders does not exist already, create it</span>
<a href="#l34.398"></a><span id="l34.398">     rv = aMgr-&gt;CreateLocalMailAccount();</span>
<a href="#l34.399"></a><span id="l34.399">     if (NS_FAILED(rv)) {</span>
<a href="#l34.400"></a><span id="l34.400">       IMPORT_LOG0(&quot;*** Failed to create Local Folders!\n&quot;);</span>
<a href="#l34.401"></a><span id="l34.401">       return false;</span>
<a href="#l34.402"></a><span id="l34.402">     }</span>
<a href="#l34.403"></a><span id="l34.403">     aMgr-&gt;GetLocalFoldersServer(getter_AddRefs(localFoldersServer));</span>
<a href="#l34.404"></a><span id="l34.404">   }</span>
<a href="#l34.405"></a><span id="l34.405"> </span>
<a href="#l34.406"></a><span id="l34.406">   // now get the account for this server</span>
<a href="#l34.407"></a><span id="l34.407">   nsCOMPtr&lt;nsIMsgAccount&gt; localFoldersAccount;</span>
<a href="#l34.408"></a><span id="l34.408" class="difflineminus">-  aMgr-&gt;FindAccountForServer(localFoldersServer, getter_AddRefs(localFoldersAccount));</span>
<a href="#l34.409"></a><span id="l34.409" class="difflineplus">+  aMgr-&gt;FindAccountForServer(localFoldersServer,</span>
<a href="#l34.410"></a><span id="l34.410" class="difflineplus">+                             getter_AddRefs(localFoldersAccount));</span>
<a href="#l34.411"></a><span id="l34.411">   if (localFoldersAccount) {</span>
<a href="#l34.412"></a><span id="l34.412">     nsCString localFoldersAcctKey;</span>
<a href="#l34.413"></a><span id="l34.413">     localFoldersAccount-&gt;GetKey(localFoldersAcctKey);</span>
<a href="#l34.414"></a><span id="l34.414">     pop3Server-&gt;SetDeferredToAccount(localFoldersAcctKey);</span>
<a href="#l34.415"></a><span id="l34.415">     pop3Server-&gt;SetDeferGetNewMail(true);</span>
<a href="#l34.416"></a><span id="l34.416">   }</span>
<a href="#l34.417"></a><span id="l34.417"> </span>
<a href="#l34.418"></a><span id="l34.418">   IMPORT_LOG2(&quot;Created POP3 server named: %s, userName: %s\n&quot;,</span>
<a href="#l34.419"></a><span id="l34.419" class="difflineminus">-              nativeServerName.get(),</span>
<a href="#l34.420"></a><span id="l34.420" class="difflineminus">-              nativeUserName.get());</span>
<a href="#l34.421"></a><span id="l34.421" class="difflineplus">+              nativeServerName.get(), nativeUserName.get());</span>
<a href="#l34.422"></a><span id="l34.422"> </span>
<a href="#l34.423"></a><span id="l34.423">   nsString prettyName;</span>
<a href="#l34.424"></a><span id="l34.424">   rv = GetAccountName(aKey, aServerName, prettyName);</span>
<a href="#l34.425"></a><span id="l34.425" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l34.426"></a><span id="l34.426" class="difflineminus">-    return false;</span>
<a href="#l34.427"></a><span id="l34.427" class="difflineplus">+  if (NS_FAILED(rv)) return false;</span>
<a href="#l34.428"></a><span id="l34.428"> </span>
<a href="#l34.429"></a><span id="l34.429">   rv = in-&gt;SetPrettyName(prettyName);</span>
<a href="#l34.430"></a><span id="l34.430">   // We have a server, create an account.</span>
<a href="#l34.431"></a><span id="l34.431" class="difflineminus">-  nsCOMPtr&lt;nsIMsgAccount&gt;  account;</span>
<a href="#l34.432"></a><span id="l34.432" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l34.433"></a><span id="l34.433">   rv = aMgr-&gt;CreateAccount(getter_AddRefs(account));</span>
<a href="#l34.434"></a><span id="l34.434" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l34.435"></a><span id="l34.435" class="difflineminus">-    return false;</span>
<a href="#l34.436"></a><span id="l34.436" class="difflineplus">+  if (NS_FAILED(rv)) return false;</span>
<a href="#l34.437"></a><span id="l34.437"> </span>
<a href="#l34.438"></a><span id="l34.438">   rv = account-&gt;SetIncomingServer(in);</span>
<a href="#l34.439"></a><span id="l34.439"> </span>
<a href="#l34.440"></a><span id="l34.440" class="difflineminus">-  IMPORT_LOG0(&quot;Created a new account and set the incoming server to the POP3 server.\n&quot;);</span>
<a href="#l34.441"></a><span id="l34.441" class="difflineplus">+  IMPORT_LOG0(</span>
<a href="#l34.442"></a><span id="l34.442" class="difflineplus">+      &quot;Created a new account and set the incoming server to the POP3 &quot;</span>
<a href="#l34.443"></a><span id="l34.443" class="difflineplus">+      &quot;server.\n&quot;);</span>
<a href="#l34.444"></a><span id="l34.444"> </span>
<a href="#l34.445"></a><span id="l34.445">   uint32_t leaveOnServer;</span>
<a href="#l34.446"></a><span id="l34.446" class="difflineminus">-  rv = aKey-&gt;ReadIntValue(NS_LITERAL_STRING(&quot;Leave Mail On Server&quot;), &amp;leaveOnServer);</span>
<a href="#l34.447"></a><span id="l34.447" class="difflineplus">+  rv = aKey-&gt;ReadIntValue(NS_LITERAL_STRING(&quot;Leave Mail On Server&quot;),</span>
<a href="#l34.448"></a><span id="l34.448" class="difflineplus">+                          &amp;leaveOnServer);</span>
<a href="#l34.449"></a><span id="l34.449">   if (NS_SUCCEEDED(rv))</span>
<a href="#l34.450"></a><span id="l34.450">     pop3Server-&gt;SetLeaveMessagesOnServer(leaveOnServer == 1 ? true : false);</span>
<a href="#l34.451"></a><span id="l34.451"> </span>
<a href="#l34.452"></a><span id="l34.452">   // Fiddle with the identities</span>
<a href="#l34.453"></a><span id="l34.453">   SetIdentities(aMgr, account, aKey);</span>
<a href="#l34.454"></a><span id="l34.454"> </span>
<a href="#l34.455"></a><span id="l34.455" class="difflineminus">-  if (aAccount)</span>
<a href="#l34.456"></a><span id="l34.456" class="difflineminus">-    account.forget(aAccount);</span>
<a href="#l34.457"></a><span id="l34.457" class="difflineplus">+  if (aAccount) account.forget(aAccount);</span>
<a href="#l34.458"></a><span id="l34.458"> </span>
<a href="#l34.459"></a><span id="l34.459">   return true;</span>
<a href="#l34.460"></a><span id="l34.460"> }</span>
<a href="#l34.461"></a><span id="l34.461"> </span>
<a href="#l34.462"></a><span id="l34.462"> void OutlookSettings::SetIdentities(nsIMsgAccountManager *aMgr,</span>
<a href="#l34.463"></a><span id="l34.463">                                     nsIMsgAccount *aAcc,</span>
<a href="#l34.464"></a><span id="l34.464" class="difflineminus">-                                    nsIWindowsRegKey *aKey)</span>
<a href="#l34.465"></a><span id="l34.465" class="difflineminus">-{</span>
<a href="#l34.466"></a><span id="l34.466" class="difflineplus">+                                    nsIWindowsRegKey *aKey) {</span>
<a href="#l34.467"></a><span id="l34.467">   // Get the relevant information for an identity</span>
<a href="#l34.468"></a><span id="l34.468">   nsAutoString name;</span>
<a href="#l34.469"></a><span id="l34.469">   aKey-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;SMTP Display Name&quot;), name);</span>
<a href="#l34.470"></a><span id="l34.470"> </span>
<a href="#l34.471"></a><span id="l34.471">   nsAutoString server;</span>
<a href="#l34.472"></a><span id="l34.472">   aKey-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;SMTP Server&quot;), server);</span>
<a href="#l34.473"></a><span id="l34.473"> </span>
<a href="#l34.474"></a><span id="l34.474">   nsAutoString email;</span>
<a href="#l34.475"></a><span id="l34.475">   aKey-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;SMTP Email Address&quot;), email);</span>
<a href="#l34.476"></a><span id="l34.476"> </span>
<a href="#l34.477"></a><span id="l34.477">   nsAutoString reply;</span>
<a href="#l34.478"></a><span id="l34.478" class="difflineminus">-  aKey-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;SMTP Reply To Email Address&quot;), reply);</span>
<a href="#l34.479"></a><span id="l34.479" class="difflineplus">+  aKey-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;SMTP Reply To Email Address&quot;),</span>
<a href="#l34.480"></a><span id="l34.480" class="difflineplus">+                        reply);</span>
<a href="#l34.481"></a><span id="l34.481"> </span>
<a href="#l34.482"></a><span id="l34.482">   nsAutoString userName;</span>
<a href="#l34.483"></a><span id="l34.483">   aKey-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;SMTP User Name&quot;), userName);</span>
<a href="#l34.484"></a><span id="l34.484"> </span>
<a href="#l34.485"></a><span id="l34.485">   nsAutoString orgName;</span>
<a href="#l34.486"></a><span id="l34.486">   aKey-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;SMTP Organization Name&quot;), orgName);</span>
<a href="#l34.487"></a><span id="l34.487"> </span>
<a href="#l34.488"></a><span id="l34.488">   nsresult rv;</span>
<a href="#l34.489"></a><span id="l34.489" class="difflineminus">-  nsCOMPtr&lt;nsIMsgIdentity&gt;  id;</span>
<a href="#l34.490"></a><span id="l34.490" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIdentity&gt; id;</span>
<a href="#l34.491"></a><span id="l34.491">   if (!email.IsEmpty() &amp;&amp; !name.IsEmpty() &amp;&amp; !server.IsEmpty()) {</span>
<a href="#l34.492"></a><span id="l34.492">     // The default identity, nor any other identities matched,</span>
<a href="#l34.493"></a><span id="l34.493">     // create a new one and add it to the account.</span>
<a href="#l34.494"></a><span id="l34.494">     rv = aMgr-&gt;CreateIdentity(getter_AddRefs(id));</span>
<a href="#l34.495"></a><span id="l34.495">     if (id) {</span>
<a href="#l34.496"></a><span id="l34.496">       id-&gt;SetFullName(name);</span>
<a href="#l34.497"></a><span id="l34.497">       id-&gt;SetOrganization(orgName);</span>
<a href="#l34.498"></a><span id="l34.498"> </span>
<a href="#l34.499"></a><span id="l34.499" class="difflineat">@@ -476,72 +442,65 @@ void OutlookSettings::SetIdentities(nsIM</span>
<a href="#l34.500"></a><span id="l34.500">       NS_CopyUnicodeToNative(name, nativeName);</span>
<a href="#l34.501"></a><span id="l34.501">       IMPORT_LOG0(&quot;Created identity and added to the account\n&quot;);</span>
<a href="#l34.502"></a><span id="l34.502">       IMPORT_LOG1(&quot;\tname: %s\n&quot;, nativeName.get());</span>
<a href="#l34.503"></a><span id="l34.503">       IMPORT_LOG1(&quot;\temail: %s\n&quot;, nativeEmail.get());</span>
<a href="#l34.504"></a><span id="l34.504">     }</span>
<a href="#l34.505"></a><span id="l34.505">   }</span>
<a href="#l34.506"></a><span id="l34.506"> </span>
<a href="#l34.507"></a><span id="l34.507">   if (userName.IsEmpty()) {</span>
<a href="#l34.508"></a><span id="l34.508" class="difflineminus">-    nsCOMPtr&lt;nsIMsgIncomingServer&gt;  incomingServer;</span>
<a href="#l34.509"></a><span id="l34.509" class="difflineplus">+    nsCOMPtr&lt;nsIMsgIncomingServer&gt; incomingServer;</span>
<a href="#l34.510"></a><span id="l34.510">     rv = aAcc-&gt;GetIncomingServer(getter_AddRefs(incomingServer));</span>
<a href="#l34.511"></a><span id="l34.511">     if (NS_SUCCEEDED(rv) &amp;&amp; incomingServer) {</span>
<a href="#l34.512"></a><span id="l34.512">       nsAutoCString nativeUserName;</span>
<a href="#l34.513"></a><span id="l34.513">       rv = incomingServer-&gt;GetUsername(nativeUserName);</span>
<a href="#l34.514"></a><span id="l34.514" class="difflineminus">-      NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Unable to get UserName from incomingServer&quot;);</span>
<a href="#l34.515"></a><span id="l34.515" class="difflineplus">+      NS_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l34.516"></a><span id="l34.516" class="difflineplus">+                   &quot;Unable to get UserName from incomingServer&quot;);</span>
<a href="#l34.517"></a><span id="l34.517">       NS_CopyNativeToUnicode(nativeUserName, userName);</span>
<a href="#l34.518"></a><span id="l34.518">     }</span>
<a href="#l34.519"></a><span id="l34.519">   }</span>
<a href="#l34.520"></a><span id="l34.520"> </span>
<a href="#l34.521"></a><span id="l34.521">   SetSmtpServer(aMgr, aAcc, id, server, userName);</span>
<a href="#l34.522"></a><span id="l34.522"> }</span>
<a href="#l34.523"></a><span id="l34.523"> </span>
<a href="#l34.524"></a><span id="l34.524"> nsresult OutlookSettings::SetSmtpServerKey(nsIMsgIdentity *aId,</span>
<a href="#l34.525"></a><span id="l34.525" class="difflineminus">-                                           nsISmtpServer *aServer)</span>
<a href="#l34.526"></a><span id="l34.526" class="difflineminus">-{</span>
<a href="#l34.527"></a><span id="l34.527" class="difflineplus">+                                           nsISmtpServer *aServer) {</span>
<a href="#l34.528"></a><span id="l34.528">   nsAutoCString smtpServerKey;</span>
<a href="#l34.529"></a><span id="l34.529">   aServer-&gt;GetKey(getter_Copies(smtpServerKey));</span>
<a href="#l34.530"></a><span id="l34.530">   return aId-&gt;SetSmtpServerKey(smtpServerKey);</span>
<a href="#l34.531"></a><span id="l34.531"> }</span>
<a href="#l34.532"></a><span id="l34.532"> </span>
<a href="#l34.533"></a><span id="l34.533"> nsresult OutlookSettings::SetSmtpServer(nsIMsgAccountManager *aMgr,</span>
<a href="#l34.534"></a><span id="l34.534">                                         nsIMsgAccount *aAcc,</span>
<a href="#l34.535"></a><span id="l34.535">                                         nsIMsgIdentity *aId,</span>
<a href="#l34.536"></a><span id="l34.536">                                         const nsString &amp;aServer,</span>
<a href="#l34.537"></a><span id="l34.537" class="difflineminus">-                                        const nsString &amp;aUser)</span>
<a href="#l34.538"></a><span id="l34.538" class="difflineminus">-{</span>
<a href="#l34.539"></a><span id="l34.539" class="difflineplus">+                                        const nsString &amp;aUser) {</span>
<a href="#l34.540"></a><span id="l34.540">   nsresult rv;</span>
<a href="#l34.541"></a><span id="l34.541" class="difflineminus">-  nsCOMPtr&lt;nsISmtpService&gt; smtpService(do_GetService(NS_SMTPSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l34.542"></a><span id="l34.542" class="difflineplus">+  nsCOMPtr&lt;nsISmtpService&gt; smtpService(</span>
<a href="#l34.543"></a><span id="l34.543" class="difflineplus">+      do_GetService(NS_SMTPSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l34.544"></a><span id="l34.544">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.545"></a><span id="l34.545"> </span>
<a href="#l34.546"></a><span id="l34.546">   nsAutoCString nativeUserName;</span>
<a href="#l34.547"></a><span id="l34.547">   NS_CopyUnicodeToNative(aUser, nativeUserName);</span>
<a href="#l34.548"></a><span id="l34.548">   nsAutoCString nativeServerName;</span>
<a href="#l34.549"></a><span id="l34.549">   NS_CopyUnicodeToNative(aServer, nativeServerName);</span>
<a href="#l34.550"></a><span id="l34.550">   nsCOMPtr&lt;nsISmtpServer&gt; foundServer;</span>
<a href="#l34.551"></a><span id="l34.551" class="difflineminus">-  rv = smtpService-&gt;FindServer(nativeUserName.get(),</span>
<a href="#l34.552"></a><span id="l34.552" class="difflineminus">-                               nativeServerName.get(),</span>
<a href="#l34.553"></a><span id="l34.553" class="difflineplus">+  rv = smtpService-&gt;FindServer(nativeUserName.get(), nativeServerName.get(),</span>
<a href="#l34.554"></a><span id="l34.554">                                getter_AddRefs(foundServer));</span>
<a href="#l34.555"></a><span id="l34.555">   if (NS_SUCCEEDED(rv) &amp;&amp; foundServer) {</span>
<a href="#l34.556"></a><span id="l34.556" class="difflineminus">-    if (aId)</span>
<a href="#l34.557"></a><span id="l34.557" class="difflineminus">-      SetSmtpServerKey(aId, foundServer);</span>
<a href="#l34.558"></a><span id="l34.558" class="difflineminus">-    IMPORT_LOG1(&quot;SMTP server already exists: %s\n&quot;,</span>
<a href="#l34.559"></a><span id="l34.559" class="difflineminus">-                nativeServerName.get());</span>
<a href="#l34.560"></a><span id="l34.560" class="difflineplus">+    if (aId) SetSmtpServerKey(aId, foundServer);</span>
<a href="#l34.561"></a><span id="l34.561" class="difflineplus">+    IMPORT_LOG1(&quot;SMTP server already exists: %s\n&quot;, nativeServerName.get());</span>
<a href="#l34.562"></a><span id="l34.562">     return rv;</span>
<a href="#l34.563"></a><span id="l34.563">   }</span>
<a href="#l34.564"></a><span id="l34.564"> </span>
<a href="#l34.565"></a><span id="l34.565">   nsCOMPtr&lt;nsISmtpServer&gt; smtpServer;</span>
<a href="#l34.566"></a><span id="l34.566">   rv = smtpService-&gt;CreateServer(getter_AddRefs(smtpServer));</span>
<a href="#l34.567"></a><span id="l34.567">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l34.568"></a><span id="l34.568"> </span>
<a href="#l34.569"></a><span id="l34.569">   smtpServer-&gt;SetHostname(nativeServerName);</span>
<a href="#l34.570"></a><span id="l34.570" class="difflineminus">-  if (!aUser.IsEmpty())</span>
<a href="#l34.571"></a><span id="l34.571" class="difflineminus">-    smtpServer-&gt;SetUsername(nativeUserName);</span>
<a href="#l34.572"></a><span id="l34.572" class="difflineplus">+  if (!aUser.IsEmpty()) smtpServer-&gt;SetUsername(nativeUserName);</span>
<a href="#l34.573"></a><span id="l34.573"> </span>
<a href="#l34.574"></a><span id="l34.574" class="difflineminus">-  if (aId)</span>
<a href="#l34.575"></a><span id="l34.575" class="difflineminus">-    SetSmtpServerKey(aId, smtpServer);</span>
<a href="#l34.576"></a><span id="l34.576" class="difflineplus">+  if (aId) SetSmtpServerKey(aId, smtpServer);</span>
<a href="#l34.577"></a><span id="l34.577"> </span>
<a href="#l34.578"></a><span id="l34.578">   // TODO SSL, auth method</span>
<a href="#l34.579"></a><span id="l34.579" class="difflineminus">-  IMPORT_LOG1(&quot;Created new SMTP server: %s\n&quot;,</span>
<a href="#l34.580"></a><span id="l34.580" class="difflineminus">-              nativeServerName.get());</span>
<a href="#l34.581"></a><span id="l34.581" class="difflineplus">+  IMPORT_LOG1(&quot;Created new SMTP server: %s\n&quot;, nativeServerName.get());</span>
<a href="#l34.582"></a><span id="l34.582">   return NS_OK;</span>
<a href="#l34.583"></a><span id="l34.583"> }</span>
<a href="#l34.584"></a><span id="l34.584" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/mailnews/import/outlook/src/nsOutlookSettings.h</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/mailnews/import/outlook/src/nsOutlookSettings.h</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -3,27 +3,25 @@</span>
<a href="#l35.4"></a><span id="l35.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l35.5"></a><span id="l35.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l35.6"></a><span id="l35.6"> </span>
<a href="#l35.7"></a><span id="l35.7"> #ifndef nsOutlookSettings_h___</span>
<a href="#l35.8"></a><span id="l35.8"> #define nsOutlookSettings_h___</span>
<a href="#l35.9"></a><span id="l35.9"> </span>
<a href="#l35.10"></a><span id="l35.10"> #include &quot;nsIImportSettings.h&quot;</span>
<a href="#l35.11"></a><span id="l35.11"> </span>
<a href="#l35.12"></a><span id="l35.12" class="difflineminus">-</span>
<a href="#l35.13"></a><span id="l35.13"> class nsOutlookSettings : public nsIImportSettings {</span>
<a href="#l35.14"></a><span id="l35.14" class="difflineminus">-public:</span>
<a href="#l35.15"></a><span id="l35.15" class="difflineminus">-    nsOutlookSettings();</span>
<a href="#l35.16"></a><span id="l35.16" class="difflineplus">+ public:</span>
<a href="#l35.17"></a><span id="l35.17" class="difflineplus">+  nsOutlookSettings();</span>
<a href="#l35.18"></a><span id="l35.18"> </span>
<a href="#l35.19"></a><span id="l35.19">   static nsresult Create(nsIImportSettings** aImport);</span>
<a href="#l35.20"></a><span id="l35.20"> </span>
<a href="#l35.21"></a><span id="l35.21" class="difflineminus">-    // nsISupports interface</span>
<a href="#l35.22"></a><span id="l35.22" class="difflineminus">-    NS_DECL_ISUPPORTS</span>
<a href="#l35.23"></a><span id="l35.23" class="difflineplus">+  // nsISupports interface</span>
<a href="#l35.24"></a><span id="l35.24" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l35.25"></a><span id="l35.25"> </span>
<a href="#l35.26"></a><span id="l35.26">   // nsIImportSettings interface</span>
<a href="#l35.27"></a><span id="l35.27">   NS_DECL_NSIIMPORTSETTINGS</span>
<a href="#l35.28"></a><span id="l35.28"> </span>
<a href="#l35.29"></a><span id="l35.29" class="difflineminus">-private:</span>
<a href="#l35.30"></a><span id="l35.30" class="difflineplus">+ private:</span>
<a href="#l35.31"></a><span id="l35.31">   virtual ~nsOutlookSettings();</span>
<a href="#l35.32"></a><span id="l35.32" class="difflineminus">-</span>
<a href="#l35.33"></a><span id="l35.33"> };</span>
<a href="#l35.34"></a><span id="l35.34"> </span>
<a href="#l35.35"></a><span id="l35.35"> #endif /* nsOutlookSettings_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/mailnews/import/outlook/src/nsOutlookStringBundle.cpp</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/mailnews/import/outlook/src/nsOutlookStringBundle.cpp</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -6,56 +6,48 @@</span>
<a href="#l36.4"></a><span id="l36.4"> #include &quot;prprf.h&quot;</span>
<a href="#l36.5"></a><span id="l36.5"> #include &quot;prmem.h&quot;</span>
<a href="#l36.6"></a><span id="l36.6"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l36.7"></a><span id="l36.7"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l36.8"></a><span id="l36.8"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l36.9"></a><span id="l36.9"> #include &quot;nsOutlookStringBundle.h&quot;</span>
<a href="#l36.10"></a><span id="l36.10"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l36.11"></a><span id="l36.11"> </span>
<a href="#l36.12"></a><span id="l36.12" class="difflineminus">-#define OUTLOOK_MSGS_URL       &quot;chrome://messenger/locale/outlookImportMsgs.properties&quot;</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineplus">+#define OUTLOOK_MSGS_URL \</span>
<a href="#l36.14"></a><span id="l36.14" class="difflineplus">+  &quot;chrome://messenger/locale/outlookImportMsgs.properties&quot;</span>
<a href="#l36.15"></a><span id="l36.15"> </span>
<a href="#l36.16"></a><span id="l36.16"> nsCOMPtr&lt;nsIStringBundle&gt; nsOutlookStringBundle::m_pBundle = nullptr;</span>
<a href="#l36.17"></a><span id="l36.17"> </span>
<a href="#l36.18"></a><span id="l36.18" class="difflineminus">-void nsOutlookStringBundle::GetStringBundle(void)</span>
<a href="#l36.19"></a><span id="l36.19" class="difflineminus">-{</span>
<a href="#l36.20"></a><span id="l36.20" class="difflineminus">-  if (m_pBundle)</span>
<a href="#l36.21"></a><span id="l36.21" class="difflineminus">-    return;</span>
<a href="#l36.22"></a><span id="l36.22" class="difflineplus">+void nsOutlookStringBundle::GetStringBundle(void) {</span>
<a href="#l36.23"></a><span id="l36.23" class="difflineplus">+  if (m_pBundle) return;</span>
<a href="#l36.24"></a><span id="l36.24"> </span>
<a href="#l36.25"></a><span id="l36.25">   nsCOMPtr&lt;nsIStringBundleService&gt; sBundleService =</span>
<a href="#l36.26"></a><span id="l36.26" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l36.27"></a><span id="l36.27" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l36.28"></a><span id="l36.28">   if (sBundleService) {</span>
<a href="#l36.29"></a><span id="l36.29">     sBundleService-&gt;CreateBundle(OUTLOOK_MSGS_URL, getter_AddRefs(m_pBundle));</span>
<a href="#l36.30"></a><span id="l36.30">   }</span>
<a href="#l36.31"></a><span id="l36.31"> }</span>
<a href="#l36.32"></a><span id="l36.32"> </span>
<a href="#l36.33"></a><span id="l36.33" class="difflineminus">-void nsOutlookStringBundle::GetStringByID(int32_t stringID, nsString&amp; result)</span>
<a href="#l36.34"></a><span id="l36.34" class="difflineminus">-{</span>
<a href="#l36.35"></a><span id="l36.35" class="difflineplus">+void nsOutlookStringBundle::GetStringByID(int32_t stringID, nsString &amp;result) {</span>
<a href="#l36.36"></a><span id="l36.36">   char16_t *ptrv = GetStringByID(stringID);</span>
<a href="#l36.37"></a><span id="l36.37">   result = ptrv;</span>
<a href="#l36.38"></a><span id="l36.38">   FreeString(ptrv);</span>
<a href="#l36.39"></a><span id="l36.39"> }</span>
<a href="#l36.40"></a><span id="l36.40"> </span>
<a href="#l36.41"></a><span id="l36.41" class="difflineminus">-char16_t *nsOutlookStringBundle::GetStringByID(int32_t stringID)</span>
<a href="#l36.42"></a><span id="l36.42" class="difflineminus">-{</span>
<a href="#l36.43"></a><span id="l36.43" class="difflineminus">-  if (m_pBundle)</span>
<a href="#l36.44"></a><span id="l36.44" class="difflineminus">-    GetStringBundle();</span>
<a href="#l36.45"></a><span id="l36.45" class="difflineplus">+char16_t *nsOutlookStringBundle::GetStringByID(int32_t stringID) {</span>
<a href="#l36.46"></a><span id="l36.46" class="difflineplus">+  if (m_pBundle) GetStringBundle();</span>
<a href="#l36.47"></a><span id="l36.47"> </span>
<a href="#l36.48"></a><span id="l36.48">   if (m_pBundle) {</span>
<a href="#l36.49"></a><span id="l36.49">     nsAutoString str;</span>
<a href="#l36.50"></a><span id="l36.50">     nsresult rv = m_pBundle-&gt;GetStringFromID(stringID, str);</span>
<a href="#l36.51"></a><span id="l36.51"> </span>
<a href="#l36.52"></a><span id="l36.52" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l36.53"></a><span id="l36.53" class="difflineminus">-      return ToNewUnicode(str);</span>
<a href="#l36.54"></a><span id="l36.54" class="difflineplus">+    if (NS_SUCCEEDED(rv)) return ToNewUnicode(str);</span>
<a href="#l36.55"></a><span id="l36.55">   }</span>
<a href="#l36.56"></a><span id="l36.56"> </span>
<a href="#l36.57"></a><span id="l36.57">   nsString resultString;</span>
<a href="#l36.58"></a><span id="l36.58">   resultString.AppendLiteral(&quot;[StringID &quot;);</span>
<a href="#l36.59"></a><span id="l36.59">   resultString.AppendInt(stringID);</span>
<a href="#l36.60"></a><span id="l36.60">   resultString.AppendLiteral(&quot;?]&quot;);</span>
<a href="#l36.61"></a><span id="l36.61"> </span>
<a href="#l36.62"></a><span id="l36.62">   return ToNewUnicode(resultString);</span>
<a href="#l36.63"></a><span id="l36.63"> }</span>
<a href="#l36.64"></a><span id="l36.64"> </span>
<a href="#l36.65"></a><span id="l36.65" class="difflineminus">-void nsOutlookStringBundle::Cleanup(void)</span>
<a href="#l36.66"></a><span id="l36.66" class="difflineminus">-{</span>
<a href="#l36.67"></a><span id="l36.67" class="difflineminus">-  m_pBundle = nullptr;</span>
<a href="#l36.68"></a><span id="l36.68" class="difflineminus">-}</span>
<a href="#l36.69"></a><span id="l36.69" class="difflineplus">+void nsOutlookStringBundle::Cleanup(void) { m_pBundle = nullptr; }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/mailnews/import/outlook/src/nsOutlookStringBundle.h</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/mailnews/import/outlook/src/nsOutlookStringBundle.h</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -6,33 +6,31 @@</span>
<a href="#l37.4"></a><span id="l37.4"> #define _nsOutlookStringBundle_H__</span>
<a href="#l37.5"></a><span id="l37.5"> </span>
<a href="#l37.6"></a><span id="l37.6"> #include &quot;nsCRTGlue.h&quot;</span>
<a href="#l37.7"></a><span id="l37.7"> #include &quot;nsString.h&quot;</span>
<a href="#l37.8"></a><span id="l37.8"> </span>
<a href="#l37.9"></a><span id="l37.9"> class nsIStringBundle;</span>
<a href="#l37.10"></a><span id="l37.10"> </span>
<a href="#l37.11"></a><span id="l37.11"> class nsOutlookStringBundle {</span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-public:</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineminus">-  static char16_t     * GetStringByID(int32_t stringID);</span>
<a href="#l37.14"></a><span id="l37.14" class="difflineplus">+ public:</span>
<a href="#l37.15"></a><span id="l37.15" class="difflineplus">+  static char16_t* GetStringByID(int32_t stringID);</span>
<a href="#l37.16"></a><span id="l37.16">   static void GetStringByID(int32_t stringID, nsString&amp; result);</span>
<a href="#l37.17"></a><span id="l37.17">   static void GetStringBundle(void);</span>
<a href="#l37.18"></a><span id="l37.18" class="difflineminus">-  static void FreeString(char16_t *pStr) { free(pStr);}</span>
<a href="#l37.19"></a><span id="l37.19" class="difflineplus">+  static void FreeString(char16_t* pStr) { free(pStr); }</span>
<a href="#l37.20"></a><span id="l37.20">   static void Cleanup(void);</span>
<a href="#l37.21"></a><span id="l37.21" class="difflineminus">-private:</span>
<a href="#l37.22"></a><span id="l37.22" class="difflineplus">+</span>
<a href="#l37.23"></a><span id="l37.23" class="difflineplus">+ private:</span>
<a href="#l37.24"></a><span id="l37.24">   static nsCOMPtr&lt;nsIStringBundle&gt; m_pBundle;</span>
<a href="#l37.25"></a><span id="l37.25"> };</span>
<a href="#l37.26"></a><span id="l37.26"> </span>
<a href="#l37.27"></a><span id="l37.27" class="difflineminus">-</span>
<a href="#l37.28"></a><span id="l37.28" class="difflineminus">-</span>
<a href="#l37.29"></a><span id="l37.29" class="difflineminus">-#define OUTLOOKIMPORT_NAME                     2000</span>
<a href="#l37.30"></a><span id="l37.30" class="difflineminus">-#define OUTLOOKIMPORT_DESCRIPTION              2010</span>
<a href="#l37.31"></a><span id="l37.31" class="difflineminus">-#define OUTLOOKIMPORT_MAILBOX_SUCCESS          2002</span>
<a href="#l37.32"></a><span id="l37.32" class="difflineminus">-#define OUTLOOKIMPORT_MAILBOX_BADPARAM         2003</span>
<a href="#l37.33"></a><span id="l37.33" class="difflineminus">-#define OUTLOOKIMPORT_MAILBOX_CONVERTERROR     2004</span>
<a href="#l37.34"></a><span id="l37.34" class="difflineminus">-#define OUTLOOKIMPORT_ADDRNAME                 2005</span>
<a href="#l37.35"></a><span id="l37.35" class="difflineminus">-#define OUTLOOKIMPORT_ADDRESS_SUCCESS          2006</span>
<a href="#l37.36"></a><span id="l37.36" class="difflineminus">-#define OUTLOOKIMPORT_ADDRESS_BADPARAM         2007</span>
<a href="#l37.37"></a><span id="l37.37" class="difflineminus">-#define OUTLOOKIMPORT_ADDRESS_BADSOURCEFILE    2008</span>
<a href="#l37.38"></a><span id="l37.38" class="difflineminus">-#define OUTLOOKIMPORT_ADDRESS_CONVERTERROR     2009</span>
<a href="#l37.39"></a><span id="l37.39" class="difflineminus">-</span>
<a href="#l37.40"></a><span id="l37.40" class="difflineplus">+#define OUTLOOKIMPORT_NAME 2000</span>
<a href="#l37.41"></a><span id="l37.41" class="difflineplus">+#define OUTLOOKIMPORT_DESCRIPTION 2010</span>
<a href="#l37.42"></a><span id="l37.42" class="difflineplus">+#define OUTLOOKIMPORT_MAILBOX_SUCCESS 2002</span>
<a href="#l37.43"></a><span id="l37.43" class="difflineplus">+#define OUTLOOKIMPORT_MAILBOX_BADPARAM 2003</span>
<a href="#l37.44"></a><span id="l37.44" class="difflineplus">+#define OUTLOOKIMPORT_MAILBOX_CONVERTERROR 2004</span>
<a href="#l37.45"></a><span id="l37.45" class="difflineplus">+#define OUTLOOKIMPORT_ADDRNAME 2005</span>
<a href="#l37.46"></a><span id="l37.46" class="difflineplus">+#define OUTLOOKIMPORT_ADDRESS_SUCCESS 2006</span>
<a href="#l37.47"></a><span id="l37.47" class="difflineplus">+#define OUTLOOKIMPORT_ADDRESS_BADPARAM 2007</span>
<a href="#l37.48"></a><span id="l37.48" class="difflineplus">+#define OUTLOOKIMPORT_ADDRESS_BADSOURCEFILE 2008</span>
<a href="#l37.49"></a><span id="l37.49" class="difflineplus">+#define OUTLOOKIMPORT_ADDRESS_CONVERTERROR 2009</span>
<a href="#l37.50"></a><span id="l37.50"> </span>
<a href="#l37.51"></a><span id="l37.51"> #endif /* _nsOutlookStringBundle_H__ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/mailnews/import/outlook/src/rtfDecoder.cpp</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/mailnews/import/outlook/src/rtfDecoder.cpp</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -3,517 +3,558 @@</span>
<a href="#l38.4"></a><span id="l38.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l38.5"></a><span id="l38.5"> </span>
<a href="#l38.6"></a><span id="l38.6"> #include &lt;stack&gt;</span>
<a href="#l38.7"></a><span id="l38.7"> #include &lt;map&gt;</span>
<a href="#l38.8"></a><span id="l38.8"> #include &lt;sstream&gt;</span>
<a href="#l38.9"></a><span id="l38.9"> #include &quot;windows.h&quot;</span>
<a href="#l38.10"></a><span id="l38.10"> #include &quot;rtfDecoder.h&quot;</span>
<a href="#l38.11"></a><span id="l38.11"> </span>
<a href="#l38.12"></a><span id="l38.12" class="difflineminus">-#define SIZEOF(x) (sizeof(x)/sizeof((x)[0]))</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineminus">-#define IS_DIGIT(i)   ((i) &gt;= '0' &amp;&amp; (i) &lt;= '9')</span>
<a href="#l38.14"></a><span id="l38.14" class="difflineminus">-#define IS_ALPHA(VAL) (((VAL) &gt;= 'a' &amp;&amp; (VAL) &lt;= 'z') || ((VAL) &gt;= 'A' &amp;&amp; (VAL) &lt;= 'Z'))</span>
<a href="#l38.15"></a><span id="l38.15" class="difflineplus">+#define SIZEOF(x) (sizeof(x) / sizeof((x)[0]))</span>
<a href="#l38.16"></a><span id="l38.16" class="difflineplus">+#define IS_DIGIT(i) ((i) &gt;= '0' &amp;&amp; (i) &lt;= '9')</span>
<a href="#l38.17"></a><span id="l38.17" class="difflineplus">+#define IS_ALPHA(VAL) \</span>
<a href="#l38.18"></a><span id="l38.18" class="difflineplus">+  (((VAL) &gt;= 'a' &amp;&amp; (VAL) &lt;= 'z') || ((VAL) &gt;= 'A' &amp;&amp; (VAL) &lt;= 'Z'))</span>
<a href="#l38.19"></a><span id="l38.19"> </span>
<a href="#l38.20"></a><span id="l38.20" class="difflineminus">-inline int HexToInt(char ch)</span>
<a href="#l38.21"></a><span id="l38.21" class="difflineminus">-{</span>
<a href="#l38.22"></a><span id="l38.22" class="difflineplus">+inline int HexToInt(char ch) {</span>
<a href="#l38.23"></a><span id="l38.23">   switch (ch) {</span>
<a href="#l38.24"></a><span id="l38.24" class="difflineminus">-  case '0': case '1': case '2': case '3': case '4': case '5': case '6': case '7': case '8': case '9':</span>
<a href="#l38.25"></a><span id="l38.25" class="difflineminus">-    return ch-'0';</span>
<a href="#l38.26"></a><span id="l38.26" class="difflineminus">-  case 'A': case 'B': case 'C': case 'D': case 'E': case 'F':</span>
<a href="#l38.27"></a><span id="l38.27" class="difflineminus">-    return ch-'A'+10;</span>
<a href="#l38.28"></a><span id="l38.28" class="difflineminus">-  case 'a': case 'b': case 'c': case 'd': case 'e': case 'f':</span>
<a href="#l38.29"></a><span id="l38.29" class="difflineminus">-    return ch-'a'+10;</span>
<a href="#l38.30"></a><span id="l38.30" class="difflineminus">-  default:</span>
<a href="#l38.31"></a><span id="l38.31" class="difflineminus">-    return 0;</span>
<a href="#l38.32"></a><span id="l38.32" class="difflineplus">+    case '0':</span>
<a href="#l38.33"></a><span id="l38.33" class="difflineplus">+    case '1':</span>
<a href="#l38.34"></a><span id="l38.34" class="difflineplus">+    case '2':</span>
<a href="#l38.35"></a><span id="l38.35" class="difflineplus">+    case '3':</span>
<a href="#l38.36"></a><span id="l38.36" class="difflineplus">+    case '4':</span>
<a href="#l38.37"></a><span id="l38.37" class="difflineplus">+    case '5':</span>
<a href="#l38.38"></a><span id="l38.38" class="difflineplus">+    case '6':</span>
<a href="#l38.39"></a><span id="l38.39" class="difflineplus">+    case '7':</span>
<a href="#l38.40"></a><span id="l38.40" class="difflineplus">+    case '8':</span>
<a href="#l38.41"></a><span id="l38.41" class="difflineplus">+    case '9':</span>
<a href="#l38.42"></a><span id="l38.42" class="difflineplus">+      return ch - '0';</span>
<a href="#l38.43"></a><span id="l38.43" class="difflineplus">+    case 'A':</span>
<a href="#l38.44"></a><span id="l38.44" class="difflineplus">+    case 'B':</span>
<a href="#l38.45"></a><span id="l38.45" class="difflineplus">+    case 'C':</span>
<a href="#l38.46"></a><span id="l38.46" class="difflineplus">+    case 'D':</span>
<a href="#l38.47"></a><span id="l38.47" class="difflineplus">+    case 'E':</span>
<a href="#l38.48"></a><span id="l38.48" class="difflineplus">+    case 'F':</span>
<a href="#l38.49"></a><span id="l38.49" class="difflineplus">+      return ch - 'A' + 10;</span>
<a href="#l38.50"></a><span id="l38.50" class="difflineplus">+    case 'a':</span>
<a href="#l38.51"></a><span id="l38.51" class="difflineplus">+    case 'b':</span>
<a href="#l38.52"></a><span id="l38.52" class="difflineplus">+    case 'c':</span>
<a href="#l38.53"></a><span id="l38.53" class="difflineplus">+    case 'd':</span>
<a href="#l38.54"></a><span id="l38.54" class="difflineplus">+    case 'e':</span>
<a href="#l38.55"></a><span id="l38.55" class="difflineplus">+    case 'f':</span>
<a href="#l38.56"></a><span id="l38.56" class="difflineplus">+      return ch - 'a' + 10;</span>
<a href="#l38.57"></a><span id="l38.57" class="difflineplus">+    default:</span>
<a href="#l38.58"></a><span id="l38.58" class="difflineplus">+      return 0;</span>
<a href="#l38.59"></a><span id="l38.59">   }</span>
<a href="#l38.60"></a><span id="l38.60"> }</span>
<a href="#l38.61"></a><span id="l38.61"> </span>
<a href="#l38.62"></a><span id="l38.62" class="difflineminus">-inline int CharsetToCP(int charset)</span>
<a href="#l38.63"></a><span id="l38.63" class="difflineminus">-{</span>
<a href="#l38.64"></a><span id="l38.64" class="difflineplus">+inline int CharsetToCP(int charset) {</span>
<a href="#l38.65"></a><span id="l38.65">   // We don't know the Code page for the commented out charsets.</span>
<a href="#l38.66"></a><span id="l38.66">   switch (charset) {</span>
<a href="#l38.67"></a><span id="l38.67" class="difflineminus">-  case 0: return 1252; // ANSI</span>
<a href="#l38.68"></a><span id="l38.68" class="difflineminus">-  case 1: return 0;   // Default</span>
<a href="#l38.69"></a><span id="l38.69" class="difflineminus">-//case 2: return 42; // Symbol</span>
<a href="#l38.70"></a><span id="l38.70" class="difflineminus">-  case 2: return 1252; // Symbol</span>
<a href="#l38.71"></a><span id="l38.71" class="difflineminus">-  case 77: return 10000; // Mac Roman</span>
<a href="#l38.72"></a><span id="l38.72" class="difflineminus">-  case 78: return 10001; // Mac Shift Jis</span>
<a href="#l38.73"></a><span id="l38.73" class="difflineminus">-  case 79: return 10003; // Mac Hangul</span>
<a href="#l38.74"></a><span id="l38.74" class="difflineminus">-  case 80: return 10008; // Mac GB2312</span>
<a href="#l38.75"></a><span id="l38.75" class="difflineminus">-  case 81: return 10002; // Mac Big5</span>
<a href="#l38.76"></a><span id="l38.76" class="difflineminus">-//case 82: Mac Johab (old)</span>
<a href="#l38.77"></a><span id="l38.77" class="difflineminus">-  case 83: return 10005; // Mac Hebrew</span>
<a href="#l38.78"></a><span id="l38.78" class="difflineminus">-  case 84: return 10004; // Mac Arabic</span>
<a href="#l38.79"></a><span id="l38.79" class="difflineminus">-  case 85: return 10006; // Mac Greek</span>
<a href="#l38.80"></a><span id="l38.80" class="difflineminus">-  case 86: return 10081; // Mac Turkish</span>
<a href="#l38.81"></a><span id="l38.81" class="difflineminus">-  case 87: return 10021; // Mac Thai</span>
<a href="#l38.82"></a><span id="l38.82" class="difflineminus">-  case 88: return 10029; // Mac East Europe</span>
<a href="#l38.83"></a><span id="l38.83" class="difflineminus">-  case 89: return 10007; // Mac Russian</span>
<a href="#l38.84"></a><span id="l38.84" class="difflineminus">-  case 128: return 932; // Shift JIS</span>
<a href="#l38.85"></a><span id="l38.85" class="difflineminus">-  case 129: return 949; // Hangul</span>
<a href="#l38.86"></a><span id="l38.86" class="difflineminus">-  case 130: return 1361; // Johab</span>
<a href="#l38.87"></a><span id="l38.87" class="difflineminus">-  case 134: return 936; // GB2312</span>
<a href="#l38.88"></a><span id="l38.88" class="difflineminus">-  case 136: return 950; // Big5</span>
<a href="#l38.89"></a><span id="l38.89" class="difflineminus">-  case 161: return 1253; // Greek</span>
<a href="#l38.90"></a><span id="l38.90" class="difflineminus">-  case 162: return 1254; // Turkish</span>
<a href="#l38.91"></a><span id="l38.91" class="difflineminus">-  case 163: return 1258; // Vietnamese</span>
<a href="#l38.92"></a><span id="l38.92" class="difflineminus">-  case 177: return 1255; // Hebrew</span>
<a href="#l38.93"></a><span id="l38.93" class="difflineminus">-  case 178: return 1256; // Arabic</span>
<a href="#l38.94"></a><span id="l38.94" class="difflineminus">-//case 179: Arabic Traditional (old)</span>
<a href="#l38.95"></a><span id="l38.95" class="difflineminus">-//case 180: Arabic user (old)</span>
<a href="#l38.96"></a><span id="l38.96" class="difflineminus">-//case 181: Hebrew user (old)</span>
<a href="#l38.97"></a><span id="l38.97" class="difflineminus">-  case 186: return 1257; // Baltic</span>
<a href="#l38.98"></a><span id="l38.98" class="difflineminus">-  case 204: return 1251; // Russian</span>
<a href="#l38.99"></a><span id="l38.99" class="difflineminus">-  case 222: return 874; // Thai</span>
<a href="#l38.100"></a><span id="l38.100" class="difflineminus">-  case 238: return 1250; // Eastern European</span>
<a href="#l38.101"></a><span id="l38.101" class="difflineminus">-  case 254: return 437; // PC 437</span>
<a href="#l38.102"></a><span id="l38.102" class="difflineminus">-  case 255: return 850; // OEM</span>
<a href="#l38.103"></a><span id="l38.103" class="difflineminus">-  default: return CP_ACP;</span>
<a href="#l38.104"></a><span id="l38.104" class="difflineplus">+    case 0:</span>
<a href="#l38.105"></a><span id="l38.105" class="difflineplus">+      return 1252;  // ANSI</span>
<a href="#l38.106"></a><span id="l38.106" class="difflineplus">+    case 1:</span>
<a href="#l38.107"></a><span id="l38.107" class="difflineplus">+      return 0;  // Default</span>
<a href="#l38.108"></a><span id="l38.108" class="difflineplus">+                 // case 2: return 42; // Symbol</span>
<a href="#l38.109"></a><span id="l38.109" class="difflineplus">+    case 2:</span>
<a href="#l38.110"></a><span id="l38.110" class="difflineplus">+      return 1252;  // Symbol</span>
<a href="#l38.111"></a><span id="l38.111" class="difflineplus">+    case 77:</span>
<a href="#l38.112"></a><span id="l38.112" class="difflineplus">+      return 10000;  // Mac Roman</span>
<a href="#l38.113"></a><span id="l38.113" class="difflineplus">+    case 78:</span>
<a href="#l38.114"></a><span id="l38.114" class="difflineplus">+      return 10001;  // Mac Shift Jis</span>
<a href="#l38.115"></a><span id="l38.115" class="difflineplus">+    case 79:</span>
<a href="#l38.116"></a><span id="l38.116" class="difflineplus">+      return 10003;  // Mac Hangul</span>
<a href="#l38.117"></a><span id="l38.117" class="difflineplus">+    case 80:</span>
<a href="#l38.118"></a><span id="l38.118" class="difflineplus">+      return 10008;  // Mac GB2312</span>
<a href="#l38.119"></a><span id="l38.119" class="difflineplus">+    case 81:</span>
<a href="#l38.120"></a><span id="l38.120" class="difflineplus">+      return 10002;  // Mac Big5</span>
<a href="#l38.121"></a><span id="l38.121" class="difflineplus">+                     // case 82: Mac Johab (old)</span>
<a href="#l38.122"></a><span id="l38.122" class="difflineplus">+    case 83:</span>
<a href="#l38.123"></a><span id="l38.123" class="difflineplus">+      return 10005;  // Mac Hebrew</span>
<a href="#l38.124"></a><span id="l38.124" class="difflineplus">+    case 84:</span>
<a href="#l38.125"></a><span id="l38.125" class="difflineplus">+      return 10004;  // Mac Arabic</span>
<a href="#l38.126"></a><span id="l38.126" class="difflineplus">+    case 85:</span>
<a href="#l38.127"></a><span id="l38.127" class="difflineplus">+      return 10006;  // Mac Greek</span>
<a href="#l38.128"></a><span id="l38.128" class="difflineplus">+    case 86:</span>
<a href="#l38.129"></a><span id="l38.129" class="difflineplus">+      return 10081;  // Mac Turkish</span>
<a href="#l38.130"></a><span id="l38.130" class="difflineplus">+    case 87:</span>
<a href="#l38.131"></a><span id="l38.131" class="difflineplus">+      return 10021;  // Mac Thai</span>
<a href="#l38.132"></a><span id="l38.132" class="difflineplus">+    case 88:</span>
<a href="#l38.133"></a><span id="l38.133" class="difflineplus">+      return 10029;  // Mac East Europe</span>
<a href="#l38.134"></a><span id="l38.134" class="difflineplus">+    case 89:</span>
<a href="#l38.135"></a><span id="l38.135" class="difflineplus">+      return 10007;  // Mac Russian</span>
<a href="#l38.136"></a><span id="l38.136" class="difflineplus">+    case 128:</span>
<a href="#l38.137"></a><span id="l38.137" class="difflineplus">+      return 932;  // Shift JIS</span>
<a href="#l38.138"></a><span id="l38.138" class="difflineplus">+    case 129:</span>
<a href="#l38.139"></a><span id="l38.139" class="difflineplus">+      return 949;  // Hangul</span>
<a href="#l38.140"></a><span id="l38.140" class="difflineplus">+    case 130:</span>
<a href="#l38.141"></a><span id="l38.141" class="difflineplus">+      return 1361;  // Johab</span>
<a href="#l38.142"></a><span id="l38.142" class="difflineplus">+    case 134:</span>
<a href="#l38.143"></a><span id="l38.143" class="difflineplus">+      return 936;  // GB2312</span>
<a href="#l38.144"></a><span id="l38.144" class="difflineplus">+    case 136:</span>
<a href="#l38.145"></a><span id="l38.145" class="difflineplus">+      return 950;  // Big5</span>
<a href="#l38.146"></a><span id="l38.146" class="difflineplus">+    case 161:</span>
<a href="#l38.147"></a><span id="l38.147" class="difflineplus">+      return 1253;  // Greek</span>
<a href="#l38.148"></a><span id="l38.148" class="difflineplus">+    case 162:</span>
<a href="#l38.149"></a><span id="l38.149" class="difflineplus">+      return 1254;  // Turkish</span>
<a href="#l38.150"></a><span id="l38.150" class="difflineplus">+    case 163:</span>
<a href="#l38.151"></a><span id="l38.151" class="difflineplus">+      return 1258;  // Vietnamese</span>
<a href="#l38.152"></a><span id="l38.152" class="difflineplus">+    case 177:</span>
<a href="#l38.153"></a><span id="l38.153" class="difflineplus">+      return 1255;  // Hebrew</span>
<a href="#l38.154"></a><span id="l38.154" class="difflineplus">+    case 178:</span>
<a href="#l38.155"></a><span id="l38.155" class="difflineplus">+      return 1256;  // Arabic</span>
<a href="#l38.156"></a><span id="l38.156" class="difflineplus">+                    // case 179: Arabic Traditional (old)</span>
<a href="#l38.157"></a><span id="l38.157" class="difflineplus">+      // case 180: Arabic user (old)</span>
<a href="#l38.158"></a><span id="l38.158" class="difflineplus">+      // case 181: Hebrew user (old)</span>
<a href="#l38.159"></a><span id="l38.159" class="difflineplus">+    case 186:</span>
<a href="#l38.160"></a><span id="l38.160" class="difflineplus">+      return 1257;  // Baltic</span>
<a href="#l38.161"></a><span id="l38.161" class="difflineplus">+    case 204:</span>
<a href="#l38.162"></a><span id="l38.162" class="difflineplus">+      return 1251;  // Russian</span>
<a href="#l38.163"></a><span id="l38.163" class="difflineplus">+    case 222:</span>
<a href="#l38.164"></a><span id="l38.164" class="difflineplus">+      return 874;  // Thai</span>
<a href="#l38.165"></a><span id="l38.165" class="difflineplus">+    case 238:</span>
<a href="#l38.166"></a><span id="l38.166" class="difflineplus">+      return 1250;  // Eastern European</span>
<a href="#l38.167"></a><span id="l38.167" class="difflineplus">+    case 254:</span>
<a href="#l38.168"></a><span id="l38.168" class="difflineplus">+      return 437;  // PC 437</span>
<a href="#l38.169"></a><span id="l38.169" class="difflineplus">+    case 255:</span>
<a href="#l38.170"></a><span id="l38.170" class="difflineplus">+      return 850;  // OEM</span>
<a href="#l38.171"></a><span id="l38.171" class="difflineplus">+    default:</span>
<a href="#l38.172"></a><span id="l38.172" class="difflineplus">+      return CP_ACP;</span>
<a href="#l38.173"></a><span id="l38.173">   }</span>
<a href="#l38.174"></a><span id="l38.174"> }</span>
<a href="#l38.175"></a><span id="l38.175"> </span>
<a href="#l38.176"></a><span id="l38.176"> struct FontInfo {</span>
<a href="#l38.177"></a><span id="l38.177" class="difflineminus">-  enum Options {has_fcharset = 0x0001,</span>
<a href="#l38.178"></a><span id="l38.178" class="difflineminus">-                has_cpg      = 0x0002};</span>
<a href="#l38.179"></a><span id="l38.179" class="difflineplus">+  enum Options { has_fcharset = 0x0001, has_cpg = 0x0002 };</span>
<a href="#l38.180"></a><span id="l38.180">   unsigned int options;</span>
<a href="#l38.181"></a><span id="l38.181">   int fcharset;</span>
<a href="#l38.182"></a><span id="l38.182">   unsigned int cpg;</span>
<a href="#l38.183"></a><span id="l38.183">   FontInfo() : options(0), fcharset(0), cpg(0xFFFFFFFF) {}</span>
<a href="#l38.184"></a><span id="l38.184" class="difflineminus">-  unsigned int Codepage()</span>
<a href="#l38.185"></a><span id="l38.185" class="difflineminus">-  {</span>
<a href="#l38.186"></a><span id="l38.186" class="difflineplus">+  unsigned int Codepage() {</span>
<a href="#l38.187"></a><span id="l38.187">     if (options &amp; has_cpg)</span>
<a href="#l38.188"></a><span id="l38.188">       return cpg;</span>
<a href="#l38.189"></a><span id="l38.189">     else if (options &amp; has_fcharset)</span>
<a href="#l38.190"></a><span id="l38.190">       return CharsetToCP(fcharset);</span>
<a href="#l38.191"></a><span id="l38.191" class="difflineminus">-    else return 0xFFFFFFFF;</span>
<a href="#l38.192"></a><span id="l38.192" class="difflineplus">+    else</span>
<a href="#l38.193"></a><span id="l38.193" class="difflineplus">+      return 0xFFFFFFFF;</span>
<a href="#l38.194"></a><span id="l38.194">   }</span>
<a href="#l38.195"></a><span id="l38.195"> };</span>
<a href="#l38.196"></a><span id="l38.196"> typedef std::map&lt;int, FontInfo&gt; Fonttbl;</span>
<a href="#l38.197"></a><span id="l38.197"> </span>
<a href="#l38.198"></a><span id="l38.198"> struct LocalState {</span>
<a href="#l38.199"></a><span id="l38.199" class="difflineminus">-  bool fonttbl;         // When fonts are being defined</span>
<a href="#l38.200"></a><span id="l38.200" class="difflineminus">-  int f;                // Index of the font being defined/used; defines the codepage if no \cpg</span>
<a href="#l38.201"></a><span id="l38.201" class="difflineminus">-  unsigned int uc;      // ucN keyword value; its default is 1</span>
<a href="#l38.202"></a><span id="l38.202" class="difflineminus">-  unsigned int codepage;// defined by \cpg</span>
<a href="#l38.203"></a><span id="l38.203" class="difflineplus">+  bool fonttbl;  // When fonts are being defined</span>
<a href="#l38.204"></a><span id="l38.204" class="difflineplus">+  int f;  // Index of the font being defined/used; defines the codepage if no</span>
<a href="#l38.205"></a><span id="l38.205" class="difflineplus">+          // \cpg</span>
<a href="#l38.206"></a><span id="l38.206" class="difflineplus">+  unsigned int uc;        // ucN keyword value; its default is 1</span>
<a href="#l38.207"></a><span id="l38.207" class="difflineplus">+  unsigned int codepage;  // defined by \cpg</span>
<a href="#l38.208"></a><span id="l38.208"> };</span>
<a href="#l38.209"></a><span id="l38.209"> typedef std::stack&lt;LocalState&gt; StateStack;</span>
<a href="#l38.210"></a><span id="l38.210"> </span>
<a href="#l38.211"></a><span id="l38.211"> struct GlobalState {</span>
<a href="#l38.212"></a><span id="l38.212">   enum Pcdata_state { pcdsno, pcdsin, pcdsfinished };</span>
<a href="#l38.213"></a><span id="l38.213">   std::istream&amp; stream;</span>
<a href="#l38.214"></a><span id="l38.214">   Fonttbl fonttbl;</span>
<a href="#l38.215"></a><span id="l38.215">   StateStack stack;</span>
<a href="#l38.216"></a><span id="l38.216" class="difflineminus">-  unsigned int codepage; // defined by \ansi, \mac, \pc, \pca, and \ansicpgN</span>
<a href="#l38.217"></a><span id="l38.217" class="difflineplus">+  unsigned int codepage;  // defined by \ansi, \mac, \pc, \pca, and \ansicpgN</span>
<a href="#l38.218"></a><span id="l38.218">   int deff;</span>
<a href="#l38.219"></a><span id="l38.219">   std::stringstream pcdata_a;</span>
<a href="#l38.220"></a><span id="l38.220">   unsigned int pcdata_a_codepage;</span>
<a href="#l38.221"></a><span id="l38.221">   Pcdata_state pcdata_a_state;</span>
<a href="#l38.222"></a><span id="l38.222"> </span>
<a href="#l38.223"></a><span id="l38.223">   explicit GlobalState(std::istream&amp; s)</span>
<a href="#l38.224"></a><span id="l38.224" class="difflineminus">-    : stream(s), codepage(CP_ACP), deff(-1), pcdata_a_state(pcdsno)</span>
<a href="#l38.225"></a><span id="l38.225" class="difflineminus">-  {</span>
<a href="#l38.226"></a><span id="l38.226" class="difflineplus">+      : stream(s), codepage(CP_ACP), deff(-1), pcdata_a_state(pcdsno) {</span>
<a href="#l38.227"></a><span id="l38.227">     LocalState st;</span>
<a href="#l38.228"></a><span id="l38.228">     st.fonttbl = false;</span>
<a href="#l38.229"></a><span id="l38.229">     st.f = -1;</span>
<a href="#l38.230"></a><span id="l38.230">     st.uc = 1;</span>
<a href="#l38.231"></a><span id="l38.231">     st.codepage = 0xFFFFFFFF;</span>
<a href="#l38.232"></a><span id="l38.232">     stack.push(st);</span>
<a href="#l38.233"></a><span id="l38.233">   }</span>
<a href="#l38.234"></a><span id="l38.234" class="difflineminus">-  unsigned int GetCurrentCP()</span>
<a href="#l38.235"></a><span id="l38.235" class="difflineminus">-  {</span>
<a href="#l38.236"></a><span id="l38.236" class="difflineminus">-    if (stack.top().codepage != 0xFFFFFFFF) // \cpg in use</span>
<a href="#l38.237"></a><span id="l38.237" class="difflineplus">+  unsigned int GetCurrentCP() {</span>
<a href="#l38.238"></a><span id="l38.238" class="difflineplus">+    if (stack.top().codepage != 0xFFFFFFFF)  // \cpg in use</span>
<a href="#l38.239"></a><span id="l38.239">       return stack.top().codepage;</span>
<a href="#l38.240"></a><span id="l38.240">     // \cpg not used; use font settings</span>
<a href="#l38.241"></a><span id="l38.241">     int f = (stack.top().f != -1) ? stack.top().f : deff;</span>
<a href="#l38.242"></a><span id="l38.242">     if (f != -1) {</span>
<a href="#l38.243"></a><span id="l38.243">       Fonttbl::iterator iter = fonttbl.find(f);</span>
<a href="#l38.244"></a><span id="l38.244">       if (iter != fonttbl.end()) {</span>
<a href="#l38.245"></a><span id="l38.245">         unsigned int cp = iter-&gt;second.Codepage();</span>
<a href="#l38.246"></a><span id="l38.246" class="difflineminus">-        if (cp != 0xFFFFFFFF)</span>
<a href="#l38.247"></a><span id="l38.247" class="difflineminus">-          return cp;</span>
<a href="#l38.248"></a><span id="l38.248" class="difflineplus">+        if (cp != 0xFFFFFFFF) return cp;</span>
<a href="#l38.249"></a><span id="l38.249">       }</span>
<a href="#l38.250"></a><span id="l38.250">     }</span>
<a href="#l38.251"></a><span id="l38.251" class="difflineminus">-    return codepage; // No overrides; use the top-level legacy setting</span>
<a href="#l38.252"></a><span id="l38.252" class="difflineplus">+    return codepage;  // No overrides; use the top-level legacy setting</span>
<a href="#l38.253"></a><span id="l38.253">   }</span>
<a href="#l38.254"></a><span id="l38.254"> };</span>
<a href="#l38.255"></a><span id="l38.255"> </span>
<a href="#l38.256"></a><span id="l38.256"> struct Keyword {</span>
<a href="#l38.257"></a><span id="l38.257">   char name[33];</span>
<a href="#l38.258"></a><span id="l38.258">   bool hasVal;</span>
<a href="#l38.259"></a><span id="l38.259">   int val;</span>
<a href="#l38.260"></a><span id="l38.260"> };</span>
<a href="#l38.261"></a><span id="l38.261"> </span>
<a href="#l38.262"></a><span id="l38.262"> class Lexem {</span>
<a href="#l38.263"></a><span id="l38.263" class="difflineminus">-public:</span>
<a href="#l38.264"></a><span id="l38.264" class="difflineminus">-  enum Type {ltGroupBegin, ltGroupEnd, ltKeyword, ltPCDATA_A, ltPCDATA_W,</span>
<a href="#l38.265"></a><span id="l38.265" class="difflineminus">-             ltBDATA, ltEOF, ltError};</span>
<a href="#l38.266"></a><span id="l38.266" class="difflineminus">-  explicit Lexem(Type t=ltError) : m_type(t) {}</span>
<a href="#l38.267"></a><span id="l38.267" class="difflineminus">-  Lexem(Lexem&amp; from)</span>
<a href="#l38.268"></a><span id="l38.268" class="difflineminus">-  {</span>
<a href="#l38.269"></a><span id="l38.269" class="difflineplus">+ public:</span>
<a href="#l38.270"></a><span id="l38.270" class="difflineplus">+  enum Type {</span>
<a href="#l38.271"></a><span id="l38.271" class="difflineplus">+    ltGroupBegin,</span>
<a href="#l38.272"></a><span id="l38.272" class="difflineplus">+    ltGroupEnd,</span>
<a href="#l38.273"></a><span id="l38.273" class="difflineplus">+    ltKeyword,</span>
<a href="#l38.274"></a><span id="l38.274" class="difflineplus">+    ltPCDATA_A,</span>
<a href="#l38.275"></a><span id="l38.275" class="difflineplus">+    ltPCDATA_W,</span>
<a href="#l38.276"></a><span id="l38.276" class="difflineplus">+    ltBDATA,</span>
<a href="#l38.277"></a><span id="l38.277" class="difflineplus">+    ltEOF,</span>
<a href="#l38.278"></a><span id="l38.278" class="difflineplus">+    ltError</span>
<a href="#l38.279"></a><span id="l38.279" class="difflineplus">+  };</span>
<a href="#l38.280"></a><span id="l38.280" class="difflineplus">+  explicit Lexem(Type t = ltError) : m_type(t) {}</span>
<a href="#l38.281"></a><span id="l38.281" class="difflineplus">+  Lexem(Lexem&amp; from) {</span>
<a href="#l38.282"></a><span id="l38.282">     switch (m_type = from.m_type) {</span>
<a href="#l38.283"></a><span id="l38.283" class="difflineminus">-    case ltKeyword:</span>
<a href="#l38.284"></a><span id="l38.284" class="difflineminus">-      m_keyword = from.m_keyword;</span>
<a href="#l38.285"></a><span id="l38.285" class="difflineminus">-      break;</span>
<a href="#l38.286"></a><span id="l38.286" class="difflineminus">-    case ltPCDATA_A:</span>
<a href="#l38.287"></a><span id="l38.287" class="difflineminus">-      m_pcdata_a = from.m_pcdata_a;</span>
<a href="#l38.288"></a><span id="l38.288" class="difflineminus">-      break;</span>
<a href="#l38.289"></a><span id="l38.289" class="difflineminus">-    case ltPCDATA_W:</span>
<a href="#l38.290"></a><span id="l38.290" class="difflineminus">-      m_pcdata_w = from.m_pcdata_w;</span>
<a href="#l38.291"></a><span id="l38.291" class="difflineminus">-      break;</span>
<a href="#l38.292"></a><span id="l38.292" class="difflineminus">-    case ltBDATA:</span>
<a href="#l38.293"></a><span id="l38.293" class="difflineminus">-      m_bdata = from.m_bdata;  // Move pointers when copying.</span>
<a href="#l38.294"></a><span id="l38.294" class="difflineminus">-      from.m_type = ltError;   // Invalidate the original. Not nice.</span>
<a href="#l38.295"></a><span id="l38.295" class="difflineminus">-      break;</span>
<a href="#l38.296"></a><span id="l38.296" class="difflineminus">-    }</span>
<a href="#l38.297"></a><span id="l38.297" class="difflineminus">-  }</span>
<a href="#l38.298"></a><span id="l38.298" class="difflineminus">-  ~Lexem() { Clear(); }</span>
<a href="#l38.299"></a><span id="l38.299" class="difflineminus">-  Lexem&amp; operator = (Lexem&amp; from)</span>
<a href="#l38.300"></a><span id="l38.300" class="difflineminus">-  {</span>
<a href="#l38.301"></a><span id="l38.301" class="difflineminus">-    if (&amp;from != this) {</span>
<a href="#l38.302"></a><span id="l38.302" class="difflineminus">-      Clear();</span>
<a href="#l38.303"></a><span id="l38.303" class="difflineminus">-      switch (m_type = from.m_type) {</span>
<a href="#l38.304"></a><span id="l38.304">       case ltKeyword:</span>
<a href="#l38.305"></a><span id="l38.305">         m_keyword = from.m_keyword;</span>
<a href="#l38.306"></a><span id="l38.306">         break;</span>
<a href="#l38.307"></a><span id="l38.307">       case ltPCDATA_A:</span>
<a href="#l38.308"></a><span id="l38.308">         m_pcdata_a = from.m_pcdata_a;</span>
<a href="#l38.309"></a><span id="l38.309">         break;</span>
<a href="#l38.310"></a><span id="l38.310">       case ltPCDATA_W:</span>
<a href="#l38.311"></a><span id="l38.311">         m_pcdata_w = from.m_pcdata_w;</span>
<a href="#l38.312"></a><span id="l38.312">         break;</span>
<a href="#l38.313"></a><span id="l38.313">       case ltBDATA:</span>
<a href="#l38.314"></a><span id="l38.314">         m_bdata = from.m_bdata;  // Move pointers when copying.</span>
<a href="#l38.315"></a><span id="l38.315">         from.m_type = ltError;   // Invalidate the original. Not nice.</span>
<a href="#l38.316"></a><span id="l38.316">         break;</span>
<a href="#l38.317"></a><span id="l38.317" class="difflineplus">+    }</span>
<a href="#l38.318"></a><span id="l38.318" class="difflineplus">+  }</span>
<a href="#l38.319"></a><span id="l38.319" class="difflineplus">+  ~Lexem() { Clear(); }</span>
<a href="#l38.320"></a><span id="l38.320" class="difflineplus">+  Lexem&amp; operator=(Lexem&amp; from) {</span>
<a href="#l38.321"></a><span id="l38.321" class="difflineplus">+    if (&amp;from != this) {</span>
<a href="#l38.322"></a><span id="l38.322" class="difflineplus">+      Clear();</span>
<a href="#l38.323"></a><span id="l38.323" class="difflineplus">+      switch (m_type = from.m_type) {</span>
<a href="#l38.324"></a><span id="l38.324" class="difflineplus">+        case ltKeyword:</span>
<a href="#l38.325"></a><span id="l38.325" class="difflineplus">+          m_keyword = from.m_keyword;</span>
<a href="#l38.326"></a><span id="l38.326" class="difflineplus">+          break;</span>
<a href="#l38.327"></a><span id="l38.327" class="difflineplus">+        case ltPCDATA_A:</span>
<a href="#l38.328"></a><span id="l38.328" class="difflineplus">+          m_pcdata_a = from.m_pcdata_a;</span>
<a href="#l38.329"></a><span id="l38.329" class="difflineplus">+          break;</span>
<a href="#l38.330"></a><span id="l38.330" class="difflineplus">+        case ltPCDATA_W:</span>
<a href="#l38.331"></a><span id="l38.331" class="difflineplus">+          m_pcdata_w = from.m_pcdata_w;</span>
<a href="#l38.332"></a><span id="l38.332" class="difflineplus">+          break;</span>
<a href="#l38.333"></a><span id="l38.333" class="difflineplus">+        case ltBDATA:</span>
<a href="#l38.334"></a><span id="l38.334" class="difflineplus">+          m_bdata = from.m_bdata;  // Move pointers when copying.</span>
<a href="#l38.335"></a><span id="l38.335" class="difflineplus">+          from.m_type = ltError;   // Invalidate the original. Not nice.</span>
<a href="#l38.336"></a><span id="l38.336" class="difflineplus">+          break;</span>
<a href="#l38.337"></a><span id="l38.337">       }</span>
<a href="#l38.338"></a><span id="l38.338">     }</span>
<a href="#l38.339"></a><span id="l38.339">     return *this;</span>
<a href="#l38.340"></a><span id="l38.340">   }</span>
<a href="#l38.341"></a><span id="l38.341">   Type type() const { return m_type; }</span>
<a href="#l38.342"></a><span id="l38.342" class="difflineminus">-  void SetPCDATA_A(char chdata)</span>
<a href="#l38.343"></a><span id="l38.343" class="difflineminus">-  {</span>
<a href="#l38.344"></a><span id="l38.344" class="difflineplus">+  void SetPCDATA_A(char chdata) {</span>
<a href="#l38.345"></a><span id="l38.345">     Clear();</span>
<a href="#l38.346"></a><span id="l38.346">     m_pcdata_a = chdata;</span>
<a href="#l38.347"></a><span id="l38.347">     m_type = ltPCDATA_A;</span>
<a href="#l38.348"></a><span id="l38.348">   }</span>
<a href="#l38.349"></a><span id="l38.349" class="difflineminus">-  void SetPCDATA_W(wchar_t chdata)</span>
<a href="#l38.350"></a><span id="l38.350" class="difflineminus">-  {</span>
<a href="#l38.351"></a><span id="l38.351" class="difflineplus">+  void SetPCDATA_W(wchar_t chdata) {</span>
<a href="#l38.352"></a><span id="l38.352">     Clear();</span>
<a href="#l38.353"></a><span id="l38.353">     m_pcdata_w = chdata;</span>
<a href="#l38.354"></a><span id="l38.354">     m_type = ltPCDATA_W;</span>
<a href="#l38.355"></a><span id="l38.355">   }</span>
<a href="#l38.356"></a><span id="l38.356" class="difflineminus">-  void SetBDATA(const char* data, int sz)</span>
<a href="#l38.357"></a><span id="l38.357" class="difflineminus">-  {</span>
<a href="#l38.358"></a><span id="l38.358" class="difflineminus">-    char* tmp = new char[sz]; // to allow getting the data from itself</span>
<a href="#l38.359"></a><span id="l38.359" class="difflineplus">+  void SetBDATA(const char* data, int sz) {</span>
<a href="#l38.360"></a><span id="l38.360" class="difflineplus">+    char* tmp = new char[sz];  // to allow getting the data from itself</span>
<a href="#l38.361"></a><span id="l38.361">     if (tmp) {</span>
<a href="#l38.362"></a><span id="l38.362">       memcpy(tmp, data, sz);</span>
<a href="#l38.363"></a><span id="l38.363">       Clear();</span>
<a href="#l38.364"></a><span id="l38.364">       m_bdata.data = tmp;</span>
<a href="#l38.365"></a><span id="l38.365">       m_bdata.sz = sz;</span>
<a href="#l38.366"></a><span id="l38.366">       m_type = ltBDATA;</span>
<a href="#l38.367"></a><span id="l38.367" class="difflineminus">-    }</span>
<a href="#l38.368"></a><span id="l38.368" class="difflineminus">-    else m_type = ltError;</span>
<a href="#l38.369"></a><span id="l38.369" class="difflineplus">+    } else</span>
<a href="#l38.370"></a><span id="l38.370" class="difflineplus">+      m_type = ltError;</span>
<a href="#l38.371"></a><span id="l38.371">   }</span>
<a href="#l38.372"></a><span id="l38.372" class="difflineminus">-  void SetKeyword(const Keyword&amp; src)</span>
<a href="#l38.373"></a><span id="l38.373" class="difflineminus">-  {</span>
<a href="#l38.374"></a><span id="l38.374" class="difflineplus">+  void SetKeyword(const Keyword&amp; src) {</span>
<a href="#l38.375"></a><span id="l38.375">     Clear();</span>
<a href="#l38.376"></a><span id="l38.376">     m_type = ltKeyword;</span>
<a href="#l38.377"></a><span id="l38.377">     m_keyword = src;</span>
<a href="#l38.378"></a><span id="l38.378">   }</span>
<a href="#l38.379"></a><span id="l38.379" class="difflineminus">-  void SetKeyword(const char* name, bool hasVal=false, int val=0)</span>
<a href="#l38.380"></a><span id="l38.380" class="difflineminus">-  {</span>
<a href="#l38.381"></a><span id="l38.381" class="difflineplus">+  void SetKeyword(const char* name, bool hasVal = false, int val = 0) {</span>
<a href="#l38.382"></a><span id="l38.382">     char tmp[SIZEOF(m_keyword.name)];</span>
<a href="#l38.383"></a><span id="l38.383" class="difflineminus">-    strncpy(tmp, name, SIZEOF(m_keyword.name)-1); // to allow copy drom itself</span>
<a href="#l38.384"></a><span id="l38.384" class="difflineminus">-    tmp[SIZEOF(m_keyword.name)-1]=0;</span>
<a href="#l38.385"></a><span id="l38.385" class="difflineplus">+    strncpy(tmp, name,</span>
<a href="#l38.386"></a><span id="l38.386" class="difflineplus">+            SIZEOF(m_keyword.name) - 1);  // to allow copy drom itself</span>
<a href="#l38.387"></a><span id="l38.387" class="difflineplus">+    tmp[SIZEOF(m_keyword.name) - 1] = 0;</span>
<a href="#l38.388"></a><span id="l38.388">     Clear();</span>
<a href="#l38.389"></a><span id="l38.389">     m_type = ltKeyword;</span>
<a href="#l38.390"></a><span id="l38.390">     memcpy(m_keyword.name, tmp, SIZEOF(m_keyword.name));</span>
<a href="#l38.391"></a><span id="l38.391" class="difflineminus">-    m_keyword.hasVal=hasVal;</span>
<a href="#l38.392"></a><span id="l38.392" class="difflineminus">-    m_keyword.val=val;</span>
<a href="#l38.393"></a><span id="l38.393" class="difflineplus">+    m_keyword.hasVal = hasVal;</span>
<a href="#l38.394"></a><span id="l38.394" class="difflineplus">+    m_keyword.val = val;</span>
<a href="#l38.395"></a><span id="l38.395">   }</span>
<a href="#l38.396"></a><span id="l38.396">   const char* KeywordName() const {</span>
<a href="#l38.397"></a><span id="l38.397" class="difflineminus">-    return (m_type == ltKeyword) ? m_keyword.name : 0; }</span>
<a href="#l38.398"></a><span id="l38.398" class="difflineplus">+    return (m_type == ltKeyword) ? m_keyword.name : 0;</span>
<a href="#l38.399"></a><span id="l38.399" class="difflineplus">+  }</span>
<a href="#l38.400"></a><span id="l38.400">   const int* KeywordVal() const {</span>
<a href="#l38.401"></a><span id="l38.401" class="difflineminus">-    return ((m_type == ltKeyword) &amp;&amp; m_keyword.hasVal) ? &amp;m_keyword.val : 0; }</span>
<a href="#l38.402"></a><span id="l38.402" class="difflineplus">+    return ((m_type == ltKeyword) &amp;&amp; m_keyword.hasVal) ? &amp;m_keyword.val : 0;</span>
<a href="#l38.403"></a><span id="l38.403" class="difflineplus">+  }</span>
<a href="#l38.404"></a><span id="l38.404">   char pcdata_a() const { return (m_type == ltPCDATA_A) ? m_pcdata_a : 0; }</span>
<a href="#l38.405"></a><span id="l38.405">   wchar_t pcdata_w() const { return (m_type == ltPCDATA_W) ? m_pcdata_w : 0; }</span>
<a href="#l38.406"></a><span id="l38.406">   const char* bdata() const { return (m_type == ltBDATA) ? m_bdata.data : 0; }</span>
<a href="#l38.407"></a><span id="l38.407">   int bdata_sz() const { return (m_type == ltBDATA) ? m_bdata.sz : 0; }</span>
<a href="#l38.408"></a><span id="l38.408">   static Lexem eof;</span>
<a href="#l38.409"></a><span id="l38.409">   static Lexem groupBegin;</span>
<a href="#l38.410"></a><span id="l38.410">   static Lexem groupEnd;</span>
<a href="#l38.411"></a><span id="l38.411">   static Lexem error;</span>
<a href="#l38.412"></a><span id="l38.412" class="difflineminus">-private:</span>
<a href="#l38.413"></a><span id="l38.413" class="difflineplus">+</span>
<a href="#l38.414"></a><span id="l38.414" class="difflineplus">+ private:</span>
<a href="#l38.415"></a><span id="l38.415">   struct BDATA {</span>
<a href="#l38.416"></a><span id="l38.416">     size_t sz;</span>
<a href="#l38.417"></a><span id="l38.417">     char* data;</span>
<a href="#l38.418"></a><span id="l38.418">   };</span>
<a href="#l38.419"></a><span id="l38.419"> </span>
<a href="#l38.420"></a><span id="l38.420">   Type m_type;</span>
<a href="#l38.421"></a><span id="l38.421">   union {</span>
<a href="#l38.422"></a><span id="l38.422">     Keyword m_keyword;</span>
<a href="#l38.423"></a><span id="l38.423">     char m_pcdata_a;</span>
<a href="#l38.424"></a><span id="l38.424">     wchar_t m_pcdata_w;</span>
<a href="#l38.425"></a><span id="l38.425">     BDATA m_bdata;</span>
<a href="#l38.426"></a><span id="l38.426">   };</span>
<a href="#l38.427"></a><span id="l38.427">   // This function leaves the object in the broken state. Must be followed</span>
<a href="#l38.428"></a><span id="l38.428">   // by a correct initialization.</span>
<a href="#l38.429"></a><span id="l38.429" class="difflineminus">-  void Clear()</span>
<a href="#l38.430"></a><span id="l38.430" class="difflineminus">-  {</span>
<a href="#l38.431"></a><span id="l38.431" class="difflineplus">+  void Clear() {</span>
<a href="#l38.432"></a><span id="l38.432">     switch (m_type) {</span>
<a href="#l38.433"></a><span id="l38.433" class="difflineminus">-    case ltBDATA:</span>
<a href="#l38.434"></a><span id="l38.434" class="difflineminus">-      delete[] m_bdata.data;</span>
<a href="#l38.435"></a><span id="l38.435" class="difflineminus">-      break;</span>
<a href="#l38.436"></a><span id="l38.436" class="difflineplus">+      case ltBDATA:</span>
<a href="#l38.437"></a><span id="l38.437" class="difflineplus">+        delete[] m_bdata.data;</span>
<a href="#l38.438"></a><span id="l38.438" class="difflineplus">+        break;</span>
<a href="#l38.439"></a><span id="l38.439">     }</span>
<a href="#l38.440"></a><span id="l38.440" class="difflineminus">-//  m_type = ltError;</span>
<a href="#l38.441"></a><span id="l38.441" class="difflineplus">+    //  m_type = ltError;</span>
<a href="#l38.442"></a><span id="l38.442">   }</span>
<a href="#l38.443"></a><span id="l38.443"> };</span>
<a href="#l38.444"></a><span id="l38.444"> </span>
<a href="#l38.445"></a><span id="l38.445"> Lexem Lexem::eof(ltEOF);</span>
<a href="#l38.446"></a><span id="l38.446"> Lexem Lexem::groupBegin(ltGroupBegin);</span>
<a href="#l38.447"></a><span id="l38.447"> Lexem Lexem::groupEnd(ltGroupEnd);</span>
<a href="#l38.448"></a><span id="l38.448"> Lexem Lexem::error(ltError);</span>
<a href="#l38.449"></a><span id="l38.449"> </span>
<a href="#l38.450"></a><span id="l38.450"> // This function moves pos. When calling the function, pos must be next to the</span>
<a href="#l38.451"></a><span id="l38.451"> // backslash; pos must be in the same sequence and before end!</span>
<a href="#l38.452"></a><span id="l38.452" class="difflineminus">-Keyword GetKeyword(std::istream&amp; stream)</span>
<a href="#l38.453"></a><span id="l38.453" class="difflineminus">-{</span>
<a href="#l38.454"></a><span id="l38.454" class="difflineplus">+Keyword GetKeyword(std::istream&amp; stream) {</span>
<a href="#l38.455"></a><span id="l38.455">   Keyword keyword = {&quot;&quot;, false, 0};</span>
<a href="#l38.456"></a><span id="l38.456">   char ch;</span>
<a href="#l38.457"></a><span id="l38.457" class="difflineminus">-  if (stream.get(ch).eof())</span>
<a href="#l38.458"></a><span id="l38.458" class="difflineminus">-    return keyword;</span>
<a href="#l38.459"></a><span id="l38.459" class="difflineplus">+  if (stream.get(ch).eof()) return keyword;</span>
<a href="#l38.460"></a><span id="l38.460">   // Control word; maybe delimiter and value</span>
<a href="#l38.461"></a><span id="l38.461">   if (IS_ALPHA(ch)) {</span>
<a href="#l38.462"></a><span id="l38.462">     int i = 0;</span>
<a href="#l38.463"></a><span id="l38.463">     do {</span>
<a href="#l38.464"></a><span id="l38.464">       // We take up to 32 characters into account, skipping over extra</span>
<a href="#l38.465"></a><span id="l38.465">       // characters (allowing for some non-conformant implementation).</span>
<a href="#l38.466"></a><span id="l38.466" class="difflineminus">-      if (i &lt; 32)</span>
<a href="#l38.467"></a><span id="l38.467" class="difflineminus">-        keyword.name[i++] = ch;</span>
<a href="#l38.468"></a><span id="l38.468" class="difflineplus">+      if (i &lt; 32) keyword.name[i++] = ch;</span>
<a href="#l38.469"></a><span id="l38.469">     } while (!stream.get(ch).eof() &amp;&amp; IS_ALPHA(ch));</span>
<a href="#l38.470"></a><span id="l38.470" class="difflineminus">-    keyword.name[i] = 0; // NULL-terminating</span>
<a href="#l38.471"></a><span id="l38.471" class="difflineminus">-    if (!stream.eof() &amp;&amp; (IS_DIGIT(ch) || (ch == '-'))) { // Value begin</span>
<a href="#l38.472"></a><span id="l38.472" class="difflineplus">+    keyword.name[i] = 0;                                   // NULL-terminating</span>
<a href="#l38.473"></a><span id="l38.473" class="difflineplus">+    if (!stream.eof() &amp;&amp; (IS_DIGIT(ch) || (ch == '-'))) {  // Value begin</span>
<a href="#l38.474"></a><span id="l38.474">       keyword.hasVal = true;</span>
<a href="#l38.475"></a><span id="l38.475">       bool negative = (ch == '-');</span>
<a href="#l38.476"></a><span id="l38.476">       if (negative) stream.get(ch);</span>
<a href="#l38.477"></a><span id="l38.477">       i = 0;</span>
<a href="#l38.478"></a><span id="l38.478">       while (!stream.eof() &amp;&amp; IS_DIGIT(ch)) {</span>
<a href="#l38.479"></a><span id="l38.479">         // We take into account only 10 digits, skip other. Older specs stated</span>
<a href="#l38.480"></a><span id="l38.480">         // that we must be ready for an arbitrary number of digits.</span>
<a href="#l38.481"></a><span id="l38.481" class="difflineminus">-        if (i++ &lt; 10)</span>
<a href="#l38.482"></a><span id="l38.482" class="difflineminus">-          keyword.val = keyword.val*10 + (ch - '0');</span>
<a href="#l38.483"></a><span id="l38.483" class="difflineplus">+        if (i++ &lt; 10) keyword.val = keyword.val * 10 + (ch - '0');</span>
<a href="#l38.484"></a><span id="l38.484">         stream.get(ch);</span>
<a href="#l38.485"></a><span id="l38.485">       }</span>
<a href="#l38.486"></a><span id="l38.486">       if (negative) keyword.val = -keyword.val;</span>
<a href="#l38.487"></a><span id="l38.487">     }</span>
<a href="#l38.488"></a><span id="l38.488" class="difflineminus">-     // End of control word; the space is just a delimiter - skip it</span>
<a href="#l38.489"></a><span id="l38.489" class="difflineminus">-    if (!stream.eof() &amp;&amp; !(ch == ' '))</span>
<a href="#l38.490"></a><span id="l38.490" class="difflineminus">-      stream.unget();</span>
<a href="#l38.491"></a><span id="l38.491" class="difflineminus">-  }</span>
<a href="#l38.492"></a><span id="l38.492" class="difflineminus">-  else { // Control symbol</span>
<a href="#l38.493"></a><span id="l38.493" class="difflineplus">+    // End of control word; the space is just a delimiter - skip it</span>
<a href="#l38.494"></a><span id="l38.494" class="difflineplus">+    if (!stream.eof() &amp;&amp; !(ch == ' ')) stream.unget();</span>
<a href="#l38.495"></a><span id="l38.495" class="difflineplus">+  } else {  // Control symbol</span>
<a href="#l38.496"></a><span id="l38.496">     keyword.name[0] = ch, keyword.name[1] = 0;</span>
<a href="#l38.497"></a><span id="l38.497">   }</span>
<a href="#l38.498"></a><span id="l38.498">   return keyword;</span>
<a href="#l38.499"></a><span id="l38.499"> }</span>
<a href="#l38.500"></a><span id="l38.500"> </span>
<a href="#l38.501"></a><span id="l38.501" class="difflineminus">-void GetLexem(std::istream&amp; stream, Lexem&amp; result)</span>
<a href="#l38.502"></a><span id="l38.502" class="difflineminus">-{</span>
<a href="#l38.503"></a><span id="l38.503" class="difflineplus">+void GetLexem(std::istream&amp; stream, Lexem&amp; result) {</span>
<a href="#l38.504"></a><span id="l38.504">   // We always stay at the beginning of the next lexem or a crlf</span>
<a href="#l38.505"></a><span id="l38.505">   // If it's a brace then it's group begin/end</span>
<a href="#l38.506"></a><span id="l38.506">   // If it's a backslash -&gt; Preprocess</span>
<a href="#l38.507"></a><span id="l38.507">   // - if it's a \u or \' -&gt; make UTF16 character</span>
<a href="#l38.508"></a><span id="l38.508">   // - else it's a keyword -&gt; Process (e.g., remember the codepage)</span>
<a href="#l38.509"></a><span id="l38.509">   // - (if the keyword is \bin then the following is #BDATA)</span>
<a href="#l38.510"></a><span id="l38.510">   // If it's some other character -&gt; Preprocess</span>
<a href="#l38.511"></a><span id="l38.511">   // - if it's 0x09 -&gt; it's the keyword \tab</span>
<a href="#l38.512"></a><span id="l38.512">   // - else it's a PCDATA</span>
<a href="#l38.513"></a><span id="l38.513">   char ch;</span>
<a href="#l38.514"></a><span id="l38.514" class="difflineminus">-  while (!stream.get(ch).eof() &amp;&amp; ((ch == '\n') || (ch == '\r'))); // Skip crlf</span>
<a href="#l38.515"></a><span id="l38.515" class="difflineplus">+  while (!stream.get(ch).eof() &amp;&amp; ((ch == '\n') || (ch == '\r')))</span>
<a href="#l38.516"></a><span id="l38.516" class="difflineplus">+    ;  // Skip crlf</span>
<a href="#l38.517"></a><span id="l38.517">   if (stream.eof())</span>
<a href="#l38.518"></a><span id="l38.518">     result = Lexem::eof;</span>
<a href="#l38.519"></a><span id="l38.519">   else {</span>
<a href="#l38.520"></a><span id="l38.520">     switch (ch) {</span>
<a href="#l38.521"></a><span id="l38.521" class="difflineminus">-    case '{': // Group begin</span>
<a href="#l38.522"></a><span id="l38.522" class="difflineminus">-    case '}': // Group end</span>
<a href="#l38.523"></a><span id="l38.523" class="difflineminus">-      result = (ch == '{') ? Lexem::groupBegin : Lexem::groupEnd;</span>
<a href="#l38.524"></a><span id="l38.524" class="difflineminus">-      break;</span>
<a href="#l38.525"></a><span id="l38.525" class="difflineminus">-    case '\\': // Keyword</span>
<a href="#l38.526"></a><span id="l38.526" class="difflineminus">-      result.SetKeyword(GetKeyword(stream));</span>
<a href="#l38.527"></a><span id="l38.527" class="difflineminus">-      break;</span>
<a href="#l38.528"></a><span id="l38.528" class="difflineminus">-    case '\t': // tab</span>
<a href="#l38.529"></a><span id="l38.529" class="difflineminus">-      result.SetKeyword(&quot;tab&quot;);</span>
<a href="#l38.530"></a><span id="l38.530" class="difflineminus">-      break;</span>
<a href="#l38.531"></a><span id="l38.531" class="difflineminus">-    default: // PSDATA?</span>
<a href="#l38.532"></a><span id="l38.532" class="difflineminus">-      result.SetPCDATA_A(ch);</span>
<a href="#l38.533"></a><span id="l38.533" class="difflineminus">-      break;</span>
<a href="#l38.534"></a><span id="l38.534" class="difflineplus">+      case '{':  // Group begin</span>
<a href="#l38.535"></a><span id="l38.535" class="difflineplus">+      case '}':  // Group end</span>
<a href="#l38.536"></a><span id="l38.536" class="difflineplus">+        result = (ch == '{') ? Lexem::groupBegin : Lexem::groupEnd;</span>
<a href="#l38.537"></a><span id="l38.537" class="difflineplus">+        break;</span>
<a href="#l38.538"></a><span id="l38.538" class="difflineplus">+      case '\\':  // Keyword</span>
<a href="#l38.539"></a><span id="l38.539" class="difflineplus">+        result.SetKeyword(GetKeyword(stream));</span>
<a href="#l38.540"></a><span id="l38.540" class="difflineplus">+        break;</span>
<a href="#l38.541"></a><span id="l38.541" class="difflineplus">+      case '\t':  // tab</span>
<a href="#l38.542"></a><span id="l38.542" class="difflineplus">+        result.SetKeyword(&quot;tab&quot;);</span>
<a href="#l38.543"></a><span id="l38.543" class="difflineplus">+        break;</span>
<a href="#l38.544"></a><span id="l38.544" class="difflineplus">+      default:  // PSDATA?</span>
<a href="#l38.545"></a><span id="l38.545" class="difflineplus">+        result.SetPCDATA_A(ch);</span>
<a href="#l38.546"></a><span id="l38.546" class="difflineplus">+        break;</span>
<a href="#l38.547"></a><span id="l38.547">     }</span>
<a href="#l38.548"></a><span id="l38.548">   }</span>
<a href="#l38.549"></a><span id="l38.549"> }</span>
<a href="#l38.550"></a><span id="l38.550"> </span>
<a href="#l38.551"></a><span id="l38.551" class="difflineminus">-void PreprocessLexem(/*inout*/Lexem&amp; lexem, std::istream&amp; stream, int uc)</span>
<a href="#l38.552"></a><span id="l38.552" class="difflineminus">-{</span>
<a href="#l38.553"></a><span id="l38.553" class="difflineplus">+void PreprocessLexem(/*inout*/ Lexem&amp; lexem, std::istream&amp; stream, int uc) {</span>
<a href="#l38.554"></a><span id="l38.554">   if (lexem.type() == Lexem::ltKeyword) {</span>
<a href="#l38.555"></a><span id="l38.555" class="difflineminus">-    if (lexem.KeywordName()[0] == 0) // Empty keyword - maybe eof?</span>
<a href="#l38.556"></a><span id="l38.556" class="difflineplus">+    if (lexem.KeywordName()[0] == 0)  // Empty keyword - maybe eof?</span>
<a href="#l38.557"></a><span id="l38.557">       lexem = Lexem::error;</span>
<a href="#l38.558"></a><span id="l38.558">     else if (eq(lexem.KeywordName(), &quot;u&quot;)) {</span>
<a href="#l38.559"></a><span id="l38.559" class="difflineminus">-       // Unicode character - get the UTF16 and skip the uc characters</span>
<a href="#l38.560"></a><span id="l38.560" class="difflineplus">+      // Unicode character - get the UTF16 and skip the uc characters</span>
<a href="#l38.561"></a><span id="l38.561">       if (const int* val = lexem.KeywordVal()) {</span>
<a href="#l38.562"></a><span id="l38.562">         lexem.SetPCDATA_W(*val);</span>
<a href="#l38.563"></a><span id="l38.563">         stream.ignore(uc);</span>
<a href="#l38.564"></a><span id="l38.564" class="difflineminus">-      }</span>
<a href="#l38.565"></a><span id="l38.565" class="difflineminus">-      else lexem = Lexem::error;</span>
<a href="#l38.566"></a><span id="l38.566" class="difflineminus">-    }</span>
<a href="#l38.567"></a><span id="l38.567" class="difflineminus">-    else if (eq(lexem.KeywordName(), &quot;'&quot;)) {</span>
<a href="#l38.568"></a><span id="l38.568" class="difflineminus">-       // 8-bit character (\'hh) -&gt; use current codepage</span>
<a href="#l38.569"></a><span id="l38.569" class="difflineplus">+      } else</span>
<a href="#l38.570"></a><span id="l38.570" class="difflineplus">+        lexem = Lexem::error;</span>
<a href="#l38.571"></a><span id="l38.571" class="difflineplus">+    } else if (eq(lexem.KeywordName(), &quot;'&quot;)) {</span>
<a href="#l38.572"></a><span id="l38.572" class="difflineplus">+      // 8-bit character (\'hh) -&gt; use current codepage</span>
<a href="#l38.573"></a><span id="l38.573">       char ch = 0, ch1 = 0;</span>
<a href="#l38.574"></a><span id="l38.574">       if (!stream.get(ch).eof()) ch1 = HexToInt(ch);</span>
<a href="#l38.575"></a><span id="l38.575">       if (!stream.get(ch).eof()) (ch1 &lt;&lt;= 4) += HexToInt(ch);</span>
<a href="#l38.576"></a><span id="l38.576">       lexem.SetPCDATA_A(ch1);</span>
<a href="#l38.577"></a><span id="l38.577" class="difflineminus">-    }</span>
<a href="#l38.578"></a><span id="l38.578" class="difflineminus">-    else if (eq(lexem.KeywordName(), &quot;\\&quot;) || eq(lexem.KeywordName(), &quot;{&quot;) ||</span>
<a href="#l38.579"></a><span id="l38.579" class="difflineminus">-             eq(lexem.KeywordName(), &quot;}&quot;)) // escaped characters</span>
<a href="#l38.580"></a><span id="l38.580" class="difflineplus">+    } else if (eq(lexem.KeywordName(), &quot;\\&quot;) || eq(lexem.KeywordName(), &quot;{&quot;) ||</span>
<a href="#l38.581"></a><span id="l38.581" class="difflineplus">+               eq(lexem.KeywordName(), &quot;}&quot;))  // escaped characters</span>
<a href="#l38.582"></a><span id="l38.582">       lexem.SetPCDATA_A(lexem.KeywordName()[0]);</span>
<a href="#l38.583"></a><span id="l38.583">     else if (eq(lexem.KeywordName(), &quot;bin&quot;)) {</span>
<a href="#l38.584"></a><span id="l38.584">       if (const int* i = lexem.KeywordVal()) {</span>
<a href="#l38.585"></a><span id="l38.585">         char* data = new char[*i];</span>
<a href="#l38.586"></a><span id="l38.586">         if (data) {</span>
<a href="#l38.587"></a><span id="l38.587">           stream.read(data, *i);</span>
<a href="#l38.588"></a><span id="l38.588">           if (stream.fail())</span>
<a href="#l38.589"></a><span id="l38.589">             lexem = Lexem::error;</span>
<a href="#l38.590"></a><span id="l38.590">           else</span>
<a href="#l38.591"></a><span id="l38.591">             lexem.SetBDATA(data, *i);</span>
<a href="#l38.592"></a><span id="l38.592">           delete[] data;</span>
<a href="#l38.593"></a><span id="l38.593" class="difflineminus">-        }</span>
<a href="#l38.594"></a><span id="l38.594" class="difflineminus">-        else lexem = Lexem::error;</span>
<a href="#l38.595"></a><span id="l38.595" class="difflineminus">-      }</span>
<a href="#l38.596"></a><span id="l38.596" class="difflineminus">-      else lexem = Lexem::error;</span>
<a href="#l38.597"></a><span id="l38.597" class="difflineminus">-    }</span>
<a href="#l38.598"></a><span id="l38.598" class="difflineminus">-    else if (eq(lexem.KeywordName(), &quot;\n&quot;) || eq(lexem.KeywordName(), &quot;\r&quot;)) {</span>
<a href="#l38.599"></a><span id="l38.599" class="difflineplus">+        } else</span>
<a href="#l38.600"></a><span id="l38.600" class="difflineplus">+          lexem = Lexem::error;</span>
<a href="#l38.601"></a><span id="l38.601" class="difflineplus">+      } else</span>
<a href="#l38.602"></a><span id="l38.602" class="difflineplus">+        lexem = Lexem::error;</span>
<a href="#l38.603"></a><span id="l38.603" class="difflineplus">+    } else if (eq(lexem.KeywordName(), &quot;\n&quot;) || eq(lexem.KeywordName(), &quot;\r&quot;)) {</span>
<a href="#l38.604"></a><span id="l38.604">       // escaped cr or lf</span>
<a href="#l38.605"></a><span id="l38.605">       lexem.SetKeyword(&quot;par&quot;);</span>
<a href="#l38.606"></a><span id="l38.606">     }</span>
<a href="#l38.607"></a><span id="l38.607">   }</span>
<a href="#l38.608"></a><span id="l38.608"> }</span>
<a href="#l38.609"></a><span id="l38.609"> </span>
<a href="#l38.610"></a><span id="l38.610" class="difflineminus">-void UpdateState(const Lexem&amp; lexem, /*inout*/GlobalState&amp; globalState)</span>
<a href="#l38.611"></a><span id="l38.611" class="difflineminus">-{</span>
<a href="#l38.612"></a><span id="l38.612" class="difflineplus">+void UpdateState(const Lexem&amp; lexem, /*inout*/ GlobalState&amp; globalState) {</span>
<a href="#l38.613"></a><span id="l38.613">   switch (globalState.pcdata_a_state) {</span>
<a href="#l38.614"></a><span id="l38.614" class="difflineminus">-  case GlobalState::pcdsfinished: // Last time we finished the pcdata</span>
<a href="#l38.615"></a><span id="l38.615" class="difflineminus">-    globalState.pcdata_a_state = GlobalState::pcdsno;</span>
<a href="#l38.616"></a><span id="l38.616" class="difflineminus">-    break;</span>
<a href="#l38.617"></a><span id="l38.617" class="difflineminus">-  case GlobalState::pcdsin:</span>
<a href="#l38.618"></a><span id="l38.618" class="difflineminus">-     // to be reset later if still in the pcdata</span>
<a href="#l38.619"></a><span id="l38.619" class="difflineminus">-    globalState.pcdata_a_state = GlobalState::pcdsfinished;</span>
<a href="#l38.620"></a><span id="l38.620" class="difflineminus">-    break;</span>
<a href="#l38.621"></a><span id="l38.621" class="difflineplus">+    case GlobalState::pcdsfinished:  // Last time we finished the pcdata</span>
<a href="#l38.622"></a><span id="l38.622" class="difflineplus">+      globalState.pcdata_a_state = GlobalState::pcdsno;</span>
<a href="#l38.623"></a><span id="l38.623" class="difflineplus">+      break;</span>
<a href="#l38.624"></a><span id="l38.624" class="difflineplus">+    case GlobalState::pcdsin:</span>
<a href="#l38.625"></a><span id="l38.625" class="difflineplus">+      // to be reset later if still in the pcdata</span>
<a href="#l38.626"></a><span id="l38.626" class="difflineplus">+      globalState.pcdata_a_state = GlobalState::pcdsfinished;</span>
<a href="#l38.627"></a><span id="l38.627" class="difflineplus">+      break;</span>
<a href="#l38.628"></a><span id="l38.628">   }</span>
<a href="#l38.629"></a><span id="l38.629"> </span>
<a href="#l38.630"></a><span id="l38.630">   switch (lexem.type()) {</span>
<a href="#l38.631"></a><span id="l38.631" class="difflineminus">-  case Lexem::ltGroupBegin:</span>
<a href="#l38.632"></a><span id="l38.632" class="difflineminus">-    globalState.stack.push(globalState.stack.top());</span>
<a href="#l38.633"></a><span id="l38.633" class="difflineminus">-    break;</span>
<a href="#l38.634"></a><span id="l38.634" class="difflineminus">-  case Lexem::ltGroupEnd:</span>
<a href="#l38.635"></a><span id="l38.635" class="difflineminus">-    globalState.stack.pop();</span>
<a href="#l38.636"></a><span id="l38.636" class="difflineminus">-    break;</span>
<a href="#l38.637"></a><span id="l38.637" class="difflineminus">-  case Lexem::ltKeyword:</span>
<a href="#l38.638"></a><span id="l38.638" class="difflineminus">-    {</span>
<a href="#l38.639"></a><span id="l38.639" class="difflineplus">+    case Lexem::ltGroupBegin:</span>
<a href="#l38.640"></a><span id="l38.640" class="difflineplus">+      globalState.stack.push(globalState.stack.top());</span>
<a href="#l38.641"></a><span id="l38.641" class="difflineplus">+      break;</span>
<a href="#l38.642"></a><span id="l38.642" class="difflineplus">+    case Lexem::ltGroupEnd:</span>
<a href="#l38.643"></a><span id="l38.643" class="difflineplus">+      globalState.stack.pop();</span>
<a href="#l38.644"></a><span id="l38.644" class="difflineplus">+      break;</span>
<a href="#l38.645"></a><span id="l38.645" class="difflineplus">+    case Lexem::ltKeyword: {</span>
<a href="#l38.646"></a><span id="l38.646">       const int* val = lexem.KeywordVal();</span>
<a href="#l38.647"></a><span id="l38.647" class="difflineminus">-      if (eq(lexem.KeywordName(), &quot;ansi&quot;)) globalState.codepage = CP_ACP;</span>
<a href="#l38.648"></a><span id="l38.648" class="difflineminus">-      else if (eq(lexem.KeywordName(), &quot;mac&quot;)) globalState.codepage = CP_MACCP;</span>
<a href="#l38.649"></a><span id="l38.649" class="difflineminus">-      else if (eq(lexem.KeywordName(), &quot;pc&quot;)) globalState.codepage = 437;</span>
<a href="#l38.650"></a><span id="l38.650" class="difflineminus">-      else if (eq(lexem.KeywordName(), &quot;pca&quot;)) globalState.codepage = 850;</span>
<a href="#l38.651"></a><span id="l38.651" class="difflineplus">+      if (eq(lexem.KeywordName(), &quot;ansi&quot;))</span>
<a href="#l38.652"></a><span id="l38.652" class="difflineplus">+        globalState.codepage = CP_ACP;</span>
<a href="#l38.653"></a><span id="l38.653" class="difflineplus">+      else if (eq(lexem.KeywordName(), &quot;mac&quot;))</span>
<a href="#l38.654"></a><span id="l38.654" class="difflineplus">+        globalState.codepage = CP_MACCP;</span>
<a href="#l38.655"></a><span id="l38.655" class="difflineplus">+      else if (eq(lexem.KeywordName(), &quot;pc&quot;))</span>
<a href="#l38.656"></a><span id="l38.656" class="difflineplus">+        globalState.codepage = 437;</span>
<a href="#l38.657"></a><span id="l38.657" class="difflineplus">+      else if (eq(lexem.KeywordName(), &quot;pca&quot;))</span>
<a href="#l38.658"></a><span id="l38.658" class="difflineplus">+        globalState.codepage = 850;</span>
<a href="#l38.659"></a><span id="l38.659">       else if (eq(lexem.KeywordName(), &quot;ansicpg&quot;) &amp;&amp; val)</span>
<a href="#l38.660"></a><span id="l38.660">         globalState.codepage = static_cast&lt;unsigned int&gt;(*val);</span>
<a href="#l38.661"></a><span id="l38.661">       else if (eq(lexem.KeywordName(), &quot;deff&quot;) &amp;&amp; val)</span>
<a href="#l38.662"></a><span id="l38.662">         globalState.deff = *val;</span>
<a href="#l38.663"></a><span id="l38.663" class="difflineminus">-      else if (eq(lexem.KeywordName(), &quot;fonttbl&quot;)) globalState.stack.top().fonttbl = true;</span>
<a href="#l38.664"></a><span id="l38.664" class="difflineplus">+      else if (eq(lexem.KeywordName(), &quot;fonttbl&quot;))</span>
<a href="#l38.665"></a><span id="l38.665" class="difflineplus">+        globalState.stack.top().fonttbl = true;</span>
<a href="#l38.666"></a><span id="l38.666">       else if (eq(lexem.KeywordName(), &quot;f&quot;) &amp;&amp; val) {</span>
<a href="#l38.667"></a><span id="l38.667">         globalState.stack.top().f = *val;</span>
<a href="#l38.668"></a><span id="l38.668" class="difflineminus">-      }</span>
<a href="#l38.669"></a><span id="l38.669" class="difflineminus">-      else if (eq(lexem.KeywordName(), &quot;fcharset&quot;) &amp;&amp;</span>
<a href="#l38.670"></a><span id="l38.670" class="difflineminus">-               globalState.stack.top().fonttbl &amp;&amp;</span>
<a href="#l38.671"></a><span id="l38.671" class="difflineminus">-               (globalState.stack.top().f != -1) &amp;&amp; val) {</span>
<a href="#l38.672"></a><span id="l38.672" class="difflineplus">+      } else if (eq(lexem.KeywordName(), &quot;fcharset&quot;) &amp;&amp;</span>
<a href="#l38.673"></a><span id="l38.673" class="difflineplus">+                 globalState.stack.top().fonttbl &amp;&amp;</span>
<a href="#l38.674"></a><span id="l38.674" class="difflineplus">+                 (globalState.stack.top().f != -1) &amp;&amp; val) {</span>
<a href="#l38.675"></a><span id="l38.675">         FontInfo&amp; f = globalState.fonttbl[globalState.stack.top().f];</span>
<a href="#l38.676"></a><span id="l38.676">         f.options |= FontInfo::has_fcharset;</span>
<a href="#l38.677"></a><span id="l38.677">         f.fcharset = *val;</span>
<a href="#l38.678"></a><span id="l38.678" class="difflineminus">-      }</span>
<a href="#l38.679"></a><span id="l38.679" class="difflineminus">-      else if (eq(lexem.KeywordName(), &quot;cpg&quot;) &amp;&amp; val) {</span>
<a href="#l38.680"></a><span id="l38.680" class="difflineminus">-        if (globalState.stack.top().fonttbl &amp;&amp; (globalState.stack.top().f != -1)) { // Defining a font</span>
<a href="#l38.681"></a><span id="l38.681" class="difflineplus">+      } else if (eq(lexem.KeywordName(), &quot;cpg&quot;) &amp;&amp; val) {</span>
<a href="#l38.682"></a><span id="l38.682" class="difflineplus">+        if (globalState.stack.top().fonttbl &amp;&amp;</span>
<a href="#l38.683"></a><span id="l38.683" class="difflineplus">+            (globalState.stack.top().f != -1)) {  // Defining a font</span>
<a href="#l38.684"></a><span id="l38.684">           FontInfo&amp; f = globalState.fonttbl[globalState.stack.top().f];</span>
<a href="#l38.685"></a><span id="l38.685">           f.options |= FontInfo::has_cpg;</span>
<a href="#l38.686"></a><span id="l38.686">           f.cpg = *val;</span>
<a href="#l38.687"></a><span id="l38.687" class="difflineminus">-        }</span>
<a href="#l38.688"></a><span id="l38.688" class="difflineminus">-        else { // Overriding the codepage for the block - may be in filenames</span>
<a href="#l38.689"></a><span id="l38.689" class="difflineplus">+        } else {  // Overriding the codepage for the block - may be in filenames</span>
<a href="#l38.690"></a><span id="l38.690">           globalState.stack.top().codepage = *val;</span>
<a href="#l38.691"></a><span id="l38.691">         }</span>
<a href="#l38.692"></a><span id="l38.692" class="difflineminus">-      }</span>
<a href="#l38.693"></a><span id="l38.693" class="difflineminus">-      else if (eq(lexem.KeywordName(), &quot;plain&quot;))</span>
<a href="#l38.694"></a><span id="l38.694" class="difflineplus">+      } else if (eq(lexem.KeywordName(), &quot;plain&quot;))</span>
<a href="#l38.695"></a><span id="l38.695">         globalState.stack.top().f = -1;</span>
<a href="#l38.696"></a><span id="l38.696">       else if (eq(lexem.KeywordName(), &quot;uc&quot;) &amp;&amp; val)</span>
<a href="#l38.697"></a><span id="l38.697">         globalState.stack.top().uc = *val;</span>
<a href="#l38.698"></a><span id="l38.698" class="difflineminus">-    }</span>
<a href="#l38.699"></a><span id="l38.699" class="difflineminus">-    break;</span>
<a href="#l38.700"></a><span id="l38.700" class="difflineminus">-  case Lexem::ltPCDATA_A:</span>
<a href="#l38.701"></a><span id="l38.701" class="difflineminus">-    if (globalState.pcdata_a_state == GlobalState::pcdsno) // Beginning of the pcdata</span>
<a href="#l38.702"></a><span id="l38.702" class="difflineminus">-      globalState.pcdata_a_codepage = globalState.GetCurrentCP(); // to use later to convert to utf16</span>
<a href="#l38.703"></a><span id="l38.703" class="difflineminus">-    globalState.pcdata_a_state = GlobalState::pcdsin;</span>
<a href="#l38.704"></a><span id="l38.704" class="difflineminus">-    globalState.pcdata_a &lt;&lt; lexem.pcdata_a();</span>
<a href="#l38.705"></a><span id="l38.705" class="difflineminus">-    break;</span>
<a href="#l38.706"></a><span id="l38.706" class="difflineplus">+    } break;</span>
<a href="#l38.707"></a><span id="l38.707" class="difflineplus">+    case Lexem::ltPCDATA_A:</span>
<a href="#l38.708"></a><span id="l38.708" class="difflineplus">+      if (globalState.pcdata_a_state ==</span>
<a href="#l38.709"></a><span id="l38.709" class="difflineplus">+          GlobalState::pcdsno)  // Beginning of the pcdata</span>
<a href="#l38.710"></a><span id="l38.710" class="difflineplus">+        globalState.pcdata_a_codepage =</span>
<a href="#l38.711"></a><span id="l38.711" class="difflineplus">+            globalState.GetCurrentCP();  // to use later to convert to utf16</span>
<a href="#l38.712"></a><span id="l38.712" class="difflineplus">+      globalState.pcdata_a_state = GlobalState::pcdsin;</span>
<a href="#l38.713"></a><span id="l38.713" class="difflineplus">+      globalState.pcdata_a &lt;&lt; lexem.pcdata_a();</span>
<a href="#l38.714"></a><span id="l38.714" class="difflineplus">+      break;</span>
<a href="#l38.715"></a><span id="l38.715">   }</span>
<a href="#l38.716"></a><span id="l38.716"> }</span>
<a href="#l38.717"></a><span id="l38.717"> </span>
<a href="#l38.718"></a><span id="l38.718" class="difflineminus">-void DecodeRTF(std::istream&amp; rtf, CRTFDecoder&amp; decoder)</span>
<a href="#l38.719"></a><span id="l38.719" class="difflineminus">-{</span>
<a href="#l38.720"></a><span id="l38.720" class="difflineplus">+void DecodeRTF(std::istream&amp; rtf, CRTFDecoder&amp; decoder) {</span>
<a href="#l38.721"></a><span id="l38.721">   // Check if this is the rtf</span>
<a href="#l38.722"></a><span id="l38.722">   Lexem lexem;</span>
<a href="#l38.723"></a><span id="l38.723">   GetLexem(rtf, lexem);</span>
<a href="#l38.724"></a><span id="l38.724" class="difflineminus">-  if (lexem.type() != Lexem::ltGroupBegin)</span>
<a href="#l38.725"></a><span id="l38.725" class="difflineminus">-    return;</span>
<a href="#l38.726"></a><span id="l38.726" class="difflineplus">+  if (lexem.type() != Lexem::ltGroupBegin) return;</span>
<a href="#l38.727"></a><span id="l38.727">   decoder.BeginGroup();</span>
<a href="#l38.728"></a><span id="l38.728">   GetLexem(rtf, lexem);</span>
<a href="#l38.729"></a><span id="l38.729">   if ((lexem.type() != Lexem::ltKeyword) || !eq(lexem.KeywordName(), &quot;rtf&quot;) ||</span>
<a href="#l38.730"></a><span id="l38.730">       !lexem.KeywordVal() || (*lexem.KeywordVal() != 1))</span>
<a href="#l38.731"></a><span id="l38.731">     return;</span>
<a href="#l38.732"></a><span id="l38.732">   decoder.Keyword(lexem.KeywordName(), lexem.KeywordVal());</span>
<a href="#l38.733"></a><span id="l38.733"> </span>
<a href="#l38.734"></a><span id="l38.734">   GlobalState state(rtf);</span>
<a href="#l38.735"></a><span id="l38.735">   // Level is the count of elements in the stack</span>
<a href="#l38.736"></a><span id="l38.736"> </span>
<a href="#l38.737"></a><span id="l38.737" class="difflineminus">-  while (!state.stream.eof() &amp;&amp; (state.stack.size()&gt;0)) { // Don't go past the global group</span>
<a href="#l38.738"></a><span id="l38.738" class="difflineplus">+  while (!state.stream.eof() &amp;&amp;</span>
<a href="#l38.739"></a><span id="l38.739" class="difflineplus">+         (state.stack.size() &gt; 0)) {  // Don't go past the global group</span>
<a href="#l38.740"></a><span id="l38.740">     GetLexem(state.stream, lexem);</span>
<a href="#l38.741"></a><span id="l38.741">     PreprocessLexem(lexem, state.stream, state.stack.top().uc);</span>
<a href="#l38.742"></a><span id="l38.742">     UpdateState(lexem, state);</span>
<a href="#l38.743"></a><span id="l38.743"> </span>
<a href="#l38.744"></a><span id="l38.744">     if (state.pcdata_a_state == GlobalState::pcdsfinished) {</span>
<a href="#l38.745"></a><span id="l38.745">       std::string s = state.pcdata_a.str();</span>
<a href="#l38.746"></a><span id="l38.746" class="difflineminus">-      int sz = ::MultiByteToWideChar(state.pcdata_a_codepage, 0, s.c_str(), s.size(), 0, 0);</span>
<a href="#l38.747"></a><span id="l38.747" class="difflineplus">+      int sz = ::MultiByteToWideChar(state.pcdata_a_codepage, 0, s.c_str(),</span>
<a href="#l38.748"></a><span id="l38.748" class="difflineplus">+                                     s.size(), 0, 0);</span>
<a href="#l38.749"></a><span id="l38.749">       if (sz) {</span>
<a href="#l38.750"></a><span id="l38.750">         wchar_t* data = new wchar_t[sz];</span>
<a href="#l38.751"></a><span id="l38.751" class="difflineminus">-        ::MultiByteToWideChar(state.pcdata_a_codepage, 0, s.c_str(), s.size(), data, sz);</span>
<a href="#l38.752"></a><span id="l38.752" class="difflineplus">+        ::MultiByteToWideChar(state.pcdata_a_codepage, 0, s.c_str(), s.size(),</span>
<a href="#l38.753"></a><span id="l38.753" class="difflineplus">+                              data, sz);</span>
<a href="#l38.754"></a><span id="l38.754">         decoder.PCDATA(data, sz);</span>
<a href="#l38.755"></a><span id="l38.755">         delete[] data;</span>
<a href="#l38.756"></a><span id="l38.756">       }</span>
<a href="#l38.757"></a><span id="l38.757" class="difflineminus">-      state.pcdata_a.str(&quot;&quot;); // reset</span>
<a href="#l38.758"></a><span id="l38.758" class="difflineplus">+      state.pcdata_a.str(&quot;&quot;);  // reset</span>
<a href="#l38.759"></a><span id="l38.759">     }</span>
<a href="#l38.760"></a><span id="l38.760"> </span>
<a href="#l38.761"></a><span id="l38.761">     switch (lexem.type()) {</span>
<a href="#l38.762"></a><span id="l38.762" class="difflineminus">-    case Lexem::ltGroupBegin:</span>
<a href="#l38.763"></a><span id="l38.763" class="difflineminus">-      decoder.BeginGroup();</span>
<a href="#l38.764"></a><span id="l38.764" class="difflineminus">-      break;</span>
<a href="#l38.765"></a><span id="l38.765" class="difflineminus">-    case Lexem::ltGroupEnd:</span>
<a href="#l38.766"></a><span id="l38.766" class="difflineminus">-      decoder.EndGroup();</span>
<a href="#l38.767"></a><span id="l38.767" class="difflineminus">-      break;</span>
<a href="#l38.768"></a><span id="l38.768" class="difflineminus">-    case Lexem::ltKeyword:</span>
<a href="#l38.769"></a><span id="l38.769" class="difflineminus">-      decoder.Keyword(lexem.KeywordName(), lexem.KeywordVal());</span>
<a href="#l38.770"></a><span id="l38.770" class="difflineminus">-      break;</span>
<a href="#l38.771"></a><span id="l38.771" class="difflineminus">-    case Lexem::ltPCDATA_W:</span>
<a href="#l38.772"></a><span id="l38.772" class="difflineminus">-      {</span>
<a href="#l38.773"></a><span id="l38.773" class="difflineplus">+      case Lexem::ltGroupBegin:</span>
<a href="#l38.774"></a><span id="l38.774" class="difflineplus">+        decoder.BeginGroup();</span>
<a href="#l38.775"></a><span id="l38.775" class="difflineplus">+        break;</span>
<a href="#l38.776"></a><span id="l38.776" class="difflineplus">+      case Lexem::ltGroupEnd:</span>
<a href="#l38.777"></a><span id="l38.777" class="difflineplus">+        decoder.EndGroup();</span>
<a href="#l38.778"></a><span id="l38.778" class="difflineplus">+        break;</span>
<a href="#l38.779"></a><span id="l38.779" class="difflineplus">+      case Lexem::ltKeyword:</span>
<a href="#l38.780"></a><span id="l38.780" class="difflineplus">+        decoder.Keyword(lexem.KeywordName(), lexem.KeywordVal());</span>
<a href="#l38.781"></a><span id="l38.781" class="difflineplus">+        break;</span>
<a href="#l38.782"></a><span id="l38.782" class="difflineplus">+      case Lexem::ltPCDATA_W: {</span>
<a href="#l38.783"></a><span id="l38.783">         wchar_t ch = lexem.pcdata_w();</span>
<a href="#l38.784"></a><span id="l38.784">         decoder.PCDATA(&amp;ch, 1);</span>
<a href="#l38.785"></a><span id="l38.785" class="difflineminus">-      }</span>
<a href="#l38.786"></a><span id="l38.786" class="difflineminus">-      break;</span>
<a href="#l38.787"></a><span id="l38.787" class="difflineminus">-    case Lexem::ltBDATA:</span>
<a href="#l38.788"></a><span id="l38.788" class="difflineminus">-      decoder.BDATA(lexem.bdata(), lexem.bdata_sz());</span>
<a href="#l38.789"></a><span id="l38.789" class="difflineminus">-      break;</span>
<a href="#l38.790"></a><span id="l38.790" class="difflineminus">-    case Lexem::ltError:</span>
<a href="#l38.791"></a><span id="l38.791" class="difflineminus">-      break; // Just silently skip the erroneous data - basic error recovery</span>
<a href="#l38.792"></a><span id="l38.792" class="difflineplus">+      } break;</span>
<a href="#l38.793"></a><span id="l38.793" class="difflineplus">+      case Lexem::ltBDATA:</span>
<a href="#l38.794"></a><span id="l38.794" class="difflineplus">+        decoder.BDATA(lexem.bdata(), lexem.bdata_sz());</span>
<a href="#l38.795"></a><span id="l38.795" class="difflineplus">+        break;</span>
<a href="#l38.796"></a><span id="l38.796" class="difflineplus">+      case Lexem::ltError:</span>
<a href="#l38.797"></a><span id="l38.797" class="difflineplus">+        break;  // Just silently skip the erroneous data - basic error recovery</span>
<a href="#l38.798"></a><span id="l38.798">     }</span>
<a href="#l38.799"></a><span id="l38.799" class="difflineminus">-  } // while</span>
<a href="#l38.800"></a><span id="l38.800" class="difflineminus">-} // DecodeRTF</span>
<a href="#l38.801"></a><span id="l38.801" class="difflineplus">+  }  // while</span>
<a href="#l38.802"></a><span id="l38.802" class="difflineplus">+}  // DecodeRTF</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/mailnews/import/outlook/src/rtfDecoder.h</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/mailnews/import/outlook/src/rtfDecoder.h</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -1,22 +1,21 @@</span>
<a href="#l39.4"></a><span id="l39.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l39.5"></a><span id="l39.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l39.6"></a><span id="l39.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l39.7"></a><span id="l39.7"> </span>
<a href="#l39.8"></a><span id="l39.8"> #include &lt;istream&gt;</span>
<a href="#l39.9"></a><span id="l39.9"> </span>
<a href="#l39.10"></a><span id="l39.10"> template &lt;size_t len&gt;</span>
<a href="#l39.11"></a><span id="l39.11" class="difflineminus">-inline bool eq(const char* str1, const char (&amp;str2)[len])</span>
<a href="#l39.12"></a><span id="l39.12" class="difflineminus">-{</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineplus">+inline bool eq(const char* str1, const char (&amp;str2)[len]) {</span>
<a href="#l39.14"></a><span id="l39.14">   return ::strncmp(str1, str2, len) == 0;</span>
<a href="#l39.15"></a><span id="l39.15"> };</span>
<a href="#l39.16"></a><span id="l39.16"> </span>
<a href="#l39.17"></a><span id="l39.17"> class CRTFDecoder {</span>
<a href="#l39.18"></a><span id="l39.18" class="difflineminus">-public:</span>
<a href="#l39.19"></a><span id="l39.19" class="difflineplus">+ public:</span>
<a href="#l39.20"></a><span id="l39.20">   virtual void BeginGroup() = 0;</span>
<a href="#l39.21"></a><span id="l39.21">   virtual void EndGroup() = 0;</span>
<a href="#l39.22"></a><span id="l39.22">   virtual void Keyword(const char* name, const int* Val) = 0;</span>
<a href="#l39.23"></a><span id="l39.23">   virtual void PCDATA(const wchar_t* data, size_t cch) = 0;</span>
<a href="#l39.24"></a><span id="l39.24">   virtual void BDATA(const char* data, size_t sz) = 0;</span>
<a href="#l39.25"></a><span id="l39.25"> };</span>
<a href="#l39.26"></a><span id="l39.26"> </span>
<a href="#l39.27"></a><span id="l39.27"> void DecodeRTF(std::istream&amp; rtf, CRTFDecoder&amp; decoder);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/mailnews/import/outlook/src/rtfMailDecoder.cpp</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/mailnews/import/outlook/src/rtfMailDecoder.cpp</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -1,79 +1,71 @@</span>
<a href="#l40.4"></a><span id="l40.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l40.5"></a><span id="l40.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l40.6"></a><span id="l40.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l40.7"></a><span id="l40.7"> </span>
<a href="#l40.8"></a><span id="l40.8"> #include &quot;rtfMailDecoder.h&quot;</span>
<a href="#l40.9"></a><span id="l40.9"> </span>
<a href="#l40.10"></a><span id="l40.10" class="difflineminus">-void CRTFMailDecoder::BeginGroup()</span>
<a href="#l40.11"></a><span id="l40.11" class="difflineminus">-{</span>
<a href="#l40.12"></a><span id="l40.12" class="difflineplus">+void CRTFMailDecoder::BeginGroup() {</span>
<a href="#l40.13"></a><span id="l40.13">   ClearState(sAsterisk);</span>
<a href="#l40.14"></a><span id="l40.14">   SetState(sBeginGroup);</span>
<a href="#l40.15"></a><span id="l40.15" class="difflineminus">-  if (m_skipLevel)</span>
<a href="#l40.16"></a><span id="l40.16" class="difflineminus">-    ++m_skipLevel;</span>
<a href="#l40.17"></a><span id="l40.17" class="difflineplus">+  if (m_skipLevel) ++m_skipLevel;</span>
<a href="#l40.18"></a><span id="l40.18"> }</span>
<a href="#l40.19"></a><span id="l40.19"> </span>
<a href="#l40.20"></a><span id="l40.20" class="difflineminus">-void CRTFMailDecoder::EndGroup()</span>
<a href="#l40.21"></a><span id="l40.21" class="difflineminus">-{</span>
<a href="#l40.22"></a><span id="l40.22" class="difflineminus">-  ClearState(sAsterisk|sBeginGroup);</span>
<a href="#l40.23"></a><span id="l40.23" class="difflineminus">-  if (m_skipLevel)</span>
<a href="#l40.24"></a><span id="l40.24" class="difflineminus">-    --m_skipLevel;</span>
<a href="#l40.25"></a><span id="l40.25" class="difflineplus">+void CRTFMailDecoder::EndGroup() {</span>
<a href="#l40.26"></a><span id="l40.26" class="difflineplus">+  ClearState(sAsterisk | sBeginGroup);</span>
<a href="#l40.27"></a><span id="l40.27" class="difflineplus">+  if (m_skipLevel) --m_skipLevel;</span>
<a href="#l40.28"></a><span id="l40.28"> }</span>
<a href="#l40.29"></a><span id="l40.29"> </span>
<a href="#l40.30"></a><span id="l40.30" class="difflineminus">-void CRTFMailDecoder::AddText(const wchar_t* txt, size_t cch)</span>
<a href="#l40.31"></a><span id="l40.31" class="difflineminus">-{</span>
<a href="#l40.32"></a><span id="l40.32" class="difflineplus">+void CRTFMailDecoder::AddText(const wchar_t* txt, size_t cch) {</span>
<a href="#l40.33"></a><span id="l40.33">   if (!IsHtmlRtf()) {</span>
<a href="#l40.34"></a><span id="l40.34">     if (cch == static_cast&lt;size_t&gt;(-1))</span>
<a href="#l40.35"></a><span id="l40.35">       m_text += txt;</span>
<a href="#l40.36"></a><span id="l40.36">     else</span>
<a href="#l40.37"></a><span id="l40.37">       m_text.append(txt, cch);</span>
<a href="#l40.38"></a><span id="l40.38">   }</span>
<a href="#l40.39"></a><span id="l40.39"> }</span>
<a href="#l40.40"></a><span id="l40.40"> </span>
<a href="#l40.41"></a><span id="l40.41" class="difflineminus">-void CRTFMailDecoder::Keyword(const char* name, const int* Val)</span>
<a href="#l40.42"></a><span id="l40.42" class="difflineminus">-{</span>
<a href="#l40.43"></a><span id="l40.43" class="difflineminus">-  bool asterisk = IsAsterisk(); ClearState(sAsterisk); // for inside use only</span>
<a href="#l40.44"></a><span id="l40.44" class="difflineminus">-  bool beginGroup = IsBeginGroup(); ClearState(sBeginGroup); // for inside use only</span>
<a href="#l40.45"></a><span id="l40.45" class="difflineplus">+void CRTFMailDecoder::Keyword(const char* name, const int* Val) {</span>
<a href="#l40.46"></a><span id="l40.46" class="difflineplus">+  bool asterisk = IsAsterisk();</span>
<a href="#l40.47"></a><span id="l40.47" class="difflineplus">+  ClearState(sAsterisk);  // for inside use only</span>
<a href="#l40.48"></a><span id="l40.48" class="difflineplus">+  bool beginGroup = IsBeginGroup();</span>
<a href="#l40.49"></a><span id="l40.49" class="difflineplus">+  ClearState(sBeginGroup);  // for inside use only</span>
<a href="#l40.50"></a><span id="l40.50">   if (!m_skipLevel) {</span>
<a href="#l40.51"></a><span id="l40.51" class="difflineminus">-    if (eq(name, &quot;*&quot;) &amp;&amp; beginGroup) SetState(sAsterisk);</span>
<a href="#l40.52"></a><span id="l40.52" class="difflineplus">+    if (eq(name, &quot;*&quot;) &amp;&amp; beginGroup)</span>
<a href="#l40.53"></a><span id="l40.53" class="difflineplus">+      SetState(sAsterisk);</span>
<a href="#l40.54"></a><span id="l40.54">     else if (asterisk) {</span>
<a href="#l40.55"></a><span id="l40.55" class="difflineminus">-      if (eq(name, &quot;htmltag&quot;) &amp;&amp; (m_mode == mHTML)) { // \*\htmltag -&gt; don't ignore; include the following text</span>
<a href="#l40.56"></a><span id="l40.56" class="difflineminus">-      }</span>
<a href="#l40.57"></a><span id="l40.57" class="difflineminus">-      else ++m_skipLevel;</span>
<a href="#l40.58"></a><span id="l40.58" class="difflineminus">-    }</span>
<a href="#l40.59"></a><span id="l40.59" class="difflineminus">-    else if (eq(name, &quot;htmlrtf&quot;)) {</span>
<a href="#l40.60"></a><span id="l40.60" class="difflineminus">-      if (Val &amp;&amp; (*Val==0))</span>
<a href="#l40.61"></a><span id="l40.61" class="difflineplus">+      if (eq(name, &quot;htmltag&quot;) &amp;&amp;</span>
<a href="#l40.62"></a><span id="l40.62" class="difflineplus">+          (m_mode ==</span>
<a href="#l40.63"></a><span id="l40.63" class="difflineplus">+           mHTML)) {  // \*\htmltag -&gt; don't ignore; include the following text</span>
<a href="#l40.64"></a><span id="l40.64" class="difflineplus">+      } else</span>
<a href="#l40.65"></a><span id="l40.65" class="difflineplus">+        ++m_skipLevel;</span>
<a href="#l40.66"></a><span id="l40.66" class="difflineplus">+    } else if (eq(name, &quot;htmlrtf&quot;)) {</span>
<a href="#l40.67"></a><span id="l40.67" class="difflineplus">+      if (Val &amp;&amp; (*Val == 0))</span>
<a href="#l40.68"></a><span id="l40.68">         ClearState(sHtmlRtf);</span>
<a href="#l40.69"></a><span id="l40.69">       else</span>
<a href="#l40.70"></a><span id="l40.70">         SetState(sHtmlRtf);</span>
<a href="#l40.71"></a><span id="l40.71" class="difflineminus">-    }</span>
<a href="#l40.72"></a><span id="l40.72" class="difflineminus">-    else if (eq(name, &quot;par&quot;) || eq(name, &quot;line&quot;)) {</span>
<a href="#l40.73"></a><span id="l40.73" class="difflineplus">+    } else if (eq(name, &quot;par&quot;) || eq(name, &quot;line&quot;)) {</span>
<a href="#l40.74"></a><span id="l40.74">       AddText(L&quot;\r\n&quot;);</span>
<a href="#l40.75"></a><span id="l40.75" class="difflineminus">-    }</span>
<a href="#l40.76"></a><span id="l40.76" class="difflineminus">-    else if (eq(name, &quot;tab&quot;)) {</span>
<a href="#l40.77"></a><span id="l40.77" class="difflineplus">+    } else if (eq(name, &quot;tab&quot;)) {</span>
<a href="#l40.78"></a><span id="l40.78">       AddText(L&quot;\t&quot;);</span>
<a href="#l40.79"></a><span id="l40.79" class="difflineminus">-    }</span>
<a href="#l40.80"></a><span id="l40.80" class="difflineminus">-    else if (eq(name, &quot;rquote&quot;)) {</span>
<a href="#l40.81"></a><span id="l40.81" class="difflineminus">-      AddText(L&quot;\x2019&quot;); // Unicode right single quotation mark</span>
<a href="#l40.82"></a><span id="l40.82" class="difflineminus">-    }</span>
<a href="#l40.83"></a><span id="l40.83" class="difflineminus">-    else if (eq(name, &quot;fromtext&quot;) &amp;&amp; (m_mode==mNone)) { // avoid double &quot;fromX&quot;</span>
<a href="#l40.84"></a><span id="l40.84" class="difflineplus">+    } else if (eq(name, &quot;rquote&quot;)) {</span>
<a href="#l40.85"></a><span id="l40.85" class="difflineplus">+      AddText(L&quot;\x2019&quot;);  // Unicode right single quotation mark</span>
<a href="#l40.86"></a><span id="l40.86" class="difflineplus">+    } else if (eq(name, &quot;fromtext&quot;) &amp;&amp;</span>
<a href="#l40.87"></a><span id="l40.87" class="difflineplus">+               (m_mode == mNone)) {  // avoid double &quot;fromX&quot;</span>
<a href="#l40.88"></a><span id="l40.88">       m_mode = mText;</span>
<a href="#l40.89"></a><span id="l40.89" class="difflineminus">-    }</span>
<a href="#l40.90"></a><span id="l40.90" class="difflineminus">-    else if (eq(name, &quot;fromhtml&quot;) &amp;&amp; (m_mode==mNone)) { // avoid double &quot;fromX&quot;</span>
<a href="#l40.91"></a><span id="l40.91" class="difflineplus">+    } else if (eq(name, &quot;fromhtml&quot;) &amp;&amp;</span>
<a href="#l40.92"></a><span id="l40.92" class="difflineplus">+               (m_mode == mNone)) {  // avoid double &quot;fromX&quot;</span>
<a href="#l40.93"></a><span id="l40.93">       m_mode = mHTML;</span>
<a href="#l40.94"></a><span id="l40.94" class="difflineminus">-    }</span>
<a href="#l40.95"></a><span id="l40.95" class="difflineminus">-    else if (eq(name, &quot;fonttbl&quot;) || eq(name, &quot;colortbl&quot;) || eq(name, &quot;stylesheet&quot;) || eq(name, &quot;pntext&quot;))</span>
<a href="#l40.96"></a><span id="l40.96" class="difflineplus">+    } else if (eq(name, &quot;fonttbl&quot;) || eq(name, &quot;colortbl&quot;) ||</span>
<a href="#l40.97"></a><span id="l40.97" class="difflineplus">+               eq(name, &quot;stylesheet&quot;) || eq(name, &quot;pntext&quot;))</span>
<a href="#l40.98"></a><span id="l40.98">       ++m_skipLevel;</span>
<a href="#l40.99"></a><span id="l40.99">   }</span>
<a href="#l40.100"></a><span id="l40.100"> }</span>
<a href="#l40.101"></a><span id="l40.101"> </span>
<a href="#l40.102"></a><span id="l40.102" class="difflineminus">-void CRTFMailDecoder::PCDATA(const wchar_t* data, size_t cch)</span>
<a href="#l40.103"></a><span id="l40.103" class="difflineminus">-{</span>
<a href="#l40.104"></a><span id="l40.104" class="difflineminus">-  ClearState(sAsterisk|sBeginGroup);</span>
<a href="#l40.105"></a><span id="l40.105" class="difflineminus">-  if (!m_skipLevel)</span>
<a href="#l40.106"></a><span id="l40.106" class="difflineminus">-    AddText(data, cch);</span>
<a href="#l40.107"></a><span id="l40.107" class="difflineplus">+void CRTFMailDecoder::PCDATA(const wchar_t* data, size_t cch) {</span>
<a href="#l40.108"></a><span id="l40.108" class="difflineplus">+  ClearState(sAsterisk | sBeginGroup);</span>
<a href="#l40.109"></a><span id="l40.109" class="difflineplus">+  if (!m_skipLevel) AddText(data, cch);</span>
<a href="#l40.110"></a><span id="l40.110"> }</span>
<a href="#l40.111"></a><span id="l40.111"> </span>
<a href="#l40.112"></a><span id="l40.112" class="difflineminus">-void CRTFMailDecoder::BDATA(const char* data, size_t sz)</span>
<a href="#l40.113"></a><span id="l40.113" class="difflineminus">-{</span>
<a href="#l40.114"></a><span id="l40.114" class="difflineminus">-  ClearState(sAsterisk|sBeginGroup);</span>
<a href="#l40.115"></a><span id="l40.115" class="difflineplus">+void CRTFMailDecoder::BDATA(const char* data, size_t sz) {</span>
<a href="#l40.116"></a><span id="l40.116" class="difflineplus">+  ClearState(sAsterisk | sBeginGroup);</span>
<a href="#l40.117"></a><span id="l40.117"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/mailnews/import/outlook/src/rtfMailDecoder.h</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/mailnews/import/outlook/src/rtfMailDecoder.h</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -1,41 +1,44 @@</span>
<a href="#l41.4"></a><span id="l41.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l41.5"></a><span id="l41.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l41.6"></a><span id="l41.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l41.7"></a><span id="l41.7"> </span>
<a href="#l41.8"></a><span id="l41.8"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l41.9"></a><span id="l41.9"> #include &lt;string&gt;</span>
<a href="#l41.10"></a><span id="l41.10"> #include &quot;rtfDecoder.h&quot;</span>
<a href="#l41.11"></a><span id="l41.11"> </span>
<a href="#l41.12"></a><span id="l41.12" class="difflineminus">-class CRTFMailDecoder: public CRTFDecoder {</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineminus">-public:</span>
<a href="#l41.14"></a><span id="l41.14" class="difflineminus">-  enum Mode {mNone, mText, mHTML};</span>
<a href="#l41.15"></a><span id="l41.15" class="difflineplus">+class CRTFMailDecoder : public CRTFDecoder {</span>
<a href="#l41.16"></a><span id="l41.16" class="difflineplus">+ public:</span>
<a href="#l41.17"></a><span id="l41.17" class="difflineplus">+  enum Mode { mNone, mText, mHTML };</span>
<a href="#l41.18"></a><span id="l41.18">   CRTFMailDecoder() : m_mode(mNone), m_state(sNormal), m_skipLevel(0) {}</span>
<a href="#l41.19"></a><span id="l41.19">   void BeginGroup() override;</span>
<a href="#l41.20"></a><span id="l41.20">   void EndGroup() override;</span>
<a href="#l41.21"></a><span id="l41.21">   void Keyword(const char* name, const int* Val) override;</span>
<a href="#l41.22"></a><span id="l41.22">   void PCDATA(const wchar_t* data, size_t cch) override;</span>
<a href="#l41.23"></a><span id="l41.23">   void BDATA(const char* data, size_t sz) override;</span>
<a href="#l41.24"></a><span id="l41.24">   const wchar_t* text() { return m_text.c_str(); }</span>
<a href="#l41.25"></a><span id="l41.25">   std::wstring::size_type textSize() { return m_text.size(); }</span>
<a href="#l41.26"></a><span id="l41.26">   Mode mode() { return m_mode; }</span>
<a href="#l41.27"></a><span id="l41.27" class="difflineminus">-private:</span>
<a href="#l41.28"></a><span id="l41.28" class="difflineminus">-  enum State {sNormal = 0x0000,</span>
<a href="#l41.29"></a><span id="l41.29" class="difflineminus">-              sBeginGroup = 0x0001,</span>
<a href="#l41.30"></a><span id="l41.30" class="difflineminus">-              sAsterisk = 0x0002,</span>
<a href="#l41.31"></a><span id="l41.31" class="difflineminus">-              sHtmlRtf = 0x0004};</span>
<a href="#l41.32"></a><span id="l41.32" class="difflineplus">+</span>
<a href="#l41.33"></a><span id="l41.33" class="difflineplus">+ private:</span>
<a href="#l41.34"></a><span id="l41.34" class="difflineplus">+  enum State {</span>
<a href="#l41.35"></a><span id="l41.35" class="difflineplus">+    sNormal = 0x0000,</span>
<a href="#l41.36"></a><span id="l41.36" class="difflineplus">+    sBeginGroup = 0x0001,</span>
<a href="#l41.37"></a><span id="l41.37" class="difflineplus">+    sAsterisk = 0x0002,</span>
<a href="#l41.38"></a><span id="l41.38" class="difflineplus">+    sHtmlRtf = 0x0004</span>
<a href="#l41.39"></a><span id="l41.39" class="difflineplus">+  };</span>
<a href="#l41.40"></a><span id="l41.40"> </span>
<a href="#l41.41"></a><span id="l41.41">   std::wstring m_text;</span>
<a href="#l41.42"></a><span id="l41.42">   Mode m_mode;</span>
<a href="#l41.43"></a><span id="l41.43" class="difflineminus">-  unsigned int m_state; // bitmask of State</span>
<a href="#l41.44"></a><span id="l41.44" class="difflineminus">-// bool m_beginGroup; // true just after the {</span>
<a href="#l41.45"></a><span id="l41.45" class="difflineminus">-//bool m_asterisk; // true just after the {\*</span>
<a href="#l41.46"></a><span id="l41.46" class="difflineminus">-  int m_skipLevel; // if &gt;0 then we ignore everything</span>
<a href="#l41.47"></a><span id="l41.47" class="difflineminus">-// bool m_htmlrtf;</span>
<a href="#l41.48"></a><span id="l41.48" class="difflineplus">+  unsigned int m_state;  // bitmask of State</span>
<a href="#l41.49"></a><span id="l41.49" class="difflineplus">+                         // bool m_beginGroup; // true just after the {</span>
<a href="#l41.50"></a><span id="l41.50" class="difflineplus">+                         // bool m_asterisk; // true just after the {\*</span>
<a href="#l41.51"></a><span id="l41.51" class="difflineplus">+  int m_skipLevel;       // if &gt;0 then we ignore everything</span>
<a href="#l41.52"></a><span id="l41.52" class="difflineplus">+                         // bool m_htmlrtf;</span>
<a href="#l41.53"></a><span id="l41.53">   inline void SetState(unsigned int s) { m_state |= s; }</span>
<a href="#l41.54"></a><span id="l41.54">   inline void ClearState(unsigned int s) { m_state &amp;= ~s; }</span>
<a href="#l41.55"></a><span id="l41.55">   inline bool CheckState(State s) { return (m_state &amp; s) != 0; }</span>
<a href="#l41.56"></a><span id="l41.56">   inline bool IsAsterisk() { return CheckState(sAsterisk); }</span>
<a href="#l41.57"></a><span id="l41.57">   inline bool IsBeginGroup() { return CheckState(sBeginGroup); }</span>
<a href="#l41.58"></a><span id="l41.58">   inline bool IsHtmlRtf() { return CheckState(sHtmlRtf); }</span>
<a href="#l41.59"></a><span id="l41.59" class="difflineminus">-  void AddText(const wchar_t* txt, size_t cch=static_cast&lt;size_t&gt;(-1));</span>
<a href="#l41.60"></a><span id="l41.60" class="difflineplus">+  void AddText(const wchar_t* txt, size_t cch = static_cast&lt;size_t&gt;(-1));</span>
<a href="#l41.61"></a><span id="l41.61"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1" class="difflineminus">--- a/mailnews/import/src/ImportCharSet.cpp</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineplus">+++ b/mailnews/import/src/ImportCharSet.cpp</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineat">@@ -1,58 +1,58 @@</span>
<a href="#l42.4"></a><span id="l42.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l42.5"></a><span id="l42.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l42.6"></a><span id="l42.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l42.7"></a><span id="l42.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l42.8"></a><span id="l42.8"> </span>
<a href="#l42.9"></a><span id="l42.9" class="difflineminus">-</span>
<a href="#l42.10"></a><span id="l42.10"> #include &quot;ImportCharSet.h&quot;</span>
<a href="#l42.11"></a><span id="l42.11"> </span>
<a href="#l42.12"></a><span id="l42.12"> char ImportCharSet::m_upperCaseMap[256];</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineminus">-char ImportCharSet::m_Ascii[256] = {0}; // the initialiser makes it strong</span>
<a href="#l42.14"></a><span id="l42.14" class="difflineplus">+char ImportCharSet::m_Ascii[256] = {0};  // the initialiser makes it strong</span>
<a href="#l42.15"></a><span id="l42.15"> </span>
<a href="#l42.16"></a><span id="l42.16"> class UInitMaps {</span>
<a href="#l42.17"></a><span id="l42.17" class="difflineminus">-public:</span>
<a href="#l42.18"></a><span id="l42.18" class="difflineplus">+ public:</span>
<a href="#l42.19"></a><span id="l42.19">   UInitMaps();</span>
<a href="#l42.20"></a><span id="l42.20"> };</span>
<a href="#l42.21"></a><span id="l42.21"> </span>
<a href="#l42.22"></a><span id="l42.22" class="difflineminus">-UInitMaps  gInitMaps;</span>
<a href="#l42.23"></a><span id="l42.23" class="difflineplus">+UInitMaps gInitMaps;</span>
<a href="#l42.24"></a><span id="l42.24"> </span>
<a href="#l42.25"></a><span id="l42.25" class="difflineminus">-UInitMaps::UInitMaps()</span>
<a href="#l42.26"></a><span id="l42.26" class="difflineminus">-{</span>
<a href="#l42.27"></a><span id="l42.27" class="difflineminus">-  int  i;</span>
<a href="#l42.28"></a><span id="l42.28" class="difflineplus">+UInitMaps::UInitMaps() {</span>
<a href="#l42.29"></a><span id="l42.29" class="difflineplus">+  int i;</span>
<a href="#l42.30"></a><span id="l42.30"> </span>
<a href="#l42.31"></a><span id="l42.31" class="difflineminus">-  for (i = 0; i &lt; 256; i++)</span>
<a href="#l42.32"></a><span id="l42.32" class="difflineminus">-    ImportCharSet::m_upperCaseMap[i] = i;</span>
<a href="#l42.33"></a><span id="l42.33" class="difflineminus">-  for (i = 'a'; i &lt;= 'z'; i++)</span>
<a href="#l42.34"></a><span id="l42.34" class="difflineminus">-    ImportCharSet::m_upperCaseMap[i] = i - 'a' + 'A';</span>
<a href="#l42.35"></a><span id="l42.35" class="difflineplus">+  for (i = 0; i &lt; 256; i++) ImportCharSet::m_upperCaseMap[i] = i;</span>
<a href="#l42.36"></a><span id="l42.36" class="difflineplus">+  for (i = 'a'; i &lt;= 'z'; i++) ImportCharSet::m_upperCaseMap[i] = i - 'a' + 'A';</span>
<a href="#l42.37"></a><span id="l42.37"> </span>
<a href="#l42.38"></a><span id="l42.38" class="difflineminus">-  for (i = 0; i &lt; 256; i++)</span>
<a href="#l42.39"></a><span id="l42.39" class="difflineminus">-    ImportCharSet::m_Ascii[i] = 0;</span>
<a href="#l42.40"></a><span id="l42.40" class="difflineplus">+  for (i = 0; i &lt; 256; i++) ImportCharSet::m_Ascii[i] = 0;</span>
<a href="#l42.41"></a><span id="l42.41"> </span>
<a href="#l42.42"></a><span id="l42.42">   for (i = ImportCharSet::cUpperAChar; i &lt;= ImportCharSet::cUpperZChar; i++)</span>
<a href="#l42.43"></a><span id="l42.43" class="difflineminus">-    ImportCharSet::m_Ascii[i] |= (ImportCharSet::cAlphaNumChar | ImportCharSet::cAlphaChar);</span>
<a href="#l42.44"></a><span id="l42.44" class="difflineplus">+    ImportCharSet::m_Ascii[i] |=</span>
<a href="#l42.45"></a><span id="l42.45" class="difflineplus">+        (ImportCharSet::cAlphaNumChar | ImportCharSet::cAlphaChar);</span>
<a href="#l42.46"></a><span id="l42.46">   for (i = ImportCharSet::cLowerAChar; i &lt;= ImportCharSet::cLowerZChar; i++)</span>
<a href="#l42.47"></a><span id="l42.47" class="difflineminus">-    ImportCharSet::m_Ascii[i] |= (ImportCharSet::cAlphaNumChar | ImportCharSet::cAlphaChar);</span>
<a href="#l42.48"></a><span id="l42.48" class="difflineplus">+    ImportCharSet::m_Ascii[i] |=</span>
<a href="#l42.49"></a><span id="l42.49" class="difflineplus">+        (ImportCharSet::cAlphaNumChar | ImportCharSet::cAlphaChar);</span>
<a href="#l42.50"></a><span id="l42.50">   for (i = ImportCharSet::cZeroChar; i &lt;= ImportCharSet::cNineChar; i++)</span>
<a href="#l42.51"></a><span id="l42.51" class="difflineminus">-    ImportCharSet::m_Ascii[i] |= (ImportCharSet::cAlphaNumChar | ImportCharSet::cDigitChar);</span>
<a href="#l42.52"></a><span id="l42.52" class="difflineplus">+    ImportCharSet::m_Ascii[i] |=</span>
<a href="#l42.53"></a><span id="l42.53" class="difflineplus">+        (ImportCharSet::cAlphaNumChar | ImportCharSet::cDigitChar);</span>
<a href="#l42.54"></a><span id="l42.54"> </span>
<a href="#l42.55"></a><span id="l42.55" class="difflineminus">-  ImportCharSet::m_Ascii[ImportCharSet::cTabChar] |= ImportCharSet::cWhiteSpaceChar;</span>
<a href="#l42.56"></a><span id="l42.56" class="difflineminus">-  ImportCharSet::m_Ascii[ImportCharSet::cCRChar] |= ImportCharSet::cWhiteSpaceChar;</span>
<a href="#l42.57"></a><span id="l42.57" class="difflineminus">-  ImportCharSet::m_Ascii[ImportCharSet::cLinefeedChar] |= ImportCharSet::cWhiteSpaceChar;</span>
<a href="#l42.58"></a><span id="l42.58" class="difflineminus">-  ImportCharSet::m_Ascii[ImportCharSet::cSpaceChar] |= ImportCharSet::cWhiteSpaceChar;</span>
<a href="#l42.59"></a><span id="l42.59" class="difflineplus">+  ImportCharSet::m_Ascii[ImportCharSet::cTabChar] |=</span>
<a href="#l42.60"></a><span id="l42.60" class="difflineplus">+      ImportCharSet::cWhiteSpaceChar;</span>
<a href="#l42.61"></a><span id="l42.61" class="difflineplus">+  ImportCharSet::m_Ascii[ImportCharSet::cCRChar] |=</span>
<a href="#l42.62"></a><span id="l42.62" class="difflineplus">+      ImportCharSet::cWhiteSpaceChar;</span>
<a href="#l42.63"></a><span id="l42.63" class="difflineplus">+  ImportCharSet::m_Ascii[ImportCharSet::cLinefeedChar] |=</span>
<a href="#l42.64"></a><span id="l42.64" class="difflineplus">+      ImportCharSet::cWhiteSpaceChar;</span>
<a href="#l42.65"></a><span id="l42.65" class="difflineplus">+  ImportCharSet::m_Ascii[ImportCharSet::cSpaceChar] |=</span>
<a href="#l42.66"></a><span id="l42.66" class="difflineplus">+      ImportCharSet::cWhiteSpaceChar;</span>
<a href="#l42.67"></a><span id="l42.67"> </span>
<a href="#l42.68"></a><span id="l42.68">   ImportCharSet::m_Ascii[uint8_t('(')] |= ImportCharSet::c822SpecialChar;</span>
<a href="#l42.69"></a><span id="l42.69">   ImportCharSet::m_Ascii[uint8_t(')')] |= ImportCharSet::c822SpecialChar;</span>
<a href="#l42.70"></a><span id="l42.70">   ImportCharSet::m_Ascii[uint8_t('&lt;')] |= ImportCharSet::c822SpecialChar;</span>
<a href="#l42.71"></a><span id="l42.71">   ImportCharSet::m_Ascii[uint8_t('&gt;')] |= ImportCharSet::c822SpecialChar;</span>
<a href="#l42.72"></a><span id="l42.72">   ImportCharSet::m_Ascii[uint8_t('@')] |= ImportCharSet::c822SpecialChar;</span>
<a href="#l42.73"></a><span id="l42.73">   ImportCharSet::m_Ascii[uint8_t(',')] |= ImportCharSet::c822SpecialChar;</span>
<a href="#l42.74"></a><span id="l42.74">   ImportCharSet::m_Ascii[uint8_t(';')] |= ImportCharSet::c822SpecialChar;</span>
<a href="#l42.75"></a><span id="l42.75">   ImportCharSet::m_Ascii[uint8_t(':')] |= ImportCharSet::c822SpecialChar;</span>
<a href="#l42.76"></a><span id="l42.76">   ImportCharSet::m_Ascii[uint8_t('\\')] |= ImportCharSet::c822SpecialChar;</span>
<a href="#l42.77"></a><span id="l42.77">   ImportCharSet::m_Ascii[uint8_t('&quot;')] |= ImportCharSet::c822SpecialChar;</span>
<a href="#l42.78"></a><span id="l42.78">   ImportCharSet::m_Ascii[uint8_t('.')] |= ImportCharSet::c822SpecialChar;</span>
<a href="#l42.79"></a><span id="l42.79">   ImportCharSet::m_Ascii[uint8_t('[')] |= ImportCharSet::c822SpecialChar;</span>
<a href="#l42.80"></a><span id="l42.80">   ImportCharSet::m_Ascii[uint8_t(']')] |= ImportCharSet::c822SpecialChar;</span>
<a href="#l42.81"></a><span id="l42.81" class="difflineminus">-</span>
<a href="#l42.82"></a><span id="l42.82" class="difflineminus">-</span>
<a href="#l42.83"></a><span id="l42.83"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1" class="difflineminus">--- a/mailnews/import/src/ImportCharSet.h</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineplus">+++ b/mailnews/import/src/ImportCharSet.h</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineat">@@ -3,36 +3,35 @@</span>
<a href="#l43.4"></a><span id="l43.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l43.5"></a><span id="l43.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l43.6"></a><span id="l43.6"> </span>
<a href="#l43.7"></a><span id="l43.7"> #ifndef ImportCharSet_h___</span>
<a href="#l43.8"></a><span id="l43.8"> #define ImportCharSet_h___</span>
<a href="#l43.9"></a><span id="l43.9"> </span>
<a href="#l43.10"></a><span id="l43.10"> #include &quot;nscore.h&quot;</span>
<a href="#l43.11"></a><span id="l43.11"> </span>
<a href="#l43.12"></a><span id="l43.12" class="difflineminus">-</span>
<a href="#l43.13"></a><span id="l43.13"> // Some useful ASCII values</span>
<a href="#l43.14"></a><span id="l43.14"> //  'A' = 65, 0x41</span>
<a href="#l43.15"></a><span id="l43.15"> //  'Z' = 90, 0x5a</span>
<a href="#l43.16"></a><span id="l43.16"> //  '_' = 95, 0x5f</span>
<a href="#l43.17"></a><span id="l43.17"> //  'a' = 97, 0x61</span>
<a href="#l43.18"></a><span id="l43.18"> //  'z' = 122, 0x7a</span>
<a href="#l43.19"></a><span id="l43.19"> //  '0' = 48, 0x30</span>
<a href="#l43.20"></a><span id="l43.20"> //  '1' = 49, 0x31</span>
<a href="#l43.21"></a><span id="l43.21"> //  '9' = 57, 0x39</span>
<a href="#l43.22"></a><span id="l43.22"> //  ' ' = 32, 0x20</span>
<a href="#l43.23"></a><span id="l43.23" class="difflineminus">-//   whitespace, 10, 13, 32, 9 (linefeed, cr, space, tab) - 0x0a, 0x0d, 0x20, 0x09</span>
<a href="#l43.24"></a><span id="l43.24" class="difflineplus">+//   whitespace, 10, 13, 32, 9 (linefeed, cr, space, tab) - 0x0a, 0x0d, 0x20,</span>
<a href="#l43.25"></a><span id="l43.25" class="difflineplus">+//   0x09</span>
<a href="#l43.26"></a><span id="l43.26"> //  ':' = 58, 0x3a</span>
<a href="#l43.27"></a><span id="l43.27"> </span>
<a href="#l43.28"></a><span id="l43.28" class="difflineminus">-</span>
<a href="#l43.29"></a><span id="l43.29" class="difflineminus">-// a typedef enum would be nicer but some compilers still have trouble with treating</span>
<a href="#l43.30"></a><span id="l43.30" class="difflineminus">-// enum's as plain numbers when needed</span>
<a href="#l43.31"></a><span id="l43.31" class="difflineplus">+// a typedef enum would be nicer but some compilers still have trouble with</span>
<a href="#l43.32"></a><span id="l43.32" class="difflineplus">+// treating enum's as plain numbers when needed</span>
<a href="#l43.33"></a><span id="l43.33"> </span>
<a href="#l43.34"></a><span id="l43.34"> class ImportCharSet {</span>
<a href="#l43.35"></a><span id="l43.35" class="difflineminus">-public:</span>
<a href="#l43.36"></a><span id="l43.36" class="difflineplus">+ public:</span>
<a href="#l43.37"></a><span id="l43.37">   enum {</span>
<a href="#l43.38"></a><span id="l43.38">     cTabChar = 9,</span>
<a href="#l43.39"></a><span id="l43.39">     cLinefeedChar = 10,</span>
<a href="#l43.40"></a><span id="l43.40">     cCRChar = 13,</span>
<a href="#l43.41"></a><span id="l43.41">     cSpaceChar = 32,</span>
<a href="#l43.42"></a><span id="l43.42">     cUpperAChar = 65,</span>
<a href="#l43.43"></a><span id="l43.43">     cUpperZChar = 90,</span>
<a href="#l43.44"></a><span id="l43.44">     cUnderscoreChar = 95,</span>
<a href="#l43.45"></a><span id="l43.45" class="difflineat">@@ -43,133 +42,160 @@ public:</span>
<a href="#l43.46"></a><span id="l43.46"> </span>
<a href="#l43.47"></a><span id="l43.47">     cAlphaNumChar = 1,</span>
<a href="#l43.48"></a><span id="l43.48">     cAlphaChar = 2,</span>
<a href="#l43.49"></a><span id="l43.49">     cWhiteSpaceChar = 4,</span>
<a href="#l43.50"></a><span id="l43.50">     cDigitChar = 8,</span>
<a href="#l43.51"></a><span id="l43.51">     c822SpecialChar = 16</span>
<a href="#l43.52"></a><span id="l43.52">   };</span>
<a href="#l43.53"></a><span id="l43.53"> </span>
<a href="#l43.54"></a><span id="l43.54" class="difflineminus">-  static char      m_upperCaseMap[256];</span>
<a href="#l43.55"></a><span id="l43.55" class="difflineminus">-  static char      m_Ascii[256];</span>
<a href="#l43.56"></a><span id="l43.56" class="difflineplus">+  static char m_upperCaseMap[256];</span>
<a href="#l43.57"></a><span id="l43.57" class="difflineplus">+  static char m_Ascii[256];</span>
<a href="#l43.58"></a><span id="l43.58"> </span>
<a href="#l43.59"></a><span id="l43.59" class="difflineminus">-  inline static bool IsUSAscii(uint8_t ch) { return (((ch &amp; (uint8_t)0x80) == 0));}</span>
<a href="#l43.60"></a><span id="l43.60" class="difflineminus">-  inline static bool Is822CtlChar(uint8_t ch) { return (ch &lt; 32);}</span>
<a href="#l43.61"></a><span id="l43.61" class="difflineminus">-  inline static bool Is822SpecialChar(uint8_t ch) { return ((m_Ascii[ch] &amp; c822SpecialChar) == c822SpecialChar);}</span>
<a href="#l43.62"></a><span id="l43.62" class="difflineminus">-  inline static bool IsWhiteSpace(uint8_t ch) { return ((m_Ascii[ch] &amp; cWhiteSpaceChar) == cWhiteSpaceChar); }</span>
<a href="#l43.63"></a><span id="l43.63" class="difflineminus">-  inline static bool IsAlphaNum(uint8_t ch) { return ((m_Ascii[ch] &amp; cAlphaNumChar) == cAlphaNumChar); }</span>
<a href="#l43.64"></a><span id="l43.64" class="difflineminus">-  inline static bool IsDigit(uint8_t ch) { return ((m_Ascii[ch] &amp; cDigitChar) == cDigitChar); }</span>
<a href="#l43.65"></a><span id="l43.65" class="difflineplus">+  inline static bool IsUSAscii(uint8_t ch) {</span>
<a href="#l43.66"></a><span id="l43.66" class="difflineplus">+    return (((ch &amp; (uint8_t)0x80) == 0));</span>
<a href="#l43.67"></a><span id="l43.67" class="difflineplus">+  }</span>
<a href="#l43.68"></a><span id="l43.68" class="difflineplus">+  inline static bool Is822CtlChar(uint8_t ch) { return (ch &lt; 32); }</span>
<a href="#l43.69"></a><span id="l43.69" class="difflineplus">+  inline static bool Is822SpecialChar(uint8_t ch) {</span>
<a href="#l43.70"></a><span id="l43.70" class="difflineplus">+    return ((m_Ascii[ch] &amp; c822SpecialChar) == c822SpecialChar);</span>
<a href="#l43.71"></a><span id="l43.71" class="difflineplus">+  }</span>
<a href="#l43.72"></a><span id="l43.72" class="difflineplus">+  inline static bool IsWhiteSpace(uint8_t ch) {</span>
<a href="#l43.73"></a><span id="l43.73" class="difflineplus">+    return ((m_Ascii[ch] &amp; cWhiteSpaceChar) == cWhiteSpaceChar);</span>
<a href="#l43.74"></a><span id="l43.74" class="difflineplus">+  }</span>
<a href="#l43.75"></a><span id="l43.75" class="difflineplus">+  inline static bool IsAlphaNum(uint8_t ch) {</span>
<a href="#l43.76"></a><span id="l43.76" class="difflineplus">+    return ((m_Ascii[ch] &amp; cAlphaNumChar) == cAlphaNumChar);</span>
<a href="#l43.77"></a><span id="l43.77" class="difflineplus">+  }</span>
<a href="#l43.78"></a><span id="l43.78" class="difflineplus">+  inline static bool IsDigit(uint8_t ch) {</span>
<a href="#l43.79"></a><span id="l43.79" class="difflineplus">+    return ((m_Ascii[ch] &amp; cDigitChar) == cDigitChar);</span>
<a href="#l43.80"></a><span id="l43.80" class="difflineplus">+  }</span>
<a href="#l43.81"></a><span id="l43.81"> </span>
<a href="#l43.82"></a><span id="l43.82" class="difflineminus">-  inline static uint8_t ToLower(uint8_t ch) { if ((m_Ascii[ch] &amp; cAlphaChar) == cAlphaChar) { return cLowerAChar + (m_upperCaseMap[ch] - cUpperAChar); } else return ch; }</span>
<a href="#l43.83"></a><span id="l43.83" class="difflineplus">+  inline static uint8_t ToLower(uint8_t ch) {</span>
<a href="#l43.84"></a><span id="l43.84" class="difflineplus">+    if ((m_Ascii[ch] &amp; cAlphaChar) == cAlphaChar) {</span>
<a href="#l43.85"></a><span id="l43.85" class="difflineplus">+      return cLowerAChar + (m_upperCaseMap[ch] - cUpperAChar);</span>
<a href="#l43.86"></a><span id="l43.86" class="difflineplus">+    } else</span>
<a href="#l43.87"></a><span id="l43.87" class="difflineplus">+      return ch;</span>
<a href="#l43.88"></a><span id="l43.88" class="difflineplus">+  }</span>
<a href="#l43.89"></a><span id="l43.89"> </span>
<a href="#l43.90"></a><span id="l43.90" class="difflineminus">-  inline static long AsciiToLong(const uint8_t * pChar, uint32_t len) {</span>
<a href="#l43.91"></a><span id="l43.91" class="difflineplus">+  inline static long AsciiToLong(const uint8_t* pChar, uint32_t len) {</span>
<a href="#l43.92"></a><span id="l43.92">     long num = 0;</span>
<a href="#l43.93"></a><span id="l43.93">     while (len) {</span>
<a href="#l43.94"></a><span id="l43.94" class="difflineminus">-      if ((m_Ascii[*pChar] &amp; cDigitChar) == 0)</span>
<a href="#l43.95"></a><span id="l43.95" class="difflineminus">-        return num;</span>
<a href="#l43.96"></a><span id="l43.96" class="difflineplus">+      if ((m_Ascii[*pChar] &amp; cDigitChar) == 0) return num;</span>
<a href="#l43.97"></a><span id="l43.97">       num *= 10;</span>
<a href="#l43.98"></a><span id="l43.98">       num += (*pChar - cZeroChar);</span>
<a href="#l43.99"></a><span id="l43.99">       len--;</span>
<a href="#l43.100"></a><span id="l43.100">       pChar++;</span>
<a href="#l43.101"></a><span id="l43.101">     }</span>
<a href="#l43.102"></a><span id="l43.102">     return num;</span>
<a href="#l43.103"></a><span id="l43.103">   }</span>
<a href="#l43.104"></a><span id="l43.104"> </span>
<a href="#l43.105"></a><span id="l43.105" class="difflineminus">-  inline static void ByteToHex(uint8_t byte, uint8_t * pHex) {</span>
<a href="#l43.106"></a><span id="l43.106" class="difflineplus">+  inline static void ByteToHex(uint8_t byte, uint8_t* pHex) {</span>
<a href="#l43.107"></a><span id="l43.107">     uint8_t val = byte;</span>
<a href="#l43.108"></a><span id="l43.108">     val /= 16;</span>
<a href="#l43.109"></a><span id="l43.109">     if (val &lt; 10)</span>
<a href="#l43.110"></a><span id="l43.110">       *pHex = '0' + val;</span>
<a href="#l43.111"></a><span id="l43.111">     else</span>
<a href="#l43.112"></a><span id="l43.112">       *pHex = 'A' + (val - 10);</span>
<a href="#l43.113"></a><span id="l43.113">     pHex++;</span>
<a href="#l43.114"></a><span id="l43.114">     val = byte;</span>
<a href="#l43.115"></a><span id="l43.115">     val &amp;= 0x0F;</span>
<a href="#l43.116"></a><span id="l43.116">     if (val &lt; 10)</span>
<a href="#l43.117"></a><span id="l43.117">       *pHex = '0' + val;</span>
<a href="#l43.118"></a><span id="l43.118">     else</span>
<a href="#l43.119"></a><span id="l43.119">       *pHex = 'A' + (val - 10);</span>
<a href="#l43.120"></a><span id="l43.120">   }</span>
<a href="#l43.121"></a><span id="l43.121"> </span>
<a href="#l43.122"></a><span id="l43.122" class="difflineminus">-  inline static void  LongToHexBytes(uint32_t type, uint8_t * pStr) {</span>
<a href="#l43.123"></a><span id="l43.123" class="difflineminus">-    ByteToHex((uint8_t) (type &gt;&gt; 24), pStr);</span>
<a href="#l43.124"></a><span id="l43.124" class="difflineplus">+  inline static void LongToHexBytes(uint32_t type, uint8_t* pStr) {</span>
<a href="#l43.125"></a><span id="l43.125" class="difflineplus">+    ByteToHex((uint8_t)(type &gt;&gt; 24), pStr);</span>
<a href="#l43.126"></a><span id="l43.126">     pStr += 2;</span>
<a href="#l43.127"></a><span id="l43.127" class="difflineminus">-    ByteToHex((uint8_t) ((type &gt;&gt; 16) &amp; 0x0FF), pStr);</span>
<a href="#l43.128"></a><span id="l43.128" class="difflineplus">+    ByteToHex((uint8_t)((type &gt;&gt; 16) &amp; 0x0FF), pStr);</span>
<a href="#l43.129"></a><span id="l43.129">     pStr += 2;</span>
<a href="#l43.130"></a><span id="l43.130" class="difflineminus">-    ByteToHex((uint8_t) ((type &gt;&gt; 8) &amp; 0x0FF), pStr);</span>
<a href="#l43.131"></a><span id="l43.131" class="difflineplus">+    ByteToHex((uint8_t)((type &gt;&gt; 8) &amp; 0x0FF), pStr);</span>
<a href="#l43.132"></a><span id="l43.132">     pStr += 2;</span>
<a href="#l43.133"></a><span id="l43.133" class="difflineminus">-    ByteToHex((uint8_t) (type &amp; 0x0FF), pStr);</span>
<a href="#l43.134"></a><span id="l43.134" class="difflineplus">+    ByteToHex((uint8_t)(type &amp; 0x0FF), pStr);</span>
<a href="#l43.135"></a><span id="l43.135">   }</span>
<a href="#l43.136"></a><span id="l43.136"> </span>
<a href="#l43.137"></a><span id="l43.137" class="difflineminus">-  inline static void SkipWhiteSpace(const uint8_t * &amp; pChar, uint32_t &amp; pos, uint32_t max) {</span>
<a href="#l43.138"></a><span id="l43.138" class="difflineplus">+  inline static void SkipWhiteSpace(const uint8_t*&amp; pChar, uint32_t&amp; pos,</span>
<a href="#l43.139"></a><span id="l43.139" class="difflineplus">+                                    uint32_t max) {</span>
<a href="#l43.140"></a><span id="l43.140">     while ((pos &lt; max) &amp;&amp; (IsWhiteSpace(*pChar))) {</span>
<a href="#l43.141"></a><span id="l43.141" class="difflineminus">-      pos++; pChar++;</span>
<a href="#l43.142"></a><span id="l43.142" class="difflineplus">+      pos++;</span>
<a href="#l43.143"></a><span id="l43.143" class="difflineplus">+      pChar++;</span>
<a href="#l43.144"></a><span id="l43.144">     }</span>
<a href="#l43.145"></a><span id="l43.145">   }</span>
<a href="#l43.146"></a><span id="l43.146"> </span>
<a href="#l43.147"></a><span id="l43.147" class="difflineminus">-  inline static void SkipSpaceTab(const uint8_t * &amp; pChar, uint32_t&amp; pos, uint32_t max) {</span>
<a href="#l43.148"></a><span id="l43.148" class="difflineminus">-    while ((pos &lt; max) &amp;&amp; ((*pChar == (uint8_t)cSpaceChar) || (*pChar == (uint8_t)cTabChar))) {</span>
<a href="#l43.149"></a><span id="l43.149" class="difflineminus">-      pos++; pChar++;</span>
<a href="#l43.150"></a><span id="l43.150" class="difflineminus">-    }</span>
<a href="#l43.151"></a><span id="l43.151" class="difflineminus">-  }</span>
<a href="#l43.152"></a><span id="l43.152" class="difflineminus">-</span>
<a href="#l43.153"></a><span id="l43.153" class="difflineminus">-  inline static void SkipTilSpaceTab(const uint8_t * &amp; pChar, uint32_t&amp; pos, uint32_t max) {</span>
<a href="#l43.154"></a><span id="l43.154" class="difflineminus">-    while ((pos &lt; max) &amp;&amp; (*pChar != (uint8_t)cSpaceChar) &amp;&amp; (*pChar != (uint8_t)cTabChar)) {</span>
<a href="#l43.155"></a><span id="l43.155" class="difflineplus">+  inline static void SkipSpaceTab(const uint8_t*&amp; pChar, uint32_t&amp; pos,</span>
<a href="#l43.156"></a><span id="l43.156" class="difflineplus">+                                  uint32_t max) {</span>
<a href="#l43.157"></a><span id="l43.157" class="difflineplus">+    while ((pos &lt; max) &amp;&amp;</span>
<a href="#l43.158"></a><span id="l43.158" class="difflineplus">+           ((*pChar == (uint8_t)cSpaceChar) || (*pChar == (uint8_t)cTabChar))) {</span>
<a href="#l43.159"></a><span id="l43.159">       pos++;</span>
<a href="#l43.160"></a><span id="l43.160">       pChar++;</span>
<a href="#l43.161"></a><span id="l43.161">     }</span>
<a href="#l43.162"></a><span id="l43.162">   }</span>
<a href="#l43.163"></a><span id="l43.163"> </span>
<a href="#l43.164"></a><span id="l43.164" class="difflineminus">-  inline static bool StrNICmp(const uint8_t * pChar, const uint8_t * pSrc, uint32_t len) {</span>
<a href="#l43.165"></a><span id="l43.165" class="difflineplus">+  inline static void SkipTilSpaceTab(const uint8_t*&amp; pChar, uint32_t&amp; pos,</span>
<a href="#l43.166"></a><span id="l43.166" class="difflineplus">+                                     uint32_t max) {</span>
<a href="#l43.167"></a><span id="l43.167" class="difflineplus">+    while ((pos &lt; max) &amp;&amp; (*pChar != (uint8_t)cSpaceChar) &amp;&amp;</span>
<a href="#l43.168"></a><span id="l43.168" class="difflineplus">+           (*pChar != (uint8_t)cTabChar)) {</span>
<a href="#l43.169"></a><span id="l43.169" class="difflineplus">+      pos++;</span>
<a href="#l43.170"></a><span id="l43.170" class="difflineplus">+      pChar++;</span>
<a href="#l43.171"></a><span id="l43.171" class="difflineplus">+    }</span>
<a href="#l43.172"></a><span id="l43.172" class="difflineplus">+  }</span>
<a href="#l43.173"></a><span id="l43.173" class="difflineplus">+</span>
<a href="#l43.174"></a><span id="l43.174" class="difflineplus">+  inline static bool StrNICmp(const uint8_t* pChar, const uint8_t* pSrc,</span>
<a href="#l43.175"></a><span id="l43.175" class="difflineplus">+                              uint32_t len) {</span>
<a href="#l43.176"></a><span id="l43.176">     while (len &amp;&amp; (m_upperCaseMap[*pChar] == m_upperCaseMap[*pSrc])) {</span>
<a href="#l43.177"></a><span id="l43.177" class="difflineminus">-      pChar++; pSrc++; len--;</span>
<a href="#l43.178"></a><span id="l43.178" class="difflineplus">+      pChar++;</span>
<a href="#l43.179"></a><span id="l43.179" class="difflineplus">+      pSrc++;</span>
<a href="#l43.180"></a><span id="l43.180" class="difflineplus">+      len--;</span>
<a href="#l43.181"></a><span id="l43.181">     }</span>
<a href="#l43.182"></a><span id="l43.182">     return len == 0;</span>
<a href="#l43.183"></a><span id="l43.183">   }</span>
<a href="#l43.184"></a><span id="l43.184"> </span>
<a href="#l43.185"></a><span id="l43.185" class="difflineminus">-  inline static bool StrNCmp(const uint8_t * pChar, const uint8_t *pSrc, uint32_t len) {</span>
<a href="#l43.186"></a><span id="l43.186" class="difflineplus">+  inline static bool StrNCmp(const uint8_t* pChar, const uint8_t* pSrc,</span>
<a href="#l43.187"></a><span id="l43.187" class="difflineplus">+                             uint32_t len) {</span>
<a href="#l43.188"></a><span id="l43.188">     while (len &amp;&amp; (*pChar == *pSrc)) {</span>
<a href="#l43.189"></a><span id="l43.189" class="difflineminus">-      pChar++; pSrc++; len--;</span>
<a href="#l43.190"></a><span id="l43.190" class="difflineplus">+      pChar++;</span>
<a href="#l43.191"></a><span id="l43.191" class="difflineplus">+      pSrc++;</span>
<a href="#l43.192"></a><span id="l43.192" class="difflineplus">+      len--;</span>
<a href="#l43.193"></a><span id="l43.193">     }</span>
<a href="#l43.194"></a><span id="l43.194">     return len == 0;</span>
<a href="#l43.195"></a><span id="l43.195">   }</span>
<a href="#l43.196"></a><span id="l43.196"> </span>
<a href="#l43.197"></a><span id="l43.197" class="difflineminus">-  inline static int FindChar(const uint8_t * pChar, uint8_t ch, uint32_t max) {</span>
<a href="#l43.198"></a><span id="l43.198" class="difflineminus">-    uint32_t    pos = 0;</span>
<a href="#l43.199"></a><span id="l43.199" class="difflineplus">+  inline static int FindChar(const uint8_t* pChar, uint8_t ch, uint32_t max) {</span>
<a href="#l43.200"></a><span id="l43.200" class="difflineplus">+    uint32_t pos = 0;</span>
<a href="#l43.201"></a><span id="l43.201">     while ((pos &lt; max) &amp;&amp; (*pChar != ch)) {</span>
<a href="#l43.202"></a><span id="l43.202" class="difflineminus">-      pos++; pChar++;</span>
<a href="#l43.203"></a><span id="l43.203" class="difflineplus">+      pos++;</span>
<a href="#l43.204"></a><span id="l43.204" class="difflineplus">+      pChar++;</span>
<a href="#l43.205"></a><span id="l43.205">     }</span>
<a href="#l43.206"></a><span id="l43.206">     if (pos &lt; max)</span>
<a href="#l43.207"></a><span id="l43.207" class="difflineminus">-      return (int) pos;</span>
<a href="#l43.208"></a><span id="l43.208" class="difflineplus">+      return (int)pos;</span>
<a href="#l43.209"></a><span id="l43.209">     else</span>
<a href="#l43.210"></a><span id="l43.210">       return -1;</span>
<a href="#l43.211"></a><span id="l43.211">   }</span>
<a href="#l43.212"></a><span id="l43.212"> </span>
<a href="#l43.213"></a><span id="l43.213" class="difflineminus">-  inline static bool NextChar(const uint8_t * &amp; pChar, uint8_t ch, uint32_t&amp; pos, uint32_t max) {</span>
<a href="#l43.214"></a><span id="l43.214" class="difflineplus">+  inline static bool NextChar(const uint8_t*&amp; pChar, uint8_t ch, uint32_t&amp; pos,</span>
<a href="#l43.215"></a><span id="l43.215" class="difflineplus">+                              uint32_t max) {</span>
<a href="#l43.216"></a><span id="l43.216">     if ((pos &lt; max) &amp;&amp; (*pChar == ch)) {</span>
<a href="#l43.217"></a><span id="l43.217">       pos++;</span>
<a href="#l43.218"></a><span id="l43.218">       pChar++;</span>
<a href="#l43.219"></a><span id="l43.219">       return true;</span>
<a href="#l43.220"></a><span id="l43.220">     }</span>
<a href="#l43.221"></a><span id="l43.221">     return false;</span>
<a href="#l43.222"></a><span id="l43.222">   }</span>
<a href="#l43.223"></a><span id="l43.223"> </span>
<a href="#l43.224"></a><span id="l43.224" class="difflineminus">-  inline static int32_t strcmp(const char * pS1, const char * pS2) {</span>
<a href="#l43.225"></a><span id="l43.225" class="difflineplus">+  inline static int32_t strcmp(const char* pS1, const char* pS2) {</span>
<a href="#l43.226"></a><span id="l43.226">     while (*pS1 &amp;&amp; *pS2 &amp;&amp; (*pS1 == *pS2)) {</span>
<a href="#l43.227"></a><span id="l43.227">       pS1++;</span>
<a href="#l43.228"></a><span id="l43.228">       pS2++;</span>
<a href="#l43.229"></a><span id="l43.229">     }</span>
<a href="#l43.230"></a><span id="l43.230">     return *pS1 - *pS2;</span>
<a href="#l43.231"></a><span id="l43.231">   }</span>
<a href="#l43.232"></a><span id="l43.232"> </span>
<a href="#l43.233"></a><span id="l43.233" class="difflineminus">-  inline static int32_t stricmp(const char * pS1, const char * pS2) {</span>
<a href="#l43.234"></a><span id="l43.234" class="difflineminus">-    while (*pS1 &amp;&amp; *pS2 &amp;&amp; (m_upperCaseMap[uint8_t(*pS1)] == m_upperCaseMap[uint8_t(*pS2)])) {</span>
<a href="#l43.235"></a><span id="l43.235" class="difflineplus">+  inline static int32_t stricmp(const char* pS1, const char* pS2) {</span>
<a href="#l43.236"></a><span id="l43.236" class="difflineplus">+    while (*pS1 &amp;&amp; *pS2 &amp;&amp;</span>
<a href="#l43.237"></a><span id="l43.237" class="difflineplus">+           (m_upperCaseMap[uint8_t(*pS1)] == m_upperCaseMap[uint8_t(*pS2)])) {</span>
<a href="#l43.238"></a><span id="l43.238">       pS1++;</span>
<a href="#l43.239"></a><span id="l43.239">       pS2++;</span>
<a href="#l43.240"></a><span id="l43.240">     }</span>
<a href="#l43.241"></a><span id="l43.241">     return m_upperCaseMap[uint8_t(*pS1)] - m_upperCaseMap[uint8_t(*pS2)];</span>
<a href="#l43.242"></a><span id="l43.242">   }</span>
<a href="#l43.243"></a><span id="l43.243" class="difflineminus">-</span>
<a href="#l43.244"></a><span id="l43.244"> };</span>
<a href="#l43.245"></a><span id="l43.245"> </span>
<a href="#l43.246"></a><span id="l43.246" class="difflineminus">-</span>
<a href="#l43.247"></a><span id="l43.247"> #endif /* ImportCharSet_h__ */</span>
<a href="#l43.248"></a><span id="l43.248" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1" class="difflineminus">--- a/mailnews/import/src/ImportDebug.h</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineplus">+++ b/mailnews/import/src/ImportDebug.h</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineat">@@ -2,20 +2,24 @@</span>
<a href="#l44.4"></a><span id="l44.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l44.5"></a><span id="l44.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l44.6"></a><span id="l44.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l44.7"></a><span id="l44.7"> </span>
<a href="#l44.8"></a><span id="l44.8"> #ifndef ImportDebug_h___</span>
<a href="#l44.9"></a><span id="l44.9"> #define ImportDebug_h___</span>
<a href="#l44.10"></a><span id="l44.10"> </span>
<a href="#l44.11"></a><span id="l44.11"> #ifdef NS_DEBUG</span>
<a href="#l44.12"></a><span id="l44.12" class="difflineminus">-#define IMPORT_DEBUG  1</span>
<a href="#l44.13"></a><span id="l44.13" class="difflineplus">+#  define IMPORT_DEBUG 1</span>
<a href="#l44.14"></a><span id="l44.14"> #endif</span>
<a href="#l44.15"></a><span id="l44.15"> </span>
<a href="#l44.16"></a><span id="l44.16"> #include &quot;mozilla/Logging.h&quot;</span>
<a href="#l44.17"></a><span id="l44.17" class="difflineminus">-extern mozilla::LazyLogModule IMPORTLOGMODULE;  // defined in nsImportService.cpp</span>
<a href="#l44.18"></a><span id="l44.18" class="difflineplus">+extern mozilla::LazyLogModule</span>
<a href="#l44.19"></a><span id="l44.19" class="difflineplus">+    IMPORTLOGMODULE;  // defined in nsImportService.cpp</span>
<a href="#l44.20"></a><span id="l44.20"> </span>
<a href="#l44.21"></a><span id="l44.21" class="difflineminus">-#define IMPORT_LOG0(x)          MOZ_LOG(IMPORTLOGMODULE, mozilla::LogLevel::Debug, (x))</span>
<a href="#l44.22"></a><span id="l44.22" class="difflineminus">-#define IMPORT_LOG1(x, y)       MOZ_LOG(IMPORTLOGMODULE, mozilla::LogLevel::Debug, (x, y))</span>
<a href="#l44.23"></a><span id="l44.23" class="difflineminus">-#define IMPORT_LOG2(x, y, z)    MOZ_LOG(IMPORTLOGMODULE, mozilla::LogLevel::Debug, (x, y, z))</span>
<a href="#l44.24"></a><span id="l44.24" class="difflineminus">-#define IMPORT_LOG3(a, b, c, d) MOZ_LOG(IMPORTLOGMODULE, mozilla::LogLevel::Debug, (a, b, c, d))</span>
<a href="#l44.25"></a><span id="l44.25" class="difflineplus">+#define IMPORT_LOG0(x) MOZ_LOG(IMPORTLOGMODULE, mozilla::LogLevel::Debug, (x))</span>
<a href="#l44.26"></a><span id="l44.26" class="difflineplus">+#define IMPORT_LOG1(x, y) \</span>
<a href="#l44.27"></a><span id="l44.27" class="difflineplus">+  MOZ_LOG(IMPORTLOGMODULE, mozilla::LogLevel::Debug, (x, y))</span>
<a href="#l44.28"></a><span id="l44.28" class="difflineplus">+#define IMPORT_LOG2(x, y, z) \</span>
<a href="#l44.29"></a><span id="l44.29" class="difflineplus">+  MOZ_LOG(IMPORTLOGMODULE, mozilla::LogLevel::Debug, (x, y, z))</span>
<a href="#l44.30"></a><span id="l44.30" class="difflineplus">+#define IMPORT_LOG3(a, b, c, d) \</span>
<a href="#l44.31"></a><span id="l44.31" class="difflineplus">+  MOZ_LOG(IMPORTLOGMODULE, mozilla::LogLevel::Debug, (a, b, c, d))</span>
<a href="#l44.32"></a><span id="l44.32"> </span>
<a href="#l44.33"></a><span id="l44.33"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1" class="difflineminus">--- a/mailnews/import/src/ImportOutFile.cpp</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineplus">+++ b/mailnews/import/src/ImportOutFile.cpp</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineat">@@ -19,281 +19,239 @@</span>
<a href="#l45.4"></a><span id="l45.4"> #define  kMacNoCreator    '????'</span>
<a href="#l45.5"></a><span id="l45.5"> #define kMacTextFile    'TEXT'</span>
<a href="#l45.6"></a><span id="l45.6"> #else</span>
<a href="#l45.7"></a><span id="l45.7"> #define  kMacNoCreator    0</span>
<a href="#l45.8"></a><span id="l45.8"> #define kMacTextFile    0</span>
<a href="#l45.9"></a><span id="l45.9"> #endif</span>
<a href="#l45.10"></a><span id="l45.10"> */</span>
<a href="#l45.11"></a><span id="l45.11"> </span>
<a href="#l45.12"></a><span id="l45.12" class="difflineminus">-ImportOutFile::ImportOutFile()</span>
<a href="#l45.13"></a><span id="l45.13" class="difflineminus">-{</span>
<a href="#l45.14"></a><span id="l45.14" class="difflineplus">+ImportOutFile::ImportOutFile() {</span>
<a href="#l45.15"></a><span id="l45.15">   m_ownsFileAndBuffer = false;</span>
<a href="#l45.16"></a><span id="l45.16">   m_pos = 0;</span>
<a href="#l45.17"></a><span id="l45.17">   m_pBuf = nullptr;</span>
<a href="#l45.18"></a><span id="l45.18">   m_bufSz = 0;</span>
<a href="#l45.19"></a><span id="l45.19">   m_pTrans = nullptr;</span>
<a href="#l45.20"></a><span id="l45.20">   m_pTransOut = nullptr;</span>
<a href="#l45.21"></a><span id="l45.21">   m_pTransBuf = nullptr;</span>
<a href="#l45.22"></a><span id="l45.22"> }</span>
<a href="#l45.23"></a><span id="l45.23"> </span>
<a href="#l45.24"></a><span id="l45.24" class="difflineminus">-ImportOutFile::ImportOutFile(nsIFile *pFile, uint8_t * pBuf, uint32_t sz)</span>
<a href="#l45.25"></a><span id="l45.25" class="difflineminus">-{</span>
<a href="#l45.26"></a><span id="l45.26" class="difflineplus">+ImportOutFile::ImportOutFile(nsIFile *pFile, uint8_t *pBuf, uint32_t sz) {</span>
<a href="#l45.27"></a><span id="l45.27">   m_pTransBuf = nullptr;</span>
<a href="#l45.28"></a><span id="l45.28">   m_pTransOut = nullptr;</span>
<a href="#l45.29"></a><span id="l45.29">   m_pTrans = nullptr;</span>
<a href="#l45.30"></a><span id="l45.30">   m_ownsFileAndBuffer = false;</span>
<a href="#l45.31"></a><span id="l45.31">   InitOutFile(pFile, pBuf, sz);</span>
<a href="#l45.32"></a><span id="l45.32"> }</span>
<a href="#l45.33"></a><span id="l45.33"> </span>
<a href="#l45.34"></a><span id="l45.34" class="difflineminus">-ImportOutFile::~ImportOutFile()</span>
<a href="#l45.35"></a><span id="l45.35" class="difflineminus">-{</span>
<a href="#l45.36"></a><span id="l45.36" class="difflineminus">-  if (m_ownsFileAndBuffer)</span>
<a href="#l45.37"></a><span id="l45.37" class="difflineminus">-  {</span>
<a href="#l45.38"></a><span id="l45.38" class="difflineplus">+ImportOutFile::~ImportOutFile() {</span>
<a href="#l45.39"></a><span id="l45.39" class="difflineplus">+  if (m_ownsFileAndBuffer) {</span>
<a href="#l45.40"></a><span id="l45.40">     Flush();</span>
<a href="#l45.41"></a><span id="l45.41" class="difflineminus">-    delete [] m_pBuf;</span>
<a href="#l45.42"></a><span id="l45.42" class="difflineplus">+    delete[] m_pBuf;</span>
<a href="#l45.43"></a><span id="l45.43">   }</span>
<a href="#l45.44"></a><span id="l45.44"> </span>
<a href="#l45.45"></a><span id="l45.45">   delete m_pTrans;</span>
<a href="#l45.46"></a><span id="l45.46">   delete m_pTransOut;</span>
<a href="#l45.47"></a><span id="l45.47" class="difflineminus">-  delete [] m_pTransBuf;</span>
<a href="#l45.48"></a><span id="l45.48" class="difflineplus">+  delete[] m_pTransBuf;</span>
<a href="#l45.49"></a><span id="l45.49"> }</span>
<a href="#l45.50"></a><span id="l45.50"> </span>
<a href="#l45.51"></a><span id="l45.51" class="difflineminus">-bool ImportOutFile::Set8bitTranslator(nsImportTranslator *pTrans)</span>
<a href="#l45.52"></a><span id="l45.52" class="difflineminus">-{</span>
<a href="#l45.53"></a><span id="l45.53" class="difflineminus">-  if (!Flush())</span>
<a href="#l45.54"></a><span id="l45.54" class="difflineminus">-    return false;</span>
<a href="#l45.55"></a><span id="l45.55" class="difflineplus">+bool ImportOutFile::Set8bitTranslator(nsImportTranslator *pTrans) {</span>
<a href="#l45.56"></a><span id="l45.56" class="difflineplus">+  if (!Flush()) return false;</span>
<a href="#l45.57"></a><span id="l45.57"> </span>
<a href="#l45.58"></a><span id="l45.58">   m_engaged = false;</span>
<a href="#l45.59"></a><span id="l45.59">   m_pTrans = pTrans;</span>
<a href="#l45.60"></a><span id="l45.60">   m_supports8to7 = pTrans-&gt;Supports8bitEncoding();</span>
<a href="#l45.61"></a><span id="l45.61"> </span>
<a href="#l45.62"></a><span id="l45.62" class="difflineminus">-</span>
<a href="#l45.63"></a><span id="l45.63">   return true;</span>
<a href="#l45.64"></a><span id="l45.64"> }</span>
<a href="#l45.65"></a><span id="l45.65"> </span>
<a href="#l45.66"></a><span id="l45.66" class="difflineminus">-bool ImportOutFile::End8bitTranslation(bool *pEngaged, nsCString&amp; useCharset, nsCString&amp; encoding)</span>
<a href="#l45.67"></a><span id="l45.67" class="difflineminus">-{</span>
<a href="#l45.68"></a><span id="l45.68" class="difflineminus">-  if (!m_pTrans)</span>
<a href="#l45.69"></a><span id="l45.69" class="difflineminus">-    return false;</span>
<a href="#l45.70"></a><span id="l45.70" class="difflineminus">-</span>
<a href="#l45.71"></a><span id="l45.71" class="difflineplus">+bool ImportOutFile::End8bitTranslation(bool *pEngaged, nsCString &amp;useCharset,</span>
<a href="#l45.72"></a><span id="l45.72" class="difflineplus">+                                       nsCString &amp;encoding) {</span>
<a href="#l45.73"></a><span id="l45.73" class="difflineplus">+  if (!m_pTrans) return false;</span>
<a href="#l45.74"></a><span id="l45.74"> </span>
<a href="#l45.75"></a><span id="l45.75">   bool bResult = Flush();</span>
<a href="#l45.76"></a><span id="l45.76">   if (m_supports8to7 &amp;&amp; m_pTransOut) {</span>
<a href="#l45.77"></a><span id="l45.77" class="difflineminus">-    if (bResult)</span>
<a href="#l45.78"></a><span id="l45.78" class="difflineminus">-      bResult = m_pTrans-&gt;FinishConvertToFile(m_pTransOut);</span>
<a href="#l45.79"></a><span id="l45.79" class="difflineminus">-    if (bResult)</span>
<a href="#l45.80"></a><span id="l45.80" class="difflineminus">-      bResult = Flush();</span>
<a href="#l45.81"></a><span id="l45.81" class="difflineplus">+    if (bResult) bResult = m_pTrans-&gt;FinishConvertToFile(m_pTransOut);</span>
<a href="#l45.82"></a><span id="l45.82" class="difflineplus">+    if (bResult) bResult = Flush();</span>
<a href="#l45.83"></a><span id="l45.83">   }</span>
<a href="#l45.84"></a><span id="l45.84"> </span>
<a href="#l45.85"></a><span id="l45.85">   if (m_supports8to7) {</span>
<a href="#l45.86"></a><span id="l45.86">     m_pTrans-&gt;GetCharset(useCharset);</span>
<a href="#l45.87"></a><span id="l45.87">     m_pTrans-&gt;GetEncoding(encoding);</span>
<a href="#l45.88"></a><span id="l45.88" class="difflineminus">-  }</span>
<a href="#l45.89"></a><span id="l45.89" class="difflineminus">-  else</span>
<a href="#l45.90"></a><span id="l45.90" class="difflineplus">+  } else</span>
<a href="#l45.91"></a><span id="l45.91">     useCharset.Truncate();</span>
<a href="#l45.92"></a><span id="l45.92">   *pEngaged = m_engaged;</span>
<a href="#l45.93"></a><span id="l45.93">   delete m_pTrans;</span>
<a href="#l45.94"></a><span id="l45.94">   m_pTrans = nullptr;</span>
<a href="#l45.95"></a><span id="l45.95">   delete m_pTransOut;</span>
<a href="#l45.96"></a><span id="l45.96">   m_pTransOut = nullptr;</span>
<a href="#l45.97"></a><span id="l45.97" class="difflineminus">-  delete [] m_pTransBuf;</span>
<a href="#l45.98"></a><span id="l45.98" class="difflineplus">+  delete[] m_pTransBuf;</span>
<a href="#l45.99"></a><span id="l45.99">   m_pTransBuf = nullptr;</span>
<a href="#l45.100"></a><span id="l45.100"> </span>
<a href="#l45.101"></a><span id="l45.101">   return bResult;</span>
<a href="#l45.102"></a><span id="l45.102"> }</span>
<a href="#l45.103"></a><span id="l45.103"> </span>
<a href="#l45.104"></a><span id="l45.104" class="difflineminus">-bool ImportOutFile::InitOutFile(nsIFile *pFile, uint32_t bufSz)</span>
<a href="#l45.105"></a><span id="l45.105" class="difflineminus">-{</span>
<a href="#l45.106"></a><span id="l45.106" class="difflineminus">-  if (!bufSz)</span>
<a href="#l45.107"></a><span id="l45.107" class="difflineminus">-    bufSz = 32 * 1024;</span>
<a href="#l45.108"></a><span id="l45.108" class="difflineminus">-  if (!m_pBuf)</span>
<a href="#l45.109"></a><span id="l45.109" class="difflineminus">-    m_pBuf = new uint8_t[ bufSz];</span>
<a href="#l45.110"></a><span id="l45.110" class="difflineplus">+bool ImportOutFile::InitOutFile(nsIFile *pFile, uint32_t bufSz) {</span>
<a href="#l45.111"></a><span id="l45.111" class="difflineplus">+  if (!bufSz) bufSz = 32 * 1024;</span>
<a href="#l45.112"></a><span id="l45.112" class="difflineplus">+  if (!m_pBuf) m_pBuf = new uint8_t[bufSz];</span>
<a href="#l45.113"></a><span id="l45.113"> </span>
<a href="#l45.114"></a><span id="l45.114" class="difflineminus">-  if (!m_outputStream)</span>
<a href="#l45.115"></a><span id="l45.115" class="difflineminus">-  {</span>
<a href="#l45.116"></a><span id="l45.116" class="difflineplus">+  if (!m_outputStream) {</span>
<a href="#l45.117"></a><span id="l45.117">     nsresult rv;</span>
<a href="#l45.118"></a><span id="l45.118" class="difflineminus">-    rv = MsgNewBufferedFileOutputStream(getter_AddRefs(m_outputStream),</span>
<a href="#l45.119"></a><span id="l45.119" class="difflineminus">-                                        pFile,</span>
<a href="#l45.120"></a><span id="l45.120" class="difflineminus">-                                        PR_CREATE_FILE | PR_WRONLY | PR_TRUNCATE,</span>
<a href="#l45.121"></a><span id="l45.121" class="difflineminus">-                                        0644);</span>
<a href="#l45.122"></a><span id="l45.122" class="difflineplus">+    rv = MsgNewBufferedFileOutputStream(</span>
<a href="#l45.123"></a><span id="l45.123" class="difflineplus">+        getter_AddRefs(m_outputStream), pFile,</span>
<a href="#l45.124"></a><span id="l45.124" class="difflineplus">+        PR_CREATE_FILE | PR_WRONLY | PR_TRUNCATE, 0644);</span>
<a href="#l45.125"></a><span id="l45.125"> </span>
<a href="#l45.126"></a><span id="l45.126" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l45.127"></a><span id="l45.127" class="difflineminus">-    {</span>
<a href="#l45.128"></a><span id="l45.128" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l45.129"></a><span id="l45.129">       IMPORT_LOG0(&quot;Couldn't create outfile\n&quot;);</span>
<a href="#l45.130"></a><span id="l45.130" class="difflineminus">-      delete [] m_pBuf;</span>
<a href="#l45.131"></a><span id="l45.131" class="difflineplus">+      delete[] m_pBuf;</span>
<a href="#l45.132"></a><span id="l45.132">       m_pBuf = nullptr;</span>
<a href="#l45.133"></a><span id="l45.133">       return false;</span>
<a href="#l45.134"></a><span id="l45.134">     }</span>
<a href="#l45.135"></a><span id="l45.135">   }</span>
<a href="#l45.136"></a><span id="l45.136">   m_pFile = pFile;</span>
<a href="#l45.137"></a><span id="l45.137">   m_ownsFileAndBuffer = true;</span>
<a href="#l45.138"></a><span id="l45.138">   m_pos = 0;</span>
<a href="#l45.139"></a><span id="l45.139">   m_bufSz = bufSz;</span>
<a href="#l45.140"></a><span id="l45.140">   return true;</span>
<a href="#l45.141"></a><span id="l45.141"> }</span>
<a href="#l45.142"></a><span id="l45.142"> </span>
<a href="#l45.143"></a><span id="l45.143" class="difflineminus">-void ImportOutFile::InitOutFile(nsIFile *pFile, uint8_t * pBuf, uint32_t sz)</span>
<a href="#l45.144"></a><span id="l45.144" class="difflineminus">-{</span>
<a href="#l45.145"></a><span id="l45.145" class="difflineplus">+void ImportOutFile::InitOutFile(nsIFile *pFile, uint8_t *pBuf, uint32_t sz) {</span>
<a href="#l45.146"></a><span id="l45.146">   m_ownsFileAndBuffer = false;</span>
<a href="#l45.147"></a><span id="l45.147">   m_pFile = pFile;</span>
<a href="#l45.148"></a><span id="l45.148">   m_pBuf = pBuf;</span>
<a href="#l45.149"></a><span id="l45.149">   m_bufSz = sz;</span>
<a href="#l45.150"></a><span id="l45.150">   m_pos = 0;</span>
<a href="#l45.151"></a><span id="l45.151"> }</span>
<a href="#l45.152"></a><span id="l45.152"> </span>
<a href="#l45.153"></a><span id="l45.153" class="difflineminus">-</span>
<a href="#l45.154"></a><span id="l45.154" class="difflineplus">+bool ImportOutFile::Flush(void) {</span>
<a href="#l45.155"></a><span id="l45.155" class="difflineplus">+  if (!m_pos) return true;</span>
<a href="#l45.156"></a><span id="l45.156"> </span>
<a href="#l45.157"></a><span id="l45.157" class="difflineminus">-bool ImportOutFile::Flush(void)</span>
<a href="#l45.158"></a><span id="l45.158" class="difflineminus">-{</span>
<a href="#l45.159"></a><span id="l45.159" class="difflineminus">-  if (!m_pos)</span>
<a href="#l45.160"></a><span id="l45.160" class="difflineminus">-    return true;</span>
<a href="#l45.161"></a><span id="l45.161" class="difflineminus">-</span>
<a href="#l45.162"></a><span id="l45.162" class="difflineminus">-  uint32_t  transLen;</span>
<a href="#l45.163"></a><span id="l45.163" class="difflineminus">-  bool      duddleyDoWrite = false;</span>
<a href="#l45.164"></a><span id="l45.164" class="difflineplus">+  uint32_t transLen;</span>
<a href="#l45.165"></a><span id="l45.165" class="difflineplus">+  bool duddleyDoWrite = false;</span>
<a href="#l45.166"></a><span id="l45.166"> </span>
<a href="#l45.167"></a><span id="l45.167">   // handle translations if appropriate</span>
<a href="#l45.168"></a><span id="l45.168">   if (m_pTrans) {</span>
<a href="#l45.169"></a><span id="l45.169">     if (m_engaged &amp;&amp; m_supports8to7) {</span>
<a href="#l45.170"></a><span id="l45.170">       // Markers can get confused by this crap!!!</span>
<a href="#l45.171"></a><span id="l45.171">       // TLR: FIXME: Need to update the markers based on</span>
<a href="#l45.172"></a><span id="l45.172">       // the difference between the translated len and untranslated len</span>
<a href="#l45.173"></a><span id="l45.173"> </span>
<a href="#l45.174"></a><span id="l45.174" class="difflineminus">-      if (!m_pTrans-&gt;ConvertToFile( m_pBuf, m_pos, m_pTransOut, &amp;transLen))</span>
<a href="#l45.175"></a><span id="l45.175" class="difflineplus">+      if (!m_pTrans-&gt;ConvertToFile(m_pBuf, m_pos, m_pTransOut, &amp;transLen))</span>
<a href="#l45.176"></a><span id="l45.176">         return false;</span>
<a href="#l45.177"></a><span id="l45.177" class="difflineminus">-      if (!m_pTransOut-&gt;Flush())</span>
<a href="#l45.178"></a><span id="l45.178" class="difflineminus">-        return false;</span>
<a href="#l45.179"></a><span id="l45.179" class="difflineplus">+      if (!m_pTransOut-&gt;Flush()) return false;</span>
<a href="#l45.180"></a><span id="l45.180">       // now update our buffer...</span>
<a href="#l45.181"></a><span id="l45.181">       if (transLen &lt; m_pos) {</span>
<a href="#l45.182"></a><span id="l45.182">         memcpy(m_pBuf, m_pBuf + transLen, m_pos - transLen);</span>
<a href="#l45.183"></a><span id="l45.183">       }</span>
<a href="#l45.184"></a><span id="l45.184">       m_pos -= transLen;</span>
<a href="#l45.185"></a><span id="l45.185" class="difflineminus">-    }</span>
<a href="#l45.186"></a><span id="l45.186" class="difflineminus">-    else if (m_engaged) {</span>
<a href="#l45.187"></a><span id="l45.187" class="difflineplus">+    } else if (m_engaged) {</span>
<a href="#l45.188"></a><span id="l45.188">       // does not actually support translation!</span>
<a href="#l45.189"></a><span id="l45.189">       duddleyDoWrite = true;</span>
<a href="#l45.190"></a><span id="l45.190" class="difflineminus">-    }</span>
<a href="#l45.191"></a><span id="l45.191" class="difflineminus">-    else {</span>
<a href="#l45.192"></a><span id="l45.192" class="difflineplus">+    } else {</span>
<a href="#l45.193"></a><span id="l45.193">       // should we engage?</span>
<a href="#l45.194"></a><span id="l45.194" class="difflineminus">-      uint8_t *  pChar = m_pBuf;</span>
<a href="#l45.195"></a><span id="l45.195" class="difflineminus">-      uint32_t  len = m_pos;</span>
<a href="#l45.196"></a><span id="l45.196" class="difflineplus">+      uint8_t *pChar = m_pBuf;</span>
<a href="#l45.197"></a><span id="l45.197" class="difflineplus">+      uint32_t len = m_pos;</span>
<a href="#l45.198"></a><span id="l45.198">       while (len) {</span>
<a href="#l45.199"></a><span id="l45.199" class="difflineminus">-        if (!ImportCharSet::IsUSAscii(*pChar))</span>
<a href="#l45.200"></a><span id="l45.200" class="difflineminus">-          break;</span>
<a href="#l45.201"></a><span id="l45.201" class="difflineplus">+        if (!ImportCharSet::IsUSAscii(*pChar)) break;</span>
<a href="#l45.202"></a><span id="l45.202">         pChar++;</span>
<a href="#l45.203"></a><span id="l45.203">         len--;</span>
<a href="#l45.204"></a><span id="l45.204">       }</span>
<a href="#l45.205"></a><span id="l45.205">       if (len) {</span>
<a href="#l45.206"></a><span id="l45.206">         m_engaged = true;</span>
<a href="#l45.207"></a><span id="l45.207">         if (m_supports8to7) {</span>
<a href="#l45.208"></a><span id="l45.208">           // allocate our translation output buffer and file...</span>
<a href="#l45.209"></a><span id="l45.209">           m_pTransBuf = new uint8_t[m_bufSz];</span>
<a href="#l45.210"></a><span id="l45.210">           m_pTransOut = new ImportOutFile(m_pFile, m_pTransBuf, m_bufSz);</span>
<a href="#l45.211"></a><span id="l45.211">           return Flush();</span>
<a href="#l45.212"></a><span id="l45.212" class="difflineminus">-        }</span>
<a href="#l45.213"></a><span id="l45.213" class="difflineminus">-        else</span>
<a href="#l45.214"></a><span id="l45.214" class="difflineplus">+        } else</span>
<a href="#l45.215"></a><span id="l45.215">           duddleyDoWrite = true;</span>
<a href="#l45.216"></a><span id="l45.216" class="difflineminus">-      }</span>
<a href="#l45.217"></a><span id="l45.217" class="difflineminus">-      else {</span>
<a href="#l45.218"></a><span id="l45.218" class="difflineplus">+      } else {</span>
<a href="#l45.219"></a><span id="l45.219">         duddleyDoWrite = true;</span>
<a href="#l45.220"></a><span id="l45.220">       }</span>
<a href="#l45.221"></a><span id="l45.221">     }</span>
<a href="#l45.222"></a><span id="l45.222" class="difflineminus">-  }</span>
<a href="#l45.223"></a><span id="l45.223" class="difflineminus">-  else</span>
<a href="#l45.224"></a><span id="l45.224" class="difflineplus">+  } else</span>
<a href="#l45.225"></a><span id="l45.225">     duddleyDoWrite = true;</span>
<a href="#l45.226"></a><span id="l45.226"> </span>
<a href="#l45.227"></a><span id="l45.227">   if (duddleyDoWrite) {</span>
<a href="#l45.228"></a><span id="l45.228">     uint32_t written = 0;</span>
<a href="#l45.229"></a><span id="l45.229" class="difflineminus">-    nsresult rv = m_outputStream-&gt;Write((const char *)m_pBuf, (int32_t)m_pos, &amp;written);</span>
<a href="#l45.230"></a><span id="l45.230" class="difflineminus">-    if (NS_FAILED(rv) || ((uint32_t)written != m_pos))</span>
<a href="#l45.231"></a><span id="l45.231" class="difflineminus">-      return false;</span>
<a href="#l45.232"></a><span id="l45.232" class="difflineplus">+    nsresult rv =</span>
<a href="#l45.233"></a><span id="l45.233" class="difflineplus">+        m_outputStream-&gt;Write((const char *)m_pBuf, (int32_t)m_pos, &amp;written);</span>
<a href="#l45.234"></a><span id="l45.234" class="difflineplus">+    if (NS_FAILED(rv) || ((uint32_t)written != m_pos)) return false;</span>
<a href="#l45.235"></a><span id="l45.235">     m_pos = 0;</span>
<a href="#l45.236"></a><span id="l45.236">   }</span>
<a href="#l45.237"></a><span id="l45.237"> </span>
<a href="#l45.238"></a><span id="l45.238">   return true;</span>
<a href="#l45.239"></a><span id="l45.239"> }</span>
<a href="#l45.240"></a><span id="l45.240"> </span>
<a href="#l45.241"></a><span id="l45.241" class="difflineminus">-bool ImportOutFile::WriteU8NullTerm(const uint8_t * pSrc, bool includeNull)</span>
<a href="#l45.242"></a><span id="l45.242" class="difflineminus">-{</span>
<a href="#l45.243"></a><span id="l45.243" class="difflineplus">+bool ImportOutFile::WriteU8NullTerm(const uint8_t *pSrc, bool includeNull) {</span>
<a href="#l45.244"></a><span id="l45.244">   while (*pSrc) {</span>
<a href="#l45.245"></a><span id="l45.245">     if (m_pos &gt;= m_bufSz) {</span>
<a href="#l45.246"></a><span id="l45.246" class="difflineminus">-      if (!Flush())</span>
<a href="#l45.247"></a><span id="l45.247" class="difflineminus">-        return false;</span>
<a href="#l45.248"></a><span id="l45.248" class="difflineplus">+      if (!Flush()) return false;</span>
<a href="#l45.249"></a><span id="l45.249">     }</span>
<a href="#l45.250"></a><span id="l45.250">     *(m_pBuf + m_pos) = *pSrc;</span>
<a href="#l45.251"></a><span id="l45.251">     m_pos++;</span>
<a href="#l45.252"></a><span id="l45.252">     pSrc++;</span>
<a href="#l45.253"></a><span id="l45.253">   }</span>
<a href="#l45.254"></a><span id="l45.254">   if (includeNull) {</span>
<a href="#l45.255"></a><span id="l45.255">     if (m_pos &gt;= m_bufSz) {</span>
<a href="#l45.256"></a><span id="l45.256" class="difflineminus">-      if (!Flush())</span>
<a href="#l45.257"></a><span id="l45.257" class="difflineminus">-        return false;</span>
<a href="#l45.258"></a><span id="l45.258" class="difflineplus">+      if (!Flush()) return false;</span>
<a href="#l45.259"></a><span id="l45.259">     }</span>
<a href="#l45.260"></a><span id="l45.260">     *(m_pBuf + m_pos) = 0;</span>
<a href="#l45.261"></a><span id="l45.261">     m_pos++;</span>
<a href="#l45.262"></a><span id="l45.262">   }</span>
<a href="#l45.263"></a><span id="l45.263"> </span>
<a href="#l45.264"></a><span id="l45.264">   return true;</span>
<a href="#l45.265"></a><span id="l45.265"> }</span>
<a href="#l45.266"></a><span id="l45.266"> </span>
<a href="#l45.267"></a><span id="l45.267" class="difflineminus">-bool ImportOutFile::SetMarker(int markerID)</span>
<a href="#l45.268"></a><span id="l45.268" class="difflineminus">-{</span>
<a href="#l45.269"></a><span id="l45.269" class="difflineplus">+bool ImportOutFile::SetMarker(int markerID) {</span>
<a href="#l45.270"></a><span id="l45.270">   if (!Flush()) {</span>
<a href="#l45.271"></a><span id="l45.271">     return false;</span>
<a href="#l45.272"></a><span id="l45.272">   }</span>
<a href="#l45.273"></a><span id="l45.273"> </span>
<a href="#l45.274"></a><span id="l45.274">   if (markerID &lt; kMaxMarkers) {</span>
<a href="#l45.275"></a><span id="l45.275">     int64_t pos = 0;</span>
<a href="#l45.276"></a><span id="l45.276" class="difflineminus">-    if (m_outputStream)</span>
<a href="#l45.277"></a><span id="l45.277" class="difflineminus">-                {</span>
<a href="#l45.278"></a><span id="l45.278" class="difflineminus">-                  // do we need to flush for the seek to give us the right pos?</span>
<a href="#l45.279"></a><span id="l45.279" class="difflineminus">-                  m_outputStream-&gt;Flush();</span>
<a href="#l45.280"></a><span id="l45.280" class="difflineminus">-                  nsresult rv;</span>
<a href="#l45.281"></a><span id="l45.281" class="difflineminus">-                  nsCOMPtr &lt;nsISeekableStream&gt; seekStream = do_QueryInterface(m_outputStream, &amp;rv);</span>
<a href="#l45.282"></a><span id="l45.282" class="difflineminus">-                  NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l45.283"></a><span id="l45.283" class="difflineplus">+    if (m_outputStream) {</span>
<a href="#l45.284"></a><span id="l45.284" class="difflineplus">+      // do we need to flush for the seek to give us the right pos?</span>
<a href="#l45.285"></a><span id="l45.285" class="difflineplus">+      m_outputStream-&gt;Flush();</span>
<a href="#l45.286"></a><span id="l45.286" class="difflineplus">+      nsresult rv;</span>
<a href="#l45.287"></a><span id="l45.287" class="difflineplus">+      nsCOMPtr&lt;nsISeekableStream&gt; seekStream =</span>
<a href="#l45.288"></a><span id="l45.288" class="difflineplus">+          do_QueryInterface(m_outputStream, &amp;rv);</span>
<a href="#l45.289"></a><span id="l45.289" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l45.290"></a><span id="l45.290">       rv = seekStream-&gt;Tell(&amp;pos);</span>
<a href="#l45.291"></a><span id="l45.291">       if (NS_FAILED(rv)) {</span>
<a href="#l45.292"></a><span id="l45.292">         IMPORT_LOG0(&quot;*** Error, Tell failed on output stream\n&quot;);</span>
<a href="#l45.293"></a><span id="l45.293">         return false;</span>
<a href="#l45.294"></a><span id="l45.294">       }</span>
<a href="#l45.295"></a><span id="l45.295">     }</span>
<a href="#l45.296"></a><span id="l45.296">     m_markers[markerID] = (uint32_t)pos + m_pos;</span>
<a href="#l45.297"></a><span id="l45.297">   }</span>
<a href="#l45.298"></a><span id="l45.298"> </span>
<a href="#l45.299"></a><span id="l45.299">   return true;</span>
<a href="#l45.300"></a><span id="l45.300"> }</span>
<a href="#l45.301"></a><span id="l45.301"> </span>
<a href="#l45.302"></a><span id="l45.302" class="difflineminus">-void ImportOutFile::ClearMarker(int markerID)</span>
<a href="#l45.303"></a><span id="l45.303" class="difflineminus">-{</span>
<a href="#l45.304"></a><span id="l45.304" class="difflineminus">-  if (markerID &lt; kMaxMarkers)</span>
<a href="#l45.305"></a><span id="l45.305" class="difflineminus">-    m_markers[markerID] = 0;</span>
<a href="#l45.306"></a><span id="l45.306" class="difflineplus">+void ImportOutFile::ClearMarker(int markerID) {</span>
<a href="#l45.307"></a><span id="l45.307" class="difflineplus">+  if (markerID &lt; kMaxMarkers) m_markers[markerID] = 0;</span>
<a href="#l45.308"></a><span id="l45.308"> }</span>
<a href="#l45.309"></a><span id="l45.309"> </span>
<a href="#l45.310"></a><span id="l45.310" class="difflineminus">-bool ImportOutFile::WriteStrAtMarker(int markerID, const char *pStr)</span>
<a href="#l45.311"></a><span id="l45.311" class="difflineminus">-{</span>
<a href="#l45.312"></a><span id="l45.312" class="difflineminus">-  if (markerID &gt;= kMaxMarkers)</span>
<a href="#l45.313"></a><span id="l45.313" class="difflineminus">-    return false;</span>
<a href="#l45.314"></a><span id="l45.314" class="difflineplus">+bool ImportOutFile::WriteStrAtMarker(int markerID, const char *pStr) {</span>
<a href="#l45.315"></a><span id="l45.315" class="difflineplus">+  if (markerID &gt;= kMaxMarkers) return false;</span>
<a href="#l45.316"></a><span id="l45.316"> </span>
<a href="#l45.317"></a><span id="l45.317" class="difflineminus">-  if (!Flush())</span>
<a href="#l45.318"></a><span id="l45.318" class="difflineminus">-    return false;</span>
<a href="#l45.319"></a><span id="l45.319" class="difflineminus">-  int64_t    pos;</span>
<a href="#l45.320"></a><span id="l45.320" class="difflineminus">-        m_outputStream-&gt;Flush();</span>
<a href="#l45.321"></a><span id="l45.321" class="difflineminus">-        nsresult rv;</span>
<a href="#l45.322"></a><span id="l45.322" class="difflineminus">-        nsCOMPtr &lt;nsISeekableStream&gt; seekStream = do_QueryInterface(m_outputStream, &amp;rv);</span>
<a href="#l45.323"></a><span id="l45.323" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l45.324"></a><span id="l45.324" class="difflineplus">+  if (!Flush()) return false;</span>
<a href="#l45.325"></a><span id="l45.325" class="difflineplus">+  int64_t pos;</span>
<a href="#l45.326"></a><span id="l45.326" class="difflineplus">+  m_outputStream-&gt;Flush();</span>
<a href="#l45.327"></a><span id="l45.327" class="difflineplus">+  nsresult rv;</span>
<a href="#l45.328"></a><span id="l45.328" class="difflineplus">+  nsCOMPtr&lt;nsISeekableStream&gt; seekStream =</span>
<a href="#l45.329"></a><span id="l45.329" class="difflineplus">+      do_QueryInterface(m_outputStream, &amp;rv);</span>
<a href="#l45.330"></a><span id="l45.330" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l45.331"></a><span id="l45.331">   rv = seekStream-&gt;Tell(&amp;pos);</span>
<a href="#l45.332"></a><span id="l45.332" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l45.333"></a><span id="l45.333" class="difflineminus">-    return false;</span>
<a href="#l45.334"></a><span id="l45.334" class="difflineminus">-  rv = seekStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, (int32_t) m_markers[markerID]);</span>
<a href="#l45.335"></a><span id="l45.335" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l45.336"></a><span id="l45.336" class="difflineminus">-    return false;</span>
<a href="#l45.337"></a><span id="l45.337" class="difflineplus">+  if (NS_FAILED(rv)) return false;</span>
<a href="#l45.338"></a><span id="l45.338" class="difflineplus">+  rv = seekStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET,</span>
<a href="#l45.339"></a><span id="l45.339" class="difflineplus">+                        (int32_t)m_markers[markerID]);</span>
<a href="#l45.340"></a><span id="l45.340" class="difflineplus">+  if (NS_FAILED(rv)) return false;</span>
<a href="#l45.341"></a><span id="l45.341">   uint32_t written;</span>
<a href="#l45.342"></a><span id="l45.342">   rv = m_outputStream-&gt;Write(pStr, strlen(pStr), &amp;written);</span>
<a href="#l45.343"></a><span id="l45.343" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l45.344"></a><span id="l45.344" class="difflineminus">-    return false;</span>
<a href="#l45.345"></a><span id="l45.345" class="difflineplus">+  if (NS_FAILED(rv)) return false;</span>
<a href="#l45.346"></a><span id="l45.346"> </span>
<a href="#l45.347"></a><span id="l45.347">   rv = seekStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, pos);</span>
<a href="#l45.348"></a><span id="l45.348" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l45.349"></a><span id="l45.349" class="difflineminus">-    return false;</span>
<a href="#l45.350"></a><span id="l45.350" class="difflineplus">+  if (NS_FAILED(rv)) return false;</span>
<a href="#l45.351"></a><span id="l45.351"> </span>
<a href="#l45.352"></a><span id="l45.352">   return true;</span>
<a href="#l45.353"></a><span id="l45.353"> }</span>
<a href="#l45.354"></a><span id="l45.354" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1" class="difflineminus">--- a/mailnews/import/src/ImportOutFile.h</span>
<a href="#l46.2"></a><span id="l46.2" class="difflineplus">+++ b/mailnews/import/src/ImportOutFile.h</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineat">@@ -5,91 +5,90 @@</span>
<a href="#l46.4"></a><span id="l46.4"> </span>
<a href="#l46.5"></a><span id="l46.5"> #ifndef ImportOutFile_h___</span>
<a href="#l46.6"></a><span id="l46.6"> #define ImportOutFile_h___</span>
<a href="#l46.7"></a><span id="l46.7"> </span>
<a href="#l46.8"></a><span id="l46.8"> #include &quot;nsImportTranslator.h&quot;</span>
<a href="#l46.9"></a><span id="l46.9"> #include &quot;nsIOutputStream.h&quot;</span>
<a href="#l46.10"></a><span id="l46.10"> #include &quot;nsIFile.h&quot;</span>
<a href="#l46.11"></a><span id="l46.11"> </span>
<a href="#l46.12"></a><span id="l46.12" class="difflineminus">-#define kMaxMarkers    10</span>
<a href="#l46.13"></a><span id="l46.13" class="difflineplus">+#define kMaxMarkers 10</span>
<a href="#l46.14"></a><span id="l46.14"> </span>
<a href="#l46.15"></a><span id="l46.15"> class ImportOutFile;</span>
<a href="#l46.16"></a><span id="l46.16"> </span>
<a href="#l46.17"></a><span id="l46.17"> class ImportOutFile {</span>
<a href="#l46.18"></a><span id="l46.18" class="difflineminus">-public:</span>
<a href="#l46.19"></a><span id="l46.19" class="difflineplus">+ public:</span>
<a href="#l46.20"></a><span id="l46.20">   ImportOutFile();</span>
<a href="#l46.21"></a><span id="l46.21" class="difflineminus">-  ImportOutFile(nsIFile *pFile, uint8_t * pBuf, uint32_t sz);</span>
<a href="#l46.22"></a><span id="l46.22" class="difflineplus">+  ImportOutFile(nsIFile *pFile, uint8_t *pBuf, uint32_t sz);</span>
<a href="#l46.23"></a><span id="l46.23">   ~ImportOutFile();</span>
<a href="#l46.24"></a><span id="l46.24"> </span>
<a href="#l46.25"></a><span id="l46.25" class="difflineminus">-  bool    InitOutFile(nsIFile *pFile, uint32_t bufSz = 4096);</span>
<a href="#l46.26"></a><span id="l46.26" class="difflineminus">-  void  InitOutFile(nsIFile *pFile, uint8_t * pBuf, uint32_t sz);</span>
<a href="#l46.27"></a><span id="l46.27" class="difflineminus">-  inline bool    WriteData(const uint8_t * pSrc, uint32_t len);</span>
<a href="#l46.28"></a><span id="l46.28" class="difflineminus">-  inline bool    WriteByte(uint8_t byte);</span>
<a href="#l46.29"></a><span id="l46.29" class="difflineminus">-  bool    WriteStr(const char *pStr) {return WriteU8NullTerm((const uint8_t *) pStr, false); }</span>
<a href="#l46.30"></a><span id="l46.30" class="difflineminus">-  bool    WriteU8NullTerm(const uint8_t * pSrc, bool includeNull);</span>
<a href="#l46.31"></a><span id="l46.31" class="difflineminus">-  bool    WriteEol(void) { return WriteStr(&quot;\x0D\x0A&quot;); }</span>
<a href="#l46.32"></a><span id="l46.32" class="difflineminus">-  bool    Done(void) {return Flush();}</span>
<a href="#l46.33"></a><span id="l46.33" class="difflineplus">+  bool InitOutFile(nsIFile *pFile, uint32_t bufSz = 4096);</span>
<a href="#l46.34"></a><span id="l46.34" class="difflineplus">+  void InitOutFile(nsIFile *pFile, uint8_t *pBuf, uint32_t sz);</span>
<a href="#l46.35"></a><span id="l46.35" class="difflineplus">+  inline bool WriteData(const uint8_t *pSrc, uint32_t len);</span>
<a href="#l46.36"></a><span id="l46.36" class="difflineplus">+  inline bool WriteByte(uint8_t byte);</span>
<a href="#l46.37"></a><span id="l46.37" class="difflineplus">+  bool WriteStr(const char *pStr) {</span>
<a href="#l46.38"></a><span id="l46.38" class="difflineplus">+    return WriteU8NullTerm((const uint8_t *)pStr, false);</span>
<a href="#l46.39"></a><span id="l46.39" class="difflineplus">+  }</span>
<a href="#l46.40"></a><span id="l46.40" class="difflineplus">+  bool WriteU8NullTerm(const uint8_t *pSrc, bool includeNull);</span>
<a href="#l46.41"></a><span id="l46.41" class="difflineplus">+  bool WriteEol(void) { return WriteStr(&quot;\x0D\x0A&quot;); }</span>
<a href="#l46.42"></a><span id="l46.42" class="difflineplus">+  bool Done(void) { return Flush(); }</span>
<a href="#l46.43"></a><span id="l46.43"> </span>
<a href="#l46.44"></a><span id="l46.44">   // Marker support</span>
<a href="#l46.45"></a><span id="l46.45" class="difflineminus">-  bool    SetMarker(int markerID);</span>
<a href="#l46.46"></a><span id="l46.46" class="difflineminus">-  void  ClearMarker(int markerID);</span>
<a href="#l46.47"></a><span id="l46.47" class="difflineminus">-  bool    WriteStrAtMarker(int markerID, const char *pStr);</span>
<a href="#l46.48"></a><span id="l46.48" class="difflineplus">+  bool SetMarker(int markerID);</span>
<a href="#l46.49"></a><span id="l46.49" class="difflineplus">+  void ClearMarker(int markerID);</span>
<a href="#l46.50"></a><span id="l46.50" class="difflineplus">+  bool WriteStrAtMarker(int markerID, const char *pStr);</span>
<a href="#l46.51"></a><span id="l46.51"> </span>
<a href="#l46.52"></a><span id="l46.52">   // 8-bit to 7-bit translation</span>
<a href="#l46.53"></a><span id="l46.53" class="difflineminus">-  bool    Set8bitTranslator(nsImportTranslator *pTrans);</span>
<a href="#l46.54"></a><span id="l46.54" class="difflineminus">-  bool    End8bitTranslation(bool *pEngaged, nsCString&amp; useCharset, nsCString&amp; encoding);</span>
<a href="#l46.55"></a><span id="l46.55" class="difflineplus">+  bool Set8bitTranslator(nsImportTranslator *pTrans);</span>
<a href="#l46.56"></a><span id="l46.56" class="difflineplus">+  bool End8bitTranslation(bool *pEngaged, nsCString &amp;useCharset,</span>
<a href="#l46.57"></a><span id="l46.57" class="difflineplus">+                          nsCString &amp;encoding);</span>
<a href="#l46.58"></a><span id="l46.58"> </span>
<a href="#l46.59"></a><span id="l46.59" class="difflineminus">-protected:</span>
<a href="#l46.60"></a><span id="l46.60" class="difflineminus">-  bool    Flush(void);</span>
<a href="#l46.61"></a><span id="l46.61" class="difflineplus">+ protected:</span>
<a href="#l46.62"></a><span id="l46.62" class="difflineplus">+  bool Flush(void);</span>
<a href="#l46.63"></a><span id="l46.63"> </span>
<a href="#l46.64"></a><span id="l46.64" class="difflineminus">-protected:</span>
<a href="#l46.65"></a><span id="l46.65" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt;      m_pFile;</span>
<a href="#l46.66"></a><span id="l46.66" class="difflineminus">-        nsCOMPtr &lt;nsIOutputStream&gt; m_outputStream;</span>
<a href="#l46.67"></a><span id="l46.67" class="difflineminus">-  uint8_t *    m_pBuf;</span>
<a href="#l46.68"></a><span id="l46.68" class="difflineminus">-  uint32_t    m_bufSz;</span>
<a href="#l46.69"></a><span id="l46.69" class="difflineminus">-  uint32_t    m_pos;</span>
<a href="#l46.70"></a><span id="l46.70" class="difflineminus">-  bool        m_ownsFileAndBuffer;</span>
<a href="#l46.71"></a><span id="l46.71" class="difflineplus">+ protected:</span>
<a href="#l46.72"></a><span id="l46.72" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; m_pFile;</span>
<a href="#l46.73"></a><span id="l46.73" class="difflineplus">+  nsCOMPtr&lt;nsIOutputStream&gt; m_outputStream;</span>
<a href="#l46.74"></a><span id="l46.74" class="difflineplus">+  uint8_t *m_pBuf;</span>
<a href="#l46.75"></a><span id="l46.75" class="difflineplus">+  uint32_t m_bufSz;</span>
<a href="#l46.76"></a><span id="l46.76" class="difflineplus">+  uint32_t m_pos;</span>
<a href="#l46.77"></a><span id="l46.77" class="difflineplus">+  bool m_ownsFileAndBuffer;</span>
<a href="#l46.78"></a><span id="l46.78"> </span>
<a href="#l46.79"></a><span id="l46.79">   // markers</span>
<a href="#l46.80"></a><span id="l46.80" class="difflineminus">-  uint32_t    m_markers[kMaxMarkers];</span>
<a href="#l46.81"></a><span id="l46.81" class="difflineplus">+  uint32_t m_markers[kMaxMarkers];</span>
<a href="#l46.82"></a><span id="l46.82"> </span>
<a href="#l46.83"></a><span id="l46.83">   // 8 bit to 7 bit translations</span>
<a href="#l46.84"></a><span id="l46.84" class="difflineminus">-  nsImportTranslator  *  m_pTrans;</span>
<a href="#l46.85"></a><span id="l46.85" class="difflineminus">-  bool            m_engaged;</span>
<a href="#l46.86"></a><span id="l46.86" class="difflineminus">-  bool            m_supports8to7;</span>
<a href="#l46.87"></a><span id="l46.87" class="difflineminus">-  ImportOutFile *      m_pTransOut;</span>
<a href="#l46.88"></a><span id="l46.88" class="difflineminus">-  uint8_t *        m_pTransBuf;</span>
<a href="#l46.89"></a><span id="l46.89" class="difflineplus">+  nsImportTranslator *m_pTrans;</span>
<a href="#l46.90"></a><span id="l46.90" class="difflineplus">+  bool m_engaged;</span>
<a href="#l46.91"></a><span id="l46.91" class="difflineplus">+  bool m_supports8to7;</span>
<a href="#l46.92"></a><span id="l46.92" class="difflineplus">+  ImportOutFile *m_pTransOut;</span>
<a href="#l46.93"></a><span id="l46.93" class="difflineplus">+  uint8_t *m_pTransBuf;</span>
<a href="#l46.94"></a><span id="l46.94"> };</span>
<a href="#l46.95"></a><span id="l46.95"> </span>
<a href="#l46.96"></a><span id="l46.96" class="difflineminus">-inline bool    ImportOutFile::WriteData(const uint8_t * pSrc, uint32_t len) {</span>
<a href="#l46.97"></a><span id="l46.97" class="difflineplus">+inline bool ImportOutFile::WriteData(const uint8_t *pSrc, uint32_t len) {</span>
<a href="#l46.98"></a><span id="l46.98">   while ((len + m_pos) &gt; m_bufSz) {</span>
<a href="#l46.99"></a><span id="l46.99">     if ((m_bufSz - m_pos)) {</span>
<a href="#l46.100"></a><span id="l46.100">       memcpy(m_pBuf + m_pos, pSrc, m_bufSz - m_pos);</span>
<a href="#l46.101"></a><span id="l46.101">       len -= (m_bufSz - m_pos);</span>
<a href="#l46.102"></a><span id="l46.102">       pSrc += (m_bufSz - m_pos);</span>
<a href="#l46.103"></a><span id="l46.103">       m_pos = m_bufSz;</span>
<a href="#l46.104"></a><span id="l46.104">     }</span>
<a href="#l46.105"></a><span id="l46.105" class="difflineminus">-    if (!Flush())</span>
<a href="#l46.106"></a><span id="l46.106" class="difflineminus">-      return false;</span>
<a href="#l46.107"></a><span id="l46.107" class="difflineplus">+    if (!Flush()) return false;</span>
<a href="#l46.108"></a><span id="l46.108">   }</span>
<a href="#l46.109"></a><span id="l46.109"> </span>
<a href="#l46.110"></a><span id="l46.110">   if (len) {</span>
<a href="#l46.111"></a><span id="l46.111">     memcpy(m_pBuf + m_pos, pSrc, len);</span>
<a href="#l46.112"></a><span id="l46.112">     m_pos += len;</span>
<a href="#l46.113"></a><span id="l46.113">   }</span>
<a href="#l46.114"></a><span id="l46.114"> </span>
<a href="#l46.115"></a><span id="l46.115">   return true;</span>
<a href="#l46.116"></a><span id="l46.116"> }</span>
<a href="#l46.117"></a><span id="l46.117"> </span>
<a href="#l46.118"></a><span id="l46.118" class="difflineminus">-inline bool    ImportOutFile::WriteByte(uint8_t byte) {</span>
<a href="#l46.119"></a><span id="l46.119" class="difflineplus">+inline bool ImportOutFile::WriteByte(uint8_t byte) {</span>
<a href="#l46.120"></a><span id="l46.120">   if (m_pos == m_bufSz) {</span>
<a href="#l46.121"></a><span id="l46.121" class="difflineminus">-    if (!Flush())</span>
<a href="#l46.122"></a><span id="l46.122" class="difflineminus">-      return false;</span>
<a href="#l46.123"></a><span id="l46.123" class="difflineplus">+    if (!Flush()) return false;</span>
<a href="#l46.124"></a><span id="l46.124">   }</span>
<a href="#l46.125"></a><span id="l46.125">   *(m_pBuf + m_pos) = byte;</span>
<a href="#l46.126"></a><span id="l46.126">   m_pos++;</span>
<a href="#l46.127"></a><span id="l46.127">   return true;</span>
<a href="#l46.128"></a><span id="l46.128"> }</span>
<a href="#l46.129"></a><span id="l46.129"> </span>
<a href="#l46.130"></a><span id="l46.130"> #endif /* ImportOutFile_h__ */</span>
<a href="#l46.131"></a><span id="l46.131" class="difflineminus">-</span>
<a href="#l46.132"></a><span id="l46.132" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1" class="difflineminus">--- a/mailnews/import/src/ImportTranslate.cpp</span>
<a href="#l47.2"></a><span id="l47.2" class="difflineplus">+++ b/mailnews/import/src/ImportTranslate.cpp</span>
<a href="#l47.3"></a><span id="l47.3" class="difflineat">@@ -2,104 +2,99 @@</span>
<a href="#l47.4"></a><span id="l47.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l47.5"></a><span id="l47.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l47.6"></a><span id="l47.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l47.7"></a><span id="l47.7"> </span>
<a href="#l47.8"></a><span id="l47.8"> #include &quot;ImportTranslate.h&quot;</span>
<a href="#l47.9"></a><span id="l47.9"> </span>
<a href="#l47.10"></a><span id="l47.10"> int ImportTranslate::m_useTranslator = -1;</span>
<a href="#l47.11"></a><span id="l47.11"> </span>
<a href="#l47.12"></a><span id="l47.12" class="difflineminus">-</span>
<a href="#l47.13"></a><span id="l47.13" class="difflineminus">-bool ImportTranslate::ConvertString(const nsCString&amp; inStr, nsCString&amp; outStr, bool mimeHeader)</span>
<a href="#l47.14"></a><span id="l47.14" class="difflineminus">-{</span>
<a href="#l47.15"></a><span id="l47.15" class="difflineplus">+bool ImportTranslate::ConvertString(const nsCString &amp;inStr, nsCString &amp;outStr,</span>
<a href="#l47.16"></a><span id="l47.16" class="difflineplus">+                                    bool mimeHeader) {</span>
<a href="#l47.17"></a><span id="l47.17">   if (inStr.IsEmpty()) {</span>
<a href="#l47.18"></a><span id="l47.18">     outStr = inStr;</span>
<a href="#l47.19"></a><span id="l47.19">     return true;</span>
<a href="#l47.20"></a><span id="l47.20">   }</span>
<a href="#l47.21"></a><span id="l47.21"> </span>
<a href="#l47.22"></a><span id="l47.22">   nsImportTranslator *pTrans = GetTranslator();</span>
<a href="#l47.23"></a><span id="l47.23">   // int      maxLen = (int) pTrans-&gt;GetMaxBufferSize(inStr.Length());</span>
<a href="#l47.24"></a><span id="l47.24">   // int      hLen = 0;</span>
<a href="#l47.25"></a><span id="l47.25" class="difflineminus">-  nsCString  set;</span>
<a href="#l47.26"></a><span id="l47.26" class="difflineminus">-  nsCString  lang;</span>
<a href="#l47.27"></a><span id="l47.27" class="difflineplus">+  nsCString set;</span>
<a href="#l47.28"></a><span id="l47.28" class="difflineplus">+  nsCString lang;</span>
<a href="#l47.29"></a><span id="l47.29"> </span>
<a href="#l47.30"></a><span id="l47.30">   if (mimeHeader) {</span>
<a href="#l47.31"></a><span id="l47.31">     // add the charset and language</span>
<a href="#l47.32"></a><span id="l47.32">     pTrans-&gt;GetCharset(set);</span>
<a href="#l47.33"></a><span id="l47.33">     pTrans-&gt;GetLanguage(lang);</span>
<a href="#l47.34"></a><span id="l47.34">   }</span>
<a href="#l47.35"></a><span id="l47.35"> </span>
<a href="#l47.36"></a><span id="l47.36">   // Unfortunately, we didn't implement ConvertBuffer for all translators,</span>
<a href="#l47.37"></a><span id="l47.37">   // just ConvertToFile.  This means that this data will not always</span>
<a href="#l47.38"></a><span id="l47.38">   // be converted to the charset of pTrans.  In that case...</span>
<a href="#l47.39"></a><span id="l47.39">   // We don't always have the data in the same charset as the current</span>
<a href="#l47.40"></a><span id="l47.40">   // translator...</span>
<a href="#l47.41"></a><span id="l47.41">   // It is safer to leave the charset and language field blank</span>
<a href="#l47.42"></a><span id="l47.42">   set.Truncate();</span>
<a href="#l47.43"></a><span id="l47.43">   lang.Truncate();</span>
<a href="#l47.44"></a><span id="l47.44"> </span>
<a href="#l47.45"></a><span id="l47.45" class="difflineminus">-  uint8_t *  pBuf;</span>
<a href="#l47.46"></a><span id="l47.46" class="difflineplus">+  uint8_t *pBuf;</span>
<a href="#l47.47"></a><span id="l47.47">   /*</span>
<a href="#l47.48"></a><span id="l47.48">   pBuf = (P_U8) outStr.GetBuffer(maxLen);</span>
<a href="#l47.49"></a><span id="l47.49">   if (!pBuf) {</span>
<a href="#l47.50"></a><span id="l47.50">     delete pTrans;</span>
<a href="#l47.51"></a><span id="l47.51">     return FALSE;</span>
<a href="#l47.52"></a><span id="l47.52">   }</span>
<a href="#l47.53"></a><span id="l47.53">   pTrans-&gt;ConvertBuffer((PC_U8)(PC_S8)inStr, inStr.GetLength(), pBuf);</span>
<a href="#l47.54"></a><span id="l47.54">   outStr.ReleaseBuffer();</span>
<a href="#l47.55"></a><span id="l47.55">   */</span>
<a href="#l47.56"></a><span id="l47.56">   outStr = inStr;</span>
<a href="#l47.57"></a><span id="l47.57">   delete pTrans;</span>
<a href="#l47.58"></a><span id="l47.58"> </span>
<a href="#l47.59"></a><span id="l47.59" class="difflineminus">-</span>
<a href="#l47.60"></a><span id="l47.60">   // Now I need to run the string through the mime-header special char</span>
<a href="#l47.61"></a><span id="l47.61">   // encoder.</span>
<a href="#l47.62"></a><span id="l47.62"> </span>
<a href="#l47.63"></a><span id="l47.63">   pTrans = new CMHTranslator;</span>
<a href="#l47.64"></a><span id="l47.64">   pBuf = new uint8_t[pTrans-&gt;GetMaxBufferSize(outStr.Length())];</span>
<a href="#l47.65"></a><span id="l47.65">   pTrans-&gt;ConvertBuffer((const uint8_t *)(outStr.get()), outStr.Length(), pBuf);</span>
<a href="#l47.66"></a><span id="l47.66">   delete pTrans;</span>
<a href="#l47.67"></a><span id="l47.67">   outStr.Truncate();</span>
<a href="#l47.68"></a><span id="l47.68">   if (mimeHeader) {</span>
<a href="#l47.69"></a><span id="l47.69">     outStr = set;</span>
<a href="#l47.70"></a><span id="l47.70">     outStr += &quot;'&quot;;</span>
<a href="#l47.71"></a><span id="l47.71">     outStr += lang;</span>
<a href="#l47.72"></a><span id="l47.72">     outStr += &quot;'&quot;;</span>
<a href="#l47.73"></a><span id="l47.73">   }</span>
<a href="#l47.74"></a><span id="l47.74">   outStr += (const char *)pBuf;</span>
<a href="#l47.75"></a><span id="l47.75" class="difflineminus">-  delete [] pBuf;</span>
<a href="#l47.76"></a><span id="l47.76" class="difflineplus">+  delete[] pBuf;</span>
<a href="#l47.77"></a><span id="l47.77"> </span>
<a href="#l47.78"></a><span id="l47.78">   return true;</span>
<a href="#l47.79"></a><span id="l47.79"> }</span>
<a href="#l47.80"></a><span id="l47.80"> </span>
<a href="#l47.81"></a><span id="l47.81" class="difflineminus">-</span>
<a href="#l47.82"></a><span id="l47.82" class="difflineminus">-nsImportTranslator *ImportTranslate::GetTranslator(void)</span>
<a href="#l47.83"></a><span id="l47.83" class="difflineminus">-{</span>
<a href="#l47.84"></a><span id="l47.84" class="difflineplus">+nsImportTranslator *ImportTranslate::GetTranslator(void) {</span>
<a href="#l47.85"></a><span id="l47.85">   if (m_useTranslator == -1) {</span>
<a href="#l47.86"></a><span id="l47.86">     // get the translator to use...</span>
<a href="#l47.87"></a><span id="l47.87">     // CString    trans;</span>
<a href="#l47.88"></a><span id="l47.88">     // trans.LoadString(IDS_LANGUAGE_TRANSLATION);</span>
<a href="#l47.89"></a><span id="l47.89">     m_useTranslator = 0;</span>
<a href="#l47.90"></a><span id="l47.90">     // if (!trans.CompareNoCase(&quot;iso-2022-jp&quot;))</span>
<a href="#l47.91"></a><span id="l47.91">     //  gWizData.m_useTranslator = 1;</span>
<a href="#l47.92"></a><span id="l47.92">   }</span>
<a href="#l47.93"></a><span id="l47.93"> </span>
<a href="#l47.94"></a><span id="l47.94" class="difflineminus">-  switch(m_useTranslator) {</span>
<a href="#l47.95"></a><span id="l47.95" class="difflineminus">-  case 0:</span>
<a href="#l47.96"></a><span id="l47.96" class="difflineminus">-    return new nsImportTranslator;</span>
<a href="#l47.97"></a><span id="l47.97" class="difflineminus">-  //case 1:</span>
<a href="#l47.98"></a><span id="l47.98" class="difflineminus">-  //  return new CSJis2JisTranslator;</span>
<a href="#l47.99"></a><span id="l47.99" class="difflineminus">-  default:</span>
<a href="#l47.100"></a><span id="l47.100" class="difflineminus">-    return new nsImportTranslator;</span>
<a href="#l47.101"></a><span id="l47.101" class="difflineplus">+  switch (m_useTranslator) {</span>
<a href="#l47.102"></a><span id="l47.102" class="difflineplus">+    case 0:</span>
<a href="#l47.103"></a><span id="l47.103" class="difflineplus">+      return new nsImportTranslator;</span>
<a href="#l47.104"></a><span id="l47.104" class="difflineplus">+    // case 1:</span>
<a href="#l47.105"></a><span id="l47.105" class="difflineplus">+    //  return new CSJis2JisTranslator;</span>
<a href="#l47.106"></a><span id="l47.106" class="difflineplus">+    default:</span>
<a href="#l47.107"></a><span id="l47.107" class="difflineplus">+      return new nsImportTranslator;</span>
<a href="#l47.108"></a><span id="l47.108">   }</span>
<a href="#l47.109"></a><span id="l47.109"> }</span>
<a href="#l47.110"></a><span id="l47.110"> </span>
<a href="#l47.111"></a><span id="l47.111" class="difflineminus">-nsImportTranslator *ImportTranslate::GetMatchingTranslator(const char *pCharSet)</span>
<a href="#l47.112"></a><span id="l47.112" class="difflineminus">-{</span>
<a href="#l47.113"></a><span id="l47.113" class="difflineminus">-/*</span>
<a href="#l47.114"></a><span id="l47.114" class="difflineminus">-  CString    jp = &quot;iso-2022-jp&quot;;</span>
<a href="#l47.115"></a><span id="l47.115" class="difflineminus">-  if (!jp.CompareNoCase(pCharSet))</span>
<a href="#l47.116"></a><span id="l47.116" class="difflineminus">-    return new CSJis2JisTranslator;</span>
<a href="#l47.117"></a><span id="l47.117" class="difflineminus">-*/</span>
<a href="#l47.118"></a><span id="l47.118" class="difflineplus">+nsImportTranslator *ImportTranslate::GetMatchingTranslator(</span>
<a href="#l47.119"></a><span id="l47.119" class="difflineplus">+    const char *pCharSet) {</span>
<a href="#l47.120"></a><span id="l47.120" class="difflineplus">+  /*</span>
<a href="#l47.121"></a><span id="l47.121" class="difflineplus">+    CString    jp = &quot;iso-2022-jp&quot;;</span>
<a href="#l47.122"></a><span id="l47.122" class="difflineplus">+    if (!jp.CompareNoCase(pCharSet))</span>
<a href="#l47.123"></a><span id="l47.123" class="difflineplus">+      return new CSJis2JisTranslator;</span>
<a href="#l47.124"></a><span id="l47.124" class="difflineplus">+  */</span>
<a href="#l47.125"></a><span id="l47.125"> </span>
<a href="#l47.126"></a><span id="l47.126">   return nullptr;</span>
<a href="#l47.127"></a><span id="l47.127"> }</span>
<a href="#l47.128"></a><span id="l47.128" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l48.1"></a><span id="l48.1" class="difflineminus">--- a/mailnews/import/src/ImportTranslate.h</span>
<a href="#l48.2"></a><span id="l48.2" class="difflineplus">+++ b/mailnews/import/src/ImportTranslate.h</span>
<a href="#l48.3"></a><span id="l48.3" class="difflineat">@@ -5,19 +5,19 @@</span>
<a href="#l48.4"></a><span id="l48.4"> </span>
<a href="#l48.5"></a><span id="l48.5"> #ifndef ImportTranslate_h___</span>
<a href="#l48.6"></a><span id="l48.6"> #define ImportTranslate_h___</span>
<a href="#l48.7"></a><span id="l48.7"> </span>
<a href="#l48.8"></a><span id="l48.8"> #include &quot;nsString.h&quot;</span>
<a href="#l48.9"></a><span id="l48.9"> #include &quot;nsImportTranslator.h&quot;</span>
<a href="#l48.10"></a><span id="l48.10"> </span>
<a href="#l48.11"></a><span id="l48.11"> class ImportTranslate {</span>
<a href="#l48.12"></a><span id="l48.12" class="difflineminus">-public:</span>
<a href="#l48.13"></a><span id="l48.13" class="difflineminus">-  static bool ConvertString(const nsCString&amp; inStr, nsCString&amp; outStr, bool mimeHeader);</span>
<a href="#l48.14"></a><span id="l48.14" class="difflineplus">+ public:</span>
<a href="#l48.15"></a><span id="l48.15" class="difflineplus">+  static bool ConvertString(const nsCString &amp;inStr, nsCString &amp;outStr,</span>
<a href="#l48.16"></a><span id="l48.16" class="difflineplus">+                            bool mimeHeader);</span>
<a href="#l48.17"></a><span id="l48.17">   static nsImportTranslator *GetTranslator(void);</span>
<a href="#l48.18"></a><span id="l48.18">   static nsImportTranslator *GetMatchingTranslator(const char *pCharSet);</span>
<a href="#l48.19"></a><span id="l48.19"> </span>
<a href="#l48.20"></a><span id="l48.20" class="difflineminus">-protected:</span>
<a href="#l48.21"></a><span id="l48.21" class="difflineplus">+ protected:</span>
<a href="#l48.22"></a><span id="l48.22">   static int m_useTranslator;</span>
<a href="#l48.23"></a><span id="l48.23"> };</span>
<a href="#l48.24"></a><span id="l48.24"> </span>
<a href="#l48.25"></a><span id="l48.25" class="difflineminus">-</span>
<a href="#l48.26"></a><span id="l48.26" class="difflineminus">-#endif  /* ImportTranslate_h__ */</span>
<a href="#l48.27"></a><span id="l48.27" class="difflineplus">+#endif /* ImportTranslate_h__ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l49.1"></a><span id="l49.1" class="difflineminus">--- a/mailnews/import/src/nsImportABDescriptor.cpp</span>
<a href="#l49.2"></a><span id="l49.2" class="difflineplus">+++ b/mailnews/import/src/nsImportABDescriptor.cpp</span>
<a href="#l49.3"></a><span id="l49.3" class="difflineat">@@ -1,26 +1,22 @@</span>
<a href="#l49.4"></a><span id="l49.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l49.5"></a><span id="l49.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l49.6"></a><span id="l49.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l49.7"></a><span id="l49.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l49.8"></a><span id="l49.8"> </span>
<a href="#l49.9"></a><span id="l49.9" class="difflineminus">-</span>
<a href="#l49.10"></a><span id="l49.10"> #include &quot;nscore.h&quot;</span>
<a href="#l49.11"></a><span id="l49.11"> #include &quot;nsImportABDescriptor.h&quot;</span>
<a href="#l49.12"></a><span id="l49.12"> </span>
<a href="#l49.13"></a><span id="l49.13"> ////////////////////////////////////////////////////////////////////////</span>
<a href="#l49.14"></a><span id="l49.14"> </span>
<a href="#l49.15"></a><span id="l49.15" class="difflineminus">-nsresult nsImportABDescriptor::Create(nsISupports *aOuter, REFNSIID aIID, void **aResult)</span>
<a href="#l49.16"></a><span id="l49.16" class="difflineminus">-{</span>
<a href="#l49.17"></a><span id="l49.17" class="difflineminus">-  if (aOuter)</span>
<a href="#l49.18"></a><span id="l49.18" class="difflineminus">-    return NS_ERROR_NO_AGGREGATION;</span>
<a href="#l49.19"></a><span id="l49.19" class="difflineplus">+nsresult nsImportABDescriptor::Create(nsISupports *aOuter, REFNSIID aIID,</span>
<a href="#l49.20"></a><span id="l49.20" class="difflineplus">+                                      void **aResult) {</span>
<a href="#l49.21"></a><span id="l49.21" class="difflineplus">+  if (aOuter) return NS_ERROR_NO_AGGREGATION;</span>
<a href="#l49.22"></a><span id="l49.22"> </span>
<a href="#l49.23"></a><span id="l49.23">   RefPtr&lt;nsImportABDescriptor&gt; it = new nsImportABDescriptor();</span>
<a href="#l49.24"></a><span id="l49.24">   return it-&gt;QueryInterface(aIID, aResult);</span>
<a href="#l49.25"></a><span id="l49.25"> }</span>
<a href="#l49.26"></a><span id="l49.26"> </span>
<a href="#l49.27"></a><span id="l49.27"> NS_IMPL_ISUPPORTS(nsImportABDescriptor, nsIImportABDescriptor)</span>
<a href="#l49.28"></a><span id="l49.28"> </span>
<a href="#l49.29"></a><span id="l49.29"> nsImportABDescriptor::nsImportABDescriptor()</span>
<a href="#l49.30"></a><span id="l49.30" class="difflineminus">-  : mId(0), mRef(0), mSize(0), mImport(true)</span>
<a href="#l49.31"></a><span id="l49.31" class="difflineminus">-{</span>
<a href="#l49.32"></a><span id="l49.32" class="difflineminus">-}</span>
<a href="#l49.33"></a><span id="l49.33" class="difflineplus">+    : mId(0), mRef(0), mSize(0), mImport(true) {}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l50.1"></a><span id="l50.1" class="difflineminus">--- a/mailnews/import/src/nsImportABDescriptor.h</span>
<a href="#l50.2"></a><span id="l50.2" class="difflineplus">+++ b/mailnews/import/src/nsImportABDescriptor.h</span>
<a href="#l50.3"></a><span id="l50.3" class="difflineat">@@ -10,19 +10,18 @@</span>
<a href="#l50.4"></a><span id="l50.4"> #include &quot;nscore.h&quot;</span>
<a href="#l50.5"></a><span id="l50.5"> #include &quot;nsString.h&quot;</span>
<a href="#l50.6"></a><span id="l50.6"> #include &quot;nsIImportABDescriptor.h&quot;</span>
<a href="#l50.7"></a><span id="l50.7"> #include &quot;nsIFile.h&quot;</span>
<a href="#l50.8"></a><span id="l50.8"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l50.9"></a><span id="l50.9"> </span>
<a href="#l50.10"></a><span id="l50.10"> ////////////////////////////////////////////////////////////////////////</span>
<a href="#l50.11"></a><span id="l50.11"> </span>
<a href="#l50.12"></a><span id="l50.12" class="difflineminus">-class nsImportABDescriptor : public nsIImportABDescriptor</span>
<a href="#l50.13"></a><span id="l50.13" class="difflineminus">-{</span>
<a href="#l50.14"></a><span id="l50.14" class="difflineminus">-public:</span>
<a href="#l50.15"></a><span id="l50.15" class="difflineplus">+class nsImportABDescriptor : public nsIImportABDescriptor {</span>
<a href="#l50.16"></a><span id="l50.16" class="difflineplus">+ public:</span>
<a href="#l50.17"></a><span id="l50.17">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l50.18"></a><span id="l50.18"> </span>
<a href="#l50.19"></a><span id="l50.19">   NS_IMETHOD GetIdentifier(uint32_t *pIdentifier) override {</span>
<a href="#l50.20"></a><span id="l50.20">     *pIdentifier = mId;</span>
<a href="#l50.21"></a><span id="l50.21">     return NS_OK;</span>
<a href="#l50.22"></a><span id="l50.22">   }</span>
<a href="#l50.23"></a><span id="l50.23">   NS_IMETHOD SetIdentifier(uint32_t ident) override {</span>
<a href="#l50.24"></a><span id="l50.24">     mId = ident;</span>
<a href="#l50.25"></a><span id="l50.25" class="difflineat">@@ -55,18 +54,17 @@ public:</span>
<a href="#l50.26"></a><span id="l50.26">   }</span>
<a href="#l50.27"></a><span id="l50.27">   NS_IMETHOD SetPreferredName(const nsAString &amp;aName) override {</span>
<a href="#l50.28"></a><span id="l50.28">     mDisplayName = aName;</span>
<a href="#l50.29"></a><span id="l50.29">     return NS_OK;</span>
<a href="#l50.30"></a><span id="l50.30">   }</span>
<a href="#l50.31"></a><span id="l50.31"> </span>
<a href="#l50.32"></a><span id="l50.32">   /* readonly attribute nsIFile fileSpec; */</span>
<a href="#l50.33"></a><span id="l50.33">   NS_IMETHOD GetAbFile(nsIFile **aFile) override {</span>
<a href="#l50.34"></a><span id="l50.34" class="difflineminus">-    if (!mFile)</span>
<a href="#l50.35"></a><span id="l50.35" class="difflineminus">-      return NS_ERROR_NULL_POINTER;</span>
<a href="#l50.36"></a><span id="l50.36" class="difflineplus">+    if (!mFile) return NS_ERROR_NULL_POINTER;</span>
<a href="#l50.37"></a><span id="l50.37"> </span>
<a href="#l50.38"></a><span id="l50.38">     return mFile-&gt;Clone(aFile);</span>
<a href="#l50.39"></a><span id="l50.39">   }</span>
<a href="#l50.40"></a><span id="l50.40"> </span>
<a href="#l50.41"></a><span id="l50.41">   NS_IMETHOD SetAbFile(nsIFile *aFile) override {</span>
<a href="#l50.42"></a><span id="l50.42">     if (!aFile) {</span>
<a href="#l50.43"></a><span id="l50.43">       mFile = nullptr;</span>
<a href="#l50.44"></a><span id="l50.44">       return NS_OK;</span>
<a href="#l50.45"></a><span id="l50.45" class="difflineat">@@ -84,20 +82,19 @@ public:</span>
<a href="#l50.46"></a><span id="l50.46">     mImport = doImport;</span>
<a href="#l50.47"></a><span id="l50.47">     return NS_OK;</span>
<a href="#l50.48"></a><span id="l50.48">   }</span>
<a href="#l50.49"></a><span id="l50.49"> </span>
<a href="#l50.50"></a><span id="l50.50">   nsImportABDescriptor();</span>
<a href="#l50.51"></a><span id="l50.51"> </span>
<a href="#l50.52"></a><span id="l50.52">   static nsresult Create(nsISupports *aOuter, REFNSIID aIID, void **aResult);</span>
<a href="#l50.53"></a><span id="l50.53"> </span>
<a href="#l50.54"></a><span id="l50.54" class="difflineminus">-private:</span>
<a href="#l50.55"></a><span id="l50.55" class="difflineplus">+ private:</span>
<a href="#l50.56"></a><span id="l50.56">   virtual ~nsImportABDescriptor() {}</span>
<a href="#l50.57"></a><span id="l50.57" class="difflineminus">-  uint32_t mId; // used by creator of the structure</span>
<a href="#l50.58"></a><span id="l50.58" class="difflineminus">-  uint32_t mRef; // depth in the hierarchy</span>
<a href="#l50.59"></a><span id="l50.59" class="difflineminus">-  nsString mDisplayName; // name of this mailbox</span>
<a href="#l50.60"></a><span id="l50.60" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt; mFile; // source file (if applicable)</span>
<a href="#l50.61"></a><span id="l50.61" class="difflineminus">-  uint32_t mSize; // size</span>
<a href="#l50.62"></a><span id="l50.62" class="difflineminus">-  bool mImport; // import it or not?</span>
<a href="#l50.63"></a><span id="l50.63" class="difflineplus">+  uint32_t mId;             // used by creator of the structure</span>
<a href="#l50.64"></a><span id="l50.64" class="difflineplus">+  uint32_t mRef;            // depth in the hierarchy</span>
<a href="#l50.65"></a><span id="l50.65" class="difflineplus">+  nsString mDisplayName;    // name of this mailbox</span>
<a href="#l50.66"></a><span id="l50.66" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; mFile;  // source file (if applicable)</span>
<a href="#l50.67"></a><span id="l50.67" class="difflineplus">+  uint32_t mSize;           // size</span>
<a href="#l50.68"></a><span id="l50.68" class="difflineplus">+  bool mImport;             // import it or not?</span>
<a href="#l50.69"></a><span id="l50.69"> };</span>
<a href="#l50.70"></a><span id="l50.70"> </span>
<a href="#l50.71"></a><span id="l50.71" class="difflineminus">-</span>
<a href="#l50.72"></a><span id="l50.72"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l51.1"></a><span id="l51.1" class="difflineminus">--- a/mailnews/import/src/nsImportAddressBooks.cpp</span>
<a href="#l51.2"></a><span id="l51.2" class="difflineplus">+++ b/mailnews/import/src/nsImportAddressBooks.cpp</span>
<a href="#l51.3"></a><span id="l51.3" class="difflineat">@@ -30,542 +30,499 @@</span>
<a href="#l51.4"></a><span id="l51.4"> #include &quot;nsIArray.h&quot;</span>
<a href="#l51.5"></a><span id="l51.5"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l51.6"></a><span id="l51.6"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l51.7"></a><span id="l51.7"> </span>
<a href="#l51.8"></a><span id="l51.8"> static void ImportAddressThread(void *stuff);</span>
<a href="#l51.9"></a><span id="l51.9"> </span>
<a href="#l51.10"></a><span id="l51.10"> class AddressThreadData;</span>
<a href="#l51.11"></a><span id="l51.11"> </span>
<a href="#l51.12"></a><span id="l51.12" class="difflineminus">-class nsImportGenericAddressBooks : public nsIImportGeneric</span>
<a href="#l51.13"></a><span id="l51.13" class="difflineminus">-{</span>
<a href="#l51.14"></a><span id="l51.14" class="difflineminus">-public:</span>
<a href="#l51.15"></a><span id="l51.15" class="difflineminus">-</span>
<a href="#l51.16"></a><span id="l51.16" class="difflineplus">+class nsImportGenericAddressBooks : public nsIImportGeneric {</span>
<a href="#l51.17"></a><span id="l51.17" class="difflineplus">+ public:</span>
<a href="#l51.18"></a><span id="l51.18">   nsImportGenericAddressBooks();</span>
<a href="#l51.19"></a><span id="l51.19"> </span>
<a href="#l51.20"></a><span id="l51.20">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l51.21"></a><span id="l51.21"> </span>
<a href="#l51.22"></a><span id="l51.22">   /* nsISupports GetData (in string dataId); */</span>
<a href="#l51.23"></a><span id="l51.23">   NS_IMETHOD GetData(const char *dataId, nsISupports **_retval) override;</span>
<a href="#l51.24"></a><span id="l51.24"> </span>
<a href="#l51.25"></a><span id="l51.25">   NS_IMETHOD SetData(const char *dataId, nsISupports *pData) override;</span>
<a href="#l51.26"></a><span id="l51.26"> </span>
<a href="#l51.27"></a><span id="l51.27">   NS_IMETHOD GetStatus(const char *statusKind, int32_t *_retval) override;</span>
<a href="#l51.28"></a><span id="l51.28"> </span>
<a href="#l51.29"></a><span id="l51.29">   NS_IMETHOD WantsProgress(bool *_retval) override;</span>
<a href="#l51.30"></a><span id="l51.30"> </span>
<a href="#l51.31"></a><span id="l51.31" class="difflineminus">-  NS_IMETHOD BeginImport(nsISupportsString *successLog, nsISupportsString *errorLog, bool *_retval) override;</span>
<a href="#l51.32"></a><span id="l51.32" class="difflineplus">+  NS_IMETHOD BeginImport(nsISupportsString *successLog,</span>
<a href="#l51.33"></a><span id="l51.33" class="difflineplus">+                         nsISupportsString *errorLog, bool *_retval) override;</span>
<a href="#l51.34"></a><span id="l51.34"> </span>
<a href="#l51.35"></a><span id="l51.35">   NS_IMETHOD ContinueImport(bool *_retval) override;</span>
<a href="#l51.36"></a><span id="l51.36"> </span>
<a href="#l51.37"></a><span id="l51.37">   NS_IMETHOD GetProgress(int32_t *_retval) override;</span>
<a href="#l51.38"></a><span id="l51.38"> </span>
<a href="#l51.39"></a><span id="l51.39">   NS_IMETHOD CancelImport(void) override;</span>
<a href="#l51.40"></a><span id="l51.40"> </span>
<a href="#l51.41"></a><span id="l51.41" class="difflineminus">-private:</span>
<a href="#l51.42"></a><span id="l51.42" class="difflineplus">+ private:</span>
<a href="#l51.43"></a><span id="l51.43">   virtual ~nsImportGenericAddressBooks();</span>
<a href="#l51.44"></a><span id="l51.44" class="difflineminus">-  void  GetDefaultLocation(void);</span>
<a href="#l51.45"></a><span id="l51.45" class="difflineminus">-  void  GetDefaultBooks(void);</span>
<a href="#l51.46"></a><span id="l51.46" class="difflineminus">-  void  GetDefaultFieldMap(void);</span>
<a href="#l51.47"></a><span id="l51.47" class="difflineplus">+  void GetDefaultLocation(void);</span>
<a href="#l51.48"></a><span id="l51.48" class="difflineplus">+  void GetDefaultBooks(void);</span>
<a href="#l51.49"></a><span id="l51.49" class="difflineplus">+  void GetDefaultFieldMap(void);</span>
<a href="#l51.50"></a><span id="l51.50"> </span>
<a href="#l51.51"></a><span id="l51.51" class="difflineminus">-public:</span>
<a href="#l51.52"></a><span id="l51.52" class="difflineminus">-  static void  SetLogs(nsString&amp; success, nsString&amp; error, nsISupportsString *pSuccess, nsISupportsString *pError);</span>
<a href="#l51.53"></a><span id="l51.53" class="difflineplus">+ public:</span>
<a href="#l51.54"></a><span id="l51.54" class="difflineplus">+  static void SetLogs(nsString &amp;success, nsString &amp;error,</span>
<a href="#l51.55"></a><span id="l51.55" class="difflineplus">+                      nsISupportsString *pSuccess, nsISupportsString *pError);</span>
<a href="#l51.56"></a><span id="l51.56">   static void ReportError(const char16_t *pName, nsString *pStream,</span>
<a href="#l51.57"></a><span id="l51.57">                           nsIStringBundle *aBundle);</span>
<a href="#l51.58"></a><span id="l51.58"> </span>
<a href="#l51.59"></a><span id="l51.59" class="difflineminus">-private:</span>
<a href="#l51.60"></a><span id="l51.60" class="difflineplus">+ private:</span>
<a href="#l51.61"></a><span id="l51.61">   nsCOMPtr&lt;nsIImportAddressBooks&gt; m_pInterface;</span>
<a href="#l51.62"></a><span id="l51.62" class="difflineminus">-  nsCOMPtr&lt;nsIArray&gt;              m_Books;</span>
<a href="#l51.63"></a><span id="l51.63" class="difflineminus">-  nsCOMArray&lt;nsIAddrDatabase&gt;     m_DBs;</span>
<a href="#l51.64"></a><span id="l51.64" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt;              m_pLocation;</span>
<a href="#l51.65"></a><span id="l51.65" class="difflineminus">-  nsCOMPtr&lt;nsIImportFieldMap&gt;     m_pFieldMap;</span>
<a href="#l51.66"></a><span id="l51.66" class="difflineminus">-  bool                            m_autoFind;</span>
<a href="#l51.67"></a><span id="l51.67" class="difflineminus">-  char16_t *                      m_description;</span>
<a href="#l51.68"></a><span id="l51.68" class="difflineminus">-  bool                            m_gotLocation;</span>
<a href="#l51.69"></a><span id="l51.69" class="difflineminus">-  bool                            m_found;</span>
<a href="#l51.70"></a><span id="l51.70" class="difflineminus">-  bool                            m_userVerify;</span>
<a href="#l51.71"></a><span id="l51.71" class="difflineminus">-  nsCOMPtr&lt;nsISupportsString&gt;     m_pSuccessLog;</span>
<a href="#l51.72"></a><span id="l51.72" class="difflineminus">-  nsCOMPtr&lt;nsISupportsString&gt;     m_pErrorLog;</span>
<a href="#l51.73"></a><span id="l51.73" class="difflineminus">-  uint32_t                        m_totalSize;</span>
<a href="#l51.74"></a><span id="l51.74" class="difflineminus">-  bool                            m_doImport;</span>
<a href="#l51.75"></a><span id="l51.75" class="difflineminus">-  AddressThreadData *             m_pThreadData;</span>
<a href="#l51.76"></a><span id="l51.76" class="difflineminus">-  nsCString                       m_pDestinationUri;</span>
<a href="#l51.77"></a><span id="l51.77" class="difflineminus">-  nsCOMPtr&lt;nsIStringBundle&gt;       m_stringBundle;</span>
<a href="#l51.78"></a><span id="l51.78" class="difflineplus">+  nsCOMPtr&lt;nsIArray&gt; m_Books;</span>
<a href="#l51.79"></a><span id="l51.79" class="difflineplus">+  nsCOMArray&lt;nsIAddrDatabase&gt; m_DBs;</span>
<a href="#l51.80"></a><span id="l51.80" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; m_pLocation;</span>
<a href="#l51.81"></a><span id="l51.81" class="difflineplus">+  nsCOMPtr&lt;nsIImportFieldMap&gt; m_pFieldMap;</span>
<a href="#l51.82"></a><span id="l51.82" class="difflineplus">+  bool m_autoFind;</span>
<a href="#l51.83"></a><span id="l51.83" class="difflineplus">+  char16_t *m_description;</span>
<a href="#l51.84"></a><span id="l51.84" class="difflineplus">+  bool m_gotLocation;</span>
<a href="#l51.85"></a><span id="l51.85" class="difflineplus">+  bool m_found;</span>
<a href="#l51.86"></a><span id="l51.86" class="difflineplus">+  bool m_userVerify;</span>
<a href="#l51.87"></a><span id="l51.87" class="difflineplus">+  nsCOMPtr&lt;nsISupportsString&gt; m_pSuccessLog;</span>
<a href="#l51.88"></a><span id="l51.88" class="difflineplus">+  nsCOMPtr&lt;nsISupportsString&gt; m_pErrorLog;</span>
<a href="#l51.89"></a><span id="l51.89" class="difflineplus">+  uint32_t m_totalSize;</span>
<a href="#l51.90"></a><span id="l51.90" class="difflineplus">+  bool m_doImport;</span>
<a href="#l51.91"></a><span id="l51.91" class="difflineplus">+  AddressThreadData *m_pThreadData;</span>
<a href="#l51.92"></a><span id="l51.92" class="difflineplus">+  nsCString m_pDestinationUri;</span>
<a href="#l51.93"></a><span id="l51.93" class="difflineplus">+  nsCOMPtr&lt;nsIStringBundle&gt; m_stringBundle;</span>
<a href="#l51.94"></a><span id="l51.94"> };</span>
<a href="#l51.95"></a><span id="l51.95"> </span>
<a href="#l51.96"></a><span id="l51.96"> class AddressThreadData {</span>
<a href="#l51.97"></a><span id="l51.97" class="difflineminus">-public:</span>
<a href="#l51.98"></a><span id="l51.98" class="difflineminus">-  bool              driverAlive;</span>
<a href="#l51.99"></a><span id="l51.99" class="difflineminus">-  bool              threadAlive;</span>
<a href="#l51.100"></a><span id="l51.100" class="difflineminus">-  bool              abort;</span>
<a href="#l51.101"></a><span id="l51.101" class="difflineminus">-  bool              fatalError;</span>
<a href="#l51.102"></a><span id="l51.102" class="difflineminus">-  uint32_t          currentTotal;</span>
<a href="#l51.103"></a><span id="l51.103" class="difflineminus">-  uint32_t          currentSize;</span>
<a href="#l51.104"></a><span id="l51.104" class="difflineminus">-  nsCOMPtr&lt;nsIArray&gt;              books;</span>
<a href="#l51.105"></a><span id="l51.105" class="difflineminus">-  nsCOMArray&lt;nsIAddrDatabase&gt;*    dBs;</span>
<a href="#l51.106"></a><span id="l51.106" class="difflineminus">-  nsCOMPtr&lt;nsIAbLDIFService&gt;      ldifService;</span>
<a href="#l51.107"></a><span id="l51.107" class="difflineplus">+ public:</span>
<a href="#l51.108"></a><span id="l51.108" class="difflineplus">+  bool driverAlive;</span>
<a href="#l51.109"></a><span id="l51.109" class="difflineplus">+  bool threadAlive;</span>
<a href="#l51.110"></a><span id="l51.110" class="difflineplus">+  bool abort;</span>
<a href="#l51.111"></a><span id="l51.111" class="difflineplus">+  bool fatalError;</span>
<a href="#l51.112"></a><span id="l51.112" class="difflineplus">+  uint32_t currentTotal;</span>
<a href="#l51.113"></a><span id="l51.113" class="difflineplus">+  uint32_t currentSize;</span>
<a href="#l51.114"></a><span id="l51.114" class="difflineplus">+  nsCOMPtr&lt;nsIArray&gt; books;</span>
<a href="#l51.115"></a><span id="l51.115" class="difflineplus">+  nsCOMArray&lt;nsIAddrDatabase&gt; *dBs;</span>
<a href="#l51.116"></a><span id="l51.116" class="difflineplus">+  nsCOMPtr&lt;nsIAbLDIFService&gt; ldifService;</span>
<a href="#l51.117"></a><span id="l51.117">   nsCOMPtr&lt;nsIImportAddressBooks&gt; addressImport;</span>
<a href="#l51.118"></a><span id="l51.118" class="difflineminus">-  nsCOMPtr&lt;nsIImportFieldMap&gt;     fieldMap;</span>
<a href="#l51.119"></a><span id="l51.119" class="difflineminus">-  nsCOMPtr&lt;nsISupportsString&gt;     successLog;</span>
<a href="#l51.120"></a><span id="l51.120" class="difflineminus">-  nsCOMPtr&lt;nsISupportsString&gt;     errorLog;</span>
<a href="#l51.121"></a><span id="l51.121" class="difflineminus">-  nsCString                       pDestinationUri;</span>
<a href="#l51.122"></a><span id="l51.122" class="difflineminus">-  nsCOMPtr&lt;nsIStringBundle&gt;       stringBundle;</span>
<a href="#l51.123"></a><span id="l51.123" class="difflineplus">+  nsCOMPtr&lt;nsIImportFieldMap&gt; fieldMap;</span>
<a href="#l51.124"></a><span id="l51.124" class="difflineplus">+  nsCOMPtr&lt;nsISupportsString&gt; successLog;</span>
<a href="#l51.125"></a><span id="l51.125" class="difflineplus">+  nsCOMPtr&lt;nsISupportsString&gt; errorLog;</span>
<a href="#l51.126"></a><span id="l51.126" class="difflineplus">+  nsCString pDestinationUri;</span>
<a href="#l51.127"></a><span id="l51.127" class="difflineplus">+  nsCOMPtr&lt;nsIStringBundle&gt; stringBundle;</span>
<a href="#l51.128"></a><span id="l51.128"> </span>
<a href="#l51.129"></a><span id="l51.129">   AddressThreadData();</span>
<a href="#l51.130"></a><span id="l51.130">   ~AddressThreadData();</span>
<a href="#l51.131"></a><span id="l51.131"> };</span>
<a href="#l51.132"></a><span id="l51.132"> </span>
<a href="#l51.133"></a><span id="l51.133" class="difflineminus">-</span>
<a href="#l51.134"></a><span id="l51.134" class="difflineminus">-nsresult NS_NewGenericAddressBooks(nsIImportGeneric** aImportGeneric)</span>
<a href="#l51.135"></a><span id="l51.135" class="difflineminus">-{</span>
<a href="#l51.136"></a><span id="l51.136" class="difflineplus">+nsresult NS_NewGenericAddressBooks(nsIImportGeneric **aImportGeneric) {</span>
<a href="#l51.137"></a><span id="l51.137">   NS_ASSERTION(aImportGeneric != nullptr, &quot;null ptr&quot;);</span>
<a href="#l51.138"></a><span id="l51.138" class="difflineminus">-  if (! aImportGeneric)</span>
<a href="#l51.139"></a><span id="l51.139" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l51.140"></a><span id="l51.140" class="difflineplus">+  if (!aImportGeneric) return NS_ERROR_NULL_POINTER;</span>
<a href="#l51.141"></a><span id="l51.141"> </span>
<a href="#l51.142"></a><span id="l51.142">   RefPtr&lt;nsImportGenericAddressBooks&gt; pGen = new nsImportGenericAddressBooks();</span>
<a href="#l51.143"></a><span id="l51.143" class="difflineminus">-  return pGen-&gt;QueryInterface(NS_GET_IID(nsIImportGeneric), (void **)aImportGeneric);</span>
<a href="#l51.144"></a><span id="l51.144" class="difflineplus">+  return pGen-&gt;QueryInterface(NS_GET_IID(nsIImportGeneric),</span>
<a href="#l51.145"></a><span id="l51.145" class="difflineplus">+                              (void **)aImportGeneric);</span>
<a href="#l51.146"></a><span id="l51.146"> }</span>
<a href="#l51.147"></a><span id="l51.147"> </span>
<a href="#l51.148"></a><span id="l51.148" class="difflineminus">-nsImportGenericAddressBooks::nsImportGenericAddressBooks()</span>
<a href="#l51.149"></a><span id="l51.149" class="difflineminus">-{</span>
<a href="#l51.150"></a><span id="l51.150" class="difflineplus">+nsImportGenericAddressBooks::nsImportGenericAddressBooks() {</span>
<a href="#l51.151"></a><span id="l51.151">   m_totalSize = 0;</span>
<a href="#l51.152"></a><span id="l51.152">   m_doImport = false;</span>
<a href="#l51.153"></a><span id="l51.153">   m_pThreadData = nullptr;</span>
<a href="#l51.154"></a><span id="l51.154"> </span>
<a href="#l51.155"></a><span id="l51.155">   m_autoFind = false;</span>
<a href="#l51.156"></a><span id="l51.156">   m_description = nullptr;</span>
<a href="#l51.157"></a><span id="l51.157">   m_gotLocation = false;</span>
<a href="#l51.158"></a><span id="l51.158">   m_found = false;</span>
<a href="#l51.159"></a><span id="l51.159">   m_userVerify = false;</span>
<a href="#l51.160"></a><span id="l51.160"> </span>
<a href="#l51.161"></a><span id="l51.161" class="difflineminus">-  nsImportStringBundle::GetStringBundle(IMPORT_MSGS_URL, getter_AddRefs(m_stringBundle));</span>
<a href="#l51.162"></a><span id="l51.162" class="difflineplus">+  nsImportStringBundle::GetStringBundle(IMPORT_MSGS_URL,</span>
<a href="#l51.163"></a><span id="l51.163" class="difflineplus">+                                        getter_AddRefs(m_stringBundle));</span>
<a href="#l51.164"></a><span id="l51.164"> }</span>
<a href="#l51.165"></a><span id="l51.165"> </span>
<a href="#l51.166"></a><span id="l51.166" class="difflineminus">-</span>
<a href="#l51.167"></a><span id="l51.167" class="difflineminus">-nsImportGenericAddressBooks::~nsImportGenericAddressBooks()</span>
<a href="#l51.168"></a><span id="l51.168" class="difflineminus">-{</span>
<a href="#l51.169"></a><span id="l51.169" class="difflineminus">-  if (m_description)</span>
<a href="#l51.170"></a><span id="l51.170" class="difflineminus">-    free(m_description);</span>
<a href="#l51.171"></a><span id="l51.171" class="difflineplus">+nsImportGenericAddressBooks::~nsImportGenericAddressBooks() {</span>
<a href="#l51.172"></a><span id="l51.172" class="difflineplus">+  if (m_description) free(m_description);</span>
<a href="#l51.173"></a><span id="l51.173"> }</span>
<a href="#l51.174"></a><span id="l51.174"> </span>
<a href="#l51.175"></a><span id="l51.175" class="difflineminus">-</span>
<a href="#l51.176"></a><span id="l51.176" class="difflineminus">-</span>
<a href="#l51.177"></a><span id="l51.177"> NS_IMPL_ISUPPORTS(nsImportGenericAddressBooks, nsIImportGeneric)</span>
<a href="#l51.178"></a><span id="l51.178"> </span>
<a href="#l51.179"></a><span id="l51.179" class="difflineminus">-</span>
<a href="#l51.180"></a><span id="l51.180" class="difflineminus">-NS_IMETHODIMP nsImportGenericAddressBooks::GetData(const char *dataId, nsISupports **_retval)</span>
<a href="#l51.181"></a><span id="l51.181" class="difflineminus">-{</span>
<a href="#l51.182"></a><span id="l51.182" class="difflineplus">+NS_IMETHODIMP nsImportGenericAddressBooks::GetData(const char *dataId,</span>
<a href="#l51.183"></a><span id="l51.183" class="difflineplus">+                                                   nsISupports **_retval) {</span>
<a href="#l51.184"></a><span id="l51.184">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l51.185"></a><span id="l51.185">   nsresult rv;</span>
<a href="#l51.186"></a><span id="l51.186">   *_retval = nullptr;</span>
<a href="#l51.187"></a><span id="l51.187">   if (!PL_strcasecmp(dataId, &quot;addressInterface&quot;)) {</span>
<a href="#l51.188"></a><span id="l51.188">     NS_IF_ADDREF(*_retval = m_pInterface);</span>
<a href="#l51.189"></a><span id="l51.189">   }</span>
<a href="#l51.190"></a><span id="l51.190"> </span>
<a href="#l51.191"></a><span id="l51.191">   if (!PL_strcasecmp(dataId, &quot;addressLocation&quot;)) {</span>
<a href="#l51.192"></a><span id="l51.192" class="difflineminus">-    if (!m_pLocation)</span>
<a href="#l51.193"></a><span id="l51.193" class="difflineminus">-      GetDefaultLocation();</span>
<a href="#l51.194"></a><span id="l51.194" class="difflineplus">+    if (!m_pLocation) GetDefaultLocation();</span>
<a href="#l51.195"></a><span id="l51.195">     NS_IF_ADDREF(*_retval = m_pLocation);</span>
<a href="#l51.196"></a><span id="l51.196">   }</span>
<a href="#l51.197"></a><span id="l51.197"> </span>
<a href="#l51.198"></a><span id="l51.198">   if (!PL_strcasecmp(dataId, &quot;addressBooks&quot;)) {</span>
<a href="#l51.199"></a><span id="l51.199" class="difflineminus">-    if (!m_pLocation)</span>
<a href="#l51.200"></a><span id="l51.200" class="difflineminus">-      GetDefaultLocation();</span>
<a href="#l51.201"></a><span id="l51.201" class="difflineminus">-    if (!m_Books)</span>
<a href="#l51.202"></a><span id="l51.202" class="difflineminus">-      GetDefaultBooks();</span>
<a href="#l51.203"></a><span id="l51.203" class="difflineplus">+    if (!m_pLocation) GetDefaultLocation();</span>
<a href="#l51.204"></a><span id="l51.204" class="difflineplus">+    if (!m_Books) GetDefaultBooks();</span>
<a href="#l51.205"></a><span id="l51.205">     *_retval = m_Books;</span>
<a href="#l51.206"></a><span id="l51.206">   }</span>
<a href="#l51.207"></a><span id="l51.207"> </span>
<a href="#l51.208"></a><span id="l51.208">   if (!PL_strcasecmp(dataId, &quot;addressDestination&quot;)) {</span>
<a href="#l51.209"></a><span id="l51.209">     if (!m_pDestinationUri.IsEmpty()) {</span>
<a href="#l51.210"></a><span id="l51.210" class="difflineminus">-      nsCOMPtr&lt;nsISupportsCString&gt; abString = do_CreateInstance(NS_SUPPORTS_CSTRING_CONTRACTID, &amp;rv);</span>
<a href="#l51.211"></a><span id="l51.211" class="difflineplus">+      nsCOMPtr&lt;nsISupportsCString&gt; abString =</span>
<a href="#l51.212"></a><span id="l51.212" class="difflineplus">+          do_CreateInstance(NS_SUPPORTS_CSTRING_CONTRACTID, &amp;rv);</span>
<a href="#l51.213"></a><span id="l51.213">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l51.214"></a><span id="l51.214">       abString-&gt;SetData(m_pDestinationUri);</span>
<a href="#l51.215"></a><span id="l51.215">       abString.forget(_retval);</span>
<a href="#l51.216"></a><span id="l51.216">     }</span>
<a href="#l51.217"></a><span id="l51.217">   }</span>
<a href="#l51.218"></a><span id="l51.218"> </span>
<a href="#l51.219"></a><span id="l51.219">   if (!PL_strcasecmp(dataId, &quot;fieldMap&quot;)) {</span>
<a href="#l51.220"></a><span id="l51.220">     if (m_pFieldMap) {</span>
<a href="#l51.221"></a><span id="l51.221">       NS_ADDREF(*_retval = m_pFieldMap);</span>
<a href="#l51.222"></a><span id="l51.222" class="difflineminus">-    }</span>
<a href="#l51.223"></a><span id="l51.223" class="difflineminus">-    else {</span>
<a href="#l51.224"></a><span id="l51.224" class="difflineplus">+    } else {</span>
<a href="#l51.225"></a><span id="l51.225">       if (m_pInterface &amp;&amp; m_pLocation) {</span>
<a href="#l51.226"></a><span id="l51.226">         bool needsIt = false;</span>
<a href="#l51.227"></a><span id="l51.227">         m_pInterface-&gt;GetNeedsFieldMap(m_pLocation, &amp;needsIt);</span>
<a href="#l51.228"></a><span id="l51.228">         if (needsIt) {</span>
<a href="#l51.229"></a><span id="l51.229">           GetDefaultFieldMap();</span>
<a href="#l51.230"></a><span id="l51.230">           if (m_pFieldMap) {</span>
<a href="#l51.231"></a><span id="l51.231">             NS_ADDREF(*_retval = m_pFieldMap);</span>
<a href="#l51.232"></a><span id="l51.232">           }</span>
<a href="#l51.233"></a><span id="l51.233">         }</span>
<a href="#l51.234"></a><span id="l51.234">       }</span>
<a href="#l51.235"></a><span id="l51.235">     }</span>
<a href="#l51.236"></a><span id="l51.236">   }</span>
<a href="#l51.237"></a><span id="l51.237"> </span>
<a href="#l51.238"></a><span id="l51.238">   if (!PL_strncasecmp(dataId, &quot;sampleData-&quot;, 11)) {</span>
<a href="#l51.239"></a><span id="l51.239">     // extra the record number</span>
<a href="#l51.240"></a><span id="l51.240">     const char *pNum = dataId + 11;</span>
<a href="#l51.241"></a><span id="l51.241" class="difflineminus">-    int32_t  rNum = 0;</span>
<a href="#l51.242"></a><span id="l51.242" class="difflineplus">+    int32_t rNum = 0;</span>
<a href="#l51.243"></a><span id="l51.243">     while (*pNum) {</span>
<a href="#l51.244"></a><span id="l51.244">       rNum *= 10;</span>
<a href="#l51.245"></a><span id="l51.245">       rNum += (*pNum - '0');</span>
<a href="#l51.246"></a><span id="l51.246">       pNum++;</span>
<a href="#l51.247"></a><span id="l51.247">     }</span>
<a href="#l51.248"></a><span id="l51.248">     IMPORT_LOG1(&quot;Requesting sample data #: %ld\n&quot;, (long)rNum);</span>
<a href="#l51.249"></a><span id="l51.249">     if (m_pInterface) {</span>
<a href="#l51.250"></a><span id="l51.250" class="difflineminus">-      nsCOMPtr&lt;nsISupportsString&gt;  data = do_CreateInstance(NS_SUPPORTS_STRING_CONTRACTID, &amp;rv);</span>
<a href="#l51.251"></a><span id="l51.251" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l51.252"></a><span id="l51.252" class="difflineminus">-        return rv;</span>
<a href="#l51.253"></a><span id="l51.253" class="difflineminus">-      char16_t *  pData = nullptr;</span>
<a href="#l51.254"></a><span id="l51.254" class="difflineminus">-      bool      found = false;</span>
<a href="#l51.255"></a><span id="l51.255" class="difflineplus">+      nsCOMPtr&lt;nsISupportsString&gt; data =</span>
<a href="#l51.256"></a><span id="l51.256" class="difflineplus">+          do_CreateInstance(NS_SUPPORTS_STRING_CONTRACTID, &amp;rv);</span>
<a href="#l51.257"></a><span id="l51.257" class="difflineplus">+      if (NS_FAILED(rv)) return rv;</span>
<a href="#l51.258"></a><span id="l51.258" class="difflineplus">+      char16_t *pData = nullptr;</span>
<a href="#l51.259"></a><span id="l51.259" class="difflineplus">+      bool found = false;</span>
<a href="#l51.260"></a><span id="l51.260">       rv = m_pInterface-&gt;GetSampleData(rNum, &amp;found, &amp;pData);</span>
<a href="#l51.261"></a><span id="l51.261" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l51.262"></a><span id="l51.262" class="difflineminus">-        return rv;</span>
<a href="#l51.263"></a><span id="l51.263" class="difflineplus">+      if (NS_FAILED(rv)) return rv;</span>
<a href="#l51.264"></a><span id="l51.264">       if (found) {</span>
<a href="#l51.265"></a><span id="l51.265">         data-&gt;SetData(nsDependentString(pData));</span>
<a href="#l51.266"></a><span id="l51.266">         data.forget(_retval);</span>
<a href="#l51.267"></a><span id="l51.267">       }</span>
<a href="#l51.268"></a><span id="l51.268">       free(pData);</span>
<a href="#l51.269"></a><span id="l51.269">     }</span>
<a href="#l51.270"></a><span id="l51.270">   }</span>
<a href="#l51.271"></a><span id="l51.271"> </span>
<a href="#l51.272"></a><span id="l51.272">   return NS_OK;</span>
<a href="#l51.273"></a><span id="l51.273"> }</span>
<a href="#l51.274"></a><span id="l51.274"> </span>
<a href="#l51.275"></a><span id="l51.275" class="difflineminus">-</span>
<a href="#l51.276"></a><span id="l51.276" class="difflineminus">-NS_IMETHODIMP nsImportGenericAddressBooks::SetData(const char *dataId, nsISupports *item)</span>
<a href="#l51.277"></a><span id="l51.277" class="difflineminus">-{</span>
<a href="#l51.278"></a><span id="l51.278" class="difflineplus">+NS_IMETHODIMP nsImportGenericAddressBooks::SetData(const char *dataId,</span>
<a href="#l51.279"></a><span id="l51.279" class="difflineplus">+                                                   nsISupports *item) {</span>
<a href="#l51.280"></a><span id="l51.280">   NS_ASSERTION(dataId != nullptr, &quot;null ptr&quot;);</span>
<a href="#l51.281"></a><span id="l51.281" class="difflineminus">-  if (!dataId)</span>
<a href="#l51.282"></a><span id="l51.282" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l51.283"></a><span id="l51.283" class="difflineplus">+  if (!dataId) return NS_ERROR_NULL_POINTER;</span>
<a href="#l51.284"></a><span id="l51.284"> </span>
<a href="#l51.285"></a><span id="l51.285">   if (!PL_strcasecmp(dataId, &quot;addressInterface&quot;)) {</span>
<a href="#l51.286"></a><span id="l51.286">     m_pInterface = nullptr;</span>
<a href="#l51.287"></a><span id="l51.287" class="difflineminus">-    if (item)</span>
<a href="#l51.288"></a><span id="l51.288" class="difflineminus">-      m_pInterface = do_QueryInterface(item);</span>
<a href="#l51.289"></a><span id="l51.289" class="difflineplus">+    if (item) m_pInterface = do_QueryInterface(item);</span>
<a href="#l51.290"></a><span id="l51.290">   }</span>
<a href="#l51.291"></a><span id="l51.291">   if (!PL_strcasecmp(dataId, &quot;addressBooks&quot;)) {</span>
<a href="#l51.292"></a><span id="l51.292" class="difflineminus">-    if (item)</span>
<a href="#l51.293"></a><span id="l51.293" class="difflineminus">-      m_Books = do_QueryInterface(item);</span>
<a href="#l51.294"></a><span id="l51.294" class="difflineplus">+    if (item) m_Books = do_QueryInterface(item);</span>
<a href="#l51.295"></a><span id="l51.295">   }</span>
<a href="#l51.296"></a><span id="l51.296"> </span>
<a href="#l51.297"></a><span id="l51.297">   if (!PL_strcasecmp(dataId, &quot;addressLocation&quot;)) {</span>
<a href="#l51.298"></a><span id="l51.298">     m_pLocation = nullptr;</span>
<a href="#l51.299"></a><span id="l51.299"> </span>
<a href="#l51.300"></a><span id="l51.300">     if (item) {</span>
<a href="#l51.301"></a><span id="l51.301">       nsresult rv;</span>
<a href="#l51.302"></a><span id="l51.302">       m_pLocation = do_QueryInterface(item, &amp;rv);</span>
<a href="#l51.303"></a><span id="l51.303" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l51.304"></a><span id="l51.304" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l51.305"></a><span id="l51.305">     }</span>
<a href="#l51.306"></a><span id="l51.306"> </span>
<a href="#l51.307"></a><span id="l51.307" class="difflineminus">-    if (m_pInterface)</span>
<a href="#l51.308"></a><span id="l51.308" class="difflineminus">-      m_pInterface-&gt;SetSampleLocation(m_pLocation);</span>
<a href="#l51.309"></a><span id="l51.309" class="difflineplus">+    if (m_pInterface) m_pInterface-&gt;SetSampleLocation(m_pLocation);</span>
<a href="#l51.310"></a><span id="l51.310">   }</span>
<a href="#l51.311"></a><span id="l51.311"> </span>
<a href="#l51.312"></a><span id="l51.312">   if (!PL_strcasecmp(dataId, &quot;addressDestination&quot;)) {</span>
<a href="#l51.313"></a><span id="l51.313">     if (item) {</span>
<a href="#l51.314"></a><span id="l51.314">       nsCOMPtr&lt;nsISupportsCString&gt; abString = do_QueryInterface(item);</span>
<a href="#l51.315"></a><span id="l51.315">       if (abString) {</span>
<a href="#l51.316"></a><span id="l51.316">         abString-&gt;GetData(m_pDestinationUri);</span>
<a href="#l51.317"></a><span id="l51.317">       }</span>
<a href="#l51.318"></a><span id="l51.318">     }</span>
<a href="#l51.319"></a><span id="l51.319">   }</span>
<a href="#l51.320"></a><span id="l51.320"> </span>
<a href="#l51.321"></a><span id="l51.321">   if (!PL_strcasecmp(dataId, &quot;fieldMap&quot;)) {</span>
<a href="#l51.322"></a><span id="l51.322">     m_pFieldMap = nullptr;</span>
<a href="#l51.323"></a><span id="l51.323" class="difflineminus">-    if (item)</span>
<a href="#l51.324"></a><span id="l51.324" class="difflineminus">-      m_pFieldMap = do_QueryInterface(item);</span>
<a href="#l51.325"></a><span id="l51.325" class="difflineplus">+    if (item) m_pFieldMap = do_QueryInterface(item);</span>
<a href="#l51.326"></a><span id="l51.326">   }</span>
<a href="#l51.327"></a><span id="l51.327"> </span>
<a href="#l51.328"></a><span id="l51.328">   return NS_OK;</span>
<a href="#l51.329"></a><span id="l51.329"> }</span>
<a href="#l51.330"></a><span id="l51.330"> </span>
<a href="#l51.331"></a><span id="l51.331" class="difflineminus">-NS_IMETHODIMP nsImportGenericAddressBooks::GetStatus(const char *statusKind, int32_t *_retval)</span>
<a href="#l51.332"></a><span id="l51.332" class="difflineminus">-{</span>
<a href="#l51.333"></a><span id="l51.333" class="difflineplus">+NS_IMETHODIMP nsImportGenericAddressBooks::GetStatus(const char *statusKind,</span>
<a href="#l51.334"></a><span id="l51.334" class="difflineplus">+                                                     int32_t *_retval) {</span>
<a href="#l51.335"></a><span id="l51.335">   NS_ASSERTION(statusKind != nullptr, &quot;null ptr&quot;);</span>
<a href="#l51.336"></a><span id="l51.336">   NS_ASSERTION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l51.337"></a><span id="l51.337" class="difflineminus">-  if (!statusKind || !_retval)</span>
<a href="#l51.338"></a><span id="l51.338" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l51.339"></a><span id="l51.339" class="difflineplus">+  if (!statusKind || !_retval) return NS_ERROR_NULL_POINTER;</span>
<a href="#l51.340"></a><span id="l51.340"> </span>
<a href="#l51.341"></a><span id="l51.341">   *_retval = 0;</span>
<a href="#l51.342"></a><span id="l51.342"> </span>
<a href="#l51.343"></a><span id="l51.343">   if (!PL_strcasecmp(statusKind, &quot;isInstalled&quot;)) {</span>
<a href="#l51.344"></a><span id="l51.344">     GetDefaultLocation();</span>
<a href="#l51.345"></a><span id="l51.345" class="difflineminus">-    *_retval = (int32_t) m_found;</span>
<a href="#l51.346"></a><span id="l51.346" class="difflineplus">+    *_retval = (int32_t)m_found;</span>
<a href="#l51.347"></a><span id="l51.347">   }</span>
<a href="#l51.348"></a><span id="l51.348"> </span>
<a href="#l51.349"></a><span id="l51.349">   if (!PL_strcasecmp(statusKind, &quot;canUserSetLocation&quot;)) {</span>
<a href="#l51.350"></a><span id="l51.350">     GetDefaultLocation();</span>
<a href="#l51.351"></a><span id="l51.351" class="difflineminus">-    *_retval = (int32_t) m_userVerify;</span>
<a href="#l51.352"></a><span id="l51.352" class="difflineplus">+    *_retval = (int32_t)m_userVerify;</span>
<a href="#l51.353"></a><span id="l51.353">   }</span>
<a href="#l51.354"></a><span id="l51.354"> </span>
<a href="#l51.355"></a><span id="l51.355">   if (!PL_strcasecmp(statusKind, &quot;autoFind&quot;)) {</span>
<a href="#l51.356"></a><span id="l51.356">     GetDefaultLocation();</span>
<a href="#l51.357"></a><span id="l51.357" class="difflineminus">-    *_retval = (int32_t) m_autoFind;</span>
<a href="#l51.358"></a><span id="l51.358" class="difflineplus">+    *_retval = (int32_t)m_autoFind;</span>
<a href="#l51.359"></a><span id="l51.359">   }</span>
<a href="#l51.360"></a><span id="l51.360"> </span>
<a href="#l51.361"></a><span id="l51.361">   if (!PL_strcasecmp(statusKind, &quot;supportsMultiple&quot;)) {</span>
<a href="#l51.362"></a><span id="l51.362" class="difflineminus">-    bool      multi = false;</span>
<a href="#l51.363"></a><span id="l51.363" class="difflineminus">-    if (m_pInterface)</span>
<a href="#l51.364"></a><span id="l51.364" class="difflineminus">-      m_pInterface-&gt;GetSupportsMultiple(&amp;multi);</span>
<a href="#l51.365"></a><span id="l51.365" class="difflineminus">-    *_retval = (int32_t) multi;</span>
<a href="#l51.366"></a><span id="l51.366" class="difflineplus">+    bool multi = false;</span>
<a href="#l51.367"></a><span id="l51.367" class="difflineplus">+    if (m_pInterface) m_pInterface-&gt;GetSupportsMultiple(&amp;multi);</span>
<a href="#l51.368"></a><span id="l51.368" class="difflineplus">+    *_retval = (int32_t)multi;</span>
<a href="#l51.369"></a><span id="l51.369">   }</span>
<a href="#l51.370"></a><span id="l51.370"> </span>
<a href="#l51.371"></a><span id="l51.371">   if (!PL_strcasecmp(statusKind, &quot;needsFieldMap&quot;)) {</span>
<a href="#l51.372"></a><span id="l51.372" class="difflineminus">-    bool      needs = false;</span>
<a href="#l51.373"></a><span id="l51.373" class="difflineplus">+    bool needs = false;</span>
<a href="#l51.374"></a><span id="l51.374">     if (m_pInterface &amp;&amp; m_pLocation)</span>
<a href="#l51.375"></a><span id="l51.375">       m_pInterface-&gt;GetNeedsFieldMap(m_pLocation, &amp;needs);</span>
<a href="#l51.376"></a><span id="l51.376" class="difflineminus">-    *_retval = (int32_t) needs;</span>
<a href="#l51.377"></a><span id="l51.377" class="difflineplus">+    *_retval = (int32_t)needs;</span>
<a href="#l51.378"></a><span id="l51.378">   }</span>
<a href="#l51.379"></a><span id="l51.379"> </span>
<a href="#l51.380"></a><span id="l51.380">   return NS_OK;</span>
<a href="#l51.381"></a><span id="l51.381"> }</span>
<a href="#l51.382"></a><span id="l51.382"> </span>
<a href="#l51.383"></a><span id="l51.383" class="difflineminus">-void nsImportGenericAddressBooks::GetDefaultLocation(void)</span>
<a href="#l51.384"></a><span id="l51.384" class="difflineminus">-{</span>
<a href="#l51.385"></a><span id="l51.385" class="difflineminus">-  if (!m_pInterface)</span>
<a href="#l51.386"></a><span id="l51.386" class="difflineminus">-    return;</span>
<a href="#l51.387"></a><span id="l51.387" class="difflineplus">+void nsImportGenericAddressBooks::GetDefaultLocation(void) {</span>
<a href="#l51.388"></a><span id="l51.388" class="difflineplus">+  if (!m_pInterface) return;</span>
<a href="#l51.389"></a><span id="l51.389"> </span>
<a href="#l51.390"></a><span id="l51.390" class="difflineminus">-  if ((m_pLocation &amp;&amp; m_gotLocation) || m_autoFind)</span>
<a href="#l51.391"></a><span id="l51.391" class="difflineminus">-    return;</span>
<a href="#l51.392"></a><span id="l51.392" class="difflineplus">+  if ((m_pLocation &amp;&amp; m_gotLocation) || m_autoFind) return;</span>
<a href="#l51.393"></a><span id="l51.393"> </span>
<a href="#l51.394"></a><span id="l51.394" class="difflineminus">-  if (m_description)</span>
<a href="#l51.395"></a><span id="l51.395" class="difflineminus">-    free(m_description);</span>
<a href="#l51.396"></a><span id="l51.396" class="difflineplus">+  if (m_description) free(m_description);</span>
<a href="#l51.397"></a><span id="l51.397">   m_description = nullptr;</span>
<a href="#l51.398"></a><span id="l51.398">   m_pInterface-&gt;GetAutoFind(&amp;m_description, &amp;m_autoFind);</span>
<a href="#l51.399"></a><span id="l51.399">   m_gotLocation = true;</span>
<a href="#l51.400"></a><span id="l51.400">   if (m_autoFind) {</span>
<a href="#l51.401"></a><span id="l51.401">     m_found = true;</span>
<a href="#l51.402"></a><span id="l51.402">     m_userVerify = false;</span>
<a href="#l51.403"></a><span id="l51.403">     return;</span>
<a href="#l51.404"></a><span id="l51.404">   }</span>
<a href="#l51.405"></a><span id="l51.405"> </span>
<a href="#l51.406"></a><span id="l51.406" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; pLoc;</span>
<a href="#l51.407"></a><span id="l51.407" class="difflineminus">-  m_pInterface-&gt;GetDefaultLocation(getter_AddRefs(pLoc), &amp;m_found, &amp;m_userVerify);</span>
<a href="#l51.408"></a><span id="l51.408" class="difflineminus">-  if (!m_pLocation)</span>
<a href="#l51.409"></a><span id="l51.409" class="difflineminus">-    m_pLocation = pLoc;</span>
<a href="#l51.410"></a><span id="l51.410" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; pLoc;</span>
<a href="#l51.411"></a><span id="l51.411" class="difflineplus">+  m_pInterface-&gt;GetDefaultLocation(getter_AddRefs(pLoc), &amp;m_found,</span>
<a href="#l51.412"></a><span id="l51.412" class="difflineplus">+                                   &amp;m_userVerify);</span>
<a href="#l51.413"></a><span id="l51.413" class="difflineplus">+  if (!m_pLocation) m_pLocation = pLoc;</span>
<a href="#l51.414"></a><span id="l51.414"> }</span>
<a href="#l51.415"></a><span id="l51.415"> </span>
<a href="#l51.416"></a><span id="l51.416" class="difflineminus">-void nsImportGenericAddressBooks::GetDefaultBooks(void)</span>
<a href="#l51.417"></a><span id="l51.417" class="difflineminus">-{</span>
<a href="#l51.418"></a><span id="l51.418" class="difflineminus">-  if (!m_pInterface || m_Books)</span>
<a href="#l51.419"></a><span id="l51.419" class="difflineminus">-    return;</span>
<a href="#l51.420"></a><span id="l51.420" class="difflineplus">+void nsImportGenericAddressBooks::GetDefaultBooks(void) {</span>
<a href="#l51.421"></a><span id="l51.421" class="difflineplus">+  if (!m_pInterface || m_Books) return;</span>
<a href="#l51.422"></a><span id="l51.422"> </span>
<a href="#l51.423"></a><span id="l51.423" class="difflineminus">-  if (!m_pLocation &amp;&amp; !m_autoFind)</span>
<a href="#l51.424"></a><span id="l51.424" class="difflineminus">-    return;</span>
<a href="#l51.425"></a><span id="l51.425" class="difflineplus">+  if (!m_pLocation &amp;&amp; !m_autoFind) return;</span>
<a href="#l51.426"></a><span id="l51.426"> </span>
<a href="#l51.427"></a><span id="l51.427" class="difflineminus">-  nsresult rv = m_pInterface-&gt;FindAddressBooks(m_pLocation, getter_AddRefs(m_Books));</span>
<a href="#l51.428"></a><span id="l51.428" class="difflineplus">+  nsresult rv =</span>
<a href="#l51.429"></a><span id="l51.429" class="difflineplus">+      m_pInterface-&gt;FindAddressBooks(m_pLocation, getter_AddRefs(m_Books));</span>
<a href="#l51.430"></a><span id="l51.430">   if (NS_FAILED(rv)) {</span>
<a href="#l51.431"></a><span id="l51.431">     IMPORT_LOG0(&quot;*** Error: FindAddressBooks failed\n&quot;);</span>
<a href="#l51.432"></a><span id="l51.432">   }</span>
<a href="#l51.433"></a><span id="l51.433"> }</span>
<a href="#l51.434"></a><span id="l51.434"> </span>
<a href="#l51.435"></a><span id="l51.435" class="difflineminus">-void nsImportGenericAddressBooks::GetDefaultFieldMap(void)</span>
<a href="#l51.436"></a><span id="l51.436" class="difflineminus">-{</span>
<a href="#l51.437"></a><span id="l51.437" class="difflineminus">-  if (!m_pInterface || !m_pLocation)</span>
<a href="#l51.438"></a><span id="l51.438" class="difflineminus">-    return;</span>
<a href="#l51.439"></a><span id="l51.439" class="difflineplus">+void nsImportGenericAddressBooks::GetDefaultFieldMap(void) {</span>
<a href="#l51.440"></a><span id="l51.440" class="difflineplus">+  if (!m_pInterface || !m_pLocation) return;</span>
<a href="#l51.441"></a><span id="l51.441"> </span>
<a href="#l51.442"></a><span id="l51.442" class="difflineminus">-  nsresult  rv;</span>
<a href="#l51.443"></a><span id="l51.443" class="difflineminus">-  nsCOMPtr&lt;nsIImportService&gt; impSvc(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l51.444"></a><span id="l51.444" class="difflineplus">+  nsresult rv;</span>
<a href="#l51.445"></a><span id="l51.445" class="difflineplus">+  nsCOMPtr&lt;nsIImportService&gt; impSvc(</span>
<a href="#l51.446"></a><span id="l51.446" class="difflineplus">+      do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l51.447"></a><span id="l51.447">   if (NS_FAILED(rv)) {</span>
<a href="#l51.448"></a><span id="l51.448">     IMPORT_LOG0(&quot;*** Unable to get nsIImportService.\n&quot;);</span>
<a href="#l51.449"></a><span id="l51.449">     return;</span>
<a href="#l51.450"></a><span id="l51.450">   }</span>
<a href="#l51.451"></a><span id="l51.451"> </span>
<a href="#l51.452"></a><span id="l51.452">   rv = impSvc-&gt;CreateNewFieldMap(getter_AddRefs(m_pFieldMap));</span>
<a href="#l51.453"></a><span id="l51.453" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l51.454"></a><span id="l51.454" class="difflineminus">-    return;</span>
<a href="#l51.455"></a><span id="l51.455" class="difflineplus">+  if (NS_FAILED(rv)) return;</span>
<a href="#l51.456"></a><span id="l51.456"> </span>
<a href="#l51.457"></a><span id="l51.457" class="difflineminus">-  int32_t  sz = 0;</span>
<a href="#l51.458"></a><span id="l51.458" class="difflineplus">+  int32_t sz = 0;</span>
<a href="#l51.459"></a><span id="l51.459">   rv = m_pFieldMap-&gt;GetNumMozFields(&amp;sz);</span>
<a href="#l51.460"></a><span id="l51.460" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l51.461"></a><span id="l51.461" class="difflineminus">-    rv = m_pFieldMap-&gt;DefaultFieldMap(sz);</span>
<a href="#l51.462"></a><span id="l51.462" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l51.463"></a><span id="l51.463" class="difflineminus">-    rv = m_pInterface-&gt;InitFieldMap(m_pFieldMap);</span>
<a href="#l51.464"></a><span id="l51.464" class="difflineplus">+  if (NS_SUCCEEDED(rv)) rv = m_pFieldMap-&gt;DefaultFieldMap(sz);</span>
<a href="#l51.465"></a><span id="l51.465" class="difflineplus">+  if (NS_SUCCEEDED(rv)) rv = m_pInterface-&gt;InitFieldMap(m_pFieldMap);</span>
<a href="#l51.466"></a><span id="l51.466">   if (NS_FAILED(rv)) {</span>
<a href="#l51.467"></a><span id="l51.467">     IMPORT_LOG0(&quot;*** Error: Unable to initialize field map\n&quot;);</span>
<a href="#l51.468"></a><span id="l51.468">     m_pFieldMap = nullptr;</span>
<a href="#l51.469"></a><span id="l51.469">   }</span>
<a href="#l51.470"></a><span id="l51.470"> }</span>
<a href="#l51.471"></a><span id="l51.471"> </span>
<a href="#l51.472"></a><span id="l51.472" class="difflineminus">-</span>
<a href="#l51.473"></a><span id="l51.473" class="difflineminus">-NS_IMETHODIMP nsImportGenericAddressBooks::WantsProgress(bool *_retval)</span>
<a href="#l51.474"></a><span id="l51.474" class="difflineminus">-{</span>
<a href="#l51.475"></a><span id="l51.475" class="difflineplus">+NS_IMETHODIMP nsImportGenericAddressBooks::WantsProgress(bool *_retval) {</span>
<a href="#l51.476"></a><span id="l51.476">   NS_ASSERTION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l51.477"></a><span id="l51.477">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l51.478"></a><span id="l51.478"> </span>
<a href="#l51.479"></a><span id="l51.479">   GetDefaultLocation();</span>
<a href="#l51.480"></a><span id="l51.480">   GetDefaultBooks();</span>
<a href="#l51.481"></a><span id="l51.481"> </span>
<a href="#l51.482"></a><span id="l51.482">   bool result = false;</span>
<a href="#l51.483"></a><span id="l51.483"> </span>
<a href="#l51.484"></a><span id="l51.484">   if (m_Books) {</span>
<a href="#l51.485"></a><span id="l51.485" class="difflineminus">-    uint32_t    count = 0;</span>
<a href="#l51.486"></a><span id="l51.486" class="difflineminus">-    uint32_t    i;</span>
<a href="#l51.487"></a><span id="l51.487" class="difflineminus">-    bool        import;</span>
<a href="#l51.488"></a><span id="l51.488" class="difflineminus">-    uint32_t    size;</span>
<a href="#l51.489"></a><span id="l51.489" class="difflineminus">-    uint32_t    totalSize = 0;</span>
<a href="#l51.490"></a><span id="l51.490" class="difflineplus">+    uint32_t count = 0;</span>
<a href="#l51.491"></a><span id="l51.491" class="difflineplus">+    uint32_t i;</span>
<a href="#l51.492"></a><span id="l51.492" class="difflineplus">+    bool import;</span>
<a href="#l51.493"></a><span id="l51.493" class="difflineplus">+    uint32_t size;</span>
<a href="#l51.494"></a><span id="l51.494" class="difflineplus">+    uint32_t totalSize = 0;</span>
<a href="#l51.495"></a><span id="l51.495"> </span>
<a href="#l51.496"></a><span id="l51.496">     m_Books-&gt;GetLength(&amp;count);</span>
<a href="#l51.497"></a><span id="l51.497"> </span>
<a href="#l51.498"></a><span id="l51.498">     for (i = 0; i &lt; count; i++) {</span>
<a href="#l51.499"></a><span id="l51.499">       nsCOMPtr&lt;nsIImportABDescriptor&gt; book = do_QueryElementAt(m_Books, i);</span>
<a href="#l51.500"></a><span id="l51.500">       if (book) {</span>
<a href="#l51.501"></a><span id="l51.501">         import = false;</span>
<a href="#l51.502"></a><span id="l51.502">         size = 0;</span>
<a href="#l51.503"></a><span id="l51.503">         nsresult rv = book-&gt;GetImport(&amp;import);</span>
<a href="#l51.504"></a><span id="l51.504">         if (NS_SUCCEEDED(rv) &amp;&amp; import) {</span>
<a href="#l51.505"></a><span id="l51.505" class="difflineminus">-          (void) book-&gt;GetSize(&amp;size);</span>
<a href="#l51.506"></a><span id="l51.506" class="difflineplus">+          (void)book-&gt;GetSize(&amp;size);</span>
<a href="#l51.507"></a><span id="l51.507">           result = true;</span>
<a href="#l51.508"></a><span id="l51.508">         }</span>
<a href="#l51.509"></a><span id="l51.509">         totalSize += size;</span>
<a href="#l51.510"></a><span id="l51.510">       }</span>
<a href="#l51.511"></a><span id="l51.511">     }</span>
<a href="#l51.512"></a><span id="l51.512"> </span>
<a href="#l51.513"></a><span id="l51.513">     m_totalSize = totalSize;</span>
<a href="#l51.514"></a><span id="l51.514">   }</span>
<a href="#l51.515"></a><span id="l51.515"> </span>
<a href="#l51.516"></a><span id="l51.516">   m_doImport = result;</span>
<a href="#l51.517"></a><span id="l51.517"> </span>
<a href="#l51.518"></a><span id="l51.518">   *_retval = result;</span>
<a href="#l51.519"></a><span id="l51.519"> </span>
<a href="#l51.520"></a><span id="l51.520">   return NS_OK;</span>
<a href="#l51.521"></a><span id="l51.521"> }</span>
<a href="#l51.522"></a><span id="l51.522"> </span>
<a href="#l51.523"></a><span id="l51.523" class="difflineminus">-void nsImportGenericAddressBooks::SetLogs(nsString&amp; success, nsString&amp; error, nsISupportsString *pSuccess, nsISupportsString *pError)</span>
<a href="#l51.524"></a><span id="l51.524" class="difflineminus">-{</span>
<a href="#l51.525"></a><span id="l51.525" class="difflineplus">+void nsImportGenericAddressBooks::SetLogs(nsString &amp;success, nsString &amp;error,</span>
<a href="#l51.526"></a><span id="l51.526" class="difflineplus">+                                          nsISupportsString *pSuccess,</span>
<a href="#l51.527"></a><span id="l51.527" class="difflineplus">+                                          nsISupportsString *pError) {</span>
<a href="#l51.528"></a><span id="l51.528">   nsAutoString str;</span>
<a href="#l51.529"></a><span id="l51.529">   if (pSuccess) {</span>
<a href="#l51.530"></a><span id="l51.530">     pSuccess-&gt;GetData(str);</span>
<a href="#l51.531"></a><span id="l51.531" class="difflineminus">-        str.Append(success);</span>
<a href="#l51.532"></a><span id="l51.532" class="difflineminus">-        pSuccess-&gt;SetData(success);</span>
<a href="#l51.533"></a><span id="l51.533" class="difflineplus">+    str.Append(success);</span>
<a href="#l51.534"></a><span id="l51.534" class="difflineplus">+    pSuccess-&gt;SetData(success);</span>
<a href="#l51.535"></a><span id="l51.535">   }</span>
<a href="#l51.536"></a><span id="l51.536">   if (pError) {</span>
<a href="#l51.537"></a><span id="l51.537">     pError-&gt;GetData(str);</span>
<a href="#l51.538"></a><span id="l51.538" class="difflineminus">-        str.Append(error);</span>
<a href="#l51.539"></a><span id="l51.539" class="difflineminus">-        pError-&gt;SetData(error);</span>
<a href="#l51.540"></a><span id="l51.540" class="difflineplus">+    str.Append(error);</span>
<a href="#l51.541"></a><span id="l51.541" class="difflineplus">+    pError-&gt;SetData(error);</span>
<a href="#l51.542"></a><span id="l51.542">   }</span>
<a href="#l51.543"></a><span id="l51.543"> }</span>
<a href="#l51.544"></a><span id="l51.544"> </span>
<a href="#l51.545"></a><span id="l51.545" class="difflineminus">-already_AddRefed&lt;nsIAddrDatabase&gt; GetAddressBookFromUri(const char *pUri)</span>
<a href="#l51.546"></a><span id="l51.546" class="difflineminus">-{</span>
<a href="#l51.547"></a><span id="l51.547" class="difflineminus">-  if (!pUri)</span>
<a href="#l51.548"></a><span id="l51.548" class="difflineminus">-    return nullptr;</span>
<a href="#l51.549"></a><span id="l51.549" class="difflineplus">+already_AddRefed&lt;nsIAddrDatabase&gt; GetAddressBookFromUri(const char *pUri) {</span>
<a href="#l51.550"></a><span id="l51.550" class="difflineplus">+  if (!pUri) return nullptr;</span>
<a href="#l51.551"></a><span id="l51.551"> </span>
<a href="#l51.552"></a><span id="l51.552">   nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID);</span>
<a href="#l51.553"></a><span id="l51.553" class="difflineminus">-  if (!abManager)</span>
<a href="#l51.554"></a><span id="l51.554" class="difflineminus">-    return nullptr;</span>
<a href="#l51.555"></a><span id="l51.555" class="difflineplus">+  if (!abManager) return nullptr;</span>
<a href="#l51.556"></a><span id="l51.556"> </span>
<a href="#l51.557"></a><span id="l51.557">   nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l51.558"></a><span id="l51.558" class="difflineminus">-  abManager-&gt;GetDirectory(nsDependentCString(pUri),</span>
<a href="#l51.559"></a><span id="l51.559" class="difflineminus">-                          getter_AddRefs(directory));</span>
<a href="#l51.560"></a><span id="l51.560" class="difflineminus">-  if (!directory)</span>
<a href="#l51.561"></a><span id="l51.561" class="difflineminus">-    return nullptr;</span>
<a href="#l51.562"></a><span id="l51.562" class="difflineplus">+  abManager-&gt;GetDirectory(nsDependentCString(pUri), getter_AddRefs(directory));</span>
<a href="#l51.563"></a><span id="l51.563" class="difflineplus">+  if (!directory) return nullptr;</span>
<a href="#l51.564"></a><span id="l51.564"> </span>
<a href="#l51.565"></a><span id="l51.565">   nsCOMPtr&lt;nsIAbMDBDirectory&gt; mdbDirectory = do_QueryInterface(directory);</span>
<a href="#l51.566"></a><span id="l51.566" class="difflineminus">-  if (!mdbDirectory)</span>
<a href="#l51.567"></a><span id="l51.567" class="difflineminus">-    return nullptr;</span>
<a href="#l51.568"></a><span id="l51.568" class="difflineplus">+  if (!mdbDirectory) return nullptr;</span>
<a href="#l51.569"></a><span id="l51.569"> </span>
<a href="#l51.570"></a><span id="l51.570">   nsCOMPtr&lt;nsIAddrDatabase&gt; pDatabase;</span>
<a href="#l51.571"></a><span id="l51.571">   mdbDirectory-&gt;GetDatabase(getter_AddRefs(pDatabase));</span>
<a href="#l51.572"></a><span id="l51.572">   return pDatabase.forget();</span>
<a href="#l51.573"></a><span id="l51.573"> }</span>
<a href="#l51.574"></a><span id="l51.574"> </span>
<a href="#l51.575"></a><span id="l51.575"> already_AddRefed&lt;nsIAddrDatabase&gt; GetAddressBook(const char16_t *name,</span>
<a href="#l51.576"></a><span id="l51.576" class="difflineminus">-                                                 bool makeNew)</span>
<a href="#l51.577"></a><span id="l51.577" class="difflineminus">-{</span>
<a href="#l51.578"></a><span id="l51.578" class="difflineplus">+                                                 bool makeNew) {</span>
<a href="#l51.579"></a><span id="l51.579">   if (!makeNew) {</span>
<a href="#l51.580"></a><span id="l51.580">     // FIXME: How do I get the list of address books and look for a</span>
<a href="#l51.581"></a><span id="l51.581">     // specific name.  Major bogosity!</span>
<a href="#l51.582"></a><span id="l51.582">     // For now, assume we didn't find anything with that name</span>
<a href="#l51.583"></a><span id="l51.583">   }</span>
<a href="#l51.584"></a><span id="l51.584"> </span>
<a href="#l51.585"></a><span id="l51.585">   IMPORT_LOG0(&quot;In GetAddressBook\n&quot;);</span>
<a href="#l51.586"></a><span id="l51.586"> </span>
<a href="#l51.587"></a><span id="l51.587">   nsresult rv;</span>
<a href="#l51.588"></a><span id="l51.588">   nsCOMPtr&lt;nsIAddrDatabase&gt; pDatabase;</span>
<a href="#l51.589"></a><span id="l51.589">   nsCOMPtr&lt;nsIFile&gt; dbPath;</span>
<a href="#l51.590"></a><span id="l51.590" class="difflineminus">-  nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l51.591"></a><span id="l51.591" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l51.592"></a><span id="l51.592" class="difflineminus">-  {</span>
<a href="#l51.593"></a><span id="l51.593" class="difflineplus">+  nsCOMPtr&lt;nsIAbManager&gt; abManager =</span>
<a href="#l51.594"></a><span id="l51.594" class="difflineplus">+      do_GetService(NS_ABMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l51.595"></a><span id="l51.595" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l51.596"></a><span id="l51.596">     /* Get the profile directory */</span>
<a href="#l51.597"></a><span id="l51.597">     rv = abManager-&gt;GetUserProfileDirectory(getter_AddRefs(dbPath));</span>
<a href="#l51.598"></a><span id="l51.598" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l51.599"></a><span id="l51.599" class="difflineminus">-    {</span>
<a href="#l51.600"></a><span id="l51.600" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l51.601"></a><span id="l51.601">       // Create a new address book file - we don't care what the file</span>
<a href="#l51.602"></a><span id="l51.602">       // name is, as long as it's unique</span>
<a href="#l51.603"></a><span id="l51.603">       rv = dbPath-&gt;Append(NS_LITERAL_STRING(&quot;impab.mab&quot;));</span>
<a href="#l51.604"></a><span id="l51.604" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l51.605"></a><span id="l51.605" class="difflineminus">-      {</span>
<a href="#l51.606"></a><span id="l51.606" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l51.607"></a><span id="l51.607">         rv = dbPath-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 0600);</span>
<a href="#l51.608"></a><span id="l51.608"> </span>
<a href="#l51.609"></a><span id="l51.609" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l51.610"></a><span id="l51.610" class="difflineminus">-        {</span>
<a href="#l51.611"></a><span id="l51.611" class="difflineplus">+        if (NS_SUCCEEDED(rv)) {</span>
<a href="#l51.612"></a><span id="l51.612">           IMPORT_LOG0(&quot;Getting the address database factory\n&quot;);</span>
<a href="#l51.613"></a><span id="l51.613"> </span>
<a href="#l51.614"></a><span id="l51.614">           nsCOMPtr&lt;nsIAddrDatabase&gt; addrDBFactory =</span>
<a href="#l51.615"></a><span id="l51.615" class="difflineminus">-            do_GetService(NS_ADDRDATABASE_CONTRACTID, &amp;rv);</span>
<a href="#l51.616"></a><span id="l51.616" class="difflineminus">-          if (NS_FAILED(rv))</span>
<a href="#l51.617"></a><span id="l51.617" class="difflineminus">-            return nullptr;</span>
<a href="#l51.618"></a><span id="l51.618" class="difflineplus">+              do_GetService(NS_ADDRDATABASE_CONTRACTID, &amp;rv);</span>
<a href="#l51.619"></a><span id="l51.619" class="difflineplus">+          if (NS_FAILED(rv)) return nullptr;</span>
<a href="#l51.620"></a><span id="l51.620"> </span>
<a href="#l51.621"></a><span id="l51.621">           IMPORT_LOG0(&quot;Opening the new address book\n&quot;);</span>
<a href="#l51.622"></a><span id="l51.622">           rv = addrDBFactory-&gt;Open(dbPath, true, true,</span>
<a href="#l51.623"></a><span id="l51.623">                                    getter_AddRefs(pDatabase));</span>
<a href="#l51.624"></a><span id="l51.624">         }</span>
<a href="#l51.625"></a><span id="l51.625">       }</span>
<a href="#l51.626"></a><span id="l51.626">     }</span>
<a href="#l51.627"></a><span id="l51.627">   }</span>
<a href="#l51.628"></a><span id="l51.628" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l51.629"></a><span id="l51.629" class="difflineminus">-  {</span>
<a href="#l51.630"></a><span id="l51.630" class="difflineminus">-    IMPORT_LOG0(&quot;Failed to get the user profile directory from the address book session\n&quot;);</span>
<a href="#l51.631"></a><span id="l51.631" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l51.632"></a><span id="l51.632" class="difflineplus">+    IMPORT_LOG0(</span>
<a href="#l51.633"></a><span id="l51.633" class="difflineplus">+        &quot;Failed to get the user profile directory from the address book &quot;</span>
<a href="#l51.634"></a><span id="l51.634" class="difflineplus">+        &quot;session\n&quot;);</span>
<a href="#l51.635"></a><span id="l51.635">   }</span>
<a href="#l51.636"></a><span id="l51.636"> </span>
<a href="#l51.637"></a><span id="l51.637" class="difflineminus">-  if (pDatabase &amp;&amp; dbPath)</span>
<a href="#l51.638"></a><span id="l51.638" class="difflineminus">-  {</span>
<a href="#l51.639"></a><span id="l51.639" class="difflineplus">+  if (pDatabase &amp;&amp; dbPath) {</span>
<a href="#l51.640"></a><span id="l51.640">     // We made a database, add it to the UI?!?!?!?!?!?!</span>
<a href="#l51.641"></a><span id="l51.641">     // This is major bogosity again!  Why doesn't the address book</span>
<a href="#l51.642"></a><span id="l51.642">     // just handle this properly for me?  Uggggg...</span>
<a href="#l51.643"></a><span id="l51.643"> </span>
<a href="#l51.644"></a><span id="l51.644">     nsCOMPtr&lt;nsIAbDirectory&gt; parentDir;</span>
<a href="#l51.645"></a><span id="l51.645">     abManager-&gt;GetDirectory(NS_LITERAL_CSTRING(kAllDirectoryRoot),</span>
<a href="#l51.646"></a><span id="l51.646">                             getter_AddRefs(parentDir));</span>
<a href="#l51.647"></a><span id="l51.647" class="difflineminus">-    if (parentDir)</span>
<a href="#l51.648"></a><span id="l51.648" class="difflineminus">-    {</span>
<a href="#l51.649"></a><span id="l51.649" class="difflineplus">+    if (parentDir) {</span>
<a href="#l51.650"></a><span id="l51.650">       nsAutoCString URI(&quot;moz-abmdbdirectory://&quot;);</span>
<a href="#l51.651"></a><span id="l51.651">       nsAutoCString leafName;</span>
<a href="#l51.652"></a><span id="l51.652">       rv = dbPath-&gt;GetNativeLeafName(leafName);</span>
<a href="#l51.653"></a><span id="l51.653">       if (NS_FAILED(rv))</span>
<a href="#l51.654"></a><span id="l51.654">         IMPORT_LOG0(&quot;*** Error: Unable to get name of database file\n&quot;);</span>
<a href="#l51.655"></a><span id="l51.655" class="difflineminus">-      else</span>
<a href="#l51.656"></a><span id="l51.656" class="difflineminus">-      {</span>
<a href="#l51.657"></a><span id="l51.657" class="difflineplus">+      else {</span>
<a href="#l51.658"></a><span id="l51.658">         URI.Append(leafName);</span>
<a href="#l51.659"></a><span id="l51.659">         rv = parentDir-&gt;CreateDirectoryByURI(nsDependentString(name), URI);</span>
<a href="#l51.660"></a><span id="l51.660">         if (NS_FAILED(rv))</span>
<a href="#l51.661"></a><span id="l51.661">           IMPORT_LOG0(&quot;*** Error: Unable to create address book directory\n&quot;);</span>
<a href="#l51.662"></a><span id="l51.662">       }</span>
<a href="#l51.663"></a><span id="l51.663">     }</span>
<a href="#l51.664"></a><span id="l51.664"> </span>
<a href="#l51.665"></a><span id="l51.665">     if (NS_SUCCEEDED(rv))</span>
<a href="#l51.666"></a><span id="l51.666">       IMPORT_LOG0(&quot;Added new address book to the UI\n&quot;);</span>
<a href="#l51.667"></a><span id="l51.667">     else</span>
<a href="#l51.668"></a><span id="l51.668" class="difflineminus">-      IMPORT_LOG0(&quot;*** Error: An error occurred while adding the address book to the UI\n&quot;);</span>
<a href="#l51.669"></a><span id="l51.669" class="difflineplus">+      IMPORT_LOG0(</span>
<a href="#l51.670"></a><span id="l51.670" class="difflineplus">+          &quot;*** Error: An error occurred while adding the address book to the &quot;</span>
<a href="#l51.671"></a><span id="l51.671" class="difflineplus">+          &quot;UI\n&quot;);</span>
<a href="#l51.672"></a><span id="l51.672">   }</span>
<a href="#l51.673"></a><span id="l51.673"> </span>
<a href="#l51.674"></a><span id="l51.674">   return pDatabase.forget();</span>
<a href="#l51.675"></a><span id="l51.675"> }</span>
<a href="#l51.676"></a><span id="l51.676"> </span>
<a href="#l51.677"></a><span id="l51.677" class="difflineminus">-NS_IMETHODIMP nsImportGenericAddressBooks::BeginImport(nsISupportsString *successLog, nsISupportsString *errorLog, bool *_retval)</span>
<a href="#l51.678"></a><span id="l51.678" class="difflineminus">-{</span>
<a href="#l51.679"></a><span id="l51.679" class="difflineplus">+NS_IMETHODIMP nsImportGenericAddressBooks::BeginImport(</span>
<a href="#l51.680"></a><span id="l51.680" class="difflineplus">+    nsISupportsString *successLog, nsISupportsString *errorLog, bool *_retval) {</span>
<a href="#l51.681"></a><span id="l51.681">   NS_ASSERTION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l51.682"></a><span id="l51.682" class="difflineminus">-  if (!_retval)</span>
<a href="#l51.683"></a><span id="l51.683" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l51.684"></a><span id="l51.684" class="difflineplus">+  if (!_retval) return NS_ERROR_NULL_POINTER;</span>
<a href="#l51.685"></a><span id="l51.685"> </span>
<a href="#l51.686"></a><span id="l51.686" class="difflineminus">-  nsString  success;</span>
<a href="#l51.687"></a><span id="l51.687" class="difflineminus">-  nsString  error;</span>
<a href="#l51.688"></a><span id="l51.688" class="difflineplus">+  nsString success;</span>
<a href="#l51.689"></a><span id="l51.689" class="difflineplus">+  nsString error;</span>
<a href="#l51.690"></a><span id="l51.690"> </span>
<a href="#l51.691"></a><span id="l51.691">   if (!m_doImport) {</span>
<a href="#l51.692"></a><span id="l51.692">     *_retval = true;</span>
<a href="#l51.693"></a><span id="l51.693">     nsImportStringBundle::GetStringByID(IMPORT_NO_ADDRBOOKS, m_stringBundle,</span>
<a href="#l51.694"></a><span id="l51.694">                                         success);</span>
<a href="#l51.695"></a><span id="l51.695">     SetLogs(success, error, successLog, errorLog);</span>
<a href="#l51.696"></a><span id="l51.696">     return NS_OK;</span>
<a href="#l51.697"></a><span id="l51.697">   }</span>
<a href="#l51.698"></a><span id="l51.698" class="difflineat">@@ -604,23 +561,20 @@ NS_IMETHODIMP nsImportGenericAddressBook</span>
<a href="#l51.699"></a><span id="l51.699">   m_pThreadData-&gt;pDestinationUri = m_pDestinationUri;</span>
<a href="#l51.700"></a><span id="l51.700"> </span>
<a href="#l51.701"></a><span id="l51.701">   uint32_t count = 0;</span>
<a href="#l51.702"></a><span id="l51.702">   m_Books-&gt;GetLength(&amp;count);</span>
<a href="#l51.703"></a><span id="l51.703">   // Create/obtain any address books that we need here, so that we don't need</span>
<a href="#l51.704"></a><span id="l51.704">   // to do so inside the import thread which would just proxy the create</span>
<a href="#l51.705"></a><span id="l51.705">   // operations back to the main thread anyway.</span>
<a href="#l51.706"></a><span id="l51.706">   nsCOMPtr&lt;nsIAddrDatabase&gt; db = GetAddressBookFromUri(m_pDestinationUri.get());</span>
<a href="#l51.707"></a><span id="l51.707" class="difflineminus">-  for (uint32_t i = 0; i &lt; count; ++i)</span>
<a href="#l51.708"></a><span id="l51.708" class="difflineminus">-  {</span>
<a href="#l51.709"></a><span id="l51.709" class="difflineplus">+  for (uint32_t i = 0; i &lt; count; ++i) {</span>
<a href="#l51.710"></a><span id="l51.710">     nsCOMPtr&lt;nsIImportABDescriptor&gt; book = do_QueryElementAt(m_Books, i);</span>
<a href="#l51.711"></a><span id="l51.711" class="difflineminus">-    if (book)</span>
<a href="#l51.712"></a><span id="l51.712" class="difflineminus">-    {</span>
<a href="#l51.713"></a><span id="l51.713" class="difflineminus">-      if (!db)</span>
<a href="#l51.714"></a><span id="l51.714" class="difflineminus">-      {</span>
<a href="#l51.715"></a><span id="l51.715" class="difflineplus">+    if (book) {</span>
<a href="#l51.716"></a><span id="l51.716" class="difflineplus">+      if (!db) {</span>
<a href="#l51.717"></a><span id="l51.717">         nsString name;</span>
<a href="#l51.718"></a><span id="l51.718">         book-&gt;GetPreferredName(name);</span>
<a href="#l51.719"></a><span id="l51.719">         db = GetAddressBook(name.get(), true);</span>
<a href="#l51.720"></a><span id="l51.720">       }</span>
<a href="#l51.721"></a><span id="l51.721">       m_DBs.AppendObject(db);</span>
<a href="#l51.722"></a><span id="l51.722">     }</span>
<a href="#l51.723"></a><span id="l51.723">   }</span>
<a href="#l51.724"></a><span id="l51.724">   m_pThreadData-&gt;dBs = &amp;m_DBs;</span>
<a href="#l51.725"></a><span id="l51.725" class="difflineat">@@ -633,134 +587,115 @@ NS_IMETHODIMP nsImportGenericAddressBook</span>
<a href="#l51.726"></a><span id="l51.726">   ImportAddressThread(m_pThreadData);</span>
<a href="#l51.727"></a><span id="l51.727">   delete m_pThreadData;</span>
<a href="#l51.728"></a><span id="l51.728">   m_pThreadData = nullptr;</span>
<a href="#l51.729"></a><span id="l51.729">   *_retval = true;</span>
<a href="#l51.730"></a><span id="l51.730"> </span>
<a href="#l51.731"></a><span id="l51.731">   return NS_OK;</span>
<a href="#l51.732"></a><span id="l51.732"> }</span>
<a href="#l51.733"></a><span id="l51.733"> </span>
<a href="#l51.734"></a><span id="l51.734" class="difflineminus">-NS_IMETHODIMP nsImportGenericAddressBooks::ContinueImport(bool *_retval)</span>
<a href="#l51.735"></a><span id="l51.735" class="difflineminus">-{</span>
<a href="#l51.736"></a><span id="l51.736" class="difflineplus">+NS_IMETHODIMP nsImportGenericAddressBooks::ContinueImport(bool *_retval) {</span>
<a href="#l51.737"></a><span id="l51.737">   NS_ASSERTION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l51.738"></a><span id="l51.738" class="difflineminus">-  if (!_retval)</span>
<a href="#l51.739"></a><span id="l51.739" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l51.740"></a><span id="l51.740" class="difflineplus">+  if (!_retval) return NS_ERROR_NULL_POINTER;</span>
<a href="#l51.741"></a><span id="l51.741"> </span>
<a href="#l51.742"></a><span id="l51.742">   *_retval = true;</span>
<a href="#l51.743"></a><span id="l51.743">   if (m_pThreadData) {</span>
<a href="#l51.744"></a><span id="l51.744" class="difflineminus">-    if (m_pThreadData-&gt;fatalError)</span>
<a href="#l51.745"></a><span id="l51.745" class="difflineminus">-      *_retval = false;</span>
<a href="#l51.746"></a><span id="l51.746" class="difflineplus">+    if (m_pThreadData-&gt;fatalError) *_retval = false;</span>
<a href="#l51.747"></a><span id="l51.747">   }</span>
<a href="#l51.748"></a><span id="l51.748"> </span>
<a href="#l51.749"></a><span id="l51.749">   return NS_OK;</span>
<a href="#l51.750"></a><span id="l51.750"> }</span>
<a href="#l51.751"></a><span id="l51.751"> </span>
<a href="#l51.752"></a><span id="l51.752" class="difflineminus">-</span>
<a href="#l51.753"></a><span id="l51.753" class="difflineminus">-NS_IMETHODIMP nsImportGenericAddressBooks::GetProgress(int32_t *_retval)</span>
<a href="#l51.754"></a><span id="l51.754" class="difflineminus">-{</span>
<a href="#l51.755"></a><span id="l51.755" class="difflineplus">+NS_IMETHODIMP nsImportGenericAddressBooks::GetProgress(int32_t *_retval) {</span>
<a href="#l51.756"></a><span id="l51.756">   // This returns the progress from the the currently</span>
<a href="#l51.757"></a><span id="l51.757">   // running import mail or import address book thread.</span>
<a href="#l51.758"></a><span id="l51.758">   NS_ASSERTION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l51.759"></a><span id="l51.759" class="difflineminus">-  if (!_retval)</span>
<a href="#l51.760"></a><span id="l51.760" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l51.761"></a><span id="l51.761" class="difflineplus">+  if (!_retval) return NS_ERROR_NULL_POINTER;</span>
<a href="#l51.762"></a><span id="l51.762"> </span>
<a href="#l51.763"></a><span id="l51.763">   if (!m_pThreadData || !(m_pThreadData-&gt;threadAlive)) {</span>
<a href="#l51.764"></a><span id="l51.764">     *_retval = 100;</span>
<a href="#l51.765"></a><span id="l51.765">     return NS_OK;</span>
<a href="#l51.766"></a><span id="l51.766">   }</span>
<a href="#l51.767"></a><span id="l51.767"> </span>
<a href="#l51.768"></a><span id="l51.768">   uint32_t sz = 0;</span>
<a href="#l51.769"></a><span id="l51.769">   if (m_pThreadData-&gt;currentSize &amp;&amp; m_pInterface) {</span>
<a href="#l51.770"></a><span id="l51.770" class="difflineminus">-    if (NS_FAILED(m_pInterface-&gt;GetImportProgress(&amp;sz)))</span>
<a href="#l51.771"></a><span id="l51.771" class="difflineminus">-      sz = 0;</span>
<a href="#l51.772"></a><span id="l51.772" class="difflineplus">+    if (NS_FAILED(m_pInterface-&gt;GetImportProgress(&amp;sz))) sz = 0;</span>
<a href="#l51.773"></a><span id="l51.773">   }</span>
<a href="#l51.774"></a><span id="l51.774"> </span>
<a href="#l51.775"></a><span id="l51.775">   if (m_totalSize)</span>
<a href="#l51.776"></a><span id="l51.776">     *_retval = ((m_pThreadData-&gt;currentTotal + sz) * 100) / m_totalSize;</span>
<a href="#l51.777"></a><span id="l51.777">   else</span>
<a href="#l51.778"></a><span id="l51.778">     *_retval = 0;</span>
<a href="#l51.779"></a><span id="l51.779"> </span>
<a href="#l51.780"></a><span id="l51.780">   // never return less than 5 so it looks like we are doing something!</span>
<a href="#l51.781"></a><span id="l51.781" class="difflineminus">-  if (*_retval &lt; 5)</span>
<a href="#l51.782"></a><span id="l51.782" class="difflineminus">-    *_retval = 5;</span>
<a href="#l51.783"></a><span id="l51.783" class="difflineplus">+  if (*_retval &lt; 5) *_retval = 5;</span>
<a href="#l51.784"></a><span id="l51.784"> </span>
<a href="#l51.785"></a><span id="l51.785">   // as long as the thread is alive don't return completely</span>
<a href="#l51.786"></a><span id="l51.786">   // done.</span>
<a href="#l51.787"></a><span id="l51.787" class="difflineminus">-  if (*_retval &gt; 99)</span>
<a href="#l51.788"></a><span id="l51.788" class="difflineminus">-    *_retval = 99;</span>
<a href="#l51.789"></a><span id="l51.789" class="difflineplus">+  if (*_retval &gt; 99) *_retval = 99;</span>
<a href="#l51.790"></a><span id="l51.790"> </span>
<a href="#l51.791"></a><span id="l51.791">   return NS_OK;</span>
<a href="#l51.792"></a><span id="l51.792"> }</span>
<a href="#l51.793"></a><span id="l51.793"> </span>
<a href="#l51.794"></a><span id="l51.794" class="difflineminus">-</span>
<a href="#l51.795"></a><span id="l51.795" class="difflineminus">-NS_IMETHODIMP nsImportGenericAddressBooks::CancelImport(void)</span>
<a href="#l51.796"></a><span id="l51.796" class="difflineminus">-{</span>
<a href="#l51.797"></a><span id="l51.797" class="difflineplus">+NS_IMETHODIMP nsImportGenericAddressBooks::CancelImport(void) {</span>
<a href="#l51.798"></a><span id="l51.798">   if (m_pThreadData) {</span>
<a href="#l51.799"></a><span id="l51.799">     m_pThreadData-&gt;abort = true;</span>
<a href="#l51.800"></a><span id="l51.800">     m_pThreadData = nullptr;</span>
<a href="#l51.801"></a><span id="l51.801">   }</span>
<a href="#l51.802"></a><span id="l51.802"> </span>
<a href="#l51.803"></a><span id="l51.803">   return NS_OK;</span>
<a href="#l51.804"></a><span id="l51.804"> }</span>
<a href="#l51.805"></a><span id="l51.805"> </span>
<a href="#l51.806"></a><span id="l51.806" class="difflineminus">-</span>
<a href="#l51.807"></a><span id="l51.807" class="difflineminus">-AddressThreadData::AddressThreadData()</span>
<a href="#l51.808"></a><span id="l51.808" class="difflineminus">-{</span>
<a href="#l51.809"></a><span id="l51.809" class="difflineplus">+AddressThreadData::AddressThreadData() {</span>
<a href="#l51.810"></a><span id="l51.810">   fatalError = false;</span>
<a href="#l51.811"></a><span id="l51.811">   driverAlive = true;</span>
<a href="#l51.812"></a><span id="l51.812">   threadAlive = true;</span>
<a href="#l51.813"></a><span id="l51.813">   abort = false;</span>
<a href="#l51.814"></a><span id="l51.814">   currentTotal = 0;</span>
<a href="#l51.815"></a><span id="l51.815">   currentSize = 0;</span>
<a href="#l51.816"></a><span id="l51.816"> }</span>
<a href="#l51.817"></a><span id="l51.817"> </span>
<a href="#l51.818"></a><span id="l51.818" class="difflineminus">-AddressThreadData::~AddressThreadData()</span>
<a href="#l51.819"></a><span id="l51.819" class="difflineminus">-{</span>
<a href="#l51.820"></a><span id="l51.820" class="difflineminus">-}</span>
<a href="#l51.821"></a><span id="l51.821" class="difflineplus">+AddressThreadData::~AddressThreadData() {}</span>
<a href="#l51.822"></a><span id="l51.822"> </span>
<a href="#l51.823"></a><span id="l51.823"> void nsImportGenericAddressBooks::ReportError(const char16_t *pName,</span>
<a href="#l51.824"></a><span id="l51.824">                                               nsString *pStream,</span>
<a href="#l51.825"></a><span id="l51.825" class="difflineminus">-                                              nsIStringBundle* aBundle)</span>
<a href="#l51.826"></a><span id="l51.826" class="difflineminus">-{</span>
<a href="#l51.827"></a><span id="l51.827" class="difflineminus">-  if (!pStream)</span>
<a href="#l51.828"></a><span id="l51.828" class="difflineminus">-    return;</span>
<a href="#l51.829"></a><span id="l51.829" class="difflineplus">+                                              nsIStringBundle *aBundle) {</span>
<a href="#l51.830"></a><span id="l51.830" class="difflineplus">+  if (!pStream) return;</span>
<a href="#l51.831"></a><span id="l51.831">   // load the error string</span>
<a href="#l51.832"></a><span id="l51.832" class="difflineminus">-  char16_t *pFmt = nsImportStringBundle::GetStringByID(IMPORT_ERROR_GETABOOK, aBundle);</span>
<a href="#l51.833"></a><span id="l51.833" class="difflineplus">+  char16_t *pFmt =</span>
<a href="#l51.834"></a><span id="l51.834" class="difflineplus">+      nsImportStringBundle::GetStringByID(IMPORT_ERROR_GETABOOK, aBundle);</span>
<a href="#l51.835"></a><span id="l51.835">   nsString pText;</span>
<a href="#l51.836"></a><span id="l51.836">   nsTextFormatter::ssprintf(pText, pFmt, pName);</span>
<a href="#l51.837"></a><span id="l51.837">   pStream-&gt;Append(pText);</span>
<a href="#l51.838"></a><span id="l51.838">   free(pFmt);</span>
<a href="#l51.839"></a><span id="l51.839">   pStream-&gt;AppendLiteral(MSG_LINEBREAK);</span>
<a href="#l51.840"></a><span id="l51.840"> }</span>
<a href="#l51.841"></a><span id="l51.841"> </span>
<a href="#l51.842"></a><span id="l51.842" class="difflineminus">-static void ImportAddressThread(void *stuff)</span>
<a href="#l51.843"></a><span id="l51.843" class="difflineminus">-{</span>
<a href="#l51.844"></a><span id="l51.844" class="difflineplus">+static void ImportAddressThread(void *stuff) {</span>
<a href="#l51.845"></a><span id="l51.845">   IMPORT_LOG0(&quot;In Begin ImportAddressThread\n&quot;);</span>
<a href="#l51.846"></a><span id="l51.846"> </span>
<a href="#l51.847"></a><span id="l51.847">   AddressThreadData *pData = (AddressThreadData *)stuff;</span>
<a href="#l51.848"></a><span id="l51.848" class="difflineminus">-  uint32_t          count = 0;</span>
<a href="#l51.849"></a><span id="l51.849" class="difflineminus">-  uint32_t          i;</span>
<a href="#l51.850"></a><span id="l51.850" class="difflineminus">-  bool              import;</span>
<a href="#l51.851"></a><span id="l51.851" class="difflineminus">-  uint32_t          size;</span>
<a href="#l51.852"></a><span id="l51.852" class="difflineplus">+  uint32_t count = 0;</span>
<a href="#l51.853"></a><span id="l51.853" class="difflineplus">+  uint32_t i;</span>
<a href="#l51.854"></a><span id="l51.854" class="difflineplus">+  bool import;</span>
<a href="#l51.855"></a><span id="l51.855" class="difflineplus">+  uint32_t size;</span>
<a href="#l51.856"></a><span id="l51.856"> </span>
<a href="#l51.857"></a><span id="l51.857" class="difflineminus">-  nsString          success;</span>
<a href="#l51.858"></a><span id="l51.858" class="difflineminus">-  nsString          error;</span>
<a href="#l51.859"></a><span id="l51.859" class="difflineplus">+  nsString success;</span>
<a href="#l51.860"></a><span id="l51.860" class="difflineplus">+  nsString error;</span>
<a href="#l51.861"></a><span id="l51.861"> </span>
<a href="#l51.862"></a><span id="l51.862" class="difflineminus">-  (void) pData-&gt;books-&gt;GetLength(&amp;count);</span>
<a href="#l51.863"></a><span id="l51.863" class="difflineplus">+  (void)pData-&gt;books-&gt;GetLength(&amp;count);</span>
<a href="#l51.864"></a><span id="l51.864"> </span>
<a href="#l51.865"></a><span id="l51.865">   for (i = 0; (i &lt; count) &amp;&amp; !(pData-&gt;abort); i++) {</span>
<a href="#l51.866"></a><span id="l51.866" class="difflineminus">-    nsCOMPtr&lt;nsIImportABDescriptor&gt; book =</span>
<a href="#l51.867"></a><span id="l51.867" class="difflineminus">-      do_QueryElementAt(pData-&gt;books, i);</span>
<a href="#l51.868"></a><span id="l51.868" class="difflineplus">+    nsCOMPtr&lt;nsIImportABDescriptor&gt; book = do_QueryElementAt(pData-&gt;books, i);</span>
<a href="#l51.869"></a><span id="l51.869"> </span>
<a href="#l51.870"></a><span id="l51.870">     if (book) {</span>
<a href="#l51.871"></a><span id="l51.871">       import = false;</span>
<a href="#l51.872"></a><span id="l51.872">       size = 0;</span>
<a href="#l51.873"></a><span id="l51.873">       nsresult rv = book-&gt;GetImport(&amp;import);</span>
<a href="#l51.874"></a><span id="l51.874" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; import)</span>
<a href="#l51.875"></a><span id="l51.875" class="difflineminus">-        rv = book-&gt;GetSize(&amp;size);</span>
<a href="#l51.876"></a><span id="l51.876" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; import) rv = book-&gt;GetSize(&amp;size);</span>
<a href="#l51.877"></a><span id="l51.877"> </span>
<a href="#l51.878"></a><span id="l51.878">       if (NS_SUCCEEDED(rv) &amp;&amp; size &amp;&amp; import) {</span>
<a href="#l51.879"></a><span id="l51.879">         nsString name;</span>
<a href="#l51.880"></a><span id="l51.880">         book-&gt;GetPreferredName(name);</span>
<a href="#l51.881"></a><span id="l51.881"> </span>
<a href="#l51.882"></a><span id="l51.882">         nsCOMPtr&lt;nsIAddrDatabase&gt; db = pData-&gt;dBs-&gt;ObjectAt(i);</span>
<a href="#l51.883"></a><span id="l51.883"> </span>
<a href="#l51.884"></a><span id="l51.884">         bool fatalError = false;</span>
<a href="#l51.885"></a><span id="l51.885" class="difflineat">@@ -774,57 +709,52 @@ static void ImportAddressThread(void *st</span>
<a href="#l51.886"></a><span id="l51.886">             int32_t    sz = 0;</span>
<a href="#l51.887"></a><span id="l51.887">             int32_t    mapIndex;</span>
<a href="#l51.888"></a><span id="l51.888">             bool      active;</span>
<a href="#l51.889"></a><span id="l51.889">             pData-&gt;fieldMap-&gt;GetMapSize(&amp;sz);</span>
<a href="#l51.890"></a><span id="l51.890">             IMPORT_LOG1(&quot;**** Field Map Size: %d\n&quot;, (int) sz);</span>
<a href="#l51.891"></a><span id="l51.891">             for (int32_t i = 0; i &lt; sz; i++) {</span>
<a href="#l51.892"></a><span id="l51.892">               pData-&gt;fieldMap-&gt;GetFieldMap(i, &amp;mapIndex);</span>
<a href="#l51.893"></a><span id="l51.893">               pData-&gt;fieldMap-&gt;GetFieldActive(i, &amp;active);</span>
<a href="#l51.894"></a><span id="l51.894" class="difflineminus">-              IMPORT_LOG3(&quot;Field map #%d: index=%d, active=%d\n&quot;, (int) i, (int) mapIndex, (int) active);</span>
<a href="#l51.895"></a><span id="l51.895" class="difflineplus">+              IMPORT_LOG3(&quot;Field map #%d: index=%d, active=%d\n&quot;, (int) i, (int)</span>
<a href="#l51.896"></a><span id="l51.896" class="difflineplus">+          mapIndex, (int) active);</span>
<a href="#l51.897"></a><span id="l51.897">             }</span>
<a href="#l51.898"></a><span id="l51.898">           }</span>
<a href="#l51.899"></a><span id="l51.899">           */</span>
<a href="#l51.900"></a><span id="l51.900"> </span>
<a href="#l51.901"></a><span id="l51.901" class="difflineminus">-          rv = pData-&gt;addressImport-&gt;ImportAddressBook(book,</span>
<a href="#l51.902"></a><span id="l51.902" class="difflineminus">-                                                       db,</span>
<a href="#l51.903"></a><span id="l51.903" class="difflineminus">-                                                       pData-&gt;fieldMap,</span>
<a href="#l51.904"></a><span id="l51.904" class="difflineminus">-                                                       pData-&gt;ldifService,</span>
<a href="#l51.905"></a><span id="l51.905" class="difflineminus">-                                                       &amp;pError,</span>
<a href="#l51.906"></a><span id="l51.906" class="difflineminus">-                                                       &amp;pSuccess,</span>
<a href="#l51.907"></a><span id="l51.907" class="difflineminus">-                                                       &amp;fatalError);</span>
<a href="#l51.908"></a><span id="l51.908" class="difflineplus">+          rv = pData-&gt;addressImport-&gt;ImportAddressBook(</span>
<a href="#l51.909"></a><span id="l51.909" class="difflineplus">+              book, db, pData-&gt;fieldMap, pData-&gt;ldifService, &amp;pError, &amp;pSuccess,</span>
<a href="#l51.910"></a><span id="l51.910" class="difflineplus">+              &amp;fatalError);</span>
<a href="#l51.911"></a><span id="l51.911">           if (NS_SUCCEEDED(rv) &amp;&amp; pSuccess) {</span>
<a href="#l51.912"></a><span id="l51.912">             success.Append(pSuccess);</span>
<a href="#l51.913"></a><span id="l51.913">             free(pSuccess);</span>
<a href="#l51.914"></a><span id="l51.914">           }</span>
<a href="#l51.915"></a><span id="l51.915">           if (pError) {</span>
<a href="#l51.916"></a><span id="l51.916">             error.Append(pError);</span>
<a href="#l51.917"></a><span id="l51.917">             free(pError);</span>
<a href="#l51.918"></a><span id="l51.918">           }</span>
<a href="#l51.919"></a><span id="l51.919" class="difflineminus">-        }</span>
<a href="#l51.920"></a><span id="l51.920" class="difflineminus">-        else {</span>
<a href="#l51.921"></a><span id="l51.921" class="difflineminus">-          nsImportGenericAddressBooks::ReportError(name.get(), &amp;error, pData-&gt;stringBundle);</span>
<a href="#l51.922"></a><span id="l51.922" class="difflineplus">+        } else {</span>
<a href="#l51.923"></a><span id="l51.923" class="difflineplus">+          nsImportGenericAddressBooks::ReportError(name.get(), &amp;error,</span>
<a href="#l51.924"></a><span id="l51.924" class="difflineplus">+                                                   pData-&gt;stringBundle);</span>
<a href="#l51.925"></a><span id="l51.925">         }</span>
<a href="#l51.926"></a><span id="l51.926"> </span>
<a href="#l51.927"></a><span id="l51.927">         pData-&gt;currentSize = 0;</span>
<a href="#l51.928"></a><span id="l51.928">         pData-&gt;currentTotal += size;</span>
<a href="#l51.929"></a><span id="l51.929"> </span>
<a href="#l51.930"></a><span id="l51.930" class="difflineminus">-        if (db)</span>
<a href="#l51.931"></a><span id="l51.931" class="difflineminus">-          db-&gt;Close(true);</span>
<a href="#l51.932"></a><span id="l51.932" class="difflineplus">+        if (db) db-&gt;Close(true);</span>
<a href="#l51.933"></a><span id="l51.933"> </span>
<a href="#l51.934"></a><span id="l51.934">         if (fatalError) {</span>
<a href="#l51.935"></a><span id="l51.935">           pData-&gt;fatalError = true;</span>
<a href="#l51.936"></a><span id="l51.936">           break;</span>
<a href="#l51.937"></a><span id="l51.937">         }</span>
<a href="#l51.938"></a><span id="l51.938">       }</span>
<a href="#l51.939"></a><span id="l51.939">     }</span>
<a href="#l51.940"></a><span id="l51.940">   }</span>
<a href="#l51.941"></a><span id="l51.941"> </span>
<a href="#l51.942"></a><span id="l51.942" class="difflineminus">-</span>
<a href="#l51.943"></a><span id="l51.943" class="difflineminus">-  nsImportGenericAddressBooks::SetLogs(success, error, pData-&gt;successLog, pData-&gt;errorLog);</span>
<a href="#l51.944"></a><span id="l51.944" class="difflineplus">+  nsImportGenericAddressBooks::SetLogs(success, error, pData-&gt;successLog,</span>
<a href="#l51.945"></a><span id="l51.945" class="difflineplus">+                                       pData-&gt;errorLog);</span>
<a href="#l51.946"></a><span id="l51.946"> </span>
<a href="#l51.947"></a><span id="l51.947">   if (pData-&gt;abort || pData-&gt;fatalError) {</span>
<a href="#l51.948"></a><span id="l51.948">     // FIXME: do what is necessary to get rid of what has been imported so far.</span>
<a href="#l51.949"></a><span id="l51.949">     // Nothing if we went into an existing address book!  Otherwise, delete</span>
<a href="#l51.950"></a><span id="l51.950">     // the ones we created?</span>
<a href="#l51.951"></a><span id="l51.951">   }</span>
<a href="#l51.952"></a><span id="l51.952" class="difflineminus">-</span>
<a href="#l51.953"></a><span id="l51.953"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l52.1"></a><span id="l52.1" class="difflineminus">--- a/mailnews/import/src/nsImportEmbeddedImageData.cpp</span>
<a href="#l52.2"></a><span id="l52.2" class="difflineplus">+++ b/mailnews/import/src/nsImportEmbeddedImageData.cpp</span>
<a href="#l52.3"></a><span id="l52.3" class="difflineat">@@ -2,63 +2,51 @@</span>
<a href="#l52.4"></a><span id="l52.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l52.5"></a><span id="l52.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l52.6"></a><span id="l52.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l52.7"></a><span id="l52.7"> </span>
<a href="#l52.8"></a><span id="l52.8"> #include &quot;nsImportEmbeddedImageData.h&quot;</span>
<a href="#l52.9"></a><span id="l52.9"> </span>
<a href="#l52.10"></a><span id="l52.10"> NS_IMPL_ISUPPORTS(nsImportEmbeddedImageData, nsIMsgEmbeddedImageData)</span>
<a href="#l52.11"></a><span id="l52.11"> </span>
<a href="#l52.12"></a><span id="l52.12" class="difflineminus">-nsImportEmbeddedImageData::nsImportEmbeddedImageData()</span>
<a href="#l52.13"></a><span id="l52.13" class="difflineminus">-{</span>
<a href="#l52.14"></a><span id="l52.14" class="difflineminus">-}</span>
<a href="#l52.15"></a><span id="l52.15" class="difflineplus">+nsImportEmbeddedImageData::nsImportEmbeddedImageData() {}</span>
<a href="#l52.16"></a><span id="l52.16"> </span>
<a href="#l52.17"></a><span id="l52.17" class="difflineminus">-nsImportEmbeddedImageData::nsImportEmbeddedImageData(</span>
<a href="#l52.18"></a><span id="l52.18" class="difflineminus">-  nsIURI *aUri, const nsACString &amp;aCid) : m_uri(aUri), m_cid(aCid)</span>
<a href="#l52.19"></a><span id="l52.19" class="difflineminus">-{</span>
<a href="#l52.20"></a><span id="l52.20" class="difflineminus">-}</span>
<a href="#l52.21"></a><span id="l52.21" class="difflineplus">+nsImportEmbeddedImageData::nsImportEmbeddedImageData(nsIURI *aUri,</span>
<a href="#l52.22"></a><span id="l52.22" class="difflineplus">+                                                     const nsACString &amp;aCid)</span>
<a href="#l52.23"></a><span id="l52.23" class="difflineplus">+    : m_uri(aUri), m_cid(aCid) {}</span>
<a href="#l52.24"></a><span id="l52.24"> </span>
<a href="#l52.25"></a><span id="l52.25" class="difflineminus">-nsImportEmbeddedImageData::nsImportEmbeddedImageData(</span>
<a href="#l52.26"></a><span id="l52.26" class="difflineminus">-  nsIURI *aUri, const nsACString &amp;aCid, const nsACString &amp;aName)</span>
<a href="#l52.27"></a><span id="l52.27" class="difflineminus">-  : m_uri(aUri), m_cid(aCid), m_name(aName)</span>
<a href="#l52.28"></a><span id="l52.28" class="difflineminus">-{</span>
<a href="#l52.29"></a><span id="l52.29" class="difflineminus">-}</span>
<a href="#l52.30"></a><span id="l52.30" class="difflineplus">+nsImportEmbeddedImageData::nsImportEmbeddedImageData(nsIURI *aUri,</span>
<a href="#l52.31"></a><span id="l52.31" class="difflineplus">+                                                     const nsACString &amp;aCid,</span>
<a href="#l52.32"></a><span id="l52.32" class="difflineplus">+                                                     const nsACString &amp;aName)</span>
<a href="#l52.33"></a><span id="l52.33" class="difflineplus">+    : m_uri(aUri), m_cid(aCid), m_name(aName) {}</span>
<a href="#l52.34"></a><span id="l52.34"> </span>
<a href="#l52.35"></a><span id="l52.35" class="difflineminus">-nsImportEmbeddedImageData::~nsImportEmbeddedImageData()</span>
<a href="#l52.36"></a><span id="l52.36" class="difflineminus">-{</span>
<a href="#l52.37"></a><span id="l52.37" class="difflineminus">-}</span>
<a href="#l52.38"></a><span id="l52.38" class="difflineplus">+nsImportEmbeddedImageData::~nsImportEmbeddedImageData() {}</span>
<a href="#l52.39"></a><span id="l52.39"> </span>
<a href="#l52.40"></a><span id="l52.40" class="difflineminus">-NS_IMETHODIMP nsImportEmbeddedImageData::GetUri(nsIURI **aUri)</span>
<a href="#l52.41"></a><span id="l52.41" class="difflineminus">-{</span>
<a href="#l52.42"></a><span id="l52.42" class="difflineplus">+NS_IMETHODIMP nsImportEmbeddedImageData::GetUri(nsIURI **aUri) {</span>
<a href="#l52.43"></a><span id="l52.43">   NS_ENSURE_ARG_POINTER(aUri);</span>
<a href="#l52.44"></a><span id="l52.44">   NS_IF_ADDREF(*aUri = m_uri);</span>
<a href="#l52.45"></a><span id="l52.45">   return NS_OK;</span>
<a href="#l52.46"></a><span id="l52.46"> }</span>
<a href="#l52.47"></a><span id="l52.47"> </span>
<a href="#l52.48"></a><span id="l52.48" class="difflineminus">-NS_IMETHODIMP nsImportEmbeddedImageData::SetUri(nsIURI *aUri)</span>
<a href="#l52.49"></a><span id="l52.49" class="difflineminus">-{</span>
<a href="#l52.50"></a><span id="l52.50" class="difflineplus">+NS_IMETHODIMP nsImportEmbeddedImageData::SetUri(nsIURI *aUri) {</span>
<a href="#l52.51"></a><span id="l52.51">   m_uri = aUri;</span>
<a href="#l52.52"></a><span id="l52.52">   return NS_OK;</span>
<a href="#l52.53"></a><span id="l52.53"> }</span>
<a href="#l52.54"></a><span id="l52.54"> </span>
<a href="#l52.55"></a><span id="l52.55" class="difflineminus">-NS_IMETHODIMP nsImportEmbeddedImageData::GetCid(nsACString &amp;aCid)</span>
<a href="#l52.56"></a><span id="l52.56" class="difflineminus">-{</span>
<a href="#l52.57"></a><span id="l52.57" class="difflineplus">+NS_IMETHODIMP nsImportEmbeddedImageData::GetCid(nsACString &amp;aCid) {</span>
<a href="#l52.58"></a><span id="l52.58">   aCid = m_cid;</span>
<a href="#l52.59"></a><span id="l52.59">   return NS_OK;</span>
<a href="#l52.60"></a><span id="l52.60"> }</span>
<a href="#l52.61"></a><span id="l52.61"> </span>
<a href="#l52.62"></a><span id="l52.62" class="difflineminus">-NS_IMETHODIMP nsImportEmbeddedImageData::SetCid(const nsACString &amp;aCid)</span>
<a href="#l52.63"></a><span id="l52.63" class="difflineminus">-{</span>
<a href="#l52.64"></a><span id="l52.64" class="difflineplus">+NS_IMETHODIMP nsImportEmbeddedImageData::SetCid(const nsACString &amp;aCid) {</span>
<a href="#l52.65"></a><span id="l52.65">   m_cid = aCid;</span>
<a href="#l52.66"></a><span id="l52.66">   return NS_OK;</span>
<a href="#l52.67"></a><span id="l52.67"> }</span>
<a href="#l52.68"></a><span id="l52.68"> </span>
<a href="#l52.69"></a><span id="l52.69" class="difflineminus">-NS_IMETHODIMP nsImportEmbeddedImageData::GetName(nsACString &amp;aName)</span>
<a href="#l52.70"></a><span id="l52.70" class="difflineminus">-{</span>
<a href="#l52.71"></a><span id="l52.71" class="difflineplus">+NS_IMETHODIMP nsImportEmbeddedImageData::GetName(nsACString &amp;aName) {</span>
<a href="#l52.72"></a><span id="l52.72">   aName = m_name;</span>
<a href="#l52.73"></a><span id="l52.73">   return NS_OK;</span>
<a href="#l52.74"></a><span id="l52.74"> }</span>
<a href="#l52.75"></a><span id="l52.75"> </span>
<a href="#l52.76"></a><span id="l52.76" class="difflineminus">-NS_IMETHODIMP nsImportEmbeddedImageData::SetName(const nsACString &amp;aName)</span>
<a href="#l52.77"></a><span id="l52.77" class="difflineminus">-{</span>
<a href="#l52.78"></a><span id="l52.78" class="difflineplus">+NS_IMETHODIMP nsImportEmbeddedImageData::SetName(const nsACString &amp;aName) {</span>
<a href="#l52.79"></a><span id="l52.79">   m_name = aName;</span>
<a href="#l52.80"></a><span id="l52.80">   return NS_OK;</span>
<a href="#l52.81"></a><span id="l52.81"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l53.1"></a><span id="l53.1" class="difflineminus">--- a/mailnews/import/src/nsImportEmbeddedImageData.h</span>
<a href="#l53.2"></a><span id="l53.2" class="difflineplus">+++ b/mailnews/import/src/nsImportEmbeddedImageData.h</span>
<a href="#l53.3"></a><span id="l53.3" class="difflineat">@@ -6,27 +6,26 @@</span>
<a href="#l53.4"></a><span id="l53.4"> #ifndef __IMPORTEMBEDDEDIMAGETDATA_H__</span>
<a href="#l53.5"></a><span id="l53.5"> #define __IMPORTEMBEDDEDIMAGETDATA_H__</span>
<a href="#l53.6"></a><span id="l53.6"> </span>
<a href="#l53.7"></a><span id="l53.7"> #include &quot;nsIMsgSend.h&quot;</span>
<a href="#l53.8"></a><span id="l53.8"> #include &quot;nsString.h&quot;</span>
<a href="#l53.9"></a><span id="l53.9"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l53.10"></a><span id="l53.10"> #include &quot;nsIURI.h&quot;</span>
<a href="#l53.11"></a><span id="l53.11"> </span>
<a href="#l53.12"></a><span id="l53.12" class="difflineminus">-class nsImportEmbeddedImageData final : public nsIMsgEmbeddedImageData</span>
<a href="#l53.13"></a><span id="l53.13" class="difflineminus">-{</span>
<a href="#l53.14"></a><span id="l53.14" class="difflineminus">-public:</span>
<a href="#l53.15"></a><span id="l53.15" class="difflineplus">+class nsImportEmbeddedImageData final : public nsIMsgEmbeddedImageData {</span>
<a href="#l53.16"></a><span id="l53.16" class="difflineplus">+ public:</span>
<a href="#l53.17"></a><span id="l53.17">   nsImportEmbeddedImageData(nsIURI *aUri, const nsACString &amp;aCID);</span>
<a href="#l53.18"></a><span id="l53.18" class="difflineminus">-  nsImportEmbeddedImageData(nsIURI *aUri, const nsACString &amp;aCID, const nsACString &amp;aName);</span>
<a href="#l53.19"></a><span id="l53.19" class="difflineplus">+  nsImportEmbeddedImageData(nsIURI *aUri, const nsACString &amp;aCID,</span>
<a href="#l53.20"></a><span id="l53.20" class="difflineplus">+                            const nsACString &amp;aName);</span>
<a href="#l53.21"></a><span id="l53.21">   nsImportEmbeddedImageData();</span>
<a href="#l53.22"></a><span id="l53.22">   NS_DECL_NSIMSGEMBEDDEDIMAGEDATA</span>
<a href="#l53.23"></a><span id="l53.23">   NS_DECL_ISUPPORTS</span>
<a href="#l53.24"></a><span id="l53.24"> </span>
<a href="#l53.25"></a><span id="l53.25">   nsCOMPtr&lt;nsIURI&gt; m_uri;</span>
<a href="#l53.26"></a><span id="l53.26">   nsCString m_cid;</span>
<a href="#l53.27"></a><span id="l53.27">   nsCString m_name;</span>
<a href="#l53.28"></a><span id="l53.28"> </span>
<a href="#l53.29"></a><span id="l53.29" class="difflineminus">-private:</span>
<a href="#l53.30"></a><span id="l53.30" class="difflineplus">+ private:</span>
<a href="#l53.31"></a><span id="l53.31">   ~nsImportEmbeddedImageData();</span>
<a href="#l53.32"></a><span id="l53.32"> };</span>
<a href="#l53.33"></a><span id="l53.33"> </span>
<a href="#l53.34"></a><span id="l53.34" class="difflineminus">-</span>
<a href="#l53.35"></a><span id="l53.35"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l54.1"></a><span id="l54.1" class="difflineminus">--- a/mailnews/import/src/nsImportEncodeScan.cpp</span>
<a href="#l54.2"></a><span id="l54.2" class="difflineplus">+++ b/mailnews/import/src/nsImportEncodeScan.cpp</span>
<a href="#l54.3"></a><span id="l54.3" class="difflineat">@@ -2,161 +2,145 @@</span>
<a href="#l54.4"></a><span id="l54.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l54.5"></a><span id="l54.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l54.6"></a><span id="l54.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l54.7"></a><span id="l54.7"> </span>
<a href="#l54.8"></a><span id="l54.8"> #include &quot;nscore.h&quot;</span>
<a href="#l54.9"></a><span id="l54.9"> #include &quot;nsImportEncodeScan.h&quot;</span>
<a href="#l54.10"></a><span id="l54.10"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l54.11"></a><span id="l54.11"> </span>
<a href="#l54.12"></a><span id="l54.12" class="difflineminus">-#define  kBeginAppleSingle    0</span>
<a href="#l54.13"></a><span id="l54.13" class="difflineminus">-#define  kBeginDataFork      1</span>
<a href="#l54.14"></a><span id="l54.14" class="difflineminus">-#define  kBeginResourceFork    2</span>
<a href="#l54.15"></a><span id="l54.15" class="difflineminus">-#define  kAddEntries        3</span>
<a href="#l54.16"></a><span id="l54.16" class="difflineminus">-#define  kScanningDataFork    4</span>
<a href="#l54.17"></a><span id="l54.17" class="difflineminus">-#define  kScanningRsrcFork    5</span>
<a href="#l54.18"></a><span id="l54.18" class="difflineminus">-#define  kDoneWithFile      6</span>
<a href="#l54.19"></a><span id="l54.19" class="difflineplus">+#define kBeginAppleSingle 0</span>
<a href="#l54.20"></a><span id="l54.20" class="difflineplus">+#define kBeginDataFork 1</span>
<a href="#l54.21"></a><span id="l54.21" class="difflineplus">+#define kBeginResourceFork 2</span>
<a href="#l54.22"></a><span id="l54.22" class="difflineplus">+#define kAddEntries 3</span>
<a href="#l54.23"></a><span id="l54.23" class="difflineplus">+#define kScanningDataFork 4</span>
<a href="#l54.24"></a><span id="l54.24" class="difflineplus">+#define kScanningRsrcFork 5</span>
<a href="#l54.25"></a><span id="l54.25" class="difflineplus">+#define kDoneWithFile 6</span>
<a href="#l54.26"></a><span id="l54.26"> </span>
<a href="#l54.27"></a><span id="l54.27" class="difflineminus">-uint32_t  gAppleSingleHeader[6] = {0x00051600, 0x00020000, 0, 0, 0, 0};</span>
<a href="#l54.28"></a><span id="l54.28" class="difflineminus">-#define kAppleSingleHeaderSize  (6 * sizeof(uint32_t))</span>
<a href="#l54.29"></a><span id="l54.29" class="difflineplus">+uint32_t gAppleSingleHeader[6] = {0x00051600, 0x00020000, 0, 0, 0, 0};</span>
<a href="#l54.30"></a><span id="l54.30" class="difflineplus">+#define kAppleSingleHeaderSize (6 * sizeof(uint32_t))</span>
<a href="#l54.31"></a><span id="l54.31"> </span>
<a href="#l54.32"></a><span id="l54.32"> #ifdef _MAC_IMPORT_CODE</span>
<a href="#l54.33"></a><span id="l54.33" class="difflineminus">-#include &quot;MoreFilesExtras.h&quot;</span>
<a href="#l54.34"></a><span id="l54.34" class="difflineminus">-#include &quot;MoreDesktopMgr.h&quot;</span>
<a href="#l54.35"></a><span id="l54.35" class="difflineplus">+#  include &quot;MoreFilesExtras.h&quot;</span>
<a href="#l54.36"></a><span id="l54.36" class="difflineplus">+#  include &quot;MoreDesktopMgr.h&quot;</span>
<a href="#l54.37"></a><span id="l54.37"> </span>
<a href="#l54.38"></a><span id="l54.38" class="difflineminus">-CInfoPBRec  gCatInfoPB;</span>
<a href="#l54.39"></a><span id="l54.39" class="difflineminus">-U32      g2000Secs = 0;</span>
<a href="#l54.40"></a><span id="l54.40" class="difflineminus">-long    gGMTDelta = 0;</span>
<a href="#l54.41"></a><span id="l54.41" class="difflineplus">+CInfoPBRec gCatInfoPB;</span>
<a href="#l54.42"></a><span id="l54.42" class="difflineplus">+U32 g2000Secs = 0;</span>
<a href="#l54.43"></a><span id="l54.43" class="difflineplus">+long gGMTDelta = 0;</span>
<a href="#l54.44"></a><span id="l54.44"> </span>
<a href="#l54.45"></a><span id="l54.45"> long GetGmtDelta(void);</span>
<a href="#l54.46"></a><span id="l54.46"> U32 Get2000Secs(void);</span>
<a href="#l54.47"></a><span id="l54.47"> </span>
<a href="#l54.48"></a><span id="l54.48" class="difflineminus">-</span>
<a href="#l54.49"></a><span id="l54.49" class="difflineminus">-long GetGmtDelta(void)</span>
<a href="#l54.50"></a><span id="l54.50" class="difflineminus">-{</span>
<a href="#l54.51"></a><span id="l54.51" class="difflineplus">+long GetGmtDelta(void) {</span>
<a href="#l54.52"></a><span id="l54.52">   MachineLocation myLocation;</span>
<a href="#l54.53"></a><span id="l54.53">   ReadLocation(&amp;myLocation);</span>
<a href="#l54.54"></a><span id="l54.54" class="difflineminus">-  long  myDelta = BitAnd(myLocation.u.gmtDelta, 0x00FFFFFF);</span>
<a href="#l54.55"></a><span id="l54.55" class="difflineminus">-  if (BitTst(&amp;myDelta, 23))</span>
<a href="#l54.56"></a><span id="l54.56" class="difflineminus">-    myDelta = BitOr(myDelta, 0xFF000000);</span>
<a href="#l54.57"></a><span id="l54.57" class="difflineplus">+  long myDelta = BitAnd(myLocation.u.gmtDelta, 0x00FFFFFF);</span>
<a href="#l54.58"></a><span id="l54.58" class="difflineplus">+  if (BitTst(&amp;myDelta, 23)) myDelta = BitOr(myDelta, 0xFF000000);</span>
<a href="#l54.59"></a><span id="l54.59">   return myDelta;</span>
<a href="#l54.60"></a><span id="l54.60"> }</span>
<a href="#l54.61"></a><span id="l54.61"> </span>
<a href="#l54.62"></a><span id="l54.62" class="difflineminus">-U32 Get2000Secs(void)</span>
<a href="#l54.63"></a><span id="l54.63" class="difflineminus">-{</span>
<a href="#l54.64"></a><span id="l54.64" class="difflineminus">-  DateTimeRec  dr;</span>
<a href="#l54.65"></a><span id="l54.65" class="difflineplus">+U32 Get2000Secs(void) {</span>
<a href="#l54.66"></a><span id="l54.66" class="difflineplus">+  DateTimeRec dr;</span>
<a href="#l54.67"></a><span id="l54.67">   dr.year = 2000;</span>
<a href="#l54.68"></a><span id="l54.68">   dr.month = 1;</span>
<a href="#l54.69"></a><span id="l54.69">   dr.day = 1;</span>
<a href="#l54.70"></a><span id="l54.70">   dr.hour = 0;</span>
<a href="#l54.71"></a><span id="l54.71">   dr.minute = 0;</span>
<a href="#l54.72"></a><span id="l54.72">   dr.second = 0;</span>
<a href="#l54.73"></a><span id="l54.73">   dr.dayOfWeek = 0;</span>
<a href="#l54.74"></a><span id="l54.74" class="difflineminus">-  U32  result;</span>
<a href="#l54.75"></a><span id="l54.75" class="difflineplus">+  U32 result;</span>
<a href="#l54.76"></a><span id="l54.76">   DateToSeconds(&amp;dr, &amp;result);</span>
<a href="#l54.77"></a><span id="l54.77">   return result;</span>
<a href="#l54.78"></a><span id="l54.78"> }</span>
<a href="#l54.79"></a><span id="l54.79"> #endif</span>
<a href="#l54.80"></a><span id="l54.80"> </span>
<a href="#l54.81"></a><span id="l54.81" class="difflineminus">-nsImportEncodeScan::nsImportEncodeScan()</span>
<a href="#l54.82"></a><span id="l54.82" class="difflineminus">-{</span>
<a href="#l54.83"></a><span id="l54.83" class="difflineplus">+nsImportEncodeScan::nsImportEncodeScan() {</span>
<a href="#l54.84"></a><span id="l54.84">   m_isAppleSingle = false;</span>
<a href="#l54.85"></a><span id="l54.85">   m_encodeScanState = 0;</span>
<a href="#l54.86"></a><span id="l54.86">   m_resourceForkSize = 0;</span>
<a href="#l54.87"></a><span id="l54.87">   m_dataForkSize = 0;</span>
<a href="#l54.88"></a><span id="l54.88"> }</span>
<a href="#l54.89"></a><span id="l54.89"> </span>
<a href="#l54.90"></a><span id="l54.90" class="difflineminus">-nsImportEncodeScan::~nsImportEncodeScan()</span>
<a href="#l54.91"></a><span id="l54.91" class="difflineminus">-{</span>
<a href="#l54.92"></a><span id="l54.92" class="difflineminus">-}</span>
<a href="#l54.93"></a><span id="l54.93" class="difflineplus">+nsImportEncodeScan::~nsImportEncodeScan() {}</span>
<a href="#l54.94"></a><span id="l54.94"> </span>
<a href="#l54.95"></a><span id="l54.95" class="difflineminus">-bool nsImportEncodeScan::InitEncodeScan(bool appleSingleEncode, nsIFile *fileLoc, const char *pName, uint8_t * pBuf, uint32_t sz)</span>
<a href="#l54.96"></a><span id="l54.96" class="difflineminus">-{</span>
<a href="#l54.97"></a><span id="l54.97" class="difflineplus">+bool nsImportEncodeScan::InitEncodeScan(bool appleSingleEncode,</span>
<a href="#l54.98"></a><span id="l54.98" class="difflineplus">+                                        nsIFile *fileLoc, const char *pName,</span>
<a href="#l54.99"></a><span id="l54.99" class="difflineplus">+                                        uint8_t *pBuf, uint32_t sz) {</span>
<a href="#l54.100"></a><span id="l54.100">   CleanUpEncodeScan();</span>
<a href="#l54.101"></a><span id="l54.101">   m_isAppleSingle = appleSingleEncode;</span>
<a href="#l54.102"></a><span id="l54.102">   m_encodeScanState = kBeginAppleSingle;</span>
<a href="#l54.103"></a><span id="l54.103">   m_pInputFile = fileLoc;</span>
<a href="#l54.104"></a><span id="l54.104">   m_useFileName = pName;</span>
<a href="#l54.105"></a><span id="l54.105">   m_pBuf = pBuf;</span>
<a href="#l54.106"></a><span id="l54.106">   m_bufSz = sz;</span>
<a href="#l54.107"></a><span id="l54.107" class="difflineminus">-  if (!m_isAppleSingle)</span>
<a href="#l54.108"></a><span id="l54.108" class="difflineminus">-        {</span>
<a href="#l54.109"></a><span id="l54.109" class="difflineminus">-    if (!m_inputStream)</span>
<a href="#l54.110"></a><span id="l54.110" class="difflineminus">-                {</span>
<a href="#l54.111"></a><span id="l54.111" class="difflineminus">-                  nsresult rv = NS_NewLocalFileInputStream(getter_AddRefs(m_inputStream), m_pInputFile);</span>
<a href="#l54.112"></a><span id="l54.112" class="difflineminus">-                  NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l54.113"></a><span id="l54.113" class="difflineplus">+  if (!m_isAppleSingle) {</span>
<a href="#l54.114"></a><span id="l54.114" class="difflineplus">+    if (!m_inputStream) {</span>
<a href="#l54.115"></a><span id="l54.115" class="difflineplus">+      nsresult rv = NS_NewLocalFileInputStream(getter_AddRefs(m_inputStream),</span>
<a href="#l54.116"></a><span id="l54.116" class="difflineplus">+                                               m_pInputFile);</span>
<a href="#l54.117"></a><span id="l54.117" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l54.118"></a><span id="l54.118">     }</span>
<a href="#l54.119"></a><span id="l54.119"> </span>
<a href="#l54.120"></a><span id="l54.120">     InitScan(m_inputStream, pBuf, sz);</span>
<a href="#l54.121"></a><span id="l54.121" class="difflineminus">-  }</span>
<a href="#l54.122"></a><span id="l54.122" class="difflineminus">-  else {</span>
<a href="#l54.123"></a><span id="l54.123" class="difflineminus">-  #ifdef _MAC_IMPORT_CODE</span>
<a href="#l54.124"></a><span id="l54.124" class="difflineplus">+  } else {</span>
<a href="#l54.125"></a><span id="l54.125" class="difflineplus">+#ifdef _MAC_IMPORT_CODE</span>
<a href="#l54.126"></a><span id="l54.126">     // Fill in the file sizes</span>
<a href="#l54.127"></a><span id="l54.127">     m_resourceForkSize = fileLoc.GetMacFileSize(UFileLocation::eResourceFork);</span>
<a href="#l54.128"></a><span id="l54.128">     m_dataForkSize = fileLoc.GetMacFileSize(UFileLocation::eDataFork);</span>
<a href="#l54.129"></a><span id="l54.129" class="difflineminus">-  #endif</span>
<a href="#l54.130"></a><span id="l54.130" class="difflineplus">+#endif</span>
<a href="#l54.131"></a><span id="l54.131">   }</span>
<a href="#l54.132"></a><span id="l54.132"> </span>
<a href="#l54.133"></a><span id="l54.133">   return true;</span>
<a href="#l54.134"></a><span id="l54.134"> }</span>
<a href="#l54.135"></a><span id="l54.135"> </span>
<a href="#l54.136"></a><span id="l54.136" class="difflineminus">-void nsImportEncodeScan::CleanUpEncodeScan(void)</span>
<a href="#l54.137"></a><span id="l54.137" class="difflineminus">-{</span>
<a href="#l54.138"></a><span id="l54.138" class="difflineplus">+void nsImportEncodeScan::CleanUpEncodeScan(void) {</span>
<a href="#l54.139"></a><span id="l54.139">   m_pInputStream-&gt;Close();</span>
<a href="#l54.140"></a><span id="l54.140">   m_pInputStream = nullptr;</span>
<a href="#l54.141"></a><span id="l54.141">   m_pInputFile = nullptr;</span>
<a href="#l54.142"></a><span id="l54.142"> }</span>
<a href="#l54.143"></a><span id="l54.143"> </span>
<a href="#l54.144"></a><span id="l54.144" class="difflineminus">-</span>
<a href="#l54.145"></a><span id="l54.145"> // 26 + 12 per entry</span>
<a href="#l54.146"></a><span id="l54.146"> </span>
<a href="#l54.147"></a><span id="l54.147" class="difflineminus">-void nsImportEncodeScan::FillInEntries(int numEntries)</span>
<a href="#l54.148"></a><span id="l54.148" class="difflineminus">-{</span>
<a href="#l54.149"></a><span id="l54.149" class="difflineplus">+void nsImportEncodeScan::FillInEntries(int numEntries) {</span>
<a href="#l54.150"></a><span id="l54.150"> #ifdef _MAC_IMPORT_CODE</span>
<a href="#l54.151"></a><span id="l54.151" class="difflineminus">-  int    len = m_useFileName.GetLength();</span>
<a href="#l54.152"></a><span id="l54.152" class="difflineminus">-  if (len &lt; 32)</span>
<a href="#l54.153"></a><span id="l54.153" class="difflineminus">-    len = 32;</span>
<a href="#l54.154"></a><span id="l54.154" class="difflineminus">-  long  entry[3];</span>
<a href="#l54.155"></a><span id="l54.155" class="difflineminus">-  long  fileOffset = 26 + (12 * numEntries);</span>
<a href="#l54.156"></a><span id="l54.156" class="difflineplus">+  int len = m_useFileName.GetLength();</span>
<a href="#l54.157"></a><span id="l54.157" class="difflineplus">+  if (len &lt; 32) len = 32;</span>
<a href="#l54.158"></a><span id="l54.158" class="difflineplus">+  long entry[3];</span>
<a href="#l54.159"></a><span id="l54.159" class="difflineplus">+  long fileOffset = 26 + (12 * numEntries);</span>
<a href="#l54.160"></a><span id="l54.160">   entry[0] = 3;</span>
<a href="#l54.161"></a><span id="l54.161">   entry[1] = fileOffset;</span>
<a href="#l54.162"></a><span id="l54.162">   entry[2] = m_useFileName.GetLength();</span>
<a href="#l54.163"></a><span id="l54.163">   fileOffset += len;</span>
<a href="#l54.164"></a><span id="l54.164">   MemCpy(m_pBuf + m_bytesInBuf, entry, 12);</span>
<a href="#l54.165"></a><span id="l54.165">   m_bytesInBuf += 12;</span>
<a href="#l54.166"></a><span id="l54.166"> </span>
<a href="#l54.167"></a><span id="l54.167" class="difflineminus">-</span>
<a href="#l54.168"></a><span id="l54.168" class="difflineminus">-  Str255  comment;</span>
<a href="#l54.169"></a><span id="l54.169" class="difflineplus">+  Str255 comment;</span>
<a href="#l54.170"></a><span id="l54.170">   comment[0] = 0;</span>
<a href="#l54.171"></a><span id="l54.171">   OSErr err = FSpDTGetComment(m_inputFileLoc, comment);</span>
<a href="#l54.172"></a><span id="l54.172" class="difflineminus">-  if (comment[0] &gt; 200)</span>
<a href="#l54.173"></a><span id="l54.173" class="difflineminus">-    comment[0] = 200;</span>
<a href="#l54.174"></a><span id="l54.174" class="difflineplus">+  if (comment[0] &gt; 200) comment[0] = 200;</span>
<a href="#l54.175"></a><span id="l54.175">   entry[0] = 4;</span>
<a href="#l54.176"></a><span id="l54.176">   entry[1] = fileOffset;</span>
<a href="#l54.177"></a><span id="l54.177">   entry[2] = comment[0];</span>
<a href="#l54.178"></a><span id="l54.178">   fileOffset += 200;</span>
<a href="#l54.179"></a><span id="l54.179">   MemCpy(m_pBuf + m_bytesInBuf, entry, 12);</span>
<a href="#l54.180"></a><span id="l54.180">   m_bytesInBuf += 12;</span>
<a href="#l54.181"></a><span id="l54.181"> </span>
<a href="#l54.182"></a><span id="l54.182" class="difflineminus">-</span>
<a href="#l54.183"></a><span id="l54.183">   entry[0] = 8;</span>
<a href="#l54.184"></a><span id="l54.184">   entry[1] = fileOffset;</span>
<a href="#l54.185"></a><span id="l54.185">   entry[2] = 16;</span>
<a href="#l54.186"></a><span id="l54.186">   fileOffset += 16;</span>
<a href="#l54.187"></a><span id="l54.187">   MemCpy(m_pBuf + m_bytesInBuf, entry, 12);</span>
<a href="#l54.188"></a><span id="l54.188">   m_bytesInBuf += 12;</span>
<a href="#l54.189"></a><span id="l54.189"> </span>
<a href="#l54.190"></a><span id="l54.190">   entry[0] = 9;</span>
<a href="#l54.191"></a><span id="l54.191">   entry[1] = fileOffset;</span>
<a href="#l54.192"></a><span id="l54.192">   entry[2] = 32;</span>
<a href="#l54.193"></a><span id="l54.193">   fileOffset += 32;</span>
<a href="#l54.194"></a><span id="l54.194">   MemCpy(m_pBuf + m_bytesInBuf, entry, 12);</span>
<a href="#l54.195"></a><span id="l54.195">   m_bytesInBuf += 12;</span>
<a href="#l54.196"></a><span id="l54.196"> </span>
<a href="#l54.197"></a><span id="l54.197" class="difflineminus">-</span>
<a href="#l54.198"></a><span id="l54.198">   entry[0] = 10;</span>
<a href="#l54.199"></a><span id="l54.199">   entry[1] = fileOffset;</span>
<a href="#l54.200"></a><span id="l54.200">   entry[2] = 4;</span>
<a href="#l54.201"></a><span id="l54.201">   fileOffset += 4;</span>
<a href="#l54.202"></a><span id="l54.202">   MemCpy(m_pBuf + m_bytesInBuf, entry, 12);</span>
<a href="#l54.203"></a><span id="l54.203">   m_bytesInBuf += 12;</span>
<a href="#l54.204"></a><span id="l54.204"> </span>
<a href="#l54.205"></a><span id="l54.205">   if (m_resourceForkSize) {</span>
<a href="#l54.206"></a><span id="l54.206" class="difflineat">@@ -175,200 +159,177 @@ void nsImportEncodeScan::FillInEntries(i</span>
<a href="#l54.207"></a><span id="l54.207">     fileOffset += m_dataForkSize;</span>
<a href="#l54.208"></a><span id="l54.208">     MemCpy(m_pBuf + m_bytesInBuf, entry, 12);</span>
<a href="#l54.209"></a><span id="l54.209">     m_bytesInBuf += 12;</span>
<a href="#l54.210"></a><span id="l54.210">   }</span>
<a href="#l54.211"></a><span id="l54.211"> </span>
<a href="#l54.212"></a><span id="l54.212"> #endif</span>
<a href="#l54.213"></a><span id="l54.213"> }</span>
<a href="#l54.214"></a><span id="l54.214"> </span>
<a href="#l54.215"></a><span id="l54.215" class="difflineminus">-bool nsImportEncodeScan::AddEntries(void)</span>
<a href="#l54.216"></a><span id="l54.216" class="difflineminus">-{</span>
<a href="#l54.217"></a><span id="l54.217" class="difflineplus">+bool nsImportEncodeScan::AddEntries(void) {</span>
<a href="#l54.218"></a><span id="l54.218"> #ifdef _MAC_IMPORT_CODE</span>
<a href="#l54.219"></a><span id="l54.219">   if (!g2000Secs) {</span>
<a href="#l54.220"></a><span id="l54.220">     g2000Secs = Get2000Secs();</span>
<a href="#l54.221"></a><span id="l54.221">     gGMTDelta = GetGmtDelta();</span>
<a href="#l54.222"></a><span id="l54.222">   }</span>
<a href="#l54.223"></a><span id="l54.223" class="difflineminus">-  MemCpy(m_pBuf + m_bytesInBuf, (PC_S8) m_useFileName, m_useFileName.GetLength());</span>
<a href="#l54.224"></a><span id="l54.224" class="difflineplus">+  MemCpy(m_pBuf + m_bytesInBuf, (PC_S8)m_useFileName,</span>
<a href="#l54.225"></a><span id="l54.225" class="difflineplus">+         m_useFileName.GetLength());</span>
<a href="#l54.226"></a><span id="l54.226">   m_bytesInBuf += m_useFileName.GetLength();</span>
<a href="#l54.227"></a><span id="l54.227">   if (m_useFileName.GetLength() &lt; 32) {</span>
<a href="#l54.228"></a><span id="l54.228">     int len = m_useFileName.GetLength();</span>
<a href="#l54.229"></a><span id="l54.229">     while (len &lt; 32) {</span>
<a href="#l54.230"></a><span id="l54.230">       *((P_S8)m_pBuf + m_bytesInBuf) = 0;</span>
<a href="#l54.231"></a><span id="l54.231">       m_bytesInBuf++;</span>
<a href="#l54.232"></a><span id="l54.232">       len++;</span>
<a href="#l54.233"></a><span id="l54.233">     }</span>
<a href="#l54.234"></a><span id="l54.234">   }</span>
<a href="#l54.235"></a><span id="l54.235"> </span>
<a href="#l54.236"></a><span id="l54.236" class="difflineminus">-  Str255  comment;</span>
<a href="#l54.237"></a><span id="l54.237" class="difflineplus">+  Str255 comment;</span>
<a href="#l54.238"></a><span id="l54.238">   comment[0] = 0;</span>
<a href="#l54.239"></a><span id="l54.239">   OSErr err = FSpDTGetComment(m_inputFileLoc, comment);</span>
<a href="#l54.240"></a><span id="l54.240">   comment[0] = 200;</span>
<a href="#l54.241"></a><span id="l54.241">   MemCpy(m_pBuf + m_bytesInBuf, &amp;(comment[1]), comment[0]);</span>
<a href="#l54.242"></a><span id="l54.242">   m_bytesInBuf += comment[0];</span>
<a href="#l54.243"></a><span id="l54.243"> </span>
<a href="#l54.244"></a><span id="l54.244" class="difflineminus">-  long  dates[4];</span>
<a href="#l54.245"></a><span id="l54.245" class="difflineplus">+  long dates[4];</span>
<a href="#l54.246"></a><span id="l54.246">   dates[0] = gCatInfoPB.hFileInfo.ioFlCrDat;</span>
<a href="#l54.247"></a><span id="l54.247">   dates[1] = gCatInfoPB.hFileInfo.ioFlMdDat;</span>
<a href="#l54.248"></a><span id="l54.248">   dates[2] = gCatInfoPB.hFileInfo.ioFlBkDat;</span>
<a href="#l54.249"></a><span id="l54.249">   dates[3] = 0x80000000;</span>
<a href="#l54.250"></a><span id="l54.250">   for (short i = 0; i &lt; 3; i++) {</span>
<a href="#l54.251"></a><span id="l54.251">     dates[i] -= g2000Secs;</span>
<a href="#l54.252"></a><span id="l54.252">     dates[i] += gGMTDelta;</span>
<a href="#l54.253"></a><span id="l54.253">   }</span>
<a href="#l54.254"></a><span id="l54.254">   MemCpy(m_pBuf + m_bytesInBuf, dates, 16);</span>
<a href="#l54.255"></a><span id="l54.255">   m_bytesInBuf += 16;</span>
<a href="#l54.256"></a><span id="l54.256"> </span>
<a href="#l54.257"></a><span id="l54.257" class="difflineminus">-</span>
<a href="#l54.258"></a><span id="l54.258" class="difflineminus">-  FInfo  fInfo = gCatInfoPB.hFileInfo.ioFlFndrInfo;</span>
<a href="#l54.259"></a><span id="l54.259" class="difflineminus">-  FXInfo  fxInfo = gCatInfoPB.hFileInfo.ioFlXFndrInfo;</span>
<a href="#l54.260"></a><span id="l54.260" class="difflineplus">+  FInfo fInfo = gCatInfoPB.hFileInfo.ioFlFndrInfo;</span>
<a href="#l54.261"></a><span id="l54.261" class="difflineplus">+  FXInfo fxInfo = gCatInfoPB.hFileInfo.ioFlXFndrInfo;</span>
<a href="#l54.262"></a><span id="l54.262">   fInfo.fdFlags = 0;</span>
<a href="#l54.263"></a><span id="l54.263">   fInfo.fdLocation.h = 0;</span>
<a href="#l54.264"></a><span id="l54.264">   fInfo.fdLocation.v = 0;</span>
<a href="#l54.265"></a><span id="l54.265">   fInfo.fdFldr = 0;</span>
<a href="#l54.266"></a><span id="l54.266">   MemSet(&amp;fxInfo, 0, sizeof(fxInfo));</span>
<a href="#l54.267"></a><span id="l54.267">   MemCpy(m_pBuf + m_bytesInBuf, &amp;fInfo, 16);</span>
<a href="#l54.268"></a><span id="l54.268">   m_bytesInBuf += 16;</span>
<a href="#l54.269"></a><span id="l54.269">   MemCpy(m_pBuf + m_bytesInBuf, &amp;fxInfo, 16);</span>
<a href="#l54.270"></a><span id="l54.270">   m_bytesInBuf += 16;</span>
<a href="#l54.271"></a><span id="l54.271"> </span>
<a href="#l54.272"></a><span id="l54.272" class="difflineminus">-</span>
<a href="#l54.273"></a><span id="l54.273">   dates[0] = 0;</span>
<a href="#l54.274"></a><span id="l54.274" class="difflineminus">-  if ((gCatInfoPB.hFileInfo.ioFlAttrib &amp; 1) != 0)</span>
<a href="#l54.275"></a><span id="l54.275" class="difflineminus">-    dates[0] |= 1;</span>
<a href="#l54.276"></a><span id="l54.276" class="difflineplus">+  if ((gCatInfoPB.hFileInfo.ioFlAttrib &amp; 1) != 0) dates[0] |= 1;</span>
<a href="#l54.277"></a><span id="l54.277">   MemCpy(m_pBuf + m_bytesInBuf, dates, 4);</span>
<a href="#l54.278"></a><span id="l54.278">   m_bytesInBuf += 4;</span>
<a href="#l54.279"></a><span id="l54.279"> </span>
<a href="#l54.280"></a><span id="l54.280" class="difflineminus">-</span>
<a href="#l54.281"></a><span id="l54.281"> #endif</span>
<a href="#l54.282"></a><span id="l54.282">   return true;</span>
<a href="#l54.283"></a><span id="l54.283"> }</span>
<a href="#l54.284"></a><span id="l54.284"> </span>
<a href="#l54.285"></a><span id="l54.285" class="difflineminus">-bool nsImportEncodeScan::Scan(bool *pDone)</span>
<a href="#l54.286"></a><span id="l54.286" class="difflineminus">-{</span>
<a href="#l54.287"></a><span id="l54.287" class="difflineminus">-  nsresult  rv;</span>
<a href="#l54.288"></a><span id="l54.288" class="difflineplus">+bool nsImportEncodeScan::Scan(bool *pDone) {</span>
<a href="#l54.289"></a><span id="l54.289" class="difflineplus">+  nsresult rv;</span>
<a href="#l54.290"></a><span id="l54.290"> </span>
<a href="#l54.291"></a><span id="l54.291">   *pDone = false;</span>
<a href="#l54.292"></a><span id="l54.292">   if (m_isAppleSingle) {</span>
<a href="#l54.293"></a><span id="l54.293">     // Stuff the buffer with things needed to encode the file...</span>
<a href="#l54.294"></a><span id="l54.294">     // then just allow UScanFile to handle each fork, but be careful</span>
<a href="#l54.295"></a><span id="l54.295">     // when handling eof.</span>
<a href="#l54.296"></a><span id="l54.296" class="difflineminus">-    switch(m_encodeScanState) {</span>
<a href="#l54.297"></a><span id="l54.297" class="difflineplus">+    switch (m_encodeScanState) {</span>
<a href="#l54.298"></a><span id="l54.298">       case kBeginAppleSingle: {</span>
<a href="#l54.299"></a><span id="l54.299"> #ifdef _MAC_IMPORT_CODE</span>
<a href="#l54.300"></a><span id="l54.300" class="difflineminus">-        OSErr err = GetCatInfoNoName(m_inputFileLoc.GetVRefNum(), m_inputFileLoc.GetParID(), m_inputFileLoc.GetFileNamePtr(), &amp;gCatInfoPB);</span>
<a href="#l54.301"></a><span id="l54.301" class="difflineminus">-        if (err != noErr)</span>
<a href="#l54.302"></a><span id="l54.302" class="difflineminus">-          return FALSE;</span>
<a href="#l54.303"></a><span id="l54.303" class="difflineplus">+        OSErr err = GetCatInfoNoName(</span>
<a href="#l54.304"></a><span id="l54.304" class="difflineplus">+            m_inputFileLoc.GetVRefNum(), m_inputFileLoc.GetParID(),</span>
<a href="#l54.305"></a><span id="l54.305" class="difflineplus">+            m_inputFileLoc.GetFileNamePtr(), &amp;gCatInfoPB);</span>
<a href="#l54.306"></a><span id="l54.306" class="difflineplus">+        if (err != noErr) return FALSE;</span>
<a href="#l54.307"></a><span id="l54.307"> #endif</span>
<a href="#l54.308"></a><span id="l54.308">         m_eof = false;</span>
<a href="#l54.309"></a><span id="l54.309">         m_pos = 0;</span>
<a href="#l54.310"></a><span id="l54.310">         memcpy(m_pBuf, gAppleSingleHeader, kAppleSingleHeaderSize);</span>
<a href="#l54.311"></a><span id="l54.311">         m_bytesInBuf = kAppleSingleHeaderSize;</span>
<a href="#l54.312"></a><span id="l54.312">         int numEntries = 5;</span>
<a href="#l54.313"></a><span id="l54.313" class="difflineminus">-        if (m_dataForkSize)</span>
<a href="#l54.314"></a><span id="l54.314" class="difflineminus">-          numEntries++;</span>
<a href="#l54.315"></a><span id="l54.315" class="difflineminus">-        if (m_resourceForkSize)</span>
<a href="#l54.316"></a><span id="l54.316" class="difflineminus">-          numEntries++;</span>
<a href="#l54.317"></a><span id="l54.317" class="difflineplus">+        if (m_dataForkSize) numEntries++;</span>
<a href="#l54.318"></a><span id="l54.318" class="difflineplus">+        if (m_resourceForkSize) numEntries++;</span>
<a href="#l54.319"></a><span id="l54.319">         memcpy(m_pBuf + m_bytesInBuf, &amp;numEntries, sizeof(numEntries));</span>
<a href="#l54.320"></a><span id="l54.320">         m_bytesInBuf += sizeof(numEntries);</span>
<a href="#l54.321"></a><span id="l54.321">         FillInEntries(numEntries);</span>
<a href="#l54.322"></a><span id="l54.322">         m_encodeScanState = kAddEntries;</span>
<a href="#l54.323"></a><span id="l54.323">         return ScanBuffer(pDone);</span>
<a href="#l54.324"></a><span id="l54.324" class="difflineminus">-      }</span>
<a href="#l54.325"></a><span id="l54.325" class="difflineminus">-      break;</span>
<a href="#l54.326"></a><span id="l54.326" class="difflineplus">+      } break;</span>
<a href="#l54.327"></a><span id="l54.327"> </span>
<a href="#l54.328"></a><span id="l54.328">       case kBeginDataFork: {</span>
<a href="#l54.329"></a><span id="l54.329">         if (!m_dataForkSize) {</span>
<a href="#l54.330"></a><span id="l54.330">           m_encodeScanState = kDoneWithFile;</span>
<a href="#l54.331"></a><span id="l54.331">           return true;</span>
<a href="#l54.332"></a><span id="l54.332">         }</span>
<a href="#l54.333"></a><span id="l54.333">         // Initialize the scan of the data fork...</span>
<a href="#l54.334"></a><span id="l54.334" class="difflineminus">-        if (!m_inputStream)</span>
<a href="#l54.335"></a><span id="l54.335" class="difflineminus">-                                {</span>
<a href="#l54.336"></a><span id="l54.336" class="difflineminus">-                                  rv = NS_NewLocalFileInputStream(getter_AddRefs(m_inputStream), m_pInputFile);</span>
<a href="#l54.337"></a><span id="l54.337" class="difflineminus">-                                  NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l54.338"></a><span id="l54.338" class="difflineminus">-                                }</span>
<a href="#l54.339"></a><span id="l54.339" class="difflineplus">+        if (!m_inputStream) {</span>
<a href="#l54.340"></a><span id="l54.340" class="difflineplus">+          rv = NS_NewLocalFileInputStream(getter_AddRefs(m_inputStream),</span>
<a href="#l54.341"></a><span id="l54.341" class="difflineplus">+                                          m_pInputFile);</span>
<a href="#l54.342"></a><span id="l54.342" class="difflineplus">+          NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l54.343"></a><span id="l54.343" class="difflineplus">+        }</span>
<a href="#l54.344"></a><span id="l54.344">         m_encodeScanState = kScanningDataFork;</span>
<a href="#l54.345"></a><span id="l54.345">         return true;</span>
<a href="#l54.346"></a><span id="l54.346" class="difflineminus">-      }</span>
<a href="#l54.347"></a><span id="l54.347" class="difflineminus">-      break;</span>
<a href="#l54.348"></a><span id="l54.348" class="difflineplus">+      } break;</span>
<a href="#l54.349"></a><span id="l54.349"> </span>
<a href="#l54.350"></a><span id="l54.350">       case kScanningDataFork: {</span>
<a href="#l54.351"></a><span id="l54.351">         bool result = FillBufferFromFile();</span>
<a href="#l54.352"></a><span id="l54.352" class="difflineminus">-        if (!result)</span>
<a href="#l54.353"></a><span id="l54.353" class="difflineminus">-          return false;</span>
<a href="#l54.354"></a><span id="l54.354" class="difflineplus">+        if (!result) return false;</span>
<a href="#l54.355"></a><span id="l54.355">         if (m_eof) {</span>
<a href="#l54.356"></a><span id="l54.356">           m_eof = false;</span>
<a href="#l54.357"></a><span id="l54.357">           result = ScanBuffer(pDone);</span>
<a href="#l54.358"></a><span id="l54.358" class="difflineminus">-          if (!result)</span>
<a href="#l54.359"></a><span id="l54.359" class="difflineminus">-            return false;</span>
<a href="#l54.360"></a><span id="l54.360" class="difflineplus">+          if (!result) return false;</span>
<a href="#l54.361"></a><span id="l54.361">           m_inputStream-&gt;Close();</span>
<a href="#l54.362"></a><span id="l54.362" class="difflineminus">-                                        m_inputStream = nullptr;</span>
<a href="#l54.363"></a><span id="l54.363" class="difflineplus">+          m_inputStream = nullptr;</span>
<a href="#l54.364"></a><span id="l54.364">           m_encodeScanState = kDoneWithFile;</span>
<a href="#l54.365"></a><span id="l54.365">           return true;</span>
<a href="#l54.366"></a><span id="l54.366" class="difflineminus">-        }</span>
<a href="#l54.367"></a><span id="l54.367" class="difflineminus">-        else</span>
<a href="#l54.368"></a><span id="l54.368" class="difflineplus">+        } else</span>
<a href="#l54.369"></a><span id="l54.369">           return ScanBuffer(pDone);</span>
<a href="#l54.370"></a><span id="l54.370" class="difflineminus">-      }</span>
<a href="#l54.371"></a><span id="l54.371" class="difflineminus">-      break;</span>
<a href="#l54.372"></a><span id="l54.372" class="difflineplus">+      } break;</span>
<a href="#l54.373"></a><span id="l54.373"> </span>
<a href="#l54.374"></a><span id="l54.374">       case kScanningRsrcFork: {</span>
<a href="#l54.375"></a><span id="l54.375">         bool result = FillBufferFromFile();</span>
<a href="#l54.376"></a><span id="l54.376" class="difflineminus">-        if (!result)</span>
<a href="#l54.377"></a><span id="l54.377" class="difflineminus">-          return false;</span>
<a href="#l54.378"></a><span id="l54.378" class="difflineplus">+        if (!result) return false;</span>
<a href="#l54.379"></a><span id="l54.379">         if (m_eof) {</span>
<a href="#l54.380"></a><span id="l54.380">           m_eof = false;</span>
<a href="#l54.381"></a><span id="l54.381">           result = ScanBuffer(pDone);</span>
<a href="#l54.382"></a><span id="l54.382" class="difflineminus">-          if (!result)</span>
<a href="#l54.383"></a><span id="l54.383" class="difflineminus">-            return false;</span>
<a href="#l54.384"></a><span id="l54.384" class="difflineplus">+          if (!result) return false;</span>
<a href="#l54.385"></a><span id="l54.385">           m_inputStream-&gt;Close();</span>
<a href="#l54.386"></a><span id="l54.386" class="difflineminus">-                                        m_inputStream = nullptr;</span>
<a href="#l54.387"></a><span id="l54.387" class="difflineplus">+          m_inputStream = nullptr;</span>
<a href="#l54.388"></a><span id="l54.388">           m_encodeScanState = kBeginDataFork;</span>
<a href="#l54.389"></a><span id="l54.389">           return true;</span>
<a href="#l54.390"></a><span id="l54.390" class="difflineminus">-        }</span>
<a href="#l54.391"></a><span id="l54.391" class="difflineminus">-        else</span>
<a href="#l54.392"></a><span id="l54.392" class="difflineplus">+        } else</span>
<a href="#l54.393"></a><span id="l54.393">           return ScanBuffer(pDone);</span>
<a href="#l54.394"></a><span id="l54.394" class="difflineminus">-      }</span>
<a href="#l54.395"></a><span id="l54.395" class="difflineminus">-      break;</span>
<a href="#l54.396"></a><span id="l54.396" class="difflineplus">+      } break;</span>
<a href="#l54.397"></a><span id="l54.397"> </span>
<a href="#l54.398"></a><span id="l54.398">       case kBeginResourceFork: {</span>
<a href="#l54.399"></a><span id="l54.399">         if (!m_resourceForkSize) {</span>
<a href="#l54.400"></a><span id="l54.400">           m_encodeScanState = kBeginDataFork;</span>
<a href="#l54.401"></a><span id="l54.401">           return true;</span>
<a href="#l54.402"></a><span id="l54.402">         }</span>
<a href="#l54.403"></a><span id="l54.403">         /*</span>
<a href="#l54.404"></a><span id="l54.404">         // FIXME: Open the resource fork on the Mac!!!</span>
<a href="#l54.405"></a><span id="l54.405">         m_fH = UFile::OpenRsrcFileRead(m_inputFileLoc);</span>
<a href="#l54.406"></a><span id="l54.406">         if (m_fH == TR_FILE_ERROR)</span>
<a href="#l54.407"></a><span id="l54.407">           return FALSE;</span>
<a href="#l54.408"></a><span id="l54.408">         */</span>
<a href="#l54.409"></a><span id="l54.409">         m_encodeScanState = kScanningRsrcFork;</span>
<a href="#l54.410"></a><span id="l54.410">         return true;</span>
<a href="#l54.411"></a><span id="l54.411" class="difflineminus">-      }</span>
<a href="#l54.412"></a><span id="l54.412" class="difflineminus">-      break;</span>
<a href="#l54.413"></a><span id="l54.413" class="difflineplus">+      } break;</span>
<a href="#l54.414"></a><span id="l54.414"> </span>
<a href="#l54.415"></a><span id="l54.415">       case kAddEntries: {</span>
<a href="#l54.416"></a><span id="l54.416">         ShiftBuffer();</span>
<a href="#l54.417"></a><span id="l54.417" class="difflineminus">-        if (!AddEntries())</span>
<a href="#l54.418"></a><span id="l54.418" class="difflineminus">-          return false;</span>
<a href="#l54.419"></a><span id="l54.419" class="difflineplus">+        if (!AddEntries()) return false;</span>
<a href="#l54.420"></a><span id="l54.420">         m_encodeScanState = kBeginResourceFork;</span>
<a href="#l54.421"></a><span id="l54.421">         return ScanBuffer(pDone);</span>
<a href="#l54.422"></a><span id="l54.422" class="difflineminus">-      }</span>
<a href="#l54.423"></a><span id="l54.423" class="difflineminus">-      break;</span>
<a href="#l54.424"></a><span id="l54.424" class="difflineplus">+      } break;</span>
<a href="#l54.425"></a><span id="l54.425"> </span>
<a href="#l54.426"></a><span id="l54.426">       case kDoneWithFile: {</span>
<a href="#l54.427"></a><span id="l54.427">         ShiftBuffer();</span>
<a href="#l54.428"></a><span id="l54.428">         m_eof = true;</span>
<a href="#l54.429"></a><span id="l54.429" class="difflineminus">-        if (!ScanBuffer(pDone))</span>
<a href="#l54.430"></a><span id="l54.430" class="difflineminus">-          return false;</span>
<a href="#l54.431"></a><span id="l54.431" class="difflineplus">+        if (!ScanBuffer(pDone)) return false;</span>
<a href="#l54.432"></a><span id="l54.432">         *pDone = true;</span>
<a href="#l54.433"></a><span id="l54.433">         return true;</span>
<a href="#l54.434"></a><span id="l54.434" class="difflineminus">-      }</span>
<a href="#l54.435"></a><span id="l54.435" class="difflineminus">-      break;</span>
<a href="#l54.436"></a><span id="l54.436" class="difflineplus">+      } break;</span>
<a href="#l54.437"></a><span id="l54.437">     }</span>
<a href="#l54.438"></a><span id="l54.438"> </span>
<a href="#l54.439"></a><span id="l54.439" class="difflineminus">-  }</span>
<a href="#l54.440"></a><span id="l54.440" class="difflineminus">-  else</span>
<a href="#l54.441"></a><span id="l54.441" class="difflineplus">+  } else</span>
<a href="#l54.442"></a><span id="l54.442">     return nsImportScanFile::Scan(pDone);</span>
<a href="#l54.443"></a><span id="l54.443"> </span>
<a href="#l54.444"></a><span id="l54.444">   return false;</span>
<a href="#l54.445"></a><span id="l54.445"> }</span>
<a href="#l54.446"></a><span id="l54.446" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l55.1"></a><span id="l55.1" class="difflineminus">--- a/mailnews/import/src/nsImportEncodeScan.h</span>
<a href="#l55.2"></a><span id="l55.2" class="difflineplus">+++ b/mailnews/import/src/nsImportEncodeScan.h</span>
<a href="#l55.3"></a><span id="l55.3" class="difflineat">@@ -7,33 +7,33 @@</span>
<a href="#l55.4"></a><span id="l55.4"> #define nsImportEncodeScan_h___</span>
<a href="#l55.5"></a><span id="l55.5"> </span>
<a href="#l55.6"></a><span id="l55.6"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l55.7"></a><span id="l55.7"> #include &quot;nsIFile.h&quot;</span>
<a href="#l55.8"></a><span id="l55.8"> #include &quot;nsImportScanFile.h&quot;</span>
<a href="#l55.9"></a><span id="l55.9"> #include &quot;nsString.h&quot;</span>
<a href="#l55.10"></a><span id="l55.10"> </span>
<a href="#l55.11"></a><span id="l55.11"> class nsImportEncodeScan : public nsImportScanFile {</span>
<a href="#l55.12"></a><span id="l55.12" class="difflineminus">-public:</span>
<a href="#l55.13"></a><span id="l55.13" class="difflineplus">+ public:</span>
<a href="#l55.14"></a><span id="l55.14">   nsImportEncodeScan();</span>
<a href="#l55.15"></a><span id="l55.15">   ~nsImportEncodeScan();</span>
<a href="#l55.16"></a><span id="l55.16"> </span>
<a href="#l55.17"></a><span id="l55.17" class="difflineminus">-  bool    InitEncodeScan(bool appleSingleEncode, nsIFile *pFile, const char *pName, uint8_t * pBuf, uint32_t sz);</span>
<a href="#l55.18"></a><span id="l55.18" class="difflineminus">-  void  CleanUpEncodeScan(void);</span>
<a href="#l55.19"></a><span id="l55.19" class="difflineplus">+  bool InitEncodeScan(bool appleSingleEncode, nsIFile *pFile, const char *pName,</span>
<a href="#l55.20"></a><span id="l55.20" class="difflineplus">+                      uint8_t *pBuf, uint32_t sz);</span>
<a href="#l55.21"></a><span id="l55.21" class="difflineplus">+  void CleanUpEncodeScan(void);</span>
<a href="#l55.22"></a><span id="l55.22"> </span>
<a href="#l55.23"></a><span id="l55.23" class="difflineminus">-  virtual bool    Scan(bool *pDone) override;</span>
<a href="#l55.24"></a><span id="l55.24" class="difflineminus">-</span>
<a href="#l55.25"></a><span id="l55.25" class="difflineminus">-protected:</span>
<a href="#l55.26"></a><span id="l55.26" class="difflineminus">-  void   FillInEntries(int numEntries);</span>
<a href="#l55.27"></a><span id="l55.27" class="difflineminus">-  bool     AddEntries(void);</span>
<a href="#l55.28"></a><span id="l55.28" class="difflineplus">+  virtual bool Scan(bool *pDone) override;</span>
<a href="#l55.29"></a><span id="l55.29"> </span>
<a href="#l55.30"></a><span id="l55.30" class="difflineminus">-protected:</span>
<a href="#l55.31"></a><span id="l55.31" class="difflineminus">-  bool        m_isAppleSingle;</span>
<a href="#l55.32"></a><span id="l55.32" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt;   m_pInputFile;</span>
<a href="#l55.33"></a><span id="l55.33" class="difflineminus">-        nsCOMPtr&lt;nsIInputStream&gt; m_inputStream;</span>
<a href="#l55.34"></a><span id="l55.34" class="difflineminus">-  int      m_encodeScanState;</span>
<a href="#l55.35"></a><span id="l55.35" class="difflineminus">-  long      m_resourceForkSize;</span>
<a href="#l55.36"></a><span id="l55.36" class="difflineminus">-  long      m_dataForkSize;</span>
<a href="#l55.37"></a><span id="l55.37" class="difflineminus">-  nsCString    m_useFileName;</span>
<a href="#l55.38"></a><span id="l55.38" class="difflineplus">+ protected:</span>
<a href="#l55.39"></a><span id="l55.39" class="difflineplus">+  void FillInEntries(int numEntries);</span>
<a href="#l55.40"></a><span id="l55.40" class="difflineplus">+  bool AddEntries(void);</span>
<a href="#l55.41"></a><span id="l55.41" class="difflineplus">+</span>
<a href="#l55.42"></a><span id="l55.42" class="difflineplus">+ protected:</span>
<a href="#l55.43"></a><span id="l55.43" class="difflineplus">+  bool m_isAppleSingle;</span>
<a href="#l55.44"></a><span id="l55.44" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; m_pInputFile;</span>
<a href="#l55.45"></a><span id="l55.45" class="difflineplus">+  nsCOMPtr&lt;nsIInputStream&gt; m_inputStream;</span>
<a href="#l55.46"></a><span id="l55.46" class="difflineplus">+  int m_encodeScanState;</span>
<a href="#l55.47"></a><span id="l55.47" class="difflineplus">+  long m_resourceForkSize;</span>
<a href="#l55.48"></a><span id="l55.48" class="difflineplus">+  long m_dataForkSize;</span>
<a href="#l55.49"></a><span id="l55.49" class="difflineplus">+  nsCString m_useFileName;</span>
<a href="#l55.50"></a><span id="l55.50"> };</span>
<a href="#l55.51"></a><span id="l55.51"> </span>
<a href="#l55.52"></a><span id="l55.52"> #endif /* nsImportEncodeScan_h__ */</span>
<a href="#l55.53"></a><span id="l55.53" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l56.1"></a><span id="l56.1" class="difflineminus">--- a/mailnews/import/src/nsImportFieldMap.cpp</span>
<a href="#l56.2"></a><span id="l56.2" class="difflineplus">+++ b/mailnews/import/src/nsImportFieldMap.cpp</span>
<a href="#l56.3"></a><span id="l56.3" class="difflineat">@@ -1,378 +1,336 @@</span>
<a href="#l56.4"></a><span id="l56.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l56.5"></a><span id="l56.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l56.6"></a><span id="l56.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l56.7"></a><span id="l56.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l56.8"></a><span id="l56.8"> </span>
<a href="#l56.9"></a><span id="l56.9" class="difflineminus">-</span>
<a href="#l56.10"></a><span id="l56.10"> #include &quot;nscore.h&quot;</span>
<a href="#l56.11"></a><span id="l56.11"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l56.12"></a><span id="l56.12"> #include &quot;nsImportFieldMap.h&quot;</span>
<a href="#l56.13"></a><span id="l56.13"> #include &quot;nsImportStringBundle.h&quot;</span>
<a href="#l56.14"></a><span id="l56.14"> #include &quot;nsCRTGlue.h&quot;</span>
<a href="#l56.15"></a><span id="l56.15"> #include &quot;ImportDebug.h&quot;</span>
<a href="#l56.16"></a><span id="l56.16"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l56.17"></a><span id="l56.17"> </span>
<a href="#l56.18"></a><span id="l56.18"> ////////////////////////////////////////////////////////////////////////</span>
<a href="#l56.19"></a><span id="l56.19"> </span>
<a href="#l56.20"></a><span id="l56.20" class="difflineminus">-nsresult nsImportFieldMap::Create(nsIStringBundle *aBundle, nsISupports *aOuter, REFNSIID aIID, void **aResult)</span>
<a href="#l56.21"></a><span id="l56.21" class="difflineminus">-{</span>
<a href="#l56.22"></a><span id="l56.22" class="difflineminus">-  if (aOuter)</span>
<a href="#l56.23"></a><span id="l56.23" class="difflineminus">-    return NS_ERROR_NO_AGGREGATION;</span>
<a href="#l56.24"></a><span id="l56.24" class="difflineplus">+nsresult nsImportFieldMap::Create(nsIStringBundle *aBundle, nsISupports *aOuter,</span>
<a href="#l56.25"></a><span id="l56.25" class="difflineplus">+                                  REFNSIID aIID, void **aResult) {</span>
<a href="#l56.26"></a><span id="l56.26" class="difflineplus">+  if (aOuter) return NS_ERROR_NO_AGGREGATION;</span>
<a href="#l56.27"></a><span id="l56.27"> </span>
<a href="#l56.28"></a><span id="l56.28">   RefPtr&lt;nsImportFieldMap&gt; it = new nsImportFieldMap(aBundle);</span>
<a href="#l56.29"></a><span id="l56.29">   return it-&gt;QueryInterface(aIID, aResult);</span>
<a href="#l56.30"></a><span id="l56.30"> }</span>
<a href="#l56.31"></a><span id="l56.31"> </span>
<a href="#l56.32"></a><span id="l56.32"> NS_IMPL_ISUPPORTS(nsImportFieldMap, nsIImportFieldMap)</span>
<a href="#l56.33"></a><span id="l56.33"> </span>
<a href="#l56.34"></a><span id="l56.34" class="difflineminus">-NS_IMETHODIMP nsImportFieldMap::GetSkipFirstRecord(bool *result)</span>
<a href="#l56.35"></a><span id="l56.35" class="difflineminus">-{</span>
<a href="#l56.36"></a><span id="l56.36" class="difflineplus">+NS_IMETHODIMP nsImportFieldMap::GetSkipFirstRecord(bool *result) {</span>
<a href="#l56.37"></a><span id="l56.37">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l56.38"></a><span id="l56.38">   *result = m_skipFirstRecord;</span>
<a href="#l56.39"></a><span id="l56.39">   return NS_OK;</span>
<a href="#l56.40"></a><span id="l56.40"> }</span>
<a href="#l56.41"></a><span id="l56.41"> </span>
<a href="#l56.42"></a><span id="l56.42" class="difflineminus">-NS_IMETHODIMP nsImportFieldMap::SetSkipFirstRecord(bool aResult)</span>
<a href="#l56.43"></a><span id="l56.43" class="difflineminus">-{</span>
<a href="#l56.44"></a><span id="l56.44" class="difflineplus">+NS_IMETHODIMP nsImportFieldMap::SetSkipFirstRecord(bool aResult) {</span>
<a href="#l56.45"></a><span id="l56.45">   m_skipFirstRecord = aResult;</span>
<a href="#l56.46"></a><span id="l56.46">   return NS_OK;</span>
<a href="#l56.47"></a><span id="l56.47"> }</span>
<a href="#l56.48"></a><span id="l56.48"> </span>
<a href="#l56.49"></a><span id="l56.49" class="difflineminus">-nsImportFieldMap::nsImportFieldMap(nsIStringBundle *aBundle)</span>
<a href="#l56.50"></a><span id="l56.50" class="difflineminus">-{</span>
<a href="#l56.51"></a><span id="l56.51" class="difflineplus">+nsImportFieldMap::nsImportFieldMap(nsIStringBundle *aBundle) {</span>
<a href="#l56.52"></a><span id="l56.52">   m_numFields = 0;</span>
<a href="#l56.53"></a><span id="l56.53">   m_pFields = nullptr;</span>
<a href="#l56.54"></a><span id="l56.54">   m_pActive = nullptr;</span>
<a href="#l56.55"></a><span id="l56.55">   m_allocated = 0;</span>
<a href="#l56.56"></a><span id="l56.56">   // need to init the description array</span>
<a href="#l56.57"></a><span id="l56.57">   m_mozFieldCount = 0;</span>
<a href="#l56.58"></a><span id="l56.58" class="difflineminus">-    m_skipFirstRecord = false;</span>
<a href="#l56.59"></a><span id="l56.59" class="difflineplus">+  m_skipFirstRecord = false;</span>
<a href="#l56.60"></a><span id="l56.60">   nsCOMPtr&lt;nsIStringBundle&gt; pBundle = aBundle;</span>
<a href="#l56.61"></a><span id="l56.61"> </span>
<a href="#l56.62"></a><span id="l56.62">   nsString *pStr;</span>
<a href="#l56.63"></a><span id="l56.63" class="difflineminus">-  for (int32_t i = IMPORT_FIELD_DESC_START; i &lt;= IMPORT_FIELD_DESC_END; i++, m_mozFieldCount++) {</span>
<a href="#l56.64"></a><span id="l56.64" class="difflineplus">+  for (int32_t i = IMPORT_FIELD_DESC_START; i &lt;= IMPORT_FIELD_DESC_END;</span>
<a href="#l56.65"></a><span id="l56.65" class="difflineplus">+       i++, m_mozFieldCount++) {</span>
<a href="#l56.66"></a><span id="l56.66">     pStr = new nsString();</span>
<a href="#l56.67"></a><span id="l56.67">     if (pBundle) {</span>
<a href="#l56.68"></a><span id="l56.68">       nsImportStringBundle::GetStringByID(i, pBundle, *pStr);</span>
<a href="#l56.69"></a><span id="l56.69" class="difflineminus">-    }</span>
<a href="#l56.70"></a><span id="l56.70" class="difflineminus">-    else</span>
<a href="#l56.71"></a><span id="l56.71" class="difflineplus">+    } else</span>
<a href="#l56.72"></a><span id="l56.72">       pStr-&gt;AppendInt(i);</span>
<a href="#l56.73"></a><span id="l56.73">     m_descriptions.AppendElement(pStr);</span>
<a href="#l56.74"></a><span id="l56.74">   }</span>
<a href="#l56.75"></a><span id="l56.75"> }</span>
<a href="#l56.76"></a><span id="l56.76"> </span>
<a href="#l56.77"></a><span id="l56.77" class="difflineminus">-nsImportFieldMap::~nsImportFieldMap()</span>
<a href="#l56.78"></a><span id="l56.78" class="difflineminus">-{</span>
<a href="#l56.79"></a><span id="l56.79" class="difflineminus">-  if (m_pFields)</span>
<a href="#l56.80"></a><span id="l56.80" class="difflineminus">-    delete [] m_pFields;</span>
<a href="#l56.81"></a><span id="l56.81" class="difflineminus">-  if (m_pActive)</span>
<a href="#l56.82"></a><span id="l56.82" class="difflineminus">-    delete [] m_pActive;</span>
<a href="#l56.83"></a><span id="l56.83" class="difflineplus">+nsImportFieldMap::~nsImportFieldMap() {</span>
<a href="#l56.84"></a><span id="l56.84" class="difflineplus">+  if (m_pFields) delete[] m_pFields;</span>
<a href="#l56.85"></a><span id="l56.85" class="difflineplus">+  if (m_pActive) delete[] m_pActive;</span>
<a href="#l56.86"></a><span id="l56.86"> </span>
<a href="#l56.87"></a><span id="l56.87" class="difflineminus">-  nsString *  pStr;</span>
<a href="#l56.88"></a><span id="l56.88" class="difflineplus">+  nsString *pStr;</span>
<a href="#l56.89"></a><span id="l56.89">   for (int32_t i = 0; i &lt; m_mozFieldCount; i++) {</span>
<a href="#l56.90"></a><span id="l56.90">     pStr = m_descriptions.ElementAt(i);</span>
<a href="#l56.91"></a><span id="l56.91">     delete pStr;</span>
<a href="#l56.92"></a><span id="l56.92">   }</span>
<a href="#l56.93"></a><span id="l56.93">   m_descriptions.Clear();</span>
<a href="#l56.94"></a><span id="l56.94"> }</span>
<a href="#l56.95"></a><span id="l56.95"> </span>
<a href="#l56.96"></a><span id="l56.96" class="difflineminus">-</span>
<a href="#l56.97"></a><span id="l56.97" class="difflineminus">-NS_IMETHODIMP nsImportFieldMap::GetNumMozFields(int32_t *aNumFields)</span>
<a href="#l56.98"></a><span id="l56.98" class="difflineminus">-{</span>
<a href="#l56.99"></a><span id="l56.99" class="difflineplus">+NS_IMETHODIMP nsImportFieldMap::GetNumMozFields(int32_t *aNumFields) {</span>
<a href="#l56.100"></a><span id="l56.100">   NS_ASSERTION(aNumFields != nullptr, &quot;null ptr&quot;);</span>
<a href="#l56.101"></a><span id="l56.101" class="difflineminus">-  if (!aNumFields)</span>
<a href="#l56.102"></a><span id="l56.102" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l56.103"></a><span id="l56.103" class="difflineplus">+  if (!aNumFields) return NS_ERROR_NULL_POINTER;</span>
<a href="#l56.104"></a><span id="l56.104"> </span>
<a href="#l56.105"></a><span id="l56.105">   *aNumFields = m_mozFieldCount;</span>
<a href="#l56.106"></a><span id="l56.106">   return NS_OK;</span>
<a href="#l56.107"></a><span id="l56.107"> }</span>
<a href="#l56.108"></a><span id="l56.108"> </span>
<a href="#l56.109"></a><span id="l56.109" class="difflineminus">-NS_IMETHODIMP nsImportFieldMap::GetMapSize(int32_t *aNumFields)</span>
<a href="#l56.110"></a><span id="l56.110" class="difflineminus">-{</span>
<a href="#l56.111"></a><span id="l56.111" class="difflineplus">+NS_IMETHODIMP nsImportFieldMap::GetMapSize(int32_t *aNumFields) {</span>
<a href="#l56.112"></a><span id="l56.112">   NS_ASSERTION(aNumFields != nullptr, &quot;null ptr&quot;);</span>
<a href="#l56.113"></a><span id="l56.113" class="difflineminus">-  if (!aNumFields)</span>
<a href="#l56.114"></a><span id="l56.114" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l56.115"></a><span id="l56.115" class="difflineplus">+  if (!aNumFields) return NS_ERROR_NULL_POINTER;</span>
<a href="#l56.116"></a><span id="l56.116"> </span>
<a href="#l56.117"></a><span id="l56.117">   *aNumFields = m_numFields;</span>
<a href="#l56.118"></a><span id="l56.118">   return NS_OK;</span>
<a href="#l56.119"></a><span id="l56.119"> }</span>
<a href="#l56.120"></a><span id="l56.120"> </span>
<a href="#l56.121"></a><span id="l56.121" class="difflineminus">-NS_IMETHODIMP nsImportFieldMap::GetFieldDescription(int32_t index, char16_t **_retval)</span>
<a href="#l56.122"></a><span id="l56.122" class="difflineminus">-{</span>
<a href="#l56.123"></a><span id="l56.123" class="difflineplus">+NS_IMETHODIMP nsImportFieldMap::GetFieldDescription(int32_t index,</span>
<a href="#l56.124"></a><span id="l56.124" class="difflineplus">+                                                    char16_t **_retval) {</span>
<a href="#l56.125"></a><span id="l56.125">   NS_ASSERTION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l56.126"></a><span id="l56.126" class="difflineminus">-  if (!_retval)</span>
<a href="#l56.127"></a><span id="l56.127" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l56.128"></a><span id="l56.128" class="difflineplus">+  if (!_retval) return NS_ERROR_NULL_POINTER;</span>
<a href="#l56.129"></a><span id="l56.129"> </span>
<a href="#l56.130"></a><span id="l56.130">   *_retval = nullptr;</span>
<a href="#l56.131"></a><span id="l56.131">   if ((index &lt; 0) || ((size_t)index &gt;= m_descriptions.Length()))</span>
<a href="#l56.132"></a><span id="l56.132">     return NS_ERROR_FAILURE;</span>
<a href="#l56.133"></a><span id="l56.133"> </span>
<a href="#l56.134"></a><span id="l56.134">   *_retval = ToNewUnicode(*(m_descriptions.ElementAt(index)));</span>
<a href="#l56.135"></a><span id="l56.135">   return NS_OK;</span>
<a href="#l56.136"></a><span id="l56.136"> }</span>
<a href="#l56.137"></a><span id="l56.137"> </span>
<a href="#l56.138"></a><span id="l56.138" class="difflineminus">-NS_IMETHODIMP nsImportFieldMap::SetFieldMapSize(int32_t size)</span>
<a href="#l56.139"></a><span id="l56.139" class="difflineminus">-{</span>
<a href="#l56.140"></a><span id="l56.140" class="difflineplus">+NS_IMETHODIMP nsImportFieldMap::SetFieldMapSize(int32_t size) {</span>
<a href="#l56.141"></a><span id="l56.141">   nsresult rv = Allocate(size);</span>
<a href="#l56.142"></a><span id="l56.142" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l56.143"></a><span id="l56.143" class="difflineminus">-    return rv;</span>
<a href="#l56.144"></a><span id="l56.144" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l56.145"></a><span id="l56.145"> </span>
<a href="#l56.146"></a><span id="l56.146">   m_numFields = size;</span>
<a href="#l56.147"></a><span id="l56.147"> </span>
<a href="#l56.148"></a><span id="l56.148">   return NS_OK;</span>
<a href="#l56.149"></a><span id="l56.149"> }</span>
<a href="#l56.150"></a><span id="l56.150"> </span>
<a href="#l56.151"></a><span id="l56.151" class="difflineminus">-</span>
<a href="#l56.152"></a><span id="l56.152" class="difflineminus">-NS_IMETHODIMP nsImportFieldMap::DefaultFieldMap(int32_t size)</span>
<a href="#l56.153"></a><span id="l56.153" class="difflineminus">-{</span>
<a href="#l56.154"></a><span id="l56.154" class="difflineplus">+NS_IMETHODIMP nsImportFieldMap::DefaultFieldMap(int32_t size) {</span>
<a href="#l56.155"></a><span id="l56.155">   nsresult rv = SetFieldMapSize(size);</span>
<a href="#l56.156"></a><span id="l56.156" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l56.157"></a><span id="l56.157" class="difflineminus">-    return rv;</span>
<a href="#l56.158"></a><span id="l56.158" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l56.159"></a><span id="l56.159">   for (int32_t i = 0; i &lt; size; i++) {</span>
<a href="#l56.160"></a><span id="l56.160">     m_pFields[i] = i;</span>
<a href="#l56.161"></a><span id="l56.161">     m_pActive[i] = true;</span>
<a href="#l56.162"></a><span id="l56.162">   }</span>
<a href="#l56.163"></a><span id="l56.163"> </span>
<a href="#l56.164"></a><span id="l56.164">   return NS_OK;</span>
<a href="#l56.165"></a><span id="l56.165"> }</span>
<a href="#l56.166"></a><span id="l56.166"> </span>
<a href="#l56.167"></a><span id="l56.167" class="difflineminus">-NS_IMETHODIMP nsImportFieldMap::GetFieldMap(int32_t index, int32_t *_retval)</span>
<a href="#l56.168"></a><span id="l56.168" class="difflineminus">-{</span>
<a href="#l56.169"></a><span id="l56.169" class="difflineplus">+NS_IMETHODIMP nsImportFieldMap::GetFieldMap(int32_t index, int32_t *_retval) {</span>
<a href="#l56.170"></a><span id="l56.170">   NS_ASSERTION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l56.171"></a><span id="l56.171" class="difflineminus">-  if (!_retval)</span>
<a href="#l56.172"></a><span id="l56.172" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l56.173"></a><span id="l56.173" class="difflineplus">+  if (!_retval) return NS_ERROR_NULL_POINTER;</span>
<a href="#l56.174"></a><span id="l56.174"> </span>
<a href="#l56.175"></a><span id="l56.175" class="difflineminus">-</span>
<a href="#l56.176"></a><span id="l56.176" class="difflineminus">-  if ((index &lt; 0) || (index &gt;= m_numFields))</span>
<a href="#l56.177"></a><span id="l56.177" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l56.178"></a><span id="l56.178" class="difflineplus">+  if ((index &lt; 0) || (index &gt;= m_numFields)) return NS_ERROR_FAILURE;</span>
<a href="#l56.179"></a><span id="l56.179"> </span>
<a href="#l56.180"></a><span id="l56.180">   *_retval = m_pFields[index];</span>
<a href="#l56.181"></a><span id="l56.181">   return NS_OK;</span>
<a href="#l56.182"></a><span id="l56.182"> }</span>
<a href="#l56.183"></a><span id="l56.183"> </span>
<a href="#l56.184"></a><span id="l56.184" class="difflineminus">-NS_IMETHODIMP nsImportFieldMap::SetFieldMap(int32_t index, int32_t fieldNum)</span>
<a href="#l56.185"></a><span id="l56.185" class="difflineminus">-{</span>
<a href="#l56.186"></a><span id="l56.186" class="difflineplus">+NS_IMETHODIMP nsImportFieldMap::SetFieldMap(int32_t index, int32_t fieldNum) {</span>
<a href="#l56.187"></a><span id="l56.187">   if (index == -1) {</span>
<a href="#l56.188"></a><span id="l56.188">     nsresult rv = Allocate(m_numFields + 1);</span>
<a href="#l56.189"></a><span id="l56.189" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l56.190"></a><span id="l56.190" class="difflineminus">-      return rv;</span>
<a href="#l56.191"></a><span id="l56.191" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l56.192"></a><span id="l56.192">     index = m_numFields;</span>
<a href="#l56.193"></a><span id="l56.193">     m_numFields++;</span>
<a href="#l56.194"></a><span id="l56.194" class="difflineminus">-  }</span>
<a href="#l56.195"></a><span id="l56.195" class="difflineminus">-  else {</span>
<a href="#l56.196"></a><span id="l56.196" class="difflineminus">-    if ((index &lt; 0) || (index &gt;= m_numFields))</span>
<a href="#l56.197"></a><span id="l56.197" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l56.198"></a><span id="l56.198" class="difflineplus">+  } else {</span>
<a href="#l56.199"></a><span id="l56.199" class="difflineplus">+    if ((index &lt; 0) || (index &gt;= m_numFields)) return NS_ERROR_FAILURE;</span>
<a href="#l56.200"></a><span id="l56.200">   }</span>
<a href="#l56.201"></a><span id="l56.201"> </span>
<a href="#l56.202"></a><span id="l56.202">   if ((fieldNum != -1) &amp;&amp; ((fieldNum &lt; 0) || (fieldNum &gt;= m_mozFieldCount)))</span>
<a href="#l56.203"></a><span id="l56.203">     return NS_ERROR_FAILURE;</span>
<a href="#l56.204"></a><span id="l56.204"> </span>
<a href="#l56.205"></a><span id="l56.205">   m_pFields[index] = fieldNum;</span>
<a href="#l56.206"></a><span id="l56.206">   return NS_OK;</span>
<a href="#l56.207"></a><span id="l56.207"> }</span>
<a href="#l56.208"></a><span id="l56.208"> </span>
<a href="#l56.209"></a><span id="l56.209" class="difflineminus">-NS_IMETHODIMP nsImportFieldMap::GetFieldActive(int32_t index, bool *active)</span>
<a href="#l56.210"></a><span id="l56.210" class="difflineminus">-{</span>
<a href="#l56.211"></a><span id="l56.211" class="difflineplus">+NS_IMETHODIMP nsImportFieldMap::GetFieldActive(int32_t index, bool *active) {</span>
<a href="#l56.212"></a><span id="l56.212">   NS_ASSERTION(active != nullptr, &quot;null ptr&quot;);</span>
<a href="#l56.213"></a><span id="l56.213" class="difflineminus">-  if (!active)</span>
<a href="#l56.214"></a><span id="l56.214" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l56.215"></a><span id="l56.215" class="difflineminus">-  if ((index &lt; 0) || (index &gt;= m_numFields))</span>
<a href="#l56.216"></a><span id="l56.216" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l56.217"></a><span id="l56.217" class="difflineplus">+  if (!active) return NS_ERROR_NULL_POINTER;</span>
<a href="#l56.218"></a><span id="l56.218" class="difflineplus">+  if ((index &lt; 0) || (index &gt;= m_numFields)) return NS_ERROR_FAILURE;</span>
<a href="#l56.219"></a><span id="l56.219"> </span>
<a href="#l56.220"></a><span id="l56.220">   *active = m_pActive[index];</span>
<a href="#l56.221"></a><span id="l56.221">   return NS_OK;</span>
<a href="#l56.222"></a><span id="l56.222"> }</span>
<a href="#l56.223"></a><span id="l56.223"> </span>
<a href="#l56.224"></a><span id="l56.224" class="difflineminus">-NS_IMETHODIMP nsImportFieldMap::SetFieldActive(int32_t index, bool active)</span>
<a href="#l56.225"></a><span id="l56.225" class="difflineminus">-{</span>
<a href="#l56.226"></a><span id="l56.226" class="difflineminus">-  if ((index &lt; 0) || (index &gt;= m_numFields))</span>
<a href="#l56.227"></a><span id="l56.227" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l56.228"></a><span id="l56.228" class="difflineplus">+NS_IMETHODIMP nsImportFieldMap::SetFieldActive(int32_t index, bool active) {</span>
<a href="#l56.229"></a><span id="l56.229" class="difflineplus">+  if ((index &lt; 0) || (index &gt;= m_numFields)) return NS_ERROR_FAILURE;</span>
<a href="#l56.230"></a><span id="l56.230"> </span>
<a href="#l56.231"></a><span id="l56.231">   m_pActive[index] = active;</span>
<a href="#l56.232"></a><span id="l56.232">   return NS_OK;</span>
<a href="#l56.233"></a><span id="l56.233"> }</span>
<a href="#l56.234"></a><span id="l56.234"> </span>
<a href="#l56.235"></a><span id="l56.235" class="difflineminus">-</span>
<a href="#l56.236"></a><span id="l56.236" class="difflineminus">-NS_IMETHODIMP nsImportFieldMap::SetFieldValue(nsIAddrDatabase *database, nsIMdbRow *row, int32_t fieldNum, const char16_t *value)</span>
<a href="#l56.237"></a><span id="l56.237" class="difflineminus">-{</span>
<a href="#l56.238"></a><span id="l56.238" class="difflineplus">+NS_IMETHODIMP nsImportFieldMap::SetFieldValue(nsIAddrDatabase *database,</span>
<a href="#l56.239"></a><span id="l56.239" class="difflineplus">+                                              nsIMdbRow *row, int32_t fieldNum,</span>
<a href="#l56.240"></a><span id="l56.240" class="difflineplus">+                                              const char16_t *value) {</span>
<a href="#l56.241"></a><span id="l56.241">   NS_ASSERTION(database != nullptr, &quot;null ptr&quot;);</span>
<a href="#l56.242"></a><span id="l56.242">   NS_ASSERTION(row != nullptr, &quot;null ptr&quot;);</span>
<a href="#l56.243"></a><span id="l56.243">   NS_ASSERTION(value != nullptr, &quot;null ptr&quot;);</span>
<a href="#l56.244"></a><span id="l56.244" class="difflineminus">-  if (!database || !row || !value)</span>
<a href="#l56.245"></a><span id="l56.245" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l56.246"></a><span id="l56.246" class="difflineplus">+  if (!database || !row || !value) return NS_ERROR_NULL_POINTER;</span>
<a href="#l56.247"></a><span id="l56.247"> </span>
<a href="#l56.248"></a><span id="l56.248">   // Allow the special value for a null field</span>
<a href="#l56.249"></a><span id="l56.249" class="difflineminus">-  if (fieldNum == -1)</span>
<a href="#l56.250"></a><span id="l56.250" class="difflineminus">-    return NS_OK;</span>
<a href="#l56.251"></a><span id="l56.251" class="difflineplus">+  if (fieldNum == -1) return NS_OK;</span>
<a href="#l56.252"></a><span id="l56.252"> </span>
<a href="#l56.253"></a><span id="l56.253" class="difflineminus">-  if ((fieldNum &lt; 0) || (fieldNum &gt;= m_mozFieldCount))</span>
<a href="#l56.254"></a><span id="l56.254" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l56.255"></a><span id="l56.255" class="difflineplus">+  if ((fieldNum &lt; 0) || (fieldNum &gt;= m_mozFieldCount)) return NS_ERROR_FAILURE;</span>
<a href="#l56.256"></a><span id="l56.256"> </span>
<a href="#l56.257"></a><span id="l56.257">   // UGGG!!!!! lot's of typing here!</span>
<a href="#l56.258"></a><span id="l56.258">   nsresult rv;</span>
<a href="#l56.259"></a><span id="l56.259"> </span>
<a href="#l56.260"></a><span id="l56.260">   nsString str(value);</span>
<a href="#l56.261"></a><span id="l56.261">   char *pVal = ToNewUTF8String(str);</span>
<a href="#l56.262"></a><span id="l56.262"> </span>
<a href="#l56.263"></a><span id="l56.263" class="difflineminus">-  switch(fieldNum) {</span>
<a href="#l56.264"></a><span id="l56.264" class="difflineminus">-  case 0:</span>
<a href="#l56.265"></a><span id="l56.265" class="difflineminus">-    rv = database-&gt;AddFirstName(row, pVal);</span>
<a href="#l56.266"></a><span id="l56.266" class="difflineminus">-    break;</span>
<a href="#l56.267"></a><span id="l56.267" class="difflineminus">-  case 1:</span>
<a href="#l56.268"></a><span id="l56.268" class="difflineminus">-    rv = database-&gt;AddLastName(row, pVal);</span>
<a href="#l56.269"></a><span id="l56.269" class="difflineminus">-    break;</span>
<a href="#l56.270"></a><span id="l56.270" class="difflineminus">-  case 2:</span>
<a href="#l56.271"></a><span id="l56.271" class="difflineminus">-    rv = database-&gt;AddDisplayName(row, pVal);</span>
<a href="#l56.272"></a><span id="l56.272" class="difflineminus">-    break;</span>
<a href="#l56.273"></a><span id="l56.273" class="difflineminus">-  case 3:</span>
<a href="#l56.274"></a><span id="l56.274" class="difflineminus">-    rv = database-&gt;AddNickName(row, pVal);</span>
<a href="#l56.275"></a><span id="l56.275" class="difflineminus">-    break;</span>
<a href="#l56.276"></a><span id="l56.276" class="difflineminus">-  case 4:</span>
<a href="#l56.277"></a><span id="l56.277" class="difflineminus">-    rv = database-&gt;AddPrimaryEmail(row, pVal);</span>
<a href="#l56.278"></a><span id="l56.278" class="difflineminus">-    break;</span>
<a href="#l56.279"></a><span id="l56.279" class="difflineminus">-  case 5:</span>
<a href="#l56.280"></a><span id="l56.280" class="difflineminus">-    rv = database-&gt;Add2ndEmail(row, pVal);</span>
<a href="#l56.281"></a><span id="l56.281" class="difflineminus">-    break;</span>
<a href="#l56.282"></a><span id="l56.282" class="difflineminus">-  case 6:</span>
<a href="#l56.283"></a><span id="l56.283" class="difflineminus">-    rv = database-&gt;AddWorkPhone(row, pVal);</span>
<a href="#l56.284"></a><span id="l56.284" class="difflineminus">-    break;</span>
<a href="#l56.285"></a><span id="l56.285" class="difflineminus">-  case 7:</span>
<a href="#l56.286"></a><span id="l56.286" class="difflineminus">-    rv = database-&gt;AddHomePhone(row, pVal);</span>
<a href="#l56.287"></a><span id="l56.287" class="difflineminus">-    break;</span>
<a href="#l56.288"></a><span id="l56.288" class="difflineminus">-  case 8:</span>
<a href="#l56.289"></a><span id="l56.289" class="difflineminus">-    rv = database-&gt;AddFaxNumber(row, pVal);</span>
<a href="#l56.290"></a><span id="l56.290" class="difflineminus">-    break;</span>
<a href="#l56.291"></a><span id="l56.291" class="difflineminus">-  case 9:</span>
<a href="#l56.292"></a><span id="l56.292" class="difflineminus">-    rv = database-&gt;AddPagerNumber(row, pVal);</span>
<a href="#l56.293"></a><span id="l56.293" class="difflineminus">-    break;</span>
<a href="#l56.294"></a><span id="l56.294" class="difflineminus">-  case 10:</span>
<a href="#l56.295"></a><span id="l56.295" class="difflineminus">-    rv = database-&gt;AddCellularNumber(row, pVal);</span>
<a href="#l56.296"></a><span id="l56.296" class="difflineminus">-    break;</span>
<a href="#l56.297"></a><span id="l56.297" class="difflineminus">-  case 11:</span>
<a href="#l56.298"></a><span id="l56.298" class="difflineminus">-    rv = database-&gt;AddHomeAddress(row, pVal);</span>
<a href="#l56.299"></a><span id="l56.299" class="difflineminus">-    break;</span>
<a href="#l56.300"></a><span id="l56.300" class="difflineminus">-  case 12:</span>
<a href="#l56.301"></a><span id="l56.301" class="difflineminus">-    rv = database-&gt;AddHomeAddress2(row, pVal);</span>
<a href="#l56.302"></a><span id="l56.302" class="difflineminus">-    break;</span>
<a href="#l56.303"></a><span id="l56.303" class="difflineminus">-  case 13:</span>
<a href="#l56.304"></a><span id="l56.304" class="difflineminus">-    rv = database-&gt;AddHomeCity(row, pVal);</span>
<a href="#l56.305"></a><span id="l56.305" class="difflineminus">-    break;</span>
<a href="#l56.306"></a><span id="l56.306" class="difflineminus">-  case 14:</span>
<a href="#l56.307"></a><span id="l56.307" class="difflineminus">-    rv = database-&gt;AddHomeState(row, pVal);</span>
<a href="#l56.308"></a><span id="l56.308" class="difflineminus">-    break;</span>
<a href="#l56.309"></a><span id="l56.309" class="difflineminus">-  case 15:</span>
<a href="#l56.310"></a><span id="l56.310" class="difflineminus">-    rv = database-&gt;AddHomeZipCode(row, pVal);</span>
<a href="#l56.311"></a><span id="l56.311" class="difflineminus">-    break;</span>
<a href="#l56.312"></a><span id="l56.312" class="difflineminus">-  case 16:</span>
<a href="#l56.313"></a><span id="l56.313" class="difflineminus">-    rv = database-&gt;AddHomeCountry(row, pVal);</span>
<a href="#l56.314"></a><span id="l56.314" class="difflineminus">-    break;</span>
<a href="#l56.315"></a><span id="l56.315" class="difflineminus">-  case 17:</span>
<a href="#l56.316"></a><span id="l56.316" class="difflineminus">-    rv = database-&gt;AddWorkAddress(row, pVal);</span>
<a href="#l56.317"></a><span id="l56.317" class="difflineminus">-    break;</span>
<a href="#l56.318"></a><span id="l56.318" class="difflineminus">-  case 18:</span>
<a href="#l56.319"></a><span id="l56.319" class="difflineminus">-    rv = database-&gt;AddWorkAddress2(row, pVal);</span>
<a href="#l56.320"></a><span id="l56.320" class="difflineminus">-    break;</span>
<a href="#l56.321"></a><span id="l56.321" class="difflineminus">-  case 19:</span>
<a href="#l56.322"></a><span id="l56.322" class="difflineminus">-    rv = database-&gt;AddWorkCity(row, pVal);</span>
<a href="#l56.323"></a><span id="l56.323" class="difflineminus">-    break;</span>
<a href="#l56.324"></a><span id="l56.324" class="difflineminus">-  case 20:</span>
<a href="#l56.325"></a><span id="l56.325" class="difflineminus">-    rv = database-&gt;AddWorkState(row, pVal);</span>
<a href="#l56.326"></a><span id="l56.326" class="difflineminus">-    break;</span>
<a href="#l56.327"></a><span id="l56.327" class="difflineminus">-  case 21:</span>
<a href="#l56.328"></a><span id="l56.328" class="difflineminus">-    rv = database-&gt;AddWorkZipCode(row, pVal);</span>
<a href="#l56.329"></a><span id="l56.329" class="difflineminus">-    break;</span>
<a href="#l56.330"></a><span id="l56.330" class="difflineminus">-  case 22:</span>
<a href="#l56.331"></a><span id="l56.331" class="difflineminus">-    rv = database-&gt;AddWorkCountry(row, pVal);</span>
<a href="#l56.332"></a><span id="l56.332" class="difflineminus">-    break;</span>
<a href="#l56.333"></a><span id="l56.333" class="difflineminus">-  case 23:</span>
<a href="#l56.334"></a><span id="l56.334" class="difflineminus">-    rv = database-&gt;AddJobTitle(row, pVal);</span>
<a href="#l56.335"></a><span id="l56.335" class="difflineminus">-    break;</span>
<a href="#l56.336"></a><span id="l56.336" class="difflineminus">-  case 24:</span>
<a href="#l56.337"></a><span id="l56.337" class="difflineminus">-    rv = database-&gt;AddDepartment(row, pVal);</span>
<a href="#l56.338"></a><span id="l56.338" class="difflineminus">-    break;</span>
<a href="#l56.339"></a><span id="l56.339" class="difflineminus">-  case 25:</span>
<a href="#l56.340"></a><span id="l56.340" class="difflineminus">-    rv = database-&gt;AddCompany(row, pVal);</span>
<a href="#l56.341"></a><span id="l56.341" class="difflineminus">-    break;</span>
<a href="#l56.342"></a><span id="l56.342" class="difflineminus">-  case 26:</span>
<a href="#l56.343"></a><span id="l56.343" class="difflineminus">-    rv = database-&gt;AddWebPage1(row, pVal);</span>
<a href="#l56.344"></a><span id="l56.344" class="difflineminus">-    break;</span>
<a href="#l56.345"></a><span id="l56.345" class="difflineminus">-  case 27:</span>
<a href="#l56.346"></a><span id="l56.346" class="difflineminus">-    rv = database-&gt;AddWebPage2(row, pVal);</span>
<a href="#l56.347"></a><span id="l56.347" class="difflineminus">-    break;</span>
<a href="#l56.348"></a><span id="l56.348" class="difflineminus">-  case 28:</span>
<a href="#l56.349"></a><span id="l56.349" class="difflineminus">-    rv = database-&gt;AddBirthYear(row, pVal);</span>
<a href="#l56.350"></a><span id="l56.350" class="difflineminus">-    break;</span>
<a href="#l56.351"></a><span id="l56.351" class="difflineminus">-  case 29:</span>
<a href="#l56.352"></a><span id="l56.352" class="difflineminus">-    rv = database-&gt;AddBirthMonth(row, pVal);</span>
<a href="#l56.353"></a><span id="l56.353" class="difflineminus">-    break;</span>
<a href="#l56.354"></a><span id="l56.354" class="difflineminus">-  case 30:</span>
<a href="#l56.355"></a><span id="l56.355" class="difflineminus">-    rv = database-&gt;AddBirthDay(row, pVal);</span>
<a href="#l56.356"></a><span id="l56.356" class="difflineminus">-    break;</span>
<a href="#l56.357"></a><span id="l56.357" class="difflineminus">-  case 31:</span>
<a href="#l56.358"></a><span id="l56.358" class="difflineminus">-    rv = database-&gt;AddCustom1(row, pVal);</span>
<a href="#l56.359"></a><span id="l56.359" class="difflineminus">-    break;</span>
<a href="#l56.360"></a><span id="l56.360" class="difflineminus">-  case 32:</span>
<a href="#l56.361"></a><span id="l56.361" class="difflineminus">-    rv = database-&gt;AddCustom2(row, pVal);</span>
<a href="#l56.362"></a><span id="l56.362" class="difflineminus">-    break;</span>
<a href="#l56.363"></a><span id="l56.363" class="difflineminus">-  case 33:</span>
<a href="#l56.364"></a><span id="l56.364" class="difflineminus">-    rv = database-&gt;AddCustom3(row, pVal);</span>
<a href="#l56.365"></a><span id="l56.365" class="difflineminus">-    break;</span>
<a href="#l56.366"></a><span id="l56.366" class="difflineminus">-  case 34:</span>
<a href="#l56.367"></a><span id="l56.367" class="difflineminus">-    rv = database-&gt;AddCustom4(row, pVal);</span>
<a href="#l56.368"></a><span id="l56.368" class="difflineminus">-    break;</span>
<a href="#l56.369"></a><span id="l56.369" class="difflineminus">-  case 35:</span>
<a href="#l56.370"></a><span id="l56.370" class="difflineminus">-    rv = database-&gt;AddNotes(row, pVal);</span>
<a href="#l56.371"></a><span id="l56.371" class="difflineminus">-    break;</span>
<a href="#l56.372"></a><span id="l56.372" class="difflineminus">-  case 36:</span>
<a href="#l56.373"></a><span id="l56.373" class="difflineminus">-    rv = database-&gt;AddAimScreenName(row, pVal);</span>
<a href="#l56.374"></a><span id="l56.374" class="difflineminus">-    break;</span>
<a href="#l56.375"></a><span id="l56.375" class="difflineminus">-  default:</span>
<a href="#l56.376"></a><span id="l56.376" class="difflineminus">-    /* Get the field description, and add it as an anonymous attr? */</span>
<a href="#l56.377"></a><span id="l56.377" class="difflineminus">-    /* OR WHAT???? */</span>
<a href="#l56.378"></a><span id="l56.378" class="difflineminus">-    {</span>
<a href="#l56.379"></a><span id="l56.379" class="difflineminus">-      rv = NS_ERROR_FAILURE;</span>
<a href="#l56.380"></a><span id="l56.380" class="difflineminus">-    }</span>
<a href="#l56.381"></a><span id="l56.381" class="difflineplus">+  switch (fieldNum) {</span>
<a href="#l56.382"></a><span id="l56.382" class="difflineplus">+    case 0:</span>
<a href="#l56.383"></a><span id="l56.383" class="difflineplus">+      rv = database-&gt;AddFirstName(row, pVal);</span>
<a href="#l56.384"></a><span id="l56.384" class="difflineplus">+      break;</span>
<a href="#l56.385"></a><span id="l56.385" class="difflineplus">+    case 1:</span>
<a href="#l56.386"></a><span id="l56.386" class="difflineplus">+      rv = database-&gt;AddLastName(row, pVal);</span>
<a href="#l56.387"></a><span id="l56.387" class="difflineplus">+      break;</span>
<a href="#l56.388"></a><span id="l56.388" class="difflineplus">+    case 2:</span>
<a href="#l56.389"></a><span id="l56.389" class="difflineplus">+      rv = database-&gt;AddDisplayName(row, pVal);</span>
<a href="#l56.390"></a><span id="l56.390" class="difflineplus">+      break;</span>
<a href="#l56.391"></a><span id="l56.391" class="difflineplus">+    case 3:</span>
<a href="#l56.392"></a><span id="l56.392" class="difflineplus">+      rv = database-&gt;AddNickName(row, pVal);</span>
<a href="#l56.393"></a><span id="l56.393" class="difflineplus">+      break;</span>
<a href="#l56.394"></a><span id="l56.394" class="difflineplus">+    case 4:</span>
<a href="#l56.395"></a><span id="l56.395" class="difflineplus">+      rv = database-&gt;AddPrimaryEmail(row, pVal);</span>
<a href="#l56.396"></a><span id="l56.396" class="difflineplus">+      break;</span>
<a href="#l56.397"></a><span id="l56.397" class="difflineplus">+    case 5:</span>
<a href="#l56.398"></a><span id="l56.398" class="difflineplus">+      rv = database-&gt;Add2ndEmail(row, pVal);</span>
<a href="#l56.399"></a><span id="l56.399" class="difflineplus">+      break;</span>
<a href="#l56.400"></a><span id="l56.400" class="difflineplus">+    case 6:</span>
<a href="#l56.401"></a><span id="l56.401" class="difflineplus">+      rv = database-&gt;AddWorkPhone(row, pVal);</span>
<a href="#l56.402"></a><span id="l56.402" class="difflineplus">+      break;</span>
<a href="#l56.403"></a><span id="l56.403" class="difflineplus">+    case 7:</span>
<a href="#l56.404"></a><span id="l56.404" class="difflineplus">+      rv = database-&gt;AddHomePhone(row, pVal);</span>
<a href="#l56.405"></a><span id="l56.405" class="difflineplus">+      break;</span>
<a href="#l56.406"></a><span id="l56.406" class="difflineplus">+    case 8:</span>
<a href="#l56.407"></a><span id="l56.407" class="difflineplus">+      rv = database-&gt;AddFaxNumber(row, pVal);</span>
<a href="#l56.408"></a><span id="l56.408" class="difflineplus">+      break;</span>
<a href="#l56.409"></a><span id="l56.409" class="difflineplus">+    case 9:</span>
<a href="#l56.410"></a><span id="l56.410" class="difflineplus">+      rv = database-&gt;AddPagerNumber(row, pVal);</span>
<a href="#l56.411"></a><span id="l56.411" class="difflineplus">+      break;</span>
<a href="#l56.412"></a><span id="l56.412" class="difflineplus">+    case 10:</span>
<a href="#l56.413"></a><span id="l56.413" class="difflineplus">+      rv = database-&gt;AddCellularNumber(row, pVal);</span>
<a href="#l56.414"></a><span id="l56.414" class="difflineplus">+      break;</span>
<a href="#l56.415"></a><span id="l56.415" class="difflineplus">+    case 11:</span>
<a href="#l56.416"></a><span id="l56.416" class="difflineplus">+      rv = database-&gt;AddHomeAddress(row, pVal);</span>
<a href="#l56.417"></a><span id="l56.417" class="difflineplus">+      break;</span>
<a href="#l56.418"></a><span id="l56.418" class="difflineplus">+    case 12:</span>
<a href="#l56.419"></a><span id="l56.419" class="difflineplus">+      rv = database-&gt;AddHomeAddress2(row, pVal);</span>
<a href="#l56.420"></a><span id="l56.420" class="difflineplus">+      break;</span>
<a href="#l56.421"></a><span id="l56.421" class="difflineplus">+    case 13:</span>
<a href="#l56.422"></a><span id="l56.422" class="difflineplus">+      rv = database-&gt;AddHomeCity(row, pVal);</span>
<a href="#l56.423"></a><span id="l56.423" class="difflineplus">+      break;</span>
<a href="#l56.424"></a><span id="l56.424" class="difflineplus">+    case 14:</span>
<a href="#l56.425"></a><span id="l56.425" class="difflineplus">+      rv = database-&gt;AddHomeState(row, pVal);</span>
<a href="#l56.426"></a><span id="l56.426" class="difflineplus">+      break;</span>
<a href="#l56.427"></a><span id="l56.427" class="difflineplus">+    case 15:</span>
<a href="#l56.428"></a><span id="l56.428" class="difflineplus">+      rv = database-&gt;AddHomeZipCode(row, pVal);</span>
<a href="#l56.429"></a><span id="l56.429" class="difflineplus">+      break;</span>
<a href="#l56.430"></a><span id="l56.430" class="difflineplus">+    case 16:</span>
<a href="#l56.431"></a><span id="l56.431" class="difflineplus">+      rv = database-&gt;AddHomeCountry(row, pVal);</span>
<a href="#l56.432"></a><span id="l56.432" class="difflineplus">+      break;</span>
<a href="#l56.433"></a><span id="l56.433" class="difflineplus">+    case 17:</span>
<a href="#l56.434"></a><span id="l56.434" class="difflineplus">+      rv = database-&gt;AddWorkAddress(row, pVal);</span>
<a href="#l56.435"></a><span id="l56.435" class="difflineplus">+      break;</span>
<a href="#l56.436"></a><span id="l56.436" class="difflineplus">+    case 18:</span>
<a href="#l56.437"></a><span id="l56.437" class="difflineplus">+      rv = database-&gt;AddWorkAddress2(row, pVal);</span>
<a href="#l56.438"></a><span id="l56.438" class="difflineplus">+      break;</span>
<a href="#l56.439"></a><span id="l56.439" class="difflineplus">+    case 19:</span>
<a href="#l56.440"></a><span id="l56.440" class="difflineplus">+      rv = database-&gt;AddWorkCity(row, pVal);</span>
<a href="#l56.441"></a><span id="l56.441" class="difflineplus">+      break;</span>
<a href="#l56.442"></a><span id="l56.442" class="difflineplus">+    case 20:</span>
<a href="#l56.443"></a><span id="l56.443" class="difflineplus">+      rv = database-&gt;AddWorkState(row, pVal);</span>
<a href="#l56.444"></a><span id="l56.444" class="difflineplus">+      break;</span>
<a href="#l56.445"></a><span id="l56.445" class="difflineplus">+    case 21:</span>
<a href="#l56.446"></a><span id="l56.446" class="difflineplus">+      rv = database-&gt;AddWorkZipCode(row, pVal);</span>
<a href="#l56.447"></a><span id="l56.447" class="difflineplus">+      break;</span>
<a href="#l56.448"></a><span id="l56.448" class="difflineplus">+    case 22:</span>
<a href="#l56.449"></a><span id="l56.449" class="difflineplus">+      rv = database-&gt;AddWorkCountry(row, pVal);</span>
<a href="#l56.450"></a><span id="l56.450" class="difflineplus">+      break;</span>
<a href="#l56.451"></a><span id="l56.451" class="difflineplus">+    case 23:</span>
<a href="#l56.452"></a><span id="l56.452" class="difflineplus">+      rv = database-&gt;AddJobTitle(row, pVal);</span>
<a href="#l56.453"></a><span id="l56.453" class="difflineplus">+      break;</span>
<a href="#l56.454"></a><span id="l56.454" class="difflineplus">+    case 24:</span>
<a href="#l56.455"></a><span id="l56.455" class="difflineplus">+      rv = database-&gt;AddDepartment(row, pVal);</span>
<a href="#l56.456"></a><span id="l56.456" class="difflineplus">+      break;</span>
<a href="#l56.457"></a><span id="l56.457" class="difflineplus">+    case 25:</span>
<a href="#l56.458"></a><span id="l56.458" class="difflineplus">+      rv = database-&gt;AddCompany(row, pVal);</span>
<a href="#l56.459"></a><span id="l56.459" class="difflineplus">+      break;</span>
<a href="#l56.460"></a><span id="l56.460" class="difflineplus">+    case 26:</span>
<a href="#l56.461"></a><span id="l56.461" class="difflineplus">+      rv = database-&gt;AddWebPage1(row, pVal);</span>
<a href="#l56.462"></a><span id="l56.462" class="difflineplus">+      break;</span>
<a href="#l56.463"></a><span id="l56.463" class="difflineplus">+    case 27:</span>
<a href="#l56.464"></a><span id="l56.464" class="difflineplus">+      rv = database-&gt;AddWebPage2(row, pVal);</span>
<a href="#l56.465"></a><span id="l56.465" class="difflineplus">+      break;</span>
<a href="#l56.466"></a><span id="l56.466" class="difflineplus">+    case 28:</span>
<a href="#l56.467"></a><span id="l56.467" class="difflineplus">+      rv = database-&gt;AddBirthYear(row, pVal);</span>
<a href="#l56.468"></a><span id="l56.468" class="difflineplus">+      break;</span>
<a href="#l56.469"></a><span id="l56.469" class="difflineplus">+    case 29:</span>
<a href="#l56.470"></a><span id="l56.470" class="difflineplus">+      rv = database-&gt;AddBirthMonth(row, pVal);</span>
<a href="#l56.471"></a><span id="l56.471" class="difflineplus">+      break;</span>
<a href="#l56.472"></a><span id="l56.472" class="difflineplus">+    case 30:</span>
<a href="#l56.473"></a><span id="l56.473" class="difflineplus">+      rv = database-&gt;AddBirthDay(row, pVal);</span>
<a href="#l56.474"></a><span id="l56.474" class="difflineplus">+      break;</span>
<a href="#l56.475"></a><span id="l56.475" class="difflineplus">+    case 31:</span>
<a href="#l56.476"></a><span id="l56.476" class="difflineplus">+      rv = database-&gt;AddCustom1(row, pVal);</span>
<a href="#l56.477"></a><span id="l56.477" class="difflineplus">+      break;</span>
<a href="#l56.478"></a><span id="l56.478" class="difflineplus">+    case 32:</span>
<a href="#l56.479"></a><span id="l56.479" class="difflineplus">+      rv = database-&gt;AddCustom2(row, pVal);</span>
<a href="#l56.480"></a><span id="l56.480" class="difflineplus">+      break;</span>
<a href="#l56.481"></a><span id="l56.481" class="difflineplus">+    case 33:</span>
<a href="#l56.482"></a><span id="l56.482" class="difflineplus">+      rv = database-&gt;AddCustom3(row, pVal);</span>
<a href="#l56.483"></a><span id="l56.483" class="difflineplus">+      break;</span>
<a href="#l56.484"></a><span id="l56.484" class="difflineplus">+    case 34:</span>
<a href="#l56.485"></a><span id="l56.485" class="difflineplus">+      rv = database-&gt;AddCustom4(row, pVal);</span>
<a href="#l56.486"></a><span id="l56.486" class="difflineplus">+      break;</span>
<a href="#l56.487"></a><span id="l56.487" class="difflineplus">+    case 35:</span>
<a href="#l56.488"></a><span id="l56.488" class="difflineplus">+      rv = database-&gt;AddNotes(row, pVal);</span>
<a href="#l56.489"></a><span id="l56.489" class="difflineplus">+      break;</span>
<a href="#l56.490"></a><span id="l56.490" class="difflineplus">+    case 36:</span>
<a href="#l56.491"></a><span id="l56.491" class="difflineplus">+      rv = database-&gt;AddAimScreenName(row, pVal);</span>
<a href="#l56.492"></a><span id="l56.492" class="difflineplus">+      break;</span>
<a href="#l56.493"></a><span id="l56.493" class="difflineplus">+    default:</span>
<a href="#l56.494"></a><span id="l56.494" class="difflineplus">+      /* Get the field description, and add it as an anonymous attr? */</span>
<a href="#l56.495"></a><span id="l56.495" class="difflineplus">+      /* OR WHAT???? */</span>
<a href="#l56.496"></a><span id="l56.496" class="difflineplus">+      { rv = NS_ERROR_FAILURE; }</span>
<a href="#l56.497"></a><span id="l56.497">   }</span>
<a href="#l56.498"></a><span id="l56.498"> </span>
<a href="#l56.499"></a><span id="l56.499">   free(pVal);</span>
<a href="#l56.500"></a><span id="l56.500"> </span>
<a href="#l56.501"></a><span id="l56.501">   return rv;</span>
<a href="#l56.502"></a><span id="l56.502"> }</span>
<a href="#l56.503"></a><span id="l56.503"> </span>
<a href="#l56.504"></a><span id="l56.504" class="difflineminus">-</span>
<a href="#l56.505"></a><span id="l56.505" class="difflineminus">-nsresult nsImportFieldMap::Allocate(int32_t newSize)</span>
<a href="#l56.506"></a><span id="l56.506" class="difflineminus">-{</span>
<a href="#l56.507"></a><span id="l56.507" class="difflineminus">-  if (newSize &lt;= m_allocated)</span>
<a href="#l56.508"></a><span id="l56.508" class="difflineminus">-    return NS_OK;</span>
<a href="#l56.509"></a><span id="l56.509" class="difflineplus">+nsresult nsImportFieldMap::Allocate(int32_t newSize) {</span>
<a href="#l56.510"></a><span id="l56.510" class="difflineplus">+  if (newSize &lt;= m_allocated) return NS_OK;</span>
<a href="#l56.511"></a><span id="l56.511"> </span>
<a href="#l56.512"></a><span id="l56.512">   int32_t sz = m_allocated;</span>
<a href="#l56.513"></a><span id="l56.513" class="difflineminus">-  while (sz &lt; newSize)</span>
<a href="#l56.514"></a><span id="l56.514" class="difflineminus">-    sz += 30;</span>
<a href="#l56.515"></a><span id="l56.515" class="difflineplus">+  while (sz &lt; newSize) sz += 30;</span>
<a href="#l56.516"></a><span id="l56.516"> </span>
<a href="#l56.517"></a><span id="l56.517" class="difflineminus">-  int32_t  *pData = new int32_t[ sz];</span>
<a href="#l56.518"></a><span id="l56.518" class="difflineminus">-  if (!pData)</span>
<a href="#l56.519"></a><span id="l56.519" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l56.520"></a><span id="l56.520" class="difflineplus">+  int32_t *pData = new int32_t[sz];</span>
<a href="#l56.521"></a><span id="l56.521" class="difflineplus">+  if (!pData) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l56.522"></a><span id="l56.522">   bool *pActive = new bool[sz];</span>
<a href="#l56.523"></a><span id="l56.523">   if (!pActive) {</span>
<a href="#l56.524"></a><span id="l56.524" class="difflineminus">-    delete [] pData;</span>
<a href="#l56.525"></a><span id="l56.525" class="difflineplus">+    delete[] pData;</span>
<a href="#l56.526"></a><span id="l56.526">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l56.527"></a><span id="l56.527">   }</span>
<a href="#l56.528"></a><span id="l56.528"> </span>
<a href="#l56.529"></a><span id="l56.529" class="difflineminus">-  int32_t  i;</span>
<a href="#l56.530"></a><span id="l56.530" class="difflineplus">+  int32_t i;</span>
<a href="#l56.531"></a><span id="l56.531">   for (i = 0; i &lt; sz; i++) {</span>
<a href="#l56.532"></a><span id="l56.532">     pData[i] = -1;</span>
<a href="#l56.533"></a><span id="l56.533">     pActive[i] = true;</span>
<a href="#l56.534"></a><span id="l56.534">   }</span>
<a href="#l56.535"></a><span id="l56.535">   if (m_numFields) {</span>
<a href="#l56.536"></a><span id="l56.536">     for (i = 0; i &lt; m_numFields; i++) {</span>
<a href="#l56.537"></a><span id="l56.537">       pData[i] = m_pFields[i];</span>
<a href="#l56.538"></a><span id="l56.538">       pActive[i] = m_pActive[i];</span>
<a href="#l56.539"></a><span id="l56.539">     }</span>
<a href="#l56.540"></a><span id="l56.540" class="difflineminus">-    delete [] m_pFields;</span>
<a href="#l56.541"></a><span id="l56.541" class="difflineminus">-    delete [] m_pActive;</span>
<a href="#l56.542"></a><span id="l56.542" class="difflineplus">+    delete[] m_pFields;</span>
<a href="#l56.543"></a><span id="l56.543" class="difflineplus">+    delete[] m_pActive;</span>
<a href="#l56.544"></a><span id="l56.544">   }</span>
<a href="#l56.545"></a><span id="l56.545">   m_allocated = sz;</span>
<a href="#l56.546"></a><span id="l56.546">   m_pFields = pData;</span>
<a href="#l56.547"></a><span id="l56.547">   m_pActive = pActive;</span>
<a href="#l56.548"></a><span id="l56.548">   return NS_OK;</span>
<a href="#l56.549"></a><span id="l56.549"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l57.1"></a><span id="l57.1" class="difflineminus">--- a/mailnews/import/src/nsImportFieldMap.h</span>
<a href="#l57.2"></a><span id="l57.2" class="difflineplus">+++ b/mailnews/import/src/nsImportFieldMap.h</span>
<a href="#l57.3"></a><span id="l57.3" class="difflineat">@@ -3,44 +3,43 @@</span>
<a href="#l57.4"></a><span id="l57.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l57.5"></a><span id="l57.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l57.6"></a><span id="l57.6"> </span>
<a href="#l57.7"></a><span id="l57.7"> #ifndef nsImportFieldMap_h___</span>
<a href="#l57.8"></a><span id="l57.8"> #define nsImportFieldMap_h___</span>
<a href="#l57.9"></a><span id="l57.9"> </span>
<a href="#l57.10"></a><span id="l57.10"> #include &quot;nscore.h&quot;</span>
<a href="#l57.11"></a><span id="l57.11"> #include &quot;nsIImportFieldMap.h&quot;</span>
<a href="#l57.12"></a><span id="l57.12" class="difflineminus">-#include &quot;nsIAddrDatabase.h&quot; // For SetFieldValue() arguments</span>
<a href="#l57.13"></a><span id="l57.13" class="difflineplus">+#include &quot;nsIAddrDatabase.h&quot;  // For SetFieldValue() arguments</span>
<a href="#l57.14"></a><span id="l57.14"> #include &quot;nsTArray.h&quot;</span>
<a href="#l57.15"></a><span id="l57.15"> #include &quot;nsString.h&quot;</span>
<a href="#l57.16"></a><span id="l57.16"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l57.17"></a><span id="l57.17"> </span>
<a href="#l57.18"></a><span id="l57.18"> ////////////////////////////////////////////////////////////////////////</span>
<a href="#l57.19"></a><span id="l57.19"> </span>
<a href="#l57.20"></a><span id="l57.20"> class nsIStringBundle;</span>
<a href="#l57.21"></a><span id="l57.21"> </span>
<a href="#l57.22"></a><span id="l57.22" class="difflineminus">-class nsImportFieldMap : public nsIImportFieldMap</span>
<a href="#l57.23"></a><span id="l57.23" class="difflineminus">-{</span>
<a href="#l57.24"></a><span id="l57.24" class="difflineminus">-public:</span>
<a href="#l57.25"></a><span id="l57.25" class="difflineplus">+class nsImportFieldMap : public nsIImportFieldMap {</span>
<a href="#l57.26"></a><span id="l57.26" class="difflineplus">+ public:</span>
<a href="#l57.27"></a><span id="l57.27">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l57.28"></a><span id="l57.28"> </span>
<a href="#l57.29"></a><span id="l57.29">   NS_DECL_NSIIMPORTFIELDMAP</span>
<a href="#l57.30"></a><span id="l57.30"> </span>
<a href="#l57.31"></a><span id="l57.31">   explicit nsImportFieldMap(nsIStringBundle *aBundle);</span>
<a href="#l57.32"></a><span id="l57.32"> </span>
<a href="#l57.33"></a><span id="l57.33" class="difflineminus">-  static nsresult Create(nsIStringBundle *aBundle, nsISupports *aOuter, REFNSIID aIID, void **aResult);</span>
<a href="#l57.34"></a><span id="l57.34" class="difflineplus">+  static nsresult Create(nsIStringBundle *aBundle, nsISupports *aOuter,</span>
<a href="#l57.35"></a><span id="l57.35" class="difflineplus">+                         REFNSIID aIID, void **aResult);</span>
<a href="#l57.36"></a><span id="l57.36"> </span>
<a href="#l57.37"></a><span id="l57.37" class="difflineminus">-private:</span>
<a href="#l57.38"></a><span id="l57.38" class="difflineplus">+ private:</span>
<a href="#l57.39"></a><span id="l57.39">   virtual ~nsImportFieldMap();</span>
<a href="#l57.40"></a><span id="l57.40" class="difflineminus">-  nsresult  Allocate(int32_t newSize);</span>
<a href="#l57.41"></a><span id="l57.41" class="difflineplus">+  nsresult Allocate(int32_t newSize);</span>
<a href="#l57.42"></a><span id="l57.42"> </span>
<a href="#l57.43"></a><span id="l57.43" class="difflineminus">-private:</span>
<a href="#l57.44"></a><span id="l57.44" class="difflineminus">-  int32_t    m_numFields;</span>
<a href="#l57.45"></a><span id="l57.45" class="difflineminus">-  int32_t  *  m_pFields;</span>
<a href="#l57.46"></a><span id="l57.46" class="difflineminus">-  bool *  m_pActive;</span>
<a href="#l57.47"></a><span id="l57.47" class="difflineminus">-  int32_t    m_allocated;</span>
<a href="#l57.48"></a><span id="l57.48" class="difflineminus">-  nsTArray&lt;nsString*&gt;  m_descriptions;</span>
<a href="#l57.49"></a><span id="l57.49" class="difflineminus">-  int32_t    m_mozFieldCount;</span>
<a href="#l57.50"></a><span id="l57.50" class="difflineminus">-  bool        m_skipFirstRecord;</span>
<a href="#l57.51"></a><span id="l57.51" class="difflineplus">+ private:</span>
<a href="#l57.52"></a><span id="l57.52" class="difflineplus">+  int32_t m_numFields;</span>
<a href="#l57.53"></a><span id="l57.53" class="difflineplus">+  int32_t *m_pFields;</span>
<a href="#l57.54"></a><span id="l57.54" class="difflineplus">+  bool *m_pActive;</span>
<a href="#l57.55"></a><span id="l57.55" class="difflineplus">+  int32_t m_allocated;</span>
<a href="#l57.56"></a><span id="l57.56" class="difflineplus">+  nsTArray&lt;nsString *&gt; m_descriptions;</span>
<a href="#l57.57"></a><span id="l57.57" class="difflineplus">+  int32_t m_mozFieldCount;</span>
<a href="#l57.58"></a><span id="l57.58" class="difflineplus">+  bool m_skipFirstRecord;</span>
<a href="#l57.59"></a><span id="l57.59"> };</span>
<a href="#l57.60"></a><span id="l57.60"> </span>
<a href="#l57.61"></a><span id="l57.61" class="difflineminus">-</span>
<a href="#l57.62"></a><span id="l57.62"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l58.1"></a><span id="l58.1" class="difflineminus">--- a/mailnews/import/src/nsImportMail.cpp</span>
<a href="#l58.2"></a><span id="l58.2" class="difflineplus">+++ b/mailnews/import/src/nsImportMail.cpp</span>
<a href="#l58.3"></a><span id="l58.3" class="difflineat">@@ -1,15 +1,15 @@</span>
<a href="#l58.4"></a><span id="l58.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l58.5"></a><span id="l58.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l58.6"></a><span id="l58.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l58.7"></a><span id="l58.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l58.8"></a><span id="l58.8"> </span>
<a href="#l58.9"></a><span id="l58.9"> /*</span>
<a href="#l58.10"></a><span id="l58.10" class="difflineminus">-*/</span>
<a href="#l58.11"></a><span id="l58.11" class="difflineplus">+ */</span>
<a href="#l58.12"></a><span id="l58.12"> </span>
<a href="#l58.13"></a><span id="l58.13"> #include &quot;prthread.h&quot;</span>
<a href="#l58.14"></a><span id="l58.14"> #include &quot;prprf.h&quot;</span>
<a href="#l58.15"></a><span id="l58.15"> #include &quot;nscore.h&quot;</span>
<a href="#l58.16"></a><span id="l58.16"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l58.17"></a><span id="l58.17"> #include &quot;nsIArray.h&quot;</span>
<a href="#l58.18"></a><span id="l58.18"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l58.19"></a><span id="l58.19"> </span>
<a href="#l58.20"></a><span id="l58.20" class="difflineat">@@ -32,334 +32,316 @@</span>
<a href="#l58.21"></a><span id="l58.21"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l58.22"></a><span id="l58.22"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l58.23"></a><span id="l58.23"> #include &quot;ImportDebug.h&quot;</span>
<a href="#l58.24"></a><span id="l58.24"> #include &quot;plstr.h&quot;</span>
<a href="#l58.25"></a><span id="l58.25"> #include &quot;MailNewsTypes.h&quot;</span>
<a href="#l58.26"></a><span id="l58.26"> #include &quot;nsThreadUtils.h&quot;</span>
<a href="#l58.27"></a><span id="l58.27"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l58.28"></a><span id="l58.28"> </span>
<a href="#l58.29"></a><span id="l58.29" class="difflineminus">-#define IMPORT_MSGS_URL       &quot;chrome://messenger/locale/importMsgs.properties&quot;</span>
<a href="#l58.30"></a><span id="l58.30" class="difflineplus">+#define IMPORT_MSGS_URL &quot;chrome://messenger/locale/importMsgs.properties&quot;</span>
<a href="#l58.31"></a><span id="l58.31"> </span>
<a href="#l58.32"></a><span id="l58.32"> ////////////////////////////////////////////////////////////////////////</span>
<a href="#l58.33"></a><span id="l58.33"> </span>
<a href="#l58.34"></a><span id="l58.34"> static void ImportMailThread(void *stuff);</span>
<a href="#l58.35"></a><span id="l58.35"> </span>
<a href="#l58.36"></a><span id="l58.36"> class ImportThreadData;</span>
<a href="#l58.37"></a><span id="l58.37"> </span>
<a href="#l58.38"></a><span id="l58.38" class="difflineminus">-class nsImportGenericMail : public nsIImportGeneric</span>
<a href="#l58.39"></a><span id="l58.39" class="difflineminus">-{</span>
<a href="#l58.40"></a><span id="l58.40" class="difflineminus">-public:</span>
<a href="#l58.41"></a><span id="l58.41" class="difflineminus">-</span>
<a href="#l58.42"></a><span id="l58.42" class="difflineplus">+class nsImportGenericMail : public nsIImportGeneric {</span>
<a href="#l58.43"></a><span id="l58.43" class="difflineplus">+ public:</span>
<a href="#l58.44"></a><span id="l58.44">   nsImportGenericMail();</span>
<a href="#l58.45"></a><span id="l58.45"> </span>
<a href="#l58.46"></a><span id="l58.46">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l58.47"></a><span id="l58.47"> </span>
<a href="#l58.48"></a><span id="l58.48">   /* nsISupports GetData (in string dataId); */</span>
<a href="#l58.49"></a><span id="l58.49">   NS_IMETHOD GetData(const char *dataId, nsISupports **_retval) override;</span>
<a href="#l58.50"></a><span id="l58.50"> </span>
<a href="#l58.51"></a><span id="l58.51">   NS_IMETHOD SetData(const char *dataId, nsISupports *pData) override;</span>
<a href="#l58.52"></a><span id="l58.52"> </span>
<a href="#l58.53"></a><span id="l58.53">   NS_IMETHOD GetStatus(const char *statusKind, int32_t *_retval) override;</span>
<a href="#l58.54"></a><span id="l58.54"> </span>
<a href="#l58.55"></a><span id="l58.55">   NS_IMETHOD WantsProgress(bool *_retval) override;</span>
<a href="#l58.56"></a><span id="l58.56"> </span>
<a href="#l58.57"></a><span id="l58.57" class="difflineminus">-  NS_IMETHODIMP BeginImport(nsISupportsString *successLog, nsISupportsString *errorLog, bool *_retval) override;</span>
<a href="#l58.58"></a><span id="l58.58" class="difflineplus">+  NS_IMETHODIMP BeginImport(nsISupportsString *successLog,</span>
<a href="#l58.59"></a><span id="l58.59" class="difflineplus">+                            nsISupportsString *errorLog,</span>
<a href="#l58.60"></a><span id="l58.60" class="difflineplus">+                            bool *_retval) override;</span>
<a href="#l58.61"></a><span id="l58.61"> </span>
<a href="#l58.62"></a><span id="l58.62">   NS_IMETHOD ContinueImport(bool *_retval) override;</span>
<a href="#l58.63"></a><span id="l58.63"> </span>
<a href="#l58.64"></a><span id="l58.64">   NS_IMETHOD GetProgress(int32_t *_retval) override;</span>
<a href="#l58.65"></a><span id="l58.65"> </span>
<a href="#l58.66"></a><span id="l58.66">   NS_IMETHOD CancelImport(void) override;</span>
<a href="#l58.67"></a><span id="l58.67"> </span>
<a href="#l58.68"></a><span id="l58.68" class="difflineminus">-private:</span>
<a href="#l58.69"></a><span id="l58.69" class="difflineplus">+ private:</span>
<a href="#l58.70"></a><span id="l58.70">   virtual ~nsImportGenericMail();</span>
<a href="#l58.71"></a><span id="l58.71" class="difflineminus">-  bool    CreateFolder(nsIMsgFolder **ppFolder);</span>
<a href="#l58.72"></a><span id="l58.72" class="difflineminus">-  void  GetDefaultMailboxes(void);</span>
<a href="#l58.73"></a><span id="l58.73" class="difflineminus">-  void  GetDefaultLocation(void);</span>
<a href="#l58.74"></a><span id="l58.74" class="difflineminus">-  void  GetDefaultDestination(void);</span>
<a href="#l58.75"></a><span id="l58.75" class="difflineminus">-  void  GetMailboxName(uint32_t index, nsISupportsString *pStr);</span>
<a href="#l58.76"></a><span id="l58.76" class="difflineminus">-</span>
<a href="#l58.77"></a><span id="l58.77" class="difflineminus">-public:</span>
<a href="#l58.78"></a><span id="l58.78" class="difflineminus">-  static void  SetLogs(nsString&amp; success, nsString&amp; error, nsISupportsString *pSuccess, nsISupportsString *pError);</span>
<a href="#l58.79"></a><span id="l58.79" class="difflineminus">-  static void ReportError(int32_t id, const char16_t *pName, nsString *pStream, nsIStringBundle* aBundle);</span>
<a href="#l58.80"></a><span id="l58.80" class="difflineplus">+  bool CreateFolder(nsIMsgFolder **ppFolder);</span>
<a href="#l58.81"></a><span id="l58.81" class="difflineplus">+  void GetDefaultMailboxes(void);</span>
<a href="#l58.82"></a><span id="l58.82" class="difflineplus">+  void GetDefaultLocation(void);</span>
<a href="#l58.83"></a><span id="l58.83" class="difflineplus">+  void GetDefaultDestination(void);</span>
<a href="#l58.84"></a><span id="l58.84" class="difflineplus">+  void GetMailboxName(uint32_t index, nsISupportsString *pStr);</span>
<a href="#l58.85"></a><span id="l58.85"> </span>
<a href="#l58.86"></a><span id="l58.86" class="difflineminus">-private:</span>
<a href="#l58.87"></a><span id="l58.87" class="difflineminus">-  nsString                    m_pName;  // module name that created this interface</span>
<a href="#l58.88"></a><span id="l58.88" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolder&gt;      m_pDestFolder;</span>
<a href="#l58.89"></a><span id="l58.89" class="difflineminus">-  bool                        m_deleteDestFolder;</span>
<a href="#l58.90"></a><span id="l58.90" class="difflineminus">-  bool                        m_createdFolder;</span>
<a href="#l58.91"></a><span id="l58.91" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt;           m_pSrcLocation;</span>
<a href="#l58.92"></a><span id="l58.92" class="difflineminus">-  bool                        m_gotLocation;</span>
<a href="#l58.93"></a><span id="l58.93" class="difflineminus">-  bool                        m_found;</span>
<a href="#l58.94"></a><span id="l58.94" class="difflineminus">-  bool                        m_userVerify;</span>
<a href="#l58.95"></a><span id="l58.95" class="difflineminus">-  nsCOMPtr&lt;nsIImportMail&gt;     m_pInterface;</span>
<a href="#l58.96"></a><span id="l58.96" class="difflineminus">-  nsCOMPtr&lt;nsIArray&gt;          m_pMailboxes;</span>
<a href="#l58.97"></a><span id="l58.97" class="difflineplus">+ public:</span>
<a href="#l58.98"></a><span id="l58.98" class="difflineplus">+  static void SetLogs(nsString &amp;success, nsString &amp;error,</span>
<a href="#l58.99"></a><span id="l58.99" class="difflineplus">+                      nsISupportsString *pSuccess, nsISupportsString *pError);</span>
<a href="#l58.100"></a><span id="l58.100" class="difflineplus">+  static void ReportError(int32_t id, const char16_t *pName, nsString *pStream,</span>
<a href="#l58.101"></a><span id="l58.101" class="difflineplus">+                          nsIStringBundle *aBundle);</span>
<a href="#l58.102"></a><span id="l58.102" class="difflineplus">+</span>
<a href="#l58.103"></a><span id="l58.103" class="difflineplus">+ private:</span>
<a href="#l58.104"></a><span id="l58.104" class="difflineplus">+  nsString m_pName;  // module name that created this interface</span>
<a href="#l58.105"></a><span id="l58.105" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; m_pDestFolder;</span>
<a href="#l58.106"></a><span id="l58.106" class="difflineplus">+  bool m_deleteDestFolder;</span>
<a href="#l58.107"></a><span id="l58.107" class="difflineplus">+  bool m_createdFolder;</span>
<a href="#l58.108"></a><span id="l58.108" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; m_pSrcLocation;</span>
<a href="#l58.109"></a><span id="l58.109" class="difflineplus">+  bool m_gotLocation;</span>
<a href="#l58.110"></a><span id="l58.110" class="difflineplus">+  bool m_found;</span>
<a href="#l58.111"></a><span id="l58.111" class="difflineplus">+  bool m_userVerify;</span>
<a href="#l58.112"></a><span id="l58.112" class="difflineplus">+  nsCOMPtr&lt;nsIImportMail&gt; m_pInterface;</span>
<a href="#l58.113"></a><span id="l58.113" class="difflineplus">+  nsCOMPtr&lt;nsIArray&gt; m_pMailboxes;</span>
<a href="#l58.114"></a><span id="l58.114">   nsCOMPtr&lt;nsISupportsString&gt; m_pSuccessLog;</span>
<a href="#l58.115"></a><span id="l58.115">   nsCOMPtr&lt;nsISupportsString&gt; m_pErrorLog;</span>
<a href="#l58.116"></a><span id="l58.116" class="difflineminus">-  uint32_t                    m_totalSize;</span>
<a href="#l58.117"></a><span id="l58.117" class="difflineminus">-  bool                        m_doImport;</span>
<a href="#l58.118"></a><span id="l58.118" class="difflineminus">-  ImportThreadData *          m_pThreadData;</span>
<a href="#l58.119"></a><span id="l58.119" class="difflineminus">-  bool                        m_performingMigration;</span>
<a href="#l58.120"></a><span id="l58.120" class="difflineminus">-  nsCOMPtr&lt;nsIStringBundle&gt;   m_stringBundle;</span>
<a href="#l58.121"></a><span id="l58.121" class="difflineplus">+  uint32_t m_totalSize;</span>
<a href="#l58.122"></a><span id="l58.122" class="difflineplus">+  bool m_doImport;</span>
<a href="#l58.123"></a><span id="l58.123" class="difflineplus">+  ImportThreadData *m_pThreadData;</span>
<a href="#l58.124"></a><span id="l58.124" class="difflineplus">+  bool m_performingMigration;</span>
<a href="#l58.125"></a><span id="l58.125" class="difflineplus">+  nsCOMPtr&lt;nsIStringBundle&gt; m_stringBundle;</span>
<a href="#l58.126"></a><span id="l58.126"> };</span>
<a href="#l58.127"></a><span id="l58.127"> </span>
<a href="#l58.128"></a><span id="l58.128"> class ImportThreadData {</span>
<a href="#l58.129"></a><span id="l58.129" class="difflineminus">-public:</span>
<a href="#l58.130"></a><span id="l58.130" class="difflineminus">-  bool            driverAlive;</span>
<a href="#l58.131"></a><span id="l58.131" class="difflineminus">-  bool            threadAlive;</span>
<a href="#l58.132"></a><span id="l58.132" class="difflineminus">-  bool            abort;</span>
<a href="#l58.133"></a><span id="l58.133" class="difflineminus">-  bool            fatalError;</span>
<a href="#l58.134"></a><span id="l58.134" class="difflineminus">-  uint32_t        currentTotal;</span>
<a href="#l58.135"></a><span id="l58.135" class="difflineminus">-  uint32_t        currentSize;</span>
<a href="#l58.136"></a><span id="l58.136" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolder&gt;      destRoot;</span>
<a href="#l58.137"></a><span id="l58.137" class="difflineminus">-  bool                        ownsDestRoot;</span>
<a href="#l58.138"></a><span id="l58.138" class="difflineminus">-  nsCOMPtr&lt;nsIArray&gt;          boxes;</span>
<a href="#l58.139"></a><span id="l58.139" class="difflineminus">-  nsCOMPtr&lt;nsIImportMail&gt;     mailImport;</span>
<a href="#l58.140"></a><span id="l58.140" class="difflineplus">+ public:</span>
<a href="#l58.141"></a><span id="l58.141" class="difflineplus">+  bool driverAlive;</span>
<a href="#l58.142"></a><span id="l58.142" class="difflineplus">+  bool threadAlive;</span>
<a href="#l58.143"></a><span id="l58.143" class="difflineplus">+  bool abort;</span>
<a href="#l58.144"></a><span id="l58.144" class="difflineplus">+  bool fatalError;</span>
<a href="#l58.145"></a><span id="l58.145" class="difflineplus">+  uint32_t currentTotal;</span>
<a href="#l58.146"></a><span id="l58.146" class="difflineplus">+  uint32_t currentSize;</span>
<a href="#l58.147"></a><span id="l58.147" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; destRoot;</span>
<a href="#l58.148"></a><span id="l58.148" class="difflineplus">+  bool ownsDestRoot;</span>
<a href="#l58.149"></a><span id="l58.149" class="difflineplus">+  nsCOMPtr&lt;nsIArray&gt; boxes;</span>
<a href="#l58.150"></a><span id="l58.150" class="difflineplus">+  nsCOMPtr&lt;nsIImportMail&gt; mailImport;</span>
<a href="#l58.151"></a><span id="l58.151">   nsCOMPtr&lt;nsISupportsString&gt; successLog;</span>
<a href="#l58.152"></a><span id="l58.152">   nsCOMPtr&lt;nsISupportsString&gt; errorLog;</span>
<a href="#l58.153"></a><span id="l58.153" class="difflineminus">-  uint32_t                    currentMailbox;</span>
<a href="#l58.154"></a><span id="l58.154" class="difflineminus">-  bool                        performingMigration;</span>
<a href="#l58.155"></a><span id="l58.155" class="difflineminus">-  nsCOMPtr&lt;nsIStringBundle&gt;   stringBundle;</span>
<a href="#l58.156"></a><span id="l58.156" class="difflineplus">+  uint32_t currentMailbox;</span>
<a href="#l58.157"></a><span id="l58.157" class="difflineplus">+  bool performingMigration;</span>
<a href="#l58.158"></a><span id="l58.158" class="difflineplus">+  nsCOMPtr&lt;nsIStringBundle&gt; stringBundle;</span>
<a href="#l58.159"></a><span id="l58.159"> </span>
<a href="#l58.160"></a><span id="l58.160">   ImportThreadData();</span>
<a href="#l58.161"></a><span id="l58.161">   ~ImportThreadData();</span>
<a href="#l58.162"></a><span id="l58.162">   void DriverDelete();</span>
<a href="#l58.163"></a><span id="l58.163">   void ThreadDelete();</span>
<a href="#l58.164"></a><span id="l58.164">   void DriverAbort();</span>
<a href="#l58.165"></a><span id="l58.165"> };</span>
<a href="#l58.166"></a><span id="l58.166"> </span>
<a href="#l58.167"></a><span id="l58.167"> // forward decl for proxy methods</span>
<a href="#l58.168"></a><span id="l58.168"> nsresult ProxyGetSubFolders(nsIMsgFolder *aFolder);</span>
<a href="#l58.169"></a><span id="l58.169" class="difflineminus">-nsresult ProxyGetChildNamed(nsIMsgFolder *aFolder,const nsAString &amp; aName,</span>
<a href="#l58.170"></a><span id="l58.170" class="difflineplus">+nsresult ProxyGetChildNamed(nsIMsgFolder *aFolder, const nsAString &amp;aName,</span>
<a href="#l58.171"></a><span id="l58.171">                             nsIMsgFolder **aChild);</span>
<a href="#l58.172"></a><span id="l58.172"> nsresult ProxyGetParent(nsIMsgFolder *aFolder, nsIMsgFolder **aParent);</span>
<a href="#l58.173"></a><span id="l58.173"> nsresult ProxyContainsChildNamed(nsIMsgFolder *aFolder, const nsAString &amp;aName,</span>
<a href="#l58.174"></a><span id="l58.174">                                  bool *aResult);</span>
<a href="#l58.175"></a><span id="l58.175"> nsresult ProxyGenerateUniqueSubfolderName(nsIMsgFolder *aFolder,</span>
<a href="#l58.176"></a><span id="l58.176" class="difflineminus">-                                          const nsAString&amp; aPrefix,</span>
<a href="#l58.177"></a><span id="l58.177" class="difflineplus">+                                          const nsAString &amp;aPrefix,</span>
<a href="#l58.178"></a><span id="l58.178">                                           nsIMsgFolder *aOtherFolder,</span>
<a href="#l58.179"></a><span id="l58.179" class="difflineminus">-                                          nsAString&amp; aName);</span>
<a href="#l58.180"></a><span id="l58.180" class="difflineplus">+                                          nsAString &amp;aName);</span>
<a href="#l58.181"></a><span id="l58.181"> nsresult ProxyCreateSubfolder(nsIMsgFolder *aFolder, const nsAString &amp;aName);</span>
<a href="#l58.182"></a><span id="l58.182"> nsresult ProxyForceDBClosed(nsIMsgFolder *aFolder);</span>
<a href="#l58.183"></a><span id="l58.183"> </span>
<a href="#l58.184"></a><span id="l58.184" class="difflineminus">-nsresult NS_NewGenericMail(nsIImportGeneric** aImportGeneric)</span>
<a href="#l58.185"></a><span id="l58.185" class="difflineminus">-{</span>
<a href="#l58.186"></a><span id="l58.186" class="difflineplus">+nsresult NS_NewGenericMail(nsIImportGeneric **aImportGeneric) {</span>
<a href="#l58.187"></a><span id="l58.187">   NS_ASSERTION(aImportGeneric != nullptr, &quot;null ptr&quot;);</span>
<a href="#l58.188"></a><span id="l58.188" class="difflineminus">-  if (!aImportGeneric)</span>
<a href="#l58.189"></a><span id="l58.189" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l58.190"></a><span id="l58.190" class="difflineplus">+  if (!aImportGeneric) return NS_ERROR_NULL_POINTER;</span>
<a href="#l58.191"></a><span id="l58.191"> </span>
<a href="#l58.192"></a><span id="l58.192">   RefPtr&lt;nsImportGenericMail&gt; pGen = new nsImportGenericMail();</span>
<a href="#l58.193"></a><span id="l58.193" class="difflineminus">-  return pGen-&gt;QueryInterface(NS_GET_IID(nsIImportGeneric), (void **)aImportGeneric);</span>
<a href="#l58.194"></a><span id="l58.194" class="difflineplus">+  return pGen-&gt;QueryInterface(NS_GET_IID(nsIImportGeneric),</span>
<a href="#l58.195"></a><span id="l58.195" class="difflineplus">+                              (void **)aImportGeneric);</span>
<a href="#l58.196"></a><span id="l58.196"> }</span>
<a href="#l58.197"></a><span id="l58.197"> </span>
<a href="#l58.198"></a><span id="l58.198" class="difflineminus">-nsImportGenericMail::nsImportGenericMail()</span>
<a href="#l58.199"></a><span id="l58.199" class="difflineminus">-{</span>
<a href="#l58.200"></a><span id="l58.200" class="difflineplus">+nsImportGenericMail::nsImportGenericMail() {</span>
<a href="#l58.201"></a><span id="l58.201">   m_found = false;</span>
<a href="#l58.202"></a><span id="l58.202">   m_userVerify = false;</span>
<a href="#l58.203"></a><span id="l58.203">   m_gotLocation = false;</span>
<a href="#l58.204"></a><span id="l58.204">   m_totalSize = 0;</span>
<a href="#l58.205"></a><span id="l58.205">   m_doImport = false;</span>
<a href="#l58.206"></a><span id="l58.206">   m_pThreadData = nullptr;</span>
<a href="#l58.207"></a><span id="l58.207"> </span>
<a href="#l58.208"></a><span id="l58.208">   m_pDestFolder = nullptr;</span>
<a href="#l58.209"></a><span id="l58.209">   m_deleteDestFolder = false;</span>
<a href="#l58.210"></a><span id="l58.210">   m_createdFolder = false;</span>
<a href="#l58.211"></a><span id="l58.211">   m_performingMigration = false;</span>
<a href="#l58.212"></a><span id="l58.212"> </span>
<a href="#l58.213"></a><span id="l58.213" class="difflineminus">-  nsresult rv = nsImportStringBundle::GetStringBundle(IMPORT_MSGS_URL, getter_AddRefs(m_stringBundle));</span>
<a href="#l58.214"></a><span id="l58.214" class="difflineplus">+  nsresult rv = nsImportStringBundle::GetStringBundle(</span>
<a href="#l58.215"></a><span id="l58.215" class="difflineplus">+      IMPORT_MSGS_URL, getter_AddRefs(m_stringBundle));</span>
<a href="#l58.216"></a><span id="l58.216">   if (NS_FAILED(rv))</span>
<a href="#l58.217"></a><span id="l58.217">     IMPORT_LOG0(&quot;Failed to get string bundle for Importing Mail&quot;);</span>
<a href="#l58.218"></a><span id="l58.218"> }</span>
<a href="#l58.219"></a><span id="l58.219"> </span>
<a href="#l58.220"></a><span id="l58.220" class="difflineminus">-</span>
<a href="#l58.221"></a><span id="l58.221" class="difflineminus">-nsImportGenericMail::~nsImportGenericMail()</span>
<a href="#l58.222"></a><span id="l58.222" class="difflineminus">-{</span>
<a href="#l58.223"></a><span id="l58.223" class="difflineplus">+nsImportGenericMail::~nsImportGenericMail() {</span>
<a href="#l58.224"></a><span id="l58.224">   if (m_pThreadData) {</span>
<a href="#l58.225"></a><span id="l58.225">     m_pThreadData-&gt;DriverAbort();</span>
<a href="#l58.226"></a><span id="l58.226">     m_pThreadData = nullptr;</span>
<a href="#l58.227"></a><span id="l58.227">   }</span>
<a href="#l58.228"></a><span id="l58.228"> }</span>
<a href="#l58.229"></a><span id="l58.229"> </span>
<a href="#l58.230"></a><span id="l58.230" class="difflineminus">-</span>
<a href="#l58.231"></a><span id="l58.231"> NS_IMPL_ISUPPORTS(nsImportGenericMail, nsIImportGeneric)</span>
<a href="#l58.232"></a><span id="l58.232"> </span>
<a href="#l58.233"></a><span id="l58.233" class="difflineminus">-</span>
<a href="#l58.234"></a><span id="l58.234" class="difflineminus">-NS_IMETHODIMP nsImportGenericMail::GetData(const char *dataId, nsISupports **_retval)</span>
<a href="#l58.235"></a><span id="l58.235" class="difflineminus">-{</span>
<a href="#l58.236"></a><span id="l58.236" class="difflineplus">+NS_IMETHODIMP nsImportGenericMail::GetData(const char *dataId,</span>
<a href="#l58.237"></a><span id="l58.237" class="difflineplus">+                                           nsISupports **_retval) {</span>
<a href="#l58.238"></a><span id="l58.238">   nsresult rv = NS_OK;</span>
<a href="#l58.239"></a><span id="l58.239">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l58.240"></a><span id="l58.240"> </span>
<a href="#l58.241"></a><span id="l58.241">   *_retval = nullptr;</span>
<a href="#l58.242"></a><span id="l58.242">   if (!PL_strcasecmp(dataId, &quot;mailInterface&quot;)) {</span>
<a href="#l58.243"></a><span id="l58.243">     NS_IF_ADDREF(*_retval = m_pInterface);</span>
<a href="#l58.244"></a><span id="l58.244">   }</span>
<a href="#l58.245"></a><span id="l58.245"> </span>
<a href="#l58.246"></a><span id="l58.246">   if (!PL_strcasecmp(dataId, &quot;mailBoxes&quot;)) {</span>
<a href="#l58.247"></a><span id="l58.247" class="difflineminus">-    if (!m_pMailboxes)</span>
<a href="#l58.248"></a><span id="l58.248" class="difflineminus">-      GetDefaultMailboxes();</span>
<a href="#l58.249"></a><span id="l58.249" class="difflineplus">+    if (!m_pMailboxes) GetDefaultMailboxes();</span>
<a href="#l58.250"></a><span id="l58.250">     NS_IF_ADDREF(*_retval = m_pMailboxes);</span>
<a href="#l58.251"></a><span id="l58.251">   }</span>
<a href="#l58.252"></a><span id="l58.252"> </span>
<a href="#l58.253"></a><span id="l58.253">   if (!PL_strcasecmp(dataId, &quot;mailLocation&quot;)) {</span>
<a href="#l58.254"></a><span id="l58.254" class="difflineminus">-    if (!m_pSrcLocation)</span>
<a href="#l58.255"></a><span id="l58.255" class="difflineminus">-      GetDefaultLocation();</span>
<a href="#l58.256"></a><span id="l58.256" class="difflineplus">+    if (!m_pSrcLocation) GetDefaultLocation();</span>
<a href="#l58.257"></a><span id="l58.257">     NS_IF_ADDREF(*_retval = m_pSrcLocation);</span>
<a href="#l58.258"></a><span id="l58.258">   }</span>
<a href="#l58.259"></a><span id="l58.259"> </span>
<a href="#l58.260"></a><span id="l58.260">   if (!PL_strcasecmp(dataId, &quot;mailDestination&quot;)) {</span>
<a href="#l58.261"></a><span id="l58.261" class="difflineminus">-    if (!m_pDestFolder)</span>
<a href="#l58.262"></a><span id="l58.262" class="difflineminus">-      GetDefaultDestination();</span>
<a href="#l58.263"></a><span id="l58.263" class="difflineplus">+    if (!m_pDestFolder) GetDefaultDestination();</span>
<a href="#l58.264"></a><span id="l58.264">     NS_IF_ADDREF(*_retval = m_pDestFolder);</span>
<a href="#l58.265"></a><span id="l58.265">   }</span>
<a href="#l58.266"></a><span id="l58.266"> </span>
<a href="#l58.267"></a><span id="l58.267">   if (!PL_strcasecmp(dataId, &quot;migration&quot;)) {</span>
<a href="#l58.268"></a><span id="l58.268" class="difflineminus">-    nsCOMPtr&lt;nsISupportsPRBool&gt; migrationString = do_CreateInstance(NS_SUPPORTS_PRBOOL_CONTRACTID, &amp;rv);</span>
<a href="#l58.269"></a><span id="l58.269" class="difflineplus">+    nsCOMPtr&lt;nsISupportsPRBool&gt; migrationString =</span>
<a href="#l58.270"></a><span id="l58.270" class="difflineplus">+        do_CreateInstance(NS_SUPPORTS_PRBOOL_CONTRACTID, &amp;rv);</span>
<a href="#l58.271"></a><span id="l58.271">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l58.272"></a><span id="l58.272">     migrationString-&gt;SetData(m_performingMigration);</span>
<a href="#l58.273"></a><span id="l58.273">     migrationString.forget(_retval);</span>
<a href="#l58.274"></a><span id="l58.274">   }</span>
<a href="#l58.275"></a><span id="l58.275"> </span>
<a href="#l58.276"></a><span id="l58.276">   if (!PL_strcasecmp(dataId, &quot;currentMailbox&quot;)) {</span>
<a href="#l58.277"></a><span id="l58.277">     // create an nsISupportsString, get the current mailbox</span>
<a href="#l58.278"></a><span id="l58.278">     // name being imported and put it in the string</span>
<a href="#l58.279"></a><span id="l58.279" class="difflineminus">-    nsCOMPtr&lt;nsISupportsString&gt;  data = do_CreateInstance(NS_SUPPORTS_STRING_CONTRACTID, &amp;rv);</span>
<a href="#l58.280"></a><span id="l58.280" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l58.281"></a><span id="l58.281" class="difflineminus">-      return rv;</span>
<a href="#l58.282"></a><span id="l58.282" class="difflineplus">+    nsCOMPtr&lt;nsISupportsString&gt; data =</span>
<a href="#l58.283"></a><span id="l58.283" class="difflineplus">+        do_CreateInstance(NS_SUPPORTS_STRING_CONTRACTID, &amp;rv);</span>
<a href="#l58.284"></a><span id="l58.284" class="difflineplus">+    if (NS_FAILED(rv)) return rv;</span>
<a href="#l58.285"></a><span id="l58.285">     if (m_pThreadData) {</span>
<a href="#l58.286"></a><span id="l58.286">       GetMailboxName(m_pThreadData-&gt;currentMailbox, data);</span>
<a href="#l58.287"></a><span id="l58.287">     }</span>
<a href="#l58.288"></a><span id="l58.288">     data.forget(_retval);</span>
<a href="#l58.289"></a><span id="l58.289">   }</span>
<a href="#l58.290"></a><span id="l58.290"> </span>
<a href="#l58.291"></a><span id="l58.291">   return rv;</span>
<a href="#l58.292"></a><span id="l58.292"> }</span>
<a href="#l58.293"></a><span id="l58.293"> </span>
<a href="#l58.294"></a><span id="l58.294" class="difflineminus">-NS_IMETHODIMP nsImportGenericMail::SetData(const char *dataId, nsISupports *item)</span>
<a href="#l58.295"></a><span id="l58.295" class="difflineminus">-{</span>
<a href="#l58.296"></a><span id="l58.296" class="difflineplus">+NS_IMETHODIMP nsImportGenericMail::SetData(const char *dataId,</span>
<a href="#l58.297"></a><span id="l58.297" class="difflineplus">+                                           nsISupports *item) {</span>
<a href="#l58.298"></a><span id="l58.298">   nsresult rv = NS_OK;</span>
<a href="#l58.299"></a><span id="l58.299">   NS_ASSERTION(dataId != nullptr, &quot;null ptr&quot;);</span>
<a href="#l58.300"></a><span id="l58.300" class="difflineminus">-  if (!dataId)</span>
<a href="#l58.301"></a><span id="l58.301" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l58.302"></a><span id="l58.302" class="difflineplus">+  if (!dataId) return NS_ERROR_NULL_POINTER;</span>
<a href="#l58.303"></a><span id="l58.303"> </span>
<a href="#l58.304"></a><span id="l58.304">   if (!PL_strcasecmp(dataId, &quot;mailInterface&quot;)) {</span>
<a href="#l58.305"></a><span id="l58.305">     m_pInterface = nullptr;</span>
<a href="#l58.306"></a><span id="l58.306" class="difflineminus">-    if (item)</span>
<a href="#l58.307"></a><span id="l58.307" class="difflineminus">-      m_pInterface = do_QueryInterface(item);</span>
<a href="#l58.308"></a><span id="l58.308" class="difflineplus">+    if (item) m_pInterface = do_QueryInterface(item);</span>
<a href="#l58.309"></a><span id="l58.309">   }</span>
<a href="#l58.310"></a><span id="l58.310">   if (!PL_strcasecmp(dataId, &quot;mailBoxes&quot;)) {</span>
<a href="#l58.311"></a><span id="l58.311">     m_pMailboxes = nullptr;</span>
<a href="#l58.312"></a><span id="l58.312" class="difflineminus">-    if (item)</span>
<a href="#l58.313"></a><span id="l58.313" class="difflineminus">-      m_pMailboxes = do_QueryInterface(item);</span>
<a href="#l58.314"></a><span id="l58.314" class="difflineplus">+    if (item) m_pMailboxes = do_QueryInterface(item);</span>
<a href="#l58.315"></a><span id="l58.315">   }</span>
<a href="#l58.316"></a><span id="l58.316"> </span>
<a href="#l58.317"></a><span id="l58.317">   if (!PL_strcasecmp(dataId, &quot;mailLocation&quot;)) {</span>
<a href="#l58.318"></a><span id="l58.318">     m_pMailboxes = nullptr;</span>
<a href="#l58.319"></a><span id="l58.319">     m_pSrcLocation = nullptr;</span>
<a href="#l58.320"></a><span id="l58.320">     if (item) {</span>
<a href="#l58.321"></a><span id="l58.321">       nsresult rv;</span>
<a href="#l58.322"></a><span id="l58.322">       nsCOMPtr&lt;nsIFile&gt; location = do_QueryInterface(item, &amp;rv);</span>
<a href="#l58.323"></a><span id="l58.323" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l58.324"></a><span id="l58.324" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l58.325"></a><span id="l58.325">       m_pSrcLocation = location;</span>
<a href="#l58.326"></a><span id="l58.326">     }</span>
<a href="#l58.327"></a><span id="l58.327">   }</span>
<a href="#l58.328"></a><span id="l58.328"> </span>
<a href="#l58.329"></a><span id="l58.329">   if (!PL_strcasecmp(dataId, &quot;mailDestination&quot;)) {</span>
<a href="#l58.330"></a><span id="l58.330">     m_pDestFolder = nullptr;</span>
<a href="#l58.331"></a><span id="l58.331" class="difflineminus">-    if (item)</span>
<a href="#l58.332"></a><span id="l58.332" class="difflineminus">-      m_pDestFolder = do_QueryInterface(item);</span>
<a href="#l58.333"></a><span id="l58.333" class="difflineplus">+    if (item) m_pDestFolder = do_QueryInterface(item);</span>
<a href="#l58.334"></a><span id="l58.334">     m_deleteDestFolder = false;</span>
<a href="#l58.335"></a><span id="l58.335">   }</span>
<a href="#l58.336"></a><span id="l58.336"> </span>
<a href="#l58.337"></a><span id="l58.337">   if (!PL_strcasecmp(dataId, &quot;name&quot;)) {</span>
<a href="#l58.338"></a><span id="l58.338">     if (item) {</span>
<a href="#l58.339"></a><span id="l58.339">       nsCOMPtr&lt;nsISupportsString&gt; nameString = do_QueryInterface(item, &amp;rv);</span>
<a href="#l58.340"></a><span id="l58.340" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l58.341"></a><span id="l58.341" class="difflineminus">-        rv = nameString-&gt;GetData(m_pName);</span>
<a href="#l58.342"></a><span id="l58.342" class="difflineplus">+      if (NS_SUCCEEDED(rv)) rv = nameString-&gt;GetData(m_pName);</span>
<a href="#l58.343"></a><span id="l58.343">     }</span>
<a href="#l58.344"></a><span id="l58.344">   }</span>
<a href="#l58.345"></a><span id="l58.345"> </span>
<a href="#l58.346"></a><span id="l58.346">   if (!PL_strcasecmp(dataId, &quot;migration&quot;)) {</span>
<a href="#l58.347"></a><span id="l58.347">     if (item) {</span>
<a href="#l58.348"></a><span id="l58.348" class="difflineminus">-      nsCOMPtr&lt;nsISupportsPRBool&gt; migrationString = do_QueryInterface(item, &amp;rv);</span>
<a href="#l58.349"></a><span id="l58.349" class="difflineplus">+      nsCOMPtr&lt;nsISupportsPRBool&gt; migrationString =</span>
<a href="#l58.350"></a><span id="l58.350" class="difflineplus">+          do_QueryInterface(item, &amp;rv);</span>
<a href="#l58.351"></a><span id="l58.351">       if (NS_SUCCEEDED(rv))</span>
<a href="#l58.352"></a><span id="l58.352">         rv = migrationString-&gt;GetData(&amp;m_performingMigration);</span>
<a href="#l58.353"></a><span id="l58.353">     }</span>
<a href="#l58.354"></a><span id="l58.354">   }</span>
<a href="#l58.355"></a><span id="l58.355">   return rv;</span>
<a href="#l58.356"></a><span id="l58.356"> }</span>
<a href="#l58.357"></a><span id="l58.357"> </span>
<a href="#l58.358"></a><span id="l58.358" class="difflineminus">-NS_IMETHODIMP nsImportGenericMail::GetStatus(const char *statusKind, int32_t *_retval)</span>
<a href="#l58.359"></a><span id="l58.359" class="difflineminus">-{</span>
<a href="#l58.360"></a><span id="l58.360" class="difflineplus">+NS_IMETHODIMP nsImportGenericMail::GetStatus(const char *statusKind,</span>
<a href="#l58.361"></a><span id="l58.361" class="difflineplus">+                                             int32_t *_retval) {</span>
<a href="#l58.362"></a><span id="l58.362">   NS_ASSERTION(statusKind != nullptr, &quot;null ptr&quot;);</span>
<a href="#l58.363"></a><span id="l58.363">   NS_ASSERTION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l58.364"></a><span id="l58.364" class="difflineminus">-  if (!statusKind || !_retval)</span>
<a href="#l58.365"></a><span id="l58.365" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l58.366"></a><span id="l58.366" class="difflineplus">+  if (!statusKind || !_retval) return NS_ERROR_NULL_POINTER;</span>
<a href="#l58.367"></a><span id="l58.367"> </span>
<a href="#l58.368"></a><span id="l58.368">   *_retval = 0;</span>
<a href="#l58.369"></a><span id="l58.369"> </span>
<a href="#l58.370"></a><span id="l58.370">   if (!PL_strcasecmp(statusKind, &quot;isInstalled&quot;)) {</span>
<a href="#l58.371"></a><span id="l58.371">     GetDefaultLocation();</span>
<a href="#l58.372"></a><span id="l58.372" class="difflineminus">-    *_retval = (int32_t) m_found;</span>
<a href="#l58.373"></a><span id="l58.373" class="difflineplus">+    *_retval = (int32_t)m_found;</span>
<a href="#l58.374"></a><span id="l58.374">   }</span>
<a href="#l58.375"></a><span id="l58.375"> </span>
<a href="#l58.376"></a><span id="l58.376">   if (!PL_strcasecmp(statusKind, &quot;canUserSetLocation&quot;)) {</span>
<a href="#l58.377"></a><span id="l58.377">     GetDefaultLocation();</span>
<a href="#l58.378"></a><span id="l58.378" class="difflineminus">-    *_retval = (int32_t) m_userVerify;</span>
<a href="#l58.379"></a><span id="l58.379" class="difflineplus">+    *_retval = (int32_t)m_userVerify;</span>
<a href="#l58.380"></a><span id="l58.380">   }</span>
<a href="#l58.381"></a><span id="l58.381"> </span>
<a href="#l58.382"></a><span id="l58.382">   return NS_OK;</span>
<a href="#l58.383"></a><span id="l58.383"> }</span>
<a href="#l58.384"></a><span id="l58.384"> </span>
<a href="#l58.385"></a><span id="l58.385" class="difflineplus">+void nsImportGenericMail::GetDefaultLocation(void) {</span>
<a href="#l58.386"></a><span id="l58.386" class="difflineplus">+  if (!m_pInterface) return;</span>
<a href="#l58.387"></a><span id="l58.387"> </span>
<a href="#l58.388"></a><span id="l58.388" class="difflineminus">-void nsImportGenericMail::GetDefaultLocation(void)</span>
<a href="#l58.389"></a><span id="l58.389" class="difflineminus">-{</span>
<a href="#l58.390"></a><span id="l58.390" class="difflineminus">-  if (!m_pInterface)</span>
<a href="#l58.391"></a><span id="l58.391" class="difflineminus">-    return;</span>
<a href="#l58.392"></a><span id="l58.392" class="difflineminus">-</span>
<a href="#l58.393"></a><span id="l58.393" class="difflineminus">-  if (m_pSrcLocation &amp;&amp; m_gotLocation)</span>
<a href="#l58.394"></a><span id="l58.394" class="difflineminus">-    return;</span>
<a href="#l58.395"></a><span id="l58.395" class="difflineplus">+  if (m_pSrcLocation &amp;&amp; m_gotLocation) return;</span>
<a href="#l58.396"></a><span id="l58.396"> </span>
<a href="#l58.397"></a><span id="l58.397">   m_gotLocation = true;</span>
<a href="#l58.398"></a><span id="l58.398"> </span>
<a href="#l58.399"></a><span id="l58.399" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; pLoc;</span>
<a href="#l58.400"></a><span id="l58.400" class="difflineminus">-  m_pInterface-&gt;GetDefaultLocation(getter_AddRefs(pLoc), &amp;m_found, &amp;m_userVerify);</span>
<a href="#l58.401"></a><span id="l58.401" class="difflineminus">-  if (!m_pSrcLocation)</span>
<a href="#l58.402"></a><span id="l58.402" class="difflineminus">-    m_pSrcLocation = pLoc;</span>
<a href="#l58.403"></a><span id="l58.403" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; pLoc;</span>
<a href="#l58.404"></a><span id="l58.404" class="difflineplus">+  m_pInterface-&gt;GetDefaultLocation(getter_AddRefs(pLoc), &amp;m_found,</span>
<a href="#l58.405"></a><span id="l58.405" class="difflineplus">+                                   &amp;m_userVerify);</span>
<a href="#l58.406"></a><span id="l58.406" class="difflineplus">+  if (!m_pSrcLocation) m_pSrcLocation = pLoc;</span>
<a href="#l58.407"></a><span id="l58.407"> }</span>
<a href="#l58.408"></a><span id="l58.408"> </span>
<a href="#l58.409"></a><span id="l58.409" class="difflineminus">-void nsImportGenericMail::GetDefaultMailboxes(void)</span>
<a href="#l58.410"></a><span id="l58.410" class="difflineminus">-{</span>
<a href="#l58.411"></a><span id="l58.411" class="difflineminus">-  if (!m_pInterface || m_pMailboxes || !m_pSrcLocation)</span>
<a href="#l58.412"></a><span id="l58.412" class="difflineminus">-    return;</span>
<a href="#l58.413"></a><span id="l58.413" class="difflineplus">+void nsImportGenericMail::GetDefaultMailboxes(void) {</span>
<a href="#l58.414"></a><span id="l58.414" class="difflineplus">+  if (!m_pInterface || m_pMailboxes || !m_pSrcLocation) return;</span>
<a href="#l58.415"></a><span id="l58.415"> </span>
<a href="#l58.416"></a><span id="l58.416">   m_pInterface-&gt;FindMailboxes(m_pSrcLocation, getter_AddRefs(m_pMailboxes));</span>
<a href="#l58.417"></a><span id="l58.417"> }</span>
<a href="#l58.418"></a><span id="l58.418"> </span>
<a href="#l58.419"></a><span id="l58.419" class="difflineminus">-void nsImportGenericMail::GetDefaultDestination(void)</span>
<a href="#l58.420"></a><span id="l58.420" class="difflineminus">-{</span>
<a href="#l58.421"></a><span id="l58.421" class="difflineminus">-  if (m_pDestFolder)</span>
<a href="#l58.422"></a><span id="l58.422" class="difflineminus">-    return;</span>
<a href="#l58.423"></a><span id="l58.423" class="difflineminus">-  if (!m_pInterface)</span>
<a href="#l58.424"></a><span id="l58.424" class="difflineminus">-    return;</span>
<a href="#l58.425"></a><span id="l58.425" class="difflineplus">+void nsImportGenericMail::GetDefaultDestination(void) {</span>
<a href="#l58.426"></a><span id="l58.426" class="difflineplus">+  if (m_pDestFolder) return;</span>
<a href="#l58.427"></a><span id="l58.427" class="difflineplus">+  if (!m_pInterface) return;</span>
<a href="#l58.428"></a><span id="l58.428"> </span>
<a href="#l58.429"></a><span id="l58.429" class="difflineminus">-  nsIMsgFolder *  rootFolder;</span>
<a href="#l58.430"></a><span id="l58.430" class="difflineplus">+  nsIMsgFolder *rootFolder;</span>
<a href="#l58.431"></a><span id="l58.431">   m_deleteDestFolder = false;</span>
<a href="#l58.432"></a><span id="l58.432">   m_createdFolder = false;</span>
<a href="#l58.433"></a><span id="l58.433">   if (CreateFolder(&amp;rootFolder)) {</span>
<a href="#l58.434"></a><span id="l58.434">     m_pDestFolder = rootFolder;</span>
<a href="#l58.435"></a><span id="l58.435">     m_deleteDestFolder = true;</span>
<a href="#l58.436"></a><span id="l58.436">     m_createdFolder = true;</span>
<a href="#l58.437"></a><span id="l58.437">     return;</span>
<a href="#l58.438"></a><span id="l58.438">   }</span>
<a href="#l58.439"></a><span id="l58.439" class="difflineminus">-  IMPORT_LOG0(&quot;*** GetDefaultDestination: Failed to create a default import destination folder.&quot;);</span>
<a href="#l58.440"></a><span id="l58.440" class="difflineplus">+  IMPORT_LOG0(</span>
<a href="#l58.441"></a><span id="l58.441" class="difflineplus">+      &quot;*** GetDefaultDestination: Failed to create a default import &quot;</span>
<a href="#l58.442"></a><span id="l58.442" class="difflineplus">+      &quot;destination folder.&quot;);</span>
<a href="#l58.443"></a><span id="l58.443"> }</span>
<a href="#l58.444"></a><span id="l58.444"> </span>
<a href="#l58.445"></a><span id="l58.445" class="difflineminus">-NS_IMETHODIMP nsImportGenericMail::WantsProgress(bool *_retval)</span>
<a href="#l58.446"></a><span id="l58.446" class="difflineminus">-{</span>
<a href="#l58.447"></a><span id="l58.447" class="difflineplus">+NS_IMETHODIMP nsImportGenericMail::WantsProgress(bool *_retval) {</span>
<a href="#l58.448"></a><span id="l58.448">   NS_ASSERTION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l58.449"></a><span id="l58.449">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l58.450"></a><span id="l58.450"> </span>
<a href="#l58.451"></a><span id="l58.451">   if (m_pThreadData) {</span>
<a href="#l58.452"></a><span id="l58.452">     m_pThreadData-&gt;DriverAbort();</span>
<a href="#l58.453"></a><span id="l58.453">     m_pThreadData = nullptr;</span>
<a href="#l58.454"></a><span id="l58.454">   }</span>
<a href="#l58.455"></a><span id="l58.455"> </span>
<a href="#l58.456"></a><span id="l58.456" class="difflineat">@@ -370,90 +352,94 @@ NS_IMETHODIMP nsImportGenericMail::Wants</span>
<a href="#l58.457"></a><span id="l58.457"> </span>
<a href="#l58.458"></a><span id="l58.458">   if (!m_pDestFolder) {</span>
<a href="#l58.459"></a><span id="l58.459">     GetDefaultDestination();</span>
<a href="#l58.460"></a><span id="l58.460">   }</span>
<a href="#l58.461"></a><span id="l58.461"> </span>
<a href="#l58.462"></a><span id="l58.462">   bool result = false;</span>
<a href="#l58.463"></a><span id="l58.463"> </span>
<a href="#l58.464"></a><span id="l58.464">   if (m_pMailboxes) {</span>
<a href="#l58.465"></a><span id="l58.465" class="difflineminus">-    uint32_t    i;</span>
<a href="#l58.466"></a><span id="l58.466" class="difflineminus">-    bool        import;</span>
<a href="#l58.467"></a><span id="l58.467" class="difflineminus">-    uint32_t    count = 0;</span>
<a href="#l58.468"></a><span id="l58.468" class="difflineminus">-    uint32_t    size;</span>
<a href="#l58.469"></a><span id="l58.469" class="difflineminus">-    uint32_t    totalSize = 0;</span>
<a href="#l58.470"></a><span id="l58.470" class="difflineplus">+    uint32_t i;</span>
<a href="#l58.471"></a><span id="l58.471" class="difflineplus">+    bool import;</span>
<a href="#l58.472"></a><span id="l58.472" class="difflineplus">+    uint32_t count = 0;</span>
<a href="#l58.473"></a><span id="l58.473" class="difflineplus">+    uint32_t size;</span>
<a href="#l58.474"></a><span id="l58.474" class="difflineplus">+    uint32_t totalSize = 0;</span>
<a href="#l58.475"></a><span id="l58.475"> </span>
<a href="#l58.476"></a><span id="l58.476" class="difflineminus">-    (void) m_pMailboxes-&gt;GetLength(&amp;count);</span>
<a href="#l58.477"></a><span id="l58.477" class="difflineplus">+    (void)m_pMailboxes-&gt;GetLength(&amp;count);</span>
<a href="#l58.478"></a><span id="l58.478">     for (i = 0; i &lt; count; i++) {</span>
<a href="#l58.479"></a><span id="l58.479">       nsCOMPtr&lt;nsIImportMailboxDescriptor&gt; box =</span>
<a href="#l58.480"></a><span id="l58.480" class="difflineminus">-        do_QueryElementAt(m_pMailboxes, i);</span>
<a href="#l58.481"></a><span id="l58.481" class="difflineplus">+          do_QueryElementAt(m_pMailboxes, i);</span>
<a href="#l58.482"></a><span id="l58.482">       if (box) {</span>
<a href="#l58.483"></a><span id="l58.483">         import = false;</span>
<a href="#l58.484"></a><span id="l58.484">         size = 0;</span>
<a href="#l58.485"></a><span id="l58.485">         nsresult rv = box-&gt;GetImport(&amp;import);</span>
<a href="#l58.486"></a><span id="l58.486">         if (NS_SUCCEEDED(rv) &amp;&amp; import) {</span>
<a href="#l58.487"></a><span id="l58.487" class="difflineminus">-          (void) box-&gt;GetSize(&amp;size);</span>
<a href="#l58.488"></a><span id="l58.488" class="difflineplus">+          (void)box-&gt;GetSize(&amp;size);</span>
<a href="#l58.489"></a><span id="l58.489">           result = true;</span>
<a href="#l58.490"></a><span id="l58.490">         }</span>
<a href="#l58.491"></a><span id="l58.491">         totalSize += size;</span>
<a href="#l58.492"></a><span id="l58.492">       }</span>
<a href="#l58.493"></a><span id="l58.493">     }</span>
<a href="#l58.494"></a><span id="l58.494"> </span>
<a href="#l58.495"></a><span id="l58.495">     m_totalSize = totalSize;</span>
<a href="#l58.496"></a><span id="l58.496">   }</span>
<a href="#l58.497"></a><span id="l58.497"> </span>
<a href="#l58.498"></a><span id="l58.498">   m_doImport = result;</span>
<a href="#l58.499"></a><span id="l58.499"> </span>
<a href="#l58.500"></a><span id="l58.500">   *_retval = result;</span>
<a href="#l58.501"></a><span id="l58.501"> </span>
<a href="#l58.502"></a><span id="l58.502">   return NS_OK;</span>
<a href="#l58.503"></a><span id="l58.503"> }</span>
<a href="#l58.504"></a><span id="l58.504"> </span>
<a href="#l58.505"></a><span id="l58.505" class="difflineminus">-void nsImportGenericMail::GetMailboxName(uint32_t index, nsISupportsString *pStr)</span>
<a href="#l58.506"></a><span id="l58.506" class="difflineminus">-{</span>
<a href="#l58.507"></a><span id="l58.507" class="difflineplus">+void nsImportGenericMail::GetMailboxName(uint32_t index,</span>
<a href="#l58.508"></a><span id="l58.508" class="difflineplus">+                                         nsISupportsString *pStr) {</span>
<a href="#l58.509"></a><span id="l58.509">   if (m_pMailboxes) {</span>
<a href="#l58.510"></a><span id="l58.510" class="difflineminus">-    nsCOMPtr&lt;nsIImportMailboxDescriptor&gt; box(do_QueryElementAt(m_pMailboxes, index));</span>
<a href="#l58.511"></a><span id="l58.511" class="difflineplus">+    nsCOMPtr&lt;nsIImportMailboxDescriptor&gt; box(</span>
<a href="#l58.512"></a><span id="l58.512" class="difflineplus">+        do_QueryElementAt(m_pMailboxes, index));</span>
<a href="#l58.513"></a><span id="l58.513">     if (box) {</span>
<a href="#l58.514"></a><span id="l58.514">       nsAutoString name;</span>
<a href="#l58.515"></a><span id="l58.515">       box-&gt;GetDisplayName(getter_Copies(name));</span>
<a href="#l58.516"></a><span id="l58.516">       if (!name.IsEmpty()) {</span>
<a href="#l58.517"></a><span id="l58.517">         pStr-&gt;SetData(name);</span>
<a href="#l58.518"></a><span id="l58.518">       }</span>
<a href="#l58.519"></a><span id="l58.519">     }</span>
<a href="#l58.520"></a><span id="l58.520">   }</span>
<a href="#l58.521"></a><span id="l58.521"> }</span>
<a href="#l58.522"></a><span id="l58.522"> </span>
<a href="#l58.523"></a><span id="l58.523" class="difflineminus">-NS_IMETHODIMP nsImportGenericMail::BeginImport(nsISupportsString *successLog, nsISupportsString *errorLog, bool *_retval)</span>
<a href="#l58.524"></a><span id="l58.524" class="difflineminus">-{</span>
<a href="#l58.525"></a><span id="l58.525" class="difflineplus">+NS_IMETHODIMP nsImportGenericMail::BeginImport(nsISupportsString *successLog,</span>
<a href="#l58.526"></a><span id="l58.526" class="difflineplus">+                                               nsISupportsString *errorLog,</span>
<a href="#l58.527"></a><span id="l58.527" class="difflineplus">+                                               bool *_retval) {</span>
<a href="#l58.528"></a><span id="l58.528">   NS_ASSERTION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l58.529"></a><span id="l58.529" class="difflineminus">-  if (!_retval)</span>
<a href="#l58.530"></a><span id="l58.530" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l58.531"></a><span id="l58.531" class="difflineplus">+  if (!_retval) return NS_ERROR_NULL_POINTER;</span>
<a href="#l58.532"></a><span id="l58.532"> </span>
<a href="#l58.533"></a><span id="l58.533" class="difflineminus">-  nsString  success;</span>
<a href="#l58.534"></a><span id="l58.534" class="difflineminus">-  nsString  error;</span>
<a href="#l58.535"></a><span id="l58.535" class="difflineplus">+  nsString success;</span>
<a href="#l58.536"></a><span id="l58.536" class="difflineplus">+  nsString error;</span>
<a href="#l58.537"></a><span id="l58.537"> </span>
<a href="#l58.538"></a><span id="l58.538">   if (!m_doImport) {</span>
<a href="#l58.539"></a><span id="l58.539" class="difflineminus">-    nsImportStringBundle::GetStringByID(IMPORT_NO_MAILBOXES,</span>
<a href="#l58.540"></a><span id="l58.540" class="difflineminus">-                                        m_stringBundle, success);</span>
<a href="#l58.541"></a><span id="l58.541" class="difflineplus">+    nsImportStringBundle::GetStringByID(IMPORT_NO_MAILBOXES, m_stringBundle,</span>
<a href="#l58.542"></a><span id="l58.542" class="difflineplus">+                                        success);</span>
<a href="#l58.543"></a><span id="l58.543">     SetLogs(success, error, successLog, errorLog);</span>
<a href="#l58.544"></a><span id="l58.544">     *_retval = true;</span>
<a href="#l58.545"></a><span id="l58.545">     return NS_OK;</span>
<a href="#l58.546"></a><span id="l58.546">   }</span>
<a href="#l58.547"></a><span id="l58.547"> </span>
<a href="#l58.548"></a><span id="l58.548">   if (!m_pInterface || !m_pMailboxes) {</span>
<a href="#l58.549"></a><span id="l58.549" class="difflineminus">-    IMPORT_LOG0(&quot;*** BeginImport: Either the interface or source mailbox is not set properly.&quot;);</span>
<a href="#l58.550"></a><span id="l58.550" class="difflineplus">+    IMPORT_LOG0(</span>
<a href="#l58.551"></a><span id="l58.551" class="difflineplus">+        &quot;*** BeginImport: Either the interface or source mailbox is not set &quot;</span>
<a href="#l58.552"></a><span id="l58.552" class="difflineplus">+        &quot;properly.&quot;);</span>
<a href="#l58.553"></a><span id="l58.553">     nsImportStringBundle::GetStringByID(IMPORT_ERROR_MB_NOTINITIALIZED,</span>
<a href="#l58.554"></a><span id="l58.554">                                         m_stringBundle, error);</span>
<a href="#l58.555"></a><span id="l58.555">     SetLogs(success, error, successLog, errorLog);</span>
<a href="#l58.556"></a><span id="l58.556">     *_retval = false;</span>
<a href="#l58.557"></a><span id="l58.557">     return NS_OK;</span>
<a href="#l58.558"></a><span id="l58.558">   }</span>
<a href="#l58.559"></a><span id="l58.559"> </span>
<a href="#l58.560"></a><span id="l58.560">   if (!m_pDestFolder) {</span>
<a href="#l58.561"></a><span id="l58.561" class="difflineminus">-    IMPORT_LOG0(&quot;*** BeginImport: The destination mailbox is not set properly.&quot;);</span>
<a href="#l58.562"></a><span id="l58.562" class="difflineplus">+    IMPORT_LOG0(</span>
<a href="#l58.563"></a><span id="l58.563" class="difflineplus">+        &quot;*** BeginImport: The destination mailbox is not set properly.&quot;);</span>
<a href="#l58.564"></a><span id="l58.564">     nsImportStringBundle::GetStringByID(IMPORT_ERROR_MB_NODESTFOLDER,</span>
<a href="#l58.565"></a><span id="l58.565">                                         m_stringBundle, error);</span>
<a href="#l58.566"></a><span id="l58.566">     SetLogs(success, error, successLog, errorLog);</span>
<a href="#l58.567"></a><span id="l58.567">     *_retval = false;</span>
<a href="#l58.568"></a><span id="l58.568">     return NS_OK;</span>
<a href="#l58.569"></a><span id="l58.569">   }</span>
<a href="#l58.570"></a><span id="l58.570"> </span>
<a href="#l58.571"></a><span id="l58.571">   if (m_pThreadData) {</span>
<a href="#l58.572"></a><span id="l58.572" class="difflineat">@@ -472,713 +458,686 @@ NS_IMETHODIMP nsImportGenericMail::Begin</span>
<a href="#l58.573"></a><span id="l58.573">   m_pThreadData-&gt;successLog = m_pSuccessLog;</span>
<a href="#l58.574"></a><span id="l58.574"> </span>
<a href="#l58.575"></a><span id="l58.575">   m_pThreadData-&gt;ownsDestRoot = m_deleteDestFolder;</span>
<a href="#l58.576"></a><span id="l58.576">   m_pThreadData-&gt;destRoot = m_pDestFolder;</span>
<a href="#l58.577"></a><span id="l58.577">   m_pThreadData-&gt;performingMigration = m_performingMigration;</span>
<a href="#l58.578"></a><span id="l58.578"> </span>
<a href="#l58.579"></a><span id="l58.579">   m_pThreadData-&gt;stringBundle = m_stringBundle;</span>
<a href="#l58.580"></a><span id="l58.580"> </span>
<a href="#l58.581"></a><span id="l58.581" class="difflineminus">-  PRThread *pThread = PR_CreateThread(PR_USER_THREAD, &amp;ImportMailThread, m_pThreadData,</span>
<a href="#l58.582"></a><span id="l58.582" class="difflineminus">-                  PR_PRIORITY_NORMAL,</span>
<a href="#l58.583"></a><span id="l58.583" class="difflineminus">-                  PR_LOCAL_THREAD,</span>
<a href="#l58.584"></a><span id="l58.584" class="difflineminus">-                  PR_UNJOINABLE_THREAD,</span>
<a href="#l58.585"></a><span id="l58.585" class="difflineminus">-                  0);</span>
<a href="#l58.586"></a><span id="l58.586" class="difflineplus">+  PRThread *pThread = PR_CreateThread(PR_USER_THREAD, &amp;ImportMailThread,</span>
<a href="#l58.587"></a><span id="l58.587" class="difflineplus">+                                      m_pThreadData, PR_PRIORITY_NORMAL,</span>
<a href="#l58.588"></a><span id="l58.588" class="difflineplus">+                                      PR_LOCAL_THREAD, PR_UNJOINABLE_THREAD, 0);</span>
<a href="#l58.589"></a><span id="l58.589">   if (!pThread) {</span>
<a href="#l58.590"></a><span id="l58.590">     m_pThreadData-&gt;ThreadDelete();</span>
<a href="#l58.591"></a><span id="l58.591">     m_pThreadData-&gt;abort = true;</span>
<a href="#l58.592"></a><span id="l58.592">     m_pThreadData-&gt;DriverAbort();</span>
<a href="#l58.593"></a><span id="l58.593">     m_pThreadData = nullptr;</span>
<a href="#l58.594"></a><span id="l58.594">     *_retval = false;</span>
<a href="#l58.595"></a><span id="l58.595">     nsImportStringBundle::GetStringByID(IMPORT_ERROR_MB_NOTHREAD,</span>
<a href="#l58.596"></a><span id="l58.596">                                         m_stringBundle, error);</span>
<a href="#l58.597"></a><span id="l58.597">     SetLogs(success, error, successLog, errorLog);</span>
<a href="#l58.598"></a><span id="l58.598" class="difflineminus">-  }</span>
<a href="#l58.599"></a><span id="l58.599" class="difflineminus">-  else</span>
<a href="#l58.600"></a><span id="l58.600" class="difflineplus">+  } else</span>
<a href="#l58.601"></a><span id="l58.601">     *_retval = true;</span>
<a href="#l58.602"></a><span id="l58.602"> </span>
<a href="#l58.603"></a><span id="l58.603">   return NS_OK;</span>
<a href="#l58.604"></a><span id="l58.604" class="difflineminus">-</span>
<a href="#l58.605"></a><span id="l58.605"> }</span>
<a href="#l58.606"></a><span id="l58.606"> </span>
<a href="#l58.607"></a><span id="l58.607" class="difflineminus">-</span>
<a href="#l58.608"></a><span id="l58.608" class="difflineminus">-NS_IMETHODIMP nsImportGenericMail::ContinueImport(bool *_retval)</span>
<a href="#l58.609"></a><span id="l58.609" class="difflineminus">-{</span>
<a href="#l58.610"></a><span id="l58.610" class="difflineplus">+NS_IMETHODIMP nsImportGenericMail::ContinueImport(bool *_retval) {</span>
<a href="#l58.611"></a><span id="l58.611">   NS_ASSERTION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l58.612"></a><span id="l58.612" class="difflineminus">-  if (!_retval)</span>
<a href="#l58.613"></a><span id="l58.613" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l58.614"></a><span id="l58.614" class="difflineplus">+  if (!_retval) return NS_ERROR_NULL_POINTER;</span>
<a href="#l58.615"></a><span id="l58.615"> </span>
<a href="#l58.616"></a><span id="l58.616">   *_retval = true;</span>
<a href="#l58.617"></a><span id="l58.617">   if (m_pThreadData) {</span>
<a href="#l58.618"></a><span id="l58.618" class="difflineminus">-    if (m_pThreadData-&gt;fatalError)</span>
<a href="#l58.619"></a><span id="l58.619" class="difflineminus">-      *_retval = false;</span>
<a href="#l58.620"></a><span id="l58.620" class="difflineplus">+    if (m_pThreadData-&gt;fatalError) *_retval = false;</span>
<a href="#l58.621"></a><span id="l58.621">   }</span>
<a href="#l58.622"></a><span id="l58.622"> </span>
<a href="#l58.623"></a><span id="l58.623">   return NS_OK;</span>
<a href="#l58.624"></a><span id="l58.624"> }</span>
<a href="#l58.625"></a><span id="l58.625"> </span>
<a href="#l58.626"></a><span id="l58.626" class="difflineminus">-</span>
<a href="#l58.627"></a><span id="l58.627" class="difflineminus">-NS_IMETHODIMP nsImportGenericMail::GetProgress(int32_t *_retval)</span>
<a href="#l58.628"></a><span id="l58.628" class="difflineminus">-{</span>
<a href="#l58.629"></a><span id="l58.629" class="difflineplus">+NS_IMETHODIMP nsImportGenericMail::GetProgress(int32_t *_retval) {</span>
<a href="#l58.630"></a><span id="l58.630">   // This returns the progress from the the currently</span>
<a href="#l58.631"></a><span id="l58.631">   // running import mail or import address book thread.</span>
<a href="#l58.632"></a><span id="l58.632">   NS_ASSERTION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l58.633"></a><span id="l58.633" class="difflineminus">-  if (!_retval)</span>
<a href="#l58.634"></a><span id="l58.634" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l58.635"></a><span id="l58.635" class="difflineplus">+  if (!_retval) return NS_ERROR_NULL_POINTER;</span>
<a href="#l58.636"></a><span id="l58.636"> </span>
<a href="#l58.637"></a><span id="l58.637">   if (!m_pThreadData || !(m_pThreadData-&gt;threadAlive)) {</span>
<a href="#l58.638"></a><span id="l58.638">     *_retval = 100;</span>
<a href="#l58.639"></a><span id="l58.639">     return NS_OK;</span>
<a href="#l58.640"></a><span id="l58.640">   }</span>
<a href="#l58.641"></a><span id="l58.641"> </span>
<a href="#l58.642"></a><span id="l58.642">   uint32_t sz = 0;</span>
<a href="#l58.643"></a><span id="l58.643">   if (m_pThreadData-&gt;currentSize &amp;&amp; m_pInterface) {</span>
<a href="#l58.644"></a><span id="l58.644" class="difflineminus">-    if (NS_FAILED(m_pInterface-&gt;GetImportProgress(&amp;sz)))</span>
<a href="#l58.645"></a><span id="l58.645" class="difflineminus">-      sz = 0;</span>
<a href="#l58.646"></a><span id="l58.646" class="difflineplus">+    if (NS_FAILED(m_pInterface-&gt;GetImportProgress(&amp;sz))) sz = 0;</span>
<a href="#l58.647"></a><span id="l58.647">   }</span>
<a href="#l58.648"></a><span id="l58.648"> </span>
<a href="#l58.649"></a><span id="l58.649" class="difflineminus">-</span>
<a href="#l58.650"></a><span id="l58.650" class="difflineminus">-  // *_retval = (int32_t) (((uint32_t)(m_pThreadData-&gt;currentTotal + sz) * (uint32_t)100) / m_totalSize);</span>
<a href="#l58.651"></a><span id="l58.651" class="difflineplus">+  // *_retval = (int32_t) (((uint32_t)(m_pThreadData-&gt;currentTotal + sz) *</span>
<a href="#l58.652"></a><span id="l58.652" class="difflineplus">+  // (uint32_t)100) / m_totalSize);</span>
<a href="#l58.653"></a><span id="l58.653"> </span>
<a href="#l58.654"></a><span id="l58.654">   if (m_totalSize) {</span>
<a href="#l58.655"></a><span id="l58.655" class="difflineminus">-    double  perc;</span>
<a href="#l58.656"></a><span id="l58.656" class="difflineminus">-    perc = (double) m_pThreadData-&gt;currentTotal;</span>
<a href="#l58.657"></a><span id="l58.657" class="difflineplus">+    double perc;</span>
<a href="#l58.658"></a><span id="l58.658" class="difflineplus">+    perc = (double)m_pThreadData-&gt;currentTotal;</span>
<a href="#l58.659"></a><span id="l58.659">     perc += sz;</span>
<a href="#l58.660"></a><span id="l58.660">     perc *= 100;</span>
<a href="#l58.661"></a><span id="l58.661">     perc /= m_totalSize;</span>
<a href="#l58.662"></a><span id="l58.662" class="difflineminus">-    *_retval = (int32_t) perc;</span>
<a href="#l58.663"></a><span id="l58.663" class="difflineminus">-    if (*_retval &gt; 100)</span>
<a href="#l58.664"></a><span id="l58.664" class="difflineminus">-      *_retval = 100;</span>
<a href="#l58.665"></a><span id="l58.665" class="difflineminus">-  }</span>
<a href="#l58.666"></a><span id="l58.666" class="difflineminus">-  else</span>
<a href="#l58.667"></a><span id="l58.667" class="difflineplus">+    *_retval = (int32_t)perc;</span>
<a href="#l58.668"></a><span id="l58.668" class="difflineplus">+    if (*_retval &gt; 100) *_retval = 100;</span>
<a href="#l58.669"></a><span id="l58.669" class="difflineplus">+  } else</span>
<a href="#l58.670"></a><span id="l58.670">     *_retval = 0;</span>
<a href="#l58.671"></a><span id="l58.671"> </span>
<a href="#l58.672"></a><span id="l58.672">   // never return 100% while the thread is still alive</span>
<a href="#l58.673"></a><span id="l58.673" class="difflineminus">-  if (*_retval &gt; 99)</span>
<a href="#l58.674"></a><span id="l58.674" class="difflineminus">-    *_retval = 99;</span>
<a href="#l58.675"></a><span id="l58.675" class="difflineplus">+  if (*_retval &gt; 99) *_retval = 99;</span>
<a href="#l58.676"></a><span id="l58.676"> </span>
<a href="#l58.677"></a><span id="l58.677">   return NS_OK;</span>
<a href="#l58.678"></a><span id="l58.678"> }</span>
<a href="#l58.679"></a><span id="l58.679"> </span>
<a href="#l58.680"></a><span id="l58.680" class="difflineminus">-void nsImportGenericMail::ReportError(int32_t id, const char16_t *pName, nsString *pStream, nsIStringBundle *aBundle)</span>
<a href="#l58.681"></a><span id="l58.681" class="difflineminus">-{</span>
<a href="#l58.682"></a><span id="l58.682" class="difflineminus">-  if (!pStream)</span>
<a href="#l58.683"></a><span id="l58.683" class="difflineminus">-    return;</span>
<a href="#l58.684"></a><span id="l58.684" class="difflineplus">+void nsImportGenericMail::ReportError(int32_t id, const char16_t *pName,</span>
<a href="#l58.685"></a><span id="l58.685" class="difflineplus">+                                      nsString *pStream,</span>
<a href="#l58.686"></a><span id="l58.686" class="difflineplus">+                                      nsIStringBundle *aBundle) {</span>
<a href="#l58.687"></a><span id="l58.687" class="difflineplus">+  if (!pStream) return;</span>
<a href="#l58.688"></a><span id="l58.688"> </span>
<a href="#l58.689"></a><span id="l58.689">   // load the error string</span>
<a href="#l58.690"></a><span id="l58.690">   char16_t *pFmt = nsImportStringBundle::GetStringByID(id, aBundle);</span>
<a href="#l58.691"></a><span id="l58.691">   nsString pText;</span>
<a href="#l58.692"></a><span id="l58.692">   nsTextFormatter::ssprintf(pText, pFmt, pName);</span>
<a href="#l58.693"></a><span id="l58.693">   pStream-&gt;Append(pText);</span>
<a href="#l58.694"></a><span id="l58.694">   free(pFmt);</span>
<a href="#l58.695"></a><span id="l58.695">   pStream-&gt;Append(NS_ConvertASCIItoUTF16(MSG_LINEBREAK));</span>
<a href="#l58.696"></a><span id="l58.696"> }</span>
<a href="#l58.697"></a><span id="l58.697"> </span>
<a href="#l58.698"></a><span id="l58.698" class="difflineminus">-</span>
<a href="#l58.699"></a><span id="l58.699" class="difflineminus">-void nsImportGenericMail::SetLogs(nsString&amp; success, nsString&amp; error, nsISupportsString *pSuccess, nsISupportsString *pError)</span>
<a href="#l58.700"></a><span id="l58.700" class="difflineminus">-{</span>
<a href="#l58.701"></a><span id="l58.701" class="difflineminus">-    nsAutoString str;</span>
<a href="#l58.702"></a><span id="l58.702" class="difflineminus">-    if (pSuccess) {</span>
<a href="#l58.703"></a><span id="l58.703" class="difflineminus">-        pSuccess-&gt;GetData(str);</span>
<a href="#l58.704"></a><span id="l58.704" class="difflineminus">-        str.Append(success);</span>
<a href="#l58.705"></a><span id="l58.705" class="difflineminus">-        pSuccess-&gt;SetData(str);</span>
<a href="#l58.706"></a><span id="l58.706" class="difflineminus">-    }</span>
<a href="#l58.707"></a><span id="l58.707" class="difflineminus">-    if (pError) {</span>
<a href="#l58.708"></a><span id="l58.708" class="difflineminus">-        pError-&gt;GetData(str);</span>
<a href="#l58.709"></a><span id="l58.709" class="difflineminus">-        str.Append(error);</span>
<a href="#l58.710"></a><span id="l58.710" class="difflineminus">-        pError-&gt;SetData(str);</span>
<a href="#l58.711"></a><span id="l58.711" class="difflineminus">-    }</span>
<a href="#l58.712"></a><span id="l58.712" class="difflineplus">+void nsImportGenericMail::SetLogs(nsString &amp;success, nsString &amp;error,</span>
<a href="#l58.713"></a><span id="l58.713" class="difflineplus">+                                  nsISupportsString *pSuccess,</span>
<a href="#l58.714"></a><span id="l58.714" class="difflineplus">+                                  nsISupportsString *pError) {</span>
<a href="#l58.715"></a><span id="l58.715" class="difflineplus">+  nsAutoString str;</span>
<a href="#l58.716"></a><span id="l58.716" class="difflineplus">+  if (pSuccess) {</span>
<a href="#l58.717"></a><span id="l58.717" class="difflineplus">+    pSuccess-&gt;GetData(str);</span>
<a href="#l58.718"></a><span id="l58.718" class="difflineplus">+    str.Append(success);</span>
<a href="#l58.719"></a><span id="l58.719" class="difflineplus">+    pSuccess-&gt;SetData(str);</span>
<a href="#l58.720"></a><span id="l58.720" class="difflineplus">+  }</span>
<a href="#l58.721"></a><span id="l58.721" class="difflineplus">+  if (pError) {</span>
<a href="#l58.722"></a><span id="l58.722" class="difflineplus">+    pError-&gt;GetData(str);</span>
<a href="#l58.723"></a><span id="l58.723" class="difflineplus">+    str.Append(error);</span>
<a href="#l58.724"></a><span id="l58.724" class="difflineplus">+    pError-&gt;SetData(str);</span>
<a href="#l58.725"></a><span id="l58.725" class="difflineplus">+  }</span>
<a href="#l58.726"></a><span id="l58.726"> }</span>
<a href="#l58.727"></a><span id="l58.727"> </span>
<a href="#l58.728"></a><span id="l58.728" class="difflineminus">-NS_IMETHODIMP nsImportGenericMail::CancelImport(void)</span>
<a href="#l58.729"></a><span id="l58.729" class="difflineminus">-{</span>
<a href="#l58.730"></a><span id="l58.730" class="difflineplus">+NS_IMETHODIMP nsImportGenericMail::CancelImport(void) {</span>
<a href="#l58.731"></a><span id="l58.731">   if (m_pThreadData) {</span>
<a href="#l58.732"></a><span id="l58.732">     m_pThreadData-&gt;abort = true;</span>
<a href="#l58.733"></a><span id="l58.733">     m_pThreadData-&gt;DriverAbort();</span>
<a href="#l58.734"></a><span id="l58.734">     m_pThreadData = nullptr;</span>
<a href="#l58.735"></a><span id="l58.735">   }</span>
<a href="#l58.736"></a><span id="l58.736"> </span>
<a href="#l58.737"></a><span id="l58.737">   return NS_OK;</span>
<a href="#l58.738"></a><span id="l58.738"> }</span>
<a href="#l58.739"></a><span id="l58.739"> </span>
<a href="#l58.740"></a><span id="l58.740" class="difflineminus">-</span>
<a href="#l58.741"></a><span id="l58.741" class="difflineminus">-ImportThreadData::ImportThreadData()</span>
<a href="#l58.742"></a><span id="l58.742" class="difflineminus">-{</span>
<a href="#l58.743"></a><span id="l58.743" class="difflineplus">+ImportThreadData::ImportThreadData() {</span>
<a href="#l58.744"></a><span id="l58.744">   fatalError = false;</span>
<a href="#l58.745"></a><span id="l58.745">   driverAlive = true;</span>
<a href="#l58.746"></a><span id="l58.746">   threadAlive = true;</span>
<a href="#l58.747"></a><span id="l58.747">   abort = false;</span>
<a href="#l58.748"></a><span id="l58.748">   currentTotal = 0;</span>
<a href="#l58.749"></a><span id="l58.749">   currentSize = 0;</span>
<a href="#l58.750"></a><span id="l58.750">   destRoot = nullptr;</span>
<a href="#l58.751"></a><span id="l58.751">   ownsDestRoot = false;</span>
<a href="#l58.752"></a><span id="l58.752"> }</span>
<a href="#l58.753"></a><span id="l58.753"> </span>
<a href="#l58.754"></a><span id="l58.754" class="difflineminus">-ImportThreadData::~ImportThreadData()</span>
<a href="#l58.755"></a><span id="l58.755" class="difflineminus">-{</span>
<a href="#l58.756"></a><span id="l58.756" class="difflineplus">+ImportThreadData::~ImportThreadData() {}</span>
<a href="#l58.757"></a><span id="l58.757" class="difflineplus">+</span>
<a href="#l58.758"></a><span id="l58.758" class="difflineplus">+void ImportThreadData::DriverDelete(void) {</span>
<a href="#l58.759"></a><span id="l58.759" class="difflineplus">+  driverAlive = false;</span>
<a href="#l58.760"></a><span id="l58.760" class="difflineplus">+  if (!driverAlive &amp;&amp; !threadAlive) delete this;</span>
<a href="#l58.761"></a><span id="l58.761"> }</span>
<a href="#l58.762"></a><span id="l58.762"> </span>
<a href="#l58.763"></a><span id="l58.763" class="difflineminus">-void ImportThreadData::DriverDelete(void)</span>
<a href="#l58.764"></a><span id="l58.764" class="difflineminus">-{</span>
<a href="#l58.765"></a><span id="l58.765" class="difflineminus">-  driverAlive = false;</span>
<a href="#l58.766"></a><span id="l58.766" class="difflineminus">-  if (!driverAlive &amp;&amp; !threadAlive)</span>
<a href="#l58.767"></a><span id="l58.767" class="difflineminus">-    delete this;</span>
<a href="#l58.768"></a><span id="l58.768" class="difflineplus">+void ImportThreadData::ThreadDelete() {</span>
<a href="#l58.769"></a><span id="l58.769" class="difflineplus">+  threadAlive = false;</span>
<a href="#l58.770"></a><span id="l58.770" class="difflineplus">+  if (!driverAlive &amp;&amp; !threadAlive) delete this;</span>
<a href="#l58.771"></a><span id="l58.771"> }</span>
<a href="#l58.772"></a><span id="l58.772"> </span>
<a href="#l58.773"></a><span id="l58.773" class="difflineminus">-void ImportThreadData::ThreadDelete()</span>
<a href="#l58.774"></a><span id="l58.774" class="difflineminus">-{</span>
<a href="#l58.775"></a><span id="l58.775" class="difflineminus">-  threadAlive = false;</span>
<a href="#l58.776"></a><span id="l58.776" class="difflineminus">-  if (!driverAlive &amp;&amp; !threadAlive)</span>
<a href="#l58.777"></a><span id="l58.777" class="difflineminus">-    delete this;</span>
<a href="#l58.778"></a><span id="l58.778" class="difflineminus">-}</span>
<a href="#l58.779"></a><span id="l58.779" class="difflineminus">-</span>
<a href="#l58.780"></a><span id="l58.780" class="difflineminus">-void ImportThreadData::DriverAbort()</span>
<a href="#l58.781"></a><span id="l58.781" class="difflineminus">-{</span>
<a href="#l58.782"></a><span id="l58.782" class="difflineplus">+void ImportThreadData::DriverAbort() {</span>
<a href="#l58.783"></a><span id="l58.783">   if (abort &amp;&amp; !threadAlive &amp;&amp; destRoot) {</span>
<a href="#l58.784"></a><span id="l58.784">     if (ownsDestRoot) {</span>
<a href="#l58.785"></a><span id="l58.785">       destRoot-&gt;RecursiveDelete(true, nullptr);</span>
<a href="#l58.786"></a><span id="l58.786" class="difflineminus">-    }</span>
<a href="#l58.787"></a><span id="l58.787" class="difflineminus">-    else {</span>
<a href="#l58.788"></a><span id="l58.788" class="difflineplus">+    } else {</span>
<a href="#l58.789"></a><span id="l58.789">       // FIXME: just delete the stuff we created?</span>
<a href="#l58.790"></a><span id="l58.790">     }</span>
<a href="#l58.791"></a><span id="l58.791" class="difflineminus">-  }</span>
<a href="#l58.792"></a><span id="l58.792" class="difflineminus">-  else</span>
<a href="#l58.793"></a><span id="l58.793" class="difflineplus">+  } else</span>
<a href="#l58.794"></a><span id="l58.794">     abort = true;</span>
<a href="#l58.795"></a><span id="l58.795">   DriverDelete();</span>
<a href="#l58.796"></a><span id="l58.796"> }</span>
<a href="#l58.797"></a><span id="l58.797"> </span>
<a href="#l58.798"></a><span id="l58.798" class="difflineminus">-</span>
<a href="#l58.799"></a><span id="l58.799" class="difflineminus">-</span>
<a href="#l58.800"></a><span id="l58.800" class="difflineminus">-static void</span>
<a href="#l58.801"></a><span id="l58.801" class="difflineminus">-ImportMailThread(void *stuff)</span>
<a href="#l58.802"></a><span id="l58.802" class="difflineminus">-{</span>
<a href="#l58.803"></a><span id="l58.803" class="difflineplus">+static void ImportMailThread(void *stuff) {</span>
<a href="#l58.804"></a><span id="l58.804">   ImportThreadData *pData = (ImportThreadData *)stuff;</span>
<a href="#l58.805"></a><span id="l58.805"> </span>
<a href="#l58.806"></a><span id="l58.806">   IMPORT_LOG0(&quot;ImportMailThread: Starting...&quot;);</span>
<a href="#l58.807"></a><span id="l58.807"> </span>
<a href="#l58.808"></a><span id="l58.808">   nsresult rv = NS_OK;</span>
<a href="#l58.809"></a><span id="l58.809"> </span>
<a href="#l58.810"></a><span id="l58.810" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolder&gt;    destRoot(pData-&gt;destRoot);</span>
<a href="#l58.811"></a><span id="l58.811" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; destRoot(pData-&gt;destRoot);</span>
<a href="#l58.812"></a><span id="l58.812"> </span>
<a href="#l58.813"></a><span id="l58.813" class="difflineminus">-  uint32_t  count = 0;</span>
<a href="#l58.814"></a><span id="l58.814" class="difflineplus">+  uint32_t count = 0;</span>
<a href="#l58.815"></a><span id="l58.815">   rv = pData-&gt;boxes-&gt;GetLength(&amp;count);</span>
<a href="#l58.816"></a><span id="l58.816"> </span>
<a href="#l58.817"></a><span id="l58.817" class="difflineminus">-  uint32_t    i;</span>
<a href="#l58.818"></a><span id="l58.818" class="difflineminus">-  bool        import;</span>
<a href="#l58.819"></a><span id="l58.819" class="difflineminus">-  uint32_t    size;</span>
<a href="#l58.820"></a><span id="l58.820" class="difflineminus">-  uint32_t    depth = 1;</span>
<a href="#l58.821"></a><span id="l58.821" class="difflineminus">-  uint32_t    newDepth;</span>
<a href="#l58.822"></a><span id="l58.822" class="difflineminus">-  nsString    lastName;</span>
<a href="#l58.823"></a><span id="l58.823" class="difflineminus">-  char16_t *    pName;</span>
<a href="#l58.824"></a><span id="l58.824" class="difflineplus">+  uint32_t i;</span>
<a href="#l58.825"></a><span id="l58.825" class="difflineplus">+  bool import;</span>
<a href="#l58.826"></a><span id="l58.826" class="difflineplus">+  uint32_t size;</span>
<a href="#l58.827"></a><span id="l58.827" class="difflineplus">+  uint32_t depth = 1;</span>
<a href="#l58.828"></a><span id="l58.828" class="difflineplus">+  uint32_t newDepth;</span>
<a href="#l58.829"></a><span id="l58.829" class="difflineplus">+  nsString lastName;</span>
<a href="#l58.830"></a><span id="l58.830" class="difflineplus">+  char16_t *pName;</span>
<a href="#l58.831"></a><span id="l58.831"> </span>
<a href="#l58.832"></a><span id="l58.832" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolder&gt;    curFolder(destRoot);</span>
<a href="#l58.833"></a><span id="l58.833" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; curFolder(destRoot);</span>
<a href="#l58.834"></a><span id="l58.834"> </span>
<a href="#l58.835"></a><span id="l58.835" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolder&gt;          newFolder;</span>
<a href="#l58.836"></a><span id="l58.836" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolder&gt;          subFolder;</span>
<a href="#l58.837"></a><span id="l58.837" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; newFolder;</span>
<a href="#l58.838"></a><span id="l58.838" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; subFolder;</span>
<a href="#l58.839"></a><span id="l58.839"> </span>
<a href="#l58.840"></a><span id="l58.840" class="difflineminus">-  bool              exists;</span>
<a href="#l58.841"></a><span id="l58.841" class="difflineplus">+  bool exists;</span>
<a href="#l58.842"></a><span id="l58.842"> </span>
<a href="#l58.843"></a><span id="l58.843" class="difflineminus">-  nsString  success;</span>
<a href="#l58.844"></a><span id="l58.844" class="difflineminus">-  nsString  error;</span>
<a href="#l58.845"></a><span id="l58.845" class="difflineplus">+  nsString success;</span>
<a href="#l58.846"></a><span id="l58.846" class="difflineplus">+  nsString error;</span>
<a href="#l58.847"></a><span id="l58.847"> </span>
<a href="#l58.848"></a><span id="l58.848" class="difflineminus">-  // GetSubFolders() will initialize folders if they are not already initialized.</span>
<a href="#l58.849"></a><span id="l58.849" class="difflineplus">+  // GetSubFolders() will initialize folders if they are not already</span>
<a href="#l58.850"></a><span id="l58.850" class="difflineplus">+  // initialized.</span>
<a href="#l58.851"></a><span id="l58.851">   ProxyGetSubFolders(curFolder);</span>
<a href="#l58.852"></a><span id="l58.852"> </span>
<a href="#l58.853"></a><span id="l58.853" class="difflineminus">-  IMPORT_LOG1(&quot;ImportMailThread: Total number of folders to import = %d.&quot;, count);</span>
<a href="#l58.854"></a><span id="l58.854" class="difflineplus">+  IMPORT_LOG1(&quot;ImportMailThread: Total number of folders to import = %d.&quot;,</span>
<a href="#l58.855"></a><span id="l58.855" class="difflineplus">+              count);</span>
<a href="#l58.856"></a><span id="l58.856"> </span>
<a href="#l58.857"></a><span id="l58.857">   // Note that the front-end js script only displays one import result string so</span>
<a href="#l58.858"></a><span id="l58.858" class="difflineminus">-  // we combine both good and bad import status into one string (in var 'success').</span>
<a href="#l58.859"></a><span id="l58.859" class="difflineplus">+  // we combine both good and bad import status into one string (in var</span>
<a href="#l58.860"></a><span id="l58.860" class="difflineplus">+  // 'success').</span>
<a href="#l58.861"></a><span id="l58.861"> </span>
<a href="#l58.862"></a><span id="l58.862">   for (i = 0; (i &lt; count) &amp;&amp; !(pData-&gt;abort); i++) {</span>
<a href="#l58.863"></a><span id="l58.863">     nsCOMPtr&lt;nsIImportMailboxDescriptor&gt; box =</span>
<a href="#l58.864"></a><span id="l58.864" class="difflineminus">-      do_QueryElementAt(pData-&gt;boxes, i);</span>
<a href="#l58.865"></a><span id="l58.865" class="difflineplus">+        do_QueryElementAt(pData-&gt;boxes, i);</span>
<a href="#l58.866"></a><span id="l58.866">     if (box) {</span>
<a href="#l58.867"></a><span id="l58.867">       pData-&gt;currentMailbox = i;</span>
<a href="#l58.868"></a><span id="l58.868"> </span>
<a href="#l58.869"></a><span id="l58.869">       import = false;</span>
<a href="#l58.870"></a><span id="l58.870">       size = 0;</span>
<a href="#l58.871"></a><span id="l58.871">       rv = box-&gt;GetImport(&amp;import);</span>
<a href="#l58.872"></a><span id="l58.872" class="difflineminus">-      if (import)</span>
<a href="#l58.873"></a><span id="l58.873" class="difflineminus">-        rv = box-&gt;GetSize(&amp;size);</span>
<a href="#l58.874"></a><span id="l58.874" class="difflineplus">+      if (import) rv = box-&gt;GetSize(&amp;size);</span>
<a href="#l58.875"></a><span id="l58.875">       rv = box-&gt;GetDepth(&amp;newDepth);</span>
<a href="#l58.876"></a><span id="l58.876">       if (newDepth &gt; depth) {</span>
<a href="#l58.877"></a><span id="l58.877" class="difflineminus">-          // OK, we are going to add a subfolder under the last/previous folder we processed, so</span>
<a href="#l58.878"></a><span id="l58.878" class="difflineminus">-          // find this folder (stored in 'lastName') who is going to be the new parent folder.</span>
<a href="#l58.879"></a><span id="l58.879" class="difflineminus">-        IMPORT_LOG1(&quot;ImportMailThread: Processing child folder '%s'.&quot;, NS_ConvertUTF16toUTF8(lastName).get());</span>
<a href="#l58.880"></a><span id="l58.880" class="difflineplus">+        // OK, we are going to add a subfolder under the last/previous folder we</span>
<a href="#l58.881"></a><span id="l58.881" class="difflineplus">+        // processed, so find this folder (stored in 'lastName') who is going to</span>
<a href="#l58.882"></a><span id="l58.882" class="difflineplus">+        // be the new parent folder.</span>
<a href="#l58.883"></a><span id="l58.883" class="difflineplus">+        IMPORT_LOG1(&quot;ImportMailThread: Processing child folder '%s'.&quot;,</span>
<a href="#l58.884"></a><span id="l58.884" class="difflineplus">+                    NS_ConvertUTF16toUTF8(lastName).get());</span>
<a href="#l58.885"></a><span id="l58.885">         rv = ProxyGetChildNamed(curFolder, lastName, getter_AddRefs(subFolder));</span>
<a href="#l58.886"></a><span id="l58.886">         if (NS_FAILED(rv)) {</span>
<a href="#l58.887"></a><span id="l58.887" class="difflineminus">-          IMPORT_LOG1(&quot;*** ImportMailThread: Failed to get the interface for child folder '%s'.&quot;, NS_ConvertUTF16toUTF8(lastName).get());</span>
<a href="#l58.888"></a><span id="l58.888" class="difflineplus">+          IMPORT_LOG1(</span>
<a href="#l58.889"></a><span id="l58.889" class="difflineplus">+              &quot;*** ImportMailThread: Failed to get the interface for child &quot;</span>
<a href="#l58.890"></a><span id="l58.890" class="difflineplus">+              &quot;folder '%s'.&quot;,</span>
<a href="#l58.891"></a><span id="l58.891" class="difflineplus">+              NS_ConvertUTF16toUTF8(lastName).get());</span>
<a href="#l58.892"></a><span id="l58.892">           nsImportGenericMail::ReportError(IMPORT_ERROR_MB_FINDCHILD,</span>
<a href="#l58.893"></a><span id="l58.893" class="difflineminus">-                                           lastName.get(),</span>
<a href="#l58.894"></a><span id="l58.894" class="difflineminus">-                                           &amp;error, pData-&gt;stringBundle);</span>
<a href="#l58.895"></a><span id="l58.895" class="difflineplus">+                                           lastName.get(), &amp;error,</span>
<a href="#l58.896"></a><span id="l58.896" class="difflineplus">+                                           pData-&gt;stringBundle);</span>
<a href="#l58.897"></a><span id="l58.897">           pData-&gt;fatalError = true;</span>
<a href="#l58.898"></a><span id="l58.898">           break;</span>
<a href="#l58.899"></a><span id="l58.899">         }</span>
<a href="#l58.900"></a><span id="l58.900">         curFolder = subFolder;</span>
<a href="#l58.901"></a><span id="l58.901" class="difflineminus">-        // Make sure this new parent folder obj has the correct subfolder list so far.</span>
<a href="#l58.902"></a><span id="l58.902" class="difflineplus">+        // Make sure this new parent folder obj has the correct subfolder list</span>
<a href="#l58.903"></a><span id="l58.903" class="difflineplus">+        // so far.</span>
<a href="#l58.904"></a><span id="l58.904">         rv = ProxyGetSubFolders(curFolder);</span>
<a href="#l58.905"></a><span id="l58.905" class="difflineminus">-      }</span>
<a href="#l58.906"></a><span id="l58.906" class="difflineminus">-      else if (newDepth &lt; depth) {</span>
<a href="#l58.907"></a><span id="l58.907" class="difflineplus">+      } else if (newDepth &lt; depth) {</span>
<a href="#l58.908"></a><span id="l58.908">         rv = NS_OK;</span>
<a href="#l58.909"></a><span id="l58.909">         while ((newDepth &lt; depth) &amp;&amp; NS_SUCCEEDED(rv)) {</span>
<a href="#l58.910"></a><span id="l58.910">           rv = curFolder-&gt;GetParent(getter_AddRefs(curFolder));</span>
<a href="#l58.911"></a><span id="l58.911">           if (NS_FAILED(rv)) {</span>
<a href="#l58.912"></a><span id="l58.912" class="difflineminus">-            IMPORT_LOG1(&quot;*** ImportMailThread: Failed to get the interface for parent folder '%s'.&quot;, NS_ConvertUTF16toUTF8(lastName).get());</span>
<a href="#l58.913"></a><span id="l58.913" class="difflineplus">+            IMPORT_LOG1(</span>
<a href="#l58.914"></a><span id="l58.914" class="difflineplus">+                &quot;*** ImportMailThread: Failed to get the interface for parent &quot;</span>
<a href="#l58.915"></a><span id="l58.915" class="difflineplus">+                &quot;folder '%s'.&quot;,</span>
<a href="#l58.916"></a><span id="l58.916" class="difflineplus">+                NS_ConvertUTF16toUTF8(lastName).get());</span>
<a href="#l58.917"></a><span id="l58.917">             nsImportGenericMail::ReportError(IMPORT_ERROR_MB_FINDCHILD,</span>
<a href="#l58.918"></a><span id="l58.918">                                              lastName.get(), &amp;error,</span>
<a href="#l58.919"></a><span id="l58.919">                                              pData-&gt;stringBundle);</span>
<a href="#l58.920"></a><span id="l58.920">             pData-&gt;fatalError = true;</span>
<a href="#l58.921"></a><span id="l58.921">             break;</span>
<a href="#l58.922"></a><span id="l58.922">           }</span>
<a href="#l58.923"></a><span id="l58.923">           depth--;</span>
<a href="#l58.924"></a><span id="l58.924">         }</span>
<a href="#l58.925"></a><span id="l58.925">         if (NS_FAILED(rv)) {</span>
<a href="#l58.926"></a><span id="l58.926" class="difflineminus">-          IMPORT_LOG1(&quot;*** ImportMailThread: Failed to get the proxy interface for parent folder '%s'.&quot;, NS_ConvertUTF16toUTF8(lastName).get());</span>
<a href="#l58.927"></a><span id="l58.927" class="difflineplus">+          IMPORT_LOG1(</span>
<a href="#l58.928"></a><span id="l58.928" class="difflineplus">+              &quot;*** ImportMailThread: Failed to get the proxy interface for &quot;</span>
<a href="#l58.929"></a><span id="l58.929" class="difflineplus">+              &quot;parent folder '%s'.&quot;,</span>
<a href="#l58.930"></a><span id="l58.930" class="difflineplus">+              NS_ConvertUTF16toUTF8(lastName).get());</span>
<a href="#l58.931"></a><span id="l58.931">           nsImportStringBundle::GetStringByID(IMPORT_ERROR_MB_NOPROXY,</span>
<a href="#l58.932"></a><span id="l58.932">                                               pData-&gt;stringBundle, error);</span>
<a href="#l58.933"></a><span id="l58.933">           pData-&gt;fatalError = true;</span>
<a href="#l58.934"></a><span id="l58.934">           break;</span>
<a href="#l58.935"></a><span id="l58.935">         }</span>
<a href="#l58.936"></a><span id="l58.936">       }</span>
<a href="#l58.937"></a><span id="l58.937">       depth = newDepth;</span>
<a href="#l58.938"></a><span id="l58.938">       pName = nullptr;</span>
<a href="#l58.939"></a><span id="l58.939">       box-&gt;GetDisplayName(&amp;pName);</span>
<a href="#l58.940"></a><span id="l58.940">       if (pName) {</span>
<a href="#l58.941"></a><span id="l58.941">         lastName = pName;</span>
<a href="#l58.942"></a><span id="l58.942">         free(pName);</span>
<a href="#l58.943"></a><span id="l58.943" class="difflineminus">-      }</span>
<a href="#l58.944"></a><span id="l58.944" class="difflineminus">-      else</span>
<a href="#l58.945"></a><span id="l58.945" class="difflineplus">+      } else</span>
<a href="#l58.946"></a><span id="l58.946">         lastName.AssignLiteral(&quot;Unknown!&quot;);</span>
<a href="#l58.947"></a><span id="l58.947"> </span>
<a href="#l58.948"></a><span id="l58.948">       // translate the folder name if we are doing migration, but</span>
<a href="#l58.949"></a><span id="l58.949">       // only for special folders which are at the root level</span>
<a href="#l58.950"></a><span id="l58.950">       if (pData-&gt;performingMigration &amp;&amp; depth == 1)</span>
<a href="#l58.951"></a><span id="l58.951">         pData-&gt;mailImport-&gt;TranslateFolderName(lastName, lastName);</span>
<a href="#l58.952"></a><span id="l58.952"> </span>
<a href="#l58.953"></a><span id="l58.953">       exists = false;</span>
<a href="#l58.954"></a><span id="l58.954">       rv = ProxyContainsChildNamed(curFolder, lastName, &amp;exists);</span>
<a href="#l58.955"></a><span id="l58.955"> </span>
<a href="#l58.956"></a><span id="l58.956" class="difflineminus">-      // If we are performing profile migration (as opposed to importing) then we are starting</span>
<a href="#l58.957"></a><span id="l58.957" class="difflineminus">-      // with empty local folders. In that case, always choose to over-write the existing local folder</span>
<a href="#l58.958"></a><span id="l58.958" class="difflineminus">-      // with this name. Don't create a unique subfolder name. Otherwise you end up with &quot;Inbox, Inbox0&quot;</span>
<a href="#l58.959"></a><span id="l58.959" class="difflineminus">-      // or &quot;Unsent Folders, UnsentFolders0&quot;</span>
<a href="#l58.960"></a><span id="l58.960" class="difflineplus">+      // If we are performing profile migration (as opposed to importing) then</span>
<a href="#l58.961"></a><span id="l58.961" class="difflineplus">+      // we are starting with empty local folders. In that case, always choose</span>
<a href="#l58.962"></a><span id="l58.962" class="difflineplus">+      // to over-write the existing local folder with this name. Don't create a</span>
<a href="#l58.963"></a><span id="l58.963" class="difflineplus">+      // unique subfolder name. Otherwise you end up with &quot;Inbox, Inbox0&quot; or</span>
<a href="#l58.964"></a><span id="l58.964" class="difflineplus">+      // &quot;Unsent Folders, UnsentFolders0&quot;</span>
<a href="#l58.965"></a><span id="l58.965">       if (exists &amp;&amp; !pData-&gt;performingMigration) {</span>
<a href="#l58.966"></a><span id="l58.966">         nsString subName;</span>
<a href="#l58.967"></a><span id="l58.967">         ProxyGenerateUniqueSubfolderName(curFolder, lastName, nullptr, subName);</span>
<a href="#l58.968"></a><span id="l58.968" class="difflineminus">-        if (!subName.IsEmpty())</span>
<a href="#l58.969"></a><span id="l58.969" class="difflineminus">-          lastName.Assign(subName);</span>
<a href="#l58.970"></a><span id="l58.970" class="difflineplus">+        if (!subName.IsEmpty()) lastName.Assign(subName);</span>
<a href="#l58.971"></a><span id="l58.971">       }</span>
<a href="#l58.972"></a><span id="l58.972"> </span>
<a href="#l58.973"></a><span id="l58.973" class="difflineminus">-      IMPORT_LOG1(&quot;ImportMailThread: Creating new import folder '%s'.&quot;, NS_ConvertUTF16toUTF8(lastName).get());</span>
<a href="#l58.974"></a><span id="l58.974" class="difflineminus">-      ProxyCreateSubfolder(curFolder, lastName); // this may fail if the folder already exists..that's ok</span>
<a href="#l58.975"></a><span id="l58.975" class="difflineplus">+      IMPORT_LOG1(&quot;ImportMailThread: Creating new import folder '%s'.&quot;,</span>
<a href="#l58.976"></a><span id="l58.976" class="difflineplus">+                  NS_ConvertUTF16toUTF8(lastName).get());</span>
<a href="#l58.977"></a><span id="l58.977" class="difflineplus">+      ProxyCreateSubfolder(</span>
<a href="#l58.978"></a><span id="l58.978" class="difflineplus">+          curFolder,</span>
<a href="#l58.979"></a><span id="l58.979" class="difflineplus">+          lastName);  // this may fail if the folder already exists..that's ok</span>
<a href="#l58.980"></a><span id="l58.980"> </span>
<a href="#l58.981"></a><span id="l58.981">       rv = ProxyGetChildNamed(curFolder, lastName, getter_AddRefs(newFolder));</span>
<a href="#l58.982"></a><span id="l58.982">       if (NS_FAILED(rv)) {</span>
<a href="#l58.983"></a><span id="l58.983" class="difflineminus">-        IMPORT_LOG1(&quot;*** ImportMailThread: Failed to locate subfolder '%s' after it's been created.&quot;, NS_ConvertUTF16toUTF8(lastName).get());</span>
<a href="#l58.984"></a><span id="l58.984" class="difflineplus">+        IMPORT_LOG1(</span>
<a href="#l58.985"></a><span id="l58.985" class="difflineplus">+            &quot;*** ImportMailThread: Failed to locate subfolder '%s' after it's &quot;</span>
<a href="#l58.986"></a><span id="l58.986" class="difflineplus">+            &quot;been created.&quot;,</span>
<a href="#l58.987"></a><span id="l58.987" class="difflineplus">+            NS_ConvertUTF16toUTF8(lastName).get());</span>
<a href="#l58.988"></a><span id="l58.988">         nsImportGenericMail::ReportError(IMPORT_ERROR_MB_CREATE, lastName.get(),</span>
<a href="#l58.989"></a><span id="l58.989">                                          &amp;error, pData-&gt;stringBundle);</span>
<a href="#l58.990"></a><span id="l58.990">       }</span>
<a href="#l58.991"></a><span id="l58.991"> </span>
<a href="#l58.992"></a><span id="l58.992">       if (size &amp;&amp; import &amp;&amp; newFolder &amp;&amp; NS_SUCCEEDED(rv)) {</span>
<a href="#l58.993"></a><span id="l58.993">         bool fatalError = false;</span>
<a href="#l58.994"></a><span id="l58.994">         pData-&gt;currentSize = size;</span>
<a href="#l58.995"></a><span id="l58.995">         char16_t *pSuccess = nullptr;</span>
<a href="#l58.996"></a><span id="l58.996">         char16_t *pError = nullptr;</span>
<a href="#l58.997"></a><span id="l58.997" class="difflineminus">-        rv = pData-&gt;mailImport-&gt;ImportMailbox(box, newFolder, &amp;pError, &amp;pSuccess, &amp;fatalError);</span>
<a href="#l58.998"></a><span id="l58.998" class="difflineplus">+        rv = pData-&gt;mailImport-&gt;ImportMailbox(box, newFolder, &amp;pError,</span>
<a href="#l58.999"></a><span id="l58.999" class="difflineplus">+                                              &amp;pSuccess, &amp;fatalError);</span>
<a href="#l58.1000"></a><span id="l58.1000">         if (pError) {</span>
<a href="#l58.1001"></a><span id="l58.1001">           error.Append(pError);</span>
<a href="#l58.1002"></a><span id="l58.1002">           free(pError);</span>
<a href="#l58.1003"></a><span id="l58.1003">         }</span>
<a href="#l58.1004"></a><span id="l58.1004">         if (pSuccess) {</span>
<a href="#l58.1005"></a><span id="l58.1005">           success.Append(pSuccess);</span>
<a href="#l58.1006"></a><span id="l58.1006">           free(pSuccess);</span>
<a href="#l58.1007"></a><span id="l58.1007">         }</span>
<a href="#l58.1008"></a><span id="l58.1008"> </span>
<a href="#l58.1009"></a><span id="l58.1009">         pData-&gt;currentSize = 0;</span>
<a href="#l58.1010"></a><span id="l58.1010">         pData-&gt;currentTotal += size;</span>
<a href="#l58.1011"></a><span id="l58.1011"> </span>
<a href="#l58.1012"></a><span id="l58.1012" class="difflineminus">-        // commit to the db synchronously, but using a proxy since it doesn't like being used</span>
<a href="#l58.1013"></a><span id="l58.1013" class="difflineminus">-        // elsewhere than from the main thread.</span>
<a href="#l58.1014"></a><span id="l58.1014" class="difflineminus">-        // OK, we've copied the actual folder/file over if the folder size is not 0</span>
<a href="#l58.1015"></a><span id="l58.1015" class="difflineminus">-        // (ie, the msg summary is no longer valid) so close the msg database so that</span>
<a href="#l58.1016"></a><span id="l58.1016" class="difflineminus">-        // when the folder is reopened the folder db can be reconstructed (which</span>
<a href="#l58.1017"></a><span id="l58.1017" class="difflineplus">+        // commit to the db synchronously, but using a proxy since it doesn't</span>
<a href="#l58.1018"></a><span id="l58.1018" class="difflineplus">+        // like being used elsewhere than from the main thread. OK, we've copied</span>
<a href="#l58.1019"></a><span id="l58.1019" class="difflineplus">+        // the actual folder/file over if the folder size is not 0 (ie, the msg</span>
<a href="#l58.1020"></a><span id="l58.1020" class="difflineplus">+        // summary is no longer valid) so close the msg database so that when</span>
<a href="#l58.1021"></a><span id="l58.1021" class="difflineplus">+        // the folder is reopened the folder db can be reconstructed (which</span>
<a href="#l58.1022"></a><span id="l58.1022">         // validates msg summary and forces folder to be reparsed).</span>
<a href="#l58.1023"></a><span id="l58.1023">         rv = ProxyForceDBClosed(newFolder);</span>
<a href="#l58.1024"></a><span id="l58.1024">         fatalError = NS_FAILED(rv);</span>
<a href="#l58.1025"></a><span id="l58.1025"> </span>
<a href="#l58.1026"></a><span id="l58.1026">         if (fatalError) {</span>
<a href="#l58.1027"></a><span id="l58.1027" class="difflineminus">-          IMPORT_LOG1(&quot;*** ImportMailThread: ImportMailbox returned fatalError, mailbox #%d\n&quot;, (int) i);</span>
<a href="#l58.1028"></a><span id="l58.1028" class="difflineplus">+          IMPORT_LOG1(</span>
<a href="#l58.1029"></a><span id="l58.1029" class="difflineplus">+              &quot;*** ImportMailThread: ImportMailbox returned fatalError, &quot;</span>
<a href="#l58.1030"></a><span id="l58.1030" class="difflineplus">+              &quot;mailbox #%d\n&quot;,</span>
<a href="#l58.1031"></a><span id="l58.1031" class="difflineplus">+              (int)i);</span>
<a href="#l58.1032"></a><span id="l58.1032">           pData-&gt;fatalError = true;</span>
<a href="#l58.1033"></a><span id="l58.1033">           break;</span>
<a href="#l58.1034"></a><span id="l58.1034">         }</span>
<a href="#l58.1035"></a><span id="l58.1035">       }</span>
<a href="#l58.1036"></a><span id="l58.1036">     }</span>
<a href="#l58.1037"></a><span id="l58.1037">   }</span>
<a href="#l58.1038"></a><span id="l58.1038"> </span>
<a href="#l58.1039"></a><span id="l58.1039">   // Now save the new acct info to pref file.</span>
<a href="#l58.1040"></a><span id="l58.1040" class="difflineminus">-  nsCOMPtr &lt;nsIMsgAccountManager&gt; accMgr = do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l58.1041"></a><span id="l58.1041" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccountManager&gt; accMgr =</span>
<a href="#l58.1042"></a><span id="l58.1042" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l58.1043"></a><span id="l58.1043">   if (NS_SUCCEEDED(rv) &amp;&amp; accMgr) {</span>
<a href="#l58.1044"></a><span id="l58.1044">     rv = accMgr-&gt;SaveAccountInfo();</span>
<a href="#l58.1045"></a><span id="l58.1045">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Can't save account info to pref file&quot;);</span>
<a href="#l58.1046"></a><span id="l58.1046">   }</span>
<a href="#l58.1047"></a><span id="l58.1047"> </span>
<a href="#l58.1048"></a><span id="l58.1048" class="difflineminus">-  nsImportGenericMail::SetLogs(success, error, pData-&gt;successLog, pData-&gt;errorLog);</span>
<a href="#l58.1049"></a><span id="l58.1049" class="difflineplus">+  nsImportGenericMail::SetLogs(success, error, pData-&gt;successLog,</span>
<a href="#l58.1050"></a><span id="l58.1050" class="difflineplus">+                               pData-&gt;errorLog);</span>
<a href="#l58.1051"></a><span id="l58.1051"> </span>
<a href="#l58.1052"></a><span id="l58.1052">   if (pData-&gt;abort || pData-&gt;fatalError) {</span>
<a href="#l58.1053"></a><span id="l58.1053">     IMPORT_LOG0(&quot;*** ImportMailThread: Abort or fatalError flag was set\n&quot;);</span>
<a href="#l58.1054"></a><span id="l58.1054">     if (pData-&gt;ownsDestRoot) {</span>
<a href="#l58.1055"></a><span id="l58.1055">       IMPORT_LOG0(&quot;Calling destRoot-&gt;RecursiveDelete\n&quot;);</span>
<a href="#l58.1056"></a><span id="l58.1056">       destRoot-&gt;RecursiveDelete(true, nullptr);</span>
<a href="#l58.1057"></a><span id="l58.1057" class="difflineminus">-    }</span>
<a href="#l58.1058"></a><span id="l58.1058" class="difflineminus">-    else {</span>
<a href="#l58.1059"></a><span id="l58.1059" class="difflineplus">+    } else {</span>
<a href="#l58.1060"></a><span id="l58.1060">       // FIXME: just delete the stuff we created?</span>
<a href="#l58.1061"></a><span id="l58.1061">     }</span>
<a href="#l58.1062"></a><span id="l58.1062">   }</span>
<a href="#l58.1063"></a><span id="l58.1063"> </span>
<a href="#l58.1064"></a><span id="l58.1064" class="difflineminus">-  IMPORT_LOG1(&quot;Import mailbox thread done: %d\n&quot;, (int) pData-&gt;currentTotal);</span>
<a href="#l58.1065"></a><span id="l58.1065" class="difflineplus">+  IMPORT_LOG1(&quot;Import mailbox thread done: %d\n&quot;, (int)pData-&gt;currentTotal);</span>
<a href="#l58.1066"></a><span id="l58.1066"> </span>
<a href="#l58.1067"></a><span id="l58.1067">   pData-&gt;ThreadDelete();</span>
<a href="#l58.1068"></a><span id="l58.1068"> }</span>
<a href="#l58.1069"></a><span id="l58.1069"> </span>
<a href="#l58.1070"></a><span id="l58.1070"> // Creates a folder in Local Folders with the module name + mail</span>
<a href="#l58.1071"></a><span id="l58.1071"> // for e.g: Outlook Mail</span>
<a href="#l58.1072"></a><span id="l58.1072" class="difflineminus">-bool nsImportGenericMail::CreateFolder(nsIMsgFolder **ppFolder)</span>
<a href="#l58.1073"></a><span id="l58.1073" class="difflineminus">-{</span>
<a href="#l58.1074"></a><span id="l58.1074" class="difflineplus">+bool nsImportGenericMail::CreateFolder(nsIMsgFolder **ppFolder) {</span>
<a href="#l58.1075"></a><span id="l58.1075">   nsresult rv;</span>
<a href="#l58.1076"></a><span id="l58.1076">   *ppFolder = nullptr;</span>
<a href="#l58.1077"></a><span id="l58.1077"> </span>
<a href="#l58.1078"></a><span id="l58.1078">   nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l58.1079"></a><span id="l58.1079">   nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l58.1080"></a><span id="l58.1080" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l58.1081"></a><span id="l58.1081" class="difflineminus">-  if (!bundleService)</span>
<a href="#l58.1082"></a><span id="l58.1082" class="difflineminus">-      return false;</span>
<a href="#l58.1083"></a><span id="l58.1083" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l58.1084"></a><span id="l58.1084" class="difflineplus">+  if (!bundleService) return false;</span>
<a href="#l58.1085"></a><span id="l58.1085">   rv = bundleService-&gt;CreateBundle(IMPORT_MSGS_URL, getter_AddRefs(bundle));</span>
<a href="#l58.1086"></a><span id="l58.1086" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l58.1087"></a><span id="l58.1087" class="difflineminus">-      return false;</span>
<a href="#l58.1088"></a><span id="l58.1088" class="difflineplus">+  if (NS_FAILED(rv)) return false;</span>
<a href="#l58.1089"></a><span id="l58.1089">   nsString folderName;</span>
<a href="#l58.1090"></a><span id="l58.1090">   if (!m_pName.IsEmpty()) {</span>
<a href="#l58.1091"></a><span id="l58.1091" class="difflineminus">-    const char16_t *moduleName[] = { m_pName.get() };</span>
<a href="#l58.1092"></a><span id="l58.1092" class="difflineminus">-    rv = bundle-&gt;FormatStringFromName(&quot;ImportModuleFolderName&quot;,</span>
<a href="#l58.1093"></a><span id="l58.1093" class="difflineminus">-                                      moduleName, 1,</span>
<a href="#l58.1094"></a><span id="l58.1094" class="difflineplus">+    const char16_t *moduleName[] = {m_pName.get()};</span>
<a href="#l58.1095"></a><span id="l58.1095" class="difflineplus">+    rv = bundle-&gt;FormatStringFromName(&quot;ImportModuleFolderName&quot;, moduleName, 1,</span>
<a href="#l58.1096"></a><span id="l58.1096">                                       folderName);</span>
<a href="#l58.1097"></a><span id="l58.1097" class="difflineminus">-  }</span>
<a href="#l58.1098"></a><span id="l58.1098" class="difflineminus">-  else {</span>
<a href="#l58.1099"></a><span id="l58.1099" class="difflineplus">+  } else {</span>
<a href="#l58.1100"></a><span id="l58.1100">     rv = bundle-&gt;GetStringFromName(&quot;DefaultFolderName&quot;, folderName);</span>
<a href="#l58.1101"></a><span id="l58.1101">   }</span>
<a href="#l58.1102"></a><span id="l58.1102">   if (NS_FAILED(rv)) {</span>
<a href="#l58.1103"></a><span id="l58.1103" class="difflineminus">-      IMPORT_LOG0(&quot;*** Failed to get Folder Name!\n&quot;);</span>
<a href="#l58.1104"></a><span id="l58.1104" class="difflineminus">-      return false;</span>
<a href="#l58.1105"></a><span id="l58.1105" class="difflineplus">+    IMPORT_LOG0(&quot;*** Failed to get Folder Name!\n&quot;);</span>
<a href="#l58.1106"></a><span id="l58.1106" class="difflineplus">+    return false;</span>
<a href="#l58.1107"></a><span id="l58.1107">   }</span>
<a href="#l58.1108"></a><span id="l58.1108" class="difflineminus">-  nsCOMPtr &lt;nsIMsgAccountManager&gt; accMgr = do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l58.1109"></a><span id="l58.1109" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccountManager&gt; accMgr =</span>
<a href="#l58.1110"></a><span id="l58.1110" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l58.1111"></a><span id="l58.1111">   if (NS_FAILED(rv)) {</span>
<a href="#l58.1112"></a><span id="l58.1112">     IMPORT_LOG0(&quot;*** Failed to create account manager!\n&quot;);</span>
<a href="#l58.1113"></a><span id="l58.1113">     return false;</span>
<a href="#l58.1114"></a><span id="l58.1114">   }</span>
<a href="#l58.1115"></a><span id="l58.1115"> </span>
<a href="#l58.1116"></a><span id="l58.1116" class="difflineminus">-  nsCOMPtr &lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l58.1117"></a><span id="l58.1117" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l58.1118"></a><span id="l58.1118">   rv = accMgr-&gt;GetLocalFoldersServer(getter_AddRefs(server));</span>
<a href="#l58.1119"></a><span id="l58.1119">   // if Local Folders does not exist already, create it</span>
<a href="#l58.1120"></a><span id="l58.1120" class="difflineminus">-  if (NS_FAILED(rv) || !server)</span>
<a href="#l58.1121"></a><span id="l58.1121" class="difflineminus">-  {</span>
<a href="#l58.1122"></a><span id="l58.1122" class="difflineplus">+  if (NS_FAILED(rv) || !server) {</span>
<a href="#l58.1123"></a><span id="l58.1123">     rv = accMgr-&gt;CreateLocalMailAccount();</span>
<a href="#l58.1124"></a><span id="l58.1124">     if (NS_FAILED(rv)) {</span>
<a href="#l58.1125"></a><span id="l58.1125">       IMPORT_LOG0(&quot;*** Failed to create Local Folders!\n&quot;);</span>
<a href="#l58.1126"></a><span id="l58.1126">       return false;</span>
<a href="#l58.1127"></a><span id="l58.1127">     }</span>
<a href="#l58.1128"></a><span id="l58.1128"> </span>
<a href="#l58.1129"></a><span id="l58.1129">     rv = accMgr-&gt;GetLocalFoldersServer(getter_AddRefs(server));</span>
<a href="#l58.1130"></a><span id="l58.1130">   }</span>
<a href="#l58.1131"></a><span id="l58.1131"> </span>
<a href="#l58.1132"></a><span id="l58.1132">   if (NS_SUCCEEDED(rv) &amp;&amp; server) {</span>
<a href="#l58.1133"></a><span id="l58.1133" class="difflineminus">-    nsCOMPtr &lt;nsIMsgFolder&gt; localRootFolder;</span>
<a href="#l58.1134"></a><span id="l58.1134" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; localRootFolder;</span>
<a href="#l58.1135"></a><span id="l58.1135">     rv = server-&gt;GetRootMsgFolder(getter_AddRefs(localRootFolder));</span>
<a href="#l58.1136"></a><span id="l58.1136">     if (localRootFolder) {</span>
<a href="#l58.1137"></a><span id="l58.1137">       // we need to call GetSubFolders() so that the folders get initialized</span>
<a href="#l58.1138"></a><span id="l58.1138">       // if they are not initialized yet.</span>
<a href="#l58.1139"></a><span id="l58.1139">       nsCOMPtr&lt;nsISimpleEnumerator&gt; aEnumerator;</span>
<a href="#l58.1140"></a><span id="l58.1140">       rv = localRootFolder-&gt;GetSubFolders(getter_AddRefs(aEnumerator));</span>
<a href="#l58.1141"></a><span id="l58.1141">       if (NS_SUCCEEDED(rv)) {</span>
<a href="#l58.1142"></a><span id="l58.1142">         // check if the folder name we picked already exists.</span>
<a href="#l58.1143"></a><span id="l58.1143">         bool exists = false;</span>
<a href="#l58.1144"></a><span id="l58.1144">         rv = localRootFolder-&gt;ContainsChildNamed(folderName, &amp;exists);</span>
<a href="#l58.1145"></a><span id="l58.1145">         if (exists) {</span>
<a href="#l58.1146"></a><span id="l58.1146">           nsString name;</span>
<a href="#l58.1147"></a><span id="l58.1147" class="difflineminus">-          localRootFolder-&gt;GenerateUniqueSubfolderName(folderName, nullptr, name);</span>
<a href="#l58.1148"></a><span id="l58.1148" class="difflineplus">+          localRootFolder-&gt;GenerateUniqueSubfolderName(folderName, nullptr,</span>
<a href="#l58.1149"></a><span id="l58.1149" class="difflineplus">+                                                       name);</span>
<a href="#l58.1150"></a><span id="l58.1150">           if (!name.IsEmpty())</span>
<a href="#l58.1151"></a><span id="l58.1151">             folderName.Assign(name);</span>
<a href="#l58.1152"></a><span id="l58.1152">           else {</span>
<a href="#l58.1153"></a><span id="l58.1153">             IMPORT_LOG0(&quot;*** Failed to find a unique folder name!\n&quot;);</span>
<a href="#l58.1154"></a><span id="l58.1154">             return false;</span>
<a href="#l58.1155"></a><span id="l58.1155">           }</span>
<a href="#l58.1156"></a><span id="l58.1156">         }</span>
<a href="#l58.1157"></a><span id="l58.1157" class="difflineminus">-        IMPORT_LOG1(&quot;Creating folder for importing mail: '%s'\n&quot;, NS_ConvertUTF16toUTF8(folderName).get());</span>
<a href="#l58.1158"></a><span id="l58.1158" class="difflineplus">+        IMPORT_LOG1(&quot;Creating folder for importing mail: '%s'\n&quot;,</span>
<a href="#l58.1159"></a><span id="l58.1159" class="difflineplus">+                    NS_ConvertUTF16toUTF8(folderName).get());</span>
<a href="#l58.1160"></a><span id="l58.1160"> </span>
<a href="#l58.1161"></a><span id="l58.1161">         // Bug 564162 identifies a dataloss design flaw.</span>
<a href="#l58.1162"></a><span id="l58.1162">         // A working Thunderbird client can have mail in Local Folders and a</span>
<a href="#l58.1163"></a><span id="l58.1163">         // subsequent import 'Everything' will trigger a migration which</span>
<a href="#l58.1164"></a><span id="l58.1164">         // overwrites existing mailboxes with the imported mailboxes.</span>
<a href="#l58.1165"></a><span id="l58.1165">         rv = localRootFolder-&gt;CreateSubfolder(folderName, nullptr);</span>
<a href="#l58.1166"></a><span id="l58.1166">         if (NS_SUCCEEDED(rv)) {</span>
<a href="#l58.1167"></a><span id="l58.1167">           rv = localRootFolder-&gt;GetChildNamed(folderName, ppFolder);</span>
<a href="#l58.1168"></a><span id="l58.1168">           if (*ppFolder) {</span>
<a href="#l58.1169"></a><span id="l58.1169" class="difflineminus">-            IMPORT_LOG1(&quot;Folder '%s' created successfully\n&quot;, NS_ConvertUTF16toUTF8(folderName).get());</span>
<a href="#l58.1170"></a><span id="l58.1170" class="difflineplus">+            IMPORT_LOG1(&quot;Folder '%s' created successfully\n&quot;,</span>
<a href="#l58.1171"></a><span id="l58.1171" class="difflineplus">+                        NS_ConvertUTF16toUTF8(folderName).get());</span>
<a href="#l58.1172"></a><span id="l58.1172">             return true;</span>
<a href="#l58.1173"></a><span id="l58.1173">           }</span>
<a href="#l58.1174"></a><span id="l58.1174">         }</span>
<a href="#l58.1175"></a><span id="l58.1175">       }</span>
<a href="#l58.1176"></a><span id="l58.1176" class="difflineminus">-    } // if localRootFolder</span>
<a href="#l58.1177"></a><span id="l58.1177" class="difflineminus">-  } // if server</span>
<a href="#l58.1178"></a><span id="l58.1178" class="difflineplus">+    }  // if localRootFolder</span>
<a href="#l58.1179"></a><span id="l58.1179" class="difflineplus">+  }    // if server</span>
<a href="#l58.1180"></a><span id="l58.1180">   IMPORT_LOG0(&quot;****** FAILED TO CREATE FOLDER FOR IMPORT\n&quot;);</span>
<a href="#l58.1181"></a><span id="l58.1181">   return false;</span>
<a href="#l58.1182"></a><span id="l58.1182"> }</span>
<a href="#l58.1183"></a><span id="l58.1183"> </span>
<a href="#l58.1184"></a><span id="l58.1184"> /**</span>
<a href="#l58.1185"></a><span id="l58.1185">  * These are the proxy objects we use to proxy nsIMsgFolder methods back</span>
<a href="#l58.1186"></a><span id="l58.1186">  * the the main thread. Since there are only five, we can hand roll them.</span>
<a href="#l58.1187"></a><span id="l58.1187">  * A better design might be a co-routine-ish design where the ui thread</span>
<a href="#l58.1188"></a><span id="l58.1188">  * hands off each folder to the import thread and when the thread finishes</span>
<a href="#l58.1189"></a><span id="l58.1189">  * the folder, the main thread hands it the next folder.</span>
<a href="#l58.1190"></a><span id="l58.1190">  */</span>
<a href="#l58.1191"></a><span id="l58.1191"> </span>
<a href="#l58.1192"></a><span id="l58.1192" class="difflineminus">-class GetSubFoldersRunnable : public mozilla::Runnable</span>
<a href="#l58.1193"></a><span id="l58.1193" class="difflineminus">-{</span>
<a href="#l58.1194"></a><span id="l58.1194" class="difflineminus">-public:</span>
<a href="#l58.1195"></a><span id="l58.1195" class="difflineplus">+class GetSubFoldersRunnable : public mozilla::Runnable {</span>
<a href="#l58.1196"></a><span id="l58.1196" class="difflineplus">+ public:</span>
<a href="#l58.1197"></a><span id="l58.1197">   explicit GetSubFoldersRunnable(nsIMsgFolder *aFolder);</span>
<a href="#l58.1198"></a><span id="l58.1198">   NS_DECL_NSIRUNNABLE</span>
<a href="#l58.1199"></a><span id="l58.1199">   nsresult mResult;</span>
<a href="#l58.1200"></a><span id="l58.1200" class="difflineminus">-private:</span>
<a href="#l58.1201"></a><span id="l58.1201" class="difflineplus">+</span>
<a href="#l58.1202"></a><span id="l58.1202" class="difflineplus">+ private:</span>
<a href="#l58.1203"></a><span id="l58.1203">   nsCOMPtr&lt;nsIMsgFolder&gt; m_folder;</span>
<a href="#l58.1204"></a><span id="l58.1204"> };</span>
<a href="#l58.1205"></a><span id="l58.1205"> </span>
<a href="#l58.1206"></a><span id="l58.1206" class="difflineminus">-GetSubFoldersRunnable::GetSubFoldersRunnable(nsIMsgFolder *aFolder) :</span>
<a href="#l58.1207"></a><span id="l58.1207" class="difflineminus">-  mozilla::Runnable(&quot;GetSubFoldersRunnable&quot;), m_folder(aFolder)</span>
<a href="#l58.1208"></a><span id="l58.1208" class="difflineminus">-{</span>
<a href="#l58.1209"></a><span id="l58.1209" class="difflineminus">-}</span>
<a href="#l58.1210"></a><span id="l58.1210" class="difflineplus">+GetSubFoldersRunnable::GetSubFoldersRunnable(nsIMsgFolder *aFolder)</span>
<a href="#l58.1211"></a><span id="l58.1211" class="difflineplus">+    : mozilla::Runnable(&quot;GetSubFoldersRunnable&quot;), m_folder(aFolder) {}</span>
<a href="#l58.1212"></a><span id="l58.1212"> </span>
<a href="#l58.1213"></a><span id="l58.1213" class="difflineminus">-NS_IMETHODIMP GetSubFoldersRunnable::Run()</span>
<a href="#l58.1214"></a><span id="l58.1214" class="difflineminus">-{</span>
<a href="#l58.1215"></a><span id="l58.1215" class="difflineplus">+NS_IMETHODIMP GetSubFoldersRunnable::Run() {</span>
<a href="#l58.1216"></a><span id="l58.1216">   nsCOMPtr&lt;nsISimpleEnumerator&gt; dummy;</span>
<a href="#l58.1217"></a><span id="l58.1217">   mResult = m_folder-&gt;GetSubFolders(getter_AddRefs(dummy));</span>
<a href="#l58.1218"></a><span id="l58.1218">   return NS_OK;  // Sync runnable must return OK.</span>
<a href="#l58.1219"></a><span id="l58.1219"> }</span>
<a href="#l58.1220"></a><span id="l58.1220"> </span>
<a href="#l58.1221"></a><span id="l58.1221" class="difflineminus">-</span>
<a href="#l58.1222"></a><span id="l58.1222" class="difflineminus">-nsresult ProxyGetSubFolders(nsIMsgFolder *aFolder)</span>
<a href="#l58.1223"></a><span id="l58.1223" class="difflineminus">-{</span>
<a href="#l58.1224"></a><span id="l58.1224" class="difflineplus">+nsresult ProxyGetSubFolders(nsIMsgFolder *aFolder) {</span>
<a href="#l58.1225"></a><span id="l58.1225">   RefPtr&lt;GetSubFoldersRunnable&gt; getSubFolders =</span>
<a href="#l58.1226"></a><span id="l58.1226" class="difflineminus">-    new GetSubFoldersRunnable(aFolder);</span>
<a href="#l58.1227"></a><span id="l58.1227" class="difflineplus">+      new GetSubFoldersRunnable(aFolder);</span>
<a href="#l58.1228"></a><span id="l58.1228">   nsresult rv = NS_DispatchToMainThread(getSubFolders, NS_DISPATCH_SYNC);</span>
<a href="#l58.1229"></a><span id="l58.1229">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l58.1230"></a><span id="l58.1230">   return getSubFolders-&gt;mResult;</span>
<a href="#l58.1231"></a><span id="l58.1231"> }</span>
<a href="#l58.1232"></a><span id="l58.1232"> </span>
<a href="#l58.1233"></a><span id="l58.1233" class="difflineminus">-class GetChildNamedRunnable : public mozilla::Runnable</span>
<a href="#l58.1234"></a><span id="l58.1234" class="difflineminus">-{</span>
<a href="#l58.1235"></a><span id="l58.1235" class="difflineminus">-public:</span>
<a href="#l58.1236"></a><span id="l58.1236" class="difflineminus">-  GetChildNamedRunnable(nsIMsgFolder *aFolder, const nsAString&amp; aName, nsIMsgFolder **aChild);</span>
<a href="#l58.1237"></a><span id="l58.1237" class="difflineplus">+class GetChildNamedRunnable : public mozilla::Runnable {</span>
<a href="#l58.1238"></a><span id="l58.1238" class="difflineplus">+ public:</span>
<a href="#l58.1239"></a><span id="l58.1239" class="difflineplus">+  GetChildNamedRunnable(nsIMsgFolder *aFolder, const nsAString &amp;aName,</span>
<a href="#l58.1240"></a><span id="l58.1240" class="difflineplus">+                        nsIMsgFolder **aChild);</span>
<a href="#l58.1241"></a><span id="l58.1241">   NS_DECL_NSIRUNNABLE</span>
<a href="#l58.1242"></a><span id="l58.1242">   nsresult mResult;</span>
<a href="#l58.1243"></a><span id="l58.1243" class="difflineminus">-protected:</span>
<a href="#l58.1244"></a><span id="l58.1244" class="difflineplus">+</span>
<a href="#l58.1245"></a><span id="l58.1245" class="difflineplus">+ protected:</span>
<a href="#l58.1246"></a><span id="l58.1246">   nsCOMPtr&lt;nsIMsgFolder&gt; m_folder;</span>
<a href="#l58.1247"></a><span id="l58.1247">   nsString m_name;</span>
<a href="#l58.1248"></a><span id="l58.1248">   nsIMsgFolder **m_child;</span>
<a href="#l58.1249"></a><span id="l58.1249"> };</span>
<a href="#l58.1250"></a><span id="l58.1250"> </span>
<a href="#l58.1251"></a><span id="l58.1251"> GetChildNamedRunnable::GetChildNamedRunnable(nsIMsgFolder *aFolder,</span>
<a href="#l58.1252"></a><span id="l58.1252" class="difflineminus">-                                             const nsAString &amp; aName,</span>
<a href="#l58.1253"></a><span id="l58.1253" class="difflineminus">-                                             nsIMsgFolder **aChild) :</span>
<a href="#l58.1254"></a><span id="l58.1254" class="difflineminus">-  mozilla::Runnable(&quot;GetChildNamedRunnable&quot;),</span>
<a href="#l58.1255"></a><span id="l58.1255" class="difflineminus">-  m_folder(aFolder), m_name(aName), m_child(aChild)</span>
<a href="#l58.1256"></a><span id="l58.1256" class="difflineminus">-{</span>
<a href="#l58.1257"></a><span id="l58.1257" class="difflineminus">-}</span>
<a href="#l58.1258"></a><span id="l58.1258" class="difflineplus">+                                             const nsAString &amp;aName,</span>
<a href="#l58.1259"></a><span id="l58.1259" class="difflineplus">+                                             nsIMsgFolder **aChild)</span>
<a href="#l58.1260"></a><span id="l58.1260" class="difflineplus">+    : mozilla::Runnable(&quot;GetChildNamedRunnable&quot;),</span>
<a href="#l58.1261"></a><span id="l58.1261" class="difflineplus">+      m_folder(aFolder),</span>
<a href="#l58.1262"></a><span id="l58.1262" class="difflineplus">+      m_name(aName),</span>
<a href="#l58.1263"></a><span id="l58.1263" class="difflineplus">+      m_child(aChild) {}</span>
<a href="#l58.1264"></a><span id="l58.1264"> </span>
<a href="#l58.1265"></a><span id="l58.1265" class="difflineminus">-NS_IMETHODIMP GetChildNamedRunnable::Run()</span>
<a href="#l58.1266"></a><span id="l58.1266" class="difflineminus">-{</span>
<a href="#l58.1267"></a><span id="l58.1267" class="difflineplus">+NS_IMETHODIMP GetChildNamedRunnable::Run() {</span>
<a href="#l58.1268"></a><span id="l58.1268">   mResult = m_folder-&gt;GetChildNamed(m_name, m_child);</span>
<a href="#l58.1269"></a><span id="l58.1269">   return NS_OK;  // Sync runnable must return OK.</span>
<a href="#l58.1270"></a><span id="l58.1270"> }</span>
<a href="#l58.1271"></a><span id="l58.1271"> </span>
<a href="#l58.1272"></a><span id="l58.1272" class="difflineminus">-</span>
<a href="#l58.1273"></a><span id="l58.1273" class="difflineminus">-nsresult ProxyGetChildNamed(nsIMsgFolder *aFolder, const nsAString &amp; aName,</span>
<a href="#l58.1274"></a><span id="l58.1274" class="difflineminus">-                            nsIMsgFolder **aChild)</span>
<a href="#l58.1275"></a><span id="l58.1275" class="difflineminus">-{</span>
<a href="#l58.1276"></a><span id="l58.1276" class="difflineplus">+nsresult ProxyGetChildNamed(nsIMsgFolder *aFolder, const nsAString &amp;aName,</span>
<a href="#l58.1277"></a><span id="l58.1277" class="difflineplus">+                            nsIMsgFolder **aChild) {</span>
<a href="#l58.1278"></a><span id="l58.1278">   RefPtr&lt;GetChildNamedRunnable&gt; getChildNamed =</span>
<a href="#l58.1279"></a><span id="l58.1279" class="difflineminus">-    new GetChildNamedRunnable(aFolder, aName, aChild);</span>
<a href="#l58.1280"></a><span id="l58.1280" class="difflineplus">+      new GetChildNamedRunnable(aFolder, aName, aChild);</span>
<a href="#l58.1281"></a><span id="l58.1281">   nsresult rv = NS_DispatchToMainThread(getChildNamed, NS_DISPATCH_SYNC);</span>
<a href="#l58.1282"></a><span id="l58.1282">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l58.1283"></a><span id="l58.1283">   return getChildNamed-&gt;mResult;</span>
<a href="#l58.1284"></a><span id="l58.1284"> }</span>
<a href="#l58.1285"></a><span id="l58.1285"> </span>
<a href="#l58.1286"></a><span id="l58.1286" class="difflineminus">-class GetParentRunnable : public mozilla::Runnable</span>
<a href="#l58.1287"></a><span id="l58.1287" class="difflineminus">-{</span>
<a href="#l58.1288"></a><span id="l58.1288" class="difflineminus">-public:</span>
<a href="#l58.1289"></a><span id="l58.1289" class="difflineplus">+class GetParentRunnable : public mozilla::Runnable {</span>
<a href="#l58.1290"></a><span id="l58.1290" class="difflineplus">+ public:</span>
<a href="#l58.1291"></a><span id="l58.1291">   GetParentRunnable(nsIMsgFolder *aFolder, nsIMsgFolder **aParent);</span>
<a href="#l58.1292"></a><span id="l58.1292">   NS_DECL_NSIRUNNABLE</span>
<a href="#l58.1293"></a><span id="l58.1293">   nsresult mResult;</span>
<a href="#l58.1294"></a><span id="l58.1294" class="difflineminus">-protected:</span>
<a href="#l58.1295"></a><span id="l58.1295" class="difflineplus">+</span>
<a href="#l58.1296"></a><span id="l58.1296" class="difflineplus">+ protected:</span>
<a href="#l58.1297"></a><span id="l58.1297">   nsCOMPtr&lt;nsIMsgFolder&gt; m_folder;</span>
<a href="#l58.1298"></a><span id="l58.1298">   nsIMsgFolder **m_parent;</span>
<a href="#l58.1299"></a><span id="l58.1299"> };</span>
<a href="#l58.1300"></a><span id="l58.1300"> </span>
<a href="#l58.1301"></a><span id="l58.1301" class="difflineminus">-GetParentRunnable::GetParentRunnable(nsIMsgFolder *aFolder, nsIMsgFolder **aParent) :</span>
<a href="#l58.1302"></a><span id="l58.1302" class="difflineminus">-  mozilla::Runnable(&quot;GetParentRunnable&quot;), m_folder(aFolder), m_parent(aParent)</span>
<a href="#l58.1303"></a><span id="l58.1303" class="difflineminus">-{</span>
<a href="#l58.1304"></a><span id="l58.1304" class="difflineminus">-}</span>
<a href="#l58.1305"></a><span id="l58.1305" class="difflineplus">+GetParentRunnable::GetParentRunnable(nsIMsgFolder *aFolder,</span>
<a href="#l58.1306"></a><span id="l58.1306" class="difflineplus">+                                     nsIMsgFolder **aParent)</span>
<a href="#l58.1307"></a><span id="l58.1307" class="difflineplus">+    : mozilla::Runnable(&quot;GetParentRunnable&quot;),</span>
<a href="#l58.1308"></a><span id="l58.1308" class="difflineplus">+      m_folder(aFolder),</span>
<a href="#l58.1309"></a><span id="l58.1309" class="difflineplus">+      m_parent(aParent) {}</span>
<a href="#l58.1310"></a><span id="l58.1310"> </span>
<a href="#l58.1311"></a><span id="l58.1311" class="difflineminus">-NS_IMETHODIMP GetParentRunnable::Run()</span>
<a href="#l58.1312"></a><span id="l58.1312" class="difflineminus">-{</span>
<a href="#l58.1313"></a><span id="l58.1313" class="difflineplus">+NS_IMETHODIMP GetParentRunnable::Run() {</span>
<a href="#l58.1314"></a><span id="l58.1314">   mResult = m_folder-&gt;GetParent(m_parent);</span>
<a href="#l58.1315"></a><span id="l58.1315">   return NS_OK;  // Sync runnable must return OK.</span>
<a href="#l58.1316"></a><span id="l58.1316"> }</span>
<a href="#l58.1317"></a><span id="l58.1317"> </span>
<a href="#l58.1318"></a><span id="l58.1318" class="difflineminus">-</span>
<a href="#l58.1319"></a><span id="l58.1319" class="difflineminus">-nsresult ProxyGetParent(nsIMsgFolder *aFolder, nsIMsgFolder **aParent)</span>
<a href="#l58.1320"></a><span id="l58.1320" class="difflineminus">-{</span>
<a href="#l58.1321"></a><span id="l58.1321" class="difflineminus">-  RefPtr&lt;GetParentRunnable&gt; getParent =</span>
<a href="#l58.1322"></a><span id="l58.1322" class="difflineminus">-    new GetParentRunnable(aFolder, aParent);</span>
<a href="#l58.1323"></a><span id="l58.1323" class="difflineplus">+nsresult ProxyGetParent(nsIMsgFolder *aFolder, nsIMsgFolder **aParent) {</span>
<a href="#l58.1324"></a><span id="l58.1324" class="difflineplus">+  RefPtr&lt;GetParentRunnable&gt; getParent = new GetParentRunnable(aFolder, aParent);</span>
<a href="#l58.1325"></a><span id="l58.1325">   nsresult rv = NS_DispatchToMainThread(getParent, NS_DISPATCH_SYNC);</span>
<a href="#l58.1326"></a><span id="l58.1326">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l58.1327"></a><span id="l58.1327">   return getParent-&gt;mResult;</span>
<a href="#l58.1328"></a><span id="l58.1328"> }</span>
<a href="#l58.1329"></a><span id="l58.1329"> </span>
<a href="#l58.1330"></a><span id="l58.1330" class="difflineminus">-class ContainsChildNamedRunnable : public mozilla::Runnable</span>
<a href="#l58.1331"></a><span id="l58.1331" class="difflineminus">-{</span>
<a href="#l58.1332"></a><span id="l58.1332" class="difflineminus">-public:</span>
<a href="#l58.1333"></a><span id="l58.1333" class="difflineminus">-  ContainsChildNamedRunnable(nsIMsgFolder *aFolder, const nsAString&amp; aName, bool *aResult);</span>
<a href="#l58.1334"></a><span id="l58.1334" class="difflineplus">+class ContainsChildNamedRunnable : public mozilla::Runnable {</span>
<a href="#l58.1335"></a><span id="l58.1335" class="difflineplus">+ public:</span>
<a href="#l58.1336"></a><span id="l58.1336" class="difflineplus">+  ContainsChildNamedRunnable(nsIMsgFolder *aFolder, const nsAString &amp;aName,</span>
<a href="#l58.1337"></a><span id="l58.1337" class="difflineplus">+                             bool *aResult);</span>
<a href="#l58.1338"></a><span id="l58.1338">   NS_DECL_NSIRUNNABLE</span>
<a href="#l58.1339"></a><span id="l58.1339">   nsresult mResult;</span>
<a href="#l58.1340"></a><span id="l58.1340" class="difflineminus">-protected:</span>
<a href="#l58.1341"></a><span id="l58.1341" class="difflineplus">+</span>
<a href="#l58.1342"></a><span id="l58.1342" class="difflineplus">+ protected:</span>
<a href="#l58.1343"></a><span id="l58.1343">   nsCOMPtr&lt;nsIMsgFolder&gt; m_folder;</span>
<a href="#l58.1344"></a><span id="l58.1344">   nsString m_name;</span>
<a href="#l58.1345"></a><span id="l58.1345">   bool *m_result;</span>
<a href="#l58.1346"></a><span id="l58.1346"> };</span>
<a href="#l58.1347"></a><span id="l58.1347"> </span>
<a href="#l58.1348"></a><span id="l58.1348"> ContainsChildNamedRunnable::ContainsChildNamedRunnable(nsIMsgFolder *aFolder,</span>
<a href="#l58.1349"></a><span id="l58.1349">                                                        const nsAString &amp;aName,</span>
<a href="#l58.1350"></a><span id="l58.1350" class="difflineminus">-                                                       bool *aResult) :</span>
<a href="#l58.1351"></a><span id="l58.1351" class="difflineminus">-  mozilla::Runnable(&quot;ContainsChildNamedRunnable&quot;),</span>
<a href="#l58.1352"></a><span id="l58.1352" class="difflineminus">-  m_folder(aFolder), m_name(aName), m_result(aResult)</span>
<a href="#l58.1353"></a><span id="l58.1353" class="difflineminus">-{</span>
<a href="#l58.1354"></a><span id="l58.1354" class="difflineminus">-}</span>
<a href="#l58.1355"></a><span id="l58.1355" class="difflineplus">+                                                       bool *aResult)</span>
<a href="#l58.1356"></a><span id="l58.1356" class="difflineplus">+    : mozilla::Runnable(&quot;ContainsChildNamedRunnable&quot;),</span>
<a href="#l58.1357"></a><span id="l58.1357" class="difflineplus">+      m_folder(aFolder),</span>
<a href="#l58.1358"></a><span id="l58.1358" class="difflineplus">+      m_name(aName),</span>
<a href="#l58.1359"></a><span id="l58.1359" class="difflineplus">+      m_result(aResult) {}</span>
<a href="#l58.1360"></a><span id="l58.1360"> </span>
<a href="#l58.1361"></a><span id="l58.1361" class="difflineminus">-NS_IMETHODIMP ContainsChildNamedRunnable::Run()</span>
<a href="#l58.1362"></a><span id="l58.1362" class="difflineminus">-{</span>
<a href="#l58.1363"></a><span id="l58.1363" class="difflineplus">+NS_IMETHODIMP ContainsChildNamedRunnable::Run() {</span>
<a href="#l58.1364"></a><span id="l58.1364">   mResult = m_folder-&gt;ContainsChildNamed(m_name, m_result);</span>
<a href="#l58.1365"></a><span id="l58.1365">   return NS_OK;  // Sync runnable must return OK.</span>
<a href="#l58.1366"></a><span id="l58.1366"> }</span>
<a href="#l58.1367"></a><span id="l58.1367"> </span>
<a href="#l58.1368"></a><span id="l58.1368" class="difflineminus">-</span>
<a href="#l58.1369"></a><span id="l58.1369"> nsresult ProxyContainsChildNamed(nsIMsgFolder *aFolder, const nsAString &amp;aName,</span>
<a href="#l58.1370"></a><span id="l58.1370" class="difflineminus">-                                 bool *aResult)</span>
<a href="#l58.1371"></a><span id="l58.1371" class="difflineminus">-{</span>
<a href="#l58.1372"></a><span id="l58.1372" class="difflineplus">+                                 bool *aResult) {</span>
<a href="#l58.1373"></a><span id="l58.1373">   RefPtr&lt;ContainsChildNamedRunnable&gt; containsChildNamed =</span>
<a href="#l58.1374"></a><span id="l58.1374" class="difflineminus">-    new ContainsChildNamedRunnable(aFolder, aName, aResult);</span>
<a href="#l58.1375"></a><span id="l58.1375" class="difflineplus">+      new ContainsChildNamedRunnable(aFolder, aName, aResult);</span>
<a href="#l58.1376"></a><span id="l58.1376">   nsresult rv = NS_DispatchToMainThread(containsChildNamed, NS_DISPATCH_SYNC);</span>
<a href="#l58.1377"></a><span id="l58.1377">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l58.1378"></a><span id="l58.1378">   return containsChildNamed-&gt;mResult;</span>
<a href="#l58.1379"></a><span id="l58.1379"> }</span>
<a href="#l58.1380"></a><span id="l58.1380"> </span>
<a href="#l58.1381"></a><span id="l58.1381" class="difflineminus">-class GenerateUniqueSubfolderNameRunnable : public mozilla::Runnable</span>
<a href="#l58.1382"></a><span id="l58.1382" class="difflineminus">-{</span>
<a href="#l58.1383"></a><span id="l58.1383" class="difflineminus">-public:</span>
<a href="#l58.1384"></a><span id="l58.1384" class="difflineplus">+class GenerateUniqueSubfolderNameRunnable : public mozilla::Runnable {</span>
<a href="#l58.1385"></a><span id="l58.1385" class="difflineplus">+ public:</span>
<a href="#l58.1386"></a><span id="l58.1386">   GenerateUniqueSubfolderNameRunnable(nsIMsgFolder *aFolder,</span>
<a href="#l58.1387"></a><span id="l58.1387" class="difflineminus">-                                      const nsAString&amp; prefix,</span>
<a href="#l58.1388"></a><span id="l58.1388" class="difflineplus">+                                      const nsAString &amp;prefix,</span>
<a href="#l58.1389"></a><span id="l58.1389">                                       nsIMsgFolder *otherFolder,</span>
<a href="#l58.1390"></a><span id="l58.1390" class="difflineminus">-                                      nsAString&amp; name);</span>
<a href="#l58.1391"></a><span id="l58.1391" class="difflineplus">+                                      nsAString &amp;name);</span>
<a href="#l58.1392"></a><span id="l58.1392">   NS_DECL_NSIRUNNABLE</span>
<a href="#l58.1393"></a><span id="l58.1393">   nsresult mResult;</span>
<a href="#l58.1394"></a><span id="l58.1394" class="difflineminus">-protected:</span>
<a href="#l58.1395"></a><span id="l58.1395" class="difflineplus">+</span>
<a href="#l58.1396"></a><span id="l58.1396" class="difflineplus">+ protected:</span>
<a href="#l58.1397"></a><span id="l58.1397">   nsCOMPtr&lt;nsIMsgFolder&gt; m_folder;</span>
<a href="#l58.1398"></a><span id="l58.1398">   nsString m_prefix;</span>
<a href="#l58.1399"></a><span id="l58.1399">   nsCOMPtr&lt;nsIMsgFolder&gt; m_otherFolder;</span>
<a href="#l58.1400"></a><span id="l58.1400">   nsString m_name;</span>
<a href="#l58.1401"></a><span id="l58.1401"> };</span>
<a href="#l58.1402"></a><span id="l58.1402"> </span>
<a href="#l58.1403"></a><span id="l58.1403"> GenerateUniqueSubfolderNameRunnable::GenerateUniqueSubfolderNameRunnable(</span>
<a href="#l58.1404"></a><span id="l58.1404" class="difflineminus">-  nsIMsgFolder *aFolder, const nsAString&amp; aPrefix, nsIMsgFolder *aOtherFolder,</span>
<a href="#l58.1405"></a><span id="l58.1405" class="difflineminus">-  nsAString&amp; aName)</span>
<a href="#l58.1406"></a><span id="l58.1406" class="difflineminus">-  : mozilla::Runnable(&quot;GenerateUniqueSubfolderNameRunnable&quot;)</span>
<a href="#l58.1407"></a><span id="l58.1407" class="difflineminus">-  , m_folder(aFolder), m_prefix(aPrefix), m_otherFolder(aOtherFolder), m_name(aName)</span>
<a href="#l58.1408"></a><span id="l58.1408" class="difflineminus">-{</span>
<a href="#l58.1409"></a><span id="l58.1409" class="difflineminus">-}</span>
<a href="#l58.1410"></a><span id="l58.1410" class="difflineplus">+    nsIMsgFolder *aFolder, const nsAString &amp;aPrefix, nsIMsgFolder *aOtherFolder,</span>
<a href="#l58.1411"></a><span id="l58.1411" class="difflineplus">+    nsAString &amp;aName)</span>
<a href="#l58.1412"></a><span id="l58.1412" class="difflineplus">+    : mozilla::Runnable(&quot;GenerateUniqueSubfolderNameRunnable&quot;),</span>
<a href="#l58.1413"></a><span id="l58.1413" class="difflineplus">+      m_folder(aFolder),</span>
<a href="#l58.1414"></a><span id="l58.1414" class="difflineplus">+      m_prefix(aPrefix),</span>
<a href="#l58.1415"></a><span id="l58.1415" class="difflineplus">+      m_otherFolder(aOtherFolder),</span>
<a href="#l58.1416"></a><span id="l58.1416" class="difflineplus">+      m_name(aName) {}</span>
<a href="#l58.1417"></a><span id="l58.1417"> </span>
<a href="#l58.1418"></a><span id="l58.1418" class="difflineminus">-NS_IMETHODIMP GenerateUniqueSubfolderNameRunnable::Run()</span>
<a href="#l58.1419"></a><span id="l58.1419" class="difflineminus">-{</span>
<a href="#l58.1420"></a><span id="l58.1420" class="difflineminus">-  mResult = m_folder-&gt;GenerateUniqueSubfolderName(m_prefix, m_otherFolder, m_name);</span>
<a href="#l58.1421"></a><span id="l58.1421" class="difflineplus">+NS_IMETHODIMP GenerateUniqueSubfolderNameRunnable::Run() {</span>
<a href="#l58.1422"></a><span id="l58.1422" class="difflineplus">+  mResult =</span>
<a href="#l58.1423"></a><span id="l58.1423" class="difflineplus">+      m_folder-&gt;GenerateUniqueSubfolderName(m_prefix, m_otherFolder, m_name);</span>
<a href="#l58.1424"></a><span id="l58.1424">   return NS_OK;  // Sync runnable must return OK.</span>
<a href="#l58.1425"></a><span id="l58.1425"> }</span>
<a href="#l58.1426"></a><span id="l58.1426"> </span>
<a href="#l58.1427"></a><span id="l58.1427" class="difflineminus">-</span>
<a href="#l58.1428"></a><span id="l58.1428"> nsresult ProxyGenerateUniqueSubfolderName(nsIMsgFolder *aFolder,</span>
<a href="#l58.1429"></a><span id="l58.1429" class="difflineminus">-                                          const nsAString&amp; aPrefix,</span>
<a href="#l58.1430"></a><span id="l58.1430" class="difflineplus">+                                          const nsAString &amp;aPrefix,</span>
<a href="#l58.1431"></a><span id="l58.1431">                                           nsIMsgFolder *aOtherFolder,</span>
<a href="#l58.1432"></a><span id="l58.1432" class="difflineminus">-                                          nsAString&amp; aName)</span>
<a href="#l58.1433"></a><span id="l58.1433" class="difflineplus">+                                          nsAString &amp;aName)</span>
<a href="#l58.1434"></a><span id="l58.1434"> </span>
<a href="#l58.1435"></a><span id="l58.1435"> {</span>
<a href="#l58.1436"></a><span id="l58.1436">   RefPtr&lt;GenerateUniqueSubfolderNameRunnable&gt; generateUniqueSubfolderName =</span>
<a href="#l58.1437"></a><span id="l58.1437" class="difflineminus">-    new GenerateUniqueSubfolderNameRunnable(aFolder, aPrefix, aOtherFolder, aName);</span>
<a href="#l58.1438"></a><span id="l58.1438" class="difflineminus">-  nsresult rv = NS_DispatchToMainThread(generateUniqueSubfolderName, NS_DISPATCH_SYNC);</span>
<a href="#l58.1439"></a><span id="l58.1439" class="difflineplus">+      new GenerateUniqueSubfolderNameRunnable(aFolder, aPrefix, aOtherFolder,</span>
<a href="#l58.1440"></a><span id="l58.1440" class="difflineplus">+                                              aName);</span>
<a href="#l58.1441"></a><span id="l58.1441" class="difflineplus">+  nsresult rv =</span>
<a href="#l58.1442"></a><span id="l58.1442" class="difflineplus">+      NS_DispatchToMainThread(generateUniqueSubfolderName, NS_DISPATCH_SYNC);</span>
<a href="#l58.1443"></a><span id="l58.1443">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l58.1444"></a><span id="l58.1444">   return generateUniqueSubfolderName-&gt;mResult;</span>
<a href="#l58.1445"></a><span id="l58.1445"> }</span>
<a href="#l58.1446"></a><span id="l58.1446"> </span>
<a href="#l58.1447"></a><span id="l58.1447" class="difflineminus">-class CreateSubfolderRunnable : public mozilla::Runnable</span>
<a href="#l58.1448"></a><span id="l58.1448" class="difflineminus">-{</span>
<a href="#l58.1449"></a><span id="l58.1449" class="difflineminus">-public:</span>
<a href="#l58.1450"></a><span id="l58.1450" class="difflineminus">-  CreateSubfolderRunnable(nsIMsgFolder *aFolder, const nsAString&amp; aName);</span>
<a href="#l58.1451"></a><span id="l58.1451" class="difflineplus">+class CreateSubfolderRunnable : public mozilla::Runnable {</span>
<a href="#l58.1452"></a><span id="l58.1452" class="difflineplus">+ public:</span>
<a href="#l58.1453"></a><span id="l58.1453" class="difflineplus">+  CreateSubfolderRunnable(nsIMsgFolder *aFolder, const nsAString &amp;aName);</span>
<a href="#l58.1454"></a><span id="l58.1454">   NS_DECL_NSIRUNNABLE</span>
<a href="#l58.1455"></a><span id="l58.1455">   nsresult mResult;</span>
<a href="#l58.1456"></a><span id="l58.1456" class="difflineminus">-protected:</span>
<a href="#l58.1457"></a><span id="l58.1457" class="difflineplus">+</span>
<a href="#l58.1458"></a><span id="l58.1458" class="difflineplus">+ protected:</span>
<a href="#l58.1459"></a><span id="l58.1459">   nsCOMPtr&lt;nsIMsgFolder&gt; m_folder;</span>
<a href="#l58.1460"></a><span id="l58.1460">   nsString m_name;</span>
<a href="#l58.1461"></a><span id="l58.1461"> };</span>
<a href="#l58.1462"></a><span id="l58.1462"> </span>
<a href="#l58.1463"></a><span id="l58.1463"> CreateSubfolderRunnable::CreateSubfolderRunnable(nsIMsgFolder *aFolder,</span>
<a href="#l58.1464"></a><span id="l58.1464" class="difflineminus">-                                                 const nsAString &amp;aName) :</span>
<a href="#l58.1465"></a><span id="l58.1465" class="difflineminus">-  mozilla::Runnable(&quot;CreateSubfolderRunnable&quot;), m_folder(aFolder), m_name(aName)</span>
<a href="#l58.1466"></a><span id="l58.1466" class="difflineminus">-{</span>
<a href="#l58.1467"></a><span id="l58.1467" class="difflineminus">-}</span>
<a href="#l58.1468"></a><span id="l58.1468" class="difflineplus">+                                                 const nsAString &amp;aName)</span>
<a href="#l58.1469"></a><span id="l58.1469" class="difflineplus">+    : mozilla::Runnable(&quot;CreateSubfolderRunnable&quot;),</span>
<a href="#l58.1470"></a><span id="l58.1470" class="difflineplus">+      m_folder(aFolder),</span>
<a href="#l58.1471"></a><span id="l58.1471" class="difflineplus">+      m_name(aName) {}</span>
<a href="#l58.1472"></a><span id="l58.1472"> </span>
<a href="#l58.1473"></a><span id="l58.1473" class="difflineminus">-NS_IMETHODIMP CreateSubfolderRunnable::Run()</span>
<a href="#l58.1474"></a><span id="l58.1474" class="difflineminus">-{</span>
<a href="#l58.1475"></a><span id="l58.1475" class="difflineplus">+NS_IMETHODIMP CreateSubfolderRunnable::Run() {</span>
<a href="#l58.1476"></a><span id="l58.1476">   mResult = m_folder-&gt;CreateSubfolder(m_name, nullptr);</span>
<a href="#l58.1477"></a><span id="l58.1477">   return NS_OK;  // Sync runnable must return OK.</span>
<a href="#l58.1478"></a><span id="l58.1478"> }</span>
<a href="#l58.1479"></a><span id="l58.1479"> </span>
<a href="#l58.1480"></a><span id="l58.1480" class="difflineminus">-</span>
<a href="#l58.1481"></a><span id="l58.1481" class="difflineminus">-nsresult ProxyCreateSubfolder(nsIMsgFolder *aFolder, const nsAString &amp;aName)</span>
<a href="#l58.1482"></a><span id="l58.1482" class="difflineminus">-{</span>
<a href="#l58.1483"></a><span id="l58.1483" class="difflineplus">+nsresult ProxyCreateSubfolder(nsIMsgFolder *aFolder, const nsAString &amp;aName) {</span>
<a href="#l58.1484"></a><span id="l58.1484">   RefPtr&lt;CreateSubfolderRunnable&gt; createSubfolder =</span>
<a href="#l58.1485"></a><span id="l58.1485" class="difflineminus">-    new CreateSubfolderRunnable(aFolder, aName);</span>
<a href="#l58.1486"></a><span id="l58.1486" class="difflineplus">+      new CreateSubfolderRunnable(aFolder, aName);</span>
<a href="#l58.1487"></a><span id="l58.1487">   nsresult rv = NS_DispatchToMainThread(createSubfolder, NS_DISPATCH_SYNC);</span>
<a href="#l58.1488"></a><span id="l58.1488">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l58.1489"></a><span id="l58.1489">   return createSubfolder-&gt;mResult;</span>
<a href="#l58.1490"></a><span id="l58.1490"> }</span>
<a href="#l58.1491"></a><span id="l58.1491"> </span>
<a href="#l58.1492"></a><span id="l58.1492" class="difflineminus">-class ForceDBClosedRunnable : public mozilla::Runnable</span>
<a href="#l58.1493"></a><span id="l58.1493" class="difflineminus">-{</span>
<a href="#l58.1494"></a><span id="l58.1494" class="difflineminus">-public:</span>
<a href="#l58.1495"></a><span id="l58.1495" class="difflineplus">+class ForceDBClosedRunnable : public mozilla::Runnable {</span>
<a href="#l58.1496"></a><span id="l58.1496" class="difflineplus">+ public:</span>
<a href="#l58.1497"></a><span id="l58.1497">   explicit ForceDBClosedRunnable(nsIMsgFolder *aFolder);</span>
<a href="#l58.1498"></a><span id="l58.1498">   NS_DECL_NSIRUNNABLE</span>
<a href="#l58.1499"></a><span id="l58.1499">   nsresult mResult;</span>
<a href="#l58.1500"></a><span id="l58.1500" class="difflineminus">-protected:</span>
<a href="#l58.1501"></a><span id="l58.1501" class="difflineplus">+</span>
<a href="#l58.1502"></a><span id="l58.1502" class="difflineplus">+ protected:</span>
<a href="#l58.1503"></a><span id="l58.1503">   nsCOMPtr&lt;nsIMsgFolder&gt; m_folder;</span>
<a href="#l58.1504"></a><span id="l58.1504"> };</span>
<a href="#l58.1505"></a><span id="l58.1505"> </span>
<a href="#l58.1506"></a><span id="l58.1506" class="difflineminus">-ForceDBClosedRunnable::ForceDBClosedRunnable(nsIMsgFolder *aFolder) :</span>
<a href="#l58.1507"></a><span id="l58.1507" class="difflineminus">-  mozilla::Runnable(&quot;ForceDBClosedRunnable&quot;), m_folder(aFolder)</span>
<a href="#l58.1508"></a><span id="l58.1508" class="difflineminus">-{</span>
<a href="#l58.1509"></a><span id="l58.1509" class="difflineminus">-}</span>
<a href="#l58.1510"></a><span id="l58.1510" class="difflineplus">+ForceDBClosedRunnable::ForceDBClosedRunnable(nsIMsgFolder *aFolder)</span>
<a href="#l58.1511"></a><span id="l58.1511" class="difflineplus">+    : mozilla::Runnable(&quot;ForceDBClosedRunnable&quot;), m_folder(aFolder) {}</span>
<a href="#l58.1512"></a><span id="l58.1512"> </span>
<a href="#l58.1513"></a><span id="l58.1513" class="difflineminus">-NS_IMETHODIMP ForceDBClosedRunnable::Run()</span>
<a href="#l58.1514"></a><span id="l58.1514" class="difflineminus">-{</span>
<a href="#l58.1515"></a><span id="l58.1515" class="difflineplus">+NS_IMETHODIMP ForceDBClosedRunnable::Run() {</span>
<a href="#l58.1516"></a><span id="l58.1516">   mResult = m_folder-&gt;ForceDBClosed();</span>
<a href="#l58.1517"></a><span id="l58.1517">   return NS_OK;  // Sync runnable must return OK.</span>
<a href="#l58.1518"></a><span id="l58.1518"> }</span>
<a href="#l58.1519"></a><span id="l58.1519"> </span>
<a href="#l58.1520"></a><span id="l58.1520" class="difflineminus">-nsresult ProxyForceDBClosed(nsIMsgFolder *aFolder)</span>
<a href="#l58.1521"></a><span id="l58.1521" class="difflineminus">-{</span>
<a href="#l58.1522"></a><span id="l58.1522" class="difflineplus">+nsresult ProxyForceDBClosed(nsIMsgFolder *aFolder) {</span>
<a href="#l58.1523"></a><span id="l58.1523">   RefPtr&lt;ForceDBClosedRunnable&gt; forceDBClosed =</span>
<a href="#l58.1524"></a><span id="l58.1524" class="difflineminus">-    new ForceDBClosedRunnable(aFolder);</span>
<a href="#l58.1525"></a><span id="l58.1525" class="difflineplus">+      new ForceDBClosedRunnable(aFolder);</span>
<a href="#l58.1526"></a><span id="l58.1526">   nsresult rv = NS_DispatchToMainThread(forceDBClosed, NS_DISPATCH_SYNC);</span>
<a href="#l58.1527"></a><span id="l58.1527">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l58.1528"></a><span id="l58.1528">   return forceDBClosed-&gt;mResult;</span>
<a href="#l58.1529"></a><span id="l58.1529"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l59.1"></a><span id="l59.1" class="difflineminus">--- a/mailnews/import/src/nsImportMailboxDescriptor.cpp</span>
<a href="#l59.2"></a><span id="l59.2" class="difflineplus">+++ b/mailnews/import/src/nsImportMailboxDescriptor.cpp</span>
<a href="#l59.3"></a><span id="l59.3" class="difflineat">@@ -1,33 +1,28 @@</span>
<a href="#l59.4"></a><span id="l59.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l59.5"></a><span id="l59.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l59.6"></a><span id="l59.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l59.7"></a><span id="l59.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l59.8"></a><span id="l59.8"> </span>
<a href="#l59.9"></a><span id="l59.9" class="difflineminus">-</span>
<a href="#l59.10"></a><span id="l59.10"> #include &quot;nscore.h&quot;</span>
<a href="#l59.11"></a><span id="l59.11"> #include &quot;nsImportMailboxDescriptor.h&quot;</span>
<a href="#l59.12"></a><span id="l59.12"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l59.13"></a><span id="l59.13"> </span>
<a href="#l59.14"></a><span id="l59.14"> ////////////////////////////////////////////////////////////////////////</span>
<a href="#l59.15"></a><span id="l59.15"> </span>
<a href="#l59.16"></a><span id="l59.16" class="difflineminus">-</span>
<a href="#l59.17"></a><span id="l59.17" class="difflineminus">-</span>
<a href="#l59.18"></a><span id="l59.18" class="difflineminus">-nsresult nsImportMailboxDescriptor::Create(nsISupports *aOuter, REFNSIID aIID, void **aResult)</span>
<a href="#l59.19"></a><span id="l59.19" class="difflineminus">-{</span>
<a href="#l59.20"></a><span id="l59.20" class="difflineminus">-  if (aOuter)</span>
<a href="#l59.21"></a><span id="l59.21" class="difflineminus">-    return NS_ERROR_NO_AGGREGATION;</span>
<a href="#l59.22"></a><span id="l59.22" class="difflineplus">+nsresult nsImportMailboxDescriptor::Create(nsISupports *aOuter, REFNSIID aIID,</span>
<a href="#l59.23"></a><span id="l59.23" class="difflineplus">+                                           void **aResult) {</span>
<a href="#l59.24"></a><span id="l59.24" class="difflineplus">+  if (aOuter) return NS_ERROR_NO_AGGREGATION;</span>
<a href="#l59.25"></a><span id="l59.25"> </span>
<a href="#l59.26"></a><span id="l59.26">   RefPtr&lt;nsImportMailboxDescriptor&gt; it = new nsImportMailboxDescriptor();</span>
<a href="#l59.27"></a><span id="l59.27">   return it-&gt;QueryInterface(aIID, aResult);</span>
<a href="#l59.28"></a><span id="l59.28"> }</span>
<a href="#l59.29"></a><span id="l59.29"> </span>
<a href="#l59.30"></a><span id="l59.30"> NS_IMPL_ISUPPORTS(nsImportMailboxDescriptor, nsIImportMailboxDescriptor)</span>
<a href="#l59.31"></a><span id="l59.31"> </span>
<a href="#l59.32"></a><span id="l59.32" class="difflineminus">-nsImportMailboxDescriptor::nsImportMailboxDescriptor()</span>
<a href="#l59.33"></a><span id="l59.33" class="difflineminus">-{</span>
<a href="#l59.34"></a><span id="l59.34" class="difflineplus">+nsImportMailboxDescriptor::nsImportMailboxDescriptor() {</span>
<a href="#l59.35"></a><span id="l59.35">   m_import = true;</span>
<a href="#l59.36"></a><span id="l59.36">   m_size = 0;</span>
<a href="#l59.37"></a><span id="l59.37">   m_depth = 0;</span>
<a href="#l59.38"></a><span id="l59.38">   m_id = 0;</span>
<a href="#l59.39"></a><span id="l59.39" class="difflineminus">-        m_pFile = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID);</span>
<a href="#l59.40"></a><span id="l59.40" class="difflineplus">+  m_pFile = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID);</span>
<a href="#l59.41"></a><span id="l59.41"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l60.1"></a><span id="l60.1" class="difflineminus">--- a/mailnews/import/src/nsImportMailboxDescriptor.h</span>
<a href="#l60.2"></a><span id="l60.2" class="difflineplus">+++ b/mailnews/import/src/nsImportMailboxDescriptor.h</span>
<a href="#l60.3"></a><span id="l60.3" class="difflineat">@@ -10,54 +10,85 @@</span>
<a href="#l60.4"></a><span id="l60.4"> #include &quot;nscore.h&quot;</span>
<a href="#l60.5"></a><span id="l60.5"> #include &quot;nsString.h&quot;</span>
<a href="#l60.6"></a><span id="l60.6"> #include &quot;nsIImportMailboxDescriptor.h&quot;</span>
<a href="#l60.7"></a><span id="l60.7"> #include &quot;nsIFile.h&quot;</span>
<a href="#l60.8"></a><span id="l60.8"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l60.9"></a><span id="l60.9"> </span>
<a href="#l60.10"></a><span id="l60.10"> ////////////////////////////////////////////////////////////////////////</span>
<a href="#l60.11"></a><span id="l60.11"> </span>
<a href="#l60.12"></a><span id="l60.12" class="difflineminus">-</span>
<a href="#l60.13"></a><span id="l60.13" class="difflineminus">-class nsImportMailboxDescriptor : public nsIImportMailboxDescriptor</span>
<a href="#l60.14"></a><span id="l60.14" class="difflineminus">-{</span>
<a href="#l60.15"></a><span id="l60.15" class="difflineminus">-public:</span>
<a href="#l60.16"></a><span id="l60.16" class="difflineplus">+class nsImportMailboxDescriptor : public nsIImportMailboxDescriptor {</span>
<a href="#l60.17"></a><span id="l60.17" class="difflineplus">+ public:</span>
<a href="#l60.18"></a><span id="l60.18">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l60.19"></a><span id="l60.19"> </span>
<a href="#l60.20"></a><span id="l60.20" class="difflineminus">-  NS_IMETHOD  GetIdentifier(uint32_t *pIdentifier) override { *pIdentifier = m_id; return NS_OK;}</span>
<a href="#l60.21"></a><span id="l60.21" class="difflineminus">-  NS_IMETHOD  SetIdentifier(uint32_t ident) override { m_id = ident; return NS_OK;}</span>
<a href="#l60.22"></a><span id="l60.22" class="difflineplus">+  NS_IMETHOD GetIdentifier(uint32_t *pIdentifier) override {</span>
<a href="#l60.23"></a><span id="l60.23" class="difflineplus">+    *pIdentifier = m_id;</span>
<a href="#l60.24"></a><span id="l60.24" class="difflineplus">+    return NS_OK;</span>
<a href="#l60.25"></a><span id="l60.25" class="difflineplus">+  }</span>
<a href="#l60.26"></a><span id="l60.26" class="difflineplus">+  NS_IMETHOD SetIdentifier(uint32_t ident) override {</span>
<a href="#l60.27"></a><span id="l60.27" class="difflineplus">+    m_id = ident;</span>
<a href="#l60.28"></a><span id="l60.28" class="difflineplus">+    return NS_OK;</span>
<a href="#l60.29"></a><span id="l60.29" class="difflineplus">+  }</span>
<a href="#l60.30"></a><span id="l60.30"> </span>
<a href="#l60.31"></a><span id="l60.31">   /* attribute unsigned long depth; */</span>
<a href="#l60.32"></a><span id="l60.32" class="difflineminus">-  NS_IMETHOD  GetDepth(uint32_t *pDepth) override { *pDepth = m_depth; return NS_OK;}</span>
<a href="#l60.33"></a><span id="l60.33" class="difflineminus">-  NS_IMETHOD  SetDepth(uint32_t theDepth) override { m_depth = theDepth; return NS_OK;}</span>
<a href="#l60.34"></a><span id="l60.34" class="difflineplus">+  NS_IMETHOD GetDepth(uint32_t *pDepth) override {</span>
<a href="#l60.35"></a><span id="l60.35" class="difflineplus">+    *pDepth = m_depth;</span>
<a href="#l60.36"></a><span id="l60.36" class="difflineplus">+    return NS_OK;</span>
<a href="#l60.37"></a><span id="l60.37" class="difflineplus">+  }</span>
<a href="#l60.38"></a><span id="l60.38" class="difflineplus">+  NS_IMETHOD SetDepth(uint32_t theDepth) override {</span>
<a href="#l60.39"></a><span id="l60.39" class="difflineplus">+    m_depth = theDepth;</span>
<a href="#l60.40"></a><span id="l60.40" class="difflineplus">+    return NS_OK;</span>
<a href="#l60.41"></a><span id="l60.41" class="difflineplus">+  }</span>
<a href="#l60.42"></a><span id="l60.42"> </span>
<a href="#l60.43"></a><span id="l60.43">   /* attribute unsigned long size; */</span>
<a href="#l60.44"></a><span id="l60.44" class="difflineminus">-  NS_IMETHOD  GetSize(uint32_t *pSize) override { *pSize = m_size; return NS_OK;}</span>
<a href="#l60.45"></a><span id="l60.45" class="difflineminus">-  NS_IMETHOD  SetSize(uint32_t theSize) override { m_size = theSize; return NS_OK;}</span>
<a href="#l60.46"></a><span id="l60.46" class="difflineplus">+  NS_IMETHOD GetSize(uint32_t *pSize) override {</span>
<a href="#l60.47"></a><span id="l60.47" class="difflineplus">+    *pSize = m_size;</span>
<a href="#l60.48"></a><span id="l60.48" class="difflineplus">+    return NS_OK;</span>
<a href="#l60.49"></a><span id="l60.49" class="difflineplus">+  }</span>
<a href="#l60.50"></a><span id="l60.50" class="difflineplus">+  NS_IMETHOD SetSize(uint32_t theSize) override {</span>
<a href="#l60.51"></a><span id="l60.51" class="difflineplus">+    m_size = theSize;</span>
<a href="#l60.52"></a><span id="l60.52" class="difflineplus">+    return NS_OK;</span>
<a href="#l60.53"></a><span id="l60.53" class="difflineplus">+  }</span>
<a href="#l60.54"></a><span id="l60.54"> </span>
<a href="#l60.55"></a><span id="l60.55">   /* attribute wstring displayName; */</span>
<a href="#l60.56"></a><span id="l60.56" class="difflineminus">-  NS_IMETHOD  GetDisplayName(char16_t **pName) override { *pName = ToNewUnicode(m_displayName); return NS_OK;}</span>
<a href="#l60.57"></a><span id="l60.57" class="difflineminus">-  NS_IMETHOD  SetDisplayName(const char16_t * pName) override { m_displayName = pName; return NS_OK;}</span>
<a href="#l60.58"></a><span id="l60.58" class="difflineplus">+  NS_IMETHOD GetDisplayName(char16_t **pName) override {</span>
<a href="#l60.59"></a><span id="l60.59" class="difflineplus">+    *pName = ToNewUnicode(m_displayName);</span>
<a href="#l60.60"></a><span id="l60.60" class="difflineplus">+    return NS_OK;</span>
<a href="#l60.61"></a><span id="l60.61" class="difflineplus">+  }</span>
<a href="#l60.62"></a><span id="l60.62" class="difflineplus">+  NS_IMETHOD SetDisplayName(const char16_t *pName) override {</span>
<a href="#l60.63"></a><span id="l60.63" class="difflineplus">+    m_displayName = pName;</span>
<a href="#l60.64"></a><span id="l60.64" class="difflineplus">+    return NS_OK;</span>
<a href="#l60.65"></a><span id="l60.65" class="difflineplus">+  }</span>
<a href="#l60.66"></a><span id="l60.66"> </span>
<a href="#l60.67"></a><span id="l60.67">   /* attribute boolean import; */</span>
<a href="#l60.68"></a><span id="l60.68" class="difflineminus">-  NS_IMETHOD  GetImport(bool *pImport) override { *pImport = m_import; return NS_OK;}</span>
<a href="#l60.69"></a><span id="l60.69" class="difflineminus">-  NS_IMETHOD  SetImport(bool doImport) override { m_import = doImport; return NS_OK;}</span>
<a href="#l60.70"></a><span id="l60.70" class="difflineplus">+  NS_IMETHOD GetImport(bool *pImport) override {</span>
<a href="#l60.71"></a><span id="l60.71" class="difflineplus">+    *pImport = m_import;</span>
<a href="#l60.72"></a><span id="l60.72" class="difflineplus">+    return NS_OK;</span>
<a href="#l60.73"></a><span id="l60.73" class="difflineplus">+  }</span>
<a href="#l60.74"></a><span id="l60.74" class="difflineplus">+  NS_IMETHOD SetImport(bool doImport) override {</span>
<a href="#l60.75"></a><span id="l60.75" class="difflineplus">+    m_import = doImport;</span>
<a href="#l60.76"></a><span id="l60.76" class="difflineplus">+    return NS_OK;</span>
<a href="#l60.77"></a><span id="l60.77" class="difflineplus">+  }</span>
<a href="#l60.78"></a><span id="l60.78"> </span>
<a href="#l60.79"></a><span id="l60.79">   /* readonly attribute nsIFile file; */</span>
<a href="#l60.80"></a><span id="l60.80" class="difflineminus">-  NS_IMETHOD GetFile(nsIFile * *aFile) override { if (m_pFile) { NS_ADDREF(*aFile = m_pFile); return NS_OK;} else return NS_ERROR_FAILURE; }</span>
<a href="#l60.81"></a><span id="l60.81" class="difflineminus">-</span>
<a href="#l60.82"></a><span id="l60.82" class="difflineminus">-</span>
<a href="#l60.83"></a><span id="l60.83" class="difflineplus">+  NS_IMETHOD GetFile(nsIFile **aFile) override {</span>
<a href="#l60.84"></a><span id="l60.84" class="difflineplus">+    if (m_pFile) {</span>
<a href="#l60.85"></a><span id="l60.85" class="difflineplus">+      NS_ADDREF(*aFile = m_pFile);</span>
<a href="#l60.86"></a><span id="l60.86" class="difflineplus">+      return NS_OK;</span>
<a href="#l60.87"></a><span id="l60.87" class="difflineplus">+    } else</span>
<a href="#l60.88"></a><span id="l60.88" class="difflineplus">+      return NS_ERROR_FAILURE;</span>
<a href="#l60.89"></a><span id="l60.89" class="difflineplus">+  }</span>
<a href="#l60.90"></a><span id="l60.90"> </span>
<a href="#l60.91"></a><span id="l60.91">   nsImportMailboxDescriptor();</span>
<a href="#l60.92"></a><span id="l60.92"> </span>
<a href="#l60.93"></a><span id="l60.93">   static nsresult Create(nsISupports *aOuter, REFNSIID aIID, void **aResult);</span>
<a href="#l60.94"></a><span id="l60.94"> </span>
<a href="#l60.95"></a><span id="l60.95" class="difflineminus">-private:</span>
<a href="#l60.96"></a><span id="l60.96" class="difflineplus">+ private:</span>
<a href="#l60.97"></a><span id="l60.97">   virtual ~nsImportMailboxDescriptor() {}</span>
<a href="#l60.98"></a><span id="l60.98" class="difflineminus">-  uint32_t    m_id;      // used by creator of the structure</span>
<a href="#l60.99"></a><span id="l60.99" class="difflineminus">-  uint32_t    m_depth;    // depth in the hierarchy</span>
<a href="#l60.100"></a><span id="l60.100" class="difflineminus">-  nsString    m_displayName;// name of this mailbox</span>
<a href="#l60.101"></a><span id="l60.101" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; m_pFile;  // source file (if applicable)</span>
<a href="#l60.102"></a><span id="l60.102" class="difflineminus">-  uint32_t    m_size;</span>
<a href="#l60.103"></a><span id="l60.103" class="difflineminus">-  bool        m_import;    // import it or not?</span>
<a href="#l60.104"></a><span id="l60.104" class="difflineplus">+  uint32_t m_id;              // used by creator of the structure</span>
<a href="#l60.105"></a><span id="l60.105" class="difflineplus">+  uint32_t m_depth;           // depth in the hierarchy</span>
<a href="#l60.106"></a><span id="l60.106" class="difflineplus">+  nsString m_displayName;     // name of this mailbox</span>
<a href="#l60.107"></a><span id="l60.107" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; m_pFile;  // source file (if applicable)</span>
<a href="#l60.108"></a><span id="l60.108" class="difflineplus">+  uint32_t m_size;</span>
<a href="#l60.109"></a><span id="l60.109" class="difflineplus">+  bool m_import;  // import it or not?</span>
<a href="#l60.110"></a><span id="l60.110"> };</span>
<a href="#l60.111"></a><span id="l60.111"> </span>
<a href="#l60.112"></a><span id="l60.112" class="difflineminus">-</span>
<a href="#l60.113"></a><span id="l60.113"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l61.1"></a><span id="l61.1" class="difflineminus">--- a/mailnews/import/src/nsImportMimeEncode.cpp</span>
<a href="#l61.2"></a><span id="l61.2" class="difflineplus">+++ b/mailnews/import/src/nsImportMimeEncode.cpp</span>
<a href="#l61.3"></a><span id="l61.3" class="difflineat">@@ -4,55 +4,48 @@</span>
<a href="#l61.4"></a><span id="l61.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l61.5"></a><span id="l61.5"> </span>
<a href="#l61.6"></a><span id="l61.6"> #include &quot;nscore.h&quot;</span>
<a href="#l61.7"></a><span id="l61.7"> #include &quot;nsImportMimeEncode.h&quot;</span>
<a href="#l61.8"></a><span id="l61.8"> </span>
<a href="#l61.9"></a><span id="l61.9"> #include &quot;ImportCharSet.h&quot;</span>
<a href="#l61.10"></a><span id="l61.10"> #include &quot;ImportTranslate.h&quot;</span>
<a href="#l61.11"></a><span id="l61.11"> </span>
<a href="#l61.12"></a><span id="l61.12" class="difflineminus">-#define  kNoState    0</span>
<a href="#l61.13"></a><span id="l61.13" class="difflineminus">-#define  kStartState    1</span>
<a href="#l61.14"></a><span id="l61.14" class="difflineminus">-#define  kEncodeState  2</span>
<a href="#l61.15"></a><span id="l61.15" class="difflineminus">-#define kDoneState    3</span>
<a href="#l61.16"></a><span id="l61.16" class="difflineplus">+#define kNoState 0</span>
<a href="#l61.17"></a><span id="l61.17" class="difflineplus">+#define kStartState 1</span>
<a href="#l61.18"></a><span id="l61.18" class="difflineplus">+#define kEncodeState 2</span>
<a href="#l61.19"></a><span id="l61.19" class="difflineplus">+#define kDoneState 3</span>
<a href="#l61.20"></a><span id="l61.20"> </span>
<a href="#l61.21"></a><span id="l61.21" class="difflineminus">-#define kEncodeBufferSz  (8192 * 8)</span>
<a href="#l61.22"></a><span id="l61.22" class="difflineplus">+#define kEncodeBufferSz (8192 * 8)</span>
<a href="#l61.23"></a><span id="l61.23"> </span>
<a href="#l61.24"></a><span id="l61.24" class="difflineminus">-nsImportMimeEncode::nsImportMimeEncode()</span>
<a href="#l61.25"></a><span id="l61.25" class="difflineminus">-{</span>
<a href="#l61.26"></a><span id="l61.26" class="difflineplus">+nsImportMimeEncode::nsImportMimeEncode() {</span>
<a href="#l61.27"></a><span id="l61.27">   m_pOut = nullptr;</span>
<a href="#l61.28"></a><span id="l61.28">   m_state = kNoState;</span>
<a href="#l61.29"></a><span id="l61.29">   m_bytesProcessed = 0;</span>
<a href="#l61.30"></a><span id="l61.30">   m_pInputBuf = nullptr;</span>
<a href="#l61.31"></a><span id="l61.31"> }</span>
<a href="#l61.32"></a><span id="l61.32"> </span>
<a href="#l61.33"></a><span id="l61.33" class="difflineminus">-nsImportMimeEncode::~nsImportMimeEncode()</span>
<a href="#l61.34"></a><span id="l61.34" class="difflineminus">-{</span>
<a href="#l61.35"></a><span id="l61.35" class="difflineminus">-  delete [] m_pInputBuf;</span>
<a href="#l61.36"></a><span id="l61.36" class="difflineminus">-}</span>
<a href="#l61.37"></a><span id="l61.37" class="difflineplus">+nsImportMimeEncode::~nsImportMimeEncode() { delete[] m_pInputBuf; }</span>
<a href="#l61.38"></a><span id="l61.38"> </span>
<a href="#l61.39"></a><span id="l61.39" class="difflineminus">-void nsImportMimeEncode::EncodeFile(nsIFile *pInFile, ImportOutFile *pOut, const char *pFileName, const char *pMimeType)</span>
<a href="#l61.40"></a><span id="l61.40" class="difflineminus">-{</span>
<a href="#l61.41"></a><span id="l61.41" class="difflineplus">+void nsImportMimeEncode::EncodeFile(nsIFile *pInFile, ImportOutFile *pOut,</span>
<a href="#l61.42"></a><span id="l61.42" class="difflineplus">+                                    const char *pFileName,</span>
<a href="#l61.43"></a><span id="l61.43" class="difflineplus">+                                    const char *pMimeType) {</span>
<a href="#l61.44"></a><span id="l61.44">   m_fileName = pFileName;</span>
<a href="#l61.45"></a><span id="l61.45">   m_mimeType = pMimeType;</span>
<a href="#l61.46"></a><span id="l61.46"> </span>
<a href="#l61.47"></a><span id="l61.47">   m_pMimeFile = pInFile;</span>
<a href="#l61.48"></a><span id="l61.48"> </span>
<a href="#l61.49"></a><span id="l61.49">   m_pOut = pOut;</span>
<a href="#l61.50"></a><span id="l61.50">   m_state = kStartState;</span>
<a href="#l61.51"></a><span id="l61.51"> }</span>
<a href="#l61.52"></a><span id="l61.52"> </span>
<a href="#l61.53"></a><span id="l61.53" class="difflineminus">-void nsImportMimeEncode::CleanUp(void)</span>
<a href="#l61.54"></a><span id="l61.54" class="difflineminus">-{</span>
<a href="#l61.55"></a><span id="l61.55" class="difflineminus">-  CleanUpEncodeScan();</span>
<a href="#l61.56"></a><span id="l61.56" class="difflineminus">-}</span>
<a href="#l61.57"></a><span id="l61.57" class="difflineplus">+void nsImportMimeEncode::CleanUp(void) { CleanUpEncodeScan(); }</span>
<a href="#l61.58"></a><span id="l61.58"> </span>
<a href="#l61.59"></a><span id="l61.59" class="difflineminus">-bool nsImportMimeEncode::SetUpEncode(void)</span>
<a href="#l61.60"></a><span id="l61.60" class="difflineminus">-{</span>
<a href="#l61.61"></a><span id="l61.61" class="difflineminus">-  nsCString    errStr;</span>
<a href="#l61.62"></a><span id="l61.62" class="difflineplus">+bool nsImportMimeEncode::SetUpEncode(void) {</span>
<a href="#l61.63"></a><span id="l61.63" class="difflineplus">+  nsCString errStr;</span>
<a href="#l61.64"></a><span id="l61.64">   if (!m_pInputBuf) {</span>
<a href="#l61.65"></a><span id="l61.65">     m_pInputBuf = new uint8_t[kEncodeBufferSz];</span>
<a href="#l61.66"></a><span id="l61.66">   }</span>
<a href="#l61.67"></a><span id="l61.67"> </span>
<a href="#l61.68"></a><span id="l61.68">   m_appleSingle = false;</span>
<a href="#l61.69"></a><span id="l61.69"> </span>
<a href="#l61.70"></a><span id="l61.70"> #ifdef _MAC_IMPORT_CODE</span>
<a href="#l61.71"></a><span id="l61.71">   // First let's see just what kind of beast we have?</span>
<a href="#l61.72"></a><span id="l61.72" class="difflineat">@@ -61,351 +54,314 @@ bool nsImportMimeEncode::SetUpEncode(voi</span>
<a href="#l61.73"></a><span id="l61.73">   // For unknown mime types and files with both forks,</span>
<a href="#l61.74"></a><span id="l61.74">   // encode as AppleSingle format.</span>
<a href="#l61.75"></a><span id="l61.75">   if (m_filePath.GetMacFileSize(UFileLocation::eResourceFork) || !pMimeType) {</span>
<a href="#l61.76"></a><span id="l61.76">     m_appleSingle = TRUE;</span>
<a href="#l61.77"></a><span id="l61.77">     m_mimeType = &quot;application/applefile&quot;;</span>
<a href="#l61.78"></a><span id="l61.78">   }</span>
<a href="#l61.79"></a><span id="l61.79"> #endif</span>
<a href="#l61.80"></a><span id="l61.80"> </span>
<a href="#l61.81"></a><span id="l61.81" class="difflineminus">-  if (!InitEncodeScan(m_appleSingle, m_pMimeFile, m_fileName.get(), m_pInputBuf, kEncodeBufferSz)) {</span>
<a href="#l61.82"></a><span id="l61.82" class="difflineplus">+  if (!InitEncodeScan(m_appleSingle, m_pMimeFile, m_fileName.get(), m_pInputBuf,</span>
<a href="#l61.83"></a><span id="l61.83" class="difflineplus">+                      kEncodeBufferSz)) {</span>
<a href="#l61.84"></a><span id="l61.84">     return false;</span>
<a href="#l61.85"></a><span id="l61.85">   }</span>
<a href="#l61.86"></a><span id="l61.86"> </span>
<a href="#l61.87"></a><span id="l61.87">   m_state = kEncodeState;</span>
<a href="#l61.88"></a><span id="l61.88">   m_lineLen = 0;</span>
<a href="#l61.89"></a><span id="l61.89"> </span>
<a href="#l61.90"></a><span id="l61.90">   // Write out the boundary header</span>
<a href="#l61.91"></a><span id="l61.91">   bool bResult = true;</span>
<a href="#l61.92"></a><span id="l61.92">   bResult = m_pOut-&gt;WriteStr(&quot;Content-type: &quot;);</span>
<a href="#l61.93"></a><span id="l61.93" class="difflineminus">-  if (bResult)</span>
<a href="#l61.94"></a><span id="l61.94" class="difflineminus">-    bResult = m_pOut-&gt;WriteStr(m_mimeType.get());</span>
<a href="#l61.95"></a><span id="l61.95" class="difflineplus">+  if (bResult) bResult = m_pOut-&gt;WriteStr(m_mimeType.get());</span>
<a href="#l61.96"></a><span id="l61.96"> </span>
<a href="#l61.97"></a><span id="l61.97"> #ifdef _MAC_IMPORT_CODE</span>
<a href="#l61.98"></a><span id="l61.98">   // include the type an creator here</span>
<a href="#l61.99"></a><span id="l61.99" class="difflineminus">-  if (bResult)</span>
<a href="#l61.100"></a><span id="l61.100" class="difflineminus">-    bResult = m_pOut-&gt;WriteStr(&quot;; x-mac-type=\&quot;&quot;);</span>
<a href="#l61.101"></a><span id="l61.101" class="difflineminus">-  U8  hex[8];</span>
<a href="#l61.102"></a><span id="l61.102" class="difflineplus">+  if (bResult) bResult = m_pOut-&gt;WriteStr(&quot;; x-mac-type=\&quot;&quot;);</span>
<a href="#l61.103"></a><span id="l61.103" class="difflineplus">+  U8 hex[8];</span>
<a href="#l61.104"></a><span id="l61.104">   LongToHexBytes(m_filePath.GetFileType(), hex);</span>
<a href="#l61.105"></a><span id="l61.105" class="difflineminus">-  if (bResult)</span>
<a href="#l61.106"></a><span id="l61.106" class="difflineminus">-    bResult = m_pOut-&gt;WriteData(hex, 8);</span>
<a href="#l61.107"></a><span id="l61.107" class="difflineplus">+  if (bResult) bResult = m_pOut-&gt;WriteData(hex, 8);</span>
<a href="#l61.108"></a><span id="l61.108">   LongToHexBytes(m_filePath.GetFileCreator(), hex);</span>
<a href="#l61.109"></a><span id="l61.109" class="difflineminus">-  if (bResult)</span>
<a href="#l61.110"></a><span id="l61.110" class="difflineminus">-    bResult = m_pOut-&gt;WriteStr(&quot;\&quot;; x-mac-creator=\&quot;&quot;);</span>
<a href="#l61.111"></a><span id="l61.111" class="difflineminus">-  if (bResult)</span>
<a href="#l61.112"></a><span id="l61.112" class="difflineminus">-    bResult = m_pOut-&gt;WriteData(hex, 8);</span>
<a href="#l61.113"></a><span id="l61.113" class="difflineminus">-  if (bResult)</span>
<a href="#l61.114"></a><span id="l61.114" class="difflineminus">-    bResult = m_pOut-&gt;WriteStr(&quot;\&quot;&quot;);</span>
<a href="#l61.115"></a><span id="l61.115" class="difflineplus">+  if (bResult) bResult = m_pOut-&gt;WriteStr(&quot;\&quot;; x-mac-creator=\&quot;&quot;);</span>
<a href="#l61.116"></a><span id="l61.116" class="difflineplus">+  if (bResult) bResult = m_pOut-&gt;WriteData(hex, 8);</span>
<a href="#l61.117"></a><span id="l61.117" class="difflineplus">+  if (bResult) bResult = m_pOut-&gt;WriteStr(&quot;\&quot;&quot;);</span>
<a href="#l61.118"></a><span id="l61.118"> #endif</span>
<a href="#l61.119"></a><span id="l61.119"> </span>
<a href="#l61.120"></a><span id="l61.120">   /*</span>
<a href="#l61.121"></a><span id="l61.121">   if (bResult)</span>
<a href="#l61.122"></a><span id="l61.122">     bResult = m_pOut-&gt;WriteStr(gMimeTypeFileName);</span>
<a href="#l61.123"></a><span id="l61.123">   */</span>
<a href="#l61.124"></a><span id="l61.124" class="difflineminus">-  if (bResult)</span>
<a href="#l61.125"></a><span id="l61.125" class="difflineminus">-    bResult = m_pOut-&gt;WriteStr(&quot;;\x0D\x0A&quot;);</span>
<a href="#l61.126"></a><span id="l61.126" class="difflineplus">+  if (bResult) bResult = m_pOut-&gt;WriteStr(&quot;;\x0D\x0A&quot;);</span>
<a href="#l61.127"></a><span id="l61.127"> </span>
<a href="#l61.128"></a><span id="l61.128" class="difflineminus">-  nsCString    fName;</span>
<a href="#l61.129"></a><span id="l61.129" class="difflineminus">-  bool        trans = TranslateFileName(m_fileName, fName);</span>
<a href="#l61.130"></a><span id="l61.130" class="difflineminus">-  if (bResult)</span>
<a href="#l61.131"></a><span id="l61.131" class="difflineminus">-    bResult = WriteFileName(fName, trans, &quot;name&quot;);</span>
<a href="#l61.132"></a><span id="l61.132" class="difflineminus">-  if (bResult)</span>
<a href="#l61.133"></a><span id="l61.133" class="difflineminus">-    bResult = m_pOut-&gt;WriteStr(&quot;Content-transfer-encoding: base64&quot;);</span>
<a href="#l61.134"></a><span id="l61.134" class="difflineminus">-  if (bResult)</span>
<a href="#l61.135"></a><span id="l61.135" class="difflineminus">-    bResult = m_pOut-&gt;WriteEol();</span>
<a href="#l61.136"></a><span id="l61.136" class="difflineplus">+  nsCString fName;</span>
<a href="#l61.137"></a><span id="l61.137" class="difflineplus">+  bool trans = TranslateFileName(m_fileName, fName);</span>
<a href="#l61.138"></a><span id="l61.138" class="difflineplus">+  if (bResult) bResult = WriteFileName(fName, trans, &quot;name&quot;);</span>
<a href="#l61.139"></a><span id="l61.139" class="difflineplus">+  if (bResult) bResult = m_pOut-&gt;WriteStr(&quot;Content-transfer-encoding: base64&quot;);</span>
<a href="#l61.140"></a><span id="l61.140" class="difflineplus">+  if (bResult) bResult = m_pOut-&gt;WriteEol();</span>
<a href="#l61.141"></a><span id="l61.141">   if (bResult)</span>
<a href="#l61.142"></a><span id="l61.142">     bResult = m_pOut-&gt;WriteStr(&quot;Content-Disposition: attachment;\x0D\x0A&quot;);</span>
<a href="#l61.143"></a><span id="l61.143" class="difflineminus">-  if (bResult)</span>
<a href="#l61.144"></a><span id="l61.144" class="difflineminus">-    bResult = WriteFileName(fName, trans, &quot;filename&quot;);</span>
<a href="#l61.145"></a><span id="l61.145" class="difflineminus">-  if (bResult)</span>
<a href="#l61.146"></a><span id="l61.146" class="difflineminus">-    bResult = m_pOut-&gt;WriteEol();</span>
<a href="#l61.147"></a><span id="l61.147" class="difflineplus">+  if (bResult) bResult = WriteFileName(fName, trans, &quot;filename&quot;);</span>
<a href="#l61.148"></a><span id="l61.148" class="difflineplus">+  if (bResult) bResult = m_pOut-&gt;WriteEol();</span>
<a href="#l61.149"></a><span id="l61.149"> </span>
<a href="#l61.150"></a><span id="l61.150">   if (!bResult) {</span>
<a href="#l61.151"></a><span id="l61.151">     CleanUp();</span>
<a href="#l61.152"></a><span id="l61.152">   }</span>
<a href="#l61.153"></a><span id="l61.153"> </span>
<a href="#l61.154"></a><span id="l61.154">   return bResult;</span>
<a href="#l61.155"></a><span id="l61.155"> }</span>
<a href="#l61.156"></a><span id="l61.156"> </span>
<a href="#l61.157"></a><span id="l61.157" class="difflineminus">-bool nsImportMimeEncode::DoWork(bool *pDone)</span>
<a href="#l61.158"></a><span id="l61.158" class="difflineminus">-{</span>
<a href="#l61.159"></a><span id="l61.159" class="difflineplus">+bool nsImportMimeEncode::DoWork(bool *pDone) {</span>
<a href="#l61.160"></a><span id="l61.160">   *pDone = false;</span>
<a href="#l61.161"></a><span id="l61.161" class="difflineminus">-  switch(m_state) {</span>
<a href="#l61.162"></a><span id="l61.162" class="difflineminus">-  case kNoState:</span>
<a href="#l61.163"></a><span id="l61.163" class="difflineminus">-    return false;</span>
<a href="#l61.164"></a><span id="l61.164" class="difflineminus">-    break;</span>
<a href="#l61.165"></a><span id="l61.165" class="difflineminus">-  case kStartState:</span>
<a href="#l61.166"></a><span id="l61.166" class="difflineminus">-    return SetUpEncode();</span>
<a href="#l61.167"></a><span id="l61.167" class="difflineminus">-    break;</span>
<a href="#l61.168"></a><span id="l61.168" class="difflineminus">-  case kEncodeState:</span>
<a href="#l61.169"></a><span id="l61.169" class="difflineminus">-    if (!Scan(pDone)) {</span>
<a href="#l61.170"></a><span id="l61.170" class="difflineplus">+  switch (m_state) {</span>
<a href="#l61.171"></a><span id="l61.171" class="difflineplus">+    case kNoState:</span>
<a href="#l61.172"></a><span id="l61.172" class="difflineplus">+      return false;</span>
<a href="#l61.173"></a><span id="l61.173" class="difflineplus">+      break;</span>
<a href="#l61.174"></a><span id="l61.174" class="difflineplus">+    case kStartState:</span>
<a href="#l61.175"></a><span id="l61.175" class="difflineplus">+      return SetUpEncode();</span>
<a href="#l61.176"></a><span id="l61.176" class="difflineplus">+      break;</span>
<a href="#l61.177"></a><span id="l61.177" class="difflineplus">+    case kEncodeState:</span>
<a href="#l61.178"></a><span id="l61.178" class="difflineplus">+      if (!Scan(pDone)) {</span>
<a href="#l61.179"></a><span id="l61.179" class="difflineplus">+        CleanUp();</span>
<a href="#l61.180"></a><span id="l61.180" class="difflineplus">+        return false;</span>
<a href="#l61.181"></a><span id="l61.181" class="difflineplus">+      }</span>
<a href="#l61.182"></a><span id="l61.182" class="difflineplus">+      if (*pDone) {</span>
<a href="#l61.183"></a><span id="l61.183" class="difflineplus">+        *pDone = false;</span>
<a href="#l61.184"></a><span id="l61.184" class="difflineplus">+        m_state = kDoneState;</span>
<a href="#l61.185"></a><span id="l61.185" class="difflineplus">+      }</span>
<a href="#l61.186"></a><span id="l61.186" class="difflineplus">+      break;</span>
<a href="#l61.187"></a><span id="l61.187" class="difflineplus">+    case kDoneState:</span>
<a href="#l61.188"></a><span id="l61.188">       CleanUp();</span>
<a href="#l61.189"></a><span id="l61.189" class="difflineminus">-      return false;</span>
<a href="#l61.190"></a><span id="l61.190" class="difflineminus">-    }</span>
<a href="#l61.191"></a><span id="l61.191" class="difflineminus">-    if (*pDone) {</span>
<a href="#l61.192"></a><span id="l61.192" class="difflineminus">-      *pDone = false;</span>
<a href="#l61.193"></a><span id="l61.193" class="difflineminus">-      m_state = kDoneState;</span>
<a href="#l61.194"></a><span id="l61.194" class="difflineminus">-    }</span>
<a href="#l61.195"></a><span id="l61.195" class="difflineminus">-    break;</span>
<a href="#l61.196"></a><span id="l61.196" class="difflineminus">-  case kDoneState:</span>
<a href="#l61.197"></a><span id="l61.197" class="difflineminus">-    CleanUp();</span>
<a href="#l61.198"></a><span id="l61.198" class="difflineminus">-    m_state = kNoState;</span>
<a href="#l61.199"></a><span id="l61.199" class="difflineminus">-    *pDone = true;</span>
<a href="#l61.200"></a><span id="l61.200" class="difflineminus">-    break;</span>
<a href="#l61.201"></a><span id="l61.201" class="difflineplus">+      m_state = kNoState;</span>
<a href="#l61.202"></a><span id="l61.202" class="difflineplus">+      *pDone = true;</span>
<a href="#l61.203"></a><span id="l61.203" class="difflineplus">+      break;</span>
<a href="#l61.204"></a><span id="l61.204">   }</span>
<a href="#l61.205"></a><span id="l61.205"> </span>
<a href="#l61.206"></a><span id="l61.206">   return true;</span>
<a href="#l61.207"></a><span id="l61.207"> }</span>
<a href="#l61.208"></a><span id="l61.208"> </span>
<a href="#l61.209"></a><span id="l61.209" class="difflineminus">-static uint8_t gBase64[] = &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;;</span>
<a href="#l61.210"></a><span id="l61.210" class="difflineminus">-</span>
<a href="#l61.211"></a><span id="l61.211" class="difflineminus">-bool nsImportMimeEncode::ScanBuffer(bool *pDone)</span>
<a href="#l61.212"></a><span id="l61.212" class="difflineminus">-{</span>
<a href="#l61.213"></a><span id="l61.213" class="difflineplus">+static uint8_t gBase64[] =</span>
<a href="#l61.214"></a><span id="l61.214" class="difflineplus">+    &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;;</span>
<a href="#l61.215"></a><span id="l61.215"> </span>
<a href="#l61.216"></a><span id="l61.216" class="difflineminus">-  uint32_t  pos = m_pos;</span>
<a href="#l61.217"></a><span id="l61.217" class="difflineminus">-  uint32_t  start = pos;</span>
<a href="#l61.218"></a><span id="l61.218" class="difflineminus">-  uint8_t *  pChar = m_pBuf + pos;</span>
<a href="#l61.219"></a><span id="l61.219" class="difflineminus">-  uint32_t  max = m_bytesInBuf;</span>
<a href="#l61.220"></a><span id="l61.220" class="difflineminus">-  uint8_t    byte[4];</span>
<a href="#l61.221"></a><span id="l61.221" class="difflineminus">-  uint32_t  lineLen = m_lineLen;</span>
<a href="#l61.222"></a><span id="l61.222" class="difflineplus">+bool nsImportMimeEncode::ScanBuffer(bool *pDone) {</span>
<a href="#l61.223"></a><span id="l61.223" class="difflineplus">+  uint32_t pos = m_pos;</span>
<a href="#l61.224"></a><span id="l61.224" class="difflineplus">+  uint32_t start = pos;</span>
<a href="#l61.225"></a><span id="l61.225" class="difflineplus">+  uint8_t *pChar = m_pBuf + pos;</span>
<a href="#l61.226"></a><span id="l61.226" class="difflineplus">+  uint32_t max = m_bytesInBuf;</span>
<a href="#l61.227"></a><span id="l61.227" class="difflineplus">+  uint8_t byte[4];</span>
<a href="#l61.228"></a><span id="l61.228" class="difflineplus">+  uint32_t lineLen = m_lineLen;</span>
<a href="#l61.229"></a><span id="l61.229"> </span>
<a href="#l61.230"></a><span id="l61.230">   while ((pos + 2) &lt; max) {</span>
<a href="#l61.231"></a><span id="l61.231">     // Encode 3 bytes</span>
<a href="#l61.232"></a><span id="l61.232">     byte[0] = gBase64[*pChar &gt;&gt; 2];</span>
<a href="#l61.233"></a><span id="l61.233" class="difflineminus">-    byte[1] = gBase64[(((*pChar) &amp; 0x3)&lt;&lt; 4) | (((*(pChar + 1)) &amp; 0xF0) &gt;&gt; 4)];</span>
<a href="#l61.234"></a><span id="l61.234" class="difflineplus">+    byte[1] = gBase64[(((*pChar) &amp; 0x3) &lt;&lt; 4) | (((*(pChar + 1)) &amp; 0xF0) &gt;&gt; 4)];</span>
<a href="#l61.235"></a><span id="l61.235">     pChar++;</span>
<a href="#l61.236"></a><span id="l61.236" class="difflineminus">-    byte[2] = gBase64[(((*pChar) &amp; 0xF) &lt;&lt; 2) | (((*(pChar + 1)) &amp; 0xC0) &gt;&gt;6)];</span>
<a href="#l61.237"></a><span id="l61.237" class="difflineplus">+    byte[2] = gBase64[(((*pChar) &amp; 0xF) &lt;&lt; 2) | (((*(pChar + 1)) &amp; 0xC0) &gt;&gt; 6)];</span>
<a href="#l61.238"></a><span id="l61.238">     pChar++;</span>
<a href="#l61.239"></a><span id="l61.239">     byte[3] = gBase64[(*pChar) &amp; 0x3F];</span>
<a href="#l61.240"></a><span id="l61.240" class="difflineminus">-    if (!m_pOut-&gt;WriteData(byte, 4))</span>
<a href="#l61.241"></a><span id="l61.241" class="difflineminus">-      return false;</span>
<a href="#l61.242"></a><span id="l61.242" class="difflineplus">+    if (!m_pOut-&gt;WriteData(byte, 4)) return false;</span>
<a href="#l61.243"></a><span id="l61.243">     pos += 3;</span>
<a href="#l61.244"></a><span id="l61.244">     pChar++;</span>
<a href="#l61.245"></a><span id="l61.245">     lineLen += 4;</span>
<a href="#l61.246"></a><span id="l61.246">     if (lineLen &gt; 71) {</span>
<a href="#l61.247"></a><span id="l61.247" class="difflineminus">-      if (!m_pOut-&gt;WriteEol())</span>
<a href="#l61.248"></a><span id="l61.248" class="difflineminus">-        return false;</span>
<a href="#l61.249"></a><span id="l61.249" class="difflineplus">+      if (!m_pOut-&gt;WriteEol()) return false;</span>
<a href="#l61.250"></a><span id="l61.250">       lineLen = 0;</span>
<a href="#l61.251"></a><span id="l61.251">     }</span>
<a href="#l61.252"></a><span id="l61.252">   }</span>
<a href="#l61.253"></a><span id="l61.253"> </span>
<a href="#l61.254"></a><span id="l61.254">   if ((pos &lt; max) &amp;&amp; m_eof) {</span>
<a href="#l61.255"></a><span id="l61.255">     // Get the last few bytes!</span>
<a href="#l61.256"></a><span id="l61.256">     byte[0] = gBase64[*pChar &gt;&gt; 2];</span>
<a href="#l61.257"></a><span id="l61.257">     pos++;</span>
<a href="#l61.258"></a><span id="l61.258">     if (pos &lt; max) {</span>
<a href="#l61.259"></a><span id="l61.259" class="difflineminus">-      byte[1] = gBase64[(((*pChar) &amp; 0x3)&lt;&lt; 4) | (((*(pChar + 1)) &amp; 0xF0) &gt;&gt; 4)];</span>
<a href="#l61.260"></a><span id="l61.260" class="difflineplus">+      byte[1] =</span>
<a href="#l61.261"></a><span id="l61.261" class="difflineplus">+          gBase64[(((*pChar) &amp; 0x3) &lt;&lt; 4) | (((*(pChar + 1)) &amp; 0xF0) &gt;&gt; 4)];</span>
<a href="#l61.262"></a><span id="l61.262">       pChar++;</span>
<a href="#l61.263"></a><span id="l61.263">       pos++;</span>
<a href="#l61.264"></a><span id="l61.264">       if (pos &lt; max) {</span>
<a href="#l61.265"></a><span id="l61.265">         // Should be dead code!! (Then why is it here doofus?)</span>
<a href="#l61.266"></a><span id="l61.266" class="difflineminus">-        byte[2] = gBase64[(((*pChar) &amp; 0xF) &lt;&lt; 2) | (((*(pChar + 1)) &amp; 0xC0) &gt;&gt;6)];</span>
<a href="#l61.267"></a><span id="l61.267" class="difflineplus">+        byte[2] =</span>
<a href="#l61.268"></a><span id="l61.268" class="difflineplus">+            gBase64[(((*pChar) &amp; 0xF) &lt;&lt; 2) | (((*(pChar + 1)) &amp; 0xC0) &gt;&gt; 6)];</span>
<a href="#l61.269"></a><span id="l61.269">         pChar++;</span>
<a href="#l61.270"></a><span id="l61.270">         byte[3] = gBase64[(*pChar) &amp; 0x3F];</span>
<a href="#l61.271"></a><span id="l61.271">         pos++;</span>
<a href="#l61.272"></a><span id="l61.272" class="difflineminus">-      }</span>
<a href="#l61.273"></a><span id="l61.273" class="difflineminus">-      else {</span>
<a href="#l61.274"></a><span id="l61.274" class="difflineplus">+      } else {</span>
<a href="#l61.275"></a><span id="l61.275">         byte[2] = gBase64[(((*pChar) &amp; 0xF) &lt;&lt; 2)];</span>
<a href="#l61.276"></a><span id="l61.276">         byte[3] = '=';</span>
<a href="#l61.277"></a><span id="l61.277">       }</span>
<a href="#l61.278"></a><span id="l61.278" class="difflineminus">-    }</span>
<a href="#l61.279"></a><span id="l61.279" class="difflineminus">-    else {</span>
<a href="#l61.280"></a><span id="l61.280" class="difflineminus">-      byte[1] = gBase64[(((*pChar) &amp; 0x3)&lt;&lt; 4)];</span>
<a href="#l61.281"></a><span id="l61.281" class="difflineplus">+    } else {</span>
<a href="#l61.282"></a><span id="l61.282" class="difflineplus">+      byte[1] = gBase64[(((*pChar) &amp; 0x3) &lt;&lt; 4)];</span>
<a href="#l61.283"></a><span id="l61.283">       byte[2] = '=';</span>
<a href="#l61.284"></a><span id="l61.284">       byte[3] = '=';</span>
<a href="#l61.285"></a><span id="l61.285">     }</span>
<a href="#l61.286"></a><span id="l61.286"> </span>
<a href="#l61.287"></a><span id="l61.287" class="difflineminus">-    if (!m_pOut-&gt;WriteData(byte, 4))</span>
<a href="#l61.288"></a><span id="l61.288" class="difflineminus">-      return false;</span>
<a href="#l61.289"></a><span id="l61.289" class="difflineminus">-    if (!m_pOut-&gt;WriteEol())</span>
<a href="#l61.290"></a><span id="l61.290" class="difflineminus">-      return false;</span>
<a href="#l61.291"></a><span id="l61.291" class="difflineminus">-  }</span>
<a href="#l61.292"></a><span id="l61.292" class="difflineminus">-  else if (m_eof) {</span>
<a href="#l61.293"></a><span id="l61.293" class="difflineplus">+    if (!m_pOut-&gt;WriteData(byte, 4)) return false;</span>
<a href="#l61.294"></a><span id="l61.294" class="difflineplus">+    if (!m_pOut-&gt;WriteEol()) return false;</span>
<a href="#l61.295"></a><span id="l61.295" class="difflineplus">+  } else if (m_eof) {</span>
<a href="#l61.296"></a><span id="l61.296">     /*</span>
<a href="#l61.297"></a><span id="l61.297">     byte[0] = '=';</span>
<a href="#l61.298"></a><span id="l61.298">     if (!m_pOut-&gt;WriteData(byte, 1))</span>
<a href="#l61.299"></a><span id="l61.299">       return FALSE;</span>
<a href="#l61.300"></a><span id="l61.300">     */</span>
<a href="#l61.301"></a><span id="l61.301" class="difflineminus">-    if (!m_pOut-&gt;WriteEol())</span>
<a href="#l61.302"></a><span id="l61.302" class="difflineminus">-      return false;</span>
<a href="#l61.303"></a><span id="l61.303" class="difflineplus">+    if (!m_pOut-&gt;WriteEol()) return false;</span>
<a href="#l61.304"></a><span id="l61.304">   }</span>
<a href="#l61.305"></a><span id="l61.305"> </span>
<a href="#l61.306"></a><span id="l61.306" class="difflineminus">-  m_lineLen = (int) lineLen;</span>
<a href="#l61.307"></a><span id="l61.307" class="difflineplus">+  m_lineLen = (int)lineLen;</span>
<a href="#l61.308"></a><span id="l61.308">   m_pos = pos;</span>
<a href="#l61.309"></a><span id="l61.309">   m_bytesProcessed += (pos - start);</span>
<a href="#l61.310"></a><span id="l61.310">   return true;</span>
<a href="#l61.311"></a><span id="l61.311"> }</span>
<a href="#l61.312"></a><span id="l61.312"> </span>
<a href="#l61.313"></a><span id="l61.313" class="difflineminus">-bool nsImportMimeEncode::TranslateFileName(nsCString&amp; inFile, nsCString&amp; outFile)</span>
<a href="#l61.314"></a><span id="l61.314" class="difflineminus">-{</span>
<a href="#l61.315"></a><span id="l61.315" class="difflineminus">-  const uint8_t * pIn = (const uint8_t *) inFile.get();</span>
<a href="#l61.316"></a><span id="l61.316" class="difflineminus">-  int    len = inFile.Length();</span>
<a href="#l61.317"></a><span id="l61.317" class="difflineplus">+bool nsImportMimeEncode::TranslateFileName(nsCString &amp;inFile,</span>
<a href="#l61.318"></a><span id="l61.318" class="difflineplus">+                                           nsCString &amp;outFile) {</span>
<a href="#l61.319"></a><span id="l61.319" class="difflineplus">+  const uint8_t *pIn = (const uint8_t *)inFile.get();</span>
<a href="#l61.320"></a><span id="l61.320" class="difflineplus">+  int len = inFile.Length();</span>
<a href="#l61.321"></a><span id="l61.321"> </span>
<a href="#l61.322"></a><span id="l61.322">   while (len) {</span>
<a href="#l61.323"></a><span id="l61.323" class="difflineminus">-    if (!ImportCharSet::IsUSAscii(*pIn))</span>
<a href="#l61.324"></a><span id="l61.324" class="difflineminus">-      break;</span>
<a href="#l61.325"></a><span id="l61.325" class="difflineplus">+    if (!ImportCharSet::IsUSAscii(*pIn)) break;</span>
<a href="#l61.326"></a><span id="l61.326">     len--;</span>
<a href="#l61.327"></a><span id="l61.327">     pIn++;</span>
<a href="#l61.328"></a><span id="l61.328">   }</span>
<a href="#l61.329"></a><span id="l61.329">   if (len) {</span>
<a href="#l61.330"></a><span id="l61.330">     // non US ascii!</span>
<a href="#l61.331"></a><span id="l61.331">     // assume this string needs translating...</span>
<a href="#l61.332"></a><span id="l61.332">     if (!ImportTranslate::ConvertString(inFile, outFile, true)) {</span>
<a href="#l61.333"></a><span id="l61.333">       outFile = inFile;</span>
<a href="#l61.334"></a><span id="l61.334">       return false;</span>
<a href="#l61.335"></a><span id="l61.335" class="difflineminus">-    }</span>
<a href="#l61.336"></a><span id="l61.336" class="difflineminus">-    else {</span>
<a href="#l61.337"></a><span id="l61.337" class="difflineplus">+    } else {</span>
<a href="#l61.338"></a><span id="l61.338">       return true;</span>
<a href="#l61.339"></a><span id="l61.339">     }</span>
<a href="#l61.340"></a><span id="l61.340" class="difflineminus">-  }</span>
<a href="#l61.341"></a><span id="l61.341" class="difflineminus">-  else {</span>
<a href="#l61.342"></a><span id="l61.342" class="difflineplus">+  } else {</span>
<a href="#l61.343"></a><span id="l61.343">     outFile = inFile;</span>
<a href="#l61.344"></a><span id="l61.344">     return false;</span>
<a href="#l61.345"></a><span id="l61.345">   }</span>
<a href="#l61.346"></a><span id="l61.346"> }</span>
<a href="#l61.347"></a><span id="l61.347"> </span>
<a href="#l61.348"></a><span id="l61.348" class="difflineminus">-bool nsImportMimeEncode::WriteFileName(nsCString&amp; fName, bool wasTrans, const char *pTag)</span>
<a href="#l61.349"></a><span id="l61.349" class="difflineminus">-{</span>
<a href="#l61.350"></a><span id="l61.350" class="difflineminus">-  int      tagNum = 0;</span>
<a href="#l61.351"></a><span id="l61.351" class="difflineminus">-  int      idx = 0;</span>
<a href="#l61.352"></a><span id="l61.352" class="difflineminus">-  bool      result = true;</span>
<a href="#l61.353"></a><span id="l61.353" class="difflineminus">-  int      len;</span>
<a href="#l61.354"></a><span id="l61.354" class="difflineminus">-  nsCString  numStr;</span>
<a href="#l61.355"></a><span id="l61.355" class="difflineplus">+bool nsImportMimeEncode::WriteFileName(nsCString &amp;fName, bool wasTrans,</span>
<a href="#l61.356"></a><span id="l61.356" class="difflineplus">+                                       const char *pTag) {</span>
<a href="#l61.357"></a><span id="l61.357" class="difflineplus">+  int tagNum = 0;</span>
<a href="#l61.358"></a><span id="l61.358" class="difflineplus">+  int idx = 0;</span>
<a href="#l61.359"></a><span id="l61.359" class="difflineplus">+  bool result = true;</span>
<a href="#l61.360"></a><span id="l61.360" class="difflineplus">+  int len;</span>
<a href="#l61.361"></a><span id="l61.361" class="difflineplus">+  nsCString numStr;</span>
<a href="#l61.362"></a><span id="l61.362"> </span>
<a href="#l61.363"></a><span id="l61.363">   while ((((fName.Length() - idx) + strlen(pTag)) &gt; 70) &amp;&amp; result) {</span>
<a href="#l61.364"></a><span id="l61.364">     len = 68 - strlen(pTag) - 5;</span>
<a href="#l61.365"></a><span id="l61.365">     if (wasTrans) {</span>
<a href="#l61.366"></a><span id="l61.366">       if (fName.CharAt(idx + len - 1) == '%')</span>
<a href="#l61.367"></a><span id="l61.367">         len--;</span>
<a href="#l61.368"></a><span id="l61.368">       else if (fName.CharAt(idx + len - 2) == '%')</span>
<a href="#l61.369"></a><span id="l61.369">         len -= 2;</span>
<a href="#l61.370"></a><span id="l61.370">     }</span>
<a href="#l61.371"></a><span id="l61.371"> </span>
<a href="#l61.372"></a><span id="l61.372" class="difflineminus">-    if (result)</span>
<a href="#l61.373"></a><span id="l61.373" class="difflineminus">-      result = m_pOut-&gt;WriteStr(&quot;\x09&quot;);</span>
<a href="#l61.374"></a><span id="l61.374" class="difflineminus">-    if (result)</span>
<a href="#l61.375"></a><span id="l61.375" class="difflineminus">-      result = m_pOut-&gt;WriteStr(pTag);</span>
<a href="#l61.376"></a><span id="l61.376" class="difflineplus">+    if (result) result = m_pOut-&gt;WriteStr(&quot;\x09&quot;);</span>
<a href="#l61.377"></a><span id="l61.377" class="difflineplus">+    if (result) result = m_pOut-&gt;WriteStr(pTag);</span>
<a href="#l61.378"></a><span id="l61.378">     numStr = &quot;*&quot;;</span>
<a href="#l61.379"></a><span id="l61.379">     numStr.AppendInt(tagNum);</span>
<a href="#l61.380"></a><span id="l61.380" class="difflineminus">-    if (result)</span>
<a href="#l61.381"></a><span id="l61.381" class="difflineminus">-      result = m_pOut-&gt;WriteStr(numStr.get());</span>
<a href="#l61.382"></a><span id="l61.382" class="difflineplus">+    if (result) result = m_pOut-&gt;WriteStr(numStr.get());</span>
<a href="#l61.383"></a><span id="l61.383">     if (wasTrans &amp;&amp; result)</span>
<a href="#l61.384"></a><span id="l61.384">       result = m_pOut-&gt;WriteStr(&quot;*=&quot;);</span>
<a href="#l61.385"></a><span id="l61.385">     else if (result)</span>
<a href="#l61.386"></a><span id="l61.386">       result = m_pOut-&gt;WriteStr(&quot;=\&quot;&quot;);</span>
<a href="#l61.387"></a><span id="l61.387">     if (result)</span>
<a href="#l61.388"></a><span id="l61.388">       result = m_pOut-&gt;WriteData(((const uint8_t *)fName.get()) + idx, len);</span>
<a href="#l61.389"></a><span id="l61.389">     if (wasTrans &amp;&amp; result)</span>
<a href="#l61.390"></a><span id="l61.390">       result = m_pOut-&gt;WriteStr(&quot;\x0D\x0A&quot;);</span>
<a href="#l61.391"></a><span id="l61.391">     else if (result)</span>
<a href="#l61.392"></a><span id="l61.392">       result = m_pOut-&gt;WriteStr(&quot;\&quot;\x0D\x0A&quot;);</span>
<a href="#l61.393"></a><span id="l61.393">     idx += len;</span>
<a href="#l61.394"></a><span id="l61.394">     tagNum++;</span>
<a href="#l61.395"></a><span id="l61.395">   }</span>
<a href="#l61.396"></a><span id="l61.396"> </span>
<a href="#l61.397"></a><span id="l61.397">   if (idx) {</span>
<a href="#l61.398"></a><span id="l61.398">     if ((fName.Length() - idx) &gt; 0) {</span>
<a href="#l61.399"></a><span id="l61.399" class="difflineminus">-      if (result)</span>
<a href="#l61.400"></a><span id="l61.400" class="difflineminus">-        result = m_pOut-&gt;WriteStr(&quot;\x09&quot;);</span>
<a href="#l61.401"></a><span id="l61.401" class="difflineminus">-      if (result)</span>
<a href="#l61.402"></a><span id="l61.402" class="difflineminus">-        result = m_pOut-&gt;WriteStr(pTag);</span>
<a href="#l61.403"></a><span id="l61.403" class="difflineplus">+      if (result) result = m_pOut-&gt;WriteStr(&quot;\x09&quot;);</span>
<a href="#l61.404"></a><span id="l61.404" class="difflineplus">+      if (result) result = m_pOut-&gt;WriteStr(pTag);</span>
<a href="#l61.405"></a><span id="l61.405">       numStr = &quot;*&quot;;</span>
<a href="#l61.406"></a><span id="l61.406">       numStr.AppendInt(tagNum);</span>
<a href="#l61.407"></a><span id="l61.407" class="difflineminus">-      if (result)</span>
<a href="#l61.408"></a><span id="l61.408" class="difflineminus">-        result = m_pOut-&gt;WriteStr(numStr.get());</span>
<a href="#l61.409"></a><span id="l61.409" class="difflineplus">+      if (result) result = m_pOut-&gt;WriteStr(numStr.get());</span>
<a href="#l61.410"></a><span id="l61.410">       if (wasTrans &amp;&amp; result)</span>
<a href="#l61.411"></a><span id="l61.411">         result = m_pOut-&gt;WriteStr(&quot;*=&quot;);</span>
<a href="#l61.412"></a><span id="l61.412">       else if (result)</span>
<a href="#l61.413"></a><span id="l61.413">         result = m_pOut-&gt;WriteStr(&quot;=\&quot;&quot;);</span>
<a href="#l61.414"></a><span id="l61.414">       if (result)</span>
<a href="#l61.415"></a><span id="l61.415" class="difflineminus">-        result = m_pOut-&gt;WriteData(((const uint8_t *)fName.get()) + idx, fName.Length() - idx);</span>
<a href="#l61.416"></a><span id="l61.416" class="difflineplus">+        result = m_pOut-&gt;WriteData(((const uint8_t *)fName.get()) + idx,</span>
<a href="#l61.417"></a><span id="l61.417" class="difflineplus">+                                   fName.Length() - idx);</span>
<a href="#l61.418"></a><span id="l61.418">       if (wasTrans &amp;&amp; result)</span>
<a href="#l61.419"></a><span id="l61.419">         result = m_pOut-&gt;WriteStr(&quot;\x0D\x0A&quot;);</span>
<a href="#l61.420"></a><span id="l61.420">       else if (result)</span>
<a href="#l61.421"></a><span id="l61.421">         result = m_pOut-&gt;WriteStr(&quot;\&quot;\x0D\x0A&quot;);</span>
<a href="#l61.422"></a><span id="l61.422">     }</span>
<a href="#l61.423"></a><span id="l61.423" class="difflineminus">-  }</span>
<a href="#l61.424"></a><span id="l61.424" class="difflineminus">-  else {</span>
<a href="#l61.425"></a><span id="l61.425" class="difflineminus">-    if (result)</span>
<a href="#l61.426"></a><span id="l61.426" class="difflineminus">-      result = m_pOut-&gt;WriteStr(&quot;\x09&quot;);</span>
<a href="#l61.427"></a><span id="l61.427" class="difflineminus">-    if (result)</span>
<a href="#l61.428"></a><span id="l61.428" class="difflineminus">-      result = m_pOut-&gt;WriteStr(pTag);</span>
<a href="#l61.429"></a><span id="l61.429" class="difflineplus">+  } else {</span>
<a href="#l61.430"></a><span id="l61.430" class="difflineplus">+    if (result) result = m_pOut-&gt;WriteStr(&quot;\x09&quot;);</span>
<a href="#l61.431"></a><span id="l61.431" class="difflineplus">+    if (result) result = m_pOut-&gt;WriteStr(pTag);</span>
<a href="#l61.432"></a><span id="l61.432">     if (wasTrans &amp;&amp; result)</span>
<a href="#l61.433"></a><span id="l61.433">       result = m_pOut-&gt;WriteStr(&quot;*=&quot;);</span>
<a href="#l61.434"></a><span id="l61.434">     else if (result)</span>
<a href="#l61.435"></a><span id="l61.435">       result = m_pOut-&gt;WriteStr(&quot;=\&quot;&quot;);</span>
<a href="#l61.436"></a><span id="l61.436" class="difflineminus">-    if (result)</span>
<a href="#l61.437"></a><span id="l61.437" class="difflineminus">-      result = m_pOut-&gt;WriteStr(fName.get());</span>
<a href="#l61.438"></a><span id="l61.438" class="difflineplus">+    if (result) result = m_pOut-&gt;WriteStr(fName.get());</span>
<a href="#l61.439"></a><span id="l61.439">     if (wasTrans &amp;&amp; result)</span>
<a href="#l61.440"></a><span id="l61.440">       result = m_pOut-&gt;WriteStr(&quot;\x0D\x0A&quot;);</span>
<a href="#l61.441"></a><span id="l61.441">     else if (result)</span>
<a href="#l61.442"></a><span id="l61.442">       result = m_pOut-&gt;WriteStr(&quot;\&quot;\x0D\x0A&quot;);</span>
<a href="#l61.443"></a><span id="l61.443">   }</span>
<a href="#l61.444"></a><span id="l61.444"> </span>
<a href="#l61.445"></a><span id="l61.445">   return result;</span>
<a href="#l61.446"></a><span id="l61.446" class="difflineminus">-</span>
<a href="#l61.447"></a><span id="l61.447"> }</span>
<a href="#l61.448"></a><span id="l61.448"> </span>
<a href="#l61.449"></a><span id="l61.449" class="difflineminus">-</span>
<a href="#l61.450"></a><span id="l61.450"> //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l61.451"></a><span id="l61.451"> //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l61.452"></a><span id="l61.452" class="difflineminus">-nsIImportMimeEncodeImpl::nsIImportMimeEncodeImpl()</span>
<a href="#l61.453"></a><span id="l61.453" class="difflineminus">-{</span>
<a href="#l61.454"></a><span id="l61.454" class="difflineplus">+nsIImportMimeEncodeImpl::nsIImportMimeEncodeImpl() {</span>
<a href="#l61.455"></a><span id="l61.455">   m_pOut = nullptr;</span>
<a href="#l61.456"></a><span id="l61.456">   m_pEncode = nullptr;</span>
<a href="#l61.457"></a><span id="l61.457"> }</span>
<a href="#l61.458"></a><span id="l61.458"> </span>
<a href="#l61.459"></a><span id="l61.459" class="difflineminus">-nsIImportMimeEncodeImpl::~nsIImportMimeEncodeImpl()</span>
<a href="#l61.460"></a><span id="l61.460" class="difflineminus">-{</span>
<a href="#l61.461"></a><span id="l61.461" class="difflineminus">-  if (m_pOut)</span>
<a href="#l61.462"></a><span id="l61.462" class="difflineminus">-    delete m_pOut;</span>
<a href="#l61.463"></a><span id="l61.463" class="difflineminus">-  if (m_pEncode)</span>
<a href="#l61.464"></a><span id="l61.464" class="difflineminus">-    delete m_pEncode;</span>
<a href="#l61.465"></a><span id="l61.465" class="difflineplus">+nsIImportMimeEncodeImpl::~nsIImportMimeEncodeImpl() {</span>
<a href="#l61.466"></a><span id="l61.466" class="difflineplus">+  if (m_pOut) delete m_pOut;</span>
<a href="#l61.467"></a><span id="l61.467" class="difflineplus">+  if (m_pEncode) delete m_pEncode;</span>
<a href="#l61.468"></a><span id="l61.468"> }</span>
<a href="#l61.469"></a><span id="l61.469"> </span>
<a href="#l61.470"></a><span id="l61.470"> NS_IMPL_ISUPPORTS(nsIImportMimeEncodeImpl, nsIImportMimeEncode)</span>
<a href="#l61.471"></a><span id="l61.471"> </span>
<a href="#l61.472"></a><span id="l61.472" class="difflineminus">-NS_IMETHODIMP nsIImportMimeEncodeImpl::EncodeFile(nsIFile *inFile, nsIFile *outFile, const char *fileName, const char *mimeType)</span>
<a href="#l61.473"></a><span id="l61.473" class="difflineminus">-{</span>
<a href="#l61.474"></a><span id="l61.474" class="difflineplus">+NS_IMETHODIMP nsIImportMimeEncodeImpl::EncodeFile(nsIFile *inFile,</span>
<a href="#l61.475"></a><span id="l61.475" class="difflineplus">+                                                  nsIFile *outFile,</span>
<a href="#l61.476"></a><span id="l61.476" class="difflineplus">+                                                  const char *fileName,</span>
<a href="#l61.477"></a><span id="l61.477" class="difflineplus">+                                                  const char *mimeType) {</span>
<a href="#l61.478"></a><span id="l61.478">   return Initialize(inFile, outFile, fileName, mimeType);</span>
<a href="#l61.479"></a><span id="l61.479"> }</span>
<a href="#l61.480"></a><span id="l61.480"> </span>
<a href="#l61.481"></a><span id="l61.481" class="difflineminus">-NS_IMETHODIMP nsIImportMimeEncodeImpl::DoWork(bool *done, bool *_retval)</span>
<a href="#l61.482"></a><span id="l61.482" class="difflineminus">-{</span>
<a href="#l61.483"></a><span id="l61.483" class="difflineplus">+NS_IMETHODIMP nsIImportMimeEncodeImpl::DoWork(bool *done, bool *_retval) {</span>
<a href="#l61.484"></a><span id="l61.484">   if (done &amp;&amp; _retval &amp;&amp; m_pEncode) {</span>
<a href="#l61.485"></a><span id="l61.485">     *_retval = m_pEncode-&gt;DoWork(done);</span>
<a href="#l61.486"></a><span id="l61.486">     return NS_OK;</span>
<a href="#l61.487"></a><span id="l61.487">   }</span>
<a href="#l61.488"></a><span id="l61.488">   return NS_ERROR_FAILURE;</span>
<a href="#l61.489"></a><span id="l61.489"> }</span>
<a href="#l61.490"></a><span id="l61.490"> </span>
<a href="#l61.491"></a><span id="l61.491" class="difflineminus">-NS_IMETHODIMP nsIImportMimeEncodeImpl::NumBytesProcessed(int32_t *_retval)</span>
<a href="#l61.492"></a><span id="l61.492" class="difflineminus">-{</span>
<a href="#l61.493"></a><span id="l61.493" class="difflineminus">-  if (m_pEncode &amp;&amp; _retval)</span>
<a href="#l61.494"></a><span id="l61.494" class="difflineminus">-    *_retval = m_pEncode-&gt;NumBytesProcessed();</span>
<a href="#l61.495"></a><span id="l61.495" class="difflineplus">+NS_IMETHODIMP nsIImportMimeEncodeImpl::NumBytesProcessed(int32_t *_retval) {</span>
<a href="#l61.496"></a><span id="l61.496" class="difflineplus">+  if (m_pEncode &amp;&amp; _retval) *_retval = m_pEncode-&gt;NumBytesProcessed();</span>
<a href="#l61.497"></a><span id="l61.497">   return NS_OK;</span>
<a href="#l61.498"></a><span id="l61.498"> }</span>
<a href="#l61.499"></a><span id="l61.499"> </span>
<a href="#l61.500"></a><span id="l61.500" class="difflineminus">-NS_IMETHODIMP nsIImportMimeEncodeImpl::DoEncoding(bool *_retval)</span>
<a href="#l61.501"></a><span id="l61.501" class="difflineminus">-{</span>
<a href="#l61.502"></a><span id="l61.502" class="difflineplus">+NS_IMETHODIMP nsIImportMimeEncodeImpl::DoEncoding(bool *_retval) {</span>
<a href="#l61.503"></a><span id="l61.503">   if (_retval &amp;&amp; m_pEncode) {</span>
<a href="#l61.504"></a><span id="l61.504" class="difflineminus">-    bool    done = false;</span>
<a href="#l61.505"></a><span id="l61.505" class="difflineminus">-    while (m_pEncode-&gt;DoWork(&amp;done) &amp;&amp; !done);</span>
<a href="#l61.506"></a><span id="l61.506" class="difflineplus">+    bool done = false;</span>
<a href="#l61.507"></a><span id="l61.507" class="difflineplus">+    while (m_pEncode-&gt;DoWork(&amp;done) &amp;&amp; !done)</span>
<a href="#l61.508"></a><span id="l61.508" class="difflineplus">+      ;</span>
<a href="#l61.509"></a><span id="l61.509">     *_retval = done;</span>
<a href="#l61.510"></a><span id="l61.510">     return NS_OK;</span>
<a href="#l61.511"></a><span id="l61.511">   }</span>
<a href="#l61.512"></a><span id="l61.512">   return NS_ERROR_FAILURE;</span>
<a href="#l61.513"></a><span id="l61.513"> }</span>
<a href="#l61.514"></a><span id="l61.514"> </span>
<a href="#l61.515"></a><span id="l61.515" class="difflineminus">-NS_IMETHODIMP nsIImportMimeEncodeImpl::Initialize(nsIFile *inFile, nsIFile *outFile, const char *fileName, const char *mimeType)</span>
<a href="#l61.516"></a><span id="l61.516" class="difflineminus">-{</span>
<a href="#l61.517"></a><span id="l61.517" class="difflineplus">+NS_IMETHODIMP nsIImportMimeEncodeImpl::Initialize(nsIFile *inFile,</span>
<a href="#l61.518"></a><span id="l61.518" class="difflineplus">+                                                  nsIFile *outFile,</span>
<a href="#l61.519"></a><span id="l61.519" class="difflineplus">+                                                  const char *fileName,</span>
<a href="#l61.520"></a><span id="l61.520" class="difflineplus">+                                                  const char *mimeType) {</span>
<a href="#l61.521"></a><span id="l61.521">   delete m_pEncode;</span>
<a href="#l61.522"></a><span id="l61.522">   delete m_pOut;</span>
<a href="#l61.523"></a><span id="l61.523"> </span>
<a href="#l61.524"></a><span id="l61.524">   m_pOut = new ImportOutFile();</span>
<a href="#l61.525"></a><span id="l61.525">   m_pOut-&gt;InitOutFile(outFile);</span>
<a href="#l61.526"></a><span id="l61.526"> </span>
<a href="#l61.527"></a><span id="l61.527">   m_pEncode = new nsImportMimeEncode();</span>
<a href="#l61.528"></a><span id="l61.528">   m_pEncode-&gt;EncodeFile(inFile, m_pOut, fileName, mimeType);</span>
<a href="#l61.529"></a><span id="l61.529"> </span>
<a href="#l61.530"></a><span id="l61.530">   return NS_OK;</span>
<a href="#l61.531"></a><span id="l61.531"> }</span>
<a href="#l61.532"></a><span id="l61.532" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l62.1"></a><span id="l62.1" class="difflineminus">--- a/mailnews/import/src/nsImportMimeEncode.h</span>
<a href="#l62.2"></a><span id="l62.2" class="difflineplus">+++ b/mailnews/import/src/nsImportMimeEncode.h</span>
<a href="#l62.3"></a><span id="l62.3" class="difflineat">@@ -7,67 +7,66 @@</span>
<a href="#l62.4"></a><span id="l62.4"> #define nsImportMimeEncode_h__</span>
<a href="#l62.5"></a><span id="l62.5"> </span>
<a href="#l62.6"></a><span id="l62.6"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l62.7"></a><span id="l62.7"> #include &quot;ImportOutFile.h&quot;</span>
<a href="#l62.8"></a><span id="l62.8"> #include &quot;nsImportEncodeScan.h&quot;</span>
<a href="#l62.9"></a><span id="l62.9"> #include &quot;nsString.h&quot;</span>
<a href="#l62.10"></a><span id="l62.10"> #include &quot;nsIImportMimeEncode.h&quot;</span>
<a href="#l62.11"></a><span id="l62.11"> </span>
<a href="#l62.12"></a><span id="l62.12" class="difflineminus">-</span>
<a href="#l62.13"></a><span id="l62.13"> // Content-Type: image/gif; name=&quot;blah.xyz&quot;</span>
<a href="#l62.14"></a><span id="l62.14"> // Content-Transfer-Encoding: base64</span>
<a href="#l62.15"></a><span id="l62.15"> // Content-Disposition: attachment; filename=&quot;blah.xyz&quot;</span>
<a href="#l62.16"></a><span id="l62.16"> </span>
<a href="#l62.17"></a><span id="l62.17"> class nsImportMimeEncode : public nsImportEncodeScan {</span>
<a href="#l62.18"></a><span id="l62.18" class="difflineminus">-public:</span>
<a href="#l62.19"></a><span id="l62.19" class="difflineplus">+ public:</span>
<a href="#l62.20"></a><span id="l62.20">   nsImportMimeEncode();</span>
<a href="#l62.21"></a><span id="l62.21">   ~nsImportMimeEncode();</span>
<a href="#l62.22"></a><span id="l62.22"> </span>
<a href="#l62.23"></a><span id="l62.23" class="difflineminus">-  void EncodeFile(nsIFile *pInFile, ImportOutFile *pOut, const char *pFileName, const char *pMimeType);</span>
<a href="#l62.24"></a><span id="l62.24" class="difflineplus">+  void EncodeFile(nsIFile *pInFile, ImportOutFile *pOut, const char *pFileName,</span>
<a href="#l62.25"></a><span id="l62.25" class="difflineplus">+                  const char *pMimeType);</span>
<a href="#l62.26"></a><span id="l62.26"> </span>
<a href="#l62.27"></a><span id="l62.27">   bool DoWork(bool *pDone);</span>
<a href="#l62.28"></a><span id="l62.28"> </span>
<a href="#l62.29"></a><span id="l62.29" class="difflineminus">-  long NumBytesProcessed(void) { long val = m_bytesProcessed; m_bytesProcessed = 0; return val;}</span>
<a href="#l62.30"></a><span id="l62.30" class="difflineplus">+  long NumBytesProcessed(void) {</span>
<a href="#l62.31"></a><span id="l62.31" class="difflineplus">+    long val = m_bytesProcessed;</span>
<a href="#l62.32"></a><span id="l62.32" class="difflineplus">+    m_bytesProcessed = 0;</span>
<a href="#l62.33"></a><span id="l62.33" class="difflineplus">+    return val;</span>
<a href="#l62.34"></a><span id="l62.34" class="difflineplus">+  }</span>
<a href="#l62.35"></a><span id="l62.35"> </span>
<a href="#l62.36"></a><span id="l62.36" class="difflineminus">-protected:</span>
<a href="#l62.37"></a><span id="l62.37" class="difflineplus">+ protected:</span>
<a href="#l62.38"></a><span id="l62.38">   void CleanUp(void);</span>
<a href="#l62.39"></a><span id="l62.39">   bool SetUpEncode(void);</span>
<a href="#l62.40"></a><span id="l62.40" class="difflineminus">-  bool WriteFileName(nsCString&amp; fName, bool wasTrans, const char *pTag);</span>
<a href="#l62.41"></a><span id="l62.41" class="difflineminus">-  bool TranslateFileName(nsCString&amp; inFile, nsCString&amp; outFile);</span>
<a href="#l62.42"></a><span id="l62.42" class="difflineminus">-</span>
<a href="#l62.43"></a><span id="l62.43" class="difflineplus">+  bool WriteFileName(nsCString &amp;fName, bool wasTrans, const char *pTag);</span>
<a href="#l62.44"></a><span id="l62.44" class="difflineplus">+  bool TranslateFileName(nsCString &amp;inFile, nsCString &amp;outFile);</span>
<a href="#l62.45"></a><span id="l62.45"> </span>
<a href="#l62.46"></a><span id="l62.46">   virtual bool ScanBuffer(bool *pDone) override;</span>
<a href="#l62.47"></a><span id="l62.47"> </span>
<a href="#l62.48"></a><span id="l62.48" class="difflineminus">-</span>
<a href="#l62.49"></a><span id="l62.49" class="difflineminus">-protected:</span>
<a href="#l62.50"></a><span id="l62.50" class="difflineminus">-  nsCString            m_fileName;</span>
<a href="#l62.51"></a><span id="l62.51" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt;   m_pMimeFile;</span>
<a href="#l62.52"></a><span id="l62.52" class="difflineminus">-  ImportOutFile      * m_pOut;</span>
<a href="#l62.53"></a><span id="l62.53" class="difflineminus">-  nsCString            m_mimeType;</span>
<a href="#l62.54"></a><span id="l62.54" class="difflineplus">+ protected:</span>
<a href="#l62.55"></a><span id="l62.55" class="difflineplus">+  nsCString m_fileName;</span>
<a href="#l62.56"></a><span id="l62.56" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; m_pMimeFile;</span>
<a href="#l62.57"></a><span id="l62.57" class="difflineplus">+  ImportOutFile *m_pOut;</span>
<a href="#l62.58"></a><span id="l62.58" class="difflineplus">+  nsCString m_mimeType;</span>
<a href="#l62.59"></a><span id="l62.59"> </span>
<a href="#l62.60"></a><span id="l62.60" class="difflineminus">-  int                  m_state;</span>
<a href="#l62.61"></a><span id="l62.61" class="difflineminus">-  long                 m_bytesProcessed;</span>
<a href="#l62.62"></a><span id="l62.62" class="difflineminus">-  uint8_t            * m_pInputBuf;</span>
<a href="#l62.63"></a><span id="l62.63" class="difflineminus">-  bool                 m_appleSingle;</span>
<a href="#l62.64"></a><span id="l62.64" class="difflineminus">-  </span>
<a href="#l62.65"></a><span id="l62.65" class="difflineplus">+  int m_state;</span>
<a href="#l62.66"></a><span id="l62.66" class="difflineplus">+  long m_bytesProcessed;</span>
<a href="#l62.67"></a><span id="l62.67" class="difflineplus">+  uint8_t *m_pInputBuf;</span>
<a href="#l62.68"></a><span id="l62.68" class="difflineplus">+  bool m_appleSingle;</span>
<a href="#l62.69"></a><span id="l62.69" class="difflineplus">+</span>
<a href="#l62.70"></a><span id="l62.70">   // Actual encoding variables</span>
<a href="#l62.71"></a><span id="l62.71" class="difflineminus">-  int                  m_lineLen;</span>
<a href="#l62.72"></a><span id="l62.72" class="difflineplus">+  int m_lineLen;</span>
<a href="#l62.73"></a><span id="l62.73"> };</span>
<a href="#l62.74"></a><span id="l62.74"> </span>
<a href="#l62.75"></a><span id="l62.75" class="difflineminus">-</span>
<a href="#l62.76"></a><span id="l62.76"> class nsIImportMimeEncodeImpl : public nsIImportMimeEncode {</span>
<a href="#l62.77"></a><span id="l62.77" class="difflineminus">-public:</span>
<a href="#l62.78"></a><span id="l62.78" class="difflineplus">+ public:</span>
<a href="#l62.79"></a><span id="l62.79">   NS_DECL_ISUPPORTS</span>
<a href="#l62.80"></a><span id="l62.80"> </span>
<a href="#l62.81"></a><span id="l62.81">   NS_DECL_NSIIMPORTMIMEENCODE</span>
<a href="#l62.82"></a><span id="l62.82"> </span>
<a href="#l62.83"></a><span id="l62.83">   nsIImportMimeEncodeImpl();</span>
<a href="#l62.84"></a><span id="l62.84"> </span>
<a href="#l62.85"></a><span id="l62.85" class="difflineminus">-private:</span>
<a href="#l62.86"></a><span id="l62.86" class="difflineplus">+ private:</span>
<a href="#l62.87"></a><span id="l62.87">   virtual ~nsIImportMimeEncodeImpl();</span>
<a href="#l62.88"></a><span id="l62.88" class="difflineminus">-  ImportOutFile * m_pOut;</span>
<a href="#l62.89"></a><span id="l62.89" class="difflineminus">-  nsImportMimeEncode * m_pEncode;</span>
<a href="#l62.90"></a><span id="l62.90" class="difflineplus">+  ImportOutFile *m_pOut;</span>
<a href="#l62.91"></a><span id="l62.91" class="difflineplus">+  nsImportMimeEncode *m_pEncode;</span>
<a href="#l62.92"></a><span id="l62.92"> };</span>
<a href="#l62.93"></a><span id="l62.93"> </span>
<a href="#l62.94"></a><span id="l62.94" class="difflineminus">-</span>
<a href="#l62.95"></a><span id="l62.95"> #endif /* nsImportMimeEncode_h__ */</span>
<a href="#l62.96"></a><span id="l62.96" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l63.1"></a><span id="l63.1" class="difflineminus">--- a/mailnews/import/src/nsImportScanFile.cpp</span>
<a href="#l63.2"></a><span id="l63.2" class="difflineplus">+++ b/mailnews/import/src/nsImportScanFile.cpp</span>
<a href="#l63.3"></a><span id="l63.3" class="difflineat">@@ -2,170 +2,153 @@</span>
<a href="#l63.4"></a><span id="l63.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l63.5"></a><span id="l63.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l63.6"></a><span id="l63.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l63.7"></a><span id="l63.7"> </span>
<a href="#l63.8"></a><span id="l63.8"> #include &quot;nscore.h&quot;</span>
<a href="#l63.9"></a><span id="l63.9"> #include &quot;nsImportScanFile.h&quot;</span>
<a href="#l63.10"></a><span id="l63.10"> #include &quot;ImportCharSet.h&quot;</span>
<a href="#l63.11"></a><span id="l63.11"> </span>
<a href="#l63.12"></a><span id="l63.12" class="difflineminus">-nsImportScanFile::nsImportScanFile()</span>
<a href="#l63.13"></a><span id="l63.13" class="difflineminus">-{</span>
<a href="#l63.14"></a><span id="l63.14" class="difflineplus">+nsImportScanFile::nsImportScanFile() {</span>
<a href="#l63.15"></a><span id="l63.15">   m_allocated = false;</span>
<a href="#l63.16"></a><span id="l63.16">   m_eof = false;</span>
<a href="#l63.17"></a><span id="l63.17">   m_pBuf = nullptr;</span>
<a href="#l63.18"></a><span id="l63.18"> }</span>
<a href="#l63.19"></a><span id="l63.19"> </span>
<a href="#l63.20"></a><span id="l63.20" class="difflineminus">-nsImportScanFile::~nsImportScanFile()</span>
<a href="#l63.21"></a><span id="l63.21" class="difflineminus">-{</span>
<a href="#l63.22"></a><span id="l63.22" class="difflineminus">-  if (m_allocated)</span>
<a href="#l63.23"></a><span id="l63.23" class="difflineminus">-    CleanUpScan();</span>
<a href="#l63.24"></a><span id="l63.24" class="difflineplus">+nsImportScanFile::~nsImportScanFile() {</span>
<a href="#l63.25"></a><span id="l63.25" class="difflineplus">+  if (m_allocated) CleanUpScan();</span>
<a href="#l63.26"></a><span id="l63.26"> }</span>
<a href="#l63.27"></a><span id="l63.27"> </span>
<a href="#l63.28"></a><span id="l63.28" class="difflineminus">-void nsImportScanFile::InitScan(nsIInputStream *pInputStream, uint8_t * pBuf, uint32_t sz)</span>
<a href="#l63.29"></a><span id="l63.29" class="difflineminus">-{</span>
<a href="#l63.30"></a><span id="l63.30" class="difflineplus">+void nsImportScanFile::InitScan(nsIInputStream *pInputStream, uint8_t *pBuf,</span>
<a href="#l63.31"></a><span id="l63.31" class="difflineplus">+                                uint32_t sz) {</span>
<a href="#l63.32"></a><span id="l63.32">   m_pInputStream = pInputStream;</span>
<a href="#l63.33"></a><span id="l63.33">   m_pBuf = pBuf;</span>
<a href="#l63.34"></a><span id="l63.34">   m_bufSz = sz;</span>
<a href="#l63.35"></a><span id="l63.35">   m_bytesInBuf = 0;</span>
<a href="#l63.36"></a><span id="l63.36">   m_pos = 0;</span>
<a href="#l63.37"></a><span id="l63.37"> }</span>
<a href="#l63.38"></a><span id="l63.38"> </span>
<a href="#l63.39"></a><span id="l63.39" class="difflineminus">-void nsImportScanFile::CleanUpScan(void)</span>
<a href="#l63.40"></a><span id="l63.40" class="difflineminus">-{</span>
<a href="#l63.41"></a><span id="l63.41" class="difflineplus">+void nsImportScanFile::CleanUpScan(void) {</span>
<a href="#l63.42"></a><span id="l63.42">   m_pInputStream = nullptr;</span>
<a href="#l63.43"></a><span id="l63.43">   if (m_allocated) {</span>
<a href="#l63.44"></a><span id="l63.44" class="difflineminus">-    delete [] m_pBuf;</span>
<a href="#l63.45"></a><span id="l63.45" class="difflineplus">+    delete[] m_pBuf;</span>
<a href="#l63.46"></a><span id="l63.46">     m_pBuf = NULL;</span>
<a href="#l63.47"></a><span id="l63.47">   }</span>
<a href="#l63.48"></a><span id="l63.48"> }</span>
<a href="#l63.49"></a><span id="l63.49"> </span>
<a href="#l63.50"></a><span id="l63.50" class="difflineminus">-void nsImportScanFile::ShiftBuffer(void)</span>
<a href="#l63.51"></a><span id="l63.51" class="difflineminus">-{</span>
<a href="#l63.52"></a><span id="l63.52" class="difflineminus">-  uint8_t *  pTop;</span>
<a href="#l63.53"></a><span id="l63.53" class="difflineminus">-  uint8_t *  pCurrent;</span>
<a href="#l63.54"></a><span id="l63.54" class="difflineplus">+void nsImportScanFile::ShiftBuffer(void) {</span>
<a href="#l63.55"></a><span id="l63.55" class="difflineplus">+  uint8_t *pTop;</span>
<a href="#l63.56"></a><span id="l63.56" class="difflineplus">+  uint8_t *pCurrent;</span>
<a href="#l63.57"></a><span id="l63.57"> </span>
<a href="#l63.58"></a><span id="l63.58">   if (m_pos &lt; m_bytesInBuf) {</span>
<a href="#l63.59"></a><span id="l63.59">     pTop = m_pBuf;</span>
<a href="#l63.60"></a><span id="l63.60">     pCurrent = pTop + m_pos;</span>
<a href="#l63.61"></a><span id="l63.61" class="difflineminus">-    uint32_t    cnt = m_bytesInBuf - m_pos;</span>
<a href="#l63.62"></a><span id="l63.62" class="difflineplus">+    uint32_t cnt = m_bytesInBuf - m_pos;</span>
<a href="#l63.63"></a><span id="l63.63">     while (cnt) {</span>
<a href="#l63.64"></a><span id="l63.64">       *pTop = *pCurrent;</span>
<a href="#l63.65"></a><span id="l63.65" class="difflineminus">-      pTop++; pCurrent++;</span>
<a href="#l63.66"></a><span id="l63.66" class="difflineplus">+      pTop++;</span>
<a href="#l63.67"></a><span id="l63.67" class="difflineplus">+      pCurrent++;</span>
<a href="#l63.68"></a><span id="l63.68">       cnt--;</span>
<a href="#l63.69"></a><span id="l63.69">     }</span>
<a href="#l63.70"></a><span id="l63.70">   }</span>
<a href="#l63.71"></a><span id="l63.71"> </span>
<a href="#l63.72"></a><span id="l63.72">   m_bytesInBuf -= m_pos;</span>
<a href="#l63.73"></a><span id="l63.73">   m_pos = 0;</span>
<a href="#l63.74"></a><span id="l63.74"> }</span>
<a href="#l63.75"></a><span id="l63.75"> </span>
<a href="#l63.76"></a><span id="l63.76" class="difflineminus">-bool nsImportScanFile::FillBufferFromFile(void)</span>
<a href="#l63.77"></a><span id="l63.77" class="difflineminus">-{</span>
<a href="#l63.78"></a><span id="l63.78" class="difflineplus">+bool nsImportScanFile::FillBufferFromFile(void) {</span>
<a href="#l63.79"></a><span id="l63.79">   uint64_t available;</span>
<a href="#l63.80"></a><span id="l63.80">   nsresult rv = m_pInputStream-&gt;Available(&amp;available);</span>
<a href="#l63.81"></a><span id="l63.81" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l63.82"></a><span id="l63.82" class="difflineminus">-    return false;</span>
<a href="#l63.83"></a><span id="l63.83" class="difflineplus">+  if (NS_FAILED(rv)) return false;</span>
<a href="#l63.84"></a><span id="l63.84"> </span>
<a href="#l63.85"></a><span id="l63.85">   // Fill up a buffer and scan it</span>
<a href="#l63.86"></a><span id="l63.86">   ShiftBuffer();</span>
<a href="#l63.87"></a><span id="l63.87"> </span>
<a href="#l63.88"></a><span id="l63.88">   // Read in some more bytes</span>
<a href="#l63.89"></a><span id="l63.89" class="difflineminus">-  uint32_t  cnt = m_bufSz - m_bytesInBuf;</span>
<a href="#l63.90"></a><span id="l63.90" class="difflineplus">+  uint32_t cnt = m_bufSz - m_bytesInBuf;</span>
<a href="#l63.91"></a><span id="l63.91">   // To distinguish from disk errors</span>
<a href="#l63.92"></a><span id="l63.92">   // Check first for end of file?</span>
<a href="#l63.93"></a><span id="l63.93">   // Set a done flag if true...</span>
<a href="#l63.94"></a><span id="l63.94">   uint32_t read;</span>
<a href="#l63.95"></a><span id="l63.95">   char *pBuf = (char *)m_pBuf;</span>
<a href="#l63.96"></a><span id="l63.96">   pBuf += m_bytesInBuf;</span>
<a href="#l63.97"></a><span id="l63.97" class="difflineminus">-  rv = m_pInputStream-&gt;Read(pBuf, (int32_t) cnt, &amp;read);</span>
<a href="#l63.98"></a><span id="l63.98" class="difflineplus">+  rv = m_pInputStream-&gt;Read(pBuf, (int32_t)cnt, &amp;read);</span>
<a href="#l63.99"></a><span id="l63.99"> </span>
<a href="#l63.100"></a><span id="l63.100" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l63.101"></a><span id="l63.101" class="difflineminus">-    return false;</span>
<a href="#l63.102"></a><span id="l63.102" class="difflineplus">+  if (NS_FAILED(rv)) return false;</span>
<a href="#l63.103"></a><span id="l63.103">   rv = m_pInputStream-&gt;Available(&amp;available);</span>
<a href="#l63.104"></a><span id="l63.104" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l63.105"></a><span id="l63.105" class="difflineminus">-          m_eof = true;</span>
<a href="#l63.106"></a><span id="l63.106" class="difflineplus">+  if (NS_FAILED(rv)) m_eof = true;</span>
<a href="#l63.107"></a><span id="l63.107"> </span>
<a href="#l63.108"></a><span id="l63.108">   m_bytesInBuf += cnt;</span>
<a href="#l63.109"></a><span id="l63.109">   return true;</span>
<a href="#l63.110"></a><span id="l63.110"> }</span>
<a href="#l63.111"></a><span id="l63.111"> </span>
<a href="#l63.112"></a><span id="l63.112" class="difflineminus">-bool nsImportScanFile::Scan(bool *pDone)</span>
<a href="#l63.113"></a><span id="l63.113" class="difflineminus">-{</span>
<a href="#l63.114"></a><span id="l63.114" class="difflineplus">+bool nsImportScanFile::Scan(bool *pDone) {</span>
<a href="#l63.115"></a><span id="l63.115">   uint64_t available;</span>
<a href="#l63.116"></a><span id="l63.116">   nsresult rv = m_pInputStream-&gt;Available(&amp;available);</span>
<a href="#l63.117"></a><span id="l63.117" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l63.118"></a><span id="l63.118" class="difflineminus">-        {</span>
<a href="#l63.119"></a><span id="l63.119" class="difflineminus">-    if (m_pos &lt; m_bytesInBuf)</span>
<a href="#l63.120"></a><span id="l63.120" class="difflineminus">-      ScanBuffer(pDone);</span>
<a href="#l63.121"></a><span id="l63.121" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l63.122"></a><span id="l63.122" class="difflineplus">+    if (m_pos &lt; m_bytesInBuf) ScanBuffer(pDone);</span>
<a href="#l63.123"></a><span id="l63.123">     *pDone = true;</span>
<a href="#l63.124"></a><span id="l63.124">     return true;</span>
<a href="#l63.125"></a><span id="l63.125">   }</span>
<a href="#l63.126"></a><span id="l63.126"> </span>
<a href="#l63.127"></a><span id="l63.127">   // Fill up a buffer and scan it</span>
<a href="#l63.128"></a><span id="l63.128" class="difflineminus">-  if (!FillBufferFromFile())</span>
<a href="#l63.129"></a><span id="l63.129" class="difflineminus">-    return false;</span>
<a href="#l63.130"></a><span id="l63.130" class="difflineplus">+  if (!FillBufferFromFile()) return false;</span>
<a href="#l63.131"></a><span id="l63.131"> </span>
<a href="#l63.132"></a><span id="l63.132">   return ScanBuffer(pDone);</span>
<a href="#l63.133"></a><span id="l63.133"> }</span>
<a href="#l63.134"></a><span id="l63.134"> </span>
<a href="#l63.135"></a><span id="l63.135" class="difflineminus">-bool nsImportScanFile::ScanBuffer(bool *)</span>
<a href="#l63.136"></a><span id="l63.136" class="difflineminus">-{</span>
<a href="#l63.137"></a><span id="l63.137" class="difflineminus">-  return true;</span>
<a href="#l63.138"></a><span id="l63.138" class="difflineminus">-}</span>
<a href="#l63.139"></a><span id="l63.139" class="difflineplus">+bool nsImportScanFile::ScanBuffer(bool *) { return true; }</span>
<a href="#l63.140"></a><span id="l63.140"> </span>
<a href="#l63.141"></a><span id="l63.141" class="difflineminus">-</span>
<a href="#l63.142"></a><span id="l63.142" class="difflineminus">-bool nsImportScanFileLines::ScanBuffer(bool *pDone)</span>
<a href="#l63.143"></a><span id="l63.143" class="difflineminus">-{</span>
<a href="#l63.144"></a><span id="l63.144" class="difflineplus">+bool nsImportScanFileLines::ScanBuffer(bool *pDone) {</span>
<a href="#l63.145"></a><span id="l63.145">   // m_pos, m_bytesInBuf, m_eof, m_pBuf are relevant</span>
<a href="#l63.146"></a><span id="l63.146"> </span>
<a href="#l63.147"></a><span id="l63.147" class="difflineminus">-  uint32_t    pos = m_pos;</span>
<a href="#l63.148"></a><span id="l63.148" class="difflineminus">-  uint32_t    max = m_bytesInBuf;</span>
<a href="#l63.149"></a><span id="l63.149" class="difflineminus">-  uint8_t *    pChar = m_pBuf + pos;</span>
<a href="#l63.150"></a><span id="l63.150" class="difflineminus">-  uint32_t    startPos;</span>
<a href="#l63.151"></a><span id="l63.151" class="difflineplus">+  uint32_t pos = m_pos;</span>
<a href="#l63.152"></a><span id="l63.152" class="difflineplus">+  uint32_t max = m_bytesInBuf;</span>
<a href="#l63.153"></a><span id="l63.153" class="difflineplus">+  uint8_t *pChar = m_pBuf + pos;</span>
<a href="#l63.154"></a><span id="l63.154" class="difflineplus">+  uint32_t startPos;</span>
<a href="#l63.155"></a><span id="l63.155"> </span>
<a href="#l63.156"></a><span id="l63.156">   while (pos &lt; max) {</span>
<a href="#l63.157"></a><span id="l63.157">     if (m_needEol) {</span>
<a href="#l63.158"></a><span id="l63.158">       // Find the next eol...</span>
<a href="#l63.159"></a><span id="l63.159" class="difflineminus">-      while ((pos &lt; max) &amp;&amp; (*pChar != ImportCharSet::cCRChar) &amp;&amp; (*pChar != ImportCharSet::cLinefeedChar)) {</span>
<a href="#l63.160"></a><span id="l63.160" class="difflineplus">+      while ((pos &lt; max) &amp;&amp; (*pChar != ImportCharSet::cCRChar) &amp;&amp;</span>
<a href="#l63.161"></a><span id="l63.161" class="difflineplus">+             (*pChar != ImportCharSet::cLinefeedChar)) {</span>
<a href="#l63.162"></a><span id="l63.162">         pos++;</span>
<a href="#l63.163"></a><span id="l63.163">         pChar++;</span>
<a href="#l63.164"></a><span id="l63.164">       }</span>
<a href="#l63.165"></a><span id="l63.165">       m_pos = pos;</span>
<a href="#l63.166"></a><span id="l63.166" class="difflineminus">-      if (pos &lt; max)</span>
<a href="#l63.167"></a><span id="l63.167" class="difflineminus">-        m_needEol = false;</span>
<a href="#l63.168"></a><span id="l63.168" class="difflineminus">-      if (pos == max) // need more buffer for an end of line</span>
<a href="#l63.169"></a><span id="l63.169" class="difflineplus">+      if (pos &lt; max) m_needEol = false;</span>
<a href="#l63.170"></a><span id="l63.170" class="difflineplus">+      if (pos == max)  // need more buffer for an end of line</span>
<a href="#l63.171"></a><span id="l63.171">         break;</span>
<a href="#l63.172"></a><span id="l63.172">     }</span>
<a href="#l63.173"></a><span id="l63.173">     // Skip past any eol characters</span>
<a href="#l63.174"></a><span id="l63.174" class="difflineminus">-    while ((pos &lt; max) &amp;&amp; ((*pChar == ImportCharSet::cCRChar) || (*pChar == ImportCharSet::cLinefeedChar))) {</span>
<a href="#l63.175"></a><span id="l63.175" class="difflineplus">+    while ((pos &lt; max) &amp;&amp; ((*pChar == ImportCharSet::cCRChar) ||</span>
<a href="#l63.176"></a><span id="l63.176" class="difflineplus">+                           (*pChar == ImportCharSet::cLinefeedChar))) {</span>
<a href="#l63.177"></a><span id="l63.177">       pos++;</span>
<a href="#l63.178"></a><span id="l63.178">       pChar++;</span>
<a href="#l63.179"></a><span id="l63.179">     }</span>
<a href="#l63.180"></a><span id="l63.180">     m_pos = pos;</span>
<a href="#l63.181"></a><span id="l63.181" class="difflineminus">-    if (pos == max)</span>
<a href="#l63.182"></a><span id="l63.182" class="difflineminus">-      break;</span>
<a href="#l63.183"></a><span id="l63.183" class="difflineplus">+    if (pos == max) break;</span>
<a href="#l63.184"></a><span id="l63.184">     // Make sure we can find either the eof or the</span>
<a href="#l63.185"></a><span id="l63.185">     // next end of line</span>
<a href="#l63.186"></a><span id="l63.186">     startPos = pos;</span>
<a href="#l63.187"></a><span id="l63.187" class="difflineminus">-    while ((pos &lt; max) &amp;&amp; (*pChar != ImportCharSet::cCRChar) &amp;&amp; (*pChar != ImportCharSet::cLinefeedChar)) {</span>
<a href="#l63.188"></a><span id="l63.188" class="difflineplus">+    while ((pos &lt; max) &amp;&amp; (*pChar != ImportCharSet::cCRChar) &amp;&amp;</span>
<a href="#l63.189"></a><span id="l63.189" class="difflineplus">+           (*pChar != ImportCharSet::cLinefeedChar)) {</span>
<a href="#l63.190"></a><span id="l63.190">       pos++;</span>
<a href="#l63.191"></a><span id="l63.191">       pChar++;</span>
<a href="#l63.192"></a><span id="l63.192">     }</span>
<a href="#l63.193"></a><span id="l63.193"> </span>
<a href="#l63.194"></a><span id="l63.194">     // Is line too big for our buffer?</span>
<a href="#l63.195"></a><span id="l63.195">     if ((pos == max) &amp;&amp; !m_eof) {</span>
<a href="#l63.196"></a><span id="l63.196" class="difflineminus">-      if (!m_pos) { // line too big for our buffer</span>
<a href="#l63.197"></a><span id="l63.197" class="difflineplus">+      if (!m_pos) {  // line too big for our buffer</span>
<a href="#l63.198"></a><span id="l63.198">         m_pos = pos;</span>
<a href="#l63.199"></a><span id="l63.199">         m_needEol = true;</span>
<a href="#l63.200"></a><span id="l63.200">       }</span>
<a href="#l63.201"></a><span id="l63.201">       break;</span>
<a href="#l63.202"></a><span id="l63.202">     }</span>
<a href="#l63.203"></a><span id="l63.203"> </span>
<a href="#l63.204"></a><span id="l63.204">     if (!ProcessLine(m_pBuf + startPos, pos - startPos, pDone)) {</span>
<a href="#l63.205"></a><span id="l63.205">       return false;</span>
<a href="#l63.206"></a><span id="l63.206">     }</span>
<a href="#l63.207"></a><span id="l63.207">     m_pos = pos;</span>
<a href="#l63.208"></a><span id="l63.208">   }</span>
<a href="#l63.209"></a><span id="l63.209"> </span>
<a href="#l63.210"></a><span id="l63.210">   return true;</span>
<a href="#l63.211"></a><span id="l63.211"> }</span>
<a href="#l63.212"></a><span id="l63.212" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l64.1"></a><span id="l64.1" class="difflineminus">--- a/mailnews/import/src/nsImportScanFile.h</span>
<a href="#l64.2"></a><span id="l64.2" class="difflineplus">+++ b/mailnews/import/src/nsImportScanFile.h</span>
<a href="#l64.3"></a><span id="l64.3" class="difflineat">@@ -6,50 +6,51 @@</span>
<a href="#l64.4"></a><span id="l64.4"> #ifndef nsImportScanFile_h__</span>
<a href="#l64.5"></a><span id="l64.5"> #define nsImportScanFile_h__</span>
<a href="#l64.6"></a><span id="l64.6"> </span>
<a href="#l64.7"></a><span id="l64.7"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l64.8"></a><span id="l64.8"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l64.9"></a><span id="l64.9"> #include &quot;nsIInputStream.h&quot;</span>
<a href="#l64.10"></a><span id="l64.10"> </span>
<a href="#l64.11"></a><span id="l64.11"> class nsImportScanFile {</span>
<a href="#l64.12"></a><span id="l64.12" class="difflineminus">-public:</span>
<a href="#l64.13"></a><span id="l64.13" class="difflineplus">+ public:</span>
<a href="#l64.14"></a><span id="l64.14">   nsImportScanFile();</span>
<a href="#l64.15"></a><span id="l64.15">   virtual ~nsImportScanFile();</span>
<a href="#l64.16"></a><span id="l64.16"> </span>
<a href="#l64.17"></a><span id="l64.17" class="difflineminus">-  void  InitScan(nsIInputStream *pInputStream, uint8_t * pBuf, uint32_t sz);</span>
<a href="#l64.18"></a><span id="l64.18" class="difflineplus">+  void InitScan(nsIInputStream *pInputStream, uint8_t *pBuf, uint32_t sz);</span>
<a href="#l64.19"></a><span id="l64.19"> </span>
<a href="#l64.20"></a><span id="l64.20" class="difflineminus">-  void  CleanUpScan(void);</span>
<a href="#l64.21"></a><span id="l64.21" class="difflineplus">+  void CleanUpScan(void);</span>
<a href="#l64.22"></a><span id="l64.22"> </span>
<a href="#l64.23"></a><span id="l64.23" class="difflineminus">-  virtual  bool    Scan(bool *pDone);</span>
<a href="#l64.24"></a><span id="l64.24" class="difflineplus">+  virtual bool Scan(bool *pDone);</span>
<a href="#l64.25"></a><span id="l64.25"> </span>
<a href="#l64.26"></a><span id="l64.26" class="difflineminus">-protected:</span>
<a href="#l64.27"></a><span id="l64.27" class="difflineminus">-  void      ShiftBuffer(void);</span>
<a href="#l64.28"></a><span id="l64.28" class="difflineminus">-  bool        FillBufferFromFile(void);</span>
<a href="#l64.29"></a><span id="l64.29" class="difflineminus">-  virtual bool    ScanBuffer(bool *pDone);</span>
<a href="#l64.30"></a><span id="l64.30" class="difflineplus">+ protected:</span>
<a href="#l64.31"></a><span id="l64.31" class="difflineplus">+  void ShiftBuffer(void);</span>
<a href="#l64.32"></a><span id="l64.32" class="difflineplus">+  bool FillBufferFromFile(void);</span>
<a href="#l64.33"></a><span id="l64.33" class="difflineplus">+  virtual bool ScanBuffer(bool *pDone);</span>
<a href="#l64.34"></a><span id="l64.34"> </span>
<a href="#l64.35"></a><span id="l64.35" class="difflineminus">-protected:</span>
<a href="#l64.36"></a><span id="l64.36" class="difflineminus">-  nsCOMPtr &lt;nsIInputStream&gt; m_pInputStream;</span>
<a href="#l64.37"></a><span id="l64.37" class="difflineminus">-  uint8_t *    m_pBuf;</span>
<a href="#l64.38"></a><span id="l64.38" class="difflineminus">-  uint32_t    m_bufSz;</span>
<a href="#l64.39"></a><span id="l64.39" class="difflineminus">-  uint32_t    m_bytesInBuf;</span>
<a href="#l64.40"></a><span id="l64.40" class="difflineminus">-  uint32_t    m_pos;</span>
<a href="#l64.41"></a><span id="l64.41" class="difflineminus">-  bool        m_eof;</span>
<a href="#l64.42"></a><span id="l64.42" class="difflineminus">-  bool        m_allocated;</span>
<a href="#l64.43"></a><span id="l64.43" class="difflineplus">+ protected:</span>
<a href="#l64.44"></a><span id="l64.44" class="difflineplus">+  nsCOMPtr&lt;nsIInputStream&gt; m_pInputStream;</span>
<a href="#l64.45"></a><span id="l64.45" class="difflineplus">+  uint8_t *m_pBuf;</span>
<a href="#l64.46"></a><span id="l64.46" class="difflineplus">+  uint32_t m_bufSz;</span>
<a href="#l64.47"></a><span id="l64.47" class="difflineplus">+  uint32_t m_bytesInBuf;</span>
<a href="#l64.48"></a><span id="l64.48" class="difflineplus">+  uint32_t m_pos;</span>
<a href="#l64.49"></a><span id="l64.49" class="difflineplus">+  bool m_eof;</span>
<a href="#l64.50"></a><span id="l64.50" class="difflineplus">+  bool m_allocated;</span>
<a href="#l64.51"></a><span id="l64.51"> };</span>
<a href="#l64.52"></a><span id="l64.52"> </span>
<a href="#l64.53"></a><span id="l64.53"> class nsImportScanFileLines : public nsImportScanFile {</span>
<a href="#l64.54"></a><span id="l64.54" class="difflineminus">-public:</span>
<a href="#l64.55"></a><span id="l64.55" class="difflineminus">-  nsImportScanFileLines() {m_needEol = false;}</span>
<a href="#l64.56"></a><span id="l64.56" class="difflineplus">+ public:</span>
<a href="#l64.57"></a><span id="l64.57" class="difflineplus">+  nsImportScanFileLines() { m_needEol = false; }</span>
<a href="#l64.58"></a><span id="l64.58"> </span>
<a href="#l64.59"></a><span id="l64.59" class="difflineminus">-  void  ResetLineScan(void) { m_needEol = false;}</span>
<a href="#l64.60"></a><span id="l64.60" class="difflineplus">+  void ResetLineScan(void) { m_needEol = false; }</span>
<a href="#l64.61"></a><span id="l64.61"> </span>
<a href="#l64.62"></a><span id="l64.62" class="difflineminus">-  virtual bool ProcessLine(uint8_t * /* pLine */, uint32_t /* len */, bool * /* pDone */) {return true;}</span>
<a href="#l64.63"></a><span id="l64.63" class="difflineplus">+  virtual bool ProcessLine(uint8_t * /* pLine */, uint32_t /* len */,</span>
<a href="#l64.64"></a><span id="l64.64" class="difflineplus">+                           bool * /* pDone */) {</span>
<a href="#l64.65"></a><span id="l64.65" class="difflineplus">+    return true;</span>
<a href="#l64.66"></a><span id="l64.66" class="difflineplus">+  }</span>
<a href="#l64.67"></a><span id="l64.67"> </span>
<a href="#l64.68"></a><span id="l64.68" class="difflineminus">-protected:</span>
<a href="#l64.69"></a><span id="l64.69" class="difflineminus">-  virtual bool    ScanBuffer(bool *pDone) override;</span>
<a href="#l64.70"></a><span id="l64.70" class="difflineplus">+ protected:</span>
<a href="#l64.71"></a><span id="l64.71" class="difflineplus">+  virtual bool ScanBuffer(bool *pDone) override;</span>
<a href="#l64.72"></a><span id="l64.72"> </span>
<a href="#l64.73"></a><span id="l64.73" class="difflineminus">-  bool    m_needEol;</span>
<a href="#l64.74"></a><span id="l64.74" class="difflineminus">-</span>
<a href="#l64.75"></a><span id="l64.75" class="difflineplus">+  bool m_needEol;</span>
<a href="#l64.76"></a><span id="l64.76"> };</span>
<a href="#l64.77"></a><span id="l64.77"> </span>
<a href="#l64.78"></a><span id="l64.78" class="difflineminus">-</span>
<a href="#l64.79"></a><span id="l64.79"> #endif /* nsImportScanFile_h__ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l65.1"></a><span id="l65.1" class="difflineminus">--- a/mailnews/import/src/nsImportService.cpp</span>
<a href="#l65.2"></a><span id="l65.2" class="difflineplus">+++ b/mailnews/import/src/nsImportService.cpp</span>
<a href="#l65.3"></a><span id="l65.3" class="difflineat">@@ -25,522 +25,449 @@</span>
<a href="#l65.4"></a><span id="l65.4"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l65.5"></a><span id="l65.5"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l65.6"></a><span id="l65.6"> #include &quot;nsIArray.h&quot;</span>
<a href="#l65.7"></a><span id="l65.7"> #include &quot;nsIMsgSend.h&quot;</span>
<a href="#l65.8"></a><span id="l65.8"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l65.9"></a><span id="l65.9"> </span>
<a href="#l65.10"></a><span id="l65.10"> mozilla::LazyLogModule IMPORTLOGMODULE(&quot;Import&quot;);</span>
<a href="#l65.11"></a><span id="l65.11"> </span>
<a href="#l65.12"></a><span id="l65.12" class="difflineminus">-static nsIImportService *  gImportService = nullptr;</span>
<a href="#l65.13"></a><span id="l65.13" class="difflineminus">-static const char *  kWhitespace = &quot;\b\t\r\n &quot;;</span>
<a href="#l65.14"></a><span id="l65.14" class="difflineminus">-</span>
<a href="#l65.15"></a><span id="l65.15" class="difflineplus">+static nsIImportService *gImportService = nullptr;</span>
<a href="#l65.16"></a><span id="l65.16" class="difflineplus">+static const char *kWhitespace = &quot;\b\t\r\n &quot;;</span>
<a href="#l65.17"></a><span id="l65.17"> </span>
<a href="#l65.18"></a><span id="l65.18"> ////////////////////////////////////////////////////////////////////////</span>
<a href="#l65.19"></a><span id="l65.19"> </span>
<a href="#l65.20"></a><span id="l65.20" class="difflineminus">-</span>
<a href="#l65.21"></a><span id="l65.21" class="difflineminus">-nsImportService::nsImportService() : m_pModules(nullptr)</span>
<a href="#l65.22"></a><span id="l65.22" class="difflineminus">-{</span>
<a href="#l65.23"></a><span id="l65.23" class="difflineplus">+nsImportService::nsImportService() : m_pModules(nullptr) {</span>
<a href="#l65.24"></a><span id="l65.24">   IMPORT_LOG0(&quot;* nsImport Service Created\n&quot;);</span>
<a href="#l65.25"></a><span id="l65.25"> </span>
<a href="#l65.26"></a><span id="l65.26">   m_didDiscovery = false;</span>
<a href="#l65.27"></a><span id="l65.27"> </span>
<a href="#l65.28"></a><span id="l65.28" class="difflineminus">-  nsresult rv = nsImportStringBundle::GetStringBundle(IMPORT_MSGS_URL, getter_AddRefs(m_stringBundle));</span>
<a href="#l65.29"></a><span id="l65.29" class="difflineplus">+  nsresult rv = nsImportStringBundle::GetStringBundle(</span>
<a href="#l65.30"></a><span id="l65.30" class="difflineplus">+      IMPORT_MSGS_URL, getter_AddRefs(m_stringBundle));</span>
<a href="#l65.31"></a><span id="l65.31">   if (NS_FAILED(rv))</span>
<a href="#l65.32"></a><span id="l65.32">     IMPORT_LOG0(&quot;Failed to get string bundle for Importing Mail&quot;);</span>
<a href="#l65.33"></a><span id="l65.33"> }</span>
<a href="#l65.34"></a><span id="l65.34"> </span>
<a href="#l65.35"></a><span id="l65.35" class="difflineminus">-</span>
<a href="#l65.36"></a><span id="l65.36" class="difflineminus">-nsImportService::~nsImportService()</span>
<a href="#l65.37"></a><span id="l65.37" class="difflineminus">-{</span>
<a href="#l65.38"></a><span id="l65.38" class="difflineplus">+nsImportService::~nsImportService() {</span>
<a href="#l65.39"></a><span id="l65.39">   gImportService = nullptr;</span>
<a href="#l65.40"></a><span id="l65.40"> </span>
<a href="#l65.41"></a><span id="l65.41" class="difflineminus">-    if (m_pModules != nullptr)</span>
<a href="#l65.42"></a><span id="l65.42" class="difflineminus">-        delete m_pModules;</span>
<a href="#l65.43"></a><span id="l65.43" class="difflineplus">+  if (m_pModules != nullptr) delete m_pModules;</span>
<a href="#l65.44"></a><span id="l65.44"> </span>
<a href="#l65.45"></a><span id="l65.45">   IMPORT_LOG0(&quot;* nsImport Service Deleted\n&quot;);</span>
<a href="#l65.46"></a><span id="l65.46"> }</span>
<a href="#l65.47"></a><span id="l65.47"> </span>
<a href="#l65.48"></a><span id="l65.48" class="difflineminus">-</span>
<a href="#l65.49"></a><span id="l65.49" class="difflineminus">-</span>
<a href="#l65.50"></a><span id="l65.50"> NS_IMPL_ISUPPORTS(nsImportService, nsIImportService)</span>
<a href="#l65.51"></a><span id="l65.51"> </span>
<a href="#l65.52"></a><span id="l65.52" class="difflineminus">-</span>
<a href="#l65.53"></a><span id="l65.53" class="difflineminus">-NS_IMETHODIMP nsImportService::DiscoverModules(void)</span>
<a href="#l65.54"></a><span id="l65.54" class="difflineminus">-{</span>
<a href="#l65.55"></a><span id="l65.55" class="difflineplus">+NS_IMETHODIMP nsImportService::DiscoverModules(void) {</span>
<a href="#l65.56"></a><span id="l65.56">   m_didDiscovery = false;</span>
<a href="#l65.57"></a><span id="l65.57">   return DoDiscover();</span>
<a href="#l65.58"></a><span id="l65.58"> }</span>
<a href="#l65.59"></a><span id="l65.59"> </span>
<a href="#l65.60"></a><span id="l65.60" class="difflineminus">-NS_IMETHODIMP nsImportService::CreateNewFieldMap(nsIImportFieldMap **_retval)</span>
<a href="#l65.61"></a><span id="l65.61" class="difflineminus">-{</span>
<a href="#l65.62"></a><span id="l65.62" class="difflineminus">-  return nsImportFieldMap::Create(m_stringBundle, nullptr, NS_GET_IID(nsIImportFieldMap), (void**)_retval);</span>
<a href="#l65.63"></a><span id="l65.63" class="difflineplus">+NS_IMETHODIMP nsImportService::CreateNewFieldMap(nsIImportFieldMap **_retval) {</span>
<a href="#l65.64"></a><span id="l65.64" class="difflineplus">+  return nsImportFieldMap::Create(</span>
<a href="#l65.65"></a><span id="l65.65" class="difflineplus">+      m_stringBundle, nullptr, NS_GET_IID(nsIImportFieldMap), (void **)_retval);</span>
<a href="#l65.66"></a><span id="l65.66"> }</span>
<a href="#l65.67"></a><span id="l65.67"> </span>
<a href="#l65.68"></a><span id="l65.68" class="difflineminus">-NS_IMETHODIMP nsImportService::CreateNewMailboxDescriptor(nsIImportMailboxDescriptor **_retval)</span>
<a href="#l65.69"></a><span id="l65.69" class="difflineminus">-{</span>
<a href="#l65.70"></a><span id="l65.70" class="difflineminus">-  return nsImportMailboxDescriptor::Create(nullptr, NS_GET_IID(nsIImportMailboxDescriptor), (void**)_retval);</span>
<a href="#l65.71"></a><span id="l65.71" class="difflineplus">+NS_IMETHODIMP nsImportService::CreateNewMailboxDescriptor(</span>
<a href="#l65.72"></a><span id="l65.72" class="difflineplus">+    nsIImportMailboxDescriptor **_retval) {</span>
<a href="#l65.73"></a><span id="l65.73" class="difflineplus">+  return nsImportMailboxDescriptor::Create(</span>
<a href="#l65.74"></a><span id="l65.74" class="difflineplus">+      nullptr, NS_GET_IID(nsIImportMailboxDescriptor), (void **)_retval);</span>
<a href="#l65.75"></a><span id="l65.75"> }</span>
<a href="#l65.76"></a><span id="l65.76"> </span>
<a href="#l65.77"></a><span id="l65.77" class="difflineminus">-NS_IMETHODIMP nsImportService::CreateNewABDescriptor(nsIImportABDescriptor **_retval)</span>
<a href="#l65.78"></a><span id="l65.78" class="difflineminus">-{</span>
<a href="#l65.79"></a><span id="l65.79" class="difflineminus">-  return nsImportABDescriptor::Create(nullptr, NS_GET_IID(nsIImportABDescriptor), (void**)_retval);</span>
<a href="#l65.80"></a><span id="l65.80" class="difflineplus">+NS_IMETHODIMP nsImportService::CreateNewABDescriptor(</span>
<a href="#l65.81"></a><span id="l65.81" class="difflineplus">+    nsIImportABDescriptor **_retval) {</span>
<a href="#l65.82"></a><span id="l65.82" class="difflineplus">+  return nsImportABDescriptor::Create(</span>
<a href="#l65.83"></a><span id="l65.83" class="difflineplus">+      nullptr, NS_GET_IID(nsIImportABDescriptor), (void **)_retval);</span>
<a href="#l65.84"></a><span id="l65.84"> }</span>
<a href="#l65.85"></a><span id="l65.85"> </span>
<a href="#l65.86"></a><span id="l65.86" class="difflineminus">-extern nsresult NS_NewGenericMail(nsIImportGeneric** aImportGeneric);</span>
<a href="#l65.87"></a><span id="l65.87" class="difflineplus">+extern nsresult NS_NewGenericMail(nsIImportGeneric **aImportGeneric);</span>
<a href="#l65.88"></a><span id="l65.88"> </span>
<a href="#l65.89"></a><span id="l65.89" class="difflineminus">-NS_IMETHODIMP nsImportService::CreateNewGenericMail(nsIImportGeneric **_retval)</span>
<a href="#l65.90"></a><span id="l65.90" class="difflineminus">-{</span>
<a href="#l65.91"></a><span id="l65.91" class="difflineplus">+NS_IMETHODIMP nsImportService::CreateNewGenericMail(</span>
<a href="#l65.92"></a><span id="l65.92" class="difflineplus">+    nsIImportGeneric **_retval) {</span>
<a href="#l65.93"></a><span id="l65.93">   NS_ASSERTION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l65.94"></a><span id="l65.94" class="difflineminus">-  if (!_retval)</span>
<a href="#l65.95"></a><span id="l65.95" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l65.96"></a><span id="l65.96" class="difflineplus">+  if (!_retval) return NS_ERROR_NULL_POINTER;</span>
<a href="#l65.97"></a><span id="l65.97"> </span>
<a href="#l65.98"></a><span id="l65.98">   return NS_NewGenericMail(_retval);</span>
<a href="#l65.99"></a><span id="l65.99"> }</span>
<a href="#l65.100"></a><span id="l65.100"> </span>
<a href="#l65.101"></a><span id="l65.101" class="difflineminus">-extern nsresult NS_NewGenericAddressBooks(nsIImportGeneric** aImportGeneric);</span>
<a href="#l65.102"></a><span id="l65.102" class="difflineplus">+extern nsresult NS_NewGenericAddressBooks(nsIImportGeneric **aImportGeneric);</span>
<a href="#l65.103"></a><span id="l65.103"> </span>
<a href="#l65.104"></a><span id="l65.104" class="difflineminus">-NS_IMETHODIMP nsImportService::CreateNewGenericAddressBooks(nsIImportGeneric **_retval)</span>
<a href="#l65.105"></a><span id="l65.105" class="difflineminus">-{</span>
<a href="#l65.106"></a><span id="l65.106" class="difflineplus">+NS_IMETHODIMP nsImportService::CreateNewGenericAddressBooks(</span>
<a href="#l65.107"></a><span id="l65.107" class="difflineplus">+    nsIImportGeneric **_retval) {</span>
<a href="#l65.108"></a><span id="l65.108">   NS_ASSERTION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l65.109"></a><span id="l65.109" class="difflineminus">-  if (!_retval)</span>
<a href="#l65.110"></a><span id="l65.110" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l65.111"></a><span id="l65.111" class="difflineplus">+  if (!_retval) return NS_ERROR_NULL_POINTER;</span>
<a href="#l65.112"></a><span id="l65.112"> </span>
<a href="#l65.113"></a><span id="l65.113">   return NS_NewGenericAddressBooks(_retval);</span>
<a href="#l65.114"></a><span id="l65.114"> }</span>
<a href="#l65.115"></a><span id="l65.115"> </span>
<a href="#l65.116"></a><span id="l65.116" class="difflineminus">-</span>
<a href="#l65.117"></a><span id="l65.117" class="difflineminus">-NS_IMETHODIMP nsImportService::GetModuleCount(const char *filter, int32_t *_retval)</span>
<a href="#l65.118"></a><span id="l65.118" class="difflineminus">-{</span>
<a href="#l65.119"></a><span id="l65.119" class="difflineplus">+NS_IMETHODIMP nsImportService::GetModuleCount(const char *filter,</span>
<a href="#l65.120"></a><span id="l65.120" class="difflineplus">+                                              int32_t *_retval) {</span>
<a href="#l65.121"></a><span id="l65.121">   NS_ASSERTION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l65.122"></a><span id="l65.122" class="difflineminus">-  if (!_retval)</span>
<a href="#l65.123"></a><span id="l65.123" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l65.124"></a><span id="l65.124" class="difflineplus">+  if (!_retval) return NS_ERROR_NULL_POINTER;</span>
<a href="#l65.125"></a><span id="l65.125"> </span>
<a href="#l65.126"></a><span id="l65.126">   DoDiscover();</span>
<a href="#l65.127"></a><span id="l65.127"> </span>
<a href="#l65.128"></a><span id="l65.128">   if (m_pModules != nullptr) {</span>
<a href="#l65.129"></a><span id="l65.129" class="difflineminus">-    ImportModuleDesc *  pDesc;</span>
<a href="#l65.130"></a><span id="l65.130" class="difflineminus">-    int32_t  count = 0;</span>
<a href="#l65.131"></a><span id="l65.131" class="difflineplus">+    ImportModuleDesc *pDesc;</span>
<a href="#l65.132"></a><span id="l65.132" class="difflineplus">+    int32_t count = 0;</span>
<a href="#l65.133"></a><span id="l65.133">     for (int32_t i = 0; i &lt; m_pModules-&gt;GetCount(); i++) {</span>
<a href="#l65.134"></a><span id="l65.134">       pDesc = m_pModules-&gt;GetModuleDesc(i);</span>
<a href="#l65.135"></a><span id="l65.135" class="difflineminus">-      if (pDesc-&gt;SupportsThings(filter))</span>
<a href="#l65.136"></a><span id="l65.136" class="difflineminus">-        count++;</span>
<a href="#l65.137"></a><span id="l65.137" class="difflineplus">+      if (pDesc-&gt;SupportsThings(filter)) count++;</span>
<a href="#l65.138"></a><span id="l65.138">     }</span>
<a href="#l65.139"></a><span id="l65.139">     *_retval = count;</span>
<a href="#l65.140"></a><span id="l65.140" class="difflineminus">-  }</span>
<a href="#l65.141"></a><span id="l65.141" class="difflineminus">-  else</span>
<a href="#l65.142"></a><span id="l65.142" class="difflineplus">+  } else</span>
<a href="#l65.143"></a><span id="l65.143">     *_retval = 0;</span>
<a href="#l65.144"></a><span id="l65.144"> </span>
<a href="#l65.145"></a><span id="l65.145">   return NS_OK;</span>
<a href="#l65.146"></a><span id="l65.146"> }</span>
<a href="#l65.147"></a><span id="l65.147"> </span>
<a href="#l65.148"></a><span id="l65.148" class="difflineminus">-NS_IMETHODIMP nsImportService::GetModuleWithCID(const nsCID&amp; cid, nsIImportModule **ppModule)</span>
<a href="#l65.149"></a><span id="l65.149" class="difflineminus">-{</span>
<a href="#l65.150"></a><span id="l65.150" class="difflineplus">+NS_IMETHODIMP nsImportService::GetModuleWithCID(const nsCID &amp;cid,</span>
<a href="#l65.151"></a><span id="l65.151" class="difflineplus">+                                                nsIImportModule **ppModule) {</span>
<a href="#l65.152"></a><span id="l65.152">   NS_ASSERTION(ppModule != nullptr, &quot;null ptr&quot;);</span>
<a href="#l65.153"></a><span id="l65.153" class="difflineminus">-  if (!ppModule)</span>
<a href="#l65.154"></a><span id="l65.154" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l65.155"></a><span id="l65.155" class="difflineplus">+  if (!ppModule) return NS_ERROR_NULL_POINTER;</span>
<a href="#l65.156"></a><span id="l65.156"> </span>
<a href="#l65.157"></a><span id="l65.157">   *ppModule = nullptr;</span>
<a href="#l65.158"></a><span id="l65.158">   nsresult rv = DoDiscover();</span>
<a href="#l65.159"></a><span id="l65.159" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l65.160"></a><span id="l65.160" class="difflineminus">-    return rv;</span>
<a href="#l65.161"></a><span id="l65.161" class="difflineminus">-  if (m_pModules == nullptr)</span>
<a href="#l65.162"></a><span id="l65.162" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l65.163"></a><span id="l65.163" class="difflineminus">-  int32_t  cnt = m_pModules-&gt;GetCount();</span>
<a href="#l65.164"></a><span id="l65.164" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l65.165"></a><span id="l65.165" class="difflineplus">+  if (m_pModules == nullptr) return NS_ERROR_FAILURE;</span>
<a href="#l65.166"></a><span id="l65.166" class="difflineplus">+  int32_t cnt = m_pModules-&gt;GetCount();</span>
<a href="#l65.167"></a><span id="l65.167">   ImportModuleDesc *pDesc;</span>
<a href="#l65.168"></a><span id="l65.168">   for (int32_t i = 0; i &lt; cnt; i++) {</span>
<a href="#l65.169"></a><span id="l65.169">     pDesc = m_pModules-&gt;GetModuleDesc(i);</span>
<a href="#l65.170"></a><span id="l65.170" class="difflineminus">-    if (!pDesc)</span>
<a href="#l65.171"></a><span id="l65.171" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l65.172"></a><span id="l65.172" class="difflineplus">+    if (!pDesc) return NS_ERROR_FAILURE;</span>
<a href="#l65.173"></a><span id="l65.173">     if (pDesc-&gt;GetCID().Equals(cid)) {</span>
<a href="#l65.174"></a><span id="l65.174">       pDesc-&gt;GetModule(ppModule);</span>
<a href="#l65.175"></a><span id="l65.175"> </span>
<a href="#l65.176"></a><span id="l65.176" class="difflineminus">-      IMPORT_LOG0(&quot;* nsImportService::GetSpecificModule - attempted to load module\n&quot;);</span>
<a href="#l65.177"></a><span id="l65.177" class="difflineplus">+      IMPORT_LOG0(</span>
<a href="#l65.178"></a><span id="l65.178" class="difflineplus">+          &quot;* nsImportService::GetSpecificModule - attempted to load module\n&quot;);</span>
<a href="#l65.179"></a><span id="l65.179"> </span>
<a href="#l65.180"></a><span id="l65.180" class="difflineminus">-      if (*ppModule == nullptr)</span>
<a href="#l65.181"></a><span id="l65.181" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l65.182"></a><span id="l65.182" class="difflineplus">+      if (*ppModule == nullptr) return NS_ERROR_FAILURE;</span>
<a href="#l65.183"></a><span id="l65.183">       return NS_OK;</span>
<a href="#l65.184"></a><span id="l65.184">     }</span>
<a href="#l65.185"></a><span id="l65.185">   }</span>
<a href="#l65.186"></a><span id="l65.186"> </span>
<a href="#l65.187"></a><span id="l65.187">   IMPORT_LOG0(&quot;* nsImportService::GetSpecificModule - module not found\n&quot;);</span>
<a href="#l65.188"></a><span id="l65.188"> </span>
<a href="#l65.189"></a><span id="l65.189">   return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l65.190"></a><span id="l65.190"> }</span>
<a href="#l65.191"></a><span id="l65.191"> </span>
<a href="#l65.192"></a><span id="l65.192" class="difflineminus">-NS_IMETHODIMP nsImportService::GetModuleInfo(const char *filter, int32_t index, char16_t **name, char16_t **moduleDescription)</span>
<a href="#l65.193"></a><span id="l65.193" class="difflineminus">-{</span>
<a href="#l65.194"></a><span id="l65.194" class="difflineplus">+NS_IMETHODIMP nsImportService::GetModuleInfo(const char *filter, int32_t index,</span>
<a href="#l65.195"></a><span id="l65.195" class="difflineplus">+                                             char16_t **name,</span>
<a href="#l65.196"></a><span id="l65.196" class="difflineplus">+                                             char16_t **moduleDescription) {</span>
<a href="#l65.197"></a><span id="l65.197">   NS_ASSERTION(name != nullptr, &quot;null ptr&quot;);</span>
<a href="#l65.198"></a><span id="l65.198">   NS_ASSERTION(moduleDescription != nullptr, &quot;null ptr&quot;);</span>
<a href="#l65.199"></a><span id="l65.199" class="difflineminus">-  if (!name || !moduleDescription)</span>
<a href="#l65.200"></a><span id="l65.200" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l65.201"></a><span id="l65.201" class="difflineplus">+  if (!name || !moduleDescription) return NS_ERROR_NULL_POINTER;</span>
<a href="#l65.202"></a><span id="l65.202"> </span>
<a href="#l65.203"></a><span id="l65.203">   *name = nullptr;</span>
<a href="#l65.204"></a><span id="l65.204">   *moduleDescription = nullptr;</span>
<a href="#l65.205"></a><span id="l65.205"> </span>
<a href="#l65.206"></a><span id="l65.206">   DoDiscover();</span>
<a href="#l65.207"></a><span id="l65.207" class="difflineminus">-  if (!m_pModules)</span>
<a href="#l65.208"></a><span id="l65.208" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l65.209"></a><span id="l65.209" class="difflineplus">+  if (!m_pModules) return NS_ERROR_FAILURE;</span>
<a href="#l65.210"></a><span id="l65.210"> </span>
<a href="#l65.211"></a><span id="l65.211" class="difflineminus">-  if ((index &lt; 0) || (index &gt;= m_pModules-&gt;GetCount()))</span>
<a href="#l65.212"></a><span id="l65.212" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l65.213"></a><span id="l65.213" class="difflineplus">+  if ((index &lt; 0) || (index &gt;= m_pModules-&gt;GetCount())) return NS_ERROR_FAILURE;</span>
<a href="#l65.214"></a><span id="l65.214"> </span>
<a href="#l65.215"></a><span id="l65.215" class="difflineminus">-  ImportModuleDesc *  pDesc;</span>
<a href="#l65.216"></a><span id="l65.216" class="difflineminus">-  int32_t  count = 0;</span>
<a href="#l65.217"></a><span id="l65.217" class="difflineplus">+  ImportModuleDesc *pDesc;</span>
<a href="#l65.218"></a><span id="l65.218" class="difflineplus">+  int32_t count = 0;</span>
<a href="#l65.219"></a><span id="l65.219">   for (int32_t i = 0; i &lt; m_pModules-&gt;GetCount(); i++) {</span>
<a href="#l65.220"></a><span id="l65.220">     pDesc = m_pModules-&gt;GetModuleDesc(i);</span>
<a href="#l65.221"></a><span id="l65.221">     if (pDesc-&gt;SupportsThings(filter)) {</span>
<a href="#l65.222"></a><span id="l65.222">       if (count == index) {</span>
<a href="#l65.223"></a><span id="l65.223">         *name = NS_xstrdup(pDesc-&gt;GetName());</span>
<a href="#l65.224"></a><span id="l65.224">         *moduleDescription = NS_xstrdup(pDesc-&gt;GetDescription());</span>
<a href="#l65.225"></a><span id="l65.225">         return NS_OK;</span>
<a href="#l65.226"></a><span id="l65.226" class="difflineminus">-      }</span>
<a href="#l65.227"></a><span id="l65.227" class="difflineminus">-      else</span>
<a href="#l65.228"></a><span id="l65.228" class="difflineplus">+      } else</span>
<a href="#l65.229"></a><span id="l65.229">         count++;</span>
<a href="#l65.230"></a><span id="l65.230">     }</span>
<a href="#l65.231"></a><span id="l65.231">   }</span>
<a href="#l65.232"></a><span id="l65.232"> </span>
<a href="#l65.233"></a><span id="l65.233">   return NS_ERROR_FAILURE;</span>
<a href="#l65.234"></a><span id="l65.234"> }</span>
<a href="#l65.235"></a><span id="l65.235"> </span>
<a href="#l65.236"></a><span id="l65.236" class="difflineminus">-NS_IMETHODIMP nsImportService::GetModuleName(const char *filter, int32_t index, char16_t **_retval)</span>
<a href="#l65.237"></a><span id="l65.237" class="difflineminus">-{</span>
<a href="#l65.238"></a><span id="l65.238" class="difflineplus">+NS_IMETHODIMP nsImportService::GetModuleName(const char *filter, int32_t index,</span>
<a href="#l65.239"></a><span id="l65.239" class="difflineplus">+                                             char16_t **_retval) {</span>
<a href="#l65.240"></a><span id="l65.240">   NS_ASSERTION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l65.241"></a><span id="l65.241" class="difflineminus">-  if (!_retval)</span>
<a href="#l65.242"></a><span id="l65.242" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l65.243"></a><span id="l65.243" class="difflineplus">+  if (!_retval) return NS_ERROR_NULL_POINTER;</span>
<a href="#l65.244"></a><span id="l65.244"> </span>
<a href="#l65.245"></a><span id="l65.245">   *_retval = nullptr;</span>
<a href="#l65.246"></a><span id="l65.246"> </span>
<a href="#l65.247"></a><span id="l65.247">   DoDiscover();</span>
<a href="#l65.248"></a><span id="l65.248" class="difflineminus">-  if (!m_pModules)</span>
<a href="#l65.249"></a><span id="l65.249" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l65.250"></a><span id="l65.250" class="difflineplus">+  if (!m_pModules) return NS_ERROR_FAILURE;</span>
<a href="#l65.251"></a><span id="l65.251"> </span>
<a href="#l65.252"></a><span id="l65.252" class="difflineminus">-  if ((index &lt; 0) || (index &gt;= m_pModules-&gt;GetCount()))</span>
<a href="#l65.253"></a><span id="l65.253" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l65.254"></a><span id="l65.254" class="difflineplus">+  if ((index &lt; 0) || (index &gt;= m_pModules-&gt;GetCount())) return NS_ERROR_FAILURE;</span>
<a href="#l65.255"></a><span id="l65.255"> </span>
<a href="#l65.256"></a><span id="l65.256" class="difflineminus">-  ImportModuleDesc *  pDesc;</span>
<a href="#l65.257"></a><span id="l65.257" class="difflineminus">-  int32_t  count = 0;</span>
<a href="#l65.258"></a><span id="l65.258" class="difflineplus">+  ImportModuleDesc *pDesc;</span>
<a href="#l65.259"></a><span id="l65.259" class="difflineplus">+  int32_t count = 0;</span>
<a href="#l65.260"></a><span id="l65.260">   for (int32_t i = 0; i &lt; m_pModules-&gt;GetCount(); i++) {</span>
<a href="#l65.261"></a><span id="l65.261">     pDesc = m_pModules-&gt;GetModuleDesc(i);</span>
<a href="#l65.262"></a><span id="l65.262">     if (pDesc-&gt;SupportsThings(filter)) {</span>
<a href="#l65.263"></a><span id="l65.263">       if (count == index) {</span>
<a href="#l65.264"></a><span id="l65.264">         *_retval = NS_xstrdup(pDesc-&gt;GetName());</span>
<a href="#l65.265"></a><span id="l65.265">         return NS_OK;</span>
<a href="#l65.266"></a><span id="l65.266" class="difflineminus">-      }</span>
<a href="#l65.267"></a><span id="l65.267" class="difflineminus">-      else</span>
<a href="#l65.268"></a><span id="l65.268" class="difflineplus">+      } else</span>
<a href="#l65.269"></a><span id="l65.269">         count++;</span>
<a href="#l65.270"></a><span id="l65.270">     }</span>
<a href="#l65.271"></a><span id="l65.271">   }</span>
<a href="#l65.272"></a><span id="l65.272"> </span>
<a href="#l65.273"></a><span id="l65.273">   return NS_ERROR_FAILURE;</span>
<a href="#l65.274"></a><span id="l65.274"> }</span>
<a href="#l65.275"></a><span id="l65.275"> </span>
<a href="#l65.276"></a><span id="l65.276" class="difflineminus">-</span>
<a href="#l65.277"></a><span id="l65.277" class="difflineminus">-NS_IMETHODIMP nsImportService::GetModuleDescription(const char *filter, int32_t index, char16_t **_retval)</span>
<a href="#l65.278"></a><span id="l65.278" class="difflineminus">-{</span>
<a href="#l65.279"></a><span id="l65.279" class="difflineplus">+NS_IMETHODIMP nsImportService::GetModuleDescription(const char *filter,</span>
<a href="#l65.280"></a><span id="l65.280" class="difflineplus">+                                                    int32_t index,</span>
<a href="#l65.281"></a><span id="l65.281" class="difflineplus">+                                                    char16_t **_retval) {</span>
<a href="#l65.282"></a><span id="l65.282">   NS_ASSERTION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l65.283"></a><span id="l65.283" class="difflineminus">-  if (!_retval)</span>
<a href="#l65.284"></a><span id="l65.284" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l65.285"></a><span id="l65.285" class="difflineplus">+  if (!_retval) return NS_ERROR_NULL_POINTER;</span>
<a href="#l65.286"></a><span id="l65.286"> </span>
<a href="#l65.287"></a><span id="l65.287">   *_retval = nullptr;</span>
<a href="#l65.288"></a><span id="l65.288"> </span>
<a href="#l65.289"></a><span id="l65.289">   DoDiscover();</span>
<a href="#l65.290"></a><span id="l65.290" class="difflineminus">-  if (!m_pModules)</span>
<a href="#l65.291"></a><span id="l65.291" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l65.292"></a><span id="l65.292" class="difflineplus">+  if (!m_pModules) return NS_ERROR_FAILURE;</span>
<a href="#l65.293"></a><span id="l65.293"> </span>
<a href="#l65.294"></a><span id="l65.294" class="difflineminus">-  if ((index &lt; 0) || (index &gt;= m_pModules-&gt;GetCount()))</span>
<a href="#l65.295"></a><span id="l65.295" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l65.296"></a><span id="l65.296" class="difflineplus">+  if ((index &lt; 0) || (index &gt;= m_pModules-&gt;GetCount())) return NS_ERROR_FAILURE;</span>
<a href="#l65.297"></a><span id="l65.297"> </span>
<a href="#l65.298"></a><span id="l65.298" class="difflineminus">-  ImportModuleDesc *  pDesc;</span>
<a href="#l65.299"></a><span id="l65.299" class="difflineminus">-  int32_t  count = 0;</span>
<a href="#l65.300"></a><span id="l65.300" class="difflineplus">+  ImportModuleDesc *pDesc;</span>
<a href="#l65.301"></a><span id="l65.301" class="difflineplus">+  int32_t count = 0;</span>
<a href="#l65.302"></a><span id="l65.302">   for (int32_t i = 0; i &lt; m_pModules-&gt;GetCount(); i++) {</span>
<a href="#l65.303"></a><span id="l65.303">     pDesc = m_pModules-&gt;GetModuleDesc(i);</span>
<a href="#l65.304"></a><span id="l65.304">     if (pDesc-&gt;SupportsThings(filter)) {</span>
<a href="#l65.305"></a><span id="l65.305">       if (count == index) {</span>
<a href="#l65.306"></a><span id="l65.306">         *_retval = NS_xstrdup(pDesc-&gt;GetDescription());</span>
<a href="#l65.307"></a><span id="l65.307">         return NS_OK;</span>
<a href="#l65.308"></a><span id="l65.308" class="difflineminus">-      }</span>
<a href="#l65.309"></a><span id="l65.309" class="difflineminus">-      else</span>
<a href="#l65.310"></a><span id="l65.310" class="difflineplus">+      } else</span>
<a href="#l65.311"></a><span id="l65.311">         count++;</span>
<a href="#l65.312"></a><span id="l65.312">     }</span>
<a href="#l65.313"></a><span id="l65.313">   }</span>
<a href="#l65.314"></a><span id="l65.314"> </span>
<a href="#l65.315"></a><span id="l65.315">   return NS_ERROR_FAILURE;</span>
<a href="#l65.316"></a><span id="l65.316"> }</span>
<a href="#l65.317"></a><span id="l65.317"> </span>
<a href="#l65.318"></a><span id="l65.318" class="difflineminus">-class nsProxySendRunnable : public mozilla::Runnable</span>
<a href="#l65.319"></a><span id="l65.319" class="difflineminus">-{</span>
<a href="#l65.320"></a><span id="l65.320" class="difflineminus">-public:</span>
<a href="#l65.321"></a><span id="l65.321" class="difflineminus">-  nsProxySendRunnable(nsIMsgIdentity *aIdentity,</span>
<a href="#l65.322"></a><span id="l65.322" class="difflineminus">-                       nsIMsgCompFields *aMsgFields,</span>
<a href="#l65.323"></a><span id="l65.323" class="difflineminus">-                       const char *attachment1_type,</span>
<a href="#l65.324"></a><span id="l65.324" class="difflineminus">-                       const nsACString &amp;attachment1_body,</span>
<a href="#l65.325"></a><span id="l65.325" class="difflineminus">-                       bool aIsDraft,</span>
<a href="#l65.326"></a><span id="l65.326" class="difflineminus">-                       nsIArray *aLoadedAttachments,</span>
<a href="#l65.327"></a><span id="l65.327" class="difflineminus">-                       nsIArray *aEmbeddedAttachments,</span>
<a href="#l65.328"></a><span id="l65.328" class="difflineminus">-                       nsIMsgSendListener *aListener);</span>
<a href="#l65.329"></a><span id="l65.329" class="difflineplus">+class nsProxySendRunnable : public mozilla::Runnable {</span>
<a href="#l65.330"></a><span id="l65.330" class="difflineplus">+ public:</span>
<a href="#l65.331"></a><span id="l65.331" class="difflineplus">+  nsProxySendRunnable(nsIMsgIdentity *aIdentity, nsIMsgCompFields *aMsgFields,</span>
<a href="#l65.332"></a><span id="l65.332" class="difflineplus">+                      const char *attachment1_type,</span>
<a href="#l65.333"></a><span id="l65.333" class="difflineplus">+                      const nsACString &amp;attachment1_body, bool aIsDraft,</span>
<a href="#l65.334"></a><span id="l65.334" class="difflineplus">+                      nsIArray *aLoadedAttachments,</span>
<a href="#l65.335"></a><span id="l65.335" class="difflineplus">+                      nsIArray *aEmbeddedAttachments,</span>
<a href="#l65.336"></a><span id="l65.336" class="difflineplus">+                      nsIMsgSendListener *aListener);</span>
<a href="#l65.337"></a><span id="l65.337">   NS_DECL_NSIRUNNABLE</span>
<a href="#l65.338"></a><span id="l65.338" class="difflineminus">-private:</span>
<a href="#l65.339"></a><span id="l65.339" class="difflineplus">+ private:</span>
<a href="#l65.340"></a><span id="l65.340">   nsCOMPtr&lt;nsIMsgIdentity&gt; m_identity;</span>
<a href="#l65.341"></a><span id="l65.341">   nsCOMPtr&lt;nsIMsgCompFields&gt; m_compFields;</span>
<a href="#l65.342"></a><span id="l65.342">   bool m_isDraft;</span>
<a href="#l65.343"></a><span id="l65.343">   nsCString m_bodyType;</span>
<a href="#l65.344"></a><span id="l65.344">   nsCString m_body;</span>
<a href="#l65.345"></a><span id="l65.345">   nsCOMPtr&lt;nsIArray&gt; m_loadedAttachments;</span>
<a href="#l65.346"></a><span id="l65.346">   nsCOMPtr&lt;nsIArray&gt; m_embeddedAttachments;</span>
<a href="#l65.347"></a><span id="l65.347">   nsCOMPtr&lt;nsIMsgSendListener&gt; m_listener;</span>
<a href="#l65.348"></a><span id="l65.348" class="difflineminus">-</span>
<a href="#l65.349"></a><span id="l65.349"> };</span>
<a href="#l65.350"></a><span id="l65.350"> </span>
<a href="#l65.351"></a><span id="l65.351"> nsProxySendRunnable::nsProxySendRunnable(nsIMsgIdentity *aIdentity,</span>
<a href="#l65.352"></a><span id="l65.352">                                          nsIMsgCompFields *aMsgFields,</span>
<a href="#l65.353"></a><span id="l65.353">                                          const char *aBodyType,</span>
<a href="#l65.354"></a><span id="l65.354" class="difflineminus">-                                         const nsACString &amp;aBody,</span>
<a href="#l65.355"></a><span id="l65.355" class="difflineminus">-                                         bool aIsDraft,</span>
<a href="#l65.356"></a><span id="l65.356" class="difflineplus">+                                         const nsACString &amp;aBody, bool aIsDraft,</span>
<a href="#l65.357"></a><span id="l65.357">                                          nsIArray *aLoadedAttachments,</span>
<a href="#l65.358"></a><span id="l65.358">                                          nsIArray *aEmbeddedAttachments,</span>
<a href="#l65.359"></a><span id="l65.359" class="difflineminus">-                                         nsIMsgSendListener *aListener) :</span>
<a href="#l65.360"></a><span id="l65.360" class="difflineminus">-  mozilla::Runnable(&quot;nsProxySendRunnable&quot;),</span>
<a href="#l65.361"></a><span id="l65.361" class="difflineminus">-  m_identity(aIdentity), m_compFields(aMsgFields),</span>
<a href="#l65.362"></a><span id="l65.362" class="difflineminus">-  m_isDraft(aIsDraft), m_bodyType(aBodyType),</span>
<a href="#l65.363"></a><span id="l65.363" class="difflineminus">-  m_body(aBody), m_loadedAttachments(aLoadedAttachments),</span>
<a href="#l65.364"></a><span id="l65.364" class="difflineminus">-  m_embeddedAttachments(aEmbeddedAttachments),</span>
<a href="#l65.365"></a><span id="l65.365" class="difflineminus">-  m_listener(aListener)</span>
<a href="#l65.366"></a><span id="l65.366" class="difflineminus">-{</span>
<a href="#l65.367"></a><span id="l65.367" class="difflineminus">-}</span>
<a href="#l65.368"></a><span id="l65.368" class="difflineplus">+                                         nsIMsgSendListener *aListener)</span>
<a href="#l65.369"></a><span id="l65.369" class="difflineplus">+    : mozilla::Runnable(&quot;nsProxySendRunnable&quot;),</span>
<a href="#l65.370"></a><span id="l65.370" class="difflineplus">+      m_identity(aIdentity),</span>
<a href="#l65.371"></a><span id="l65.371" class="difflineplus">+      m_compFields(aMsgFields),</span>
<a href="#l65.372"></a><span id="l65.372" class="difflineplus">+      m_isDraft(aIsDraft),</span>
<a href="#l65.373"></a><span id="l65.373" class="difflineplus">+      m_bodyType(aBodyType),</span>
<a href="#l65.374"></a><span id="l65.374" class="difflineplus">+      m_body(aBody),</span>
<a href="#l65.375"></a><span id="l65.375" class="difflineplus">+      m_loadedAttachments(aLoadedAttachments),</span>
<a href="#l65.376"></a><span id="l65.376" class="difflineplus">+      m_embeddedAttachments(aEmbeddedAttachments),</span>
<a href="#l65.377"></a><span id="l65.377" class="difflineplus">+      m_listener(aListener) {}</span>
<a href="#l65.378"></a><span id="l65.378"> </span>
<a href="#l65.379"></a><span id="l65.379" class="difflineminus">-NS_IMETHODIMP nsProxySendRunnable::Run()</span>
<a href="#l65.380"></a><span id="l65.380" class="difflineminus">-{</span>
<a href="#l65.381"></a><span id="l65.381" class="difflineplus">+NS_IMETHODIMP nsProxySendRunnable::Run() {</span>
<a href="#l65.382"></a><span id="l65.382">   nsresult rv;</span>
<a href="#l65.383"></a><span id="l65.383">   nsCOMPtr&lt;nsIMsgSend&gt; msgSend = do_CreateInstance(NS_MSGSEND_CONTRACTID, &amp;rv);</span>
<a href="#l65.384"></a><span id="l65.384">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.385"></a><span id="l65.385"> </span>
<a href="#l65.386"></a><span id="l65.386" class="difflineminus">-  return msgSend-&gt;CreateRFC822Message(m_identity, m_compFields,</span>
<a href="#l65.387"></a><span id="l65.387" class="difflineminus">-                                      m_bodyType.get(), m_body,</span>
<a href="#l65.388"></a><span id="l65.388" class="difflineminus">-                                      m_isDraft, m_loadedAttachments,</span>
<a href="#l65.389"></a><span id="l65.389" class="difflineminus">-                                      m_embeddedAttachments,</span>
<a href="#l65.390"></a><span id="l65.390" class="difflineminus">-                                      m_listener);</span>
<a href="#l65.391"></a><span id="l65.391" class="difflineplus">+  return msgSend-&gt;CreateRFC822Message(</span>
<a href="#l65.392"></a><span id="l65.392" class="difflineplus">+      m_identity, m_compFields, m_bodyType.get(), m_body, m_isDraft,</span>
<a href="#l65.393"></a><span id="l65.393" class="difflineplus">+      m_loadedAttachments, m_embeddedAttachments, m_listener);</span>
<a href="#l65.394"></a><span id="l65.394"> }</span>
<a href="#l65.395"></a><span id="l65.395"> </span>
<a href="#l65.396"></a><span id="l65.396" class="difflineminus">-</span>
<a href="#l65.397"></a><span id="l65.397"> NS_IMETHODIMP</span>
<a href="#l65.398"></a><span id="l65.398"> nsImportService::CreateRFC822Message(nsIMsgIdentity *aIdentity,</span>
<a href="#l65.399"></a><span id="l65.399">                                      nsIMsgCompFields *aMsgFields,</span>
<a href="#l65.400"></a><span id="l65.400">                                      const char *aBodyType,</span>
<a href="#l65.401"></a><span id="l65.401" class="difflineminus">-                                     const nsACString &amp;aBody,</span>
<a href="#l65.402"></a><span id="l65.402" class="difflineminus">-                                     bool aIsDraft,</span>
<a href="#l65.403"></a><span id="l65.403" class="difflineplus">+                                     const nsACString &amp;aBody, bool aIsDraft,</span>
<a href="#l65.404"></a><span id="l65.404">                                      nsIArray *aLoadedAttachments,</span>
<a href="#l65.405"></a><span id="l65.405">                                      nsIArray *aEmbeddedAttachments,</span>
<a href="#l65.406"></a><span id="l65.406" class="difflineminus">-                                     nsIMsgSendListener *aListener)</span>
<a href="#l65.407"></a><span id="l65.407" class="difflineminus">-{</span>
<a href="#l65.408"></a><span id="l65.408" class="difflineminus">-    RefPtr&lt;nsProxySendRunnable&gt; runnable =</span>
<a href="#l65.409"></a><span id="l65.409" class="difflineminus">-      new nsProxySendRunnable(aIdentity,</span>
<a href="#l65.410"></a><span id="l65.410" class="difflineminus">-                              aMsgFields,</span>
<a href="#l65.411"></a><span id="l65.411" class="difflineminus">-                              aBodyType,</span>
<a href="#l65.412"></a><span id="l65.412" class="difflineminus">-                              aBody,</span>
<a href="#l65.413"></a><span id="l65.413" class="difflineminus">-                              aIsDraft,</span>
<a href="#l65.414"></a><span id="l65.414" class="difflineminus">-                              aLoadedAttachments,</span>
<a href="#l65.415"></a><span id="l65.415" class="difflineminus">-                              aEmbeddedAttachments,</span>
<a href="#l65.416"></a><span id="l65.416" class="difflineminus">-                              aListener);</span>
<a href="#l65.417"></a><span id="l65.417" class="difflineminus">-    // invoke the callback</span>
<a href="#l65.418"></a><span id="l65.418" class="difflineminus">-    return NS_DispatchToMainThread(runnable);</span>
<a href="#l65.419"></a><span id="l65.419" class="difflineplus">+                                     nsIMsgSendListener *aListener) {</span>
<a href="#l65.420"></a><span id="l65.420" class="difflineplus">+  RefPtr&lt;nsProxySendRunnable&gt; runnable = new nsProxySendRunnable(</span>
<a href="#l65.421"></a><span id="l65.421" class="difflineplus">+      aIdentity, aMsgFields, aBodyType, aBody, aIsDraft, aLoadedAttachments,</span>
<a href="#l65.422"></a><span id="l65.422" class="difflineplus">+      aEmbeddedAttachments, aListener);</span>
<a href="#l65.423"></a><span id="l65.423" class="difflineplus">+  // invoke the callback</span>
<a href="#l65.424"></a><span id="l65.424" class="difflineplus">+  return NS_DispatchToMainThread(runnable);</span>
<a href="#l65.425"></a><span id="l65.425"> }</span>
<a href="#l65.426"></a><span id="l65.426"> </span>
<a href="#l65.427"></a><span id="l65.427" class="difflineminus">-NS_IMETHODIMP nsImportService::GetModule(const char *filter, int32_t index, nsIImportModule **_retval)</span>
<a href="#l65.428"></a><span id="l65.428" class="difflineminus">-{</span>
<a href="#l65.429"></a><span id="l65.429" class="difflineplus">+NS_IMETHODIMP nsImportService::GetModule(const char *filter, int32_t index,</span>
<a href="#l65.430"></a><span id="l65.430" class="difflineplus">+                                         nsIImportModule **_retval) {</span>
<a href="#l65.431"></a><span id="l65.431">   NS_ASSERTION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l65.432"></a><span id="l65.432" class="difflineminus">-  if (!_retval)</span>
<a href="#l65.433"></a><span id="l65.433" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l65.434"></a><span id="l65.434" class="difflineplus">+  if (!_retval) return NS_ERROR_NULL_POINTER;</span>
<a href="#l65.435"></a><span id="l65.435">   *_retval = nullptr;</span>
<a href="#l65.436"></a><span id="l65.436"> </span>
<a href="#l65.437"></a><span id="l65.437">   DoDiscover();</span>
<a href="#l65.438"></a><span id="l65.438" class="difflineminus">-  if (!m_pModules)</span>
<a href="#l65.439"></a><span id="l65.439" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l65.440"></a><span id="l65.440" class="difflineplus">+  if (!m_pModules) return NS_ERROR_FAILURE;</span>
<a href="#l65.441"></a><span id="l65.441"> </span>
<a href="#l65.442"></a><span id="l65.442" class="difflineminus">-  if ((index &lt; 0) || (index &gt;= m_pModules-&gt;GetCount()))</span>
<a href="#l65.443"></a><span id="l65.443" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l65.444"></a><span id="l65.444" class="difflineplus">+  if ((index &lt; 0) || (index &gt;= m_pModules-&gt;GetCount())) return NS_ERROR_FAILURE;</span>
<a href="#l65.445"></a><span id="l65.445"> </span>
<a href="#l65.446"></a><span id="l65.446" class="difflineminus">-  ImportModuleDesc *  pDesc;</span>
<a href="#l65.447"></a><span id="l65.447" class="difflineminus">-  int32_t  count = 0;</span>
<a href="#l65.448"></a><span id="l65.448" class="difflineplus">+  ImportModuleDesc *pDesc;</span>
<a href="#l65.449"></a><span id="l65.449" class="difflineplus">+  int32_t count = 0;</span>
<a href="#l65.450"></a><span id="l65.450">   for (int32_t i = 0; i &lt; m_pModules-&gt;GetCount(); i++) {</span>
<a href="#l65.451"></a><span id="l65.451">     pDesc = m_pModules-&gt;GetModuleDesc(i);</span>
<a href="#l65.452"></a><span id="l65.452">     if (pDesc-&gt;SupportsThings(filter)) {</span>
<a href="#l65.453"></a><span id="l65.453">       if (count == index) {</span>
<a href="#l65.454"></a><span id="l65.454">         pDesc-&gt;GetModule(_retval);</span>
<a href="#l65.455"></a><span id="l65.455">         break;</span>
<a href="#l65.456"></a><span id="l65.456" class="difflineminus">-      }</span>
<a href="#l65.457"></a><span id="l65.457" class="difflineminus">-      else</span>
<a href="#l65.458"></a><span id="l65.458" class="difflineplus">+      } else</span>
<a href="#l65.459"></a><span id="l65.459">         count++;</span>
<a href="#l65.460"></a><span id="l65.460">     }</span>
<a href="#l65.461"></a><span id="l65.461">   }</span>
<a href="#l65.462"></a><span id="l65.462" class="difflineminus">-  if (!(*_retval))</span>
<a href="#l65.463"></a><span id="l65.463" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l65.464"></a><span id="l65.464" class="difflineplus">+  if (!(*_retval)) return NS_ERROR_FAILURE;</span>
<a href="#l65.465"></a><span id="l65.465"> </span>
<a href="#l65.466"></a><span id="l65.466">   return NS_OK;</span>
<a href="#l65.467"></a><span id="l65.467"> }</span>
<a href="#l65.468"></a><span id="l65.468"> </span>
<a href="#l65.469"></a><span id="l65.469" class="difflineplus">+nsresult nsImportService::DoDiscover(void) {</span>
<a href="#l65.470"></a><span id="l65.470" class="difflineplus">+  if (m_didDiscovery) return NS_OK;</span>
<a href="#l65.471"></a><span id="l65.471"> </span>
<a href="#l65.472"></a><span id="l65.472" class="difflineminus">-nsresult nsImportService::DoDiscover(void)</span>
<a href="#l65.473"></a><span id="l65.473" class="difflineminus">-{</span>
<a href="#l65.474"></a><span id="l65.474" class="difflineminus">-  if (m_didDiscovery)</span>
<a href="#l65.475"></a><span id="l65.475" class="difflineminus">-    return NS_OK;</span>
<a href="#l65.476"></a><span id="l65.476" class="difflineminus">-</span>
<a href="#l65.477"></a><span id="l65.477" class="difflineminus">-  if (m_pModules != nullptr)</span>
<a href="#l65.478"></a><span id="l65.478" class="difflineminus">-    m_pModules-&gt;ClearList();</span>
<a href="#l65.479"></a><span id="l65.479" class="difflineplus">+  if (m_pModules != nullptr) m_pModules-&gt;ClearList();</span>
<a href="#l65.480"></a><span id="l65.480"> </span>
<a href="#l65.481"></a><span id="l65.481">   nsresult rv;</span>
<a href="#l65.482"></a><span id="l65.482"> </span>
<a href="#l65.483"></a><span id="l65.483" class="difflineminus">-  nsCOMPtr&lt;nsICategoryManager&gt; catMan = do_GetService(NS_CATEGORYMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l65.484"></a><span id="l65.484" class="difflineplus">+  nsCOMPtr&lt;nsICategoryManager&gt; catMan =</span>
<a href="#l65.485"></a><span id="l65.485" class="difflineplus">+      do_GetService(NS_CATEGORYMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l65.486"></a><span id="l65.486">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.487"></a><span id="l65.487"> </span>
<a href="#l65.488"></a><span id="l65.488">   nsCOMPtr&lt;nsISimpleEnumerator&gt; e;</span>
<a href="#l65.489"></a><span id="l65.489">   rv = catMan-&gt;EnumerateCategory(&quot;mailnewsimport&quot;, getter_AddRefs(e));</span>
<a href="#l65.490"></a><span id="l65.490">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.491"></a><span id="l65.491">   nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l65.492"></a><span id="l65.492">   nsCOMPtr&lt;nsISupportsCString&gt; contractid;</span>
<a href="#l65.493"></a><span id="l65.493">   rv = e-&gt;GetNext(getter_AddRefs(supports));</span>
<a href="#l65.494"></a><span id="l65.494" class="difflineminus">-  while (NS_SUCCEEDED(rv) &amp;&amp; supports)</span>
<a href="#l65.495"></a><span id="l65.495" class="difflineminus">-  {</span>
<a href="#l65.496"></a><span id="l65.496" class="difflineplus">+  while (NS_SUCCEEDED(rv) &amp;&amp; supports) {</span>
<a href="#l65.497"></a><span id="l65.497">     contractid = do_QueryInterface(supports);</span>
<a href="#l65.498"></a><span id="l65.498" class="difflineminus">-    if (!contractid)</span>
<a href="#l65.499"></a><span id="l65.499" class="difflineminus">-      break;</span>
<a href="#l65.500"></a><span id="l65.500" class="difflineplus">+    if (!contractid) break;</span>
<a href="#l65.501"></a><span id="l65.501"> </span>
<a href="#l65.502"></a><span id="l65.502">     nsCString contractIdStr;</span>
<a href="#l65.503"></a><span id="l65.503">     contractid-&gt;ToString(getter_Copies(contractIdStr));</span>
<a href="#l65.504"></a><span id="l65.504">     nsCString supportsStr;</span>
<a href="#l65.505"></a><span id="l65.505">     rv = catMan-&gt;GetCategoryEntry(&quot;mailnewsimport&quot;, contractIdStr, supportsStr);</span>
<a href="#l65.506"></a><span id="l65.506">     if (NS_SUCCEEDED(rv))</span>
<a href="#l65.507"></a><span id="l65.507">       LoadModuleInfo(contractIdStr.get(), supportsStr.get());</span>
<a href="#l65.508"></a><span id="l65.508">     rv = e-&gt;GetNext(getter_AddRefs(supports));</span>
<a href="#l65.509"></a><span id="l65.509">   }</span>
<a href="#l65.510"></a><span id="l65.510"> </span>
<a href="#l65.511"></a><span id="l65.511">   m_didDiscovery = true;</span>
<a href="#l65.512"></a><span id="l65.512"> </span>
<a href="#l65.513"></a><span id="l65.513">   return NS_OK;</span>
<a href="#l65.514"></a><span id="l65.514"> }</span>
<a href="#l65.515"></a><span id="l65.515"> </span>
<a href="#l65.516"></a><span id="l65.516" class="difflineminus">-nsresult nsImportService::LoadModuleInfo(const char *pClsId, const char *pSupports)</span>
<a href="#l65.517"></a><span id="l65.517" class="difflineminus">-{</span>
<a href="#l65.518"></a><span id="l65.518" class="difflineminus">-  if (!pClsId || !pSupports)</span>
<a href="#l65.519"></a><span id="l65.519" class="difflineminus">-    return NS_OK;</span>
<a href="#l65.520"></a><span id="l65.520" class="difflineplus">+nsresult nsImportService::LoadModuleInfo(const char *pClsId,</span>
<a href="#l65.521"></a><span id="l65.521" class="difflineplus">+                                         const char *pSupports) {</span>
<a href="#l65.522"></a><span id="l65.522" class="difflineplus">+  if (!pClsId || !pSupports) return NS_OK;</span>
<a href="#l65.523"></a><span id="l65.523"> </span>
<a href="#l65.524"></a><span id="l65.524" class="difflineminus">-  if (m_pModules == nullptr)</span>
<a href="#l65.525"></a><span id="l65.525" class="difflineminus">-    m_pModules = new nsImportModuleList();</span>
<a href="#l65.526"></a><span id="l65.526" class="difflineplus">+  if (m_pModules == nullptr) m_pModules = new nsImportModuleList();</span>
<a href="#l65.527"></a><span id="l65.527"> </span>
<a href="#l65.528"></a><span id="l65.528">   // load the component and get all of the info we need from it....</span>
<a href="#l65.529"></a><span id="l65.529">   // then call AddModule</span>
<a href="#l65.530"></a><span id="l65.530" class="difflineminus">-  nsresult  rv;</span>
<a href="#l65.531"></a><span id="l65.531" class="difflineplus">+  nsresult rv;</span>
<a href="#l65.532"></a><span id="l65.532"> </span>
<a href="#l65.533"></a><span id="l65.533" class="difflineminus">-  nsCID        clsId;</span>
<a href="#l65.534"></a><span id="l65.534" class="difflineplus">+  nsCID clsId;</span>
<a href="#l65.535"></a><span id="l65.535">   clsId.Parse(pClsId);</span>
<a href="#l65.536"></a><span id="l65.536">   nsCOMPtr&lt;nsIImportModule&gt; module = do_CreateInstance(clsId, &amp;rv);</span>
<a href="#l65.537"></a><span id="l65.537">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l65.538"></a><span id="l65.538"> </span>
<a href="#l65.539"></a><span id="l65.539" class="difflineminus">-  nsString  theTitle;</span>
<a href="#l65.540"></a><span id="l65.540" class="difflineminus">-  nsString  theDescription;</span>
<a href="#l65.541"></a><span id="l65.541" class="difflineplus">+  nsString theTitle;</span>
<a href="#l65.542"></a><span id="l65.542" class="difflineplus">+  nsString theDescription;</span>
<a href="#l65.543"></a><span id="l65.543">   rv = module-&gt;GetName(getter_Copies(theTitle));</span>
<a href="#l65.544"></a><span id="l65.544" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l65.545"></a><span id="l65.545" class="difflineminus">-    theTitle.AssignLiteral(&quot;Unknown&quot;);</span>
<a href="#l65.546"></a><span id="l65.546" class="difflineplus">+  if (NS_FAILED(rv)) theTitle.AssignLiteral(&quot;Unknown&quot;);</span>
<a href="#l65.547"></a><span id="l65.547"> </span>
<a href="#l65.548"></a><span id="l65.548">   rv = module-&gt;GetDescription(getter_Copies(theDescription));</span>
<a href="#l65.549"></a><span id="l65.549" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l65.550"></a><span id="l65.550" class="difflineminus">-    theDescription.AssignLiteral(&quot;Unknown description&quot;);</span>
<a href="#l65.551"></a><span id="l65.551" class="difflineplus">+  if (NS_FAILED(rv)) theDescription.AssignLiteral(&quot;Unknown description&quot;);</span>
<a href="#l65.552"></a><span id="l65.552"> </span>
<a href="#l65.553"></a><span id="l65.553">   // call the module to get the info we need</span>
<a href="#l65.554"></a><span id="l65.554">   m_pModules-&gt;AddModule(clsId, pSupports, theTitle.get(), theDescription.get());</span>
<a href="#l65.555"></a><span id="l65.555"> </span>
<a href="#l65.556"></a><span id="l65.556">   return NS_OK;</span>
<a href="#l65.557"></a><span id="l65.557"> }</span>
<a href="#l65.558"></a><span id="l65.558"> </span>
<a href="#l65.559"></a><span id="l65.559"> // XXX This should return already_AddRefed.</span>
<a href="#l65.560"></a><span id="l65.560" class="difflineminus">-void ImportModuleDesc::GetModule(nsIImportModule **_retval)</span>
<a href="#l65.561"></a><span id="l65.561" class="difflineminus">-{</span>
<a href="#l65.562"></a><span id="l65.562" class="difflineminus">-  if (!m_pModule)</span>
<a href="#l65.563"></a><span id="l65.563" class="difflineminus">-  {</span>
<a href="#l65.564"></a><span id="l65.564" class="difflineminus">-    nsresult  rv;</span>
<a href="#l65.565"></a><span id="l65.565" class="difflineplus">+void ImportModuleDesc::GetModule(nsIImportModule **_retval) {</span>
<a href="#l65.566"></a><span id="l65.566" class="difflineplus">+  if (!m_pModule) {</span>
<a href="#l65.567"></a><span id="l65.567" class="difflineplus">+    nsresult rv;</span>
<a href="#l65.568"></a><span id="l65.568">     m_pModule = do_CreateInstance(m_cid, &amp;rv);</span>
<a href="#l65.569"></a><span id="l65.569" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l65.570"></a><span id="l65.570" class="difflineminus">-      m_pModule = nullptr;</span>
<a href="#l65.571"></a><span id="l65.571" class="difflineplus">+    if (NS_FAILED(rv)) m_pModule = nullptr;</span>
<a href="#l65.572"></a><span id="l65.572">   }</span>
<a href="#l65.573"></a><span id="l65.573"> </span>
<a href="#l65.574"></a><span id="l65.574">   NS_IF_ADDREF(*_retval = m_pModule);</span>
<a href="#l65.575"></a><span id="l65.575">   return;</span>
<a href="#l65.576"></a><span id="l65.576"> }</span>
<a href="#l65.577"></a><span id="l65.577"> </span>
<a href="#l65.578"></a><span id="l65.578" class="difflineminus">-void ImportModuleDesc::ReleaseModule(void)</span>
<a href="#l65.579"></a><span id="l65.579" class="difflineminus">-{</span>
<a href="#l65.580"></a><span id="l65.580" class="difflineminus">-  m_pModule = nullptr;</span>
<a href="#l65.581"></a><span id="l65.581" class="difflineminus">-}</span>
<a href="#l65.582"></a><span id="l65.582" class="difflineplus">+void ImportModuleDesc::ReleaseModule(void) { m_pModule = nullptr; }</span>
<a href="#l65.583"></a><span id="l65.583"> </span>
<a href="#l65.584"></a><span id="l65.584" class="difflineminus">-bool ImportModuleDesc::SupportsThings(const char *pThings)</span>
<a href="#l65.585"></a><span id="l65.585" class="difflineminus">-{</span>
<a href="#l65.586"></a><span id="l65.586" class="difflineminus">-  if (!pThings || !*pThings)</span>
<a href="#l65.587"></a><span id="l65.587" class="difflineminus">-    return true;</span>
<a href="#l65.588"></a><span id="l65.588" class="difflineplus">+bool ImportModuleDesc::SupportsThings(const char *pThings) {</span>
<a href="#l65.589"></a><span id="l65.589" class="difflineplus">+  if (!pThings || !*pThings) return true;</span>
<a href="#l65.590"></a><span id="l65.590"> </span>
<a href="#l65.591"></a><span id="l65.591">   nsCString thing(pThings);</span>
<a href="#l65.592"></a><span id="l65.592">   nsCString item;</span>
<a href="#l65.593"></a><span id="l65.593">   int32_t idx;</span>
<a href="#l65.594"></a><span id="l65.594"> </span>
<a href="#l65.595"></a><span id="l65.595" class="difflineminus">-  while ((idx = thing.FindChar(',')) != -1)</span>
<a href="#l65.596"></a><span id="l65.596" class="difflineminus">-  {</span>
<a href="#l65.597"></a><span id="l65.597" class="difflineplus">+  while ((idx = thing.FindChar(',')) != -1) {</span>
<a href="#l65.598"></a><span id="l65.598">     item = StringHead(thing, idx);</span>
<a href="#l65.599"></a><span id="l65.599">     item.Trim(kWhitespace);</span>
<a href="#l65.600"></a><span id="l65.600">     ToLowerCase(item);</span>
<a href="#l65.601"></a><span id="l65.601" class="difflineminus">-    if (item.Length() &amp;&amp; (m_supports.Find(item) == -1))</span>
<a href="#l65.602"></a><span id="l65.602" class="difflineminus">-      return false;</span>
<a href="#l65.603"></a><span id="l65.603" class="difflineplus">+    if (item.Length() &amp;&amp; (m_supports.Find(item) == -1)) return false;</span>
<a href="#l65.604"></a><span id="l65.604">     thing = Substring(thing, idx + 1);</span>
<a href="#l65.605"></a><span id="l65.605">   }</span>
<a href="#l65.606"></a><span id="l65.606">   thing.Trim(kWhitespace);</span>
<a href="#l65.607"></a><span id="l65.607">   ToLowerCase(thing);</span>
<a href="#l65.608"></a><span id="l65.608">   return thing.IsEmpty() || (m_supports.Find(thing) != -1);</span>
<a href="#l65.609"></a><span id="l65.609"> }</span>
<a href="#l65.610"></a><span id="l65.610"> </span>
<a href="#l65.611"></a><span id="l65.611" class="difflineminus">-void nsImportModuleList::ClearList(void)</span>
<a href="#l65.612"></a><span id="l65.612" class="difflineminus">-{</span>
<a href="#l65.613"></a><span id="l65.613" class="difflineminus">-  if (m_pList)</span>
<a href="#l65.614"></a><span id="l65.614" class="difflineminus">-  {</span>
<a href="#l65.615"></a><span id="l65.615" class="difflineminus">-    for (int i = 0; i &lt; m_count; i++)</span>
<a href="#l65.616"></a><span id="l65.616" class="difflineminus">-    {</span>
<a href="#l65.617"></a><span id="l65.617" class="difflineplus">+void nsImportModuleList::ClearList(void) {</span>
<a href="#l65.618"></a><span id="l65.618" class="difflineplus">+  if (m_pList) {</span>
<a href="#l65.619"></a><span id="l65.619" class="difflineplus">+    for (int i = 0; i &lt; m_count; i++) {</span>
<a href="#l65.620"></a><span id="l65.620">       delete m_pList[i];</span>
<a href="#l65.621"></a><span id="l65.621">       m_pList[i] = nullptr;</span>
<a href="#l65.622"></a><span id="l65.622">     }</span>
<a href="#l65.623"></a><span id="l65.623">     m_count = 0;</span>
<a href="#l65.624"></a><span id="l65.624" class="difflineminus">-    delete [] m_pList;</span>
<a href="#l65.625"></a><span id="l65.625" class="difflineplus">+    delete[] m_pList;</span>
<a href="#l65.626"></a><span id="l65.626">     m_pList = nullptr;</span>
<a href="#l65.627"></a><span id="l65.627">     m_alloc = 0;</span>
<a href="#l65.628"></a><span id="l65.628">   }</span>
<a href="#l65.629"></a><span id="l65.629" class="difflineminus">-</span>
<a href="#l65.630"></a><span id="l65.630"> }</span>
<a href="#l65.631"></a><span id="l65.631"> </span>
<a href="#l65.632"></a><span id="l65.632" class="difflineminus">-void nsImportModuleList::AddModule(const nsCID&amp; cid, const char *pSupports, const char16_t *pName, const char16_t *pDesc)</span>
<a href="#l65.633"></a><span id="l65.633" class="difflineminus">-{</span>
<a href="#l65.634"></a><span id="l65.634" class="difflineminus">-  if (!m_pList)</span>
<a href="#l65.635"></a><span id="l65.635" class="difflineminus">-  {</span>
<a href="#l65.636"></a><span id="l65.636" class="difflineplus">+void nsImportModuleList::AddModule(const nsCID &amp;cid, const char *pSupports,</span>
<a href="#l65.637"></a><span id="l65.637" class="difflineplus">+                                   const char16_t *pName,</span>
<a href="#l65.638"></a><span id="l65.638" class="difflineplus">+                                   const char16_t *pDesc) {</span>
<a href="#l65.639"></a><span id="l65.639" class="difflineplus">+  if (!m_pList) {</span>
<a href="#l65.640"></a><span id="l65.640">     m_alloc = 10;</span>
<a href="#l65.641"></a><span id="l65.641">     m_pList = new ImportModuleDesc *[m_alloc];</span>
<a href="#l65.642"></a><span id="l65.642">     m_count = 0;</span>
<a href="#l65.643"></a><span id="l65.643">     memset(m_pList, 0, sizeof(ImportModuleDesc *) * m_alloc);</span>
<a href="#l65.644"></a><span id="l65.644">   }</span>
<a href="#l65.645"></a><span id="l65.645"> </span>
<a href="#l65.646"></a><span id="l65.646" class="difflineminus">-  if (m_count == m_alloc)</span>
<a href="#l65.647"></a><span id="l65.647" class="difflineminus">-  {</span>
<a href="#l65.648"></a><span id="l65.648" class="difflineplus">+  if (m_count == m_alloc) {</span>
<a href="#l65.649"></a><span id="l65.649">     ImportModuleDesc **pList = new ImportModuleDesc *[m_alloc + 10];</span>
<a href="#l65.650"></a><span id="l65.650">     memset(&amp;(pList[m_alloc]), 0, sizeof(ImportModuleDesc *) * 10);</span>
<a href="#l65.651"></a><span id="l65.651">     memcpy(pList, m_pList, sizeof(ImportModuleDesc *) * m_alloc);</span>
<a href="#l65.652"></a><span id="l65.652" class="difflineminus">-    for(int i = 0; i &lt; m_count; i++)</span>
<a href="#l65.653"></a><span id="l65.653" class="difflineminus">-      delete m_pList[i];</span>
<a href="#l65.654"></a><span id="l65.654" class="difflineminus">-    delete [] m_pList;</span>
<a href="#l65.655"></a><span id="l65.655" class="difflineplus">+    for (int i = 0; i &lt; m_count; i++) delete m_pList[i];</span>
<a href="#l65.656"></a><span id="l65.656" class="difflineplus">+    delete[] m_pList;</span>
<a href="#l65.657"></a><span id="l65.657">     m_pList = pList;</span>
<a href="#l65.658"></a><span id="l65.658">     m_alloc += 10;</span>
<a href="#l65.659"></a><span id="l65.659">   }</span>
<a href="#l65.660"></a><span id="l65.660"> </span>
<a href="#l65.661"></a><span id="l65.661">   m_pList[m_count] = new ImportModuleDesc();</span>
<a href="#l65.662"></a><span id="l65.662">   m_pList[m_count]-&gt;SetCID(cid);</span>
<a href="#l65.663"></a><span id="l65.663">   m_pList[m_count]-&gt;SetSupports(pSupports);</span>
<a href="#l65.664"></a><span id="l65.664">   m_pList[m_count]-&gt;SetName(pName);</span>
<a href="#l65.665"></a><span id="l65.665">   m_pList[m_count]-&gt;SetDescription(pDesc);</span>
<a href="#l65.666"></a><span id="l65.666"> </span>
<a href="#l65.667"></a><span id="l65.667">   m_count++;</span>
<a href="#l65.668"></a><span id="l65.668"> #ifdef IMPORT_DEBUG</span>
<a href="#l65.669"></a><span id="l65.669" class="difflineminus">-  IMPORT_LOG3(&quot;* nsImportService registered import module: %s, %s, %s\n&quot;, NS_LossyConvertUTF16toASCII(pName).get(), NS_LossyConvertUTF16toASCII(pDesc).get(), pSupports);</span>
<a href="#l65.670"></a><span id="l65.670" class="difflineplus">+  IMPORT_LOG3(&quot;* nsImportService registered import module: %s, %s, %s\n&quot;,</span>
<a href="#l65.671"></a><span id="l65.671" class="difflineplus">+              NS_LossyConvertUTF16toASCII(pName).get(),</span>
<a href="#l65.672"></a><span id="l65.672" class="difflineplus">+              NS_LossyConvertUTF16toASCII(pDesc).get(), pSupports);</span>
<a href="#l65.673"></a><span id="l65.673"> #endif</span>
<a href="#l65.674"></a><span id="l65.674"> }</span>
<a href="#l65.675"></a><span id="l65.675" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l66.1"></a><span id="l66.1" class="difflineminus">--- a/mailnews/import/src/nsImportService.h</span>
<a href="#l66.2"></a><span id="l66.2" class="difflineplus">+++ b/mailnews/import/src/nsImportService.h</span>
<a href="#l66.3"></a><span id="l66.3" class="difflineat">@@ -9,80 +9,86 @@</span>
<a href="#l66.4"></a><span id="l66.4"> #include &quot;nsString.h&quot;</span>
<a href="#l66.5"></a><span id="l66.5"> #include &quot;nsMemory.h&quot;</span>
<a href="#l66.6"></a><span id="l66.6"> #include &quot;nsIImportModule.h&quot;</span>
<a href="#l66.7"></a><span id="l66.7"> #include &quot;nsIImportService.h&quot;</span>
<a href="#l66.8"></a><span id="l66.8"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l66.9"></a><span id="l66.9"> </span>
<a href="#l66.10"></a><span id="l66.10"> class nsImportModuleList;</span>
<a href="#l66.11"></a><span id="l66.11"> </span>
<a href="#l66.12"></a><span id="l66.12" class="difflineminus">-class nsImportService : public nsIImportService</span>
<a href="#l66.13"></a><span id="l66.13" class="difflineminus">-{</span>
<a href="#l66.14"></a><span id="l66.14" class="difflineminus">-public:</span>
<a href="#l66.15"></a><span id="l66.15" class="difflineminus">-</span>
<a href="#l66.16"></a><span id="l66.16" class="difflineplus">+class nsImportService : public nsIImportService {</span>
<a href="#l66.17"></a><span id="l66.17" class="difflineplus">+ public:</span>
<a href="#l66.18"></a><span id="l66.18">   nsImportService();</span>
<a href="#l66.19"></a><span id="l66.19"> </span>
<a href="#l66.20"></a><span id="l66.20">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l66.21"></a><span id="l66.21">   NS_DECL_NSIIMPORTSERVICE</span>
<a href="#l66.22"></a><span id="l66.22"> </span>
<a href="#l66.23"></a><span id="l66.23" class="difflineminus">-private:</span>
<a href="#l66.24"></a><span id="l66.24" class="difflineplus">+ private:</span>
<a href="#l66.25"></a><span id="l66.25">   virtual ~nsImportService();</span>
<a href="#l66.26"></a><span id="l66.26" class="difflineminus">-  nsresult LoadModuleInfo(const char*pClsId, const char *pSupports);</span>
<a href="#l66.27"></a><span id="l66.27" class="difflineplus">+  nsresult LoadModuleInfo(const char *pClsId, const char *pSupports);</span>
<a href="#l66.28"></a><span id="l66.28">   nsresult DoDiscover(void);</span>
<a href="#l66.29"></a><span id="l66.29"> </span>
<a href="#l66.30"></a><span id="l66.30" class="difflineminus">-private:</span>
<a href="#l66.31"></a><span id="l66.31" class="difflineminus">-  nsImportModuleList * m_pModules;</span>
<a href="#l66.32"></a><span id="l66.32" class="difflineplus">+ private:</span>
<a href="#l66.33"></a><span id="l66.33" class="difflineplus">+  nsImportModuleList *m_pModules;</span>
<a href="#l66.34"></a><span id="l66.34">   bool m_didDiscovery;</span>
<a href="#l66.35"></a><span id="l66.35">   nsCString m_sysCharset;</span>
<a href="#l66.36"></a><span id="l66.36">   nsCOMPtr&lt;nsIStringBundle&gt; m_stringBundle;</span>
<a href="#l66.37"></a><span id="l66.37"> };</span>
<a href="#l66.38"></a><span id="l66.38"> </span>
<a href="#l66.39"></a><span id="l66.39"> class ImportModuleDesc {</span>
<a href="#l66.40"></a><span id="l66.40" class="difflineminus">-public:</span>
<a href="#l66.41"></a><span id="l66.41" class="difflineminus">-  ImportModuleDesc() { m_pModule = nullptr;}</span>
<a href="#l66.42"></a><span id="l66.42" class="difflineminus">-  ~ImportModuleDesc() { ReleaseModule();  }</span>
<a href="#l66.43"></a><span id="l66.43" class="difflineplus">+ public:</span>
<a href="#l66.44"></a><span id="l66.44" class="difflineplus">+  ImportModuleDesc() { m_pModule = nullptr; }</span>
<a href="#l66.45"></a><span id="l66.45" class="difflineplus">+  ~ImportModuleDesc() { ReleaseModule(); }</span>
<a href="#l66.46"></a><span id="l66.46"> </span>
<a href="#l66.47"></a><span id="l66.47" class="difflineminus">-  void  SetCID(const nsCID&amp; cid) { m_cid = cid;}</span>
<a href="#l66.48"></a><span id="l66.48" class="difflineminus">-  void  SetName(const char16_t *pName) { m_name = pName;}</span>
<a href="#l66.49"></a><span id="l66.49" class="difflineminus">-  void  SetDescription(const char16_t *pDesc) { m_description = pDesc;}</span>
<a href="#l66.50"></a><span id="l66.50" class="difflineminus">-  void  SetSupports(const char *pSupports) { m_supports = pSupports;}</span>
<a href="#l66.51"></a><span id="l66.51" class="difflineplus">+  void SetCID(const nsCID &amp;cid) { m_cid = cid; }</span>
<a href="#l66.52"></a><span id="l66.52" class="difflineplus">+  void SetName(const char16_t *pName) { m_name = pName; }</span>
<a href="#l66.53"></a><span id="l66.53" class="difflineplus">+  void SetDescription(const char16_t *pDesc) { m_description = pDesc; }</span>
<a href="#l66.54"></a><span id="l66.54" class="difflineplus">+  void SetSupports(const char *pSupports) { m_supports = pSupports; }</span>
<a href="#l66.55"></a><span id="l66.55"> </span>
<a href="#l66.56"></a><span id="l66.56" class="difflineminus">-  nsCID      GetCID(void) { return m_cid;}</span>
<a href="#l66.57"></a><span id="l66.57" class="difflineminus">-  const char16_t *GetName(void) { return m_name.get();}</span>
<a href="#l66.58"></a><span id="l66.58" class="difflineminus">-  const char16_t *GetDescription(void) { return m_description.get();}</span>
<a href="#l66.59"></a><span id="l66.59" class="difflineminus">-  const char *  GetSupports(void) { return m_supports.get();}</span>
<a href="#l66.60"></a><span id="l66.60" class="difflineplus">+  nsCID GetCID(void) { return m_cid; }</span>
<a href="#l66.61"></a><span id="l66.61" class="difflineplus">+  const char16_t *GetName(void) { return m_name.get(); }</span>
<a href="#l66.62"></a><span id="l66.62" class="difflineplus">+  const char16_t *GetDescription(void) { return m_description.get(); }</span>
<a href="#l66.63"></a><span id="l66.63" class="difflineplus">+  const char *GetSupports(void) { return m_supports.get(); }</span>
<a href="#l66.64"></a><span id="l66.64"> </span>
<a href="#l66.65"></a><span id="l66.65" class="difflineminus">-  void        GetModule(nsIImportModule **);</span>
<a href="#l66.66"></a><span id="l66.66" class="difflineminus">-  void        ReleaseModule(void);</span>
<a href="#l66.67"></a><span id="l66.67" class="difflineplus">+  void GetModule(nsIImportModule **);</span>
<a href="#l66.68"></a><span id="l66.68" class="difflineplus">+  void ReleaseModule(void);</span>
<a href="#l66.69"></a><span id="l66.69"> </span>
<a href="#l66.70"></a><span id="l66.70" class="difflineminus">-  bool        SupportsThings(const char *pThings);</span>
<a href="#l66.71"></a><span id="l66.71" class="difflineplus">+  bool SupportsThings(const char *pThings);</span>
<a href="#l66.72"></a><span id="l66.72"> </span>
<a href="#l66.73"></a><span id="l66.73" class="difflineminus">-private:</span>
<a href="#l66.74"></a><span id="l66.74" class="difflineplus">+ private:</span>
<a href="#l66.75"></a><span id="l66.75">   nsCID m_cid;</span>
<a href="#l66.76"></a><span id="l66.76">   nsString m_name;</span>
<a href="#l66.77"></a><span id="l66.77">   nsString m_description;</span>
<a href="#l66.78"></a><span id="l66.78">   nsCString m_supports;</span>
<a href="#l66.79"></a><span id="l66.79">   nsCOMPtr&lt;nsIImportModule&gt; m_pModule;</span>
<a href="#l66.80"></a><span id="l66.80"> };</span>
<a href="#l66.81"></a><span id="l66.81"> </span>
<a href="#l66.82"></a><span id="l66.82"> class nsImportModuleList {</span>
<a href="#l66.83"></a><span id="l66.83" class="difflineminus">-public:</span>
<a href="#l66.84"></a><span id="l66.84" class="difflineminus">-  nsImportModuleList() { m_pList = nullptr; m_alloc = 0; m_count = 0;}</span>
<a href="#l66.85"></a><span id="l66.85" class="difflineplus">+ public:</span>
<a href="#l66.86"></a><span id="l66.86" class="difflineplus">+  nsImportModuleList() {</span>
<a href="#l66.87"></a><span id="l66.87" class="difflineplus">+    m_pList = nullptr;</span>
<a href="#l66.88"></a><span id="l66.88" class="difflineplus">+    m_alloc = 0;</span>
<a href="#l66.89"></a><span id="l66.89" class="difflineplus">+    m_count = 0;</span>
<a href="#l66.90"></a><span id="l66.90" class="difflineplus">+  }</span>
<a href="#l66.91"></a><span id="l66.91">   ~nsImportModuleList() { ClearList(); }</span>
<a href="#l66.92"></a><span id="l66.92"> </span>
<a href="#l66.93"></a><span id="l66.93" class="difflineminus">-  void  AddModule(const nsCID&amp; cid, const char *pSupports, const char16_t *pName, const char16_t *pDesc);</span>
<a href="#l66.94"></a><span id="l66.94" class="difflineplus">+  void AddModule(const nsCID &amp;cid, const char *pSupports, const char16_t *pName,</span>
<a href="#l66.95"></a><span id="l66.95" class="difflineplus">+                 const char16_t *pDesc);</span>
<a href="#l66.96"></a><span id="l66.96"> </span>
<a href="#l66.97"></a><span id="l66.97" class="difflineminus">-  void  ClearList(void);</span>
<a href="#l66.98"></a><span id="l66.98" class="difflineplus">+  void ClearList(void);</span>
<a href="#l66.99"></a><span id="l66.99"> </span>
<a href="#l66.100"></a><span id="l66.100" class="difflineminus">-  int32_t  GetCount(void) { return m_count;}</span>
<a href="#l66.101"></a><span id="l66.101" class="difflineplus">+  int32_t GetCount(void) { return m_count; }</span>
<a href="#l66.102"></a><span id="l66.102"> </span>
<a href="#l66.103"></a><span id="l66.103" class="difflineminus">-  ImportModuleDesc *  GetModuleDesc(int32_t idx)</span>
<a href="#l66.104"></a><span id="l66.104" class="difflineminus">-    { if ((idx &lt; 0) || (idx &gt;= m_count)) return nullptr; else return m_pList[idx];}</span>
<a href="#l66.105"></a><span id="l66.105" class="difflineminus">-</span>
<a href="#l66.106"></a><span id="l66.106" class="difflineminus">-private:</span>
<a href="#l66.107"></a><span id="l66.107" class="difflineplus">+  ImportModuleDesc *GetModuleDesc(int32_t idx) {</span>
<a href="#l66.108"></a><span id="l66.108" class="difflineplus">+    if ((idx &lt; 0) || (idx &gt;= m_count))</span>
<a href="#l66.109"></a><span id="l66.109" class="difflineplus">+      return nullptr;</span>
<a href="#l66.110"></a><span id="l66.110" class="difflineplus">+    else</span>
<a href="#l66.111"></a><span id="l66.111" class="difflineplus">+      return m_pList[idx];</span>
<a href="#l66.112"></a><span id="l66.112" class="difflineplus">+  }</span>
<a href="#l66.113"></a><span id="l66.113"> </span>
<a href="#l66.114"></a><span id="l66.114" class="difflineminus">-private:</span>
<a href="#l66.115"></a><span id="l66.115" class="difflineminus">-    ImportModuleDesc **  m_pList;</span>
<a href="#l66.116"></a><span id="l66.116" class="difflineminus">-  int32_t        m_alloc;</span>
<a href="#l66.117"></a><span id="l66.117" class="difflineminus">-  int32_t        m_count;</span>
<a href="#l66.118"></a><span id="l66.118" class="difflineplus">+ private:</span>
<a href="#l66.119"></a><span id="l66.119" class="difflineplus">+ private:</span>
<a href="#l66.120"></a><span id="l66.120" class="difflineplus">+  ImportModuleDesc **m_pList;</span>
<a href="#l66.121"></a><span id="l66.121" class="difflineplus">+  int32_t m_alloc;</span>
<a href="#l66.122"></a><span id="l66.122" class="difflineplus">+  int32_t m_count;</span>
<a href="#l66.123"></a><span id="l66.123"> };</span>
<a href="#l66.124"></a><span id="l66.124"> </span>
<a href="#l66.125"></a><span id="l66.125" class="difflineminus">-#endif // nsImportService_h__</span>
<a href="#l66.126"></a><span id="l66.126" class="difflineplus">+#endif  // nsImportService_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l67.1"></a><span id="l67.1" class="difflineminus">--- a/mailnews/import/src/nsImportStringBundle.cpp</span>
<a href="#l67.2"></a><span id="l67.2" class="difflineplus">+++ b/mailnews/import/src/nsImportStringBundle.cpp</span>
<a href="#l67.3"></a><span id="l67.3" class="difflineat">@@ -8,69 +8,60 @@</span>
<a href="#l67.4"></a><span id="l67.4"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l67.5"></a><span id="l67.5"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l67.6"></a><span id="l67.6"> #include &quot;nsImportStringBundle.h&quot;</span>
<a href="#l67.7"></a><span id="l67.7"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l67.8"></a><span id="l67.8"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l67.9"></a><span id="l67.9"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l67.10"></a><span id="l67.10"> </span>
<a href="#l67.11"></a><span id="l67.11"> nsresult nsImportStringBundle::GetStringBundle(const char *aPropertyURL,</span>
<a href="#l67.12"></a><span id="l67.12" class="difflineminus">-                                               nsIStringBundle **aBundle)</span>
<a href="#l67.13"></a><span id="l67.13" class="difflineminus">-{</span>
<a href="#l67.14"></a><span id="l67.14" class="difflineplus">+                                               nsIStringBundle **aBundle) {</span>
<a href="#l67.15"></a><span id="l67.15">   nsresult rv;</span>
<a href="#l67.16"></a><span id="l67.16"> </span>
<a href="#l67.17"></a><span id="l67.17">   nsCOMPtr&lt;nsIStringBundleService&gt; sBundleService =</span>
<a href="#l67.18"></a><span id="l67.18" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l67.19"></a><span id="l67.19" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l67.20"></a><span id="l67.20">   NS_ENSURE_TRUE(sBundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l67.21"></a><span id="l67.21">   rv = sBundleService-&gt;CreateBundle(aPropertyURL, aBundle);</span>
<a href="#l67.22"></a><span id="l67.22"> </span>
<a href="#l67.23"></a><span id="l67.23">   return rv;</span>
<a href="#l67.24"></a><span id="l67.24"> }</span>
<a href="#l67.25"></a><span id="l67.25"> </span>
<a href="#l67.26"></a><span id="l67.26"> void nsImportStringBundle::GetStringByID(int32_t aStringID,</span>
<a href="#l67.27"></a><span id="l67.27">                                          nsIStringBundle *aBundle,</span>
<a href="#l67.28"></a><span id="l67.28" class="difflineminus">-                                         nsString &amp;aResult)</span>
<a href="#l67.29"></a><span id="l67.29" class="difflineminus">-{</span>
<a href="#l67.30"></a><span id="l67.30" class="difflineplus">+                                         nsString &amp;aResult) {</span>
<a href="#l67.31"></a><span id="l67.31">   aResult.Adopt(GetStringByID(aStringID, aBundle));</span>
<a href="#l67.32"></a><span id="l67.32"> }</span>
<a href="#l67.33"></a><span id="l67.33"> </span>
<a href="#l67.34"></a><span id="l67.34"> char16_t *nsImportStringBundle::GetStringByID(int32_t aStringID,</span>
<a href="#l67.35"></a><span id="l67.35" class="difflineminus">-                                               nsIStringBundle *aBundle)</span>
<a href="#l67.36"></a><span id="l67.36" class="difflineminus">-{</span>
<a href="#l67.37"></a><span id="l67.37" class="difflineminus">-  if (aBundle)</span>
<a href="#l67.38"></a><span id="l67.38" class="difflineminus">-  {</span>
<a href="#l67.39"></a><span id="l67.39" class="difflineplus">+                                              nsIStringBundle *aBundle) {</span>
<a href="#l67.40"></a><span id="l67.40" class="difflineplus">+  if (aBundle) {</span>
<a href="#l67.41"></a><span id="l67.41">     nsAutoString str;</span>
<a href="#l67.42"></a><span id="l67.42">     nsresult rv = aBundle-&gt;GetStringFromID(aStringID, str);</span>
<a href="#l67.43"></a><span id="l67.43" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l67.44"></a><span id="l67.44" class="difflineminus">-      return ToNewUnicode(str);</span>
<a href="#l67.45"></a><span id="l67.45" class="difflineplus">+    if (NS_SUCCEEDED(rv)) return ToNewUnicode(str);</span>
<a href="#l67.46"></a><span id="l67.46">   }</span>
<a href="#l67.47"></a><span id="l67.47"> </span>
<a href="#l67.48"></a><span id="l67.48">   nsString resultString(NS_LITERAL_STRING(&quot;[StringID &quot;));</span>
<a href="#l67.49"></a><span id="l67.49">   resultString.AppendInt(aStringID);</span>
<a href="#l67.50"></a><span id="l67.50">   resultString.AppendLiteral(&quot;?]&quot;);</span>
<a href="#l67.51"></a><span id="l67.51"> </span>
<a href="#l67.52"></a><span id="l67.52">   return ToNewUnicode(resultString);</span>
<a href="#l67.53"></a><span id="l67.53"> }</span>
<a href="#l67.54"></a><span id="l67.54"> </span>
<a href="#l67.55"></a><span id="l67.55"> void nsImportStringBundle::GetStringByName(const char *aName,</span>
<a href="#l67.56"></a><span id="l67.56">                                            nsIStringBundle *aBundle,</span>
<a href="#l67.57"></a><span id="l67.57" class="difflineminus">-                                           nsString &amp;aResult)</span>
<a href="#l67.58"></a><span id="l67.58" class="difflineminus">-{</span>
<a href="#l67.59"></a><span id="l67.59" class="difflineplus">+                                           nsString &amp;aResult) {</span>
<a href="#l67.60"></a><span id="l67.60">   aResult.Adopt(GetStringByName(aName, aBundle));</span>
<a href="#l67.61"></a><span id="l67.61"> }</span>
<a href="#l67.62"></a><span id="l67.62"> </span>
<a href="#l67.63"></a><span id="l67.63"> char16_t *nsImportStringBundle::GetStringByName(const char *aName,</span>
<a href="#l67.64"></a><span id="l67.64" class="difflineminus">-                                                 nsIStringBundle *aBundle)</span>
<a href="#l67.65"></a><span id="l67.65" class="difflineminus">-{</span>
<a href="#l67.66"></a><span id="l67.66" class="difflineminus">-  if (aBundle)</span>
<a href="#l67.67"></a><span id="l67.67" class="difflineminus">-  {</span>
<a href="#l67.68"></a><span id="l67.68" class="difflineplus">+                                                nsIStringBundle *aBundle) {</span>
<a href="#l67.69"></a><span id="l67.69" class="difflineplus">+  if (aBundle) {</span>
<a href="#l67.70"></a><span id="l67.70">     nsAutoString str;</span>
<a href="#l67.71"></a><span id="l67.71">     nsresult rv = aBundle-&gt;GetStringFromName(aName, str);</span>
<a href="#l67.72"></a><span id="l67.72" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l67.73"></a><span id="l67.73" class="difflineminus">-      return ToNewUnicode(str);</span>
<a href="#l67.74"></a><span id="l67.74" class="difflineplus">+    if (NS_SUCCEEDED(rv)) return ToNewUnicode(str);</span>
<a href="#l67.75"></a><span id="l67.75">   }</span>
<a href="#l67.76"></a><span id="l67.76"> </span>
<a href="#l67.77"></a><span id="l67.77">   nsString resultString(NS_LITERAL_STRING(&quot;[StringName &quot;));</span>
<a href="#l67.78"></a><span id="l67.78">   resultString.Append(NS_ConvertUTF8toUTF16(aName).get());</span>
<a href="#l67.79"></a><span id="l67.79">   resultString.AppendLiteral(&quot;?]&quot;);</span>
<a href="#l67.80"></a><span id="l67.80"> </span>
<a href="#l67.81"></a><span id="l67.81">   return ToNewUnicode(resultString);</span>
<a href="#l67.82"></a><span id="l67.82"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l68.1"></a><span id="l68.1" class="difflineminus">--- a/mailnews/import/src/nsImportStringBundle.h</span>
<a href="#l68.2"></a><span id="l68.2" class="difflineplus">+++ b/mailnews/import/src/nsImportStringBundle.h</span>
<a href="#l68.3"></a><span id="l68.3" class="difflineat">@@ -4,45 +4,40 @@</span>
<a href="#l68.4"></a><span id="l68.4"> </span>
<a href="#l68.5"></a><span id="l68.5"> #ifndef _nsImportStringBundle_H__</span>
<a href="#l68.6"></a><span id="l68.6"> #define _nsImportStringBundle_H__</span>
<a href="#l68.7"></a><span id="l68.7"> </span>
<a href="#l68.8"></a><span id="l68.8"> #include &quot;nsString.h&quot;</span>
<a href="#l68.9"></a><span id="l68.9"> </span>
<a href="#l68.10"></a><span id="l68.10"> class nsIStringBundle;</span>
<a href="#l68.11"></a><span id="l68.11"> </span>
<a href="#l68.12"></a><span id="l68.12" class="difflineminus">-class nsImportStringBundle</span>
<a href="#l68.13"></a><span id="l68.13" class="difflineminus">-{</span>
<a href="#l68.14"></a><span id="l68.14" class="difflineminus">-public:</span>
<a href="#l68.15"></a><span id="l68.15" class="difflineminus">-  static char16_t* GetStringByID(int32_t aStringID,</span>
<a href="#l68.16"></a><span id="l68.16" class="difflineminus">-                                  nsIStringBundle *aBundle = nullptr);</span>
<a href="#l68.17"></a><span id="l68.17" class="difflineminus">-  static void GetStringByID(int32_t aStringID,</span>
<a href="#l68.18"></a><span id="l68.18" class="difflineminus">-                            nsIStringBundle *aBundle,</span>
<a href="#l68.19"></a><span id="l68.19" class="difflineplus">+class nsImportStringBundle {</span>
<a href="#l68.20"></a><span id="l68.20" class="difflineplus">+ public:</span>
<a href="#l68.21"></a><span id="l68.21" class="difflineplus">+  static char16_t *GetStringByID(int32_t aStringID,</span>
<a href="#l68.22"></a><span id="l68.22" class="difflineplus">+                                 nsIStringBundle *aBundle = nullptr);</span>
<a href="#l68.23"></a><span id="l68.23" class="difflineplus">+  static void GetStringByID(int32_t aStringID, nsIStringBundle *aBundle,</span>
<a href="#l68.24"></a><span id="l68.24">                             nsString &amp;aResult);</span>
<a href="#l68.25"></a><span id="l68.25" class="difflineminus">-  static char16_t* GetStringByName(const char *aName,</span>
<a href="#l68.26"></a><span id="l68.26" class="difflineminus">-                                    nsIStringBundle *aBundle = nullptr);</span>
<a href="#l68.27"></a><span id="l68.27" class="difflineminus">-  static void GetStringByName(const char *aName,</span>
<a href="#l68.28"></a><span id="l68.28" class="difflineminus">-                                nsIStringBundle *aBundle,</span>
<a href="#l68.29"></a><span id="l68.29" class="difflineminus">-                                nsString &amp;aResult);</span>
<a href="#l68.30"></a><span id="l68.30" class="difflineplus">+  static char16_t *GetStringByName(const char *aName,</span>
<a href="#l68.31"></a><span id="l68.31" class="difflineplus">+                                   nsIStringBundle *aBundle = nullptr);</span>
<a href="#l68.32"></a><span id="l68.32" class="difflineplus">+  static void GetStringByName(const char *aName, nsIStringBundle *aBundle,</span>
<a href="#l68.33"></a><span id="l68.33" class="difflineplus">+                              nsString &amp;aResult);</span>
<a href="#l68.34"></a><span id="l68.34">   static nsresult GetStringBundle(const char *aPropertyURL,</span>
<a href="#l68.35"></a><span id="l68.35">                                   nsIStringBundle **aBundle);</span>
<a href="#l68.36"></a><span id="l68.36"> };</span>
<a href="#l68.37"></a><span id="l68.37"> </span>
<a href="#l68.38"></a><span id="l68.38" class="difflineminus">-#define IMPORT_MSGS_URL       &quot;chrome://messenger/locale/importMsgs.properties&quot;</span>
<a href="#l68.39"></a><span id="l68.39" class="difflineminus">-</span>
<a href="#l68.40"></a><span id="l68.40" class="difflineplus">+#define IMPORT_MSGS_URL &quot;chrome://messenger/locale/importMsgs.properties&quot;</span>
<a href="#l68.41"></a><span id="l68.41"> </span>
<a href="#l68.42"></a><span id="l68.42" class="difflineminus">-#define  IMPORT_NO_ADDRBOOKS                            2000</span>
<a href="#l68.43"></a><span id="l68.43" class="difflineminus">-#define  IMPORT_ERROR_AB_NOTINITIALIZED            2001</span>
<a href="#l68.44"></a><span id="l68.44" class="difflineminus">-#define IMPORT_ERROR_AB_NOTHREAD              2002</span>
<a href="#l68.45"></a><span id="l68.45" class="difflineminus">-#define IMPORT_ERROR_GETABOOK                2003</span>
<a href="#l68.46"></a><span id="l68.46" class="difflineminus">-#define  IMPORT_NO_MAILBOXES                            2004</span>
<a href="#l68.47"></a><span id="l68.47" class="difflineminus">-#define  IMPORT_ERROR_MB_NOTINITIALIZED            2005</span>
<a href="#l68.48"></a><span id="l68.48" class="difflineminus">-#define IMPORT_ERROR_MB_NOTHREAD              2006</span>
<a href="#l68.49"></a><span id="l68.49" class="difflineminus">-#define IMPORT_ERROR_MB_NOPROXY                2007</span>
<a href="#l68.50"></a><span id="l68.50" class="difflineminus">-#define IMPORT_ERROR_MB_FINDCHILD              2008</span>
<a href="#l68.51"></a><span id="l68.51" class="difflineminus">-#define IMPORT_ERROR_MB_CREATE                2009</span>
<a href="#l68.52"></a><span id="l68.52" class="difflineminus">-#define IMPORT_ERROR_MB_NODESTFOLDER            2010</span>
<a href="#l68.53"></a><span id="l68.53" class="difflineplus">+#define IMPORT_NO_ADDRBOOKS 2000</span>
<a href="#l68.54"></a><span id="l68.54" class="difflineplus">+#define IMPORT_ERROR_AB_NOTINITIALIZED 2001</span>
<a href="#l68.55"></a><span id="l68.55" class="difflineplus">+#define IMPORT_ERROR_AB_NOTHREAD 2002</span>
<a href="#l68.56"></a><span id="l68.56" class="difflineplus">+#define IMPORT_ERROR_GETABOOK 2003</span>
<a href="#l68.57"></a><span id="l68.57" class="difflineplus">+#define IMPORT_NO_MAILBOXES 2004</span>
<a href="#l68.58"></a><span id="l68.58" class="difflineplus">+#define IMPORT_ERROR_MB_NOTINITIALIZED 2005</span>
<a href="#l68.59"></a><span id="l68.59" class="difflineplus">+#define IMPORT_ERROR_MB_NOTHREAD 2006</span>
<a href="#l68.60"></a><span id="l68.60" class="difflineplus">+#define IMPORT_ERROR_MB_NOPROXY 2007</span>
<a href="#l68.61"></a><span id="l68.61" class="difflineplus">+#define IMPORT_ERROR_MB_FINDCHILD 2008</span>
<a href="#l68.62"></a><span id="l68.62" class="difflineplus">+#define IMPORT_ERROR_MB_CREATE 2009</span>
<a href="#l68.63"></a><span id="l68.63" class="difflineplus">+#define IMPORT_ERROR_MB_NODESTFOLDER 2010</span>
<a href="#l68.64"></a><span id="l68.64"> </span>
<a href="#l68.65"></a><span id="l68.65" class="difflineminus">-#define IMPORT_FIELD_DESC_START                2100</span>
<a href="#l68.66"></a><span id="l68.66" class="difflineminus">-#define IMPORT_FIELD_DESC_END                2136</span>
<a href="#l68.67"></a><span id="l68.67" class="difflineminus">-</span>
<a href="#l68.68"></a><span id="l68.68" class="difflineplus">+#define IMPORT_FIELD_DESC_START 2100</span>
<a href="#l68.69"></a><span id="l68.69" class="difflineplus">+#define IMPORT_FIELD_DESC_END 2136</span>
<a href="#l68.70"></a><span id="l68.70"> </span>
<a href="#l68.71"></a><span id="l68.71"> #endif /* _nsImportStringBundle_H__ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l69.1"></a><span id="l69.1" class="difflineminus">--- a/mailnews/import/src/nsImportTranslator.cpp</span>
<a href="#l69.2"></a><span id="l69.2" class="difflineplus">+++ b/mailnews/import/src/nsImportTranslator.cpp</span>
<a href="#l69.3"></a><span id="l69.3" class="difflineat">@@ -3,244 +3,245 @@</span>
<a href="#l69.4"></a><span id="l69.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l69.5"></a><span id="l69.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l69.6"></a><span id="l69.6"> </span>
<a href="#l69.7"></a><span id="l69.7"> #include &quot;ImportOutFile.h&quot;</span>
<a href="#l69.8"></a><span id="l69.8"> #include &quot;nsImportTranslator.h&quot;</span>
<a href="#l69.9"></a><span id="l69.9"> </span>
<a href="#l69.10"></a><span id="l69.10"> #include &quot;ImportCharSet.h&quot;</span>
<a href="#l69.11"></a><span id="l69.11"> </span>
<a href="#l69.12"></a><span id="l69.12" class="difflineminus">-</span>
<a href="#l69.13"></a><span id="l69.13" class="difflineminus">-bool nsImportTranslator::ConvertToFile(const uint8_t * pIn, uint32_t inLen, ImportOutFile *pOutFile, uint32_t *pProcessed)</span>
<a href="#l69.14"></a><span id="l69.14" class="difflineminus">-{</span>
<a href="#l69.15"></a><span id="l69.15" class="difflineminus">-  if (pProcessed)</span>
<a href="#l69.16"></a><span id="l69.16" class="difflineminus">-    *pProcessed = inLen;</span>
<a href="#l69.17"></a><span id="l69.17" class="difflineplus">+bool nsImportTranslator::ConvertToFile(const uint8_t *pIn, uint32_t inLen,</span>
<a href="#l69.18"></a><span id="l69.18" class="difflineplus">+                                       ImportOutFile *pOutFile,</span>
<a href="#l69.19"></a><span id="l69.19" class="difflineplus">+                                       uint32_t *pProcessed) {</span>
<a href="#l69.20"></a><span id="l69.20" class="difflineplus">+  if (pProcessed) *pProcessed = inLen;</span>
<a href="#l69.21"></a><span id="l69.21">   return (pOutFile-&gt;WriteData(pIn, inLen));</span>
<a href="#l69.22"></a><span id="l69.22"> }</span>
<a href="#l69.23"></a><span id="l69.23"> </span>
<a href="#l69.24"></a><span id="l69.24" class="difflineminus">-void CMHTranslator::ConvertBuffer(const uint8_t * pIn, uint32_t inLen, uint8_t * pOut)</span>
<a href="#l69.25"></a><span id="l69.25" class="difflineminus">-{</span>
<a href="#l69.26"></a><span id="l69.26" class="difflineplus">+void CMHTranslator::ConvertBuffer(const uint8_t *pIn, uint32_t inLen,</span>
<a href="#l69.27"></a><span id="l69.27" class="difflineplus">+                                  uint8_t *pOut) {</span>
<a href="#l69.28"></a><span id="l69.28">   while (inLen) {</span>
<a href="#l69.29"></a><span id="l69.29" class="difflineminus">-    if (!ImportCharSet::IsUSAscii(*pIn) || ImportCharSet::Is822SpecialChar(*pIn) || ImportCharSet::Is822CtlChar(*pIn) ||</span>
<a href="#l69.30"></a><span id="l69.30" class="difflineminus">-      (*pIn == ImportCharSet::cSpaceChar) || (*pIn == '*') || (*pIn == '\'') ||</span>
<a href="#l69.31"></a><span id="l69.31" class="difflineminus">-      (*pIn == '%')) {</span>
<a href="#l69.32"></a><span id="l69.32" class="difflineplus">+    if (!ImportCharSet::IsUSAscii(*pIn) ||</span>
<a href="#l69.33"></a><span id="l69.33" class="difflineplus">+        ImportCharSet::Is822SpecialChar(*pIn) ||</span>
<a href="#l69.34"></a><span id="l69.34" class="difflineplus">+        ImportCharSet::Is822CtlChar(*pIn) ||</span>
<a href="#l69.35"></a><span id="l69.35" class="difflineplus">+        (*pIn == ImportCharSet::cSpaceChar) || (*pIn == '*') ||</span>
<a href="#l69.36"></a><span id="l69.36" class="difflineplus">+        (*pIn == '\'') || (*pIn == '%')) {</span>
<a href="#l69.37"></a><span id="l69.37">       // needs to be encode as %hex val</span>
<a href="#l69.38"></a><span id="l69.38" class="difflineminus">-      *pOut = '%'; pOut++;</span>
<a href="#l69.39"></a><span id="l69.39" class="difflineplus">+      *pOut = '%';</span>
<a href="#l69.40"></a><span id="l69.40" class="difflineplus">+      pOut++;</span>
<a href="#l69.41"></a><span id="l69.41">       ImportCharSet::ByteToHex(*pIn, pOut);</span>
<a href="#l69.42"></a><span id="l69.42">       pOut += 2;</span>
<a href="#l69.43"></a><span id="l69.43" class="difflineminus">-    }</span>
<a href="#l69.44"></a><span id="l69.44" class="difflineminus">-    else {</span>
<a href="#l69.45"></a><span id="l69.45" class="difflineplus">+    } else {</span>
<a href="#l69.46"></a><span id="l69.46">       *pOut = *pIn;</span>
<a href="#l69.47"></a><span id="l69.47">       pOut++;</span>
<a href="#l69.48"></a><span id="l69.48">     }</span>
<a href="#l69.49"></a><span id="l69.49" class="difflineminus">-    pIn++; inLen--;</span>
<a href="#l69.50"></a><span id="l69.50" class="difflineplus">+    pIn++;</span>
<a href="#l69.51"></a><span id="l69.51" class="difflineplus">+    inLen--;</span>
<a href="#l69.52"></a><span id="l69.52">   }</span>
<a href="#l69.53"></a><span id="l69.53">   *pOut = 0;</span>
<a href="#l69.54"></a><span id="l69.54"> }</span>
<a href="#l69.55"></a><span id="l69.55"> </span>
<a href="#l69.56"></a><span id="l69.56" class="difflineminus">-bool CMHTranslator::ConvertToFile(const uint8_t * pIn, uint32_t inLen, ImportOutFile *pOutFile, uint32_t *pProcessed)</span>
<a href="#l69.57"></a><span id="l69.57" class="difflineminus">-{</span>
<a href="#l69.58"></a><span id="l69.58" class="difflineminus">-  uint8_t    hex[2];</span>
<a href="#l69.59"></a><span id="l69.59" class="difflineplus">+bool CMHTranslator::ConvertToFile(const uint8_t *pIn, uint32_t inLen,</span>
<a href="#l69.60"></a><span id="l69.60" class="difflineplus">+                                  ImportOutFile *pOutFile,</span>
<a href="#l69.61"></a><span id="l69.61" class="difflineplus">+                                  uint32_t *pProcessed) {</span>
<a href="#l69.62"></a><span id="l69.62" class="difflineplus">+  uint8_t hex[2];</span>
<a href="#l69.63"></a><span id="l69.63">   while (inLen) {</span>
<a href="#l69.64"></a><span id="l69.64" class="difflineminus">-    if (!ImportCharSet::IsUSAscii(*pIn) || ImportCharSet::Is822SpecialChar(*pIn) || ImportCharSet::Is822CtlChar(*pIn) ||</span>
<a href="#l69.65"></a><span id="l69.65" class="difflineminus">-      (*pIn == ImportCharSet::cSpaceChar) || (*pIn == '*') || (*pIn == '\'') ||</span>
<a href="#l69.66"></a><span id="l69.66" class="difflineminus">-      (*pIn == '%')) {</span>
<a href="#l69.67"></a><span id="l69.67" class="difflineplus">+    if (!ImportCharSet::IsUSAscii(*pIn) ||</span>
<a href="#l69.68"></a><span id="l69.68" class="difflineplus">+        ImportCharSet::Is822SpecialChar(*pIn) ||</span>
<a href="#l69.69"></a><span id="l69.69" class="difflineplus">+        ImportCharSet::Is822CtlChar(*pIn) ||</span>
<a href="#l69.70"></a><span id="l69.70" class="difflineplus">+        (*pIn == ImportCharSet::cSpaceChar) || (*pIn == '*') ||</span>
<a href="#l69.71"></a><span id="l69.71" class="difflineplus">+        (*pIn == '\'') || (*pIn == '%')) {</span>
<a href="#l69.72"></a><span id="l69.72">       // needs to be encode as %hex val</span>
<a href="#l69.73"></a><span id="l69.73" class="difflineminus">-      if (!pOutFile-&gt;WriteByte('%'))</span>
<a href="#l69.74"></a><span id="l69.74" class="difflineminus">-        return false;</span>
<a href="#l69.75"></a><span id="l69.75" class="difflineplus">+      if (!pOutFile-&gt;WriteByte('%')) return false;</span>
<a href="#l69.76"></a><span id="l69.76">       ImportCharSet::ByteToHex(*pIn, hex);</span>
<a href="#l69.77"></a><span id="l69.77" class="difflineminus">-      if (!pOutFile-&gt;WriteData(hex, 2))</span>
<a href="#l69.78"></a><span id="l69.78" class="difflineminus">-        return false;</span>
<a href="#l69.79"></a><span id="l69.79" class="difflineplus">+      if (!pOutFile-&gt;WriteData(hex, 2)) return false;</span>
<a href="#l69.80"></a><span id="l69.80" class="difflineplus">+    } else {</span>
<a href="#l69.81"></a><span id="l69.81" class="difflineplus">+      if (!pOutFile-&gt;WriteByte(*pIn)) return false;</span>
<a href="#l69.82"></a><span id="l69.82">     }</span>
<a href="#l69.83"></a><span id="l69.83" class="difflineminus">-    else {</span>
<a href="#l69.84"></a><span id="l69.84" class="difflineminus">-      if (!pOutFile-&gt;WriteByte(*pIn))</span>
<a href="#l69.85"></a><span id="l69.85" class="difflineminus">-        return false;</span>
<a href="#l69.86"></a><span id="l69.86" class="difflineminus">-    }</span>
<a href="#l69.87"></a><span id="l69.87" class="difflineminus">-    pIn++; inLen--;</span>
<a href="#l69.88"></a><span id="l69.88" class="difflineplus">+    pIn++;</span>
<a href="#l69.89"></a><span id="l69.89" class="difflineplus">+    inLen--;</span>
<a href="#l69.90"></a><span id="l69.90">   }</span>
<a href="#l69.91"></a><span id="l69.91"> </span>
<a href="#l69.92"></a><span id="l69.92" class="difflineminus">-  if (pProcessed)</span>
<a href="#l69.93"></a><span id="l69.93" class="difflineminus">-    *pProcessed = inLen;</span>
<a href="#l69.94"></a><span id="l69.94" class="difflineplus">+  if (pProcessed) *pProcessed = inLen;</span>
<a href="#l69.95"></a><span id="l69.95"> </span>
<a href="#l69.96"></a><span id="l69.96">   return true;</span>
<a href="#l69.97"></a><span id="l69.97"> }</span>
<a href="#l69.98"></a><span id="l69.98"> </span>
<a href="#l69.99"></a><span id="l69.99" class="difflineminus">-</span>
<a href="#l69.100"></a><span id="l69.100" class="difflineminus">-bool C2047Translator::ConvertToFileQ(const uint8_t * pIn, uint32_t inLen, ImportOutFile *pOutFile, uint32_t *pProcessed)</span>
<a href="#l69.101"></a><span id="l69.101" class="difflineminus">-{</span>
<a href="#l69.102"></a><span id="l69.102" class="difflineminus">-  if (!inLen)</span>
<a href="#l69.103"></a><span id="l69.103" class="difflineminus">-    return true;</span>
<a href="#l69.104"></a><span id="l69.104" class="difflineplus">+bool C2047Translator::ConvertToFileQ(const uint8_t *pIn, uint32_t inLen,</span>
<a href="#l69.105"></a><span id="l69.105" class="difflineplus">+                                     ImportOutFile *pOutFile,</span>
<a href="#l69.106"></a><span id="l69.106" class="difflineplus">+                                     uint32_t *pProcessed) {</span>
<a href="#l69.107"></a><span id="l69.107" class="difflineplus">+  if (!inLen) return true;</span>
<a href="#l69.108"></a><span id="l69.108"> </span>
<a href="#l69.109"></a><span id="l69.109" class="difflineminus">-  int    maxLineLen = 64;</span>
<a href="#l69.110"></a><span id="l69.110" class="difflineminus">-  int    curLineLen = m_startLen;</span>
<a href="#l69.111"></a><span id="l69.111" class="difflineminus">-  bool    startLine = true;</span>
<a href="#l69.112"></a><span id="l69.112" class="difflineplus">+  int maxLineLen = 64;</span>
<a href="#l69.113"></a><span id="l69.113" class="difflineplus">+  int curLineLen = m_startLen;</span>
<a href="#l69.114"></a><span id="l69.114" class="difflineplus">+  bool startLine = true;</span>
<a href="#l69.115"></a><span id="l69.115"> </span>
<a href="#l69.116"></a><span id="l69.116" class="difflineminus">-  uint8_t  hex[2];</span>
<a href="#l69.117"></a><span id="l69.117" class="difflineplus">+  uint8_t hex[2];</span>
<a href="#l69.118"></a><span id="l69.118">   while (inLen) {</span>
<a href="#l69.119"></a><span id="l69.119">     if (startLine) {</span>
<a href="#l69.120"></a><span id="l69.120" class="difflineminus">-      if (!pOutFile-&gt;WriteStr(&quot; =?&quot;))</span>
<a href="#l69.121"></a><span id="l69.121" class="difflineminus">-        return false;</span>
<a href="#l69.122"></a><span id="l69.122" class="difflineminus">-      if (!pOutFile-&gt;WriteStr(m_charset.get()))</span>
<a href="#l69.123"></a><span id="l69.123" class="difflineminus">-        return false;</span>
<a href="#l69.124"></a><span id="l69.124" class="difflineminus">-      if (!pOutFile-&gt;WriteStr(&quot;?q?&quot;))</span>
<a href="#l69.125"></a><span id="l69.125" class="difflineminus">-        return false;</span>
<a href="#l69.126"></a><span id="l69.126" class="difflineplus">+      if (!pOutFile-&gt;WriteStr(&quot; =?&quot;)) return false;</span>
<a href="#l69.127"></a><span id="l69.127" class="difflineplus">+      if (!pOutFile-&gt;WriteStr(m_charset.get())) return false;</span>
<a href="#l69.128"></a><span id="l69.128" class="difflineplus">+      if (!pOutFile-&gt;WriteStr(&quot;?q?&quot;)) return false;</span>
<a href="#l69.129"></a><span id="l69.129">       curLineLen += (6 + m_charset.Length());</span>
<a href="#l69.130"></a><span id="l69.130">       startLine = false;</span>
<a href="#l69.131"></a><span id="l69.131">     }</span>
<a href="#l69.132"></a><span id="l69.132"> </span>
<a href="#l69.133"></a><span id="l69.133" class="difflineminus">-    if (!ImportCharSet::IsUSAscii(*pIn) || ImportCharSet::Is822SpecialChar(*pIn) || ImportCharSet::Is822CtlChar(*pIn) ||</span>
<a href="#l69.134"></a><span id="l69.134" class="difflineminus">-      (*pIn == ImportCharSet::cSpaceChar) || (*pIn == '?') || (*pIn == '=')) {</span>
<a href="#l69.135"></a><span id="l69.135" class="difflineplus">+    if (!ImportCharSet::IsUSAscii(*pIn) ||</span>
<a href="#l69.136"></a><span id="l69.136" class="difflineplus">+        ImportCharSet::Is822SpecialChar(*pIn) ||</span>
<a href="#l69.137"></a><span id="l69.137" class="difflineplus">+        ImportCharSet::Is822CtlChar(*pIn) ||</span>
<a href="#l69.138"></a><span id="l69.138" class="difflineplus">+        (*pIn == ImportCharSet::cSpaceChar) || (*pIn == '?') || (*pIn == '=')) {</span>
<a href="#l69.139"></a><span id="l69.139">       // needs to be encode as =hex val</span>
<a href="#l69.140"></a><span id="l69.140" class="difflineminus">-      if (!pOutFile-&gt;WriteByte('='))</span>
<a href="#l69.141"></a><span id="l69.141" class="difflineminus">-        return false;</span>
<a href="#l69.142"></a><span id="l69.142" class="difflineplus">+      if (!pOutFile-&gt;WriteByte('=')) return false;</span>
<a href="#l69.143"></a><span id="l69.143">       ImportCharSet::ByteToHex(*pIn, hex);</span>
<a href="#l69.144"></a><span id="l69.144" class="difflineminus">-      if (!pOutFile-&gt;WriteData(hex, 2))</span>
<a href="#l69.145"></a><span id="l69.145" class="difflineminus">-        return false;</span>
<a href="#l69.146"></a><span id="l69.146" class="difflineplus">+      if (!pOutFile-&gt;WriteData(hex, 2)) return false;</span>
<a href="#l69.147"></a><span id="l69.147">       curLineLen += 3;</span>
<a href="#l69.148"></a><span id="l69.148" class="difflineminus">-    }</span>
<a href="#l69.149"></a><span id="l69.149" class="difflineminus">-    else {</span>
<a href="#l69.150"></a><span id="l69.150" class="difflineminus">-      if (!pOutFile-&gt;WriteByte(*pIn))</span>
<a href="#l69.151"></a><span id="l69.151" class="difflineminus">-        return false;</span>
<a href="#l69.152"></a><span id="l69.152" class="difflineplus">+    } else {</span>
<a href="#l69.153"></a><span id="l69.153" class="difflineplus">+      if (!pOutFile-&gt;WriteByte(*pIn)) return false;</span>
<a href="#l69.154"></a><span id="l69.154">       curLineLen++;</span>
<a href="#l69.155"></a><span id="l69.155">     }</span>
<a href="#l69.156"></a><span id="l69.156" class="difflineminus">-    pIn++; inLen--;</span>
<a href="#l69.157"></a><span id="l69.157" class="difflineplus">+    pIn++;</span>
<a href="#l69.158"></a><span id="l69.158" class="difflineplus">+    inLen--;</span>
<a href="#l69.159"></a><span id="l69.159">     if (curLineLen &gt; maxLineLen) {</span>
<a href="#l69.160"></a><span id="l69.160" class="difflineminus">-      if (!pOutFile-&gt;WriteStr(&quot;?=&quot;))</span>
<a href="#l69.161"></a><span id="l69.161" class="difflineminus">-        return false;</span>
<a href="#l69.162"></a><span id="l69.162" class="difflineplus">+      if (!pOutFile-&gt;WriteStr(&quot;?=&quot;)) return false;</span>
<a href="#l69.163"></a><span id="l69.163">       if (inLen) {</span>
<a href="#l69.164"></a><span id="l69.164" class="difflineminus">-        if (!pOutFile-&gt;WriteStr(&quot;\x0D\x0A &quot;))</span>
<a href="#l69.165"></a><span id="l69.165" class="difflineminus">-          return false;</span>
<a href="#l69.166"></a><span id="l69.166" class="difflineplus">+        if (!pOutFile-&gt;WriteStr(&quot;\x0D\x0A &quot;)) return false;</span>
<a href="#l69.167"></a><span id="l69.167">       }</span>
<a href="#l69.168"></a><span id="l69.168"> </span>
<a href="#l69.169"></a><span id="l69.169">       startLine = true;</span>
<a href="#l69.170"></a><span id="l69.170">       curLineLen = 0;</span>
<a href="#l69.171"></a><span id="l69.171">     }</span>
<a href="#l69.172"></a><span id="l69.172">   }</span>
<a href="#l69.173"></a><span id="l69.173"> </span>
<a href="#l69.174"></a><span id="l69.174">   if (!startLine) {</span>
<a href="#l69.175"></a><span id="l69.175">     // end the encoding!</span>
<a href="#l69.176"></a><span id="l69.176" class="difflineminus">-    if (!pOutFile-&gt;WriteStr(&quot;?=&quot;))</span>
<a href="#l69.177"></a><span id="l69.177" class="difflineminus">-      return false;</span>
<a href="#l69.178"></a><span id="l69.178" class="difflineplus">+    if (!pOutFile-&gt;WriteStr(&quot;?=&quot;)) return false;</span>
<a href="#l69.179"></a><span id="l69.179">   }</span>
<a href="#l69.180"></a><span id="l69.180"> </span>
<a href="#l69.181"></a><span id="l69.181" class="difflineminus">-  if (pProcessed)</span>
<a href="#l69.182"></a><span id="l69.182" class="difflineminus">-    *pProcessed = inLen;</span>
<a href="#l69.183"></a><span id="l69.183" class="difflineplus">+  if (pProcessed) *pProcessed = inLen;</span>
<a href="#l69.184"></a><span id="l69.184"> </span>
<a href="#l69.185"></a><span id="l69.185">   return true;</span>
<a href="#l69.186"></a><span id="l69.186"> }</span>
<a href="#l69.187"></a><span id="l69.187"> </span>
<a href="#l69.188"></a><span id="l69.188" class="difflineminus">-bool C2047Translator::ConvertToFile(const uint8_t * pIn, uint32_t inLen, ImportOutFile *pOutFile, uint32_t *pProcessed)</span>
<a href="#l69.189"></a><span id="l69.189" class="difflineminus">-{</span>
<a href="#l69.190"></a><span id="l69.190" class="difflineplus">+bool C2047Translator::ConvertToFile(const uint8_t *pIn, uint32_t inLen,</span>
<a href="#l69.191"></a><span id="l69.191" class="difflineplus">+                                    ImportOutFile *pOutFile,</span>
<a href="#l69.192"></a><span id="l69.192" class="difflineplus">+                                    uint32_t *pProcessed) {</span>
<a href="#l69.193"></a><span id="l69.193">   if (m_useQuotedPrintable)</span>
<a href="#l69.194"></a><span id="l69.194">     return ConvertToFileQ(pIn, inLen, pOutFile, pProcessed);</span>
<a href="#l69.195"></a><span id="l69.195"> </span>
<a href="#l69.196"></a><span id="l69.196" class="difflineminus">-  if (!inLen)</span>
<a href="#l69.197"></a><span id="l69.197" class="difflineminus">-    return true;</span>
<a href="#l69.198"></a><span id="l69.198" class="difflineplus">+  if (!inLen) return true;</span>
<a href="#l69.199"></a><span id="l69.199"> </span>
<a href="#l69.200"></a><span id="l69.200" class="difflineminus">-  int      maxLineLen = 64;</span>
<a href="#l69.201"></a><span id="l69.201" class="difflineminus">-  int      curLineLen = m_startLen;</span>
<a href="#l69.202"></a><span id="l69.202" class="difflineminus">-  bool      startLine = true;</span>
<a href="#l69.203"></a><span id="l69.203" class="difflineminus">-  int      encodeMax;</span>
<a href="#l69.204"></a><span id="l69.204" class="difflineminus">-  uint8_t *  pEncoded = new uint8_t[maxLineLen * 2];</span>
<a href="#l69.205"></a><span id="l69.205" class="difflineplus">+  int maxLineLen = 64;</span>
<a href="#l69.206"></a><span id="l69.206" class="difflineplus">+  int curLineLen = m_startLen;</span>
<a href="#l69.207"></a><span id="l69.207" class="difflineplus">+  bool startLine = true;</span>
<a href="#l69.208"></a><span id="l69.208" class="difflineplus">+  int encodeMax;</span>
<a href="#l69.209"></a><span id="l69.209" class="difflineplus">+  uint8_t *pEncoded = new uint8_t[maxLineLen * 2];</span>
<a href="#l69.210"></a><span id="l69.210"> </span>
<a href="#l69.211"></a><span id="l69.211">   while (inLen) {</span>
<a href="#l69.212"></a><span id="l69.212">     if (startLine) {</span>
<a href="#l69.213"></a><span id="l69.213">       if (!pOutFile-&gt;WriteStr(&quot; =?&quot;)) {</span>
<a href="#l69.214"></a><span id="l69.214" class="difflineminus">-        delete [] pEncoded;</span>
<a href="#l69.215"></a><span id="l69.215" class="difflineplus">+        delete[] pEncoded;</span>
<a href="#l69.216"></a><span id="l69.216">         return false;</span>
<a href="#l69.217"></a><span id="l69.217">       }</span>
<a href="#l69.218"></a><span id="l69.218">       if (!pOutFile-&gt;WriteStr(m_charset.get())) {</span>
<a href="#l69.219"></a><span id="l69.219" class="difflineminus">-        delete [] pEncoded;</span>
<a href="#l69.220"></a><span id="l69.220" class="difflineplus">+        delete[] pEncoded;</span>
<a href="#l69.221"></a><span id="l69.221">         return false;</span>
<a href="#l69.222"></a><span id="l69.222">       }</span>
<a href="#l69.223"></a><span id="l69.223">       if (!pOutFile-&gt;WriteStr(&quot;?b?&quot;)) {</span>
<a href="#l69.224"></a><span id="l69.224" class="difflineminus">-        delete [] pEncoded;</span>
<a href="#l69.225"></a><span id="l69.225" class="difflineplus">+        delete[] pEncoded;</span>
<a href="#l69.226"></a><span id="l69.226">         return false;</span>
<a href="#l69.227"></a><span id="l69.227">       }</span>
<a href="#l69.228"></a><span id="l69.228">       curLineLen += (6 + m_charset.Length());</span>
<a href="#l69.229"></a><span id="l69.229">       startLine = false;</span>
<a href="#l69.230"></a><span id="l69.230">     }</span>
<a href="#l69.231"></a><span id="l69.231">     encodeMax = maxLineLen - curLineLen;</span>
<a href="#l69.232"></a><span id="l69.232">     encodeMax *= 3;</span>
<a href="#l69.233"></a><span id="l69.233">     encodeMax /= 4;</span>
<a href="#l69.234"></a><span id="l69.234" class="difflineminus">-    if ((uint32_t)encodeMax &gt; inLen)</span>
<a href="#l69.235"></a><span id="l69.235" class="difflineminus">-      encodeMax = (int)inLen;</span>
<a href="#l69.236"></a><span id="l69.236" class="difflineplus">+    if ((uint32_t)encodeMax &gt; inLen) encodeMax = (int)inLen;</span>
<a href="#l69.237"></a><span id="l69.237"> </span>
<a href="#l69.238"></a><span id="l69.238">     // encode the line, end the line</span>
<a href="#l69.239"></a><span id="l69.239">     // then continue. Update curLineLen, pIn, startLine, and inLen</span>
<a href="#l69.240"></a><span id="l69.240" class="difflineminus">-    UMimeEncode::ConvertBuffer(pIn, encodeMax, pEncoded, maxLineLen, maxLineLen, &quot;\x0D\x0A&quot;);</span>
<a href="#l69.241"></a><span id="l69.241" class="difflineplus">+    UMimeEncode::ConvertBuffer(pIn, encodeMax, pEncoded, maxLineLen, maxLineLen,</span>
<a href="#l69.242"></a><span id="l69.242" class="difflineplus">+                               &quot;\x0D\x0A&quot;);</span>
<a href="#l69.243"></a><span id="l69.243"> </span>
<a href="#l69.244"></a><span id="l69.244">     if (!pOutFile-&gt;WriteStr((const char *)pEncoded)) {</span>
<a href="#l69.245"></a><span id="l69.245" class="difflineminus">-      delete [] pEncoded;</span>
<a href="#l69.246"></a><span id="l69.246" class="difflineplus">+      delete[] pEncoded;</span>
<a href="#l69.247"></a><span id="l69.247">       return false;</span>
<a href="#l69.248"></a><span id="l69.248">     }</span>
<a href="#l69.249"></a><span id="l69.249"> </span>
<a href="#l69.250"></a><span id="l69.250">     pIn += encodeMax;</span>
<a href="#l69.251"></a><span id="l69.251">     inLen -= encodeMax;</span>
<a href="#l69.252"></a><span id="l69.252">     startLine = true;</span>
<a href="#l69.253"></a><span id="l69.253">     curLineLen = 0;</span>
<a href="#l69.254"></a><span id="l69.254">     if (!pOutFile-&gt;WriteStr(&quot;?=&quot;)) {</span>
<a href="#l69.255"></a><span id="l69.255" class="difflineminus">-      delete [] pEncoded;</span>
<a href="#l69.256"></a><span id="l69.256" class="difflineplus">+      delete[] pEncoded;</span>
<a href="#l69.257"></a><span id="l69.257">       return false;</span>
<a href="#l69.258"></a><span id="l69.258">     }</span>
<a href="#l69.259"></a><span id="l69.259">     if (inLen) {</span>
<a href="#l69.260"></a><span id="l69.260">       if (!pOutFile-&gt;WriteStr(&quot;\x0D\x0A &quot;)) {</span>
<a href="#l69.261"></a><span id="l69.261" class="difflineminus">-        delete [] pEncoded;</span>
<a href="#l69.262"></a><span id="l69.262" class="difflineplus">+        delete[] pEncoded;</span>
<a href="#l69.263"></a><span id="l69.263">         return false;</span>
<a href="#l69.264"></a><span id="l69.264">       }</span>
<a href="#l69.265"></a><span id="l69.265">     }</span>
<a href="#l69.266"></a><span id="l69.266">   }</span>
<a href="#l69.267"></a><span id="l69.267"> </span>
<a href="#l69.268"></a><span id="l69.268" class="difflineminus">-  delete [] pEncoded;</span>
<a href="#l69.269"></a><span id="l69.269" class="difflineplus">+  delete[] pEncoded;</span>
<a href="#l69.270"></a><span id="l69.270"> </span>
<a href="#l69.271"></a><span id="l69.271" class="difflineminus">-  if (pProcessed)</span>
<a href="#l69.272"></a><span id="l69.272" class="difflineminus">-    *pProcessed = inLen;</span>
<a href="#l69.273"></a><span id="l69.273" class="difflineplus">+  if (pProcessed) *pProcessed = inLen;</span>
<a href="#l69.274"></a><span id="l69.274"> </span>
<a href="#l69.275"></a><span id="l69.275">   return true;</span>
<a href="#l69.276"></a><span id="l69.276"> }</span>
<a href="#l69.277"></a><span id="l69.277"> </span>
<a href="#l69.278"></a><span id="l69.278" class="difflineminus">-</span>
<a href="#l69.279"></a><span id="l69.279" class="difflineminus">-uint32_t  UMimeEncode::GetBufferSize(uint32_t inBytes)</span>
<a href="#l69.280"></a><span id="l69.280" class="difflineminus">-{</span>
<a href="#l69.281"></a><span id="l69.281" class="difflineplus">+uint32_t UMimeEncode::GetBufferSize(uint32_t inBytes) {</span>
<a href="#l69.282"></a><span id="l69.282">   // it takes 4 base64 bytes to represent 3 regular bytes</span>
<a href="#l69.283"></a><span id="l69.283">   inBytes += 3;</span>
<a href="#l69.284"></a><span id="l69.284">   inBytes /= 3;</span>
<a href="#l69.285"></a><span id="l69.285">   inBytes *= 4;</span>
<a href="#l69.286"></a><span id="l69.286">   // This should be plenty, but just to be safe</span>
<a href="#l69.287"></a><span id="l69.287">   inBytes += 4;</span>
<a href="#l69.288"></a><span id="l69.288"> </span>
<a href="#l69.289"></a><span id="l69.289">   // now allow for end of line characters</span>
<a href="#l69.290"></a><span id="l69.290">   inBytes += ((inBytes + 39) / 40) * 4;</span>
<a href="#l69.291"></a><span id="l69.291"> </span>
<a href="#l69.292"></a><span id="l69.292">   return inBytes;</span>
<a href="#l69.293"></a><span id="l69.293"> }</span>
<a href="#l69.294"></a><span id="l69.294"> </span>
<a href="#l69.295"></a><span id="l69.295" class="difflineminus">-static uint8_t gBase64[] = &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;;</span>
<a href="#l69.296"></a><span id="l69.296" class="difflineminus">-</span>
<a href="#l69.297"></a><span id="l69.297" class="difflineminus">-uint32_t UMimeEncode::ConvertBuffer(const uint8_t * pIn, uint32_t inLen, uint8_t * pOut, uint32_t maxLen, uint32_t firstLineLen, const char * pEolStr)</span>
<a href="#l69.298"></a><span id="l69.298" class="difflineminus">-{</span>
<a href="#l69.299"></a><span id="l69.299" class="difflineplus">+static uint8_t gBase64[] =</span>
<a href="#l69.300"></a><span id="l69.300" class="difflineplus">+    &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;;</span>
<a href="#l69.301"></a><span id="l69.301"> </span>
<a href="#l69.302"></a><span id="l69.302" class="difflineminus">-  uint32_t  pos = 0;</span>
<a href="#l69.303"></a><span id="l69.303" class="difflineminus">-  uint32_t  len = 0;</span>
<a href="#l69.304"></a><span id="l69.304" class="difflineminus">-  uint32_t  lineLen = 0;</span>
<a href="#l69.305"></a><span id="l69.305" class="difflineminus">-  uint32_t  maxLine = firstLineLen;</span>
<a href="#l69.306"></a><span id="l69.306" class="difflineminus">-  int  eolLen = 0;</span>
<a href="#l69.307"></a><span id="l69.307" class="difflineminus">-  if (pEolStr)</span>
<a href="#l69.308"></a><span id="l69.308" class="difflineminus">-    eolLen = strlen(pEolStr);</span>
<a href="#l69.309"></a><span id="l69.309" class="difflineplus">+uint32_t UMimeEncode::ConvertBuffer(const uint8_t *pIn, uint32_t inLen,</span>
<a href="#l69.310"></a><span id="l69.310" class="difflineplus">+                                    uint8_t *pOut, uint32_t maxLen,</span>
<a href="#l69.311"></a><span id="l69.311" class="difflineplus">+                                    uint32_t firstLineLen,</span>
<a href="#l69.312"></a><span id="l69.312" class="difflineplus">+                                    const char *pEolStr) {</span>
<a href="#l69.313"></a><span id="l69.313" class="difflineplus">+  uint32_t pos = 0;</span>
<a href="#l69.314"></a><span id="l69.314" class="difflineplus">+  uint32_t len = 0;</span>
<a href="#l69.315"></a><span id="l69.315" class="difflineplus">+  uint32_t lineLen = 0;</span>
<a href="#l69.316"></a><span id="l69.316" class="difflineplus">+  uint32_t maxLine = firstLineLen;</span>
<a href="#l69.317"></a><span id="l69.317" class="difflineplus">+  int eolLen = 0;</span>
<a href="#l69.318"></a><span id="l69.318" class="difflineplus">+  if (pEolStr) eolLen = strlen(pEolStr);</span>
<a href="#l69.319"></a><span id="l69.319"> </span>
<a href="#l69.320"></a><span id="l69.320">   while ((pos + 2) &lt; inLen) {</span>
<a href="#l69.321"></a><span id="l69.321">     // Encode 3 bytes</span>
<a href="#l69.322"></a><span id="l69.322">     *pOut = gBase64[*pIn &gt;&gt; 2];</span>
<a href="#l69.323"></a><span id="l69.323" class="difflineminus">-    pOut++; len++; lineLen++;</span>
<a href="#l69.324"></a><span id="l69.324" class="difflineminus">-    *pOut = gBase64[(((*pIn) &amp; 0x3)&lt;&lt; 4) | (((*(pIn + 1)) &amp; 0xF0) &gt;&gt; 4)];</span>
<a href="#l69.325"></a><span id="l69.325" class="difflineminus">-    pIn++; pOut++; len++; lineLen++;</span>
<a href="#l69.326"></a><span id="l69.326" class="difflineminus">-    *pOut = gBase64[(((*pIn) &amp; 0xF) &lt;&lt; 2) | (((*(pIn + 1)) &amp; 0xC0) &gt;&gt;6)];</span>
<a href="#l69.327"></a><span id="l69.327" class="difflineminus">-    pIn++; pOut++; len++; lineLen++;</span>
<a href="#l69.328"></a><span id="l69.328" class="difflineplus">+    pOut++;</span>
<a href="#l69.329"></a><span id="l69.329" class="difflineplus">+    len++;</span>
<a href="#l69.330"></a><span id="l69.330" class="difflineplus">+    lineLen++;</span>
<a href="#l69.331"></a><span id="l69.331" class="difflineplus">+    *pOut = gBase64[(((*pIn) &amp; 0x3) &lt;&lt; 4) | (((*(pIn + 1)) &amp; 0xF0) &gt;&gt; 4)];</span>
<a href="#l69.332"></a><span id="l69.332" class="difflineplus">+    pIn++;</span>
<a href="#l69.333"></a><span id="l69.333" class="difflineplus">+    pOut++;</span>
<a href="#l69.334"></a><span id="l69.334" class="difflineplus">+    len++;</span>
<a href="#l69.335"></a><span id="l69.335" class="difflineplus">+    lineLen++;</span>
<a href="#l69.336"></a><span id="l69.336" class="difflineplus">+    *pOut = gBase64[(((*pIn) &amp; 0xF) &lt;&lt; 2) | (((*(pIn + 1)) &amp; 0xC0) &gt;&gt; 6)];</span>
<a href="#l69.337"></a><span id="l69.337" class="difflineplus">+    pIn++;</span>
<a href="#l69.338"></a><span id="l69.338" class="difflineplus">+    pOut++;</span>
<a href="#l69.339"></a><span id="l69.339" class="difflineplus">+    len++;</span>
<a href="#l69.340"></a><span id="l69.340" class="difflineplus">+    lineLen++;</span>
<a href="#l69.341"></a><span id="l69.341">     *pOut = gBase64[(*pIn) &amp; 0x3F];</span>
<a href="#l69.342"></a><span id="l69.342" class="difflineminus">-    pIn++; pOut++; len++; lineLen++;</span>
<a href="#l69.343"></a><span id="l69.343" class="difflineplus">+    pIn++;</span>
<a href="#l69.344"></a><span id="l69.344" class="difflineplus">+    pOut++;</span>
<a href="#l69.345"></a><span id="l69.345" class="difflineplus">+    len++;</span>
<a href="#l69.346"></a><span id="l69.346" class="difflineplus">+    lineLen++;</span>
<a href="#l69.347"></a><span id="l69.347">     pos += 3;</span>
<a href="#l69.348"></a><span id="l69.348">     if (lineLen &gt;= maxLine) {</span>
<a href="#l69.349"></a><span id="l69.349">       lineLen = 0;</span>
<a href="#l69.350"></a><span id="l69.350">       maxLine = maxLen;</span>
<a href="#l69.351"></a><span id="l69.351">       if (pEolStr) {</span>
<a href="#l69.352"></a><span id="l69.352">         memcpy(pOut, pEolStr, eolLen);</span>
<a href="#l69.353"></a><span id="l69.353">         pOut += eolLen;</span>
<a href="#l69.354"></a><span id="l69.354">         len += eolLen;</span>
<a href="#l69.355"></a><span id="l69.355" class="difflineat">@@ -256,41 +257,52 @@ uint32_t UMimeEncode::ConvertBuffer(cons</span>
<a href="#l69.356"></a><span id="l69.356">       pOut += eolLen;</span>
<a href="#l69.357"></a><span id="l69.357">       len += eolLen;</span>
<a href="#l69.358"></a><span id="l69.358">     }</span>
<a href="#l69.359"></a><span id="l69.359">   }</span>
<a href="#l69.360"></a><span id="l69.360"> </span>
<a href="#l69.361"></a><span id="l69.361">   if (pos &lt; inLen) {</span>
<a href="#l69.362"></a><span id="l69.362">     // Get the last few bytes!</span>
<a href="#l69.363"></a><span id="l69.363">     *pOut = gBase64[*pIn &gt;&gt; 2];</span>
<a href="#l69.364"></a><span id="l69.364" class="difflineminus">-    pOut++; len++;</span>
<a href="#l69.365"></a><span id="l69.365" class="difflineplus">+    pOut++;</span>
<a href="#l69.366"></a><span id="l69.366" class="difflineplus">+    len++;</span>
<a href="#l69.367"></a><span id="l69.367">     pos++;</span>
<a href="#l69.368"></a><span id="l69.368">     if (pos &lt; inLen) {</span>
<a href="#l69.369"></a><span id="l69.369" class="difflineminus">-      *pOut = gBase64[(((*pIn) &amp; 0x3)&lt;&lt; 4) | (((*(pIn + 1)) &amp; 0xF0) &gt;&gt; 4)];</span>
<a href="#l69.370"></a><span id="l69.370" class="difflineminus">-      pIn++; pOut++; pos++; len++;</span>
<a href="#l69.371"></a><span id="l69.371" class="difflineplus">+      *pOut = gBase64[(((*pIn) &amp; 0x3) &lt;&lt; 4) | (((*(pIn + 1)) &amp; 0xF0) &gt;&gt; 4)];</span>
<a href="#l69.372"></a><span id="l69.372" class="difflineplus">+      pIn++;</span>
<a href="#l69.373"></a><span id="l69.373" class="difflineplus">+      pOut++;</span>
<a href="#l69.374"></a><span id="l69.374" class="difflineplus">+      pos++;</span>
<a href="#l69.375"></a><span id="l69.375" class="difflineplus">+      len++;</span>
<a href="#l69.376"></a><span id="l69.376">       if (pos &lt; inLen) {</span>
<a href="#l69.377"></a><span id="l69.377">         // Should be dead code!! (Then why is it here doofus?)</span>
<a href="#l69.378"></a><span id="l69.378" class="difflineminus">-        *pOut = gBase64[(((*pIn) &amp; 0xF) &lt;&lt; 2) | (((*(pIn + 1)) &amp; 0xC0) &gt;&gt;6)];</span>
<a href="#l69.379"></a><span id="l69.379" class="difflineminus">-        pIn++; pOut++; len++;</span>
<a href="#l69.380"></a><span id="l69.380" class="difflineplus">+        *pOut = gBase64[(((*pIn) &amp; 0xF) &lt;&lt; 2) | (((*(pIn + 1)) &amp; 0xC0) &gt;&gt; 6)];</span>
<a href="#l69.381"></a><span id="l69.381" class="difflineplus">+        pIn++;</span>
<a href="#l69.382"></a><span id="l69.382" class="difflineplus">+        pOut++;</span>
<a href="#l69.383"></a><span id="l69.383" class="difflineplus">+        len++;</span>
<a href="#l69.384"></a><span id="l69.384">         *pOut = gBase64[(*pIn) &amp; 0x3F];</span>
<a href="#l69.385"></a><span id="l69.385" class="difflineminus">-        pos++; pOut++; len++;</span>
<a href="#l69.386"></a><span id="l69.386" class="difflineminus">-      }</span>
<a href="#l69.387"></a><span id="l69.387" class="difflineminus">-      else {</span>
<a href="#l69.388"></a><span id="l69.388" class="difflineplus">+        pos++;</span>
<a href="#l69.389"></a><span id="l69.389" class="difflineplus">+        pOut++;</span>
<a href="#l69.390"></a><span id="l69.390" class="difflineplus">+        len++;</span>
<a href="#l69.391"></a><span id="l69.391" class="difflineplus">+      } else {</span>
<a href="#l69.392"></a><span id="l69.392">         *pOut = gBase64[(((*pIn) &amp; 0xF) &lt;&lt; 2)];</span>
<a href="#l69.393"></a><span id="l69.393" class="difflineminus">-        pOut++; len++;</span>
<a href="#l69.394"></a><span id="l69.394" class="difflineplus">+        pOut++;</span>
<a href="#l69.395"></a><span id="l69.395" class="difflineplus">+        len++;</span>
<a href="#l69.396"></a><span id="l69.396">         *pOut = '=';</span>
<a href="#l69.397"></a><span id="l69.397" class="difflineminus">-        pOut++; len++;</span>
<a href="#l69.398"></a><span id="l69.398" class="difflineplus">+        pOut++;</span>
<a href="#l69.399"></a><span id="l69.399" class="difflineplus">+        len++;</span>
<a href="#l69.400"></a><span id="l69.400">       }</span>
<a href="#l69.401"></a><span id="l69.401" class="difflineminus">-    }</span>
<a href="#l69.402"></a><span id="l69.402" class="difflineminus">-    else {</span>
<a href="#l69.403"></a><span id="l69.403" class="difflineminus">-      *pOut = gBase64[(((*pIn) &amp; 0x3)&lt;&lt; 4)];</span>
<a href="#l69.404"></a><span id="l69.404" class="difflineminus">-      pOut++; len++;</span>
<a href="#l69.405"></a><span id="l69.405" class="difflineplus">+    } else {</span>
<a href="#l69.406"></a><span id="l69.406" class="difflineplus">+      *pOut = gBase64[(((*pIn) &amp; 0x3) &lt;&lt; 4)];</span>
<a href="#l69.407"></a><span id="l69.407" class="difflineplus">+      pOut++;</span>
<a href="#l69.408"></a><span id="l69.408" class="difflineplus">+      len++;</span>
<a href="#l69.409"></a><span id="l69.409">       *pOut = '=';</span>
<a href="#l69.410"></a><span id="l69.410" class="difflineminus">-      pOut++; len++;</span>
<a href="#l69.411"></a><span id="l69.411" class="difflineplus">+      pOut++;</span>
<a href="#l69.412"></a><span id="l69.412" class="difflineplus">+      len++;</span>
<a href="#l69.413"></a><span id="l69.413">       *pOut = '=';</span>
<a href="#l69.414"></a><span id="l69.414" class="difflineminus">-      pOut++; len++;</span>
<a href="#l69.415"></a><span id="l69.415" class="difflineplus">+      pOut++;</span>
<a href="#l69.416"></a><span id="l69.416" class="difflineplus">+      len++;</span>
<a href="#l69.417"></a><span id="l69.417">     }</span>
<a href="#l69.418"></a><span id="l69.418">   }</span>
<a href="#l69.419"></a><span id="l69.419"> </span>
<a href="#l69.420"></a><span id="l69.420">   *pOut = 0;</span>
<a href="#l69.421"></a><span id="l69.421"> </span>
<a href="#l69.422"></a><span id="l69.422">   return len;</span>
<a href="#l69.423"></a><span id="l69.423"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l70.1"></a><span id="l70.1" class="difflineminus">--- a/mailnews/import/src/nsImportTranslator.h</span>
<a href="#l70.2"></a><span id="l70.2" class="difflineplus">+++ b/mailnews/import/src/nsImportTranslator.h</span>
<a href="#l70.3"></a><span id="l70.3" class="difflineat">@@ -9,58 +9,79 @@</span>
<a href="#l70.4"></a><span id="l70.4"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l70.5"></a><span id="l70.5"> #include &quot;nscore.h&quot;</span>
<a href="#l70.6"></a><span id="l70.6"> #include &quot;nsString.h&quot;</span>
<a href="#l70.7"></a><span id="l70.7"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l70.8"></a><span id="l70.8"> </span>
<a href="#l70.9"></a><span id="l70.9"> class ImportOutFile;</span>
<a href="#l70.10"></a><span id="l70.10"> </span>
<a href="#l70.11"></a><span id="l70.11"> class UMimeEncode {</span>
<a href="#l70.12"></a><span id="l70.12" class="difflineminus">-public:</span>
<a href="#l70.13"></a><span id="l70.13" class="difflineminus">-  static uint32_t  GetBufferSize(uint32_t inByes);</span>
<a href="#l70.14"></a><span id="l70.14" class="difflineminus">-  static uint32_t  ConvertBuffer(const uint8_t * pIn, uint32_t inLen, uint8_t *pOut, uint32_t maxLen = 72, uint32_t firstLineLen = 72, const char * pEolStr = nullptr);</span>
<a href="#l70.15"></a><span id="l70.15" class="difflineplus">+ public:</span>
<a href="#l70.16"></a><span id="l70.16" class="difflineplus">+  static uint32_t GetBufferSize(uint32_t inByes);</span>
<a href="#l70.17"></a><span id="l70.17" class="difflineplus">+  static uint32_t ConvertBuffer(const uint8_t *pIn, uint32_t inLen,</span>
<a href="#l70.18"></a><span id="l70.18" class="difflineplus">+                                uint8_t *pOut, uint32_t maxLen = 72,</span>
<a href="#l70.19"></a><span id="l70.19" class="difflineplus">+                                uint32_t firstLineLen = 72,</span>
<a href="#l70.20"></a><span id="l70.20" class="difflineplus">+                                const char *pEolStr = nullptr);</span>
<a href="#l70.21"></a><span id="l70.21"> };</span>
<a href="#l70.22"></a><span id="l70.22"> </span>
<a href="#l70.23"></a><span id="l70.23" class="difflineminus">-</span>
<a href="#l70.24"></a><span id="l70.24"> class nsImportTranslator {</span>
<a href="#l70.25"></a><span id="l70.25" class="difflineminus">-public:</span>
<a href="#l70.26"></a><span id="l70.26" class="difflineplus">+ public:</span>
<a href="#l70.27"></a><span id="l70.27">   virtual ~nsImportTranslator() {}</span>
<a href="#l70.28"></a><span id="l70.28" class="difflineminus">-  virtual bool      Supports8bitEncoding(void) { return false;}</span>
<a href="#l70.29"></a><span id="l70.29" class="difflineminus">-  virtual uint32_t  GetMaxBufferSize(uint32_t inLen) { return inLen + 1;}</span>
<a href="#l70.30"></a><span id="l70.30" class="difflineminus">-  virtual void    ConvertBuffer(const uint8_t * pIn, uint32_t inLen, uint8_t * pOut) { memcpy(pOut, pIn, inLen); pOut[inLen] = 0;}</span>
<a href="#l70.31"></a><span id="l70.31" class="difflineminus">-  virtual bool      ConvertToFile(const uint8_t * pIn, uint32_t inLen, ImportOutFile *pOutFile, uint32_t *pProcessed = nullptr);</span>
<a href="#l70.32"></a><span id="l70.32" class="difflineminus">-  virtual bool      FinishConvertToFile(ImportOutFile * /* pOutFile */) { return true;}</span>
<a href="#l70.33"></a><span id="l70.33" class="difflineplus">+  virtual bool Supports8bitEncoding(void) { return false; }</span>
<a href="#l70.34"></a><span id="l70.34" class="difflineplus">+  virtual uint32_t GetMaxBufferSize(uint32_t inLen) { return inLen + 1; }</span>
<a href="#l70.35"></a><span id="l70.35" class="difflineplus">+  virtual void ConvertBuffer(const uint8_t *pIn, uint32_t inLen,</span>
<a href="#l70.36"></a><span id="l70.36" class="difflineplus">+                             uint8_t *pOut) {</span>
<a href="#l70.37"></a><span id="l70.37" class="difflineplus">+    memcpy(pOut, pIn, inLen);</span>
<a href="#l70.38"></a><span id="l70.38" class="difflineplus">+    pOut[inLen] = 0;</span>
<a href="#l70.39"></a><span id="l70.39" class="difflineplus">+  }</span>
<a href="#l70.40"></a><span id="l70.40" class="difflineplus">+  virtual bool ConvertToFile(const uint8_t *pIn, uint32_t inLen,</span>
<a href="#l70.41"></a><span id="l70.41" class="difflineplus">+                             ImportOutFile *pOutFile,</span>
<a href="#l70.42"></a><span id="l70.42" class="difflineplus">+                             uint32_t *pProcessed = nullptr);</span>
<a href="#l70.43"></a><span id="l70.43" class="difflineplus">+  virtual bool FinishConvertToFile(ImportOutFile * /* pOutFile */) {</span>
<a href="#l70.44"></a><span id="l70.44" class="difflineplus">+    return true;</span>
<a href="#l70.45"></a><span id="l70.45" class="difflineplus">+  }</span>
<a href="#l70.46"></a><span id="l70.46"> </span>
<a href="#l70.47"></a><span id="l70.47" class="difflineminus">-  virtual void  GetCharset(nsCString&amp; charSet) { charSet = &quot;us-ascii&quot;;}</span>
<a href="#l70.48"></a><span id="l70.48" class="difflineminus">-  virtual void  GetLanguage(nsCString&amp; lang) { lang = &quot;en&quot;;}</span>
<a href="#l70.49"></a><span id="l70.49" class="difflineminus">-  virtual void  GetEncoding(nsCString&amp; encoding) { encoding.Truncate();}</span>
<a href="#l70.50"></a><span id="l70.50" class="difflineplus">+  virtual void GetCharset(nsCString &amp;charSet) { charSet = &quot;us-ascii&quot;; }</span>
<a href="#l70.51"></a><span id="l70.51" class="difflineplus">+  virtual void GetLanguage(nsCString &amp;lang) { lang = &quot;en&quot;; }</span>
<a href="#l70.52"></a><span id="l70.52" class="difflineplus">+  virtual void GetEncoding(nsCString &amp;encoding) { encoding.Truncate(); }</span>
<a href="#l70.53"></a><span id="l70.53"> };</span>
<a href="#l70.54"></a><span id="l70.54"> </span>
<a href="#l70.55"></a><span id="l70.55"> // Specialized encoder, not a valid language translator, used for Mime headers.</span>
<a href="#l70.56"></a><span id="l70.56"> // rfc2231</span>
<a href="#l70.57"></a><span id="l70.57"> class CMHTranslator : public nsImportTranslator {</span>
<a href="#l70.58"></a><span id="l70.58" class="difflineminus">-public:</span>
<a href="#l70.59"></a><span id="l70.59" class="difflineminus">-  virtual uint32_t  GetMaxBufferSize(uint32_t inLen) override { return (inLen * 3) + 1;}</span>
<a href="#l70.60"></a><span id="l70.60" class="difflineminus">-  virtual void    ConvertBuffer(const uint8_t * pIn, uint32_t inLen, uint8_t * pOut) override;</span>
<a href="#l70.61"></a><span id="l70.61" class="difflineminus">-  virtual bool      ConvertToFile(const uint8_t * pIn, uint32_t inLen, ImportOutFile *pOutFile, uint32_t *pProcessed = nullptr) override;</span>
<a href="#l70.62"></a><span id="l70.62" class="difflineplus">+ public:</span>
<a href="#l70.63"></a><span id="l70.63" class="difflineplus">+  virtual uint32_t GetMaxBufferSize(uint32_t inLen) override {</span>
<a href="#l70.64"></a><span id="l70.64" class="difflineplus">+    return (inLen * 3) + 1;</span>
<a href="#l70.65"></a><span id="l70.65" class="difflineplus">+  }</span>
<a href="#l70.66"></a><span id="l70.66" class="difflineplus">+  virtual void ConvertBuffer(const uint8_t *pIn, uint32_t inLen,</span>
<a href="#l70.67"></a><span id="l70.67" class="difflineplus">+                             uint8_t *pOut) override;</span>
<a href="#l70.68"></a><span id="l70.68" class="difflineplus">+  virtual bool ConvertToFile(const uint8_t *pIn, uint32_t inLen,</span>
<a href="#l70.69"></a><span id="l70.69" class="difflineplus">+                             ImportOutFile *pOutFile,</span>
<a href="#l70.70"></a><span id="l70.70" class="difflineplus">+                             uint32_t *pProcessed = nullptr) override;</span>
<a href="#l70.71"></a><span id="l70.71"> };</span>
<a href="#l70.72"></a><span id="l70.72"> </span>
<a href="#l70.73"></a><span id="l70.73"> // Specialized encoder, not a valid language translator, used for mail headers</span>
<a href="#l70.74"></a><span id="l70.74"> // rfc2047</span>
<a href="#l70.75"></a><span id="l70.75"> class C2047Translator : public nsImportTranslator {</span>
<a href="#l70.76"></a><span id="l70.76" class="difflineminus">-public:</span>
<a href="#l70.77"></a><span id="l70.77" class="difflineplus">+ public:</span>
<a href="#l70.78"></a><span id="l70.78">   virtual ~C2047Translator() {}</span>
<a href="#l70.79"></a><span id="l70.79"> </span>
<a href="#l70.80"></a><span id="l70.80" class="difflineminus">-  C2047Translator(const char *pCharset, uint32_t headerLen) { m_charset = pCharset; m_startLen = headerLen; m_useQuotedPrintable = false;}</span>
<a href="#l70.81"></a><span id="l70.81" class="difflineplus">+  C2047Translator(const char *pCharset, uint32_t headerLen) {</span>
<a href="#l70.82"></a><span id="l70.82" class="difflineplus">+    m_charset = pCharset;</span>
<a href="#l70.83"></a><span id="l70.83" class="difflineplus">+    m_startLen = headerLen;</span>
<a href="#l70.84"></a><span id="l70.84" class="difflineplus">+    m_useQuotedPrintable = false;</span>
<a href="#l70.85"></a><span id="l70.85" class="difflineplus">+  }</span>
<a href="#l70.86"></a><span id="l70.86"> </span>
<a href="#l70.87"></a><span id="l70.87" class="difflineminus">-  void  SetUseQuotedPrintable(void) { m_useQuotedPrintable = true;}</span>
<a href="#l70.88"></a><span id="l70.88" class="difflineplus">+  void SetUseQuotedPrintable(void) { m_useQuotedPrintable = true; }</span>
<a href="#l70.89"></a><span id="l70.89"> </span>
<a href="#l70.90"></a><span id="l70.90" class="difflineminus">-  virtual bool    ConvertToFile(const uint8_t * pIn, uint32_t inLen, ImportOutFile *pOutFile, uint32_t *pProcessed = nullptr) override;</span>
<a href="#l70.91"></a><span id="l70.91" class="difflineminus">-  bool    ConvertToFileQ(const uint8_t * pIn, uint32_t inLen, ImportOutFile *pOutFile, uint32_t *pProcessed);</span>
<a href="#l70.92"></a><span id="l70.92" class="difflineplus">+  virtual bool ConvertToFile(const uint8_t *pIn, uint32_t inLen,</span>
<a href="#l70.93"></a><span id="l70.93" class="difflineplus">+                             ImportOutFile *pOutFile,</span>
<a href="#l70.94"></a><span id="l70.94" class="difflineplus">+                             uint32_t *pProcessed = nullptr) override;</span>
<a href="#l70.95"></a><span id="l70.95" class="difflineplus">+  bool ConvertToFileQ(const uint8_t *pIn, uint32_t inLen,</span>
<a href="#l70.96"></a><span id="l70.96" class="difflineplus">+                      ImportOutFile *pOutFile, uint32_t *pProcessed);</span>
<a href="#l70.97"></a><span id="l70.97"> </span>
<a href="#l70.98"></a><span id="l70.98" class="difflineminus">-protected:</span>
<a href="#l70.99"></a><span id="l70.99" class="difflineminus">-  bool        m_useQuotedPrintable;</span>
<a href="#l70.100"></a><span id="l70.100" class="difflineminus">-  nsCString    m_charset;</span>
<a href="#l70.101"></a><span id="l70.101" class="difflineminus">-  uint32_t    m_startLen;</span>
<a href="#l70.102"></a><span id="l70.102" class="difflineplus">+ protected:</span>
<a href="#l70.103"></a><span id="l70.103" class="difflineplus">+  bool m_useQuotedPrintable;</span>
<a href="#l70.104"></a><span id="l70.104" class="difflineplus">+  nsCString m_charset;</span>
<a href="#l70.105"></a><span id="l70.105" class="difflineplus">+  uint32_t m_startLen;</span>
<a href="#l70.106"></a><span id="l70.106"> };</span>
<a href="#l70.107"></a><span id="l70.107"> </span>
<a href="#l70.108"></a><span id="l70.108"> #endif /* nsImportTranslator_h__ */</span>
<a href="#l70.109"></a><span id="l70.109" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l71.1"></a><span id="l71.1" class="difflineminus">--- a/mailnews/import/text/src/nsTextAddress.cpp</span>
<a href="#l71.2"></a><span id="l71.2" class="difflineplus">+++ b/mailnews/import/text/src/nsTextAddress.cpp</span>
<a href="#l71.3"></a><span id="l71.3" class="difflineat">@@ -16,52 +16,49 @@</span>
<a href="#l71.4"></a><span id="l71.4"> #include &quot;nsIConverterInputStream.h&quot;</span>
<a href="#l71.5"></a><span id="l71.5"> #include &quot;nsIUnicharLineInputStream.h&quot;</span>
<a href="#l71.6"></a><span id="l71.6"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l71.7"></a><span id="l71.7"> </span>
<a href="#l71.8"></a><span id="l71.8"> #include &quot;ImportDebug.h&quot;</span>
<a href="#l71.9"></a><span id="l71.9"> #include &quot;plstr.h&quot;</span>
<a href="#l71.10"></a><span id="l71.10"> #include &quot;msgCore.h&quot;</span>
<a href="#l71.11"></a><span id="l71.11"> </span>
<a href="#l71.12"></a><span id="l71.12" class="difflineminus">-#define kWhitespace    &quot; \t\b\r\n&quot;</span>
<a href="#l71.13"></a><span id="l71.13" class="difflineplus">+#define kWhitespace &quot; \t\b\r\n&quot;</span>
<a href="#l71.14"></a><span id="l71.14"> </span>
<a href="#l71.15"></a><span id="l71.15" class="difflineminus">-nsTextAddress::nsTextAddress()</span>
<a href="#l71.16"></a><span id="l71.16" class="difflineminus">-{</span>
<a href="#l71.17"></a><span id="l71.17" class="difflineplus">+nsTextAddress::nsTextAddress() {</span>
<a href="#l71.18"></a><span id="l71.18">   m_LFCount = 0;</span>
<a href="#l71.19"></a><span id="l71.19">   m_CRCount = 0;</span>
<a href="#l71.20"></a><span id="l71.20"> }</span>
<a href="#l71.21"></a><span id="l71.21"> </span>
<a href="#l71.22"></a><span id="l71.22" class="difflineminus">-nsTextAddress::~nsTextAddress()</span>
<a href="#l71.23"></a><span id="l71.23" class="difflineminus">-{</span>
<a href="#l71.24"></a><span id="l71.24" class="difflineminus">-}</span>
<a href="#l71.25"></a><span id="l71.25" class="difflineplus">+nsTextAddress::~nsTextAddress() {}</span>
<a href="#l71.26"></a><span id="l71.26"> </span>
<a href="#l71.27"></a><span id="l71.27" class="difflineminus">-nsresult nsTextAddress::GetUnicharLineStreamForFile(nsIFile *aFile,</span>
<a href="#l71.28"></a><span id="l71.28" class="difflineminus">-                                                    nsIInputStream *aInputStream,</span>
<a href="#l71.29"></a><span id="l71.29" class="difflineminus">-                                                    nsIUnicharLineInputStream **aStream)</span>
<a href="#l71.30"></a><span id="l71.30" class="difflineminus">-{</span>
<a href="#l71.31"></a><span id="l71.31" class="difflineplus">+nsresult nsTextAddress::GetUnicharLineStreamForFile(</span>
<a href="#l71.32"></a><span id="l71.32" class="difflineplus">+    nsIFile *aFile, nsIInputStream *aInputStream,</span>
<a href="#l71.33"></a><span id="l71.33" class="difflineplus">+    nsIUnicharLineInputStream **aStream) {</span>
<a href="#l71.34"></a><span id="l71.34">   nsAutoCString charset;</span>
<a href="#l71.35"></a><span id="l71.35">   nsresult rv = MsgDetectCharsetFromFile(aFile, charset);</span>
<a href="#l71.36"></a><span id="l71.36">   if (NS_FAILED(rv)) {</span>
<a href="#l71.37"></a><span id="l71.37">     charset = nsMsgI18NFileSystemCharset();</span>
<a href="#l71.38"></a><span id="l71.38">   }</span>
<a href="#l71.39"></a><span id="l71.39"> </span>
<a href="#l71.40"></a><span id="l71.40">   nsCOMPtr&lt;nsIConverterInputStream&gt; converterStream =</span>
<a href="#l71.41"></a><span id="l71.41" class="difflineminus">-    do_CreateInstance(&quot;@mozilla.org/intl/converter-input-stream;1&quot;, &amp;rv);</span>
<a href="#l71.42"></a><span id="l71.42" class="difflineplus">+      do_CreateInstance(&quot;@mozilla.org/intl/converter-input-stream;1&quot;, &amp;rv);</span>
<a href="#l71.43"></a><span id="l71.43">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l71.44"></a><span id="l71.44" class="difflineminus">-    rv = converterStream-&gt;Init(aInputStream,</span>
<a href="#l71.45"></a><span id="l71.45" class="difflineminus">-                               charset.get(),</span>
<a href="#l71.46"></a><span id="l71.46" class="difflineminus">-                               8192,</span>
<a href="#l71.47"></a><span id="l71.47" class="difflineminus">-                               nsIConverterInputStream::DEFAULT_REPLACEMENT_CHARACTER);</span>
<a href="#l71.48"></a><span id="l71.48" class="difflineplus">+    rv = converterStream-&gt;Init(</span>
<a href="#l71.49"></a><span id="l71.49" class="difflineplus">+        aInputStream, charset.get(), 8192,</span>
<a href="#l71.50"></a><span id="l71.50" class="difflineplus">+        nsIConverterInputStream::DEFAULT_REPLACEMENT_CHARACTER);</span>
<a href="#l71.51"></a><span id="l71.51">   }</span>
<a href="#l71.52"></a><span id="l71.52"> </span>
<a href="#l71.53"></a><span id="l71.53">   return CallQueryInterface(converterStream, aStream);</span>
<a href="#l71.54"></a><span id="l71.54"> }</span>
<a href="#l71.55"></a><span id="l71.55"> </span>
<a href="#l71.56"></a><span id="l71.56" class="difflineminus">-nsresult nsTextAddress::ImportAddresses(bool *pAbort, const char16_t *pName, nsIFile *pSrc, nsIAddrDatabase *pDb, nsIImportFieldMap *fieldMap, nsString&amp; errors, uint32_t *pProgress)</span>
<a href="#l71.57"></a><span id="l71.57" class="difflineminus">-{</span>
<a href="#l71.58"></a><span id="l71.58" class="difflineplus">+nsresult nsTextAddress::ImportAddresses(bool *pAbort, const char16_t *pName,</span>
<a href="#l71.59"></a><span id="l71.59" class="difflineplus">+                                        nsIFile *pSrc, nsIAddrDatabase *pDb,</span>
<a href="#l71.60"></a><span id="l71.60" class="difflineplus">+                                        nsIImportFieldMap *fieldMap,</span>
<a href="#l71.61"></a><span id="l71.61" class="difflineplus">+                                        nsString &amp;errors, uint32_t *pProgress) {</span>
<a href="#l71.62"></a><span id="l71.62">   // Open the source file for reading, read each line and process it!</span>
<a href="#l71.63"></a><span id="l71.63">   m_database = pDb;</span>
<a href="#l71.64"></a><span id="l71.64">   m_fieldMap = fieldMap;</span>
<a href="#l71.65"></a><span id="l71.65"> </span>
<a href="#l71.66"></a><span id="l71.66">   nsCOMPtr&lt;nsIInputStream&gt; inputStream;</span>
<a href="#l71.67"></a><span id="l71.67">   nsresult rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream), pSrc);</span>
<a href="#l71.68"></a><span id="l71.68">   if (NS_FAILED(rv)) {</span>
<a href="#l71.69"></a><span id="l71.69">     IMPORT_LOG0(&quot;*** Error opening address file for reading\n&quot;);</span>
<a href="#l71.70"></a><span id="l71.70" class="difflineat">@@ -79,33 +76,34 @@ nsresult nsTextAddress::ImportAddresses(</span>
<a href="#l71.71"></a><span id="l71.71">     return rv;</span>
<a href="#l71.72"></a><span id="l71.72">   }</span>
<a href="#l71.73"></a><span id="l71.73"> </span>
<a href="#l71.74"></a><span id="l71.74">   uint64_t totalBytes = bytesLeft;</span>
<a href="#l71.75"></a><span id="l71.75">   bool skipRecord = false;</span>
<a href="#l71.76"></a><span id="l71.76"> </span>
<a href="#l71.77"></a><span id="l71.77">   rv = m_fieldMap-&gt;GetSkipFirstRecord(&amp;skipRecord);</span>
<a href="#l71.78"></a><span id="l71.78">   if (NS_FAILED(rv)) {</span>
<a href="#l71.79"></a><span id="l71.79" class="difflineminus">-    IMPORT_LOG0(&quot;*** Error checking to see if we should skip the first record\n&quot;);</span>
<a href="#l71.80"></a><span id="l71.80" class="difflineplus">+    IMPORT_LOG0(</span>
<a href="#l71.81"></a><span id="l71.81" class="difflineplus">+        &quot;*** Error checking to see if we should skip the first record\n&quot;);</span>
<a href="#l71.82"></a><span id="l71.82">     return rv;</span>
<a href="#l71.83"></a><span id="l71.83">   }</span>
<a href="#l71.84"></a><span id="l71.84"> </span>
<a href="#l71.85"></a><span id="l71.85">   nsCOMPtr&lt;nsIUnicharLineInputStream&gt; lineStream;</span>
<a href="#l71.86"></a><span id="l71.86" class="difflineminus">-  rv = GetUnicharLineStreamForFile(pSrc, inputStream, getter_AddRefs(lineStream));</span>
<a href="#l71.87"></a><span id="l71.87" class="difflineplus">+  rv = GetUnicharLineStreamForFile(pSrc, inputStream,</span>
<a href="#l71.88"></a><span id="l71.88" class="difflineplus">+                                   getter_AddRefs(lineStream));</span>
<a href="#l71.89"></a><span id="l71.89">   if (NS_FAILED(rv)) {</span>
<a href="#l71.90"></a><span id="l71.90">     IMPORT_LOG0(&quot;*** Error opening converter stream for importer\n&quot;);</span>
<a href="#l71.91"></a><span id="l71.91">     return rv;</span>
<a href="#l71.92"></a><span id="l71.92">   }</span>
<a href="#l71.93"></a><span id="l71.93"> </span>
<a href="#l71.94"></a><span id="l71.94">   bool more = true;</span>
<a href="#l71.95"></a><span id="l71.95">   nsAutoString line;</span>
<a href="#l71.96"></a><span id="l71.96"> </span>
<a href="#l71.97"></a><span id="l71.97">   // Skip the first record if the user has requested it.</span>
<a href="#l71.98"></a><span id="l71.98" class="difflineminus">-  if (skipRecord)</span>
<a href="#l71.99"></a><span id="l71.99" class="difflineminus">-    rv = ReadRecord(lineStream, line, &amp;more);</span>
<a href="#l71.100"></a><span id="l71.100" class="difflineplus">+  if (skipRecord) rv = ReadRecord(lineStream, line, &amp;more);</span>
<a href="#l71.101"></a><span id="l71.101"> </span>
<a href="#l71.102"></a><span id="l71.102">   while (!(*pAbort) &amp;&amp; more &amp;&amp; NS_SUCCEEDED(rv)) {</span>
<a href="#l71.103"></a><span id="l71.103">     // Read the line in</span>
<a href="#l71.104"></a><span id="l71.104">     rv = ReadRecord(lineStream, line, &amp;more);</span>
<a href="#l71.105"></a><span id="l71.105">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l71.106"></a><span id="l71.106">       // Now process it to add it to the database</span>
<a href="#l71.107"></a><span id="l71.107">       rv = ProcessLine(line, errors);</span>
<a href="#l71.108"></a><span id="l71.108"> </span>
<a href="#l71.109"></a><span id="l71.109" class="difflineat">@@ -120,60 +118,57 @@ nsresult nsTextAddress::ImportAddresses(</span>
<a href="#l71.110"></a><span id="l71.110">       bytesLeft -= line.Length();</span>
<a href="#l71.111"></a><span id="l71.111">       *pProgress = std::min(totalBytes - bytesLeft, uint64_t(PR_UINT32_MAX));</span>
<a href="#l71.112"></a><span id="l71.112">     }</span>
<a href="#l71.113"></a><span id="l71.113">   }</span>
<a href="#l71.114"></a><span id="l71.114"> </span>
<a href="#l71.115"></a><span id="l71.115">   inputStream-&gt;Close();</span>
<a href="#l71.116"></a><span id="l71.116"> </span>
<a href="#l71.117"></a><span id="l71.117">   if (NS_FAILED(rv)) {</span>
<a href="#l71.118"></a><span id="l71.118" class="difflineminus">-    IMPORT_LOG0(&quot;*** Error reading the address book - probably incorrect ending\n&quot;);</span>
<a href="#l71.119"></a><span id="l71.119" class="difflineplus">+    IMPORT_LOG0(</span>
<a href="#l71.120"></a><span id="l71.120" class="difflineplus">+        &quot;*** Error reading the address book - probably incorrect ending\n&quot;);</span>
<a href="#l71.121"></a><span id="l71.121">     return NS_ERROR_FAILURE;</span>
<a href="#l71.122"></a><span id="l71.122">   }</span>
<a href="#l71.123"></a><span id="l71.123"> </span>
<a href="#l71.124"></a><span id="l71.124">   return pDb-&gt;Commit(nsAddrDBCommitType::kLargeCommit);</span>
<a href="#l71.125"></a><span id="l71.125"> }</span>
<a href="#l71.126"></a><span id="l71.126"> </span>
<a href="#l71.127"></a><span id="l71.127"> nsresult nsTextAddress::ReadRecord(nsIUnicharLineInputStream *aLineStream,</span>
<a href="#l71.128"></a><span id="l71.128" class="difflineminus">-                                   nsAString &amp;aLine,</span>
<a href="#l71.129"></a><span id="l71.129" class="difflineminus">-                                   bool *aMore)</span>
<a href="#l71.130"></a><span id="l71.130" class="difflineminus">-{</span>
<a href="#l71.131"></a><span id="l71.131" class="difflineplus">+                                   nsAString &amp;aLine, bool *aMore) {</span>
<a href="#l71.132"></a><span id="l71.132">   bool more = true;</span>
<a href="#l71.133"></a><span id="l71.133">   uint32_t numQuotes = 0;</span>
<a href="#l71.134"></a><span id="l71.134">   nsresult rv;</span>
<a href="#l71.135"></a><span id="l71.135">   nsAutoString line;</span>
<a href="#l71.136"></a><span id="l71.136"> </span>
<a href="#l71.137"></a><span id="l71.137">   // ensure aLine is empty</span>
<a href="#l71.138"></a><span id="l71.138">   aLine.Truncate();</span>
<a href="#l71.139"></a><span id="l71.139"> </span>
<a href="#l71.140"></a><span id="l71.140">   do {</span>
<a href="#l71.141"></a><span id="l71.141">     if (!more) {</span>
<a href="#l71.142"></a><span id="l71.142">       // No more, so we must have an incorrect file.</span>
<a href="#l71.143"></a><span id="l71.143">       rv = NS_ERROR_FAILURE;</span>
<a href="#l71.144"></a><span id="l71.144" class="difflineminus">-    }</span>
<a href="#l71.145"></a><span id="l71.145" class="difflineminus">-    else {</span>
<a href="#l71.146"></a><span id="l71.146" class="difflineplus">+    } else {</span>
<a href="#l71.147"></a><span id="l71.147">       // Read the line and append it</span>
<a href="#l71.148"></a><span id="l71.148">       rv = aLineStream-&gt;ReadLine(line, &amp;more);</span>
<a href="#l71.149"></a><span id="l71.149">       if (NS_SUCCEEDED(rv)) {</span>
<a href="#l71.150"></a><span id="l71.150" class="difflineminus">-        if (!aLine.IsEmpty())</span>
<a href="#l71.151"></a><span id="l71.151" class="difflineminus">-          aLine.AppendLiteral(MSG_LINEBREAK);</span>
<a href="#l71.152"></a><span id="l71.152" class="difflineplus">+        if (!aLine.IsEmpty()) aLine.AppendLiteral(MSG_LINEBREAK);</span>
<a href="#l71.153"></a><span id="l71.153">         aLine.Append(line);</span>
<a href="#l71.154"></a><span id="l71.154"> </span>
<a href="#l71.155"></a><span id="l71.155">         numQuotes += MsgCountChar(line, char16_t('&quot;'));</span>
<a href="#l71.156"></a><span id="l71.156">       }</span>
<a href="#l71.157"></a><span id="l71.157">     }</span>
<a href="#l71.158"></a><span id="l71.158">     // Continue whilst everything is ok, and we have an odd number of quotes.</span>
<a href="#l71.159"></a><span id="l71.159">   } while (NS_SUCCEEDED(rv) &amp;&amp; (numQuotes % 2 != 0));</span>
<a href="#l71.160"></a><span id="l71.160"> </span>
<a href="#l71.161"></a><span id="l71.161">   *aMore = more;</span>
<a href="#l71.162"></a><span id="l71.162">   return rv;</span>
<a href="#l71.163"></a><span id="l71.163"> }</span>
<a href="#l71.164"></a><span id="l71.164"> </span>
<a href="#l71.165"></a><span id="l71.165" class="difflineminus">-nsresult nsTextAddress::ReadRecordNumber(nsIFile *aSrc, nsAString &amp;aLine, int32_t rNum)</span>
<a href="#l71.166"></a><span id="l71.166" class="difflineminus">-{</span>
<a href="#l71.167"></a><span id="l71.167" class="difflineplus">+nsresult nsTextAddress::ReadRecordNumber(nsIFile *aSrc, nsAString &amp;aLine,</span>
<a href="#l71.168"></a><span id="l71.168" class="difflineplus">+                                         int32_t rNum) {</span>
<a href="#l71.169"></a><span id="l71.169">   nsCOMPtr&lt;nsIInputStream&gt; inputStream;</span>
<a href="#l71.170"></a><span id="l71.170">   nsresult rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream), aSrc);</span>
<a href="#l71.171"></a><span id="l71.171">   if (NS_FAILED(rv)) {</span>
<a href="#l71.172"></a><span id="l71.172">     IMPORT_LOG0(&quot;*** Error opening address file for reading\n&quot;);</span>
<a href="#l71.173"></a><span id="l71.173">     return rv;</span>
<a href="#l71.174"></a><span id="l71.174">   }</span>
<a href="#l71.175"></a><span id="l71.175"> </span>
<a href="#l71.176"></a><span id="l71.176">   int32_t rIndex = 0;</span>
<a href="#l71.177"></a><span id="l71.177" class="difflineat">@@ -182,17 +177,18 @@ nsresult nsTextAddress::ReadRecordNumber</span>
<a href="#l71.178"></a><span id="l71.178">   rv = inputStream-&gt;Available(&amp;bytesLeft);</span>
<a href="#l71.179"></a><span id="l71.179">   if (NS_FAILED(rv)) {</span>
<a href="#l71.180"></a><span id="l71.180">     IMPORT_LOG0(&quot;*** Error checking address file for eof\n&quot;);</span>
<a href="#l71.181"></a><span id="l71.181">     inputStream-&gt;Close();</span>
<a href="#l71.182"></a><span id="l71.182">     return rv;</span>
<a href="#l71.183"></a><span id="l71.183">   }</span>
<a href="#l71.184"></a><span id="l71.184"> </span>
<a href="#l71.185"></a><span id="l71.185">   nsCOMPtr&lt;nsIUnicharLineInputStream&gt; lineStream;</span>
<a href="#l71.186"></a><span id="l71.186" class="difflineminus">-  rv = GetUnicharLineStreamForFile(aSrc, inputStream, getter_AddRefs(lineStream));</span>
<a href="#l71.187"></a><span id="l71.187" class="difflineplus">+  rv = GetUnicharLineStreamForFile(aSrc, inputStream,</span>
<a href="#l71.188"></a><span id="l71.188" class="difflineplus">+                                   getter_AddRefs(lineStream));</span>
<a href="#l71.189"></a><span id="l71.189">   if (NS_FAILED(rv)) {</span>
<a href="#l71.190"></a><span id="l71.190">     IMPORT_LOG0(&quot;*** Error opening converter stream for importer\n&quot;);</span>
<a href="#l71.191"></a><span id="l71.191">     return rv;</span>
<a href="#l71.192"></a><span id="l71.192">   }</span>
<a href="#l71.193"></a><span id="l71.193"> </span>
<a href="#l71.194"></a><span id="l71.194">   bool more = true;</span>
<a href="#l71.195"></a><span id="l71.195"> </span>
<a href="#l71.196"></a><span id="l71.196">   while (more &amp;&amp; (rIndex &lt;= rNum)) {</span>
<a href="#l71.197"></a><span id="l71.197" class="difflineat">@@ -207,173 +203,154 @@ nsresult nsTextAddress::ReadRecordNumber</span>
<a href="#l71.198"></a><span id="l71.198">     }</span>
<a href="#l71.199"></a><span id="l71.199"> </span>
<a href="#l71.200"></a><span id="l71.200">     rIndex++;</span>
<a href="#l71.201"></a><span id="l71.201">   }</span>
<a href="#l71.202"></a><span id="l71.202"> </span>
<a href="#l71.203"></a><span id="l71.203">   return NS_ERROR_FAILURE;</span>
<a href="#l71.204"></a><span id="l71.204"> }</span>
<a href="#l71.205"></a><span id="l71.205"> </span>
<a href="#l71.206"></a><span id="l71.206" class="difflineminus">-int32_t nsTextAddress::CountFields(const nsAString &amp;aLine, char16_t delim)</span>
<a href="#l71.207"></a><span id="l71.207" class="difflineminus">-{</span>
<a href="#l71.208"></a><span id="l71.208" class="difflineminus">-    int32_t pos = 0;</span>
<a href="#l71.209"></a><span id="l71.209" class="difflineminus">-    int32_t maxLen = aLine.Length();</span>
<a href="#l71.210"></a><span id="l71.210" class="difflineminus">-    int32_t count = 0;</span>
<a href="#l71.211"></a><span id="l71.211" class="difflineminus">-    char16_t tab = char16_t('\t');</span>
<a href="#l71.212"></a><span id="l71.212" class="difflineminus">-    char16_t doubleQuote = char16_t('&quot;');</span>
<a href="#l71.213"></a><span id="l71.213" class="difflineplus">+int32_t nsTextAddress::CountFields(const nsAString &amp;aLine, char16_t delim) {</span>
<a href="#l71.214"></a><span id="l71.214" class="difflineplus">+  int32_t pos = 0;</span>
<a href="#l71.215"></a><span id="l71.215" class="difflineplus">+  int32_t maxLen = aLine.Length();</span>
<a href="#l71.216"></a><span id="l71.216" class="difflineplus">+  int32_t count = 0;</span>
<a href="#l71.217"></a><span id="l71.217" class="difflineplus">+  char16_t tab = char16_t('\t');</span>
<a href="#l71.218"></a><span id="l71.218" class="difflineplus">+  char16_t doubleQuote = char16_t('&quot;');</span>
<a href="#l71.219"></a><span id="l71.219" class="difflineplus">+</span>
<a href="#l71.220"></a><span id="l71.220" class="difflineplus">+  if (delim == tab) tab = char16_t('\0');</span>
<a href="#l71.221"></a><span id="l71.221"> </span>
<a href="#l71.222"></a><span id="l71.222" class="difflineminus">-    if (delim == tab)</span>
<a href="#l71.223"></a><span id="l71.223" class="difflineminus">-        tab = char16_t('\0');</span>
<a href="#l71.224"></a><span id="l71.224" class="difflineminus">-</span>
<a href="#l71.225"></a><span id="l71.225" class="difflineminus">-    while (pos &lt; maxLen) {</span>
<a href="#l71.226"></a><span id="l71.226" class="difflineminus">-        while (((aLine[pos] == char16_t(' ')) || (aLine[pos] == tab)) &amp;&amp;</span>
<a href="#l71.227"></a><span id="l71.227" class="difflineminus">-               (pos &lt; maxLen)) {</span>
<a href="#l71.228"></a><span id="l71.228" class="difflineminus">-            pos++;</span>
<a href="#l71.229"></a><span id="l71.229" class="difflineplus">+  while (pos &lt; maxLen) {</span>
<a href="#l71.230"></a><span id="l71.230" class="difflineplus">+    while (((aLine[pos] == char16_t(' ')) || (aLine[pos] == tab)) &amp;&amp;</span>
<a href="#l71.231"></a><span id="l71.231" class="difflineplus">+           (pos &lt; maxLen)) {</span>
<a href="#l71.232"></a><span id="l71.232" class="difflineplus">+      pos++;</span>
<a href="#l71.233"></a><span id="l71.233" class="difflineplus">+    }</span>
<a href="#l71.234"></a><span id="l71.234" class="difflineplus">+    if ((pos &lt; maxLen) &amp;&amp; (aLine[pos] == doubleQuote)) {</span>
<a href="#l71.235"></a><span id="l71.235" class="difflineplus">+      pos++;</span>
<a href="#l71.236"></a><span id="l71.236" class="difflineplus">+      while ((pos &lt; maxLen) &amp;&amp; (aLine[pos] != doubleQuote)) {</span>
<a href="#l71.237"></a><span id="l71.237" class="difflineplus">+        pos++;</span>
<a href="#l71.238"></a><span id="l71.238" class="difflineplus">+        if (((pos + 1) &lt; maxLen) &amp;&amp; (aLine[pos] == doubleQuote) &amp;&amp;</span>
<a href="#l71.239"></a><span id="l71.239" class="difflineplus">+            (aLine[pos + 1] == doubleQuote)) {</span>
<a href="#l71.240"></a><span id="l71.240" class="difflineplus">+          pos += 2;</span>
<a href="#l71.241"></a><span id="l71.241">         }</span>
<a href="#l71.242"></a><span id="l71.242" class="difflineminus">-        if ((pos &lt; maxLen) &amp;&amp; (aLine[pos] == doubleQuote)) {</span>
<a href="#l71.243"></a><span id="l71.243" class="difflineminus">-            pos++;</span>
<a href="#l71.244"></a><span id="l71.244" class="difflineminus">-            while ((pos &lt; maxLen) &amp;&amp; (aLine[pos] != doubleQuote)) {</span>
<a href="#l71.245"></a><span id="l71.245" class="difflineminus">-                pos++;</span>
<a href="#l71.246"></a><span id="l71.246" class="difflineminus">-                if (((pos + 1) &lt; maxLen) &amp;&amp;</span>
<a href="#l71.247"></a><span id="l71.247" class="difflineminus">-                    (aLine[pos] == doubleQuote) &amp;&amp;</span>
<a href="#l71.248"></a><span id="l71.248" class="difflineminus">-                    (aLine[pos + 1] == doubleQuote)) {</span>
<a href="#l71.249"></a><span id="l71.249" class="difflineminus">-                    pos += 2;</span>
<a href="#l71.250"></a><span id="l71.250" class="difflineminus">-                }</span>
<a href="#l71.251"></a><span id="l71.251" class="difflineminus">-            }</span>
<a href="#l71.252"></a><span id="l71.252" class="difflineminus">-            if (pos &lt; maxLen)</span>
<a href="#l71.253"></a><span id="l71.253" class="difflineminus">-                pos++;</span>
<a href="#l71.254"></a><span id="l71.254" class="difflineminus">-        }</span>
<a href="#l71.255"></a><span id="l71.255" class="difflineminus">-        while ((pos &lt; maxLen) &amp;&amp; (aLine[pos] != delim))</span>
<a href="#l71.256"></a><span id="l71.256" class="difflineminus">-            pos++;</span>
<a href="#l71.257"></a><span id="l71.257" class="difflineplus">+      }</span>
<a href="#l71.258"></a><span id="l71.258" class="difflineplus">+      if (pos &lt; maxLen) pos++;</span>
<a href="#l71.259"></a><span id="l71.259" class="difflineplus">+    }</span>
<a href="#l71.260"></a><span id="l71.260" class="difflineplus">+    while ((pos &lt; maxLen) &amp;&amp; (aLine[pos] != delim)) pos++;</span>
<a href="#l71.261"></a><span id="l71.261"> </span>
<a href="#l71.262"></a><span id="l71.262" class="difflineminus">-        count++;</span>
<a href="#l71.263"></a><span id="l71.263" class="difflineminus">-        pos++;</span>
<a href="#l71.264"></a><span id="l71.264" class="difflineminus">-    }</span>
<a href="#l71.265"></a><span id="l71.265" class="difflineplus">+    count++;</span>
<a href="#l71.266"></a><span id="l71.266" class="difflineplus">+    pos++;</span>
<a href="#l71.267"></a><span id="l71.267" class="difflineplus">+  }</span>
<a href="#l71.268"></a><span id="l71.268"> </span>
<a href="#l71.269"></a><span id="l71.269" class="difflineminus">-    return count;</span>
<a href="#l71.270"></a><span id="l71.270" class="difflineplus">+  return count;</span>
<a href="#l71.271"></a><span id="l71.271"> }</span>
<a href="#l71.272"></a><span id="l71.272"> </span>
<a href="#l71.273"></a><span id="l71.273" class="difflineminus">-bool nsTextAddress::GetField(const nsAString &amp;aLine,</span>
<a href="#l71.274"></a><span id="l71.274" class="difflineminus">-                             int32_t index,</span>
<a href="#l71.275"></a><span id="l71.275" class="difflineminus">-                             nsString &amp;field,</span>
<a href="#l71.276"></a><span id="l71.276" class="difflineminus">-                             char16_t delim)</span>
<a href="#l71.277"></a><span id="l71.277" class="difflineminus">-{</span>
<a href="#l71.278"></a><span id="l71.278" class="difflineminus">-    bool result = false;</span>
<a href="#l71.279"></a><span id="l71.279" class="difflineminus">-    int32_t pos = 0;</span>
<a href="#l71.280"></a><span id="l71.280" class="difflineminus">-    int32_t maxLen = aLine.Length();</span>
<a href="#l71.281"></a><span id="l71.281" class="difflineminus">-    char16_t tab = char16_t('\t');</span>
<a href="#l71.282"></a><span id="l71.282" class="difflineminus">-    char16_t doubleQuote = char16_t('&quot;');</span>
<a href="#l71.283"></a><span id="l71.283" class="difflineplus">+bool nsTextAddress::GetField(const nsAString &amp;aLine, int32_t index,</span>
<a href="#l71.284"></a><span id="l71.284" class="difflineplus">+                             nsString &amp;field, char16_t delim) {</span>
<a href="#l71.285"></a><span id="l71.285" class="difflineplus">+  bool result = false;</span>
<a href="#l71.286"></a><span id="l71.286" class="difflineplus">+  int32_t pos = 0;</span>
<a href="#l71.287"></a><span id="l71.287" class="difflineplus">+  int32_t maxLen = aLine.Length();</span>
<a href="#l71.288"></a><span id="l71.288" class="difflineplus">+  char16_t tab = char16_t('\t');</span>
<a href="#l71.289"></a><span id="l71.289" class="difflineplus">+  char16_t doubleQuote = char16_t('&quot;');</span>
<a href="#l71.290"></a><span id="l71.290" class="difflineplus">+</span>
<a href="#l71.291"></a><span id="l71.291" class="difflineplus">+  field.Truncate();</span>
<a href="#l71.292"></a><span id="l71.292" class="difflineplus">+</span>
<a href="#l71.293"></a><span id="l71.293" class="difflineplus">+  if (delim == tab) tab = 0;</span>
<a href="#l71.294"></a><span id="l71.294"> </span>
<a href="#l71.295"></a><span id="l71.295" class="difflineminus">-    field.Truncate();</span>
<a href="#l71.296"></a><span id="l71.296" class="difflineminus">-</span>
<a href="#l71.297"></a><span id="l71.297" class="difflineminus">-    if (delim == tab)</span>
<a href="#l71.298"></a><span id="l71.298" class="difflineminus">-        tab = 0;</span>
<a href="#l71.299"></a><span id="l71.299" class="difflineminus">-</span>
<a href="#l71.300"></a><span id="l71.300" class="difflineminus">-    while (index &amp;&amp; (pos &lt; maxLen)) {</span>
<a href="#l71.301"></a><span id="l71.301" class="difflineminus">-        while (((aLine[pos] == char16_t(' ')) || (aLine[pos] == tab)) &amp;&amp;</span>
<a href="#l71.302"></a><span id="l71.302" class="difflineminus">-               (pos &lt; maxLen)) {</span>
<a href="#l71.303"></a><span id="l71.303" class="difflineminus">-            pos++;</span>
<a href="#l71.304"></a><span id="l71.304" class="difflineplus">+  while (index &amp;&amp; (pos &lt; maxLen)) {</span>
<a href="#l71.305"></a><span id="l71.305" class="difflineplus">+    while (((aLine[pos] == char16_t(' ')) || (aLine[pos] == tab)) &amp;&amp;</span>
<a href="#l71.306"></a><span id="l71.306" class="difflineplus">+           (pos &lt; maxLen)) {</span>
<a href="#l71.307"></a><span id="l71.307" class="difflineplus">+      pos++;</span>
<a href="#l71.308"></a><span id="l71.308" class="difflineplus">+    }</span>
<a href="#l71.309"></a><span id="l71.309" class="difflineplus">+    if (pos &gt;= maxLen) break;</span>
<a href="#l71.310"></a><span id="l71.310" class="difflineplus">+    if (aLine[pos] == doubleQuote) {</span>
<a href="#l71.311"></a><span id="l71.311" class="difflineplus">+      do {</span>
<a href="#l71.312"></a><span id="l71.312" class="difflineplus">+        pos++;</span>
<a href="#l71.313"></a><span id="l71.313" class="difflineplus">+        if (((pos + 1) &lt; maxLen) &amp;&amp; (aLine[pos] == doubleQuote) &amp;&amp;</span>
<a href="#l71.314"></a><span id="l71.314" class="difflineplus">+            (aLine[pos + 1] == doubleQuote)) {</span>
<a href="#l71.315"></a><span id="l71.315" class="difflineplus">+          pos += 2;</span>
<a href="#l71.316"></a><span id="l71.316">         }</span>
<a href="#l71.317"></a><span id="l71.317" class="difflineminus">-        if (pos &gt;= maxLen)</span>
<a href="#l71.318"></a><span id="l71.318" class="difflineminus">-            break;</span>
<a href="#l71.319"></a><span id="l71.319" class="difflineminus">-        if (aLine[pos] == doubleQuote) {</span>
<a href="#l71.320"></a><span id="l71.320" class="difflineminus">-            do {</span>
<a href="#l71.321"></a><span id="l71.321" class="difflineminus">-                pos++;</span>
<a href="#l71.322"></a><span id="l71.322" class="difflineminus">-                if (((pos + 1) &lt; maxLen) &amp;&amp;</span>
<a href="#l71.323"></a><span id="l71.323" class="difflineminus">-                    (aLine[pos] == doubleQuote) &amp;&amp;</span>
<a href="#l71.324"></a><span id="l71.324" class="difflineminus">-                    (aLine[pos + 1] == doubleQuote)) {</span>
<a href="#l71.325"></a><span id="l71.325" class="difflineminus">-                    pos += 2;</span>
<a href="#l71.326"></a><span id="l71.326" class="difflineminus">-                }</span>
<a href="#l71.327"></a><span id="l71.327" class="difflineminus">-            } while ((pos &lt; maxLen) &amp;&amp; (aLine[pos] != doubleQuote));</span>
<a href="#l71.328"></a><span id="l71.328" class="difflineminus">-            if (pos &lt; maxLen)</span>
<a href="#l71.329"></a><span id="l71.329" class="difflineminus">-                pos++;</span>
<a href="#l71.330"></a><span id="l71.330" class="difflineminus">-        }</span>
<a href="#l71.331"></a><span id="l71.331" class="difflineminus">-        if (pos &gt;= maxLen)</span>
<a href="#l71.332"></a><span id="l71.332" class="difflineminus">-            break;</span>
<a href="#l71.333"></a><span id="l71.333" class="difflineplus">+      } while ((pos &lt; maxLen) &amp;&amp; (aLine[pos] != doubleQuote));</span>
<a href="#l71.334"></a><span id="l71.334" class="difflineplus">+      if (pos &lt; maxLen) pos++;</span>
<a href="#l71.335"></a><span id="l71.335" class="difflineplus">+    }</span>
<a href="#l71.336"></a><span id="l71.336" class="difflineplus">+    if (pos &gt;= maxLen) break;</span>
<a href="#l71.337"></a><span id="l71.337" class="difflineplus">+</span>
<a href="#l71.338"></a><span id="l71.338" class="difflineplus">+    while ((pos &lt; maxLen) &amp;&amp; (aLine[pos] != delim)) pos++;</span>
<a href="#l71.339"></a><span id="l71.339"> </span>
<a href="#l71.340"></a><span id="l71.340" class="difflineminus">-        while ((pos &lt; maxLen) &amp;&amp; (aLine[pos] != delim))</span>
<a href="#l71.341"></a><span id="l71.341" class="difflineminus">-            pos++;</span>
<a href="#l71.342"></a><span id="l71.342" class="difflineplus">+    if (pos &gt;= maxLen) break;</span>
<a href="#l71.343"></a><span id="l71.343"> </span>
<a href="#l71.344"></a><span id="l71.344" class="difflineminus">-        if (pos &gt;= maxLen)</span>
<a href="#l71.345"></a><span id="l71.345" class="difflineminus">-            break;</span>
<a href="#l71.346"></a><span id="l71.346" class="difflineplus">+    index--;</span>
<a href="#l71.347"></a><span id="l71.347" class="difflineplus">+    pos++;</span>
<a href="#l71.348"></a><span id="l71.348" class="difflineplus">+  }</span>
<a href="#l71.349"></a><span id="l71.349"> </span>
<a href="#l71.350"></a><span id="l71.350" class="difflineminus">-        index--;</span>
<a href="#l71.351"></a><span id="l71.351" class="difflineminus">-        pos++;</span>
<a href="#l71.352"></a><span id="l71.352" class="difflineminus">-    }</span>
<a href="#l71.353"></a><span id="l71.353" class="difflineplus">+  if (pos &gt;= maxLen) return result;</span>
<a href="#l71.354"></a><span id="l71.354" class="difflineplus">+</span>
<a href="#l71.355"></a><span id="l71.355" class="difflineplus">+  result = true;</span>
<a href="#l71.356"></a><span id="l71.356"> </span>
<a href="#l71.357"></a><span id="l71.357" class="difflineminus">-    if (pos &gt;= maxLen)</span>
<a href="#l71.358"></a><span id="l71.358" class="difflineminus">-        return result;</span>
<a href="#l71.359"></a><span id="l71.359" class="difflineminus">-</span>
<a href="#l71.360"></a><span id="l71.360" class="difflineminus">-    result = true;</span>
<a href="#l71.361"></a><span id="l71.361" class="difflineminus">-</span>
<a href="#l71.362"></a><span id="l71.362" class="difflineminus">-    while ((pos &lt; maxLen) &amp;&amp; ((aLine[pos] == ' ') || (aLine[pos] == tab)))</span>
<a href="#l71.363"></a><span id="l71.363" class="difflineminus">-        pos++;</span>
<a href="#l71.364"></a><span id="l71.364" class="difflineplus">+  while ((pos &lt; maxLen) &amp;&amp; ((aLine[pos] == ' ') || (aLine[pos] == tab))) pos++;</span>
<a href="#l71.365"></a><span id="l71.365"> </span>
<a href="#l71.366"></a><span id="l71.366" class="difflineminus">-    int32_t fLen = 0;</span>
<a href="#l71.367"></a><span id="l71.367" class="difflineminus">-    int32_t startPos = pos;</span>
<a href="#l71.368"></a><span id="l71.368" class="difflineminus">-    bool    quoted = false;</span>
<a href="#l71.369"></a><span id="l71.369" class="difflineminus">-    if (aLine[pos] == '&quot;') {</span>
<a href="#l71.370"></a><span id="l71.370" class="difflineminus">-        startPos++;</span>
<a href="#l71.371"></a><span id="l71.371" class="difflineminus">-        fLen = -1;</span>
<a href="#l71.372"></a><span id="l71.372" class="difflineminus">-        do {</span>
<a href="#l71.373"></a><span id="l71.373" class="difflineminus">-            pos++;</span>
<a href="#l71.374"></a><span id="l71.374" class="difflineminus">-            fLen++;</span>
<a href="#l71.375"></a><span id="l71.375" class="difflineminus">-            if (((pos + 1) &lt; maxLen) &amp;&amp;</span>
<a href="#l71.376"></a><span id="l71.376" class="difflineminus">-                (aLine[pos] == doubleQuote) &amp;&amp;</span>
<a href="#l71.377"></a><span id="l71.377" class="difflineminus">-                (aLine[pos + 1] == doubleQuote)) {</span>
<a href="#l71.378"></a><span id="l71.378" class="difflineminus">-                quoted = true;</span>
<a href="#l71.379"></a><span id="l71.379" class="difflineminus">-                pos += 2;</span>
<a href="#l71.380"></a><span id="l71.380" class="difflineminus">-                fLen += 2;</span>
<a href="#l71.381"></a><span id="l71.381" class="difflineminus">-            }</span>
<a href="#l71.382"></a><span id="l71.382" class="difflineminus">-        } while ((pos &lt; maxLen) &amp;&amp; (aLine[pos] != doubleQuote));</span>
<a href="#l71.383"></a><span id="l71.383" class="difflineplus">+  int32_t fLen = 0;</span>
<a href="#l71.384"></a><span id="l71.384" class="difflineplus">+  int32_t startPos = pos;</span>
<a href="#l71.385"></a><span id="l71.385" class="difflineplus">+  bool quoted = false;</span>
<a href="#l71.386"></a><span id="l71.386" class="difflineplus">+  if (aLine[pos] == '&quot;') {</span>
<a href="#l71.387"></a><span id="l71.387" class="difflineplus">+    startPos++;</span>
<a href="#l71.388"></a><span id="l71.388" class="difflineplus">+    fLen = -1;</span>
<a href="#l71.389"></a><span id="l71.389" class="difflineplus">+    do {</span>
<a href="#l71.390"></a><span id="l71.390" class="difflineplus">+      pos++;</span>
<a href="#l71.391"></a><span id="l71.391" class="difflineplus">+      fLen++;</span>
<a href="#l71.392"></a><span id="l71.392" class="difflineplus">+      if (((pos + 1) &lt; maxLen) &amp;&amp; (aLine[pos] == doubleQuote) &amp;&amp;</span>
<a href="#l71.393"></a><span id="l71.393" class="difflineplus">+          (aLine[pos + 1] == doubleQuote)) {</span>
<a href="#l71.394"></a><span id="l71.394" class="difflineplus">+        quoted = true;</span>
<a href="#l71.395"></a><span id="l71.395" class="difflineplus">+        pos += 2;</span>
<a href="#l71.396"></a><span id="l71.396" class="difflineplus">+        fLen += 2;</span>
<a href="#l71.397"></a><span id="l71.397" class="difflineplus">+      }</span>
<a href="#l71.398"></a><span id="l71.398" class="difflineplus">+    } while ((pos &lt; maxLen) &amp;&amp; (aLine[pos] != doubleQuote));</span>
<a href="#l71.399"></a><span id="l71.399" class="difflineplus">+  } else {</span>
<a href="#l71.400"></a><span id="l71.400" class="difflineplus">+    while ((pos &lt; maxLen) &amp;&amp; (aLine[pos] != delim)) {</span>
<a href="#l71.401"></a><span id="l71.401" class="difflineplus">+      pos++;</span>
<a href="#l71.402"></a><span id="l71.402" class="difflineplus">+      fLen++;</span>
<a href="#l71.403"></a><span id="l71.403">     }</span>
<a href="#l71.404"></a><span id="l71.404" class="difflineminus">-    else {</span>
<a href="#l71.405"></a><span id="l71.405" class="difflineminus">-        while ((pos &lt; maxLen) &amp;&amp; (aLine[pos] != delim)) {</span>
<a href="#l71.406"></a><span id="l71.406" class="difflineminus">-            pos++;</span>
<a href="#l71.407"></a><span id="l71.407" class="difflineminus">-            fLen++;</span>
<a href="#l71.408"></a><span id="l71.408" class="difflineminus">-        }</span>
<a href="#l71.409"></a><span id="l71.409" class="difflineminus">-    }</span>
<a href="#l71.410"></a><span id="l71.410" class="difflineplus">+  }</span>
<a href="#l71.411"></a><span id="l71.411"> </span>
<a href="#l71.412"></a><span id="l71.412" class="difflineminus">-    if (!fLen) {</span>
<a href="#l71.413"></a><span id="l71.413" class="difflineminus">-        return result;</span>
<a href="#l71.414"></a><span id="l71.414" class="difflineminus">-    }</span>
<a href="#l71.415"></a><span id="l71.415" class="difflineplus">+  if (!fLen) {</span>
<a href="#l71.416"></a><span id="l71.416" class="difflineplus">+    return result;</span>
<a href="#l71.417"></a><span id="l71.417" class="difflineplus">+  }</span>
<a href="#l71.418"></a><span id="l71.418" class="difflineplus">+</span>
<a href="#l71.419"></a><span id="l71.419" class="difflineplus">+  field.Append(nsDependentSubstring(aLine, startPos, fLen));</span>
<a href="#l71.420"></a><span id="l71.420" class="difflineplus">+  field.Trim(kWhitespace);</span>
<a href="#l71.421"></a><span id="l71.421"> </span>
<a href="#l71.422"></a><span id="l71.422" class="difflineminus">-    field.Append(nsDependentSubstring(aLine, startPos, fLen));</span>
<a href="#l71.423"></a><span id="l71.423" class="difflineminus">-    field.Trim(kWhitespace);</span>
<a href="#l71.424"></a><span id="l71.424" class="difflineplus">+  if (quoted) {</span>
<a href="#l71.425"></a><span id="l71.425" class="difflineplus">+    int32_t offset = field.Find(&quot;\&quot;\&quot;&quot;);</span>
<a href="#l71.426"></a><span id="l71.426" class="difflineplus">+    while (offset != -1) {</span>
<a href="#l71.427"></a><span id="l71.427" class="difflineplus">+      field.Cut(offset, 1);</span>
<a href="#l71.428"></a><span id="l71.428" class="difflineplus">+      offset = MsgFind(field, &quot;\&quot;\&quot;&quot;, false, offset + 1);</span>
<a href="#l71.429"></a><span id="l71.429" class="difflineplus">+    }</span>
<a href="#l71.430"></a><span id="l71.430" class="difflineplus">+  }</span>
<a href="#l71.431"></a><span id="l71.431"> </span>
<a href="#l71.432"></a><span id="l71.432" class="difflineminus">-    if (quoted) {</span>
<a href="#l71.433"></a><span id="l71.433" class="difflineminus">-      int32_t offset = field.Find(&quot;\&quot;\&quot;&quot;);</span>
<a href="#l71.434"></a><span id="l71.434" class="difflineminus">-      while (offset != -1) {</span>
<a href="#l71.435"></a><span id="l71.435" class="difflineminus">-        field.Cut(offset, 1);</span>
<a href="#l71.436"></a><span id="l71.436" class="difflineminus">-        offset = MsgFind(field, &quot;\&quot;\&quot;&quot;, false, offset + 1);</span>
<a href="#l71.437"></a><span id="l71.437" class="difflineminus">-      }</span>
<a href="#l71.438"></a><span id="l71.438" class="difflineminus">-    }</span>
<a href="#l71.439"></a><span id="l71.439" class="difflineminus">-</span>
<a href="#l71.440"></a><span id="l71.440" class="difflineminus">-    return result;</span>
<a href="#l71.441"></a><span id="l71.441" class="difflineplus">+  return result;</span>
<a href="#l71.442"></a><span id="l71.442"> }</span>
<a href="#l71.443"></a><span id="l71.443"> </span>
<a href="#l71.444"></a><span id="l71.444" class="difflineminus">-nsresult nsTextAddress::DetermineDelim(nsIFile *aSrc)</span>
<a href="#l71.445"></a><span id="l71.445" class="difflineminus">-{</span>
<a href="#l71.446"></a><span id="l71.446" class="difflineplus">+nsresult nsTextAddress::DetermineDelim(nsIFile *aSrc) {</span>
<a href="#l71.447"></a><span id="l71.447">   nsCOMPtr&lt;nsIInputStream&gt; inputStream;</span>
<a href="#l71.448"></a><span id="l71.448">   nsresult rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream), aSrc);</span>
<a href="#l71.449"></a><span id="l71.449">   if (NS_FAILED(rv)) {</span>
<a href="#l71.450"></a><span id="l71.450">     IMPORT_LOG0(&quot;*** Error opening address file for reading\n&quot;);</span>
<a href="#l71.451"></a><span id="l71.451">     return rv;</span>
<a href="#l71.452"></a><span id="l71.452">   }</span>
<a href="#l71.453"></a><span id="l71.453"> </span>
<a href="#l71.454"></a><span id="l71.454">   int32_t lineCount = 0;</span>
<a href="#l71.455"></a><span id="l71.455">   int32_t tabCount = 0;</span>
<a href="#l71.456"></a><span id="l71.456">   int32_t commaCount = 0;</span>
<a href="#l71.457"></a><span id="l71.457">   int32_t tabLines = 0;</span>
<a href="#l71.458"></a><span id="l71.458">   int32_t commaLines = 0;</span>
<a href="#l71.459"></a><span id="l71.459">   nsAutoString line;</span>
<a href="#l71.460"></a><span id="l71.460">   bool more = true;</span>
<a href="#l71.461"></a><span id="l71.461"> </span>
<a href="#l71.462"></a><span id="l71.462">   nsCOMPtr&lt;nsIUnicharLineInputStream&gt; lineStream;</span>
<a href="#l71.463"></a><span id="l71.463" class="difflineminus">-  rv = GetUnicharLineStreamForFile(aSrc, inputStream, getter_AddRefs(lineStream));</span>
<a href="#l71.464"></a><span id="l71.464" class="difflineplus">+  rv = GetUnicharLineStreamForFile(aSrc, inputStream,</span>
<a href="#l71.465"></a><span id="l71.465" class="difflineplus">+                                   getter_AddRefs(lineStream));</span>
<a href="#l71.466"></a><span id="l71.466">   if (NS_FAILED(rv)) {</span>
<a href="#l71.467"></a><span id="l71.467">     IMPORT_LOG0(&quot;*** Error opening converter stream for importer\n&quot;);</span>
<a href="#l71.468"></a><span id="l71.468">     return rv;</span>
<a href="#l71.469"></a><span id="l71.469">   }</span>
<a href="#l71.470"></a><span id="l71.470"> </span>
<a href="#l71.471"></a><span id="l71.471">   while (more &amp;&amp; NS_SUCCEEDED(rv) &amp;&amp; (lineCount &lt; 100)) {</span>
<a href="#l71.472"></a><span id="l71.472">     rv = lineStream-&gt;ReadLine(line, &amp;more);</span>
<a href="#l71.473"></a><span id="l71.473">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l71.474"></a><span id="l71.474" class="difflineat">@@ -389,67 +366,62 @@ nsresult nsTextAddress::DetermineDelim(n</span>
<a href="#l71.475"></a><span id="l71.475"> </span>
<a href="#l71.476"></a><span id="l71.476">   rv = inputStream-&gt;Close();</span>
<a href="#l71.477"></a><span id="l71.477"> </span>
<a href="#l71.478"></a><span id="l71.478">   if (tabLines &gt; commaLines)</span>
<a href="#l71.479"></a><span id="l71.479">     m_delim = char16_t('\t');</span>
<a href="#l71.480"></a><span id="l71.480">   else</span>
<a href="#l71.481"></a><span id="l71.481">     m_delim = char16_t(',');</span>
<a href="#l71.482"></a><span id="l71.482"> </span>
<a href="#l71.483"></a><span id="l71.483" class="difflineminus">-  IMPORT_LOG2( &quot;Tab count = %d, Comma count = %d\n&quot;, tabLines, commaLines);</span>
<a href="#l71.484"></a><span id="l71.484" class="difflineplus">+  IMPORT_LOG2(&quot;Tab count = %d, Comma count = %d\n&quot;, tabLines, commaLines);</span>
<a href="#l71.485"></a><span id="l71.485"> </span>
<a href="#l71.486"></a><span id="l71.486">   return rv;</span>
<a href="#l71.487"></a><span id="l71.487"> }</span>
<a href="#l71.488"></a><span id="l71.488"> </span>
<a href="#l71.489"></a><span id="l71.489"> /*</span>
<a href="#l71.490"></a><span id="l71.490">     This is where the real work happens!</span>
<a href="#l71.491"></a><span id="l71.491">     Go through the field map and set the data in a new database row</span>
<a href="#l71.492"></a><span id="l71.492"> */</span>
<a href="#l71.493"></a><span id="l71.493" class="difflineminus">-nsresult nsTextAddress::ProcessLine(const nsAString &amp;aLine, nsString&amp; errors)</span>
<a href="#l71.494"></a><span id="l71.494" class="difflineminus">-{</span>
<a href="#l71.495"></a><span id="l71.495" class="difflineminus">-    if (!m_fieldMap) {</span>
<a href="#l71.496"></a><span id="l71.496" class="difflineminus">-        IMPORT_LOG0(&quot;*** Error, text import needs a field map\n&quot;);</span>
<a href="#l71.497"></a><span id="l71.497" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l71.498"></a><span id="l71.498" class="difflineminus">-    }</span>
<a href="#l71.499"></a><span id="l71.499" class="difflineplus">+nsresult nsTextAddress::ProcessLine(const nsAString &amp;aLine, nsString &amp;errors) {</span>
<a href="#l71.500"></a><span id="l71.500" class="difflineplus">+  if (!m_fieldMap) {</span>
<a href="#l71.501"></a><span id="l71.501" class="difflineplus">+    IMPORT_LOG0(&quot;*** Error, text import needs a field map\n&quot;);</span>
<a href="#l71.502"></a><span id="l71.502" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l71.503"></a><span id="l71.503" class="difflineplus">+  }</span>
<a href="#l71.504"></a><span id="l71.504"> </span>
<a href="#l71.505"></a><span id="l71.505" class="difflineminus">-    nsresult rv;</span>
<a href="#l71.506"></a><span id="l71.506" class="difflineplus">+  nsresult rv;</span>
<a href="#l71.507"></a><span id="l71.507"> </span>
<a href="#l71.508"></a><span id="l71.508" class="difflineminus">-    // Wait until we get our first non-empty field, then create a new row,</span>
<a href="#l71.509"></a><span id="l71.509" class="difflineminus">-    // fill in the data, then add the row to the database.</span>
<a href="#l71.510"></a><span id="l71.510" class="difflineminus">-    nsCOMPtr&lt;nsIMdbRow&gt; newRow;</span>
<a href="#l71.511"></a><span id="l71.511" class="difflineminus">-    nsAutoString   fieldVal;</span>
<a href="#l71.512"></a><span id="l71.512" class="difflineminus">-    int32_t        fieldNum;</span>
<a href="#l71.513"></a><span id="l71.513" class="difflineminus">-    int32_t        numFields = 0;</span>
<a href="#l71.514"></a><span id="l71.514" class="difflineminus">-    bool           active;</span>
<a href="#l71.515"></a><span id="l71.515" class="difflineminus">-    rv = m_fieldMap-&gt;GetMapSize(&amp;numFields);</span>
<a href="#l71.516"></a><span id="l71.516" class="difflineminus">-    for (int32_t i = 0; (i &lt; numFields) &amp;&amp; NS_SUCCEEDED(rv); i++) {</span>
<a href="#l71.517"></a><span id="l71.517" class="difflineminus">-        active = false;</span>
<a href="#l71.518"></a><span id="l71.518" class="difflineminus">-        rv = m_fieldMap-&gt;GetFieldMap(i, &amp;fieldNum);</span>
<a href="#l71.519"></a><span id="l71.519" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l71.520"></a><span id="l71.520" class="difflineminus">-            rv = m_fieldMap-&gt;GetFieldActive(i, &amp;active);</span>
<a href="#l71.521"></a><span id="l71.521" class="difflineminus">-        if (NS_SUCCEEDED(rv) &amp;&amp; active) {</span>
<a href="#l71.522"></a><span id="l71.522" class="difflineminus">-            if (GetField(aLine, i, fieldVal, m_delim)) {</span>
<a href="#l71.523"></a><span id="l71.523" class="difflineminus">-                if (!fieldVal.IsEmpty()) {</span>
<a href="#l71.524"></a><span id="l71.524" class="difflineminus">-                    if (!newRow) {</span>
<a href="#l71.525"></a><span id="l71.525" class="difflineminus">-                        rv = m_database-&gt;GetNewRow(getter_AddRefs(newRow));</span>
<a href="#l71.526"></a><span id="l71.526" class="difflineminus">-                        if (NS_FAILED(rv)) {</span>
<a href="#l71.527"></a><span id="l71.527" class="difflineminus">-                            IMPORT_LOG0(&quot;*** Error getting new address database row\n&quot;);</span>
<a href="#l71.528"></a><span id="l71.528" class="difflineminus">-                        }</span>
<a href="#l71.529"></a><span id="l71.529" class="difflineminus">-                    }</span>
<a href="#l71.530"></a><span id="l71.530" class="difflineminus">-                    if (newRow) {</span>
<a href="#l71.531"></a><span id="l71.531" class="difflineminus">-                        rv = m_fieldMap-&gt;SetFieldValue(m_database, newRow, fieldNum, fieldVal.get());</span>
<a href="#l71.532"></a><span id="l71.532" class="difflineminus">-                    }</span>
<a href="#l71.533"></a><span id="l71.533" class="difflineminus">-                }</span>
<a href="#l71.534"></a><span id="l71.534" class="difflineplus">+  // Wait until we get our first non-empty field, then create a new row,</span>
<a href="#l71.535"></a><span id="l71.535" class="difflineplus">+  // fill in the data, then add the row to the database.</span>
<a href="#l71.536"></a><span id="l71.536" class="difflineplus">+  nsCOMPtr&lt;nsIMdbRow&gt; newRow;</span>
<a href="#l71.537"></a><span id="l71.537" class="difflineplus">+  nsAutoString fieldVal;</span>
<a href="#l71.538"></a><span id="l71.538" class="difflineplus">+  int32_t fieldNum;</span>
<a href="#l71.539"></a><span id="l71.539" class="difflineplus">+  int32_t numFields = 0;</span>
<a href="#l71.540"></a><span id="l71.540" class="difflineplus">+  bool active;</span>
<a href="#l71.541"></a><span id="l71.541" class="difflineplus">+  rv = m_fieldMap-&gt;GetMapSize(&amp;numFields);</span>
<a href="#l71.542"></a><span id="l71.542" class="difflineplus">+  for (int32_t i = 0; (i &lt; numFields) &amp;&amp; NS_SUCCEEDED(rv); i++) {</span>
<a href="#l71.543"></a><span id="l71.543" class="difflineplus">+    active = false;</span>
<a href="#l71.544"></a><span id="l71.544" class="difflineplus">+    rv = m_fieldMap-&gt;GetFieldMap(i, &amp;fieldNum);</span>
<a href="#l71.545"></a><span id="l71.545" class="difflineplus">+    if (NS_SUCCEEDED(rv)) rv = m_fieldMap-&gt;GetFieldActive(i, &amp;active);</span>
<a href="#l71.546"></a><span id="l71.546" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; active) {</span>
<a href="#l71.547"></a><span id="l71.547" class="difflineplus">+      if (GetField(aLine, i, fieldVal, m_delim)) {</span>
<a href="#l71.548"></a><span id="l71.548" class="difflineplus">+        if (!fieldVal.IsEmpty()) {</span>
<a href="#l71.549"></a><span id="l71.549" class="difflineplus">+          if (!newRow) {</span>
<a href="#l71.550"></a><span id="l71.550" class="difflineplus">+            rv = m_database-&gt;GetNewRow(getter_AddRefs(newRow));</span>
<a href="#l71.551"></a><span id="l71.551" class="difflineplus">+            if (NS_FAILED(rv)) {</span>
<a href="#l71.552"></a><span id="l71.552" class="difflineplus">+              IMPORT_LOG0(&quot;*** Error getting new address database row\n&quot;);</span>
<a href="#l71.553"></a><span id="l71.553">             }</span>
<a href="#l71.554"></a><span id="l71.554" class="difflineminus">-            else</span>
<a href="#l71.555"></a><span id="l71.555" class="difflineminus">-                break;</span>
<a href="#l71.556"></a><span id="l71.556" class="difflineplus">+          }</span>
<a href="#l71.557"></a><span id="l71.557" class="difflineplus">+          if (newRow) {</span>
<a href="#l71.558"></a><span id="l71.558" class="difflineplus">+            rv = m_fieldMap-&gt;SetFieldValue(m_database, newRow, fieldNum,</span>
<a href="#l71.559"></a><span id="l71.559" class="difflineplus">+                                           fieldVal.get());</span>
<a href="#l71.560"></a><span id="l71.560" class="difflineplus">+          }</span>
<a href="#l71.561"></a><span id="l71.561">         }</span>
<a href="#l71.562"></a><span id="l71.562" class="difflineminus">-        else if (active) {</span>
<a href="#l71.563"></a><span id="l71.563" class="difflineminus">-          IMPORT_LOG1(&quot;*** Error getting field map for index %ld\n&quot;, (long) i);</span>
<a href="#l71.564"></a><span id="l71.564" class="difflineminus">-        }</span>
<a href="#l71.565"></a><span id="l71.565" class="difflineplus">+      } else</span>
<a href="#l71.566"></a><span id="l71.566" class="difflineplus">+        break;</span>
<a href="#l71.567"></a><span id="l71.567" class="difflineplus">+    } else if (active) {</span>
<a href="#l71.568"></a><span id="l71.568" class="difflineplus">+      IMPORT_LOG1(&quot;*** Error getting field map for index %ld\n&quot;, (long)i);</span>
<a href="#l71.569"></a><span id="l71.569">     }</span>
<a href="#l71.570"></a><span id="l71.570" class="difflineminus">-</span>
<a href="#l71.571"></a><span id="l71.571" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; newRow)</span>
<a href="#l71.572"></a><span id="l71.572" class="difflineminus">-      rv = m_database-&gt;AddCardRowToDB(newRow);</span>
<a href="#l71.573"></a><span id="l71.573" class="difflineplus">+  }</span>
<a href="#l71.574"></a><span id="l71.574"> </span>
<a href="#l71.575"></a><span id="l71.575" class="difflineminus">-    return rv;</span>
<a href="#l71.576"></a><span id="l71.576" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; newRow) rv = m_database-&gt;AddCardRowToDB(newRow);</span>
<a href="#l71.577"></a><span id="l71.577" class="difflineplus">+</span>
<a href="#l71.578"></a><span id="l71.578" class="difflineplus">+  return rv;</span>
<a href="#l71.579"></a><span id="l71.579"> }</span>
<a href="#l71.580"></a><span id="l71.580" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l72.1"></a><span id="l72.1" class="difflineminus">--- a/mailnews/import/text/src/nsTextAddress.h</span>
<a href="#l72.2"></a><span id="l72.2" class="difflineplus">+++ b/mailnews/import/text/src/nsTextAddress.h</span>
<a href="#l72.3"></a><span id="l72.3" class="difflineat">@@ -17,41 +17,43 @@ class nsIFile;</span>
<a href="#l72.4"></a><span id="l72.4"> class nsIInputStream;</span>
<a href="#l72.5"></a><span id="l72.5"> class nsIUnicharLineInputStream;</span>
<a href="#l72.6"></a><span id="l72.6"> </span>
<a href="#l72.7"></a><span id="l72.7"> /////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l72.8"></a><span id="l72.8"> /////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l72.9"></a><span id="l72.9"> /////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l72.10"></a><span id="l72.10"> </span>
<a href="#l72.11"></a><span id="l72.11"> class nsTextAddress {</span>
<a href="#l72.12"></a><span id="l72.12" class="difflineminus">-public:</span>
<a href="#l72.13"></a><span id="l72.13" class="difflineplus">+ public:</span>
<a href="#l72.14"></a><span id="l72.14">   nsTextAddress();</span>
<a href="#l72.15"></a><span id="l72.15">   virtual ~nsTextAddress();</span>
<a href="#l72.16"></a><span id="l72.16"> </span>
<a href="#l72.17"></a><span id="l72.17" class="difflineminus">-  nsresult ImportAddresses(bool *pAbort, const char16_t *pName, nsIFile *pSrc, nsIAddrDatabase *pDb, nsIImportFieldMap *fieldMap, nsString&amp; errors, uint32_t *pProgress);</span>
<a href="#l72.18"></a><span id="l72.18" class="difflineplus">+  nsresult ImportAddresses(bool *pAbort, const char16_t *pName, nsIFile *pSrc,</span>
<a href="#l72.19"></a><span id="l72.19" class="difflineplus">+                           nsIAddrDatabase *pDb, nsIImportFieldMap *fieldMap,</span>
<a href="#l72.20"></a><span id="l72.20" class="difflineplus">+                           nsString &amp;errors, uint32_t *pProgress);</span>
<a href="#l72.21"></a><span id="l72.21"> </span>
<a href="#l72.22"></a><span id="l72.22">   nsresult DetermineDelim(nsIFile *pSrc);</span>
<a href="#l72.23"></a><span id="l72.23">   char16_t GetDelim(void) { return m_delim; }</span>
<a href="#l72.24"></a><span id="l72.24"> </span>
<a href="#l72.25"></a><span id="l72.25" class="difflineminus">-  static nsresult ReadRecordNumber(nsIFile *pSrc, nsAString &amp;aLine, int32_t rNum);</span>
<a href="#l72.26"></a><span id="l72.26" class="difflineminus">-  static bool GetField(const nsAString &amp;aLine, int32_t index, nsString &amp;field, char16_t delim);</span>
<a href="#l72.27"></a><span id="l72.27" class="difflineplus">+  static nsresult ReadRecordNumber(nsIFile *pSrc, nsAString &amp;aLine,</span>
<a href="#l72.28"></a><span id="l72.28" class="difflineplus">+                                   int32_t rNum);</span>
<a href="#l72.29"></a><span id="l72.29" class="difflineplus">+  static bool GetField(const nsAString &amp;aLine, int32_t index, nsString &amp;field,</span>
<a href="#l72.30"></a><span id="l72.30" class="difflineplus">+                       char16_t delim);</span>
<a href="#l72.31"></a><span id="l72.31"> </span>
<a href="#l72.32"></a><span id="l72.32" class="difflineminus">-private:</span>
<a href="#l72.33"></a><span id="l72.33" class="difflineplus">+ private:</span>
<a href="#l72.34"></a><span id="l72.34">   nsresult ProcessLine(const nsAString &amp;aLine, nsString &amp;errors);</span>
<a href="#l72.35"></a><span id="l72.35"> </span>
<a href="#l72.36"></a><span id="l72.36">   static int32_t CountFields(const nsAString &amp;aLine, char16_t delim);</span>
<a href="#l72.37"></a><span id="l72.37" class="difflineminus">-  static nsresult ReadRecord(nsIUnicharLineInputStream *pSrc, nsAString &amp;aLine, bool *aMore);</span>
<a href="#l72.38"></a><span id="l72.38" class="difflineminus">-  static nsresult GetUnicharLineStreamForFile(nsIFile *aFile,</span>
<a href="#l72.39"></a><span id="l72.39" class="difflineminus">-                                              nsIInputStream *aInputStream,</span>
<a href="#l72.40"></a><span id="l72.40" class="difflineminus">-                                              nsIUnicharLineInputStream **aStream);</span>
<a href="#l72.41"></a><span id="l72.41" class="difflineplus">+  static nsresult ReadRecord(nsIUnicharLineInputStream *pSrc, nsAString &amp;aLine,</span>
<a href="#l72.42"></a><span id="l72.42" class="difflineplus">+                             bool *aMore);</span>
<a href="#l72.43"></a><span id="l72.43" class="difflineplus">+  static nsresult GetUnicharLineStreamForFile(</span>
<a href="#l72.44"></a><span id="l72.44" class="difflineplus">+      nsIFile *aFile, nsIInputStream *aInputStream,</span>
<a href="#l72.45"></a><span id="l72.45" class="difflineplus">+      nsIUnicharLineInputStream **aStream);</span>
<a href="#l72.46"></a><span id="l72.46"> </span>
<a href="#l72.47"></a><span id="l72.47">   char16_t m_delim;</span>
<a href="#l72.48"></a><span id="l72.48">   int32_t m_LFCount;</span>
<a href="#l72.49"></a><span id="l72.49">   int32_t m_CRCount;</span>
<a href="#l72.50"></a><span id="l72.50" class="difflineminus">-  nsCOMPtr&lt;nsIAddrDatabase&gt;   m_database;</span>
<a href="#l72.51"></a><span id="l72.51" class="difflineplus">+  nsCOMPtr&lt;nsIAddrDatabase&gt; m_database;</span>
<a href="#l72.52"></a><span id="l72.52">   nsCOMPtr&lt;nsIImportFieldMap&gt; m_fieldMap;</span>
<a href="#l72.53"></a><span id="l72.53" class="difflineminus">-  nsCOMPtr&lt;nsIImportService&gt;  m_pService;</span>
<a href="#l72.54"></a><span id="l72.54" class="difflineplus">+  nsCOMPtr&lt;nsIImportService&gt; m_pService;</span>
<a href="#l72.55"></a><span id="l72.55"> };</span>
<a href="#l72.56"></a><span id="l72.56"> </span>
<a href="#l72.57"></a><span id="l72.57" class="difflineminus">-</span>
<a href="#l72.58"></a><span id="l72.58" class="difflineminus">-</span>
<a href="#l72.59"></a><span id="l72.59"> #endif /* nsTextAddress_h__ */</span>
<a href="#l72.60"></a><span id="l72.60" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l73.1"></a><span id="l73.1" class="difflineminus">--- a/mailnews/import/text/src/nsTextImport.cpp</span>
<a href="#l73.2"></a><span id="l73.2" class="difflineplus">+++ b/mailnews/import/text/src/nsTextImport.cpp</span>
<a href="#l73.3"></a><span id="l73.3" class="difflineat">@@ -26,240 +26,223 @@</span>
<a href="#l73.4"></a><span id="l73.4"> #include &quot;nsTextAddress.h&quot;</span>
<a href="#l73.5"></a><span id="l73.5"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l73.6"></a><span id="l73.6"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l73.7"></a><span id="l73.7"> #include &quot;ImportDebug.h&quot;</span>
<a href="#l73.8"></a><span id="l73.8"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l73.9"></a><span id="l73.9"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l73.10"></a><span id="l73.10"> </span>
<a href="#l73.11"></a><span id="l73.11"> #define TEXT_MSGS_URL &quot;chrome://messenger/locale/textImportMsgs.properties&quot;</span>
<a href="#l73.12"></a><span id="l73.12" class="difflineminus">-#define TEXTIMPORT_NAME                  2000</span>
<a href="#l73.13"></a><span id="l73.13" class="difflineminus">-#define TEXTIMPORT_DESCRIPTION           2001</span>
<a href="#l73.14"></a><span id="l73.14" class="difflineminus">-#define TEXTIMPORT_ADDRESS_NAME          2002</span>
<a href="#l73.15"></a><span id="l73.15" class="difflineminus">-#define TEXTIMPORT_ADDRESS_SUCCESS       2003</span>
<a href="#l73.16"></a><span id="l73.16" class="difflineminus">-#define TEXTIMPORT_ADDRESS_BADPARAM      2004</span>
<a href="#l73.17"></a><span id="l73.17" class="difflineplus">+#define TEXTIMPORT_NAME 2000</span>
<a href="#l73.18"></a><span id="l73.18" class="difflineplus">+#define TEXTIMPORT_DESCRIPTION 2001</span>
<a href="#l73.19"></a><span id="l73.19" class="difflineplus">+#define TEXTIMPORT_ADDRESS_NAME 2002</span>
<a href="#l73.20"></a><span id="l73.20" class="difflineplus">+#define TEXTIMPORT_ADDRESS_SUCCESS 2003</span>
<a href="#l73.21"></a><span id="l73.21" class="difflineplus">+#define TEXTIMPORT_ADDRESS_BADPARAM 2004</span>
<a href="#l73.22"></a><span id="l73.22"> #define TEXTIMPORT_ADDRESS_BADSOURCEFILE 2005</span>
<a href="#l73.23"></a><span id="l73.23" class="difflineminus">-#define TEXTIMPORT_ADDRESS_CONVERTERROR  2006</span>
<a href="#l73.24"></a><span id="l73.24" class="difflineplus">+#define TEXTIMPORT_ADDRESS_CONVERTERROR 2006</span>
<a href="#l73.25"></a><span id="l73.25"> </span>
<a href="#l73.26"></a><span id="l73.26" class="difflineminus">-class ImportAddressImpl final : public nsIImportAddressBooks</span>
<a href="#l73.27"></a><span id="l73.27" class="difflineminus">-{</span>
<a href="#l73.28"></a><span id="l73.28" class="difflineminus">-public:</span>
<a href="#l73.29"></a><span id="l73.29" class="difflineminus">-  explicit ImportAddressImpl(nsIStringBundle* aStringBundle);</span>
<a href="#l73.30"></a><span id="l73.30" class="difflineplus">+class ImportAddressImpl final : public nsIImportAddressBooks {</span>
<a href="#l73.31"></a><span id="l73.31" class="difflineplus">+ public:</span>
<a href="#l73.32"></a><span id="l73.32" class="difflineplus">+  explicit ImportAddressImpl(nsIStringBundle *aStringBundle);</span>
<a href="#l73.33"></a><span id="l73.33"> </span>
<a href="#l73.34"></a><span id="l73.34" class="difflineminus">-  static nsresult Create(nsIImportAddressBooks** aImport,</span>
<a href="#l73.35"></a><span id="l73.35" class="difflineplus">+  static nsresult Create(nsIImportAddressBooks **aImport,</span>
<a href="#l73.36"></a><span id="l73.36">                          nsIStringBundle *aStringBundle);</span>
<a href="#l73.37"></a><span id="l73.37"> </span>
<a href="#l73.38"></a><span id="l73.38" class="difflineminus">-    // nsISupports interface</span>
<a href="#l73.39"></a><span id="l73.39" class="difflineminus">-    NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l73.40"></a><span id="l73.40" class="difflineplus">+  // nsISupports interface</span>
<a href="#l73.41"></a><span id="l73.41" class="difflineplus">+  NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l73.42"></a><span id="l73.42" class="difflineplus">+</span>
<a href="#l73.43"></a><span id="l73.43" class="difflineplus">+  // nsIImportAddressBooks interface</span>
<a href="#l73.44"></a><span id="l73.44"> </span>
<a href="#l73.45"></a><span id="l73.45" class="difflineminus">-    // nsIImportAddressBooks interface</span>
<a href="#l73.46"></a><span id="l73.46" class="difflineminus">-</span>
<a href="#l73.47"></a><span id="l73.47" class="difflineminus">-  NS_IMETHOD GetSupportsMultiple(bool *_retval) override { *_retval = false; return NS_OK;}</span>
<a href="#l73.48"></a><span id="l73.48" class="difflineplus">+  NS_IMETHOD GetSupportsMultiple(bool *_retval) override {</span>
<a href="#l73.49"></a><span id="l73.49" class="difflineplus">+    *_retval = false;</span>
<a href="#l73.50"></a><span id="l73.50" class="difflineplus">+    return NS_OK;</span>
<a href="#l73.51"></a><span id="l73.51" class="difflineplus">+  }</span>
<a href="#l73.52"></a><span id="l73.52"> </span>
<a href="#l73.53"></a><span id="l73.53">   NS_IMETHOD GetAutoFind(char16_t **description, bool *_retval) override;</span>
<a href="#l73.54"></a><span id="l73.54"> </span>
<a href="#l73.55"></a><span id="l73.55">   NS_IMETHOD GetNeedsFieldMap(nsIFile *location, bool *_retval) override;</span>
<a href="#l73.56"></a><span id="l73.56"> </span>
<a href="#l73.57"></a><span id="l73.57" class="difflineminus">-  NS_IMETHOD GetDefaultLocation(nsIFile **location, bool *found, bool *userVerify) override;</span>
<a href="#l73.58"></a><span id="l73.58" class="difflineplus">+  NS_IMETHOD GetDefaultLocation(nsIFile **location, bool *found,</span>
<a href="#l73.59"></a><span id="l73.59" class="difflineplus">+                                bool *userVerify) override;</span>
<a href="#l73.60"></a><span id="l73.60"> </span>
<a href="#l73.61"></a><span id="l73.61">   NS_IMETHOD FindAddressBooks(nsIFile *location, nsIArray **_retval) override;</span>
<a href="#l73.62"></a><span id="l73.62"> </span>
<a href="#l73.63"></a><span id="l73.63">   NS_IMETHOD InitFieldMap(nsIImportFieldMap *fieldMap) override;</span>
<a href="#l73.64"></a><span id="l73.64"> </span>
<a href="#l73.65"></a><span id="l73.65">   NS_IMETHOD ImportAddressBook(nsIImportABDescriptor *source,</span>
<a href="#l73.66"></a><span id="l73.66">                                nsIAddrDatabase *destination,</span>
<a href="#l73.67"></a><span id="l73.67">                                nsIImportFieldMap *fieldMap,</span>
<a href="#l73.68"></a><span id="l73.68">                                nsISupports *aSupportService,</span>
<a href="#l73.69"></a><span id="l73.69" class="difflineminus">-                               char16_t **errorLog,</span>
<a href="#l73.70"></a><span id="l73.70" class="difflineminus">-                               char16_t **successLog,</span>
<a href="#l73.71"></a><span id="l73.71" class="difflineplus">+                               char16_t **errorLog, char16_t **successLog,</span>
<a href="#l73.72"></a><span id="l73.72">                                bool *fatalError) override;</span>
<a href="#l73.73"></a><span id="l73.73"> </span>
<a href="#l73.74"></a><span id="l73.74">   NS_IMETHOD GetImportProgress(uint32_t *_retval) override;</span>
<a href="#l73.75"></a><span id="l73.75"> </span>
<a href="#l73.76"></a><span id="l73.76" class="difflineminus">-  NS_IMETHOD GetSampleData(int32_t index, bool *pFound, char16_t **pStr) override;</span>
<a href="#l73.77"></a><span id="l73.77" class="difflineplus">+  NS_IMETHOD GetSampleData(int32_t index, bool *pFound,</span>
<a href="#l73.78"></a><span id="l73.78" class="difflineplus">+                           char16_t **pStr) override;</span>
<a href="#l73.79"></a><span id="l73.79"> </span>
<a href="#l73.80"></a><span id="l73.80">   NS_IMETHOD SetSampleLocation(nsIFile *) override;</span>
<a href="#l73.81"></a><span id="l73.81"> </span>
<a href="#l73.82"></a><span id="l73.82" class="difflineminus">-private:</span>
<a href="#l73.83"></a><span id="l73.83" class="difflineplus">+ private:</span>
<a href="#l73.84"></a><span id="l73.84">   void ClearSampleFile(void);</span>
<a href="#l73.85"></a><span id="l73.85">   void SaveFieldMap(nsIImportFieldMap *pMap);</span>
<a href="#l73.86"></a><span id="l73.86"> </span>
<a href="#l73.87"></a><span id="l73.87" class="difflineminus">-  static void ReportSuccess(nsString&amp; name, nsString *pStream,</span>
<a href="#l73.88"></a><span id="l73.88" class="difflineminus">-                            nsIStringBundle* pBundle);</span>
<a href="#l73.89"></a><span id="l73.89" class="difflineminus">-  static void SetLogs(nsString&amp; success, nsString&amp; error, char16_t **pError,</span>
<a href="#l73.90"></a><span id="l73.90" class="difflineplus">+  static void ReportSuccess(nsString &amp;name, nsString *pStream,</span>
<a href="#l73.91"></a><span id="l73.91" class="difflineplus">+                            nsIStringBundle *pBundle);</span>
<a href="#l73.92"></a><span id="l73.92" class="difflineplus">+  static void SetLogs(nsString &amp;success, nsString &amp;error, char16_t **pError,</span>
<a href="#l73.93"></a><span id="l73.93">                       char16_t **pSuccess);</span>
<a href="#l73.94"></a><span id="l73.94" class="difflineminus">-  static void ReportError(int32_t errorNum, nsString&amp; name, nsString *pStream,</span>
<a href="#l73.95"></a><span id="l73.95" class="difflineminus">-                          nsIStringBundle* pBundle);</span>
<a href="#l73.96"></a><span id="l73.96" class="difflineminus">-  static void SanitizeSampleData(nsString&amp; val);</span>
<a href="#l73.97"></a><span id="l73.97" class="difflineplus">+  static void ReportError(int32_t errorNum, nsString &amp;name, nsString *pStream,</span>
<a href="#l73.98"></a><span id="l73.98" class="difflineplus">+                          nsIStringBundle *pBundle);</span>
<a href="#l73.99"></a><span id="l73.99" class="difflineplus">+  static void SanitizeSampleData(nsString &amp;val);</span>
<a href="#l73.100"></a><span id="l73.100"> </span>
<a href="#l73.101"></a><span id="l73.101" class="difflineminus">-private:</span>
<a href="#l73.102"></a><span id="l73.102" class="difflineplus">+ private:</span>
<a href="#l73.103"></a><span id="l73.103">   ~ImportAddressImpl() {}</span>
<a href="#l73.104"></a><span id="l73.104">   nsTextAddress m_text;</span>
<a href="#l73.105"></a><span id="l73.105">   bool m_haveDelim;</span>
<a href="#l73.106"></a><span id="l73.106">   nsCOMPtr&lt;nsIFile&gt; m_fileLoc;</span>
<a href="#l73.107"></a><span id="l73.107">   nsCOMPtr&lt;nsIStringBundle&gt; m_notProxyBundle;</span>
<a href="#l73.108"></a><span id="l73.108">   char16_t m_delim;</span>
<a href="#l73.109"></a><span id="l73.109">   uint32_t m_bytesImported;</span>
<a href="#l73.110"></a><span id="l73.110"> };</span>
<a href="#l73.111"></a><span id="l73.111"> </span>
<a href="#l73.112"></a><span id="l73.112"> ////////////////////////////////////////////////////////////////////////</span>
<a href="#l73.113"></a><span id="l73.113"> ////////////////////////////////////////////////////////////////////////</span>
<a href="#l73.114"></a><span id="l73.114"> </span>
<a href="#l73.115"></a><span id="l73.115" class="difflineminus">-nsTextImport::nsTextImport()</span>
<a href="#l73.116"></a><span id="l73.116" class="difflineminus">-{</span>
<a href="#l73.117"></a><span id="l73.117" class="difflineplus">+nsTextImport::nsTextImport() {</span>
<a href="#l73.118"></a><span id="l73.118">   IMPORT_LOG0(&quot;nsTextImport Module Created\n&quot;);</span>
<a href="#l73.119"></a><span id="l73.119"> </span>
<a href="#l73.120"></a><span id="l73.120">   nsImportStringBundle::GetStringBundle(TEXT_MSGS_URL,</span>
<a href="#l73.121"></a><span id="l73.121">                                         getter_AddRefs(m_stringBundle));</span>
<a href="#l73.122"></a><span id="l73.122"> }</span>
<a href="#l73.123"></a><span id="l73.123"> </span>
<a href="#l73.124"></a><span id="l73.124" class="difflineminus">-nsTextImport::~nsTextImport()</span>
<a href="#l73.125"></a><span id="l73.125" class="difflineminus">-{</span>
<a href="#l73.126"></a><span id="l73.126" class="difflineminus">-  IMPORT_LOG0(&quot;nsTextImport Module Deleted\n&quot;);</span>
<a href="#l73.127"></a><span id="l73.127" class="difflineminus">-}</span>
<a href="#l73.128"></a><span id="l73.128" class="difflineplus">+nsTextImport::~nsTextImport() { IMPORT_LOG0(&quot;nsTextImport Module Deleted\n&quot;); }</span>
<a href="#l73.129"></a><span id="l73.129"> </span>
<a href="#l73.130"></a><span id="l73.130"> NS_IMPL_ISUPPORTS(nsTextImport, nsIImportModule)</span>
<a href="#l73.131"></a><span id="l73.131"> </span>
<a href="#l73.132"></a><span id="l73.132" class="difflineminus">-NS_IMETHODIMP nsTextImport::GetName(char16_t **name)</span>
<a href="#l73.133"></a><span id="l73.133" class="difflineminus">-{</span>
<a href="#l73.134"></a><span id="l73.134" class="difflineplus">+NS_IMETHODIMP nsTextImport::GetName(char16_t **name) {</span>
<a href="#l73.135"></a><span id="l73.135">   NS_ENSURE_ARG_POINTER(name);</span>
<a href="#l73.136"></a><span id="l73.136">   *name = nsImportStringBundle::GetStringByID(TEXTIMPORT_NAME, m_stringBundle);</span>
<a href="#l73.137"></a><span id="l73.137">   return NS_OK;</span>
<a href="#l73.138"></a><span id="l73.138"> }</span>
<a href="#l73.139"></a><span id="l73.139"> </span>
<a href="#l73.140"></a><span id="l73.140" class="difflineminus">-NS_IMETHODIMP nsTextImport::GetDescription(char16_t **name)</span>
<a href="#l73.141"></a><span id="l73.141" class="difflineminus">-{</span>
<a href="#l73.142"></a><span id="l73.142" class="difflineplus">+NS_IMETHODIMP nsTextImport::GetDescription(char16_t **name) {</span>
<a href="#l73.143"></a><span id="l73.143">   NS_ENSURE_ARG_POINTER(name);</span>
<a href="#l73.144"></a><span id="l73.144">   *name = nsImportStringBundle::GetStringByID(TEXTIMPORT_DESCRIPTION,</span>
<a href="#l73.145"></a><span id="l73.145">                                               m_stringBundle);</span>
<a href="#l73.146"></a><span id="l73.146"> </span>
<a href="#l73.147"></a><span id="l73.147">   return NS_OK;</span>
<a href="#l73.148"></a><span id="l73.148"> }</span>
<a href="#l73.149"></a><span id="l73.149"> </span>
<a href="#l73.150"></a><span id="l73.150" class="difflineminus">-NS_IMETHODIMP nsTextImport::GetSupports(char **supports)</span>
<a href="#l73.151"></a><span id="l73.151" class="difflineminus">-{</span>
<a href="#l73.152"></a><span id="l73.152" class="difflineplus">+NS_IMETHODIMP nsTextImport::GetSupports(char **supports) {</span>
<a href="#l73.153"></a><span id="l73.153">   NS_ENSURE_ARG_POINTER(supports);</span>
<a href="#l73.154"></a><span id="l73.154">   *supports = strdup(kTextSupportsString);</span>
<a href="#l73.155"></a><span id="l73.155">   return NS_OK;</span>
<a href="#l73.156"></a><span id="l73.156"> }</span>
<a href="#l73.157"></a><span id="l73.157"> </span>
<a href="#l73.158"></a><span id="l73.158" class="difflineminus">-NS_IMETHODIMP nsTextImport::GetSupportsUpgrade(bool *pUpgrade)</span>
<a href="#l73.159"></a><span id="l73.159" class="difflineminus">-{</span>
<a href="#l73.160"></a><span id="l73.160" class="difflineplus">+NS_IMETHODIMP nsTextImport::GetSupportsUpgrade(bool *pUpgrade) {</span>
<a href="#l73.161"></a><span id="l73.161">   NS_ASSERTION(pUpgrade != nullptr, &quot;null ptr&quot;);</span>
<a href="#l73.162"></a><span id="l73.162" class="difflineminus">-  if (! pUpgrade)</span>
<a href="#l73.163"></a><span id="l73.163" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l73.164"></a><span id="l73.164" class="difflineplus">+  if (!pUpgrade) return NS_ERROR_NULL_POINTER;</span>
<a href="#l73.165"></a><span id="l73.165"> </span>
<a href="#l73.166"></a><span id="l73.166">   *pUpgrade = false;</span>
<a href="#l73.167"></a><span id="l73.167">   return NS_OK;</span>
<a href="#l73.168"></a><span id="l73.168"> }</span>
<a href="#l73.169"></a><span id="l73.169"> </span>
<a href="#l73.170"></a><span id="l73.170" class="difflineminus">-NS_IMETHODIMP nsTextImport::GetImportInterface(const char *pImportType, nsISupports **ppInterface)</span>
<a href="#l73.171"></a><span id="l73.171" class="difflineminus">-{</span>
<a href="#l73.172"></a><span id="l73.172" class="difflineplus">+NS_IMETHODIMP nsTextImport::GetImportInterface(const char *pImportType,</span>
<a href="#l73.173"></a><span id="l73.173" class="difflineplus">+                                               nsISupports **ppInterface) {</span>
<a href="#l73.174"></a><span id="l73.174">   NS_ENSURE_ARG_POINTER(pImportType);</span>
<a href="#l73.175"></a><span id="l73.175">   NS_ENSURE_ARG_POINTER(ppInterface);</span>
<a href="#l73.176"></a><span id="l73.176"> </span>
<a href="#l73.177"></a><span id="l73.177">   *ppInterface = nullptr;</span>
<a href="#l73.178"></a><span id="l73.178">   nsresult rv;</span>
<a href="#l73.179"></a><span id="l73.179"> </span>
<a href="#l73.180"></a><span id="l73.180">   if (!strcmp(pImportType, &quot;addressbook&quot;)) {</span>
<a href="#l73.181"></a><span id="l73.181">     // create the nsIImportMail interface and return it!</span>
<a href="#l73.182"></a><span id="l73.182">     nsCOMPtr&lt;nsIImportAddressBooks&gt; pAddress;</span>
<a href="#l73.183"></a><span id="l73.183">     nsCOMPtr&lt;nsIImportGeneric&gt; pGeneric;</span>
<a href="#l73.184"></a><span id="l73.184">     rv = ImportAddressImpl::Create(getter_AddRefs(pAddress), m_stringBundle);</span>
<a href="#l73.185"></a><span id="l73.185">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l73.186"></a><span id="l73.186" class="difflineminus">-      nsCOMPtr&lt;nsIImportService&gt; impSvc(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l73.187"></a><span id="l73.187" class="difflineplus">+      nsCOMPtr&lt;nsIImportService&gt; impSvc(</span>
<a href="#l73.188"></a><span id="l73.188" class="difflineplus">+          do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l73.189"></a><span id="l73.189">       if (NS_SUCCEEDED(rv)) {</span>
<a href="#l73.190"></a><span id="l73.190">         rv = impSvc-&gt;CreateNewGenericAddressBooks(getter_AddRefs(pGeneric));</span>
<a href="#l73.191"></a><span id="l73.191">         if (NS_SUCCEEDED(rv)) {</span>
<a href="#l73.192"></a><span id="l73.192">           pGeneric-&gt;SetData(&quot;addressInterface&quot;, pAddress);</span>
<a href="#l73.193"></a><span id="l73.193">           nsCOMPtr&lt;nsISupports&gt; pInterface(do_QueryInterface(pGeneric));</span>
<a href="#l73.194"></a><span id="l73.194">           pInterface.forget(ppInterface);</span>
<a href="#l73.195"></a><span id="l73.195">         }</span>
<a href="#l73.196"></a><span id="l73.196">       }</span>
<a href="#l73.197"></a><span id="l73.197">     }</span>
<a href="#l73.198"></a><span id="l73.198">     return rv;</span>
<a href="#l73.199"></a><span id="l73.199">   }</span>
<a href="#l73.200"></a><span id="l73.200">   return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l73.201"></a><span id="l73.201"> }</span>
<a href="#l73.202"></a><span id="l73.202"> </span>
<a href="#l73.203"></a><span id="l73.203"> /////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l73.204"></a><span id="l73.204"> </span>
<a href="#l73.205"></a><span id="l73.205" class="difflineminus">-</span>
<a href="#l73.206"></a><span id="l73.206" class="difflineminus">-</span>
<a href="#l73.207"></a><span id="l73.207" class="difflineminus">-nsresult ImportAddressImpl::Create(nsIImportAddressBooks** aImport,</span>
<a href="#l73.208"></a><span id="l73.208" class="difflineminus">-                                   nsIStringBundle* aStringBundle)</span>
<a href="#l73.209"></a><span id="l73.209" class="difflineminus">-{</span>
<a href="#l73.210"></a><span id="l73.210" class="difflineplus">+nsresult ImportAddressImpl::Create(nsIImportAddressBooks **aImport,</span>
<a href="#l73.211"></a><span id="l73.211" class="difflineplus">+                                   nsIStringBundle *aStringBundle) {</span>
<a href="#l73.212"></a><span id="l73.212">   NS_ENSURE_ARG_POINTER(aImport);</span>
<a href="#l73.213"></a><span id="l73.213">   NS_ADDREF(*aImport = new ImportAddressImpl(aStringBundle));</span>
<a href="#l73.214"></a><span id="l73.214">   return NS_OK;</span>
<a href="#l73.215"></a><span id="l73.215"> }</span>
<a href="#l73.216"></a><span id="l73.216"> </span>
<a href="#l73.217"></a><span id="l73.217" class="difflineminus">-ImportAddressImpl::ImportAddressImpl(nsIStringBundle* aStringBundle) :</span>
<a href="#l73.218"></a><span id="l73.218" class="difflineminus">-  m_notProxyBundle(aStringBundle)</span>
<a href="#l73.219"></a><span id="l73.219" class="difflineminus">-{</span>
<a href="#l73.220"></a><span id="l73.220" class="difflineplus">+ImportAddressImpl::ImportAddressImpl(nsIStringBundle *aStringBundle)</span>
<a href="#l73.221"></a><span id="l73.221" class="difflineplus">+    : m_notProxyBundle(aStringBundle) {</span>
<a href="#l73.222"></a><span id="l73.222">   m_haveDelim = false;</span>
<a href="#l73.223"></a><span id="l73.223"> }</span>
<a href="#l73.224"></a><span id="l73.224"> </span>
<a href="#l73.225"></a><span id="l73.225"> NS_IMPL_ISUPPORTS(ImportAddressImpl, nsIImportAddressBooks)</span>
<a href="#l73.226"></a><span id="l73.226"> </span>
<a href="#l73.227"></a><span id="l73.227" class="difflineminus">-</span>
<a href="#l73.228"></a><span id="l73.228" class="difflineminus">-NS_IMETHODIMP ImportAddressImpl::GetAutoFind(char16_t **addrDescription, bool *_retval)</span>
<a href="#l73.229"></a><span id="l73.229" class="difflineminus">-{</span>
<a href="#l73.230"></a><span id="l73.230" class="difflineplus">+NS_IMETHODIMP ImportAddressImpl::GetAutoFind(char16_t **addrDescription,</span>
<a href="#l73.231"></a><span id="l73.231" class="difflineplus">+                                             bool *_retval) {</span>
<a href="#l73.232"></a><span id="l73.232">   NS_ASSERTION(addrDescription != nullptr, &quot;null ptr&quot;);</span>
<a href="#l73.233"></a><span id="l73.233">   NS_ASSERTION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l73.234"></a><span id="l73.234" class="difflineminus">-  if (! addrDescription || !_retval)</span>
<a href="#l73.235"></a><span id="l73.235" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l73.236"></a><span id="l73.236" class="difflineplus">+  if (!addrDescription || !_retval) return NS_ERROR_NULL_POINTER;</span>
<a href="#l73.237"></a><span id="l73.237"> </span>
<a href="#l73.238"></a><span id="l73.238">   nsString str;</span>
<a href="#l73.239"></a><span id="l73.239">   *_retval = false;</span>
<a href="#l73.240"></a><span id="l73.240"> </span>
<a href="#l73.241"></a><span id="l73.241" class="difflineminus">-  if (!m_notProxyBundle)</span>
<a href="#l73.242"></a><span id="l73.242" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l73.243"></a><span id="l73.243" class="difflineplus">+  if (!m_notProxyBundle) return NS_ERROR_FAILURE;</span>
<a href="#l73.244"></a><span id="l73.244"> </span>
<a href="#l73.245"></a><span id="l73.245" class="difflineminus">-  nsImportStringBundle::GetStringByID(TEXTIMPORT_ADDRESS_NAME, m_notProxyBundle, str);</span>
<a href="#l73.246"></a><span id="l73.246" class="difflineplus">+  nsImportStringBundle::GetStringByID(TEXTIMPORT_ADDRESS_NAME, m_notProxyBundle,</span>
<a href="#l73.247"></a><span id="l73.247" class="difflineplus">+                                      str);</span>
<a href="#l73.248"></a><span id="l73.248">   *addrDescription = ToNewUnicode(str);</span>
<a href="#l73.249"></a><span id="l73.249">   return NS_OK;</span>
<a href="#l73.250"></a><span id="l73.250"> }</span>
<a href="#l73.251"></a><span id="l73.251"> </span>
<a href="#l73.252"></a><span id="l73.252" class="difflineminus">-</span>
<a href="#l73.253"></a><span id="l73.253" class="difflineminus">-NS_IMETHODIMP ImportAddressImpl::GetDefaultLocation(nsIFile **ppLoc, bool *found, bool *userVerify)</span>
<a href="#l73.254"></a><span id="l73.254" class="difflineminus">-{</span>
<a href="#l73.255"></a><span id="l73.255" class="difflineplus">+NS_IMETHODIMP ImportAddressImpl::GetDefaultLocation(nsIFile **ppLoc,</span>
<a href="#l73.256"></a><span id="l73.256" class="difflineplus">+                                                    bool *found,</span>
<a href="#l73.257"></a><span id="l73.257" class="difflineplus">+                                                    bool *userVerify) {</span>
<a href="#l73.258"></a><span id="l73.258">   NS_ASSERTION(found != nullptr, &quot;null ptr&quot;);</span>
<a href="#l73.259"></a><span id="l73.259">   NS_ASSERTION(ppLoc != nullptr, &quot;null ptr&quot;);</span>
<a href="#l73.260"></a><span id="l73.260">   NS_ASSERTION(userVerify != nullptr, &quot;null ptr&quot;);</span>
<a href="#l73.261"></a><span id="l73.261" class="difflineminus">-  if (! found || !userVerify || !ppLoc)</span>
<a href="#l73.262"></a><span id="l73.262" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l73.263"></a><span id="l73.263" class="difflineplus">+  if (!found || !userVerify || !ppLoc) return NS_ERROR_NULL_POINTER;</span>
<a href="#l73.264"></a><span id="l73.264"> </span>
<a href="#l73.265"></a><span id="l73.265">   *ppLoc = nullptr;</span>
<a href="#l73.266"></a><span id="l73.266">   *found = false;</span>
<a href="#l73.267"></a><span id="l73.267">   *userVerify = true;</span>
<a href="#l73.268"></a><span id="l73.268">   return NS_OK;</span>
<a href="#l73.269"></a><span id="l73.269"> }</span>
<a href="#l73.270"></a><span id="l73.270"> </span>
<a href="#l73.271"></a><span id="l73.271" class="difflineminus">-</span>
<a href="#l73.272"></a><span id="l73.272" class="difflineminus">-</span>
<a href="#l73.273"></a><span id="l73.273" class="difflineminus">-NS_IMETHODIMP ImportAddressImpl::FindAddressBooks(nsIFile *pLoc, nsIArray **ppArray)</span>
<a href="#l73.274"></a><span id="l73.274" class="difflineminus">-{</span>
<a href="#l73.275"></a><span id="l73.275" class="difflineplus">+NS_IMETHODIMP ImportAddressImpl::FindAddressBooks(nsIFile *pLoc,</span>
<a href="#l73.276"></a><span id="l73.276" class="difflineplus">+                                                  nsIArray **ppArray) {</span>
<a href="#l73.277"></a><span id="l73.277">   NS_ASSERTION(pLoc != nullptr, &quot;null ptr&quot;);</span>
<a href="#l73.278"></a><span id="l73.278">   NS_ASSERTION(ppArray != nullptr, &quot;null ptr&quot;);</span>
<a href="#l73.279"></a><span id="l73.279" class="difflineminus">-  if (!pLoc || !ppArray)</span>
<a href="#l73.280"></a><span id="l73.280" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l73.281"></a><span id="l73.281" class="difflineplus">+  if (!pLoc || !ppArray) return NS_ERROR_NULL_POINTER;</span>
<a href="#l73.282"></a><span id="l73.282"> </span>
<a href="#l73.283"></a><span id="l73.283">   ClearSampleFile();</span>
<a href="#l73.284"></a><span id="l73.284"> </span>
<a href="#l73.285"></a><span id="l73.285">   *ppArray = nullptr;</span>
<a href="#l73.286"></a><span id="l73.286">   bool exists = false;</span>
<a href="#l73.287"></a><span id="l73.287">   nsresult rv = pLoc-&gt;Exists(&amp;exists);</span>
<a href="#l73.288"></a><span id="l73.288" class="difflineminus">-  if (NS_FAILED(rv) || !exists)</span>
<a href="#l73.289"></a><span id="l73.289" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l73.290"></a><span id="l73.290" class="difflineplus">+  if (NS_FAILED(rv) || !exists) return NS_ERROR_FAILURE;</span>
<a href="#l73.291"></a><span id="l73.291"> </span>
<a href="#l73.292"></a><span id="l73.292">   bool isFile = false;</span>
<a href="#l73.293"></a><span id="l73.293">   rv = pLoc-&gt;IsFile(&amp;isFile);</span>
<a href="#l73.294"></a><span id="l73.294" class="difflineminus">-  if (NS_FAILED(rv) || !isFile)</span>
<a href="#l73.295"></a><span id="l73.295" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l73.296"></a><span id="l73.296" class="difflineplus">+  if (NS_FAILED(rv) || !isFile) return NS_ERROR_FAILURE;</span>
<a href="#l73.297"></a><span id="l73.297"> </span>
<a href="#l73.298"></a><span id="l73.298">   rv = m_text.DetermineDelim(pLoc);</span>
<a href="#l73.299"></a><span id="l73.299"> </span>
<a href="#l73.300"></a><span id="l73.300">   if (NS_FAILED(rv)) {</span>
<a href="#l73.301"></a><span id="l73.301">     IMPORT_LOG0(&quot;*** Error determining delimitter\n&quot;);</span>
<a href="#l73.302"></a><span id="l73.302">     return rv;</span>
<a href="#l73.303"></a><span id="l73.303">   }</span>
<a href="#l73.304"></a><span id="l73.304">   m_haveDelim = true;</span>
<a href="#l73.305"></a><span id="l73.305" class="difflineat">@@ -283,107 +266,98 @@ NS_IMETHODIMP ImportAddressImpl::FindAdd</span>
<a href="#l73.306"></a><span id="l73.306"> </span>
<a href="#l73.307"></a><span id="l73.307">   int32_t idx = name.RFindChar('.');</span>
<a href="#l73.308"></a><span id="l73.308">   if ((idx != -1) &amp;&amp; (idx &gt; 0) &amp;&amp; ((name.Length() - idx - 1) &lt; 5)) {</span>
<a href="#l73.309"></a><span id="l73.309">     name.SetLength(idx);</span>
<a href="#l73.310"></a><span id="l73.310">   }</span>
<a href="#l73.311"></a><span id="l73.311"> </span>
<a href="#l73.312"></a><span id="l73.312">   nsCOMPtr&lt;nsIImportABDescriptor&gt; desc;</span>
<a href="#l73.313"></a><span id="l73.313"> </span>
<a href="#l73.314"></a><span id="l73.314" class="difflineminus">-  nsCOMPtr&lt;nsIImportService&gt; impSvc(do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l73.315"></a><span id="l73.315" class="difflineplus">+  nsCOMPtr&lt;nsIImportService&gt; impSvc(</span>
<a href="#l73.316"></a><span id="l73.316" class="difflineplus">+      do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l73.317"></a><span id="l73.317">   if (NS_FAILED(rv)) {</span>
<a href="#l73.318"></a><span id="l73.318">     IMPORT_LOG0(&quot;*** Failed to obtain the import service\n&quot;);</span>
<a href="#l73.319"></a><span id="l73.319">     return rv;</span>
<a href="#l73.320"></a><span id="l73.320">   }</span>
<a href="#l73.321"></a><span id="l73.321"> </span>
<a href="#l73.322"></a><span id="l73.322">   rv = impSvc-&gt;CreateNewABDescriptor(getter_AddRefs(desc));</span>
<a href="#l73.323"></a><span id="l73.323">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l73.324"></a><span id="l73.324">     int64_t sz = 0;</span>
<a href="#l73.325"></a><span id="l73.325">     pLoc-&gt;GetFileSize(&amp;sz);</span>
<a href="#l73.326"></a><span id="l73.326">     desc-&gt;SetPreferredName(name);</span>
<a href="#l73.327"></a><span id="l73.327" class="difflineminus">-    desc-&gt;SetSize((uint32_t) sz);</span>
<a href="#l73.328"></a><span id="l73.328" class="difflineplus">+    desc-&gt;SetSize((uint32_t)sz);</span>
<a href="#l73.329"></a><span id="l73.329">     desc-&gt;SetAbFile(m_fileLoc);</span>
<a href="#l73.330"></a><span id="l73.330">     nsCOMPtr&lt;nsISupports&gt; pInterface(do_QueryInterface(desc));</span>
<a href="#l73.331"></a><span id="l73.331">     array-&gt;AppendElement(pInterface);</span>
<a href="#l73.332"></a><span id="l73.332">   }</span>
<a href="#l73.333"></a><span id="l73.333">   if (NS_FAILED(rv)) {</span>
<a href="#l73.334"></a><span id="l73.334">     IMPORT_LOG0(&quot;*** Error creating address book descriptor for text import\n&quot;);</span>
<a href="#l73.335"></a><span id="l73.335">     return rv;</span>
<a href="#l73.336"></a><span id="l73.336">   }</span>
<a href="#l73.337"></a><span id="l73.337">   array.forget(ppArray);</span>
<a href="#l73.338"></a><span id="l73.338">   return NS_OK;</span>
<a href="#l73.339"></a><span id="l73.339"> }</span>
<a href="#l73.340"></a><span id="l73.340"> </span>
<a href="#l73.341"></a><span id="l73.341" class="difflineminus">-void ImportAddressImpl::ReportSuccess(nsString&amp; name, nsString *pStream,</span>
<a href="#l73.342"></a><span id="l73.342" class="difflineminus">-                                      nsIStringBundle* pBundle)</span>
<a href="#l73.343"></a><span id="l73.343" class="difflineminus">-{</span>
<a href="#l73.344"></a><span id="l73.344" class="difflineminus">-  if (!pStream)</span>
<a href="#l73.345"></a><span id="l73.345" class="difflineminus">-    return;</span>
<a href="#l73.346"></a><span id="l73.346" class="difflineplus">+void ImportAddressImpl::ReportSuccess(nsString &amp;name, nsString *pStream,</span>
<a href="#l73.347"></a><span id="l73.347" class="difflineplus">+                                      nsIStringBundle *pBundle) {</span>
<a href="#l73.348"></a><span id="l73.348" class="difflineplus">+  if (!pStream) return;</span>
<a href="#l73.349"></a><span id="l73.349"> </span>
<a href="#l73.350"></a><span id="l73.350">   // load the success string</span>
<a href="#l73.351"></a><span id="l73.351">   char16_t *pFmt =</span>
<a href="#l73.352"></a><span id="l73.352" class="difflineminus">-    nsImportStringBundle::GetStringByID(TEXTIMPORT_ADDRESS_SUCCESS, pBundle);</span>
<a href="#l73.353"></a><span id="l73.353" class="difflineplus">+      nsImportStringBundle::GetStringByID(TEXTIMPORT_ADDRESS_SUCCESS, pBundle);</span>
<a href="#l73.354"></a><span id="l73.354"> </span>
<a href="#l73.355"></a><span id="l73.355">   nsString pText;</span>
<a href="#l73.356"></a><span id="l73.356">   nsTextFormatter::ssprintf(pText, pFmt, name.get());</span>
<a href="#l73.357"></a><span id="l73.357">   pStream-&gt;Append(pText);</span>
<a href="#l73.358"></a><span id="l73.358">   free(pFmt);</span>
<a href="#l73.359"></a><span id="l73.359">   pStream-&gt;Append(char16_t('\n'));</span>
<a href="#l73.360"></a><span id="l73.360"> }</span>
<a href="#l73.361"></a><span id="l73.361"> </span>
<a href="#l73.362"></a><span id="l73.362" class="difflineminus">-void ImportAddressImpl::ReportError(int32_t errorNum, nsString&amp; name,</span>
<a href="#l73.363"></a><span id="l73.363" class="difflineminus">-                                    nsString *pStream, nsIStringBundle* pBundle)</span>
<a href="#l73.364"></a><span id="l73.364" class="difflineminus">-{</span>
<a href="#l73.365"></a><span id="l73.365" class="difflineminus">-  if (!pStream)</span>
<a href="#l73.366"></a><span id="l73.366" class="difflineminus">-    return;</span>
<a href="#l73.367"></a><span id="l73.367" class="difflineplus">+void ImportAddressImpl::ReportError(int32_t errorNum, nsString &amp;name,</span>
<a href="#l73.368"></a><span id="l73.368" class="difflineplus">+                                    nsString *pStream,</span>
<a href="#l73.369"></a><span id="l73.369" class="difflineplus">+                                    nsIStringBundle *pBundle) {</span>
<a href="#l73.370"></a><span id="l73.370" class="difflineplus">+  if (!pStream) return;</span>
<a href="#l73.371"></a><span id="l73.371"> </span>
<a href="#l73.372"></a><span id="l73.372">   // load the error string</span>
<a href="#l73.373"></a><span id="l73.373">   char16_t *pFmt = nsImportStringBundle::GetStringByID(errorNum, pBundle);</span>
<a href="#l73.374"></a><span id="l73.374">   nsString pText;</span>
<a href="#l73.375"></a><span id="l73.375">   nsTextFormatter::ssprintf(pText, pFmt, name.get());</span>
<a href="#l73.376"></a><span id="l73.376">   pStream-&gt;Append(pText);</span>
<a href="#l73.377"></a><span id="l73.377">   free(pFmt);</span>
<a href="#l73.378"></a><span id="l73.378">   pStream-&gt;Append(char16_t('\n'));</span>
<a href="#l73.379"></a><span id="l73.379"> }</span>
<a href="#l73.380"></a><span id="l73.380"> </span>
<a href="#l73.381"></a><span id="l73.381" class="difflineminus">-void ImportAddressImpl::SetLogs(nsString&amp; success, nsString&amp; error, char16_t **pError, char16_t **pSuccess)</span>
<a href="#l73.382"></a><span id="l73.382" class="difflineminus">-{</span>
<a href="#l73.383"></a><span id="l73.383" class="difflineminus">-  if (pError)</span>
<a href="#l73.384"></a><span id="l73.384" class="difflineminus">-    *pError = ToNewUnicode(error);</span>
<a href="#l73.385"></a><span id="l73.385" class="difflineminus">-  if (pSuccess)</span>
<a href="#l73.386"></a><span id="l73.386" class="difflineminus">-    *pSuccess = ToNewUnicode(success);</span>
<a href="#l73.387"></a><span id="l73.387" class="difflineplus">+void ImportAddressImpl::SetLogs(nsString &amp;success, nsString &amp;error,</span>
<a href="#l73.388"></a><span id="l73.388" class="difflineplus">+                                char16_t **pError, char16_t **pSuccess) {</span>
<a href="#l73.389"></a><span id="l73.389" class="difflineplus">+  if (pError) *pError = ToNewUnicode(error);</span>
<a href="#l73.390"></a><span id="l73.390" class="difflineplus">+  if (pSuccess) *pSuccess = ToNewUnicode(success);</span>
<a href="#l73.391"></a><span id="l73.391"> }</span>
<a href="#l73.392"></a><span id="l73.392"> </span>
<a href="#l73.393"></a><span id="l73.393" class="difflineminus">-</span>
<a href="#l73.394"></a><span id="l73.394"> NS_IMETHODIMP</span>
<a href="#l73.395"></a><span id="l73.395"> ImportAddressImpl::ImportAddressBook(nsIImportABDescriptor *pSource,</span>
<a href="#l73.396"></a><span id="l73.396">                                      nsIAddrDatabase *pDestination,</span>
<a href="#l73.397"></a><span id="l73.397">                                      nsIImportFieldMap *fieldMap,</span>
<a href="#l73.398"></a><span id="l73.398">                                      nsISupports *aSupportService,</span>
<a href="#l73.399"></a><span id="l73.399" class="difflineminus">-                                     char16_t ** pErrorLog,</span>
<a href="#l73.400"></a><span id="l73.400" class="difflineminus">-                                     char16_t ** pSuccessLog,</span>
<a href="#l73.401"></a><span id="l73.401" class="difflineminus">-                                     bool * fatalError)</span>
<a href="#l73.402"></a><span id="l73.402" class="difflineminus">-{</span>
<a href="#l73.403"></a><span id="l73.403" class="difflineplus">+                                     char16_t **pErrorLog,</span>
<a href="#l73.404"></a><span id="l73.404" class="difflineplus">+                                     char16_t **pSuccessLog, bool *fatalError) {</span>
<a href="#l73.405"></a><span id="l73.405">   NS_ASSERTION(pSource != nullptr, &quot;null ptr&quot;);</span>
<a href="#l73.406"></a><span id="l73.406">   NS_ASSERTION(pDestination != nullptr, &quot;null ptr&quot;);</span>
<a href="#l73.407"></a><span id="l73.407">   NS_ASSERTION(fatalError != nullptr, &quot;null ptr&quot;);</span>
<a href="#l73.408"></a><span id="l73.408"> </span>
<a href="#l73.409"></a><span id="l73.409">   m_bytesImported = 0;</span>
<a href="#l73.410"></a><span id="l73.410"> </span>
<a href="#l73.411"></a><span id="l73.411">   nsString success, error;</span>
<a href="#l73.412"></a><span id="l73.412">   if (!pSource || !pDestination || !fatalError) {</span>
<a href="#l73.413"></a><span id="l73.413">     IMPORT_LOG0(&quot;*** Bad param passed to text address import\n&quot;);</span>
<a href="#l73.414"></a><span id="l73.414">     nsImportStringBundle::GetStringByID(TEXTIMPORT_ADDRESS_BADPARAM,</span>
<a href="#l73.415"></a><span id="l73.415" class="difflineminus">-                                        m_notProxyBundle,</span>
<a href="#l73.416"></a><span id="l73.416" class="difflineminus">-                                        error);</span>
<a href="#l73.417"></a><span id="l73.417" class="difflineplus">+                                        m_notProxyBundle, error);</span>
<a href="#l73.418"></a><span id="l73.418"> </span>
<a href="#l73.419"></a><span id="l73.419">     SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l73.420"></a><span id="l73.420"> </span>
<a href="#l73.421"></a><span id="l73.421" class="difflineminus">-    if (fatalError)</span>
<a href="#l73.422"></a><span id="l73.422" class="difflineminus">-      *fatalError = true;</span>
<a href="#l73.423"></a><span id="l73.423" class="difflineplus">+    if (fatalError) *fatalError = true;</span>
<a href="#l73.424"></a><span id="l73.424"> </span>
<a href="#l73.425"></a><span id="l73.425">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l73.426"></a><span id="l73.426">   }</span>
<a href="#l73.427"></a><span id="l73.427"> </span>
<a href="#l73.428"></a><span id="l73.428">   ClearSampleFile();</span>
<a href="#l73.429"></a><span id="l73.429"> </span>
<a href="#l73.430"></a><span id="l73.430">   bool addrAbort = false;</span>
<a href="#l73.431"></a><span id="l73.431">   nsString name;</span>
<a href="#l73.432"></a><span id="l73.432" class="difflineat">@@ -395,110 +369,108 @@ ImportAddressImpl::ImportAddressBook(nsI</span>
<a href="#l73.433"></a><span id="l73.433">     IMPORT_LOG0(&quot;Address book size is 0, skipping import.\n&quot;);</span>
<a href="#l73.434"></a><span id="l73.434">     ReportSuccess(name, &amp;success, m_notProxyBundle);</span>
<a href="#l73.435"></a><span id="l73.435">     SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l73.436"></a><span id="l73.436">     return NS_OK;</span>
<a href="#l73.437"></a><span id="l73.437">   }</span>
<a href="#l73.438"></a><span id="l73.438"> </span>
<a href="#l73.439"></a><span id="l73.439">   nsCOMPtr&lt;nsIFile&gt; inFile;</span>
<a href="#l73.440"></a><span id="l73.440">   if (NS_FAILED(pSource-&gt;GetAbFile(getter_AddRefs(inFile)))) {</span>
<a href="#l73.441"></a><span id="l73.441" class="difflineminus">-    ReportError(TEXTIMPORT_ADDRESS_BADSOURCEFILE, name, &amp;error, m_notProxyBundle);</span>
<a href="#l73.442"></a><span id="l73.442" class="difflineplus">+    ReportError(TEXTIMPORT_ADDRESS_BADSOURCEFILE, name, &amp;error,</span>
<a href="#l73.443"></a><span id="l73.443" class="difflineplus">+                m_notProxyBundle);</span>
<a href="#l73.444"></a><span id="l73.444">     SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l73.445"></a><span id="l73.445">     return NS_ERROR_FAILURE;</span>
<a href="#l73.446"></a><span id="l73.446">   }</span>
<a href="#l73.447"></a><span id="l73.447"> </span>
<a href="#l73.448"></a><span id="l73.448">   if (!aSupportService) {</span>
<a href="#l73.449"></a><span id="l73.449">     IMPORT_LOG0(&quot;Missing support service to import call&quot;);</span>
<a href="#l73.450"></a><span id="l73.450">     return NS_ERROR_FAILURE;</span>
<a href="#l73.451"></a><span id="l73.451">   }</span>
<a href="#l73.452"></a><span id="l73.452"> </span>
<a href="#l73.453"></a><span id="l73.453">   bool isLDIF = false;</span>
<a href="#l73.454"></a><span id="l73.454">   nsresult rv;</span>
<a href="#l73.455"></a><span id="l73.455" class="difflineminus">-  nsCOMPtr&lt;nsIAbLDIFService&gt; ldifService(do_QueryInterface(aSupportService, &amp;rv));</span>
<a href="#l73.456"></a><span id="l73.456" class="difflineplus">+  nsCOMPtr&lt;nsIAbLDIFService&gt; ldifService(</span>
<a href="#l73.457"></a><span id="l73.457" class="difflineplus">+      do_QueryInterface(aSupportService, &amp;rv));</span>
<a href="#l73.458"></a><span id="l73.458"> </span>
<a href="#l73.459"></a><span id="l73.459" class="difflineminus">-    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l73.460"></a><span id="l73.460" class="difflineminus">-      rv = ldifService-&gt;IsLDIFFile(inFile, &amp;isLDIF);</span>
<a href="#l73.461"></a><span id="l73.461" class="difflineminus">-      if (NS_FAILED(rv)) {</span>
<a href="#l73.462"></a><span id="l73.462" class="difflineminus">-        IMPORT_LOG0(&quot;*** Error reading address file\n&quot;);</span>
<a href="#l73.463"></a><span id="l73.463" class="difflineminus">-      }</span>
<a href="#l73.464"></a><span id="l73.464" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l73.465"></a><span id="l73.465" class="difflineplus">+    rv = ldifService-&gt;IsLDIFFile(inFile, &amp;isLDIF);</span>
<a href="#l73.466"></a><span id="l73.466" class="difflineplus">+    if (NS_FAILED(rv)) {</span>
<a href="#l73.467"></a><span id="l73.467" class="difflineplus">+      IMPORT_LOG0(&quot;*** Error reading address file\n&quot;);</span>
<a href="#l73.468"></a><span id="l73.468">     }</span>
<a href="#l73.469"></a><span id="l73.469" class="difflineplus">+  }</span>
<a href="#l73.470"></a><span id="l73.470"> </span>
<a href="#l73.471"></a><span id="l73.471">   if (NS_FAILED(rv)) {</span>
<a href="#l73.472"></a><span id="l73.472" class="difflineminus">-    ReportError(TEXTIMPORT_ADDRESS_CONVERTERROR, name, &amp;error, m_notProxyBundle);</span>
<a href="#l73.473"></a><span id="l73.473" class="difflineplus">+    ReportError(TEXTIMPORT_ADDRESS_CONVERTERROR, name, &amp;error,</span>
<a href="#l73.474"></a><span id="l73.474" class="difflineplus">+                m_notProxyBundle);</span>
<a href="#l73.475"></a><span id="l73.475">     SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l73.476"></a><span id="l73.476">     return rv;</span>
<a href="#l73.477"></a><span id="l73.477">   }</span>
<a href="#l73.478"></a><span id="l73.478"> </span>
<a href="#l73.479"></a><span id="l73.479">   if (isLDIF) {</span>
<a href="#l73.480"></a><span id="l73.480">     if (ldifService)</span>
<a href="#l73.481"></a><span id="l73.481" class="difflineminus">-      rv = ldifService-&gt;ImportLDIFFile(pDestination, inFile, false, &amp;m_bytesImported);</span>
<a href="#l73.482"></a><span id="l73.482" class="difflineplus">+      rv = ldifService-&gt;ImportLDIFFile(pDestination, inFile, false,</span>
<a href="#l73.483"></a><span id="l73.483" class="difflineplus">+                                       &amp;m_bytesImported);</span>
<a href="#l73.484"></a><span id="l73.484">     else</span>
<a href="#l73.485"></a><span id="l73.485">       return NS_ERROR_FAILURE;</span>
<a href="#l73.486"></a><span id="l73.486" class="difflineminus">-  }</span>
<a href="#l73.487"></a><span id="l73.487" class="difflineminus">-  else {</span>
<a href="#l73.488"></a><span id="l73.488" class="difflineminus">-    rv = m_text.ImportAddresses(&amp;addrAbort, name.get(), inFile, pDestination, fieldMap, error, &amp;m_bytesImported);</span>
<a href="#l73.489"></a><span id="l73.489" class="difflineplus">+  } else {</span>
<a href="#l73.490"></a><span id="l73.490" class="difflineplus">+    rv = m_text.ImportAddresses(&amp;addrAbort, name.get(), inFile, pDestination,</span>
<a href="#l73.491"></a><span id="l73.491" class="difflineplus">+                                fieldMap, error, &amp;m_bytesImported);</span>
<a href="#l73.492"></a><span id="l73.492">     SaveFieldMap(fieldMap);</span>
<a href="#l73.493"></a><span id="l73.493">   }</span>
<a href="#l73.494"></a><span id="l73.494"> </span>
<a href="#l73.495"></a><span id="l73.495">   if (NS_SUCCEEDED(rv) &amp;&amp; error.IsEmpty()) {</span>
<a href="#l73.496"></a><span id="l73.496">     ReportSuccess(name, &amp;success, m_notProxyBundle);</span>
<a href="#l73.497"></a><span id="l73.497">     SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l73.498"></a><span id="l73.498" class="difflineminus">-  }</span>
<a href="#l73.499"></a><span id="l73.499" class="difflineminus">-  else {</span>
<a href="#l73.500"></a><span id="l73.500" class="difflineminus">-    ReportError(TEXTIMPORT_ADDRESS_CONVERTERROR, name, &amp;error, m_notProxyBundle);</span>
<a href="#l73.501"></a><span id="l73.501" class="difflineplus">+  } else {</span>
<a href="#l73.502"></a><span id="l73.502" class="difflineplus">+    ReportError(TEXTIMPORT_ADDRESS_CONVERTERROR, name, &amp;error,</span>
<a href="#l73.503"></a><span id="l73.503" class="difflineplus">+                m_notProxyBundle);</span>
<a href="#l73.504"></a><span id="l73.504">     SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l73.505"></a><span id="l73.505">   }</span>
<a href="#l73.506"></a><span id="l73.506"> </span>
<a href="#l73.507"></a><span id="l73.507">   IMPORT_LOG0(&quot;*** Text address import done\n&quot;);</span>
<a href="#l73.508"></a><span id="l73.508">   return rv;</span>
<a href="#l73.509"></a><span id="l73.509"> }</span>
<a href="#l73.510"></a><span id="l73.510"> </span>
<a href="#l73.511"></a><span id="l73.511" class="difflineminus">-</span>
<a href="#l73.512"></a><span id="l73.512" class="difflineminus">-NS_IMETHODIMP ImportAddressImpl::GetImportProgress(uint32_t *_retval)</span>
<a href="#l73.513"></a><span id="l73.513" class="difflineminus">-{</span>
<a href="#l73.514"></a><span id="l73.514" class="difflineplus">+NS_IMETHODIMP ImportAddressImpl::GetImportProgress(uint32_t *_retval) {</span>
<a href="#l73.515"></a><span id="l73.515">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l73.516"></a><span id="l73.516">   *_retval = m_bytesImported;</span>
<a href="#l73.517"></a><span id="l73.517">   return NS_OK;</span>
<a href="#l73.518"></a><span id="l73.518"> }</span>
<a href="#l73.519"></a><span id="l73.519"> </span>
<a href="#l73.520"></a><span id="l73.520" class="difflineminus">-</span>
<a href="#l73.521"></a><span id="l73.521" class="difflineminus">-NS_IMETHODIMP ImportAddressImpl::GetNeedsFieldMap(nsIFile *aLocation, bool *_retval)</span>
<a href="#l73.522"></a><span id="l73.522" class="difflineminus">-{</span>
<a href="#l73.523"></a><span id="l73.523" class="difflineplus">+NS_IMETHODIMP ImportAddressImpl::GetNeedsFieldMap(nsIFile *aLocation,</span>
<a href="#l73.524"></a><span id="l73.524" class="difflineplus">+                                                  bool *_retval) {</span>
<a href="#l73.525"></a><span id="l73.525">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l73.526"></a><span id="l73.526">   NS_ENSURE_ARG_POINTER(aLocation);</span>
<a href="#l73.527"></a><span id="l73.527"> </span>
<a href="#l73.528"></a><span id="l73.528">   *_retval = true;</span>
<a href="#l73.529"></a><span id="l73.529">   bool exists = false;</span>
<a href="#l73.530"></a><span id="l73.530">   bool isFile = false;</span>
<a href="#l73.531"></a><span id="l73.531"> </span>
<a href="#l73.532"></a><span id="l73.532">   nsresult rv = aLocation-&gt;Exists(&amp;exists);</span>
<a href="#l73.533"></a><span id="l73.533">   rv = aLocation-&gt;IsFile(&amp;isFile);</span>
<a href="#l73.534"></a><span id="l73.534"> </span>
<a href="#l73.535"></a><span id="l73.535" class="difflineminus">-  if (!exists || !isFile)</span>
<a href="#l73.536"></a><span id="l73.536" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l73.537"></a><span id="l73.537" class="difflineplus">+  if (!exists || !isFile) return NS_ERROR_FAILURE;</span>
<a href="#l73.538"></a><span id="l73.538"> </span>
<a href="#l73.539"></a><span id="l73.539" class="difflineminus">-  bool    isLDIF = false;</span>
<a href="#l73.540"></a><span id="l73.540" class="difflineminus">-  nsCOMPtr&lt;nsIAbLDIFService&gt; ldifService = do_GetService(NS_ABLDIFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l73.541"></a><span id="l73.541" class="difflineplus">+  bool isLDIF = false;</span>
<a href="#l73.542"></a><span id="l73.542" class="difflineplus">+  nsCOMPtr&lt;nsIAbLDIFService&gt; ldifService =</span>
<a href="#l73.543"></a><span id="l73.543" class="difflineplus">+      do_GetService(NS_ABLDIFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l73.544"></a><span id="l73.544"> </span>
<a href="#l73.545"></a><span id="l73.545" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l73.546"></a><span id="l73.546" class="difflineminus">-    rv = ldifService-&gt;IsLDIFFile(aLocation, &amp;isLDIF);</span>
<a href="#l73.547"></a><span id="l73.547" class="difflineplus">+  if (NS_SUCCEEDED(rv)) rv = ldifService-&gt;IsLDIFFile(aLocation, &amp;isLDIF);</span>
<a href="#l73.548"></a><span id="l73.548"> </span>
<a href="#l73.549"></a><span id="l73.549">   if (NS_FAILED(rv)) {</span>
<a href="#l73.550"></a><span id="l73.550">     IMPORT_LOG0(&quot;*** Error determining if file is of type LDIF\n&quot;);</span>
<a href="#l73.551"></a><span id="l73.551">     return rv;</span>
<a href="#l73.552"></a><span id="l73.552">   }</span>
<a href="#l73.553"></a><span id="l73.553"> </span>
<a href="#l73.554"></a><span id="l73.554" class="difflineminus">-  if (isLDIF)</span>
<a href="#l73.555"></a><span id="l73.555" class="difflineminus">-    *_retval = false;</span>
<a href="#l73.556"></a><span id="l73.556" class="difflineplus">+  if (isLDIF) *_retval = false;</span>
<a href="#l73.557"></a><span id="l73.557"> </span>
<a href="#l73.558"></a><span id="l73.558">   return NS_OK;</span>
<a href="#l73.559"></a><span id="l73.559"> }</span>
<a href="#l73.560"></a><span id="l73.560"> </span>
<a href="#l73.561"></a><span id="l73.561" class="difflineminus">-void ImportAddressImpl::SanitizeSampleData(nsString&amp; val)</span>
<a href="#l73.562"></a><span id="l73.562" class="difflineminus">-{</span>
<a href="#l73.563"></a><span id="l73.563" class="difflineplus">+void ImportAddressImpl::SanitizeSampleData(nsString &amp;val) {</span>
<a href="#l73.564"></a><span id="l73.564">   // remove any line-feeds...</span>
<a href="#l73.565"></a><span id="l73.565">   int32_t offset = val.Find(NS_LITERAL_STRING(&quot;\x0D\x0A&quot;));</span>
<a href="#l73.566"></a><span id="l73.566">   while (offset != -1) {</span>
<a href="#l73.567"></a><span id="l73.567">     val.Replace(offset, 2, NS_LITERAL_STRING(&quot;, &quot;));</span>
<a href="#l73.568"></a><span id="l73.568">     offset = val.Find(NS_LITERAL_STRING(&quot;\x0D\x0A&quot;), offset + 2);</span>
<a href="#l73.569"></a><span id="l73.569">   }</span>
<a href="#l73.570"></a><span id="l73.570">   offset = val.FindChar(13);</span>
<a href="#l73.571"></a><span id="l73.571">   while (offset != -1) {</span>
<a href="#l73.572"></a><span id="l73.572" class="difflineat">@@ -507,22 +479,21 @@ void ImportAddressImpl::SanitizeSampleDa</span>
<a href="#l73.573"></a><span id="l73.573">   }</span>
<a href="#l73.574"></a><span id="l73.574">   offset = val.FindChar(10);</span>
<a href="#l73.575"></a><span id="l73.575">   while (offset != -1) {</span>
<a href="#l73.576"></a><span id="l73.576">     val.Replace(offset, 1, ',');</span>
<a href="#l73.577"></a><span id="l73.577">     offset = val.FindChar(10, offset + 2);</span>
<a href="#l73.578"></a><span id="l73.578">   }</span>
<a href="#l73.579"></a><span id="l73.579"> }</span>
<a href="#l73.580"></a><span id="l73.580"> </span>
<a href="#l73.581"></a><span id="l73.581" class="difflineminus">-NS_IMETHODIMP ImportAddressImpl::GetSampleData(int32_t index, bool *pFound, char16_t **pStr)</span>
<a href="#l73.582"></a><span id="l73.582" class="difflineminus">-{</span>
<a href="#l73.583"></a><span id="l73.583" class="difflineplus">+NS_IMETHODIMP ImportAddressImpl::GetSampleData(int32_t index, bool *pFound,</span>
<a href="#l73.584"></a><span id="l73.584" class="difflineplus">+                                               char16_t **pStr) {</span>
<a href="#l73.585"></a><span id="l73.585">   NS_ASSERTION(pFound != nullptr, &quot;null ptr&quot;);</span>
<a href="#l73.586"></a><span id="l73.586">   NS_ASSERTION(pStr != nullptr, &quot;null ptr&quot;);</span>
<a href="#l73.587"></a><span id="l73.587" class="difflineminus">-  if (!pFound || !pStr)</span>
<a href="#l73.588"></a><span id="l73.588" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l73.589"></a><span id="l73.589" class="difflineplus">+  if (!pFound || !pStr) return NS_ERROR_NULL_POINTER;</span>
<a href="#l73.590"></a><span id="l73.590"> </span>
<a href="#l73.591"></a><span id="l73.591">   if (!m_fileLoc) {</span>
<a href="#l73.592"></a><span id="l73.592">     IMPORT_LOG0(&quot;*** Error, called GetSampleData before SetSampleLocation\n&quot;);</span>
<a href="#l73.593"></a><span id="l73.593">     return NS_ERROR_FAILURE;</span>
<a href="#l73.594"></a><span id="l73.594">   }</span>
<a href="#l73.595"></a><span id="l73.595"> </span>
<a href="#l73.596"></a><span id="l73.596">   nsresult rv;</span>
<a href="#l73.597"></a><span id="l73.597">   *pStr = nullptr;</span>
<a href="#l73.598"></a><span id="l73.598" class="difflineat">@@ -547,54 +518,49 @@ NS_IMETHODIMP ImportAddressImpl::GetSamp</span>
<a href="#l73.599"></a><span id="l73.599"> </span>
<a href="#l73.600"></a><span id="l73.600">   nsAutoString line;</span>
<a href="#l73.601"></a><span id="l73.601">   rv = nsTextAddress::ReadRecordNumber(m_fileLoc, line, index);</span>
<a href="#l73.602"></a><span id="l73.602">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l73.603"></a><span id="l73.603">     nsString str;</span>
<a href="#l73.604"></a><span id="l73.604">     nsString field;</span>
<a href="#l73.605"></a><span id="l73.605">     int32_t fNum = 0;</span>
<a href="#l73.606"></a><span id="l73.606">     while (nsTextAddress::GetField(line, fNum, field, m_delim)) {</span>
<a href="#l73.607"></a><span id="l73.607" class="difflineminus">-      if (fNum)</span>
<a href="#l73.608"></a><span id="l73.608" class="difflineminus">-        str.Append(char16_t('\n'));</span>
<a href="#l73.609"></a><span id="l73.609" class="difflineplus">+      if (fNum) str.Append(char16_t('\n'));</span>
<a href="#l73.610"></a><span id="l73.610">       SanitizeSampleData(field);</span>
<a href="#l73.611"></a><span id="l73.611">       str.Append(field);</span>
<a href="#l73.612"></a><span id="l73.612">       fNum++;</span>
<a href="#l73.613"></a><span id="l73.613">       field.Truncate();</span>
<a href="#l73.614"></a><span id="l73.614">     }</span>
<a href="#l73.615"></a><span id="l73.615"> </span>
<a href="#l73.616"></a><span id="l73.616">     *pStr = ToNewUnicode(str);</span>
<a href="#l73.617"></a><span id="l73.617">     *pFound = true;</span>
<a href="#l73.618"></a><span id="l73.618"> </span>
<a href="#l73.619"></a><span id="l73.619">     /* IMPORT_LOG1(&quot;Sample data: %S\n&quot;, str.get()); */</span>
<a href="#l73.620"></a><span id="l73.620" class="difflineminus">-  }</span>
<a href="#l73.621"></a><span id="l73.621" class="difflineminus">-  else {</span>
<a href="#l73.622"></a><span id="l73.622" class="difflineplus">+  } else {</span>
<a href="#l73.623"></a><span id="l73.623">     *pFound = false;</span>
<a href="#l73.624"></a><span id="l73.624">     *pStr = NS_xstrdup(&amp;term);</span>
<a href="#l73.625"></a><span id="l73.625">   }</span>
<a href="#l73.626"></a><span id="l73.626"> </span>
<a href="#l73.627"></a><span id="l73.627">   return NS_OK;</span>
<a href="#l73.628"></a><span id="l73.628"> }</span>
<a href="#l73.629"></a><span id="l73.629"> </span>
<a href="#l73.630"></a><span id="l73.630" class="difflineminus">-NS_IMETHODIMP ImportAddressImpl::SetSampleLocation(nsIFile *pLocation)</span>
<a href="#l73.631"></a><span id="l73.631" class="difflineminus">-{</span>
<a href="#l73.632"></a><span id="l73.632" class="difflineplus">+NS_IMETHODIMP ImportAddressImpl::SetSampleLocation(nsIFile *pLocation) {</span>
<a href="#l73.633"></a><span id="l73.633">   NS_ENSURE_ARG_POINTER(pLocation);</span>
<a href="#l73.634"></a><span id="l73.634"> </span>
<a href="#l73.635"></a><span id="l73.635">   m_fileLoc = pLocation;</span>
<a href="#l73.636"></a><span id="l73.636">   m_haveDelim = false;</span>
<a href="#l73.637"></a><span id="l73.637">   return NS_OK;</span>
<a href="#l73.638"></a><span id="l73.638"> }</span>
<a href="#l73.639"></a><span id="l73.639"> </span>
<a href="#l73.640"></a><span id="l73.640" class="difflineminus">-void ImportAddressImpl::ClearSampleFile(void)</span>
<a href="#l73.641"></a><span id="l73.641" class="difflineminus">-{</span>
<a href="#l73.642"></a><span id="l73.642" class="difflineplus">+void ImportAddressImpl::ClearSampleFile(void) {</span>
<a href="#l73.643"></a><span id="l73.643">   m_fileLoc = nullptr;</span>
<a href="#l73.644"></a><span id="l73.644">   m_haveDelim = false;</span>
<a href="#l73.645"></a><span id="l73.645"> }</span>
<a href="#l73.646"></a><span id="l73.646"> </span>
<a href="#l73.647"></a><span id="l73.647" class="difflineminus">-NS_IMETHODIMP ImportAddressImpl::InitFieldMap(nsIImportFieldMap *fieldMap)</span>
<a href="#l73.648"></a><span id="l73.648" class="difflineminus">-{</span>
<a href="#l73.649"></a><span id="l73.649" class="difflineplus">+NS_IMETHODIMP ImportAddressImpl::InitFieldMap(nsIImportFieldMap *fieldMap) {</span>
<a href="#l73.650"></a><span id="l73.650">   // Let's remember the last one the user used!</span>
<a href="#l73.651"></a><span id="l73.651">   // This should be normal for someone importing multiple times, it's usually</span>
<a href="#l73.652"></a><span id="l73.652">   // from the same file format.</span>
<a href="#l73.653"></a><span id="l73.653"> </span>
<a href="#l73.654"></a><span id="l73.654">   nsresult rv;</span>
<a href="#l73.655"></a><span id="l73.655">   nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l73.656"></a><span id="l73.656">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l73.657"></a><span id="l73.657">     nsCString prefStr;</span>
<a href="#l73.658"></a><span id="l73.658" class="difflineat">@@ -602,65 +568,57 @@ NS_IMETHODIMP ImportAddressImpl::InitFie</span>
<a href="#l73.659"></a><span id="l73.659">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l73.660"></a><span id="l73.660">       const char *pStr = prefStr.get();</span>
<a href="#l73.661"></a><span id="l73.661">       if (pStr) {</span>
<a href="#l73.662"></a><span id="l73.662">         fieldMap-&gt;SetFieldMapSize(0);</span>
<a href="#l73.663"></a><span id="l73.663">         long fNum;</span>
<a href="#l73.664"></a><span id="l73.664">         bool active;</span>
<a href="#l73.665"></a><span id="l73.665">         long fIndex = 0;</span>
<a href="#l73.666"></a><span id="l73.666">         while (*pStr) {</span>
<a href="#l73.667"></a><span id="l73.667" class="difflineminus">-          while (*pStr &amp;&amp; (*pStr != '+') &amp;&amp; (*pStr != '-'))</span>
<a href="#l73.668"></a><span id="l73.668" class="difflineminus">-            pStr++;</span>
<a href="#l73.669"></a><span id="l73.669" class="difflineplus">+          while (*pStr &amp;&amp; (*pStr != '+') &amp;&amp; (*pStr != '-')) pStr++;</span>
<a href="#l73.670"></a><span id="l73.670">           if (*pStr == '+')</span>
<a href="#l73.671"></a><span id="l73.671">             active = true;</span>
<a href="#l73.672"></a><span id="l73.672">           else if (*pStr == '-')</span>
<a href="#l73.673"></a><span id="l73.673">             active = false;</span>
<a href="#l73.674"></a><span id="l73.674">           else</span>
<a href="#l73.675"></a><span id="l73.675">             break;</span>
<a href="#l73.676"></a><span id="l73.676">           fNum = 0;</span>
<a href="#l73.677"></a><span id="l73.677" class="difflineminus">-          while (*pStr &amp;&amp; ((*pStr &lt; '0') || (*pStr &gt; '9')))</span>
<a href="#l73.678"></a><span id="l73.678" class="difflineminus">-            pStr++;</span>
<a href="#l73.679"></a><span id="l73.679" class="difflineminus">-          if (!(*pStr))</span>
<a href="#l73.680"></a><span id="l73.680" class="difflineminus">-            break;</span>
<a href="#l73.681"></a><span id="l73.681" class="difflineplus">+          while (*pStr &amp;&amp; ((*pStr &lt; '0') || (*pStr &gt; '9'))) pStr++;</span>
<a href="#l73.682"></a><span id="l73.682" class="difflineplus">+          if (!(*pStr)) break;</span>
<a href="#l73.683"></a><span id="l73.683">           while (*pStr &amp;&amp; (*pStr &gt;= '0') &amp;&amp; (*pStr &lt;= '9')) {</span>
<a href="#l73.684"></a><span id="l73.684">             fNum *= 10;</span>
<a href="#l73.685"></a><span id="l73.685">             fNum += (*pStr - '0');</span>
<a href="#l73.686"></a><span id="l73.686">             pStr++;</span>
<a href="#l73.687"></a><span id="l73.687">           }</span>
<a href="#l73.688"></a><span id="l73.688" class="difflineminus">-          while (*pStr &amp;&amp; (*pStr != ','))</span>
<a href="#l73.689"></a><span id="l73.689" class="difflineminus">-            pStr++;</span>
<a href="#l73.690"></a><span id="l73.690" class="difflineminus">-          if (*pStr == ',')</span>
<a href="#l73.691"></a><span id="l73.691" class="difflineminus">-            pStr++;</span>
<a href="#l73.692"></a><span id="l73.692" class="difflineplus">+          while (*pStr &amp;&amp; (*pStr != ',')) pStr++;</span>
<a href="#l73.693"></a><span id="l73.693" class="difflineplus">+          if (*pStr == ',') pStr++;</span>
<a href="#l73.694"></a><span id="l73.694">           fieldMap-&gt;SetFieldMap(-1, fNum);</span>
<a href="#l73.695"></a><span id="l73.695">           fieldMap-&gt;SetFieldActive(fIndex, active);</span>
<a href="#l73.696"></a><span id="l73.696">           fIndex++;</span>
<a href="#l73.697"></a><span id="l73.697">         }</span>
<a href="#l73.698"></a><span id="l73.698">         if (!fIndex) {</span>
<a href="#l73.699"></a><span id="l73.699">           int num;</span>
<a href="#l73.700"></a><span id="l73.700">           fieldMap-&gt;GetNumMozFields(&amp;num);</span>
<a href="#l73.701"></a><span id="l73.701">           fieldMap-&gt;DefaultFieldMap(num);</span>
<a href="#l73.702"></a><span id="l73.702">         }</span>
<a href="#l73.703"></a><span id="l73.703">       }</span>
<a href="#l73.704"></a><span id="l73.704">     }</span>
<a href="#l73.705"></a><span id="l73.705"> </span>
<a href="#l73.706"></a><span id="l73.706">     // Now also get the last used skip first record value.</span>
<a href="#l73.707"></a><span id="l73.707">     bool skipFirstRecord = false;</span>
<a href="#l73.708"></a><span id="l73.708" class="difflineminus">-    rv = prefs-&gt;GetBoolPref(&quot;mailnews.import.text.skipfirstrecord&quot;, &amp;skipFirstRecord);</span>
<a href="#l73.709"></a><span id="l73.709" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l73.710"></a><span id="l73.710" class="difflineminus">-      fieldMap-&gt;SetSkipFirstRecord(skipFirstRecord);</span>
<a href="#l73.711"></a><span id="l73.711" class="difflineplus">+    rv = prefs-&gt;GetBoolPref(&quot;mailnews.import.text.skipfirstrecord&quot;,</span>
<a href="#l73.712"></a><span id="l73.712" class="difflineplus">+                            &amp;skipFirstRecord);</span>
<a href="#l73.713"></a><span id="l73.713" class="difflineplus">+    if (NS_SUCCEEDED(rv)) fieldMap-&gt;SetSkipFirstRecord(skipFirstRecord);</span>
<a href="#l73.714"></a><span id="l73.714">   }</span>
<a href="#l73.715"></a><span id="l73.715"> </span>
<a href="#l73.716"></a><span id="l73.716">   return NS_OK;</span>
<a href="#l73.717"></a><span id="l73.717"> }</span>
<a href="#l73.718"></a><span id="l73.718"> </span>
<a href="#l73.719"></a><span id="l73.719" class="difflineminus">-</span>
<a href="#l73.720"></a><span id="l73.720" class="difflineminus">-void ImportAddressImpl::SaveFieldMap(nsIImportFieldMap *pMap)</span>
<a href="#l73.721"></a><span id="l73.721" class="difflineminus">-{</span>
<a href="#l73.722"></a><span id="l73.722" class="difflineminus">-  if (!pMap)</span>
<a href="#l73.723"></a><span id="l73.723" class="difflineminus">-    return;</span>
<a href="#l73.724"></a><span id="l73.724" class="difflineplus">+void ImportAddressImpl::SaveFieldMap(nsIImportFieldMap *pMap) {</span>
<a href="#l73.725"></a><span id="l73.725" class="difflineplus">+  if (!pMap) return;</span>
<a href="#l73.726"></a><span id="l73.726"> </span>
<a href="#l73.727"></a><span id="l73.727">   int size;</span>
<a href="#l73.728"></a><span id="l73.728">   int index;</span>
<a href="#l73.729"></a><span id="l73.729">   bool active;</span>
<a href="#l73.730"></a><span id="l73.730">   nsCString str;</span>
<a href="#l73.731"></a><span id="l73.731"> </span>
<a href="#l73.732"></a><span id="l73.732">   pMap-&gt;GetMapSize(&amp;size);</span>
<a href="#l73.733"></a><span id="l73.733">   for (long i = 0; i &lt; size; i++) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l74.1"></a><span id="l74.1" class="difflineminus">--- a/mailnews/import/text/src/nsTextImport.h</span>
<a href="#l74.2"></a><span id="l74.2" class="difflineplus">+++ b/mailnews/import/text/src/nsTextImport.h</span>
<a href="#l74.3"></a><span id="l74.3" class="difflineat">@@ -6,34 +6,35 @@</span>
<a href="#l74.4"></a><span id="l74.4"> </span>
<a href="#l74.5"></a><span id="l74.5"> #ifndef nsTextImport_h___</span>
<a href="#l74.6"></a><span id="l74.6"> #define nsTextImport_h___</span>
<a href="#l74.7"></a><span id="l74.7"> </span>
<a href="#l74.8"></a><span id="l74.8"> #include &quot;nsIImportModule.h&quot;</span>
<a href="#l74.9"></a><span id="l74.9"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l74.10"></a><span id="l74.10"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l74.11"></a><span id="l74.11"> </span>
<a href="#l74.12"></a><span id="l74.12" class="difflineminus">-#define NS_TEXTIMPORT_CID          \</span>
<a href="#l74.13"></a><span id="l74.13" class="difflineminus">-{ /* A5991D01-ADA7-11d3-A9C2-00A0CC26DA63 */      \</span>
<a href="#l74.14"></a><span id="l74.14" class="difflineminus">-  0xa5991d01, 0xada7, 0x11d3,            \</span>
<a href="#l74.15"></a><span id="l74.15" class="difflineminus">-  {0xa9, 0xc2, 0x0, 0xa0, 0xcc, 0x26, 0xda, 0x63 }}</span>
<a href="#l74.16"></a><span id="l74.16" class="difflineplus">+#define NS_TEXTIMPORT_CID                           \</span>
<a href="#l74.17"></a><span id="l74.17" class="difflineplus">+  { /* A5991D01-ADA7-11d3-A9C2-00A0CC26DA63 */      \</span>
<a href="#l74.18"></a><span id="l74.18" class="difflineplus">+    0xa5991d01, 0xada7, 0x11d3, {                   \</span>
<a href="#l74.19"></a><span id="l74.19" class="difflineplus">+      0xa9, 0xc2, 0x0, 0xa0, 0xcc, 0x26, 0xda, 0x63 \</span>
<a href="#l74.20"></a><span id="l74.20" class="difflineplus">+    }                                               \</span>
<a href="#l74.21"></a><span id="l74.21" class="difflineplus">+  }</span>
<a href="#l74.22"></a><span id="l74.22"> </span>
<a href="#l74.23"></a><span id="l74.23"> #define kTextSupportsString NS_IMPORT_ADDRESS_STR</span>
<a href="#l74.24"></a><span id="l74.24"> </span>
<a href="#l74.25"></a><span id="l74.25" class="difflineminus">-class nsTextImport : public nsIImportModule</span>
<a href="#l74.26"></a><span id="l74.26" class="difflineminus">-{</span>
<a href="#l74.27"></a><span id="l74.27" class="difflineminus">-public:</span>
<a href="#l74.28"></a><span id="l74.28" class="difflineplus">+class nsTextImport : public nsIImportModule {</span>
<a href="#l74.29"></a><span id="l74.29" class="difflineplus">+ public:</span>
<a href="#l74.30"></a><span id="l74.30">   nsTextImport();</span>
<a href="#l74.31"></a><span id="l74.31"> </span>
<a href="#l74.32"></a><span id="l74.32">   NS_DECL_ISUPPORTS</span>
<a href="#l74.33"></a><span id="l74.33"> </span>
<a href="#l74.34"></a><span id="l74.34">   ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l74.35"></a><span id="l74.35">   // we support the nsIImportModule interface</span>
<a href="#l74.36"></a><span id="l74.36">   ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l74.37"></a><span id="l74.37"> </span>
<a href="#l74.38"></a><span id="l74.38">   NS_DECL_NSIIMPORTMODULE</span>
<a href="#l74.39"></a><span id="l74.39"> </span>
<a href="#l74.40"></a><span id="l74.40" class="difflineminus">-protected:</span>
<a href="#l74.41"></a><span id="l74.41" class="difflineplus">+ protected:</span>
<a href="#l74.42"></a><span id="l74.42">   virtual ~nsTextImport();</span>
<a href="#l74.43"></a><span id="l74.43" class="difflineminus">-  nsCOMPtr&lt;nsIStringBundle&gt;   m_stringBundle;</span>
<a href="#l74.44"></a><span id="l74.44" class="difflineplus">+  nsCOMPtr&lt;nsIStringBundle&gt; m_stringBundle;</span>
<a href="#l74.45"></a><span id="l74.45"> };</span>
<a href="#l74.46"></a><span id="l74.46"> </span>
<a href="#l74.47"></a><span id="l74.47"> #endif /* nsTextImport_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l75.1"></a><span id="l75.1" class="difflineminus">--- a/mailnews/import/vcard/src/nsVCardAddress.cpp</span>
<a href="#l75.2"></a><span id="l75.2" class="difflineplus">+++ b/mailnews/import/vcard/src/nsVCardAddress.cpp</span>
<a href="#l75.3"></a><span id="l75.3" class="difflineat">@@ -13,32 +13,24 @@</span>
<a href="#l75.4"></a><span id="l75.4"> #include &quot;nsIFile.h&quot;</span>
<a href="#l75.5"></a><span id="l75.5"> #include &quot;nsIInputStream.h&quot;</span>
<a href="#l75.6"></a><span id="l75.6"> #include &quot;nsILineInputStream.h&quot;</span>
<a href="#l75.7"></a><span id="l75.7"> </span>
<a href="#l75.8"></a><span id="l75.8"> #include &quot;plstr.h&quot;</span>
<a href="#l75.9"></a><span id="l75.9"> #include &quot;msgCore.h&quot;</span>
<a href="#l75.10"></a><span id="l75.10"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l75.11"></a><span id="l75.11"> </span>
<a href="#l75.12"></a><span id="l75.12" class="difflineminus">-nsVCardAddress::nsVCardAddress()</span>
<a href="#l75.13"></a><span id="l75.13" class="difflineminus">-{</span>
<a href="#l75.14"></a><span id="l75.14" class="difflineminus">-}</span>
<a href="#l75.15"></a><span id="l75.15" class="difflineplus">+nsVCardAddress::nsVCardAddress() {}</span>
<a href="#l75.16"></a><span id="l75.16"> </span>
<a href="#l75.17"></a><span id="l75.17" class="difflineminus">-nsVCardAddress::~nsVCardAddress()</span>
<a href="#l75.18"></a><span id="l75.18" class="difflineminus">-{</span>
<a href="#l75.19"></a><span id="l75.19" class="difflineminus">-}</span>
<a href="#l75.20"></a><span id="l75.20" class="difflineplus">+nsVCardAddress::~nsVCardAddress() {}</span>
<a href="#l75.21"></a><span id="l75.21"> </span>
<a href="#l75.22"></a><span id="l75.22" class="difflineminus">-nsresult nsVCardAddress::ImportAddresses(</span>
<a href="#l75.23"></a><span id="l75.23" class="difflineminus">-    bool *pAbort,</span>
<a href="#l75.24"></a><span id="l75.24" class="difflineminus">-    const char16_t *pName,</span>
<a href="#l75.25"></a><span id="l75.25" class="difflineminus">-    nsIFile *pSrc,</span>
<a href="#l75.26"></a><span id="l75.26" class="difflineminus">-    nsIAddrDatabase *pDb,</span>
<a href="#l75.27"></a><span id="l75.27" class="difflineminus">-    nsString&amp; errors,</span>
<a href="#l75.28"></a><span id="l75.28" class="difflineminus">-    uint32_t *pProgress)</span>
<a href="#l75.29"></a><span id="l75.29" class="difflineminus">-{</span>
<a href="#l75.30"></a><span id="l75.30" class="difflineplus">+nsresult nsVCardAddress::ImportAddresses(bool *pAbort, const char16_t *pName,</span>
<a href="#l75.31"></a><span id="l75.31" class="difflineplus">+                                         nsIFile *pSrc, nsIAddrDatabase *pDb,</span>
<a href="#l75.32"></a><span id="l75.32" class="difflineplus">+                                         nsString &amp;errors,</span>
<a href="#l75.33"></a><span id="l75.33" class="difflineplus">+                                         uint32_t *pProgress) {</span>
<a href="#l75.34"></a><span id="l75.34">   // Open the source file for reading, read each line and process it!</span>
<a href="#l75.35"></a><span id="l75.35">   nsCOMPtr&lt;nsIInputStream&gt; inputStream;</span>
<a href="#l75.36"></a><span id="l75.36">   nsresult rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream), pSrc);</span>
<a href="#l75.37"></a><span id="l75.37">   if (NS_FAILED(rv)) {</span>
<a href="#l75.38"></a><span id="l75.38">     IMPORT_LOG0(&quot;*** Error opening address file for reading\n&quot;);</span>
<a href="#l75.39"></a><span id="l75.39">     return rv;</span>
<a href="#l75.40"></a><span id="l75.40">   }</span>
<a href="#l75.41"></a><span id="l75.41"> </span>
<a href="#l75.42"></a><span id="l75.42" class="difflineat">@@ -63,17 +55,18 @@ nsresult nsVCardAddress::ImportAddresses</span>
<a href="#l75.43"></a><span id="l75.43"> </span>
<a href="#l75.44"></a><span id="l75.44">   bool more = true;</span>
<a href="#l75.45"></a><span id="l75.45">   nsCString record;</span>
<a href="#l75.46"></a><span id="l75.46">   while (!(*pAbort) &amp;&amp; more &amp;&amp; NS_SUCCEEDED(rv)) {</span>
<a href="#l75.47"></a><span id="l75.47">     rv = ReadRecord(lineStream, record, &amp;more);</span>
<a href="#l75.48"></a><span id="l75.48">     if (NS_SUCCEEDED(rv) &amp;&amp; !record.IsEmpty()) {</span>
<a href="#l75.49"></a><span id="l75.49">       // Parse the vCard and build an nsIAbCard from it</span>
<a href="#l75.50"></a><span id="l75.50">       nsCOMPtr&lt;nsIAbCard&gt; cardFromVCard;</span>
<a href="#l75.51"></a><span id="l75.51" class="difflineminus">-      rv = ab-&gt;EscapedVCardToAbCard(record.get(), getter_AddRefs(cardFromVCard));</span>
<a href="#l75.52"></a><span id="l75.52" class="difflineplus">+      rv =</span>
<a href="#l75.53"></a><span id="l75.53" class="difflineplus">+          ab-&gt;EscapedVCardToAbCard(record.get(), getter_AddRefs(cardFromVCard));</span>
<a href="#l75.54"></a><span id="l75.54">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l75.55"></a><span id="l75.55"> </span>
<a href="#l75.56"></a><span id="l75.56">       rv = pDb-&gt;CreateNewCardAndAddToDB(cardFromVCard, false, nullptr);</span>
<a href="#l75.57"></a><span id="l75.57">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l75.58"></a><span id="l75.58"> </span>
<a href="#l75.59"></a><span id="l75.59">       if (NS_FAILED(rv)) {</span>
<a href="#l75.60"></a><span id="l75.60">         IMPORT_LOG0(&quot;*** Error processing vCard record.\n&quot;);</span>
<a href="#l75.61"></a><span id="l75.61">       }</span>
<a href="#l75.62"></a><span id="l75.62" class="difflineat">@@ -84,53 +77,53 @@ nsresult nsVCardAddress::ImportAddresses</span>
<a href="#l75.63"></a><span id="l75.63">       // are actually left.</span>
<a href="#l75.64"></a><span id="l75.64">       bytesLeft -= record.Length();</span>
<a href="#l75.65"></a><span id="l75.65">       *pProgress = totalBytes - bytesLeft;</span>
<a href="#l75.66"></a><span id="l75.66">     }</span>
<a href="#l75.67"></a><span id="l75.67">   }</span>
<a href="#l75.68"></a><span id="l75.68">   inputStream-&gt;Close();</span>
<a href="#l75.69"></a><span id="l75.69"> </span>
<a href="#l75.70"></a><span id="l75.70">   if (NS_FAILED(rv)) {</span>
<a href="#l75.71"></a><span id="l75.71" class="difflineminus">-    IMPORT_LOG0(&quot;*** Error reading the address book - probably incorrect ending\n&quot;);</span>
<a href="#l75.72"></a><span id="l75.72" class="difflineplus">+    IMPORT_LOG0(</span>
<a href="#l75.73"></a><span id="l75.73" class="difflineplus">+        &quot;*** Error reading the address book - probably incorrect ending\n&quot;);</span>
<a href="#l75.74"></a><span id="l75.74">     return NS_ERROR_FAILURE;</span>
<a href="#l75.75"></a><span id="l75.75">   }</span>
<a href="#l75.76"></a><span id="l75.76"> </span>
<a href="#l75.77"></a><span id="l75.77">   return pDb-&gt;Commit(nsAddrDBCommitType::kLargeCommit);</span>
<a href="#l75.78"></a><span id="l75.78"> }</span>
<a href="#l75.79"></a><span id="l75.79"> </span>
<a href="#l75.80"></a><span id="l75.80" class="difflineminus">-nsresult nsVCardAddress::ReadRecord(</span>
<a href="#l75.81"></a><span id="l75.81" class="difflineminus">-    nsILineInputStream *aLineStream, nsCString &amp;aRecord, bool *aMore)</span>
<a href="#l75.82"></a><span id="l75.82" class="difflineminus">-{</span>
<a href="#l75.83"></a><span id="l75.83" class="difflineplus">+nsresult nsVCardAddress::ReadRecord(nsILineInputStream *aLineStream,</span>
<a href="#l75.84"></a><span id="l75.84" class="difflineplus">+                                    nsCString &amp;aRecord, bool *aMore) {</span>
<a href="#l75.85"></a><span id="l75.85">   bool more = true;</span>
<a href="#l75.86"></a><span id="l75.86">   nsresult rv;</span>
<a href="#l75.87"></a><span id="l75.87">   nsCString line;</span>
<a href="#l75.88"></a><span id="l75.88"> </span>
<a href="#l75.89"></a><span id="l75.89">   aRecord.Truncate();</span>
<a href="#l75.90"></a><span id="l75.90"> </span>
<a href="#l75.91"></a><span id="l75.91">   // remove the empty lines.</span>
<a href="#l75.92"></a><span id="l75.92">   do {</span>
<a href="#l75.93"></a><span id="l75.93">     rv = aLineStream-&gt;ReadLine(line, aMore);</span>
<a href="#l75.94"></a><span id="l75.94" class="difflineminus">-  }</span>
<a href="#l75.95"></a><span id="l75.95" class="difflineminus">-  while (line.IsEmpty() &amp;&amp; *aMore);</span>
<a href="#l75.96"></a><span id="l75.96" class="difflineminus">-  if (!*aMore)</span>
<a href="#l75.97"></a><span id="l75.97" class="difflineminus">-    return rv;</span>
<a href="#l75.98"></a><span id="l75.98" class="difflineplus">+  } while (line.IsEmpty() &amp;&amp; *aMore);</span>
<a href="#l75.99"></a><span id="l75.99" class="difflineplus">+  if (!*aMore) return rv;</span>
<a href="#l75.100"></a><span id="l75.100"> </span>
<a href="#l75.101"></a><span id="l75.101">   // read BEGIN:VCARD</span>
<a href="#l75.102"></a><span id="l75.102">   if (!line.LowerCaseEqualsLiteral(&quot;begin:vcard&quot;)) {</span>
<a href="#l75.103"></a><span id="l75.103" class="difflineminus">-    IMPORT_LOG0(&quot;*** Expected case-insensitive BEGIN:VCARD at start of vCard\n&quot;);</span>
<a href="#l75.104"></a><span id="l75.104" class="difflineplus">+    IMPORT_LOG0(</span>
<a href="#l75.105"></a><span id="l75.105" class="difflineplus">+        &quot;*** Expected case-insensitive BEGIN:VCARD at start of vCard\n&quot;);</span>
<a href="#l75.106"></a><span id="l75.106">     rv = NS_ERROR_FAILURE;</span>
<a href="#l75.107"></a><span id="l75.107">     *aMore = more;</span>
<a href="#l75.108"></a><span id="l75.108">     return rv;</span>
<a href="#l75.109"></a><span id="l75.109">   }</span>
<a href="#l75.110"></a><span id="l75.110">   aRecord.Append(line);</span>
<a href="#l75.111"></a><span id="l75.111"> </span>
<a href="#l75.112"></a><span id="l75.112">   // read until END:VCARD</span>
<a href="#l75.113"></a><span id="l75.113">   do {</span>
<a href="#l75.114"></a><span id="l75.114">     if (!more) {</span>
<a href="#l75.115"></a><span id="l75.115" class="difflineminus">-      IMPORT_LOG0(&quot;*** Expected case-insensitive END:VCARD at start of vCard\n&quot;);</span>
<a href="#l75.116"></a><span id="l75.116" class="difflineplus">+      IMPORT_LOG0(</span>
<a href="#l75.117"></a><span id="l75.117" class="difflineplus">+          &quot;*** Expected case-insensitive END:VCARD at start of vCard\n&quot;);</span>
<a href="#l75.118"></a><span id="l75.118">       rv = NS_ERROR_FAILURE;</span>
<a href="#l75.119"></a><span id="l75.119">       break;</span>
<a href="#l75.120"></a><span id="l75.120">     }</span>
<a href="#l75.121"></a><span id="l75.121">     rv = aLineStream-&gt;ReadLine(line, &amp;more);</span>
<a href="#l75.122"></a><span id="l75.122">     aRecord.AppendLiteral(MSG_LINEBREAK);</span>
<a href="#l75.123"></a><span id="l75.123">     aRecord.Append(line);</span>
<a href="#l75.124"></a><span id="l75.124">   } while (!line.LowerCaseEqualsLiteral(&quot;end:vcard&quot;));</span>
<a href="#l75.125"></a><span id="l75.125"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l76.1"></a><span id="l76.1" class="difflineminus">--- a/mailnews/import/vcard/src/nsVCardAddress.h</span>
<a href="#l76.2"></a><span id="l76.2" class="difflineplus">+++ b/mailnews/import/vcard/src/nsVCardAddress.h</span>
<a href="#l76.3"></a><span id="l76.3" class="difflineat">@@ -7,27 +7,22 @@</span>
<a href="#l76.4"></a><span id="l76.4"> </span>
<a href="#l76.5"></a><span id="l76.5"> #include &quot;ImportDebug.h&quot;</span>
<a href="#l76.6"></a><span id="l76.6"> </span>
<a href="#l76.7"></a><span id="l76.7"> class nsIAddrDatabase;</span>
<a href="#l76.8"></a><span id="l76.8"> class nsIFile;</span>
<a href="#l76.9"></a><span id="l76.9"> class nsILineInputStream;</span>
<a href="#l76.10"></a><span id="l76.10"> </span>
<a href="#l76.11"></a><span id="l76.11"> class nsVCardAddress {</span>
<a href="#l76.12"></a><span id="l76.12" class="difflineminus">-public:</span>
<a href="#l76.13"></a><span id="l76.13" class="difflineplus">+ public:</span>
<a href="#l76.14"></a><span id="l76.14">   nsVCardAddress();</span>
<a href="#l76.15"></a><span id="l76.15">   virtual ~nsVCardAddress();</span>
<a href="#l76.16"></a><span id="l76.16"> </span>
<a href="#l76.17"></a><span id="l76.17" class="difflineminus">-  nsresult ImportAddresses(</span>
<a href="#l76.18"></a><span id="l76.18" class="difflineminus">-      bool *pAbort,</span>
<a href="#l76.19"></a><span id="l76.19" class="difflineminus">-      const char16_t *pName,</span>
<a href="#l76.20"></a><span id="l76.20" class="difflineminus">-      nsIFile *pSrc,</span>
<a href="#l76.21"></a><span id="l76.21" class="difflineminus">-      nsIAddrDatabase *pDb,</span>
<a href="#l76.22"></a><span id="l76.22" class="difflineminus">-      nsString&amp; errors,</span>
<a href="#l76.23"></a><span id="l76.23" class="difflineminus">-      uint32_t *pProgress);</span>
<a href="#l76.24"></a><span id="l76.24" class="difflineplus">+  nsresult ImportAddresses(bool *pAbort, const char16_t *pName, nsIFile *pSrc,</span>
<a href="#l76.25"></a><span id="l76.25" class="difflineplus">+                           nsIAddrDatabase *pDb, nsString &amp;errors,</span>
<a href="#l76.26"></a><span id="l76.26" class="difflineplus">+                           uint32_t *pProgress);</span>
<a href="#l76.27"></a><span id="l76.27"> </span>
<a href="#l76.28"></a><span id="l76.28" class="difflineminus">-private:</span>
<a href="#l76.29"></a><span id="l76.29" class="difflineminus">-  static nsresult ReadRecord(</span>
<a href="#l76.30"></a><span id="l76.30" class="difflineminus">-      nsILineInputStream *aLineStream, nsCString &amp;aRecord, bool *aMore);</span>
<a href="#l76.31"></a><span id="l76.31" class="difflineplus">+ private:</span>
<a href="#l76.32"></a><span id="l76.32" class="difflineplus">+  static nsresult ReadRecord(nsILineInputStream *aLineStream,</span>
<a href="#l76.33"></a><span id="l76.33" class="difflineplus">+                             nsCString &amp;aRecord, bool *aMore);</span>
<a href="#l76.34"></a><span id="l76.34"> };</span>
<a href="#l76.35"></a><span id="l76.35"> </span>
<a href="#l76.36"></a><span id="l76.36"> #endif /* nsVCardAddress_h__ */</span>
<a href="#l76.37"></a><span id="l76.37" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l77.1"></a><span id="l77.1" class="difflineminus">--- a/mailnews/import/vcard/src/nsVCardImport.cpp</span>
<a href="#l77.2"></a><span id="l77.2" class="difflineplus">+++ b/mailnews/import/vcard/src/nsVCardImport.cpp</span>
<a href="#l77.3"></a><span id="l77.3" class="difflineat">@@ -19,138 +19,134 @@</span>
<a href="#l77.4"></a><span id="l77.4"> #include &quot;nsImportStringBundle.h&quot;</span>
<a href="#l77.5"></a><span id="l77.5"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l77.6"></a><span id="l77.6"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l77.7"></a><span id="l77.7"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l77.8"></a><span id="l77.8"> #include &quot;nsTextFormatter.h&quot;</span>
<a href="#l77.9"></a><span id="l77.9"> #include &quot;nsVCardAddress.h&quot;</span>
<a href="#l77.10"></a><span id="l77.10"> #include &quot;nsVCardImport.h&quot;</span>
<a href="#l77.11"></a><span id="l77.11"> </span>
<a href="#l77.12"></a><span id="l77.12" class="difflineminus">-class ImportVCardAddressImpl : public nsIImportAddressBooks</span>
<a href="#l77.13"></a><span id="l77.13" class="difflineminus">-{</span>
<a href="#l77.14"></a><span id="l77.14" class="difflineminus">-public:</span>
<a href="#l77.15"></a><span id="l77.15" class="difflineminus">-  explicit ImportVCardAddressImpl(nsIStringBundle* aStringBundle);</span>
<a href="#l77.16"></a><span id="l77.16" class="difflineplus">+class ImportVCardAddressImpl : public nsIImportAddressBooks {</span>
<a href="#l77.17"></a><span id="l77.17" class="difflineplus">+ public:</span>
<a href="#l77.18"></a><span id="l77.18" class="difflineplus">+  explicit ImportVCardAddressImpl(nsIStringBundle *aStringBundle);</span>
<a href="#l77.19"></a><span id="l77.19"> </span>
<a href="#l77.20"></a><span id="l77.20" class="difflineminus">-  static nsresult Create(</span>
<a href="#l77.21"></a><span id="l77.21" class="difflineminus">-      nsIImportAddressBooks** aImport, nsIStringBundle* aStringBundle);</span>
<a href="#l77.22"></a><span id="l77.22" class="difflineplus">+  static nsresult Create(nsIImportAddressBooks **aImport,</span>
<a href="#l77.23"></a><span id="l77.23" class="difflineplus">+                         nsIStringBundle *aStringBundle);</span>
<a href="#l77.24"></a><span id="l77.24"> </span>
<a href="#l77.25"></a><span id="l77.25">   // nsISupports interface</span>
<a href="#l77.26"></a><span id="l77.26">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l77.27"></a><span id="l77.27"> </span>
<a href="#l77.28"></a><span id="l77.28">   // nsIImportAddressBooks interface</span>
<a href="#l77.29"></a><span id="l77.29"> </span>
<a href="#l77.30"></a><span id="l77.30">   // TODO: support multiple vCard files in future - shouldn't be too hard,</span>
<a href="#l77.31"></a><span id="l77.31">   // since you just import each file in turn.</span>
<a href="#l77.32"></a><span id="l77.32" class="difflineminus">-  NS_IMETHOD GetSupportsMultiple(bool *_retval) override</span>
<a href="#l77.33"></a><span id="l77.33" class="difflineminus">-  { *_retval = false; return NS_OK;}</span>
<a href="#l77.34"></a><span id="l77.34" class="difflineplus">+  NS_IMETHOD GetSupportsMultiple(bool *_retval) override {</span>
<a href="#l77.35"></a><span id="l77.35" class="difflineplus">+    *_retval = false;</span>
<a href="#l77.36"></a><span id="l77.36" class="difflineplus">+    return NS_OK;</span>
<a href="#l77.37"></a><span id="l77.37" class="difflineplus">+  }</span>
<a href="#l77.38"></a><span id="l77.38"> </span>
<a href="#l77.39"></a><span id="l77.39">   NS_IMETHOD GetAutoFind(char16_t **description, bool *_retval) override;</span>
<a href="#l77.40"></a><span id="l77.40"> </span>
<a href="#l77.41"></a><span id="l77.41" class="difflineminus">-  NS_IMETHOD GetNeedsFieldMap(nsIFile *location, bool *_retval) override</span>
<a href="#l77.42"></a><span id="l77.42" class="difflineminus">-  { *_retval = false; return NS_OK;}</span>
<a href="#l77.43"></a><span id="l77.43" class="difflineplus">+  NS_IMETHOD GetNeedsFieldMap(nsIFile *location, bool *_retval) override {</span>
<a href="#l77.44"></a><span id="l77.44" class="difflineplus">+    *_retval = false;</span>
<a href="#l77.45"></a><span id="l77.45" class="difflineplus">+    return NS_OK;</span>
<a href="#l77.46"></a><span id="l77.46" class="difflineplus">+  }</span>
<a href="#l77.47"></a><span id="l77.47"> </span>
<a href="#l77.48"></a><span id="l77.48" class="difflineminus">-  NS_IMETHOD GetDefaultLocation(</span>
<a href="#l77.49"></a><span id="l77.49" class="difflineminus">-      nsIFile **location, bool *found, bool *userVerify) override;</span>
<a href="#l77.50"></a><span id="l77.50" class="difflineplus">+  NS_IMETHOD GetDefaultLocation(nsIFile **location, bool *found,</span>
<a href="#l77.51"></a><span id="l77.51" class="difflineplus">+                                bool *userVerify) override;</span>
<a href="#l77.52"></a><span id="l77.52"> </span>
<a href="#l77.53"></a><span id="l77.53">   NS_IMETHOD FindAddressBooks(nsIFile *location, nsIArray **_retval) override;</span>
<a href="#l77.54"></a><span id="l77.54"> </span>
<a href="#l77.55"></a><span id="l77.55" class="difflineminus">-  NS_IMETHOD InitFieldMap(nsIImportFieldMap *fieldMap) override</span>
<a href="#l77.56"></a><span id="l77.56" class="difflineminus">-  { return NS_ERROR_FAILURE;}</span>
<a href="#l77.57"></a><span id="l77.57" class="difflineplus">+  NS_IMETHOD InitFieldMap(nsIImportFieldMap *fieldMap) override {</span>
<a href="#l77.58"></a><span id="l77.58" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l77.59"></a><span id="l77.59" class="difflineplus">+  }</span>
<a href="#l77.60"></a><span id="l77.60"> </span>
<a href="#l77.61"></a><span id="l77.61">   NS_IMETHOD ImportAddressBook(nsIImportABDescriptor *source,</span>
<a href="#l77.62"></a><span id="l77.62">                                nsIAddrDatabase *destination,</span>
<a href="#l77.63"></a><span id="l77.63">                                nsIImportFieldMap *fieldMap,</span>
<a href="#l77.64"></a><span id="l77.64">                                nsISupports *aSupportService,</span>
<a href="#l77.65"></a><span id="l77.65" class="difflineminus">-                               char16_t **errorLog,</span>
<a href="#l77.66"></a><span id="l77.66" class="difflineminus">-                               char16_t **successLog,</span>
<a href="#l77.67"></a><span id="l77.67" class="difflineplus">+                               char16_t **errorLog, char16_t **successLog,</span>
<a href="#l77.68"></a><span id="l77.68">                                bool *fatalError) override;</span>
<a href="#l77.69"></a><span id="l77.69"> </span>
<a href="#l77.70"></a><span id="l77.70">   NS_IMETHOD GetImportProgress(uint32_t *_retval) override;</span>
<a href="#l77.71"></a><span id="l77.71"> </span>
<a href="#l77.72"></a><span id="l77.72" class="difflineminus">-  NS_IMETHOD GetSampleData(int32_t index, bool *pFound, char16_t **pStr) override</span>
<a href="#l77.73"></a><span id="l77.73" class="difflineminus">-  { return NS_ERROR_FAILURE;}</span>
<a href="#l77.74"></a><span id="l77.74" class="difflineplus">+  NS_IMETHOD GetSampleData(int32_t index, bool *pFound,</span>
<a href="#l77.75"></a><span id="l77.75" class="difflineplus">+                           char16_t **pStr) override {</span>
<a href="#l77.76"></a><span id="l77.76" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l77.77"></a><span id="l77.77" class="difflineplus">+  }</span>
<a href="#l77.78"></a><span id="l77.78"> </span>
<a href="#l77.79"></a><span id="l77.79" class="difflineminus">-  NS_IMETHOD SetSampleLocation(nsIFile *) override</span>
<a href="#l77.80"></a><span id="l77.80" class="difflineminus">-  { return NS_ERROR_FAILURE; }</span>
<a href="#l77.81"></a><span id="l77.81" class="difflineplus">+  NS_IMETHOD SetSampleLocation(nsIFile *) override { return NS_ERROR_FAILURE; }</span>
<a href="#l77.82"></a><span id="l77.82"> </span>
<a href="#l77.83"></a><span id="l77.83" class="difflineminus">-private:</span>
<a href="#l77.84"></a><span id="l77.84" class="difflineplus">+ private:</span>
<a href="#l77.85"></a><span id="l77.85">   virtual ~ImportVCardAddressImpl();</span>
<a href="#l77.86"></a><span id="l77.86" class="difflineminus">-  static void ReportSuccess(</span>
<a href="#l77.87"></a><span id="l77.87" class="difflineminus">-      nsString&amp; name, nsString *pStream, nsIStringBundle* pBundle);</span>
<a href="#l77.88"></a><span id="l77.88" class="difflineminus">-  static void SetLogs(</span>
<a href="#l77.89"></a><span id="l77.89" class="difflineminus">-      nsString&amp; success, nsString&amp; error,</span>
<a href="#l77.90"></a><span id="l77.90" class="difflineminus">-      char16_t **pError, char16_t **pSuccess);</span>
<a href="#l77.91"></a><span id="l77.91" class="difflineminus">-  static void ReportError(</span>
<a href="#l77.92"></a><span id="l77.92" class="difflineminus">-      const char *errorName, nsString&amp; name, nsString *pStream,</span>
<a href="#l77.93"></a><span id="l77.93" class="difflineminus">-      nsIStringBundle* pBundle);</span>
<a href="#l77.94"></a><span id="l77.94" class="difflineplus">+  static void ReportSuccess(nsString &amp;name, nsString *pStream,</span>
<a href="#l77.95"></a><span id="l77.95" class="difflineplus">+                            nsIStringBundle *pBundle);</span>
<a href="#l77.96"></a><span id="l77.96" class="difflineplus">+  static void SetLogs(nsString &amp;success, nsString &amp;error, char16_t **pError,</span>
<a href="#l77.97"></a><span id="l77.97" class="difflineplus">+                      char16_t **pSuccess);</span>
<a href="#l77.98"></a><span id="l77.98" class="difflineplus">+  static void ReportError(const char *errorName, nsString &amp;name,</span>
<a href="#l77.99"></a><span id="l77.99" class="difflineplus">+                          nsString *pStream, nsIStringBundle *pBundle);</span>
<a href="#l77.100"></a><span id="l77.100"> </span>
<a href="#l77.101"></a><span id="l77.101" class="difflineminus">-private:</span>
<a href="#l77.102"></a><span id="l77.102" class="difflineplus">+ private:</span>
<a href="#l77.103"></a><span id="l77.103">   nsVCardAddress m_vCard;</span>
<a href="#l77.104"></a><span id="l77.104">   nsCOMPtr&lt;nsIFile&gt; m_fileLoc;</span>
<a href="#l77.105"></a><span id="l77.105">   uint32_t m_bytesImported;</span>
<a href="#l77.106"></a><span id="l77.106">   nsCOMPtr&lt;nsIStringBundle&gt; m_notProxyBundle;</span>
<a href="#l77.107"></a><span id="l77.107"> };</span>
<a href="#l77.108"></a><span id="l77.108"> </span>
<a href="#l77.109"></a><span id="l77.109" class="difflineminus">-nsVCardImport::nsVCardImport()</span>
<a href="#l77.110"></a><span id="l77.110" class="difflineminus">-{</span>
<a href="#l77.111"></a><span id="l77.111" class="difflineminus">-  nsImportStringBundle::GetStringBundle(</span>
<a href="#l77.112"></a><span id="l77.112" class="difflineminus">-      VCARDIMPORT_MSGS_URL, getter_AddRefs(m_stringBundle));</span>
<a href="#l77.113"></a><span id="l77.113" class="difflineplus">+nsVCardImport::nsVCardImport() {</span>
<a href="#l77.114"></a><span id="l77.114" class="difflineplus">+  nsImportStringBundle::GetStringBundle(VCARDIMPORT_MSGS_URL,</span>
<a href="#l77.115"></a><span id="l77.115" class="difflineplus">+                                        getter_AddRefs(m_stringBundle));</span>
<a href="#l77.116"></a><span id="l77.116"> </span>
<a href="#l77.117"></a><span id="l77.117">   IMPORT_LOG0(&quot;nsVCardImport Module Created\n&quot;);</span>
<a href="#l77.118"></a><span id="l77.118"> }</span>
<a href="#l77.119"></a><span id="l77.119"> </span>
<a href="#l77.120"></a><span id="l77.120" class="difflineminus">-nsVCardImport::~nsVCardImport()</span>
<a href="#l77.121"></a><span id="l77.121" class="difflineminus">-{</span>
<a href="#l77.122"></a><span id="l77.122" class="difflineplus">+nsVCardImport::~nsVCardImport() {</span>
<a href="#l77.123"></a><span id="l77.123">   IMPORT_LOG0(&quot;nsVCardImport Module Deleted\n&quot;);</span>
<a href="#l77.124"></a><span id="l77.124"> }</span>
<a href="#l77.125"></a><span id="l77.125"> </span>
<a href="#l77.126"></a><span id="l77.126"> NS_IMPL_ISUPPORTS(nsVCardImport, nsIImportModule)</span>
<a href="#l77.127"></a><span id="l77.127"> </span>
<a href="#l77.128"></a><span id="l77.128" class="difflineminus">-NS_IMETHODIMP nsVCardImport::GetName(char16_t **name)</span>
<a href="#l77.129"></a><span id="l77.129" class="difflineminus">-{</span>
<a href="#l77.130"></a><span id="l77.130" class="difflineplus">+NS_IMETHODIMP nsVCardImport::GetName(char16_t **name) {</span>
<a href="#l77.131"></a><span id="l77.131">   NS_ENSURE_ARG_POINTER(name);</span>
<a href="#l77.132"></a><span id="l77.132" class="difflineminus">-  *name = nsImportStringBundle::GetStringByName(</span>
<a href="#l77.133"></a><span id="l77.133" class="difflineminus">-      &quot;vCardImportName&quot;, m_stringBundle);</span>
<a href="#l77.134"></a><span id="l77.134" class="difflineplus">+  *name =</span>
<a href="#l77.135"></a><span id="l77.135" class="difflineplus">+      nsImportStringBundle::GetStringByName(&quot;vCardImportName&quot;, m_stringBundle);</span>
<a href="#l77.136"></a><span id="l77.136">   return NS_OK;</span>
<a href="#l77.137"></a><span id="l77.137"> }</span>
<a href="#l77.138"></a><span id="l77.138"> </span>
<a href="#l77.139"></a><span id="l77.139" class="difflineminus">-NS_IMETHODIMP nsVCardImport::GetDescription(char16_t **name)</span>
<a href="#l77.140"></a><span id="l77.140" class="difflineminus">-{</span>
<a href="#l77.141"></a><span id="l77.141" class="difflineplus">+NS_IMETHODIMP nsVCardImport::GetDescription(char16_t **name) {</span>
<a href="#l77.142"></a><span id="l77.142">   NS_ENSURE_ARG_POINTER(name);</span>
<a href="#l77.143"></a><span id="l77.143" class="difflineminus">-  *name = nsImportStringBundle::GetStringByName(</span>
<a href="#l77.144"></a><span id="l77.144" class="difflineminus">-      &quot;vCardImportDescription&quot;, m_stringBundle);</span>
<a href="#l77.145"></a><span id="l77.145" class="difflineplus">+  *name = nsImportStringBundle::GetStringByName(&quot;vCardImportDescription&quot;,</span>
<a href="#l77.146"></a><span id="l77.146" class="difflineplus">+                                                m_stringBundle);</span>
<a href="#l77.147"></a><span id="l77.147">   return NS_OK;</span>
<a href="#l77.148"></a><span id="l77.148"> }</span>
<a href="#l77.149"></a><span id="l77.149"> </span>
<a href="#l77.150"></a><span id="l77.150" class="difflineminus">-NS_IMETHODIMP nsVCardImport::GetSupports(char **supports)</span>
<a href="#l77.151"></a><span id="l77.151" class="difflineminus">-{</span>
<a href="#l77.152"></a><span id="l77.152" class="difflineplus">+NS_IMETHODIMP nsVCardImport::GetSupports(char **supports) {</span>
<a href="#l77.153"></a><span id="l77.153">   NS_ENSURE_ARG_POINTER(supports);</span>
<a href="#l77.154"></a><span id="l77.154">   *supports = strdup(NS_IMPORT_ADDRESS_STR);</span>
<a href="#l77.155"></a><span id="l77.155">   return NS_OK;</span>
<a href="#l77.156"></a><span id="l77.156"> }</span>
<a href="#l77.157"></a><span id="l77.157"> </span>
<a href="#l77.158"></a><span id="l77.158" class="difflineminus">-NS_IMETHODIMP nsVCardImport::GetSupportsUpgrade(bool *pUpgrade)</span>
<a href="#l77.159"></a><span id="l77.159" class="difflineminus">-{</span>
<a href="#l77.160"></a><span id="l77.160" class="difflineplus">+NS_IMETHODIMP nsVCardImport::GetSupportsUpgrade(bool *pUpgrade) {</span>
<a href="#l77.161"></a><span id="l77.161">   NS_ENSURE_ARG_POINTER(pUpgrade);</span>
<a href="#l77.162"></a><span id="l77.162">   *pUpgrade = true;</span>
<a href="#l77.163"></a><span id="l77.163">   return NS_OK;</span>
<a href="#l77.164"></a><span id="l77.164"> }</span>
<a href="#l77.165"></a><span id="l77.165"> </span>
<a href="#l77.166"></a><span id="l77.166" class="difflineminus">-NS_IMETHODIMP nsVCardImport::GetImportInterface(</span>
<a href="#l77.167"></a><span id="l77.167" class="difflineminus">-    const char *pImportType, nsISupports **ppInterface)</span>
<a href="#l77.168"></a><span id="l77.168" class="difflineminus">-{</span>
<a href="#l77.169"></a><span id="l77.169" class="difflineplus">+NS_IMETHODIMP nsVCardImport::GetImportInterface(const char *pImportType,</span>
<a href="#l77.170"></a><span id="l77.170" class="difflineplus">+                                                nsISupports **ppInterface) {</span>
<a href="#l77.171"></a><span id="l77.171">   NS_ENSURE_ARG_POINTER(pImportType);</span>
<a href="#l77.172"></a><span id="l77.172">   NS_ENSURE_ARG_POINTER(ppInterface);</span>
<a href="#l77.173"></a><span id="l77.173">   *ppInterface = nullptr;</span>
<a href="#l77.174"></a><span id="l77.174">   if (!strcmp(pImportType, &quot;addressbook&quot;)) {</span>
<a href="#l77.175"></a><span id="l77.175">     nsresult rv;</span>
<a href="#l77.176"></a><span id="l77.176">     // create the nsIImportMail interface and return it!</span>
<a href="#l77.177"></a><span id="l77.177">     nsCOMPtr&lt;nsIImportAddressBooks&gt; pAddress;</span>
<a href="#l77.178"></a><span id="l77.178">     nsCOMPtr&lt;nsIImportGeneric&gt; pGeneric;</span>
<a href="#l77.179"></a><span id="l77.179" class="difflineminus">-    rv = ImportVCardAddressImpl::Create(getter_AddRefs(pAddress), m_stringBundle);</span>
<a href="#l77.180"></a><span id="l77.180" class="difflineplus">+    rv = ImportVCardAddressImpl::Create(getter_AddRefs(pAddress),</span>
<a href="#l77.181"></a><span id="l77.181" class="difflineplus">+                                        m_stringBundle);</span>
<a href="#l77.182"></a><span id="l77.182">     if (NS_SUCCEEDED(rv)) {</span>
<a href="#l77.183"></a><span id="l77.183">       nsCOMPtr&lt;nsIImportService&gt; impSvc(</span>
<a href="#l77.184"></a><span id="l77.184">           do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l77.185"></a><span id="l77.185">       if (NS_SUCCEEDED(rv)) {</span>
<a href="#l77.186"></a><span id="l77.186">         rv = impSvc-&gt;CreateNewGenericAddressBooks(getter_AddRefs(pGeneric));</span>
<a href="#l77.187"></a><span id="l77.187">         if (NS_SUCCEEDED(rv)) {</span>
<a href="#l77.188"></a><span id="l77.188">           pGeneric-&gt;SetData(&quot;addressInterface&quot;, pAddress);</span>
<a href="#l77.189"></a><span id="l77.189">           nsCOMPtr&lt;nsISupports&gt; pInterface(do_QueryInterface(pGeneric));</span>
<a href="#l77.190"></a><span id="l77.190" class="difflineat">@@ -158,81 +154,72 @@ NS_IMETHODIMP nsVCardImport::GetImportIn</span>
<a href="#l77.191"></a><span id="l77.191">         }</span>
<a href="#l77.192"></a><span id="l77.192">       }</span>
<a href="#l77.193"></a><span id="l77.193">     }</span>
<a href="#l77.194"></a><span id="l77.194">     return rv;</span>
<a href="#l77.195"></a><span id="l77.195">   }</span>
<a href="#l77.196"></a><span id="l77.196">   return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l77.197"></a><span id="l77.197"> }</span>
<a href="#l77.198"></a><span id="l77.198"> </span>
<a href="#l77.199"></a><span id="l77.199" class="difflineminus">-nsresult ImportVCardAddressImpl::Create(</span>
<a href="#l77.200"></a><span id="l77.200" class="difflineminus">-    nsIImportAddressBooks** aImport, nsIStringBundle* aStringBundle)</span>
<a href="#l77.201"></a><span id="l77.201" class="difflineminus">-{</span>
<a href="#l77.202"></a><span id="l77.202" class="difflineplus">+nsresult ImportVCardAddressImpl::Create(nsIImportAddressBooks **aImport,</span>
<a href="#l77.203"></a><span id="l77.203" class="difflineplus">+                                        nsIStringBundle *aStringBundle) {</span>
<a href="#l77.204"></a><span id="l77.204">   NS_ENSURE_ARG_POINTER(aImport);</span>
<a href="#l77.205"></a><span id="l77.205">   NS_ADDREF(*aImport = new ImportVCardAddressImpl(aStringBundle));</span>
<a href="#l77.206"></a><span id="l77.206">   return NS_OK;</span>
<a href="#l77.207"></a><span id="l77.207"> }</span>
<a href="#l77.208"></a><span id="l77.208"> </span>
<a href="#l77.209"></a><span id="l77.209" class="difflineminus">-ImportVCardAddressImpl::ImportVCardAddressImpl(</span>
<a href="#l77.210"></a><span id="l77.210" class="difflineminus">-    nsIStringBundle* aStringBundle) : m_notProxyBundle(aStringBundle)</span>
<a href="#l77.211"></a><span id="l77.211" class="difflineminus">-{</span>
<a href="#l77.212"></a><span id="l77.212" class="difflineminus">-}</span>
<a href="#l77.213"></a><span id="l77.213" class="difflineplus">+ImportVCardAddressImpl::ImportVCardAddressImpl(nsIStringBundle *aStringBundle)</span>
<a href="#l77.214"></a><span id="l77.214" class="difflineplus">+    : m_notProxyBundle(aStringBundle) {}</span>
<a href="#l77.215"></a><span id="l77.215"> </span>
<a href="#l77.216"></a><span id="l77.216" class="difflineminus">-ImportVCardAddressImpl::~ImportVCardAddressImpl()</span>
<a href="#l77.217"></a><span id="l77.217" class="difflineminus">-{</span>
<a href="#l77.218"></a><span id="l77.218" class="difflineminus">-}</span>
<a href="#l77.219"></a><span id="l77.219" class="difflineplus">+ImportVCardAddressImpl::~ImportVCardAddressImpl() {}</span>
<a href="#l77.220"></a><span id="l77.220"> </span>
<a href="#l77.221"></a><span id="l77.221"> NS_IMPL_ISUPPORTS(ImportVCardAddressImpl, nsIImportAddressBooks)</span>
<a href="#l77.222"></a><span id="l77.222"> </span>
<a href="#l77.223"></a><span id="l77.223" class="difflineminus">-NS_IMETHODIMP ImportVCardAddressImpl::GetAutoFind(</span>
<a href="#l77.224"></a><span id="l77.224" class="difflineminus">-    char16_t **addrDescription, bool *_retval)</span>
<a href="#l77.225"></a><span id="l77.225" class="difflineminus">-{</span>
<a href="#l77.226"></a><span id="l77.226" class="difflineplus">+NS_IMETHODIMP ImportVCardAddressImpl::GetAutoFind(char16_t **addrDescription,</span>
<a href="#l77.227"></a><span id="l77.227" class="difflineplus">+                                                  bool *_retval) {</span>
<a href="#l77.228"></a><span id="l77.228">   NS_ENSURE_ARG_POINTER(addrDescription);</span>
<a href="#l77.229"></a><span id="l77.229">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l77.230"></a><span id="l77.230"> </span>
<a href="#l77.231"></a><span id="l77.231">   nsString str;</span>
<a href="#l77.232"></a><span id="l77.232">   *_retval = false;</span>
<a href="#l77.233"></a><span id="l77.233"> </span>
<a href="#l77.234"></a><span id="l77.234" class="difflineminus">-  if (!m_notProxyBundle)</span>
<a href="#l77.235"></a><span id="l77.235" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l77.236"></a><span id="l77.236" class="difflineplus">+  if (!m_notProxyBundle) return NS_ERROR_FAILURE;</span>
<a href="#l77.237"></a><span id="l77.237"> </span>
<a href="#l77.238"></a><span id="l77.238" class="difflineminus">-  nsImportStringBundle::GetStringByName(&quot;vCardImportAddressName&quot;, m_notProxyBundle, str);</span>
<a href="#l77.239"></a><span id="l77.239" class="difflineplus">+  nsImportStringBundle::GetStringByName(&quot;vCardImportAddressName&quot;,</span>
<a href="#l77.240"></a><span id="l77.240" class="difflineplus">+                                        m_notProxyBundle, str);</span>
<a href="#l77.241"></a><span id="l77.241">   *addrDescription = ToNewUnicode(str);</span>
<a href="#l77.242"></a><span id="l77.242">   return NS_OK;</span>
<a href="#l77.243"></a><span id="l77.243"> }</span>
<a href="#l77.244"></a><span id="l77.244"> </span>
<a href="#l77.245"></a><span id="l77.245" class="difflineminus">-NS_IMETHODIMP ImportVCardAddressImpl::GetDefaultLocation(</span>
<a href="#l77.246"></a><span id="l77.246" class="difflineminus">-    nsIFile **ppLoc, bool *found, bool *userVerify)</span>
<a href="#l77.247"></a><span id="l77.247" class="difflineminus">-{</span>
<a href="#l77.248"></a><span id="l77.248" class="difflineplus">+NS_IMETHODIMP ImportVCardAddressImpl::GetDefaultLocation(nsIFile **ppLoc,</span>
<a href="#l77.249"></a><span id="l77.249" class="difflineplus">+                                                         bool *found,</span>
<a href="#l77.250"></a><span id="l77.250" class="difflineplus">+                                                         bool *userVerify) {</span>
<a href="#l77.251"></a><span id="l77.251">   NS_ENSURE_ARG_POINTER(found);</span>
<a href="#l77.252"></a><span id="l77.252">   NS_ENSURE_ARG_POINTER(ppLoc);</span>
<a href="#l77.253"></a><span id="l77.253">   NS_ENSURE_ARG_POINTER(userVerify);</span>
<a href="#l77.254"></a><span id="l77.254"> </span>
<a href="#l77.255"></a><span id="l77.255">   *ppLoc = nullptr;</span>
<a href="#l77.256"></a><span id="l77.256">   *found = false;</span>
<a href="#l77.257"></a><span id="l77.257">   *userVerify = true;</span>
<a href="#l77.258"></a><span id="l77.258">   return NS_OK;</span>
<a href="#l77.259"></a><span id="l77.259"> }</span>
<a href="#l77.260"></a><span id="l77.260"> </span>
<a href="#l77.261"></a><span id="l77.261" class="difflineminus">-NS_IMETHODIMP ImportVCardAddressImpl::FindAddressBooks(</span>
<a href="#l77.262"></a><span id="l77.262" class="difflineminus">-    nsIFile *pLoc, nsIArray **ppArray)</span>
<a href="#l77.263"></a><span id="l77.263" class="difflineminus">-{</span>
<a href="#l77.264"></a><span id="l77.264" class="difflineplus">+NS_IMETHODIMP ImportVCardAddressImpl::FindAddressBooks(nsIFile *pLoc,</span>
<a href="#l77.265"></a><span id="l77.265" class="difflineplus">+                                                       nsIArray **ppArray) {</span>
<a href="#l77.266"></a><span id="l77.266">   NS_ENSURE_ARG_POINTER(pLoc);</span>
<a href="#l77.267"></a><span id="l77.267">   NS_ENSURE_ARG_POINTER(ppArray);</span>
<a href="#l77.268"></a><span id="l77.268"> </span>
<a href="#l77.269"></a><span id="l77.269">   *ppArray = nullptr;</span>
<a href="#l77.270"></a><span id="l77.270">   bool exists = false;</span>
<a href="#l77.271"></a><span id="l77.271">   nsresult rv = pLoc-&gt;Exists(&amp;exists);</span>
<a href="#l77.272"></a><span id="l77.272" class="difflineminus">-  if (NS_FAILED(rv) || !exists)</span>
<a href="#l77.273"></a><span id="l77.273" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l77.274"></a><span id="l77.274" class="difflineplus">+  if (NS_FAILED(rv) || !exists) return NS_ERROR_FAILURE;</span>
<a href="#l77.275"></a><span id="l77.275"> </span>
<a href="#l77.276"></a><span id="l77.276">   bool isFile = false;</span>
<a href="#l77.277"></a><span id="l77.277">   rv = pLoc-&gt;IsFile(&amp;isFile);</span>
<a href="#l77.278"></a><span id="l77.278" class="difflineminus">-  if (NS_FAILED(rv) || !isFile)</span>
<a href="#l77.279"></a><span id="l77.279" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l77.280"></a><span id="l77.280" class="difflineplus">+  if (NS_FAILED(rv) || !isFile) return NS_ERROR_FAILURE;</span>
<a href="#l77.281"></a><span id="l77.281"> </span>
<a href="#l77.282"></a><span id="l77.282">   m_fileLoc = pLoc;</span>
<a href="#l77.283"></a><span id="l77.283"> </span>
<a href="#l77.284"></a><span id="l77.284">   /* Build an address book descriptor based on the file passed in! */</span>
<a href="#l77.285"></a><span id="l77.285">   nsCOMPtr&lt;nsIMutableArray&gt; array(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l77.286"></a><span id="l77.286">   if (NS_FAILED(rv)) {</span>
<a href="#l77.287"></a><span id="l77.287">     IMPORT_LOG0(&quot;FAILED to allocate the nsIMutableArray\n&quot;);</span>
<a href="#l77.288"></a><span id="l77.288">     return rv;</span>
<a href="#l77.289"></a><span id="l77.289" class="difflineat">@@ -245,102 +232,88 @@ NS_IMETHODIMP ImportVCardAddressImpl::Fi</span>
<a href="#l77.290"></a><span id="l77.290">     return rv;</span>
<a href="#l77.291"></a><span id="l77.291">   }</span>
<a href="#l77.292"></a><span id="l77.292"> </span>
<a href="#l77.293"></a><span id="l77.293">   int32_t idx = name.RFindChar('.');</span>
<a href="#l77.294"></a><span id="l77.294">   if ((idx != -1) &amp;&amp; (idx &gt; 0) &amp;&amp; ((name.Length() - idx - 1) &lt; 5)) {</span>
<a href="#l77.295"></a><span id="l77.295">     name.SetLength(idx);</span>
<a href="#l77.296"></a><span id="l77.296">   }</span>
<a href="#l77.297"></a><span id="l77.297"> </span>
<a href="#l77.298"></a><span id="l77.298" class="difflineminus">-  nsCOMPtr&lt;nsIImportABDescriptor&gt;  desc;</span>
<a href="#l77.299"></a><span id="l77.299" class="difflineplus">+  nsCOMPtr&lt;nsIImportABDescriptor&gt; desc;</span>
<a href="#l77.300"></a><span id="l77.300">   nsCOMPtr&lt;nsIImportService&gt; impSvc(</span>
<a href="#l77.301"></a><span id="l77.301">       do_GetService(NS_IMPORTSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l77.302"></a><span id="l77.302">   if (NS_FAILED(rv)) {</span>
<a href="#l77.303"></a><span id="l77.303">     IMPORT_LOG0(&quot;*** Failed to obtain the import service\n&quot;);</span>
<a href="#l77.304"></a><span id="l77.304">     return rv;</span>
<a href="#l77.305"></a><span id="l77.305">   }</span>
<a href="#l77.306"></a><span id="l77.306"> </span>
<a href="#l77.307"></a><span id="l77.307">   rv = impSvc-&gt;CreateNewABDescriptor(getter_AddRefs(desc));</span>
<a href="#l77.308"></a><span id="l77.308">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l77.309"></a><span id="l77.309">     int64_t sz = 0;</span>
<a href="#l77.310"></a><span id="l77.310">     pLoc-&gt;GetFileSize(&amp;sz);</span>
<a href="#l77.311"></a><span id="l77.311">     desc-&gt;SetPreferredName(name);</span>
<a href="#l77.312"></a><span id="l77.312" class="difflineminus">-    desc-&gt;SetSize((uint32_t) sz);</span>
<a href="#l77.313"></a><span id="l77.313" class="difflineplus">+    desc-&gt;SetSize((uint32_t)sz);</span>
<a href="#l77.314"></a><span id="l77.314">     desc-&gt;SetAbFile(m_fileLoc);</span>
<a href="#l77.315"></a><span id="l77.315">     nsCOMPtr&lt;nsISupports&gt; pInterface(do_QueryInterface(desc, &amp;rv));</span>
<a href="#l77.316"></a><span id="l77.316">     array-&gt;AppendElement(pInterface);</span>
<a href="#l77.317"></a><span id="l77.317">   }</span>
<a href="#l77.318"></a><span id="l77.318">   if (NS_FAILED(rv)) {</span>
<a href="#l77.319"></a><span id="l77.319">     IMPORT_LOG0(</span>
<a href="#l77.320"></a><span id="l77.320">         &quot;*** Error creating address book descriptor for vCard import\n&quot;);</span>
<a href="#l77.321"></a><span id="l77.321">     return rv;</span>
<a href="#l77.322"></a><span id="l77.322">   }</span>
<a href="#l77.323"></a><span id="l77.323"> </span>
<a href="#l77.324"></a><span id="l77.324">   array.forget(ppArray);</span>
<a href="#l77.325"></a><span id="l77.325">   return NS_OK;</span>
<a href="#l77.326"></a><span id="l77.326"> }</span>
<a href="#l77.327"></a><span id="l77.327"> </span>
<a href="#l77.328"></a><span id="l77.328" class="difflineminus">-void ImportVCardAddressImpl::ReportSuccess(</span>
<a href="#l77.329"></a><span id="l77.329" class="difflineminus">-    nsString&amp; name, nsString *pStream, nsIStringBundle* pBundle)</span>
<a href="#l77.330"></a><span id="l77.330" class="difflineminus">-{</span>
<a href="#l77.331"></a><span id="l77.331" class="difflineminus">-  if (!pStream)</span>
<a href="#l77.332"></a><span id="l77.332" class="difflineminus">-    return;</span>
<a href="#l77.333"></a><span id="l77.333" class="difflineplus">+void ImportVCardAddressImpl::ReportSuccess(nsString &amp;name, nsString *pStream,</span>
<a href="#l77.334"></a><span id="l77.334" class="difflineplus">+                                           nsIStringBundle *pBundle) {</span>
<a href="#l77.335"></a><span id="l77.335" class="difflineplus">+  if (!pStream) return;</span>
<a href="#l77.336"></a><span id="l77.336"> </span>
<a href="#l77.337"></a><span id="l77.337">   // load the success string</span>
<a href="#l77.338"></a><span id="l77.338">   char16_t *pFmt = nsImportStringBundle::GetStringByName(</span>
<a href="#l77.339"></a><span id="l77.339">       &quot;vCardImportAddressSuccess&quot;, pBundle);</span>
<a href="#l77.340"></a><span id="l77.340"> </span>
<a href="#l77.341"></a><span id="l77.341">   nsString pText;</span>
<a href="#l77.342"></a><span id="l77.342">   nsTextFormatter::ssprintf(pText, pFmt, name.get());</span>
<a href="#l77.343"></a><span id="l77.343">   pStream-&gt;Append(pText);</span>
<a href="#l77.344"></a><span id="l77.344">   free(pFmt);</span>
<a href="#l77.345"></a><span id="l77.345">   pStream-&gt;Append(char16_t('\n'));</span>
<a href="#l77.346"></a><span id="l77.346"> }</span>
<a href="#l77.347"></a><span id="l77.347"> </span>
<a href="#l77.348"></a><span id="l77.348" class="difflineminus">-void ImportVCardAddressImpl::ReportError(</span>
<a href="#l77.349"></a><span id="l77.349" class="difflineminus">-    const char *errorName, nsString&amp; name, nsString *pStream,</span>
<a href="#l77.350"></a><span id="l77.350" class="difflineminus">-    nsIStringBundle* pBundle)</span>
<a href="#l77.351"></a><span id="l77.351" class="difflineminus">-{</span>
<a href="#l77.352"></a><span id="l77.352" class="difflineminus">-  if (!pStream)</span>
<a href="#l77.353"></a><span id="l77.353" class="difflineminus">-    return;</span>
<a href="#l77.354"></a><span id="l77.354" class="difflineplus">+void ImportVCardAddressImpl::ReportError(const char *errorName, nsString &amp;name,</span>
<a href="#l77.355"></a><span id="l77.355" class="difflineplus">+                                         nsString *pStream,</span>
<a href="#l77.356"></a><span id="l77.356" class="difflineplus">+                                         nsIStringBundle *pBundle) {</span>
<a href="#l77.357"></a><span id="l77.357" class="difflineplus">+  if (!pStream) return;</span>
<a href="#l77.358"></a><span id="l77.358"> </span>
<a href="#l77.359"></a><span id="l77.359">   // load the error string</span>
<a href="#l77.360"></a><span id="l77.360">   char16_t *pFmt = nsImportStringBundle::GetStringByName(errorName, pBundle);</span>
<a href="#l77.361"></a><span id="l77.361">   nsString pText;</span>
<a href="#l77.362"></a><span id="l77.362">   nsTextFormatter::ssprintf(pText, pFmt, name.get());</span>
<a href="#l77.363"></a><span id="l77.363">   pStream-&gt;Append(pText);</span>
<a href="#l77.364"></a><span id="l77.364">   free(pFmt);</span>
<a href="#l77.365"></a><span id="l77.365">   pStream-&gt;Append(char16_t('\n'));</span>
<a href="#l77.366"></a><span id="l77.366"> }</span>
<a href="#l77.367"></a><span id="l77.367"> </span>
<a href="#l77.368"></a><span id="l77.368" class="difflineminus">-void ImportVCardAddressImpl::SetLogs(</span>
<a href="#l77.369"></a><span id="l77.369" class="difflineminus">-    nsString&amp; success, nsString&amp; error,</span>
<a href="#l77.370"></a><span id="l77.370" class="difflineminus">-    char16_t **pError, char16_t **pSuccess)</span>
<a href="#l77.371"></a><span id="l77.371" class="difflineminus">-{</span>
<a href="#l77.372"></a><span id="l77.372" class="difflineminus">-  if (pError)</span>
<a href="#l77.373"></a><span id="l77.373" class="difflineminus">-    *pError = ToNewUnicode(error);</span>
<a href="#l77.374"></a><span id="l77.374" class="difflineminus">-  if (pSuccess)</span>
<a href="#l77.375"></a><span id="l77.375" class="difflineminus">-    *pSuccess = ToNewUnicode(success);</span>
<a href="#l77.376"></a><span id="l77.376" class="difflineplus">+void ImportVCardAddressImpl::SetLogs(nsString &amp;success, nsString &amp;error,</span>
<a href="#l77.377"></a><span id="l77.377" class="difflineplus">+                                     char16_t **pError, char16_t **pSuccess) {</span>
<a href="#l77.378"></a><span id="l77.378" class="difflineplus">+  if (pError) *pError = ToNewUnicode(error);</span>
<a href="#l77.379"></a><span id="l77.379" class="difflineplus">+  if (pSuccess) *pSuccess = ToNewUnicode(success);</span>
<a href="#l77.380"></a><span id="l77.380"> }</span>
<a href="#l77.381"></a><span id="l77.381"> </span>
<a href="#l77.382"></a><span id="l77.382"> NS_IMETHODIMP ImportVCardAddressImpl::ImportAddressBook(</span>
<a href="#l77.383"></a><span id="l77.383" class="difflineminus">-    nsIImportABDescriptor *pSource,</span>
<a href="#l77.384"></a><span id="l77.384" class="difflineminus">-    nsIAddrDatabase *pDestination,</span>
<a href="#l77.385"></a><span id="l77.385" class="difflineminus">-    nsIImportFieldMap *fieldMap,</span>
<a href="#l77.386"></a><span id="l77.386" class="difflineminus">-    nsISupports *aSupportService,</span>
<a href="#l77.387"></a><span id="l77.387" class="difflineminus">-    char16_t ** pErrorLog,</span>
<a href="#l77.388"></a><span id="l77.388" class="difflineminus">-    char16_t ** pSuccessLog,</span>
<a href="#l77.389"></a><span id="l77.389" class="difflineminus">-    bool * fatalError)</span>
<a href="#l77.390"></a><span id="l77.390" class="difflineminus">-{</span>
<a href="#l77.391"></a><span id="l77.391" class="difflineplus">+    nsIImportABDescriptor *pSource, nsIAddrDatabase *pDestination,</span>
<a href="#l77.392"></a><span id="l77.392" class="difflineplus">+    nsIImportFieldMap *fieldMap, nsISupports *aSupportService,</span>
<a href="#l77.393"></a><span id="l77.393" class="difflineplus">+    char16_t **pErrorLog, char16_t **pSuccessLog, bool *fatalError) {</span>
<a href="#l77.394"></a><span id="l77.394">   NS_ENSURE_ARG_POINTER(pSource);</span>
<a href="#l77.395"></a><span id="l77.395">   NS_ENSURE_ARG_POINTER(pDestination);</span>
<a href="#l77.396"></a><span id="l77.396">   NS_ENSURE_ARG_POINTER(fatalError);</span>
<a href="#l77.397"></a><span id="l77.397"> </span>
<a href="#l77.398"></a><span id="l77.398" class="difflineminus">-  if (!m_notProxyBundle)</span>
<a href="#l77.399"></a><span id="l77.399" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l77.400"></a><span id="l77.400" class="difflineplus">+  if (!m_notProxyBundle) return NS_ERROR_FAILURE;</span>
<a href="#l77.401"></a><span id="l77.401"> </span>
<a href="#l77.402"></a><span id="l77.402">   m_bytesImported = 0;</span>
<a href="#l77.403"></a><span id="l77.403">   nsString success, error;</span>
<a href="#l77.404"></a><span id="l77.404">   bool addrAbort = false;</span>
<a href="#l77.405"></a><span id="l77.405">   nsString name;</span>
<a href="#l77.406"></a><span id="l77.406">   pSource-&gt;GetPreferredName(name);</span>
<a href="#l77.407"></a><span id="l77.407"> </span>
<a href="#l77.408"></a><span id="l77.408">   uint32_t addressSize = 0;</span>
<a href="#l77.409"></a><span id="l77.409" class="difflineat">@@ -349,40 +322,40 @@ NS_IMETHODIMP ImportVCardAddressImpl::Im</span>
<a href="#l77.410"></a><span id="l77.410">     IMPORT_LOG0(&quot;Address book size is 0, skipping import.\n&quot;);</span>
<a href="#l77.411"></a><span id="l77.411">     ReportSuccess(name, &amp;success, m_notProxyBundle);</span>
<a href="#l77.412"></a><span id="l77.412">     SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l77.413"></a><span id="l77.413">     return NS_OK;</span>
<a href="#l77.414"></a><span id="l77.414">   }</span>
<a href="#l77.415"></a><span id="l77.415"> </span>
<a href="#l77.416"></a><span id="l77.416">   nsCOMPtr&lt;nsIFile&gt; inFile;</span>
<a href="#l77.417"></a><span id="l77.417">   if (NS_FAILED(pSource-&gt;GetAbFile(getter_AddRefs(inFile)))) {</span>
<a href="#l77.418"></a><span id="l77.418" class="difflineminus">-    ReportError(&quot;vCardImportAddressBadSourceFile&quot;, name, &amp;error, m_notProxyBundle);</span>
<a href="#l77.419"></a><span id="l77.419" class="difflineplus">+    ReportError(&quot;vCardImportAddressBadSourceFile&quot;, name, &amp;error,</span>
<a href="#l77.420"></a><span id="l77.420" class="difflineplus">+                m_notProxyBundle);</span>
<a href="#l77.421"></a><span id="l77.421">     SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l77.422"></a><span id="l77.422">     return NS_ERROR_FAILURE;</span>
<a href="#l77.423"></a><span id="l77.423">   }</span>
<a href="#l77.424"></a><span id="l77.424"> </span>
<a href="#l77.425"></a><span id="l77.425">   if (!aSupportService) {</span>
<a href="#l77.426"></a><span id="l77.426">     IMPORT_LOG0(&quot;Missing support service to import call\n&quot;);</span>
<a href="#l77.427"></a><span id="l77.427">     return NS_ERROR_FAILURE;</span>
<a href="#l77.428"></a><span id="l77.428">   }</span>
<a href="#l77.429"></a><span id="l77.429"> </span>
<a href="#l77.430"></a><span id="l77.430" class="difflineminus">-  nsresult rv = m_vCard.ImportAddresses(</span>
<a href="#l77.431"></a><span id="l77.431" class="difflineminus">-      &amp;addrAbort, name.get(), inFile, pDestination, error, &amp;m_bytesImported);</span>
<a href="#l77.432"></a><span id="l77.432" class="difflineplus">+  nsresult rv = m_vCard.ImportAddresses(&amp;addrAbort, name.get(), inFile,</span>
<a href="#l77.433"></a><span id="l77.433" class="difflineplus">+                                        pDestination, error, &amp;m_bytesImported);</span>
<a href="#l77.434"></a><span id="l77.434"> </span>
<a href="#l77.435"></a><span id="l77.435">   if (NS_SUCCEEDED(rv) &amp;&amp; error.IsEmpty()) {</span>
<a href="#l77.436"></a><span id="l77.436">     ReportSuccess(name, &amp;success, m_notProxyBundle);</span>
<a href="#l77.437"></a><span id="l77.437">     SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l77.438"></a><span id="l77.438" class="difflineminus">-  }</span>
<a href="#l77.439"></a><span id="l77.439" class="difflineminus">-  else {</span>
<a href="#l77.440"></a><span id="l77.440" class="difflineminus">-    ReportError(&quot;vCardImportAddressConvertError&quot;, name, &amp;error, m_notProxyBundle);</span>
<a href="#l77.441"></a><span id="l77.441" class="difflineplus">+  } else {</span>
<a href="#l77.442"></a><span id="l77.442" class="difflineplus">+    ReportError(&quot;vCardImportAddressConvertError&quot;, name, &amp;error,</span>
<a href="#l77.443"></a><span id="l77.443" class="difflineplus">+                m_notProxyBundle);</span>
<a href="#l77.444"></a><span id="l77.444">     SetLogs(success, error, pErrorLog, pSuccessLog);</span>
<a href="#l77.445"></a><span id="l77.445">   }</span>
<a href="#l77.446"></a><span id="l77.446"> </span>
<a href="#l77.447"></a><span id="l77.447">   IMPORT_LOG0(&quot;*** VCard address import done\n&quot;);</span>
<a href="#l77.448"></a><span id="l77.448">   return rv;</span>
<a href="#l77.449"></a><span id="l77.449"> }</span>
<a href="#l77.450"></a><span id="l77.450"> </span>
<a href="#l77.451"></a><span id="l77.451" class="difflineminus">-NS_IMETHODIMP ImportVCardAddressImpl::GetImportProgress(uint32_t *_retval)</span>
<a href="#l77.452"></a><span id="l77.452" class="difflineminus">-{</span>
<a href="#l77.453"></a><span id="l77.453" class="difflineplus">+NS_IMETHODIMP ImportVCardAddressImpl::GetImportProgress(uint32_t *_retval) {</span>
<a href="#l77.454"></a><span id="l77.454">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l77.455"></a><span id="l77.455">   *_retval = m_bytesImported;</span>
<a href="#l77.456"></a><span id="l77.456">   return NS_OK;</span>
<a href="#l77.457"></a><span id="l77.457"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l78.1"></a><span id="l78.1" class="difflineminus">--- a/mailnews/import/vcard/src/nsVCardImport.h</span>
<a href="#l78.2"></a><span id="l78.2" class="difflineplus">+++ b/mailnews/import/vcard/src/nsVCardImport.h</span>
<a href="#l78.3"></a><span id="l78.3" class="difflineat">@@ -4,35 +4,36 @@</span>
<a href="#l78.4"></a><span id="l78.4"> </span>
<a href="#l78.5"></a><span id="l78.5"> #ifndef nsVCardImport_h___</span>
<a href="#l78.6"></a><span id="l78.6"> #define nsVCardImport_h___</span>
<a href="#l78.7"></a><span id="l78.7"> </span>
<a href="#l78.8"></a><span id="l78.8"> #include &quot;nsIImportModule.h&quot;</span>
<a href="#l78.9"></a><span id="l78.9"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l78.10"></a><span id="l78.10"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l78.11"></a><span id="l78.11"> </span>
<a href="#l78.12"></a><span id="l78.12" class="difflineminus">-#define NS_VCARDIMPORT_CID \</span>
<a href="#l78.13"></a><span id="l78.13" class="difflineminus">-{ /* 0EB034A3-964A-4E2F-92EBCC55D9AE9DD2 */ \</span>
<a href="#l78.14"></a><span id="l78.14" class="difflineminus">-  0x0eb034a3, 0x964a, 0x4e2f, \</span>
<a href="#l78.15"></a><span id="l78.15" class="difflineminus">-  {0x92, 0xeb, 0xcc, 0x55, 0xd9, 0xae, 0x9d, 0xd2}}</span>
<a href="#l78.16"></a><span id="l78.16" class="difflineplus">+#define NS_VCARDIMPORT_CID                           \</span>
<a href="#l78.17"></a><span id="l78.17" class="difflineplus">+  { /* 0EB034A3-964A-4E2F-92EBCC55D9AE9DD2 */        \</span>
<a href="#l78.18"></a><span id="l78.18" class="difflineplus">+    0x0eb034a3, 0x964a, 0x4e2f, {                    \</span>
<a href="#l78.19"></a><span id="l78.19" class="difflineplus">+      0x92, 0xeb, 0xcc, 0x55, 0xd9, 0xae, 0x9d, 0xd2 \</span>
<a href="#l78.20"></a><span id="l78.20" class="difflineplus">+    }                                                \</span>
<a href="#l78.21"></a><span id="l78.21" class="difflineplus">+  }</span>
<a href="#l78.22"></a><span id="l78.22"> </span>
<a href="#l78.23"></a><span id="l78.23" class="difflineminus">-#define VCARDIMPORT_MSGS_URL &quot;chrome://messenger/locale/vCardImportMsgs.properties&quot;</span>
<a href="#l78.24"></a><span id="l78.24" class="difflineplus">+#define VCARDIMPORT_MSGS_URL \</span>
<a href="#l78.25"></a><span id="l78.25" class="difflineplus">+  &quot;chrome://messenger/locale/vCardImportMsgs.properties&quot;</span>
<a href="#l78.26"></a><span id="l78.26"> </span>
<a href="#l78.27"></a><span id="l78.27" class="difflineminus">-class nsVCardImport : public nsIImportModule</span>
<a href="#l78.28"></a><span id="l78.28" class="difflineminus">-{</span>
<a href="#l78.29"></a><span id="l78.29" class="difflineminus">-public:</span>
<a href="#l78.30"></a><span id="l78.30" class="difflineminus">-</span>
<a href="#l78.31"></a><span id="l78.31" class="difflineplus">+class nsVCardImport : public nsIImportModule {</span>
<a href="#l78.32"></a><span id="l78.32" class="difflineplus">+ public:</span>
<a href="#l78.33"></a><span id="l78.33">   nsVCardImport();</span>
<a href="#l78.34"></a><span id="l78.34"> </span>
<a href="#l78.35"></a><span id="l78.35">   NS_DECL_ISUPPORTS</span>
<a href="#l78.36"></a><span id="l78.36"> </span>
<a href="#l78.37"></a><span id="l78.37">   ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l78.38"></a><span id="l78.38">   // we support the nsIImportModule interface</span>
<a href="#l78.39"></a><span id="l78.39">   ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l78.40"></a><span id="l78.40"> </span>
<a href="#l78.41"></a><span id="l78.41">   NS_DECL_NSIIMPORTMODULE</span>
<a href="#l78.42"></a><span id="l78.42"> </span>
<a href="#l78.43"></a><span id="l78.43" class="difflineminus">-protected:</span>
<a href="#l78.44"></a><span id="l78.44" class="difflineplus">+ protected:</span>
<a href="#l78.45"></a><span id="l78.45">   virtual ~nsVCardImport();</span>
<a href="#l78.46"></a><span id="l78.46">   nsCOMPtr&lt;nsIStringBundle&gt; m_stringBundle;</span>
<a href="#l78.47"></a><span id="l78.47"> };</span>
<a href="#l78.48"></a><span id="l78.48"> </span>
<a href="#l78.49"></a><span id="l78.49"> #endif /* nsVCardImport_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l79.1"></a><span id="l79.1" class="difflineminus">--- a/mailnews/import/winlivemail/nsWMImport.cpp</span>
<a href="#l79.2"></a><span id="l79.2" class="difflineplus">+++ b/mailnews/import/winlivemail/nsWMImport.cpp</span>
<a href="#l79.3"></a><span id="l79.3" class="difflineat">@@ -16,110 +16,101 @@</span>
<a href="#l79.4"></a><span id="l79.4"> #include &quot;nsXPCOM.h&quot;</span>
<a href="#l79.5"></a><span id="l79.5"> #include &quot;nsWMSettings.h&quot;</span>
<a href="#l79.6"></a><span id="l79.6"> #include &quot;nsTextFormatter.h&quot;</span>
<a href="#l79.7"></a><span id="l79.7"> #include &quot;nsWMStringBundle.h&quot;</span>
<a href="#l79.8"></a><span id="l79.8"> #include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l79.9"></a><span id="l79.9"> </span>
<a href="#l79.10"></a><span id="l79.10"> #include &quot;ImportDebug.h&quot;</span>
<a href="#l79.11"></a><span id="l79.11"> </span>
<a href="#l79.12"></a><span id="l79.12" class="difflineminus">-class ImportWMMailImpl : public nsIImportMail</span>
<a href="#l79.13"></a><span id="l79.13" class="difflineminus">-{</span>
<a href="#l79.14"></a><span id="l79.14" class="difflineminus">-public:</span>
<a href="#l79.15"></a><span id="l79.15" class="difflineplus">+class ImportWMMailImpl : public nsIImportMail {</span>
<a href="#l79.16"></a><span id="l79.16" class="difflineplus">+ public:</span>
<a href="#l79.17"></a><span id="l79.17">   ImportWMMailImpl();</span>
<a href="#l79.18"></a><span id="l79.18"> </span>
<a href="#l79.19"></a><span id="l79.19" class="difflineminus">-  static nsresult Create(nsIImportMail** aImport);</span>
<a href="#l79.20"></a><span id="l79.20" class="difflineplus">+  static nsresult Create(nsIImportMail **aImport);</span>
<a href="#l79.21"></a><span id="l79.21"> </span>
<a href="#l79.22"></a><span id="l79.22">   // nsISupports interface</span>
<a href="#l79.23"></a><span id="l79.23">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l79.24"></a><span id="l79.24"> </span>
<a href="#l79.25"></a><span id="l79.25">   // nsIImportmail interface</span>
<a href="#l79.26"></a><span id="l79.26"> </span>
<a href="#l79.27"></a><span id="l79.27" class="difflineminus">-  /* void GetDefaultLocation (out nsIFile location, out boolean found, out boolean userVerify); */</span>
<a href="#l79.28"></a><span id="l79.28" class="difflineminus">-  NS_IMETHOD GetDefaultLocation(nsIFile **location, bool *found, bool *userVerify);</span>
<a href="#l79.29"></a><span id="l79.29" class="difflineplus">+  /* void GetDefaultLocation (out nsIFile location, out boolean found, out</span>
<a href="#l79.30"></a><span id="l79.30" class="difflineplus">+   * boolean userVerify); */</span>
<a href="#l79.31"></a><span id="l79.31" class="difflineplus">+  NS_IMETHOD GetDefaultLocation(nsIFile **location, bool *found,</span>
<a href="#l79.32"></a><span id="l79.32" class="difflineplus">+                                bool *userVerify);</span>
<a href="#l79.33"></a><span id="l79.33"> </span>
<a href="#l79.34"></a><span id="l79.34">   /* nsIArray FindMailboxes (in nsIFile location); */</span>
<a href="#l79.35"></a><span id="l79.35">   NS_IMETHOD FindMailboxes(nsIFile *location, nsIArray **_retval);</span>
<a href="#l79.36"></a><span id="l79.36"> </span>
<a href="#l79.37"></a><span id="l79.37">   NS_IMETHOD ImportMailbox(nsIImportMailboxDescriptor *source,</span>
<a href="#l79.38"></a><span id="l79.38" class="difflineminus">-                           nsIMsgFolder *dstFolder,</span>
<a href="#l79.39"></a><span id="l79.39" class="difflineminus">-                           char16_t **pErrorLog, char16_t **pSuccessLog,</span>
<a href="#l79.40"></a><span id="l79.40" class="difflineminus">-                           bool *fatalError);</span>
<a href="#l79.41"></a><span id="l79.41" class="difflineplus">+                           nsIMsgFolder *dstFolder, char16_t **pErrorLog,</span>
<a href="#l79.42"></a><span id="l79.42" class="difflineplus">+                           char16_t **pSuccessLog, bool *fatalError);</span>
<a href="#l79.43"></a><span id="l79.43"> </span>
<a href="#l79.44"></a><span id="l79.44">   /* unsigned long GetImportProgress (); */</span>
<a href="#l79.45"></a><span id="l79.45">   NS_IMETHOD GetImportProgress(uint32_t *_retval);</span>
<a href="#l79.46"></a><span id="l79.46"> </span>
<a href="#l79.47"></a><span id="l79.47" class="difflineminus">-  NS_IMETHOD TranslateFolderName(const nsAString &amp; aFolderName, nsAString &amp; _retval);</span>
<a href="#l79.48"></a><span id="l79.48" class="difflineplus">+  NS_IMETHOD TranslateFolderName(const nsAString &amp;aFolderName,</span>
<a href="#l79.49"></a><span id="l79.49" class="difflineplus">+                                 nsAString &amp;_retval);</span>
<a href="#l79.50"></a><span id="l79.50"> </span>
<a href="#l79.51"></a><span id="l79.51" class="difflineminus">-public:</span>
<a href="#l79.52"></a><span id="l79.52" class="difflineminus">-  static void ReportSuccess(nsString&amp; name, int32_t count, nsString *pStream);</span>
<a href="#l79.53"></a><span id="l79.53" class="difflineminus">-  static void ReportError(int32_t errorNum, nsString&amp; name, nsString *pStream);</span>
<a href="#l79.54"></a><span id="l79.54" class="difflineplus">+ public:</span>
<a href="#l79.55"></a><span id="l79.55" class="difflineplus">+  static void ReportSuccess(nsString &amp;name, int32_t count, nsString *pStream);</span>
<a href="#l79.56"></a><span id="l79.56" class="difflineplus">+  static void ReportError(int32_t errorNum, nsString &amp;name, nsString *pStream);</span>
<a href="#l79.57"></a><span id="l79.57">   static void AddLinebreak(nsString *pStream);</span>
<a href="#l79.58"></a><span id="l79.58" class="difflineminus">-  static void SetLogs(nsString&amp; success, nsString&amp; error, char16_t **pError, char16_t **pSuccess);</span>
<a href="#l79.59"></a><span id="l79.59" class="difflineplus">+  static void SetLogs(nsString &amp;success, nsString &amp;error, char16_t **pError,</span>
<a href="#l79.60"></a><span id="l79.60" class="difflineplus">+                      char16_t **pSuccess);</span>
<a href="#l79.61"></a><span id="l79.61"> </span>
<a href="#l79.62"></a><span id="l79.62" class="difflineminus">-private:</span>
<a href="#l79.63"></a><span id="l79.63" class="difflineplus">+ private:</span>
<a href="#l79.64"></a><span id="l79.64">   virtual ~ImportWMMailImpl();</span>
<a href="#l79.65"></a><span id="l79.65"> };</span>
<a href="#l79.66"></a><span id="l79.66"> </span>
<a href="#l79.67"></a><span id="l79.67" class="difflineminus">-nsWMImport::nsWMImport()</span>
<a href="#l79.68"></a><span id="l79.68" class="difflineminus">-{</span>
<a href="#l79.69"></a><span id="l79.69" class="difflineplus">+nsWMImport::nsWMImport() {</span>
<a href="#l79.70"></a><span id="l79.70">   IMPORT_LOG0(&quot;nsWMImport Module Created\n&quot;);</span>
<a href="#l79.71"></a><span id="l79.71">   nsWMStringBundle::GetStringBundle();</span>
<a href="#l79.72"></a><span id="l79.72"> }</span>
<a href="#l79.73"></a><span id="l79.73"> </span>
<a href="#l79.74"></a><span id="l79.74" class="difflineminus">-nsWMImport::~nsWMImport()</span>
<a href="#l79.75"></a><span id="l79.75" class="difflineminus">-{</span>
<a href="#l79.76"></a><span id="l79.76" class="difflineminus">-  IMPORT_LOG0(&quot;nsWMImport Module Deleted\n&quot;);</span>
<a href="#l79.77"></a><span id="l79.77" class="difflineminus">-}</span>
<a href="#l79.78"></a><span id="l79.78" class="difflineplus">+nsWMImport::~nsWMImport() { IMPORT_LOG0(&quot;nsWMImport Module Deleted\n&quot;); }</span>
<a href="#l79.79"></a><span id="l79.79"> </span>
<a href="#l79.80"></a><span id="l79.80"> NS_IMPL_ISUPPORTS(nsWMImport, nsIImportModule)</span>
<a href="#l79.81"></a><span id="l79.81"> </span>
<a href="#l79.82"></a><span id="l79.82" class="difflineminus">-NS_IMETHODIMP nsWMImport::GetName(char16_t **name)</span>
<a href="#l79.83"></a><span id="l79.83" class="difflineminus">-{</span>
<a href="#l79.84"></a><span id="l79.84" class="difflineplus">+NS_IMETHODIMP nsWMImport::GetName(char16_t **name) {</span>
<a href="#l79.85"></a><span id="l79.85">   NS_ENSURE_ARG_POINTER(name);</span>
<a href="#l79.86"></a><span id="l79.86">   // nsString  title = &quot;Windows Live Mail&quot;;</span>
<a href="#l79.87"></a><span id="l79.87">   // *name = ToNewUnicode(title);</span>
<a href="#l79.88"></a><span id="l79.88">   *name = nsWMStringBundle::GetStringByID(WMIMPORT_NAME);</span>
<a href="#l79.89"></a><span id="l79.89"> </span>
<a href="#l79.90"></a><span id="l79.90" class="difflineminus">-    return NS_OK;</span>
<a href="#l79.91"></a><span id="l79.91" class="difflineplus">+  return NS_OK;</span>
<a href="#l79.92"></a><span id="l79.92"> }</span>
<a href="#l79.93"></a><span id="l79.93"> </span>
<a href="#l79.94"></a><span id="l79.94" class="difflineminus">-NS_IMETHODIMP nsWMImport::GetDescription(char16_t **name)</span>
<a href="#l79.95"></a><span id="l79.95" class="difflineminus">-{</span>
<a href="#l79.96"></a><span id="l79.96" class="difflineplus">+NS_IMETHODIMP nsWMImport::GetDescription(char16_t **name) {</span>
<a href="#l79.97"></a><span id="l79.97">   NS_ENSURE_ARG_POINTER(name);</span>
<a href="#l79.98"></a><span id="l79.98"> </span>
<a href="#l79.99"></a><span id="l79.99">   // nsString  desc = &quot;Windows Live Mail mail and address books&quot;;</span>
<a href="#l79.100"></a><span id="l79.100">   // *name = ToNewUnicode(desc);</span>
<a href="#l79.101"></a><span id="l79.101">   *name = nsWMStringBundle::GetStringByID(WMIMPORT_DESCRIPTION);</span>
<a href="#l79.102"></a><span id="l79.102">   return NS_OK;</span>
<a href="#l79.103"></a><span id="l79.103"> }</span>
<a href="#l79.104"></a><span id="l79.104"> </span>
<a href="#l79.105"></a><span id="l79.105" class="difflineminus">-NS_IMETHODIMP nsWMImport::GetSupports(char **supports)</span>
<a href="#l79.106"></a><span id="l79.106" class="difflineminus">-{</span>
<a href="#l79.107"></a><span id="l79.107" class="difflineplus">+NS_IMETHODIMP nsWMImport::GetSupports(char **supports) {</span>
<a href="#l79.108"></a><span id="l79.108">   NS_ASSERTION(supports != nullptr, &quot;null ptr&quot;);</span>
<a href="#l79.109"></a><span id="l79.109" class="difflineminus">-  if (! supports)</span>
<a href="#l79.110"></a><span id="l79.110" class="difflineminus">-      return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.111"></a><span id="l79.111" class="difflineplus">+  if (!supports) return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.112"></a><span id="l79.112"> </span>
<a href="#l79.113"></a><span id="l79.113">   *supports = strdup(kWMSupportsString);</span>
<a href="#l79.114"></a><span id="l79.114">   return NS_OK;</span>
<a href="#l79.115"></a><span id="l79.115"> }</span>
<a href="#l79.116"></a><span id="l79.116"> </span>
<a href="#l79.117"></a><span id="l79.117" class="difflineminus">-NS_IMETHODIMP nsWMImport::GetSupportsUpgrade(bool *pUpgrade)</span>
<a href="#l79.118"></a><span id="l79.118" class="difflineminus">-{</span>
<a href="#l79.119"></a><span id="l79.119" class="difflineplus">+NS_IMETHODIMP nsWMImport::GetSupportsUpgrade(bool *pUpgrade) {</span>
<a href="#l79.120"></a><span id="l79.120">   NS_ASSERTION(pUpgrade != nullptr, &quot;null ptr&quot;);</span>
<a href="#l79.121"></a><span id="l79.121" class="difflineminus">-  if (! pUpgrade)</span>
<a href="#l79.122"></a><span id="l79.122" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.123"></a><span id="l79.123" class="difflineplus">+  if (!pUpgrade) return NS_ERROR_NULL_POINTER;</span>
<a href="#l79.124"></a><span id="l79.124"> </span>
<a href="#l79.125"></a><span id="l79.125">   *pUpgrade = true;</span>
<a href="#l79.126"></a><span id="l79.126">   return NS_OK;</span>
<a href="#l79.127"></a><span id="l79.127"> }</span>
<a href="#l79.128"></a><span id="l79.128"> </span>
<a href="#l79.129"></a><span id="l79.129"> NS_IMETHODIMP nsWMImport::GetImportInterface(const char *pImportType,</span>
<a href="#l79.130"></a><span id="l79.130" class="difflineminus">-                                             nsISupports **ppInterface)</span>
<a href="#l79.131"></a><span id="l79.131" class="difflineminus">-{</span>
<a href="#l79.132"></a><span id="l79.132" class="difflineplus">+                                             nsISupports **ppInterface) {</span>
<a href="#l79.133"></a><span id="l79.133">   NS_ENSURE_ARG_POINTER(pImportType);</span>
<a href="#l79.134"></a><span id="l79.134">   NS_ENSURE_ARG_POINTER(ppInterface);</span>
<a href="#l79.135"></a><span id="l79.135"> </span>
<a href="#l79.136"></a><span id="l79.136">   *ppInterface = nullptr;</span>
<a href="#l79.137"></a><span id="l79.137">   nsresult rv;</span>
<a href="#l79.138"></a><span id="l79.138"> </span>
<a href="#l79.139"></a><span id="l79.139">   if (!strcmp(pImportType, &quot;settings&quot;)) {</span>
<a href="#l79.140"></a><span id="l79.140">     nsCOMPtr&lt;nsIImportSettings&gt; pSettings;</span>
<a href="#l79.141"></a><span id="l79.141" class="difflineat">@@ -130,96 +121,78 @@ NS_IMETHODIMP nsWMImport::GetImportInter</span>
<a href="#l79.142"></a><span id="l79.142">     }</span>
<a href="#l79.143"></a><span id="l79.143">     return rv;</span>
<a href="#l79.144"></a><span id="l79.144">   }</span>
<a href="#l79.145"></a><span id="l79.145"> </span>
<a href="#l79.146"></a><span id="l79.146">   return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l79.147"></a><span id="l79.147"> }</span>
<a href="#l79.148"></a><span id="l79.148"> </span>
<a href="#l79.149"></a><span id="l79.149"> /////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l79.150"></a><span id="l79.150" class="difflineminus">-nsresult ImportWMMailImpl::Create(nsIImportMail** aImport)</span>
<a href="#l79.151"></a><span id="l79.151" class="difflineminus">-{</span>
<a href="#l79.152"></a><span id="l79.152" class="difflineplus">+nsresult ImportWMMailImpl::Create(nsIImportMail **aImport) {</span>
<a href="#l79.153"></a><span id="l79.153">   NS_ENSURE_ARG_POINTER(aImport);</span>
<a href="#l79.154"></a><span id="l79.154">   NS_ADDREF(*aImport = new ImportWMMailImpl());</span>
<a href="#l79.155"></a><span id="l79.155">   return NS_OK;</span>
<a href="#l79.156"></a><span id="l79.156"> }</span>
<a href="#l79.157"></a><span id="l79.157"> </span>
<a href="#l79.158"></a><span id="l79.158" class="difflineminus">-ImportWMMailImpl::ImportWMMailImpl()</span>
<a href="#l79.159"></a><span id="l79.159" class="difflineminus">-{</span>
<a href="#l79.160"></a><span id="l79.160" class="difflineminus">-}</span>
<a href="#l79.161"></a><span id="l79.161" class="difflineplus">+ImportWMMailImpl::ImportWMMailImpl() {}</span>
<a href="#l79.162"></a><span id="l79.162"> </span>
<a href="#l79.163"></a><span id="l79.163" class="difflineminus">-ImportWMMailImpl::~ImportWMMailImpl()</span>
<a href="#l79.164"></a><span id="l79.164" class="difflineminus">-{</span>
<a href="#l79.165"></a><span id="l79.165" class="difflineminus">-}</span>
<a href="#l79.166"></a><span id="l79.166" class="difflineplus">+ImportWMMailImpl::~ImportWMMailImpl() {}</span>
<a href="#l79.167"></a><span id="l79.167"> </span>
<a href="#l79.168"></a><span id="l79.168"> NS_IMPL_ISUPPORTS(ImportWMMailImpl, nsIImportMail)</span>
<a href="#l79.169"></a><span id="l79.169"> </span>
<a href="#l79.170"></a><span id="l79.170" class="difflineminus">-NS_IMETHODIMP ImportWMMailImpl::TranslateFolderName(const nsAString &amp; aFolderName, nsAString &amp; _retval)</span>
<a href="#l79.171"></a><span id="l79.171" class="difflineminus">-{</span>
<a href="#l79.172"></a><span id="l79.172" class="difflineplus">+NS_IMETHODIMP ImportWMMailImpl::TranslateFolderName(</span>
<a href="#l79.173"></a><span id="l79.173" class="difflineplus">+    const nsAString &amp;aFolderName, nsAString &amp;_retval) {</span>
<a href="#l79.174"></a><span id="l79.174">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l79.175"></a><span id="l79.175"> }</span>
<a href="#l79.176"></a><span id="l79.176"> </span>
<a href="#l79.177"></a><span id="l79.177"> NS_IMETHODIMP ImportWMMailImpl::GetDefaultLocation(nsIFile **ppLoc, bool *found,</span>
<a href="#l79.178"></a><span id="l79.178" class="difflineminus">-                                                   bool *userVerify)</span>
<a href="#l79.179"></a><span id="l79.179" class="difflineminus">-{</span>
<a href="#l79.180"></a><span id="l79.180" class="difflineplus">+                                                   bool *userVerify) {</span>
<a href="#l79.181"></a><span id="l79.181">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l79.182"></a><span id="l79.182"> }</span>
<a href="#l79.183"></a><span id="l79.183"> </span>
<a href="#l79.184"></a><span id="l79.184"> NS_IMETHODIMP ImportWMMailImpl::FindMailboxes(nsIFile *pLoc,</span>
<a href="#l79.185"></a><span id="l79.185" class="difflineminus">-                                              nsIArray **ppArray)</span>
<a href="#l79.186"></a><span id="l79.186" class="difflineminus">-{</span>
<a href="#l79.187"></a><span id="l79.187" class="difflineplus">+                                              nsIArray **ppArray) {</span>
<a href="#l79.188"></a><span id="l79.188">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l79.189"></a><span id="l79.189"> }</span>
<a href="#l79.190"></a><span id="l79.190"> </span>
<a href="#l79.191"></a><span id="l79.191" class="difflineminus">-void ImportWMMailImpl::AddLinebreak(nsString *pStream)</span>
<a href="#l79.192"></a><span id="l79.192" class="difflineminus">-{</span>
<a href="#l79.193"></a><span id="l79.193" class="difflineminus">-  if (pStream)</span>
<a href="#l79.194"></a><span id="l79.194" class="difflineminus">-    pStream-&gt;Append(char16_t('\n'));</span>
<a href="#l79.195"></a><span id="l79.195" class="difflineplus">+void ImportWMMailImpl::AddLinebreak(nsString *pStream) {</span>
<a href="#l79.196"></a><span id="l79.196" class="difflineplus">+  if (pStream) pStream-&gt;Append(char16_t('\n'));</span>
<a href="#l79.197"></a><span id="l79.197"> }</span>
<a href="#l79.198"></a><span id="l79.198"> </span>
<a href="#l79.199"></a><span id="l79.199" class="difflineminus">-void ImportWMMailImpl::ReportSuccess(nsString&amp; name, int32_t count, nsString *pStream)</span>
<a href="#l79.200"></a><span id="l79.200" class="difflineminus">-{</span>
<a href="#l79.201"></a><span id="l79.201" class="difflineminus">-  if (!pStream)</span>
<a href="#l79.202"></a><span id="l79.202" class="difflineminus">-    return;</span>
<a href="#l79.203"></a><span id="l79.203" class="difflineplus">+void ImportWMMailImpl::ReportSuccess(nsString &amp;name, int32_t count,</span>
<a href="#l79.204"></a><span id="l79.204" class="difflineplus">+                                     nsString *pStream) {</span>
<a href="#l79.205"></a><span id="l79.205" class="difflineplus">+  if (!pStream) return;</span>
<a href="#l79.206"></a><span id="l79.206">   // load the success string</span>
<a href="#l79.207"></a><span id="l79.207">   char16_t *pFmt = nsWMStringBundle::GetStringByID(WMIMPORT_MAILBOX_SUCCESS);</span>
<a href="#l79.208"></a><span id="l79.208">   nsString pText;</span>
<a href="#l79.209"></a><span id="l79.209">   nsTextFormatter::ssprintf(pText, pFmt, name.get(), count);</span>
<a href="#l79.210"></a><span id="l79.210">   pStream-&gt;Append(pText);</span>
<a href="#l79.211"></a><span id="l79.211">   nsWMStringBundle::FreeString(pFmt);</span>
<a href="#l79.212"></a><span id="l79.212">   AddLinebreak(pStream);</span>
<a href="#l79.213"></a><span id="l79.213"> }</span>
<a href="#l79.214"></a><span id="l79.214"> </span>
<a href="#l79.215"></a><span id="l79.215" class="difflineminus">-void ImportWMMailImpl::ReportError(int32_t errorNum, nsString&amp; name, nsString *pStream)</span>
<a href="#l79.216"></a><span id="l79.216" class="difflineminus">-{</span>
<a href="#l79.217"></a><span id="l79.217" class="difflineminus">-  if (!pStream)</span>
<a href="#l79.218"></a><span id="l79.218" class="difflineminus">-    return;</span>
<a href="#l79.219"></a><span id="l79.219" class="difflineplus">+void ImportWMMailImpl::ReportError(int32_t errorNum, nsString &amp;name,</span>
<a href="#l79.220"></a><span id="l79.220" class="difflineplus">+                                   nsString *pStream) {</span>
<a href="#l79.221"></a><span id="l79.221" class="difflineplus">+  if (!pStream) return;</span>
<a href="#l79.222"></a><span id="l79.222">   // load the error string</span>
<a href="#l79.223"></a><span id="l79.223">   char16_t *pFmt = nsWMStringBundle::GetStringByID(errorNum);</span>
<a href="#l79.224"></a><span id="l79.224">   nsString pText;</span>
<a href="#l79.225"></a><span id="l79.225">   nsTextFormatter::ssprintf(pText, pFmt, name.get());</span>
<a href="#l79.226"></a><span id="l79.226">   pStream-&gt;Append(pText);</span>
<a href="#l79.227"></a><span id="l79.227">   nsWMStringBundle::FreeString(pFmt);</span>
<a href="#l79.228"></a><span id="l79.228">   AddLinebreak(pStream);</span>
<a href="#l79.229"></a><span id="l79.229"> }</span>
<a href="#l79.230"></a><span id="l79.230"> </span>
<a href="#l79.231"></a><span id="l79.231" class="difflineminus">-void ImportWMMailImpl::SetLogs(nsString&amp; success, nsString&amp; error,</span>
<a href="#l79.232"></a><span id="l79.232" class="difflineminus">-                               char16_t **pError, char16_t **pSuccess)</span>
<a href="#l79.233"></a><span id="l79.233" class="difflineminus">-{</span>
<a href="#l79.234"></a><span id="l79.234" class="difflineminus">-  if (pError)</span>
<a href="#l79.235"></a><span id="l79.235" class="difflineminus">-    *pError = ToNewUnicode(error);</span>
<a href="#l79.236"></a><span id="l79.236" class="difflineminus">-  if (pSuccess)</span>
<a href="#l79.237"></a><span id="l79.237" class="difflineminus">-    *pSuccess = ToNewUnicode(success);</span>
<a href="#l79.238"></a><span id="l79.238" class="difflineplus">+void ImportWMMailImpl::SetLogs(nsString &amp;success, nsString &amp;error,</span>
<a href="#l79.239"></a><span id="l79.239" class="difflineplus">+                               char16_t **pError, char16_t **pSuccess) {</span>
<a href="#l79.240"></a><span id="l79.240" class="difflineplus">+  if (pError) *pError = ToNewUnicode(error);</span>
<a href="#l79.241"></a><span id="l79.241" class="difflineplus">+  if (pSuccess) *pSuccess = ToNewUnicode(success);</span>
<a href="#l79.242"></a><span id="l79.242"> }</span>
<a href="#l79.243"></a><span id="l79.243"> </span>
<a href="#l79.244"></a><span id="l79.244" class="difflineminus">-NS_IMETHODIMP ImportWMMailImpl::ImportMailbox(nsIImportMailboxDescriptor *pSource,</span>
<a href="#l79.245"></a><span id="l79.245" class="difflineminus">-                                              nsIMsgFolder *pDstFolder,</span>
<a href="#l79.246"></a><span id="l79.246" class="difflineminus">-                                              char16_t **pErrorLog,</span>
<a href="#l79.247"></a><span id="l79.247" class="difflineminus">-                                              char16_t **pSuccessLog,</span>
<a href="#l79.248"></a><span id="l79.248" class="difflineminus">-                                              bool *fatalError)</span>
<a href="#l79.249"></a><span id="l79.249" class="difflineminus">-{</span>
<a href="#l79.250"></a><span id="l79.250" class="difflineplus">+NS_IMETHODIMP ImportWMMailImpl::ImportMailbox(</span>
<a href="#l79.251"></a><span id="l79.251" class="difflineplus">+    nsIImportMailboxDescriptor *pSource, nsIMsgFolder *pDstFolder,</span>
<a href="#l79.252"></a><span id="l79.252" class="difflineplus">+    char16_t **pErrorLog, char16_t **pSuccessLog, bool *fatalError) {</span>
<a href="#l79.253"></a><span id="l79.253">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l79.254"></a><span id="l79.254"> }</span>
<a href="#l79.255"></a><span id="l79.255"> </span>
<a href="#l79.256"></a><span id="l79.256" class="difflineminus">-NS_IMETHODIMP ImportWMMailImpl::GetImportProgress(uint32_t *pDoneSoFar)</span>
<a href="#l79.257"></a><span id="l79.257" class="difflineminus">-{</span>
<a href="#l79.258"></a><span id="l79.258" class="difflineplus">+NS_IMETHODIMP ImportWMMailImpl::GetImportProgress(uint32_t *pDoneSoFar) {</span>
<a href="#l79.259"></a><span id="l79.259">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l79.260"></a><span id="l79.260"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l80.1"></a><span id="l80.1" class="difflineminus">--- a/mailnews/import/winlivemail/nsWMImport.h</span>
<a href="#l80.2"></a><span id="l80.2" class="difflineplus">+++ b/mailnews/import/winlivemail/nsWMImport.h</span>
<a href="#l80.3"></a><span id="l80.3" class="difflineat">@@ -4,35 +4,35 @@</span>
<a href="#l80.4"></a><span id="l80.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l80.5"></a><span id="l80.5"> </span>
<a href="#l80.6"></a><span id="l80.6"> #ifndef nsWMImport_h___</span>
<a href="#l80.7"></a><span id="l80.7"> #define nsWMImport_h___</span>
<a href="#l80.8"></a><span id="l80.8"> </span>
<a href="#l80.9"></a><span id="l80.9"> #include &quot;nsIImportModule.h&quot;</span>
<a href="#l80.10"></a><span id="l80.10"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l80.11"></a><span id="l80.11"> </span>
<a href="#l80.12"></a><span id="l80.12" class="difflineminus">-#define NS_WMIMPORT_CID   \</span>
<a href="#l80.13"></a><span id="l80.13" class="difflineminus">-{ /* 42bc82bc-8e9f-4597-8b6e-e529daaf3af1 */      \</span>
<a href="#l80.14"></a><span id="l80.14" class="difflineminus">-   0x42bc82bc, 0x8e9f, 0x4597,   \</span>
<a href="#l80.15"></a><span id="l80.15" class="difflineminus">-   {0x8b, 0x6e, 0xe5, 0x29, 0xda, 0xaf, 0x3a, 0xf1}}</span>
<a href="#l80.16"></a><span id="l80.16" class="difflineplus">+#define NS_WMIMPORT_CID                              \</span>
<a href="#l80.17"></a><span id="l80.17" class="difflineplus">+  { /* 42bc82bc-8e9f-4597-8b6e-e529daaf3af1 */       \</span>
<a href="#l80.18"></a><span id="l80.18" class="difflineplus">+    0x42bc82bc, 0x8e9f, 0x4597, {                    \</span>
<a href="#l80.19"></a><span id="l80.19" class="difflineplus">+      0x8b, 0x6e, 0xe5, 0x29, 0xda, 0xaf, 0x3a, 0xf1 \</span>
<a href="#l80.20"></a><span id="l80.20" class="difflineplus">+    }                                                \</span>
<a href="#l80.21"></a><span id="l80.21" class="difflineplus">+  }</span>
<a href="#l80.22"></a><span id="l80.22"> </span>
<a href="#l80.23"></a><span id="l80.23"> // currently only support setting import</span>
<a href="#l80.24"></a><span id="l80.24"> #define kWMSupportsString NS_IMPORT_SETTINGS_STR</span>
<a href="#l80.25"></a><span id="l80.25"> </span>
<a href="#l80.26"></a><span id="l80.26" class="difflineminus">-class nsWMImport : public nsIImportModule</span>
<a href="#l80.27"></a><span id="l80.27" class="difflineminus">-{</span>
<a href="#l80.28"></a><span id="l80.28" class="difflineminus">-public:</span>
<a href="#l80.29"></a><span id="l80.29" class="difflineminus">-</span>
<a href="#l80.30"></a><span id="l80.30" class="difflineplus">+class nsWMImport : public nsIImportModule {</span>
<a href="#l80.31"></a><span id="l80.31" class="difflineplus">+ public:</span>
<a href="#l80.32"></a><span id="l80.32">   nsWMImport();</span>
<a href="#l80.33"></a><span id="l80.33"> </span>
<a href="#l80.34"></a><span id="l80.34">   NS_DECL_ISUPPORTS</span>
<a href="#l80.35"></a><span id="l80.35"> </span>
<a href="#l80.36"></a><span id="l80.36">   ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l80.37"></a><span id="l80.37">   // we support the nsIImportModule interface</span>
<a href="#l80.38"></a><span id="l80.38">   ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l80.39"></a><span id="l80.39"> </span>
<a href="#l80.40"></a><span id="l80.40">   NS_DECL_NSIIMPORTMODULE</span>
<a href="#l80.41"></a><span id="l80.41"> </span>
<a href="#l80.42"></a><span id="l80.42" class="difflineminus">-protected:</span>
<a href="#l80.43"></a><span id="l80.43" class="difflineplus">+ protected:</span>
<a href="#l80.44"></a><span id="l80.44">   virtual ~nsWMImport();</span>
<a href="#l80.45"></a><span id="l80.45"> };</span>
<a href="#l80.46"></a><span id="l80.46"> </span>
<a href="#l80.47"></a><span id="l80.47"> #endif /* nsWMImport_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l81.1"></a><span id="l81.1" class="difflineminus">--- a/mailnews/import/winlivemail/nsWMSettings.cpp</span>
<a href="#l81.2"></a><span id="l81.2" class="difflineplus">+++ b/mailnews/import/winlivemail/nsWMSettings.cpp</span>
<a href="#l81.3"></a><span id="l81.3" class="difflineat">@@ -32,104 +32,91 @@</span>
<a href="#l81.4"></a><span id="l81.4"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l81.5"></a><span id="l81.5"> #include &quot;nsTArray.h&quot;</span>
<a href="#l81.6"></a><span id="l81.6"> #include &lt;windows.h&gt;</span>
<a href="#l81.7"></a><span id="l81.7"> #include &quot;nsIWindowsRegKey.h&quot;</span>
<a href="#l81.8"></a><span id="l81.8"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l81.9"></a><span id="l81.9"> #include &quot;nsWMUtils.h&quot;</span>
<a href="#l81.10"></a><span id="l81.10"> </span>
<a href="#l81.11"></a><span id="l81.11"> class WMSettings {</span>
<a href="#l81.12"></a><span id="l81.12" class="difflineminus">-public:</span>
<a href="#l81.13"></a><span id="l81.13" class="difflineplus">+ public:</span>
<a href="#l81.14"></a><span id="l81.14">   static bool DoImport(nsIMsgAccount **ppAccount);</span>
<a href="#l81.15"></a><span id="l81.15">   static bool DoIMAPServer(nsIMsgAccountManager *pMgr,</span>
<a href="#l81.16"></a><span id="l81.16" class="difflineminus">-                             mozilla::dom::Document *xmlDoc,</span>
<a href="#l81.17"></a><span id="l81.17" class="difflineminus">-                             const nsString&amp; serverName,</span>
<a href="#l81.18"></a><span id="l81.18" class="difflineminus">-                             nsIMsgAccount **ppAccount);</span>
<a href="#l81.19"></a><span id="l81.19" class="difflineplus">+                           mozilla::dom::Document *xmlDoc,</span>
<a href="#l81.20"></a><span id="l81.20" class="difflineplus">+                           const nsString &amp;serverName,</span>
<a href="#l81.21"></a><span id="l81.21" class="difflineplus">+                           nsIMsgAccount **ppAccount);</span>
<a href="#l81.22"></a><span id="l81.22">   static bool DoPOP3Server(nsIMsgAccountManager *pMgr,</span>
<a href="#l81.23"></a><span id="l81.23" class="difflineminus">-                             mozilla::dom::Document *xmlDoc,</span>
<a href="#l81.24"></a><span id="l81.24" class="difflineminus">-                             const nsString&amp; serverName,</span>
<a href="#l81.25"></a><span id="l81.25" class="difflineminus">-                             nsIMsgAccount **ppAccount);</span>
<a href="#l81.26"></a><span id="l81.26" class="difflineplus">+                           mozilla::dom::Document *xmlDoc,</span>
<a href="#l81.27"></a><span id="l81.27" class="difflineplus">+                           const nsString &amp;serverName,</span>
<a href="#l81.28"></a><span id="l81.28" class="difflineplus">+                           nsIMsgAccount **ppAccount);</span>
<a href="#l81.29"></a><span id="l81.29">   static bool DoNNTPServer(nsIMsgAccountManager *pMgr,</span>
<a href="#l81.30"></a><span id="l81.30" class="difflineminus">-                             mozilla::dom::Document *xmlDoc,</span>
<a href="#l81.31"></a><span id="l81.31" class="difflineminus">-                             const nsString&amp; serverName,</span>
<a href="#l81.32"></a><span id="l81.32" class="difflineminus">-                             nsIMsgAccount **ppAccount);</span>
<a href="#l81.33"></a><span id="l81.33" class="difflineplus">+                           mozilla::dom::Document *xmlDoc,</span>
<a href="#l81.34"></a><span id="l81.34" class="difflineplus">+                           const nsString &amp;serverName,</span>
<a href="#l81.35"></a><span id="l81.35" class="difflineplus">+                           nsIMsgAccount **ppAccount);</span>
<a href="#l81.36"></a><span id="l81.36">   static void SetIdentities(nsIMsgAccountManager *pMgr, nsIMsgAccount *pAcc,</span>
<a href="#l81.37"></a><span id="l81.37" class="difflineminus">-                            mozilla::dom::Document *xmlDoc, nsAutoString &amp;userName,</span>
<a href="#l81.38"></a><span id="l81.38" class="difflineminus">-                            int32_t authMethodIncoming, bool isNNTP);</span>
<a href="#l81.39"></a><span id="l81.39" class="difflineplus">+                            mozilla::dom::Document *xmlDoc,</span>
<a href="#l81.40"></a><span id="l81.40" class="difflineplus">+                            nsAutoString &amp;userName, int32_t authMethodIncoming,</span>
<a href="#l81.41"></a><span id="l81.41" class="difflineplus">+                            bool isNNTP);</span>
<a href="#l81.42"></a><span id="l81.42">   static void SetSmtpServer(mozilla::dom::Document *xmlDoc, nsIMsgIdentity *id,</span>
<a href="#l81.43"></a><span id="l81.43" class="difflineminus">-                            nsAutoString&amp; inUserName, int32_t authMethodIncoming);</span>
<a href="#l81.44"></a><span id="l81.44" class="difflineplus">+                            nsAutoString &amp;inUserName,</span>
<a href="#l81.45"></a><span id="l81.45" class="difflineplus">+                            int32_t authMethodIncoming);</span>
<a href="#l81.46"></a><span id="l81.46"> };</span>
<a href="#l81.47"></a><span id="l81.47"> </span>
<a href="#l81.48"></a><span id="l81.48" class="difflineminus">-static int32_t checkNewMailTime;// WM global setting, let's default to 30</span>
<a href="#l81.49"></a><span id="l81.49" class="difflineminus">-static bool    checkNewMail;    // WM global setting, let's default to false</span>
<a href="#l81.50"></a><span id="l81.50" class="difflineminus">-                                // This won't cause unwanted autodownloads-</span>
<a href="#l81.51"></a><span id="l81.51" class="difflineminus">-                                // user can set prefs after import</span>
<a href="#l81.52"></a><span id="l81.52" class="difflineplus">+static int32_t checkNewMailTime;  // WM global setting, let's default to 30</span>
<a href="#l81.53"></a><span id="l81.53" class="difflineplus">+static bool checkNewMail;         // WM global setting, let's default to false</span>
<a href="#l81.54"></a><span id="l81.54" class="difflineplus">+                                  // This won't cause unwanted autodownloads-</span>
<a href="#l81.55"></a><span id="l81.55" class="difflineplus">+                                  // user can set prefs after import</span>
<a href="#l81.56"></a><span id="l81.56"> </span>
<a href="#l81.57"></a><span id="l81.57"> ////////////////////////////////////////////////////////////////////////</span>
<a href="#l81.58"></a><span id="l81.58" class="difflineminus">-nsresult nsWMSettings::Create(nsIImportSettings** aImport)</span>
<a href="#l81.59"></a><span id="l81.59" class="difflineminus">-{</span>
<a href="#l81.60"></a><span id="l81.60" class="difflineplus">+nsresult nsWMSettings::Create(nsIImportSettings **aImport) {</span>
<a href="#l81.61"></a><span id="l81.61">   NS_ENSURE_ARG_POINTER(aImport);</span>
<a href="#l81.62"></a><span id="l81.62">   NS_ADDREF(*aImport = new nsWMSettings());</span>
<a href="#l81.63"></a><span id="l81.63">   return NS_OK;</span>
<a href="#l81.64"></a><span id="l81.64"> }</span>
<a href="#l81.65"></a><span id="l81.65"> </span>
<a href="#l81.66"></a><span id="l81.66" class="difflineminus">-nsWMSettings::nsWMSettings()</span>
<a href="#l81.67"></a><span id="l81.67" class="difflineminus">-{</span>
<a href="#l81.68"></a><span id="l81.68" class="difflineminus">-}</span>
<a href="#l81.69"></a><span id="l81.69" class="difflineplus">+nsWMSettings::nsWMSettings() {}</span>
<a href="#l81.70"></a><span id="l81.70"> </span>
<a href="#l81.71"></a><span id="l81.71" class="difflineminus">-nsWMSettings::~nsWMSettings()</span>
<a href="#l81.72"></a><span id="l81.72" class="difflineminus">-{</span>
<a href="#l81.73"></a><span id="l81.73" class="difflineminus">-}</span>
<a href="#l81.74"></a><span id="l81.74" class="difflineplus">+nsWMSettings::~nsWMSettings() {}</span>
<a href="#l81.75"></a><span id="l81.75"> </span>
<a href="#l81.76"></a><span id="l81.76"> NS_IMPL_ISUPPORTS(nsWMSettings, nsIImportSettings)</span>
<a href="#l81.77"></a><span id="l81.77"> </span>
<a href="#l81.78"></a><span id="l81.78"> NS_IMETHODIMP nsWMSettings::AutoLocate(char16_t **description,</span>
<a href="#l81.79"></a><span id="l81.79" class="difflineminus">-                                       nsIFile **location, bool *_retval)</span>
<a href="#l81.80"></a><span id="l81.80" class="difflineminus">-{</span>
<a href="#l81.81"></a><span id="l81.81" class="difflineplus">+                                       nsIFile **location, bool *_retval) {</span>
<a href="#l81.82"></a><span id="l81.82">   NS_ASSERTION(description != nullptr, &quot;null ptr&quot;);</span>
<a href="#l81.83"></a><span id="l81.83">   NS_ASSERTION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l81.84"></a><span id="l81.84" class="difflineminus">-  if (!description || !_retval)</span>
<a href="#l81.85"></a><span id="l81.85" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l81.86"></a><span id="l81.86" class="difflineplus">+  if (!description || !_retval) return NS_ERROR_NULL_POINTER;</span>
<a href="#l81.87"></a><span id="l81.87"> </span>
<a href="#l81.88"></a><span id="l81.88">   *description = nsWMStringBundle::GetStringByID(WMIMPORT_NAME);</span>
<a href="#l81.89"></a><span id="l81.89">   *_retval = false;</span>
<a href="#l81.90"></a><span id="l81.90"> </span>
<a href="#l81.91"></a><span id="l81.91" class="difflineminus">-  if (location)</span>
<a href="#l81.92"></a><span id="l81.92" class="difflineminus">-    *location = nullptr;</span>
<a href="#l81.93"></a><span id="l81.93" class="difflineplus">+  if (location) *location = nullptr;</span>
<a href="#l81.94"></a><span id="l81.94">   nsCOMPtr&lt;nsIWindowsRegKey&gt; key;</span>
<a href="#l81.95"></a><span id="l81.95" class="difflineminus">-  if (NS_SUCCEEDED(nsWMUtils::FindWMKey(getter_AddRefs(key))))</span>
<a href="#l81.96"></a><span id="l81.96" class="difflineminus">-    *_retval = true;</span>
<a href="#l81.97"></a><span id="l81.97" class="difflineplus">+  if (NS_SUCCEEDED(nsWMUtils::FindWMKey(getter_AddRefs(key)))) *_retval = true;</span>
<a href="#l81.98"></a><span id="l81.98"> </span>
<a href="#l81.99"></a><span id="l81.99">   return NS_OK;</span>
<a href="#l81.100"></a><span id="l81.100"> }</span>
<a href="#l81.101"></a><span id="l81.101"> </span>
<a href="#l81.102"></a><span id="l81.102" class="difflineminus">-NS_IMETHODIMP nsWMSettings::SetLocation(nsIFile *location)</span>
<a href="#l81.103"></a><span id="l81.103" class="difflineminus">-{</span>
<a href="#l81.104"></a><span id="l81.104" class="difflineminus">-  return NS_OK;</span>
<a href="#l81.105"></a><span id="l81.105" class="difflineminus">-}</span>
<a href="#l81.106"></a><span id="l81.106" class="difflineplus">+NS_IMETHODIMP nsWMSettings::SetLocation(nsIFile *location) { return NS_OK; }</span>
<a href="#l81.107"></a><span id="l81.107"> </span>
<a href="#l81.108"></a><span id="l81.108"> NS_IMETHODIMP nsWMSettings::Import(nsIMsgAccount **localMailAccount,</span>
<a href="#l81.109"></a><span id="l81.109" class="difflineminus">-                                   bool *_retval)</span>
<a href="#l81.110"></a><span id="l81.110" class="difflineminus">-{</span>
<a href="#l81.111"></a><span id="l81.111" class="difflineplus">+                                   bool *_retval) {</span>
<a href="#l81.112"></a><span id="l81.112">   NS_ASSERTION(_retval != nullptr, &quot;null ptr&quot;);</span>
<a href="#l81.113"></a><span id="l81.113"> </span>
<a href="#l81.114"></a><span id="l81.114">   if (WMSettings::DoImport(localMailAccount)) {</span>
<a href="#l81.115"></a><span id="l81.115">     *_retval = true;</span>
<a href="#l81.116"></a><span id="l81.116">     IMPORT_LOG0(&quot;Settings import appears successful\n&quot;);</span>
<a href="#l81.117"></a><span id="l81.117" class="difflineminus">-  }</span>
<a href="#l81.118"></a><span id="l81.118" class="difflineminus">-  else {</span>
<a href="#l81.119"></a><span id="l81.119" class="difflineplus">+  } else {</span>
<a href="#l81.120"></a><span id="l81.120">     *_retval = false;</span>
<a href="#l81.121"></a><span id="l81.121">     IMPORT_LOG0(&quot;Settings import returned FALSE\n&quot;);</span>
<a href="#l81.122"></a><span id="l81.122">   }</span>
<a href="#l81.123"></a><span id="l81.123"> </span>
<a href="#l81.124"></a><span id="l81.124">   return NS_OK;</span>
<a href="#l81.125"></a><span id="l81.125"> }</span>
<a href="#l81.126"></a><span id="l81.126"> </span>
<a href="#l81.127"></a><span id="l81.127" class="difflineminus">-bool WMSettings::DoImport(nsIMsgAccount **ppAccount)</span>
<a href="#l81.128"></a><span id="l81.128" class="difflineminus">-{</span>
<a href="#l81.129"></a><span id="l81.129" class="difflineplus">+bool WMSettings::DoImport(nsIMsgAccount **ppAccount) {</span>
<a href="#l81.130"></a><span id="l81.130">   // do the windows registry stuff first</span>
<a href="#l81.131"></a><span id="l81.131">   nsCOMPtr&lt;nsIWindowsRegKey&gt; key;</span>
<a href="#l81.132"></a><span id="l81.132">   if (NS_FAILED(nsWMUtils::FindWMKey(getter_AddRefs(key)))) {</span>
<a href="#l81.133"></a><span id="l81.133">     IMPORT_LOG0(&quot;*** Error finding Windows Live Mail registry account keys\n&quot;);</span>
<a href="#l81.134"></a><span id="l81.134">     return false;</span>
<a href="#l81.135"></a><span id="l81.135">   }</span>
<a href="#l81.136"></a><span id="l81.136">   // 'poll for messages' setting in WM is a global setting-Like OE</span>
<a href="#l81.137"></a><span id="l81.137">   // for all accounts dword ==0xffffffff for don't poll else 1/60000 = minutes</span>
<a href="#l81.138"></a><span id="l81.138" class="difflineat">@@ -137,283 +124,254 @@ bool WMSettings::DoImport(nsIMsgAccount </span>
<a href="#l81.139"></a><span id="l81.139">   checkNewMail = false;</span>
<a href="#l81.140"></a><span id="l81.140"> </span>
<a href="#l81.141"></a><span id="l81.141">   nsresult rv;</span>
<a href="#l81.142"></a><span id="l81.142">   nsCOMPtr&lt;nsIWindowsRegKey&gt; subKey;</span>
<a href="#l81.143"></a><span id="l81.143">   if (NS_SUCCEEDED(key-&gt;OpenChild(NS_LITERAL_STRING(&quot;mail&quot;),</span>
<a href="#l81.144"></a><span id="l81.144">                                   nsIWindowsRegKey::ACCESS_QUERY_VALUE,</span>
<a href="#l81.145"></a><span id="l81.145">                                   getter_AddRefs(subKey)))) {</span>
<a href="#l81.146"></a><span id="l81.146">     uint32_t dwordResult = -1;</span>
<a href="#l81.147"></a><span id="l81.147" class="difflineminus">-    rv = subKey-&gt;ReadIntValue(NS_LITERAL_STRING(&quot;Poll For Mail&quot;), &amp;dwordResult); // reg_dword</span>
<a href="#l81.148"></a><span id="l81.148" class="difflineplus">+    rv = subKey-&gt;ReadIntValue(NS_LITERAL_STRING(&quot;Poll For Mail&quot;),</span>
<a href="#l81.149"></a><span id="l81.149" class="difflineplus">+                              &amp;dwordResult);  // reg_dword</span>
<a href="#l81.150"></a><span id="l81.150">     subKey-&gt;Close();</span>
<a href="#l81.151"></a><span id="l81.151" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; dwordResult != -1){</span>
<a href="#l81.152"></a><span id="l81.152" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; dwordResult != -1) {</span>
<a href="#l81.153"></a><span id="l81.153">       checkNewMail = true;</span>
<a href="#l81.154"></a><span id="l81.154">       checkNewMailTime = dwordResult / 60000;</span>
<a href="#l81.155"></a><span id="l81.155">     }</span>
<a href="#l81.156"></a><span id="l81.156">   }</span>
<a href="#l81.157"></a><span id="l81.157">   // these are in main windowsmail key and if they don't exist-not to worry</span>
<a href="#l81.158"></a><span id="l81.158" class="difflineminus">-  // (less than 64 chars) e.g. account{4A18B81E-83CA-472A-8D7F-5301C0B97B8D}.oeaccount</span>
<a href="#l81.159"></a><span id="l81.159" class="difflineminus">-  nsAutoString  defMailAcct, defNewsAcct;</span>
<a href="#l81.160"></a><span id="l81.160" class="difflineminus">-  key-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;Default Mail Account&quot;), defMailAcct); // ref_sz</span>
<a href="#l81.161"></a><span id="l81.161" class="difflineminus">-  key-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;Default News Account&quot;), defNewsAcct); // ref_sz</span>
<a href="#l81.162"></a><span id="l81.162" class="difflineplus">+  // (less than 64 chars) e.g.</span>
<a href="#l81.163"></a><span id="l81.163" class="difflineplus">+  // account{4A18B81E-83CA-472A-8D7F-5301C0B97B8D}.oeaccount</span>
<a href="#l81.164"></a><span id="l81.164" class="difflineplus">+  nsAutoString defMailAcct, defNewsAcct;</span>
<a href="#l81.165"></a><span id="l81.165" class="difflineplus">+  key-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;Default Mail Account&quot;),</span>
<a href="#l81.166"></a><span id="l81.166" class="difflineplus">+                       defMailAcct);  // ref_sz</span>
<a href="#l81.167"></a><span id="l81.167" class="difflineplus">+  key-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;Default News Account&quot;),</span>
<a href="#l81.168"></a><span id="l81.168" class="difflineplus">+                       defNewsAcct);  // ref_sz</span>
<a href="#l81.169"></a><span id="l81.169"> </span>
<a href="#l81.170"></a><span id="l81.170">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accMgr =</span>
<a href="#l81.171"></a><span id="l81.171" class="difflineminus">-           do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l81.172"></a><span id="l81.172" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l81.173"></a><span id="l81.173">   if (NS_FAILED(rv)) {</span>
<a href="#l81.174"></a><span id="l81.174">     IMPORT_LOG0(&quot;*** Failed to create an account manager!\n&quot;);</span>
<a href="#l81.175"></a><span id="l81.175">     return false;</span>
<a href="#l81.176"></a><span id="l81.176">   }</span>
<a href="#l81.177"></a><span id="l81.177"> </span>
<a href="#l81.178"></a><span id="l81.178">   nsCOMArray&lt;nsIFile&gt; fileArray;</span>
<a href="#l81.179"></a><span id="l81.179">   if (NS_FAILED(nsWMUtils::GetOEAccountFiles(fileArray))) {</span>
<a href="#l81.180"></a><span id="l81.180">     IMPORT_LOG0(&quot;*** Failed to get .oeaccount file!\n&quot;);</span>
<a href="#l81.181"></a><span id="l81.181">     return false;</span>
<a href="#l81.182"></a><span id="l81.182">   }</span>
<a href="#l81.183"></a><span id="l81.183"> </span>
<a href="#l81.184"></a><span id="l81.184">   // Loop through *.oeaccounts files looking for POP3 &amp; IMAP &amp; NNTP accounts</span>
<a href="#l81.185"></a><span id="l81.185">   // Ignore LDAP for now!</span>
<a href="#l81.186"></a><span id="l81.186">   int accounts = 0;</span>
<a href="#l81.187"></a><span id="l81.187">   nsCOMPtr&lt;mozilla::dom::Document&gt; xmlDoc;</span>
<a href="#l81.188"></a><span id="l81.188"> </span>
<a href="#l81.189"></a><span id="l81.189" class="difflineminus">-  for (int32_t i = fileArray.Count() - 1 ; i &gt;= 0; i--){</span>
<a href="#l81.190"></a><span id="l81.190" class="difflineplus">+  for (int32_t i = fileArray.Count() - 1; i &gt;= 0; i--) {</span>
<a href="#l81.191"></a><span id="l81.191">     nsWMUtils::MakeXMLdoc(getter_AddRefs(xmlDoc), fileArray[i]);</span>
<a href="#l81.192"></a><span id="l81.192"> </span>
<a href="#l81.193"></a><span id="l81.193">     nsAutoCString name;</span>
<a href="#l81.194"></a><span id="l81.194">     fileArray[i]-&gt;GetNativeLeafName(name);</span>
<a href="#l81.195"></a><span id="l81.195">     nsAutoString value;</span>
<a href="#l81.196"></a><span id="l81.196">     nsCOMPtr&lt;nsIMsgAccount&gt; anAccount;</span>
<a href="#l81.197"></a><span id="l81.197" class="difflineminus">-    if (NS_SUCCEEDED(nsWMUtils::GetValueForTag(xmlDoc,</span>
<a href="#l81.198"></a><span id="l81.198" class="difflineminus">-                                               &quot;IMAP_Server&quot;,</span>
<a href="#l81.199"></a><span id="l81.199" class="difflineminus">-                                               value)))</span>
<a href="#l81.200"></a><span id="l81.200" class="difflineplus">+    if (NS_SUCCEEDED(nsWMUtils::GetValueForTag(xmlDoc, &quot;IMAP_Server&quot;, value)))</span>
<a href="#l81.201"></a><span id="l81.201">       if (DoIMAPServer(accMgr, xmlDoc, value, getter_AddRefs(anAccount)))</span>
<a href="#l81.202"></a><span id="l81.202">         accounts++;</span>
<a href="#l81.203"></a><span id="l81.203" class="difflineminus">-    if (NS_SUCCEEDED(nsWMUtils::GetValueForTag(xmlDoc,</span>
<a href="#l81.204"></a><span id="l81.204" class="difflineminus">-                                               &quot;NNTP_Server&quot;,</span>
<a href="#l81.205"></a><span id="l81.205" class="difflineminus">-                                               value)))</span>
<a href="#l81.206"></a><span id="l81.206" class="difflineplus">+    if (NS_SUCCEEDED(nsWMUtils::GetValueForTag(xmlDoc, &quot;NNTP_Server&quot;, value)))</span>
<a href="#l81.207"></a><span id="l81.207">       if (DoNNTPServer(accMgr, xmlDoc, value, getter_AddRefs(anAccount)))</span>
<a href="#l81.208"></a><span id="l81.208">         accounts++;</span>
<a href="#l81.209"></a><span id="l81.209" class="difflineminus">-    if (NS_SUCCEEDED(nsWMUtils::GetValueForTag(xmlDoc,</span>
<a href="#l81.210"></a><span id="l81.210" class="difflineminus">-                                               &quot;POP3_Server&quot;,</span>
<a href="#l81.211"></a><span id="l81.211" class="difflineminus">-                                               value)))</span>
<a href="#l81.212"></a><span id="l81.212" class="difflineplus">+    if (NS_SUCCEEDED(nsWMUtils::GetValueForTag(xmlDoc, &quot;POP3_Server&quot;, value)))</span>
<a href="#l81.213"></a><span id="l81.213">       if (DoPOP3Server(accMgr, xmlDoc, value, getter_AddRefs(anAccount)))</span>
<a href="#l81.214"></a><span id="l81.214">         accounts++;</span>
<a href="#l81.215"></a><span id="l81.215"> </span>
<a href="#l81.216"></a><span id="l81.216">     if (anAccount) {</span>
<a href="#l81.217"></a><span id="l81.217">       nsString name;</span>
<a href="#l81.218"></a><span id="l81.218">       // Is this the default account?</span>
<a href="#l81.219"></a><span id="l81.219">       fileArray[i]-&gt;GetLeafName(name);</span>
<a href="#l81.220"></a><span id="l81.220" class="difflineminus">-      if (defMailAcct.Equals(name))</span>
<a href="#l81.221"></a><span id="l81.221" class="difflineminus">-        accMgr-&gt;SetDefaultAccount(anAccount);</span>
<a href="#l81.222"></a><span id="l81.222" class="difflineplus">+      if (defMailAcct.Equals(name)) accMgr-&gt;SetDefaultAccount(anAccount);</span>
<a href="#l81.223"></a><span id="l81.223">     }</span>
<a href="#l81.224"></a><span id="l81.224">   }</span>
<a href="#l81.225"></a><span id="l81.225"> </span>
<a href="#l81.226"></a><span id="l81.226">   // Now save the new acct info to pref file.</span>
<a href="#l81.227"></a><span id="l81.227">   rv = accMgr-&gt;SaveAccountInfo();</span>
<a href="#l81.228"></a><span id="l81.228">   NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Can't save account info to pref file&quot;);</span>
<a href="#l81.229"></a><span id="l81.229"> </span>
<a href="#l81.230"></a><span id="l81.230">   return accounts != 0;</span>
<a href="#l81.231"></a><span id="l81.231"> }</span>
<a href="#l81.232"></a><span id="l81.232"> </span>
<a href="#l81.233"></a><span id="l81.233"> bool WMSettings::DoIMAPServer(nsIMsgAccountManager *pMgr,</span>
<a href="#l81.234"></a><span id="l81.234" class="difflineminus">-                                mozilla::dom::Document *xmlDoc,</span>
<a href="#l81.235"></a><span id="l81.235" class="difflineminus">-                                const nsString&amp; serverName,</span>
<a href="#l81.236"></a><span id="l81.236" class="difflineminus">-                                nsIMsgAccount **ppAccount)</span>
<a href="#l81.237"></a><span id="l81.237" class="difflineminus">-{</span>
<a href="#l81.238"></a><span id="l81.238" class="difflineminus">-  int32_t authMethod;   // Secure Password Authentication (SPA)</span>
<a href="#l81.239"></a><span id="l81.239" class="difflineplus">+                              mozilla::dom::Document *xmlDoc,</span>
<a href="#l81.240"></a><span id="l81.240" class="difflineplus">+                              const nsString &amp;serverName,</span>
<a href="#l81.241"></a><span id="l81.241" class="difflineplus">+                              nsIMsgAccount **ppAccount) {</span>
<a href="#l81.242"></a><span id="l81.242" class="difflineplus">+  int32_t authMethod;  // Secure Password Authentication (SPA)</span>
<a href="#l81.243"></a><span id="l81.243">   nsresult errorCode;</span>
<a href="#l81.244"></a><span id="l81.244" class="difflineminus">-  if (ppAccount)</span>
<a href="#l81.245"></a><span id="l81.245" class="difflineminus">-    *ppAccount = nullptr;</span>
<a href="#l81.246"></a><span id="l81.246" class="difflineplus">+  if (ppAccount) *ppAccount = nullptr;</span>
<a href="#l81.247"></a><span id="l81.247"> </span>
<a href="#l81.248"></a><span id="l81.248">   nsAutoString userName, value;</span>
<a href="#l81.249"></a><span id="l81.249" class="difflineminus">-  if (NS_FAILED(nsWMUtils::GetValueForTag(xmlDoc,</span>
<a href="#l81.250"></a><span id="l81.250" class="difflineminus">-                                          &quot;IMAP_User_Name&quot;,</span>
<a href="#l81.251"></a><span id="l81.251" class="difflineminus">-                                          userName)))</span>
<a href="#l81.252"></a><span id="l81.252" class="difflineplus">+  if (NS_FAILED(nsWMUtils::GetValueForTag(xmlDoc, &quot;IMAP_User_Name&quot;, userName)))</span>
<a href="#l81.253"></a><span id="l81.253">     return false;</span>
<a href="#l81.254"></a><span id="l81.254">   bool result = false;</span>
<a href="#l81.255"></a><span id="l81.255">   // I now have a user name/server name pair, find out if it already exists?</span>
<a href="#l81.256"></a><span id="l81.256">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; in;</span>
<a href="#l81.257"></a><span id="l81.257" class="difflineminus">-  nsresult rv = pMgr-&gt;FindServer(NS_ConvertUTF16toUTF8(userName),</span>
<a href="#l81.258"></a><span id="l81.258" class="difflineminus">-                                 NS_ConvertUTF16toUTF8(serverName),</span>
<a href="#l81.259"></a><span id="l81.259" class="difflineminus">-                                 NS_LITERAL_CSTRING(&quot;imap&quot;),</span>
<a href="#l81.260"></a><span id="l81.260" class="difflineminus">-                                 getter_AddRefs(in));</span>
<a href="#l81.261"></a><span id="l81.261" class="difflineplus">+  nsresult rv = pMgr-&gt;FindServer(</span>
<a href="#l81.262"></a><span id="l81.262" class="difflineplus">+      NS_ConvertUTF16toUTF8(userName), NS_ConvertUTF16toUTF8(serverName),</span>
<a href="#l81.263"></a><span id="l81.263" class="difflineplus">+      NS_LITERAL_CSTRING(&quot;imap&quot;), getter_AddRefs(in));</span>
<a href="#l81.264"></a><span id="l81.264">   if (NS_FAILED(rv) || (in == nullptr)) {</span>
<a href="#l81.265"></a><span id="l81.265">     // Create the incoming server and an account for it?</span>
<a href="#l81.266"></a><span id="l81.266" class="difflineminus">-    rv = pMgr-&gt;CreateIncomingServer(NS_ConvertUTF16toUTF8(userName),</span>
<a href="#l81.267"></a><span id="l81.267" class="difflineminus">-                                    NS_ConvertUTF16toUTF8(serverName),</span>
<a href="#l81.268"></a><span id="l81.268" class="difflineminus">-                                    NS_LITERAL_CSTRING(&quot;imap&quot;),</span>
<a href="#l81.269"></a><span id="l81.269" class="difflineminus">-                                    getter_AddRefs(in));</span>
<a href="#l81.270"></a><span id="l81.270" class="difflineplus">+    rv = pMgr-&gt;CreateIncomingServer(</span>
<a href="#l81.271"></a><span id="l81.271" class="difflineplus">+        NS_ConvertUTF16toUTF8(userName), NS_ConvertUTF16toUTF8(serverName),</span>
<a href="#l81.272"></a><span id="l81.272" class="difflineplus">+        NS_LITERAL_CSTRING(&quot;imap&quot;), getter_AddRefs(in));</span>
<a href="#l81.273"></a><span id="l81.273">     if (NS_SUCCEEDED(rv) &amp;&amp; in) {</span>
<a href="#l81.274"></a><span id="l81.274">       nsCOMPtr&lt;nsIImapIncomingServer&gt; imapServer = do_QueryInterface(in);</span>
<a href="#l81.275"></a><span id="l81.275" class="difflineminus">-      if (!imapServer){</span>
<a href="#l81.276"></a><span id="l81.276" class="difflineplus">+      if (!imapServer) {</span>
<a href="#l81.277"></a><span id="l81.277">         IMPORT_LOG1(&quot;*** Failed to create nsIImapIncomingServer for %S!\n&quot;,</span>
<a href="#l81.278"></a><span id="l81.278">                     serverName.get());</span>
<a href="#l81.279"></a><span id="l81.279">         return false;</span>
<a href="#l81.280"></a><span id="l81.280">       }</span>
<a href="#l81.281"></a><span id="l81.281" class="difflineminus">-      if (NS_SUCCEEDED(nsWMUtils::GetValueForTag(xmlDoc,</span>
<a href="#l81.282"></a><span id="l81.282" class="difflineminus">-                                                 &quot;IMAP_Root_Folder&quot;,</span>
<a href="#l81.283"></a><span id="l81.283" class="difflineminus">-                                                 value))) {</span>
<a href="#l81.284"></a><span id="l81.284" class="difflineplus">+      if (NS_SUCCEEDED(</span>
<a href="#l81.285"></a><span id="l81.285" class="difflineplus">+              nsWMUtils::GetValueForTag(xmlDoc, &quot;IMAP_Root_Folder&quot;, value))) {</span>
<a href="#l81.286"></a><span id="l81.286">         imapServer-&gt;SetServerDirectory(NS_ConvertUTF16toUTF8(value));</span>
<a href="#l81.287"></a><span id="l81.287">       }</span>
<a href="#l81.288"></a><span id="l81.288" class="difflineminus">-      if (NS_SUCCEEDED(nsWMUtils::GetValueForTag(xmlDoc,</span>
<a href="#l81.289"></a><span id="l81.289" class="difflineminus">-                                                 &quot;IMAP_Secure_Connection&quot;,</span>
<a href="#l81.290"></a><span id="l81.290" class="difflineminus">-                                                 value))) {</span>
<a href="#l81.291"></a><span id="l81.291" class="difflineplus">+      if (NS_SUCCEEDED(nsWMUtils::GetValueForTag(</span>
<a href="#l81.292"></a><span id="l81.292" class="difflineplus">+              xmlDoc, &quot;IMAP_Secure_Connection&quot;, value))) {</span>
<a href="#l81.293"></a><span id="l81.293">         if (value.ToInteger(&amp;errorCode, 16))</span>
<a href="#l81.294"></a><span id="l81.294">           in-&gt;SetSocketType(nsMsgSocketType::SSL);</span>
<a href="#l81.295"></a><span id="l81.295">       }</span>
<a href="#l81.296"></a><span id="l81.296" class="difflineminus">-      if (NS_SUCCEEDED(nsWMUtils::GetValueForTag(xmlDoc,</span>
<a href="#l81.297"></a><span id="l81.297" class="difflineminus">-                                                 &quot;IMAP_Use_Sicily&quot;,</span>
<a href="#l81.298"></a><span id="l81.298" class="difflineminus">-                                                 value))) {</span>
<a href="#l81.299"></a><span id="l81.299" class="difflineplus">+      if (NS_SUCCEEDED(</span>
<a href="#l81.300"></a><span id="l81.300" class="difflineplus">+              nsWMUtils::GetValueForTag(xmlDoc, &quot;IMAP_Use_Sicily&quot;, value))) {</span>
<a href="#l81.301"></a><span id="l81.301">         bool secAuth = (bool)value.ToInteger(&amp;errorCode, 16);</span>
<a href="#l81.302"></a><span id="l81.302" class="difflineminus">-        authMethod = secAuth ? nsMsgAuthMethod::secure :</span>
<a href="#l81.303"></a><span id="l81.303" class="difflineminus">-                               nsMsgAuthMethod::passwordCleartext;</span>
<a href="#l81.304"></a><span id="l81.304" class="difflineplus">+        authMethod = secAuth ? nsMsgAuthMethod::secure</span>
<a href="#l81.305"></a><span id="l81.305" class="difflineplus">+                             : nsMsgAuthMethod::passwordCleartext;</span>
<a href="#l81.306"></a><span id="l81.306">         in-&gt;SetAuthMethod(authMethod);</span>
<a href="#l81.307"></a><span id="l81.307">       }</span>
<a href="#l81.308"></a><span id="l81.308"> </span>
<a href="#l81.309"></a><span id="l81.309" class="difflineminus">-      if (NS_SUCCEEDED(nsWMUtils::GetValueForTag(xmlDoc,</span>
<a href="#l81.310"></a><span id="l81.310" class="difflineminus">-                                                 &quot;IMAP_Port&quot;,</span>
<a href="#l81.311"></a><span id="l81.311" class="difflineminus">-                                                 value))) {</span>
<a href="#l81.312"></a><span id="l81.312" class="difflineplus">+      if (NS_SUCCEEDED(nsWMUtils::GetValueForTag(xmlDoc, &quot;IMAP_Port&quot;, value))) {</span>
<a href="#l81.313"></a><span id="l81.313">         in-&gt;SetPort(value.ToInteger(&amp;errorCode, 16));</span>
<a href="#l81.314"></a><span id="l81.314">       }</span>
<a href="#l81.315"></a><span id="l81.315" class="difflineminus">-      if (NS_SUCCEEDED(nsWMUtils::GetValueForTag(xmlDoc,</span>
<a href="#l81.316"></a><span id="l81.316" class="difflineminus">-                                                &quot;Account_Name&quot;,</span>
<a href="#l81.317"></a><span id="l81.317" class="difflineminus">-                                                value))) {</span>
<a href="#l81.318"></a><span id="l81.318" class="difflineplus">+      if (NS_SUCCEEDED(</span>
<a href="#l81.319"></a><span id="l81.319" class="difflineplus">+              nsWMUtils::GetValueForTag(xmlDoc, &quot;Account_Name&quot;, value))) {</span>
<a href="#l81.320"></a><span id="l81.320">         rv = in-&gt;SetPrettyName(value);</span>
<a href="#l81.321"></a><span id="l81.321">       }</span>
<a href="#l81.322"></a><span id="l81.322">       in-&gt;SetDoBiff(checkNewMail);</span>
<a href="#l81.323"></a><span id="l81.323">       in-&gt;SetBiffMinutes(checkNewMailTime);</span>
<a href="#l81.324"></a><span id="l81.324"> </span>
<a href="#l81.325"></a><span id="l81.325">       IMPORT_LOG2(&quot;Created IMAP server named: %S, userName: %S\n&quot;,</span>
<a href="#l81.326"></a><span id="l81.326">                   serverName.get(), userName.get());</span>
<a href="#l81.327"></a><span id="l81.327"> </span>
<a href="#l81.328"></a><span id="l81.328">       // We have a server, create an account.</span>
<a href="#l81.329"></a><span id="l81.329">       nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l81.330"></a><span id="l81.330">       rv = pMgr-&gt;CreateAccount(getter_AddRefs(account));</span>
<a href="#l81.331"></a><span id="l81.331">       if (NS_SUCCEEDED(rv) &amp;&amp; account) {</span>
<a href="#l81.332"></a><span id="l81.332">         rv = account-&gt;SetIncomingServer(in);</span>
<a href="#l81.333"></a><span id="l81.333"> </span>
<a href="#l81.334"></a><span id="l81.334" class="difflineminus">-        IMPORT_LOG0(&quot;Created an account and set the IMAP server &quot;</span>
<a href="#l81.335"></a><span id="l81.335" class="difflineminus">-                    &quot;as the incoming server\n&quot;);</span>
<a href="#l81.336"></a><span id="l81.336" class="difflineplus">+        IMPORT_LOG0(</span>
<a href="#l81.337"></a><span id="l81.337" class="difflineplus">+            &quot;Created an account and set the IMAP server &quot;</span>
<a href="#l81.338"></a><span id="l81.338" class="difflineplus">+            &quot;as the incoming server\n&quot;);</span>
<a href="#l81.339"></a><span id="l81.339"> </span>
<a href="#l81.340"></a><span id="l81.340">         // Fiddle with the identities</span>
<a href="#l81.341"></a><span id="l81.341">         SetIdentities(pMgr, account, xmlDoc, userName, authMethod, false);</span>
<a href="#l81.342"></a><span id="l81.342">         result = true;</span>
<a href="#l81.343"></a><span id="l81.343" class="difflineminus">-        if (ppAccount)</span>
<a href="#l81.344"></a><span id="l81.344" class="difflineminus">-          account.forget(ppAccount);</span>
<a href="#l81.345"></a><span id="l81.345" class="difflineplus">+        if (ppAccount) account.forget(ppAccount);</span>
<a href="#l81.346"></a><span id="l81.346">       }</span>
<a href="#l81.347"></a><span id="l81.347">     }</span>
<a href="#l81.348"></a><span id="l81.348" class="difflineminus">-  }</span>
<a href="#l81.349"></a><span id="l81.349" class="difflineminus">-  else if (NS_SUCCEEDED(rv) &amp;&amp; in) {</span>
<a href="#l81.350"></a><span id="l81.350" class="difflineplus">+  } else if (NS_SUCCEEDED(rv) &amp;&amp; in) {</span>
<a href="#l81.351"></a><span id="l81.351">     // for an existing server we create another identity,</span>
<a href="#l81.352"></a><span id="l81.352">     //  TB lists under 'manage identities'</span>
<a href="#l81.353"></a><span id="l81.353">     nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l81.354"></a><span id="l81.354">     rv = pMgr-&gt;FindAccountForServer(in, getter_AddRefs(account));</span>
<a href="#l81.355"></a><span id="l81.355">     if (NS_SUCCEEDED(rv) &amp;&amp; account) {</span>
<a href="#l81.356"></a><span id="l81.356" class="difflineminus">-      IMPORT_LOG0(&quot;Created an identity and added to existing &quot;</span>
<a href="#l81.357"></a><span id="l81.357" class="difflineminus">-                  &quot;IMAP incoming server\n&quot;);</span>
<a href="#l81.358"></a><span id="l81.358" class="difflineplus">+      IMPORT_LOG0(</span>
<a href="#l81.359"></a><span id="l81.359" class="difflineplus">+          &quot;Created an identity and added to existing &quot;</span>
<a href="#l81.360"></a><span id="l81.360" class="difflineplus">+          &quot;IMAP incoming server\n&quot;);</span>
<a href="#l81.361"></a><span id="l81.361">       // Fiddle with the identities</span>
<a href="#l81.362"></a><span id="l81.362">       in-&gt;GetAuthMethod(&amp;authMethod);</span>
<a href="#l81.363"></a><span id="l81.363">       SetIdentities(pMgr, account, xmlDoc, userName, authMethod, false);</span>
<a href="#l81.364"></a><span id="l81.364">       result = true;</span>
<a href="#l81.365"></a><span id="l81.365" class="difflineminus">-      if (ppAccount)</span>
<a href="#l81.366"></a><span id="l81.366" class="difflineminus">-        account.forget(ppAccount);</span>
<a href="#l81.367"></a><span id="l81.367" class="difflineplus">+      if (ppAccount) account.forget(ppAccount);</span>
<a href="#l81.368"></a><span id="l81.368">     }</span>
<a href="#l81.369"></a><span id="l81.369" class="difflineminus">-  }</span>
<a href="#l81.370"></a><span id="l81.370" class="difflineminus">-  else</span>
<a href="#l81.371"></a><span id="l81.371" class="difflineplus">+  } else</span>
<a href="#l81.372"></a><span id="l81.372">     result = true;</span>
<a href="#l81.373"></a><span id="l81.373">   return result;</span>
<a href="#l81.374"></a><span id="l81.374"> }</span>
<a href="#l81.375"></a><span id="l81.375"> </span>
<a href="#l81.376"></a><span id="l81.376"> bool WMSettings::DoPOP3Server(nsIMsgAccountManager *pMgr,</span>
<a href="#l81.377"></a><span id="l81.377" class="difflineminus">-                                mozilla::dom::Document *xmlDoc,</span>
<a href="#l81.378"></a><span id="l81.378" class="difflineminus">-                                const nsString&amp; serverName,</span>
<a href="#l81.379"></a><span id="l81.379" class="difflineminus">-                                nsIMsgAccount **ppAccount)</span>
<a href="#l81.380"></a><span id="l81.380" class="difflineminus">-{</span>
<a href="#l81.381"></a><span id="l81.381" class="difflineminus">-  int32_t authMethod;   // Secure Password Authentication (SPA)</span>
<a href="#l81.382"></a><span id="l81.382" class="difflineplus">+                              mozilla::dom::Document *xmlDoc,</span>
<a href="#l81.383"></a><span id="l81.383" class="difflineplus">+                              const nsString &amp;serverName,</span>
<a href="#l81.384"></a><span id="l81.384" class="difflineplus">+                              nsIMsgAccount **ppAccount) {</span>
<a href="#l81.385"></a><span id="l81.385" class="difflineplus">+  int32_t authMethod;  // Secure Password Authentication (SPA)</span>
<a href="#l81.386"></a><span id="l81.386">   nsresult errorCode;</span>
<a href="#l81.387"></a><span id="l81.387" class="difflineminus">-  if (ppAccount)</span>
<a href="#l81.388"></a><span id="l81.388" class="difflineminus">-    *ppAccount = nullptr;</span>
<a href="#l81.389"></a><span id="l81.389" class="difflineplus">+  if (ppAccount) *ppAccount = nullptr;</span>
<a href="#l81.390"></a><span id="l81.390"> </span>
<a href="#l81.391"></a><span id="l81.391">   nsAutoString userName, value;</span>
<a href="#l81.392"></a><span id="l81.392" class="difflineminus">-  if (NS_FAILED(nsWMUtils::GetValueForTag(xmlDoc,</span>
<a href="#l81.393"></a><span id="l81.393" class="difflineminus">-                                          &quot;POP3_User_Name&quot;,</span>
<a href="#l81.394"></a><span id="l81.394" class="difflineminus">-                                          userName)))</span>
<a href="#l81.395"></a><span id="l81.395" class="difflineplus">+  if (NS_FAILED(nsWMUtils::GetValueForTag(xmlDoc, &quot;POP3_User_Name&quot;, userName)))</span>
<a href="#l81.396"></a><span id="l81.396">     return false;</span>
<a href="#l81.397"></a><span id="l81.397">   bool result = false;</span>
<a href="#l81.398"></a><span id="l81.398">   // I now have a user name/server name pair, find out if it already exists?</span>
<a href="#l81.399"></a><span id="l81.399">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; in;</span>
<a href="#l81.400"></a><span id="l81.400" class="difflineminus">-  nsresult rv = pMgr-&gt;FindServer(NS_ConvertUTF16toUTF8(userName),</span>
<a href="#l81.401"></a><span id="l81.401" class="difflineminus">-                                 NS_ConvertUTF16toUTF8(serverName),</span>
<a href="#l81.402"></a><span id="l81.402" class="difflineminus">-                                 NS_LITERAL_CSTRING(&quot;pop3&quot;),</span>
<a href="#l81.403"></a><span id="l81.403" class="difflineminus">-                                 getter_AddRefs(in));</span>
<a href="#l81.404"></a><span id="l81.404" class="difflineplus">+  nsresult rv = pMgr-&gt;FindServer(</span>
<a href="#l81.405"></a><span id="l81.405" class="difflineplus">+      NS_ConvertUTF16toUTF8(userName), NS_ConvertUTF16toUTF8(serverName),</span>
<a href="#l81.406"></a><span id="l81.406" class="difflineplus">+      NS_LITERAL_CSTRING(&quot;pop3&quot;), getter_AddRefs(in));</span>
<a href="#l81.407"></a><span id="l81.407">   if (NS_FAILED(rv) || (in == nullptr)) {</span>
<a href="#l81.408"></a><span id="l81.408">     // Create the incoming server and an account for it?</span>
<a href="#l81.409"></a><span id="l81.409" class="difflineminus">-    rv = pMgr-&gt;CreateIncomingServer(NS_ConvertUTF16toUTF8(userName),</span>
<a href="#l81.410"></a><span id="l81.410" class="difflineminus">-                                    NS_ConvertUTF16toUTF8(serverName),</span>
<a href="#l81.411"></a><span id="l81.411" class="difflineminus">-                                    NS_LITERAL_CSTRING(&quot;pop3&quot;),</span>
<a href="#l81.412"></a><span id="l81.412" class="difflineminus">-                                    getter_AddRefs(in));</span>
<a href="#l81.413"></a><span id="l81.413" class="difflineplus">+    rv = pMgr-&gt;CreateIncomingServer(</span>
<a href="#l81.414"></a><span id="l81.414" class="difflineplus">+        NS_ConvertUTF16toUTF8(userName), NS_ConvertUTF16toUTF8(serverName),</span>
<a href="#l81.415"></a><span id="l81.415" class="difflineplus">+        NS_LITERAL_CSTRING(&quot;pop3&quot;), getter_AddRefs(in));</span>
<a href="#l81.416"></a><span id="l81.416">     if (NS_SUCCEEDED(rv) &amp;&amp; in) {</span>
<a href="#l81.417"></a><span id="l81.417">       nsCOMPtr&lt;nsIPop3IncomingServer&gt; pop3Server = do_QueryInterface(in);</span>
<a href="#l81.418"></a><span id="l81.418" class="difflineminus">-      if (!pop3Server){</span>
<a href="#l81.419"></a><span id="l81.419" class="difflineplus">+      if (!pop3Server) {</span>
<a href="#l81.420"></a><span id="l81.420">         IMPORT_LOG1(&quot;*** Failed to create nsIPop3IncomingServer for %S!\n&quot;,</span>
<a href="#l81.421"></a><span id="l81.421" class="difflineminus">-          serverName.get());</span>
<a href="#l81.422"></a><span id="l81.422" class="difflineplus">+                    serverName.get());</span>
<a href="#l81.423"></a><span id="l81.423">         return false;</span>
<a href="#l81.424"></a><span id="l81.424">       }</span>
<a href="#l81.425"></a><span id="l81.425"> </span>
<a href="#l81.426"></a><span id="l81.426" class="difflineminus">-      if (NS_SUCCEEDED(nsWMUtils::GetValueForTag(xmlDoc,</span>
<a href="#l81.427"></a><span id="l81.427" class="difflineminus">-                                                &quot;POP3_Secure_Connection&quot;,</span>
<a href="#l81.428"></a><span id="l81.428" class="difflineminus">-                                                value)) &amp;&amp;</span>
<a href="#l81.429"></a><span id="l81.429" class="difflineplus">+      if (NS_SUCCEEDED(nsWMUtils::GetValueForTag(</span>
<a href="#l81.430"></a><span id="l81.430" class="difflineplus">+              xmlDoc, &quot;POP3_Secure_Connection&quot;, value)) &amp;&amp;</span>
<a href="#l81.431"></a><span id="l81.431">           value.ToInteger(&amp;errorCode, 16)) {</span>
<a href="#l81.432"></a><span id="l81.432" class="difflineminus">-          in-&gt;SetSocketType(nsMsgSocketType::SSL);</span>
<a href="#l81.433"></a><span id="l81.433" class="difflineplus">+        in-&gt;SetSocketType(nsMsgSocketType::SSL);</span>
<a href="#l81.434"></a><span id="l81.434">       }</span>
<a href="#l81.435"></a><span id="l81.435" class="difflineminus">-      if (NS_SUCCEEDED(nsWMUtils::GetValueForTag(xmlDoc,</span>
<a href="#l81.436"></a><span id="l81.436" class="difflineminus">-                                                 &quot;POP3_Use_Sicily&quot;,</span>
<a href="#l81.437"></a><span id="l81.437" class="difflineminus">-                                                 value))) {</span>
<a href="#l81.438"></a><span id="l81.438" class="difflineplus">+      if (NS_SUCCEEDED(</span>
<a href="#l81.439"></a><span id="l81.439" class="difflineplus">+              nsWMUtils::GetValueForTag(xmlDoc, &quot;POP3_Use_Sicily&quot;, value))) {</span>
<a href="#l81.440"></a><span id="l81.440">         bool secAuth = (bool)value.ToInteger(&amp;errorCode, 16);</span>
<a href="#l81.441"></a><span id="l81.441" class="difflineminus">-        authMethod = secAuth ? nsMsgAuthMethod::secure :</span>
<a href="#l81.442"></a><span id="l81.442" class="difflineminus">-                               nsMsgAuthMethod::passwordCleartext;</span>
<a href="#l81.443"></a><span id="l81.443" class="difflineplus">+        authMethod = secAuth ? nsMsgAuthMethod::secure</span>
<a href="#l81.444"></a><span id="l81.444" class="difflineplus">+                             : nsMsgAuthMethod::passwordCleartext;</span>
<a href="#l81.445"></a><span id="l81.445">         in-&gt;SetAuthMethod(authMethod);</span>
<a href="#l81.446"></a><span id="l81.446">       }</span>
<a href="#l81.447"></a><span id="l81.447" class="difflineminus">-      if (NS_SUCCEEDED(nsWMUtils::GetValueForTag(xmlDoc,</span>
<a href="#l81.448"></a><span id="l81.448" class="difflineminus">-                                                 &quot;POP3_Port&quot;,</span>
<a href="#l81.449"></a><span id="l81.449" class="difflineminus">-                                                 value))) {</span>
<a href="#l81.450"></a><span id="l81.450" class="difflineplus">+      if (NS_SUCCEEDED(nsWMUtils::GetValueForTag(xmlDoc, &quot;POP3_Port&quot;, value))) {</span>
<a href="#l81.451"></a><span id="l81.451">         in-&gt;SetPort(value.ToInteger(&amp;errorCode, 16));</span>
<a href="#l81.452"></a><span id="l81.452">       }</span>
<a href="#l81.453"></a><span id="l81.453" class="difflineminus">-      if (NS_SUCCEEDED(nsWMUtils::GetValueForTag(xmlDoc,</span>
<a href="#l81.454"></a><span id="l81.454" class="difflineminus">-                                                 &quot;POP3_Skip_Account&quot;,</span>
<a href="#l81.455"></a><span id="l81.455" class="difflineminus">-                                                 value))) {</span>
<a href="#l81.456"></a><span id="l81.456" class="difflineplus">+      if (NS_SUCCEEDED(</span>
<a href="#l81.457"></a><span id="l81.457" class="difflineplus">+              nsWMUtils::GetValueForTag(xmlDoc, &quot;POP3_Skip_Account&quot;, value))) {</span>
<a href="#l81.458"></a><span id="l81.458">         if (!value.IsEmpty())</span>
<a href="#l81.459"></a><span id="l81.459">           // OE:0=='Include this account when receiving mail or synchronizing'==</span>
<a href="#l81.460"></a><span id="l81.460" class="difflineminus">-          // TB:1==ActMgr:Server:advanced:Include this server when getting new mail</span>
<a href="#l81.461"></a><span id="l81.461" class="difflineplus">+          // TB:1==ActMgr:Server:advanced:Include this server when getting new</span>
<a href="#l81.462"></a><span id="l81.462" class="difflineplus">+          // mail</span>
<a href="#l81.463"></a><span id="l81.463">           pop3Server-&gt;SetDeferGetNewMail(value.ToInteger(&amp;errorCode, 16) == 0);</span>
<a href="#l81.464"></a><span id="l81.464">         else</span>
<a href="#l81.465"></a><span id="l81.465">           pop3Server-&gt;SetDeferGetNewMail(false);</span>
<a href="#l81.466"></a><span id="l81.466">       }</span>
<a href="#l81.467"></a><span id="l81.467" class="difflineminus">-      if (NS_SUCCEEDED(nsWMUtils::GetValueForTag(xmlDoc,</span>
<a href="#l81.468"></a><span id="l81.468" class="difflineminus">-                                                 &quot;Leave_Mail_On_Server&quot;,</span>
<a href="#l81.469"></a><span id="l81.469" class="difflineplus">+      if (NS_SUCCEEDED(nsWMUtils::GetValueForTag(xmlDoc, &quot;Leave_Mail_On_Server&quot;,</span>
<a href="#l81.470"></a><span id="l81.470">                                                  value))) {</span>
<a href="#l81.471"></a><span id="l81.471" class="difflineminus">-        pop3Server-&gt;SetLeaveMessagesOnServer((bool)value.ToInteger(&amp;errorCode, 16));</span>
<a href="#l81.472"></a><span id="l81.472" class="difflineplus">+        pop3Server-&gt;SetLeaveMessagesOnServer(</span>
<a href="#l81.473"></a><span id="l81.473" class="difflineplus">+            (bool)value.ToInteger(&amp;errorCode, 16));</span>
<a href="#l81.474"></a><span id="l81.474">       }</span>
<a href="#l81.475"></a><span id="l81.475" class="difflineminus">-      if (NS_SUCCEEDED(nsWMUtils::GetValueForTag(xmlDoc,</span>
<a href="#l81.476"></a><span id="l81.476" class="difflineminus">-                                                 &quot;Remove_When_Deleted&quot;,</span>
<a href="#l81.477"></a><span id="l81.477" class="difflineplus">+      if (NS_SUCCEEDED(nsWMUtils::GetValueForTag(xmlDoc, &quot;Remove_When_Deleted&quot;,</span>
<a href="#l81.478"></a><span id="l81.478">                                                  value))) {</span>
<a href="#l81.479"></a><span id="l81.479" class="difflineminus">-        pop3Server-&gt;SetDeleteMailLeftOnServer((bool)value.ToInteger(&amp;errorCode, 16));</span>
<a href="#l81.480"></a><span id="l81.480" class="difflineplus">+        pop3Server-&gt;SetDeleteMailLeftOnServer(</span>
<a href="#l81.481"></a><span id="l81.481" class="difflineplus">+            (bool)value.ToInteger(&amp;errorCode, 16));</span>
<a href="#l81.482"></a><span id="l81.482">       }</span>
<a href="#l81.483"></a><span id="l81.483" class="difflineminus">-      if (NS_SUCCEEDED(nsWMUtils::GetValueForTag(xmlDoc,</span>
<a href="#l81.484"></a><span id="l81.484" class="difflineminus">-                                                 &quot;Remove_When_Expired&quot;,</span>
<a href="#l81.485"></a><span id="l81.485" class="difflineplus">+      if (NS_SUCCEEDED(nsWMUtils::GetValueForTag(xmlDoc, &quot;Remove_When_Expired&quot;,</span>
<a href="#l81.486"></a><span id="l81.486">                                                  value))) {</span>
<a href="#l81.487"></a><span id="l81.487" class="difflineminus">-        pop3Server-&gt;SetDeleteByAgeFromServer((bool)value.ToInteger(&amp;errorCode, 16));</span>
<a href="#l81.488"></a><span id="l81.488" class="difflineplus">+        pop3Server-&gt;SetDeleteByAgeFromServer(</span>
<a href="#l81.489"></a><span id="l81.489" class="difflineplus">+            (bool)value.ToInteger(&amp;errorCode, 16));</span>
<a href="#l81.490"></a><span id="l81.490">       }</span>
<a href="#l81.491"></a><span id="l81.491" class="difflineminus">-      if (NS_SUCCEEDED(nsWMUtils::GetValueForTag(xmlDoc,</span>
<a href="#l81.492"></a><span id="l81.492" class="difflineminus">-                                                 &quot;Expire_Days&quot;,</span>
<a href="#l81.493"></a><span id="l81.493" class="difflineminus">-                                                 value))) {</span>
<a href="#l81.494"></a><span id="l81.494" class="difflineplus">+      if (NS_SUCCEEDED(</span>
<a href="#l81.495"></a><span id="l81.495" class="difflineplus">+              nsWMUtils::GetValueForTag(xmlDoc, &quot;Expire_Days&quot;, value))) {</span>
<a href="#l81.496"></a><span id="l81.496">         pop3Server-&gt;SetNumDaysToLeaveOnServer(value.ToInteger(&amp;errorCode, 16));</span>
<a href="#l81.497"></a><span id="l81.497">       }</span>
<a href="#l81.498"></a><span id="l81.498" class="difflineminus">-      if (NS_SUCCEEDED(nsWMUtils::GetValueForTag(xmlDoc,</span>
<a href="#l81.499"></a><span id="l81.499" class="difflineminus">-                                                 &quot;Account_Name&quot;,</span>
<a href="#l81.500"></a><span id="l81.500" class="difflineminus">-                                                 value))) {</span>
<a href="#l81.501"></a><span id="l81.501" class="difflineplus">+      if (NS_SUCCEEDED(</span>
<a href="#l81.502"></a><span id="l81.502" class="difflineplus">+              nsWMUtils::GetValueForTag(xmlDoc, &quot;Account_Name&quot;, value))) {</span>
<a href="#l81.503"></a><span id="l81.503">         rv = in-&gt;SetPrettyName(value);</span>
<a href="#l81.504"></a><span id="l81.504">       }</span>
<a href="#l81.505"></a><span id="l81.505"> </span>
<a href="#l81.506"></a><span id="l81.506">       in-&gt;SetDoBiff(checkNewMail);</span>
<a href="#l81.507"></a><span id="l81.507">       in-&gt;SetBiffMinutes(checkNewMailTime);</span>
<a href="#l81.508"></a><span id="l81.508"> </span>
<a href="#l81.509"></a><span id="l81.509">       // set local folders as the Inbox to use for this POP3 server</span>
<a href="#l81.510"></a><span id="l81.510">       nsCOMPtr&lt;nsIMsgIncomingServer&gt; localFoldersServer;</span>
<a href="#l81.511"></a><span id="l81.511" class="difflineat">@@ -444,298 +402,277 @@ bool WMSettings::DoPOP3Server(nsIMsgAcco</span>
<a href="#l81.512"></a><span id="l81.512">       IMPORT_LOG2(&quot;Created POP3 server named: %S, userName: %S\n&quot;,</span>
<a href="#l81.513"></a><span id="l81.513">                   serverName.get(), userName.get());</span>
<a href="#l81.514"></a><span id="l81.514"> </span>
<a href="#l81.515"></a><span id="l81.515">       // We have a server, create an account.</span>
<a href="#l81.516"></a><span id="l81.516">       nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l81.517"></a><span id="l81.517">       rv = pMgr-&gt;CreateAccount(getter_AddRefs(account));</span>
<a href="#l81.518"></a><span id="l81.518">       if (NS_SUCCEEDED(rv) &amp;&amp; account) {</span>
<a href="#l81.519"></a><span id="l81.519">         rv = account-&gt;SetIncomingServer(in);</span>
<a href="#l81.520"></a><span id="l81.520" class="difflineminus">-        IMPORT_LOG0(&quot;Created a new account and set the incoming &quot;</span>
<a href="#l81.521"></a><span id="l81.521" class="difflineminus">-                    &quot;server to the POP3 server.\n&quot;);</span>
<a href="#l81.522"></a><span id="l81.522" class="difflineplus">+        IMPORT_LOG0(</span>
<a href="#l81.523"></a><span id="l81.523" class="difflineplus">+            &quot;Created a new account and set the incoming &quot;</span>
<a href="#l81.524"></a><span id="l81.524" class="difflineplus">+            &quot;server to the POP3 server.\n&quot;);</span>
<a href="#l81.525"></a><span id="l81.525"> </span>
<a href="#l81.526"></a><span id="l81.526">         // Fiddle with the identities</span>
<a href="#l81.527"></a><span id="l81.527">         SetIdentities(pMgr, account, xmlDoc, userName, authMethod, false);</span>
<a href="#l81.528"></a><span id="l81.528">         result = true;</span>
<a href="#l81.529"></a><span id="l81.529" class="difflineminus">-        if (ppAccount)</span>
<a href="#l81.530"></a><span id="l81.530" class="difflineminus">-          account.forget(ppAccount);</span>
<a href="#l81.531"></a><span id="l81.531" class="difflineplus">+        if (ppAccount) account.forget(ppAccount);</span>
<a href="#l81.532"></a><span id="l81.532">       }</span>
<a href="#l81.533"></a><span id="l81.533">     }</span>
<a href="#l81.534"></a><span id="l81.534" class="difflineminus">-  }</span>
<a href="#l81.535"></a><span id="l81.535" class="difflineminus">-  else if (NS_SUCCEEDED(rv) &amp;&amp; in) {</span>
<a href="#l81.536"></a><span id="l81.536" class="difflineplus">+  } else if (NS_SUCCEEDED(rv) &amp;&amp; in) {</span>
<a href="#l81.537"></a><span id="l81.537">     IMPORT_LOG2(&quot;Existing POP3 server named: %S, userName: %S\n&quot;,</span>
<a href="#l81.538"></a><span id="l81.538">                 serverName.get(), userName.get());</span>
<a href="#l81.539"></a><span id="l81.539">     // for an existing server we create another identity,</span>
<a href="#l81.540"></a><span id="l81.540">     // TB listed under 'manage identities'</span>
<a href="#l81.541"></a><span id="l81.541" class="difflineminus">-    nsCOMPtr&lt;nsIMsgAccount&gt;  account;</span>
<a href="#l81.542"></a><span id="l81.542" class="difflineplus">+    nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l81.543"></a><span id="l81.543">     rv = pMgr-&gt;FindAccountForServer(in, getter_AddRefs(account));</span>
<a href="#l81.544"></a><span id="l81.544">     if (NS_SUCCEEDED(rv) &amp;&amp; account) {</span>
<a href="#l81.545"></a><span id="l81.545" class="difflineminus">-      IMPORT_LOG0(&quot;Created identity and added to existing POP3 incoming server.\n&quot;);</span>
<a href="#l81.546"></a><span id="l81.546" class="difflineplus">+      IMPORT_LOG0(</span>
<a href="#l81.547"></a><span id="l81.547" class="difflineplus">+          &quot;Created identity and added to existing POP3 incoming server.\n&quot;);</span>
<a href="#l81.548"></a><span id="l81.548">       // Fiddle with the identities</span>
<a href="#l81.549"></a><span id="l81.549">       in-&gt;GetAuthMethod(&amp;authMethod);</span>
<a href="#l81.550"></a><span id="l81.550">       SetIdentities(pMgr, account, xmlDoc, userName, authMethod, false);</span>
<a href="#l81.551"></a><span id="l81.551">       result = true;</span>
<a href="#l81.552"></a><span id="l81.552" class="difflineminus">-      if (ppAccount)</span>
<a href="#l81.553"></a><span id="l81.553" class="difflineminus">-        account.forget(ppAccount);</span>
<a href="#l81.554"></a><span id="l81.554" class="difflineplus">+      if (ppAccount) account.forget(ppAccount);</span>
<a href="#l81.555"></a><span id="l81.555">     }</span>
<a href="#l81.556"></a><span id="l81.556" class="difflineminus">-  }</span>
<a href="#l81.557"></a><span id="l81.557" class="difflineminus">-  else</span>
<a href="#l81.558"></a><span id="l81.558" class="difflineplus">+  } else</span>
<a href="#l81.559"></a><span id="l81.559">     result = true;</span>
<a href="#l81.560"></a><span id="l81.560">   return result;</span>
<a href="#l81.561"></a><span id="l81.561"> }</span>
<a href="#l81.562"></a><span id="l81.562"> </span>
<a href="#l81.563"></a><span id="l81.563"> bool WMSettings::DoNNTPServer(nsIMsgAccountManager *pMgr,</span>
<a href="#l81.564"></a><span id="l81.564" class="difflineminus">-                                mozilla::dom::Document *xmlDoc,</span>
<a href="#l81.565"></a><span id="l81.565" class="difflineminus">-                                const nsString&amp; serverName,</span>
<a href="#l81.566"></a><span id="l81.566" class="difflineminus">-                                nsIMsgAccount **ppAccount)</span>
<a href="#l81.567"></a><span id="l81.567" class="difflineminus">-{</span>
<a href="#l81.568"></a><span id="l81.568" class="difflineplus">+                              mozilla::dom::Document *xmlDoc,</span>
<a href="#l81.569"></a><span id="l81.569" class="difflineplus">+                              const nsString &amp;serverName,</span>
<a href="#l81.570"></a><span id="l81.570" class="difflineplus">+                              nsIMsgAccount **ppAccount) {</span>
<a href="#l81.571"></a><span id="l81.571">   int32_t authMethod;</span>
<a href="#l81.572"></a><span id="l81.572">   nsresult errorCode;</span>
<a href="#l81.573"></a><span id="l81.573" class="difflineminus">-  if (ppAccount)</span>
<a href="#l81.574"></a><span id="l81.574" class="difflineminus">-    *ppAccount = nullptr;</span>
<a href="#l81.575"></a><span id="l81.575" class="difflineplus">+  if (ppAccount) *ppAccount = nullptr;</span>
<a href="#l81.576"></a><span id="l81.576"> </span>
<a href="#l81.577"></a><span id="l81.577">   nsAutoString userName, value;</span>
<a href="#l81.578"></a><span id="l81.578">   // this only exists if NNTP server requires it or not, anonymous login</span>
<a href="#l81.579"></a><span id="l81.579">   nsWMUtils::GetValueForTag(xmlDoc, &quot;NNTP_User_Name&quot;, userName);</span>
<a href="#l81.580"></a><span id="l81.580">   bool result = false;</span>
<a href="#l81.581"></a><span id="l81.581"> </span>
<a href="#l81.582"></a><span id="l81.582">   // I now have a user name/server name pair, find out if it already exists?</span>
<a href="#l81.583"></a><span id="l81.583">   // NNTP can have empty user name.  This is wild card in findserver</span>
<a href="#l81.584"></a><span id="l81.584">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; in;</span>
<a href="#l81.585"></a><span id="l81.585" class="difflineminus">-  nsresult rv = pMgr-&gt;FindServer(EmptyCString(),</span>
<a href="#l81.586"></a><span id="l81.586" class="difflineminus">-                         NS_ConvertUTF16toUTF8(serverName),</span>
<a href="#l81.587"></a><span id="l81.587" class="difflineminus">-                         NS_LITERAL_CSTRING(&quot;nntp&quot;),</span>
<a href="#l81.588"></a><span id="l81.588" class="difflineminus">-                         getter_AddRefs(in));</span>
<a href="#l81.589"></a><span id="l81.589" class="difflineplus">+  nsresult rv =</span>
<a href="#l81.590"></a><span id="l81.590" class="difflineplus">+      pMgr-&gt;FindServer(EmptyCString(), NS_ConvertUTF16toUTF8(serverName),</span>
<a href="#l81.591"></a><span id="l81.591" class="difflineplus">+                       NS_LITERAL_CSTRING(&quot;nntp&quot;), getter_AddRefs(in));</span>
<a href="#l81.592"></a><span id="l81.592">   if (NS_FAILED(rv) || (in == nullptr)) {</span>
<a href="#l81.593"></a><span id="l81.593">     // Create the incoming server and an account for it?</span>
<a href="#l81.594"></a><span id="l81.594" class="difflineminus">-    rv = pMgr-&gt;CreateIncomingServer(nsDependentCString(&quot;&quot;),</span>
<a href="#l81.595"></a><span id="l81.595" class="difflineminus">-                                    NS_ConvertUTF16toUTF8(serverName),</span>
<a href="#l81.596"></a><span id="l81.596" class="difflineminus">-                                    NS_LITERAL_CSTRING(&quot;nntp&quot;),</span>
<a href="#l81.597"></a><span id="l81.597" class="difflineminus">-                                    getter_AddRefs(in));</span>
<a href="#l81.598"></a><span id="l81.598" class="difflineplus">+    rv = pMgr-&gt;CreateIncomingServer(</span>
<a href="#l81.599"></a><span id="l81.599" class="difflineplus">+        nsDependentCString(&quot;&quot;), NS_ConvertUTF16toUTF8(serverName),</span>
<a href="#l81.600"></a><span id="l81.600" class="difflineplus">+        NS_LITERAL_CSTRING(&quot;nntp&quot;), getter_AddRefs(in));</span>
<a href="#l81.601"></a><span id="l81.601">     if (NS_SUCCEEDED(rv) &amp;&amp; in) {</span>
<a href="#l81.602"></a><span id="l81.602" class="difflineminus">-</span>
<a href="#l81.603"></a><span id="l81.603">       nsCOMPtr&lt;nsINntpIncomingServer&gt; nntpServer = do_QueryInterface(in);</span>
<a href="#l81.604"></a><span id="l81.604">       if (!nntpServer) {</span>
<a href="#l81.605"></a><span id="l81.605">         IMPORT_LOG1(&quot;*** Failed to create nsINnntpIncomingServer for %S!\n&quot;,</span>
<a href="#l81.606"></a><span id="l81.606" class="difflineminus">-          serverName.get());</span>
<a href="#l81.607"></a><span id="l81.607" class="difflineplus">+                    serverName.get());</span>
<a href="#l81.608"></a><span id="l81.608">         return false;</span>
<a href="#l81.609"></a><span id="l81.609">       }</span>
<a href="#l81.610"></a><span id="l81.610">       if (!userName.IsEmpty()) {  // if username req'd then auth req'd</span>
<a href="#l81.611"></a><span id="l81.611">         nntpServer-&gt;SetPushAuth(true);</span>
<a href="#l81.612"></a><span id="l81.612">         in-&gt;SetUsername(NS_ConvertUTF16toUTF8(userName));</span>
<a href="#l81.613"></a><span id="l81.613">       }</span>
<a href="#l81.614"></a><span id="l81.614"> </span>
<a href="#l81.615"></a><span id="l81.615">       nsAutoString value;</span>
<a href="#l81.616"></a><span id="l81.616" class="difflineminus">-      if (NS_SUCCEEDED(nsWMUtils::GetValueForTag(xmlDoc,</span>
<a href="#l81.617"></a><span id="l81.617" class="difflineminus">-                                                 &quot;NNTP_Port&quot;,</span>
<a href="#l81.618"></a><span id="l81.618" class="difflineminus">-                                                 value))) {</span>
<a href="#l81.619"></a><span id="l81.619" class="difflineplus">+      if (NS_SUCCEEDED(nsWMUtils::GetValueForTag(xmlDoc, &quot;NNTP_Port&quot;, value))) {</span>
<a href="#l81.620"></a><span id="l81.620">         in-&gt;SetPort(value.ToInteger(&amp;errorCode, 16));</span>
<a href="#l81.621"></a><span id="l81.621">       }</span>
<a href="#l81.622"></a><span id="l81.622"> </span>
<a href="#l81.623"></a><span id="l81.623" class="difflineminus">-      if (NS_SUCCEEDED(nsWMUtils::GetValueForTag(xmlDoc,</span>
<a href="#l81.624"></a><span id="l81.624" class="difflineminus">-                                                 &quot;Account_Name&quot;,</span>
<a href="#l81.625"></a><span id="l81.625" class="difflineminus">-                                                 value))) {</span>
<a href="#l81.626"></a><span id="l81.626" class="difflineplus">+      if (NS_SUCCEEDED(</span>
<a href="#l81.627"></a><span id="l81.627" class="difflineplus">+              nsWMUtils::GetValueForTag(xmlDoc, &quot;Account_Name&quot;, value))) {</span>
<a href="#l81.628"></a><span id="l81.628">         in-&gt;SetPrettyName(value);</span>
<a href="#l81.629"></a><span id="l81.629">       }</span>
<a href="#l81.630"></a><span id="l81.630"> </span>
<a href="#l81.631"></a><span id="l81.631" class="difflineminus">-      if (NS_SUCCEEDED(nsWMUtils::GetValueForTag(xmlDoc,</span>
<a href="#l81.632"></a><span id="l81.632" class="difflineminus">-                                                 &quot;NNTP_Use_Sicily&quot;,</span>
<a href="#l81.633"></a><span id="l81.633" class="difflineminus">-                                                 value))) {</span>
<a href="#l81.634"></a><span id="l81.634" class="difflineplus">+      if (NS_SUCCEEDED(</span>
<a href="#l81.635"></a><span id="l81.635" class="difflineplus">+              nsWMUtils::GetValueForTag(xmlDoc, &quot;NNTP_Use_Sicily&quot;, value))) {</span>
<a href="#l81.636"></a><span id="l81.636">         bool secAuth = (bool)value.ToInteger(&amp;errorCode, 16);</span>
<a href="#l81.637"></a><span id="l81.637" class="difflineminus">-        authMethod = secAuth ? nsMsgAuthMethod::secure :</span>
<a href="#l81.638"></a><span id="l81.638" class="difflineminus">-                               nsMsgAuthMethod::passwordCleartext;</span>
<a href="#l81.639"></a><span id="l81.639" class="difflineplus">+        authMethod = secAuth ? nsMsgAuthMethod::secure</span>
<a href="#l81.640"></a><span id="l81.640" class="difflineplus">+                             : nsMsgAuthMethod::passwordCleartext;</span>
<a href="#l81.641"></a><span id="l81.641">         in-&gt;SetAuthMethod(authMethod);</span>
<a href="#l81.642"></a><span id="l81.642">       }</span>
<a href="#l81.643"></a><span id="l81.643"> </span>
<a href="#l81.644"></a><span id="l81.644">       IMPORT_LOG2(&quot;Created NNTP server named: %S, userName: %S\n&quot;,</span>
<a href="#l81.645"></a><span id="l81.645">                   serverName.get(), userName.get());</span>
<a href="#l81.646"></a><span id="l81.646"> </span>
<a href="#l81.647"></a><span id="l81.647">       // We have a server, create an account.</span>
<a href="#l81.648"></a><span id="l81.648">       nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l81.649"></a><span id="l81.649">       rv = pMgr-&gt;CreateAccount(getter_AddRefs(account));</span>
<a href="#l81.650"></a><span id="l81.650">       if (NS_SUCCEEDED(rv) &amp;&amp; account) {</span>
<a href="#l81.651"></a><span id="l81.651">         rv = account-&gt;SetIncomingServer(in);</span>
<a href="#l81.652"></a><span id="l81.652"> </span>
<a href="#l81.653"></a><span id="l81.653" class="difflineminus">-        IMPORT_LOG0(&quot;Created an account and set the NNTP server &quot;</span>
<a href="#l81.654"></a><span id="l81.654" class="difflineminus">-                    &quot;as the incoming server\n&quot;);</span>
<a href="#l81.655"></a><span id="l81.655" class="difflineplus">+        IMPORT_LOG0(</span>
<a href="#l81.656"></a><span id="l81.656" class="difflineplus">+            &quot;Created an account and set the NNTP server &quot;</span>
<a href="#l81.657"></a><span id="l81.657" class="difflineplus">+            &quot;as the incoming server\n&quot;);</span>
<a href="#l81.658"></a><span id="l81.658"> </span>
<a href="#l81.659"></a><span id="l81.659">         // Fiddle with the identities</span>
<a href="#l81.660"></a><span id="l81.660">         SetIdentities(pMgr, account, xmlDoc, userName, authMethod, true);</span>
<a href="#l81.661"></a><span id="l81.661">         result = true;</span>
<a href="#l81.662"></a><span id="l81.662" class="difflineminus">-        if (ppAccount)</span>
<a href="#l81.663"></a><span id="l81.663" class="difflineminus">-          account.forget(ppAccount);</span>
<a href="#l81.664"></a><span id="l81.664" class="difflineplus">+        if (ppAccount) account.forget(ppAccount);</span>
<a href="#l81.665"></a><span id="l81.665">       }</span>
<a href="#l81.666"></a><span id="l81.666">     }</span>
<a href="#l81.667"></a><span id="l81.667" class="difflineminus">-  }</span>
<a href="#l81.668"></a><span id="l81.668" class="difflineminus">-  else if (NS_SUCCEEDED(rv) &amp;&amp; in) {</span>
<a href="#l81.669"></a><span id="l81.669" class="difflineplus">+  } else if (NS_SUCCEEDED(rv) &amp;&amp; in) {</span>
<a href="#l81.670"></a><span id="l81.670">     // for the existing server...</span>
<a href="#l81.671"></a><span id="l81.671">     nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l81.672"></a><span id="l81.672">     rv = pMgr-&gt;FindAccountForServer(in, getter_AddRefs(account));</span>
<a href="#l81.673"></a><span id="l81.673">     if (NS_SUCCEEDED(rv) &amp;&amp; account) {</span>
<a href="#l81.674"></a><span id="l81.674" class="difflineminus">-      IMPORT_LOG0(&quot;Using existing account and set the &quot;</span>
<a href="#l81.675"></a><span id="l81.675" class="difflineminus">-                  &quot;NNTP server as the incoming server\n&quot;);</span>
<a href="#l81.676"></a><span id="l81.676" class="difflineplus">+      IMPORT_LOG0(</span>
<a href="#l81.677"></a><span id="l81.677" class="difflineplus">+          &quot;Using existing account and set the &quot;</span>
<a href="#l81.678"></a><span id="l81.678" class="difflineplus">+          &quot;NNTP server as the incoming server\n&quot;);</span>
<a href="#l81.679"></a><span id="l81.679">       // Fiddle with the identities</span>
<a href="#l81.680"></a><span id="l81.680">       in-&gt;GetAuthMethod(&amp;authMethod);</span>
<a href="#l81.681"></a><span id="l81.681">       SetIdentities(pMgr, account, xmlDoc, userName, authMethod, true);</span>
<a href="#l81.682"></a><span id="l81.682">       result = true;</span>
<a href="#l81.683"></a><span id="l81.683" class="difflineminus">-      if (ppAccount)</span>
<a href="#l81.684"></a><span id="l81.684" class="difflineminus">-        account.forget(ppAccount);</span>
<a href="#l81.685"></a><span id="l81.685" class="difflineplus">+      if (ppAccount) account.forget(ppAccount);</span>
<a href="#l81.686"></a><span id="l81.686">     }</span>
<a href="#l81.687"></a><span id="l81.687" class="difflineminus">-  }</span>
<a href="#l81.688"></a><span id="l81.688" class="difflineminus">-  else</span>
<a href="#l81.689"></a><span id="l81.689" class="difflineplus">+  } else</span>
<a href="#l81.690"></a><span id="l81.690">     result = true;</span>
<a href="#l81.691"></a><span id="l81.691">   return result;</span>
<a href="#l81.692"></a><span id="l81.692"> }</span>
<a href="#l81.693"></a><span id="l81.693"> </span>
<a href="#l81.694"></a><span id="l81.694"> void WMSettings::SetIdentities(nsIMsgAccountManager *pMgr, nsIMsgAccount *pAcc,</span>
<a href="#l81.695"></a><span id="l81.695" class="difflineminus">-                               mozilla::dom::Document *xmlDoc, nsAutoString &amp;inUserName,</span>
<a href="#l81.696"></a><span id="l81.696" class="difflineminus">-                               int32_t authMethodIncoming, bool isNNTP)</span>
<a href="#l81.697"></a><span id="l81.697" class="difflineminus">-{</span>
<a href="#l81.698"></a><span id="l81.698" class="difflineplus">+                               mozilla::dom::Document *xmlDoc,</span>
<a href="#l81.699"></a><span id="l81.699" class="difflineplus">+                               nsAutoString &amp;inUserName,</span>
<a href="#l81.700"></a><span id="l81.700" class="difflineplus">+                               int32_t authMethodIncoming, bool isNNTP) {</span>
<a href="#l81.701"></a><span id="l81.701">   // Get the relevant information for an identity</span>
<a href="#l81.702"></a><span id="l81.702">   nsresult rv;</span>
<a href="#l81.703"></a><span id="l81.703">   nsAutoString value;</span>
<a href="#l81.704"></a><span id="l81.704"> </span>
<a href="#l81.705"></a><span id="l81.705">   nsCOMPtr&lt;nsIMsgIdentity&gt; id;</span>
<a href="#l81.706"></a><span id="l81.706">   rv = pMgr-&gt;CreateIdentity(getter_AddRefs(id));</span>
<a href="#l81.707"></a><span id="l81.707">   if (id) {</span>
<a href="#l81.708"></a><span id="l81.708">     IMPORT_LOG0(&quot;Created identity and added to the account\n&quot;);</span>
<a href="#l81.709"></a><span id="l81.709" class="difflineminus">-    if (NS_SUCCEEDED(nsWMUtils::GetValueForTag(xmlDoc,</span>
<a href="#l81.710"></a><span id="l81.710" class="difflineminus">-                                               isNNTP ?</span>
<a href="#l81.711"></a><span id="l81.711" class="difflineminus">-                                                 &quot;NNTP_Display_Name&quot; :</span>
<a href="#l81.712"></a><span id="l81.712" class="difflineminus">-                                                 &quot;SMTP_Display_Name&quot;,</span>
<a href="#l81.713"></a><span id="l81.713" class="difflineminus">-                                               value))) {</span>
<a href="#l81.714"></a><span id="l81.714" class="difflineplus">+    if (NS_SUCCEEDED(nsWMUtils::GetValueForTag(</span>
<a href="#l81.715"></a><span id="l81.715" class="difflineplus">+            xmlDoc, isNNTP ? &quot;NNTP_Display_Name&quot; : &quot;SMTP_Display_Name&quot;,</span>
<a href="#l81.716"></a><span id="l81.716" class="difflineplus">+            value))) {</span>
<a href="#l81.717"></a><span id="l81.717">       id-&gt;SetFullName(value);</span>
<a href="#l81.718"></a><span id="l81.718">       IMPORT_LOG1(&quot;\tname: %S\n&quot;, value.get());</span>
<a href="#l81.719"></a><span id="l81.719">     }</span>
<a href="#l81.720"></a><span id="l81.720"> </span>
<a href="#l81.721"></a><span id="l81.721" class="difflineminus">-    if (NS_SUCCEEDED(nsWMUtils::GetValueForTag(xmlDoc,</span>
<a href="#l81.722"></a><span id="l81.722" class="difflineminus">-                                               isNNTP ?</span>
<a href="#l81.723"></a><span id="l81.723" class="difflineminus">-                                                 &quot;NNTP_Organization_Name&quot; :</span>
<a href="#l81.724"></a><span id="l81.724" class="difflineminus">-                                                 &quot;SMTP_Organization_Name&quot;,</span>
<a href="#l81.725"></a><span id="l81.725" class="difflineminus">-                                               value))) {</span>
<a href="#l81.726"></a><span id="l81.726" class="difflineplus">+    if (NS_SUCCEEDED(nsWMUtils::GetValueForTag(</span>
<a href="#l81.727"></a><span id="l81.727" class="difflineplus">+            xmlDoc,</span>
<a href="#l81.728"></a><span id="l81.728" class="difflineplus">+            isNNTP ? &quot;NNTP_Organization_Name&quot; : &quot;SMTP_Organization_Name&quot;,</span>
<a href="#l81.729"></a><span id="l81.729" class="difflineplus">+            value))) {</span>
<a href="#l81.730"></a><span id="l81.730">       id-&gt;SetOrganization(value);</span>
<a href="#l81.731"></a><span id="l81.731">     }</span>
<a href="#l81.732"></a><span id="l81.732"> </span>
<a href="#l81.733"></a><span id="l81.733" class="difflineminus">-    if (NS_SUCCEEDED(nsWMUtils::GetValueForTag(xmlDoc,</span>
<a href="#l81.734"></a><span id="l81.734" class="difflineminus">-                                               isNNTP ?</span>
<a href="#l81.735"></a><span id="l81.735" class="difflineminus">-                                                 &quot;NNTP_Email_Address&quot; :</span>
<a href="#l81.736"></a><span id="l81.736" class="difflineminus">-                                                 &quot;SMTP_Email_Address&quot;,</span>
<a href="#l81.737"></a><span id="l81.737" class="difflineminus">-                                               value))) {</span>
<a href="#l81.738"></a><span id="l81.738" class="difflineplus">+    if (NS_SUCCEEDED(nsWMUtils::GetValueForTag(</span>
<a href="#l81.739"></a><span id="l81.739" class="difflineplus">+            xmlDoc, isNNTP ? &quot;NNTP_Email_Address&quot; : &quot;SMTP_Email_Address&quot;,</span>
<a href="#l81.740"></a><span id="l81.740" class="difflineplus">+            value))) {</span>
<a href="#l81.741"></a><span id="l81.741">       id-&gt;SetEmail(NS_ConvertUTF16toUTF8(value));</span>
<a href="#l81.742"></a><span id="l81.742">       IMPORT_LOG1(&quot;\temail: %S\n&quot;, value.get());</span>
<a href="#l81.743"></a><span id="l81.743">     }</span>
<a href="#l81.744"></a><span id="l81.744"> </span>
<a href="#l81.745"></a><span id="l81.745" class="difflineminus">-    if (NS_SUCCEEDED(nsWMUtils::GetValueForTag(xmlDoc,</span>
<a href="#l81.746"></a><span id="l81.746" class="difflineminus">-                                               isNNTP ?</span>
<a href="#l81.747"></a><span id="l81.747" class="difflineminus">-                                                 &quot;NNTP_Reply_To_Email_Address&quot; :</span>
<a href="#l81.748"></a><span id="l81.748" class="difflineminus">-                                                 &quot;SMTP_Reply_To_Email_Address&quot;,</span>
<a href="#l81.749"></a><span id="l81.749" class="difflineminus">-                                               value))) {</span>
<a href="#l81.750"></a><span id="l81.750" class="difflineplus">+    if (NS_SUCCEEDED(</span>
<a href="#l81.751"></a><span id="l81.751" class="difflineplus">+            nsWMUtils::GetValueForTag(xmlDoc,</span>
<a href="#l81.752"></a><span id="l81.752" class="difflineplus">+                                      isNNTP ? &quot;NNTP_Reply_To_Email_Address&quot;</span>
<a href="#l81.753"></a><span id="l81.753" class="difflineplus">+                                             : &quot;SMTP_Reply_To_Email_Address&quot;,</span>
<a href="#l81.754"></a><span id="l81.754" class="difflineplus">+                                      value))) {</span>
<a href="#l81.755"></a><span id="l81.755">       id-&gt;SetReplyTo(NS_ConvertUTF16toUTF8(value));</span>
<a href="#l81.756"></a><span id="l81.756">     }</span>
<a href="#l81.757"></a><span id="l81.757"> </span>
<a href="#l81.758"></a><span id="l81.758">     // Windows users are used to top style quoting.</span>
<a href="#l81.759"></a><span id="l81.759">     id-&gt;SetReplyOnTop(isNNTP ? 0 : 1);</span>
<a href="#l81.760"></a><span id="l81.760">     pAcc-&gt;AddIdentity(id);</span>
<a href="#l81.761"></a><span id="l81.761">   }</span>
<a href="#l81.762"></a><span id="l81.762"> </span>
<a href="#l81.763"></a><span id="l81.763">   if (!isNNTP)  // NNTP does not use SMTP in OE or TB</span>
<a href="#l81.764"></a><span id="l81.764">     SetSmtpServer(xmlDoc, id, inUserName, authMethodIncoming);</span>
<a href="#l81.765"></a><span id="l81.765"> }</span>
<a href="#l81.766"></a><span id="l81.766"> </span>
<a href="#l81.767"></a><span id="l81.767" class="difflineminus">-void WMSettings::SetSmtpServer(mozilla::dom::Document *xmlDoc, nsIMsgIdentity *id,</span>
<a href="#l81.768"></a><span id="l81.768" class="difflineminus">-                               nsAutoString&amp; inUserName, int32_t authMethodIncoming)</span>
<a href="#l81.769"></a><span id="l81.769" class="difflineminus">-{</span>
<a href="#l81.770"></a><span id="l81.770" class="difflineplus">+void WMSettings::SetSmtpServer(mozilla::dom::Document *xmlDoc,</span>
<a href="#l81.771"></a><span id="l81.771" class="difflineplus">+                               nsIMsgIdentity *id, nsAutoString &amp;inUserName,</span>
<a href="#l81.772"></a><span id="l81.772" class="difflineplus">+                               int32_t authMethodIncoming) {</span>
<a href="#l81.773"></a><span id="l81.773">   nsresult errorCode;</span>
<a href="#l81.774"></a><span id="l81.774"> </span>
<a href="#l81.775"></a><span id="l81.775">   // set the id.smtpserver accordingly</span>
<a href="#l81.776"></a><span id="l81.776" class="difflineminus">-  if (!id)</span>
<a href="#l81.777"></a><span id="l81.777" class="difflineminus">-    return;</span>
<a href="#l81.778"></a><span id="l81.778" class="difflineplus">+  if (!id) return;</span>
<a href="#l81.779"></a><span id="l81.779">   nsCString smtpServerKey, userName;</span>
<a href="#l81.780"></a><span id="l81.780">   nsAutoString value, smtpName;</span>
<a href="#l81.781"></a><span id="l81.781">   if (NS_FAILED(nsWMUtils::GetValueForTag(xmlDoc, &quot;SMTP_Server&quot;, smtpName)))</span>
<a href="#l81.782"></a><span id="l81.782">     return;</span>
<a href="#l81.783"></a><span id="l81.783"> </span>
<a href="#l81.784"></a><span id="l81.784">   // first we have to calculate the smtp user name which is based on sicily</span>
<a href="#l81.785"></a><span id="l81.785">   // smtp user name depends on sicily which may or not exist</span>
<a href="#l81.786"></a><span id="l81.786">   int32_t useSicily = 0;</span>
<a href="#l81.787"></a><span id="l81.787" class="difflineminus">-  if (NS_SUCCEEDED(nsWMUtils::GetValueForTag(xmlDoc,</span>
<a href="#l81.788"></a><span id="l81.788" class="difflineminus">-                                             &quot;SMTP_Use_Sicily&quot;,</span>
<a href="#l81.789"></a><span id="l81.789" class="difflineminus">-                                             value))) {</span>
<a href="#l81.790"></a><span id="l81.790" class="difflineminus">-    useSicily = (int32_t)value.ToInteger(&amp;errorCode,16);</span>
<a href="#l81.791"></a><span id="l81.791" class="difflineplus">+  if (NS_SUCCEEDED(</span>
<a href="#l81.792"></a><span id="l81.792" class="difflineplus">+          nsWMUtils::GetValueForTag(xmlDoc, &quot;SMTP_Use_Sicily&quot;, value))) {</span>
<a href="#l81.793"></a><span id="l81.793" class="difflineplus">+    useSicily = (int32_t)value.ToInteger(&amp;errorCode, 16);</span>
<a href="#l81.794"></a><span id="l81.794">   }</span>
<a href="#l81.795"></a><span id="l81.795">   switch (useSicily) {</span>
<a href="#l81.796"></a><span id="l81.796" class="difflineminus">-    case 1 : case 3 :</span>
<a href="#l81.797"></a><span id="l81.797" class="difflineminus">-      if (NS_SUCCEEDED(nsWMUtils::GetValueForTag(xmlDoc,</span>
<a href="#l81.798"></a><span id="l81.798" class="difflineminus">-                                                 &quot;SMTP_User_Name&quot;,</span>
<a href="#l81.799"></a><span id="l81.799" class="difflineminus">-                                                 value))) {</span>
<a href="#l81.800"></a><span id="l81.800" class="difflineplus">+    case 1:</span>
<a href="#l81.801"></a><span id="l81.801" class="difflineplus">+    case 3:</span>
<a href="#l81.802"></a><span id="l81.802" class="difflineplus">+      if (NS_SUCCEEDED(</span>
<a href="#l81.803"></a><span id="l81.803" class="difflineplus">+              nsWMUtils::GetValueForTag(xmlDoc, &quot;SMTP_User_Name&quot;, value))) {</span>
<a href="#l81.804"></a><span id="l81.804">         CopyUTF16toUTF8(value, userName);</span>
<a href="#l81.805"></a><span id="l81.805" class="difflineminus">-      }</span>
<a href="#l81.806"></a><span id="l81.806" class="difflineminus">-      else {</span>
<a href="#l81.807"></a><span id="l81.807" class="difflineplus">+      } else {</span>
<a href="#l81.808"></a><span id="l81.808">         CopyUTF16toUTF8(inUserName, userName);</span>
<a href="#l81.809"></a><span id="l81.809">       }</span>
<a href="#l81.810"></a><span id="l81.810">       break;</span>
<a href="#l81.811"></a><span id="l81.811" class="difflineminus">-    case 2 :</span>
<a href="#l81.812"></a><span id="l81.812" class="difflineplus">+    case 2:</span>
<a href="#l81.813"></a><span id="l81.813">       CopyUTF16toUTF8(inUserName, userName);</span>
<a href="#l81.814"></a><span id="l81.814">       break;</span>
<a href="#l81.815"></a><span id="l81.815" class="difflineminus">-    default :</span>
<a href="#l81.816"></a><span id="l81.816" class="difflineminus">-      break; // initial userName == &quot;&quot;</span>
<a href="#l81.817"></a><span id="l81.817" class="difflineplus">+    default:</span>
<a href="#l81.818"></a><span id="l81.818" class="difflineplus">+      break;  // initial userName == &quot;&quot;</span>
<a href="#l81.819"></a><span id="l81.819">   }</span>
<a href="#l81.820"></a><span id="l81.820"> </span>
<a href="#l81.821"></a><span id="l81.821">   nsresult rv;</span>
<a href="#l81.822"></a><span id="l81.822" class="difflineminus">-  nsCOMPtr&lt;nsISmtpService&gt;</span>
<a href="#l81.823"></a><span id="l81.823" class="difflineminus">-    smtpService(do_GetService(NS_SMTPSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l81.824"></a><span id="l81.824" class="difflineplus">+  nsCOMPtr&lt;nsISmtpService&gt; smtpService(</span>
<a href="#l81.825"></a><span id="l81.825" class="difflineplus">+      do_GetService(NS_SMTPSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l81.826"></a><span id="l81.826">   if (NS_SUCCEEDED(rv) &amp;&amp; smtpService) {</span>
<a href="#l81.827"></a><span id="l81.827">     nsCOMPtr&lt;nsISmtpServer&gt; extgServer;</span>
<a href="#l81.828"></a><span id="l81.828">     // don't try to make another server</span>
<a href="#l81.829"></a><span id="l81.829">     // regardless if username doesn't match</span>
<a href="#l81.830"></a><span id="l81.830">     rv = smtpService-&gt;FindServer(userName.get(),</span>
<a href="#l81.831"></a><span id="l81.831">                                  NS_ConvertUTF16toUTF8(smtpName).get(),</span>
<a href="#l81.832"></a><span id="l81.832">                                  getter_AddRefs(extgServer));</span>
<a href="#l81.833"></a><span id="l81.833">     if (NS_SUCCEEDED(rv) &amp;&amp; extgServer) {</span>
<a href="#l81.834"></a><span id="l81.834">       // set our account keyed to this smptserver key</span>
<a href="#l81.835"></a><span id="l81.835">       extgServer-&gt;GetKey(getter_Copies(smtpServerKey));</span>
<a href="#l81.836"></a><span id="l81.836">       id-&gt;SetSmtpServerKey(smtpServerKey);</span>
<a href="#l81.837"></a><span id="l81.837"> </span>
<a href="#l81.838"></a><span id="l81.838" class="difflineminus">-      IMPORT_LOG1(&quot;SMTP server already exists: %s\n&quot;, NS_ConvertUTF16toUTF8(smtpName).get());</span>
<a href="#l81.839"></a><span id="l81.839" class="difflineminus">-    }</span>
<a href="#l81.840"></a><span id="l81.840" class="difflineminus">-    else {</span>
<a href="#l81.841"></a><span id="l81.841" class="difflineplus">+      IMPORT_LOG1(&quot;SMTP server already exists: %s\n&quot;,</span>
<a href="#l81.842"></a><span id="l81.842" class="difflineplus">+                  NS_ConvertUTF16toUTF8(smtpName).get());</span>
<a href="#l81.843"></a><span id="l81.843" class="difflineplus">+    } else {</span>
<a href="#l81.844"></a><span id="l81.844">       nsCOMPtr&lt;nsISmtpServer&gt; smtpServer;</span>
<a href="#l81.845"></a><span id="l81.845">       rv = smtpService-&gt;CreateServer(getter_AddRefs(smtpServer));</span>
<a href="#l81.846"></a><span id="l81.846">       if (NS_SUCCEEDED(rv) &amp;&amp; smtpServer) {</span>
<a href="#l81.847"></a><span id="l81.847" class="difflineminus">-        if (NS_SUCCEEDED(nsWMUtils::GetValueForTag(xmlDoc,</span>
<a href="#l81.848"></a><span id="l81.848" class="difflineminus">-                                                   &quot;SMTP_Port&quot;,</span>
<a href="#l81.849"></a><span id="l81.849" class="difflineminus">-                                                   value))) {</span>
<a href="#l81.850"></a><span id="l81.850" class="difflineminus">-          smtpServer-&gt;SetPort(value.ToInteger(&amp;errorCode,16));</span>
<a href="#l81.851"></a><span id="l81.851" class="difflineplus">+        if (NS_SUCCEEDED(</span>
<a href="#l81.852"></a><span id="l81.852" class="difflineplus">+                nsWMUtils::GetValueForTag(xmlDoc, &quot;SMTP_Port&quot;, value))) {</span>
<a href="#l81.853"></a><span id="l81.853" class="difflineplus">+          smtpServer-&gt;SetPort(value.ToInteger(&amp;errorCode, 16));</span>
<a href="#l81.854"></a><span id="l81.854">         }</span>
<a href="#l81.855"></a><span id="l81.855"> </span>
<a href="#l81.856"></a><span id="l81.856" class="difflineminus">-        if (NS_SUCCEEDED(nsWMUtils::GetValueForTag(xmlDoc,</span>
<a href="#l81.857"></a><span id="l81.857" class="difflineminus">-                                                   &quot;SMTP_Secure_Connection&quot;,</span>
<a href="#l81.858"></a><span id="l81.858" class="difflineminus">-                                                   value))) {</span>
<a href="#l81.859"></a><span id="l81.859" class="difflineplus">+        if (NS_SUCCEEDED(nsWMUtils::GetValueForTag(</span>
<a href="#l81.860"></a><span id="l81.860" class="difflineplus">+                xmlDoc, &quot;SMTP_Secure_Connection&quot;, value))) {</span>
<a href="#l81.861"></a><span id="l81.861">           if (value.ToInteger(&amp;errorCode, 16) == 1)</span>
<a href="#l81.862"></a><span id="l81.862">             smtpServer-&gt;SetSocketType(nsMsgSocketType::SSL);</span>
<a href="#l81.863"></a><span id="l81.863">           else</span>
<a href="#l81.864"></a><span id="l81.864">             smtpServer-&gt;SetSocketType(nsMsgSocketType::plain);</span>
<a href="#l81.865"></a><span id="l81.865">         }</span>
<a href="#l81.866"></a><span id="l81.866">         smtpServer-&gt;SetUsername(userName);</span>
<a href="#l81.867"></a><span id="l81.867">         switch (useSicily) {</span>
<a href="#l81.868"></a><span id="l81.868" class="difflineminus">-          case 1 :</span>
<a href="#l81.869"></a><span id="l81.869" class="difflineplus">+          case 1:</span>
<a href="#l81.870"></a><span id="l81.870">             smtpServer-&gt;SetAuthMethod(nsMsgAuthMethod::secure);</span>
<a href="#l81.871"></a><span id="l81.871">             break;</span>
<a href="#l81.872"></a><span id="l81.872" class="difflineminus">-           case 2 : // requires SMTP authentication to use the incoming server settings</span>
<a href="#l81.873"></a><span id="l81.873" class="difflineplus">+          case 2:  // requires SMTP authentication to use the incoming server</span>
<a href="#l81.874"></a><span id="l81.874" class="difflineplus">+                   // settings</span>
<a href="#l81.875"></a><span id="l81.875">             smtpServer-&gt;SetAuthMethod(authMethodIncoming);</span>
<a href="#l81.876"></a><span id="l81.876">             break;</span>
<a href="#l81.877"></a><span id="l81.877" class="difflineminus">-          case 3 :</span>
<a href="#l81.878"></a><span id="l81.878" class="difflineplus">+          case 3:</span>
<a href="#l81.879"></a><span id="l81.879">             smtpServer-&gt;SetAuthMethod(nsMsgAuthMethod::passwordCleartext);</span>
<a href="#l81.880"></a><span id="l81.880">             break;</span>
<a href="#l81.881"></a><span id="l81.881">           default:</span>
<a href="#l81.882"></a><span id="l81.882">             smtpServer-&gt;SetAuthMethod(nsMsgAuthMethod::none);</span>
<a href="#l81.883"></a><span id="l81.883">         }</span>
<a href="#l81.884"></a><span id="l81.884"> </span>
<a href="#l81.885"></a><span id="l81.885">         smtpServer-&gt;SetHostname(NS_ConvertUTF16toUTF8(smtpName));</span>
<a href="#l81.886"></a><span id="l81.886"> </span>
<a href="#l81.887"></a><span id="l81.887">         smtpServer-&gt;GetKey(getter_Copies(smtpServerKey));</span>
<a href="#l81.888"></a><span id="l81.888">         id-&gt;SetSmtpServerKey(smtpServerKey);</span>
<a href="#l81.889"></a><span id="l81.889"> </span>
<a href="#l81.890"></a><span id="l81.890" class="difflineminus">-        IMPORT_LOG1(&quot;Created new SMTP server: %s\n&quot;, NS_ConvertUTF16toUTF8(smtpName).get());</span>
<a href="#l81.891"></a><span id="l81.891" class="difflineplus">+        IMPORT_LOG1(&quot;Created new SMTP server: %s\n&quot;,</span>
<a href="#l81.892"></a><span id="l81.892" class="difflineplus">+                    NS_ConvertUTF16toUTF8(smtpName).get());</span>
<a href="#l81.893"></a><span id="l81.893">       }</span>
<a href="#l81.894"></a><span id="l81.894">     }</span>
<a href="#l81.895"></a><span id="l81.895">   }</span>
<a href="#l81.896"></a><span id="l81.896"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l82.1"></a><span id="l82.1" class="difflineminus">--- a/mailnews/import/winlivemail/nsWMSettings.h</span>
<a href="#l82.2"></a><span id="l82.2" class="difflineplus">+++ b/mailnews/import/winlivemail/nsWMSettings.h</span>
<a href="#l82.3"></a><span id="l82.3" class="difflineat">@@ -4,19 +4,19 @@</span>
<a href="#l82.4"></a><span id="l82.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l82.5"></a><span id="l82.5"> </span>
<a href="#l82.6"></a><span id="l82.6"> #ifndef nsWMSettings_h___</span>
<a href="#l82.7"></a><span id="l82.7"> #define nsWMSettings_h___</span>
<a href="#l82.8"></a><span id="l82.8"> </span>
<a href="#l82.9"></a><span id="l82.9"> #include &quot;nsIImportSettings.h&quot;</span>
<a href="#l82.10"></a><span id="l82.10"> </span>
<a href="#l82.11"></a><span id="l82.11"> class nsWMSettings : public nsIImportSettings {</span>
<a href="#l82.12"></a><span id="l82.12" class="difflineminus">-public:</span>
<a href="#l82.13"></a><span id="l82.13" class="difflineplus">+ public:</span>
<a href="#l82.14"></a><span id="l82.14">   nsWMSettings();</span>
<a href="#l82.15"></a><span id="l82.15">   static nsresult Create(nsIImportSettings** aImport);</span>
<a href="#l82.16"></a><span id="l82.16">   NS_DECL_ISUPPORTS</span>
<a href="#l82.17"></a><span id="l82.17">   NS_DECL_NSIIMPORTSETTINGS</span>
<a href="#l82.18"></a><span id="l82.18"> </span>
<a href="#l82.19"></a><span id="l82.19" class="difflineminus">-private:</span>
<a href="#l82.20"></a><span id="l82.20" class="difflineplus">+ private:</span>
<a href="#l82.21"></a><span id="l82.21">   virtual ~nsWMSettings();</span>
<a href="#l82.22"></a><span id="l82.22"> };</span>
<a href="#l82.23"></a><span id="l82.23"> </span>
<a href="#l82.24"></a><span id="l82.24"> #endif /* nsWMSettings_h___ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l83.1"></a><span id="l83.1" class="difflineminus">--- a/mailnews/import/winlivemail/nsWMStringBundle.cpp</span>
<a href="#l83.2"></a><span id="l83.2" class="difflineplus">+++ b/mailnews/import/winlivemail/nsWMStringBundle.cpp</span>
<a href="#l83.3"></a><span id="l83.3" class="difflineat">@@ -6,56 +6,47 @@</span>
<a href="#l83.4"></a><span id="l83.4"> #include &quot;prprf.h&quot;</span>
<a href="#l83.5"></a><span id="l83.5"> #include &quot;prmem.h&quot;</span>
<a href="#l83.6"></a><span id="l83.6"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l83.7"></a><span id="l83.7"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l83.8"></a><span id="l83.8"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l83.9"></a><span id="l83.9"> #include &quot;nsWMStringBundle.h&quot;</span>
<a href="#l83.10"></a><span id="l83.10"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l83.11"></a><span id="l83.11"> </span>
<a href="#l83.12"></a><span id="l83.12" class="difflineminus">-#define WM_MSGS_URL       &quot;chrome://messenger/locale/wmImportMsgs.properties&quot;</span>
<a href="#l83.13"></a><span id="l83.13" class="difflineplus">+#define WM_MSGS_URL &quot;chrome://messenger/locale/wmImportMsgs.properties&quot;</span>
<a href="#l83.14"></a><span id="l83.14"> </span>
<a href="#l83.15"></a><span id="l83.15"> nsCOMPtr&lt;nsIStringBundle&gt; nsWMStringBundle::m_pBundle = nullptr;</span>
<a href="#l83.16"></a><span id="l83.16"> </span>
<a href="#l83.17"></a><span id="l83.17" class="difflineminus">-void nsWMStringBundle::GetStringBundle(void)</span>
<a href="#l83.18"></a><span id="l83.18" class="difflineminus">-{</span>
<a href="#l83.19"></a><span id="l83.19" class="difflineminus">-  if (m_pBundle)</span>
<a href="#l83.20"></a><span id="l83.20" class="difflineminus">-    return;</span>
<a href="#l83.21"></a><span id="l83.21" class="difflineplus">+void nsWMStringBundle::GetStringBundle(void) {</span>
<a href="#l83.22"></a><span id="l83.22" class="difflineplus">+  if (m_pBundle) return;</span>
<a href="#l83.23"></a><span id="l83.23"> </span>
<a href="#l83.24"></a><span id="l83.24">   nsCOMPtr&lt;nsIStringBundleService&gt; sBundleService =</span>
<a href="#l83.25"></a><span id="l83.25" class="difflineminus">-    mozilla::services::GetStringBundleService();</span>
<a href="#l83.26"></a><span id="l83.26" class="difflineplus">+      mozilla::services::GetStringBundleService();</span>
<a href="#l83.27"></a><span id="l83.27">   if (sBundleService) {</span>
<a href="#l83.28"></a><span id="l83.28">     sBundleService-&gt;CreateBundle(WM_MSGS_URL, getter_AddRefs(m_pBundle));</span>
<a href="#l83.29"></a><span id="l83.29">   }</span>
<a href="#l83.30"></a><span id="l83.30"> }</span>
<a href="#l83.31"></a><span id="l83.31"> </span>
<a href="#l83.32"></a><span id="l83.32" class="difflineminus">-void nsWMStringBundle::GetStringByID(int32_t stringID, nsString&amp; result)</span>
<a href="#l83.33"></a><span id="l83.33" class="difflineminus">-{</span>
<a href="#l83.34"></a><span id="l83.34" class="difflineplus">+void nsWMStringBundle::GetStringByID(int32_t stringID, nsString &amp;result) {</span>
<a href="#l83.35"></a><span id="l83.35">   char16_t *ptrv = GetStringByID(stringID);</span>
<a href="#l83.36"></a><span id="l83.36">   result = ptrv;</span>
<a href="#l83.37"></a><span id="l83.37">   FreeString(ptrv);</span>
<a href="#l83.38"></a><span id="l83.38"> }</span>
<a href="#l83.39"></a><span id="l83.39"> </span>
<a href="#l83.40"></a><span id="l83.40" class="difflineminus">-char16_t *nsWMStringBundle::GetStringByID(int32_t stringID)</span>
<a href="#l83.41"></a><span id="l83.41" class="difflineminus">-{</span>
<a href="#l83.42"></a><span id="l83.42" class="difflineminus">-  if (!m_pBundle)</span>
<a href="#l83.43"></a><span id="l83.43" class="difflineminus">-    GetStringBundle();</span>
<a href="#l83.44"></a><span id="l83.44" class="difflineplus">+char16_t *nsWMStringBundle::GetStringByID(int32_t stringID) {</span>
<a href="#l83.45"></a><span id="l83.45" class="difflineplus">+  if (!m_pBundle) GetStringBundle();</span>
<a href="#l83.46"></a><span id="l83.46"> </span>
<a href="#l83.47"></a><span id="l83.47">   if (m_pBundle) {</span>
<a href="#l83.48"></a><span id="l83.48">     nsAutoString str;</span>
<a href="#l83.49"></a><span id="l83.49">     nsresult rv = m_pBundle-&gt;GetStringFromID(stringID, str);</span>
<a href="#l83.50"></a><span id="l83.50"> </span>
<a href="#l83.51"></a><span id="l83.51" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l83.52"></a><span id="l83.52" class="difflineminus">-      return ToNewUnicode(str);</span>
<a href="#l83.53"></a><span id="l83.53" class="difflineplus">+    if (NS_SUCCEEDED(rv)) return ToNewUnicode(str);</span>
<a href="#l83.54"></a><span id="l83.54">   }</span>
<a href="#l83.55"></a><span id="l83.55"> </span>
<a href="#l83.56"></a><span id="l83.56">   nsString resultString;</span>
<a href="#l83.57"></a><span id="l83.57">   resultString.AppendLiteral(&quot;[StringID &quot;);</span>
<a href="#l83.58"></a><span id="l83.58">   resultString.AppendInt(stringID);</span>
<a href="#l83.59"></a><span id="l83.59">   resultString.AppendLiteral(&quot;?]&quot;);</span>
<a href="#l83.60"></a><span id="l83.60"> </span>
<a href="#l83.61"></a><span id="l83.61">   return ToNewUnicode(resultString);</span>
<a href="#l83.62"></a><span id="l83.62"> }</span>
<a href="#l83.63"></a><span id="l83.63"> </span>
<a href="#l83.64"></a><span id="l83.64" class="difflineminus">-void nsWMStringBundle::Cleanup(void)</span>
<a href="#l83.65"></a><span id="l83.65" class="difflineminus">-{</span>
<a href="#l83.66"></a><span id="l83.66" class="difflineminus">-  m_pBundle = nullptr;</span>
<a href="#l83.67"></a><span id="l83.67" class="difflineminus">-}</span>
<a href="#l83.68"></a><span id="l83.68" class="difflineplus">+void nsWMStringBundle::Cleanup(void) { m_pBundle = nullptr; }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l84.1"></a><span id="l84.1" class="difflineminus">--- a/mailnews/import/winlivemail/nsWMStringBundle.h</span>
<a href="#l84.2"></a><span id="l84.2" class="difflineplus">+++ b/mailnews/import/winlivemail/nsWMStringBundle.h</span>
<a href="#l84.3"></a><span id="l84.3" class="difflineat">@@ -5,34 +5,32 @@</span>
<a href="#l84.4"></a><span id="l84.4"> #ifndef _nsWMStringBundle_H__</span>
<a href="#l84.5"></a><span id="l84.5"> #define _nsWMStringBundle_H__</span>
<a href="#l84.6"></a><span id="l84.6"> </span>
<a href="#l84.7"></a><span id="l84.7"> #include &quot;nsString.h&quot;</span>
<a href="#l84.8"></a><span id="l84.8"> </span>
<a href="#l84.9"></a><span id="l84.9"> class nsIStringBundle;</span>
<a href="#l84.10"></a><span id="l84.10"> </span>
<a href="#l84.11"></a><span id="l84.11"> class nsWMStringBundle {</span>
<a href="#l84.12"></a><span id="l84.12" class="difflineminus">-public:</span>
<a href="#l84.13"></a><span id="l84.13" class="difflineminus">-  static char16_t     *    GetStringByID(int32_t stringID);</span>
<a href="#l84.14"></a><span id="l84.14" class="difflineminus">-  static void          GetStringByID(int32_t stringID, nsString&amp; result);</span>
<a href="#l84.15"></a><span id="l84.15" class="difflineminus">-  static void          GetStringBundle(void);</span>
<a href="#l84.16"></a><span id="l84.16" class="difflineminus">-  static void          FreeString(char16_t *pStr) { free(pStr);}</span>
<a href="#l84.17"></a><span id="l84.17" class="difflineminus">-  static void          Cleanup(void);</span>
<a href="#l84.18"></a><span id="l84.18" class="difflineplus">+ public:</span>
<a href="#l84.19"></a><span id="l84.19" class="difflineplus">+  static char16_t* GetStringByID(int32_t stringID);</span>
<a href="#l84.20"></a><span id="l84.20" class="difflineplus">+  static void GetStringByID(int32_t stringID, nsString&amp; result);</span>
<a href="#l84.21"></a><span id="l84.21" class="difflineplus">+  static void GetStringBundle(void);</span>
<a href="#l84.22"></a><span id="l84.22" class="difflineplus">+  static void FreeString(char16_t* pStr) { free(pStr); }</span>
<a href="#l84.23"></a><span id="l84.23" class="difflineplus">+  static void Cleanup(void);</span>
<a href="#l84.24"></a><span id="l84.24"> </span>
<a href="#l84.25"></a><span id="l84.25" class="difflineminus">-private:</span>
<a href="#l84.26"></a><span id="l84.26" class="difflineplus">+ private:</span>
<a href="#l84.27"></a><span id="l84.27">   static nsCOMPtr&lt;nsIStringBundle&gt; m_pBundle;</span>
<a href="#l84.28"></a><span id="l84.28"> };</span>
<a href="#l84.29"></a><span id="l84.29"> </span>
<a href="#l84.30"></a><span id="l84.30" class="difflineminus">-</span>
<a href="#l84.31"></a><span id="l84.31" class="difflineminus">-</span>
<a href="#l84.32"></a><span id="l84.32" class="difflineminus">-#define WMIMPORT_NAME                     2000</span>
<a href="#l84.33"></a><span id="l84.33" class="difflineminus">-#define WMIMPORT_DESCRIPTION              2001</span>
<a href="#l84.34"></a><span id="l84.34" class="difflineminus">-#define WMIMPORT_MAILBOX_SUCCESS          2002</span>
<a href="#l84.35"></a><span id="l84.35" class="difflineminus">-#define WMIMPORT_MAILBOX_BADPARAM         2003</span>
<a href="#l84.36"></a><span id="l84.36" class="difflineminus">-#define WMIMPORT_MAILBOX_BADSOURCEFILE    2004</span>
<a href="#l84.37"></a><span id="l84.37" class="difflineminus">-#define WMIMPORT_MAILBOX_CONVERTERROR     2005</span>
<a href="#l84.38"></a><span id="l84.38" class="difflineminus">-#define WMIMPORT_DEFAULT_NAME             2006</span>
<a href="#l84.39"></a><span id="l84.39" class="difflineminus">-#define WMIMPORT_AUTOFIND                 2007</span>
<a href="#l84.40"></a><span id="l84.40" class="difflineminus">-#define WMIMPORT_ADDRESS_SUCCESS          2008</span>
<a href="#l84.41"></a><span id="l84.41" class="difflineminus">-#define WMIMPORT_ADDRESS_CONVERTERROR     2009</span>
<a href="#l84.42"></a><span id="l84.42" class="difflineminus">-#define WMIMPORT_ADDRESS_BADPARAM         2010</span>
<a href="#l84.43"></a><span id="l84.43" class="difflineplus">+#define WMIMPORT_NAME 2000</span>
<a href="#l84.44"></a><span id="l84.44" class="difflineplus">+#define WMIMPORT_DESCRIPTION 2001</span>
<a href="#l84.45"></a><span id="l84.45" class="difflineplus">+#define WMIMPORT_MAILBOX_SUCCESS 2002</span>
<a href="#l84.46"></a><span id="l84.46" class="difflineplus">+#define WMIMPORT_MAILBOX_BADPARAM 2003</span>
<a href="#l84.47"></a><span id="l84.47" class="difflineplus">+#define WMIMPORT_MAILBOX_BADSOURCEFILE 2004</span>
<a href="#l84.48"></a><span id="l84.48" class="difflineplus">+#define WMIMPORT_MAILBOX_CONVERTERROR 2005</span>
<a href="#l84.49"></a><span id="l84.49" class="difflineplus">+#define WMIMPORT_DEFAULT_NAME 2006</span>
<a href="#l84.50"></a><span id="l84.50" class="difflineplus">+#define WMIMPORT_AUTOFIND 2007</span>
<a href="#l84.51"></a><span id="l84.51" class="difflineplus">+#define WMIMPORT_ADDRESS_SUCCESS 2008</span>
<a href="#l84.52"></a><span id="l84.52" class="difflineplus">+#define WMIMPORT_ADDRESS_CONVERTERROR 2009</span>
<a href="#l84.53"></a><span id="l84.53" class="difflineplus">+#define WMIMPORT_ADDRESS_BADPARAM 2010</span>
<a href="#l84.54"></a><span id="l84.54"> </span>
<a href="#l84.55"></a><span id="l84.55"> #endif /* _nsWMStringBundle_H__ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l85.1"></a><span id="l85.1" class="difflineminus">--- a/mailnews/import/winlivemail/nsWMUtils.cpp</span>
<a href="#l85.2"></a><span id="l85.2" class="difflineplus">+++ b/mailnews/import/winlivemail/nsWMUtils.cpp</span>
<a href="#l85.3"></a><span id="l85.3" class="difflineat">@@ -1,11 +1,11 @@</span>
<a href="#l85.4"></a><span id="l85.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l85.5"></a><span id="l85.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l85.6"></a><span id="l85.6" class="difflineminus">-  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l85.7"></a><span id="l85.7" class="difflineplus">+ * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l85.8"></a><span id="l85.8"> </span>
<a href="#l85.9"></a><span id="l85.9"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l85.10"></a><span id="l85.10"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l85.11"></a><span id="l85.11"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l85.12"></a><span id="l85.12"> #include &quot;nsNetCID.h&quot;</span>
<a href="#l85.13"></a><span id="l85.13"> #include &quot;nsString.h&quot;</span>
<a href="#l85.14"></a><span id="l85.14"> #include &quot;mozilla/dom/Document.h&quot;</span>
<a href="#l85.15"></a><span id="l85.15"> #include &quot;nsWMUtils.h&quot;</span>
<a href="#l85.16"></a><span id="l85.16" class="difflineat">@@ -15,22 +15,20 @@</span>
<a href="#l85.17"></a><span id="l85.17"> #include &quot;nsIFileStreams.h&quot;</span>
<a href="#l85.18"></a><span id="l85.18"> #include &quot;nsIFile.h&quot;</span>
<a href="#l85.19"></a><span id="l85.19"> #include &quot;nsIDirectoryEnumerator.h&quot;</span>
<a href="#l85.20"></a><span id="l85.20"> #include &quot;ImportDebug.h&quot;</span>
<a href="#l85.21"></a><span id="l85.21"> #include &quot;prio.h&quot;</span>
<a href="#l85.22"></a><span id="l85.22"> #include &quot;mozilla/ErrorResult.h&quot;</span>
<a href="#l85.23"></a><span id="l85.23"> #include &quot;mozilla/dom/DOMParser.h&quot;</span>
<a href="#l85.24"></a><span id="l85.24"> </span>
<a href="#l85.25"></a><span id="l85.25" class="difflineminus">-nsresult</span>
<a href="#l85.26"></a><span id="l85.26" class="difflineminus">-nsWMUtils::FindWMKey(nsIWindowsRegKey **aKey)</span>
<a href="#l85.27"></a><span id="l85.27" class="difflineminus">-{</span>
<a href="#l85.28"></a><span id="l85.28" class="difflineplus">+nsresult nsWMUtils::FindWMKey(nsIWindowsRegKey **aKey) {</span>
<a href="#l85.29"></a><span id="l85.29">   nsresult rv;</span>
<a href="#l85.30"></a><span id="l85.30">   nsCOMPtr&lt;nsIWindowsRegKey&gt; key =</span>
<a href="#l85.31"></a><span id="l85.31" class="difflineminus">-    do_CreateInstance(&quot;@mozilla.org/windows-registry-key;1&quot;, &amp;rv);</span>
<a href="#l85.32"></a><span id="l85.32" class="difflineplus">+      do_CreateInstance(&quot;@mozilla.org/windows-registry-key;1&quot;, &amp;rv);</span>
<a href="#l85.33"></a><span id="l85.33">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l85.34"></a><span id="l85.34"> </span>
<a href="#l85.35"></a><span id="l85.35">   rv = key-&gt;Open(nsIWindowsRegKey::ROOT_KEY_CURRENT_USER,</span>
<a href="#l85.36"></a><span id="l85.36">                  NS_LITERAL_STRING(&quot;Software\\Microsoft\\Windows Live Mail&quot;),</span>
<a href="#l85.37"></a><span id="l85.37">                  nsIWindowsRegKey::ACCESS_QUERY_VALUE);</span>
<a href="#l85.38"></a><span id="l85.38">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l85.39"></a><span id="l85.39">     key.forget(aKey);</span>
<a href="#l85.40"></a><span id="l85.40">     return rv;</span>
<a href="#l85.41"></a><span id="l85.41" class="difflineat">@@ -38,131 +36,120 @@ nsWMUtils::FindWMKey(nsIWindowsRegKey **</span>
<a href="#l85.42"></a><span id="l85.42"> </span>
<a href="#l85.43"></a><span id="l85.43">   rv = key-&gt;Open(nsIWindowsRegKey::ROOT_KEY_CURRENT_USER,</span>
<a href="#l85.44"></a><span id="l85.44">                  NS_LITERAL_STRING(&quot;Software\\Microsoft\\Windows Mail&quot;),</span>
<a href="#l85.45"></a><span id="l85.45">                  nsIWindowsRegKey::ACCESS_QUERY_VALUE);</span>
<a href="#l85.46"></a><span id="l85.46">   key.forget(aKey);</span>
<a href="#l85.47"></a><span id="l85.47">   return rv;</span>
<a href="#l85.48"></a><span id="l85.48"> }</span>
<a href="#l85.49"></a><span id="l85.49"> </span>
<a href="#l85.50"></a><span id="l85.50" class="difflineminus">-nsresult</span>
<a href="#l85.51"></a><span id="l85.51" class="difflineminus">-nsWMUtils::GetRootFolder(nsIFile **aRootFolder)</span>
<a href="#l85.52"></a><span id="l85.52" class="difflineminus">-{</span>
<a href="#l85.53"></a><span id="l85.53" class="difflineplus">+nsresult nsWMUtils::GetRootFolder(nsIFile **aRootFolder) {</span>
<a href="#l85.54"></a><span id="l85.54">   nsCOMPtr&lt;nsIWindowsRegKey&gt; key;</span>
<a href="#l85.55"></a><span id="l85.55">   if (NS_FAILED(nsWMUtils::FindWMKey(getter_AddRefs(key)))) {</span>
<a href="#l85.56"></a><span id="l85.56">     IMPORT_LOG0(&quot;*** Error finding Windows Live Mail registry account keys\n&quot;);</span>
<a href="#l85.57"></a><span id="l85.57">     return NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l85.58"></a><span id="l85.58">   }</span>
<a href="#l85.59"></a><span id="l85.59" class="difflineminus">-  // This is essential to proceed; it is the location on disk of xml-type account files;</span>
<a href="#l85.60"></a><span id="l85.60" class="difflineminus">-  // it is in reg_expand_sz so it will need expanding to absolute path.</span>
<a href="#l85.61"></a><span id="l85.61" class="difflineminus">-  nsString  storeRoot;</span>
<a href="#l85.62"></a><span id="l85.62" class="difflineminus">-  nsresult rv = key-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;Store Root&quot;), storeRoot);</span>
<a href="#l85.63"></a><span id="l85.63" class="difflineminus">-  key-&gt;Close();  // Finished with windows registry key. We do not want to return before this closing</span>
<a href="#l85.64"></a><span id="l85.64" class="difflineplus">+  // This is essential to proceed; it is the location on disk of xml-type</span>
<a href="#l85.65"></a><span id="l85.65" class="difflineplus">+  // account files; it is in reg_expand_sz so it will need expanding to absolute</span>
<a href="#l85.66"></a><span id="l85.66" class="difflineplus">+  // path.</span>
<a href="#l85.67"></a><span id="l85.67" class="difflineplus">+  nsString storeRoot;</span>
<a href="#l85.68"></a><span id="l85.68" class="difflineplus">+  nsresult rv =</span>
<a href="#l85.69"></a><span id="l85.69" class="difflineplus">+      key-&gt;ReadStringValue(NS_LITERAL_STRING(&quot;Store Root&quot;), storeRoot);</span>
<a href="#l85.70"></a><span id="l85.70" class="difflineplus">+  key-&gt;Close();  // Finished with windows registry key. We do not want to return</span>
<a href="#l85.71"></a><span id="l85.71" class="difflineplus">+                 // before this closing</span>
<a href="#l85.72"></a><span id="l85.72">   if (NS_FAILED(rv) || storeRoot.IsEmpty()) {</span>
<a href="#l85.73"></a><span id="l85.73">     IMPORT_LOG0(&quot;*** Error finding Windows Live Mail Store Root\n&quot;);</span>
<a href="#l85.74"></a><span id="l85.74">     return rv;</span>
<a href="#l85.75"></a><span id="l85.75">   }</span>
<a href="#l85.76"></a><span id="l85.76"> </span>
<a href="#l85.77"></a><span id="l85.77" class="difflineminus">-  uint32_t size = ::ExpandEnvironmentStringsW((LPCWSTR)storeRoot.get(), nullptr, 0);</span>
<a href="#l85.78"></a><span id="l85.78" class="difflineplus">+  uint32_t size =</span>
<a href="#l85.79"></a><span id="l85.79" class="difflineplus">+      ::ExpandEnvironmentStringsW((LPCWSTR)storeRoot.get(), nullptr, 0);</span>
<a href="#l85.80"></a><span id="l85.80">   nsString expandedStoreRoot;</span>
<a href="#l85.81"></a><span id="l85.81">   expandedStoreRoot.SetLength(size - 1);</span>
<a href="#l85.82"></a><span id="l85.82" class="difflineminus">-  if (expandedStoreRoot.Length() != size - 1)</span>
<a href="#l85.83"></a><span id="l85.83" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l85.84"></a><span id="l85.84" class="difflineplus">+  if (expandedStoreRoot.Length() != size - 1) return NS_ERROR_FAILURE;</span>
<a href="#l85.85"></a><span id="l85.85">   ::ExpandEnvironmentStringsW((LPCWSTR)storeRoot.get(),</span>
<a href="#l85.86"></a><span id="l85.86" class="difflineminus">-                              (LPWSTR)expandedStoreRoot.BeginWriting(),</span>
<a href="#l85.87"></a><span id="l85.87" class="difflineminus">-                              size);</span>
<a href="#l85.88"></a><span id="l85.88" class="difflineplus">+                              (LPWSTR)expandedStoreRoot.BeginWriting(), size);</span>
<a href="#l85.89"></a><span id="l85.89">   storeRoot = expandedStoreRoot;</span>
<a href="#l85.90"></a><span id="l85.90"> </span>
<a href="#l85.91"></a><span id="l85.91" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt; rootFolder(do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv));</span>
<a href="#l85.92"></a><span id="l85.92" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; rootFolder(</span>
<a href="#l85.93"></a><span id="l85.93" class="difflineplus">+      do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv));</span>
<a href="#l85.94"></a><span id="l85.94">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l85.95"></a><span id="l85.95"> </span>
<a href="#l85.96"></a><span id="l85.96">   rv = rootFolder-&gt;InitWithPath(storeRoot);</span>
<a href="#l85.97"></a><span id="l85.97">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l85.98"></a><span id="l85.98"> </span>
<a href="#l85.99"></a><span id="l85.99">   rootFolder.forget(aRootFolder);</span>
<a href="#l85.100"></a><span id="l85.100"> </span>
<a href="#l85.101"></a><span id="l85.101">   return NS_OK;</span>
<a href="#l85.102"></a><span id="l85.102"> }</span>
<a href="#l85.103"></a><span id="l85.103"> </span>
<a href="#l85.104"></a><span id="l85.104" class="difflineminus">-nsresult</span>
<a href="#l85.105"></a><span id="l85.105" class="difflineminus">-nsWMUtils::GetOEAccountFiles(nsCOMArray&lt;nsIFile&gt; &amp;aFileArray)</span>
<a href="#l85.106"></a><span id="l85.106" class="difflineminus">-{</span>
<a href="#l85.107"></a><span id="l85.107" class="difflineplus">+nsresult nsWMUtils::GetOEAccountFiles(nsCOMArray&lt;nsIFile&gt; &amp;aFileArray) {</span>
<a href="#l85.108"></a><span id="l85.108">   nsCOMPtr&lt;nsIFile&gt; rootFolder;</span>
<a href="#l85.109"></a><span id="l85.109"> </span>
<a href="#l85.110"></a><span id="l85.110">   nsresult rv = GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l85.111"></a><span id="l85.111">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l85.112"></a><span id="l85.112"> </span>
<a href="#l85.113"></a><span id="l85.113">   return GetOEAccountFilesInFolder(rootFolder, aFileArray);</span>
<a href="#l85.114"></a><span id="l85.114"> }</span>
<a href="#l85.115"></a><span id="l85.115"> </span>
<a href="#l85.116"></a><span id="l85.116" class="difflineminus">-nsresult</span>
<a href="#l85.117"></a><span id="l85.117" class="difflineminus">-nsWMUtils::GetOEAccountFilesInFolder(nsIFile *aFolder,</span>
<a href="#l85.118"></a><span id="l85.118" class="difflineminus">-                                     nsCOMArray&lt;nsIFile&gt; &amp;aFileArray)</span>
<a href="#l85.119"></a><span id="l85.119" class="difflineminus">-{</span>
<a href="#l85.120"></a><span id="l85.120" class="difflineplus">+nsresult nsWMUtils::GetOEAccountFilesInFolder(nsIFile *aFolder,</span>
<a href="#l85.121"></a><span id="l85.121" class="difflineplus">+                                              nsCOMArray&lt;nsIFile&gt; &amp;aFileArray) {</span>
<a href="#l85.122"></a><span id="l85.122">   nsCOMPtr&lt;nsIDirectoryEnumerator&gt; entries;</span>
<a href="#l85.123"></a><span id="l85.123">   nsresult rv = aFolder-&gt;GetDirectoryEntries(getter_AddRefs(entries));</span>
<a href="#l85.124"></a><span id="l85.124" class="difflineminus">-  if (NS_FAILED(rv) || !entries)</span>
<a href="#l85.125"></a><span id="l85.125" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l85.126"></a><span id="l85.126" class="difflineplus">+  if (NS_FAILED(rv) || !entries) return NS_ERROR_FAILURE;</span>
<a href="#l85.127"></a><span id="l85.127"> </span>
<a href="#l85.128"></a><span id="l85.128">   bool hasMore;</span>
<a href="#l85.129"></a><span id="l85.129">   while (NS_SUCCEEDED(entries-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l85.130"></a><span id="l85.130">     nsCOMPtr&lt;nsIFile&gt; file;</span>
<a href="#l85.131"></a><span id="l85.131">     rv = entries-&gt;GetNextFile(getter_AddRefs(file));</span>
<a href="#l85.132"></a><span id="l85.132">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l85.133"></a><span id="l85.133"> </span>
<a href="#l85.134"></a><span id="l85.134">     bool isDirectory;</span>
<a href="#l85.135"></a><span id="l85.135">     rv = file-&gt;IsDirectory(&amp;isDirectory);</span>
<a href="#l85.136"></a><span id="l85.136">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l85.137"></a><span id="l85.137"> </span>
<a href="#l85.138"></a><span id="l85.138">     if (isDirectory) {</span>
<a href="#l85.139"></a><span id="l85.139">       GetOEAccountFilesInFolder(file, aFileArray);</span>
<a href="#l85.140"></a><span id="l85.140" class="difflineminus">-    }</span>
<a href="#l85.141"></a><span id="l85.141" class="difflineminus">-    else {</span>
<a href="#l85.142"></a><span id="l85.142" class="difflineplus">+    } else {</span>
<a href="#l85.143"></a><span id="l85.143">       nsString name;</span>
<a href="#l85.144"></a><span id="l85.144">       rv = file-&gt;GetLeafName(name);</span>
<a href="#l85.145"></a><span id="l85.145">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l85.146"></a><span id="l85.146">       if (StringEndsWith(name, NS_LITERAL_STRING(&quot;.oeaccount&quot;)))</span>
<a href="#l85.147"></a><span id="l85.147">         aFileArray.AppendObject(file);</span>
<a href="#l85.148"></a><span id="l85.148">     }</span>
<a href="#l85.149"></a><span id="l85.149">   }</span>
<a href="#l85.150"></a><span id="l85.150">   return NS_OK;</span>
<a href="#l85.151"></a><span id="l85.151"> }</span>
<a href="#l85.152"></a><span id="l85.152"> </span>
<a href="#l85.153"></a><span id="l85.153" class="difflineminus">-nsresult</span>
<a href="#l85.154"></a><span id="l85.154" class="difflineminus">-nsWMUtils::MakeXMLdoc(mozilla::dom::Document **aXmlDoc,</span>
<a href="#l85.155"></a><span id="l85.155" class="difflineminus">-                      nsIFile *aFile)</span>
<a href="#l85.156"></a><span id="l85.156" class="difflineminus">-{</span>
<a href="#l85.157"></a><span id="l85.157" class="difflineplus">+nsresult nsWMUtils::MakeXMLdoc(mozilla::dom::Document **aXmlDoc,</span>
<a href="#l85.158"></a><span id="l85.158" class="difflineplus">+                               nsIFile *aFile) {</span>
<a href="#l85.159"></a><span id="l85.159">   nsresult rv;</span>
<a href="#l85.160"></a><span id="l85.160">   nsCOMPtr&lt;nsIFileInputStream&gt; stream =</span>
<a href="#l85.161"></a><span id="l85.161" class="difflineminus">-    do_CreateInstance(NS_LOCALFILEINPUTSTREAM_CONTRACTID, &amp;rv);</span>
<a href="#l85.162"></a><span id="l85.162" class="difflineplus">+      do_CreateInstance(NS_LOCALFILEINPUTSTREAM_CONTRACTID, &amp;rv);</span>
<a href="#l85.163"></a><span id="l85.163">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l85.164"></a><span id="l85.164"> </span>
<a href="#l85.165"></a><span id="l85.165">   rv = stream-&gt;Init(aFile, PR_RDONLY, -1, 0);</span>
<a href="#l85.166"></a><span id="l85.166">   mozilla::ErrorResult rv2;</span>
<a href="#l85.167"></a><span id="l85.167" class="difflineminus">-  RefPtr&lt;mozilla::dom::DOMParser&gt; parser = mozilla::dom::DOMParser::CreateWithoutGlobal(rv2);</span>
<a href="#l85.168"></a><span id="l85.168" class="difflineplus">+  RefPtr&lt;mozilla::dom::DOMParser&gt; parser =</span>
<a href="#l85.169"></a><span id="l85.169" class="difflineplus">+      mozilla::dom::DOMParser::CreateWithoutGlobal(rv2);</span>
<a href="#l85.170"></a><span id="l85.170">   if (rv2.Failed()) {</span>
<a href="#l85.171"></a><span id="l85.171">     return rv2.StealNSResult();</span>
<a href="#l85.172"></a><span id="l85.172">   }</span>
<a href="#l85.173"></a><span id="l85.173">   int64_t filesize;</span>
<a href="#l85.174"></a><span id="l85.174">   aFile-&gt;GetFileSize(&amp;filesize);</span>
<a href="#l85.175"></a><span id="l85.175" class="difflineminus">-  nsCOMPtr&lt;mozilla::dom::Document&gt; xmldoc =</span>
<a href="#l85.176"></a><span id="l85.176" class="difflineminus">-    parser-&gt;ParseFromStream(stream, EmptyString(), int32_t(filesize),</span>
<a href="#l85.177"></a><span id="l85.177" class="difflineminus">-                            mozilla::dom::SupportedType::Application_xml, rv2);</span>
<a href="#l85.178"></a><span id="l85.178" class="difflineplus">+  nsCOMPtr&lt;mozilla::dom::Document&gt; xmldoc = parser-&gt;ParseFromStream(</span>
<a href="#l85.179"></a><span id="l85.179" class="difflineplus">+      stream, EmptyString(), int32_t(filesize),</span>
<a href="#l85.180"></a><span id="l85.180" class="difflineplus">+      mozilla::dom::SupportedType::Application_xml, rv2);</span>
<a href="#l85.181"></a><span id="l85.181">   xmldoc.forget(aXmlDoc);</span>
<a href="#l85.182"></a><span id="l85.182">   return rv2.StealNSResult();</span>
<a href="#l85.183"></a><span id="l85.183"> }</span>
<a href="#l85.184"></a><span id="l85.184"> </span>
<a href="#l85.185"></a><span id="l85.185" class="difflineminus">-nsresult</span>
<a href="#l85.186"></a><span id="l85.186" class="difflineminus">-nsWMUtils::GetValueForTag(mozilla::dom::Document *aXmlDoc,</span>
<a href="#l85.187"></a><span id="l85.187" class="difflineminus">-                          const char *aTagName,</span>
<a href="#l85.188"></a><span id="l85.188" class="difflineminus">-                          nsAString &amp;aValue)</span>
<a href="#l85.189"></a><span id="l85.189" class="difflineminus">-{</span>
<a href="#l85.190"></a><span id="l85.190" class="difflineplus">+nsresult nsWMUtils::GetValueForTag(mozilla::dom::Document *aXmlDoc,</span>
<a href="#l85.191"></a><span id="l85.191" class="difflineplus">+                                   const char *aTagName, nsAString &amp;aValue) {</span>
<a href="#l85.192"></a><span id="l85.192">   nsAutoString tagName;</span>
<a href="#l85.193"></a><span id="l85.193">   tagName.AssignASCII(aTagName);</span>
<a href="#l85.194"></a><span id="l85.194">   nsCOMPtr&lt;nsINodeList&gt; list = aXmlDoc-&gt;GetElementsByTagName(tagName);</span>
<a href="#l85.195"></a><span id="l85.195">   nsCOMPtr&lt;nsINode&gt; node = list-&gt;Item(0);</span>
<a href="#l85.196"></a><span id="l85.196" class="difflineminus">-  if (!node)</span>
<a href="#l85.197"></a><span id="l85.197" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l85.198"></a><span id="l85.198" class="difflineplus">+  if (!node) return NS_ERROR_FAILURE;</span>
<a href="#l85.199"></a><span id="l85.199">   mozilla::ErrorResult rv2;</span>
<a href="#l85.200"></a><span id="l85.200">   node-&gt;GetTextContent(aValue, rv2);</span>
<a href="#l85.201"></a><span id="l85.201">   return rv2.StealNSResult();</span>
<a href="#l85.202"></a><span id="l85.202"> }</span>
<a href="#l85.203"></a><span id="l85.203" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l86.1"></a><span id="l86.1" class="difflineminus">--- a/mailnews/import/winlivemail/nsWMUtils.h</span>
<a href="#l86.2"></a><span id="l86.2" class="difflineplus">+++ b/mailnews/import/winlivemail/nsWMUtils.h</span>
<a href="#l86.3"></a><span id="l86.3" class="difflineat">@@ -1,24 +1,23 @@</span>
<a href="#l86.4"></a><span id="l86.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l86.5"></a><span id="l86.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l86.6"></a><span id="l86.6" class="difflineminus">-  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l86.7"></a><span id="l86.7" class="difflineplus">+ * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l86.8"></a><span id="l86.8"> </span>
<a href="#l86.9"></a><span id="l86.9"> #ifndef nsWMUtils_h___</span>
<a href="#l86.10"></a><span id="l86.10"> #define nsWMUtils_h___</span>
<a href="#l86.11"></a><span id="l86.11"> </span>
<a href="#l86.12"></a><span id="l86.12"> #include &lt;windows.h&gt;</span>
<a href="#l86.13"></a><span id="l86.13"> #include &quot;nsIWindowsRegKey.h&quot;</span>
<a href="#l86.14"></a><span id="l86.14"> </span>
<a href="#l86.15"></a><span id="l86.15"> class nsWMUtils {</span>
<a href="#l86.16"></a><span id="l86.16" class="difflineminus">-public:</span>
<a href="#l86.17"></a><span id="l86.17" class="difflineplus">+ public:</span>
<a href="#l86.18"></a><span id="l86.18">   static nsresult FindWMKey(nsIWindowsRegKey **aKey);</span>
<a href="#l86.19"></a><span id="l86.19">   static nsresult GetRootFolder(nsIFile **aRootFolder);</span>
<a href="#l86.20"></a><span id="l86.20">   static nsresult GetOEAccountFiles(nsCOMArray&lt;nsIFile&gt; &amp;aFileArray);</span>
<a href="#l86.21"></a><span id="l86.21">   static nsresult GetOEAccountFilesInFolder(nsIFile *aFolder,</span>
<a href="#l86.22"></a><span id="l86.22">                                             nsCOMArray&lt;nsIFile&gt; &amp;aFileArray);</span>
<a href="#l86.23"></a><span id="l86.23">   static nsresult MakeXMLdoc(mozilla::dom::Document **aXmlDoc, nsIFile *aFile);</span>
<a href="#l86.24"></a><span id="l86.24">   static nsresult GetValueForTag(mozilla::dom::Document *aXmlDoc,</span>
<a href="#l86.25"></a><span id="l86.25" class="difflineminus">-                                 const char *aTagName,</span>
<a href="#l86.26"></a><span id="l86.26" class="difflineminus">-                                 nsAString &amp;aValue);</span>
<a href="#l86.27"></a><span id="l86.27" class="difflineplus">+                                 const char *aTagName, nsAString &amp;aValue);</span>
<a href="#l86.28"></a><span id="l86.28"> };</span>
<a href="#l86.29"></a><span id="l86.29"> </span>
<a href="#l86.30"></a><span id="l86.30"> #endif /* nsWMUtils_h___ */</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

