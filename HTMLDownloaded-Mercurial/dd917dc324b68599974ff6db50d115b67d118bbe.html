<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 24877:dd917dc324b68599974ff6db50d115b67d118bbe</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ dd917dc324b68599974ff6db50d115b67d118bbe" />
<meta property="og:url" content="/comm-central/rev/dd917dc324b68599974ff6db50d115b67d118bbe" />
<meta property="og:description" content="Bug 1478572 - Turn on ESLint in mail/components/cloudfile; r=aceman" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / dd917dc324b68599974ff6db50d115b67d118bbe 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/dd917dc324b68599974ff6db50d115b67d118bbe">shortlog</a> |
<a href="/comm-central/log/dd917dc324b68599974ff6db50d115b67d118bbe">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/dd917dc324b68599974ff6db50d115b67d118bbe">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/dd917dc324b68599974ff6db50d115b67d118bbe">files</a> |
changeset |
<a href="/comm-central/raw-rev/dd917dc324b68599974ff6db50d115b67d118bbe">raw</a>  | <a href="/comm-central/archive/dd917dc324b68599974ff6db50d115b67d118bbe.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1478572">Bug 1478572</a> - Turn on ESLint in mail/components/cloudfile; r=aceman
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 03 Oct 2018 21:07:06 +1300</td></tr>

<tr>
 <td>changeset 24877</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/dd917dc324b68599974ff6db50d115b67d118bbe">dd917dc324b68599974ff6db50d115b67d118bbe</a></td>
</tr>



<tr>
<td>parent 24876</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/b9846bdfa088b43e94d7a801d87622248c79e78d">b9846bdfa088b43e94d7a801d87622248c79e78d</a>
</td>
</tr>

<tr>
<td>child 24878</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/f929f9f1b39c927af3aa30231ca7dde95b330995">f929f9f1b39c927af3aa30231ca7dde95b330995</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=dd917dc324b68599974ff6db50d115b67d118bbe">14965</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Wed, 03 Oct 2018 08:07:25 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@dd917dc324b6 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=dd917dc324b68599974ff6db50d115b67d118bbe">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=dd917dc324b68599974ff6db50d115b67d118bbe&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=dd917dc324b68599974ff6db50d115b67d118bbe&newProject=comm-central&newRevision=dd917dc324b68599974ff6db50d115b67d118bbe&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=dd917dc324b68599974ff6db50d115b67d118bbe&newProject=comm-central&newRevision=dd917dc324b68599974ff6db50d115b67d118bbe&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=dd917dc324b68599974ff6db50d115b67d118bbe&newProject=comm-central&newRevision=dd917dc324b68599974ff6db50d115b67d118bbe&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28aceman%29&revcount=50">aceman</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1478572">1478572</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1478572">Bug 1478572</a> - Turn on ESLint in mail/components/cloudfile; r=aceman</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dd917dc324b68599974ff6db50d115b67d118bbe/.eslintignore">.eslintignore</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd917dc324b68599974ff6db50d115b67d118bbe/.eslintignore">file</a> |
<a href="/comm-central/annotate/dd917dc324b68599974ff6db50d115b67d118bbe/.eslintignore">annotate</a> |
<a href="/comm-central/diff/dd917dc324b68599974ff6db50d115b67d118bbe/.eslintignore">diff</a> |
<a href="/comm-central/comparison/dd917dc324b68599974ff6db50d115b67d118bbe/.eslintignore">comparison</a> |
<a href="/comm-central/log/dd917dc324b68599974ff6db50d115b67d118bbe/.eslintignore">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dd917dc324b68599974ff6db50d115b67d118bbe/mail/components/cloudfile/cloudFileAccounts.js">mail/components/cloudfile/cloudFileAccounts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd917dc324b68599974ff6db50d115b67d118bbe/mail/components/cloudfile/cloudFileAccounts.js">file</a> |
<a href="/comm-central/annotate/dd917dc324b68599974ff6db50d115b67d118bbe/mail/components/cloudfile/cloudFileAccounts.js">annotate</a> |
<a href="/comm-central/diff/dd917dc324b68599974ff6db50d115b67d118bbe/mail/components/cloudfile/cloudFileAccounts.js">diff</a> |
<a href="/comm-central/comparison/dd917dc324b68599974ff6db50d115b67d118bbe/mail/components/cloudfile/cloudFileAccounts.js">comparison</a> |
<a href="/comm-central/log/dd917dc324b68599974ff6db50d115b67d118bbe/mail/components/cloudfile/cloudFileAccounts.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dd917dc324b68599974ff6db50d115b67d118bbe/mail/components/cloudfile/content/Box/management.js">mail/components/cloudfile/content/Box/management.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd917dc324b68599974ff6db50d115b67d118bbe/mail/components/cloudfile/content/Box/management.js">file</a> |
<a href="/comm-central/annotate/dd917dc324b68599974ff6db50d115b67d118bbe/mail/components/cloudfile/content/Box/management.js">annotate</a> |
<a href="/comm-central/diff/dd917dc324b68599974ff6db50d115b67d118bbe/mail/components/cloudfile/content/Box/management.js">diff</a> |
<a href="/comm-central/comparison/dd917dc324b68599974ff6db50d115b67d118bbe/mail/components/cloudfile/content/Box/management.js">comparison</a> |
<a href="/comm-central/log/dd917dc324b68599974ff6db50d115b67d118bbe/mail/components/cloudfile/content/Box/management.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dd917dc324b68599974ff6db50d115b67d118bbe/mail/components/cloudfile/content/Hightail/fileExceedsQuota.js">mail/components/cloudfile/content/Hightail/fileExceedsQuota.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd917dc324b68599974ff6db50d115b67d118bbe/mail/components/cloudfile/content/Hightail/fileExceedsQuota.js">file</a> |
<a href="/comm-central/annotate/dd917dc324b68599974ff6db50d115b67d118bbe/mail/components/cloudfile/content/Hightail/fileExceedsQuota.js">annotate</a> |
<a href="/comm-central/diff/dd917dc324b68599974ff6db50d115b67d118bbe/mail/components/cloudfile/content/Hightail/fileExceedsQuota.js">diff</a> |
<a href="/comm-central/comparison/dd917dc324b68599974ff6db50d115b67d118bbe/mail/components/cloudfile/content/Hightail/fileExceedsQuota.js">comparison</a> |
<a href="/comm-central/log/dd917dc324b68599974ff6db50d115b67d118bbe/mail/components/cloudfile/content/Hightail/fileExceedsQuota.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dd917dc324b68599974ff6db50d115b67d118bbe/mail/components/cloudfile/content/Hightail/management.js">mail/components/cloudfile/content/Hightail/management.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd917dc324b68599974ff6db50d115b67d118bbe/mail/components/cloudfile/content/Hightail/management.js">file</a> |
<a href="/comm-central/annotate/dd917dc324b68599974ff6db50d115b67d118bbe/mail/components/cloudfile/content/Hightail/management.js">annotate</a> |
<a href="/comm-central/diff/dd917dc324b68599974ff6db50d115b67d118bbe/mail/components/cloudfile/content/Hightail/management.js">diff</a> |
<a href="/comm-central/comparison/dd917dc324b68599974ff6db50d115b67d118bbe/mail/components/cloudfile/content/Hightail/management.js">comparison</a> |
<a href="/comm-central/log/dd917dc324b68599974ff6db50d115b67d118bbe/mail/components/cloudfile/content/Hightail/management.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dd917dc324b68599974ff6db50d115b67d118bbe/mail/components/cloudfile/content/addAccountDialog.js">mail/components/cloudfile/content/addAccountDialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd917dc324b68599974ff6db50d115b67d118bbe/mail/components/cloudfile/content/addAccountDialog.js">file</a> |
<a href="/comm-central/annotate/dd917dc324b68599974ff6db50d115b67d118bbe/mail/components/cloudfile/content/addAccountDialog.js">annotate</a> |
<a href="/comm-central/diff/dd917dc324b68599974ff6db50d115b67d118bbe/mail/components/cloudfile/content/addAccountDialog.js">diff</a> |
<a href="/comm-central/comparison/dd917dc324b68599974ff6db50d115b67d118bbe/mail/components/cloudfile/content/addAccountDialog.js">comparison</a> |
<a href="/comm-central/log/dd917dc324b68599974ff6db50d115b67d118bbe/mail/components/cloudfile/content/addAccountDialog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/dd917dc324b68599974ff6db50d115b67d118bbe/mail/components/cloudfile/nsBox.js">mail/components/cloudfile/nsBox.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd917dc324b68599974ff6db50d115b67d118bbe/mail/components/cloudfile/nsBox.js">file</a> |
<a href="/comm-central/annotate/dd917dc324b68599974ff6db50d115b67d118bbe/mail/components/cloudfile/nsBox.js">annotate</a> |
<a href="/comm-central/diff/dd917dc324b68599974ff6db50d115b67d118bbe/mail/components/cloudfile/nsBox.js">diff</a> |
<a href="/comm-central/comparison/dd917dc324b68599974ff6db50d115b67d118bbe/mail/components/cloudfile/nsBox.js">comparison</a> |
<a href="/comm-central/log/dd917dc324b68599974ff6db50d115b67d118bbe/mail/components/cloudfile/nsBox.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/dd917dc324b68599974ff6db50d115b67d118bbe/mail/components/cloudfile/nsHightail.js">mail/components/cloudfile/nsHightail.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/dd917dc324b68599974ff6db50d115b67d118bbe/mail/components/cloudfile/nsHightail.js">file</a> |
<a href="/comm-central/annotate/dd917dc324b68599974ff6db50d115b67d118bbe/mail/components/cloudfile/nsHightail.js">annotate</a> |
<a href="/comm-central/diff/dd917dc324b68599974ff6db50d115b67d118bbe/mail/components/cloudfile/nsHightail.js">diff</a> |
<a href="/comm-central/comparison/dd917dc324b68599974ff6db50d115b67d118bbe/mail/components/cloudfile/nsHightail.js">comparison</a> |
<a href="/comm-central/log/dd917dc324b68599974ff6db50d115b67d118bbe/mail/components/cloudfile/nsHightail.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/.eslintignore</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/.eslintignore</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -46,17 +46,16 @@ mailnews/test/*</span>
<a href="#l1.4"></a><span id="l1.4"> # mailnews/extensions exclusions</span>
<a href="#l1.5"></a><span id="l1.5"> mailnews/extensions/*</span>
<a href="#l1.6"></a><span id="l1.6"> !mailnews/extensions/newsblog</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8"> # mail exclusions</span>
<a href="#l1.9"></a><span id="l1.9"> mail/app/**</span>
<a href="#l1.10"></a><span id="l1.10"> mail/base/**</span>
<a href="#l1.11"></a><span id="l1.11"> mail/branding/**</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-mail/components/cloudfile/**</span>
<a href="#l1.13"></a><span id="l1.13"> mail/components/newmailaccount/**</span>
<a href="#l1.14"></a><span id="l1.14"> mail/components/search/**</span>
<a href="#l1.15"></a><span id="l1.15"> mail/config/**</span>
<a href="#l1.16"></a><span id="l1.16"> mail/extensions/**</span>
<a href="#l1.17"></a><span id="l1.17"> mail/installer/**</span>
<a href="#l1.18"></a><span id="l1.18"> mail/locales/**</span>
<a href="#l1.19"></a><span id="l1.19"> mail/test/**</span>
<a href="#l1.20"></a><span id="l1.20"> mail/themes/**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/components/cloudfile/cloudFileAccounts.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/components/cloudfile/cloudFileAccounts.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -10,17 +10,17 @@ var ACCOUNT_ROOT = PREF_ROOT + &quot;accounts</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5"> // The following constants are used to query and insert entries</span>
<a href="#l2.6"></a><span id="l2.6"> // into the nsILoginManager.</span>
<a href="#l2.7"></a><span id="l2.7"> var PWDMGR_HOST = &quot;chrome://messenger/cloudfile&quot;;</span>
<a href="#l2.8"></a><span id="l2.8"> var PWDMGR_REALM = &quot;BigFiles Auth Token&quot;;</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l2.11"></a><span id="l2.11"> ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+const { fixIterator } = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;, null);</span>
<a href="#l2.14"></a><span id="l2.14"> </span>
<a href="#l2.15"></a><span id="l2.15"> var cloudFileAccounts = {</span>
<a href="#l2.16"></a><span id="l2.16">   get kTokenRealm() {</span>
<a href="#l2.17"></a><span id="l2.17">     return PWDMGR_REALM;</span>
<a href="#l2.18"></a><span id="l2.18">   },</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20">   get _accountKeys() {</span>
<a href="#l2.21"></a><span id="l2.21">     let accountKeySet = {};</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -30,30 +30,30 @@ var cloudFileAccounts = {</span>
<a href="#l2.23"></a><span id="l2.23">       let subbranch = child.substr(0, child.indexOf(&quot;.&quot;));</span>
<a href="#l2.24"></a><span id="l2.24">       accountKeySet[subbranch] = 1;</span>
<a href="#l2.25"></a><span id="l2.25">     }</span>
<a href="#l2.26"></a><span id="l2.26"> </span>
<a href="#l2.27"></a><span id="l2.27">     // TODO: sort by ordinal</span>
<a href="#l2.28"></a><span id="l2.28">     return Object.keys(accountKeySet);</span>
<a href="#l2.29"></a><span id="l2.29">   },</span>
<a href="#l2.30"></a><span id="l2.30"> </span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-  _getInitedProviderForType: function(aAccountKey, aType) {</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+  _getInitedProviderForType(aAccountKey, aType) {</span>
<a href="#l2.33"></a><span id="l2.33">     let provider = this.getProviderForType(aType);</span>
<a href="#l2.34"></a><span id="l2.34">     if (provider) {</span>
<a href="#l2.35"></a><span id="l2.35">       try {</span>
<a href="#l2.36"></a><span id="l2.36">         provider.init(aAccountKey);</span>
<a href="#l2.37"></a><span id="l2.37">       } catch (e) {</span>
<a href="#l2.38"></a><span id="l2.38">         Cu.reportError(e);</span>
<a href="#l2.39"></a><span id="l2.39">         provider = null;</span>
<a href="#l2.40"></a><span id="l2.40">       }</span>
<a href="#l2.41"></a><span id="l2.41">     }</span>
<a href="#l2.42"></a><span id="l2.42">     return provider;</span>
<a href="#l2.43"></a><span id="l2.43">   },</span>
<a href="#l2.44"></a><span id="l2.44"> </span>
<a href="#l2.45"></a><span id="l2.45" class="difflineminus">-  _createUniqueAccountKey: function() {</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+  _createUniqueAccountKey() {</span>
<a href="#l2.47"></a><span id="l2.47">     // Pick a unique account key (TODO: this is a dumb way to do it, probably)</span>
<a href="#l2.48"></a><span id="l2.48">     let existingKeys = this._accountKeys;</span>
<a href="#l2.49"></a><span id="l2.49">     for (let n = 1; ; n++) {</span>
<a href="#l2.50"></a><span id="l2.50"> </span>
<a href="#l2.51"></a><span id="l2.51">       if (!existingKeys.includes(&quot;account&quot; + n))</span>
<a href="#l2.52"></a><span id="l2.52">         return &quot;account&quot; + n;</span>
<a href="#l2.53"></a><span id="l2.53">     }</span>
<a href="#l2.54"></a><span id="l2.54">   },</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineat">@@ -61,58 +61,56 @@ var cloudFileAccounts = {</span>
<a href="#l2.56"></a><span id="l2.56">   /**</span>
<a href="#l2.57"></a><span id="l2.57">    * Ensure that we have the account key for an account. If we already have the</span>
<a href="#l2.58"></a><span id="l2.58">    * key, just return it. If we have the nsIMsgCloudFileProvider, get the key</span>
<a href="#l2.59"></a><span id="l2.59">    * from it.</span>
<a href="#l2.60"></a><span id="l2.60">    *</span>
<a href="#l2.61"></a><span id="l2.61">    * @param aKeyOrAccount the key or the account object</span>
<a href="#l2.62"></a><span id="l2.62">    * @return the account key</span>
<a href="#l2.63"></a><span id="l2.63">    */</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineminus">-  _ensureKey: function(aKeyOrAccount) {</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+  _ensureKey(aKeyOrAccount) {</span>
<a href="#l2.66"></a><span id="l2.66">     if (typeof aKeyOrAccount == &quot;string&quot;)</span>
<a href="#l2.67"></a><span id="l2.67">       return aKeyOrAccount;</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineminus">-    else if (&quot;accountKey&quot; in aKeyOrAccount)</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+    if (&quot;accountKey&quot; in aKeyOrAccount)</span>
<a href="#l2.70"></a><span id="l2.70">       return aKeyOrAccount.accountKey;</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineminus">-    else</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineminus">-      throw new Error(&quot;string or nsIMsgCloudFileProvider expected&quot;);</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+    throw new Error(&quot;string or nsIMsgCloudFileProvider expected&quot;);</span>
<a href="#l2.74"></a><span id="l2.74">   },</span>
<a href="#l2.75"></a><span id="l2.75"> </span>
<a href="#l2.76"></a><span id="l2.76" class="difflineminus">-  getProviderForType: function(aType) {</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+  getProviderForType(aType) {</span>
<a href="#l2.78"></a><span id="l2.78">     try {</span>
<a href="#l2.79"></a><span id="l2.79">       let className = categoryManager.getCategoryEntry(CATEGORY, aType);</span>
<a href="#l2.80"></a><span id="l2.80">       let provider = Cc[className].createInstance(Ci.nsIMsgCloudFileProvider);</span>
<a href="#l2.81"></a><span id="l2.81">       return provider;</span>
<a href="#l2.82"></a><span id="l2.82">     } catch (e) {</span>
<a href="#l2.83"></a><span id="l2.83">       if (e.result != Cr.NS_ERROR_NOT_AVAILABLE) {</span>
<a href="#l2.84"></a><span id="l2.84">         // If a provider is not available we swallow the error message.</span>
<a href="#l2.85"></a><span id="l2.85">         // Otherwise at least notify, so developers can fix things.</span>
<a href="#l2.86"></a><span id="l2.86">         Cu.reportError(&quot;Getting provider for type=&quot; + aType + &quot; FAILED; &quot; + e);</span>
<a href="#l2.87"></a><span id="l2.87">       }</span>
<a href="#l2.88"></a><span id="l2.88">     }</span>
<a href="#l2.89"></a><span id="l2.89">     return null;</span>
<a href="#l2.90"></a><span id="l2.90">   },</span>
<a href="#l2.91"></a><span id="l2.91"> </span>
<a href="#l2.92"></a><span id="l2.92">   // aExtraPrefs are prefs specific to an account provider.</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineminus">-  createAccount: function(aType, aRequestObserver, aExtraPrefs) {</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineplus">+  createAccount(aType, aRequestObserver, aExtraPrefs) {</span>
<a href="#l2.95"></a><span id="l2.95">     let key = this._createUniqueAccountKey();</span>
<a href="#l2.96"></a><span id="l2.96"> </span>
<a href="#l2.97"></a><span id="l2.97">     try {</span>
<a href="#l2.98"></a><span id="l2.98">       Services.prefs</span>
<a href="#l2.99"></a><span id="l2.99">               .setCharPref(ACCOUNT_ROOT + key + &quot;.type&quot;, aType);</span>
<a href="#l2.100"></a><span id="l2.100"> </span>
<a href="#l2.101"></a><span id="l2.101">       if (aExtraPrefs !== undefined)</span>
<a href="#l2.102"></a><span id="l2.102">         this._processExtraPrefs(key, aExtraPrefs);</span>
<a href="#l2.103"></a><span id="l2.103"> </span>
<a href="#l2.104"></a><span id="l2.104">       let provider = this._getInitedProviderForType(key, aType);</span>
<a href="#l2.105"></a><span id="l2.105">       if (provider)</span>
<a href="#l2.106"></a><span id="l2.106">         provider.createExistingAccount(aRequestObserver);</span>
<a href="#l2.107"></a><span id="l2.107"> </span>
<a href="#l2.108"></a><span id="l2.108">       return provider;</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineminus">-    }</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineminus">-    catch(e) {</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineplus">+    } catch (e) {</span>
<a href="#l2.112"></a><span id="l2.112">       Services.prefs.deleteBranch(ACCOUNT_ROOT + key);</span>
<a href="#l2.113"></a><span id="l2.113">       throw e;</span>
<a href="#l2.114"></a><span id="l2.114">     }</span>
<a href="#l2.115"></a><span id="l2.115">   },</span>
<a href="#l2.116"></a><span id="l2.116"> </span>
<a href="#l2.117"></a><span id="l2.117">   // Set provider-specific prefs</span>
<a href="#l2.118"></a><span id="l2.118">   _processExtraPrefs: function CFA__processExtraPrefs(aAccountKey,</span>
<a href="#l2.119"></a><span id="l2.119">                                                       aExtraPrefs) {</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineat">@@ -132,35 +130,33 @@ var cloudFileAccounts = {</span>
<a href="#l2.121"></a><span id="l2.121">       }</span>
<a href="#l2.122"></a><span id="l2.122"> </span>
<a href="#l2.123"></a><span id="l2.123">       let func = kFuncMap[type];</span>
<a href="#l2.124"></a><span id="l2.124">       Services.prefs[func](ACCOUNT_ROOT + aAccountKey + &quot;.&quot; + prefKey,</span>
<a href="#l2.125"></a><span id="l2.125">                            value);</span>
<a href="#l2.126"></a><span id="l2.126">     }</span>
<a href="#l2.127"></a><span id="l2.127">   },</span>
<a href="#l2.128"></a><span id="l2.128"> </span>
<a href="#l2.129"></a><span id="l2.129" class="difflineminus">-  enumerateProviders: function*() {</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineplus">+  * enumerateProviders() {</span>
<a href="#l2.131"></a><span id="l2.131">     for (let entry of fixIterator(categoryManager.enumerateCategory(CATEGORY),</span>
<a href="#l2.132"></a><span id="l2.132">                                   Ci.nsISupportsCString)) {</span>
<a href="#l2.133"></a><span id="l2.133">       let provider = this.getProviderForType(entry.data);</span>
<a href="#l2.134"></a><span id="l2.134">       yield [entry.data, provider];</span>
<a href="#l2.135"></a><span id="l2.135">     }</span>
<a href="#l2.136"></a><span id="l2.136">   },</span>
<a href="#l2.137"></a><span id="l2.137"> </span>
<a href="#l2.138"></a><span id="l2.138" class="difflineminus">-  getAccount: function(aKey) {</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineminus">-    let type = Services.prefs.QueryInterface(Ci.nsIPrefBranch)</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineminus">-                       .getCharPref(ACCOUNT_ROOT + aKey + &quot;.type&quot;);</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineplus">+  getAccount(aKey) {</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineplus">+    let type = Services.prefs.getCharPref(ACCOUNT_ROOT + aKey + &quot;.type&quot;);</span>
<a href="#l2.143"></a><span id="l2.143">     return this._getInitedProviderForType(aKey, type);</span>
<a href="#l2.144"></a><span id="l2.144">   },</span>
<a href="#l2.145"></a><span id="l2.145"> </span>
<a href="#l2.146"></a><span id="l2.146" class="difflineminus">-  removeAccount: function(aKeyOrAccount) {</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineplus">+  removeAccount(aKeyOrAccount) {</span>
<a href="#l2.148"></a><span id="l2.148">     let key = this._ensureKey(aKeyOrAccount);</span>
<a href="#l2.149"></a><span id="l2.149"> </span>
<a href="#l2.150"></a><span id="l2.150" class="difflineminus">-    let type = Services.prefs.QueryInterface(Ci.nsIPrefBranch)</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineminus">-                       .deleteBranch(ACCOUNT_ROOT + key);</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineplus">+    Services.prefs.deleteBranch(ACCOUNT_ROOT + key);</span>
<a href="#l2.153"></a><span id="l2.153"> </span>
<a href="#l2.154"></a><span id="l2.154">     // Destroy any secret tokens for this accountKey.</span>
<a href="#l2.155"></a><span id="l2.155">     let logins = Services.logins</span>
<a href="#l2.156"></a><span id="l2.156">                          .findLogins({}, PWDMGR_HOST, null, &quot;&quot;);</span>
<a href="#l2.157"></a><span id="l2.157">     for (let login of logins) {</span>
<a href="#l2.158"></a><span id="l2.158">       if (login.username == key)</span>
<a href="#l2.159"></a><span id="l2.159">         Services.logins.removeLogin(login);</span>
<a href="#l2.160"></a><span id="l2.160">     }</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineat">@@ -189,44 +185,44 @@ var cloudFileAccounts = {</span>
<a href="#l2.162"></a><span id="l2.162">             .getMostRecentWindow(null)</span>
<a href="#l2.163"></a><span id="l2.163">             .openDialog(&quot;chrome://messenger/content/cloudfile/&quot;</span>
<a href="#l2.164"></a><span id="l2.164">                         + &quot;addAccountDialog.xul&quot;,</span>
<a href="#l2.165"></a><span id="l2.165">                         &quot;&quot;, &quot;chrome, dialog, modal, resizable=yes&quot;,</span>
<a href="#l2.166"></a><span id="l2.166">                         params).focus();</span>
<a href="#l2.167"></a><span id="l2.167">     return params.accountKey;</span>
<a href="#l2.168"></a><span id="l2.168">   },</span>
<a href="#l2.169"></a><span id="l2.169"> </span>
<a href="#l2.170"></a><span id="l2.170" class="difflineminus">-  getDisplayName: function(aKeyOrAccount) {</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineplus">+  getDisplayName(aKeyOrAccount) {</span>
<a href="#l2.172"></a><span id="l2.172">     try {</span>
<a href="#l2.173"></a><span id="l2.173">       let key = this._ensureKey(aKeyOrAccount);</span>
<a href="#l2.174"></a><span id="l2.174">       return Services.prefs.getCharPref(ACCOUNT_ROOT +</span>
<a href="#l2.175"></a><span id="l2.175">                                         key + &quot;.displayName&quot;);</span>
<a href="#l2.176"></a><span id="l2.176" class="difflineminus">-    } catch(e) {</span>
<a href="#l2.177"></a><span id="l2.177" class="difflineplus">+    } catch (e) {</span>
<a href="#l2.178"></a><span id="l2.178">       // If no display name has been set, we return the empty string.</span>
<a href="#l2.179"></a><span id="l2.179">       Cu.reportError(e);</span>
<a href="#l2.180"></a><span id="l2.180">       return &quot;&quot;;</span>
<a href="#l2.181"></a><span id="l2.181">     }</span>
<a href="#l2.182"></a><span id="l2.182">   },</span>
<a href="#l2.183"></a><span id="l2.183"> </span>
<a href="#l2.184"></a><span id="l2.184" class="difflineminus">-  setDisplayName: function(aKeyOrAccount, aDisplayName) {</span>
<a href="#l2.185"></a><span id="l2.185" class="difflineplus">+  setDisplayName(aKeyOrAccount, aDisplayName) {</span>
<a href="#l2.186"></a><span id="l2.186">     let key = this._ensureKey(aKeyOrAccount);</span>
<a href="#l2.187"></a><span id="l2.187">     Services.prefs.setCharPref(ACCOUNT_ROOT + key +</span>
<a href="#l2.188"></a><span id="l2.188">                                &quot;.displayName&quot;, aDisplayName);</span>
<a href="#l2.189"></a><span id="l2.189">   },</span>
<a href="#l2.190"></a><span id="l2.190"> </span>
<a href="#l2.191"></a><span id="l2.191">   /**</span>
<a href="#l2.192"></a><span id="l2.192">    * Retrieve a secret value, like an authorization token, for an account.</span>
<a href="#l2.193"></a><span id="l2.193">    *</span>
<a href="#l2.194"></a><span id="l2.194">    * @param aKeyOrAccount an nsIMsgCloudFileProvider, or an accountKey</span>
<a href="#l2.195"></a><span id="l2.195">    *                      for a provider.</span>
<a href="#l2.196"></a><span id="l2.196">    * @param aRealm a human-readable string describing what exactly</span>
<a href="#l2.197"></a><span id="l2.197">    *               was being stored. Should match the realm used when setting</span>
<a href="#l2.198"></a><span id="l2.198">    *               the value.</span>
<a href="#l2.199"></a><span id="l2.199">    */</span>
<a href="#l2.200"></a><span id="l2.200" class="difflineminus">-  getSecretValue: function(aKeyOrAccount, aRealm) {</span>
<a href="#l2.201"></a><span id="l2.201" class="difflineplus">+  getSecretValue(aKeyOrAccount, aRealm) {</span>
<a href="#l2.202"></a><span id="l2.202">     let key = this._ensureKey(aKeyOrAccount);</span>
<a href="#l2.203"></a><span id="l2.203"> </span>
<a href="#l2.204"></a><span id="l2.204">     let loginInfo = this._getLoginInfoForKey(key, aRealm);</span>
<a href="#l2.205"></a><span id="l2.205"> </span>
<a href="#l2.206"></a><span id="l2.206">     if (loginInfo)</span>
<a href="#l2.207"></a><span id="l2.207">       return loginInfo.password;</span>
<a href="#l2.208"></a><span id="l2.208"> </span>
<a href="#l2.209"></a><span id="l2.209">     return null;</span>
<a href="#l2.210"></a><span id="l2.210" class="difflineat">@@ -240,17 +236,17 @@ var cloudFileAccounts = {</span>
<a href="#l2.211"></a><span id="l2.211">    *                      for a provider.</span>
<a href="#l2.212"></a><span id="l2.212">    * @param aRealm a human-readable string describing what exactly</span>
<a href="#l2.213"></a><span id="l2.213">    *               is being stored here. To reduce magic strings, you can use</span>
<a href="#l2.214"></a><span id="l2.214">    *               cloudFileAccounts.kTokenRealm for simple auth tokens, and</span>
<a href="#l2.215"></a><span id="l2.215">    *               anything else for custom secret values.</span>
<a href="#l2.216"></a><span id="l2.216">    * @param aToken The token to be saved.  If this is set to null or the</span>
<a href="#l2.217"></a><span id="l2.217">    *               empty string, then the entry for this key will be removed.</span>
<a href="#l2.218"></a><span id="l2.218">    */</span>
<a href="#l2.219"></a><span id="l2.219" class="difflineminus">-  setSecretValue: function(aKeyOrAccount, aRealm, aToken) {</span>
<a href="#l2.220"></a><span id="l2.220" class="difflineplus">+  setSecretValue(aKeyOrAccount, aRealm, aToken) {</span>
<a href="#l2.221"></a><span id="l2.221">     let key = this._ensureKey(aKeyOrAccount);</span>
<a href="#l2.222"></a><span id="l2.222">     let loginInfo = this._getLoginInfoForKey(key, aRealm);</span>
<a href="#l2.223"></a><span id="l2.223"> </span>
<a href="#l2.224"></a><span id="l2.224">     if (!aToken) {</span>
<a href="#l2.225"></a><span id="l2.225">       if (!loginInfo)</span>
<a href="#l2.226"></a><span id="l2.226">         return;</span>
<a href="#l2.227"></a><span id="l2.227"> </span>
<a href="#l2.228"></a><span id="l2.228">       Services.logins.removeLogin(loginInfo);</span>
<a href="#l2.229"></a><span id="l2.229" class="difflineat">@@ -271,17 +267,17 @@ var cloudFileAccounts = {</span>
<a href="#l2.230"></a><span id="l2.230">   /**</span>
<a href="#l2.231"></a><span id="l2.231">    * Searches the nsILoginManager for an nsILoginInfo for BigFiles with</span>
<a href="#l2.232"></a><span id="l2.232">    * the username set to aKey, and the realm set to aRealm.</span>
<a href="#l2.233"></a><span id="l2.233">    *</span>
<a href="#l2.234"></a><span id="l2.234">    * @param aKey a key for an nsIMsgCloudFileProvider that we're searching</span>
<a href="#l2.235"></a><span id="l2.235">    *             for login info for.</span>
<a href="#l2.236"></a><span id="l2.236">    * @param aRealm the realm that the login info was stored under.</span>
<a href="#l2.237"></a><span id="l2.237">    */</span>
<a href="#l2.238"></a><span id="l2.238" class="difflineminus">-  _getLoginInfoForKey: function(aKey, aRealm) {</span>
<a href="#l2.239"></a><span id="l2.239" class="difflineplus">+  _getLoginInfoForKey(aKey, aRealm) {</span>
<a href="#l2.240"></a><span id="l2.240">     let logins = Services.logins</span>
<a href="#l2.241"></a><span id="l2.241">                          .findLogins({}, PWDMGR_HOST, null, aRealm);</span>
<a href="#l2.242"></a><span id="l2.242">     for (let login of logins) {</span>
<a href="#l2.243"></a><span id="l2.243">       if (login.username == aKey)</span>
<a href="#l2.244"></a><span id="l2.244">         return login;</span>
<a href="#l2.245"></a><span id="l2.245">     }</span>
<a href="#l2.246"></a><span id="l2.246">     return null;</span>
<a href="#l2.247"></a><span id="l2.247">   },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/components/cloudfile/content/Box/management.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/components/cloudfile/content/Box/management.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,12 +1,15 @@</span>
<a href="#l3.4"></a><span id="l3.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.5"></a><span id="l3.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l3.6"></a><span id="l3.6">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8" class="difflineplus">+// mail/base/content/protovis-r2.6-modded.js</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+/* globals pv */</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+</span>
<a href="#l3.11"></a><span id="l3.11"> function onLoadProvider(provider) {</span>
<a href="#l3.12"></a><span id="l3.12">   let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l3.13"></a><span id="l3.13">                     .createInstance(Ci.nsIMessenger);</span>
<a href="#l3.14"></a><span id="l3.14"> </span>
<a href="#l3.15"></a><span id="l3.15">   let fileSpaceUsed = document.getElementById(&quot;file-space-used&quot;);</span>
<a href="#l3.16"></a><span id="l3.16">   fileSpaceUsed.textContent = messenger.formatFileSize(provider.fileSpaceUsed);</span>
<a href="#l3.17"></a><span id="l3.17">   let fileSpaceUsedSwatch = document.getElementById(&quot;file-space-used-swatch&quot;);</span>
<a href="#l3.18"></a><span id="l3.18">   fileSpaceUsedSwatch.style.backgroundColor = pv.Colors.category20.values[0];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/components/cloudfile/content/Hightail/fileExceedsQuota.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/components/cloudfile/content/Hightail/fileExceedsQuota.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -4,13 +4,13 @@</span>
<a href="#l4.4"></a><span id="l4.4"> </span>
<a href="#l4.5"></a><span id="l4.5"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l4.6"></a><span id="l4.6"> ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8"> document.addEventListener(&quot;DOMContentLoaded&quot;, function() {</span>
<a href="#l4.9"></a><span id="l4.9">   if (&quot;wrappedJSObject&quot; in window.arguments[0]) {</span>
<a href="#l4.10"></a><span id="l4.10">     let storage = parseInt(window.arguments[0].wrappedJSObject.storage);</span>
<a href="#l4.11"></a><span id="l4.11">     storage = (storage / 1024 / 1024 / 1024).toFixed(2);</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-    let currentStorage = document.getElementById('currentStorage');</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-    currentStorage.textContent = currentStorage.textContent.replace('#XXX', storage);</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+    let currentStorage = document.getElementById(&quot;currentStorage&quot;);</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+    currentStorage.textContent = currentStorage.textContent.replace(&quot;#XXX&quot;, storage);</span>
<a href="#l4.16"></a><span id="l4.16">   }</span>
<a href="#l4.17"></a><span id="l4.17"> });</span>
<a href="#l4.18"></a><span id="l4.18"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/components/cloudfile/content/Hightail/management.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/components/cloudfile/content/Hightail/management.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1,12 +1,15 @@</span>
<a href="#l5.4"></a><span id="l5.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.5"></a><span id="l5.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l5.6"></a><span id="l5.6">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8" class="difflineplus">+// mail/base/content/protovis-r2.6-modded.js</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineplus">+/* globals pv */</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+</span>
<a href="#l5.11"></a><span id="l5.11"> function onLoadProvider(provider) {</span>
<a href="#l5.12"></a><span id="l5.12">   let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l5.13"></a><span id="l5.13">                     .createInstance(Ci.nsIMessenger);</span>
<a href="#l5.14"></a><span id="l5.14"> </span>
<a href="#l5.15"></a><span id="l5.15">   let fileSpaceUsed = document.getElementById(&quot;file-space-used&quot;);</span>
<a href="#l5.16"></a><span id="l5.16">   fileSpaceUsed.textContent = messenger.formatFileSize(provider.fileSpaceUsed);</span>
<a href="#l5.17"></a><span id="l5.17">   let fileSpaceUsedSwatch = document.getElementById(&quot;file-space-used-swatch&quot;);</span>
<a href="#l5.18"></a><span id="l5.18">   fileSpaceUsedSwatch.style.backgroundColor = pv.Colors.category20.values[0];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/components/cloudfile/content/addAccountDialog.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/components/cloudfile/content/addAccountDialog.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -5,47 +5,45 @@</span>
<a href="#l6.4"></a><span id="l6.4">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.5"></a><span id="l6.5"> </span>
<a href="#l6.6"></a><span id="l6.6"> var kFormId = &quot;provider-form&quot;;</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l6.9"></a><span id="l6.9"> ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l6.10"></a><span id="l6.10"> ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.js&quot;);</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-function createAccountObserver() {};</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+function createAccountObserver() {}</span>
<a href="#l6.14"></a><span id="l6.14"> </span>
<a href="#l6.15"></a><span id="l6.15"> createAccountObserver.prototype = {</span>
<a href="#l6.16"></a><span id="l6.16">   QueryInterface: ChromeUtils.generateQI([Ci.nsIRequestObserver]),</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-  onStartRequest: function(aRequest, aContext) {},</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-  onStopRequest: function(aRequest, aContext, aStatusCode) {</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineplus">+  onStartRequest(aRequest, aContext) {},</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+  onStopRequest(aRequest, aContext, aStatusCode) {</span>
<a href="#l6.21"></a><span id="l6.21">     if (aStatusCode == Cr.NS_OK</span>
<a href="#l6.22"></a><span id="l6.22">         &amp;&amp; aContext instanceof Ci.nsIMsgCloudFileProvider) {</span>
<a href="#l6.23"></a><span id="l6.23">       let accountKey = aContext.accountKey;</span>
<a href="#l6.24"></a><span id="l6.24"> </span>
<a href="#l6.25"></a><span id="l6.25">       // For now, we'll just set the display name to be the name of the service</span>
<a href="#l6.26"></a><span id="l6.26">       cloudFileAccounts.setDisplayName(accountKey, aContext.displayName);</span>
<a href="#l6.27"></a><span id="l6.27"> </span>
<a href="#l6.28"></a><span id="l6.28">       window.arguments[0].accountKey = aContext.accountKey;</span>
<a href="#l6.29"></a><span id="l6.29">       window.close();</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-    }</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-    else {</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+    } else {</span>
<a href="#l6.33"></a><span id="l6.33">       if (aContext instanceof Ci.nsIMsgCloudFileProvider) {</span>
<a href="#l6.34"></a><span id="l6.34">         cloudFileAccounts.removeAccount(aContext.accountKey);</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">-      }</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">-      else {</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+      } else {</span>
<a href="#l6.38"></a><span id="l6.38">         // Something went seriously wrong here...</span>
<a href="#l6.39"></a><span id="l6.39">         Cu.reportError(&quot;Cloud account creation failed, and &quot; +</span>
<a href="#l6.40"></a><span id="l6.40">                        &quot;provider instance missing!&quot;);</span>
<a href="#l6.41"></a><span id="l6.41">       }</span>
<a href="#l6.42"></a><span id="l6.42"> </span>
<a href="#l6.43"></a><span id="l6.43">       addAccountDialog._accept.disabled = false;</span>
<a href="#l6.44"></a><span id="l6.44">       addAccountDialog._messages.selectedPanel = addAccountDialog._error;</span>
<a href="#l6.45"></a><span id="l6.45">     }</span>
<a href="#l6.46"></a><span id="l6.46">   },</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineminus">-}</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineplus">+};</span>
<a href="#l6.49"></a><span id="l6.49"> </span>
<a href="#l6.50"></a><span id="l6.50"> var addAccountDialog = {</span>
<a href="#l6.51"></a><span id="l6.51">   _settings: null,</span>
<a href="#l6.52"></a><span id="l6.52">   _settingsWrap: null,</span>
<a href="#l6.53"></a><span id="l6.53">   _accountType: null,</span>
<a href="#l6.54"></a><span id="l6.54">   _accept: null,</span>
<a href="#l6.55"></a><span id="l6.55">   _strings: Services.strings</span>
<a href="#l6.56"></a><span id="l6.56">                     .createBundle(&quot;chrome://messenger/locale/cloudfile/addAccountDialog.properties&quot;),</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineat">@@ -92,26 +90,26 @@ var addAccountDialog = {</span>
<a href="#l6.58"></a><span id="l6.58">     // The default emptySettings.xhtml is already loaded into the IFrame</span>
<a href="#l6.59"></a><span id="l6.59">     // at this point, before we could attach our DOMContentLoaded event</span>
<a href="#l6.60"></a><span id="l6.60">     // listener, so we'll call the function here manually.</span>
<a href="#l6.61"></a><span id="l6.61">     this.onIFrameLoaded(null);</span>
<a href="#l6.62"></a><span id="l6.62"> </span>
<a href="#l6.63"></a><span id="l6.63">     addAccountDialog.fitIFrame();</span>
<a href="#l6.64"></a><span id="l6.64">   },</span>
<a href="#l6.65"></a><span id="l6.65"> </span>
<a href="#l6.66"></a><span id="l6.66" class="difflineminus">-  onUnInit: function() {</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineplus">+  onUnInit() {</span>
<a href="#l6.68"></a><span id="l6.68">     // Clean-up the event listeners.</span>
<a href="#l6.69"></a><span id="l6.69">     this._settings.removeEventListener(&quot;DOMContentLoaded&quot;, this);</span>
<a href="#l6.70"></a><span id="l6.70">     this._settings.removeEventListener(&quot;overflow&quot;, this);</span>
<a href="#l6.71"></a><span id="l6.71">     this._accountType.removeEventListener(&quot;select&quot;, this);</span>
<a href="#l6.72"></a><span id="l6.72"> </span>
<a href="#l6.73"></a><span id="l6.73">     return true;</span>
<a href="#l6.74"></a><span id="l6.74">   },</span>
<a href="#l6.75"></a><span id="l6.75"> </span>
<a href="#l6.76"></a><span id="l6.76" class="difflineminus">-  handleEvent: function(aEvent) {</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineplus">+  handleEvent(aEvent) {</span>
<a href="#l6.78"></a><span id="l6.78">     switch (aEvent.type) {</span>
<a href="#l6.79"></a><span id="l6.79">       case &quot;DOMContentLoaded&quot;: {</span>
<a href="#l6.80"></a><span id="l6.80">         this.onIFrameLoaded();</span>
<a href="#l6.81"></a><span id="l6.81">         break;</span>
<a href="#l6.82"></a><span id="l6.82">       }</span>
<a href="#l6.83"></a><span id="l6.83">       case &quot;overflow&quot;: {</span>
<a href="#l6.84"></a><span id="l6.84">         if (this._settings.contentDocument.body)</span>
<a href="#l6.85"></a><span id="l6.85">           this.fitIFrame();</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineat">@@ -141,17 +139,17 @@ var addAccountDialog = {</span>
<a href="#l6.87"></a><span id="l6.87"> </span>
<a href="#l6.88"></a><span id="l6.88">     // Focus the first field in the form, if any, that does not have the</span>
<a href="#l6.89"></a><span id="l6.89">     // class &quot;focus-filter&quot;.</span>
<a href="#l6.90"></a><span id="l6.90">     let firstField = doc.querySelector(&quot;form:not(.filter) input:not(.hidden)&quot;);</span>
<a href="#l6.91"></a><span id="l6.91">     if (firstField)</span>
<a href="#l6.92"></a><span id="l6.92">       firstField.focus();</span>
<a href="#l6.93"></a><span id="l6.93">   },</span>
<a href="#l6.94"></a><span id="l6.94"> </span>
<a href="#l6.95"></a><span id="l6.95" class="difflineminus">-  fitIFrame: function() {</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineplus">+  fitIFrame() {</span>
<a href="#l6.97"></a><span id="l6.97">     // Determine the height of the accountSettings iframe, and adjust</span>
<a href="#l6.98"></a><span id="l6.98">     // the height of the window appropriately.</span>
<a href="#l6.99"></a><span id="l6.99"> </span>
<a href="#l6.100"></a><span id="l6.100">     // If no account is available, |.body| is undefined. In this case</span>
<a href="#l6.101"></a><span id="l6.101">     // return a minimum height of 16px without calling sizeToContent().</span>
<a href="#l6.102"></a><span id="l6.102">     if (!this._settings.contentDocument.body) {</span>
<a href="#l6.103"></a><span id="l6.103">       Cu.reportError(&quot;WARNING: addAccountDialog.js: fitFrame: There is no account and this._settings.contentDocument.body is undefined.&quot;);</span>
<a href="#l6.104"></a><span id="l6.104">       this._settings.style.height = this._settings.style.minHeight = &quot;16px&quot;;</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineat">@@ -196,17 +194,17 @@ var addAccountDialog = {</span>
<a href="#l6.106"></a><span id="l6.106">     // This block should go away when bug 748437 gets fixed, since we'll</span>
<a href="#l6.107"></a><span id="l6.107">     // be able to add an arbitrary number of accounts for each account type.</span>
<a href="#l6.108"></a><span id="l6.108">     if (this._accountType.itemCount == 0) {</span>
<a href="#l6.109"></a><span id="l6.109">       this._createAccountText.hidden = true;</span>
<a href="#l6.110"></a><span id="l6.110">       this._accountType.hidden = true;</span>
<a href="#l6.111"></a><span id="l6.111">       this._accept.disabled = true;</span>
<a href="#l6.112"></a><span id="l6.112">       this._noAccountText.hidden = false;</span>
<a href="#l6.113"></a><span id="l6.113">       this._settings.classList.remove(&quot;indent&quot;);</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineminus">-      this._settings.classList.add(&quot;small-indent&quot;)</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineplus">+      this._settings.classList.add(&quot;small-indent&quot;);</span>
<a href="#l6.116"></a><span id="l6.116">       this._cancel.focus();</span>
<a href="#l6.117"></a><span id="l6.117">     }</span>
<a href="#l6.118"></a><span id="l6.118"> </span>
<a href="#l6.119"></a><span id="l6.119">     // If there's only one option, let's choose it for the user to avoid</span>
<a href="#l6.120"></a><span id="l6.120">     // a few clicks.</span>
<a href="#l6.121"></a><span id="l6.121">     if (this._accountType.itemCount == 1)</span>
<a href="#l6.122"></a><span id="l6.122">       this._accountType.selectedIndex = 0;</span>
<a href="#l6.123"></a><span id="l6.123"> </span>
<a href="#l6.124"></a><span id="l6.124" class="difflineat">@@ -214,17 +212,17 @@ var addAccountDialog = {</span>
<a href="#l6.125"></a><span id="l6.125">   },</span>
<a href="#l6.126"></a><span id="l6.126"> </span>
<a href="#l6.127"></a><span id="l6.127">   onOK: function AAD_onOK() {</span>
<a href="#l6.128"></a><span id="l6.128">     let accountType = this._accountType.value;</span>
<a href="#l6.129"></a><span id="l6.129">     let obs = new createAccountObserver();</span>
<a href="#l6.130"></a><span id="l6.130"> </span>
<a href="#l6.131"></a><span id="l6.131">     let extras = this.getExtraArgs();</span>
<a href="#l6.132"></a><span id="l6.132"> </span>
<a href="#l6.133"></a><span id="l6.133" class="difflineminus">-    let provider = cloudFileAccounts.createAccount(accountType, obs, extras);</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineplus">+    cloudFileAccounts.createAccount(accountType, obs, extras);</span>
<a href="#l6.135"></a><span id="l6.135">     this._accept.disabled = true;</span>
<a href="#l6.136"></a><span id="l6.136"> </span>
<a href="#l6.137"></a><span id="l6.137">     this._messages.selectedPanel = this._authSpinner;</span>
<a href="#l6.138"></a><span id="l6.138"> </span>
<a href="#l6.139"></a><span id="l6.139">     // Uninitialize the dialog before closing.</span>
<a href="#l6.140"></a><span id="l6.140">     this.onUnInit();</span>
<a href="#l6.141"></a><span id="l6.141">     return false;</span>
<a href="#l6.142"></a><span id="l6.142">   },</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineat">@@ -265,18 +263,17 @@ var addAccountDialog = {</span>
<a href="#l6.144"></a><span id="l6.144">   },</span>
<a href="#l6.145"></a><span id="l6.145"> </span>
<a href="#l6.146"></a><span id="l6.146">   onInput: function AAD_onInput() {</span>
<a href="#l6.147"></a><span id="l6.147">     // Let's see if we have everything we need to make OK enabled...</span>
<a href="#l6.148"></a><span id="l6.148">     if (this._accountType.selectedIndex == -1) {</span>
<a href="#l6.149"></a><span id="l6.149">       // We have the &quot;Select a service provider&quot; menuitem selected, so we</span>
<a href="#l6.150"></a><span id="l6.150">       // shouldn't be able to click &quot;Set up account&quot;</span>
<a href="#l6.151"></a><span id="l6.151">       this._accept.disabled = true;</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineminus">-    }</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineminus">-    else {</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineplus">+    } else {</span>
<a href="#l6.155"></a><span id="l6.155">       this._accept.disabled = !this.checkValidity();</span>
<a href="#l6.156"></a><span id="l6.156">     }</span>
<a href="#l6.157"></a><span id="l6.157">   },</span>
<a href="#l6.158"></a><span id="l6.158"> </span>
<a href="#l6.159"></a><span id="l6.159">   checkValidity: function AAD_checkValidity() {</span>
<a href="#l6.160"></a><span id="l6.160">     // If there's a form in the iframe, ensure that</span>
<a href="#l6.161"></a><span id="l6.161">     // it's checkValidity function passes.</span>
<a href="#l6.162"></a><span id="l6.162">     let form = this._settings</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineat">@@ -285,13 +282,13 @@ var addAccountDialog = {</span>
<a href="#l6.164"></a><span id="l6.164">                    .document</span>
<a href="#l6.165"></a><span id="l6.165">                    .getElementById(kFormId);</span>
<a href="#l6.166"></a><span id="l6.166"> </span>
<a href="#l6.167"></a><span id="l6.167">     if (form)</span>
<a href="#l6.168"></a><span id="l6.168">       return form.checkValidity();</span>
<a href="#l6.169"></a><span id="l6.169"> </span>
<a href="#l6.170"></a><span id="l6.170">     return true;</span>
<a href="#l6.171"></a><span id="l6.171">   },</span>
<a href="#l6.172"></a><span id="l6.172" class="difflineminus">-}</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineplus">+};</span>
<a href="#l6.174"></a><span id="l6.174"> </span>
<a href="#l6.175"></a><span id="l6.175"> XPCOMUtils.defineLazyServiceGetter(this, &quot;gProtocolService&quot;,</span>
<a href="#l6.176"></a><span id="l6.176">                                    &quot;@mozilla.org/uriloader/external-protocol-service;1&quot;,</span>
<a href="#l6.177"></a><span id="l6.177">                                    &quot;nsIExternalProtocolService&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/components/cloudfile/nsBox.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/components/cloudfile/nsBox.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -3,19 +3,21 @@</span>
<a href="#l7.4"></a><span id="l7.4">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.5"></a><span id="l7.5"> </span>
<a href="#l7.6"></a><span id="l7.6"> /* This file implements the nsIMsgCloudFileProvider interface.</span>
<a href="#l7.7"></a><span id="l7.7">  *</span>
<a href="#l7.8"></a><span id="l7.8">  * This component handles the Box implementation of the</span>
<a href="#l7.9"></a><span id="l7.9">  * nsIMsgCloudFileProvider interface.</span>
<a href="#l7.10"></a><span id="l7.10">  */</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+/* globals kClientId, kClientSecret */</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+</span>
<a href="#l7.14"></a><span id="l7.14"> ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l7.15"></a><span id="l7.15"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+const { Log4Moz } = ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;, null);</span>
<a href="#l7.18"></a><span id="l7.18"> ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.js&quot;);</span>
<a href="#l7.19"></a><span id="l7.19"> ChromeUtils.import(&quot;resource:///modules/OAuth2.jsm&quot;);</span>
<a href="#l7.20"></a><span id="l7.20"> ChromeUtils.import(&quot;resource://gre/modules/Http.jsm&quot;);</span>
<a href="#l7.21"></a><span id="l7.21"> </span>
<a href="#l7.22"></a><span id="l7.22"> Cu.importGlobalProperties([&quot;File&quot;, &quot;FormData&quot;, &quot;XMLHttpRequest&quot;]);</span>
<a href="#l7.23"></a><span id="l7.23"> </span>
<a href="#l7.24"></a><span id="l7.24"> var gServerUrl = &quot;https://api.box.com/2.0/&quot;;</span>
<a href="#l7.25"></a><span id="l7.25"> var gUploadUrl = &quot;https://upload.box.com/api/2.0/&quot;;</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineat">@@ -47,17 +49,17 @@ function nsBox() {</span>
<a href="#l7.27"></a><span id="l7.27">         aVal = &quot;&quot;;</span>
<a href="#l7.28"></a><span id="l7.28"> </span>
<a href="#l7.29"></a><span id="l7.29">       cloudFileAccounts.setSecretValue(account.accountKey,</span>
<a href="#l7.30"></a><span id="l7.30">                                        cloudFileAccounts.kTokenRealm,</span>
<a href="#l7.31"></a><span id="l7.31">                                        aVal);</span>
<a href="#l7.32"></a><span id="l7.32"> </span>
<a href="#l7.33"></a><span id="l7.33">       return (this.mRefreshToken = aVal);</span>
<a href="#l7.34"></a><span id="l7.34">     },</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">-    enumerable: true</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+    enumerable: true,</span>
<a href="#l7.37"></a><span id="l7.37">   });</span>
<a href="#l7.38"></a><span id="l7.38"> }</span>
<a href="#l7.39"></a><span id="l7.39"> </span>
<a href="#l7.40"></a><span id="l7.40"> nsBox.prototype = {</span>
<a href="#l7.41"></a><span id="l7.41">   /* nsISupports */</span>
<a href="#l7.42"></a><span id="l7.42">   QueryInterface: ChromeUtils.generateQI([Ci.nsIMsgCloudFileProvider]),</span>
<a href="#l7.43"></a><span id="l7.43"> </span>
<a href="#l7.44"></a><span id="l7.44">   classID: Components.ID(&quot;{c06a8707-7463-416c-8b39-e85044a4ff6e}&quot;),</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineat">@@ -74,26 +76,25 @@ nsBox.prototype = {</span>
<a href="#l7.46"></a><span id="l7.46">   completionURI: &quot;http://boxauthcallback.local/&quot;,</span>
<a href="#l7.47"></a><span id="l7.47"> </span>
<a href="#l7.48"></a><span id="l7.48">   _accountKey: false,</span>
<a href="#l7.49"></a><span id="l7.49">   _prefBranch: null,</span>
<a href="#l7.50"></a><span id="l7.50">   _folderId: &quot;&quot;,</span>
<a href="#l7.51"></a><span id="l7.51">   // If an access token exists, the user is logged in.</span>
<a href="#l7.52"></a><span id="l7.52">   get _loggedIn() { return !!this._oauth.accessToken; },</span>
<a href="#l7.53"></a><span id="l7.53">   _userInfo: null,</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">-  _file : null,</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineminus">-  _maxFileSize : -1,</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineminus">-  _fileSpaceUsed : -1,</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineminus">-  _totalStorage : -1,</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineminus">-  _lastErrorStatus : 0,</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineminus">-  _lastErrorText : &quot;&quot;,</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineminus">-  _uploadingFile : null,</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineminus">-  _uploader : null,</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineminus">-  _urlsForFiles : {},</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineminus">-  _uploadInfo : {},</span>
<a href="#l7.64"></a><span id="l7.64" class="difflineplus">+  _file: null,</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineplus">+  _maxFileSize: -1,</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineplus">+  _fileSpaceUsed: -1,</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineplus">+  _totalStorage: -1,</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+  _lastErrorText: &quot;&quot;,</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+  _uploadingFile: null,</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+  _uploader: null,</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+  _urlsForFiles: {},</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+  _uploadInfo: {},</span>
<a href="#l7.73"></a><span id="l7.73">   _uploads: [],</span>
<a href="#l7.74"></a><span id="l7.74">   _oauth: null,</span>
<a href="#l7.75"></a><span id="l7.75"> </span>
<a href="#l7.76"></a><span id="l7.76">   /**</span>
<a href="#l7.77"></a><span id="l7.77">    * Used by our testing framework to override the URLs that this component</span>
<a href="#l7.78"></a><span id="l7.78">    * communicates to.</span>
<a href="#l7.79"></a><span id="l7.79">    */</span>
<a href="#l7.80"></a><span id="l7.80">   overrideUrls: function nsBox_overrideUrls(aNumUrls, aUrls) {</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineat">@@ -116,20 +117,20 @@ nsBox.prototype = {</span>
<a href="#l7.82"></a><span id="l7.82">   /**</span>
<a href="#l7.83"></a><span id="l7.83">    * Private function for assigning the folder id from a cached version</span>
<a href="#l7.84"></a><span id="l7.84">    * If the folder doesn't exist, check if it exists on the server. If it</span>
<a href="#l7.85"></a><span id="l7.85">    * doesn't, set in motion the creation.</span>
<a href="#l7.86"></a><span id="l7.86">    *</span>
<a href="#l7.87"></a><span id="l7.87">    * @param aCallback called if folder is ready.</span>
<a href="#l7.88"></a><span id="l7.88">    */</span>
<a href="#l7.89"></a><span id="l7.89">   _initFolder: function nsBox__initFolder(aCallback) {</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineminus">-    this.log.info('_initFolder, cached folder id  = ' + this._cachedFolderId);</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+    this.log.info(&quot;_initFolder, cached folder id  = &quot; + this._cachedFolderId);</span>
<a href="#l7.92"></a><span id="l7.92"> </span>
<a href="#l7.93"></a><span id="l7.93">     let saveFolderId = (aFolderId) =&gt; {</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineminus">-      this.log.info('saveFolderId : ' + aFolderId);</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+      this.log.info(&quot;saveFolderId : &quot; + aFolderId);</span>
<a href="#l7.96"></a><span id="l7.96">       this._cachedFolderId = this._folderId = aFolderId;</span>
<a href="#l7.97"></a><span id="l7.97">       if (aCallback)</span>
<a href="#l7.98"></a><span id="l7.98">         aCallback();</span>
<a href="#l7.99"></a><span id="l7.99">     };</span>
<a href="#l7.100"></a><span id="l7.100"> </span>
<a href="#l7.101"></a><span id="l7.101">     let createThunderbirdFolder = () =&gt; {</span>
<a href="#l7.102"></a><span id="l7.102">       this._createFolder(&quot;Thunderbird&quot;, saveFolderId);</span>
<a href="#l7.103"></a><span id="l7.103">     };</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineat">@@ -159,23 +160,22 @@ nsBox.prototype = {</span>
<a href="#l7.105"></a><span id="l7.105">     this._uploads.shift();</span>
<a href="#l7.106"></a><span id="l7.106">     if (this._uploads.length &gt; 0) {</span>
<a href="#l7.107"></a><span id="l7.107">       let nextUpload = this._uploads[0];</span>
<a href="#l7.108"></a><span id="l7.108">       this.log.info(&quot;chaining upload, file = &quot; + nextUpload.file.leafName);</span>
<a href="#l7.109"></a><span id="l7.109">       this._uploadingFile = nextUpload.file;</span>
<a href="#l7.110"></a><span id="l7.110">       this._uploader = nextUpload;</span>
<a href="#l7.111"></a><span id="l7.111">       try {</span>
<a href="#l7.112"></a><span id="l7.112">         this.uploadFile(nextUpload.file, nextUpload.requestObserver);</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineminus">-      }</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineminus">-      catch (ex) {</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineplus">+      } catch (ex) {</span>
<a href="#l7.116"></a><span id="l7.116">         nextUpload.callback(nextUpload.requestObserver, Cr.NS_ERROR_FAILURE);</span>
<a href="#l7.117"></a><span id="l7.117">       }</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineplus">+    } else {</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineplus">+      this._uploader = null;</span>
<a href="#l7.120"></a><span id="l7.120">     }</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineminus">-    else</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineminus">-      this._uploader = null;</span>
<a href="#l7.123"></a><span id="l7.123">   },</span>
<a href="#l7.124"></a><span id="l7.124"> </span>
<a href="#l7.125"></a><span id="l7.125">   /**</span>
<a href="#l7.126"></a><span id="l7.126">    * Attempt to upload a file to Box's servers.</span>
<a href="#l7.127"></a><span id="l7.127">    *</span>
<a href="#l7.128"></a><span id="l7.128">    * @param aFile an nsIFile for uploading.</span>
<a href="#l7.129"></a><span id="l7.129">    * @param aCallback an nsIRequestObserver for monitoring the start and</span>
<a href="#l7.130"></a><span id="l7.130">    *                  stop states of the upload procedure.</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineat">@@ -208,50 +208,57 @@ nsBox.prototype = {</span>
<a href="#l7.132"></a><span id="l7.132"> </span>
<a href="#l7.133"></a><span id="l7.133">     let onGetUserInfoSuccess = function() {</span>
<a href="#l7.134"></a><span id="l7.134">       this._initFolder(finish);</span>
<a href="#l7.135"></a><span id="l7.135">     }.bind(this);</span>
<a href="#l7.136"></a><span id="l7.136"> </span>
<a href="#l7.137"></a><span id="l7.137">     let onAuthFailure = function() {</span>
<a href="#l7.138"></a><span id="l7.138">       aCallback.onStopRequest(null, null,</span>
<a href="#l7.139"></a><span id="l7.139">                               Ci.nsIMsgCloudFileProvider.authErr);</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineminus">-    }.bind(this);</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineplus">+    };</span>
<a href="#l7.142"></a><span id="l7.142"> </span>
<a href="#l7.143"></a><span id="l7.143">     this.log.info(&quot;Checking to see if we're logged in&quot;);</span>
<a href="#l7.144"></a><span id="l7.144"> </span>
<a href="#l7.145"></a><span id="l7.145">     if (!this._loggedIn) {</span>
<a href="#l7.146"></a><span id="l7.146">       let onLoginSuccess = function() {</span>
<a href="#l7.147"></a><span id="l7.147">         this._getUserInfo(onGetUserInfoSuccess, onAuthFailure);</span>
<a href="#l7.148"></a><span id="l7.148">       }.bind(this);</span>
<a href="#l7.149"></a><span id="l7.149"> </span>
<a href="#l7.150"></a><span id="l7.150" class="difflineminus">-      return this.logon(onLoginSuccess, onAuthFailure, true);</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineplus">+      this.logon(onLoginSuccess, onAuthFailure, true);</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineplus">+      return;</span>
<a href="#l7.153"></a><span id="l7.153">     }</span>
<a href="#l7.154"></a><span id="l7.154"> </span>
<a href="#l7.155"></a><span id="l7.155" class="difflineminus">-    if (!this._userInfo)</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineminus">-      return this._getUserInfo(onGetUserInfoSuccess, onAuthFailure);</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineplus">+    if (!this._userInfo) {</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineplus">+      this._getUserInfo(onGetUserInfoSuccess, onAuthFailure);</span>
<a href="#l7.159"></a><span id="l7.159" class="difflineplus">+      return;</span>
<a href="#l7.160"></a><span id="l7.160" class="difflineplus">+    }</span>
<a href="#l7.161"></a><span id="l7.161"> </span>
<a href="#l7.162"></a><span id="l7.162">     onGetUserInfoSuccess();</span>
<a href="#l7.163"></a><span id="l7.163">   },</span>
<a href="#l7.164"></a><span id="l7.164"> </span>
<a href="#l7.165"></a><span id="l7.165">   /**</span>
<a href="#l7.166"></a><span id="l7.166">    * A private function called when we're almost ready to kick off the upload</span>
<a href="#l7.167"></a><span id="l7.167">    * for a file. First, ensures that the file size is not too large, and that</span>
<a href="#l7.168"></a><span id="l7.168">    * we won't exceed our storage quota, and then kicks off the upload.</span>
<a href="#l7.169"></a><span id="l7.169">    *</span>
<a href="#l7.170"></a><span id="l7.170">    * @param aFile the nsIFile to upload</span>
<a href="#l7.171"></a><span id="l7.171">    * @param aCallback the nsIRequestObserver for monitoring the start and stop</span>
<a href="#l7.172"></a><span id="l7.172">    *                  states of the upload procedure.</span>
<a href="#l7.173"></a><span id="l7.173">    */</span>
<a href="#l7.174"></a><span id="l7.174">   _finishUpload: function nsBox__finishUpload(aFile, aCallback) {</span>
<a href="#l7.175"></a><span id="l7.175">     let exceedsFileLimit = Ci.nsIMsgCloudFileProvider.uploadExceedsFileLimit;</span>
<a href="#l7.176"></a><span id="l7.176">     let exceedsQuota = Ci.nsIMsgCloudFileProvider.uploadWouldExceedQuota;</span>
<a href="#l7.177"></a><span id="l7.177" class="difflineminus">-    if (aFile.fileSize &gt; this._maxFileSize)</span>
<a href="#l7.178"></a><span id="l7.178" class="difflineminus">-      return aCallback.onStopRequest(null, null, exceedsFileLimit);</span>
<a href="#l7.179"></a><span id="l7.179" class="difflineminus">-    if (aFile.fileSize &gt; this.remainingFileSpace)</span>
<a href="#l7.180"></a><span id="l7.180" class="difflineminus">-      return aCallback.onStopRequest(null, null, exceedsQuota);</span>
<a href="#l7.181"></a><span id="l7.181" class="difflineplus">+    if (aFile.fileSize &gt; this._maxFileSize) {</span>
<a href="#l7.182"></a><span id="l7.182" class="difflineplus">+      aCallback.onStopRequest(null, null, exceedsFileLimit);</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineplus">+      return;</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineplus">+    }</span>
<a href="#l7.185"></a><span id="l7.185" class="difflineplus">+    if (aFile.fileSize &gt; this.remainingFileSpace) {</span>
<a href="#l7.186"></a><span id="l7.186" class="difflineplus">+      aCallback.onStopRequest(null, null, exceedsQuota);</span>
<a href="#l7.187"></a><span id="l7.187" class="difflineplus">+      return;</span>
<a href="#l7.188"></a><span id="l7.188" class="difflineplus">+    }</span>
<a href="#l7.189"></a><span id="l7.189"> </span>
<a href="#l7.190"></a><span id="l7.190">     delete this._userInfo; // force us to update userInfo on every upload.</span>
<a href="#l7.191"></a><span id="l7.191"> </span>
<a href="#l7.192"></a><span id="l7.192">     if (!this._uploader) {</span>
<a href="#l7.193"></a><span id="l7.193">       this._uploader = new nsBoxFileUploader(this, aFile,</span>
<a href="#l7.194"></a><span id="l7.194">                                              this._uploaderCallback</span>
<a href="#l7.195"></a><span id="l7.195">                                                  .bind(this),</span>
<a href="#l7.196"></a><span id="l7.196">                                              aCallback);</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineat">@@ -265,18 +272,17 @@ nsBox.prototype = {</span>
<a href="#l7.198"></a><span id="l7.198">   /**</span>
<a href="#l7.199"></a><span id="l7.199">    * Cancels an in-progress file upload.</span>
<a href="#l7.200"></a><span id="l7.200">    *</span>
<a href="#l7.201"></a><span id="l7.201">    * @param aFile the nsIFile being uploaded.</span>
<a href="#l7.202"></a><span id="l7.202">    */</span>
<a href="#l7.203"></a><span id="l7.203">   cancelFileUpload: function nsBox_cancelFileUpload(aFile) {</span>
<a href="#l7.204"></a><span id="l7.204">     if (this._uploadingFile.equals(aFile)) {</span>
<a href="#l7.205"></a><span id="l7.205">       this._uploader.cancel();</span>
<a href="#l7.206"></a><span id="l7.206" class="difflineminus">-    }</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineminus">-    else {</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineplus">+    } else {</span>
<a href="#l7.209"></a><span id="l7.209">       for (let i = 0; i &lt; this._uploads.length; i++)</span>
<a href="#l7.210"></a><span id="l7.210">         if (this._uploads[i].file.equals(aFile)) {</span>
<a href="#l7.211"></a><span id="l7.211">           this._uploads[i].requestObserver.onStopRequest(</span>
<a href="#l7.212"></a><span id="l7.212">             null, null, Ci.nsIMsgCloudFileProvider.uploadCanceled);</span>
<a href="#l7.213"></a><span id="l7.213">           this._uploads.splice(i, 1);</span>
<a href="#l7.214"></a><span id="l7.214">           return;</span>
<a href="#l7.215"></a><span id="l7.215">         }</span>
<a href="#l7.216"></a><span id="l7.216">     }</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineat">@@ -297,17 +303,17 @@ nsBox.prototype = {</span>
<a href="#l7.218"></a><span id="l7.218">     if (!successCallback)</span>
<a href="#l7.219"></a><span id="l7.219">       successCallback = function() {</span>
<a href="#l7.220"></a><span id="l7.220">         this.requestObserver</span>
<a href="#l7.221"></a><span id="l7.221">             .onStopRequest(null, null,</span>
<a href="#l7.222"></a><span id="l7.222">                            this._loggedIn ? Cr.NS_OK : Ci.nsIMsgCloudFileProvider.authErr);</span>
<a href="#l7.223"></a><span id="l7.223">     }.bind(this);</span>
<a href="#l7.224"></a><span id="l7.224"> </span>
<a href="#l7.225"></a><span id="l7.225">     if (!failureCallback)</span>
<a href="#l7.226"></a><span id="l7.226" class="difflineminus">-      failureCallback = function () {</span>
<a href="#l7.227"></a><span id="l7.227" class="difflineplus">+      failureCallback = function() {</span>
<a href="#l7.228"></a><span id="l7.228">         this.requestObserver</span>
<a href="#l7.229"></a><span id="l7.229">             .onStopRequest(null, null, Ci.nsIMsgCloudFileProvider.authErr);</span>
<a href="#l7.230"></a><span id="l7.230">     }.bind(this);</span>
<a href="#l7.231"></a><span id="l7.231"> </span>
<a href="#l7.232"></a><span id="l7.232">     let accountInfoSuccess = function(aResponseText, aRequest) {</span>
<a href="#l7.233"></a><span id="l7.233">       this.log.info(&quot;get_account_info request response = &quot; + aResponseText);</span>
<a href="#l7.234"></a><span id="l7.234"> </span>
<a href="#l7.235"></a><span id="l7.235">       try {</span>
<a href="#l7.236"></a><span id="l7.236" class="difflineat">@@ -320,38 +326,37 @@ nsBox.prototype = {</span>
<a href="#l7.237"></a><span id="l7.237"> </span>
<a href="#l7.238"></a><span id="l7.238">         this._totalStorage = this._userInfo.space_amount;</span>
<a href="#l7.239"></a><span id="l7.239">         this._fileSpaceUsed = this._userInfo.space_used;</span>
<a href="#l7.240"></a><span id="l7.240">         this._maxFileSize = this._userInfo.max_upload_size;</span>
<a href="#l7.241"></a><span id="l7.241">         this.log.info(&quot;storage total = &quot; + this._totalStorage);</span>
<a href="#l7.242"></a><span id="l7.242">         this.log.info(&quot;storage used = &quot; + this._fileSpaceUsed);</span>
<a href="#l7.243"></a><span id="l7.243">         this.log.info(&quot;max file size = &quot; + this._maxFileSize);</span>
<a href="#l7.244"></a><span id="l7.244">         successCallback();</span>
<a href="#l7.245"></a><span id="l7.245" class="difflineminus">-      }</span>
<a href="#l7.246"></a><span id="l7.246" class="difflineminus">-      catch(e) {</span>
<a href="#l7.247"></a><span id="l7.247" class="difflineplus">+      } catch (e) {</span>
<a href="#l7.248"></a><span id="l7.248">         // most likely bad JSON</span>
<a href="#l7.249"></a><span id="l7.249">         this.log.error(&quot;Failed to parse account info response: &quot; + e);</span>
<a href="#l7.250"></a><span id="l7.250">         this.log.error(&quot;Account info response: &quot; + aResponseText);</span>
<a href="#l7.251"></a><span id="l7.251">         failureCallback();</span>
<a href="#l7.252"></a><span id="l7.252">       }</span>
<a href="#l7.253"></a><span id="l7.253">     }.bind(this);</span>
<a href="#l7.254"></a><span id="l7.254">     let accountInfoFailure = function(aException, aResponseText, aRequest) {</span>
<a href="#l7.255"></a><span id="l7.255">       this.log.info(&quot;Failed to acquire user info:&quot; + aResponseText);</span>
<a href="#l7.256"></a><span id="l7.256">       this.log.error(&quot;user info failed, status = &quot; + aRequest.status);</span>
<a href="#l7.257"></a><span id="l7.257">       this.log.error(&quot;response text = &quot; + aResponseText);</span>
<a href="#l7.258"></a><span id="l7.258">       this.log.error(&quot;exception = &quot; + aException);</span>
<a href="#l7.259"></a><span id="l7.259">       failureCallback();</span>
<a href="#l7.260"></a><span id="l7.260" class="difflineminus">-    }.bind(this)</span>
<a href="#l7.261"></a><span id="l7.261" class="difflineplus">+    }.bind(this);</span>
<a href="#l7.262"></a><span id="l7.262"> </span>
<a href="#l7.263"></a><span id="l7.263">     // Request to get user info</span>
<a href="#l7.264"></a><span id="l7.264">     httpRequest(requestUrl, {</span>
<a href="#l7.265"></a><span id="l7.265">                   onLoad: accountInfoSuccess,</span>
<a href="#l7.266"></a><span id="l7.266">                   onError: accountInfoFailure,</span>
<a href="#l7.267"></a><span id="l7.267">                   method: &quot;GET&quot;,</span>
<a href="#l7.268"></a><span id="l7.268" class="difflineminus">-                  headers: [[&quot;Authorization&quot;, &quot;Bearer &quot; + this._oauth.accessToken]]</span>
<a href="#l7.269"></a><span id="l7.269" class="difflineplus">+                  headers: [[&quot;Authorization&quot;, &quot;Bearer &quot; + this._oauth.accessToken]],</span>
<a href="#l7.270"></a><span id="l7.270">                 });</span>
<a href="#l7.271"></a><span id="l7.271">   },</span>
<a href="#l7.272"></a><span id="l7.272"> </span>
<a href="#l7.273"></a><span id="l7.273">   /**</span>
<a href="#l7.274"></a><span id="l7.274">    * A private function that first ensures that the user is logged in, and then</span>
<a href="#l7.275"></a><span id="l7.275">    * retrieves the user's profile information.</span>
<a href="#l7.276"></a><span id="l7.276">    *</span>
<a href="#l7.277"></a><span id="l7.277">    * @param aSuccessCallback the function called on successful information</span>
<a href="#l7.278"></a><span id="l7.278" class="difflineat">@@ -359,17 +364,17 @@ nsBox.prototype = {</span>
<a href="#l7.279"></a><span id="l7.279">    * @param aFailureCallback the function called on failed information retrieval</span>
<a href="#l7.280"></a><span id="l7.280">    * @param aWithUI a boolean for whether or not we should display authorization</span>
<a href="#l7.281"></a><span id="l7.281">    *                UI if we don't have a valid token anymore, or just fail out.</span>
<a href="#l7.282"></a><span id="l7.282">    */</span>
<a href="#l7.283"></a><span id="l7.283">   _logonAndGetUserInfo: function nsBox_logonAndGetUserInfo(aSuccessCallback,</span>
<a href="#l7.284"></a><span id="l7.284">                                                                aFailureCallback,</span>
<a href="#l7.285"></a><span id="l7.285">                                                                aWithUI) {</span>
<a href="#l7.286"></a><span id="l7.286">     if (!aFailureCallback)</span>
<a href="#l7.287"></a><span id="l7.287" class="difflineminus">-      aFailureCallback = function () {</span>
<a href="#l7.288"></a><span id="l7.288" class="difflineplus">+      aFailureCallback = function() {</span>
<a href="#l7.289"></a><span id="l7.289">         this.requestObserver</span>
<a href="#l7.290"></a><span id="l7.290">             .onStopRequest(null, null, Ci.nsIMsgCloudFileProvider.authErr);</span>
<a href="#l7.291"></a><span id="l7.291">       }.bind(this);</span>
<a href="#l7.292"></a><span id="l7.292"> </span>
<a href="#l7.293"></a><span id="l7.293">     return this.logon(function() {</span>
<a href="#l7.294"></a><span id="l7.294">       this._getUserInfo(aSuccessCallback, aFailureCallback);</span>
<a href="#l7.295"></a><span id="l7.295">     }.bind(this), aFailureCallback, aWithUI);</span>
<a href="#l7.296"></a><span id="l7.296">   },</span>
<a href="#l7.297"></a><span id="l7.297" class="difflineat">@@ -441,54 +446,51 @@ nsBox.prototype = {</span>
<a href="#l7.298"></a><span id="l7.298"> </span>
<a href="#l7.299"></a><span id="l7.299">       let folderId = null;</span>
<a href="#l7.300"></a><span id="l7.300">       try {</span>
<a href="#l7.301"></a><span id="l7.301">         let result = JSON.parse(aResponseText);</span>
<a href="#l7.302"></a><span id="l7.302"> </span>
<a href="#l7.303"></a><span id="l7.303">         // Ensure the JSON is somewhat valid.</span>
<a href="#l7.304"></a><span id="l7.304">         if (!result || !result.item_collection) {</span>
<a href="#l7.305"></a><span id="l7.305">           this._lastErrorText = &quot;Get folder failure&quot;;</span>
<a href="#l7.306"></a><span id="l7.306" class="difflineminus">-          this._lastErrorStatus = docStatus;</span>
<a href="#l7.307"></a><span id="l7.307">           return;</span>
<a href="#l7.308"></a><span id="l7.308">         }</span>
<a href="#l7.309"></a><span id="l7.309"> </span>
<a href="#l7.310"></a><span id="l7.310">         // Search the paths for the folder.</span>
<a href="#l7.311"></a><span id="l7.311">         for (let item of result.item_collection.entries) {</span>
<a href="#l7.312"></a><span id="l7.312">           // Found it!</span>
<a href="#l7.313"></a><span id="l7.313">           if (item.type == &quot;folder&quot; &amp;&amp; item.name == aName) {</span>
<a href="#l7.314"></a><span id="l7.314">             folderId = item.id;</span>
<a href="#l7.315"></a><span id="l7.315">             break;</span>
<a href="#l7.316"></a><span id="l7.316">           }</span>
<a href="#l7.317"></a><span id="l7.317">         }</span>
<a href="#l7.318"></a><span id="l7.318" class="difflineminus">-      }</span>
<a href="#l7.319"></a><span id="l7.319" class="difflineminus">-      catch(e) {</span>
<a href="#l7.320"></a><span id="l7.320" class="difflineplus">+      } catch (e) {</span>
<a href="#l7.321"></a><span id="l7.321">         // most likely bad JSON</span>
<a href="#l7.322"></a><span id="l7.322">         this.log.error(&quot;Failed to get the folder:\n&quot; + e);</span>
<a href="#l7.323"></a><span id="l7.323">       }</span>
<a href="#l7.324"></a><span id="l7.324"> </span>
<a href="#l7.325"></a><span id="l7.325">       // Return outside of the try-catch.</span>
<a href="#l7.326"></a><span id="l7.326">       if (folderId) {</span>
<a href="#l7.327"></a><span id="l7.327">         this.log.info(&quot;folder id = &quot; + folderId);</span>
<a href="#l7.328"></a><span id="l7.328" class="difflineminus">-        aSuccessCallback(folderId)</span>
<a href="#l7.329"></a><span id="l7.329" class="difflineminus">-      }</span>
<a href="#l7.330"></a><span id="l7.330" class="difflineminus">-      else {</span>
<a href="#l7.331"></a><span id="l7.331" class="difflineplus">+        aSuccessCallback(folderId);</span>
<a href="#l7.332"></a><span id="l7.332" class="difflineplus">+      } else {</span>
<a href="#l7.333"></a><span id="l7.333">         // Didn't find any item.</span>
<a href="#l7.334"></a><span id="l7.334">         aFailureCallback();</span>
<a href="#l7.335"></a><span id="l7.335">       }</span>
<a href="#l7.336"></a><span id="l7.336">     };</span>
<a href="#l7.337"></a><span id="l7.337">     let getFailure = (aException, aResponseText, aRequest) =&gt; {</span>
<a href="#l7.338"></a><span id="l7.338">       this.log.error(&quot;Failed to get an existing folder: &quot; + aRequest.status);</span>
<a href="#l7.339"></a><span id="l7.339">     };</span>
<a href="#l7.340"></a><span id="l7.340"> </span>
<a href="#l7.341"></a><span id="l7.341">     // Request to create the folder</span>
<a href="#l7.342"></a><span id="l7.342">     httpRequest(requestUrl, {</span>
<a href="#l7.343"></a><span id="l7.343">                   onLoad: getSuccess,</span>
<a href="#l7.344"></a><span id="l7.344">                   onError: getFailure,</span>
<a href="#l7.345"></a><span id="l7.345">                   method: &quot;GET&quot;,</span>
<a href="#l7.346"></a><span id="l7.346" class="difflineminus">-                  headers: [[&quot;Authorization&quot;, &quot;Bearer &quot; + this._oauth.accessToken]]</span>
<a href="#l7.347"></a><span id="l7.347" class="difflineplus">+                  headers: [[&quot;Authorization&quot;, &quot;Bearer &quot; + this._oauth.accessToken]],</span>
<a href="#l7.348"></a><span id="l7.348">                 });</span>
<a href="#l7.349"></a><span id="l7.349">   },</span>
<a href="#l7.350"></a><span id="l7.350"> </span>
<a href="#l7.351"></a><span id="l7.351">   /**</span>
<a href="#l7.352"></a><span id="l7.352">    * Private function for creating folder on the Box website.</span>
<a href="#l7.353"></a><span id="l7.353">    *</span>
<a href="#l7.354"></a><span id="l7.354">    * @param aName name of folder</span>
<a href="#l7.355"></a><span id="l7.355">    * @param aSuccessCallback called when folder is created</span>
<a href="#l7.356"></a><span id="l7.356" class="difflineat">@@ -496,54 +498,52 @@ nsBox.prototype = {</span>
<a href="#l7.357"></a><span id="l7.357">   _createFolder: function nsBox__createFolder(aName,</span>
<a href="#l7.358"></a><span id="l7.358">                                               aSuccessCallback) {</span>
<a href="#l7.359"></a><span id="l7.359">     this.log.info(&quot;Creating folder: &quot; + aName);</span>
<a href="#l7.360"></a><span id="l7.360">     if (Services.io.offline)</span>
<a href="#l7.361"></a><span id="l7.361">       throw Ci.nsIMsgCloudFileProvider.offlineErr;</span>
<a href="#l7.362"></a><span id="l7.362"> </span>
<a href="#l7.363"></a><span id="l7.363">     let body = {</span>
<a href="#l7.364"></a><span id="l7.364">       parent: {</span>
<a href="#l7.365"></a><span id="l7.365" class="difflineminus">-        id: &quot;0&quot;</span>
<a href="#l7.366"></a><span id="l7.366" class="difflineplus">+        id: &quot;0&quot;,</span>
<a href="#l7.367"></a><span id="l7.367">       },</span>
<a href="#l7.368"></a><span id="l7.368" class="difflineminus">-      name: aName</span>
<a href="#l7.369"></a><span id="l7.369" class="difflineplus">+      name: aName,</span>
<a href="#l7.370"></a><span id="l7.370">     };</span>
<a href="#l7.371"></a><span id="l7.371">     let requestUrl = gServerUrl + &quot;folders&quot;;</span>
<a href="#l7.372"></a><span id="l7.372">     this.log.info(&quot;create_folder requestUrl = &quot; + requestUrl);</span>
<a href="#l7.373"></a><span id="l7.373"> </span>
<a href="#l7.374"></a><span id="l7.374">     let createSuccess = function(aResponseText, aRequest) {</span>
<a href="#l7.375"></a><span id="l7.375">       this.log.info(&quot;create_folder request response = &quot; + aResponseText);</span>
<a href="#l7.376"></a><span id="l7.376"> </span>
<a href="#l7.377"></a><span id="l7.377">       try {</span>
<a href="#l7.378"></a><span id="l7.378">         let result = JSON.parse(aResponseText);</span>
<a href="#l7.379"></a><span id="l7.379"> </span>
<a href="#l7.380"></a><span id="l7.380">         if (!result || !result.id) {</span>
<a href="#l7.381"></a><span id="l7.381">           this._lastErrorText = &quot;Create folder failure&quot;;</span>
<a href="#l7.382"></a><span id="l7.382" class="difflineminus">-          this._lastErrorStatus = docStatus;</span>
<a href="#l7.383"></a><span id="l7.383">           return;</span>
<a href="#l7.384"></a><span id="l7.384">         }</span>
<a href="#l7.385"></a><span id="l7.385">         let folderId = result.id;</span>
<a href="#l7.386"></a><span id="l7.386">         this.log.info(&quot;folder id = &quot; + folderId);</span>
<a href="#l7.387"></a><span id="l7.387">         aSuccessCallback(folderId);</span>
<a href="#l7.388"></a><span id="l7.388" class="difflineminus">-      }</span>
<a href="#l7.389"></a><span id="l7.389" class="difflineminus">-      catch(e) {</span>
<a href="#l7.390"></a><span id="l7.390" class="difflineplus">+      } catch (e) {</span>
<a href="#l7.391"></a><span id="l7.391">         // most likely bad JSON</span>
<a href="#l7.392"></a><span id="l7.392">         this.log.error(&quot;Failed to create a new folder&quot;);</span>
<a href="#l7.393"></a><span id="l7.393">       }</span>
<a href="#l7.394"></a><span id="l7.394">     }.bind(this);</span>
<a href="#l7.395"></a><span id="l7.395">     let createFailure = function(aException, aResponseText, aRequest) {</span>
<a href="#l7.396"></a><span id="l7.396">       this.log.error(&quot;Failed to create a new folder: &quot; + aRequest.status);</span>
<a href="#l7.397"></a><span id="l7.397">     }.bind(this);</span>
<a href="#l7.398"></a><span id="l7.398"> </span>
<a href="#l7.399"></a><span id="l7.399">     // Request to create the folder</span>
<a href="#l7.400"></a><span id="l7.400">     httpRequest(requestUrl, {</span>
<a href="#l7.401"></a><span id="l7.401">                   onLoad: createSuccess,</span>
<a href="#l7.402"></a><span id="l7.402">                   onError: createFailure,</span>
<a href="#l7.403"></a><span id="l7.403">                   method: &quot;POST&quot;,</span>
<a href="#l7.404"></a><span id="l7.404">                   headers: [[&quot;Authorization&quot;, &quot;Bearer &quot; + this._oauth.accessToken]],</span>
<a href="#l7.405"></a><span id="l7.405" class="difflineminus">-                  postData: JSON.stringify(body)</span>
<a href="#l7.406"></a><span id="l7.406" class="difflineplus">+                  postData: JSON.stringify(body),</span>
<a href="#l7.407"></a><span id="l7.407">                 });</span>
<a href="#l7.408"></a><span id="l7.408">   },</span>
<a href="#l7.409"></a><span id="l7.409"> </span>
<a href="#l7.410"></a><span id="l7.410">   /**</span>
<a href="#l7.411"></a><span id="l7.411">    * If a the user associated with this account key already has an account,</span>
<a href="#l7.412"></a><span id="l7.412">    * allows them to log in.</span>
<a href="#l7.413"></a><span id="l7.413">    *</span>
<a href="#l7.414"></a><span id="l7.414">    * @param aRequestObserver an nsIRequestObserver for monitoring the start and</span>
<a href="#l7.415"></a><span id="l7.415" class="difflineat">@@ -625,47 +625,40 @@ nsBox.prototype = {</span>
<a href="#l7.416"></a><span id="l7.416">       aCallback.onStopRequest(null, null, Cr.NS_ERROR_FAILURE);</span>
<a href="#l7.417"></a><span id="l7.417">     }.bind(this);</span>
<a href="#l7.418"></a><span id="l7.418"> </span>
<a href="#l7.419"></a><span id="l7.419">     // Request to delete a file</span>
<a href="#l7.420"></a><span id="l7.420">     httpRequest(requestUrl, {</span>
<a href="#l7.421"></a><span id="l7.421">                   onLoad: deleteSuccess,</span>
<a href="#l7.422"></a><span id="l7.422">                   onError: deleteFailure,</span>
<a href="#l7.423"></a><span id="l7.423">                   method: &quot;DELETE&quot;,</span>
<a href="#l7.424"></a><span id="l7.424" class="difflineminus">-                  headers: [[&quot;Authorization&quot;, &quot;Bearer &quot; + this._oauth.accessToken]]</span>
<a href="#l7.425"></a><span id="l7.425" class="difflineplus">+                  headers: [[&quot;Authorization&quot;, &quot;Bearer &quot; + this._oauth.accessToken]],</span>
<a href="#l7.426"></a><span id="l7.426">                 });</span>
<a href="#l7.427"></a><span id="l7.427">   },</span>
<a href="#l7.428"></a><span id="l7.428"> </span>
<a href="#l7.429"></a><span id="l7.429">   /**</span>
<a href="#l7.430"></a><span id="l7.430">    * Attempt to log on and get the auth token for this Box account.</span>
<a href="#l7.431"></a><span id="l7.431">    *</span>
<a href="#l7.432"></a><span id="l7.432">    * @param successCallback the callback to be fired if logging on is successful</span>
<a href="#l7.433"></a><span id="l7.433">    * @param failureCallback the callback to be fired if loggong on fails</span>
<a href="#l7.434"></a><span id="l7.434">    * @aparam aWithUI a boolean for whether or not we should prompt for a password</span>
<a href="#l7.435"></a><span id="l7.435">    *                 if no auth token is currently stored.</span>
<a href="#l7.436"></a><span id="l7.436">    */</span>
<a href="#l7.437"></a><span id="l7.437">   logon: function nsBox_logon(successCallback, failureCallback, aWithUI) {</span>
<a href="#l7.438"></a><span id="l7.438">     // The token has expired, reauthenticate.</span>
<a href="#l7.439"></a><span id="l7.439">     if (this._oauth.tokenExpires &lt; (new Date()).getTime()) {</span>
<a href="#l7.440"></a><span id="l7.440">       this._oauth.connect(successCallback, failureCallback, aWithUI);</span>
<a href="#l7.441"></a><span id="l7.441" class="difflineminus">-    }</span>
<a href="#l7.442"></a><span id="l7.442" class="difflineminus">-    // The token is still valid, success!</span>
<a href="#l7.443"></a><span id="l7.443" class="difflineminus">-    else {</span>
<a href="#l7.444"></a><span id="l7.444" class="difflineplus">+    } else {</span>
<a href="#l7.445"></a><span id="l7.445" class="difflineplus">+      // The token is still valid, success!</span>
<a href="#l7.446"></a><span id="l7.446">       successCallback();</span>
<a href="#l7.447"></a><span id="l7.447">     }</span>
<a href="#l7.448"></a><span id="l7.448">   },</span>
<a href="#l7.449"></a><span id="l7.449"> </span>
<a href="#l7.450"></a><span id="l7.450">   get _cachedFolderId() {</span>
<a href="#l7.451"></a><span id="l7.451" class="difflineminus">-    let folderId = &quot;&quot;;</span>
<a href="#l7.452"></a><span id="l7.452" class="difflineminus">-    try {</span>
<a href="#l7.453"></a><span id="l7.453" class="difflineminus">-      folderId = this._prefBranch.getCharPref(&quot;folderid&quot;);</span>
<a href="#l7.454"></a><span id="l7.454" class="difflineminus">-    }</span>
<a href="#l7.455"></a><span id="l7.455" class="difflineminus">-    catch(e) { } // pref does not exist</span>
<a href="#l7.456"></a><span id="l7.456" class="difflineminus">-</span>
<a href="#l7.457"></a><span id="l7.457" class="difflineminus">-    return folderId;</span>
<a href="#l7.458"></a><span id="l7.458" class="difflineplus">+    return this._prefBranch.getCharPref(&quot;folderid&quot;, &quot;&quot;);</span>
<a href="#l7.459"></a><span id="l7.459">   },</span>
<a href="#l7.460"></a><span id="l7.460"> </span>
<a href="#l7.461"></a><span id="l7.461">   set _cachedFolderId(aVal) {</span>
<a href="#l7.462"></a><span id="l7.462">     if (!aVal)</span>
<a href="#l7.463"></a><span id="l7.463">       aVal = &quot;&quot;;</span>
<a href="#l7.464"></a><span id="l7.464"> </span>
<a href="#l7.465"></a><span id="l7.465">     this._prefBranch.setCharPref(&quot;folderid&quot;, aVal);</span>
<a href="#l7.466"></a><span id="l7.466">   },</span>
<a href="#l7.467"></a><span id="l7.467" class="difflineat">@@ -677,33 +670,32 @@ function nsBoxFileUploader(aBox, aFile, </span>
<a href="#l7.468"></a><span id="l7.468">   this.log = this.box.log;</span>
<a href="#l7.469"></a><span id="l7.469">   this.log.info(&quot;new nsBoxFileUploader file = &quot; + aFile.leafName);</span>
<a href="#l7.470"></a><span id="l7.470">   this.file = aFile;</span>
<a href="#l7.471"></a><span id="l7.471">   this.callback = aCallback;</span>
<a href="#l7.472"></a><span id="l7.472">   this.requestObserver = aRequestObserver;</span>
<a href="#l7.473"></a><span id="l7.473"> }</span>
<a href="#l7.474"></a><span id="l7.474"> </span>
<a href="#l7.475"></a><span id="l7.475"> nsBoxFileUploader.prototype = {</span>
<a href="#l7.476"></a><span id="l7.476" class="difflineminus">-  box : null,</span>
<a href="#l7.477"></a><span id="l7.477" class="difflineminus">-  file : null,</span>
<a href="#l7.478"></a><span id="l7.478" class="difflineminus">-  callback : null,</span>
<a href="#l7.479"></a><span id="l7.479" class="difflineminus">-  request : null,</span>
<a href="#l7.480"></a><span id="l7.480" class="difflineplus">+  box: null,</span>
<a href="#l7.481"></a><span id="l7.481" class="difflineplus">+  file: null,</span>
<a href="#l7.482"></a><span id="l7.482" class="difflineplus">+  callback: null,</span>
<a href="#l7.483"></a><span id="l7.483" class="difflineplus">+  request: null,</span>
<a href="#l7.484"></a><span id="l7.484"> </span>
<a href="#l7.485"></a><span id="l7.485">   /**</span>
<a href="#l7.486"></a><span id="l7.486">    * Do the upload of the file to Box.</span>
<a href="#l7.487"></a><span id="l7.487">    */</span>
<a href="#l7.488"></a><span id="l7.488">   uploadFile: function nsBox_uploadFile() {</span>
<a href="#l7.489"></a><span id="l7.489">     this.requestObserver.onStartRequest(null, null);</span>
<a href="#l7.490"></a><span id="l7.490">     let requestUrl = gUploadUrl + &quot;files/content&quot;;</span>
<a href="#l7.491"></a><span id="l7.491">     this.box._uploadInfo[this.file.path] = {};</span>
<a href="#l7.492"></a><span id="l7.492">     this.box._uploadInfo[this.file.path].uploadUrl = requestUrl;</span>
<a href="#l7.493"></a><span id="l7.493"> </span>
<a href="#l7.494"></a><span id="l7.494">     let req = new XMLHttpRequest();</span>
<a href="#l7.495"></a><span id="l7.495"> </span>
<a href="#l7.496"></a><span id="l7.496" class="difflineminus">-    let curDate = Date.now().toString();</span>
<a href="#l7.497"></a><span id="l7.497">     this.log.info(&quot;upload url = &quot; + requestUrl);</span>
<a href="#l7.498"></a><span id="l7.498">     this.request = req;</span>
<a href="#l7.499"></a><span id="l7.499">     req.open(&quot;POST&quot;, requestUrl, true);</span>
<a href="#l7.500"></a><span id="l7.500">     req.onload = function() {</span>
<a href="#l7.501"></a><span id="l7.501">       if (req.status &gt;= 200 &amp;&amp; req.status &lt; 400) {</span>
<a href="#l7.502"></a><span id="l7.502">         try {</span>
<a href="#l7.503"></a><span id="l7.503">           this.log.info(&quot;upload response = &quot; + req.responseText);</span>
<a href="#l7.504"></a><span id="l7.504">           let result = JSON.parse(req.responseText);</span>
<a href="#l7.505"></a><span id="l7.505" class="difflineat">@@ -735,44 +727,42 @@ nsBoxFileUploader.prototype = {</span>
<a href="#l7.506"></a><span id="l7.506"> </span>
<a href="#l7.507"></a><span id="l7.507">             // Currently only one file is uploaded at a time.</span>
<a href="#l7.508"></a><span id="l7.508">             let fileId = result.entries[0].id;</span>
<a href="#l7.509"></a><span id="l7.509">             this.box._uploadInfo[this.file.path].fileId = fileId;</span>
<a href="#l7.510"></a><span id="l7.510"> </span>
<a href="#l7.511"></a><span id="l7.511">             let requestUrl = gServerUrl + &quot;files/&quot; + fileId;</span>
<a href="#l7.512"></a><span id="l7.512">             let body = {</span>
<a href="#l7.513"></a><span id="l7.513">               shared_link: {</span>
<a href="#l7.514"></a><span id="l7.514" class="difflineminus">-                access: &quot;open&quot;</span>
<a href="#l7.515"></a><span id="l7.515" class="difflineminus">-              }</span>
<a href="#l7.516"></a><span id="l7.516" class="difflineplus">+                access: &quot;open&quot;,</span>
<a href="#l7.517"></a><span id="l7.517" class="difflineplus">+              },</span>
<a href="#l7.518"></a><span id="l7.518">             };</span>
<a href="#l7.519"></a><span id="l7.519">             httpRequest(requestUrl, {</span>
<a href="#l7.520"></a><span id="l7.520">               onLoad: shareSuccess,</span>
<a href="#l7.521"></a><span id="l7.521">               onError: shareFailure,</span>
<a href="#l7.522"></a><span id="l7.522">               method: &quot;PUT&quot;,</span>
<a href="#l7.523"></a><span id="l7.523">               headers: [[&quot;Authorization&quot;, &quot;Bearer &quot; + this.box._oauth.accessToken]],</span>
<a href="#l7.524"></a><span id="l7.524" class="difflineminus">-              postData: JSON.stringify(body)</span>
<a href="#l7.525"></a><span id="l7.525" class="difflineplus">+              postData: JSON.stringify(body),</span>
<a href="#l7.526"></a><span id="l7.526">             });</span>
<a href="#l7.527"></a><span id="l7.527" class="difflineminus">-          }</span>
<a href="#l7.528"></a><span id="l7.528" class="difflineminus">-          else {</span>
<a href="#l7.529"></a><span id="l7.529" class="difflineplus">+          } else {</span>
<a href="#l7.530"></a><span id="l7.530">             this.callback(this.requestObserver,</span>
<a href="#l7.531"></a><span id="l7.531">                       Ci.nsIMsgCloudFileProvider.uploadErr);</span>
<a href="#l7.532"></a><span id="l7.532">           }</span>
<a href="#l7.533"></a><span id="l7.533">         } catch (ex) {</span>
<a href="#l7.534"></a><span id="l7.534">           this.log.error(ex);</span>
<a href="#l7.535"></a><span id="l7.535">           this.callback(this.requestObserver,</span>
<a href="#l7.536"></a><span id="l7.536">                       Ci.nsIMsgCloudFileProvider.uploadErr);</span>
<a href="#l7.537"></a><span id="l7.537">         }</span>
<a href="#l7.538"></a><span id="l7.538" class="difflineminus">-      }</span>
<a href="#l7.539"></a><span id="l7.539" class="difflineminus">-      else {</span>
<a href="#l7.540"></a><span id="l7.540" class="difflineplus">+      } else {</span>
<a href="#l7.541"></a><span id="l7.541">         this.callback(this.requestObserver,</span>
<a href="#l7.542"></a><span id="l7.542">                       Ci.nsIMsgCloudFileProvider.uploadErr);</span>
<a href="#l7.543"></a><span id="l7.543">       }</span>
<a href="#l7.544"></a><span id="l7.544">     }.bind(this);</span>
<a href="#l7.545"></a><span id="l7.545"> </span>
<a href="#l7.546"></a><span id="l7.546" class="difflineminus">-    req.onerror = function () {</span>
<a href="#l7.547"></a><span id="l7.547" class="difflineplus">+    req.onerror = function() {</span>
<a href="#l7.548"></a><span id="l7.548">       if (this.callback)</span>
<a href="#l7.549"></a><span id="l7.549">         this.callback(this.requestObserver,</span>
<a href="#l7.550"></a><span id="l7.550">                       Ci.nsIMsgCloudFileProvider.uploadErr);</span>
<a href="#l7.551"></a><span id="l7.551">     }.bind(this);</span>
<a href="#l7.552"></a><span id="l7.552"> </span>
<a href="#l7.553"></a><span id="l7.553">     req.setRequestHeader(&quot;Authorization&quot;, &quot;Bearer &quot; + this.box._oauth.accessToken);</span>
<a href="#l7.554"></a><span id="l7.554"> </span>
<a href="#l7.555"></a><span id="l7.555">     // Encode the form.</span>
<a href="#l7.556"></a><span id="l7.556" class="difflineat">@@ -796,31 +786,33 @@ nsBoxFileUploader.prototype = {</span>
<a href="#l7.557"></a><span id="l7.557">       this.log.info(&quot;cancelling upload request&quot;);</span>
<a href="#l7.558"></a><span id="l7.558">       let req = this.request;</span>
<a href="#l7.559"></a><span id="l7.559">       if (req.channel) {</span>
<a href="#l7.560"></a><span id="l7.560">         this.log.info(&quot;cancelling upload channel&quot;);</span>
<a href="#l7.561"></a><span id="l7.561">         req.channel.cancel(Cr.NS_BINDING_ABORTED);</span>
<a href="#l7.562"></a><span id="l7.562">       }</span>
<a href="#l7.563"></a><span id="l7.563">       this.request = null;</span>
<a href="#l7.564"></a><span id="l7.564">     }</span>
<a href="#l7.565"></a><span id="l7.565" class="difflineminus">-  }</span>
<a href="#l7.566"></a><span id="l7.566" class="difflineplus">+  },</span>
<a href="#l7.567"></a><span id="l7.567"> };</span>
<a href="#l7.568"></a><span id="l7.568"> </span>
<a href="#l7.569"></a><span id="l7.569"> // Before you spend time trying to find out what this means, please note that</span>
<a href="#l7.570"></a><span id="l7.570"> // doing so and using the information WILL cause Box to revoke Thunderbird's</span>
<a href="#l7.571"></a><span id="l7.571"> // privileges,  which means not one Thunderbird user will be able to connect to</span>
<a href="#l7.572"></a><span id="l7.572"> // Box. This will cause unhappy users all around which means that the</span>
<a href="#l7.573"></a><span id="l7.573"> // Thunderbird developers will have to spend more time with user support, which</span>
<a href="#l7.574"></a><span id="l7.574"> // means less time for features, releases and bugfixes. For a paid developer</span>
<a href="#l7.575"></a><span id="l7.575"> // this would actually mean financial harm.</span>
<a href="#l7.576"></a><span id="l7.576"> //</span>
<a href="#l7.577"></a><span id="l7.577"> // Do you really want all of this to be your fault? Instead of using the</span>
<a href="#l7.578"></a><span id="l7.578"> // information contained here please get your own copy, its really easy.</span>
<a href="#l7.579"></a><span id="l7.579" class="difflineplus">+/* eslint-disable */</span>
<a href="#l7.580"></a><span id="l7.580"> (zqdx=&gt;{zqdx[&quot;\x65\x76\x61\x6C&quot;](zqdx[&quot;\x41\x72\x72\x61\x79&quot;][&quot;\x70\x72\x6F\x74&quot;+</span>
<a href="#l7.581"></a><span id="l7.581"> &quot;\x6F\x74\x79\x70\x65&quot;][&quot;\x6D\x61\x70&quot;][&quot;\x63\x61\x6C\x6C&quot;](&quot;wbs!lDmjfouJe&gt;#fyt&quot;+</span>
<a href="#l7.582"></a><span id="l7.582"> &quot;9n1bhk2gb6839mywo399zn{12eo{o#&lt;wbs!lDmjfouTfdsfu&gt;#vE33oEp8{Eo{rRw9E7iVJ4ODLw9F&quot;+</span>
<a href="#l7.583"></a><span id="l7.583"> &quot;zLqM#&lt;&quot;,__=&gt;zqdx[&quot;\x53\x74\x72\x69\x6E\x67&quot;][&quot;\x66\x72\x6F\x6D\x43\x68\x61\x72&quot;+</span>
<a href="#l7.584"></a><span id="l7.584"> &quot;\x43\x6F\x64\x65&quot;](__[&quot;&quot;+&quot;\x63\x68\x61\x72\x43\x6F\x64\x65\x41\x74&quot;](0)-1),this)</span>
<a href="#l7.585"></a><span id="l7.585"> [&quot;\x6A\x6F\x69\x6E&quot;](&quot;&quot;))})[&quot;\x63\x61\x6C\x6C&quot;]((this),Components[&quot;\x75\x74\x69&quot;+</span>
<a href="#l7.586"></a><span id="l7.586"> &quot;\x6c\x73&quot;][(&quot;\x67\x65\x74\x47\x6c\x6f\x62\x61\x6c\x46\x6f\x72\x4f\x62\x6a\x65&quot;)+</span>
<a href="#l7.587"></a><span id="l7.587"> &quot;\x63\x74&quot;](this));</span>
<a href="#l7.588"></a><span id="l7.588" class="difflineplus">+/* eslint-enable */</span>
<a href="#l7.589"></a><span id="l7.589"> </span>
<a href="#l7.590"></a><span id="l7.590"> var NSGetFactory = XPCOMUtils.generateNSGetFactory([nsBox]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/components/cloudfile/nsHightail.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/components/cloudfile/nsHightail.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -5,17 +5,17 @@</span>
<a href="#l8.4"></a><span id="l8.4"> /* This file implements the nsIMsgCloudFileProvider interface.</span>
<a href="#l8.5"></a><span id="l8.5">  *</span>
<a href="#l8.6"></a><span id="l8.6">  * This component handles the Hightail implementation of the</span>
<a href="#l8.7"></a><span id="l8.7">  * nsIMsgCloudFileProvider interface.</span>
<a href="#l8.8"></a><span id="l8.8">  */</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10"> ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l8.11"></a><span id="l8.11"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+const { Log4Moz } = ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;, null);</span>
<a href="#l8.14"></a><span id="l8.14"> ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.js&quot;);</span>
<a href="#l8.15"></a><span id="l8.15"> </span>
<a href="#l8.16"></a><span id="l8.16"> Cu.importGlobalProperties([&quot;XMLHttpRequest&quot;]);</span>
<a href="#l8.17"></a><span id="l8.17"> </span>
<a href="#l8.18"></a><span id="l8.18"> var gServerUrl = &quot;https://dpi.yousendit.com&quot;; // Production url</span>
<a href="#l8.19"></a><span id="l8.19"> // test url var gServerUrl = &quot;https://test2-api.yousendit.com&quot;;</span>
<a href="#l8.20"></a><span id="l8.20"> </span>
<a href="#l8.21"></a><span id="l8.21"> var kApiKey = &quot;7spvjdt7m4kycr7jyhywrdn2&quot;;</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineat">@@ -47,67 +47,67 @@ nsHightail.prototype = {</span>
<a href="#l8.23"></a><span id="l8.23">   get managementURL() { return &quot;chrome://messenger/content/cloudfile/Hightail/management.xhtml&quot;; },</span>
<a href="#l8.24"></a><span id="l8.24"> </span>
<a href="#l8.25"></a><span id="l8.25">   _accountKey: false,</span>
<a href="#l8.26"></a><span id="l8.26">   _prefBranch: null,</span>
<a href="#l8.27"></a><span id="l8.27">   _userName: &quot;&quot;,</span>
<a href="#l8.28"></a><span id="l8.28">   _password: &quot;&quot;,</span>
<a href="#l8.29"></a><span id="l8.29">   _loggedIn: false,</span>
<a href="#l8.30"></a><span id="l8.30">   _userInfo: null,</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-  _file : null,</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+  _file: null,</span>
<a href="#l8.33"></a><span id="l8.33">   _folderId: &quot;&quot;,</span>
<a href="#l8.34"></a><span id="l8.34">   _requestDate: null,</span>
<a href="#l8.35"></a><span id="l8.35">   _successCallback: null,</span>
<a href="#l8.36"></a><span id="l8.36">   _request: null,</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineminus">-  _maxFileSize : -1,</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineminus">-  _fileSpaceUsed : -1,</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineminus">-  _availableStorage : -1,</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineminus">-  _totalStorage : -1,</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineminus">-  _lastErrorStatus : 0,</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineminus">-  _lastErrorText : &quot;&quot;,</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineminus">-  _uploadingFile : null,</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineminus">-  _uploader : null,</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineminus">-  _urlsForFiles : {},</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineminus">-  _uploadInfo : {},</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+  _maxFileSize: -1,</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+  _fileSpaceUsed: -1,</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+  _availableStorage: -1,</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+  _totalStorage: -1,</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+  _lastErrorStatus: 0,</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+  _lastErrorText: &quot;&quot;,</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+  _uploadingFile: null,</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+  _uploader: null,</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+  _urlsForFiles: {},</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+  _uploadInfo: {},</span>
<a href="#l8.57"></a><span id="l8.57">   _uploads: [],</span>
<a href="#l8.58"></a><span id="l8.58"> </span>
<a href="#l8.59"></a><span id="l8.59">   /**</span>
<a href="#l8.60"></a><span id="l8.60">    * Used by our testing framework to override the URLs that this component</span>
<a href="#l8.61"></a><span id="l8.61">    * communicates to.</span>
<a href="#l8.62"></a><span id="l8.62">    */</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineminus">-  overrideUrls: function(aNumUrls, aUrls) {</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+  overrideUrls(aNumUrls, aUrls) {</span>
<a href="#l8.65"></a><span id="l8.65">     gServerUrl = aUrls[0];</span>
<a href="#l8.66"></a><span id="l8.66">   },</span>
<a href="#l8.67"></a><span id="l8.67"> </span>
<a href="#l8.68"></a><span id="l8.68">   /**</span>
<a href="#l8.69"></a><span id="l8.69">    * Initializes an instance of this nsIMsgCloudFileProvider for an account</span>
<a href="#l8.70"></a><span id="l8.70">    * with key aAccountKey.</span>
<a href="#l8.71"></a><span id="l8.71">    *</span>
<a href="#l8.72"></a><span id="l8.72">    * @param aAccountKey the account key to initialize this</span>
<a href="#l8.73"></a><span id="l8.73">    *                    nsIMsgCloudFileProvider with.</span>
<a href="#l8.74"></a><span id="l8.74">    */</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineminus">-  init: function(aAccountKey) {</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+  init(aAccountKey) {</span>
<a href="#l8.77"></a><span id="l8.77">     this._accountKey = aAccountKey;</span>
<a href="#l8.78"></a><span id="l8.78">     this._prefBranch = Services.prefs.getBranch(&quot;mail.cloud_files.accounts.&quot; +</span>
<a href="#l8.79"></a><span id="l8.79">                                                 aAccountKey + &quot;.&quot;);</span>
<a href="#l8.80"></a><span id="l8.80">     this._userName = this._prefBranch.getCharPref(&quot;username&quot;);</span>
<a href="#l8.81"></a><span id="l8.81">     this._loggedIn = this._cachedAuthToken != &quot;&quot;;</span>
<a href="#l8.82"></a><span id="l8.82">   },</span>
<a href="#l8.83"></a><span id="l8.83"> </span>
<a href="#l8.84"></a><span id="l8.84">   /**</span>
<a href="#l8.85"></a><span id="l8.85">    * Private function for retrieving or creating folder</span>
<a href="#l8.86"></a><span id="l8.86">    * on Hightail website for uploading file.</span>
<a href="#l8.87"></a><span id="l8.87">    *</span>
<a href="#l8.88"></a><span id="l8.88">    * @param aCallback called if folder is ready.</span>
<a href="#l8.89"></a><span id="l8.89">    */</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineminus">-  _initFolder: function(aCallback) {</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineminus">-    this.log.info('_initFolder');</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineplus">+  _initFolder(aCallback) {</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineplus">+    this.log.info(&quot;_initFolder&quot;);</span>
<a href="#l8.94"></a><span id="l8.94"> </span>
<a href="#l8.95"></a><span id="l8.95">     let saveFolderId = function(aFolderId) {</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineminus">-      this.log.info('saveFolderId');</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+      this.log.info(&quot;saveFolderId&quot;);</span>
<a href="#l8.98"></a><span id="l8.98">       this._folderId = aFolderId;</span>
<a href="#l8.99"></a><span id="l8.99">       if (aCallback)</span>
<a href="#l8.100"></a><span id="l8.100">         aCallback();</span>
<a href="#l8.101"></a><span id="l8.101">     }.bind(this);</span>
<a href="#l8.102"></a><span id="l8.102"> </span>
<a href="#l8.103"></a><span id="l8.103">     let createThunderbirdFolder = function(aParentFolderId) {</span>
<a href="#l8.104"></a><span id="l8.104">       this._createFolder(&quot;Mozilla Thunderbird&quot;, aParentFolderId, saveFolderId);</span>
<a href="#l8.105"></a><span id="l8.105">     }.bind(this);</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineat">@@ -134,46 +134,45 @@ nsHightail.prototype = {</span>
<a href="#l8.107"></a><span id="l8.107">   /**</span>
<a href="#l8.108"></a><span id="l8.108">    * Private callback function passed to, and called from</span>
<a href="#l8.109"></a><span id="l8.109">    * nsHightailFileUploader.</span>
<a href="#l8.110"></a><span id="l8.110">    *</span>
<a href="#l8.111"></a><span id="l8.111">    * @param aRequestObserver a request observer for monitoring the start and</span>
<a href="#l8.112"></a><span id="l8.112">    *                         stop states of a request.</span>
<a href="#l8.113"></a><span id="l8.113">    * @param aStatus the status of the request.</span>
<a href="#l8.114"></a><span id="l8.114">    */</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineminus">-  _uploaderCallback: function(aRequestObserver, aStatus) {</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineplus">+  _uploaderCallback(aRequestObserver, aStatus) {</span>
<a href="#l8.117"></a><span id="l8.117">     aRequestObserver.onStopRequest(null, null, aStatus);</span>
<a href="#l8.118"></a><span id="l8.118"> </span>
<a href="#l8.119"></a><span id="l8.119">     this._uploadingFile = null;</span>
<a href="#l8.120"></a><span id="l8.120">     this._uploads.shift();</span>
<a href="#l8.121"></a><span id="l8.121">     if (this._uploads.length &gt; 0) {</span>
<a href="#l8.122"></a><span id="l8.122">       let nextUpload = this._uploads[0];</span>
<a href="#l8.123"></a><span id="l8.123">       this.log.info(&quot;chaining upload, file = &quot; + nextUpload.file.leafName);</span>
<a href="#l8.124"></a><span id="l8.124">       this._uploadingFile = nextUpload.file;</span>
<a href="#l8.125"></a><span id="l8.125">       this._uploader = nextUpload;</span>
<a href="#l8.126"></a><span id="l8.126">       try {</span>
<a href="#l8.127"></a><span id="l8.127">         this.uploadFile(nextUpload.file, nextUpload.requestObserver);</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineminus">-      }</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineminus">-      catch (ex) {</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineplus">+      } catch (ex) {</span>
<a href="#l8.131"></a><span id="l8.131">         // I'd like to pass ex.result, but that doesn't seem to be defined.</span>
<a href="#l8.132"></a><span id="l8.132">         nextUpload.callback(nextUpload.requestObserver, Cr.NS_ERROR_FAILURE);</span>
<a href="#l8.133"></a><span id="l8.133">       }</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineplus">+    } else {</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineplus">+      this._uploader = null;</span>
<a href="#l8.136"></a><span id="l8.136">     }</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineminus">-    else</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineminus">-      this._uploader = null;</span>
<a href="#l8.139"></a><span id="l8.139">   },</span>
<a href="#l8.140"></a><span id="l8.140"> </span>
<a href="#l8.141"></a><span id="l8.141">   /**</span>
<a href="#l8.142"></a><span id="l8.142">    * Attempt to upload a file to Hightail's servers.</span>
<a href="#l8.143"></a><span id="l8.143">    *</span>
<a href="#l8.144"></a><span id="l8.144">    * @param aFile an nsIFile for uploading.</span>
<a href="#l8.145"></a><span id="l8.145">    * @param aCallback an nsIRequestObserver for monitoring the start and</span>
<a href="#l8.146"></a><span id="l8.146">    *                  stop states of the upload procedure.</span>
<a href="#l8.147"></a><span id="l8.147">    */</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineminus">-  uploadFile: function(aFile, aCallback) {</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineplus">+  uploadFile(aFile, aCallback) {</span>
<a href="#l8.150"></a><span id="l8.150">     if (Services.io.offline)</span>
<a href="#l8.151"></a><span id="l8.151">       throw Ci.nsIMsgCloudFileProvider.offlineErr;</span>
<a href="#l8.152"></a><span id="l8.152"> </span>
<a href="#l8.153"></a><span id="l8.153">     this.log.info(&quot;Preparing to upload a file&quot;);</span>
<a href="#l8.154"></a><span id="l8.154"> </span>
<a href="#l8.155"></a><span id="l8.155">     // if we're uploading a file, queue this request.</span>
<a href="#l8.156"></a><span id="l8.156">     if (this._uploadingFile &amp;&amp; this._uploadingFile != aFile) {</span>
<a href="#l8.157"></a><span id="l8.157">       this.log.info(&quot;Adding file to queue&quot;);</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineat">@@ -193,51 +192,59 @@ nsHightail.prototype = {</span>
<a href="#l8.159"></a><span id="l8.159"> </span>
<a href="#l8.160"></a><span id="l8.160">     let onGetUserInfoSuccess = function() {</span>
<a href="#l8.161"></a><span id="l8.161">       this._initFolder(finish);</span>
<a href="#l8.162"></a><span id="l8.162">     }.bind(this);</span>
<a href="#l8.163"></a><span id="l8.163"> </span>
<a href="#l8.164"></a><span id="l8.164">     let onAuthFailure = function() {</span>
<a href="#l8.165"></a><span id="l8.165">       aCallback.onStopRequest(null, null,</span>
<a href="#l8.166"></a><span id="l8.166">                               Ci.nsIMsgCloudFileProvider.authErr);</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineminus">-    }.bind(this);</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineplus">+    };</span>
<a href="#l8.169"></a><span id="l8.169"> </span>
<a href="#l8.170"></a><span id="l8.170">     this.log.info(&quot;Checking to see if we're logged in&quot;);</span>
<a href="#l8.171"></a><span id="l8.171"> </span>
<a href="#l8.172"></a><span id="l8.172">     if (!this._loggedIn) {</span>
<a href="#l8.173"></a><span id="l8.173">       let onLoginSuccess = function() {</span>
<a href="#l8.174"></a><span id="l8.174">         this._getUserInfo(onGetUserInfoSuccess, onAuthFailure);</span>
<a href="#l8.175"></a><span id="l8.175">       }.bind(this);</span>
<a href="#l8.176"></a><span id="l8.176"> </span>
<a href="#l8.177"></a><span id="l8.177" class="difflineminus">-      return this.logon(onLoginSuccess, onAuthFailure, true);</span>
<a href="#l8.178"></a><span id="l8.178" class="difflineplus">+      this.logon(onLoginSuccess, onAuthFailure, true);</span>
<a href="#l8.179"></a><span id="l8.179" class="difflineplus">+      return;</span>
<a href="#l8.180"></a><span id="l8.180">     }</span>
<a href="#l8.181"></a><span id="l8.181"> </span>
<a href="#l8.182"></a><span id="l8.182" class="difflineminus">-    if (!this._userInfo)</span>
<a href="#l8.183"></a><span id="l8.183" class="difflineminus">-      return this._getUserInfo(onGetUserInfoSuccess, onAuthFailure);</span>
<a href="#l8.184"></a><span id="l8.184" class="difflineplus">+    if (!this._userInfo) {</span>
<a href="#l8.185"></a><span id="l8.185" class="difflineplus">+      this._getUserInfo(onGetUserInfoSuccess, onAuthFailure);</span>
<a href="#l8.186"></a><span id="l8.186" class="difflineplus">+      return;</span>
<a href="#l8.187"></a><span id="l8.187" class="difflineplus">+    }</span>
<a href="#l8.188"></a><span id="l8.188"> </span>
<a href="#l8.189"></a><span id="l8.189">     onGetUserInfoSuccess();</span>
<a href="#l8.190"></a><span id="l8.190">   },</span>
<a href="#l8.191"></a><span id="l8.191"> </span>
<a href="#l8.192"></a><span id="l8.192">   /**</span>
<a href="#l8.193"></a><span id="l8.193">    * A private function called when we're almost ready to kick off the upload</span>
<a href="#l8.194"></a><span id="l8.194">    * for a file. First, ensures that the file size is not too large, and that</span>
<a href="#l8.195"></a><span id="l8.195">    * we won't exceed our storage quota, and then kicks off the upload.</span>
<a href="#l8.196"></a><span id="l8.196">    *</span>
<a href="#l8.197"></a><span id="l8.197">    * @param aFile the nsIFile to upload</span>
<a href="#l8.198"></a><span id="l8.198">    * @param aCallback the nsIRequestObserver for monitoring the start and stop</span>
<a href="#l8.199"></a><span id="l8.199">    *                  states of the upload procedure.</span>
<a href="#l8.200"></a><span id="l8.200">    */</span>
<a href="#l8.201"></a><span id="l8.201" class="difflineminus">-  _finishUpload: function(aFile, aCallback) {</span>
<a href="#l8.202"></a><span id="l8.202" class="difflineminus">-    if (aFile.fileSize &gt; 2147483648)</span>
<a href="#l8.203"></a><span id="l8.203" class="difflineminus">-      return this._fileExceedsLimit(aCallback, '2GB', 0);</span>
<a href="#l8.204"></a><span id="l8.204" class="difflineminus">-    if (aFile.fileSize &gt; this._maxFileSize)</span>
<a href="#l8.205"></a><span id="l8.205" class="difflineminus">-      return this._fileExceedsLimit(aCallback, 'Limit', 0);</span>
<a href="#l8.206"></a><span id="l8.206" class="difflineminus">-    if (aFile.fileSize &gt; this._availableStorage)</span>
<a href="#l8.207"></a><span id="l8.207" class="difflineminus">-      return this._fileExceedsLimit(aCallback, 'Quota',</span>
<a href="#l8.208"></a><span id="l8.208" class="difflineminus">-                                    aFile.fileSize + this._fileSpaceUsed);</span>
<a href="#l8.209"></a><span id="l8.209" class="difflineplus">+  _finishUpload(aFile, aCallback) {</span>
<a href="#l8.210"></a><span id="l8.210" class="difflineplus">+    if (aFile.fileSize &gt; 2147483648) {</span>
<a href="#l8.211"></a><span id="l8.211" class="difflineplus">+      this._fileExceedsLimit(aCallback, &quot;2GB&quot;, 0);</span>
<a href="#l8.212"></a><span id="l8.212" class="difflineplus">+      return;</span>
<a href="#l8.213"></a><span id="l8.213" class="difflineplus">+    }</span>
<a href="#l8.214"></a><span id="l8.214" class="difflineplus">+    if (aFile.fileSize &gt; this._maxFileSize) {</span>
<a href="#l8.215"></a><span id="l8.215" class="difflineplus">+      this._fileExceedsLimit(aCallback, &quot;Limit&quot;, 0);</span>
<a href="#l8.216"></a><span id="l8.216" class="difflineplus">+      return;</span>
<a href="#l8.217"></a><span id="l8.217" class="difflineplus">+    }</span>
<a href="#l8.218"></a><span id="l8.218" class="difflineplus">+    if (aFile.fileSize &gt; this._availableStorage) {</span>
<a href="#l8.219"></a><span id="l8.219" class="difflineplus">+      this._fileExceedsLimit(aCallback, &quot;Quota&quot;, aFile.fileSize + this._fileSpaceUsed);</span>
<a href="#l8.220"></a><span id="l8.220" class="difflineplus">+      return;</span>
<a href="#l8.221"></a><span id="l8.221" class="difflineplus">+    }</span>
<a href="#l8.222"></a><span id="l8.222"> </span>
<a href="#l8.223"></a><span id="l8.223">     delete this._userInfo; // force us to update userInfo on every upload.</span>
<a href="#l8.224"></a><span id="l8.224"> </span>
<a href="#l8.225"></a><span id="l8.225">     if (!this._uploader) {</span>
<a href="#l8.226"></a><span id="l8.226">       this._uploader = new nsHightailFileUploader(this, aFile,</span>
<a href="#l8.227"></a><span id="l8.227">                                                    this._uploaderCallback</span>
<a href="#l8.228"></a><span id="l8.228">                                                        .bind(this),</span>
<a href="#l8.229"></a><span id="l8.229">                                                    aCallback);</span>
<a href="#l8.230"></a><span id="l8.230" class="difflineat">@@ -249,17 +256,17 @@ nsHightail.prototype = {</span>
<a href="#l8.231"></a><span id="l8.231">   },</span>
<a href="#l8.232"></a><span id="l8.232"> </span>
<a href="#l8.233"></a><span id="l8.233">   /**</span>
<a href="#l8.234"></a><span id="l8.234">    * A private function called when upload exceeds file limit.</span>
<a href="#l8.235"></a><span id="l8.235">    *</span>
<a href="#l8.236"></a><span id="l8.236">    * @param aCallback the nsIRequestObserver for monitoring the start and stop</span>
<a href="#l8.237"></a><span id="l8.237">    *                  states of the upload procedure.</span>
<a href="#l8.238"></a><span id="l8.238">    */</span>
<a href="#l8.239"></a><span id="l8.239" class="difflineminus">-  _fileExceedsLimit: function(aCallback, aType, aStorageSize) {</span>
<a href="#l8.240"></a><span id="l8.240" class="difflineplus">+  _fileExceedsLimit(aCallback, aType, aStorageSize) {</span>
<a href="#l8.241"></a><span id="l8.241">     let cancel = Ci.nsIMsgCloudFileProvider.uploadCanceled;</span>
<a href="#l8.242"></a><span id="l8.242"> </span>
<a href="#l8.243"></a><span id="l8.243">     let args = {storage: aStorageSize};</span>
<a href="#l8.244"></a><span id="l8.244">     args.wrappedJSObject = args;</span>
<a href="#l8.245"></a><span id="l8.245">     Services.ww.openWindow(null,</span>
<a href="#l8.246"></a><span id="l8.246">                            &quot;chrome://messenger/content/cloudfile/Hightail/&quot;</span>
<a href="#l8.247"></a><span id="l8.247">                            + &quot;fileExceeds&quot; + aType + &quot;.xul&quot;,</span>
<a href="#l8.248"></a><span id="l8.248">                            &quot;Hightail&quot;, &quot;chrome,centerscreen,dialog,modal,resizable=yes&quot;,</span>
<a href="#l8.249"></a><span id="l8.249" class="difflineat">@@ -268,23 +275,22 @@ nsHightail.prototype = {</span>
<a href="#l8.250"></a><span id="l8.250">     return aCallback.onStopRequest(null, null, cancel);</span>
<a href="#l8.251"></a><span id="l8.251">   },</span>
<a href="#l8.252"></a><span id="l8.252"> </span>
<a href="#l8.253"></a><span id="l8.253">   /**</span>
<a href="#l8.254"></a><span id="l8.254">    * Cancels an in-progress file upload.</span>
<a href="#l8.255"></a><span id="l8.255">    *</span>
<a href="#l8.256"></a><span id="l8.256">    * @param aFile the nsIFile being uploaded.</span>
<a href="#l8.257"></a><span id="l8.257">    */</span>
<a href="#l8.258"></a><span id="l8.258" class="difflineminus">-  cancelFileUpload: function(aFile) {</span>
<a href="#l8.259"></a><span id="l8.259" class="difflineplus">+  cancelFileUpload(aFile) {</span>
<a href="#l8.260"></a><span id="l8.260">     this.log.info(&quot;in cancel upload&quot;);</span>
<a href="#l8.261"></a><span id="l8.261">     if (this._uploadingFile != null &amp;&amp; this._uploader != null &amp;&amp;</span>
<a href="#l8.262"></a><span id="l8.262">         this._uploadingFile.equals(aFile)) {</span>
<a href="#l8.263"></a><span id="l8.263">       this._uploader.cancel();</span>
<a href="#l8.264"></a><span id="l8.264" class="difflineminus">-    }</span>
<a href="#l8.265"></a><span id="l8.265" class="difflineminus">-    else {</span>
<a href="#l8.266"></a><span id="l8.266" class="difflineplus">+    } else {</span>
<a href="#l8.267"></a><span id="l8.267">       for (let i = 0; i &lt; this._uploads.length; i++)</span>
<a href="#l8.268"></a><span id="l8.268">         if (this._uploads[i].file.equals(aFile)) {</span>
<a href="#l8.269"></a><span id="l8.269">           this._uploads[i].requestObserver.onStopRequest(</span>
<a href="#l8.270"></a><span id="l8.270">             null, null, Ci.nsIMsgCloudFileProvider.uploadCanceled);</span>
<a href="#l8.271"></a><span id="l8.271">           this._uploads.splice(i, 1);</span>
<a href="#l8.272"></a><span id="l8.272">           return;</span>
<a href="#l8.273"></a><span id="l8.273">         }</span>
<a href="#l8.274"></a><span id="l8.274">     }</span>
<a href="#l8.275"></a><span id="l8.275" class="difflineat">@@ -292,17 +298,17 @@ nsHightail.prototype = {</span>
<a href="#l8.276"></a><span id="l8.276"> </span>
<a href="#l8.277"></a><span id="l8.277">   /**</span>
<a href="#l8.278"></a><span id="l8.278">    * A private function for dealing with stale tokens.  Attempts to refresh</span>
<a href="#l8.279"></a><span id="l8.279">    * the token without prompting for the password.</span>
<a href="#l8.280"></a><span id="l8.280">    *</span>
<a href="#l8.281"></a><span id="l8.281">    * @param aSuccessCallback called if token refresh is successful.</span>
<a href="#l8.282"></a><span id="l8.282">    * @param aFailureCallback called if token refresh fails.</span>
<a href="#l8.283"></a><span id="l8.283">    */</span>
<a href="#l8.284"></a><span id="l8.284" class="difflineminus">-  _handleStaleToken: function(aSuccessCallback, aFailureCallback) {</span>
<a href="#l8.285"></a><span id="l8.285" class="difflineplus">+  _handleStaleToken(aSuccessCallback, aFailureCallback) {</span>
<a href="#l8.286"></a><span id="l8.286">     this.log.info(&quot;Handling a stale token.&quot;);</span>
<a href="#l8.287"></a><span id="l8.287">     this._loggedIn = false;</span>
<a href="#l8.288"></a><span id="l8.288">     this._cachedAuthToken = &quot;&quot;;</span>
<a href="#l8.289"></a><span id="l8.289">     if (this.getPassword(this._userName, true) != &quot;&quot;) {</span>
<a href="#l8.290"></a><span id="l8.290">       this.log.info(&quot;Attempting to reauth with saved password&quot;);</span>
<a href="#l8.291"></a><span id="l8.291">       // We had a stored password - let's try logging in with that now.</span>
<a href="#l8.292"></a><span id="l8.292">       this.logon(aSuccessCallback, aFailureCallback,</span>
<a href="#l8.293"></a><span id="l8.293">                  false);</span>
<a href="#l8.294"></a><span id="l8.294" class="difflineat">@@ -315,17 +321,17 @@ nsHightail.prototype = {</span>
<a href="#l8.295"></a><span id="l8.295">   /**</span>
<a href="#l8.296"></a><span id="l8.296">    * A private function for retrieving profile information about a user.</span>
<a href="#l8.297"></a><span id="l8.297">    *</span>
<a href="#l8.298"></a><span id="l8.298">    * @param successCallback a callback fired if retrieving profile information</span>
<a href="#l8.299"></a><span id="l8.299">    *                        is successful.</span>
<a href="#l8.300"></a><span id="l8.300">    * @param failureCallback a callback fired if retrieving profile information</span>
<a href="#l8.301"></a><span id="l8.301">    *                        fails.</span>
<a href="#l8.302"></a><span id="l8.302">    */</span>
<a href="#l8.303"></a><span id="l8.303" class="difflineminus">-  _getUserInfo: function(successCallback, failureCallback) {</span>
<a href="#l8.304"></a><span id="l8.304" class="difflineplus">+  _getUserInfo(successCallback, failureCallback) {</span>
<a href="#l8.305"></a><span id="l8.305">     this.log.info(&quot;getting user info&quot;);</span>
<a href="#l8.306"></a><span id="l8.306">     let args = &quot;?email=&quot; + this._userName + &quot;&amp;&quot;;</span>
<a href="#l8.307"></a><span id="l8.307"> </span>
<a href="#l8.308"></a><span id="l8.308">     let req = new XMLHttpRequest();</span>
<a href="#l8.309"></a><span id="l8.309">     req.open(&quot;GET&quot;, gServerUrl + kUserInfoPath + args + kUrlTail, true);</span>
<a href="#l8.310"></a><span id="l8.310"> </span>
<a href="#l8.311"></a><span id="l8.311">     req.onload = function() {</span>
<a href="#l8.312"></a><span id="l8.312">       if (req.status &gt;= 200 &amp;&amp; req.status &lt; 400) {</span>
<a href="#l8.313"></a><span id="l8.313" class="difflineat">@@ -353,27 +359,27 @@ nsHightail.prototype = {</span>
<a href="#l8.314"></a><span id="l8.314">           return;</span>
<a href="#l8.315"></a><span id="l8.315">         }</span>
<a href="#l8.316"></a><span id="l8.316">         this._userInfo = docResponse;</span>
<a href="#l8.317"></a><span id="l8.317">         let account = docResponse.account;</span>
<a href="#l8.318"></a><span id="l8.318">         let storage = docResponse.storage;</span>
<a href="#l8.319"></a><span id="l8.319">         if (storage) {</span>
<a href="#l8.320"></a><span id="l8.320">           this._fileSpaceUsed = parseInt(storage.currentUsage);</span>
<a href="#l8.321"></a><span id="l8.321">           this._availableStorage = parseInt(storage.storageQuota) - this._fileSpaceUsed;</span>
<a href="#l8.322"></a><span id="l8.322" class="difflineplus">+        } else {</span>
<a href="#l8.323"></a><span id="l8.323" class="difflineplus">+          this._availableStorage = parseInt(account.availableStorage);</span>
<a href="#l8.324"></a><span id="l8.324">         }</span>
<a href="#l8.325"></a><span id="l8.325" class="difflineminus">-        else</span>
<a href="#l8.326"></a><span id="l8.326" class="difflineminus">-          this._availableStorage = parseInt(account.availableStorage);</span>
<a href="#l8.327"></a><span id="l8.327"> </span>
<a href="#l8.328"></a><span id="l8.328">         this._maxFileSize = docResponse.type == &quot;BAS&quot; ? 52428800 : (parseInt(account.maxFileSize));</span>
<a href="#l8.329"></a><span id="l8.329">         this.log.info(&quot;available storage = &quot; + this._availableStorage + &quot; max file size = &quot; + this._maxFileSize);</span>
<a href="#l8.330"></a><span id="l8.330"> </span>
<a href="#l8.331"></a><span id="l8.331">         successCallback();</span>
<a href="#l8.332"></a><span id="l8.332" class="difflineplus">+      } else {</span>
<a href="#l8.333"></a><span id="l8.333" class="difflineplus">+        failureCallback();</span>
<a href="#l8.334"></a><span id="l8.334">       }</span>
<a href="#l8.335"></a><span id="l8.335" class="difflineminus">-      else</span>
<a href="#l8.336"></a><span id="l8.336" class="difflineminus">-        failureCallback();</span>
<a href="#l8.337"></a><span id="l8.337">     }.bind(this);</span>
<a href="#l8.338"></a><span id="l8.338"> </span>
<a href="#l8.339"></a><span id="l8.339">     req.onerror = function() {</span>
<a href="#l8.340"></a><span id="l8.340">       this.log.info(&quot;getUserInfo failed - status = &quot; + req.status);</span>
<a href="#l8.341"></a><span id="l8.341">       failureCallback();</span>
<a href="#l8.342"></a><span id="l8.342">     }.bind(this);</span>
<a href="#l8.343"></a><span id="l8.343">     // Add a space at the end because http logging looks for two</span>
<a href="#l8.344"></a><span id="l8.344">     // spaces in the X-Auth-Token header to avoid putting passwords</span>
<a href="#l8.345"></a><span id="l8.345" class="difflineat">@@ -384,86 +390,84 @@ nsHightail.prototype = {</span>
<a href="#l8.346"></a><span id="l8.346">     req.send();</span>
<a href="#l8.347"></a><span id="l8.347">   },</span>
<a href="#l8.348"></a><span id="l8.348"> </span>
<a href="#l8.349"></a><span id="l8.349">   /**</span>
<a href="#l8.350"></a><span id="l8.350">    * Returns the sharing URL for some uploaded file.</span>
<a href="#l8.351"></a><span id="l8.351">    *</span>
<a href="#l8.352"></a><span id="l8.352">    * @param aFile the nsIFile to get the URL for.</span>
<a href="#l8.353"></a><span id="l8.353">    */</span>
<a href="#l8.354"></a><span id="l8.354" class="difflineminus">-  urlForFile: function(aFile) {</span>
<a href="#l8.355"></a><span id="l8.355" class="difflineplus">+  urlForFile(aFile) {</span>
<a href="#l8.356"></a><span id="l8.356">     return this._urlsForFiles[aFile.path];</span>
<a href="#l8.357"></a><span id="l8.357">   },</span>
<a href="#l8.358"></a><span id="l8.358"> </span>
<a href="#l8.359"></a><span id="l8.359">   /**</span>
<a href="#l8.360"></a><span id="l8.360">    * Attempts to refresh cached profile information for the account associated</span>
<a href="#l8.361"></a><span id="l8.361">    * with this instance's account key.</span>
<a href="#l8.362"></a><span id="l8.362">    *</span>
<a href="#l8.363"></a><span id="l8.363">    * @param aWithUI a boolean for whether or not we should prompt the user for</span>
<a href="#l8.364"></a><span id="l8.364">    *                a password if we don't have a proper token.</span>
<a href="#l8.365"></a><span id="l8.365">    * @param aListener an nsIRequestObserver for monitoring the start and stop</span>
<a href="#l8.366"></a><span id="l8.366">    *                  states of fetching profile information.</span>
<a href="#l8.367"></a><span id="l8.367">    */</span>
<a href="#l8.368"></a><span id="l8.368" class="difflineminus">-  refreshUserInfo: function(aWithUI, aListener) {</span>
<a href="#l8.369"></a><span id="l8.369" class="difflineplus">+  refreshUserInfo(aWithUI, aListener) {</span>
<a href="#l8.370"></a><span id="l8.370">     if (Services.io.offline)</span>
<a href="#l8.371"></a><span id="l8.371">       throw Ci.nsIMsgCloudFileProvider.offlineErr;</span>
<a href="#l8.372"></a><span id="l8.372"> </span>
<a href="#l8.373"></a><span id="l8.373">     aListener.onStartRequest(null, null);</span>
<a href="#l8.374"></a><span id="l8.374"> </span>
<a href="#l8.375"></a><span id="l8.375">     // Let's define some reusable callback functions...</span>
<a href="#l8.376"></a><span id="l8.376">     let onGetUserInfoSuccess = function() {</span>
<a href="#l8.377"></a><span id="l8.377">       aListener.onStopRequest(null, null, Cr.NS_OK);</span>
<a href="#l8.378"></a><span id="l8.378" class="difflineminus">-    }</span>
<a href="#l8.379"></a><span id="l8.379" class="difflineplus">+    };</span>
<a href="#l8.380"></a><span id="l8.380"> </span>
<a href="#l8.381"></a><span id="l8.381">     let onAuthFailure = function() {</span>
<a href="#l8.382"></a><span id="l8.382">       aListener.onStopRequest(null, null,</span>
<a href="#l8.383"></a><span id="l8.383">                               Ci.nsIMsgCloudFileProvider.authErr);</span>
<a href="#l8.384"></a><span id="l8.384" class="difflineminus">-    }</span>
<a href="#l8.385"></a><span id="l8.385" class="difflineplus">+    };</span>
<a href="#l8.386"></a><span id="l8.386"> </span>
<a href="#l8.387"></a><span id="l8.387">     // If we're not logged in, attempt to login, and then attempt to</span>
<a href="#l8.388"></a><span id="l8.388">     // get user info if logging in is successful.</span>
<a href="#l8.389"></a><span id="l8.389">     this.log.info(&quot;Checking to see if we're logged in&quot;);</span>
<a href="#l8.390"></a><span id="l8.390">     if (!this._loggedIn) {</span>
<a href="#l8.391"></a><span id="l8.391">       let onLoginSuccess = function() {</span>
<a href="#l8.392"></a><span id="l8.392">         this._getUserInfo(onGetUserInfoSuccess, onAuthFailure);</span>
<a href="#l8.393"></a><span id="l8.393">       }.bind(this);</span>
<a href="#l8.394"></a><span id="l8.394"> </span>
<a href="#l8.395"></a><span id="l8.395" class="difflineminus">-      return this.logon(onLoginSuccess, onAuthFailure, aWithUI);</span>
<a href="#l8.396"></a><span id="l8.396" class="difflineplus">+      this.logon(onLoginSuccess, onAuthFailure, aWithUI);</span>
<a href="#l8.397"></a><span id="l8.397" class="difflineplus">+      return;</span>
<a href="#l8.398"></a><span id="l8.398">     }</span>
<a href="#l8.399"></a><span id="l8.399"> </span>
<a href="#l8.400"></a><span id="l8.400">     // If we're logged in, attempt to get user info.</span>
<a href="#l8.401"></a><span id="l8.401">     if (!this._userInfo)</span>
<a href="#l8.402"></a><span id="l8.402" class="difflineminus">-      return this._getUserInfo(onGetUserInfoSuccess, onAuthFailure);</span>
<a href="#l8.403"></a><span id="l8.403" class="difflineminus">-</span>
<a href="#l8.404"></a><span id="l8.404" class="difflineplus">+      this._getUserInfo(onGetUserInfoSuccess, onAuthFailure);</span>
<a href="#l8.405"></a><span id="l8.405">   },</span>
<a href="#l8.406"></a><span id="l8.406"> </span>
<a href="#l8.407"></a><span id="l8.407">   /**</span>
<a href="#l8.408"></a><span id="l8.408">    * Creates an account for a user.  Note that, currently, this function is</span>
<a href="#l8.409"></a><span id="l8.409">    * not being used by the UI.</span>
<a href="#l8.410"></a><span id="l8.410">    */</span>
<a href="#l8.411"></a><span id="l8.411" class="difflineminus">-  createNewAccount: function(aEmailAddress, aPassword,aFirstName, aLastName,</span>
<a href="#l8.412"></a><span id="l8.412" class="difflineminus">-                             aRequestObserver) {</span>
<a href="#l8.413"></a><span id="l8.413" class="difflineplus">+  createNewAccount(aEmailAddress, aPassword, aFirstName, aLastName, aRequestObserver) {</span>
<a href="#l8.414"></a><span id="l8.414">     if (Services.io.offline)</span>
<a href="#l8.415"></a><span id="l8.415">       throw Ci.nsIMsgCloudFileProvider.offlineErr;</span>
<a href="#l8.416"></a><span id="l8.416"> </span>
<a href="#l8.417"></a><span id="l8.417">     let args = &quot;?email=&quot; + aEmailAddress + &quot;&amp;password=&quot; + aPassword + &quot;&amp;firstname=&quot;</span>
<a href="#l8.418"></a><span id="l8.418">                + aFirstName + &quot;&amp;lastname=&quot; + aLastName + &quot;&amp;&quot;;</span>
<a href="#l8.419"></a><span id="l8.419"> </span>
<a href="#l8.420"></a><span id="l8.420">     let req = new XMLHttpRequest();</span>
<a href="#l8.421"></a><span id="l8.421"> </span>
<a href="#l8.422"></a><span id="l8.422">     req.open(&quot;POST&quot;, gServerUrl + kUserInfoPath + args + kUrlTail, true);</span>
<a href="#l8.423"></a><span id="l8.423"> </span>
<a href="#l8.424"></a><span id="l8.424">     req.onload = function() {</span>
<a href="#l8.425"></a><span id="l8.425">       if (req.status &gt;= 200 &amp;&amp;</span>
<a href="#l8.426"></a><span id="l8.426">           req.status &lt; 400) {</span>
<a href="#l8.427"></a><span id="l8.427">         this.log.info(&quot;request status = &quot; + req + &quot; response = &quot; +</span>
<a href="#l8.428"></a><span id="l8.428">                       req.responseText);</span>
<a href="#l8.429"></a><span id="l8.429">         aRequestObserver.onStopRequest(null, null, Cr.NS_OK);</span>
<a href="#l8.430"></a><span id="l8.430" class="difflineminus">-      }</span>
<a href="#l8.431"></a><span id="l8.431" class="difflineminus">-      else {</span>
<a href="#l8.432"></a><span id="l8.432" class="difflineplus">+      } else {</span>
<a href="#l8.433"></a><span id="l8.433">         let docResponse = JSON.parse(req.responseText);</span>
<a href="#l8.434"></a><span id="l8.434">         this._lastErrorText = docResponse.errorStatus.message;</span>
<a href="#l8.435"></a><span id="l8.435">         this._lastErrorStatus = docResponse.errorStatus.code;</span>
<a href="#l8.436"></a><span id="l8.436">         aRequestObserver.onStopRequest(null, null, Cr.NS_ERROR_FAILURE);</span>
<a href="#l8.437"></a><span id="l8.437">       }</span>
<a href="#l8.438"></a><span id="l8.438">     }.bind(this);</span>
<a href="#l8.439"></a><span id="l8.439"> </span>
<a href="#l8.440"></a><span id="l8.440">     req.onerror = function() {</span>
<a href="#l8.441"></a><span id="l8.441" class="difflineat">@@ -482,19 +486,17 @@ nsHightail.prototype = {</span>
<a href="#l8.442"></a><span id="l8.442">   /**</span>
<a href="#l8.443"></a><span id="l8.443">    * Attempt to find folder by name on Hightail website.</span>
<a href="#l8.444"></a><span id="l8.444">    *</span>
<a href="#l8.445"></a><span id="l8.445">    * @param aFolderName name of folder</span>
<a href="#l8.446"></a><span id="l8.446">    * @param aParentFolderId id of folder where we are looking</span>
<a href="#l8.447"></a><span id="l8.447">    * @param aNotFoundCallback called if folder is not found</span>
<a href="#l8.448"></a><span id="l8.448">    * @param aFoundCallback called if folder is found</span>
<a href="#l8.449"></a><span id="l8.449">    */</span>
<a href="#l8.450"></a><span id="l8.450" class="difflineminus">-  _findFolder: function(aFolderName, aParentFolderId, aNotFoundCallback,</span>
<a href="#l8.451"></a><span id="l8.451" class="difflineminus">-                        aFoundCallback) {</span>
<a href="#l8.452"></a><span id="l8.452" class="difflineminus">-</span>
<a href="#l8.453"></a><span id="l8.453" class="difflineplus">+  _findFolder(aFolderName, aParentFolderId, aNotFoundCallback, aFoundCallback) {</span>
<a href="#l8.454"></a><span id="l8.454">     this.log.info(&quot;Find folder: &quot; + aFolderName);</span>
<a href="#l8.455"></a><span id="l8.455"> </span>
<a href="#l8.456"></a><span id="l8.456">     let checkChildFolders = function(folders) {</span>
<a href="#l8.457"></a><span id="l8.457">       this.log.info(&quot;Looking for a child folder&quot;);</span>
<a href="#l8.458"></a><span id="l8.458">       let folderId = 0;</span>
<a href="#l8.459"></a><span id="l8.459">       let folder = folders.folder;</span>
<a href="#l8.460"></a><span id="l8.460">       for (let i in folder) {</span>
<a href="#l8.461"></a><span id="l8.461">         if (folder[i].name == aFolderName) {</span>
<a href="#l8.462"></a><span id="l8.462" class="difflineat">@@ -515,18 +517,18 @@ nsHightail.prototype = {</span>
<a href="#l8.463"></a><span id="l8.463"> </span>
<a href="#l8.464"></a><span id="l8.464">   /**</span>
<a href="#l8.465"></a><span id="l8.465">    * Attempt to find folder by id on Hightail website.</span>
<a href="#l8.466"></a><span id="l8.466">    *</span>
<a href="#l8.467"></a><span id="l8.467">    * @param aFolderId id of folder</span>
<a href="#l8.468"></a><span id="l8.468">    * @param aNotFoundCallback called if folder is not found</span>
<a href="#l8.469"></a><span id="l8.469">    * @param aFoundCallback called if folder is found</span>
<a href="#l8.470"></a><span id="l8.470">    */</span>
<a href="#l8.471"></a><span id="l8.471" class="difflineminus">-  _checkFolderExist: function(aFolderId, aFoundCallback, aNotFoundCallback) {</span>
<a href="#l8.472"></a><span id="l8.472" class="difflineminus">-    this.log.info('checkFolderExist');</span>
<a href="#l8.473"></a><span id="l8.473" class="difflineplus">+  _checkFolderExist(aFolderId, aFoundCallback, aNotFoundCallback) {</span>
<a href="#l8.474"></a><span id="l8.474" class="difflineplus">+    this.log.info(&quot;checkFolderExist&quot;);</span>
<a href="#l8.475"></a><span id="l8.475">     if (Services.io.offline)</span>
<a href="#l8.476"></a><span id="l8.476">       throw Ci.nsIMsgCloudFileProvider.offlineErr;</span>
<a href="#l8.477"></a><span id="l8.477"> </span>
<a href="#l8.478"></a><span id="l8.478">     let args = &quot;?includeFiles=false&amp;includeFolders=true&amp;&quot;;</span>
<a href="#l8.479"></a><span id="l8.479"> </span>
<a href="#l8.480"></a><span id="l8.480">     let req = new XMLHttpRequest();</span>
<a href="#l8.481"></a><span id="l8.481"> </span>
<a href="#l8.482"></a><span id="l8.482">     req.open(&quot;GET&quot;,</span>
<a href="#l8.483"></a><span id="l8.483" class="difflineat">@@ -536,18 +538,17 @@ nsHightail.prototype = {</span>
<a href="#l8.484"></a><span id="l8.484">     req.onload = function() {</span>
<a href="#l8.485"></a><span id="l8.485">       let docResponse = JSON.parse(req.responseText);</span>
<a href="#l8.486"></a><span id="l8.486">       if (req.status &gt;= 200 &amp;&amp; req.status &lt; 400) {</span>
<a href="#l8.487"></a><span id="l8.487">         this.log.info(&quot;request status = &quot; + req + &quot; response = &quot; +</span>
<a href="#l8.488"></a><span id="l8.488">                       req.responseText);</span>
<a href="#l8.489"></a><span id="l8.489"> </span>
<a href="#l8.490"></a><span id="l8.490">         if (aFoundCallback &amp;&amp; docResponse.folders)</span>
<a href="#l8.491"></a><span id="l8.491">           aFoundCallback(docResponse.folders);</span>
<a href="#l8.492"></a><span id="l8.492" class="difflineminus">-      }</span>
<a href="#l8.493"></a><span id="l8.493" class="difflineminus">-      else {</span>
<a href="#l8.494"></a><span id="l8.494" class="difflineplus">+      } else {</span>
<a href="#l8.495"></a><span id="l8.495">         this._lastErrorText = docResponse.errorStatus.message;</span>
<a href="#l8.496"></a><span id="l8.496">         this._lastErrorStatus = docResponse.errorStatus.code;</span>
<a href="#l8.497"></a><span id="l8.497">         if (this._lastErrorStatus == 400 &amp;&amp; this._lastErrorText == &quot;Not Found&quot; &amp;&amp; aNotFoundCallback)</span>
<a href="#l8.498"></a><span id="l8.498">           aNotFoundCallback();</span>
<a href="#l8.499"></a><span id="l8.499">       }</span>
<a href="#l8.500"></a><span id="l8.500">     }.bind(this);</span>
<a href="#l8.501"></a><span id="l8.501"> </span>
<a href="#l8.502"></a><span id="l8.502">     req.onerror = function() {</span>
<a href="#l8.503"></a><span id="l8.503" class="difflineat">@@ -564,37 +565,36 @@ nsHightail.prototype = {</span>
<a href="#l8.504"></a><span id="l8.504"> </span>
<a href="#l8.505"></a><span id="l8.505">   /**</span>
<a href="#l8.506"></a><span id="l8.506">    * Private function for creating folder on Hightail website.</span>
<a href="#l8.507"></a><span id="l8.507">    *</span>
<a href="#l8.508"></a><span id="l8.508">    * @param aName name of folder</span>
<a href="#l8.509"></a><span id="l8.509">    * @param aParent id of parent folder</span>
<a href="#l8.510"></a><span id="l8.510">    * @param aSuccessCallback called when folder is created</span>
<a href="#l8.511"></a><span id="l8.511">    */</span>
<a href="#l8.512"></a><span id="l8.512" class="difflineminus">-  _createFolder: function(aName, aParent, aSuccessCallback) {</span>
<a href="#l8.513"></a><span id="l8.513" class="difflineplus">+  _createFolder(aName, aParent, aSuccessCallback) {</span>
<a href="#l8.514"></a><span id="l8.514">     this.log.info(&quot;Create folder: &quot; + aName);</span>
<a href="#l8.515"></a><span id="l8.515">     if (Services.io.offline)</span>
<a href="#l8.516"></a><span id="l8.516">       throw Ci.nsIMsgCloudFileProvider.offlineErr;</span>
<a href="#l8.517"></a><span id="l8.517"> </span>
<a href="#l8.518"></a><span id="l8.518">     let args = &quot;?name=&quot; + aName + &quot;&amp;parentId=&quot; + aParent + &quot;&amp;&quot;;</span>
<a href="#l8.519"></a><span id="l8.519"> </span>
<a href="#l8.520"></a><span id="l8.520">     let req = new XMLHttpRequest();</span>
<a href="#l8.521"></a><span id="l8.521"> </span>
<a href="#l8.522"></a><span id="l8.522" class="difflineminus">-    req.open(&quot;POST&quot;, gServerUrl + kFolderPath.replace(/\/$/, '') + args + kUrlTail, true);</span>
<a href="#l8.523"></a><span id="l8.523" class="difflineplus">+    req.open(&quot;POST&quot;, gServerUrl + kFolderPath.replace(/\/$/, &quot;&quot;) + args + kUrlTail, true);</span>
<a href="#l8.524"></a><span id="l8.524"> </span>
<a href="#l8.525"></a><span id="l8.525">     req.onload = function() {</span>
<a href="#l8.526"></a><span id="l8.526">       let docResponse = JSON.parse(req.responseText);</span>
<a href="#l8.527"></a><span id="l8.527">       if (req.status &gt;= 200 &amp;&amp; req.status &lt; 400) {</span>
<a href="#l8.528"></a><span id="l8.528">         this.log.info(&quot;request status = &quot; + req + &quot; response = &quot; +</span>
<a href="#l8.529"></a><span id="l8.529">                       req.responseText);</span>
<a href="#l8.530"></a><span id="l8.530"> </span>
<a href="#l8.531"></a><span id="l8.531">         if (aSuccessCallback)</span>
<a href="#l8.532"></a><span id="l8.532" class="difflineminus">-          aSuccessCallback(docResponse.id)</span>
<a href="#l8.533"></a><span id="l8.533" class="difflineminus">-      }</span>
<a href="#l8.534"></a><span id="l8.534" class="difflineminus">-      else {</span>
<a href="#l8.535"></a><span id="l8.535" class="difflineplus">+          aSuccessCallback(docResponse.id);</span>
<a href="#l8.536"></a><span id="l8.536" class="difflineplus">+      } else {</span>
<a href="#l8.537"></a><span id="l8.537">         this._lastErrorText = docResponse.errorStatus.message;</span>
<a href="#l8.538"></a><span id="l8.538">         this._lastErrorStatus = docResponse.errorStatus.code;</span>
<a href="#l8.539"></a><span id="l8.539">       }</span>
<a href="#l8.540"></a><span id="l8.540">     }.bind(this);</span>
<a href="#l8.541"></a><span id="l8.541"> </span>
<a href="#l8.542"></a><span id="l8.542">     req.onerror = function() {</span>
<a href="#l8.543"></a><span id="l8.543">       this.log.info(&quot;createFolder failed - status = &quot; + req.status);</span>
<a href="#l8.544"></a><span id="l8.544">     }.bind(this);</span>
<a href="#l8.545"></a><span id="l8.545" class="difflineat">@@ -609,17 +609,17 @@ nsHightail.prototype = {</span>
<a href="#l8.546"></a><span id="l8.546"> </span>
<a href="#l8.547"></a><span id="l8.547">   /**</span>
<a href="#l8.548"></a><span id="l8.548">    * If a the user associated with this account key already has an account,</span>
<a href="#l8.549"></a><span id="l8.549">    * allows them to log in.</span>
<a href="#l8.550"></a><span id="l8.550">    *</span>
<a href="#l8.551"></a><span id="l8.551">    * @param aRequestObserver an nsIRequestObserver for monitoring the start and</span>
<a href="#l8.552"></a><span id="l8.552">    *                         stop states of the login procedure.</span>
<a href="#l8.553"></a><span id="l8.553">    */</span>
<a href="#l8.554"></a><span id="l8.554" class="difflineminus">-  createExistingAccount: function(aRequestObserver) {</span>
<a href="#l8.555"></a><span id="l8.555" class="difflineplus">+  createExistingAccount(aRequestObserver) {</span>
<a href="#l8.556"></a><span id="l8.556">      // XXX: replace this with a better function</span>
<a href="#l8.557"></a><span id="l8.557">     let successCb = function(aResponseText, aRequest) {</span>
<a href="#l8.558"></a><span id="l8.558">       aRequestObserver.onStopRequest(null, this, Cr.NS_OK);</span>
<a href="#l8.559"></a><span id="l8.559">     }.bind(this);</span>
<a href="#l8.560"></a><span id="l8.560"> </span>
<a href="#l8.561"></a><span id="l8.561">     let failureCb = function(aResponseText, aRequest) {</span>
<a href="#l8.562"></a><span id="l8.562">       aRequestObserver.onStopRequest(null, this,</span>
<a href="#l8.563"></a><span id="l8.563">                                      Ci.nsIMsgCloudFileProvider.authErr);</span>
<a href="#l8.564"></a><span id="l8.564" class="difflineat">@@ -629,17 +629,17 @@ nsHightail.prototype = {</span>
<a href="#l8.565"></a><span id="l8.565">   },</span>
<a href="#l8.566"></a><span id="l8.566"> </span>
<a href="#l8.567"></a><span id="l8.567">   /**</span>
<a href="#l8.568"></a><span id="l8.568">    * Returns an appropriate provider-specific URL for dealing with a particular</span>
<a href="#l8.569"></a><span id="l8.569">    * error type.</span>
<a href="#l8.570"></a><span id="l8.570">    *</span>
<a href="#l8.571"></a><span id="l8.571">    * @param aError an error to get the URL for.</span>
<a href="#l8.572"></a><span id="l8.572">    */</span>
<a href="#l8.573"></a><span id="l8.573" class="difflineminus">-  providerUrlForError: function(aError) {</span>
<a href="#l8.574"></a><span id="l8.574" class="difflineplus">+  providerUrlForError(aError) {</span>
<a href="#l8.575"></a><span id="l8.575">     if (aError == Ci.nsIMsgCloudFileProvider.uploadExceedsFileLimit)</span>
<a href="#l8.576"></a><span id="l8.576">       return &quot;http://www.hightail.com&quot;;</span>
<a href="#l8.577"></a><span id="l8.577">     return &quot;&quot;;</span>
<a href="#l8.578"></a><span id="l8.578">   },</span>
<a href="#l8.579"></a><span id="l8.579"> </span>
<a href="#l8.580"></a><span id="l8.580">   /**</span>
<a href="#l8.581"></a><span id="l8.581">    * If the provider doesn't have an API for creating an account, perhaps</span>
<a href="#l8.582"></a><span id="l8.582">    * there's a url we can load in a content tab that will allow the user</span>
<a href="#l8.583"></a><span id="l8.583" class="difflineat">@@ -658,17 +658,17 @@ nsHightail.prototype = {</span>
<a href="#l8.584"></a><span id="l8.584"> </span>
<a href="#l8.585"></a><span id="l8.585">   /**</span>
<a href="#l8.586"></a><span id="l8.586">    * Attempts to delete an uploaded file.</span>
<a href="#l8.587"></a><span id="l8.587">    *</span>
<a href="#l8.588"></a><span id="l8.588">    * @param aFile the nsIFile to delete.</span>
<a href="#l8.589"></a><span id="l8.589">    * @param aCallback an nsIRequestObserver for monitoring the start and stop</span>
<a href="#l8.590"></a><span id="l8.590">    *                  states of the delete procedure.</span>
<a href="#l8.591"></a><span id="l8.591">    */</span>
<a href="#l8.592"></a><span id="l8.592" class="difflineminus">-  deleteFile: function(aFile, aCallback) {</span>
<a href="#l8.593"></a><span id="l8.593" class="difflineplus">+  deleteFile(aFile, aCallback) {</span>
<a href="#l8.594"></a><span id="l8.594">     this.log.info(&quot;Deleting a file&quot;);</span>
<a href="#l8.595"></a><span id="l8.595"> </span>
<a href="#l8.596"></a><span id="l8.596">     if (Services.io.offline) {</span>
<a href="#l8.597"></a><span id="l8.597">       this.log.error(&quot;We're offline - we can't delete the file.&quot;);</span>
<a href="#l8.598"></a><span id="l8.598">       throw Ci.nsIMsgCloudFileProvider.offlineErr;</span>
<a href="#l8.599"></a><span id="l8.599">     }</span>
<a href="#l8.600"></a><span id="l8.600"> </span>
<a href="#l8.601"></a><span id="l8.601">     let uploadInfo = this._uploadInfo[aFile.path];</span>
<a href="#l8.602"></a><span id="l8.602" class="difflineat">@@ -706,26 +706,26 @@ nsHightail.prototype = {</span>
<a href="#l8.603"></a><span id="l8.603">           // Our token has gone stale</span>
<a href="#l8.604"></a><span id="l8.604">           let onTokenRefresh = function() {</span>
<a href="#l8.605"></a><span id="l8.605">             this.deleteFile(aFile, aCallback);</span>
<a href="#l8.606"></a><span id="l8.606">           }.bind(this);</span>
<a href="#l8.607"></a><span id="l8.607"> </span>
<a href="#l8.608"></a><span id="l8.608">           let onTokenRefreshFailure = function() {</span>
<a href="#l8.609"></a><span id="l8.609">             aCallback.onStopRequest(null, null,</span>
<a href="#l8.610"></a><span id="l8.610">                                     Ci.nsIMsgCloudFileProvider.authErr);</span>
<a href="#l8.611"></a><span id="l8.611" class="difflineminus">-          }</span>
<a href="#l8.612"></a><span id="l8.612" class="difflineplus">+          };</span>
<a href="#l8.613"></a><span id="l8.613">           this._handleStaleToken(onTokenRefresh, onTokenRefreshFailure);</span>
<a href="#l8.614"></a><span id="l8.614">           return;</span>
<a href="#l8.615"></a><span id="l8.615">         }</span>
<a href="#l8.616"></a><span id="l8.616"> </span>
<a href="#l8.617"></a><span id="l8.617">         this.log.error(&quot;Server has returned a failure on our delete request.&quot;);</span>
<a href="#l8.618"></a><span id="l8.618">         this.log.error(&quot;Error code: &quot; + deleteInfo.errorStatus.code);</span>
<a href="#l8.619"></a><span id="l8.619">         this.log.error(&quot;Error message: &quot; + deleteInfo.errorStatus.message);</span>
<a href="#l8.620"></a><span id="l8.620" class="difflineminus">-        //aCallback.onStopRequest(null, null,</span>
<a href="#l8.621"></a><span id="l8.621" class="difflineminus">-        //                        Ci.nsIMsgCloudFileProvider.uploadErr);</span>
<a href="#l8.622"></a><span id="l8.622" class="difflineplus">+        // aCallback.onStopRequest(null, null,</span>
<a href="#l8.623"></a><span id="l8.623" class="difflineplus">+        //                         Ci.nsIMsgCloudFileProvider.uploadErr);</span>
<a href="#l8.624"></a><span id="l8.624">         return;</span>
<a href="#l8.625"></a><span id="l8.625">       }</span>
<a href="#l8.626"></a><span id="l8.626"> </span>
<a href="#l8.627"></a><span id="l8.627">       this.log.info(&quot;Delete was successful!&quot;);</span>
<a href="#l8.628"></a><span id="l8.628">       // Success!</span>
<a href="#l8.629"></a><span id="l8.629">       aCallback.onStopRequest(null, null, Cr.NS_OK);</span>
<a href="#l8.630"></a><span id="l8.630">     }.bind(this);</span>
<a href="#l8.631"></a><span id="l8.631"> </span>
<a href="#l8.632"></a><span id="l8.632" class="difflineat">@@ -740,17 +740,17 @@ nsHightail.prototype = {</span>
<a href="#l8.633"></a><span id="l8.633">    * Returns the saved password for this account if one exists, or prompts</span>
<a href="#l8.634"></a><span id="l8.634">    * the user for a password. Returns the empty string on failure.</span>
<a href="#l8.635"></a><span id="l8.635">    *</span>
<a href="#l8.636"></a><span id="l8.636">    * @param aUsername the username associated with the account / password.</span>
<a href="#l8.637"></a><span id="l8.637">    * @param aNoPrompt a boolean for whether or not we should suppress</span>
<a href="#l8.638"></a><span id="l8.638">    *                  the password prompt if no password exists.  If so,</span>
<a href="#l8.639"></a><span id="l8.639">    *                  returns the empty string if no password exists.</span>
<a href="#l8.640"></a><span id="l8.640">    */</span>
<a href="#l8.641"></a><span id="l8.641" class="difflineminus">-  getPassword: function(aUsername, aNoPrompt) {</span>
<a href="#l8.642"></a><span id="l8.642" class="difflineplus">+  getPassword(aUsername, aNoPrompt) {</span>
<a href="#l8.643"></a><span id="l8.643">     this.log.info(&quot;Getting password for user: &quot; + aUsername);</span>
<a href="#l8.644"></a><span id="l8.644"> </span>
<a href="#l8.645"></a><span id="l8.645">     if (aNoPrompt)</span>
<a href="#l8.646"></a><span id="l8.646">       this.log.info(&quot;Suppressing password prompt&quot;);</span>
<a href="#l8.647"></a><span id="l8.647"> </span>
<a href="#l8.648"></a><span id="l8.648">     let passwordURI = gServerUrl;</span>
<a href="#l8.649"></a><span id="l8.649">     let logins = Services.logins.findLogins({}, passwordURI, null, passwordURI);</span>
<a href="#l8.650"></a><span id="l8.650">     for (let loginInfo of logins) {</span>
<a href="#l8.651"></a><span id="l8.651" class="difflineat">@@ -763,17 +763,17 @@ nsHightail.prototype = {</span>
<a href="#l8.652"></a><span id="l8.652">     // OK, let's prompt for it.</span>
<a href="#l8.653"></a><span id="l8.653">     let win = Services.wm.getMostRecentWindow(null);</span>
<a href="#l8.654"></a><span id="l8.654"> </span>
<a href="#l8.655"></a><span id="l8.655">     let authPrompter = Services.ww.getNewAuthPrompter(win);</span>
<a href="#l8.656"></a><span id="l8.656">     let password = { value: &quot;&quot; };</span>
<a href="#l8.657"></a><span id="l8.657">     // Use the service name in the prompt text</span>
<a href="#l8.658"></a><span id="l8.658">     let serverUrl = gServerUrl;</span>
<a href="#l8.659"></a><span id="l8.659">     let userPos = gServerUrl.indexOf(&quot;//&quot;) + 2;</span>
<a href="#l8.660"></a><span id="l8.660" class="difflineminus">-    let userNamePart = encodeURIComponent(this._userName) + '@';</span>
<a href="#l8.661"></a><span id="l8.661" class="difflineplus">+    let userNamePart = encodeURIComponent(this._userName) + &quot;@&quot;;</span>
<a href="#l8.662"></a><span id="l8.662">     serverUrl = gServerUrl.substr(0, userPos) + userNamePart + gServerUrl.substr(userPos);</span>
<a href="#l8.663"></a><span id="l8.663">     let messengerBundle = Services.strings.createBundle(</span>
<a href="#l8.664"></a><span id="l8.664">       &quot;chrome://messenger/locale/messenger.properties&quot;);</span>
<a href="#l8.665"></a><span id="l8.665">     let promptString = messengerBundle.formatStringFromName(&quot;passwordPrompt&quot;,</span>
<a href="#l8.666"></a><span id="l8.666">                                                             [this._userName,</span>
<a href="#l8.667"></a><span id="l8.667">                                                              this.displayName],</span>
<a href="#l8.668"></a><span id="l8.668">                                                             2);</span>
<a href="#l8.669"></a><span id="l8.669"> </span>
<a href="#l8.670"></a><span id="l8.670" class="difflineat">@@ -783,32 +783,32 @@ nsHightail.prototype = {</span>
<a href="#l8.671"></a><span id="l8.671">       return password.value;</span>
<a href="#l8.672"></a><span id="l8.672"> </span>
<a href="#l8.673"></a><span id="l8.673">     return &quot;&quot;;</span>
<a href="#l8.674"></a><span id="l8.674">   },</span>
<a href="#l8.675"></a><span id="l8.675"> </span>
<a href="#l8.676"></a><span id="l8.676">   /**</span>
<a href="#l8.677"></a><span id="l8.677">    * Clears any saved Hightail passwords for this instance's account.</span>
<a href="#l8.678"></a><span id="l8.678">    */</span>
<a href="#l8.679"></a><span id="l8.679" class="difflineminus">-  clearPassword: function() {</span>
<a href="#l8.680"></a><span id="l8.680" class="difflineplus">+  clearPassword() {</span>
<a href="#l8.681"></a><span id="l8.681">     let logins = Services.logins.findLogins({}, gServerUrl, null, gServerUrl);</span>
<a href="#l8.682"></a><span id="l8.682">     for (let loginInfo of logins)</span>
<a href="#l8.683"></a><span id="l8.683">       if (loginInfo.username == this._userName)</span>
<a href="#l8.684"></a><span id="l8.684">         Services.logins.removeLogin(loginInfo);</span>
<a href="#l8.685"></a><span id="l8.685">   },</span>
<a href="#l8.686"></a><span id="l8.686"> </span>
<a href="#l8.687"></a><span id="l8.687">   /**</span>
<a href="#l8.688"></a><span id="l8.688">    * Attempt to log on and get the auth token for this Hightail account.</span>
<a href="#l8.689"></a><span id="l8.689">    *</span>
<a href="#l8.690"></a><span id="l8.690">    * @param successCallback the callback to be fired if logging on is successful</span>
<a href="#l8.691"></a><span id="l8.691">    * @param failureCallback the callback to be fired if loggong on fails</span>
<a href="#l8.692"></a><span id="l8.692">    * @aparam aWithUI a boolean for whether or not we should prompt for a password</span>
<a href="#l8.693"></a><span id="l8.693">    *                 if no auth token is currently stored.</span>
<a href="#l8.694"></a><span id="l8.694">    */</span>
<a href="#l8.695"></a><span id="l8.695" class="difflineminus">-  logon: function(successCallback, failureCallback, aWithUI) {</span>
<a href="#l8.696"></a><span id="l8.696" class="difflineplus">+  logon(successCallback, failureCallback, aWithUI) {</span>
<a href="#l8.697"></a><span id="l8.697">     this.log.info(&quot;Logging in, aWithUI = &quot; + aWithUI);</span>
<a href="#l8.698"></a><span id="l8.698">     if (this._password == undefined || !this._password)</span>
<a href="#l8.699"></a><span id="l8.699">       this._password = this.getPassword(this._userName, !aWithUI);</span>
<a href="#l8.700"></a><span id="l8.700">     let args = &quot;?email=&quot; + this._userName + &quot;&amp;password=&quot; + this._password + &quot;&amp;&quot;;</span>
<a href="#l8.701"></a><span id="l8.701">     this.log.info(&quot;Sending login information...&quot;);</span>
<a href="#l8.702"></a><span id="l8.702">     let req = new XMLHttpRequest();</span>
<a href="#l8.703"></a><span id="l8.703">     let curDate = Date.now().toString();</span>
<a href="#l8.704"></a><span id="l8.704"> </span>
<a href="#l8.705"></a><span id="l8.705" class="difflineat">@@ -823,26 +823,24 @@ nsHightail.prototype = {</span>
<a href="#l8.706"></a><span id="l8.706">         this.log.info(&quot;auth token response = &quot; + req.responseText);</span>
<a href="#l8.707"></a><span id="l8.707">         let docResponse = JSON.parse(req.responseText);</span>
<a href="#l8.708"></a><span id="l8.708">         this.log.info(&quot;login response parsed = &quot; + docResponse);</span>
<a href="#l8.709"></a><span id="l8.709">         this._cachedAuthToken = docResponse.authToken;</span>
<a href="#l8.710"></a><span id="l8.710">         this.log.info(&quot;authToken = &quot; + this._cachedAuthToken);</span>
<a href="#l8.711"></a><span id="l8.711">         if (this._cachedAuthToken) {</span>
<a href="#l8.712"></a><span id="l8.712">           this._loggedIn = true;</span>
<a href="#l8.713"></a><span id="l8.713">           successCallback();</span>
<a href="#l8.714"></a><span id="l8.714" class="difflineminus">-        }</span>
<a href="#l8.715"></a><span id="l8.715" class="difflineminus">-        else {</span>
<a href="#l8.716"></a><span id="l8.716" class="difflineplus">+        } else {</span>
<a href="#l8.717"></a><span id="l8.717">           this.clearPassword();</span>
<a href="#l8.718"></a><span id="l8.718">           this._loggedIn = false;</span>
<a href="#l8.719"></a><span id="l8.719">           this._lastErrorText = docResponse.errorStatus.message;</span>
<a href="#l8.720"></a><span id="l8.720">           this._lastErrorStatus = docResponse.errorStatus.code;</span>
<a href="#l8.721"></a><span id="l8.721">           failureCallback();</span>
<a href="#l8.722"></a><span id="l8.722">         }</span>
<a href="#l8.723"></a><span id="l8.723" class="difflineminus">-      }</span>
<a href="#l8.724"></a><span id="l8.724" class="difflineminus">-      else {</span>
<a href="#l8.725"></a><span id="l8.725" class="difflineplus">+      } else {</span>
<a href="#l8.726"></a><span id="l8.726">         this.clearPassword();</span>
<a href="#l8.727"></a><span id="l8.727">         failureCallback();</span>
<a href="#l8.728"></a><span id="l8.728">       }</span>
<a href="#l8.729"></a><span id="l8.729">     }.bind(this);</span>
<a href="#l8.730"></a><span id="l8.730">     req.setRequestHeader(&quot;X-Api-Key&quot;, kApiKey);</span>
<a href="#l8.731"></a><span id="l8.731">     req.setRequestHeader(&quot;Date&quot;, curDate);</span>
<a href="#l8.732"></a><span id="l8.732">     req.setRequestHeader(&quot;Accept&quot;, &quot;application/json&quot;);</span>
<a href="#l8.733"></a><span id="l8.733">     req.send();</span>
<a href="#l8.734"></a><span id="l8.734" class="difflineat">@@ -874,27 +872,25 @@ function nsHightailFileUploader(aHightai</span>
<a href="#l8.735"></a><span id="l8.735">   this.log = this.hightail.log;</span>
<a href="#l8.736"></a><span id="l8.736">   this.log.info(&quot;new nsHightailFileUploader file = &quot; + aFile.leafName);</span>
<a href="#l8.737"></a><span id="l8.737">   this.file = aFile;</span>
<a href="#l8.738"></a><span id="l8.738">   this.callback = aCallback;</span>
<a href="#l8.739"></a><span id="l8.739">   this.requestObserver = aRequestObserver;</span>
<a href="#l8.740"></a><span id="l8.740"> }</span>
<a href="#l8.741"></a><span id="l8.741"> </span>
<a href="#l8.742"></a><span id="l8.742"> nsHightailFileUploader.prototype = {</span>
<a href="#l8.743"></a><span id="l8.743" class="difflineminus">-  hightail : null,</span>
<a href="#l8.744"></a><span id="l8.744" class="difflineminus">-  file : null,</span>
<a href="#l8.745"></a><span id="l8.745" class="difflineminus">-  callback : null,</span>
<a href="#l8.746"></a><span id="l8.746" class="difflineminus">-  _request : null,</span>
<a href="#l8.747"></a><span id="l8.747" class="difflineplus">+  hightail: null,</span>
<a href="#l8.748"></a><span id="l8.748" class="difflineplus">+  file: null,</span>
<a href="#l8.749"></a><span id="l8.749" class="difflineplus">+  callback: null,</span>
<a href="#l8.750"></a><span id="l8.750" class="difflineplus">+  _request: null,</span>
<a href="#l8.751"></a><span id="l8.751"> </span>
<a href="#l8.752"></a><span id="l8.752">   /**</span>
<a href="#l8.753"></a><span id="l8.753">    * Kicks off the upload procedure for this uploader.</span>
<a href="#l8.754"></a><span id="l8.754">    */</span>
<a href="#l8.755"></a><span id="l8.755" class="difflineminus">-  startUpload: function() {</span>
<a href="#l8.756"></a><span id="l8.756" class="difflineminus">-    let curDate = Date.now().toString();</span>
<a href="#l8.757"></a><span id="l8.757" class="difflineminus">-</span>
<a href="#l8.758"></a><span id="l8.758" class="difflineplus">+  startUpload() {</span>
<a href="#l8.759"></a><span id="l8.759">     this.requestObserver.onStartRequest(null, null);</span>
<a href="#l8.760"></a><span id="l8.760"> </span>
<a href="#l8.761"></a><span id="l8.761">     let onSuccess = function() {</span>
<a href="#l8.762"></a><span id="l8.762">       this._uploadFile();</span>
<a href="#l8.763"></a><span id="l8.763">     }.bind(this);</span>
<a href="#l8.764"></a><span id="l8.764"> </span>
<a href="#l8.765"></a><span id="l8.765">     let onFailure = function() {</span>
<a href="#l8.766"></a><span id="l8.766">       this.callback(this.requestObserver, Ci.nsIMsgCloudFileProvider.uploadErr);</span>
<a href="#l8.767"></a><span id="l8.767" class="difflineat">@@ -905,34 +901,33 @@ nsHightailFileUploader.prototype = {</span>
<a href="#l8.768"></a><span id="l8.768"> </span>
<a href="#l8.769"></a><span id="l8.769">   /**</span>
<a href="#l8.770"></a><span id="l8.770">    * Communicates with Hightail to get the URL that we will send the upload</span>
<a href="#l8.771"></a><span id="l8.771">    * request to.</span>
<a href="#l8.772"></a><span id="l8.772">    *</span>
<a href="#l8.773"></a><span id="l8.773">    * @param successCallback the callback fired if getting the URL is successful</span>
<a href="#l8.774"></a><span id="l8.774">    * @param failureCallback the callback fired if getting the URL fails</span>
<a href="#l8.775"></a><span id="l8.775">    */</span>
<a href="#l8.776"></a><span id="l8.776" class="difflineminus">-  _prepareToSend: function(successCallback, failureCallback) {</span>
<a href="#l8.777"></a><span id="l8.777" class="difflineplus">+  _prepareToSend(successCallback, failureCallback) {</span>
<a href="#l8.778"></a><span id="l8.778">     let req = new XMLHttpRequest();</span>
<a href="#l8.779"></a><span id="l8.779"> </span>
<a href="#l8.780"></a><span id="l8.780">     req.open(&quot;POST&quot;, gServerUrl + kFolderInitUploadPath + &quot;?&quot; + kUrlTail, true);</span>
<a href="#l8.781"></a><span id="l8.781"> </span>
<a href="#l8.782"></a><span id="l8.782">     req.onerror = failureCallback;</span>
<a href="#l8.783"></a><span id="l8.783"> </span>
<a href="#l8.784"></a><span id="l8.784">     req.onload = function() {</span>
<a href="#l8.785"></a><span id="l8.785">       let response = req.responseText;</span>
<a href="#l8.786"></a><span id="l8.786">       if (req.status &gt;= 200 &amp;&amp; req.status &lt; 400) {</span>
<a href="#l8.787"></a><span id="l8.787">         this._urlInfo = JSON.parse(response);</span>
<a href="#l8.788"></a><span id="l8.788">         this.hightail._uploadInfo[this.file.path] = this._urlInfo;</span>
<a href="#l8.789"></a><span id="l8.789">         this.log.info(&quot;in prepare to send response = &quot; + response);</span>
<a href="#l8.790"></a><span id="l8.790">         this.log.info(&quot;file id = &quot; + this._urlInfo.fileId);</span>
<a href="#l8.791"></a><span id="l8.791">         this.log.info(&quot;upload url = &quot; + this._urlInfo.uploadUrl[0]);</span>
<a href="#l8.792"></a><span id="l8.792">         successCallback();</span>
<a href="#l8.793"></a><span id="l8.793" class="difflineminus">-      }</span>
<a href="#l8.794"></a><span id="l8.794" class="difflineminus">-      else {</span>
<a href="#l8.795"></a><span id="l8.795" class="difflineplus">+      } else {</span>
<a href="#l8.796"></a><span id="l8.796">         this.log.error(&quot;Preparing to send failed!&quot;);</span>
<a href="#l8.797"></a><span id="l8.797">         this.log.error(&quot;Response was: &quot; + response);</span>
<a href="#l8.798"></a><span id="l8.798">         this.hightail._lastErrorText = req.responseText;</span>
<a href="#l8.799"></a><span id="l8.799">         this.hightail._lastErrorStatus = req.status;</span>
<a href="#l8.800"></a><span id="l8.800">         failureCallback();</span>
<a href="#l8.801"></a><span id="l8.801">       }</span>
<a href="#l8.802"></a><span id="l8.802">     }.bind(this);</span>
<a href="#l8.803"></a><span id="l8.803"> </span>
<a href="#l8.804"></a><span id="l8.804" class="difflineat">@@ -945,48 +940,48 @@ nsHightailFileUploader.prototype = {</span>
<a href="#l8.805"></a><span id="l8.805">     req.setRequestHeader(&quot;Content-Type&quot;, &quot;application/x-www-form-urlencoded&quot;);</span>
<a href="#l8.806"></a><span id="l8.806">     req.send();</span>
<a href="#l8.807"></a><span id="l8.807">   },</span>
<a href="#l8.808"></a><span id="l8.808"> </span>
<a href="#l8.809"></a><span id="l8.809">   /**</span>
<a href="#l8.810"></a><span id="l8.810">    * Once we've got the URL to upload the file to, this function actually does</span>
<a href="#l8.811"></a><span id="l8.811">    * the upload of the file to Hightail.</span>
<a href="#l8.812"></a><span id="l8.812">    */</span>
<a href="#l8.813"></a><span id="l8.813" class="difflineminus">-  _uploadFile: function() {</span>
<a href="#l8.814"></a><span id="l8.814" class="difflineplus">+  _uploadFile() {</span>
<a href="#l8.815"></a><span id="l8.815">     let req = new XMLHttpRequest();</span>
<a href="#l8.816"></a><span id="l8.816"> </span>
<a href="#l8.817"></a><span id="l8.817">     let curDate = Date.now().toString();</span>
<a href="#l8.818"></a><span id="l8.818">     this.log.info(&quot;upload url = &quot; + this._urlInfo.uploadUrl[0]);</span>
<a href="#l8.819"></a><span id="l8.819">     this.request = req;</span>
<a href="#l8.820"></a><span id="l8.820">     req.open(&quot;POST&quot;, this._urlInfo.uploadUrl[0] + &quot;?&quot; + kUrlTail, true);</span>
<a href="#l8.821"></a><span id="l8.821">     req.onload = function() {</span>
<a href="#l8.822"></a><span id="l8.822">       this.cleanupTempFile();</span>
<a href="#l8.823"></a><span id="l8.823">       if (req.status &gt;= 200 &amp;&amp; req.status &lt; 400) {</span>
<a href="#l8.824"></a><span id="l8.824">         try {</span>
<a href="#l8.825"></a><span id="l8.825">           this.log.info(&quot;upload response = &quot; + req.responseText);</span>
<a href="#l8.826"></a><span id="l8.826">           this._commitSend();</span>
<a href="#l8.827"></a><span id="l8.827">         } catch (ex) {</span>
<a href="#l8.828"></a><span id="l8.828">           this.log.error(ex);</span>
<a href="#l8.829"></a><span id="l8.829">         }</span>
<a href="#l8.830"></a><span id="l8.830" class="difflineminus">-      }</span>
<a href="#l8.831"></a><span id="l8.831" class="difflineminus">-      else</span>
<a href="#l8.832"></a><span id="l8.832" class="difflineplus">+      } else {</span>
<a href="#l8.833"></a><span id="l8.833">         this.callback(this.requestObserver,</span>
<a href="#l8.834"></a><span id="l8.834">                       Ci.nsIMsgCloudFileProvider.uploadErr);</span>
<a href="#l8.835"></a><span id="l8.835" class="difflineplus">+      }</span>
<a href="#l8.836"></a><span id="l8.836">     }.bind(this);</span>
<a href="#l8.837"></a><span id="l8.837"> </span>
<a href="#l8.838"></a><span id="l8.838" class="difflineminus">-    req.onerror = function () {</span>
<a href="#l8.839"></a><span id="l8.839" class="difflineplus">+    req.onerror = function() {</span>
<a href="#l8.840"></a><span id="l8.840">       this.cleanupTempFile();</span>
<a href="#l8.841"></a><span id="l8.841">       if (this.callback)</span>
<a href="#l8.842"></a><span id="l8.842">         this.callback(this.requestObserver,</span>
<a href="#l8.843"></a><span id="l8.843">                       Ci.nsIMsgCloudFileProvider.uploadErr);</span>
<a href="#l8.844"></a><span id="l8.844">     }.bind(this);</span>
<a href="#l8.845"></a><span id="l8.845"> </span>
<a href="#l8.846"></a><span id="l8.846">     req.setRequestHeader(&quot;Date&quot;, curDate);</span>
<a href="#l8.847"></a><span id="l8.847">     let boundary = &quot;------&quot; + curDate;</span>
<a href="#l8.848"></a><span id="l8.848" class="difflineminus">-    let contentType = &quot;multipart/form-data; boundary=&quot;+ boundary;</span>
<a href="#l8.849"></a><span id="l8.849" class="difflineplus">+    let contentType = &quot;multipart/form-data; boundary=&quot; + boundary;</span>
<a href="#l8.850"></a><span id="l8.850">     req.setRequestHeader(&quot;Content-Type&quot;, contentType);</span>
<a href="#l8.851"></a><span id="l8.851"> </span>
<a href="#l8.852"></a><span id="l8.852">     let fileContents = &quot;--&quot; + boundary +</span>
<a href="#l8.853"></a><span id="l8.853">       &quot;\r\nContent-Disposition: form-data; name=\&quot;bid\&quot;\r\n\r\n&quot; +</span>
<a href="#l8.854"></a><span id="l8.854">        this._urlInfo.fileId;</span>
<a href="#l8.855"></a><span id="l8.855"> </span>
<a href="#l8.856"></a><span id="l8.856">     let fileName = /^[\040-\176]+$/.test(this.file.leafName)</span>
<a href="#l8.857"></a><span id="l8.857">         ? this.file.leafName</span>
<a href="#l8.858"></a><span id="l8.858" class="difflineat">@@ -1049,17 +1044,17 @@ nsHightailFileUploader.prototype = {</span>
<a href="#l8.859"></a><span id="l8.859">       this.log.error(ex);</span>
<a href="#l8.860"></a><span id="l8.860">       throw ex;</span>
<a href="#l8.861"></a><span id="l8.861">     }</span>
<a href="#l8.862"></a><span id="l8.862">   },</span>
<a href="#l8.863"></a><span id="l8.863"> </span>
<a href="#l8.864"></a><span id="l8.864">   /**</span>
<a href="#l8.865"></a><span id="l8.865">    * Cancels the upload request for the file associated with this Uploader.</span>
<a href="#l8.866"></a><span id="l8.866">    */</span>
<a href="#l8.867"></a><span id="l8.867" class="difflineminus">-  cancel: function() {</span>
<a href="#l8.868"></a><span id="l8.868" class="difflineplus">+  cancel() {</span>
<a href="#l8.869"></a><span id="l8.869">     this.log.info(&quot;in uploader cancel&quot;);</span>
<a href="#l8.870"></a><span id="l8.870">     this.callback(this.requestObserver, Ci.nsIMsgCloudFileProvider.uploadCanceled);</span>
<a href="#l8.871"></a><span id="l8.871">     delete this.callback;</span>
<a href="#l8.872"></a><span id="l8.872">     if (this.request) {</span>
<a href="#l8.873"></a><span id="l8.873">       this.log.info(&quot;cancelling upload request&quot;);</span>
<a href="#l8.874"></a><span id="l8.874">       let req = this.request;</span>
<a href="#l8.875"></a><span id="l8.875">       if (req.channel) {</span>
<a href="#l8.876"></a><span id="l8.876">         this.log.info(&quot;cancelling upload channel&quot;);</span>
<a href="#l8.877"></a><span id="l8.877" class="difflineat">@@ -1067,17 +1062,17 @@ nsHightailFileUploader.prototype = {</span>
<a href="#l8.878"></a><span id="l8.878">       }</span>
<a href="#l8.879"></a><span id="l8.879">       this.request = null;</span>
<a href="#l8.880"></a><span id="l8.880">     }</span>
<a href="#l8.881"></a><span id="l8.881">   },</span>
<a href="#l8.882"></a><span id="l8.882">   /**</span>
<a href="#l8.883"></a><span id="l8.883">    * Once the file is uploaded, if we want to get a sharing URL back, we have</span>
<a href="#l8.884"></a><span id="l8.884">    * to send a &quot;commit&quot; request - which this function does.</span>
<a href="#l8.885"></a><span id="l8.885">    */</span>
<a href="#l8.886"></a><span id="l8.886" class="difflineminus">-  _commitSend: function() {</span>
<a href="#l8.887"></a><span id="l8.887" class="difflineplus">+  _commitSend() {</span>
<a href="#l8.888"></a><span id="l8.888">     this.log.info(&quot;commit sending file &quot; + this._urlInfo.fileId);</span>
<a href="#l8.889"></a><span id="l8.889">     let req = new XMLHttpRequest();</span>
<a href="#l8.890"></a><span id="l8.890">     let args = &quot;?name=&quot; + this.file.leafName +</span>
<a href="#l8.891"></a><span id="l8.891">                &quot;&amp;fileId=&quot; + this._urlInfo.fileId +</span>
<a href="#l8.892"></a><span id="l8.892">                &quot;&amp;parentId=&quot; + this.hightail._folderId + &quot;&amp;&quot;;</span>
<a href="#l8.893"></a><span id="l8.893"> </span>
<a href="#l8.894"></a><span id="l8.894">     req.open(&quot;POST&quot;, gServerUrl + kFolderCommitUploadPath + args + kUrlTail, true);</span>
<a href="#l8.895"></a><span id="l8.895"> </span>
<a href="#l8.896"></a><span id="l8.896" class="difflineat">@@ -1102,60 +1097,59 @@ nsHightailFileUploader.prototype = {</span>
<a href="#l8.897"></a><span id="l8.897">                       ? Ci.nsIMsgCloudFileProvider.uploadExceedsFileNameLimit</span>
<a href="#l8.898"></a><span id="l8.898">                       : Ci.nsIMsgCloudFileProvider.uploadErr);</span>
<a href="#l8.899"></a><span id="l8.899">       }.bind(this);</span>
<a href="#l8.900"></a><span id="l8.900"> </span>
<a href="#l8.901"></a><span id="l8.901">       if (uploadInfo.errorStatus) {</span>
<a href="#l8.902"></a><span id="l8.902">         this.hightail._lastErrorText = uploadInfo.errorStatus.message;</span>
<a href="#l8.903"></a><span id="l8.903">         this.hightail._lastErrorStatus = uploadInfo.errorStatus.code;</span>
<a href="#l8.904"></a><span id="l8.904">         failed();</span>
<a href="#l8.905"></a><span id="l8.905" class="difflineminus">-      }</span>
<a href="#l8.906"></a><span id="l8.906" class="difflineminus">-      else if (uploadInfo.clickableDownloadUrl) {</span>
<a href="#l8.907"></a><span id="l8.907" class="difflineplus">+      } else if (uploadInfo.clickableDownloadUrl) {</span>
<a href="#l8.908"></a><span id="l8.908">         // We need a kludge here because Hightail is returning URLs without the scheme...</span>
<a href="#l8.909"></a><span id="l8.909">         let url = this._ensureScheme(uploadInfo.clickableDownloadUrl);</span>
<a href="#l8.910"></a><span id="l8.910">         this.hightail._urlsForFiles[this.file.path] = url;</span>
<a href="#l8.911"></a><span id="l8.911">         succeed();</span>
<a href="#l8.912"></a><span id="l8.912" class="difflineplus">+      } else {</span>
<a href="#l8.913"></a><span id="l8.913" class="difflineplus">+        this._findDownloadUrl(uploadInfo.id, succeed, failed);</span>
<a href="#l8.914"></a><span id="l8.914">       }</span>
<a href="#l8.915"></a><span id="l8.915" class="difflineminus">-      else</span>
<a href="#l8.916"></a><span id="l8.916" class="difflineminus">-        this._findDownloadUrl(uploadInfo.id, succeed, failed);</span>
<a href="#l8.917"></a><span id="l8.917">     }.bind(this);</span>
<a href="#l8.918"></a><span id="l8.918"> </span>
<a href="#l8.919"></a><span id="l8.919">     req.setRequestHeader(&quot;X-Auth-Token&quot;, this.hightail._cachedAuthToken + &quot; &quot;);</span>
<a href="#l8.920"></a><span id="l8.920">     req.setRequestHeader(&quot;X-Api-Key&quot;, kApiKey);</span>
<a href="#l8.921"></a><span id="l8.921">     req.setRequestHeader(&quot;Accept&quot;, &quot;application/json&quot;);</span>
<a href="#l8.922"></a><span id="l8.922">     req.send();</span>
<a href="#l8.923"></a><span id="l8.923">   },</span>
<a href="#l8.924"></a><span id="l8.924"> </span>
<a href="#l8.925"></a><span id="l8.925">   /**</span>
<a href="#l8.926"></a><span id="l8.926">    * If there's no scheme prefix for a URL, attaches an https:// prefix</span>
<a href="#l8.927"></a><span id="l8.927">    * and returns the new result.</span>
<a href="#l8.928"></a><span id="l8.928">    *</span>
<a href="#l8.929"></a><span id="l8.929">    * @param aURL to ensure a scheme with</span>
<a href="#l8.930"></a><span id="l8.930">    */</span>
<a href="#l8.931"></a><span id="l8.931" class="difflineminus">-  _ensureScheme: function(aURL) {</span>
<a href="#l8.932"></a><span id="l8.932" class="difflineplus">+  _ensureScheme(aURL) {</span>
<a href="#l8.933"></a><span id="l8.933">     try {</span>
<a href="#l8.934"></a><span id="l8.934" class="difflineminus">-      let scheme = Services.io.extractScheme(aURL);</span>
<a href="#l8.935"></a><span id="l8.935" class="difflineplus">+      Services.io.extractScheme(aURL);</span>
<a href="#l8.936"></a><span id="l8.936">       return aURL;</span>
<a href="#l8.937"></a><span id="l8.937" class="difflineminus">-    } catch(e) {</span>
<a href="#l8.938"></a><span id="l8.938" class="difflineplus">+    } catch (e) {</span>
<a href="#l8.939"></a><span id="l8.939">       // If we got NS_ERROR_MALFORMED_URI back, there's no scheme here.</span>
<a href="#l8.940"></a><span id="l8.940">       if (e.result == Cr.NS_ERROR_MALFORMED_URI)</span>
<a href="#l8.941"></a><span id="l8.941">         return &quot;https://&quot; + aURL;</span>
<a href="#l8.942"></a><span id="l8.942">       // Otherwise, we hit something different, and should throw.</span>
<a href="#l8.943"></a><span id="l8.943">       throw e;</span>
<a href="#l8.944"></a><span id="l8.944">     }</span>
<a href="#l8.945"></a><span id="l8.945">   },</span>
<a href="#l8.946"></a><span id="l8.946"> </span>
<a href="#l8.947"></a><span id="l8.947">   /**</span>
<a href="#l8.948"></a><span id="l8.948">    * Attempt to find download url for file.</span>
<a href="#l8.949"></a><span id="l8.949">    *</span>
<a href="#l8.950"></a><span id="l8.950">    * @param aFileId id of file</span>
<a href="#l8.951"></a><span id="l8.951">    * @param aSuccessCallback called if url is found</span>
<a href="#l8.952"></a><span id="l8.952">    * @param aFailureCallback called if url is not found</span>
<a href="#l8.953"></a><span id="l8.953">    */</span>
<a href="#l8.954"></a><span id="l8.954" class="difflineminus">-  _findDownloadUrl: function(aFileId, aSuccessCallback, aFailureCallback) {</span>
<a href="#l8.955"></a><span id="l8.955" class="difflineplus">+  _findDownloadUrl(aFileId, aSuccessCallback, aFailureCallback) {</span>
<a href="#l8.956"></a><span id="l8.956">     let req = new XMLHttpRequest();</span>
<a href="#l8.957"></a><span id="l8.957"> </span>
<a href="#l8.958"></a><span id="l8.958">     req.open(&quot;GET&quot;, gServerUrl + kFolderFilePath + aFileId, true);</span>
<a href="#l8.959"></a><span id="l8.959"> </span>
<a href="#l8.960"></a><span id="l8.960">     req.onerror = function() {</span>
<a href="#l8.961"></a><span id="l8.961">       this.log.info(&quot;error in findDownloadUrl&quot;);</span>
<a href="#l8.962"></a><span id="l8.962">       aFailureCallback();</span>
<a href="#l8.963"></a><span id="l8.963">     }.bind(this);</span>
<a href="#l8.964"></a><span id="l8.964" class="difflineat">@@ -1179,29 +1173,29 @@ nsHightailFileUploader.prototype = {</span>
<a href="#l8.965"></a><span id="l8.965">     req.setRequestHeader(&quot;X-Api-Key&quot;, kApiKey);</span>
<a href="#l8.966"></a><span id="l8.966">     req.setRequestHeader(&quot;Accept&quot;, &quot;application/json&quot;);</span>
<a href="#l8.967"></a><span id="l8.967">     req.send();</span>
<a href="#l8.968"></a><span id="l8.968">   },</span>
<a href="#l8.969"></a><span id="l8.969"> </span>
<a href="#l8.970"></a><span id="l8.970">   /**</span>
<a href="#l8.971"></a><span id="l8.971">    * Creates and returns a temporary file on the local file system.</span>
<a href="#l8.972"></a><span id="l8.972">    */</span>
<a href="#l8.973"></a><span id="l8.973" class="difflineminus">-  getTempFile: function(leafName) {</span>
<a href="#l8.974"></a><span id="l8.974" class="difflineplus">+  getTempFile(leafName) {</span>
<a href="#l8.975"></a><span id="l8.975">     let tempfile = Services.dirsvc.get(&quot;TmpD&quot;, Ci.nsIFile);</span>
<a href="#l8.976"></a><span id="l8.976" class="difflineminus">-    tempfile.append(leafName)</span>
<a href="#l8.977"></a><span id="l8.977" class="difflineplus">+    tempfile.append(leafName);</span>
<a href="#l8.978"></a><span id="l8.978">     tempfile.createUnique(Ci.nsIFile.NORMAL_FILE_TYPE, parseInt(&quot;0666&quot;, 8));</span>
<a href="#l8.979"></a><span id="l8.979">     // do whatever you need to the created file</span>
<a href="#l8.980"></a><span id="l8.980" class="difflineminus">-    return tempfile.clone()</span>
<a href="#l8.981"></a><span id="l8.981" class="difflineplus">+    return tempfile.clone();</span>
<a href="#l8.982"></a><span id="l8.982">   },</span>
<a href="#l8.983"></a><span id="l8.983"> </span>
<a href="#l8.984"></a><span id="l8.984">   /**</span>
<a href="#l8.985"></a><span id="l8.985">    * Cleans up any temporary files that this nsHightailFileUploader may have</span>
<a href="#l8.986"></a><span id="l8.986">    * created.</span>
<a href="#l8.987"></a><span id="l8.987">    */</span>
<a href="#l8.988"></a><span id="l8.988" class="difflineminus">-  cleanupTempFile: function() {</span>
<a href="#l8.989"></a><span id="l8.989" class="difflineplus">+  cleanupTempFile() {</span>
<a href="#l8.990"></a><span id="l8.990">     if (this._bufStream)</span>
<a href="#l8.991"></a><span id="l8.991">       this._bufStream.close();</span>
<a href="#l8.992"></a><span id="l8.992">     if (this._fstream)</span>
<a href="#l8.993"></a><span id="l8.993">       this._fstream.close();</span>
<a href="#l8.994"></a><span id="l8.994">     if (this._tempFile)</span>
<a href="#l8.995"></a><span id="l8.995">       this._tempFile.remove(false);</span>
<a href="#l8.996"></a><span id="l8.996">   },</span>
<a href="#l8.997"></a><span id="l8.997"> };</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

