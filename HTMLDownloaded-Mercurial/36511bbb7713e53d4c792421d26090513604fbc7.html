<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 26552:36511bbb7713e53d4c792421d26090513604fbc7</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 36511bbb7713e53d4c792421d26090513604fbc7" />
<meta property="og:url" content="/comm-central/rev/36511bbb7713e53d4c792421d26090513604fbc7" />
<meta property="og:description" content="Bug 971347 - Also fetch ISP configuration using SSL. r=BenB" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 36511bbb7713e53d4c792421d26090513604fbc7 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/36511bbb7713e53d4c792421d26090513604fbc7">shortlog</a> |
<a href="/comm-central/log/36511bbb7713e53d4c792421d26090513604fbc7">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/36511bbb7713e53d4c792421d26090513604fbc7">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/36511bbb7713e53d4c792421d26090513604fbc7">files</a> |
changeset |
<a href="/comm-central/raw-rev/36511bbb7713e53d4c792421d26090513604fbc7">raw</a>  | <a href="/comm-central/archive/36511bbb7713e53d4c792421d26090513604fbc7.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=971347">Bug 971347</a> - Also fetch ISP configuration using SSL. r=BenB
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#97;&#110;&#111;&#110;&#121;&#109;&#32;&#60;&#97;&#110;&#111;&#110;&#121;&#109;&#64;&#114;&#105;&#115;&#101;&#117;&#112;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 09 May 2019 00:25:39 +0200</td></tr>

<tr>
 <td>changeset 26552</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/36511bbb7713e53d4c792421d26090513604fbc7">36511bbb7713e53d4c792421d26090513604fbc7</a></td>
</tr>



<tr>
<td>parent 26551</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/0ab50c564778864a7ca57582195a75e5d9700695">0ab50c564778864a7ca57582195a75e5d9700695</a>
</td>
</tr>

<tr>
<td>child 26553</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/8d425742466967aa0e90945d2f9d386dabb53fcc">8d425742466967aa0e90945d2f9d386dabb53fcc</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=36511bbb7713e53d4c792421d26090513604fbc7">15889</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Wed, 08 May 2019 22:55:04 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@8d4257424669 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=8d425742466967aa0e90945d2f9d386dabb53fcc">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=8d425742466967aa0e90945d2f9d386dabb53fcc&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=8d425742466967aa0e90945d2f9d386dabb53fcc&newProject=comm-central&newRevision=83bbcac4d9a6d8b877cc97821c1f3410badf6417&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=8d425742466967aa0e90945d2f9d386dabb53fcc&newProject=comm-central&newRevision=83bbcac4d9a6d8b877cc97821c1f3410badf6417&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=8d425742466967aa0e90945d2f9d386dabb53fcc&newProject=comm-central&newRevision=83bbcac4d9a6d8b877cc97821c1f3410badf6417&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28BenB%29&revcount=50">BenB</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=971347">971347</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=971347">Bug 971347</a> - Also fetch ISP configuration using SSL. r=BenB
Now we support ISPs who only serve .well-known over SSL.

This slightly increases defenses against passive attackers (who could
snoop your username [0]), but for active attackers the &quot;downgrade&quot;
attack that forces plaintext is trivial: just block all SSL traffic
and then manipulate the HTTP traffic. In other words, a
Man-in-the-middle can easily get full control over the client
configuration.

It would be reasonable to only do SSL by default, but it is not an
option in certain enterprise deployments, so instead we allow
security-focused distributions (and extensions like TorBirdy) to
control the behavior via a new boolean pref:

mailnews.auto_config.fetchFromISP.sslOnly

When set to true ISP fetches are done using SSL only, but it defaults
to false which allows insecure fetches as well.

[0] See the mailnews.auto_config.fetchFromISP.sendEmailAddress pref.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/36511bbb7713e53d4c792421d26090513604fbc7/mail/components/accountcreation/content/fetchConfig.js">mail/components/accountcreation/content/fetchConfig.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/36511bbb7713e53d4c792421d26090513604fbc7/mail/components/accountcreation/content/fetchConfig.js">file</a> |
<a href="/comm-central/annotate/36511bbb7713e53d4c792421d26090513604fbc7/mail/components/accountcreation/content/fetchConfig.js">annotate</a> |
<a href="/comm-central/diff/36511bbb7713e53d4c792421d26090513604fbc7/mail/components/accountcreation/content/fetchConfig.js">diff</a> |
<a href="/comm-central/comparison/36511bbb7713e53d4c792421d26090513604fbc7/mail/components/accountcreation/content/fetchConfig.js">comparison</a> |
<a href="/comm-central/log/36511bbb7713e53d4c792421d26090513604fbc7/mail/components/accountcreation/content/fetchConfig.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/36511bbb7713e53d4c792421d26090513604fbc7/mailnews/mailnews.js">mailnews/mailnews.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/36511bbb7713e53d4c792421d26090513604fbc7/mailnews/mailnews.js">file</a> |
<a href="/comm-central/annotate/36511bbb7713e53d4c792421d26090513604fbc7/mailnews/mailnews.js">annotate</a> |
<a href="/comm-central/diff/36511bbb7713e53d4c792421d26090513604fbc7/mailnews/mailnews.js">diff</a> |
<a href="/comm-central/comparison/36511bbb7713e53d4c792421d26090513604fbc7/mailnews/mailnews.js">comparison</a> |
<a href="/comm-central/log/36511bbb7713e53d4c792421d26090513604fbc7/mailnews/mailnews.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/components/accountcreation/content/fetchConfig.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/components/accountcreation/content/fetchConfig.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -58,48 +58,48 @@ function fetchConfigFromDisk(domain, suc</span>
<a href="#l1.4"></a><span id="l1.4"> function fetchConfigFromISP(domain, emailAddress, successCallback,</span>
<a href="#l1.5"></a><span id="l1.5">                             errorCallback) {</span>
<a href="#l1.6"></a><span id="l1.6">   if (!Services.prefs.getBoolPref(</span>
<a href="#l1.7"></a><span id="l1.7">       &quot;mailnews.auto_config.fetchFromISP.enabled&quot;)) {</span>
<a href="#l1.8"></a><span id="l1.8">     errorCallback(new Exception(&quot;ISP fetch disabled per user preference&quot;));</span>
<a href="#l1.9"></a><span id="l1.9">     return new Abortable();</span>
<a href="#l1.10"></a><span id="l1.10">   }</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-  let url1 = &quot;http://autoconfig.&quot; + sanitize.hostname(domain) +</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-             &quot;/mail/config-v1.1.xml&quot;;</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+  let conf1 = &quot;autoconfig.&quot; + sanitize.hostname(domain) +</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+              &quot;/mail/config-v1.1.xml&quot;;</span>
<a href="#l1.16"></a><span id="l1.16">   // .well-known/ &lt;http://tools.ietf.org/html/draft-nottingham-site-meta-04&gt;</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-  let url2 = &quot;http://&quot; + sanitize.hostname(domain) +</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">-             &quot;/.well-known/autoconfig/mail/config-v1.1.xml&quot;;</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+  let conf2 = sanitize.hostname(domain) +</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+              &quot;/.well-known/autoconfig/mail/config-v1.1.xml&quot;;</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+  // This list is sorted by decreasing priority</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+  var urls = [&quot;https://&quot; + conf1, &quot;https://&quot; + conf2];</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+  if (!Services.prefs.getBoolPref(&quot;mailnews.auto_config.fetchFromISP.sslOnly&quot;)) {</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+    urls.push(&quot;http://&quot; + conf1, &quot;http://&quot; + conf2);</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+  }</span>
<a href="#l1.26"></a><span id="l1.26">   let callArgs = {</span>
<a href="#l1.27"></a><span id="l1.27">     urlArgs: {</span>
<a href="#l1.28"></a><span id="l1.28">       emailaddress: emailAddress,</span>
<a href="#l1.29"></a><span id="l1.29">     },</span>
<a href="#l1.30"></a><span id="l1.30">   };</span>
<a href="#l1.31"></a><span id="l1.31">   if (!Services.prefs.getBoolPref(</span>
<a href="#l1.32"></a><span id="l1.32">       &quot;mailnews.auto_config.fetchFromISP.sendEmailAddress&quot;)) {</span>
<a href="#l1.33"></a><span id="l1.33">     delete callArgs.urlArgs.emailaddress;</span>
<a href="#l1.34"></a><span id="l1.34">   }</span>
<a href="#l1.35"></a><span id="l1.35">   let call;</span>
<a href="#l1.36"></a><span id="l1.36">   let fetch;</span>
<a href="#l1.37"></a><span id="l1.37"> </span>
<a href="#l1.38"></a><span id="l1.38">   let priority = new PriorityOrderAbortable(</span>
<a href="#l1.39"></a><span id="l1.39">       xml =&gt; successCallback(readFromXML(xml)),</span>
<a href="#l1.40"></a><span id="l1.40">       errorCallback);</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineminus">-</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">-  call = priority.addCall();</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">-  fetch = new FetchHTTP(url1, callArgs,</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineminus">-      call.successCallback(), call.errorCallback());</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineminus">-  call.setAbortable(fetch);</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">-  fetch.start();</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineminus">-</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineminus">-  call = priority.addCall();</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineminus">-  fetch = new FetchHTTP(url2, callArgs,</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-      call.successCallback(), call.errorCallback());</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineminus">-  call.setAbortable(fetch);</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-  fetch.start();</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+  for (let url of urls) {</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+    call = priority.addCall();</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+    fetch = new FetchHTTP(url, callArgs,</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+        call.successCallback(), call.errorCallback());</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+    call.setAbortable(fetch);</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+    fetch.start();</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+  }</span>
<a href="#l1.60"></a><span id="l1.60"> </span>
<a href="#l1.61"></a><span id="l1.61">   return priority;</span>
<a href="#l1.62"></a><span id="l1.62"> }</span>
<a href="#l1.63"></a><span id="l1.63"> </span>
<a href="#l1.64"></a><span id="l1.64"> /**</span>
<a href="#l1.65"></a><span id="l1.65">  * Tries to get a configuration for this ISP from a central database at</span>
<a href="#l1.66"></a><span id="l1.66">  * Mozilla servers.</span>
<a href="#l1.67"></a><span id="l1.67">  * Params @see fetchConfigFromISP()</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/mailnews.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/mailnews.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -911,22 +911,40 @@ pref(&quot;mailnews.emptyJunk.dontAskAgain&quot;, </span>
<a href="#l2.4"></a><span id="l2.4"> pref(&quot;mailnews.emptyTrash.dontAskAgain&quot;, false);</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6"> // where to fetch auto config information from.</span>
<a href="#l2.7"></a><span id="l2.7"> pref(&quot;mailnews.auto_config_url&quot;, &quot;https://live.thunderbird.net/autoconfig/v1.1/&quot;);</span>
<a href="#l2.8"></a><span id="l2.8"> // Added in bug 551519. Remove when bug 545866 is fixed.</span>
<a href="#l2.9"></a><span id="l2.9"> pref(&quot;mailnews.mx_service_url&quot;, &quot;https://live.thunderbird.net/dns/mx/&quot;);</span>
<a href="#l2.10"></a><span id="l2.10"> // The list of addons which can handle certain account types</span>
<a href="#l2.11"></a><span id="l2.11"> pref(&quot;mailnews.auto_config.addons_url&quot;, &quot;https://live.thunderbird.net/autoconfig/addons.json&quot;);</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-// Allow to contact ISP (email address domain)</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-// This happens via insecure means (HTTP), so the config cannot be trusted,</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-// and also contains the email address</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+// Allow to contact the ISP (email address domain).</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+// This may happen via insecure means (HTTP) susceptible to eavesdropping</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+// and MitM (see mailnews.auto_config.fetchFromISP.sslOnly below).</span>
<a href="#l2.18"></a><span id="l2.18"> pref(&quot;mailnews.auto_config.fetchFromISP.enabled&quot;, true);</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-// Allow the fetch from ISP via HTTP, but not the email address</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+// Allow the username to be sent to the ISP when fetching.</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+// Note that the username will leak in plaintext if a non-SSL fetch is</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+// performed.</span>
<a href="#l2.23"></a><span id="l2.23"> pref(&quot;mailnews.auto_config.fetchFromISP.sendEmailAddress&quot;, true);</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+// Allow only SSL channels when fetching config from ISP.</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+// If false, an active attacker can block SSL fetches and then</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+// MITM the HTTP fetch, determining the config that is shown to the user.</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+// However:</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+// 1. The user still needs to explicitly approve the false config.</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+// 2. Most hosters that offer this ISP config do so on HTTP and not on HTTPS.</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+//    That's because they direct customer domains (HTTP) to their provider</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+//    config (HTTPS). If you set this to true, you simply break this mechanism.</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+//    You will simply not get most configs.</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+// 3. Even with this mechanism protected, there are still guess config and</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+//    AutoDiscover config mechanisms which have the exact same problem.</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+//    And we really need the guess config, it's the mechanism that provides</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+//    about 40% of the configs. Plus, many internal mail servers</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+//    have no SSL, so even with this preference set to true, you cannot</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+//    solve the problem.</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+pref(&quot;mailnews.auto_config.fetchFromISP.sslOnly&quot;, false);</span>
<a href="#l2.40"></a><span id="l2.40"> // Allow the Microsoft Exchange AutoDiscover protocol.</span>
<a href="#l2.41"></a><span id="l2.41"> // This also sends the email address and password to the server,</span>
<a href="#l2.42"></a><span id="l2.42"> // which the protocol unfortunately requires in practice.</span>
<a href="#l2.43"></a><span id="l2.43"> pref(&quot;mailnews.auto_config.fetchFromExchange.enabled&quot;, true);</span>
<a href="#l2.44"></a><span id="l2.44"> // Whether we will attempt to guess the account configuration based on</span>
<a href="#l2.45"></a><span id="l2.45"> // protocol default ports and common domain practices</span>
<a href="#l2.46"></a><span id="l2.46"> // (e.g. {mail,pop,imap,smtp}.&lt;email-domain&gt;).</span>
<a href="#l2.47"></a><span id="l2.47"> pref(&quot;mailnews.auto_config.guess.enabled&quot;, true);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

