<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 9874:065ca8b823be22a0b1e137c20f211e3581296e95</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 065ca8b823be22a0b1e137c20f211e3581296e95" />
<meta property="og:url" content="/comm-central/rev/065ca8b823be22a0b1e137c20f211e3581296e95" />
<meta property="og:description" content="Bug 736881 - Improve calculation of attached message size; r=bienvenu, ui-rs=bwinton" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 065ca8b823be22a0b1e137c20f211e3581296e95 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/065ca8b823be22a0b1e137c20f211e3581296e95">shortlog</a> |
<a href="/comm-central/log/065ca8b823be22a0b1e137c20f211e3581296e95">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/065ca8b823be22a0b1e137c20f211e3581296e95">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/065ca8b823be22a0b1e137c20f211e3581296e95">files</a> |
changeset |
<a href="/comm-central/raw-rev/065ca8b823be22a0b1e137c20f211e3581296e95">raw</a>  | <a href="/comm-central/archive/065ca8b823be22a0b1e137c20f211e3581296e95.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=736881">Bug 736881</a> - Improve calculation of attached message size; r=bienvenu, ui-rs=bwinton
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#105;&#109;&#32;&#80;&#111;&#114;&#116;&#101;&#114;&#32;&#60;&#115;&#113;&#117;&#105;&#98;&#98;&#108;&#121;&#102;&#108;&#97;&#98;&#98;&#101;&#116;&#121;&#100;&#111;&#111;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 10 Apr 2012 18:44:36 -0500</td></tr>

<tr>
 <td>changeset 9874</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/065ca8b823be22a0b1e137c20f211e3581296e95">065ca8b823be22a0b1e137c20f211e3581296e95</a></td>
</tr>



<tr>
<td>parent 9873</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/0a7f003186645dd9d86c396c8cb747b81d784fce">0a7f003186645dd9d86c396c8cb747b81d784fce</a>
</td>
</tr>

<tr>
<td>child 9875</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/99fcdce4abb46338e757fb9951c003e360983368">99fcdce4abb46338e757fb9951c003e360983368</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=065ca8b823be22a0b1e137c20f211e3581296e95">7519</a></td></tr>
<tr><td>push user</td><td>squibblyflabbetydoo@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 10 Apr 2012 23:44:54 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@065ca8b823be [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=065ca8b823be22a0b1e137c20f211e3581296e95">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=065ca8b823be22a0b1e137c20f211e3581296e95&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=065ca8b823be22a0b1e137c20f211e3581296e95&newProject=comm-central&newRevision=065ca8b823be22a0b1e137c20f211e3581296e95&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=065ca8b823be22a0b1e137c20f211e3581296e95&newProject=comm-central&newRevision=065ca8b823be22a0b1e137c20f211e3581296e95&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=065ca8b823be22a0b1e137c20f211e3581296e95&newProject=comm-central&newRevision=065ca8b823be22a0b1e137c20f211e3581296e95&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28bienvenu%29&revcount=50">bienvenu</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=736881">736881</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=736881">Bug 736881</a> - Improve calculation of attached message size; r=bienvenu, ui-rs=bwinton</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/065ca8b823be22a0b1e137c20f211e3581296e95/mail/base/content/msgHdrViewOverlay.js">mail/base/content/msgHdrViewOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/065ca8b823be22a0b1e137c20f211e3581296e95/mail/base/content/msgHdrViewOverlay.js">file</a> |
<a href="/comm-central/annotate/065ca8b823be22a0b1e137c20f211e3581296e95/mail/base/content/msgHdrViewOverlay.js">annotate</a> |
<a href="/comm-central/diff/065ca8b823be22a0b1e137c20f211e3581296e95/mail/base/content/msgHdrViewOverlay.js">diff</a> |
<a href="/comm-central/comparison/065ca8b823be22a0b1e137c20f211e3581296e95/mail/base/content/msgHdrViewOverlay.js">comparison</a> |
<a href="/comm-central/log/065ca8b823be22a0b1e137c20f211e3581296e95/mail/base/content/msgHdrViewOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/065ca8b823be22a0b1e137c20f211e3581296e95/mail/test/mozmill/attachment/test-attachment-size.js">mail/test/mozmill/attachment/test-attachment-size.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/065ca8b823be22a0b1e137c20f211e3581296e95/mail/test/mozmill/attachment/test-attachment-size.js">file</a> |
<a href="/comm-central/annotate/065ca8b823be22a0b1e137c20f211e3581296e95/mail/test/mozmill/attachment/test-attachment-size.js">annotate</a> |
<a href="/comm-central/diff/065ca8b823be22a0b1e137c20f211e3581296e95/mail/test/mozmill/attachment/test-attachment-size.js">diff</a> |
<a href="/comm-central/comparison/065ca8b823be22a0b1e137c20f211e3581296e95/mail/test/mozmill/attachment/test-attachment-size.js">comparison</a> |
<a href="/comm-central/log/065ca8b823be22a0b1e137c20f211e3581296e95/mail/test/mozmill/attachment/test-attachment-size.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/065ca8b823be22a0b1e137c20f211e3581296e95/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">mail/test/mozmill/shared-modules/test-folder-display-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/065ca8b823be22a0b1e137c20f211e3581296e95/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">file</a> |
<a href="/comm-central/annotate/065ca8b823be22a0b1e137c20f211e3581296e95/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">annotate</a> |
<a href="/comm-central/diff/065ca8b823be22a0b1e137c20f211e3581296e95/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">diff</a> |
<a href="/comm-central/comparison/065ca8b823be22a0b1e137c20f211e3581296e95/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">comparison</a> |
<a href="/comm-central/log/065ca8b823be22a0b1e137c20f211e3581296e95/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/065ca8b823be22a0b1e137c20f211e3581296e95/mailnews/mime/src/mimemoz2.cpp">mailnews/mime/src/mimemoz2.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/065ca8b823be22a0b1e137c20f211e3581296e95/mailnews/mime/src/mimemoz2.cpp">file</a> |
<a href="/comm-central/annotate/065ca8b823be22a0b1e137c20f211e3581296e95/mailnews/mime/src/mimemoz2.cpp">annotate</a> |
<a href="/comm-central/diff/065ca8b823be22a0b1e137c20f211e3581296e95/mailnews/mime/src/mimemoz2.cpp">diff</a> |
<a href="/comm-central/comparison/065ca8b823be22a0b1e137c20f211e3581296e95/mailnews/mime/src/mimemoz2.cpp">comparison</a> |
<a href="/comm-central/log/065ca8b823be22a0b1e137c20f211e3581296e95/mailnews/mime/src/mimemoz2.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/065ca8b823be22a0b1e137c20f211e3581296e95/mailnews/mime/src/mimemsg.cpp">mailnews/mime/src/mimemsg.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/065ca8b823be22a0b1e137c20f211e3581296e95/mailnews/mime/src/mimemsg.cpp">file</a> |
<a href="/comm-central/annotate/065ca8b823be22a0b1e137c20f211e3581296e95/mailnews/mime/src/mimemsg.cpp">annotate</a> |
<a href="/comm-central/diff/065ca8b823be22a0b1e137c20f211e3581296e95/mailnews/mime/src/mimemsg.cpp">diff</a> |
<a href="/comm-central/comparison/065ca8b823be22a0b1e137c20f211e3581296e95/mailnews/mime/src/mimemsg.cpp">comparison</a> |
<a href="/comm-central/log/065ca8b823be22a0b1e137c20f211e3581296e95/mailnews/mime/src/mimemsg.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/065ca8b823be22a0b1e137c20f211e3581296e95/mailnews/mime/src/mimemsg.h">mailnews/mime/src/mimemsg.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/065ca8b823be22a0b1e137c20f211e3581296e95/mailnews/mime/src/mimemsg.h">file</a> |
<a href="/comm-central/annotate/065ca8b823be22a0b1e137c20f211e3581296e95/mailnews/mime/src/mimemsg.h">annotate</a> |
<a href="/comm-central/diff/065ca8b823be22a0b1e137c20f211e3581296e95/mailnews/mime/src/mimemsg.h">diff</a> |
<a href="/comm-central/comparison/065ca8b823be22a0b1e137c20f211e3581296e95/mailnews/mime/src/mimemsg.h">comparison</a> |
<a href="/comm-central/log/065ca8b823be22a0b1e137c20f211e3581296e95/mailnews/mime/src/mimemsg.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/065ca8b823be22a0b1e137c20f211e3581296e95/mailnews/mime/test/unit/test_attachment_size.js">mailnews/mime/test/unit/test_attachment_size.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/065ca8b823be22a0b1e137c20f211e3581296e95/mailnews/mime/test/unit/test_attachment_size.js">file</a> |
<a href="/comm-central/annotate/065ca8b823be22a0b1e137c20f211e3581296e95/mailnews/mime/test/unit/test_attachment_size.js">annotate</a> |
<a href="/comm-central/diff/065ca8b823be22a0b1e137c20f211e3581296e95/mailnews/mime/test/unit/test_attachment_size.js">diff</a> |
<a href="/comm-central/comparison/065ca8b823be22a0b1e137c20f211e3581296e95/mailnews/mime/test/unit/test_attachment_size.js">comparison</a> |
<a href="/comm-central/log/065ca8b823be22a0b1e137c20f211e3581296e95/mailnews/mime/test/unit/test_attachment_size.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/msgHdrViewOverlay.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/msgHdrViewOverlay.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -37,16 +37,17 @@</span>
<a href="#l1.4"></a><span id="l1.4">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l1.5"></a><span id="l1.5">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l1.6"></a><span id="l1.6">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l1.7"></a><span id="l1.7">  *</span>
<a href="#l1.8"></a><span id="l1.8">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l1.11"></a><span id="l1.11"> Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+Components.utils.import(&quot;resource:///modules/gloda/utils.js&quot;);</span>
<a href="#l1.13"></a><span id="l1.13"> </span>
<a href="#l1.14"></a><span id="l1.14"> /* This is where functions related to displaying the headers for a selected message in the</span>
<a href="#l1.15"></a><span id="l1.15">    message pane live. */</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17"> ////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l1.18"></a><span id="l1.18"> // Warning: if you go to modify any of these JS routines please get a code review from</span>
<a href="#l1.19"></a><span id="l1.19"> // scott@scott-macgregor.org. It's critical that the code in here for displaying</span>
<a href="#l1.20"></a><span id="l1.20"> // the message headers for a selected message remain as fast as possible. In particular,</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineat">@@ -1644,16 +1645,19 @@ function AttachmentInfo(contentType, url</span>
<a href="#l1.22"></a><span id="l1.22">                         isExternalAttachment, size)</span>
<a href="#l1.23"></a><span id="l1.23"> {</span>
<a href="#l1.24"></a><span id="l1.24">   this.contentType = contentType;</span>
<a href="#l1.25"></a><span id="l1.25">   this.url = url;</span>
<a href="#l1.26"></a><span id="l1.26">   this.name = name;</span>
<a href="#l1.27"></a><span id="l1.27">   this.uri = uri;</span>
<a href="#l1.28"></a><span id="l1.28">   this.isExternalAttachment = isExternalAttachment;</span>
<a href="#l1.29"></a><span id="l1.29">   this.size = size;</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+  let match = GlodaUtils.PART_RE.exec(url);</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+  this.partID = match &amp;&amp; match[1];</span>
<a href="#l1.33"></a><span id="l1.33"> }</span>
<a href="#l1.34"></a><span id="l1.34"> </span>
<a href="#l1.35"></a><span id="l1.35"> AttachmentInfo.prototype = {</span>
<a href="#l1.36"></a><span id="l1.36">   /**</span>
<a href="#l1.37"></a><span id="l1.37">    * Save this attachment to a file.</span>
<a href="#l1.38"></a><span id="l1.38">    */</span>
<a href="#l1.39"></a><span id="l1.39">   save: function AttachmentInfo_save()</span>
<a href="#l1.40"></a><span id="l1.40">   {</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineat">@@ -2016,28 +2020,35 @@ function displayAttachmentsForExpandedVi</span>
<a href="#l1.42"></a><span id="l1.42">                              .getService(Components.interfaces.nsIPrefBranch)</span>
<a href="#l1.43"></a><span id="l1.43">                              .getIntPref(&quot;mailnews.attachments.display.view&quot;);</span>
<a href="#l1.44"></a><span id="l1.44">     var views = [&quot;small&quot;, &quot;large&quot;, &quot;tile&quot;];</span>
<a href="#l1.45"></a><span id="l1.45">     attachmentList.view = views[viewMode];</span>
<a href="#l1.46"></a><span id="l1.46">     attachmentList.controllers.appendController(AttachmentListController);</span>
<a href="#l1.47"></a><span id="l1.47"> </span>
<a href="#l1.48"></a><span id="l1.48">     toggleAttachmentList(false);</span>
<a href="#l1.49"></a><span id="l1.49"> </span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+    var lastPartID;</span>
<a href="#l1.51"></a><span id="l1.51">     var unknownSize = false;</span>
<a href="#l1.52"></a><span id="l1.52">     for each (let [, attachment] in Iterator(currentAttachments)) {</span>
<a href="#l1.53"></a><span id="l1.53">       // Create a new attachment widget</span>
<a href="#l1.54"></a><span id="l1.54">       var displayName = SanitizeAttachmentDisplayName(attachment);</span>
<a href="#l1.55"></a><span id="l1.55">       var item = attachmentList.appendItem(attachment, displayName);</span>
<a href="#l1.56"></a><span id="l1.56">       item.setAttribute(&quot;tooltiptext&quot;, attachment.name);</span>
<a href="#l1.57"></a><span id="l1.57">       item.addEventListener(&quot;command&quot;, attachmentItemCommand, false);</span>
<a href="#l1.58"></a><span id="l1.58"> </span>
<a href="#l1.59"></a><span id="l1.59" class="difflineminus">-      if (attachment.size !== null)</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineminus">-        totalSize += attachment.size;</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineminus">-      else if (!attachment.isDeleted)</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineminus">-        unknownSize = true;</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineplus">+      // Check if this attachment's part ID is a child of the last attachment</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineplus">+      // we counted. If so, skip it, since we already accounted for its size</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+      // from its parent.</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+      if (!lastPartID || attachment.partID.indexOf(lastPartID) != 0) {</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+        lastPartID = attachment.partID;</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+        if (attachment.size !== null)</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+          totalSize += attachment.size;</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+        else if (!attachment.isDeleted)</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineplus">+          unknownSize = true;</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineplus">+      }</span>
<a href="#l1.73"></a><span id="l1.73">     }</span>
<a href="#l1.74"></a><span id="l1.74"> </span>
<a href="#l1.75"></a><span id="l1.75">     // Show the appropriate toolbar button and label based on the number of</span>
<a href="#l1.76"></a><span id="l1.76">     // attachments.</span>
<a href="#l1.77"></a><span id="l1.77">     updateSaveAllAttachmentsButton();</span>
<a href="#l1.78"></a><span id="l1.78"> </span>
<a href="#l1.79"></a><span id="l1.79">     let attachmentInfo = document.getElementById(&quot;attachmentInfo&quot;);</span>
<a href="#l1.80"></a><span id="l1.80">     let attachmentCount = document.getElementById(&quot;attachmentCount&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/test/mozmill/attachment/test-attachment-size.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/test/mozmill/attachment/test-attachment-size.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -140,16 +140,23 @@ var messages = [</span>
<a href="#l2.4"></a><span id="l2.4">   { name: 'multiple_attachments_one_deleted',</span>
<a href="#l2.5"></a><span id="l2.5">     bodyPart: null,</span>
<a href="#l2.6"></a><span id="l2.6">     attachments: [{ body: textAttachment,</span>
<a href="#l2.7"></a><span id="l2.7">                     filename: 'ubik.txt',</span>
<a href="#l2.8"></a><span id="l2.8">                     format: '' }],</span>
<a href="#l2.9"></a><span id="l2.9">     attachmentSizes: [null, textAttachment.length],</span>
<a href="#l2.10"></a><span id="l2.10">     attachmentTotalSize: { size: textAttachment.length, exact: true },</span>
<a href="#l2.11"></a><span id="l2.11">   },</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+  // this is an attached message that itself has an attachment</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+  {</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+    name: 'attached_message_with_attachment',</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+    bodyPart: null,</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+    attachmentSizes: [null, textAttachment.length],</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+    attachmentTotalSize: { size: 0, exact: true },</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+  },</span>
<a href="#l2.19"></a><span id="l2.19"> ];</span>
<a href="#l2.20"></a><span id="l2.20"> </span>
<a href="#l2.21"></a><span id="l2.21"> function setupModule(module) {</span>
<a href="#l2.22"></a><span id="l2.22">   let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l2.23"></a><span id="l2.23">   fdh.installInto(module);</span>
<a href="#l2.24"></a><span id="l2.24">   let wh = collector.getModule('window-helpers');</span>
<a href="#l2.25"></a><span id="l2.25">   wh.installInto(module);</span>
<a href="#l2.26"></a><span id="l2.26">   let ah = collector.getModule('attachment-helpers');</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineat">@@ -160,17 +167,17 @@ function setupModule(module) {</span>
<a href="#l2.28"></a><span id="l2.28"> </span>
<a href="#l2.29"></a><span id="l2.29">   /* Today's gory details (thanks to Jonathan Protzenko): libmime somehow</span>
<a href="#l2.30"></a><span id="l2.30">    * counts the trailing newline for an attachment MIME part. Most of the time,</span>
<a href="#l2.31"></a><span id="l2.31">    * assuming attachment has N bytes (no matter what's inside, newlines or</span>
<a href="#l2.32"></a><span id="l2.32">    * not), libmime will return N + 1 bytes. On Linux and Mac, this always</span>
<a href="#l2.33"></a><span id="l2.33">    * holds. However, on Windows, if the attachment is not encoded (that is, is</span>
<a href="#l2.34"></a><span id="l2.34">    * inline text), libmime will return N + 2 bytes.</span>
<a href="#l2.35"></a><span id="l2.35">    */</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-  epsilon = ('@mozilla.org/windows-registry-key;1' in Components.classes) ? 2 : 1;</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+  epsilon = ('@mozilla.org/windows-registry-key;1' in Components.classes) ? 4 : 2;</span>
<a href="#l2.38"></a><span id="l2.38"> </span>
<a href="#l2.39"></a><span id="l2.39">   // set up our detached/deleted attachments</span>
<a href="#l2.40"></a><span id="l2.40">   var thisFilePath = os.getFileForPath(__file__);</span>
<a href="#l2.41"></a><span id="l2.41"> </span>
<a href="#l2.42"></a><span id="l2.42">   var detachedFile = os.getFileForPath(os.abspath(detachedName, thisFilePath));</span>
<a href="#l2.43"></a><span id="l2.43">   var detached = create_body_part(</span>
<a href="#l2.44"></a><span id="l2.44">     'Here is a file',</span>
<a href="#l2.45"></a><span id="l2.45">     [create_detached_attachment(detachedFile, 'text/plain')]</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineat">@@ -182,16 +189,34 @@ function setupModule(module) {</span>
<a href="#l2.47"></a><span id="l2.47">     [create_detached_attachment(missingFile, 'text/plain')]</span>
<a href="#l2.48"></a><span id="l2.48">   );</span>
<a href="#l2.49"></a><span id="l2.49"> </span>
<a href="#l2.50"></a><span id="l2.50">   var deleted = create_body_part(</span>
<a href="#l2.51"></a><span id="l2.51">     'Here is a file that you deleted',</span>
<a href="#l2.52"></a><span id="l2.52">     [create_deleted_attachment(deletedName, 'text/plain')]</span>
<a href="#l2.53"></a><span id="l2.53">   );</span>
<a href="#l2.54"></a><span id="l2.54"> </span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+  var attachedMessage = msgGen.makeMessage({</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+    body: { body: textAttachment },</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+    attachments: [{ body: textAttachment,</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+                    filename: 'ubik.txt',</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+                    format: '' }],</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+  });</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+  /* Much like the above comment, libmime counts bytes differently on Windows,</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+   * where it counts newlines (\r\n) as 2 bytes. Mac and Linux treats them as</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+   * 1 byte.</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+   */</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+  var attachedMessageLength;</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+  if (epsilon == 4) // Windows</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+    attachedMessageLength = attachedMessage.toMessageString().length;</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+  else // Mac/Linux</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+    attachedMessageLength = attachedMessage.toMessageString()</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+                                           .replace(/\r\n/g, &quot;\n&quot;).length;</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+</span>
<a href="#l2.73"></a><span id="l2.73">   folder = create_folder('AttachmentSizeA');</span>
<a href="#l2.74"></a><span id="l2.74">   for (let i = 0; i &lt; messages.length; i++) {</span>
<a href="#l2.75"></a><span id="l2.75">     // First, add any missing info to the message object.</span>
<a href="#l2.76"></a><span id="l2.76">     switch(messages[i].name) {</span>
<a href="#l2.77"></a><span id="l2.77">       case 'detached_attachment':</span>
<a href="#l2.78"></a><span id="l2.78">       case 'multiple_attachments_one_detached':</span>
<a href="#l2.79"></a><span id="l2.79">         messages[i].bodyPart = detached;</span>
<a href="#l2.80"></a><span id="l2.80">         messages[i].attachmentSizes[0] = detachedFile.fileSize;</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineat">@@ -200,16 +225,24 @@ function setupModule(module) {</span>
<a href="#l2.82"></a><span id="l2.82">       case 'detached_attachment_with_missing_file':</span>
<a href="#l2.83"></a><span id="l2.83">       case 'multiple_attachments_one_detached_with_missing_file':</span>
<a href="#l2.84"></a><span id="l2.84">         messages[i].bodyPart = missing;</span>
<a href="#l2.85"></a><span id="l2.85">         break;</span>
<a href="#l2.86"></a><span id="l2.86">       case 'deleted_attachment':</span>
<a href="#l2.87"></a><span id="l2.87">       case 'multiple_attachments_one_deleted':</span>
<a href="#l2.88"></a><span id="l2.88">         messages[i].bodyPart = deleted;</span>
<a href="#l2.89"></a><span id="l2.89">         break;</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+      case 'attached_message_with_attachment':</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+        messages[i].bodyPart = new SyntheticPartMultiMixed([</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineplus">+          new SyntheticPartLeaf(&quot;I am text!&quot;, { contentType: &quot;text/plain&quot; }),</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineplus">+          attachedMessage,</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineplus">+        ]);</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineplus">+        messages[i].attachmentSizes[0] = attachedMessageLength;</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineplus">+        messages[i].attachmentTotalSize.size += attachedMessageLength;</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineplus">+        break;</span>
<a href="#l2.98"></a><span id="l2.98">     }</span>
<a href="#l2.99"></a><span id="l2.99"> </span>
<a href="#l2.100"></a><span id="l2.100">     add_message_to_folder(folder, create_message(messages[i]));</span>
<a href="#l2.101"></a><span id="l2.101">   }</span>
<a href="#l2.102"></a><span id="l2.102"> }</span>
<a href="#l2.103"></a><span id="l2.103"> </span>
<a href="#l2.104"></a><span id="l2.104"> /**</span>
<a href="#l2.105"></a><span id="l2.105">  * Make sure that the attachment's size is what we expect</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineat">@@ -259,21 +292,26 @@ function check_no_attachment_size(index)</span>
<a href="#l2.107"></a><span id="l2.107"> function check_total_attachment_size(count, expectedSize, exact) {</span>
<a href="#l2.108"></a><span id="l2.108">   let list = mc.e('attachmentList');</span>
<a href="#l2.109"></a><span id="l2.109">   let nodes = list.getElementsByTagName('attachmentitem');</span>
<a href="#l2.110"></a><span id="l2.110">   let sizeNode = mc.e('attachmentSize');</span>
<a href="#l2.111"></a><span id="l2.111"> </span>
<a href="#l2.112"></a><span id="l2.112">   if (nodes.length != count)</span>
<a href="#l2.113"></a><span id="l2.113">     throw new Error('Saw '+nodes.length+' attachments, but expected '+count);</span>
<a href="#l2.114"></a><span id="l2.114"> </span>
<a href="#l2.115"></a><span id="l2.115" class="difflineplus">+  let lastPartID;</span>
<a href="#l2.116"></a><span id="l2.116">   let size = 0;</span>
<a href="#l2.117"></a><span id="l2.117">   for (let i = 0; i &lt; nodes.length; i++) {</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineminus">-    let currSize = nodes[i].attachment.size;</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineminus">-    if (!isNaN(currSize))</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineminus">-      size += currSize;</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineplus">+    let attachment = nodes[i].attachment;</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineplus">+    if (!lastPartID || attachment.partID.indexOf(lastPartID) != 0) {</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineplus">+      lastPartID = attachment.partID;</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineplus">+      let currSize = attachment.size;</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineplus">+      if (!isNaN(currSize))</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineplus">+        size += currSize;</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineplus">+    }</span>
<a href="#l2.128"></a><span id="l2.128">   }</span>
<a href="#l2.129"></a><span id="l2.129"> </span>
<a href="#l2.130"></a><span id="l2.130">   if (Math.abs(size - expectedSize) &gt; epsilon*count)</span>
<a href="#l2.131"></a><span id="l2.131">     throw new Error('Reported attachment size ('+size+') not within epsilon ' +</span>
<a href="#l2.132"></a><span id="l2.132">                     'of actual attachment size ('+expectedSize+')');</span>
<a href="#l2.133"></a><span id="l2.133"> </span>
<a href="#l2.134"></a><span id="l2.134">   // Next, make sure that the formatted size in the label is correct</span>
<a href="#l2.135"></a><span id="l2.135">   let formattedSize = sizeNode.getAttribute('value');</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-folder-display-helpers.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-folder-display-helpers.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -253,16 +253,19 @@ function setupModule() {</span>
<a href="#l3.4"></a><span id="l3.4">   testHelperModule.gMessageScenarioFactory =</span>
<a href="#l3.5"></a><span id="l3.5">     new testHelperModule.MessageScenarioFactory(msgGen);</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7">   make_new_sets_in_folders = make_new_sets_in_folder =</span>
<a href="#l3.8"></a><span id="l3.8">     testHelperModule.make_new_sets_in_folders;</span>
<a href="#l3.9"></a><span id="l3.9">   add_sets_to_folders = testHelperModule.add_sets_to_folders;</span>
<a href="#l3.10"></a><span id="l3.10">   make_folder_with_sets = testHelperModule.make_folder_with_sets;</span>
<a href="#l3.11"></a><span id="l3.11">   make_virtual_folder = testHelperModule.make_virtual_folder;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+  SyntheticPartLeaf = testHelperModule.SyntheticPartLeaf;</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+  SyntheticPartMultiMixed = testHelperModule.SyntheticPartMultiMixed;</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+  SyntheticPartMultiRelated = testHelperModule.SyntheticPartMultiRelated;</span>
<a href="#l3.15"></a><span id="l3.15"> </span>
<a href="#l3.16"></a><span id="l3.16">   delete_message_set = testHelperModule.async_delete_messages;</span>
<a href="#l3.17"></a><span id="l3.17"> </span>
<a href="#l3.18"></a><span id="l3.18">   // use window-helper's augment_controller method to get our extra good stuff</span>
<a href="#l3.19"></a><span id="l3.19">   //  we need.</span>
<a href="#l3.20"></a><span id="l3.20">   windowHelper = collector.getModule('window-helpers');</span>
<a href="#l3.21"></a><span id="l3.21">   mc = windowHelper.wait_for_existing_window(&quot;mail:3pane&quot;);</span>
<a href="#l3.22"></a><span id="l3.22">   windowHelper.augment_controller(mc);</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineat">@@ -2790,16 +2793,19 @@ function set_pane_layout(aLayout) {</span>
<a href="#l3.24"></a><span id="l3.24"> </span>
<a href="#l3.25"></a><span id="l3.25"> /** exported from messageInjection */</span>
<a href="#l3.26"></a><span id="l3.26"> var make_new_sets_in_folders;</span>
<a href="#l3.27"></a><span id="l3.27"> var make_new_sets_in_folder;</span>
<a href="#l3.28"></a><span id="l3.28"> var add_sets_to_folders;</span>
<a href="#l3.29"></a><span id="l3.29"> var delete_message_set;</span>
<a href="#l3.30"></a><span id="l3.30"> var make_folder_with_sets;</span>
<a href="#l3.31"></a><span id="l3.31"> var make_virtual_folder;</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+var SyntheticPartLeaf;</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+var SyntheticPartMultiMixed;</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+var SyntheticPartMultiRelated;</span>
<a href="#l3.35"></a><span id="l3.35"> </span>
<a href="#l3.36"></a><span id="l3.36"> /**</span>
<a href="#l3.37"></a><span id="l3.37">  * Load a file in its own 'module'.</span>
<a href="#l3.38"></a><span id="l3.38">  *</span>
<a href="#l3.39"></a><span id="l3.39">  * @param aPath A path relative to the comm-central source path.</span>
<a href="#l3.40"></a><span id="l3.40">  *</span>
<a href="#l3.41"></a><span id="l3.41">  * @return An object that serves as the global scope for the loaded file.</span>
<a href="#l3.42"></a><span id="l3.42">  */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/mime/src/mimemoz2.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/mime/src/mimemoz2.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -111,19 +111,22 @@ mime_stream_data::mime_stream_data() : u</span>
<a href="#l4.4"></a><span id="l4.4"> // Attachment handling routines</span>
<a href="#l4.5"></a><span id="l4.5"> ////////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l4.6"></a><span id="l4.6"> //</span>
<a href="#l4.7"></a><span id="l4.7"> MimeObject    *mime_get_main_object(MimeObject* obj);</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9"> nsresult MimeGetSize(MimeObject *child, PRInt32 *size) {</span>
<a href="#l4.10"></a><span id="l4.10">   bool isLeaf = mime_subclass_p(child-&gt;clazz, (MimeObjectClass *) &amp;mimeLeafClass);</span>
<a href="#l4.11"></a><span id="l4.11">   bool isContainer = mime_subclass_p(child-&gt;clazz, (MimeObjectClass *) &amp;mimeContainerClass);</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+  bool isMsg = mime_subclass_p(child-&gt;clazz, (MimeObjectClass *) &amp;mimeMessageClass);</span>
<a href="#l4.13"></a><span id="l4.13"> </span>
<a href="#l4.14"></a><span id="l4.14">   if (isLeaf) {</span>
<a href="#l4.15"></a><span id="l4.15">     *size += ((MimeLeaf *)child)-&gt;sizeSoFar;</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+  } else if (isMsg) {</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+    *size += ((MimeMessage *)child)-&gt;sizeSoFar;</span>
<a href="#l4.18"></a><span id="l4.18">   } else if (isContainer) {</span>
<a href="#l4.19"></a><span id="l4.19">     int i;</span>
<a href="#l4.20"></a><span id="l4.20">     MimeContainer *cont = (MimeContainer *)child;</span>
<a href="#l4.21"></a><span id="l4.21">     for (i = 0; i &lt; cont-&gt;nchildren; ++i) {</span>
<a href="#l4.22"></a><span id="l4.22">       MimeGetSize(cont-&gt;children[i], size);</span>
<a href="#l4.23"></a><span id="l4.23">     }</span>
<a href="#l4.24"></a><span id="l4.24">   }</span>
<a href="#l4.25"></a><span id="l4.25">   return NS_OK;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/mime/src/mimemsg.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/mime/src/mimemsg.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -104,16 +104,17 @@ MimeMessageClassInitialize(MimeMessageCl</span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5"> </span>
<a href="#l5.6"></a><span id="l5.6"> static int</span>
<a href="#l5.7"></a><span id="l5.7"> MimeMessage_initialize (MimeObject *object)</span>
<a href="#l5.8"></a><span id="l5.8"> {</span>
<a href="#l5.9"></a><span id="l5.9">   MimeMessage *msg = (MimeMessage *)object;</span>
<a href="#l5.10"></a><span id="l5.10">   msg-&gt;grabSubject = false;</span>
<a href="#l5.11"></a><span id="l5.11">   msg-&gt;bodyLength = 0;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+  msg-&gt;sizeSoFar = 0;</span>
<a href="#l5.13"></a><span id="l5.13"> </span>
<a href="#l5.14"></a><span id="l5.14">   return ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;initialize(object);</span>
<a href="#l5.15"></a><span id="l5.15"> }</span>
<a href="#l5.16"></a><span id="l5.16"> </span>
<a href="#l5.17"></a><span id="l5.17"> static void</span>
<a href="#l5.18"></a><span id="l5.18"> MimeMessage_finalize (MimeObject *object)</span>
<a href="#l5.19"></a><span id="l5.19"> {</span>
<a href="#l5.20"></a><span id="l5.20">   MimeMessage *msg = (MimeMessage *)object;</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineat">@@ -149,16 +150,18 @@ MimeMessage_parse_line (const char *aLin</span>
<a href="#l5.22"></a><span id="l5.22">   PRInt32 length = aLength;</span>
<a href="#l5.23"></a><span id="l5.23"> </span>
<a href="#l5.24"></a><span id="l5.24">   MimeMessage *msg = (MimeMessage *) obj;</span>
<a href="#l5.25"></a><span id="l5.25">   int status = 0;</span>
<a href="#l5.26"></a><span id="l5.26"> </span>
<a href="#l5.27"></a><span id="l5.27">   NS_ASSERTION(line &amp;&amp; *line, &quot;empty line in mime msg parse_line&quot;);</span>
<a href="#l5.28"></a><span id="l5.28">   if (!line || !*line) return -1;</span>
<a href="#l5.29"></a><span id="l5.29"> </span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+  msg-&gt;sizeSoFar += length;</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+</span>
<a href="#l5.32"></a><span id="l5.32">   if (msg-&gt;grabSubject)</span>
<a href="#l5.33"></a><span id="l5.33">   {</span>
<a href="#l5.34"></a><span id="l5.34">     if ( (!PL_strncasecmp(line, &quot;Subject: &quot;, 9)) &amp;&amp; (obj-&gt;parent) )</span>
<a href="#l5.35"></a><span id="l5.35">     {</span>
<a href="#l5.36"></a><span id="l5.36">       if ( (obj-&gt;headers) &amp;&amp; (!obj-&gt;headers-&gt;munged_subject) )</span>
<a href="#l5.37"></a><span id="l5.37">       {</span>
<a href="#l5.38"></a><span id="l5.38">         obj-&gt;headers-&gt;munged_subject = (char *) PL_strndup(line + 9, length - 9);</span>
<a href="#l5.39"></a><span id="l5.39">         char *tPtr = obj-&gt;headers-&gt;munged_subject;</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineat">@@ -182,17 +185,17 @@ MimeMessage_parse_line (const char *aLin</span>
<a href="#l5.41"></a><span id="l5.41">    */</span>
<a href="#l5.42"></a><span id="l5.42">   if (msg-&gt;container.nchildren)</span>
<a href="#l5.43"></a><span id="l5.43">   {</span>
<a href="#l5.44"></a><span id="l5.44">     MimeObject *kid = msg-&gt;container.children[0];</span>
<a href="#l5.45"></a><span id="l5.45">     bool nl;</span>
<a href="#l5.46"></a><span id="l5.46">     PR_ASSERT(kid);</span>
<a href="#l5.47"></a><span id="l5.47">     if (!kid) return -1;</span>
<a href="#l5.48"></a><span id="l5.48"> </span>
<a href="#l5.49"></a><span id="l5.49" class="difflineminus">-          msg-&gt;bodyLength += length;</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+    msg-&gt;bodyLength += length;</span>
<a href="#l5.51"></a><span id="l5.51"> </span>
<a href="#l5.52"></a><span id="l5.52">     /* Don't allow MimeMessage objects to not end in a newline, since it</span>
<a href="#l5.53"></a><span id="l5.53">      would be inappropriate for any following part to appear on the same</span>
<a href="#l5.54"></a><span id="l5.54">      line as the last line of the message.</span>
<a href="#l5.55"></a><span id="l5.55"> </span>
<a href="#l5.56"></a><span id="l5.56">      #### This assumes that the only time the `parse_line' method is</span>
<a href="#l5.57"></a><span id="l5.57">      called with a line that doesn't end in a newline is when that line</span>
<a href="#l5.58"></a><span id="l5.58">      is the last line.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/mime/src/mimemsg.h</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/mime/src/mimemsg.h</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -59,12 +59,14 @@ struct MimeMessage {</span>
<a href="#l6.4"></a><span id="l6.4">   bool newline_p;      /* whether the last line ended in a newline */</span>
<a href="#l6.5"></a><span id="l6.5">   bool crypto_stamped_p;    /* whether the header of this message has been</span>
<a href="#l6.6"></a><span id="l6.6">                    emitted expecting its child to emit HTML</span>
<a href="#l6.7"></a><span id="l6.7">                    which says that it is xlated. */</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9">   bool crypto_msg_signed_p;  /* What the emitted xlation-stamp *says*. */</span>
<a href="#l6.10"></a><span id="l6.10">   bool crypto_msg_encrypted_p;</span>
<a href="#l6.11"></a><span id="l6.11">   bool grabSubject;  /* Should we try to grab the subject of this message */</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  PRInt32 bodyLength;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+  PRInt32 bodyLength; /* Used for determining if the body has been truncated */</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+  PRInt32 sizeSoFar; /* The total size of the MIME message, once parsing is</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+                        finished. */</span>
<a href="#l6.16"></a><span id="l6.16"> };</span>
<a href="#l6.17"></a><span id="l6.17"> </span>
<a href="#l6.18"></a><span id="l6.18"> #endif /* _MIMEMSG_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/mime/test/unit/test_attachment_size.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/mime/test/unit/test_attachment_size.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -112,16 +112,42 @@ const yencSize = 174;</span>
<a href="#l7.4"></a><span id="l7.4"> </span>
<a href="#l7.5"></a><span id="l7.5"> const partHtml = new SyntheticPartLeaf(</span>
<a href="#l7.6"></a><span id="l7.6">   &quot;&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;I am HTML! Woo! &lt;/body&gt;&lt;/html&gt;&quot;,</span>
<a href="#l7.7"></a><span id="l7.7">   {</span>
<a href="#l7.8"></a><span id="l7.8">     contentType: &quot;text/html&quot;</span>
<a href="#l7.9"></a><span id="l7.9">   }</span>
<a href="#l7.10"></a><span id="l7.10"> );</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+let attachedMessage1 = msgGen.makeMessage({ body: { body: textAttachment } });</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+let attachedMessage2 = msgGen.makeMessage({</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+  body: { body: textAttachment },</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+  attachments: [{ body: imageAttachment,</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+                  contentType: 'application/x-ubik',</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+                  filename: 'ubik',</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+                  encoding: 'base64',</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+                  format: '' }]</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+});</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+/**</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+ * Return the size of a synthetic message. Much like the above comment, libmime</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineplus">+ * counts bytes differently on Windows, where it counts newlines (\r\n) as 2</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+ * bytes. Mac and Linux treats them as 1 byte.</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineplus">+ *</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineplus">+ * @param message a synthetic message from makeMessage()</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+ * @return the message's size in bytes</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+ */</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+function get_message_size(message) {</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+  let messageString = message.toMessageString();</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+  if (epsilon == 4) // Windows</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+    return messageString.length;</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+  else // Mac/Linux</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+    return messageString.replace(/\r\n/g, &quot;\n&quot;).length;</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+}</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+</span>
<a href="#l7.38"></a><span id="l7.38"> // create some messages that have various types of attachments</span>
<a href="#l7.39"></a><span id="l7.39"> let messages = [</span>
<a href="#l7.40"></a><span id="l7.40">   // text attachment</span>
<a href="#l7.41"></a><span id="l7.41">   { attachments: [{ body: textAttachment,</span>
<a href="#l7.42"></a><span id="l7.42">                     filename: 'ubik.txt',</span>
<a href="#l7.43"></a><span id="l7.43">                     format: '' }],</span>
<a href="#l7.44"></a><span id="l7.44">     size: textAttachment.length },</span>
<a href="#l7.45"></a><span id="l7.45">   // (inline) image attachment</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineat">@@ -155,32 +181,27 @@ let messages = [</span>
<a href="#l7.47"></a><span id="l7.47">   { bodyPart: new SyntheticPartLeaf(&quot;I am text! Woo!\n\n&quot;+yencText,</span>
<a href="#l7.48"></a><span id="l7.48">                                     { contentType: '' } ),</span>
<a href="#l7.49"></a><span id="l7.49">     subject: &quot;yEnc-Prefix: \&quot;jane.doe\&quot; 174 yEnc bytes - yEnc test (1)&quot;,</span>
<a href="#l7.50"></a><span id="l7.50">     size: yencSize },</span>
<a href="#l7.51"></a><span id="l7.51">   // an attached eml that used to return a size that's -1</span>
<a href="#l7.52"></a><span id="l7.52">   {</span>
<a href="#l7.53"></a><span id="l7.53">     bodyPart: new SyntheticPartMultiMixed([</span>
<a href="#l7.54"></a><span id="l7.54">       partHtml,</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineminus">-      msgGen.makeMessage({ body: { body: textAttachment } }),</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+      attachedMessage1,</span>
<a href="#l7.57"></a><span id="l7.57">     ]),</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineminus">-    size: textAttachment.length + 1,</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineplus">+    size: get_message_size(attachedMessage1),</span>
<a href="#l7.60"></a><span id="l7.60">   },</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineminus">-  // this is an attached message that has itself an attachment</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+  // this is an attached message that itself has an attachment</span>
<a href="#l7.63"></a><span id="l7.63">   {</span>
<a href="#l7.64"></a><span id="l7.64">     bodyPart: new SyntheticPartMultiMixed([</span>
<a href="#l7.65"></a><span id="l7.65">       partHtml,</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineminus">-      msgGen.makeMessage({ body: { body: textAttachment },</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineminus">-                           attachments: [{ body: imageAttachment,</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineminus">-                            contentType: 'application/x-ubik',</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineminus">-                            filename: 'ubik',</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineminus">-                            encoding: 'base64',</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineminus">-                            format: '' }] }),</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+      attachedMessage2,</span>
<a href="#l7.73"></a><span id="l7.73">     ]),</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineminus">-    size: textAttachment.length + imageSize,</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+    size: get_message_size(attachedMessage2),</span>
<a href="#l7.76"></a><span id="l7.76">   },</span>
<a href="#l7.77"></a><span id="l7.77">   // an &quot;attachment&quot; that's really the body of the message</span>
<a href="#l7.78"></a><span id="l7.78">   { body: { body: textAttachment,</span>
<a href="#l7.79"></a><span id="l7.79">             contentType: 'application/x-ubik; name=attachment.ubik' },</span>
<a href="#l7.80"></a><span id="l7.80">     size: textAttachment.length,</span>
<a href="#l7.81"></a><span id="l7.81">   },</span>
<a href="#l7.82"></a><span id="l7.82"> ];</span>
<a href="#l7.83"></a><span id="l7.83"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

