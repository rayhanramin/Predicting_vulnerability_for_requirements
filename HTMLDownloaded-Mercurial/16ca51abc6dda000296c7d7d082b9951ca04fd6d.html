<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 29148:16ca51abc6dda000296c7d7d082b9951ca04fd6d</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 16ca51abc6dda000296c7d7d082b9951ca04fd6d" />
<meta property="og:url" content="/comm-central/rev/16ca51abc6dda000296c7d7d082b9951ca04fd6d" />
<meta property="og:description" content="Bug 1614846 - Remove nsIArray use in nsIMsgAccountManager.allServers. r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 16ca51abc6dda000296c7d7d082b9951ca04fd6d 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/16ca51abc6dda000296c7d7d082b9951ca04fd6d">shortlog</a> |
<a href="/comm-central/log/16ca51abc6dda000296c7d7d082b9951ca04fd6d">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/16ca51abc6dda000296c7d7d082b9951ca04fd6d">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/16ca51abc6dda000296c7d7d082b9951ca04fd6d">files</a> |
changeset |
<a href="/comm-central/raw-rev/16ca51abc6dda000296c7d7d082b9951ca04fd6d">raw</a>  | <a href="/comm-central/archive/16ca51abc6dda000296c7d7d082b9951ca04fd6d.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1614846">Bug 1614846</a> - Remove nsIArray use in nsIMsgAccountManager.allServers. r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#66;&#101;&#110;&#32;&#67;&#97;&#109;&#112;&#98;&#101;&#108;&#108;&#32;&#60;&#98;&#101;&#110;&#99;&#64;&#116;&#104;&#117;&#110;&#100;&#101;&#114;&#98;&#105;&#114;&#100;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Sat, 28 Mar 2020 07:53:42 +1300</td></tr>

<tr>
 <td>changeset 29148</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/16ca51abc6dda000296c7d7d082b9951ca04fd6d">16ca51abc6dda000296c7d7d082b9951ca04fd6d</a></td>
</tr>



<tr>
<td>parent 29147</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/f91579666b7a560981d4d2305bf286896581375e">f91579666b7a560981d4d2305bf286896581375e</a>
</td>
</tr>

<tr>
<td>child 29149</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/03cfd777e6359f5628d750985da7c4c5d5c45935">03cfd777e6359f5628d750985da7c4c5d5c45935</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=16ca51abc6dda000296c7d7d082b9951ca04fd6d">17224</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Wed, 01 Apr 2020 03:34:17 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@16ca51abc6dd [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=16ca51abc6dda000296c7d7d082b9951ca04fd6d">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=16ca51abc6dda000296c7d7d082b9951ca04fd6d&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=16ca51abc6dda000296c7d7d082b9951ca04fd6d&newProject=comm-central&newRevision=b2b96ec63aff658f33e49832cd828aaf19d80a94&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=16ca51abc6dda000296c7d7d082b9951ca04fd6d&newProject=comm-central&newRevision=b2b96ec63aff658f33e49832cd828aaf19d80a94&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=16ca51abc6dda000296c7d7d082b9951ca04fd6d&newProject=comm-central&newRevision=b2b96ec63aff658f33e49832cd828aaf19d80a94&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1614846">1614846</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1614846">Bug 1614846</a> - Remove nsIArray use in nsIMsgAccountManager.allServers. r=mkmelin</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/content/FilterListDialog.js">mail/base/content/FilterListDialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/content/FilterListDialog.js">file</a> |
<a href="/comm-central/annotate/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/content/FilterListDialog.js">annotate</a> |
<a href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/content/FilterListDialog.js">diff</a> |
<a href="/comm-central/comparison/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/content/FilterListDialog.js">comparison</a> |
<a href="/comm-central/log/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/content/FilterListDialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/content/folderPane.js">mail/base/content/folderPane.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/content/folderPane.js">file</a> |
<a href="/comm-central/annotate/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/content/folderPane.js">annotate</a> |
<a href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/content/folderPane.js">diff</a> |
<a href="/comm-central/comparison/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/content/folderPane.js">comparison</a> |
<a href="/comm-central/log/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/content/folderPane.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/content/mail3PaneWindowCommands.js">mail/base/content/mail3PaneWindowCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/content/mail3PaneWindowCommands.js">file</a> |
<a href="/comm-central/annotate/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/content/mail3PaneWindowCommands.js">annotate</a> |
<a href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/content/mail3PaneWindowCommands.js">diff</a> |
<a href="/comm-central/comparison/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/content/mail3PaneWindowCommands.js">comparison</a> |
<a href="/comm-central/log/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/content/mail3PaneWindowCommands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/content/mailContextMenus.js">mail/base/content/mailContextMenus.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/content/mailContextMenus.js">file</a> |
<a href="/comm-central/annotate/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/content/mailContextMenus.js">annotate</a> |
<a href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/content/mailContextMenus.js">diff</a> |
<a href="/comm-central/comparison/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/content/mailContextMenus.js">comparison</a> |
<a href="/comm-central/log/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/content/mailContextMenus.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/content/mailWindowOverlay.js">mail/base/content/mailWindowOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/content/mailWindowOverlay.js">file</a> |
<a href="/comm-central/annotate/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/content/mailWindowOverlay.js">annotate</a> |
<a href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/content/mailWindowOverlay.js">diff</a> |
<a href="/comm-central/comparison/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/content/mailWindowOverlay.js">comparison</a> |
<a href="/comm-central/log/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/content/mailWindowOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/content/msgMail3PaneWindow.js">mail/base/content/msgMail3PaneWindow.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/content/msgMail3PaneWindow.js">file</a> |
<a href="/comm-central/annotate/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/content/msgMail3PaneWindow.js">annotate</a> |
<a href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/content/msgMail3PaneWindow.js">diff</a> |
<a href="/comm-central/comparison/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/content/msgMail3PaneWindow.js">comparison</a> |
<a href="/comm-central/log/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/content/msgMail3PaneWindow.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/modules/MailMigrator.jsm">mail/base/modules/MailMigrator.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/modules/MailMigrator.jsm">file</a> |
<a href="/comm-central/annotate/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/modules/MailMigrator.jsm">annotate</a> |
<a href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/modules/MailMigrator.jsm">diff</a> |
<a href="/comm-central/comparison/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/modules/MailMigrator.jsm">comparison</a> |
<a href="/comm-central/log/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/modules/MailMigrator.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/modules/MailUtils.jsm">mail/base/modules/MailUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/modules/MailUtils.jsm">file</a> |
<a href="/comm-central/annotate/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/modules/MailUtils.jsm">annotate</a> |
<a href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/modules/MailUtils.jsm">diff</a> |
<a href="/comm-central/comparison/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/modules/MailUtils.jsm">comparison</a> |
<a href="/comm-central/log/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/base/modules/MailUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/components/search/SearchIntegration.jsm">mail/components/search/SearchIntegration.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/components/search/SearchIntegration.jsm">file</a> |
<a href="/comm-central/annotate/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/components/search/SearchIntegration.jsm">annotate</a> |
<a href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/components/search/SearchIntegration.jsm">diff</a> |
<a href="/comm-central/comparison/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/components/search/SearchIntegration.jsm">comparison</a> |
<a href="/comm-central/log/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mail/components/search/SearchIntegration.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/prefs/content/AccountManager.js">mailnews/base/prefs/content/AccountManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/prefs/content/AccountManager.js">file</a> |
<a href="/comm-central/annotate/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/prefs/content/AccountManager.js">annotate</a> |
<a href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/prefs/content/AccountManager.js">diff</a> |
<a href="/comm-central/comparison/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/prefs/content/AccountManager.js">comparison</a> |
<a href="/comm-central/log/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/prefs/content/AccountManager.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/public/nsIMsgAccountManager.idl">mailnews/base/public/nsIMsgAccountManager.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/public/nsIMsgAccountManager.idl">file</a> |
<a href="/comm-central/annotate/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/public/nsIMsgAccountManager.idl">annotate</a> |
<a href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/public/nsIMsgAccountManager.idl">diff</a> |
<a href="/comm-central/comparison/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/public/nsIMsgAccountManager.idl">comparison</a> |
<a href="/comm-central/log/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/public/nsIMsgAccountManager.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/search/src/PeriodicFilterManager.jsm">mailnews/base/search/src/PeriodicFilterManager.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/search/src/PeriodicFilterManager.jsm">file</a> |
<a href="/comm-central/annotate/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/search/src/PeriodicFilterManager.jsm">annotate</a> |
<a href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/search/src/PeriodicFilterManager.jsm">diff</a> |
<a href="/comm-central/comparison/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/search/src/PeriodicFilterManager.jsm">comparison</a> |
<a href="/comm-central/log/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/search/src/PeriodicFilterManager.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/src/MailNotificationService.jsm">mailnews/base/src/MailNotificationService.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/src/MailNotificationService.jsm">file</a> |
<a href="/comm-central/annotate/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/src/MailNotificationService.jsm">annotate</a> |
<a href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/src/MailNotificationService.jsm">diff</a> |
<a href="/comm-central/comparison/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/src/MailNotificationService.jsm">comparison</a> |
<a href="/comm-central/log/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/src/MailNotificationService.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/src/nsMsgAccountManager.cpp">mailnews/base/src/nsMsgAccountManager.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/src/nsMsgAccountManager.cpp">file</a> |
<a href="/comm-central/annotate/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/src/nsMsgAccountManager.cpp">annotate</a> |
<a href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/src/nsMsgAccountManager.cpp">diff</a> |
<a href="/comm-central/comparison/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/src/nsMsgAccountManager.cpp">comparison</a> |
<a href="/comm-central/log/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/src/nsMsgAccountManager.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/src/nsMsgPurgeService.cpp">mailnews/base/src/nsMsgPurgeService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/src/nsMsgPurgeService.cpp">file</a> |
<a href="/comm-central/annotate/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/src/nsMsgPurgeService.cpp">annotate</a> |
<a href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/src/nsMsgPurgeService.cpp">diff</a> |
<a href="/comm-central/comparison/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/src/nsMsgPurgeService.cpp">comparison</a> |
<a href="/comm-central/log/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/src/nsMsgPurgeService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/test/unit/test_accountMgr2.js">mailnews/base/test/unit/test_accountMgr2.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/test/unit/test_accountMgr2.js">file</a> |
<a href="/comm-central/annotate/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/test/unit/test_accountMgr2.js">annotate</a> |
<a href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/test/unit/test_accountMgr2.js">diff</a> |
<a href="/comm-central/comparison/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/test/unit/test_accountMgr2.js">comparison</a> |
<a href="/comm-central/log/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/test/unit/test_accountMgr2.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/util/nsMsgDBFolder.cpp">mailnews/base/util/nsMsgDBFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/util/nsMsgDBFolder.cpp">file</a> |
<a href="/comm-central/annotate/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/util/nsMsgDBFolder.cpp">annotate</a> |
<a href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/util/nsMsgDBFolder.cpp">diff</a> |
<a href="/comm-central/comparison/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/util/nsMsgDBFolder.cpp">comparison</a> |
<a href="/comm-central/log/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/util/nsMsgDBFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/util/nsMsgIncomingServer.cpp">mailnews/base/util/nsMsgIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/util/nsMsgIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/util/nsMsgIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/util/nsMsgIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/util/nsMsgIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/base/util/nsMsgIncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/compose/src/nsSmtpServer.cpp">mailnews/compose/src/nsSmtpServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/compose/src/nsSmtpServer.cpp">file</a> |
<a href="/comm-central/annotate/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/compose/src/nsSmtpServer.cpp">annotate</a> |
<a href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/compose/src/nsSmtpServer.cpp">diff</a> |
<a href="/comm-central/comparison/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/compose/src/nsSmtpServer.cpp">comparison</a> |
<a href="/comm-central/log/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/compose/src/nsSmtpServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/extensions/newsblog/content/FeedUtils.jsm">mailnews/extensions/newsblog/content/FeedUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/extensions/newsblog/content/FeedUtils.jsm">file</a> |
<a href="/comm-central/annotate/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/extensions/newsblog/content/FeedUtils.jsm">annotate</a> |
<a href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/extensions/newsblog/content/FeedUtils.jsm">diff</a> |
<a href="/comm-central/comparison/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/extensions/newsblog/content/FeedUtils.jsm">comparison</a> |
<a href="/comm-central/log/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/extensions/newsblog/content/FeedUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/imap/src/nsImapOfflineSync.cpp">mailnews/imap/src/nsImapOfflineSync.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/imap/src/nsImapOfflineSync.cpp">file</a> |
<a href="/comm-central/annotate/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/imap/src/nsImapOfflineSync.cpp">annotate</a> |
<a href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/imap/src/nsImapOfflineSync.cpp">diff</a> |
<a href="/comm-central/comparison/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/imap/src/nsImapOfflineSync.cpp">comparison</a> |
<a href="/comm-central/log/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/imap/src/nsImapOfflineSync.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/imap/src/nsImapOfflineSync.h">mailnews/imap/src/nsImapOfflineSync.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/imap/src/nsImapOfflineSync.h">file</a> |
<a href="/comm-central/annotate/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/imap/src/nsImapOfflineSync.h">annotate</a> |
<a href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/imap/src/nsImapOfflineSync.h">diff</a> |
<a href="/comm-central/comparison/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/imap/src/nsImapOfflineSync.h">comparison</a> |
<a href="/comm-central/log/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/imap/src/nsImapOfflineSync.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/news/src/nsNewsDownloader.cpp">mailnews/news/src/nsNewsDownloader.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/news/src/nsNewsDownloader.cpp">file</a> |
<a href="/comm-central/annotate/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/news/src/nsNewsDownloader.cpp">annotate</a> |
<a href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/news/src/nsNewsDownloader.cpp">diff</a> |
<a href="/comm-central/comparison/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/news/src/nsNewsDownloader.cpp">comparison</a> |
<a href="/comm-central/log/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/news/src/nsNewsDownloader.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/news/src/nsNewsDownloader.h">mailnews/news/src/nsNewsDownloader.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/news/src/nsNewsDownloader.h">file</a> |
<a href="/comm-central/annotate/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/news/src/nsNewsDownloader.h">annotate</a> |
<a href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/news/src/nsNewsDownloader.h">diff</a> |
<a href="/comm-central/comparison/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/news/src/nsNewsDownloader.h">comparison</a> |
<a href="/comm-central/log/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/news/src/nsNewsDownloader.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/news/src/nsNntpService.cpp">mailnews/news/src/nsNntpService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/news/src/nsNntpService.cpp">file</a> |
<a href="/comm-central/annotate/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/news/src/nsNntpService.cpp">annotate</a> |
<a href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/news/src/nsNntpService.cpp">diff</a> |
<a href="/comm-central/comparison/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/news/src/nsNntpService.cpp">comparison</a> |
<a href="/comm-central/log/16ca51abc6dda000296c7d7d082b9951ca04fd6d/mailnews/news/src/nsNntpService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/suite/mailnews/content/FilterListDialog.js">suite/mailnews/content/FilterListDialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/16ca51abc6dda000296c7d7d082b9951ca04fd6d/suite/mailnews/content/FilterListDialog.js">file</a> |
<a href="/comm-central/annotate/16ca51abc6dda000296c7d7d082b9951ca04fd6d/suite/mailnews/content/FilterListDialog.js">annotate</a> |
<a href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/suite/mailnews/content/FilterListDialog.js">diff</a> |
<a href="/comm-central/comparison/16ca51abc6dda000296c7d7d082b9951ca04fd6d/suite/mailnews/content/FilterListDialog.js">comparison</a> |
<a href="/comm-central/log/16ca51abc6dda000296c7d7d082b9951ca04fd6d/suite/mailnews/content/FilterListDialog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/suite/mailnews/content/mail3PaneWindowCommands.js">suite/mailnews/content/mail3PaneWindowCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/16ca51abc6dda000296c7d7d082b9951ca04fd6d/suite/mailnews/content/mail3PaneWindowCommands.js">file</a> |
<a href="/comm-central/annotate/16ca51abc6dda000296c7d7d082b9951ca04fd6d/suite/mailnews/content/mail3PaneWindowCommands.js">annotate</a> |
<a href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/suite/mailnews/content/mail3PaneWindowCommands.js">diff</a> |
<a href="/comm-central/comparison/16ca51abc6dda000296c7d7d082b9951ca04fd6d/suite/mailnews/content/mail3PaneWindowCommands.js">comparison</a> |
<a href="/comm-central/log/16ca51abc6dda000296c7d7d082b9951ca04fd6d/suite/mailnews/content/mail3PaneWindowCommands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/suite/mailnews/content/mailContextMenus.js">suite/mailnews/content/mailContextMenus.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/16ca51abc6dda000296c7d7d082b9951ca04fd6d/suite/mailnews/content/mailContextMenus.js">file</a> |
<a href="/comm-central/annotate/16ca51abc6dda000296c7d7d082b9951ca04fd6d/suite/mailnews/content/mailContextMenus.js">annotate</a> |
<a href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/suite/mailnews/content/mailContextMenus.js">diff</a> |
<a href="/comm-central/comparison/16ca51abc6dda000296c7d7d082b9951ca04fd6d/suite/mailnews/content/mailContextMenus.js">comparison</a> |
<a href="/comm-central/log/16ca51abc6dda000296c7d7d082b9951ca04fd6d/suite/mailnews/content/mailContextMenus.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/suite/mailnews/content/mailTasksOverlay.js">suite/mailnews/content/mailTasksOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/16ca51abc6dda000296c7d7d082b9951ca04fd6d/suite/mailnews/content/mailTasksOverlay.js">file</a> |
<a href="/comm-central/annotate/16ca51abc6dda000296c7d7d082b9951ca04fd6d/suite/mailnews/content/mailTasksOverlay.js">annotate</a> |
<a href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/suite/mailnews/content/mailTasksOverlay.js">diff</a> |
<a href="/comm-central/comparison/16ca51abc6dda000296c7d7d082b9951ca04fd6d/suite/mailnews/content/mailTasksOverlay.js">comparison</a> |
<a href="/comm-central/log/16ca51abc6dda000296c7d7d082b9951ca04fd6d/suite/mailnews/content/mailTasksOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/suite/mailnews/modules/MailUtils.js">suite/mailnews/modules/MailUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/16ca51abc6dda000296c7d7d082b9951ca04fd6d/suite/mailnews/modules/MailUtils.js">file</a> |
<a href="/comm-central/annotate/16ca51abc6dda000296c7d7d082b9951ca04fd6d/suite/mailnews/modules/MailUtils.js">annotate</a> |
<a href="/comm-central/diff/16ca51abc6dda000296c7d7d082b9951ca04fd6d/suite/mailnews/modules/MailUtils.js">diff</a> |
<a href="/comm-central/comparison/16ca51abc6dda000296c7d7d082b9951ca04fd6d/suite/mailnews/modules/MailUtils.js">comparison</a> |
<a href="/comm-central/log/16ca51abc6dda000296c7d7d082b9951ca04fd6d/suite/mailnews/modules/MailUtils.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/FilterListDialog.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/FilterListDialog.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1,19 +1,16 @@</span>
<a href="#l1.4"></a><span id="l1.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l1.5"></a><span id="l1.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.6"></a><span id="l1.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.7"></a><span id="l1.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9"> var { PluralForm } = ChromeUtils.import(</span>
<a href="#l1.10"></a><span id="l1.10">   &quot;resource://gre/modules/PluralForm.jsm&quot;</span>
<a href="#l1.11"></a><span id="l1.11"> );</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-var { fixIterator } = ChromeUtils.import(</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-  &quot;resource:///modules/iteratorUtils.jsm&quot;</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-);</span>
<a href="#l1.15"></a><span id="l1.15"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l1.16"></a><span id="l1.16"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l1.17"></a><span id="l1.17">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l1.18"></a><span id="l1.18"> );</span>
<a href="#l1.19"></a><span id="l1.19"> </span>
<a href="#l1.20"></a><span id="l1.20"> var gFilterListMsgWindow = null;</span>
<a href="#l1.21"></a><span id="l1.21"> var gCurrentFilterList;</span>
<a href="#l1.22"></a><span id="l1.22"> var gServerMenu = null;</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineat">@@ -964,24 +961,17 @@ function getServerThatCanHaveFilters() {</span>
<a href="#l1.24"></a><span id="l1.24">     // Check to see if default server can have filters.</span>
<a href="#l1.25"></a><span id="l1.25">     if (defaultIncomingServer.canHaveFilters) {</span>
<a href="#l1.26"></a><span id="l1.26">       return defaultIncomingServer;</span>
<a href="#l1.27"></a><span id="l1.27">     }</span>
<a href="#l1.28"></a><span id="l1.28">   }</span>
<a href="#l1.29"></a><span id="l1.29"> </span>
<a href="#l1.30"></a><span id="l1.30">   // If it cannot, check all accounts to find a server</span>
<a href="#l1.31"></a><span id="l1.31">   // that can have filters.</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-  let allServers = MailServices.accounts.allServers;</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-  for (let currentServer of fixIterator(allServers, Ci.nsIMsgIncomingServer)) {</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-    if (currentServer.canHaveFilters) {</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">-      return currentServer;</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineminus">-    }</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-  }</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-  return null;</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+  return MailServices.accounts.allServers.find(server =&gt; server.canHaveFilters);</span>
<a href="#l1.41"></a><span id="l1.41"> }</span>
<a href="#l1.42"></a><span id="l1.42"> </span>
<a href="#l1.43"></a><span id="l1.43"> function onFilterClick(event) {</span>
<a href="#l1.44"></a><span id="l1.44">   // This is called after the clicked checkbox changed state</span>
<a href="#l1.45"></a><span id="l1.45">   // so this.checked is the right state we want to toggle to.</span>
<a href="#l1.46"></a><span id="l1.46">   toggleFilter(this.parentNode, this.checked);</span>
<a href="#l1.47"></a><span id="l1.47"> }</span>
<a href="#l1.48"></a><span id="l1.48"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/content/folderPane.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/content/folderPane.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -2310,20 +2310,17 @@ var gFolderTreeView = {</span>
<a href="#l2.4"></a><span id="l2.4">   },</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6">   /**</span>
<a href="#l2.7"></a><span id="l2.7">    * This is a helper attribute that simply returns a flat list of all folders</span>
<a href="#l2.8"></a><span id="l2.8">    */</span>
<a href="#l2.9"></a><span id="l2.9">   get _enumerateFolders() {</span>
<a href="#l2.10"></a><span id="l2.10">     let folders = [];</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-    for (let server of fixIterator(</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-      MailServices.accounts.allServers,</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-      Ci.nsIMsgIncomingServer</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-    )) {</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+    for (let server of MailServices.accounts.allServers) {</span>
<a href="#l2.17"></a><span id="l2.17">       // Skip deferred accounts</span>
<a href="#l2.18"></a><span id="l2.18">       if (</span>
<a href="#l2.19"></a><span id="l2.19">         server instanceof Ci.nsIPop3IncomingServer &amp;&amp;</span>
<a href="#l2.20"></a><span id="l2.20">         server.deferredToAccount</span>
<a href="#l2.21"></a><span id="l2.21">       ) {</span>
<a href="#l2.22"></a><span id="l2.22">         continue;</span>
<a href="#l2.23"></a><span id="l2.23">       }</span>
<a href="#l2.24"></a><span id="l2.24"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/base/content/mail3PaneWindowCommands.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/base/content/mail3PaneWindowCommands.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1344,18 +1344,17 @@ function IsSendUnsentMsgsEnabled(unsentM</span>
<a href="#l3.4"></a><span id="l3.4"> }</span>
<a href="#l3.5"></a><span id="l3.5"> </span>
<a href="#l3.6"></a><span id="l3.6"> /**</span>
<a href="#l3.7"></a><span id="l3.7">  * Determine whether there exists any server for which to show the Subscribe dialog.</span>
<a href="#l3.8"></a><span id="l3.8">  */</span>
<a href="#l3.9"></a><span id="l3.9"> function IsSubscribeEnabled() {</span>
<a href="#l3.10"></a><span id="l3.10">   // If there are any IMAP or News servers, we can show the dialog any time and</span>
<a href="#l3.11"></a><span id="l3.11">   // it will properly show those.</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  let servers = MailServices.accounts.allServers;</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-  for (let server of fixIterator(servers, Ci.nsIMsgIncomingServer)) {</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+  for (let server of MailServices.accounts.allServers) {</span>
<a href="#l3.15"></a><span id="l3.15">     if (server.type == &quot;imap&quot; || server.type == &quot;nntp&quot;) {</span>
<a href="#l3.16"></a><span id="l3.16">       return true;</span>
<a href="#l3.17"></a><span id="l3.17">     }</span>
<a href="#l3.18"></a><span id="l3.18">   }</span>
<a href="#l3.19"></a><span id="l3.19"> </span>
<a href="#l3.20"></a><span id="l3.20">   // RSS accounts use a separate Subscribe dialog that we can only show when</span>
<a href="#l3.21"></a><span id="l3.21">   // such an account is selected.</span>
<a href="#l3.22"></a><span id="l3.22">   let preselectedFolder = GetFirstSelectedMsgFolder();</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineat">@@ -1491,21 +1490,18 @@ function SetFocusMessagePane() {</span>
<a href="#l3.24"></a><span id="l3.24"> //</span>
<a href="#l3.25"></a><span id="l3.25"> function CanRenameDeleteJunkMail(aFolderUri) {</span>
<a href="#l3.26"></a><span id="l3.26">   if (!aFolderUri) {</span>
<a href="#l3.27"></a><span id="l3.27">     return false;</span>
<a href="#l3.28"></a><span id="l3.28">   }</span>
<a href="#l3.29"></a><span id="l3.29"> </span>
<a href="#l3.30"></a><span id="l3.30">   // Go through junk mail settings for all servers and see if the folder is set/used by anyone.</span>
<a href="#l3.31"></a><span id="l3.31">   try {</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-    var allServers = accountManager.allServers;</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-    for (var i = 0; i &lt; allServers.length; i++) {</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-      var currentServer = allServers.queryElementAt(i, Ci.nsIMsgIncomingServer);</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">-      var settings = currentServer.spamSettings;</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+    for (let server of MailServices.accounts.allServers) {</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+      var settings = server.spamSettings;</span>
<a href="#l3.39"></a><span id="l3.39">       // If junk mail control or move junk mail to folder option is disabled then</span>
<a href="#l3.40"></a><span id="l3.40">       // allow the folder to be removed/renamed since the folder is not used in this case.</span>
<a href="#l3.41"></a><span id="l3.41">       if (!settings.level || !settings.moveOnSpam) {</span>
<a href="#l3.42"></a><span id="l3.42">         continue;</span>
<a href="#l3.43"></a><span id="l3.43">       }</span>
<a href="#l3.44"></a><span id="l3.44">       if (settings.spamFolderURI == aFolderUri) {</span>
<a href="#l3.45"></a><span id="l3.45">         return false;</span>
<a href="#l3.46"></a><span id="l3.46">       }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/base/content/mailContextMenus.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/base/content/mailContextMenus.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -201,33 +201,30 @@ function OpenMessageForMessageId(message</span>
<a href="#l4.4"></a><span id="l4.4">   // first search in current folder for message id</span>
<a href="#l4.5"></a><span id="l4.5">   let messageHeader = CheckForMessageIdInFolder(</span>
<a href="#l4.6"></a><span id="l4.6">     msgWindow.openFolder,</span>
<a href="#l4.7"></a><span id="l4.7">     messageId</span>
<a href="#l4.8"></a><span id="l4.8">   );</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10">   // if message id not found in current folder search in all folders</span>
<a href="#l4.11"></a><span id="l4.11">   if (!messageHeader) {</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-    let allServers = MailServices.accounts.allServers;</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-</span>
<a href="#l4.14"></a><span id="l4.14">     messageHeader = SearchForMessageIdInSubFolder(</span>
<a href="#l4.15"></a><span id="l4.15">       startServer.rootFolder,</span>
<a href="#l4.16"></a><span id="l4.16">       messageId</span>
<a href="#l4.17"></a><span id="l4.17">     );</span>
<a href="#l4.18"></a><span id="l4.18"> </span>
<a href="#l4.19"></a><span id="l4.19" class="difflineminus">-    for (let i = 0; i &lt; allServers.length &amp;&amp; !messageHeader; i++) {</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineminus">-      let currentServer = allServers.queryElementAt(i, Ci.nsIMsgIncomingServer);</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+    for (let server of MailServices.accounts.allServers) {</span>
<a href="#l4.22"></a><span id="l4.22">       if (</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineminus">-        currentServer &amp;&amp;</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineminus">-        startServer != currentServer &amp;&amp;</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineminus">-        currentServer.canSearchMessages &amp;&amp;</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineminus">-        !currentServer.isDeferredTo</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+        server &amp;&amp;</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+        startServer != server &amp;&amp;</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+        server.canSearchMessages &amp;&amp;</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+        !server.isDeferredTo</span>
<a href="#l4.31"></a><span id="l4.31">       ) {</span>
<a href="#l4.32"></a><span id="l4.32">         messageHeader = SearchForMessageIdInSubFolder(</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-          currentServer.rootFolder,</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+          server.rootFolder,</span>
<a href="#l4.35"></a><span id="l4.35">           messageId</span>
<a href="#l4.36"></a><span id="l4.36">         );</span>
<a href="#l4.37"></a><span id="l4.37">       }</span>
<a href="#l4.38"></a><span id="l4.38">     }</span>
<a href="#l4.39"></a><span id="l4.39">   }</span>
<a href="#l4.40"></a><span id="l4.40">   window.setCursor(&quot;auto&quot;);</span>
<a href="#l4.41"></a><span id="l4.41"> </span>
<a href="#l4.42"></a><span id="l4.42">   // if message id was found open corresponding message</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/base/content/mailWindowOverlay.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/base/content/mailWindowOverlay.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1858,48 +1858,40 @@ function MsgPauseUpdates(aMenuitem) {</span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5">   let pause = aMenuitem.getAttribute(&quot;checked&quot;) == &quot;true&quot;;</span>
<a href="#l5.6"></a><span id="l5.6">   FeedUtils.pauseFeedFolderUpdates(folder, pause, true);</span>
<a href="#l5.7"></a><span id="l5.7"> }</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9"> function MsgGetMessagesForAllServers(defaultServer) {</span>
<a href="#l5.10"></a><span id="l5.10">   // now log into any server</span>
<a href="#l5.11"></a><span id="l5.11">   try {</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-    var allServers = accountManager.allServers;</span>
<a href="#l5.13"></a><span id="l5.13">     // Array of arrays of servers for a particular folder.</span>
<a href="#l5.14"></a><span id="l5.14">     var pop3DownloadServersArray = [];</span>
<a href="#l5.15"></a><span id="l5.15">     // Parallel array of folders to download to...</span>
<a href="#l5.16"></a><span id="l5.16">     var localFoldersToDownloadTo = [];</span>
<a href="#l5.17"></a><span id="l5.17">     var pop3Server;</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineminus">-    for (let i = 0; i &lt; allServers.length; ++i) {</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineminus">-      var currentServer = allServers.queryElementAt(i, Ci.nsIMsgIncomingServer);</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineminus">-      if (</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineminus">-        currentServer.protocolInfo.canLoginAtStartUp &amp;&amp;</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineminus">-        currentServer.loginAtStartUp</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineminus">-      ) {</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+    for (let server of accountManager.allServers) {</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+      if (server.protocolInfo.canLoginAtStartUp &amp;&amp; server.loginAtStartUp) {</span>
<a href="#l5.26"></a><span id="l5.26">         if (</span>
<a href="#l5.27"></a><span id="l5.27">           defaultServer &amp;&amp;</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineminus">-          defaultServer.equals(currentServer) &amp;&amp;</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+          defaultServer.equals(server) &amp;&amp;</span>
<a href="#l5.30"></a><span id="l5.30">           !defaultServer.isDeferredTo &amp;&amp;</span>
<a href="#l5.31"></a><span id="l5.31">           defaultServer.rootFolder == defaultServer.rootMsgFolder</span>
<a href="#l5.32"></a><span id="l5.32">         ) {</span>
<a href="#l5.33"></a><span id="l5.33">           // skip, already opened</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-        } else if (</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">-          currentServer.type == &quot;pop3&quot; &amp;&amp;</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineminus">-          currentServer.downloadOnBiff</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineminus">-        ) {</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+        } else if (server.type == &quot;pop3&quot; &amp;&amp; server.downloadOnBiff) {</span>
<a href="#l5.39"></a><span id="l5.39">           CoalesceGetMsgsForPop3ServersByDestFolder(</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineminus">-            currentServer,</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+            server,</span>
<a href="#l5.42"></a><span id="l5.42">             pop3DownloadServersArray,</span>
<a href="#l5.43"></a><span id="l5.43">             localFoldersToDownloadTo</span>
<a href="#l5.44"></a><span id="l5.44">           );</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineminus">-          pop3Server = currentServer.QueryInterface(Ci.nsIPop3IncomingServer);</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+          pop3Server = server.QueryInterface(Ci.nsIPop3IncomingServer);</span>
<a href="#l5.47"></a><span id="l5.47">         } else {</span>
<a href="#l5.48"></a><span id="l5.48">           // Check to see if there are new messages on the server</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineminus">-          currentServer.performBiff(msgWindow);</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+          server.performBiff(msgWindow);</span>
<a href="#l5.51"></a><span id="l5.51">         }</span>
<a href="#l5.52"></a><span id="l5.52">       }</span>
<a href="#l5.53"></a><span id="l5.53">     }</span>
<a href="#l5.54"></a><span id="l5.54">     for (let i = 0; i &lt; pop3DownloadServersArray.length; ++i) {</span>
<a href="#l5.55"></a><span id="l5.55">       // Any ol' pop3Server will do - the serversArray specifies which servers</span>
<a href="#l5.56"></a><span id="l5.56">       // to download from.</span>
<a href="#l5.57"></a><span id="l5.57">       pop3Server.downloadMailFromServers(</span>
<a href="#l5.58"></a><span id="l5.58">         pop3DownloadServersArray[i],</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineat">@@ -2720,19 +2712,17 @@ function PrintEnginePrintPreview() {</span>
<a href="#l5.60"></a><span id="l5.60"> </span>
<a href="#l5.61"></a><span id="l5.61"> function IsMailFolderSelected() {</span>
<a href="#l5.62"></a><span id="l5.62">   var selectedFolders = GetSelectedMsgFolders();</span>
<a href="#l5.63"></a><span id="l5.63">   var folder = selectedFolders.length ? selectedFolders[0] : null;</span>
<a href="#l5.64"></a><span id="l5.64">   return folder &amp;&amp; folder.server.type != &quot;nntp&quot;;</span>
<a href="#l5.65"></a><span id="l5.65"> }</span>
<a href="#l5.66"></a><span id="l5.66"> </span>
<a href="#l5.67"></a><span id="l5.67"> function IsGetNewMessagesEnabled() {</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineminus">-  let allServers = accountManager.allServers;</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineminus">-  for (let i = 0; i &lt; allServers.length; ++i) {</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineminus">-    let server = allServers.queryElementAt(i, Ci.nsIMsgIncomingServer);</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+  for (let server of accountManager.allServers) {</span>
<a href="#l5.72"></a><span id="l5.72">     if (server.type == &quot;none&quot;) {</span>
<a href="#l5.73"></a><span id="l5.73">       continue;</span>
<a href="#l5.74"></a><span id="l5.74">     }</span>
<a href="#l5.75"></a><span id="l5.75">     return true;</span>
<a href="#l5.76"></a><span id="l5.76">   }</span>
<a href="#l5.77"></a><span id="l5.77">   return false;</span>
<a href="#l5.78"></a><span id="l5.78"> }</span>
<a href="#l5.79"></a><span id="l5.79"> </span>
<a href="#l5.80"></a><span id="l5.80" class="difflineat">@@ -2946,39 +2936,37 @@ function CoalesceGetMsgsForPop3ServersBy</span>
<a href="#l5.81"></a><span id="l5.81">     pop3DownloadServersArray.push([]);</span>
<a href="#l5.82"></a><span id="l5.82">   }</span>
<a href="#l5.83"></a><span id="l5.83">   pop3DownloadServersArray[index].push(currentServer);</span>
<a href="#l5.84"></a><span id="l5.84"> }</span>
<a href="#l5.85"></a><span id="l5.85"> </span>
<a href="#l5.86"></a><span id="l5.86"> function GetMessagesForAllAuthenticatedAccounts() {</span>
<a href="#l5.87"></a><span id="l5.87">   // now log into any server</span>
<a href="#l5.88"></a><span id="l5.88">   try {</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineminus">-    var allServers = accountManager.allServers;</span>
<a href="#l5.90"></a><span id="l5.90">     // Array of arrays of servers for a particular folder.</span>
<a href="#l5.91"></a><span id="l5.91">     var pop3DownloadServersArray = [];</span>
<a href="#l5.92"></a><span id="l5.92">     // parallel array of folders to download to...</span>
<a href="#l5.93"></a><span id="l5.93">     var localFoldersToDownloadTo = [];</span>
<a href="#l5.94"></a><span id="l5.94">     var pop3Server;</span>
<a href="#l5.95"></a><span id="l5.95"> </span>
<a href="#l5.96"></a><span id="l5.96" class="difflineminus">-    for (let i = 0; i &lt; allServers.length; ++i) {</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineminus">-      var currentServer = allServers.queryElementAt(i, Ci.nsIMsgIncomingServer);</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineplus">+    for (let server of accountManager.allServers) {</span>
<a href="#l5.99"></a><span id="l5.99">       if (</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineminus">-        currentServer.protocolInfo.canGetMessages &amp;&amp;</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineminus">-        !currentServer.passwordPromptRequired</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineplus">+        server.protocolInfo.canGetMessages &amp;&amp;</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineplus">+        !server.passwordPromptRequired</span>
<a href="#l5.104"></a><span id="l5.104">       ) {</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineminus">-        if (currentServer.type == &quot;pop3&quot;) {</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineplus">+        if (server.type == &quot;pop3&quot;) {</span>
<a href="#l5.107"></a><span id="l5.107">           CoalesceGetMsgsForPop3ServersByDestFolder(</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineminus">-            currentServer,</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineplus">+            server,</span>
<a href="#l5.110"></a><span id="l5.110">             pop3DownloadServersArray,</span>
<a href="#l5.111"></a><span id="l5.111">             localFoldersToDownloadTo</span>
<a href="#l5.112"></a><span id="l5.112">           );</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineminus">-          pop3Server = currentServer.QueryInterface(Ci.nsIPop3IncomingServer);</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineplus">+          pop3Server = server.QueryInterface(Ci.nsIPop3IncomingServer);</span>
<a href="#l5.115"></a><span id="l5.115">         } else {</span>
<a href="#l5.116"></a><span id="l5.116">           // get new messages on the server for imap or rss</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineminus">-          GetMessagesForInboxOnServer(currentServer);</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineplus">+          GetMessagesForInboxOnServer(server);</span>
<a href="#l5.119"></a><span id="l5.119">         }</span>
<a href="#l5.120"></a><span id="l5.120">       }</span>
<a href="#l5.121"></a><span id="l5.121">     }</span>
<a href="#l5.122"></a><span id="l5.122">     for (let i = 0; i &lt; pop3DownloadServersArray.length; ++i) {</span>
<a href="#l5.123"></a><span id="l5.123">       // any ol' pop3Server will do - the serversArray specifies which servers to download from</span>
<a href="#l5.124"></a><span id="l5.124">       pop3Server.downloadMailFromServers(</span>
<a href="#l5.125"></a><span id="l5.125">         pop3DownloadServersArray[i],</span>
<a href="#l5.126"></a><span id="l5.126">         msgWindow,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/base/content/msgMail3PaneWindow.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/base/content/msgMail3PaneWindow.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1466,23 +1466,19 @@ function MigrateJunkMailSettings() {</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5"> // The first time a user runs a build that supports folder views, pre-populate the favorite folders list</span>
<a href="#l6.6"></a><span id="l6.6"> // with the existing INBOX folders.</span>
<a href="#l6.7"></a><span id="l6.7"> function MigrateFolderViews() {</span>
<a href="#l6.8"></a><span id="l6.8">   var folderViewsVersion = Services.prefs.getIntPref(</span>
<a href="#l6.9"></a><span id="l6.9">     &quot;mail.folder.views.version&quot;</span>
<a href="#l6.10"></a><span id="l6.10">   );</span>
<a href="#l6.11"></a><span id="l6.11">   if (!folderViewsVersion) {</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-    var servers = accountManager.allServers;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-    var server;</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-    var inbox;</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-    for (var index = 0; index &lt; servers.length; index++) {</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-      server = servers.queryElementAt(index, Ci.nsIMsgIncomingServer);</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+    for (let server of accountManager.allServers) {</span>
<a href="#l6.18"></a><span id="l6.18">       if (server) {</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-        inbox = MailUtils.getInboxFolder(server);</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+        let inbox = MailUtils.getInboxFolder(server);</span>
<a href="#l6.21"></a><span id="l6.21">         if (inbox) {</span>
<a href="#l6.22"></a><span id="l6.22">           inbox.setFlag(Ci.nsMsgFolderFlags.Favorite);</span>
<a href="#l6.23"></a><span id="l6.23">         }</span>
<a href="#l6.24"></a><span id="l6.24">       }</span>
<a href="#l6.25"></a><span id="l6.25">     }</span>
<a href="#l6.26"></a><span id="l6.26">     Services.prefs.setIntPref(&quot;mail.folder.views.version&quot;, 1);</span>
<a href="#l6.27"></a><span id="l6.27">   }</span>
<a href="#l6.28"></a><span id="l6.28"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/base/modules/MailMigrator.jsm</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/base/modules/MailMigrator.jsm</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -496,19 +496,17 @@ var MailMigrator = {</span>
<a href="#l7.4"></a><span id="l7.4">    * The feeds and items migration are handled as separate (hopefully atomic)</span>
<a href="#l7.5"></a><span id="l7.5">    * steps. It is careful to not overwrite new-style .json files.</span>
<a href="#l7.6"></a><span id="l7.6">    *</span>
<a href="#l7.7"></a><span id="l7.7">    * @returns {void}</span>
<a href="#l7.8"></a><span id="l7.8">    */</span>
<a href="#l7.9"></a><span id="l7.9">   _migrateRSS() {</span>
<a href="#l7.10"></a><span id="l7.10">     // Find all the RSS IncomingServers.</span>
<a href="#l7.11"></a><span id="l7.11">     let rssServers = [];</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-    let allServers = MailServices.accounts.allServers;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-    for (let i = 0; i &lt; allServers.length; i++) {</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-      let server = allServers.queryElementAt(i, Ci.nsIMsgIncomingServer);</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+    for (let server of MailServices.accounts.allServers) {</span>
<a href="#l7.16"></a><span id="l7.16">       if (server &amp;&amp; server.type == &quot;rss&quot;) {</span>
<a href="#l7.17"></a><span id="l7.17">         rssServers.push(server);</span>
<a href="#l7.18"></a><span id="l7.18">       }</span>
<a href="#l7.19"></a><span id="l7.19">     }</span>
<a href="#l7.20"></a><span id="l7.20"> </span>
<a href="#l7.21"></a><span id="l7.21">     // For each one...</span>
<a href="#l7.22"></a><span id="l7.22">     for (let server of rssServers) {</span>
<a href="#l7.23"></a><span id="l7.23">       this._migrateRSSServer(server);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/base/modules/MailUtils.jsm</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/base/modules/MailUtils.jsm</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -25,18 +25,17 @@ var MC = MailConsts;</span>
<a href="#l8.4"></a><span id="l8.4">  */</span>
<a href="#l8.5"></a><span id="l8.5"> var MailUtils = {</span>
<a href="#l8.6"></a><span id="l8.6">   /**</span>
<a href="#l8.7"></a><span id="l8.7">    * Discover all folders. This is useful during startup, when you have code</span>
<a href="#l8.8"></a><span id="l8.8">    * that deals with folders and that executes before the main 3pane window is</span>
<a href="#l8.9"></a><span id="l8.9">    * open (the folder tree wouldn't have been initialized yet).</span>
<a href="#l8.10"></a><span id="l8.10">    */</span>
<a href="#l8.11"></a><span id="l8.11">   discoverFolders() {</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-    let servers = MailServices.accounts.allServers;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-    for (let server of fixIterator(servers, Ci.nsIMsgIncomingServer)) {</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+    for (let server of MailServices.accounts.allServers) {</span>
<a href="#l8.15"></a><span id="l8.15">       // Bug 466311 Sometimes this can throw file not found, we're unsure</span>
<a href="#l8.16"></a><span id="l8.16">       // why, but catch it and log the fact.</span>
<a href="#l8.17"></a><span id="l8.17">       try {</span>
<a href="#l8.18"></a><span id="l8.18">         server.rootFolder.subFolders;</span>
<a href="#l8.19"></a><span id="l8.19">       } catch (ex) {</span>
<a href="#l8.20"></a><span id="l8.20">         Services.console.logStringMessage(</span>
<a href="#l8.21"></a><span id="l8.21">           &quot;Discovering folders for account failed with exception: &quot; + ex</span>
<a href="#l8.22"></a><span id="l8.22">         );</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/components/search/SearchIntegration.jsm</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/components/search/SearchIntegration.jsm</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -297,23 +297,21 @@ var SearchSupport = {</span>
<a href="#l9.4"></a><span id="l9.4">    * Next, it looks for the next folder after the lastFolderIndexedUri. If it is</span>
<a href="#l9.5"></a><span id="l9.5">    * in such a folder, it'll yield return that folder, then set the</span>
<a href="#l9.6"></a><span id="l9.6">    * lastFolderIndexedUrl to the URI of that folder.</span>
<a href="#l9.7"></a><span id="l9.7">    *</span>
<a href="#l9.8"></a><span id="l9.8">    * It resets lastFolderIndexedUri to an empty string, then yield returns null</span>
<a href="#l9.9"></a><span id="l9.9">    * once iteration across all folders is complete.</span>
<a href="#l9.10"></a><span id="l9.10">    */</span>
<a href="#l9.11"></a><span id="l9.11">   *_foldersToIndexGenerator() {</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-    let servers = MailServices.accounts.allServers;</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-</span>
<a href="#l9.14"></a><span id="l9.14">     // Stores whether we're after the last folder indexed or before that --</span>
<a href="#l9.15"></a><span id="l9.15">     // if the last folder indexed is empty, this needs to be true initially</span>
<a href="#l9.16"></a><span id="l9.16">     let afterLastFolderIndexed = this._lastFolderIndexedUri.length == 0;</span>
<a href="#l9.17"></a><span id="l9.17"> </span>
<a href="#l9.18"></a><span id="l9.18" class="difflineminus">-    for (var server of fixIterator(servers, Ci.nsIMsgIncomingServer)) {</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+    for (let server of MailServices.accounts.allServers) {</span>
<a href="#l9.20"></a><span id="l9.20">       let allFolders = server.rootFolder.descendants;</span>
<a href="#l9.21"></a><span id="l9.21">       this._log.debug(</span>
<a href="#l9.22"></a><span id="l9.22">         &quot;in find next folder, lastFolderIndexedUri = &quot; +</span>
<a href="#l9.23"></a><span id="l9.23">           this._lastFolderIndexedUri</span>
<a href="#l9.24"></a><span id="l9.24">       );</span>
<a href="#l9.25"></a><span id="l9.25"> </span>
<a href="#l9.26"></a><span id="l9.26">       for (var folder of fixIterator(allFolders, Ci.nsIMsgFolder)) {</span>
<a href="#l9.27"></a><span id="l9.27">         let searchPath = this._getSearchPathForFolder(folder);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/base/prefs/content/AccountManager.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/base/prefs/content/AccountManager.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -511,19 +511,17 @@ function checkDirectoryIsUsable(aLocalPa</span>
<a href="#l10.4"></a><span id="l10.4">     let alertNotAllowed = document</span>
<a href="#l10.5"></a><span id="l10.5">       .getElementById(&quot;bundle_prefs&quot;)</span>
<a href="#l10.6"></a><span id="l10.6">       .getFormattedString(&quot;localDirectoryNotAllowed&quot;, [originalPath.path]);</span>
<a href="#l10.7"></a><span id="l10.7">     Services.prompt.alert(window, kAlertTitle, alertNotAllowed);</span>
<a href="#l10.8"></a><span id="l10.8">     return false;</span>
<a href="#l10.9"></a><span id="l10.9">   }</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11">   // Check that no other account has this same or dependent local directory.</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-  let allServers = MailServices.accounts.allServers;</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-  for (let server of fixIterator(allServers, Ci.nsIMsgIncomingServer)) {</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+  for (let server of MailServices.accounts.allServers) {</span>
<a href="#l10.16"></a><span id="l10.16">     if (server.key == currentAccount.incomingServer.key) {</span>
<a href="#l10.17"></a><span id="l10.17">       continue;</span>
<a href="#l10.18"></a><span id="l10.18">     }</span>
<a href="#l10.19"></a><span id="l10.19"> </span>
<a href="#l10.20"></a><span id="l10.20">     let serverPath = server.localPath;</span>
<a href="#l10.21"></a><span id="l10.21">     try {</span>
<a href="#l10.22"></a><span id="l10.22">       serverPath.normalize();</span>
<a href="#l10.23"></a><span id="l10.23">       let alertStringID = null;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgAccountManager.idl</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgAccountManager.idl</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -90,17 +90,17 @@ interface nsIMsgAccountManager : nsISupp</span>
<a href="#l11.4"></a><span id="l11.4">   /* list of all identities in all accounts</span>
<a href="#l11.5"></a><span id="l11.5">    * array of nsIMsgIdentity</span>
<a href="#l11.6"></a><span id="l11.6">    */</span>
<a href="#l11.7"></a><span id="l11.7">   readonly attribute Array&lt;nsIMsgIdentity&gt; allIdentities;</span>
<a href="#l11.8"></a><span id="l11.8"> </span>
<a href="#l11.9"></a><span id="l11.9">   /* list of all servers in all accounts, except for hidden and IM servers</span>
<a href="#l11.10"></a><span id="l11.10">    * array of nsIMsgIncomingServer</span>
<a href="#l11.11"></a><span id="l11.11">    */</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-  readonly attribute nsIArray allServers;</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+  readonly attribute Array&lt;nsIMsgIncomingServer&gt; allServers;</span>
<a href="#l11.14"></a><span id="l11.14"> </span>
<a href="#l11.15"></a><span id="l11.15">   /* summary of summary files folder cache */</span>
<a href="#l11.16"></a><span id="l11.16">   readonly attribute nsIMsgFolderCache folderCache;</span>
<a href="#l11.17"></a><span id="l11.17"> </span>
<a href="#l11.18"></a><span id="l11.18">   /* are we shutting down */</span>
<a href="#l11.19"></a><span id="l11.19">   readonly attribute boolean shutdownInProgress;</span>
<a href="#l11.20"></a><span id="l11.20"> </span>
<a href="#l11.21"></a><span id="l11.21">   /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/base/search/src/PeriodicFilterManager.jsm</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/base/search/src/PeriodicFilterManager.jsm</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -6,19 +6,16 @@</span>
<a href="#l12.4"></a><span id="l12.4">  * Execute periodic filters at the correct rate.</span>
<a href="#l12.5"></a><span id="l12.5">  *</span>
<a href="#l12.6"></a><span id="l12.6">  * The only external call required for this is setupFiltering(). This should be</span>
<a href="#l12.7"></a><span id="l12.7">  * called before the mail-startup-done notification.</span>
<a href="#l12.8"></a><span id="l12.8">  */</span>
<a href="#l12.9"></a><span id="l12.9"> </span>
<a href="#l12.10"></a><span id="l12.10"> const EXPORTED_SYMBOLS = [&quot;PeriodicFilterManager&quot;];</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-const { fixIterator } = ChromeUtils.import(</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-  &quot;resource:///modules/iteratorUtils.jsm&quot;</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">-);</span>
<a href="#l12.15"></a><span id="l12.15"> const { Log4Moz } = ChromeUtils.import(&quot;resource:///modules/gloda/Log4moz.jsm&quot;);</span>
<a href="#l12.16"></a><span id="l12.16"> const { MailServices } = ChromeUtils.import(</span>
<a href="#l12.17"></a><span id="l12.17">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l12.18"></a><span id="l12.18"> );</span>
<a href="#l12.19"></a><span id="l12.19"> const { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l12.20"></a><span id="l12.20"> </span>
<a href="#l12.21"></a><span id="l12.21"> const log = Log4Moz.getConfiguredLogger(</span>
<a href="#l12.22"></a><span id="l12.22">   &quot;mail.periodicFilterManager&quot;,</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineat">@@ -45,18 +42,17 @@ var PeriodicFilterManager = {</span>
<a href="#l12.24"></a><span id="l12.24">     this._initialized = true;</span>
<a href="#l12.25"></a><span id="l12.25">     Services.obs.addObserver(this, &quot;mail-startup-done&quot;);</span>
<a href="#l12.26"></a><span id="l12.26">   },</span>
<a href="#l12.27"></a><span id="l12.27"> </span>
<a href="#l12.28"></a><span id="l12.28">   // Main call to start the periodic filter process</span>
<a href="#l12.29"></a><span id="l12.29">   init() {</span>
<a href="#l12.30"></a><span id="l12.30">     log.info(&quot;PeriodicFilterManager init()&quot;);</span>
<a href="#l12.31"></a><span id="l12.31">     // set the next filter time</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineminus">-    let servers = MailServices.accounts.allServers;</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineminus">-    for (let server of fixIterator(servers, Ci.nsIMsgIncomingServer)) {</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+    for (let server of MailServices.accounts.allServers) {</span>
<a href="#l12.35"></a><span id="l12.35">       let nowTime = parseInt(Date.now() / 60000);</span>
<a href="#l12.36"></a><span id="l12.36">       // Make sure that the last filter time of all servers was in the past.</span>
<a href="#l12.37"></a><span id="l12.37">       let lastFilterTime = server.getIntValue(&quot;lastFilterTime&quot;);</span>
<a href="#l12.38"></a><span id="l12.38">       // Schedule next filter run.</span>
<a href="#l12.39"></a><span id="l12.39">       let nextFilterTime =</span>
<a href="#l12.40"></a><span id="l12.40">         lastFilterTime &lt; nowTime</span>
<a href="#l12.41"></a><span id="l12.41">           ? lastFilterTime + this.getServerPeriod(server)</span>
<a href="#l12.42"></a><span id="l12.42">           : nowTime;</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineat">@@ -84,19 +80,18 @@ var PeriodicFilterManager = {</span>
<a href="#l12.44"></a><span id="l12.44">    */</span>
<a href="#l12.45"></a><span id="l12.45">   notify(timer) {</span>
<a href="#l12.46"></a><span id="l12.46">     log.debug(&quot;PeriodicFilterManager timer callback&quot;);</span>
<a href="#l12.47"></a><span id="l12.47">     if (this._running) {</span>
<a href="#l12.48"></a><span id="l12.48">       log.debug(&quot;PeriodicFilterManager Previous filter run still executing&quot;);</span>
<a href="#l12.49"></a><span id="l12.49">       return;</span>
<a href="#l12.50"></a><span id="l12.50">     }</span>
<a href="#l12.51"></a><span id="l12.51">     this._running = true;</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineminus">-    let servers = MailServices.accounts.allServers;</span>
<a href="#l12.53"></a><span id="l12.53">     let nowTime = parseInt(Date.now() / 60000);</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineminus">-    for (let server of fixIterator(servers, Ci.nsIMsgIncomingServer)) {</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineplus">+    for (let server of MailServices.accounts.allServers) {</span>
<a href="#l12.56"></a><span id="l12.56">       if (!server.canHaveFilters) {</span>
<a href="#l12.57"></a><span id="l12.57">         continue;</span>
<a href="#l12.58"></a><span id="l12.58">       }</span>
<a href="#l12.59"></a><span id="l12.59">       if (server.getIntValue(&quot;nextFilterTime&quot;) &gt; nowTime) {</span>
<a href="#l12.60"></a><span id="l12.60">         continue;</span>
<a href="#l12.61"></a><span id="l12.61">       }</span>
<a href="#l12.62"></a><span id="l12.62">       if (server.serverBusy) {</span>
<a href="#l12.63"></a><span id="l12.63">         continue;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/base/src/MailNotificationService.jsm</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/base/src/MailNotificationService.jsm</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -109,32 +109,27 @@ NewMailNotificationService.prototype = {</span>
<a href="#l13.4"></a><span id="l13.4">       }</span>
<a href="#l13.5"></a><span id="l13.5">     } catch (error) {</span>
<a href="#l13.6"></a><span id="l13.6">       this._log.error(&quot;NMNS_Observe failed: &quot; + error);</span>
<a href="#l13.7"></a><span id="l13.7">     }</span>
<a href="#l13.8"></a><span id="l13.8">   },</span>
<a href="#l13.9"></a><span id="l13.9"> </span>
<a href="#l13.10"></a><span id="l13.10">   _initUnreadCount() {</span>
<a href="#l13.11"></a><span id="l13.11">     let total = 0;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-    let allServers = MailServices.accounts.allServers;</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-    for (let i = 0; i &lt; allServers.length; i++) {</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-      let currentServer = allServers.queryElementAt(i, Ci.nsIMsgIncomingServer);</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+    for (let server of MailServices.accounts.allServers) {</span>
<a href="#l13.16"></a><span id="l13.16">       this._log.debug(</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineminus">-        &quot;NMNS_initUnread: server &quot; +</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineminus">-          currentServer.prettyName +</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineminus">-          &quot; type &quot; +</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineminus">-          currentServer.type</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineplus">+        &quot;NMNS_initUnread: server &quot; + server.prettyName + &quot; type &quot; + server.type</span>
<a href="#l13.22"></a><span id="l13.22">       );</span>
<a href="#l13.23"></a><span id="l13.23">       // Don't bother counting RSS or NNTP servers</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineminus">-      let type = currentServer.type;</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineplus">+      let type = server.type;</span>
<a href="#l13.26"></a><span id="l13.26">       if (type == &quot;rss&quot; || type == &quot;nntp&quot;) {</span>
<a href="#l13.27"></a><span id="l13.27">         continue;</span>
<a href="#l13.28"></a><span id="l13.28">       }</span>
<a href="#l13.29"></a><span id="l13.29"> </span>
<a href="#l13.30"></a><span id="l13.30" class="difflineminus">-      let rootFolder = currentServer.rootFolder;</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+      let rootFolder = server.rootFolder;</span>
<a href="#l13.32"></a><span id="l13.32">       if (rootFolder) {</span>
<a href="#l13.33"></a><span id="l13.33">         total += this._countUnread(rootFolder);</span>
<a href="#l13.34"></a><span id="l13.34">       }</span>
<a href="#l13.35"></a><span id="l13.35">     }</span>
<a href="#l13.36"></a><span id="l13.36">     this._mUnreadCount = total;</span>
<a href="#l13.37"></a><span id="l13.37">     if (!this.countNew) {</span>
<a href="#l13.38"></a><span id="l13.38">       this._log.info(</span>
<a href="#l13.39"></a><span id="l13.39">         &quot;NMNS_initUnread notifying listeners: &quot; +</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/base/src/nsMsgAccountManager.cpp</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgAccountManager.cpp</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -890,45 +890,41 @@ nsMsgAccountManager::GetAllIdentities(</span>
<a href="#l14.4"></a><span id="l14.4"> </span>
<a href="#l14.5"></a><span id="l14.5">       if (!found) result.AppendElement(identity);</span>
<a href="#l14.6"></a><span id="l14.6">     }</span>
<a href="#l14.7"></a><span id="l14.7">   }</span>
<a href="#l14.8"></a><span id="l14.8">   return rv;</span>
<a href="#l14.9"></a><span id="l14.9"> }</span>
<a href="#l14.10"></a><span id="l14.10"> </span>
<a href="#l14.11"></a><span id="l14.11"> NS_IMETHODIMP</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-nsMsgAccountManager::GetAllServers(nsIArray **_retval) {</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+nsMsgAccountManager::GetAllServers(</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+    nsTArray&lt;RefPtr&lt;nsIMsgIncomingServer&gt;&gt; &amp;servers) {</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+  servers.Clear();</span>
<a href="#l14.16"></a><span id="l14.16">   nsresult rv = LoadAccounts();</span>
<a href="#l14.17"></a><span id="l14.17">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.18"></a><span id="l14.18"> </span>
<a href="#l14.19"></a><span id="l14.19" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; servers(</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineminus">-      do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineminus">-</span>
<a href="#l14.23"></a><span id="l14.23">   for (auto iter = m_incomingServers.Iter(); !iter.Done(); iter.Next()) {</span>
<a href="#l14.24"></a><span id="l14.24">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; &amp;server = iter.Data();</span>
<a href="#l14.25"></a><span id="l14.25">     if (!server) continue;</span>
<a href="#l14.26"></a><span id="l14.26"> </span>
<a href="#l14.27"></a><span id="l14.27">     bool hidden = false;</span>
<a href="#l14.28"></a><span id="l14.28">     server-&gt;GetHidden(&amp;hidden);</span>
<a href="#l14.29"></a><span id="l14.29">     if (hidden) continue;</span>
<a href="#l14.30"></a><span id="l14.30"> </span>
<a href="#l14.31"></a><span id="l14.31">     nsCString type;</span>
<a href="#l14.32"></a><span id="l14.32">     if (NS_FAILED(server-&gt;GetType(type))) {</span>
<a href="#l14.33"></a><span id="l14.33">       NS_WARNING(&quot;server-&gt;GetType() failed&quot;);</span>
<a href="#l14.34"></a><span id="l14.34">       continue;</span>
<a href="#l14.35"></a><span id="l14.35">     }</span>
<a href="#l14.36"></a><span id="l14.36"> </span>
<a href="#l14.37"></a><span id="l14.37">     if (!type.EqualsLiteral(&quot;im&quot;)) {</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineminus">-      servers-&gt;AppendElement(server);</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+      servers.AppendElement(server);</span>
<a href="#l14.40"></a><span id="l14.40">     }</span>
<a href="#l14.41"></a><span id="l14.41">   }</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineminus">-</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineminus">-  servers.forget(_retval);</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineminus">-  return rv;</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+  return NS_OK;</span>
<a href="#l14.46"></a><span id="l14.46"> }</span>
<a href="#l14.47"></a><span id="l14.47"> </span>
<a href="#l14.48"></a><span id="l14.48"> nsresult nsMsgAccountManager::LoadAccounts() {</span>
<a href="#l14.49"></a><span id="l14.49">   nsresult rv;</span>
<a href="#l14.50"></a><span id="l14.50"> </span>
<a href="#l14.51"></a><span id="l14.51">   // for now safeguard multiple calls to this function</span>
<a href="#l14.52"></a><span id="l14.52">   if (m_accountsLoaded) return NS_OK;</span>
<a href="#l14.53"></a><span id="l14.53"> </span>
<a href="#l14.54"></a><span id="l14.54" class="difflineat">@@ -2941,31 +2937,25 @@ nsresult nsMsgAccountManager::RemoveVFLi</span>
<a href="#l14.55"></a><span id="l14.55">     }</span>
<a href="#l14.56"></a><span id="l14.56">   }</span>
<a href="#l14.57"></a><span id="l14.57">   return NS_OK;</span>
<a href="#l14.58"></a><span id="l14.58"> }</span>
<a href="#l14.59"></a><span id="l14.59"> </span>
<a href="#l14.60"></a><span id="l14.60"> NS_IMETHODIMP nsMsgAccountManager::GetAllFolders(nsIArray **aAllFolders) {</span>
<a href="#l14.61"></a><span id="l14.61">   NS_ENSURE_ARG_POINTER(aAllFolders);</span>
<a href="#l14.62"></a><span id="l14.62"> </span>
<a href="#l14.63"></a><span id="l14.63" class="difflineminus">-  nsCOMPtr&lt;nsIArray&gt; servers;</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineminus">-  nsresult rv = GetAllServers(getter_AddRefs(servers));</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineminus">-</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineminus">-  uint32_t numServers = 0;</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineminus">-  rv = servers-&gt;GetLength(&amp;numServers);</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineplus">+  nsTArray&lt;RefPtr&lt;nsIMsgIncomingServer&gt;&gt; allServers;</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+  nsresult rv = GetAllServers(allServers);</span>
<a href="#l14.71"></a><span id="l14.71">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.72"></a><span id="l14.72"> </span>
<a href="#l14.73"></a><span id="l14.73">   nsCOMPtr&lt;nsIMutableArray&gt; allFolders(</span>
<a href="#l14.74"></a><span id="l14.74">       do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l14.75"></a><span id="l14.75">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.76"></a><span id="l14.76"> </span>
<a href="#l14.77"></a><span id="l14.77" class="difflineminus">-  uint32_t i;</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineminus">-  for (i = 0; i &lt; numServers; i++) {</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineminus">-    nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryElementAt(servers, i);</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineplus">+  for (auto server : allServers) {</span>
<a href="#l14.81"></a><span id="l14.81">     if (server) {</span>
<a href="#l14.82"></a><span id="l14.82">       nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l14.83"></a><span id="l14.83">       server-&gt;GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l14.84"></a><span id="l14.84">       if (rootFolder) rootFolder-&gt;ListDescendants(allFolders);</span>
<a href="#l14.85"></a><span id="l14.85">     }</span>
<a href="#l14.86"></a><span id="l14.86">   }</span>
<a href="#l14.87"></a><span id="l14.87"> </span>
<a href="#l14.88"></a><span id="l14.88">   allFolders.forget(aAllFolders);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/base/src/nsMsgPurgeService.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgPurgeService.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -122,40 +122,38 @@ nsresult nsMsgPurgeService::PerformPurge</span>
<a href="#l15.4"></a><span id="l15.4"> </span>
<a href="#l15.5"></a><span id="l15.5">   nsresult rv;</span>
<a href="#l15.6"></a><span id="l15.6"> </span>
<a href="#l15.7"></a><span id="l15.7">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l15.8"></a><span id="l15.8">       do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l15.9"></a><span id="l15.9">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.10"></a><span id="l15.10">   bool keepApplyingRetentionSettings = true;</span>
<a href="#l15.11"></a><span id="l15.11"> </span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-  nsCOMPtr&lt;nsIArray&gt; allServers;</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-  rv = accountManager-&gt;GetAllServers(getter_AddRefs(allServers));</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; allServers) {</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineminus">-    uint32_t numServers;</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineminus">-    rv = allServers-&gt;GetLength(&amp;numServers);</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineplus">+  nsTArray&lt;RefPtr&lt;nsIMsgIncomingServer&gt;&gt; allServers;</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineplus">+  rv = accountManager-&gt;GetAllServers(allServers);</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l15.20"></a><span id="l15.20">     MOZ_LOG(MsgPurgeLogModule, mozilla::LogLevel::Info,</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineminus">-            (&quot;%d servers&quot;, numServers));</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineplus">+            (&quot;%d servers&quot;, (int)allServers.Length()));</span>
<a href="#l15.23"></a><span id="l15.23">     nsCOMPtr&lt;nsIMsgFolder&gt; folderToPurge;</span>
<a href="#l15.24"></a><span id="l15.24">     PRIntervalTime startTime = PR_IntervalNow();</span>
<a href="#l15.25"></a><span id="l15.25">     int32_t purgeIntervalToUse = 0;</span>
<a href="#l15.26"></a><span id="l15.26">     PRTime oldestPurgeTime =</span>
<a href="#l15.27"></a><span id="l15.27">         0;  // we're going to pick the least-recently purged folder</span>
<a href="#l15.28"></a><span id="l15.28"> </span>
<a href="#l15.29"></a><span id="l15.29">     // apply retention settings to folders that haven't had retention settings</span>
<a href="#l15.30"></a><span id="l15.30">     // applied in mMinDelayBetweenPurges minutes (default 8 hours)</span>
<a href="#l15.31"></a><span id="l15.31">     // Because we get last purge time from the folder cache,</span>
<a href="#l15.32"></a><span id="l15.32">     // this code won't open db's for folders until it decides it needs</span>
<a href="#l15.33"></a><span id="l15.33">     // to apply retention settings, and since</span>
<a href="#l15.34"></a><span id="l15.34">     // nsIMsgFolder::ApplyRetentionSettings will close any db's it opens, this</span>
<a href="#l15.35"></a><span id="l15.35">     // code won't leave db's open.</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineminus">-    for (uint32_t serverIndex = 0; serverIndex &lt; numServers; serverIndex++) {</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineminus">-      nsCOMPtr&lt;nsIMsgIncomingServer&gt; server =</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineminus">-          do_QueryElementAt(allServers, serverIndex, &amp;rv);</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; server) {</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineplus">+    for (uint32_t serverIndex = 0; serverIndex &lt; allServers.Length();</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineplus">+         serverIndex++) {</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineplus">+      nsCOMPtr&lt;nsIMsgIncomingServer&gt; server(allServers[serverIndex]);</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineplus">+      if (server) {</span>
<a href="#l15.44"></a><span id="l15.44">         if (keepApplyingRetentionSettings) {</span>
<a href="#l15.45"></a><span id="l15.45">           nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l15.46"></a><span id="l15.46">           rv = server-&gt;GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l15.47"></a><span id="l15.47">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.48"></a><span id="l15.48"> </span>
<a href="#l15.49"></a><span id="l15.49">           nsCOMPtr&lt;nsIArray&gt; childFolders;</span>
<a href="#l15.50"></a><span id="l15.50">           rv = rootFolder-&gt;GetDescendants(getter_AddRefs(childFolders));</span>
<a href="#l15.51"></a><span id="l15.51">           NS_ENSURE_SUCCESS(rv, rv);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/base/test/unit/test_accountMgr2.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_accountMgr2.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -43,17 +43,15 @@ add_task(async function() {</span>
<a href="#l16.4"></a><span id="l16.4">   acc1.addIdentity(id3);</span>
<a href="#l16.5"></a><span id="l16.5">   acc2.addIdentity(id3);</span>
<a href="#l16.6"></a><span id="l16.6"> </span>
<a href="#l16.7"></a><span id="l16.7">   // The special &quot;Local Folders&quot; account and server (server type is &quot;none&quot;).</span>
<a href="#l16.8"></a><span id="l16.8">   mgr.createLocalMailAccount();</span>
<a href="#l16.9"></a><span id="l16.9"> </span>
<a href="#l16.10"></a><span id="l16.10">   // Setup done. Now check that things are as we expect.</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-  let allServers = [...fixIterator(mgr.allServers, Ci.nsIMsgIncomingServer)];</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-</span>
<a href="#l16.14"></a><span id="l16.14">   // At this point we should have 3 accounts and servers (imap, pop, local).</span>
<a href="#l16.15"></a><span id="l16.15">   Assert.equal(mgr.accounts.length, 3);</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineminus">-  Assert.equal(allServers.length, 3);</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineplus">+  Assert.equal(mgr.allServers.length, 3);</span>
<a href="#l16.18"></a><span id="l16.18"> </span>
<a href="#l16.19"></a><span id="l16.19">   // The identities we explicitly created.</span>
<a href="#l16.20"></a><span id="l16.20">   Assert.equal(mgr.allIdentities.length, 3);</span>
<a href="#l16.21"></a><span id="l16.21"> });</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -1689,46 +1689,44 @@ class AutoCompactEvent : public mozilla:</span>
<a href="#l17.4"></a><span id="l17.4">   RefPtr&lt;nsMsgDBFolder&gt; mFolder;</span>
<a href="#l17.5"></a><span id="l17.5"> };</span>
<a href="#l17.6"></a><span id="l17.6"> </span>
<a href="#l17.7"></a><span id="l17.7"> nsresult nsMsgDBFolder::HandleAutoCompactEvent(nsIMsgWindow *aWindow) {</span>
<a href="#l17.8"></a><span id="l17.8">   nsresult rv;</span>
<a href="#l17.9"></a><span id="l17.9">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accountMgr =</span>
<a href="#l17.10"></a><span id="l17.10">       do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l17.11"></a><span id="l17.11">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-    nsCOMPtr&lt;nsIArray&gt; allServers;</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-    rv = accountMgr-&gt;GetAllServers(getter_AddRefs(allServers));</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+    nsTArray&lt;RefPtr&lt;nsIMsgIncomingServer&gt;&gt; allServers;</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+    rv = accountMgr-&gt;GetAllServers(allServers);</span>
<a href="#l17.16"></a><span id="l17.16">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineminus">-    uint32_t numServers = 0, serverIndex = 0;</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineminus">-    rv = allServers-&gt;GetLength(&amp;numServers);</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineminus">-    int32_t offlineSupportLevel;</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineplus">+    uint32_t numServers = allServers.Length();</span>
<a href="#l17.21"></a><span id="l17.21">     if (numServers &gt; 0) {</span>
<a href="#l17.22"></a><span id="l17.22">       nsCOMPtr&lt;nsIMutableArray&gt; folderArray =</span>
<a href="#l17.23"></a><span id="l17.23">           do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l17.24"></a><span id="l17.24">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.25"></a><span id="l17.25">       nsCOMPtr&lt;nsIMutableArray&gt; offlineFolderArray =</span>
<a href="#l17.26"></a><span id="l17.26">           do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l17.27"></a><span id="l17.27">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.28"></a><span id="l17.28">       int64_t totalExpungedBytes = 0;</span>
<a href="#l17.29"></a><span id="l17.29">       int64_t offlineExpungedBytes = 0;</span>
<a href="#l17.30"></a><span id="l17.30">       int64_t localExpungedBytes = 0;</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineplus">+      uint32_t serverIndex = 0;</span>
<a href="#l17.32"></a><span id="l17.32">       do {</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineminus">-        nsCOMPtr&lt;nsIMsgIncomingServer&gt; server =</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineminus">-            do_QueryElementAt(allServers, serverIndex, &amp;rv);</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineplus">+        nsCOMPtr&lt;nsIMsgIncomingServer&gt; server(allServers[serverIndex]);</span>
<a href="#l17.37"></a><span id="l17.37">         nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l17.38"></a><span id="l17.38">         rv = server-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l17.39"></a><span id="l17.39">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.40"></a><span id="l17.40">         if (!msgStore) continue;</span>
<a href="#l17.41"></a><span id="l17.41">         bool supportsCompaction;</span>
<a href="#l17.42"></a><span id="l17.42">         msgStore-&gt;GetSupportsCompaction(&amp;supportsCompaction);</span>
<a href="#l17.43"></a><span id="l17.43">         if (!supportsCompaction) continue;</span>
<a href="#l17.44"></a><span id="l17.44">         nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l17.45"></a><span id="l17.45">         rv = server-&gt;GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l17.46"></a><span id="l17.46">         if (NS_SUCCEEDED(rv) &amp;&amp; rootFolder) {</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineplus">+          int32_t offlineSupportLevel;</span>
<a href="#l17.48"></a><span id="l17.48">           rv = server-&gt;GetOfflineSupportLevel(&amp;offlineSupportLevel);</span>
<a href="#l17.49"></a><span id="l17.49">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.50"></a><span id="l17.50">           nsCOMPtr&lt;nsIArray&gt; allDescendents;</span>
<a href="#l17.51"></a><span id="l17.51">           rootFolder-&gt;GetDescendants(getter_AddRefs(allDescendents));</span>
<a href="#l17.52"></a><span id="l17.52">           uint32_t cnt = 0;</span>
<a href="#l17.53"></a><span id="l17.53">           rv = allDescendents-&gt;GetLength(&amp;cnt);</span>
<a href="#l17.54"></a><span id="l17.54">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.55"></a><span id="l17.55">           int64_t expungedBytes = 0;</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineat">@@ -1928,25 +1926,21 @@ nsMsgDBFolder::MatchOrChangeFilterDestin</span>
<a href="#l17.57"></a><span id="l17.57">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.58"></a><span id="l17.58">   }</span>
<a href="#l17.59"></a><span id="l17.59"> </span>
<a href="#l17.60"></a><span id="l17.60">   nsCOMPtr&lt;nsIMsgFilterList&gt; filterList;</span>
<a href="#l17.61"></a><span id="l17.61">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accountMgr =</span>
<a href="#l17.62"></a><span id="l17.62">       do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l17.63"></a><span id="l17.63">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.64"></a><span id="l17.64"> </span>
<a href="#l17.65"></a><span id="l17.65" class="difflineminus">-  nsCOMPtr&lt;nsIArray&gt; allServers;</span>
<a href="#l17.66"></a><span id="l17.66" class="difflineminus">-  rv = accountMgr-&gt;GetAllServers(getter_AddRefs(allServers));</span>
<a href="#l17.67"></a><span id="l17.67" class="difflineplus">+  nsTArray&lt;RefPtr&lt;nsIMsgIncomingServer&gt;&gt; allServers;</span>
<a href="#l17.68"></a><span id="l17.68" class="difflineplus">+  rv = accountMgr-&gt;GetAllServers(allServers);</span>
<a href="#l17.69"></a><span id="l17.69">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.70"></a><span id="l17.70"> </span>
<a href="#l17.71"></a><span id="l17.71" class="difflineminus">-  uint32_t numServers;</span>
<a href="#l17.72"></a><span id="l17.72" class="difflineminus">-  rv = allServers-&gt;GetLength(&amp;numServers);</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineminus">-  for (uint32_t serverIndex = 0; serverIndex &lt; numServers; serverIndex++) {</span>
<a href="#l17.74"></a><span id="l17.74" class="difflineminus">-    nsCOMPtr&lt;nsIMsgIncomingServer&gt; server =</span>
<a href="#l17.75"></a><span id="l17.75" class="difflineminus">-        do_QueryElementAt(allServers, serverIndex);</span>
<a href="#l17.76"></a><span id="l17.76" class="difflineplus">+  for (auto server : allServers) {</span>
<a href="#l17.77"></a><span id="l17.77">     if (server) {</span>
<a href="#l17.78"></a><span id="l17.78">       bool canHaveFilters;</span>
<a href="#l17.79"></a><span id="l17.79">       rv = server-&gt;GetCanHaveFilters(&amp;canHaveFilters);</span>
<a href="#l17.80"></a><span id="l17.80">       if (NS_SUCCEEDED(rv) &amp;&amp; canHaveFilters) {</span>
<a href="#l17.81"></a><span id="l17.81">         // update the filterlist to match the new folder name</span>
<a href="#l17.82"></a><span id="l17.82">         rv = server-&gt;GetFilterList(nullptr, getter_AddRefs(filterList));</span>
<a href="#l17.83"></a><span id="l17.83">         if (NS_SUCCEEDED(rv) &amp;&amp; filterList) {</span>
<a href="#l17.84"></a><span id="l17.84">           rv = filterList-&gt;MatchOrChangeFilterTarget(oldUri, newUri,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/base/util/nsMsgIncomingServer.cpp</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgIncomingServer.cpp</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -1978,63 +1978,52 @@ nsresult nsMsgIncomingServer::GetDeferre</span>
<a href="#l18.4"></a><span id="l18.4">   nsresult rv;</span>
<a href="#l18.5"></a><span id="l18.5">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l18.6"></a><span id="l18.6">       do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l18.7"></a><span id="l18.7">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.8"></a><span id="l18.8"> </span>
<a href="#l18.9"></a><span id="l18.9">   nsCOMPtr&lt;nsIMsgAccount&gt; thisAccount;</span>
<a href="#l18.10"></a><span id="l18.10">   accountManager-&gt;FindAccountForServer(destServer, getter_AddRefs(thisAccount));</span>
<a href="#l18.11"></a><span id="l18.11">   if (thisAccount) {</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-    nsCOMPtr&lt;nsIArray&gt; allServers;</span>
<a href="#l18.13"></a><span id="l18.13">     nsCString accountKey;</span>
<a href="#l18.14"></a><span id="l18.14">     thisAccount-&gt;GetKey(accountKey);</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineminus">-    accountManager-&gt;GetAllServers(getter_AddRefs(allServers));</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineminus">-    if (allServers) {</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineminus">-      uint32_t serverCount;</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineminus">-      allServers-&gt;GetLength(&amp;serverCount);</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineminus">-      for (uint32_t i = 0; i &lt; serverCount; i++) {</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineminus">-        nsCOMPtr&lt;nsIPop3IncomingServer&gt; server(</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineminus">-            do_QueryElementAt(allServers, i));</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineminus">-        if (server) {</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineminus">-          nsCString deferredToAccount;</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineminus">-          server-&gt;GetDeferredToAccount(deferredToAccount);</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineminus">-          if (deferredToAccount.Equals(accountKey))</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineminus">-            aServers.AppendElement(server);</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineminus">-        }</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineplus">+    nsTArray&lt;RefPtr&lt;nsIMsgIncomingServer&gt;&gt; allServers;</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineplus">+    accountManager-&gt;GetAllServers(allServers);</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineplus">+    for (auto server : allServers) {</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineplus">+      nsCOMPtr&lt;nsIPop3IncomingServer&gt; popServer(do_QueryInterface(server));</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineplus">+      if (!popServer) {</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineplus">+        nsCString deferredToAccount;</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineplus">+        popServer-&gt;GetDeferredToAccount(deferredToAccount);</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineplus">+        if (deferredToAccount.Equals(accountKey))</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineplus">+          aServers.AppendElement(popServer);</span>
<a href="#l18.37"></a><span id="l18.37">       }</span>
<a href="#l18.38"></a><span id="l18.38">     }</span>
<a href="#l18.39"></a><span id="l18.39">   }</span>
<a href="#l18.40"></a><span id="l18.40">   return rv;</span>
<a href="#l18.41"></a><span id="l18.41"> }</span>
<a href="#l18.42"></a><span id="l18.42"> </span>
<a href="#l18.43"></a><span id="l18.43"> NS_IMETHODIMP nsMsgIncomingServer::GetIsDeferredTo(bool *aIsDeferredTo) {</span>
<a href="#l18.44"></a><span id="l18.44">   NS_ENSURE_ARG_POINTER(aIsDeferredTo);</span>
<a href="#l18.45"></a><span id="l18.45">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l18.46"></a><span id="l18.46">       do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID);</span>
<a href="#l18.47"></a><span id="l18.47">   if (accountManager) {</span>
<a href="#l18.48"></a><span id="l18.48">     nsCOMPtr&lt;nsIMsgAccount&gt; thisAccount;</span>
<a href="#l18.49"></a><span id="l18.49">     accountManager-&gt;FindAccountForServer(this, getter_AddRefs(thisAccount));</span>
<a href="#l18.50"></a><span id="l18.50">     if (thisAccount) {</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineminus">-      nsCOMPtr&lt;nsIArray&gt; allServers;</span>
<a href="#l18.52"></a><span id="l18.52">       nsCString accountKey;</span>
<a href="#l18.53"></a><span id="l18.53">       thisAccount-&gt;GetKey(accountKey);</span>
<a href="#l18.54"></a><span id="l18.54" class="difflineminus">-      accountManager-&gt;GetAllServers(getter_AddRefs(allServers));</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineminus">-      if (allServers) {</span>
<a href="#l18.56"></a><span id="l18.56" class="difflineminus">-        uint32_t serverCount;</span>
<a href="#l18.57"></a><span id="l18.57" class="difflineminus">-        allServers-&gt;GetLength(&amp;serverCount);</span>
<a href="#l18.58"></a><span id="l18.58" class="difflineminus">-        for (uint32_t i = 0; i &lt; serverCount; i++) {</span>
<a href="#l18.59"></a><span id="l18.59" class="difflineminus">-          nsCOMPtr&lt;nsIMsgIncomingServer&gt; server(</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineminus">-              do_QueryElementAt(allServers, i));</span>
<a href="#l18.61"></a><span id="l18.61" class="difflineminus">-          if (server) {</span>
<a href="#l18.62"></a><span id="l18.62" class="difflineminus">-            nsCString deferredToAccount;</span>
<a href="#l18.63"></a><span id="l18.63" class="difflineminus">-            server-&gt;GetCharValue(&quot;deferred_to_account&quot;, deferredToAccount);</span>
<a href="#l18.64"></a><span id="l18.64" class="difflineminus">-            if (deferredToAccount.Equals(accountKey)) {</span>
<a href="#l18.65"></a><span id="l18.65" class="difflineminus">-              *aIsDeferredTo = true;</span>
<a href="#l18.66"></a><span id="l18.66" class="difflineminus">-              return NS_OK;</span>
<a href="#l18.67"></a><span id="l18.67" class="difflineminus">-            }</span>
<a href="#l18.68"></a><span id="l18.68" class="difflineplus">+      nsTArray&lt;RefPtr&lt;nsIMsgIncomingServer&gt;&gt; allServers;</span>
<a href="#l18.69"></a><span id="l18.69" class="difflineplus">+      accountManager-&gt;GetAllServers(allServers);</span>
<a href="#l18.70"></a><span id="l18.70" class="difflineplus">+      for (auto server : allServers) {</span>
<a href="#l18.71"></a><span id="l18.71" class="difflineplus">+        if (server) {</span>
<a href="#l18.72"></a><span id="l18.72" class="difflineplus">+          nsCString deferredToAccount;</span>
<a href="#l18.73"></a><span id="l18.73" class="difflineplus">+          server-&gt;GetCharValue(&quot;deferred_to_account&quot;, deferredToAccount);</span>
<a href="#l18.74"></a><span id="l18.74" class="difflineplus">+          if (deferredToAccount.Equals(accountKey)) {</span>
<a href="#l18.75"></a><span id="l18.75" class="difflineplus">+            *aIsDeferredTo = true;</span>
<a href="#l18.76"></a><span id="l18.76" class="difflineplus">+            return NS_OK;</span>
<a href="#l18.77"></a><span id="l18.77">           }</span>
<a href="#l18.78"></a><span id="l18.78">         }</span>
<a href="#l18.79"></a><span id="l18.79">       }</span>
<a href="#l18.80"></a><span id="l18.80">     }</span>
<a href="#l18.81"></a><span id="l18.81">   }</span>
<a href="#l18.82"></a><span id="l18.82">   *aIsDeferredTo = false;</span>
<a href="#l18.83"></a><span id="l18.83">   return NS_OK;</span>
<a href="#l18.84"></a><span id="l18.84"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpServer.cpp</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpServer.cpp</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -370,38 +370,31 @@ nsSmtpServer::GetPassword(nsAString &amp;aPa</span>
<a href="#l19.4"></a><span id="l19.4">             // pass in empty type and port=0, to match imap and pop3.</span>
<a href="#l19.5"></a><span id="l19.5">             accountManager-&gt;FindRealServer(userName, hostName, EmptyCString(),</span>
<a href="#l19.6"></a><span id="l19.6">                                            0,</span>
<a href="#l19.7"></a><span id="l19.7">                                            getter_AddRefs(incomingServerToUse));</span>
<a href="#l19.8"></a><span id="l19.8">           int32_t dotPos = -1;</span>
<a href="#l19.9"></a><span id="l19.9">           if (!incomingServerToUse &amp;&amp; useMatchingDomainServer &amp;&amp;</span>
<a href="#l19.10"></a><span id="l19.10">               (dotPos = hostName.FindChar('.')) != kNotFound) {</span>
<a href="#l19.11"></a><span id="l19.11">             hostName.Cut(0, dotPos);</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-            nsCOMPtr&lt;nsIArray&gt; allServers;</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-            accountManager-&gt;GetAllServers(getter_AddRefs(allServers));</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineminus">-            if (allServers) {</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineminus">-              uint32_t count = 0;</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineminus">-              allServers-&gt;GetLength(&amp;count);</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineminus">-              uint32_t i;</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineminus">-              for (i = 0; i &lt; count; i++) {</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineminus">-                nsCOMPtr&lt;nsIMsgIncomingServer&gt; server =</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineminus">-                    do_QueryElementAt(allServers, i);</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineminus">-                if (server) {</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineminus">-                  nsCString serverUserName;</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineminus">-                  nsCString serverHostName;</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineminus">-                  server-&gt;GetRealUsername(serverUserName);</span>
<a href="#l19.25"></a><span id="l19.25" class="difflineminus">-                  server-&gt;GetRealHostName(serverHostName);</span>
<a href="#l19.26"></a><span id="l19.26" class="difflineminus">-                  if (serverUserName.Equals(userName)) {</span>
<a href="#l19.27"></a><span id="l19.27" class="difflineminus">-                    int32_t serverDotPos = serverHostName.FindChar('.');</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineminus">-                    if (serverDotPos != kNotFound) {</span>
<a href="#l19.29"></a><span id="l19.29" class="difflineminus">-                      serverHostName.Cut(0, serverDotPos);</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineminus">-                      if (serverHostName.Equals(hostName)) {</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineminus">-                        incomingServerToUse = server;</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineminus">-                        break;</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineminus">-                      }</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineplus">+            nsTArray&lt;RefPtr&lt;nsIMsgIncomingServer&gt;&gt; allServers;</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineplus">+            accountManager-&gt;GetAllServers(allServers);</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineplus">+            for (auto server : allServers) {</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineplus">+              if (server) {</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineplus">+                nsCString serverUserName;</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineplus">+                nsCString serverHostName;</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineplus">+                server-&gt;GetRealUsername(serverUserName);</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineplus">+                server-&gt;GetRealHostName(serverHostName);</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineplus">+                if (serverUserName.Equals(userName)) {</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineplus">+                  int32_t serverDotPos = serverHostName.FindChar('.');</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineplus">+                  if (serverDotPos != kNotFound) {</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineplus">+                    serverHostName.Cut(0, serverDotPos);</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineplus">+                    if (serverHostName.Equals(hostName)) {</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineplus">+                      incomingServerToUse = server;</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineplus">+                      break;</span>
<a href="#l19.49"></a><span id="l19.49">                     }</span>
<a href="#l19.50"></a><span id="l19.50">                   }</span>
<a href="#l19.51"></a><span id="l19.51">                 }</span>
<a href="#l19.52"></a><span id="l19.52">               }</span>
<a href="#l19.53"></a><span id="l19.53">             }</span>
<a href="#l19.54"></a><span id="l19.54">           }</span>
<a href="#l19.55"></a><span id="l19.55">         }</span>
<a href="#l19.56"></a><span id="l19.56">       }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/extensions/newsblog/content/FeedUtils.jsm</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/content/FeedUtils.jsm</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -118,19 +118,17 @@ var FeedUtils = {</span>
<a href="#l20.4"></a><span id="l20.4"> </span>
<a href="#l20.5"></a><span id="l20.5">   /**</span>
<a href="#l20.6"></a><span id="l20.6">    * Get all rss account servers rootFolders.</span>
<a href="#l20.7"></a><span id="l20.7">    *</span>
<a href="#l20.8"></a><span id="l20.8">    * @returns {nsIMsgIncomingServer}[] - Array of servers (empty array if none).</span>
<a href="#l20.9"></a><span id="l20.9">    */</span>
<a href="#l20.10"></a><span id="l20.10">   getAllRssServerRootFolders() {</span>
<a href="#l20.11"></a><span id="l20.11">     let rssRootFolders = [];</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-    let allServers = MailServices.accounts.allServers;</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-    for (let i = 0; i &lt; allServers.length; i++) {</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineminus">-      let server = allServers.queryElementAt(i, Ci.nsIMsgIncomingServer);</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineplus">+    for (let server of MailServices.accounts.allServers) {</span>
<a href="#l20.16"></a><span id="l20.16">       if (server &amp;&amp; server.type == &quot;rss&quot;) {</span>
<a href="#l20.17"></a><span id="l20.17">         rssRootFolders.push(server.rootFolder);</span>
<a href="#l20.18"></a><span id="l20.18">       }</span>
<a href="#l20.19"></a><span id="l20.19">     }</span>
<a href="#l20.20"></a><span id="l20.20"> </span>
<a href="#l20.21"></a><span id="l20.21">     // By default, Tb sorts by hostname, ie Feeds, Feeds-1, and not by alpha</span>
<a href="#l20.22"></a><span id="l20.22">     // prettyName.  Do the same as a stock install to match folderpane order.</span>
<a href="#l20.23"></a><span id="l20.23">     rssRootFolders.sort(function(a, b) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/imap/src/nsImapOfflineSync.cpp</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapOfflineSync.cpp</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -106,44 +106,43 @@ nsImapOfflineSync::OnStopRunningUrl(nsIU</span>
<a href="#l21.4"></a><span id="l21.4">  * Leaves m_currentServer at the next imap or local mail &quot;server&quot; that</span>
<a href="#l21.5"></a><span id="l21.5">  * might have offline events to playback. If no more servers,</span>
<a href="#l21.6"></a><span id="l21.6">  * m_currentServer will be left at nullptr and the function returns false.</span>
<a href="#l21.7"></a><span id="l21.7">  * Also, sets up m_serverEnumerator to enumerate over the server.</span>
<a href="#l21.8"></a><span id="l21.8">  */</span>
<a href="#l21.9"></a><span id="l21.9"> bool nsImapOfflineSync::AdvanceToNextServer() {</span>
<a href="#l21.10"></a><span id="l21.10">   nsresult rv = NS_OK;</span>
<a href="#l21.11"></a><span id="l21.11"> </span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-  if (!m_allServers) {</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+  if (m_allServers.IsEmpty()) {</span>
<a href="#l21.14"></a><span id="l21.14">     NS_ASSERTION(!m_currentServer, &quot;this shouldn't be set&quot;);</span>
<a href="#l21.15"></a><span id="l21.15">     m_currentServer = nullptr;</span>
<a href="#l21.16"></a><span id="l21.16">     nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l21.17"></a><span id="l21.17">         do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l21.18"></a><span id="l21.18">     NS_ASSERTION(accountManager &amp;&amp; NS_SUCCEEDED(rv),</span>
<a href="#l21.19"></a><span id="l21.19">                  &quot;couldn't get account mgr&quot;);</span>
<a href="#l21.20"></a><span id="l21.20">     if (!accountManager || NS_FAILED(rv)) return false;</span>
<a href="#l21.21"></a><span id="l21.21"> </span>
<a href="#l21.22"></a><span id="l21.22" class="difflineminus">-    rv = accountManager-&gt;GetAllServers(getter_AddRefs(m_allServers));</span>
<a href="#l21.23"></a><span id="l21.23" class="difflineplus">+    rv = accountManager-&gt;GetAllServers(m_allServers);</span>
<a href="#l21.24"></a><span id="l21.24">     NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l21.25"></a><span id="l21.25">   }</span>
<a href="#l21.26"></a><span id="l21.26">   uint32_t serverIndex = 0;</span>
<a href="#l21.27"></a><span id="l21.27">   if (m_currentServer) {</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineminus">-    rv = m_allServers-&gt;IndexOf(0, m_currentServer, &amp;serverIndex);</span>
<a href="#l21.29"></a><span id="l21.29" class="difflineminus">-    if (NS_FAILED(rv)) serverIndex = -1;</span>
<a href="#l21.30"></a><span id="l21.30" class="difflineminus">-</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineminus">-    // Move to the next server</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineminus">-    ++serverIndex;</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineplus">+    serverIndex = m_allServers.IndexOf(m_currentServer);</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineplus">+    if (serverIndex == m_allServers.NoIndex) {</span>
<a href="#l21.35"></a><span id="l21.35" class="difflineplus">+      serverIndex = 0;</span>
<a href="#l21.36"></a><span id="l21.36" class="difflineplus">+    } else {</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineplus">+      // Move to the next server</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineplus">+      ++serverIndex;</span>
<a href="#l21.39"></a><span id="l21.39" class="difflineplus">+    }</span>
<a href="#l21.40"></a><span id="l21.40">   }</span>
<a href="#l21.41"></a><span id="l21.41">   m_currentServer = nullptr;</span>
<a href="#l21.42"></a><span id="l21.42" class="difflineminus">-  uint32_t numServers;</span>
<a href="#l21.43"></a><span id="l21.43" class="difflineminus">-  m_allServers-&gt;GetLength(&amp;numServers);</span>
<a href="#l21.44"></a><span id="l21.44">   nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l21.45"></a><span id="l21.45"> </span>
<a href="#l21.46"></a><span id="l21.46" class="difflineminus">-  while (serverIndex &lt; numServers) {</span>
<a href="#l21.47"></a><span id="l21.47" class="difflineminus">-    nsCOMPtr&lt;nsIMsgIncomingServer&gt; server(</span>
<a href="#l21.48"></a><span id="l21.48" class="difflineminus">-        do_QueryElementAt(m_allServers, serverIndex));</span>
<a href="#l21.49"></a><span id="l21.49" class="difflineplus">+  while (serverIndex &lt; m_allServers.Length()) {</span>
<a href="#l21.50"></a><span id="l21.50" class="difflineplus">+    nsCOMPtr&lt;nsIMsgIncomingServer&gt; server(m_allServers[serverIndex]);</span>
<a href="#l21.51"></a><span id="l21.51">     serverIndex++;</span>
<a href="#l21.52"></a><span id="l21.52"> </span>
<a href="#l21.53"></a><span id="l21.53">     nsCOMPtr&lt;nsINntpIncomingServer&gt; newsServer = do_QueryInterface(server);</span>
<a href="#l21.54"></a><span id="l21.54">     if (newsServer)  // news servers aren't involved in offline imap</span>
<a href="#l21.55"></a><span id="l21.55">       continue;</span>
<a href="#l21.56"></a><span id="l21.56"> </span>
<a href="#l21.57"></a><span id="l21.57">     if (server) {</span>
<a href="#l21.58"></a><span id="l21.58">       m_currentServer = server;</span>
<a href="#l21.59"></a><span id="l21.59" class="difflineat">@@ -992,34 +991,26 @@ nsImapOfflineDownloader::nsImapOfflineDo</span>
<a href="#l21.60"></a><span id="l21.60">       do_GetService(NS_AUTOSYNCMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l21.61"></a><span id="l21.61">   if (NS_SUCCEEDED(rv)) autoSyncMgr-&gt;Pause();</span>
<a href="#l21.62"></a><span id="l21.62"> }</span>
<a href="#l21.63"></a><span id="l21.63"> </span>
<a href="#l21.64"></a><span id="l21.64"> nsImapOfflineDownloader::~nsImapOfflineDownloader() {}</span>
<a href="#l21.65"></a><span id="l21.65"> </span>
<a href="#l21.66"></a><span id="l21.66"> nsresult nsImapOfflineDownloader::ProcessNextOperation() {</span>
<a href="#l21.67"></a><span id="l21.67">   nsresult rv = NS_OK;</span>
<a href="#l21.68"></a><span id="l21.68" class="difflineminus">-  if (!m_mailboxupdatesStarted) {</span>
<a href="#l21.69"></a><span id="l21.69" class="difflineminus">-    m_mailboxupdatesStarted = true;</span>
<a href="#l21.70"></a><span id="l21.70" class="difflineminus">-    // Update the INBOX first so the updates on the remaining</span>
<a href="#l21.71"></a><span id="l21.71" class="difflineminus">-    // folders pickup the results of any filter moves.</span>
<a href="#l21.72"></a><span id="l21.72" class="difflineminus">-    nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l21.73"></a><span id="l21.73" class="difflineminus">-        do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l21.74"></a><span id="l21.74" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l21.75"></a><span id="l21.75" class="difflineplus">+  m_mailboxupdatesStarted = true;</span>
<a href="#l21.76"></a><span id="l21.76"> </span>
<a href="#l21.77"></a><span id="l21.77" class="difflineminus">-    nsCOMPtr&lt;nsIArray&gt; servers;</span>
<a href="#l21.78"></a><span id="l21.78" class="difflineminus">-    rv = accountManager-&gt;GetAllServers(getter_AddRefs(servers));</span>
<a href="#l21.79"></a><span id="l21.79" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l21.80"></a><span id="l21.80" class="difflineminus">-  }</span>
<a href="#l21.81"></a><span id="l21.81">   if (!m_mailboxupdatesFinished) {</span>
<a href="#l21.82"></a><span id="l21.82">     if (AdvanceToNextServer()) {</span>
<a href="#l21.83"></a><span id="l21.83">       nsCOMPtr&lt;nsIMsgFolder&gt; rootMsgFolder;</span>
<a href="#l21.84"></a><span id="l21.84">       m_currentServer-&gt;GetRootFolder(getter_AddRefs(rootMsgFolder));</span>
<a href="#l21.85"></a><span id="l21.85">       nsCOMPtr&lt;nsIMsgFolder&gt; inbox;</span>
<a href="#l21.86"></a><span id="l21.86">       if (rootMsgFolder) {</span>
<a href="#l21.87"></a><span id="l21.87" class="difflineplus">+        // Update the INBOX first so the updates on the remaining</span>
<a href="#l21.88"></a><span id="l21.88" class="difflineplus">+        // folders pickup the results of any filter moves.</span>
<a href="#l21.89"></a><span id="l21.89">         rootMsgFolder-&gt;GetFolderWithFlags(nsMsgFolderFlags::Inbox,</span>
<a href="#l21.90"></a><span id="l21.90">                                           getter_AddRefs(inbox));</span>
<a href="#l21.91"></a><span id="l21.91">         if (inbox) {</span>
<a href="#l21.92"></a><span id="l21.92">           nsCOMPtr&lt;nsIMsgFolder&gt; offlineImapFolder;</span>
<a href="#l21.93"></a><span id="l21.93">           nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapInbox = do_QueryInterface(inbox);</span>
<a href="#l21.94"></a><span id="l21.94">           if (imapInbox) {</span>
<a href="#l21.95"></a><span id="l21.95">             rootMsgFolder-&gt;GetFolderWithFlags(</span>
<a href="#l21.96"></a><span id="l21.96">                 nsMsgFolderFlags::Offline, getter_AddRefs(offlineImapFolder));</span>
<a href="#l21.97"></a><span id="l21.97" class="difflineat">@@ -1048,17 +1039,17 @@ nsresult nsImapOfflineDownloader::Proces</span>
<a href="#l21.98"></a><span id="l21.98">             }</span>
<a href="#l21.99"></a><span id="l21.99">             rv = inbox-&gt;GetNewMessages(m_window, this);</span>
<a href="#l21.100"></a><span id="l21.100">             if (NS_SUCCEEDED(rv)) return rv;  // otherwise, fall through.</span>
<a href="#l21.101"></a><span id="l21.101">           }</span>
<a href="#l21.102"></a><span id="l21.102">         }</span>
<a href="#l21.103"></a><span id="l21.103">       }</span>
<a href="#l21.104"></a><span id="l21.104">       return ProcessNextOperation();  // recurse and do next server.</span>
<a href="#l21.105"></a><span id="l21.105">     }</span>
<a href="#l21.106"></a><span id="l21.106" class="difflineminus">-    m_allServers = nullptr;</span>
<a href="#l21.107"></a><span id="l21.107" class="difflineplus">+    m_allServers.Clear();</span>
<a href="#l21.108"></a><span id="l21.108">     m_mailboxupdatesFinished = true;</span>
<a href="#l21.109"></a><span id="l21.109">   }</span>
<a href="#l21.110"></a><span id="l21.110"> </span>
<a href="#l21.111"></a><span id="l21.111">   while (AdvanceToNextFolder()) {</span>
<a href="#l21.112"></a><span id="l21.112">     uint32_t folderFlags;</span>
<a href="#l21.113"></a><span id="l21.113"> </span>
<a href="#l21.114"></a><span id="l21.114">     ClearDB();</span>
<a href="#l21.115"></a><span id="l21.115">     nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapFolder;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/imap/src/nsImapOfflineSync.h</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapOfflineSync.h</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -60,17 +60,17 @@ class nsImapOfflineSync : public nsIUrlL</span>
<a href="#l22.4"></a><span id="l22.4">   void ProcessCopyOperation(nsIMsgOfflineImapOperation *currentOp);</span>
<a href="#l22.5"></a><span id="l22.5">   void ProcessEmptyTrash();</span>
<a href="#l22.6"></a><span id="l22.6">   void ProcessAppendMsgOperation(nsIMsgOfflineImapOperation *currentOp,</span>
<a href="#l22.7"></a><span id="l22.7">                                  nsOfflineImapOperationType opType);</span>
<a href="#l22.8"></a><span id="l22.8"> </span>
<a href="#l22.9"></a><span id="l22.9">   nsCOMPtr&lt;nsIMsgFolder&gt; m_currentFolder;</span>
<a href="#l22.10"></a><span id="l22.10">   nsCOMPtr&lt;nsIMsgFolder&gt; m_singleFolderToUpdate;</span>
<a href="#l22.11"></a><span id="l22.11">   nsCOMPtr&lt;nsIMsgWindow&gt; m_window;</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-  nsCOMPtr&lt;nsIArray&gt; m_allServers;</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+  nsTArray&lt;RefPtr&lt;nsIMsgIncomingServer&gt;&gt; m_allServers;</span>
<a href="#l22.14"></a><span id="l22.14">   nsCOMPtr&lt;nsIArray&gt; m_allFolders;</span>
<a href="#l22.15"></a><span id="l22.15">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; m_currentServer;</span>
<a href="#l22.16"></a><span id="l22.16">   nsCOMPtr&lt;nsISimpleEnumerator&gt; m_serverEnumerator;</span>
<a href="#l22.17"></a><span id="l22.17">   nsCOMPtr&lt;nsIFile&gt; m_curTempFile;</span>
<a href="#l22.18"></a><span id="l22.18"> </span>
<a href="#l22.19"></a><span id="l22.19">   nsTArray&lt;nsMsgKey&gt; m_CurrentKeys;</span>
<a href="#l22.20"></a><span id="l22.20">   nsCOMArray&lt;nsIMsgOfflineImapOperation&gt; m_currentOpsToClear;</span>
<a href="#l22.21"></a><span id="l22.21">   uint32_t m_KeyIndex;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/news/src/nsNewsDownloader.cpp</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/news/src/nsNewsDownloader.cpp</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -322,41 +322,41 @@ nsMsgDownloadAllNewsgroups::OnStopRunnin</span>
<a href="#l23.4"></a><span id="l23.4">  * might have folders to download for offline use. If no more servers,</span>
<a href="#l23.5"></a><span id="l23.5">  * m_currentServer will be left at nullptr and the function returns false.</span>
<a href="#l23.6"></a><span id="l23.6">  * Also, sets up m_serverEnumerator to enumerate over the server.</span>
<a href="#l23.7"></a><span id="l23.7">  * If no servers found, m_serverEnumerator will be left at null.</span>
<a href="#l23.8"></a><span id="l23.8">  */</span>
<a href="#l23.9"></a><span id="l23.9"> bool nsMsgDownloadAllNewsgroups::AdvanceToNextServer() {</span>
<a href="#l23.10"></a><span id="l23.10">   nsresult rv;</span>
<a href="#l23.11"></a><span id="l23.11"> </span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-  if (!m_allServers) {</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+  if (m_allServers.IsEmpty()) {</span>
<a href="#l23.14"></a><span id="l23.14">     nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l23.15"></a><span id="l23.15">         do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l23.16"></a><span id="l23.16">     NS_ASSERTION(accountManager &amp;&amp; NS_SUCCEEDED(rv),</span>
<a href="#l23.17"></a><span id="l23.17">                  &quot;couldn't get account mgr&quot;);</span>
<a href="#l23.18"></a><span id="l23.18">     if (!accountManager || NS_FAILED(rv)) return false;</span>
<a href="#l23.19"></a><span id="l23.19"> </span>
<a href="#l23.20"></a><span id="l23.20" class="difflineminus">-    rv = accountManager-&gt;GetAllServers(getter_AddRefs(m_allServers));</span>
<a href="#l23.21"></a><span id="l23.21" class="difflineplus">+    rv = accountManager-&gt;GetAllServers(m_allServers);</span>
<a href="#l23.22"></a><span id="l23.22">     NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l23.23"></a><span id="l23.23">   }</span>
<a href="#l23.24"></a><span id="l23.24">   uint32_t serverIndex = 0;</span>
<a href="#l23.25"></a><span id="l23.25">   if (m_currentServer) {</span>
<a href="#l23.26"></a><span id="l23.26" class="difflineminus">-    rv = m_allServers-&gt;IndexOf(0, m_currentServer, &amp;serverIndex);</span>
<a href="#l23.27"></a><span id="l23.27" class="difflineminus">-    if (NS_FAILED(rv)) serverIndex = -1;</span>
<a href="#l23.28"></a><span id="l23.28" class="difflineminus">-</span>
<a href="#l23.29"></a><span id="l23.29" class="difflineminus">-    ++serverIndex;</span>
<a href="#l23.30"></a><span id="l23.30" class="difflineplus">+    serverIndex = m_allServers.IndexOf(m_currentServer);</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineplus">+    if (serverIndex == m_allServers.NoIndex) {</span>
<a href="#l23.32"></a><span id="l23.32" class="difflineplus">+      serverIndex = 0;</span>
<a href="#l23.33"></a><span id="l23.33" class="difflineplus">+    } else {</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineplus">+      ++serverIndex;</span>
<a href="#l23.35"></a><span id="l23.35" class="difflineplus">+    }</span>
<a href="#l23.36"></a><span id="l23.36">   }</span>
<a href="#l23.37"></a><span id="l23.37">   m_currentServer = nullptr;</span>
<a href="#l23.38"></a><span id="l23.38" class="difflineminus">-  uint32_t numServers;</span>
<a href="#l23.39"></a><span id="l23.39" class="difflineminus">-  m_allServers-&gt;GetLength(&amp;numServers);</span>
<a href="#l23.40"></a><span id="l23.40" class="difflineplus">+  uint32_t numServers = m_allServers.Length();</span>
<a href="#l23.41"></a><span id="l23.41">   nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l23.42"></a><span id="l23.42"> </span>
<a href="#l23.43"></a><span id="l23.43">   while (serverIndex &lt; numServers) {</span>
<a href="#l23.44"></a><span id="l23.44" class="difflineminus">-    nsCOMPtr&lt;nsIMsgIncomingServer&gt; server =</span>
<a href="#l23.45"></a><span id="l23.45" class="difflineminus">-        do_QueryElementAt(m_allServers, serverIndex);</span>
<a href="#l23.46"></a><span id="l23.46" class="difflineplus">+    nsCOMPtr&lt;nsIMsgIncomingServer&gt; server(m_allServers[serverIndex]);</span>
<a href="#l23.47"></a><span id="l23.47">     serverIndex++;</span>
<a href="#l23.48"></a><span id="l23.48"> </span>
<a href="#l23.49"></a><span id="l23.49">     nsCOMPtr&lt;nsINntpIncomingServer&gt; newsServer = do_QueryInterface(server);</span>
<a href="#l23.50"></a><span id="l23.50">     if (!newsServer)  // we're only looking for news servers</span>
<a href="#l23.51"></a><span id="l23.51">       continue;</span>
<a href="#l23.52"></a><span id="l23.52"> </span>
<a href="#l23.53"></a><span id="l23.53">     if (server) {</span>
<a href="#l23.54"></a><span id="l23.54">       m_currentServer = server;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/news/src/nsNewsDownloader.h</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/news/src/nsNewsDownloader.h</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -119,17 +119,17 @@ class nsMsgDownloadAllNewsgroups : publi</span>
<a href="#l24.4"></a><span id="l24.4">   bool AdvanceToNextServer();</span>
<a href="#l24.5"></a><span id="l24.5">   bool AdvanceToNextGroup();</span>
<a href="#l24.6"></a><span id="l24.6">   nsresult DownloadMsgsForCurrentGroup();</span>
<a href="#l24.7"></a><span id="l24.7"> </span>
<a href="#l24.8"></a><span id="l24.8">   RefPtr&lt;DownloadMatchingNewsArticlesToNewsDB&gt; m_downloaderForGroup;</span>
<a href="#l24.9"></a><span id="l24.9"> </span>
<a href="#l24.10"></a><span id="l24.10">   nsCOMPtr&lt;nsIMsgFolder&gt; m_currentFolder;</span>
<a href="#l24.11"></a><span id="l24.11">   nsCOMPtr&lt;nsIMsgWindow&gt; m_window;</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-  nsCOMPtr&lt;nsIArray&gt; m_allServers;</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+  nsTArray&lt;RefPtr&lt;nsIMsgIncomingServer&gt;&gt; m_allServers;</span>
<a href="#l24.14"></a><span id="l24.14">   nsCOMPtr&lt;nsIArray&gt; m_allFolders;</span>
<a href="#l24.15"></a><span id="l24.15">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; m_currentServer;</span>
<a href="#l24.16"></a><span id="l24.16">   nsCOMPtr&lt;nsISimpleEnumerator&gt; m_serverEnumerator;</span>
<a href="#l24.17"></a><span id="l24.17">   nsCOMPtr&lt;nsIUrlListener&gt; m_listener;</span>
<a href="#l24.18"></a><span id="l24.18"> </span>
<a href="#l24.19"></a><span id="l24.19">   bool m_downloadedHdrsForCurGroup;</span>
<a href="#l24.20"></a><span id="l24.20"> };</span>
<a href="#l24.21"></a><span id="l24.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/news/src/nsNntpService.cpp</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/news/src/nsNntpService.cpp</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -605,41 +605,35 @@ nsNntpService::CopyMessages(const nsTArr</span>
<a href="#l25.4"></a><span id="l25.4"> nsresult nsNntpService::FindServerWithNewsgroup(nsCString &amp;host,</span>
<a href="#l25.5"></a><span id="l25.5">                                                 nsCString &amp;groupName) {</span>
<a href="#l25.6"></a><span id="l25.6">   nsresult rv;</span>
<a href="#l25.7"></a><span id="l25.7"> </span>
<a href="#l25.8"></a><span id="l25.8">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l25.9"></a><span id="l25.9">       do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l25.10"></a><span id="l25.10">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.11"></a><span id="l25.11"> </span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-  nsCOMPtr&lt;nsIArray&gt; servers;</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineminus">-  rv = accountManager-&gt;GetAllServers(getter_AddRefs(servers));</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineplus">+  nsTArray&lt;RefPtr&lt;nsIMsgIncomingServer&gt;&gt; servers;</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineplus">+  rv = accountManager-&gt;GetAllServers(servers);</span>
<a href="#l25.16"></a><span id="l25.16">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.17"></a><span id="l25.17"> </span>
<a href="#l25.18"></a><span id="l25.18">   NS_ASSERTION(mozilla::IsUtf8(groupName), &quot;newsgroup is not in UTF-8&quot;);</span>
<a href="#l25.19"></a><span id="l25.19"> </span>
<a href="#l25.20"></a><span id="l25.20">   // XXX TODO</span>
<a href="#l25.21"></a><span id="l25.21">   // this only looks at the list of subscribed newsgroups.</span>
<a href="#l25.22"></a><span id="l25.22">   // fix to use the hostinfo.dat information</span>
<a href="#l25.23"></a><span id="l25.23"> </span>
<a href="#l25.24"></a><span id="l25.24" class="difflineminus">-  uint32_t length;</span>
<a href="#l25.25"></a><span id="l25.25" class="difflineminus">-  rv = servers-&gt;GetLength(&amp;length);</span>
<a href="#l25.26"></a><span id="l25.26" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.27"></a><span id="l25.27" class="difflineminus">-</span>
<a href="#l25.28"></a><span id="l25.28" class="difflineminus">-  for (uint32_t i = 0; i &lt; length; ++i) {</span>
<a href="#l25.29"></a><span id="l25.29" class="difflineminus">-    nsCOMPtr&lt;nsINntpIncomingServer&gt; newsserver(</span>
<a href="#l25.30"></a><span id="l25.30" class="difflineminus">-        do_QueryElementAt(servers, i, &amp;rv));</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineminus">-    if (NS_FAILED(rv)) continue;</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineplus">+  for (auto server : servers) {</span>
<a href="#l25.33"></a><span id="l25.33" class="difflineplus">+    nsCOMPtr&lt;nsINntpIncomingServer&gt; newsserver = do_QueryInterface(server);</span>
<a href="#l25.34"></a><span id="l25.34" class="difflineplus">+    if (!newsserver) {</span>
<a href="#l25.35"></a><span id="l25.35" class="difflineplus">+      continue;</span>
<a href="#l25.36"></a><span id="l25.36" class="difflineplus">+    }</span>
<a href="#l25.37"></a><span id="l25.37"> </span>
<a href="#l25.38"></a><span id="l25.38">     bool containsGroup = false;</span>
<a href="#l25.39"></a><span id="l25.39">     rv = newsserver-&gt;ContainsNewsgroup(groupName, &amp;containsGroup);</span>
<a href="#l25.40"></a><span id="l25.40">     if (containsGroup) {</span>
<a href="#l25.41"></a><span id="l25.41" class="difflineminus">-      nsCOMPtr&lt;nsIMsgIncomingServer&gt; server(do_QueryInterface(newsserver, &amp;rv));</span>
<a href="#l25.42"></a><span id="l25.42" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.43"></a><span id="l25.43" class="difflineminus">-</span>
<a href="#l25.44"></a><span id="l25.44">       return server-&gt;GetHostName(host);</span>
<a href="#l25.45"></a><span id="l25.45">     }</span>
<a href="#l25.46"></a><span id="l25.46">   }</span>
<a href="#l25.47"></a><span id="l25.47">   return NS_OK;</span>
<a href="#l25.48"></a><span id="l25.48"> }</span>
<a href="#l25.49"></a><span id="l25.49"> </span>
<a href="#l25.50"></a><span id="l25.50"> nsresult nsNntpService::FindHostFromGroup(nsCString &amp;host,</span>
<a href="#l25.51"></a><span id="l25.51">                                           nsCString &amp;groupName) {</span>
<a href="#l25.52"></a><span id="l25.52" class="difflineat">@@ -946,18 +940,18 @@ nsresult nsNntpService::GetServerForUri(</span>
<a href="#l25.53"></a><span id="l25.53">   // find the incoming server, it if exists.</span>
<a href="#l25.54"></a><span id="l25.54">   // migrate if necessary, before searching for it.</span>
<a href="#l25.55"></a><span id="l25.55">   // if it doesn't exist, create it.</span>
<a href="#l25.56"></a><span id="l25.56">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l25.57"></a><span id="l25.57"> </span>
<a href="#l25.58"></a><span id="l25.58">   // Grab all servers for if this is a no-authority URL. This also loads</span>
<a href="#l25.59"></a><span id="l25.59">   // accounts if they haven't been loaded, i.e., we're running this straight</span>
<a href="#l25.60"></a><span id="l25.60">   // from the command line</span>
<a href="#l25.61"></a><span id="l25.61" class="difflineminus">-  nsCOMPtr&lt;nsIArray&gt; servers;</span>
<a href="#l25.62"></a><span id="l25.62" class="difflineminus">-  rv = accountManager-&gt;GetAllServers(getter_AddRefs(servers));</span>
<a href="#l25.63"></a><span id="l25.63" class="difflineplus">+  nsTArray&lt;RefPtr&lt;nsIMsgIncomingServer&gt;&gt; servers;</span>
<a href="#l25.64"></a><span id="l25.64" class="difflineplus">+  rv = accountManager-&gt;GetAllServers(servers);</span>
<a href="#l25.65"></a><span id="l25.65">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.66"></a><span id="l25.66"> </span>
<a href="#l25.67"></a><span id="l25.67">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailUrl = do_QueryInterface(aUri, &amp;rv);</span>
<a href="#l25.68"></a><span id="l25.68">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.69"></a><span id="l25.69"> </span>
<a href="#l25.70"></a><span id="l25.70">   rv = mailUrl-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l25.71"></a><span id="l25.71">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l25.72"></a><span id="l25.72"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/suite/mailnews/content/FilterListDialog.js</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/suite/mailnews/content/FilterListDialog.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -518,23 +518,18 @@ function getServerThatCanHaveFilters()</span>
<a href="#l26.4"></a><span id="l26.4">       let defaultIncomingServer = defaultAccount.incomingServer;</span>
<a href="#l26.5"></a><span id="l26.5">       // Check to see if default server can have filters.</span>
<a href="#l26.6"></a><span id="l26.6">       if (defaultIncomingServer.canHaveFilters)</span>
<a href="#l26.7"></a><span id="l26.7">         return defaultIncomingServer;</span>
<a href="#l26.8"></a><span id="l26.8">     }</span>
<a href="#l26.9"></a><span id="l26.9"> </span>
<a href="#l26.10"></a><span id="l26.10">     // if it cannot, check all accounts to find a server</span>
<a href="#l26.11"></a><span id="l26.11">     // that can have filters</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-    var allServers = MailServices.accounts.allServers;</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineminus">-    var numServers = allServers.length;</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineminus">-    for (var index = 0; index &lt; numServers; index++)</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineplus">+    for (let currentServer of MailServices.accounts.allServers)</span>
<a href="#l26.16"></a><span id="l26.16">     {</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineminus">-        var currentServer =</span>
<a href="#l26.18"></a><span id="l26.18" class="difflineminus">-          allServers.queryElementAt(index, Ci.nsIMsgIncomingServer);</span>
<a href="#l26.19"></a><span id="l26.19" class="difflineminus">-</span>
<a href="#l26.20"></a><span id="l26.20">         if (currentServer.canHaveFilters)</span>
<a href="#l26.21"></a><span id="l26.21">             return currentServer;</span>
<a href="#l26.22"></a><span id="l26.22">     }</span>
<a href="#l26.23"></a><span id="l26.23"> </span>
<a href="#l26.24"></a><span id="l26.24">     return null;</span>
<a href="#l26.25"></a><span id="l26.25"> }</span>
<a href="#l26.26"></a><span id="l26.26"> </span>
<a href="#l26.27"></a><span id="l26.27"> function onFilterDoubleClick(event)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/suite/mailnews/content/mail3PaneWindowCommands.js</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/suite/mailnews/content/mail3PaneWindowCommands.js</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -842,19 +842,17 @@ function IsSendUnsentMsgsEnabled(folderR</span>
<a href="#l27.4"></a><span id="l27.4"> </span>
<a href="#l27.5"></a><span id="l27.5"> /**</span>
<a href="#l27.6"></a><span id="l27.6">  * Determine whether there exists any server for which to show the Subscribe dialog.</span>
<a href="#l27.7"></a><span id="l27.7">  */</span>
<a href="#l27.8"></a><span id="l27.8"> function IsSubscribeEnabled()</span>
<a href="#l27.9"></a><span id="l27.9"> {</span>
<a href="#l27.10"></a><span id="l27.10">   // If there are any IMAP or News servers, we can show the dialog any time and</span>
<a href="#l27.11"></a><span id="l27.11">   // it will properly show those.</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-  let servers = accountManager.allServers;</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineminus">-  for (let server of fixIterator(servers,</span>
<a href="#l27.14"></a><span id="l27.14" class="difflineminus">-                                 Ci.nsIMsgIncomingServer)) {</span>
<a href="#l27.15"></a><span id="l27.15" class="difflineplus">+  for (let server of accountManager.allServers) {</span>
<a href="#l27.16"></a><span id="l27.16">     if (server.type == &quot;imap&quot; || server.type == &quot;nntp&quot;)</span>
<a href="#l27.17"></a><span id="l27.17">       return true;</span>
<a href="#l27.18"></a><span id="l27.18">   }</span>
<a href="#l27.19"></a><span id="l27.19"> </span>
<a href="#l27.20"></a><span id="l27.20">   // RSS accounts use a separate Subscribe dialog that we can only show when</span>
<a href="#l27.21"></a><span id="l27.21">   // such an account is selected.</span>
<a href="#l27.22"></a><span id="l27.22">   let preselectedFolder = GetFirstSelectedMsgFolder();</span>
<a href="#l27.23"></a><span id="l27.23">   if (preselectedFolder &amp;&amp; preselectedFolder.server.type == &quot;rss&quot;)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/suite/mailnews/content/mailContextMenus.js</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/suite/mailnews/content/mailContextMenus.js</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -565,24 +565,21 @@ function OpenMessageForMessageId(message</span>
<a href="#l28.4"></a><span id="l28.4">   // first search in current folder for message id</span>
<a href="#l28.5"></a><span id="l28.5">   var messageHeader = CheckForMessageIdInFolder(gDBView.msgFolder, messageId);</span>
<a href="#l28.6"></a><span id="l28.6"> </span>
<a href="#l28.7"></a><span id="l28.7">   // if message id not found in current folder search in all folders</span>
<a href="#l28.8"></a><span id="l28.8">   if (!messageHeader)</span>
<a href="#l28.9"></a><span id="l28.9">   {</span>
<a href="#l28.10"></a><span id="l28.10">     var accountManager = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l28.11"></a><span id="l28.11">                            .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-    var allServers = accountManager.allServers;</span>
<a href="#l28.13"></a><span id="l28.13"> </span>
<a href="#l28.14"></a><span id="l28.14">     messageHeader = SearchForMessageIdInSubFolder(startServer.rootFolder, messageId);</span>
<a href="#l28.15"></a><span id="l28.15"> </span>
<a href="#l28.16"></a><span id="l28.16" class="difflineminus">-    for (var i = 0; i &lt; allServers.length &amp;&amp; !messageHeader; i++)</span>
<a href="#l28.17"></a><span id="l28.17" class="difflineplus">+    for (let currentServer of accountManager.allServers)</span>
<a href="#l28.18"></a><span id="l28.18">     {</span>
<a href="#l28.19"></a><span id="l28.19" class="difflineminus">-      var currentServer =</span>
<a href="#l28.20"></a><span id="l28.20" class="difflineminus">-        allServers.queryElementAt(i, Ci.nsIMsgIncomingServer);</span>
<a href="#l28.21"></a><span id="l28.21">       if (currentServer &amp;&amp; startServer != currentServer &amp;&amp;</span>
<a href="#l28.22"></a><span id="l28.22">           currentServer.canSearchMessages &amp;&amp; !currentServer.isDeferredTo)</span>
<a href="#l28.23"></a><span id="l28.23">       {</span>
<a href="#l28.24"></a><span id="l28.24">         messageHeader = SearchForMessageIdInSubFolder(currentServer.rootFolder, messageId);</span>
<a href="#l28.25"></a><span id="l28.25">       }</span>
<a href="#l28.26"></a><span id="l28.26">     }</span>
<a href="#l28.27"></a><span id="l28.27">   }</span>
<a href="#l28.28"></a><span id="l28.28">   window.setCursor(&quot;auto&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/suite/mailnews/content/mailTasksOverlay.js</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/suite/mailnews/content/mailTasksOverlay.js</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -62,19 +62,18 @@ function MailTasksGetMessagesForAllServe</span>
<a href="#l29.4"></a><span id="l29.4">     var allServers = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l29.5"></a><span id="l29.5">                        .getService(Ci.nsIMsgAccountManager)</span>
<a href="#l29.6"></a><span id="l29.6">                        .allServers;</span>
<a href="#l29.7"></a><span id="l29.7">     // array of array of servers for a particular folder</span>
<a href="#l29.8"></a><span id="l29.8">     var pop3DownloadServersArray = [];</span>
<a href="#l29.9"></a><span id="l29.9">     // parallel array of folders to download to...</span>
<a href="#l29.10"></a><span id="l29.10">     var localFoldersToDownloadTo = [];</span>
<a href="#l29.11"></a><span id="l29.11">     var pop3Server = null;</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-    for (let i = 0; i &lt; allServers.length; ++i)</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineplus">+    for (let currentServer of allServers)</span>
<a href="#l29.14"></a><span id="l29.14">     {</span>
<a href="#l29.15"></a><span id="l29.15" class="difflineminus">-      let currentServer = allServers.queryElementAt(i, Ci.nsIMsgIncomingServer);</span>
<a href="#l29.16"></a><span id="l29.16">       if (currentServer)</span>
<a href="#l29.17"></a><span id="l29.17">       {</span>
<a href="#l29.18"></a><span id="l29.18">         if (aBiff)</span>
<a href="#l29.19"></a><span id="l29.19">         {</span>
<a href="#l29.20"></a><span id="l29.20">           if (currentServer.protocolInfo.canLoginAtStartUp &amp;&amp;</span>
<a href="#l29.21"></a><span id="l29.21">               currentServer.loginAtStartUp)</span>
<a href="#l29.22"></a><span id="l29.22">           {</span>
<a href="#l29.23"></a><span id="l29.23">             if (aDefaultServer &amp;&amp;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/suite/mailnews/modules/MailUtils.js</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/suite/mailnews/modules/MailUtils.js</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -18,18 +18,17 @@ var MailUtils =</span>
<a href="#l30.4"></a><span id="l30.4">    * Discover all folders. This is useful during startup, when you have code</span>
<a href="#l30.5"></a><span id="l30.5">    * that deals with folders and that executes before the main 3pane window is</span>
<a href="#l30.6"></a><span id="l30.6">    * open (the folder tree wouldn't have been initialized yet).</span>
<a href="#l30.7"></a><span id="l30.7">    */</span>
<a href="#l30.8"></a><span id="l30.8">   discoverFolders: function MailUtils_discoverFolders()</span>
<a href="#l30.9"></a><span id="l30.9">   {</span>
<a href="#l30.10"></a><span id="l30.10">     let accountManager = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l30.11"></a><span id="l30.11">                            .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-    let servers = accountManager.allServers;</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineminus">-    for (let server of fixIterator(servers, Ci.nsIMsgIncomingServer))</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineplus">+    for (let server of accountManager.allServers)</span>
<a href="#l30.15"></a><span id="l30.15">       server.rootFolder.subFolders;</span>
<a href="#l30.16"></a><span id="l30.16">   },</span>
<a href="#l30.17"></a><span id="l30.17"> </span>
<a href="#l30.18"></a><span id="l30.18">   /**</span>
<a href="#l30.19"></a><span id="l30.19">    * Get the nsIMsgFolder corresponding to this URI. This uses the RDF service</span>
<a href="#l30.20"></a><span id="l30.20">    * to do the work.</span>
<a href="#l30.21"></a><span id="l30.21">    *</span>
<a href="#l30.22"></a><span id="l30.22">    * @param aFolderURI the URI to convert into a folder</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:31Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

