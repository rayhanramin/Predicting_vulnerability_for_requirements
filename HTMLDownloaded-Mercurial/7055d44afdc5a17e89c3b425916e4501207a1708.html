<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 117:7055d44afdc5a17e89c3b425916e4501207a1708</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 7055d44afdc5a17e89c3b425916e4501207a1708" />
<meta property="og:url" content="/comm-central/rev/7055d44afdc5a17e89c3b425916e4501207a1708" />
<meta property="og:description" content="Merge conflict for bug 232515." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 7055d44afdc5a17e89c3b425916e4501207a1708 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/7055d44afdc5a17e89c3b425916e4501207a1708">shortlog</a> |
<a href="/comm-central/log/7055d44afdc5a17e89c3b425916e4501207a1708">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/7055d44afdc5a17e89c3b425916e4501207a1708">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/7055d44afdc5a17e89c3b425916e4501207a1708">files</a> |
changeset |
<a href="/comm-central/raw-rev/7055d44afdc5a17e89c3b425916e4501207a1708">raw</a>  | <a href="/comm-central/archive/7055d44afdc5a17e89c3b425916e4501207a1708.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Merge conflict for <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=232515">bug 232515</a>.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#77;&#97;&#103;&#110;&#117;&#115;&#32;&#77;&#101;&#108;&#105;&#110;&#32;&#60;&#109;&#107;&#109;&#101;&#108;&#105;&#110;&#64;&#105;&#107;&#105;&#46;&#102;&#105;&#62;</td></tr>
<tr><td></td><td class="date age">Sun, 17 Aug 2008 10:08:31 +0300</td></tr>

<tr>
 <td>changeset 117</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/7055d44afdc5a17e89c3b425916e4501207a1708">7055d44afdc5a17e89c3b425916e4501207a1708</a></td>
</tr>



<tr>
<td>parent 116</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/6e8b065f2b6c3bc1900194251089b96bba7590df">6e8b065f2b6c3bc1900194251089b96bba7590df</a> (current diff)
</td>
</tr>
<tr>
<td>parent 115</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/670443c1cb9e345f4d235b41550d0b58f613c186">670443c1cb9e345f4d235b41550d0b58f613c186</a> (<a href="/comm-central/rev/670443c1cb9e345f4d235b41550d0b58f613c186:7055d44afdc5">diff</a>)
</td>
</tr>

<tr>
<td>child 118</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/1b1889d9c36a664915b6f16ac51c6cc2e6f3d033">1b1889d9c36a664915b6f16ac51c6cc2e6f3d033</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=7055d44afdc5a17e89c3b425916e4501207a1708">103</a></td></tr>
<tr><td>push user</td><td>mkmelin@iki.fi</td></tr>
<tr><td>push date</td><td class="date age">Sun, 17 Aug 2008 07:09:02 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@7055d44afdc5 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=7055d44afdc5a17e89c3b425916e4501207a1708">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=7055d44afdc5a17e89c3b425916e4501207a1708&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7055d44afdc5a17e89c3b425916e4501207a1708&newProject=comm-central&newRevision=6e8b065f2b6c3bc1900194251089b96bba7590df&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7055d44afdc5a17e89c3b425916e4501207a1708&newProject=comm-central&newRevision=6e8b065f2b6c3bc1900194251089b96bba7590df&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=7055d44afdc5a17e89c3b425916e4501207a1708&newProject=comm-central&newRevision=6e8b065f2b6c3bc1900194251089b96bba7590df&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>

<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=232515">232515</a></td></tr>




</table></div>

<div class="page_body description">Merge conflict for <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=232515">bug 232515</a>.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/config/autoconf.mk.in</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/config/autoconf.mk.in</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -119,17 +119,16 @@ MOZ_MAIL_NEWS	= @MOZ_MAIL_NEWS@</span>
<a href="#l1.4"></a><span id="l1.4"> MOZ_CALENDAR	= @MOZ_CALENDAR@</span>
<a href="#l1.5"></a><span id="l1.5"> MOZ_PLAINTEXT_EDITOR_ONLY = @MOZ_PLAINTEXT_EDITOR_ONLY@</span>
<a href="#l1.6"></a><span id="l1.6"> MOZ_COMPOSER = @MOZ_COMPOSER@</span>
<a href="#l1.7"></a><span id="l1.7"> BUILD_STATIC_LIBS = @BUILD_STATIC_LIBS@</span>
<a href="#l1.8"></a><span id="l1.8"> MOZ_ENABLE_LIBXUL = @MOZ_ENABLE_LIBXUL@</span>
<a href="#l1.9"></a><span id="l1.9"> ENABLE_TESTS	= @ENABLE_TESTS@</span>
<a href="#l1.10"></a><span id="l1.10"> IBMBIDI = @IBMBIDI@</span>
<a href="#l1.11"></a><span id="l1.11"> MOZ_UNIVERSALCHARDET = @MOZ_UNIVERSALCHARDET@</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-SUNCTL = @SUNCTL@</span>
<a href="#l1.13"></a><span id="l1.13"> ACCESSIBILITY = @ACCESSIBILITY@</span>
<a href="#l1.14"></a><span id="l1.14"> MOZ_VIEW_SOURCE = @MOZ_VIEW_SOURCE@</span>
<a href="#l1.15"></a><span id="l1.15"> MOZ_XPINSTALL = @MOZ_XPINSTALL@</span>
<a href="#l1.16"></a><span id="l1.16"> MOZ_JSLOADER  = @MOZ_JSLOADER@</span>
<a href="#l1.17"></a><span id="l1.17"> MOZ_USE_NATIVE_UCONV = @MOZ_USE_NATIVE_UCONV@</span>
<a href="#l1.18"></a><span id="l1.18"> MOZ_LDAP_XPCOM = @MOZ_LDAP_XPCOM@</span>
<a href="#l1.19"></a><span id="l1.19"> MOZ_LDAP_XPCOM_EXPERIMENTAL = @MOZ_LDAP_XPCOM_EXPERIMENTAL@</span>
<a href="#l1.20"></a><span id="l1.20"> MOZ_BRANDING_DIRECTORY = @MOZ_BRANDING_DIRECTORY@</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/configure.in</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/configure.in</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1318,17 +1318,16 @@ if test &quot;$GNU_CC&quot;; then</span>
<a href="#l2.4"></a><span id="l2.4">     _MOZ_EXCEPTIONS_FLAGS_OFF='-fno-handle-exceptions'</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6">     # Turn on GNU specific features</span>
<a href="#l2.7"></a><span id="l2.7">     # -Wall - turn on all warnings</span>
<a href="#l2.8"></a><span id="l2.8">     # -pedantic - make compiler warn about non-ANSI stuff, and</span>
<a href="#l2.9"></a><span id="l2.9">     #             be a little bit stricter</span>
<a href="#l2.10"></a><span id="l2.10">     # Warnings slamm took out for now (these were giving more noise than help):</span>
<a href="#l2.11"></a><span id="l2.11">     # -Wbad-function-cast - warns when casting a function to a new return type</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-    # -Wconversion - complained when char's or short's were used a function args</span>
<a href="#l2.13"></a><span id="l2.13">     # -Wshadow - removed because it generates more noise than help --pete</span>
<a href="#l2.14"></a><span id="l2.14">     _WARNINGS_CFLAGS=&quot;${_WARNINGS_CFLAGS} -Wall -W -Wno-unused -Wpointer-arith&quot;</span>
<a href="#l2.15"></a><span id="l2.15">     if test -z &quot;$INTEL_CC&quot;; then</span>
<a href="#l2.16"></a><span id="l2.16">        # Don't use -Wcast-align with ICC</span>
<a href="#l2.17"></a><span id="l2.17">        case &quot;$CPU_ARCH&quot; in</span>
<a href="#l2.18"></a><span id="l2.18">            # And don't use it on hppa, ia64, sparc, since it's noisy there</span>
<a href="#l2.19"></a><span id="l2.19">            hppa | ia64 | sparc)</span>
<a href="#l2.20"></a><span id="l2.20">            ;;</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineat">@@ -1365,17 +1364,17 @@ else</span>
<a href="#l2.22"></a><span id="l2.22">     DSO_PIC_CFLAGS='-KPIC'</span>
<a href="#l2.23"></a><span id="l2.23">     _DEFINES_CFLAGS='$(ACDEFINES) -D_MOZILLA_CONFIG_H_ -DMOZILLA_CLIENT'</span>
<a href="#l2.24"></a><span id="l2.24"> fi</span>
<a href="#l2.25"></a><span id="l2.25"> </span>
<a href="#l2.26"></a><span id="l2.26"> if test &quot;$GNU_CXX&quot;; then</span>
<a href="#l2.27"></a><span id="l2.27">     # FIXME: Let us build with strict aliasing. bug 414641.</span>
<a href="#l2.28"></a><span id="l2.28">     CXXFLAGS=&quot;$CXXFLAGS -fno-strict-aliasing&quot;</span>
<a href="#l2.29"></a><span id="l2.29">     # Turn on GNU specific features</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-    _WARNINGS_CXXFLAGS=&quot;${_WARNINGS_CXXFLAGS} -Wall -Wconversion -Wpointer-arith -Woverloaded-virtual -Wsynth -Wno-ctor-dtor-privacy -Wno-non-virtual-dtor&quot;</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+    _WARNINGS_CXXFLAGS=&quot;${_WARNINGS_CXXFLAGS} -Wall -Wpointer-arith -Woverloaded-virtual -Wsynth -Wno-ctor-dtor-privacy -Wno-non-virtual-dtor&quot;</span>
<a href="#l2.32"></a><span id="l2.32">     if test -z &quot;$INTEL_CC&quot;; then</span>
<a href="#l2.33"></a><span id="l2.33">        # Don't use -Wcast-align with ICC</span>
<a href="#l2.34"></a><span id="l2.34">        case &quot;$CPU_ARCH&quot; in</span>
<a href="#l2.35"></a><span id="l2.35">            # And don't use it on hppa, ia64, sparc, since it's noisy there</span>
<a href="#l2.36"></a><span id="l2.36">            hppa | ia64 | sparc)</span>
<a href="#l2.37"></a><span id="l2.37">            ;;</span>
<a href="#l2.38"></a><span id="l2.38">            *)</span>
<a href="#l2.39"></a><span id="l2.39">         _WARNINGS_CXXFLAGS=&quot;${_WARNINGS_CXXFLAGS} -Wcast-align&quot;</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineat">@@ -4388,17 +4387,16 @@ MOZ_VIEW_SOURCE=1</span>
<a href="#l2.41"></a><span id="l2.41"> MOZ_XPFE_COMPONENTS=1</span>
<a href="#l2.42"></a><span id="l2.42"> MOZ_XPINSTALL=1</span>
<a href="#l2.43"></a><span id="l2.43"> MOZ_XSLT_STANDALONE=</span>
<a href="#l2.44"></a><span id="l2.44"> MOZ_XTF=1</span>
<a href="#l2.45"></a><span id="l2.45"> MOZ_XUL=1</span>
<a href="#l2.46"></a><span id="l2.46"> MOZ_XUL_APP=1</span>
<a href="#l2.47"></a><span id="l2.47"> MOZ_ZIPWRITER=1</span>
<a href="#l2.48"></a><span id="l2.48"> NS_PRINTING=1</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-SUNCTL=</span>
<a href="#l2.50"></a><span id="l2.50"> JS_STATIC_BUILD=</span>
<a href="#l2.51"></a><span id="l2.51"> XPC_IDISPATCH_SUPPORT=</span>
<a href="#l2.52"></a><span id="l2.52"> </span>
<a href="#l2.53"></a><span id="l2.53"> </span>
<a href="#l2.54"></a><span id="l2.54"> case &quot;$target_os&quot; in</span>
<a href="#l2.55"></a><span id="l2.55"> darwin*)</span>
<a href="#l2.56"></a><span id="l2.56">     ACCESSIBILITY=</span>
<a href="#l2.57"></a><span id="l2.57">     ;;</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineat">@@ -5100,24 +5098,16 @@ if test -n &quot;$MOZ_OJI&quot;; then</span>
<a href="#l2.59"></a><span id="l2.59">     AC_DEFINE(OJI)</span>
<a href="#l2.60"></a><span id="l2.60"> fi</span>
<a href="#l2.61"></a><span id="l2.61"> </span>
<a href="#l2.62"></a><span id="l2.62"> dnl bi-directional support always on</span>
<a href="#l2.63"></a><span id="l2.63"> IBMBIDI=1</span>
<a href="#l2.64"></a><span id="l2.64"> AC_DEFINE(IBMBIDI)</span>
<a href="#l2.65"></a><span id="l2.65"> </span>
<a href="#l2.66"></a><span id="l2.66"> dnl ========================================================</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineminus">-dnl complex text support off by default</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineminus">-dnl ========================================================</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineminus">-MOZ_ARG_ENABLE_BOOL(ctl,</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-[  --enable-ctl            Enable Thai Complex Script support],</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineminus">-    SUNCTL=1,</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineminus">-    SUNCTL= )</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineminus">-</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineminus">-dnl ========================================================</span>
<a href="#l2.75"></a><span id="l2.75"> dnl view source support on by default</span>
<a href="#l2.76"></a><span id="l2.76"> dnl ========================================================</span>
<a href="#l2.77"></a><span id="l2.77"> MOZ_ARG_DISABLE_BOOL(view-source,</span>
<a href="#l2.78"></a><span id="l2.78"> [  --disable-view-source     Disable view source support],</span>
<a href="#l2.79"></a><span id="l2.79">     MOZ_VIEW_SOURCE=,</span>
<a href="#l2.80"></a><span id="l2.80">     MOZ_VIEW_SOURCE=1 )</span>
<a href="#l2.81"></a><span id="l2.81"> if test &quot;$MOZ_VIEW_SOURCE&quot;; then</span>
<a href="#l2.82"></a><span id="l2.82">     AC_DEFINE(MOZ_VIEW_SOURCE)</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineat">@@ -7304,32 +7294,16 @@ if test &quot;$MOZ_LDAP_XPCOM&quot;; then</span>
<a href="#l2.84"></a><span id="l2.84">         fi</span>
<a href="#l2.85"></a><span id="l2.85">     elif test &quot;$OS_ARCH&quot; = &quot;OS2&quot;; then</span>
<a href="#l2.86"></a><span id="l2.86">             LDAP_LIBS='$(DIST)/lib/$(LIB_PREFIX)ldap60.${IMPORT_LIB_SUFFIX} $(DIST)/lib/$(LIB_PREFIX)prldap60.${IMPORT_LIB_SUFFIX} $(DIST)/lib/$(LIB_PREFIX)ldif60.${IMPORT_LIB_SUFFIX}'</span>
<a href="#l2.87"></a><span id="l2.87">     else</span>
<a href="#l2.88"></a><span id="l2.88">         LDAP_LIBS='-L${DIST}/bin -L${DIST}/lib -lldap60 -lprldap60 -lldif60'</span>
<a href="#l2.89"></a><span id="l2.89">     fi</span>
<a href="#l2.90"></a><span id="l2.90"> fi</span>
<a href="#l2.91"></a><span id="l2.91"> </span>
<a href="#l2.92"></a><span id="l2.92" class="difflineminus">-if test &quot;$COMPILE_ENVIRONMENT&quot;; then</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineminus">-if test &quot;$SUNCTL&quot;; then</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineminus">-    dnl older versions of glib do not seem to have gmodule which ctl needs</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineminus">-    _SAVE_CFLAGS=$CFLAGS</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineminus">-    CFLAGS=&quot;$CFLAGS $GLIB_CFLAGS&quot;</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineminus">-    AC_LANG_SAVE</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineminus">-    AC_LANG_C</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineminus">-    AC_TRY_COMPILE([#include &lt;gmodule.h&gt;],</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineminus">-        [ int x = 1; x++; ],,</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineminus">-        [AC_MSG_ERROR([Cannot build ctl without gmodule support in glib.])])</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineminus">-    AC_LANG_RESTORE</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineminus">-    CFLAGS=$_SAVE_CFLAGS</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineminus">-    AC_DEFINE(SUNCTL)</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineminus">-fi</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineminus">-fi # COMPILE_ENVIRONMENT</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineminus">-</span>
<a href="#l2.108"></a><span id="l2.108"> dnl ========================================================</span>
<a href="#l2.109"></a><span id="l2.109"> dnl =</span>
<a href="#l2.110"></a><span id="l2.110"> dnl = Maintainer debug option (no --enable equivalent)</span>
<a href="#l2.111"></a><span id="l2.111"> dnl =</span>
<a href="#l2.112"></a><span id="l2.112"> dnl ========================================================</span>
<a href="#l2.113"></a><span id="l2.113"> </span>
<a href="#l2.114"></a><span id="l2.114"> AC_SUBST(AR)</span>
<a href="#l2.115"></a><span id="l2.115"> AC_SUBST(AR_FLAGS)</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineat">@@ -7422,17 +7396,16 @@ AC_SUBST(HAVE_XIE)</span>
<a href="#l2.117"></a><span id="l2.117"> AC_SUBST(MOZ_XIE_LIBS)</span>
<a href="#l2.118"></a><span id="l2.118"> AC_SUBST(MOZ_ENABLE_POSTSCRIPT)</span>
<a href="#l2.119"></a><span id="l2.119"> </span>
<a href="#l2.120"></a><span id="l2.120"> AC_SUBST(XPCOM_USE_LEA)</span>
<a href="#l2.121"></a><span id="l2.121"> AC_SUBST(BUILD_STATIC_LIBS)</span>
<a href="#l2.122"></a><span id="l2.122"> AC_SUBST(MOZ_ENABLE_LIBXUL)</span>
<a href="#l2.123"></a><span id="l2.123"> AC_SUBST(ENABLE_TESTS)</span>
<a href="#l2.124"></a><span id="l2.124"> AC_SUBST(IBMBIDI)</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineminus">-AC_SUBST(SUNCTL)</span>
<a href="#l2.126"></a><span id="l2.126"> AC_SUBST(MOZ_UNIVERSALCHARDET)</span>
<a href="#l2.127"></a><span id="l2.127"> AC_SUBST(ACCESSIBILITY)</span>
<a href="#l2.128"></a><span id="l2.128"> AC_SUBST(MOZ_XPINSTALL)</span>
<a href="#l2.129"></a><span id="l2.129"> AC_SUBST(MOZ_VIEW_SOURCE)</span>
<a href="#l2.130"></a><span id="l2.130"> AC_SUBST(MOZ_SPELLCHECK)</span>
<a href="#l2.131"></a><span id="l2.131"> AC_SUBST(MOZ_XPFE_COMPONENTS)</span>
<a href="#l2.132"></a><span id="l2.132"> AC_SUBST(MOZ_USER_DIR)</span>
<a href="#l2.133"></a><span id="l2.133"> AC_SUBST(MOZ_CRASHREPORTER)</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineat">@@ -7845,17 +7818,16 @@ LDFLAGS=&quot;$_SUBDIR_LDFLAGS&quot;</span>
<a href="#l2.135"></a><span id="l2.135"> HOST_CC=&quot;$_SUBDIR_HOST_CC&quot; </span>
<a href="#l2.136"></a><span id="l2.136"> HOST_CFLAGS=&quot;$_SUBDIR_HOST_CFLAGS&quot;</span>
<a href="#l2.137"></a><span id="l2.137"> HOST_LDFLAGS=&quot;$_SUBDIR_HOST_LDFLAGS&quot;</span>
<a href="#l2.138"></a><span id="l2.138"> RC=</span>
<a href="#l2.139"></a><span id="l2.139"> </span>
<a href="#l2.140"></a><span id="l2.140"> unset MAKEFILES</span>
<a href="#l2.141"></a><span id="l2.141"> unset CONFIG_FILES</span>
<a href="#l2.142"></a><span id="l2.142"> </span>
<a href="#l2.143"></a><span id="l2.143" class="difflineminus">-if test &quot;$COMPILE_ENVIRONMENT&quot;; then</span>
<a href="#l2.144"></a><span id="l2.144"> # build Mozilla first</span>
<a href="#l2.145"></a><span id="l2.145"> #</span>
<a href="#l2.146"></a><span id="l2.146"> # the subdir may not yet have been created in the build tree.</span>
<a href="#l2.147"></a><span id="l2.147"> #</span>
<a href="#l2.148"></a><span id="l2.148"> if test ! -d &quot;mozilla&quot;; then</span>
<a href="#l2.149"></a><span id="l2.149">     mkdir &quot;mozilla&quot;</span>
<a href="#l2.150"></a><span id="l2.150"> fi</span>
<a href="#l2.151"></a><span id="l2.151"> </span>
<a href="#l2.152"></a><span id="l2.152" class="difflineat">@@ -7876,16 +7848,17 @@ fi</span>
<a href="#l2.153"></a><span id="l2.153"> MOZ_BUILD_APP_CACHED=&quot;$MOZ_BUILD_APP&quot;</span>
<a href="#l2.154"></a><span id="l2.154"> if test -n &quot;$MOZ_CURRENT_PROJECT&quot;; then</span>
<a href="#l2.155"></a><span id="l2.155">     export MOZ_BUILD_APP=&quot;$MOZ_CURRENT_PROJECT&quot;</span>
<a href="#l2.156"></a><span id="l2.156"> fi</span>
<a href="#l2.157"></a><span id="l2.157"> AC_OUTPUT_SUBDIRS(mozilla)</span>
<a href="#l2.158"></a><span id="l2.158"> ac_configure_args=&quot;$_SUBDIR_CONFIG_ARGS&quot;</span>
<a href="#l2.159"></a><span id="l2.159"> MOZ_BUILD_APP=&quot;$MOZ_BUILD_APP_CACHED&quot;</span>
<a href="#l2.160"></a><span id="l2.160"> </span>
<a href="#l2.161"></a><span id="l2.161" class="difflineplus">+if test &quot;$COMPILE_ENVIRONMENT&quot;; then</span>
<a href="#l2.162"></a><span id="l2.162"> # if we're building the LDAP XPCOM component, we need to build </span>
<a href="#l2.163"></a><span id="l2.163"> # the c-sdk first.  </span>
<a href="#l2.164"></a><span id="l2.164"> #</span>
<a href="#l2.165"></a><span id="l2.165"> if test &quot;$MOZ_LDAP_XPCOM&quot;; then</span>
<a href="#l2.166"></a><span id="l2.166"> </span>
<a href="#l2.167"></a><span id="l2.167">     # these subdirs may not yet have been created in the build tree.</span>
<a href="#l2.168"></a><span id="l2.168">     # don't use the &quot;-p&quot; switch to mkdir, since not all platforms have it</span>
<a href="#l2.169"></a><span id="l2.169">     #</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/base/content/mailWindowOverlay.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/base/content/mailWindowOverlay.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -2552,23 +2552,25 @@ function allowRemoteContentForSender()</span>
<a href="#l3.4"></a><span id="l3.4">   // search through all of our local address books looking for a match.</span>
<a href="#l3.5"></a><span id="l3.5">   var enumerator = Components.classes[&quot;@mozilla.org/abmanager;1&quot;]</span>
<a href="#l3.6"></a><span id="l3.6">                              .getService(Components.interfaces.nsIAbManager)</span>
<a href="#l3.7"></a><span id="l3.7">                              .directories;</span>
<a href="#l3.8"></a><span id="l3.8">   var cardForEmailAddress;</span>
<a href="#l3.9"></a><span id="l3.9">   var addrbook;</span>
<a href="#l3.10"></a><span id="l3.10">   while (!cardForEmailAddress &amp;&amp; enumerator.hasMoreElements())</span>
<a href="#l3.11"></a><span id="l3.11">   {</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-    addrbook = enumerator.getNext();</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-    if (addrbook instanceof Components.interfaces.nsIAbMDBDirectory)</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+    addrbook = enumerator.getNext()</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+                         .QueryInterface(Components.interfaces.nsIAbDirectory);</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+    try {</span>
<a href="#l3.17"></a><span id="l3.17">       cardForEmailAddress = addrbook.cardForEmailAddress(authorEmailAddress);</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+    } catch (e) {}</span>
<a href="#l3.19"></a><span id="l3.19">   }</span>
<a href="#l3.20"></a><span id="l3.20"> </span>
<a href="#l3.21"></a><span id="l3.21">   var allowRemoteContent = false;</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-  if (cardForEmailAddress &amp;&amp; addrbook instanceof Components.interfaces.nsIAbDirectory)</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+  if (cardForEmailAddress)</span>
<a href="#l3.24"></a><span id="l3.24">   {</span>
<a href="#l3.25"></a><span id="l3.25">     // set the property for remote content</span>
<a href="#l3.26"></a><span id="l3.26">     cardForEmailAddress.setProperty(&quot;AllowRemoteContent&quot;, true);</span>
<a href="#l3.27"></a><span id="l3.27">     addrbook.modifyCard(cardForEmailAddress);</span>
<a href="#l3.28"></a><span id="l3.28">     allowRemoteContent = true;</span>
<a href="#l3.29"></a><span id="l3.29">   }</span>
<a href="#l3.30"></a><span id="l3.30">   else</span>
<a href="#l3.31"></a><span id="l3.31">   {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/base/content/msgHdrViewOverlay.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/base/content/msgHdrViewOverlay.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -972,26 +972,19 @@ function useDisplayNameForAddress(emailA</span>
<a href="#l4.4"></a><span id="l4.4"> {</span>
<a href="#l4.5"></a><span id="l4.5">   // For now, if the email address is in the personal address book, then consider this user a 'known' user</span>
<a href="#l4.6"></a><span id="l4.6">   // and use the display name. I could eventually see our rules enlarged to include other local ABs, replicated</span>
<a href="#l4.7"></a><span id="l4.7">   // LDAP directories, and maybe even domain matches (i.e. any email from someone in my company</span>
<a href="#l4.8"></a><span id="l4.8">   // should use the friendly display name)</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10">   if (!gPersonalAddressBookDirectory)</span>
<a href="#l4.11"></a><span id="l4.11">   {</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-    var dirs = Components.classes[&quot;@mozilla.org/abmanager;1&quot;]</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-                         .getService(Components.interfaces.nsIAbManager).directories;</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-    while (dirs.hasMoreElements) {</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-      var dir = dirs.getNext().QueryInterface(Components.interfaces.nsIAbDirectory);</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineminus">-      if (dir.URI == kPersonalAddressbookUri) {</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineminus">-        gPersonalAddressBookDirectory = dir.QueryInterface(Components.interfaces.nsIAbMDBDirectory);</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineminus">-        break;</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineminus">-      }</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineminus">-    }</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineminus">-</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+    var manager = Components.classes[&quot;@mozilla.org/abmanager;1&quot;]</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+                            .getService(Components.interfaces.nsIAbManager);</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+    gPersonalAddressBookDirectory = manager.getDirectory(kPersonalAddressbookUri);</span>
<a href="#l4.25"></a><span id="l4.25">     if (!gPersonalAddressBookDirectory)</span>
<a href="#l4.26"></a><span id="l4.26">       return false;</span>
<a href="#l4.27"></a><span id="l4.27">   }</span>
<a href="#l4.28"></a><span id="l4.28"> </span>
<a href="#l4.29"></a><span id="l4.29">   // look up the email address in the database</span>
<a href="#l4.30"></a><span id="l4.30">   return gPersonalAddressBookDirectory.cardForEmailAddress(emailAddress);</span>
<a href="#l4.31"></a><span id="l4.31"> }</span>
<a href="#l4.32"></a><span id="l4.32"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/addrbook/public/nsIAbDirectory.idl</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/addrbook/public/nsIAbDirectory.idl</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -54,17 +54,17 @@ interface nsIMutableArray;</span>
<a href="#l5.4"></a><span id="l5.4"> #define kCollectedAddressbook      &quot;history.mab&quot;</span>
<a href="#l5.5"></a><span id="l5.5"> #define kCollectedAddressbookUri   &quot;moz-abmdbdirectory://history.mab&quot;</span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7"> #define kABFileName_PreviousSuffix &quot;.na2&quot; /* final v2 address book format */</span>
<a href="#l5.8"></a><span id="l5.8"> #define kABFileName_PreviousSuffixLen 4</span>
<a href="#l5.9"></a><span id="l5.9"> #define kABFileName_CurrentSuffix &quot;.mab&quot;  /* v3 address book extension */</span>
<a href="#l5.10"></a><span id="l5.10"> %}</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-[scriptable, uuid(e30c442f-9d83-4f38-8d41-9884e81237a0)]</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+[scriptable, uuid(ab55bec3-5bf9-4928-8322-5cff399b7045)]</span>
<a href="#l5.14"></a><span id="l5.14"> interface nsIAbDirectory : nsISupports {</span>
<a href="#l5.15"></a><span id="l5.15"> </span>
<a href="#l5.16"></a><span id="l5.16">   /**</span>
<a href="#l5.17"></a><span id="l5.17">    * The chrome URI to use for bringing up a dialog to edit this directory.</span>
<a href="#l5.18"></a><span id="l5.18">    * When opening the dialog, use a JS argument of</span>
<a href="#l5.19"></a><span id="l5.19">    * {selectedDirectory: thisdir} where thisdir is this directory that you just</span>
<a href="#l5.20"></a><span id="l5.20">    * got the chrome URI from.</span>
<a href="#l5.21"></a><span id="l5.21">    */</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineat">@@ -302,9 +302,24 @@ interface nsIAbDirectory : nsISupports {</span>
<a href="#l5.23"></a><span id="l5.23">    *                      be obtained (e.g. dirPrefId isn't set).</span>
<a href="#l5.24"></a><span id="l5.24">    */</span>
<a href="#l5.25"></a><span id="l5.25">   //@{</span>
<a href="#l5.26"></a><span id="l5.26">   void setIntValue(in string aName, in long aValue);</span>
<a href="#l5.27"></a><span id="l5.27">   void setBoolValue(in string aName, in boolean aValue);</span>
<a href="#l5.28"></a><span id="l5.28">   void setStringValue(in string aName, in ACString aValue);</span>
<a href="#l5.29"></a><span id="l5.29">   void setLocalizedStringValue(in string aName, in AUTF8String aValue);</span>
<a href="#l5.30"></a><span id="l5.30">   //@}</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+  /** </span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+   * Returns the address card for the specified email address if found.</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+   *</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+   * If the address book type does not know how to find a card, it will throw</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+   * NS_ERROR_NOT_IMPLEMENTED. Core address book types do throw this exception,</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+   * so beware when calling this method.</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+   *</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+   * @param  emailAddress The email address to find in either the primary or</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+   *                      secondary email address fields. If email address is</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+   *                      empty, the database won't be searched and the function</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+   *                      will return as if no card was found.</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineplus">+   * @return              An nsIAbCard if one was found, else returns NULL.</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+   */</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+  nsIAbCard cardForEmailAddress(in AUTF8String emailAddress);</span>
<a href="#l5.46"></a><span id="l5.46"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/addrbook/public/nsIAbMDBDirectory.idl</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/addrbook/public/nsIAbMDBDirectory.idl</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -43,17 +43,17 @@ interface nsIAbDirectory;</span>
<a href="#l6.4"></a><span id="l6.4"> interface nsIAbCard;</span>
<a href="#l6.5"></a><span id="l6.5"> interface nsIAddrDatabase;</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7"> %{C++</span>
<a href="#l6.8"></a><span id="l6.8"> #define kMDBDirectoryRoot          &quot;moz-abmdbdirectory://&quot;</span>
<a href="#l6.9"></a><span id="l6.9"> #define kMDBDirectoryRootLen       21</span>
<a href="#l6.10"></a><span id="l6.10"> %}</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-[scriptable, uuid(705a6b63-118c-402d-a835-b07347de5a53)]</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+[scriptable, uuid(744072be-1ba0-46bc-af24-46e22567a2ea)]</span>
<a href="#l6.14"></a><span id="l6.14"> interface nsIAbMDBDirectory : nsISupports {</span>
<a href="#l6.15"></a><span id="l6.15"> </span>
<a href="#l6.16"></a><span id="l6.16"> 	// Creates an RDF directory component from the</span>
<a href="#l6.17"></a><span id="l6.17"> 	// uriName, adds it to its children and returns</span>
<a href="#l6.18"></a><span id="l6.18"> 	// the component</span>
<a href="#l6.19"></a><span id="l6.19"> 	nsIAbDirectory addDirectory(in string uriName);</span>
<a href="#l6.20"></a><span id="l6.20"> </span>
<a href="#l6.21"></a><span id="l6.21">   /**</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineat">@@ -96,20 +96,9 @@ interface nsIAbMDBDirectory : nsISupport</span>
<a href="#l6.23"></a><span id="l6.23"> 	void removeEmailAddressAt(in unsigned long aIndex);</span>
<a href="#l6.24"></a><span id="l6.24"> </span>
<a href="#l6.25"></a><span id="l6.25">     attribute unsigned long dbRowID;</span>
<a href="#l6.26"></a><span id="l6.26"> </span>
<a href="#l6.27"></a><span id="l6.27"> 	// Empty implementation, called by the data base</span>
<a href="#l6.28"></a><span id="l6.28"> 	[noscript] void notifyDirItemAdded(in nsISupports item);</span>
<a href="#l6.29"></a><span id="l6.29"> 	</span>
<a href="#l6.30"></a><span id="l6.30"> 	[noscript] void clearDatabase();</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-	</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-  /** </span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-   * Returns the address card for the specified email address if found.</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-   *</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">-   * @param  emailAddress The email address to find in either the primary or</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">-   *                      secondary email address fields. If email address is</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineminus">-   *                      empty, the database won't be searched and the function</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineminus">-   *                      will return as if no card was found.</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineminus">-   * @return              An nsIAbCard if one was found, else returns NULL.</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineminus">-   */</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineminus">-  nsIAbCard cardForEmailAddress(in AUTF8String emailAddress);</span>
<a href="#l6.42"></a><span id="l6.42"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbDirProperty.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbDirProperty.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -306,16 +306,20 @@ NS_IMETHODIMP nsAbDirProperty::ModifyCar</span>
<a href="#l7.4"></a><span id="l7.4"> { return NS_ERROR_NOT_IMPLEMENTED; }</span>
<a href="#l7.5"></a><span id="l7.5"> </span>
<a href="#l7.6"></a><span id="l7.6"> NS_IMETHODIMP nsAbDirProperty::DeleteCards(nsIArray *cards)</span>
<a href="#l7.7"></a><span id="l7.7"> { return NS_ERROR_NOT_IMPLEMENTED; }</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9"> NS_IMETHODIMP nsAbDirProperty::DropCard(nsIAbCard *childCard, PRBool needToCopyCard)</span>
<a href="#l7.10"></a><span id="l7.10"> { return NS_ERROR_NOT_IMPLEMENTED; }</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+NS_IMETHODIMP nsAbDirProperty::CardForEmailAddress(const nsACString &amp;aEmailAddress,</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+                                                   nsIAbCard ** aAbCard)</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+{ return NS_ERROR_NOT_IMPLEMENTED; }</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+</span>
<a href="#l7.16"></a><span id="l7.16"> NS_IMETHODIMP nsAbDirProperty::GetSupportsMailingLists(PRBool *aSupportsMailingsLists)</span>
<a href="#l7.17"></a><span id="l7.17"> {</span>
<a href="#l7.18"></a><span id="l7.18">   NS_ENSURE_ARG_POINTER(aSupportsMailingsLists);</span>
<a href="#l7.19"></a><span id="l7.19">   // We don't currently support nested mailing lists, so only return true if</span>
<a href="#l7.20"></a><span id="l7.20">   // we're not a mailing list.</span>
<a href="#l7.21"></a><span id="l7.21">   *aSupportsMailingsLists = !m_IsMailList;</span>
<a href="#l7.22"></a><span id="l7.22">   return NS_OK;</span>
<a href="#l7.23"></a><span id="l7.23"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbMDBDirProperty.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbMDBDirProperty.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -163,21 +163,16 @@ NS_IMETHODIMP nsAbMDBDirProperty::Notify</span>
<a href="#l8.4"></a><span id="l8.4"> }</span>
<a href="#l8.5"></a><span id="l8.5"> </span>
<a href="#l8.6"></a><span id="l8.6"> /* [noscript] void clearDatabase (); */</span>
<a href="#l8.7"></a><span id="l8.7"> NS_IMETHODIMP nsAbMDBDirProperty::ClearDatabase()</span>
<a href="#l8.8"></a><span id="l8.8"> {</span>
<a href="#l8.9"></a><span id="l8.9">     return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l8.10"></a><span id="l8.10"> }</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-NS_IMETHODIMP nsAbMDBDirProperty::CardForEmailAddress(const nsACString &amp;aEmailAddress, nsIAbCard ** aAbCard)</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-{</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-}</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">-</span>
<a href="#l8.17"></a><span id="l8.17"> NS_IMETHODIMP nsAbMDBDirProperty::GetDatabaseFile(nsILocalFile **aResult)</span>
<a href="#l8.18"></a><span id="l8.18"> {</span>
<a href="#l8.19"></a><span id="l8.19">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l8.20"></a><span id="l8.20"> }</span>
<a href="#l8.21"></a><span id="l8.21"> </span>
<a href="#l8.22"></a><span id="l8.22"> NS_IMETHODIMP nsAbMDBDirProperty::GetDatabase(nsIAddrDatabase **aResult)</span>
<a href="#l8.23"></a><span id="l8.23"> {</span>
<a href="#l8.24"></a><span id="l8.24">   return NS_ERROR_NOT_IMPLEMENTED;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_cardForEmail.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_cardForEmail.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1,11 +1,11 @@</span>
<a href="#l9.4"></a><span id="l9.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l9.5"></a><span id="l9.5"> /*</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineminus">- * Tests nsIAbMDBDirectory::cardForEmailAddress</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineplus">+ * Tests nsIAbDirectory::cardForEmailAddress</span>
<a href="#l9.8"></a><span id="l9.8">  * - checks correct return when no email address supplied</span>
<a href="#l9.9"></a><span id="l9.9">  * - checks correct return when no matching email address supplied</span>
<a href="#l9.10"></a><span id="l9.10">  * - checks correct return when matching email address supplied.</span>
<a href="#l9.11"></a><span id="l9.11">  *</span>
<a href="#l9.12"></a><span id="l9.12">  * Uses: cardForEmail.mab</span>
<a href="#l9.13"></a><span id="l9.13">  */</span>
<a href="#l9.14"></a><span id="l9.14"> </span>
<a href="#l9.15"></a><span id="l9.15"> function run_test() {</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineat">@@ -14,18 +14,17 @@ function run_test() {</span>
<a href="#l9.17"></a><span id="l9.17"> </span>
<a href="#l9.18"></a><span id="l9.18">   // Copy the file to the profile directory for a PAB</span>
<a href="#l9.19"></a><span id="l9.19">   testAB.copyTo(gProfileDir, kPABData.fileName);</span>
<a href="#l9.20"></a><span id="l9.20"> </span>
<a href="#l9.21"></a><span id="l9.21">   // Test - Get the directory</span>
<a href="#l9.22"></a><span id="l9.22">   var abManager = Components.classes[&quot;@mozilla.org/abmanager;1&quot;]</span>
<a href="#l9.23"></a><span id="l9.23">                             .getService(Components.interfaces.nsIAbManager);</span>
<a href="#l9.24"></a><span id="l9.24"> </span>
<a href="#l9.25"></a><span id="l9.25" class="difflineminus">-  var AB = abManager.getDirectory(kPABData.URI)</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineminus">-                .QueryInterface(Components.interfaces.nsIAbMDBDirectory);</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+  var AB = abManager.getDirectory(kPABData.URI);</span>
<a href="#l9.28"></a><span id="l9.28"> </span>
<a href="#l9.29"></a><span id="l9.29">   // Test - Check that a null string succeeds and does not</span>
<a href="#l9.30"></a><span id="l9.30">   // return a card (bug 404264)</span>
<a href="#l9.31"></a><span id="l9.31">   do_check_true(AB.cardForEmailAddress(null) == null);</span>
<a href="#l9.32"></a><span id="l9.32"> </span>
<a href="#l9.33"></a><span id="l9.33">   // Test - Check that an empty string succeeds and does not</span>
<a href="#l9.34"></a><span id="l9.34">   // return a card (bug 404264)</span>
<a href="#l9.35"></a><span id="l9.35">   do_check_true(AB.cardForEmailAddress(&quot;&quot;) == null);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_collection.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_collection.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -259,33 +259,30 @@ function run_test()</span>
<a href="#l10.4"></a><span id="l10.4"> </span>
<a href="#l10.5"></a><span id="l10.5">   // XXX Getting all directories ensures we create all ABs because the</span>
<a href="#l10.6"></a><span id="l10.6">   // address collecter can't currently create ABs itself (bug 314448).</span>
<a href="#l10.7"></a><span id="l10.7">   var temp = abManager.directories;</span>
<a href="#l10.8"></a><span id="l10.8"> </span>
<a href="#l10.9"></a><span id="l10.9">   // Get the actual AB for the collector so we can check cards have been</span>
<a href="#l10.10"></a><span id="l10.10">   // added.</span>
<a href="#l10.11"></a><span id="l10.11">   collectChecker.AB =</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-    abManager.getDirectory(prefService.getCharPref(&quot;mail.collect_addressbook&quot;))</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-             .QueryInterface(Components.interfaces.nsIAbMDBDirectory);</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+    abManager.getDirectory(prefService.getCharPref(&quot;mail.collect_addressbook&quot;));</span>
<a href="#l10.15"></a><span id="l10.15"> </span>
<a href="#l10.16"></a><span id="l10.16">   // Get the actual collecter</span>
<a href="#l10.17"></a><span id="l10.17">   collectChecker.addressCollect =</span>
<a href="#l10.18"></a><span id="l10.18">     Components.classes[&quot;@mozilla.org/addressbook/services/addressCollecter;1&quot;]</span>
<a href="#l10.19"></a><span id="l10.19">               .getService(Components.interfaces.nsIAbAddressCollecter);</span>
<a href="#l10.20"></a><span id="l10.20"> </span>
<a href="#l10.21"></a><span id="l10.21">   // Test - Addition of header without email address.</span>
<a href="#l10.22"></a><span id="l10.22"> </span>
<a href="#l10.23"></a><span id="l10.23">   collectChecker.addressCollect.collectAddress(&quot;MyTest &lt;&gt;&quot;, true,</span>
<a href="#l10.24"></a><span id="l10.24">                                                nsIAbPMF.unknown);</span>
<a href="#l10.25"></a><span id="l10.25"> </span>
<a href="#l10.26"></a><span id="l10.26" class="difflineminus">-  var CAB = collectChecker.AB.QueryInterface(Components.interfaces.nsIAbDirectory);</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineminus">-</span>
<a href="#l10.28"></a><span id="l10.28">   // Address book should have no cards present.</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineminus">-  do_check_false(CAB.childCards.hasMoreElements());</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineplus">+  do_check_false(collectChecker.AB.childCards.hasMoreElements());</span>
<a href="#l10.31"></a><span id="l10.31"> </span>
<a href="#l10.32"></a><span id="l10.32">   // Test - Email doesn't exist, but don't add it.</span>
<a href="#l10.33"></a><span id="l10.33"> </span>
<a href="#l10.34"></a><span id="l10.34">   // As we've just set everything up, we know we haven't got anything in the</span>
<a href="#l10.35"></a><span id="l10.35">   // AB, so just try and collect without adding.</span>
<a href="#l10.36"></a><span id="l10.36">   collectChecker.addressCollect.collectAddress(addEmailChecks[0].emailHeader,</span>
<a href="#l10.37"></a><span id="l10.37">                                                false,</span>
<a href="#l10.38"></a><span id="l10.38">                                                addEmailChecks[0].mailFormat);</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineat">@@ -298,45 +295,45 @@ function run_test()</span>
<a href="#l10.40"></a><span id="l10.40"> </span>
<a href="#l10.41"></a><span id="l10.41">   collectChecker.part = 0;</span>
<a href="#l10.42"></a><span id="l10.42"> </span>
<a href="#l10.43"></a><span id="l10.43">   addEmailChecks.forEach(collectChecker.checkAddress, collectChecker);</span>
<a href="#l10.44"></a><span id="l10.44"> </span>
<a href="#l10.45"></a><span id="l10.45">   // Test - Do all emails at the same time.</span>
<a href="#l10.46"></a><span id="l10.46"> </span>
<a href="#l10.47"></a><span id="l10.47">   // First delete all existing cards</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">-  var childCards = CAB.childCards;</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+  var childCards = collectChecker.AB.childCards;</span>
<a href="#l10.50"></a><span id="l10.50">   var cardsToDelete = Components.classes[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l10.51"></a><span id="l10.51">                                 .createInstance(Components.interfaces.nsIMutableArray);</span>
<a href="#l10.52"></a><span id="l10.52">   while (childCards.hasMoreElements()) {</span>
<a href="#l10.53"></a><span id="l10.53">     cardsToDelete.appendElement(childCards.getNext(), false);</span>
<a href="#l10.54"></a><span id="l10.54">   }</span>
<a href="#l10.55"></a><span id="l10.55"> </span>
<a href="#l10.56"></a><span id="l10.56" class="difflineminus">-  CAB.deleteCards(cardsToDelete);</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineplus">+  collectChecker.AB.deleteCards(cardsToDelete);</span>
<a href="#l10.58"></a><span id="l10.58"> </span>
<a href="#l10.59"></a><span id="l10.59">   // Null these directly, so gc() will purge them</span>
<a href="#l10.60"></a><span id="l10.60">   childCards = null;</span>
<a href="#l10.61"></a><span id="l10.61">   cardsToDelete = null;</span>
<a href="#l10.62"></a><span id="l10.62"> </span>
<a href="#l10.63"></a><span id="l10.63">   // Address book should have no cards present.</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineminus">-  do_check_false(CAB.childCards.hasMoreElements());</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineplus">+  do_check_false(collectChecker.AB.childCards.hasMoreElements());</span>
<a href="#l10.66"></a><span id="l10.66"> </span>
<a href="#l10.67"></a><span id="l10.67">   do_check_eq(collectChecker.AB.cardForEmailAddress(addEmailChecks[0].emailHeader), null);</span>
<a href="#l10.68"></a><span id="l10.68"> </span>
<a href="#l10.69"></a><span id="l10.69">   // Now do all emails at the same time.</span>
<a href="#l10.70"></a><span id="l10.70">   collectChecker.checkAll(addEmailChecks);</span>
<a href="#l10.71"></a><span id="l10.71"> </span>
<a href="#l10.72"></a><span id="l10.72">   // Test - Try and modify various emails and formats.</span>
<a href="#l10.73"></a><span id="l10.73"> </span>
<a href="#l10.74"></a><span id="l10.74">   // Add a basic card with just primary and second email to allow testing</span>
<a href="#l10.75"></a><span id="l10.75">   // of the case where we don't modify when second email is matching.</span>
<a href="#l10.76"></a><span id="l10.76">   card = Components.classes[&quot;@mozilla.org/addressbook/cardproperty;1&quot;]</span>
<a href="#l10.77"></a><span id="l10.77">                    .createInstance(Components.interfaces.nsIAbCard);</span>
<a href="#l10.78"></a><span id="l10.78"> </span>
<a href="#l10.79"></a><span id="l10.79">   card.primaryEmail = &quot;userprim\u00D0@invalid.com&quot;;</span>
<a href="#l10.80"></a><span id="l10.80">   card.setProperty(&quot;SecondEmail&quot;, &quot;usersec\u00D0@invalid.com&quot;);</span>
<a href="#l10.81"></a><span id="l10.81"> </span>
<a href="#l10.82"></a><span id="l10.82" class="difflineminus">-  CAB.addCard(card);</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineplus">+  collectChecker.AB.addCard(card);</span>
<a href="#l10.84"></a><span id="l10.84"> </span>
<a href="#l10.85"></a><span id="l10.85">   collectChecker.part = 0;</span>
<a href="#l10.86"></a><span id="l10.86"> </span>
<a href="#l10.87"></a><span id="l10.87">   modifyEmailChecks.forEach(collectChecker.checkAddress, collectChecker);</span>
<a href="#l10.88"></a><span id="l10.88"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/base/resources/content/junkCommands.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/base/resources/content/junkCommands.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -183,32 +183,36 @@ MessageClassifier.prototype =</span>
<a href="#l11.4"></a><span id="l11.4">    *</span>
<a href="#l11.5"></a><span id="l11.5">    * Starts the message classification process for a message. If the message</span>
<a href="#l11.6"></a><span id="l11.6">    * sender's address is in the address book specified by aWhiteListDirectory,</span>
<a href="#l11.7"></a><span id="l11.7">    * the message is skipped.</span>
<a href="#l11.8"></a><span id="l11.8">    *</span>
<a href="#l11.9"></a><span id="l11.9">    * @param aMsgHdr</span>
<a href="#l11.10"></a><span id="l11.10">    *        The header (nsIMsgDBHdr) of the message to classify.</span>
<a href="#l11.11"></a><span id="l11.11">    * @param aWhiteListDirectory</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-   *        The addressbook (nsIAbMDBDirectory) to use as a whitelist, or null</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+   *        The addressbook (nsIAbDirectory) to use as a whitelist, or null</span>
<a href="#l11.14"></a><span id="l11.14">    *        if no whitelisting should be done.</span>
<a href="#l11.15"></a><span id="l11.15">    */</span>
<a href="#l11.16"></a><span id="l11.16">   analyzeMessage: function(aMsgHdr, aWhiteListDirectory)</span>
<a href="#l11.17"></a><span id="l11.17">   {</span>
<a href="#l11.18"></a><span id="l11.18">     var junkscoreorigin = aMsgHdr.getStringProperty(&quot;junkscoreorigin&quot;);</span>
<a href="#l11.19"></a><span id="l11.19">     if (junkscoreorigin == &quot;user&quot;) // don't override user-set junk status</span>
<a href="#l11.20"></a><span id="l11.20">       return;</span>
<a href="#l11.21"></a><span id="l11.21"> </span>
<a href="#l11.22"></a><span id="l11.22">     // if a whitelist addressbook was specified, check if the email address is in it</span>
<a href="#l11.23"></a><span id="l11.23">     if (aWhiteListDirectory)</span>
<a href="#l11.24"></a><span id="l11.24">     {</span>
<a href="#l11.25"></a><span id="l11.25">       var headerParser = Components.classes[&quot;@mozilla.org/messenger/headerparser;1&quot;]</span>
<a href="#l11.26"></a><span id="l11.26">                                    .getService(Components.interfaces.nsIMsgHeaderParser);</span>
<a href="#l11.27"></a><span id="l11.27">       var authorEmailAddress = headerParser.extractHeaderAddressMailboxes(null, aMsgHdr.author);</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineminus">-      if (aWhiteListDirectory.cardForEmailAddress(authorEmailAddress))</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineplus">+      var abCard = false;</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+      try {</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+        abCard = aWhiteListDirectory.cardForEmailAddress(authorEmailAddress);</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+      } catch (e) {}</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+      if (abCard)</span>
<a href="#l11.34"></a><span id="l11.34">       {</span>
<a href="#l11.35"></a><span id="l11.35">         // message is ham from whitelist</span>
<a href="#l11.36"></a><span id="l11.36">         {</span>
<a href="#l11.37"></a><span id="l11.37">           var db = aMsgHdr.folder.getMsgDatabase(msgWindow);</span>
<a href="#l11.38"></a><span id="l11.38">           db.setStringProperty(aMsgHdr.messageKey, &quot;junkscore&quot;, Components.interfaces.nsIJunkMailPlugin.IS_HAM_SCORE);</span>
<a href="#l11.39"></a><span id="l11.39">           db.setStringProperty(aMsgHdr.messageKey, &quot;junkscoreorigin&quot;, &quot;whitelist&quot;);</span>
<a href="#l11.40"></a><span id="l11.40">           this.mGoodMsgHdrs.appendElement(aMsgHdr, false);</span>
<a href="#l11.41"></a><span id="l11.41">         }</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineat">@@ -353,18 +357,21 @@ function processFolderForJunk(aAll)</span>
<a href="#l11.43"></a><span id="l11.43">   if (!tmpMsgURI)</span>
<a href="#l11.44"></a><span id="l11.44">     return;</span>
<a href="#l11.45"></a><span id="l11.45"> </span>
<a href="#l11.46"></a><span id="l11.46">   var tmpMsgHdr = messenger.messageServiceFromURI(tmpMsgURI).messageURIToMsgHdr(tmpMsgURI);</span>
<a href="#l11.47"></a><span id="l11.47">   var spamSettings = tmpMsgHdr.folder.server.spamSettings;</span>
<a href="#l11.48"></a><span id="l11.48"> </span>
<a href="#l11.49"></a><span id="l11.49">   // if enabled in the spam settings, retrieve whitelist addressbook</span>
<a href="#l11.50"></a><span id="l11.50">   var whiteListDirectory = null;</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineminus">-  if (spamSettings.useWhiteList &amp;&amp; spamSettings.whiteListAbURI)</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineminus">-    whiteListDirectory = RDF.GetResource(spamSettings.whiteListAbURI).QueryInterface(Components.interfaces.nsIAbMDBDirectory);</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineplus">+  if (spamSettings.useWhiteList &amp;&amp; spamSettings.whiteListAbURI) {</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineplus">+    whiteListDirectory = Components.classes[&quot;@mozilla.org/abmanager;1&quot;]</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineplus">+                                   .getService(Components.interfaces.nsIAbManager)</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineplus">+                                   .getDirectory(spamSettings.whiteListAbURI);</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineplus">+  }</span>
<a href="#l11.58"></a><span id="l11.58"> </span>
<a href="#l11.59"></a><span id="l11.59">   // create a classifier instance to classify messages in the folder.</span>
<a href="#l11.60"></a><span id="l11.60">   var msgClassifier = new MessageClassifier(tmpMsgHdr.folder, totalMessages);</span>
<a href="#l11.61"></a><span id="l11.61"> </span>
<a href="#l11.62"></a><span id="l11.62">   for ( i = 0; i &lt; totalMessages; i++)</span>
<a href="#l11.63"></a><span id="l11.63">   {</span>
<a href="#l11.64"></a><span id="l11.64">     var index = aAll ? i : indices[i];</span>
<a href="#l11.65"></a><span id="l11.65">     try</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/base/resources/content/mailWindowOverlay.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/base/resources/content/mailWindowOverlay.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -2301,23 +2301,25 @@ function allowRemoteContentForSender()</span>
<a href="#l12.4"></a><span id="l12.4">   // search through all of our local address books looking for a match.</span>
<a href="#l12.5"></a><span id="l12.5">   var enumerator = Components.classes[&quot;@mozilla.org/abmanager;1&quot;]</span>
<a href="#l12.6"></a><span id="l12.6">                              .getService(Components.interfaces.nsIAbManager)</span>
<a href="#l12.7"></a><span id="l12.7">                              .directories;</span>
<a href="#l12.8"></a><span id="l12.8">   var cardForEmailAddress;</span>
<a href="#l12.9"></a><span id="l12.9">   var addrbook;</span>
<a href="#l12.10"></a><span id="l12.10">   while (!cardForEmailAddress &amp;&amp; enumerator.hasMoreElements())</span>
<a href="#l12.11"></a><span id="l12.11">   {</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-    addrbook = enumerator.getNext();</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-    if (addrbook instanceof Components.interfaces.nsIAbMDBDirectory)</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+    addrbook = enumerator.getNext()</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+                         .QueryInterface(Components.interfaces.nsIAbDirectory);</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+    try {</span>
<a href="#l12.17"></a><span id="l12.17">       cardForEmailAddress = addrbook.cardForEmailAddress(authorEmailAddress);</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+    } catch (e) {}</span>
<a href="#l12.19"></a><span id="l12.19">   }</span>
<a href="#l12.20"></a><span id="l12.20"> </span>
<a href="#l12.21"></a><span id="l12.21">   var allowRemoteContent = false;</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineminus">-  if (cardForEmailAddress &amp;&amp; addrbook instanceof Components.interfaces.nsIAbDirectory)</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineplus">+  if (cardForEmailAddress)</span>
<a href="#l12.24"></a><span id="l12.24">   {</span>
<a href="#l12.25"></a><span id="l12.25">     // set the property for remote content</span>
<a href="#l12.26"></a><span id="l12.26">     cardForEmailAddress.setProperty(&quot;AllowRemoteContent&quot;, true);</span>
<a href="#l12.27"></a><span id="l12.27">     addrbook.modifyCard(cardForEmailAddress);</span>
<a href="#l12.28"></a><span id="l12.28">     allowRemoteContent = true;</span>
<a href="#l12.29"></a><span id="l12.29">   }</span>
<a href="#l12.30"></a><span id="l12.30">   else</span>
<a href="#l12.31"></a><span id="l12.31">   {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/base/search/public/nsMsgSearchTerm.h</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/base/search/public/nsMsgSearchTerm.h</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -41,17 +41,17 @@</span>
<a href="#l13.4"></a><span id="l13.4"> //---------------------------------------------------------------------------</span>
<a href="#l13.5"></a><span id="l13.5"> // nsMsgSearchTerm specifies one criterion, e.g. name contains phil</span>
<a href="#l13.6"></a><span id="l13.6"> //---------------------------------------------------------------------------</span>
<a href="#l13.7"></a><span id="l13.7"> #include &quot;nsIMsgSearchSession.h&quot;</span>
<a href="#l13.8"></a><span id="l13.8"> #include &quot;nsIMsgSearchScopeTerm.h&quot;</span>
<a href="#l13.9"></a><span id="l13.9"> #include &quot;nsIMsgSearchTerm.h&quot;</span>
<a href="#l13.10"></a><span id="l13.10"> </span>
<a href="#l13.11"></a><span id="l13.11"> // needed to search for addresses in address books</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-#include &quot;nsIAbMDBDirectory.h&quot;</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+#include &quot;nsIAbDirectory.h&quot;</span>
<a href="#l13.14"></a><span id="l13.14"> </span>
<a href="#l13.15"></a><span id="l13.15"> #define EMPTY_MESSAGE_LINE(buf) (buf[0] == '\r' || buf[0] == '\n' || buf[0] == '\0')</span>
<a href="#l13.16"></a><span id="l13.16"> </span>
<a href="#l13.17"></a><span id="l13.17"> class nsMsgSearchTerm : public nsIMsgSearchTerm</span>
<a href="#l13.18"></a><span id="l13.18"> {</span>
<a href="#l13.19"></a><span id="l13.19"> public:</span>
<a href="#l13.20"></a><span id="l13.20">   nsMsgSearchTerm();</span>
<a href="#l13.21"></a><span id="l13.21">   nsMsgSearchTerm (nsMsgSearchAttribValue, nsMsgSearchOpValue, nsIMsgSearchValue *, nsMsgSearchBooleanOperator, const char * arbitraryHeader);</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineat">@@ -112,15 +112,15 @@ protected:</span>
<a href="#l13.23"></a><span id="l13.23">   nsresult OutputValue(nsCString &amp;outputStr);</span>
<a href="#l13.24"></a><span id="l13.24">   nsresult ParseAttribute(char *inStream, nsMsgSearchAttribValue *attrib);</span>
<a href="#l13.25"></a><span id="l13.25">   nsresult ParseOperator(char *inStream, nsMsgSearchOpValue *value);</span>
<a href="#l13.26"></a><span id="l13.26">   nsresult ParseValue(char *inStream);</span>
<a href="#l13.27"></a><span id="l13.27">   nsresult InitHeaderAddressParser();</span>
<a href="#l13.28"></a><span id="l13.28">     nsresult InitializeAddressBook();</span>
<a href="#l13.29"></a><span id="l13.29">     nsresult MatchInAddressBook(const char * aAddress, PRBool *pResult);</span>
<a href="#l13.30"></a><span id="l13.30">     // fields used by search in address book</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-    nsCOMPtr &lt;nsIAbMDBDirectory&gt; mDirectory;</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+    nsCOMPtr &lt;nsIAbDirectory&gt; mDirectory;</span>
<a href="#l13.33"></a><span id="l13.33"> </span>
<a href="#l13.34"></a><span id="l13.34">     PRPackedBool mBeginsGrouping;</span>
<a href="#l13.35"></a><span id="l13.35">     PRPackedBool mEndsGrouping;</span>
<a href="#l13.36"></a><span id="l13.36"> };</span>
<a href="#l13.37"></a><span id="l13.37"> </span>
<a href="#l13.38"></a><span id="l13.38"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgSearchTerm.cpp</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgSearchTerm.cpp</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -63,17 +63,16 @@</span>
<a href="#l14.4"></a><span id="l14.4"> #include &quot;nsIMsgFilterPlugin.h&quot;</span>
<a href="#l14.5"></a><span id="l14.5"> #include &quot;nsILocalFile.h&quot;</span>
<a href="#l14.6"></a><span id="l14.6"> #include &quot;nsIRDFService.h&quot;</span>
<a href="#l14.7"></a><span id="l14.7"> #include &quot;nsISupportsObsolete.h&quot;</span>
<a href="#l14.8"></a><span id="l14.8"> #include &quot;nsNetCID.h&quot;</span>
<a href="#l14.9"></a><span id="l14.9"> #include &quot;nsIFileStreams.h&quot;</span>
<a href="#l14.10"></a><span id="l14.10"> #include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l14.11"></a><span id="l14.11"> #include &quot;nsIAbCard.h&quot;</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-#include &quot;nsIAbDirectory.h&quot;</span>
<a href="#l14.13"></a><span id="l14.13"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l14.14"></a><span id="l14.14"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l14.15"></a><span id="l14.15"> #include &quot;nsMemory.h&quot;</span>
<a href="#l14.16"></a><span id="l14.16"> #include &lt;ctype.h&gt;</span>
<a href="#l14.17"></a><span id="l14.17"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l14.18"></a><span id="l14.18"> #include &quot;nsIMsgTagService.h&quot;</span>
<a href="#l14.19"></a><span id="l14.19"> </span>
<a href="#l14.20"></a><span id="l14.20"> //---------------------------------------------------------------------------</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineat">@@ -888,21 +887,18 @@ nsresult nsMsgSearchTerm::MatchBody (nsI</span>
<a href="#l14.22"></a><span id="l14.22"> nsresult nsMsgSearchTerm::InitializeAddressBook()</span>
<a href="#l14.23"></a><span id="l14.23"> {</span>
<a href="#l14.24"></a><span id="l14.24">   // the search attribute value has the URI for the address book we need to load.</span>
<a href="#l14.25"></a><span id="l14.25">   // we need both the database and the directory.</span>
<a href="#l14.26"></a><span id="l14.26">   nsresult rv = NS_OK;</span>
<a href="#l14.27"></a><span id="l14.27"> </span>
<a href="#l14.28"></a><span id="l14.28">   if (mDirectory)</span>
<a href="#l14.29"></a><span id="l14.29">   {</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineminus">-    nsCOMPtr&lt;nsIAbDirectory&gt; dir(do_QueryInterface(mDirectory, &amp;rv));</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineminus">-</span>
<a href="#l14.33"></a><span id="l14.33">     nsCString uri;</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineminus">-    rv = dir-&gt;GetURI(uri);</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+    rv = mDirectory-&gt;GetURI(uri);</span>
<a href="#l14.36"></a><span id="l14.36">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.37"></a><span id="l14.37"> </span>
<a href="#l14.38"></a><span id="l14.38">     if (!uri.Equals(m_value.string))</span>
<a href="#l14.39"></a><span id="l14.39">       // clear out the directory....we are no longer pointing to the right one</span>
<a href="#l14.40"></a><span id="l14.40">       mDirectory = nsnull;</span>
<a href="#l14.41"></a><span id="l14.41">   }</span>
<a href="#l14.42"></a><span id="l14.42">   if (!mDirectory)</span>
<a href="#l14.43"></a><span id="l14.43">   {</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineat">@@ -926,19 +922,21 @@ nsresult nsMsgSearchTerm::MatchInAddress</span>
<a href="#l14.45"></a><span id="l14.45">   *pResult = PR_FALSE;</span>
<a href="#l14.46"></a><span id="l14.46"> </span>
<a href="#l14.47"></a><span id="l14.47">   // Some junkmails have empty From: fields.</span>
<a href="#l14.48"></a><span id="l14.48">   if (aAddress == NULL || strlen(aAddress) == 0)</span>
<a href="#l14.49"></a><span id="l14.49">     return rv;</span>
<a href="#l14.50"></a><span id="l14.50"> </span>
<a href="#l14.51"></a><span id="l14.51">   if (mDirectory)</span>
<a href="#l14.52"></a><span id="l14.52">   {</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineminus">-    nsIAbCard* cardForAddress;</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+    nsIAbCard* cardForAddress = nsnull;</span>
<a href="#l14.55"></a><span id="l14.55">     rv = mDirectory-&gt;CardForEmailAddress(nsDependentCString(aAddress),</span>
<a href="#l14.56"></a><span id="l14.56">                                          &amp;cardForAddress);</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineplus">+    if (NS_FAILED(rv) &amp;&amp; rv != NS_ERROR_NOT_IMPLEMENTED)</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineplus">+      return rv;</span>
<a href="#l14.59"></a><span id="l14.59">     if ((m_operator == nsMsgSearchOp::IsInAB &amp;&amp; cardForAddress) || (m_operator == nsMsgSearchOp::IsntInAB &amp;&amp; !cardForAddress))</span>
<a href="#l14.60"></a><span id="l14.60">       *pResult = PR_TRUE;</span>
<a href="#l14.61"></a><span id="l14.61">     NS_IF_RELEASE(cardForAddress);</span>
<a href="#l14.62"></a><span id="l14.62">   }</span>
<a href="#l14.63"></a><span id="l14.63"> </span>
<a href="#l14.64"></a><span id="l14.64">   return rv;</span>
<a href="#l14.65"></a><span id="l14.65"> }</span>
<a href="#l14.66"></a><span id="l14.66"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/base/src/nsMsgContentPolicy.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgContentPolicy.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -38,21 +38,19 @@</span>
<a href="#l15.4"></a><span id="l15.4"> </span>
<a href="#l15.5"></a><span id="l15.5"> #include &quot;nsMsgContentPolicy.h&quot;</span>
<a href="#l15.6"></a><span id="l15.6"> #include &quot;nsIServiceManager.h&quot;</span>
<a href="#l15.7"></a><span id="l15.7"> #include &quot;nsIDocShellTreeItem.h&quot;</span>
<a href="#l15.8"></a><span id="l15.8"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l15.9"></a><span id="l15.9"> #include &quot;nsIPrefBranch2.h&quot;</span>
<a href="#l15.10"></a><span id="l15.10"> #include &quot;nsIURI.h&quot;</span>
<a href="#l15.11"></a><span id="l15.11"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-#include &quot;nsIRDFService.h&quot;</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-#include &quot;nsIRDFResource.h&quot;</span>
<a href="#l15.14"></a><span id="l15.14"> #include &quot;nsIMsgHeaderParser.h&quot;</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+#include &quot;nsIAbManager.h&quot;</span>
<a href="#l15.16"></a><span id="l15.16"> #include &quot;nsIAbDirectory.h&quot;</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineminus">-#include &quot;nsIAbMDBDirectory.h&quot;</span>
<a href="#l15.18"></a><span id="l15.18"> #include &quot;nsIAbCard.h&quot;</span>
<a href="#l15.19"></a><span id="l15.19"> #include &quot;nsIMsgMailNewsUrl.h&quot;</span>
<a href="#l15.20"></a><span id="l15.20"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l15.21"></a><span id="l15.21"> #include &quot;nsIMimeMiscStatus.h&quot;</span>
<a href="#l15.22"></a><span id="l15.22"> #include &quot;nsIMsgMessageService.h&quot;</span>
<a href="#l15.23"></a><span id="l15.23"> #include &quot;nsIMsgIncomingServer.h&quot;</span>
<a href="#l15.24"></a><span id="l15.24"> #include &quot;nsIRssIncomingServer.h&quot;</span>
<a href="#l15.25"></a><span id="l15.25"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineat">@@ -148,48 +146,40 @@ nsresult nsMsgContentPolicy::AllowRemote</span>
<a href="#l15.27"></a><span id="l15.27"> </span>
<a href="#l15.28"></a><span id="l15.28">   nsCOMPtr&lt;nsIMsgHeaderParser&gt; headerParser = do_GetService(&quot;@mozilla.org/messenger/headerparser;1&quot;, &amp;rv);</span>
<a href="#l15.29"></a><span id="l15.29">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.30"></a><span id="l15.30"> </span>
<a href="#l15.31"></a><span id="l15.31">   nsCString emailAddress; </span>
<a href="#l15.32"></a><span id="l15.32">   rv = headerParser-&gt;ExtractHeaderAddressMailboxes(nsnull, author.get(), getter_Copies(emailAddress));</span>
<a href="#l15.33"></a><span id="l15.33">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.34"></a><span id="l15.34"> </span>
<a href="#l15.35"></a><span id="l15.35" class="difflineminus">-  if (!mCachedTopLevelAb)</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineminus">-  {</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineminus">-    // Use the RDF service to walk through the list of local directories</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineminus">-    nsCOMPtr&lt;nsIRDFService&gt; rdfService =</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineminus">-      do_GetService(&quot;@mozilla.org/rdf/rdf-service;1&quot;, &amp;rv);</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineminus">-</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineminus">-    nsCOMPtr&lt;nsIRDFResource&gt; resource;</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineminus">-    rv = rdfService-&gt;GetResource(NS_LITERAL_CSTRING(&quot;moz-abdirectory://&quot;),</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineminus">-                                 getter_AddRefs(resource));</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineminus">-</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineminus">-    mCachedTopLevelAb = do_QueryInterface(resource, &amp;rv);</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineminus">-  }</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineplus">+  nsCOMPtr&lt;nsIAbManager&gt; abManager = do_GetService(&quot;@mozilla.org/abmanager;1&quot;,</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineplus">+                                                   &amp;rv);</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.53"></a><span id="l15.53"> </span>
<a href="#l15.54"></a><span id="l15.54">   nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineminus">-  rv = mCachedTopLevelAb-&gt;GetChildNodes(getter_AddRefs(enumerator));</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineplus">+  rv = abManager-&gt;GetDirectories(getter_AddRefs(enumerator));</span>
<a href="#l15.57"></a><span id="l15.57">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.58"></a><span id="l15.58"> </span>
<a href="#l15.59"></a><span id="l15.59">   nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineminus">-  nsCOMPtr&lt;nsIAbMDBDirectory&gt; mdbDirectory;</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineplus">+  nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l15.62"></a><span id="l15.62">   nsCOMPtr&lt;nsIAbCard&gt; cardForAddress;</span>
<a href="#l15.63"></a><span id="l15.63">   PRBool hasMore;</span>
<a href="#l15.64"></a><span id="l15.64"> </span>
<a href="#l15.65"></a><span id="l15.65">   while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore &amp;&amp; !cardForAddress)</span>
<a href="#l15.66"></a><span id="l15.66">   {</span>
<a href="#l15.67"></a><span id="l15.67">     rv = enumerator-&gt;GetNext(getter_AddRefs(supports));</span>
<a href="#l15.68"></a><span id="l15.68">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineminus">-    mdbDirectory = do_QueryInterface(supports);</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineminus">-    if (mdbDirectory)</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineminus">-      mdbDirectory-&gt;CardForEmailAddress(emailAddress, getter_AddRefs(cardForAddress));</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineplus">+    directory = do_QueryInterface(supports);</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineplus">+    if (directory)</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineplus">+    {</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineplus">+      rv = directory-&gt;CardForEmailAddress(emailAddress, getter_AddRefs(cardForAddress));</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineplus">+      if (NS_FAILED(rv) &amp;&amp; rv != NS_ERROR_NOT_IMPLEMENTED)</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineplus">+        return rv;</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineplus">+    }</span>
<a href="#l15.79"></a><span id="l15.79">   }</span>
<a href="#l15.80"></a><span id="l15.80">   </span>
<a href="#l15.81"></a><span id="l15.81">   // if we found a card from the sender, </span>
<a href="#l15.82"></a><span id="l15.82">   if (cardForAddress)</span>
<a href="#l15.83"></a><span id="l15.83">     cardForAddress-&gt;GetPropertyAsBool(kAllowRemoteContentProperty, aAllowForSender);</span>
<a href="#l15.84"></a><span id="l15.84"> </span>
<a href="#l15.85"></a><span id="l15.85">   return NS_OK;</span>
<a href="#l15.86"></a><span id="l15.86"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/base/src/nsMsgContentPolicy.h</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgContentPolicy.h</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -45,17 +45,16 @@</span>
<a href="#l16.4"></a><span id="l16.4"> </span>
<a href="#l16.5"></a><span id="l16.5"> #ifndef _nsMsgContentPolicy_H_</span>
<a href="#l16.6"></a><span id="l16.6"> #define _nsMsgContentPolicy_H_</span>
<a href="#l16.7"></a><span id="l16.7"> </span>
<a href="#l16.8"></a><span id="l16.8"> #include &quot;nsIContentPolicy.h&quot;</span>
<a href="#l16.9"></a><span id="l16.9"> #include &quot;nsIObserver.h&quot;</span>
<a href="#l16.10"></a><span id="l16.10"> #include &quot;nsWeakReference.h&quot;</span>
<a href="#l16.11"></a><span id="l16.11"> #include &quot;nsString.h&quot;</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-#include &quot;nsIAbDirectory.h&quot;</span>
<a href="#l16.13"></a><span id="l16.13"> </span>
<a href="#l16.14"></a><span id="l16.14"> #include &quot;nsICookiePermission.h&quot; </span>
<a href="#l16.15"></a><span id="l16.15"> </span>
<a href="#l16.16"></a><span id="l16.16"> /* DBFCFDF0-4489-4faa-8122-190FD1EFA16C */</span>
<a href="#l16.17"></a><span id="l16.17"> #define NS_MSGCONTENTPOLICY_CID \</span>
<a href="#l16.18"></a><span id="l16.18"> { 0xdbfcfdf0, 0x4489, 0x4faa, { 0x81, 0x22, 0x19, 0xf, 0xd1, 0xef, 0xa1, 0x6c } }</span>
<a href="#l16.19"></a><span id="l16.19"> </span>
<a href="#l16.20"></a><span id="l16.20"> #define NS_MSGCONTENTPOLICY_CONTRACTID &quot;@mozilla.org/messenger/content-policy;1&quot;</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineat">@@ -76,17 +75,16 @@ public:</span>
<a href="#l16.22"></a><span id="l16.22">   NS_DECL_ISUPPORTS</span>
<a href="#l16.23"></a><span id="l16.23">   NS_DECL_NSICONTENTPOLICY</span>
<a href="#l16.24"></a><span id="l16.24">   NS_DECL_NSIOBSERVER</span>
<a href="#l16.25"></a><span id="l16.25"> </span>
<a href="#l16.26"></a><span id="l16.26"> protected:</span>
<a href="#l16.27"></a><span id="l16.27">   PRBool   mBlockRemoteImages;</span>
<a href="#l16.28"></a><span id="l16.28">   PRBool   mAllowPlugins;</span>
<a href="#l16.29"></a><span id="l16.29">   nsCString mTrustedMailDomains;</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineminus">-  nsCOMPtr&lt;nsIAbDirectory&gt; mCachedTopLevelAb;</span>
<a href="#l16.31"></a><span id="l16.31"> </span>
<a href="#l16.32"></a><span id="l16.32">   PRBool IsTrustedDomain(nsIURI * aContentLocation);</span>
<a href="#l16.33"></a><span id="l16.33">   nsresult AllowRemoteContentForSender(nsIMsgDBHdr * aMsgHdr, PRBool * aAllowForSender);</span>
<a href="#l16.34"></a><span id="l16.34">   nsresult AllowRemoteContentForMsgHdr(nsIMsgDBHdr * aMsgHdr, nsIURI * aRequestingLocation, nsIURI * aContentLocation, PRInt16 *aDecision);</span>
<a href="#l16.35"></a><span id="l16.35">   nsresult MailShouldLoad(nsIURI * aRequestingLocation, nsIURI * aContentLocation, PRInt16 * aDecision);</span>
<a href="#l16.36"></a><span id="l16.36">   nsresult ComposeShouldLoad(nsIDocShell * aRootDocShell, nsISupports *aRequestingContext, </span>
<a href="#l16.37"></a><span id="l16.37">                              nsIURI * aContentLocation, PRInt16 * aDecision);</span>
<a href="#l16.38"></a><span id="l16.38"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -60,17 +60,17 @@</span>
<a href="#l17.4"></a><span id="l17.4"> #include &quot;nsIPrompt.h&quot;</span>
<a href="#l17.5"></a><span id="l17.5"> #include &quot;nsIInterfaceRequestor.h&quot;</span>
<a href="#l17.6"></a><span id="l17.6"> #include &quot;nsIInterfaceRequestorUtils.h&quot;</span>
<a href="#l17.7"></a><span id="l17.7"> #include &quot;nsILocale.h&quot;</span>
<a href="#l17.8"></a><span id="l17.8"> #include &quot;nsILocaleService.h&quot;</span>
<a href="#l17.9"></a><span id="l17.9"> #include &quot;nsCollationCID.h&quot;</span>
<a href="#l17.10"></a><span id="l17.10"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l17.11"></a><span id="l17.11"> #include &quot;nsIAbCard.h&quot;</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-#include &quot;nsIAbMDBDirectory.h&quot;</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+#include &quot;nsIAbDirectory.h&quot;</span>
<a href="#l17.14"></a><span id="l17.14"> #include &quot;nsISpamSettings.h&quot;</span>
<a href="#l17.15"></a><span id="l17.15"> #include &quot;nsIMsgFilterPlugin.h&quot;</span>
<a href="#l17.16"></a><span id="l17.16"> #include &quot;nsIMsgMailSession.h&quot;</span>
<a href="#l17.17"></a><span id="l17.17"> #include &quot;nsIRDFService.h&quot;</span>
<a href="#l17.18"></a><span id="l17.18"> #include &quot;nsTextFormatter.h&quot;</span>
<a href="#l17.19"></a><span id="l17.19"> #include &quot;nsCPasswordManager.h&quot;</span>
<a href="#l17.20"></a><span id="l17.20"> #include &quot;nsMsgDBCID.h&quot;</span>
<a href="#l17.21"></a><span id="l17.21"> #include &quot;nsInt64.h&quot;</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineat">@@ -1771,17 +1771,17 @@ nsMsgDBFolder::SpamFilterClassifyMessage</span>
<a href="#l17.23"></a><span id="l17.23">  */</span>
<a href="#l17.24"></a><span id="l17.24"> NS_IMETHODIMP</span>
<a href="#l17.25"></a><span id="l17.25"> nsMsgDBFolder::CallFilterPlugins(nsIMsgWindow *aMsgWindow, PRBool *aFiltersRun)</span>
<a href="#l17.26"></a><span id="l17.26"> {</span>
<a href="#l17.27"></a><span id="l17.27">   NS_ENSURE_ARG_POINTER(aFiltersRun);</span>
<a href="#l17.28"></a><span id="l17.28">   *aFiltersRun = PR_FALSE;</span>
<a href="#l17.29"></a><span id="l17.29">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l17.30"></a><span id="l17.30">   nsCOMPtr&lt;nsISpamSettings&gt; spamSettings;</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineminus">-  nsCOMArray&lt;nsIAbMDBDirectory&gt; whiteListDirArray;</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+  nsCOMArray&lt;nsIAbDirectory&gt; whiteListDirArray;</span>
<a href="#l17.33"></a><span id="l17.33">   nsCOMPtr&lt;nsIMsgHeaderParser&gt; headerParser;</span>
<a href="#l17.34"></a><span id="l17.34">   PRBool useWhiteList = PR_FALSE;</span>
<a href="#l17.35"></a><span id="l17.35">   PRInt32 spamLevel = 0;</span>
<a href="#l17.36"></a><span id="l17.36">   nsCString whiteListAbURI;</span>
<a href="#l17.37"></a><span id="l17.37"> </span>
<a href="#l17.38"></a><span id="l17.38">   nsresult rv = GetServer(getter_AddRefs(server));</span>
<a href="#l17.39"></a><span id="l17.39">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.40"></a><span id="l17.40"> </span>
<a href="#l17.41"></a><span id="l17.41" class="difflineat">@@ -1871,17 +1871,18 @@ nsMsgDBFolder::CallFilterPlugins(nsIMsgW</span>
<a href="#l17.42"></a><span id="l17.42">       nsCStringArray whiteListArray;</span>
<a href="#l17.43"></a><span id="l17.43">       whiteListArray.ParseString(whiteListAbURI.get(), &quot; &quot;);</span>
<a href="#l17.44"></a><span id="l17.44"> </span>
<a href="#l17.45"></a><span id="l17.45">       for (PRInt32 index = 0; index &lt; whiteListArray.Count(); index++)</span>
<a href="#l17.46"></a><span id="l17.46">       {</span>
<a href="#l17.47"></a><span id="l17.47">         nsCOMPtr&lt;nsIRDFResource&gt; resource;</span>
<a href="#l17.48"></a><span id="l17.48">         rv = rdfService-&gt;GetResource(*whiteListArray[index], getter_AddRefs(resource));</span>
<a href="#l17.49"></a><span id="l17.49"> </span>
<a href="#l17.50"></a><span id="l17.50" class="difflineminus">-        nsCOMPtr&lt;nsIAbMDBDirectory&gt; whiteListDirectory = do_QueryInterface(resource, &amp;rv);</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineplus">+        nsCOMPtr&lt;nsIAbDirectory&gt; whiteListDirectory =</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineplus">+          do_QueryInterface(resource, &amp;rv);</span>
<a href="#l17.53"></a><span id="l17.53">         if (whiteListDirectory)</span>
<a href="#l17.54"></a><span id="l17.54">           whiteListDirArray.AppendObject(whiteListDirectory);</span>
<a href="#l17.55"></a><span id="l17.55">       }</span>
<a href="#l17.56"></a><span id="l17.56">     }</span>
<a href="#l17.57"></a><span id="l17.57">     // if we can't get the db, we probably want to continue firing spam filters.</span>
<a href="#l17.58"></a><span id="l17.58">   }</span>
<a href="#l17.59"></a><span id="l17.59"> </span>
<a href="#l17.60"></a><span id="l17.60">   nsCString trustedMailDomains;</span>
<a href="#l17.61"></a><span id="l17.61" class="difflineat">@@ -1940,19 +1941,18 @@ nsMsgDBFolder::CallFilterPlugins(nsIMsgW</span>
<a href="#l17.62"></a><span id="l17.62">     {</span>
<a href="#l17.63"></a><span id="l17.63">       if (NS_SUCCEEDED(rv))</span>
<a href="#l17.64"></a><span id="l17.64">       {</span>
<a href="#l17.65"></a><span id="l17.65">         nsIAbCard* cardForAddress = nsnull;</span>
<a href="#l17.66"></a><span id="l17.66">         // don't want to abort the rest of the scoring.</span>
<a href="#l17.67"></a><span id="l17.67">         if (!authorEmailAddress.IsEmpty())</span>
<a href="#l17.68"></a><span id="l17.68">         {</span>
<a href="#l17.69"></a><span id="l17.69">           for (PRInt32 index = 0; index &lt; whiteListDirArray.Count() &amp;&amp; !cardForAddress; index++)</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineminus">-            rv = whiteListDirArray[index]-&gt;CardForEmailAddress(authorEmailAddress, &amp;cardForAddress);</span>
<a href="#l17.71"></a><span id="l17.71" class="difflineminus">-            if (NS_FAILED(rv))</span>
<a href="#l17.72"></a><span id="l17.72" class="difflineminus">-              cardForAddress = nsnull;</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineplus">+            whiteListDirArray[index]-&gt;CardForEmailAddress(authorEmailAddress,</span>
<a href="#l17.74"></a><span id="l17.74" class="difflineplus">+                                                          &amp;cardForAddress);</span>
<a href="#l17.75"></a><span id="l17.75">         }</span>
<a href="#l17.76"></a><span id="l17.76">         if (cardForAddress)</span>
<a href="#l17.77"></a><span id="l17.77">         {</span>
<a href="#l17.78"></a><span id="l17.78">           NS_RELEASE(cardForAddress);</span>
<a href="#l17.79"></a><span id="l17.79">           // mark this msg as non-junk, because we whitelisted it.</span>
<a href="#l17.80"></a><span id="l17.80">           mDatabase-&gt;SetStringProperty(msgKey, &quot;junkscore&quot;, &quot;0&quot;);</span>
<a href="#l17.81"></a><span id="l17.81">           mDatabase-&gt;SetStringProperty(msgKey, &quot;junkscoreorigin&quot;, &quot;whitelist&quot;);</span>
<a href="#l17.82"></a><span id="l17.82">           continue; // skip this msg since it's in the white list</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/suite/browser/src/nsBookmarksService.cpp</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/suite/browser/src/nsBookmarksService.cpp</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -2493,17 +2493,17 @@ NS_IMETHODIMP nsBookmarksService::Observ</span>
<a href="#l18.4"></a><span id="l18.4"> {</span>
<a href="#l18.5"></a><span id="l18.5">     nsresult rv = NS_OK;</span>
<a href="#l18.6"></a><span id="l18.6"> </span>
<a href="#l18.7"></a><span id="l18.7">     if (!strcmp(aTopic, &quot;profile-before-change&quot;))</span>
<a href="#l18.8"></a><span id="l18.8">     {</span>
<a href="#l18.9"></a><span id="l18.9">         // The profile has not changed yet.</span>
<a href="#l18.10"></a><span id="l18.10">         rv = Flush();</span>
<a href="#l18.11"></a><span id="l18.11">     </span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-        if (!NS_strcmp(someData, NS_LITERAL_STRING(&quot;shutdown-cleanse&quot;).get()))</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+        if (someData &amp;&amp; NS_LITERAL_STRING(&quot;shutdown-cleanse&quot;).Equals(someData))</span>
<a href="#l18.14"></a><span id="l18.14">         {</span>
<a href="#l18.15"></a><span id="l18.15">             if (mBookmarksFile)</span>
<a href="#l18.16"></a><span id="l18.16">             {</span>
<a href="#l18.17"></a><span id="l18.17">                 mBookmarksFile-&gt;Remove(PR_FALSE);</span>
<a href="#l18.18"></a><span id="l18.18">             }</span>
<a href="#l18.19"></a><span id="l18.19">         }</span>
<a href="#l18.20"></a><span id="l18.20">     }    </span>
<a href="#l18.21"></a><span id="l18.21">     else if (mBookmarksFile &amp;&amp; !strcmp(aTopic, &quot;profile-after-change&quot;))</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/suite/browser/src/nsInternetSearchService.cpp</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/suite/browser/src/nsInternetSearchService.cpp</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -6138,17 +6138,17 @@ InternetSearchDataSource::Observe(nsISup</span>
<a href="#l19.4"></a><span id="l19.4"> {</span>
<a href="#l19.5"></a><span id="l19.5">     nsresult rv = NS_OK;</span>
<a href="#l19.6"></a><span id="l19.6"> </span>
<a href="#l19.7"></a><span id="l19.7">     if (!strcmp(aTopic, &quot;profile-before-change&quot;))</span>
<a href="#l19.8"></a><span id="l19.8">     {</span>
<a href="#l19.9"></a><span id="l19.9">         // The profile is about to change.</span>
<a href="#l19.10"></a><span id="l19.10">         categoryDataSource = nsnull;</span>
<a href="#l19.11"></a><span id="l19.11"> </span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-        if (NS_LITERAL_STRING(&quot;shutdown-cleanse&quot;).Equals(someData))</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+        if (someData &amp;&amp; NS_LITERAL_STRING(&quot;shutdown-cleanse&quot;).Equals(someData))</span>
<a href="#l19.14"></a><span id="l19.14">         {</span>
<a href="#l19.15"></a><span id="l19.15">             // Delete search.rdf</span>
<a href="#l19.16"></a><span id="l19.16">             nsCOMPtr&lt;nsIFile&gt; searchFile;</span>
<a href="#l19.17"></a><span id="l19.17">             rv = NS_GetSpecialDirectory(NS_APP_SEARCH_50_FILE, getter_AddRefs(searchFile));</span>
<a href="#l19.18"></a><span id="l19.18">             if (NS_SUCCEEDED(rv))</span>
<a href="#l19.19"></a><span id="l19.19">                 rv = searchFile-&gt;Remove(PR_FALSE);</span>
<a href="#l19.20"></a><span id="l19.20">         }</span>
<a href="#l19.21"></a><span id="l19.21">     }</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

