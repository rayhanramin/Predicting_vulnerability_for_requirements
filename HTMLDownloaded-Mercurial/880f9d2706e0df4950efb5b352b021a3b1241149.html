<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 11704:880f9d2706e0df4950efb5b352b021a3b1241149</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 880f9d2706e0df4950efb5b352b021a3b1241149" />
<meta property="og:url" content="/comm-central/rev/880f9d2706e0df4950efb5b352b021a3b1241149" />
<meta property="og:description" content="Bug 795152 - Switch to Services.jsm: What's left: other code. r=mmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 880f9d2706e0df4950efb5b352b021a3b1241149 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/880f9d2706e0df4950efb5b352b021a3b1241149">shortlog</a> |
<a href="/comm-central/log/880f9d2706e0df4950efb5b352b021a3b1241149">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/880f9d2706e0df4950efb5b352b021a3b1241149">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/880f9d2706e0df4950efb5b352b021a3b1241149">files</a> |
changeset |
<a href="/comm-central/raw-rev/880f9d2706e0df4950efb5b352b021a3b1241149">raw</a>  | <a href="/comm-central/archive/880f9d2706e0df4950efb5b352b021a3b1241149.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=795152">Bug 795152</a> - Switch to Services.jsm: What's left: other code. r=mmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#83;&#101;&#98;&#97;&#115;&#116;&#105;&#97;&#110;&#32;&#72;&#101;&#110;&#103;&#115;&#116;&#32;&#60;&#97;&#114;&#99;&#104;&#97;&#101;&#111;&#112;&#116;&#101;&#114;&#121;&#120;&#64;&#99;&#111;&#111;&#108;&#101;&#45;&#102;&#105;&#108;&#101;&#115;&#46;&#100;&#101;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 14 Dec 2012 17:53:53 +0100</td></tr>

<tr>
 <td>changeset 11704</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/880f9d2706e0df4950efb5b352b021a3b1241149">880f9d2706e0df4950efb5b352b021a3b1241149</a></td>
</tr>



<tr>
<td>parent 11703</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/df332995c5b4249997c830c713fcbf01d99b7563">df332995c5b4249997c830c713fcbf01d99b7563</a>
</td>
</tr>

<tr>
<td>child 11705</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/4733c850b67c11521edfcc49678e67e6003a7590">4733c850b67c11521edfcc49678e67e6003a7590</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=880f9d2706e0df4950efb5b352b021a3b1241149">8716</a></td></tr>
<tr><td>push user</td><td>ryanvm@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Mon, 17 Dec 2012 00:04:04 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@a6e24ded8c28 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a6e24ded8c28130c9659f47a74bc193478e756af">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=a6e24ded8c28130c9659f47a74bc193478e756af&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a6e24ded8c28130c9659f47a74bc193478e756af&newProject=comm-central&newRevision=79a73f336716eb9b780cbe4627d9f6fc981b48f9&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a6e24ded8c28130c9659f47a74bc193478e756af&newProject=comm-central&newRevision=79a73f336716eb9b780cbe4627d9f6fc981b48f9&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=a6e24ded8c28130c9659f47a74bc193478e756af&newProject=comm-central&newRevision=79a73f336716eb9b780cbe4627d9f6fc981b48f9&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mmelin%29&revcount=50">mmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=795152">795152</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=795152">Bug 795152</a> - Switch to Services.jsm: What's left: other code. r=mmelin</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mail/base/modules/MailUtils.js">mail/base/modules/MailUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/880f9d2706e0df4950efb5b352b021a3b1241149/mail/base/modules/MailUtils.js">file</a> |
<a href="/comm-central/annotate/880f9d2706e0df4950efb5b352b021a3b1241149/mail/base/modules/MailUtils.js">annotate</a> |
<a href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mail/base/modules/MailUtils.js">diff</a> |
<a href="/comm-central/comparison/880f9d2706e0df4950efb5b352b021a3b1241149/mail/base/modules/MailUtils.js">comparison</a> |
<a href="/comm-central/log/880f9d2706e0df4950efb5b352b021a3b1241149/mail/base/modules/MailUtils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mail/base/modules/mailInstrumentation.js">mail/base/modules/mailInstrumentation.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/880f9d2706e0df4950efb5b352b021a3b1241149/mail/base/modules/mailInstrumentation.js">file</a> |
<a href="/comm-central/annotate/880f9d2706e0df4950efb5b352b021a3b1241149/mail/base/modules/mailInstrumentation.js">annotate</a> |
<a href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mail/base/modules/mailInstrumentation.js">diff</a> |
<a href="/comm-central/comparison/880f9d2706e0df4950efb5b352b021a3b1241149/mail/base/modules/mailInstrumentation.js">comparison</a> |
<a href="/comm-central/log/880f9d2706e0df4950efb5b352b021a3b1241149/mail/base/modules/mailInstrumentation.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mail/base/modules/mailMigrator.js">mail/base/modules/mailMigrator.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/880f9d2706e0df4950efb5b352b021a3b1241149/mail/base/modules/mailMigrator.js">file</a> |
<a href="/comm-central/annotate/880f9d2706e0df4950efb5b352b021a3b1241149/mail/base/modules/mailMigrator.js">annotate</a> |
<a href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mail/base/modules/mailMigrator.js">diff</a> |
<a href="/comm-central/comparison/880f9d2706e0df4950efb5b352b021a3b1241149/mail/base/modules/mailMigrator.js">comparison</a> |
<a href="/comm-central/log/880f9d2706e0df4950efb5b352b021a3b1241149/mail/base/modules/mailMigrator.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mail/base/modules/quickFilterManager.js">mail/base/modules/quickFilterManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/880f9d2706e0df4950efb5b352b021a3b1241149/mail/base/modules/quickFilterManager.js">file</a> |
<a href="/comm-central/annotate/880f9d2706e0df4950efb5b352b021a3b1241149/mail/base/modules/quickFilterManager.js">annotate</a> |
<a href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mail/base/modules/quickFilterManager.js">diff</a> |
<a href="/comm-central/comparison/880f9d2706e0df4950efb5b352b021a3b1241149/mail/base/modules/quickFilterManager.js">comparison</a> |
<a href="/comm-central/log/880f9d2706e0df4950efb5b352b021a3b1241149/mail/base/modules/quickFilterManager.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mail/base/modules/searchSpec.js">mail/base/modules/searchSpec.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/880f9d2706e0df4950efb5b352b021a3b1241149/mail/base/modules/searchSpec.js">file</a> |
<a href="/comm-central/annotate/880f9d2706e0df4950efb5b352b021a3b1241149/mail/base/modules/searchSpec.js">annotate</a> |
<a href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mail/base/modules/searchSpec.js">diff</a> |
<a href="/comm-central/comparison/880f9d2706e0df4950efb5b352b021a3b1241149/mail/base/modules/searchSpec.js">comparison</a> |
<a href="/comm-central/log/880f9d2706e0df4950efb5b352b021a3b1241149/mail/base/modules/searchSpec.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mail/base/modules/sessionStoreManager.js">mail/base/modules/sessionStoreManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/880f9d2706e0df4950efb5b352b021a3b1241149/mail/base/modules/sessionStoreManager.js">file</a> |
<a href="/comm-central/annotate/880f9d2706e0df4950efb5b352b021a3b1241149/mail/base/modules/sessionStoreManager.js">annotate</a> |
<a href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mail/base/modules/sessionStoreManager.js">diff</a> |
<a href="/comm-central/comparison/880f9d2706e0df4950efb5b352b021a3b1241149/mail/base/modules/sessionStoreManager.js">comparison</a> |
<a href="/comm-central/log/880f9d2706e0df4950efb5b352b021a3b1241149/mail/base/modules/sessionStoreManager.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/aboutRedirector.js">mail/components/aboutRedirector.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/aboutRedirector.js">file</a> |
<a href="/comm-central/annotate/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/aboutRedirector.js">annotate</a> |
<a href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/aboutRedirector.js">diff</a> |
<a href="/comm-central/comparison/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/aboutRedirector.js">comparison</a> |
<a href="/comm-central/log/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/aboutRedirector.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/appIdleManager.js">mail/components/appIdleManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/appIdleManager.js">file</a> |
<a href="/comm-central/annotate/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/appIdleManager.js">annotate</a> |
<a href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/appIdleManager.js">diff</a> |
<a href="/comm-central/comparison/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/appIdleManager.js">comparison</a> |
<a href="/comm-central/log/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/appIdleManager.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/migration/content/migration.js">mail/components/migration/content/migration.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/migration/content/migration.js">file</a> |
<a href="/comm-central/annotate/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/migration/content/migration.js">annotate</a> |
<a href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/migration/content/migration.js">diff</a> |
<a href="/comm-central/comparison/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/migration/content/migration.js">comparison</a> |
<a href="/comm-central/log/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/migration/content/migration.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/newmailaccount/content/accountProvisioner.js">mail/components/newmailaccount/content/accountProvisioner.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/newmailaccount/content/accountProvisioner.js">file</a> |
<a href="/comm-central/annotate/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/newmailaccount/content/accountProvisioner.js">annotate</a> |
<a href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/newmailaccount/content/accountProvisioner.js">diff</a> |
<a href="/comm-central/comparison/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/newmailaccount/content/accountProvisioner.js">comparison</a> |
<a href="/comm-central/log/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/newmailaccount/content/accountProvisioner.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/newmailaccount/content/accountProvisionerTab.js">mail/components/newmailaccount/content/accountProvisionerTab.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/newmailaccount/content/accountProvisionerTab.js">file</a> |
<a href="/comm-central/annotate/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/newmailaccount/content/accountProvisionerTab.js">annotate</a> |
<a href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/newmailaccount/content/accountProvisionerTab.js">diff</a> |
<a href="/comm-central/comparison/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/newmailaccount/content/accountProvisionerTab.js">comparison</a> |
<a href="/comm-central/log/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/newmailaccount/content/accountProvisionerTab.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/nsMailDefaultHandler.js">mail/components/nsMailDefaultHandler.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/nsMailDefaultHandler.js">file</a> |
<a href="/comm-central/annotate/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/nsMailDefaultHandler.js">annotate</a> |
<a href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/nsMailDefaultHandler.js">diff</a> |
<a href="/comm-central/comparison/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/nsMailDefaultHandler.js">comparison</a> |
<a href="/comm-central/log/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/nsMailDefaultHandler.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/phishing/globalstore.js">mail/components/phishing/globalstore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/phishing/globalstore.js">file</a> |
<a href="/comm-central/annotate/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/phishing/globalstore.js">annotate</a> |
<a href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/phishing/globalstore.js">diff</a> |
<a href="/comm-central/comparison/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/phishing/globalstore.js">comparison</a> |
<a href="/comm-central/log/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/phishing/globalstore.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/search/SpotlightIntegration.js">mail/components/search/SpotlightIntegration.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/search/SpotlightIntegration.js">file</a> |
<a href="/comm-central/annotate/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/search/SpotlightIntegration.js">annotate</a> |
<a href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/search/SpotlightIntegration.js">diff</a> |
<a href="/comm-central/comparison/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/search/SpotlightIntegration.js">comparison</a> |
<a href="/comm-central/log/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/search/SpotlightIntegration.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/search/WinSearchIntegration.js">mail/components/search/WinSearchIntegration.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/search/WinSearchIntegration.js">file</a> |
<a href="/comm-central/annotate/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/search/WinSearchIntegration.js">annotate</a> |
<a href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/search/WinSearchIntegration.js">diff</a> |
<a href="/comm-central/comparison/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/search/WinSearchIntegration.js">comparison</a> |
<a href="/comm-central/log/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/search/WinSearchIntegration.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/search/content/searchCommon.js">mail/components/search/content/searchCommon.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/search/content/searchCommon.js">file</a> |
<a href="/comm-central/annotate/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/search/content/searchCommon.js">annotate</a> |
<a href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/search/content/searchCommon.js">diff</a> |
<a href="/comm-central/comparison/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/search/content/searchCommon.js">comparison</a> |
<a href="/comm-central/log/880f9d2706e0df4950efb5b352b021a3b1241149/mail/components/search/content/searchCommon.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mail/extensions/smime/content/msgCompSMIMEOverlay.js">mail/extensions/smime/content/msgCompSMIMEOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/880f9d2706e0df4950efb5b352b021a3b1241149/mail/extensions/smime/content/msgCompSMIMEOverlay.js">file</a> |
<a href="/comm-central/annotate/880f9d2706e0df4950efb5b352b021a3b1241149/mail/extensions/smime/content/msgCompSMIMEOverlay.js">annotate</a> |
<a href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mail/extensions/smime/content/msgCompSMIMEOverlay.js">diff</a> |
<a href="/comm-central/comparison/880f9d2706e0df4950efb5b352b021a3b1241149/mail/extensions/smime/content/msgCompSMIMEOverlay.js">comparison</a> |
<a href="/comm-central/log/880f9d2706e0df4950efb5b352b021a3b1241149/mail/extensions/smime/content/msgCompSMIMEOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/addrbook/src/nsAbLDAPAutoCompleteSearch.js">mailnews/addrbook/src/nsAbLDAPAutoCompleteSearch.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/addrbook/src/nsAbLDAPAutoCompleteSearch.js">file</a> |
<a href="/comm-central/annotate/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/addrbook/src/nsAbLDAPAutoCompleteSearch.js">annotate</a> |
<a href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/addrbook/src/nsAbLDAPAutoCompleteSearch.js">diff</a> |
<a href="/comm-central/comparison/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/addrbook/src/nsAbLDAPAutoCompleteSearch.js">comparison</a> |
<a href="/comm-central/log/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/addrbook/src/nsAbLDAPAutoCompleteSearch.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/base/content/folderProps.xul">mailnews/base/content/folderProps.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/base/content/folderProps.xul">file</a> |
<a href="/comm-central/annotate/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/base/content/folderProps.xul">annotate</a> |
<a href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/base/content/folderProps.xul">diff</a> |
<a href="/comm-central/comparison/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/base/content/folderProps.xul">comparison</a> |
<a href="/comm-central/log/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/base/content/folderProps.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/base/search/src/nsMsgTraitService.js">mailnews/base/search/src/nsMsgTraitService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/base/search/src/nsMsgTraitService.js">file</a> |
<a href="/comm-central/annotate/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/base/search/src/nsMsgTraitService.js">annotate</a> |
<a href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/base/search/src/nsMsgTraitService.js">diff</a> |
<a href="/comm-central/comparison/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/base/search/src/nsMsgTraitService.js">comparison</a> |
<a href="/comm-central/log/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/base/search/src/nsMsgTraitService.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/base/util/IOUtils.js">mailnews/base/util/IOUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/base/util/IOUtils.js">file</a> |
<a href="/comm-central/annotate/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/base/util/IOUtils.js">annotate</a> |
<a href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/base/util/IOUtils.js">diff</a> |
<a href="/comm-central/comparison/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/base/util/IOUtils.js">comparison</a> |
<a href="/comm-central/log/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/base/util/IOUtils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/base/util/StringBundle.js">mailnews/base/util/StringBundle.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/base/util/StringBundle.js">file</a> |
<a href="/comm-central/annotate/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/base/util/StringBundle.js">annotate</a> |
<a href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/base/util/StringBundle.js">diff</a> |
<a href="/comm-central/comparison/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/base/util/StringBundle.js">comparison</a> |
<a href="/comm-central/log/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/base/util/StringBundle.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/base/util/mailnewsMigrator.js">mailnews/base/util/mailnewsMigrator.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/base/util/mailnewsMigrator.js">file</a> |
<a href="/comm-central/annotate/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/base/util/mailnewsMigrator.js">annotate</a> |
<a href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/base/util/mailnewsMigrator.js">diff</a> |
<a href="/comm-central/comparison/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/base/util/mailnewsMigrator.js">comparison</a> |
<a href="/comm-central/log/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/base/util/mailnewsMigrator.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/extensions/bayesian-spam-filter/test/unit/head_bayes.js">mailnews/extensions/bayesian-spam-filter/test/unit/head_bayes.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/extensions/bayesian-spam-filter/test/unit/head_bayes.js">file</a> |
<a href="/comm-central/annotate/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/extensions/bayesian-spam-filter/test/unit/head_bayes.js">annotate</a> |
<a href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/extensions/bayesian-spam-filter/test/unit/head_bayes.js">diff</a> |
<a href="/comm-central/comparison/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/extensions/bayesian-spam-filter/test/unit/head_bayes.js">comparison</a> |
<a href="/comm-central/log/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/extensions/bayesian-spam-filter/test/unit/head_bayes.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/extensions/bayesian-spam-filter/test/unit/resources/trainingfile.js">mailnews/extensions/bayesian-spam-filter/test/unit/resources/trainingfile.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/extensions/bayesian-spam-filter/test/unit/resources/trainingfile.js">file</a> |
<a href="/comm-central/annotate/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/extensions/bayesian-spam-filter/test/unit/resources/trainingfile.js">annotate</a> |
<a href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/extensions/bayesian-spam-filter/test/unit/resources/trainingfile.js">diff</a> |
<a href="/comm-central/comparison/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/extensions/bayesian-spam-filter/test/unit/resources/trainingfile.js">comparison</a> |
<a href="/comm-central/log/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/extensions/bayesian-spam-filter/test/unit/resources/trainingfile.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/extensions/mdn/content/am-mdn.js">mailnews/extensions/mdn/content/am-mdn.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/extensions/mdn/content/am-mdn.js">file</a> |
<a href="/comm-central/annotate/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/extensions/mdn/content/am-mdn.js">annotate</a> |
<a href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/extensions/mdn/content/am-mdn.js">diff</a> |
<a href="/comm-central/comparison/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/extensions/mdn/content/am-mdn.js">comparison</a> |
<a href="/comm-central/log/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/extensions/mdn/content/am-mdn.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/extensions/newsblog/js/newsblog.js">mailnews/extensions/newsblog/js/newsblog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/extensions/newsblog/js/newsblog.js">file</a> |
<a href="/comm-central/annotate/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/extensions/newsblog/js/newsblog.js">annotate</a> |
<a href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/extensions/newsblog/js/newsblog.js">diff</a> |
<a href="/comm-central/comparison/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/extensions/newsblog/js/newsblog.js">comparison</a> |
<a href="/comm-central/log/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/extensions/newsblog/js/newsblog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/import/content/importDialog.js">mailnews/import/content/importDialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/import/content/importDialog.js">file</a> |
<a href="/comm-central/annotate/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/import/content/importDialog.js">annotate</a> |
<a href="/comm-central/diff/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/import/content/importDialog.js">diff</a> |
<a href="/comm-central/comparison/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/import/content/importDialog.js">comparison</a> |
<a href="/comm-central/log/880f9d2706e0df4950efb5b352b021a3b1241149/mailnews/import/content/importDialog.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/modules/MailUtils.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/modules/MailUtils.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -4,54 +4,44 @@</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5"> var EXPORTED_SYMBOLS = [&quot;MailUtils&quot;];</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> const Cc = Components.classes;</span>
<a href="#l1.8"></a><span id="l1.8"> const Ci = Components.interfaces;</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10"> Components.utils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l1.11"></a><span id="l1.11"> Components.utils.import(&quot;resource:///modules/MailConsts.js&quot;);</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l1.13"></a><span id="l1.13"> const MC = MailConsts;</span>
<a href="#l1.14"></a><span id="l1.14"> </span>
<a href="#l1.15"></a><span id="l1.15"> /**</span>
<a href="#l1.16"></a><span id="l1.16">  * This module has several utility functions for use by both core and</span>
<a href="#l1.17"></a><span id="l1.17">  * third-party code. Some functions are aimed at code that doesn't have a</span>
<a href="#l1.18"></a><span id="l1.18">  * window context, while others can be used anywhere.</span>
<a href="#l1.19"></a><span id="l1.19">  */</span>
<a href="#l1.20"></a><span id="l1.20"> var MailUtils =</span>
<a href="#l1.21"></a><span id="l1.21"> {</span>
<a href="#l1.22"></a><span id="l1.22">   /**</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineminus">-   * A reference to the root pref branch</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineminus">-   */</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineminus">-  get _prefBranch() {</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineminus">-    delete this._prefBranch;</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineminus">-    return this._prefBranch = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineminus">-                                .getService(Ci.nsIPrefService)</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineminus">-                                .getBranch(null);</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-  },</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-  /**</span>
<a href="#l1.33"></a><span id="l1.33">    * Discover all folders. This is useful during startup, when you have code</span>
<a href="#l1.34"></a><span id="l1.34">    * that deals with folders and that executes before the main 3pane window is</span>
<a href="#l1.35"></a><span id="l1.35">    * open (the folder tree wouldn't have been initialized yet).</span>
<a href="#l1.36"></a><span id="l1.36">    */</span>
<a href="#l1.37"></a><span id="l1.37">   discoverFolders: function MailUtils_discoverFolders() {</span>
<a href="#l1.38"></a><span id="l1.38">     let accountManager = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l1.39"></a><span id="l1.39">                            .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l1.40"></a><span id="l1.40">     let servers = accountManager.allServers;</span>
<a href="#l1.41"></a><span id="l1.41">     for each (let server in fixIterator(servers, Ci.nsIMsgIncomingServer)) {</span>
<a href="#l1.42"></a><span id="l1.42">       // Bug 466311 Sometimes this can throw file not found, we're unsure</span>
<a href="#l1.43"></a><span id="l1.43">       // why, but catch it and log the fact.</span>
<a href="#l1.44"></a><span id="l1.44">       try {</span>
<a href="#l1.45"></a><span id="l1.45">         server.rootFolder.subFolders;</span>
<a href="#l1.46"></a><span id="l1.46">       }</span>
<a href="#l1.47"></a><span id="l1.47">       catch (ex) {</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineminus">-        Cc[&quot;@mozilla.org/consoleservice;1&quot;].getService(Ci.nsIConsoleService)</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineminus">-          .logStringMessage(&quot;Discovering folders for account failed with &quot; +</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-                            &quot;exception: &quot; + ex);</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+        Services.console.logStringMessage(&quot;Discovering folders for account failed with &quot; +</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+                                          &quot;exception: &quot; + ex);</span>
<a href="#l1.53"></a><span id="l1.53">       }</span>
<a href="#l1.54"></a><span id="l1.54">     }</span>
<a href="#l1.55"></a><span id="l1.55">   },</span>
<a href="#l1.56"></a><span id="l1.56"> </span>
<a href="#l1.57"></a><span id="l1.57">   /**</span>
<a href="#l1.58"></a><span id="l1.58">    * Get the nsIMsgFolder corresponding to this file. This just looks at all</span>
<a href="#l1.59"></a><span id="l1.59">    * folders and does a direct match.</span>
<a href="#l1.60"></a><span id="l1.60">    *</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineat">@@ -147,35 +137,33 @@ var MailUtils =</span>
<a href="#l1.62"></a><span id="l1.62">    *                   - if one or more 3pane windows are open, the most recent</span>
<a href="#l1.63"></a><span id="l1.63">    *                     one's tabmail is used, and the window is brought to the</span>
<a href="#l1.64"></a><span id="l1.64">    *                     front</span>
<a href="#l1.65"></a><span id="l1.65">    *                   - if no 3pane windows are open, standalone windows are</span>
<a href="#l1.66"></a><span id="l1.66">    *                     opened instead of tabs</span>
<a href="#l1.67"></a><span id="l1.67">    */</span>
<a href="#l1.68"></a><span id="l1.68">   displayMessages: function MailUtils_displayMessages(aMsgHdrs,</span>
<a href="#l1.69"></a><span id="l1.69">                        aViewWrapperToClone, aTabmail) {</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineminus">-    let openMessageBehavior = this._prefBranch.getIntPref(</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineplus">+    let openMessageBehavior = Services.prefs.getIntPref(</span>
<a href="#l1.72"></a><span id="l1.72">                                   &quot;mail.openMessageBehavior&quot;);</span>
<a href="#l1.73"></a><span id="l1.73"> </span>
<a href="#l1.74"></a><span id="l1.74">     if (openMessageBehavior == MC.OpenMessageBehavior.NEW_WINDOW) {</span>
<a href="#l1.75"></a><span id="l1.75">       this.openMessagesInNewWindows(aMsgHdrs, aViewWrapperToClone);</span>
<a href="#l1.76"></a><span id="l1.76">     }</span>
<a href="#l1.77"></a><span id="l1.77">     else if (openMessageBehavior == MC.OpenMessageBehavior.EXISTING_WINDOW) {</span>
<a href="#l1.78"></a><span id="l1.78">       // Try reusing an existing window. If we can't, fall back to opening new</span>
<a href="#l1.79"></a><span id="l1.79">       // windows</span>
<a href="#l1.80"></a><span id="l1.80">       if (aMsgHdrs.length &gt; 1 || !this.openMessageInExistingWindow(aMsgHdrs[0]))</span>
<a href="#l1.81"></a><span id="l1.81">         this.openMessagesInNewWindows(aMsgHdrs, aViewWrapperToClone);</span>
<a href="#l1.82"></a><span id="l1.82">     }</span>
<a href="#l1.83"></a><span id="l1.83">     else if (openMessageBehavior == MC.OpenMessageBehavior.NEW_TAB) {</span>
<a href="#l1.84"></a><span id="l1.84">       let mail3PaneWindow = null;</span>
<a href="#l1.85"></a><span id="l1.85">       if (!aTabmail) {</span>
<a href="#l1.86"></a><span id="l1.86">         // Try opening new tabs in a 3pane window</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineminus">-        let windowMediator = Cc[&quot;@mozilla.org/appshell/window-mediator;1&quot;]</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineminus">-                               .getService(Ci.nsIWindowMediator);</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineminus">-        mail3PaneWindow = windowMediator.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineplus">+        mail3PaneWindow = Services.wm.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l1.91"></a><span id="l1.91">         if (mail3PaneWindow)</span>
<a href="#l1.92"></a><span id="l1.92">           aTabmail = mail3PaneWindow.document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l1.93"></a><span id="l1.93">       }</span>
<a href="#l1.94"></a><span id="l1.94"> </span>
<a href="#l1.95"></a><span id="l1.95">       if (aTabmail) {</span>
<a href="#l1.96"></a><span id="l1.96">         for each (let [i, msgHdr] in Iterator(aMsgHdrs))</span>
<a href="#l1.97"></a><span id="l1.97">           // Open all the tabs in the background, except for the last one</span>
<a href="#l1.98"></a><span id="l1.98">           aTabmail.openTab(&quot;message&quot;, {msgHdr: msgHdr,</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineat">@@ -201,19 +189,17 @@ var MailUtils =</span>
<a href="#l1.100"></a><span id="l1.100">    * @param [aViewWrapperToClone] a DB view wrapper to clone for the message</span>
<a href="#l1.101"></a><span id="l1.101">    *                              window</span>
<a href="#l1.102"></a><span id="l1.102">    * @returns true if an existing window was found and the message header was</span>
<a href="#l1.103"></a><span id="l1.103">    *          displayed, false otherwise</span>
<a href="#l1.104"></a><span id="l1.104">    */</span>
<a href="#l1.105"></a><span id="l1.105">   openMessageInExistingWindow:</span>
<a href="#l1.106"></a><span id="l1.106">       function MailUtils_openMessageInExistingWindow(aMsgHdr,</span>
<a href="#l1.107"></a><span id="l1.107">                                                      aViewWrapperToClone) {</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineminus">-    let windowMediator = Cc[&quot;@mozilla.org/appshell/window-mediator;1&quot;]</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineminus">-                           .getService(Ci.nsIWindowMediator);</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineminus">-    let messageWindow = windowMediator.getMostRecentWindow(&quot;mail:messageWindow&quot;);</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineplus">+    let messageWindow = Services.wm.getMostRecentWindow(&quot;mail:messageWindow&quot;);</span>
<a href="#l1.112"></a><span id="l1.112">     if (messageWindow) {</span>
<a href="#l1.113"></a><span id="l1.113">       messageWindow.displayMessage(aMsgHdr, aViewWrapperToClone);</span>
<a href="#l1.114"></a><span id="l1.114">       return true;</span>
<a href="#l1.115"></a><span id="l1.115">     }</span>
<a href="#l1.116"></a><span id="l1.116">     return false;</span>
<a href="#l1.117"></a><span id="l1.117">   },</span>
<a href="#l1.118"></a><span id="l1.118"> </span>
<a href="#l1.119"></a><span id="l1.119">   /**</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineat">@@ -224,51 +210,46 @@ var MailUtils =</span>
<a href="#l1.121"></a><span id="l1.121">    *                              window</span>
<a href="#l1.122"></a><span id="l1.122">    */</span>
<a href="#l1.123"></a><span id="l1.123">   openMessageInNewWindow:</span>
<a href="#l1.124"></a><span id="l1.124">       function MailUtils_openMessageInNewWindow(aMsgHdr, aViewWrapperToClone) {</span>
<a href="#l1.125"></a><span id="l1.125">     // It sucks that we have to go through XPCOM for this</span>
<a href="#l1.126"></a><span id="l1.126">     let args = {msgHdr: aMsgHdr, viewWrapperToClone: aViewWrapperToClone};</span>
<a href="#l1.127"></a><span id="l1.127">     args.wrappedJSObject = args;</span>
<a href="#l1.128"></a><span id="l1.128"> </span>
<a href="#l1.129"></a><span id="l1.129" class="difflineminus">-    let windowWatcher = Cc[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineminus">-                          .getService(Ci.nsIWindowWatcher);</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineminus">-    windowWatcher.openWindow(null,</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineplus">+    Services.ww.openWindow(null,</span>
<a href="#l1.133"></a><span id="l1.133">         &quot;chrome://messenger/content/messageWindow.xul&quot;, &quot;&quot;,</span>
<a href="#l1.134"></a><span id="l1.134">         &quot;all,chrome,dialog=no,status,toolbar&quot;, args);</span>
<a href="#l1.135"></a><span id="l1.135">   },</span>
<a href="#l1.136"></a><span id="l1.136"> </span>
<a href="#l1.137"></a><span id="l1.137">   /**</span>
<a href="#l1.138"></a><span id="l1.138">    * Open new standalone message windows for these headers. This will prompt</span>
<a href="#l1.139"></a><span id="l1.139">    * for confirmation if the number of windows to be opened is greater than the</span>
<a href="#l1.140"></a><span id="l1.140">    * value of the mailnews.open_window_warning preference.</span>
<a href="#l1.141"></a><span id="l1.141">    *</span>
<a href="#l1.142"></a><span id="l1.142">    * @param aMsgHdrs an array containing the message headers to display</span>
<a href="#l1.143"></a><span id="l1.143">    * @param [aViewWrapperToClone] a DB view wrapper to clone for each message</span>
<a href="#l1.144"></a><span id="l1.144">    *                              window</span>
<a href="#l1.145"></a><span id="l1.145">    */</span>
<a href="#l1.146"></a><span id="l1.146">    openMessagesInNewWindows:</span>
<a href="#l1.147"></a><span id="l1.147">        function MailUtils_openMessagesInNewWindows(aMsgHdrs,</span>
<a href="#l1.148"></a><span id="l1.148">                                                    aViewWrapperToClone) {</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineminus">-    let openWindowWarning = this._prefBranch.getIntPref(</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineplus">+    let openWindowWarning = Services.prefs.getIntPref(</span>
<a href="#l1.151"></a><span id="l1.151">                                 &quot;mailnews.open_window_warning&quot;);</span>
<a href="#l1.152"></a><span id="l1.152">     let numMessages = aMsgHdrs.length;</span>
<a href="#l1.153"></a><span id="l1.153"> </span>
<a href="#l1.154"></a><span id="l1.154">     if ((openWindowWarning &gt; 1) &amp;&amp; (numMessages &gt;= openWindowWarning)) {</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineminus">-      let bundle = Cc[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineminus">-                     .getService(Ci.nsIStringBundleService).createBundle(</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineminus">-                         &quot;chrome://messenger/locale/messenger.properties&quot;);</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineplus">+      let bundle = Services.strings.createBundle(</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineplus">+        &quot;chrome://messenger/locale/messenger.properties&quot;);</span>
<a href="#l1.160"></a><span id="l1.160"> </span>
<a href="#l1.161"></a><span id="l1.161">       let title = bundle.GetStringFromName(&quot;openWindowWarningTitle&quot;);</span>
<a href="#l1.162"></a><span id="l1.162">       let params = [numMessages];</span>
<a href="#l1.163"></a><span id="l1.163">       let message = bundle.formatStringFromName(&quot;openWindowWarningText&quot;,</span>
<a href="#l1.164"></a><span id="l1.164">                                                 params, params.length);</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineminus">-      let promptService = Cc[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l1.166"></a><span id="l1.166" class="difflineminus">-                            .getService(Ci.nsIPromptService);</span>
<a href="#l1.167"></a><span id="l1.167" class="difflineminus">-      if (!promptService.confirm(null, title, message))</span>
<a href="#l1.168"></a><span id="l1.168" class="difflineplus">+      if (!Services.prompt.confirm(null, title, message))</span>
<a href="#l1.169"></a><span id="l1.169">         return;</span>
<a href="#l1.170"></a><span id="l1.170">     }</span>
<a href="#l1.171"></a><span id="l1.171"> </span>
<a href="#l1.172"></a><span id="l1.172">     for each (let [, msgHdr] in Iterator(aMsgHdrs))</span>
<a href="#l1.173"></a><span id="l1.173">       this.openMessageInNewWindow(msgHdr, aViewWrapperToClone);</span>
<a href="#l1.174"></a><span id="l1.174">   },</span>
<a href="#l1.175"></a><span id="l1.175"> </span>
<a href="#l1.176"></a><span id="l1.176">   /**</span>
<a href="#l1.177"></a><span id="l1.177" class="difflineat">@@ -276,28 +257,24 @@ var MailUtils =</span>
<a href="#l1.178"></a><span id="l1.178">    * useful when the message needs to be displayed in the context of its folder</span>
<a href="#l1.179"></a><span id="l1.179">    * or thread.</span>
<a href="#l1.180"></a><span id="l1.180">    *</span>
<a href="#l1.181"></a><span id="l1.181">    * @param aMsgHdr the message header to display</span>
<a href="#l1.182"></a><span id="l1.182">    */</span>
<a href="#l1.183"></a><span id="l1.183">   displayMessageInFolderTab: function MailUtils_displayMessageInFolderTab(</span>
<a href="#l1.184"></a><span id="l1.184">                                  aMsgHdr) {</span>
<a href="#l1.185"></a><span id="l1.185">     // Try opening new tabs in a 3pane window</span>
<a href="#l1.186"></a><span id="l1.186" class="difflineminus">-    let windowMediator = Cc[&quot;@mozilla.org/appshell/window-mediator;1&quot;]</span>
<a href="#l1.187"></a><span id="l1.187" class="difflineminus">-                           .getService(Ci.nsIWindowMediator);</span>
<a href="#l1.188"></a><span id="l1.188" class="difflineminus">-    let mail3PaneWindow = windowMediator.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l1.189"></a><span id="l1.189" class="difflineplus">+    let mail3PaneWindow = Services.wm.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l1.190"></a><span id="l1.190">     if (mail3PaneWindow) {</span>
<a href="#l1.191"></a><span id="l1.191">       mail3PaneWindow.MsgDisplayMessageInFolderTab(aMsgHdr);</span>
<a href="#l1.192"></a><span id="l1.192">     }</span>
<a href="#l1.193"></a><span id="l1.193">     else {</span>
<a href="#l1.194"></a><span id="l1.194" class="difflineminus">-      let windowWatcher = Cc[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l1.195"></a><span id="l1.195" class="difflineminus">-                            .getService(Ci.nsIWindowWatcher);</span>
<a href="#l1.196"></a><span id="l1.196">       let args = {msgHdr: aMsgHdr};</span>
<a href="#l1.197"></a><span id="l1.197">       args.wrappedJSObject = args;</span>
<a href="#l1.198"></a><span id="l1.198" class="difflineminus">-      windowWatcher.openWindow(null,</span>
<a href="#l1.199"></a><span id="l1.199" class="difflineplus">+      Services.ww.openWindow(null,</span>
<a href="#l1.200"></a><span id="l1.200">           &quot;chrome://messenger/content/&quot;, &quot;&quot;,</span>
<a href="#l1.201"></a><span id="l1.201">           &quot;all,chrome,dialog=no,status,toolbar&quot;, args);</span>
<a href="#l1.202"></a><span id="l1.202">     }</span>
<a href="#l1.203"></a><span id="l1.203">   },</span>
<a href="#l1.204"></a><span id="l1.204"> </span>
<a href="#l1.205"></a><span id="l1.205">   /**</span>
<a href="#l1.206"></a><span id="l1.206">    * The number of milliseconds to wait between loading of folders in</span>
<a href="#l1.207"></a><span id="l1.207">    * |setStringPropertyOnFolderAndDescendents|.  We wait at all because</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/modules/mailInstrumentation.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/modules/mailInstrumentation.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -201,18 +201,16 @@ var mailInstrumentationManager =</span>
<a href="#l2.4"></a><span id="l2.4">     Services.prefs.addObserver(&quot;mail.smtpservers&quot;, this._smtpServerAdded, false);</span>
<a href="#l2.5"></a><span id="l2.5">     gMFNService.addListener(this, nsIMFNService.msgAdded);</span>
<a href="#l2.6"></a><span id="l2.6">     this._observersRegistered = true;</span>
<a href="#l2.7"></a><span id="l2.7">     this._mfnListener = true;</span>
<a href="#l2.8"></a><span id="l2.8">   },</span>
<a href="#l2.9"></a><span id="l2.9">   uninit: function() {</span>
<a href="#l2.10"></a><span id="l2.10">     if (!this._observersRegistered)</span>
<a href="#l2.11"></a><span id="l2.11">       return;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-    let os = Cc[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-              .getService(Ci.nsIObserverService);</span>
<a href="#l2.14"></a><span id="l2.14">     Services.obs.removeObserver(this, &quot;mail:composeSendSucceeded&quot;);</span>
<a href="#l2.15"></a><span id="l2.15">     Services.obs.removeObserver(this, &quot;mail:setAsDefault&quot;);</span>
<a href="#l2.16"></a><span id="l2.16">     if (this._mfnListener)</span>
<a href="#l2.17"></a><span id="l2.17">       gMFNService.removeListener(this);</span>
<a href="#l2.18"></a><span id="l2.18">     Services.prefs.removeObserver(&quot;mail.accountmanager.accounts&quot;, this);</span>
<a href="#l2.19"></a><span id="l2.19">     Services.prefs.removeObserver(&quot;mail.instrumentation.userOptedIn&quot;, this);</span>
<a href="#l2.20"></a><span id="l2.20">     Services.prefs.removeObserver(&quot;mail.smtpservers&quot;, this);</span>
<a href="#l2.21"></a><span id="l2.21">   },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/base/modules/mailMigrator.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/base/modules/mailMigrator.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -27,53 +27,51 @@ var MailMigrator = {</span>
<a href="#l3.4"></a><span id="l3.4">   _switchDefaultFonts: function MailMigrator__switchDefaultFonts(aFonts,</span>
<a href="#l3.5"></a><span id="l3.5">                                                                  aEncodings) {</span>
<a href="#l3.6"></a><span id="l3.6">     for each (let [, encoding] in Iterator(aEncodings)) {</span>
<a href="#l3.7"></a><span id="l3.7">       let serifPref = &quot;font.name.serif.&quot; + encoding;</span>
<a href="#l3.8"></a><span id="l3.8">       let sansPref = &quot;font.name.sans-serif.&quot; + encoding;</span>
<a href="#l3.9"></a><span id="l3.9">       let variableSizePref = &quot;font.size.variable.&quot; + encoding;</span>
<a href="#l3.10"></a><span id="l3.10">       // This is expected to be one of sans-serif or serif, and determines what</span>
<a href="#l3.11"></a><span id="l3.11">       // we'll link the variable font size to.</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-      let isSansDefault = this._prefBranch.getCharPref(&quot;font.default.&quot; + encoding) ==</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+      let isSansDefault = Services.prefs.getCharPref(&quot;font.default.&quot; + encoding) ==</span>
<a href="#l3.14"></a><span id="l3.14">                             &quot;sans-serif&quot;;</span>
<a href="#l3.15"></a><span id="l3.15"> </span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-      if (!this._prefBranch.prefHasUserValue(serifPref)) {</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-        this._prefBranch.setCharPref(serifPref, aFonts.serif);</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+      if (!Services.prefs.prefHasUserValue(serifPref)) {</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+        Services.prefs.setCharPref(serifPref, aFonts.serif);</span>
<a href="#l3.20"></a><span id="l3.20">         if (!isSansDefault)</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-          this._prefBranch.setIntPref(variableSizePref, aFonts.variableSize);</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+          Services.prefs.setIntPref(variableSizePref, aFonts.variableSize);</span>
<a href="#l3.23"></a><span id="l3.23">       }</span>
<a href="#l3.24"></a><span id="l3.24"> </span>
<a href="#l3.25"></a><span id="l3.25" class="difflineminus">-      if (!this._prefBranch.prefHasUserValue(sansPref)) {</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-        this._prefBranch.setCharPref(sansPref, aFonts.sans);</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+      if (!Services.prefs.prefHasUserValue(sansPref)) {</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+        Services.prefs.setCharPref(sansPref, aFonts.sans);</span>
<a href="#l3.29"></a><span id="l3.29">         if (isSansDefault)</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-          this._prefBranch.setIntPref(variableSizePref, aFonts.variableSize);</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+          Services.prefs.setIntPref(variableSizePref, aFonts.variableSize);</span>
<a href="#l3.32"></a><span id="l3.32">       }</span>
<a href="#l3.33"></a><span id="l3.33"> </span>
<a href="#l3.34"></a><span id="l3.34">       let monospacePref = &quot;font.name.monospace.&quot; + encoding;</span>
<a href="#l3.35"></a><span id="l3.35">       let fixedSizePref = &quot;font.size.fixed.&quot; + encoding;</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">-      if (!this._prefBranch.prefHasUserValue(monospacePref)) {</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineminus">-        this._prefBranch.setCharPref(monospacePref, aFonts.monospace);</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineminus">-        this._prefBranch.setIntPref(fixedSizePref, aFonts.fixedSize);</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+      if (!Services.prefs.prefHasUserValue(monospacePref)) {</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+        Services.prefs.setCharPref(monospacePref, aFonts.monospace);</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+        Services.prefs.setIntPref(fixedSizePref, aFonts.fixedSize);</span>
<a href="#l3.42"></a><span id="l3.42">       }</span>
<a href="#l3.43"></a><span id="l3.43">     }</span>
<a href="#l3.44"></a><span id="l3.44">   },</span>
<a href="#l3.45"></a><span id="l3.45"> </span>
<a href="#l3.46"></a><span id="l3.46">   /**</span>
<a href="#l3.47"></a><span id="l3.47">    * Migrate to ClearType fonts (Cambria, Calibri and Consolas) on Windows Vista</span>
<a href="#l3.48"></a><span id="l3.48">    * and above.</span>
<a href="#l3.49"></a><span id="l3.49">    */</span>
<a href="#l3.50"></a><span id="l3.50">   migrateToClearTypeFonts: function MailMigrator_migrateToClearTypeFonts() {</span>
<a href="#l3.51"></a><span id="l3.51">     // Windows...</span>
<a href="#l3.52"></a><span id="l3.52">     if (&quot;@mozilla.org/windows-registry-key;1&quot; in Components.classes) {</span>
<a href="#l3.53"></a><span id="l3.53">       // Only migrate on Vista (Windows version 6.0) and above</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineminus">-      let sysInfo = Cc[&quot;@mozilla.org/system-info;1&quot;]</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineminus">-                      .getService(Ci.nsIPropertyBag2);</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineminus">-      if (sysInfo.getPropertyAsDouble(&quot;version&quot;) &gt;= 6.0) {</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+      if (Services.sysinfo.getPropertyAsDouble(&quot;version&quot;) &gt;= 6.0) {</span>
<a href="#l3.58"></a><span id="l3.58">         let fontPrefVersion =</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineminus">-          this._prefBranch.getIntPref(&quot;mail.font.windows.version&quot;);</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+          Services.prefs.getIntPref(&quot;mail.font.windows.version&quot;);</span>
<a href="#l3.61"></a><span id="l3.61">         if (fontPrefVersion &lt; 2) {</span>
<a href="#l3.62"></a><span id="l3.62">           let fonts = {</span>
<a href="#l3.63"></a><span id="l3.63">             serif: &quot;Cambria&quot;,</span>
<a href="#l3.64"></a><span id="l3.64">             sans: &quot;Calibri&quot;,</span>
<a href="#l3.65"></a><span id="l3.65">             monospace: &quot;Consolas&quot;,</span>
<a href="#l3.66"></a><span id="l3.66">             variableSize: 17,</span>
<a href="#l3.67"></a><span id="l3.67">             fixedSize: 14,</span>
<a href="#l3.68"></a><span id="l3.68">           };</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineat">@@ -82,17 +80,17 @@ var MailMigrator = {</span>
<a href="#l3.70"></a><span id="l3.70">           // (Thunderbird 3.1)</span>
<a href="#l3.71"></a><span id="l3.71">           if (fontPrefVersion &lt; 1)</span>
<a href="#l3.72"></a><span id="l3.72">             encodings.push(&quot;x-unicode&quot;, &quot;x-western&quot;);</span>
<a href="#l3.73"></a><span id="l3.73">           // (Thunderbird 3.2)</span>
<a href="#l3.74"></a><span id="l3.74">           encodings.push(&quot;x-central-euro&quot;, &quot;x-cyrillic&quot;, &quot;x-baltic&quot;, &quot;el&quot;, &quot;tr&quot;);</span>
<a href="#l3.75"></a><span id="l3.75"> </span>
<a href="#l3.76"></a><span id="l3.76">           this._switchDefaultFonts(fonts, encodings);</span>
<a href="#l3.77"></a><span id="l3.77"> </span>
<a href="#l3.78"></a><span id="l3.78" class="difflineminus">-          this._prefBranch.setIntPref(&quot;mail.font.windows.version&quot;, 2);</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+          Services.prefs.setIntPref(&quot;mail.font.windows.version&quot;, 2);</span>
<a href="#l3.80"></a><span id="l3.80">         }</span>
<a href="#l3.81"></a><span id="l3.81">       }</span>
<a href="#l3.82"></a><span id="l3.82">     }</span>
<a href="#l3.83"></a><span id="l3.83">   },</span>
<a href="#l3.84"></a><span id="l3.84"> </span>
<a href="#l3.85"></a><span id="l3.85">   /**</span>
<a href="#l3.86"></a><span id="l3.86">    * Determine if the UI has been upgraded in a way that requires us to reset</span>
<a href="#l3.87"></a><span id="l3.87">    * some user configuration.  If so, performs the resets.</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineat">@@ -374,12 +372,8 @@ var MailMigrator = {</span>
<a href="#l3.89"></a><span id="l3.89">     }</span>
<a href="#l3.90"></a><span id="l3.90">     catch(e) {</span>
<a href="#l3.91"></a><span id="l3.91">       // If something's gone wrong here, report it in the Error Console.</span>
<a href="#l3.92"></a><span id="l3.92">       Cu.reportError(e);</span>
<a href="#l3.93"></a><span id="l3.93">       throw(e);</span>
<a href="#l3.94"></a><span id="l3.94">     }</span>
<a href="#l3.95"></a><span id="l3.95">   },</span>
<a href="#l3.96"></a><span id="l3.96"> };</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineminus">-</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineminus">-XPCOMUtils.defineLazyServiceGetter(MailMigrator, &quot;_prefBranch&quot;,</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineminus">-                                   &quot;@mozilla.org/preferences-service;1&quot;,</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineminus">-                                   &quot;nsIPrefBranch&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/base/modules/quickFilterManager.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/base/modules/quickFilterManager.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -5,27 +5,25 @@</span>
<a href="#l4.4"></a><span id="l4.4"> const EXPORTED_SYMBOLS = [&quot;QuickFilterState&quot;, &quot;QuickFilterManager&quot;,</span>
<a href="#l4.5"></a><span id="l4.5">                           &quot;MessageTextFilter&quot;, &quot;QuickFilterSearchListener&quot;];</span>
<a href="#l4.6"></a><span id="l4.6"> const Cc = Components.classes;</span>
<a href="#l4.7"></a><span id="l4.7"> const Ci = Components.interfaces;</span>
<a href="#l4.8"></a><span id="l4.8"> const Cr = Components.results;</span>
<a href="#l4.9"></a><span id="l4.9"> const Cu = Components.utils;</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11"> Cu.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+Cu.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l4.13"></a><span id="l4.13"> </span>
<a href="#l4.14"></a><span id="l4.14"> Cu.import(&quot;resource:///modules/searchSpec.js&quot;);</span>
<a href="#l4.15"></a><span id="l4.15"> Cu.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l4.16"></a><span id="l4.16"> Cu.import(&quot;resource:///modules/errUtils.js&quot;);</span>
<a href="#l4.17"></a><span id="l4.17"> </span>
<a href="#l4.18"></a><span id="l4.18"> const Application = Cc[&quot;@mozilla.org/steel/application;1&quot;]</span>
<a href="#l4.19"></a><span id="l4.19">                       .getService(Ci.steelIApplication);</span>
<a href="#l4.20"></a><span id="l4.20"> </span>
<a href="#l4.21"></a><span id="l4.21" class="difflineminus">-const FocusManager = Cc[&quot;@mozilla.org/focus-manager;1&quot;]</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineminus">-                       .getService(Ci.nsIFocusManager);</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineminus">-</span>
<a href="#l4.24"></a><span id="l4.24"> const nsMsgSearchAttrib = Components.interfaces.nsMsgSearchAttrib;</span>
<a href="#l4.25"></a><span id="l4.25"> const nsMsgMessageFlags = Components.interfaces.nsMsgMessageFlags;</span>
<a href="#l4.26"></a><span id="l4.26"> const nsMsgSearchOp = Components.interfaces.nsMsgSearchOp;</span>
<a href="#l4.27"></a><span id="l4.27"> </span>
<a href="#l4.28"></a><span id="l4.28"> // XXX we need to know whether the gloda indexer is enabled for upsell reasons,</span>
<a href="#l4.29"></a><span id="l4.29"> // but this should really just be exposed on the main Gloda public interface.</span>
<a href="#l4.30"></a><span id="l4.30"> Cu.import(&quot;resource:///modules/gloda/indexer.js&quot;);</span>
<a href="#l4.31"></a><span id="l4.31"> // we need to be able to create gloda message searcher instances for upsells:</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineat">@@ -1071,17 +1069,17 @@ let MessageTextFilter = {</span>
<a href="#l4.33"></a><span id="l4.33">       else if (aEvent.keyCode == aEvent.DOM_VK_ENTER) {</span>
<a href="#l4.34"></a><span id="l4.34">       }</span>
<a href="#l4.35"></a><span id="l4.35">       return true;</span>
<a href="#l4.36"></a><span id="l4.36">     }, false);</span>
<a href="#l4.37"></a><span id="l4.37"> </span>
<a href="#l4.38"></a><span id="l4.38">     // -- Blurring kills upsell.</span>
<a href="#l4.39"></a><span id="l4.39">     aNode.addEventListener(&quot;blur&quot;, function(aEvent) {</span>
<a href="#l4.40"></a><span id="l4.40">       let panel = aDocument.getElementById(&quot;qfb-text-search-upsell&quot;);</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineminus">-      if ((FocusManager.activeWindow != aDocument.defaultView ||</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+      if ((Services.focus.activeWindow != aDocument.defaultView ||</span>
<a href="#l4.43"></a><span id="l4.43">            aDocument.commandDispatcher.focusedElement != aNode.inputField) &amp;&amp;</span>
<a href="#l4.44"></a><span id="l4.44">           panel.state == &quot;open&quot;) {</span>
<a href="#l4.45"></a><span id="l4.45">         panel.hidePopup();</span>
<a href="#l4.46"></a><span id="l4.46">       }</span>
<a href="#l4.47"></a><span id="l4.47">     }, true);</span>
<a href="#l4.48"></a><span id="l4.48"> </span>
<a href="#l4.49"></a><span id="l4.49">     // -- Expando Buttons!</span>
<a href="#l4.50"></a><span id="l4.50">     function commandHandler(aEvent) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/base/modules/searchSpec.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/base/modules/searchSpec.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -5,16 +5,17 @@</span>
<a href="#l5.4"></a><span id="l5.4"> const EXPORTED_SYMBOLS = ['SearchSpec'];</span>
<a href="#l5.5"></a><span id="l5.5"> </span>
<a href="#l5.6"></a><span id="l5.6"> const Cc = Components.classes;</span>
<a href="#l5.7"></a><span id="l5.7"> const Ci = Components.interfaces;</span>
<a href="#l5.8"></a><span id="l5.8"> const Cr = Components.results;</span>
<a href="#l5.9"></a><span id="l5.9"> const Cu = Components.utils;</span>
<a href="#l5.10"></a><span id="l5.10"> </span>
<a href="#l5.11"></a><span id="l5.11"> Cu.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+Cu.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l5.13"></a><span id="l5.13"> </span>
<a href="#l5.14"></a><span id="l5.14"> const nsMsgSearchScope = Ci.nsMsgSearchScope;</span>
<a href="#l5.15"></a><span id="l5.15"> const nsIMsgSearchTerm = Ci.nsIMsgSearchTerm;</span>
<a href="#l5.16"></a><span id="l5.16"> const nsIMsgLocalMailFolder = Ci.nsIMsgLocalMailFolder;</span>
<a href="#l5.17"></a><span id="l5.17"> const nsMsgFolderFlags = Ci.nsMsgFolderFlags;</span>
<a href="#l5.18"></a><span id="l5.18"> const nsMsgSearchAttrib = Ci.nsMsgSearchAttrib;</span>
<a href="#l5.19"></a><span id="l5.19"> </span>
<a href="#l5.20"></a><span id="l5.20"> const NS_MSG_SEARCH_INTERRUPTED = 0x00550002;</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineat">@@ -399,30 +400,28 @@ SearchSpec.prototype = {</span>
<a href="#l5.22"></a><span id="l5.22">     if (this.owner.isSynthetic) {</span>
<a href="#l5.23"></a><span id="l5.23">       // We don't want to pass in a folder, and we don't want to use the</span>
<a href="#l5.24"></a><span id="l5.24">       //  allSearchableGroups scope, so we cheat and use AddDirectoryScopeTerm.</span>
<a href="#l5.25"></a><span id="l5.25">       session.addDirectoryScopeTerm(nsMsgSearchScope.offlineMail);</span>
<a href="#l5.26"></a><span id="l5.26">       return;</span>
<a href="#l5.27"></a><span id="l5.27">     }</span>
<a href="#l5.28"></a><span id="l5.28"> </span>
<a href="#l5.29"></a><span id="l5.29">     let filtering = this._userTerms != null || this._viewTerms != null;</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-    let ioService = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-                      .getService(Ci.nsIIOService);</span>
<a href="#l5.32"></a><span id="l5.32">     let validityManager = Cc['@mozilla.org/mail/search/validityManager;1']</span>
<a href="#l5.33"></a><span id="l5.33">                             .getService(Ci.nsIMsgSearchValidityManager);</span>
<a href="#l5.34"></a><span id="l5.34">     for each (let [, folder] in Iterator(this.owner._underlyingFolders)) {</span>
<a href="#l5.35"></a><span id="l5.35">       // we do not need to check isServer here because _underlyingFolders</span>
<a href="#l5.36"></a><span id="l5.36">       //  filtered it out when it was initialized.</span>
<a href="#l5.37"></a><span id="l5.37"> </span>
<a href="#l5.38"></a><span id="l5.38">       let scope;</span>
<a href="#l5.39"></a><span id="l5.39">       let serverScope = folder.server.searchScope;</span>
<a href="#l5.40"></a><span id="l5.40">       // If we're offline, or this is a local folder, or there's no separate</span>
<a href="#l5.41"></a><span id="l5.41">       //  online scope, use server scope.</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineminus">-      if (ioService.offline || (serverScope == nsMsgSearchScope.offlineMail) ||</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-                               (folder instanceof nsIMsgLocalMailFolder))</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+      if (Services.io.offline || (serverScope == nsMsgSearchScope.offlineMail) ||</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+                                 (folder instanceof nsIMsgLocalMailFolder))</span>
<a href="#l5.46"></a><span id="l5.46">         scope = serverScope;</span>
<a href="#l5.47"></a><span id="l5.47">       else {</span>
<a href="#l5.48"></a><span id="l5.48">         // we need to test the validity in online and offline tables</span>
<a href="#l5.49"></a><span id="l5.49">         let onlineValidityTable = validityManager.getTable(serverScope);</span>
<a href="#l5.50"></a><span id="l5.50"> </span>
<a href="#l5.51"></a><span id="l5.51">         let offlineScope;</span>
<a href="#l5.52"></a><span id="l5.52">         if (folder.flags &amp; nsMsgFolderFlags.Offline)</span>
<a href="#l5.53"></a><span id="l5.53">           offlineScope = nsMsgSearchScope.offlineMail;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/base/modules/sessionStoreManager.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/base/modules/sessionStoreManager.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -10,16 +10,17 @@</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5"> const EXPORTED_SYMBOLS = [&quot;sessionStoreManager&quot;];</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7"> const Cc = Components.classes;</span>
<a href="#l6.8"></a><span id="l6.8"> const Ci = Components.interfaces;</span>
<a href="#l6.9"></a><span id="l6.9"> const Cu = Components.utils;</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11"> Cu.import(&quot;resource:///modules/IOUtils.js&quot;);</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+Cu.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l6.13"></a><span id="l6.13"> </span>
<a href="#l6.14"></a><span id="l6.14"> /**</span>
<a href="#l6.15"></a><span id="l6.15">  * asuth arbitrarily chose this value to trade-off powersaving,</span>
<a href="#l6.16"></a><span id="l6.16">  * processor usage, and recency of state in the face of the impossibility of</span>
<a href="#l6.17"></a><span id="l6.17">  * our crashing; he also worded this.</span>
<a href="#l6.18"></a><span id="l6.18">  */</span>
<a href="#l6.19"></a><span id="l6.19"> const SESSION_AUTO_SAVE_DEFAULT_MS = 300000; // 5 minutes</span>
<a href="#l6.20"></a><span id="l6.20"> </span>
<a href="#l6.21"></a><span id="l6.21" class="difflineat">@@ -60,19 +61,17 @@ var sessionStoreManager =</span>
<a href="#l6.22"></a><span id="l6.22">    */</span>
<a href="#l6.23"></a><span id="l6.23">   _init: function ssm_init()</span>
<a href="#l6.24"></a><span id="l6.24">   {</span>
<a href="#l6.25"></a><span id="l6.25">     this._loadSessionFile();</span>
<a href="#l6.26"></a><span id="l6.26"> </span>
<a href="#l6.27"></a><span id="l6.27">     // we listen for &quot;quit-application-granted&quot; instead of</span>
<a href="#l6.28"></a><span id="l6.28">     // &quot;quit-application-requested&quot; because other observers of the</span>
<a href="#l6.29"></a><span id="l6.29">     // latter can cancel the shutdown.</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-    var observerSvc = Cc[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-                      .getService(Ci.nsIObserverService);</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-    observerSvc.addObserver(this, &quot;quit-application-granted&quot;, false);</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+    Services.obs.addObserver(this, &quot;quit-application-granted&quot;, false);</span>
<a href="#l6.34"></a><span id="l6.34"> </span>
<a href="#l6.35"></a><span id="l6.35">     this.startPeriodicSave();</span>
<a href="#l6.36"></a><span id="l6.36"> </span>
<a href="#l6.37"></a><span id="l6.37">     this._initialized = true;</span>
<a href="#l6.38"></a><span id="l6.38">   },</span>
<a href="#l6.39"></a><span id="l6.39"> </span>
<a href="#l6.40"></a><span id="l6.40">   /**</span>
<a href="#l6.41"></a><span id="l6.41">    * Loads the session file into _initialState. This should only be called by</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineat">@@ -156,22 +155,19 @@ var sessionStoreManager =</span>
<a href="#l6.43"></a><span id="l6.43"> </span>
<a href="#l6.44"></a><span id="l6.44">   /**</span>
<a href="#l6.45"></a><span id="l6.45">    * Writes the state of all currently open 3pane windows to disk.</span>
<a href="#l6.46"></a><span id="l6.46">    */</span>
<a href="#l6.47"></a><span id="l6.47">   _saveState: function ssm_saveState()</span>
<a href="#l6.48"></a><span id="l6.48">   {</span>
<a href="#l6.49"></a><span id="l6.49">     let state = this._createStateObject();</span>
<a href="#l6.50"></a><span id="l6.50"> </span>
<a href="#l6.51"></a><span id="l6.51" class="difflineminus">-    let windowMediator = Cc[&quot;@mozilla.org/appshell/window-mediator;1&quot;]</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineminus">-                         .getService(Ci.nsIWindowMediator);</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineminus">-</span>
<a href="#l6.54"></a><span id="l6.54">     // XXX we'd like to support other window types in future, but for now</span>
<a href="#l6.55"></a><span id="l6.55">     // only get the 3pane windows.</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineminus">-    let enumerator = windowMediator.getEnumerator(&quot;mail:3pane&quot;);</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+    let enumerator = Services.wm.getEnumerator(&quot;mail:3pane&quot;);</span>
<a href="#l6.58"></a><span id="l6.58">     while (enumerator.hasMoreElements()) {</span>
<a href="#l6.59"></a><span id="l6.59">       let win = enumerator.getNext();</span>
<a href="#l6.60"></a><span id="l6.60">       if (win &amp;&amp; &quot;complete&quot; == win.document.readyState &amp;&amp;</span>
<a href="#l6.61"></a><span id="l6.61">           win.getWindowStateForSessionPersistence)</span>
<a href="#l6.62"></a><span id="l6.62">         state.windows.push(win.getWindowStateForSessionPersistence());</span>
<a href="#l6.63"></a><span id="l6.63">     }</span>
<a href="#l6.64"></a><span id="l6.64"> </span>
<a href="#l6.65"></a><span id="l6.65">     this._saveStateObject(state);</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineat">@@ -243,19 +239,17 @@ var sessionStoreManager =</span>
<a href="#l6.67"></a><span id="l6.67">    * last 3pane window, its state is persisted. The last 3pane window unloads</span>
<a href="#l6.68"></a><span id="l6.68">    * first before the &quot;quit-application-granted&quot; event is generated.</span>
<a href="#l6.69"></a><span id="l6.69">    */</span>
<a href="#l6.70"></a><span id="l6.70">   unloadingWindow: function ssm_unloadingWindow(aWindow)</span>
<a href="#l6.71"></a><span id="l6.71">   {</span>
<a href="#l6.72"></a><span id="l6.72">     if (!this._shutdownStateSaved) {</span>
<a href="#l6.73"></a><span id="l6.73">       // determine whether aWindow is the last open window</span>
<a href="#l6.74"></a><span id="l6.74">       let lastWindow = true;</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineminus">-      let windowMediator = Cc[&quot;@mozilla.org/appshell/window-mediator;1&quot;]</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineminus">-                           .getService(Ci.nsIWindowMediator);</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineminus">-      let enumerator = windowMediator.getEnumerator(&quot;mail:3pane&quot;);</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineplus">+      let enumerator = Services.wm.getEnumerator(&quot;mail:3pane&quot;);</span>
<a href="#l6.79"></a><span id="l6.79">       while (enumerator.hasMoreElements()) {</span>
<a href="#l6.80"></a><span id="l6.80">         if (enumerator.getNext() != aWindow)</span>
<a href="#l6.81"></a><span id="l6.81">           lastWindow = false;</span>
<a href="#l6.82"></a><span id="l6.82">       }</span>
<a href="#l6.83"></a><span id="l6.83"> </span>
<a href="#l6.84"></a><span id="l6.84">       if (lastWindow) {</span>
<a href="#l6.85"></a><span id="l6.85">         // last chance to save any state for the current session since</span>
<a href="#l6.86"></a><span id="l6.86">         // aWindow is the last 3pane window and the &quot;quit-application-granted&quot;</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineat">@@ -302,15 +296,13 @@ var sessionStoreManager =</span>
<a href="#l6.88"></a><span id="l6.88">     }</span>
<a href="#l6.89"></a><span id="l6.89">   },</span>
<a href="#l6.90"></a><span id="l6.90"> </span>
<a href="#l6.91"></a><span id="l6.91">   /**</span>
<a href="#l6.92"></a><span id="l6.92">    * Gets the file used for session storage.</span>
<a href="#l6.93"></a><span id="l6.93">    */</span>
<a href="#l6.94"></a><span id="l6.94">   get sessionFile()</span>
<a href="#l6.95"></a><span id="l6.95">   {</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineminus">-    let sessionFile = Cc[&quot;@mozilla.org/file/directory_service;1&quot;]</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineminus">-                      .getService(Ci.nsIProperties)</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineminus">-                      .get(&quot;ProfD&quot;, Ci.nsIFile);</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineplus">+    let sessionFile = Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsIFile);</span>
<a href="#l6.100"></a><span id="l6.100">     sessionFile.append(&quot;session.json&quot;);</span>
<a href="#l6.101"></a><span id="l6.101">     return sessionFile;</span>
<a href="#l6.102"></a><span id="l6.102">   }</span>
<a href="#l6.103"></a><span id="l6.103"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/components/aboutRedirector.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/components/aboutRedirector.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -44,19 +44,17 @@ AboutRedirector.prototype = {</span>
<a href="#l7.4"></a><span id="l7.4">     let name = this._getModuleName(aURI);</span>
<a href="#l7.5"></a><span id="l7.5">     if (!(name in this._redirMap))</span>
<a href="#l7.6"></a><span id="l7.6">       throw Components.results.NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l7.7"></a><span id="l7.7"> </span>
<a href="#l7.8"></a><span id="l7.8">     let channel = Services.io.newChannel(this._redirMap[name].url, null, null);</span>
<a href="#l7.9"></a><span id="l7.9">     channel.originalURI = aURI;</span>
<a href="#l7.10"></a><span id="l7.10"> </span>
<a href="#l7.11"></a><span id="l7.11">     if (this._redirMap[name].flags &amp; Ci.nsIAboutModule.URI_SAFE_FOR_UNTRUSTED_CONTENT) {</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-      let secMan = Cc[&quot;@mozilla.org/scriptsecuritymanager;1&quot;]</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-                     .getService(Ci.nsIScriptSecurityManager);</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-      let principal = secMan.getNoAppCodebasePrincipal(aURI);</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+      let principal = Services.scriptSecurityManager.getNoAppCodebasePrincipal(aURI);</span>
<a href="#l7.16"></a><span id="l7.16">       channel.owner = principal;</span>
<a href="#l7.17"></a><span id="l7.17">     }</span>
<a href="#l7.18"></a><span id="l7.18"> </span>
<a href="#l7.19"></a><span id="l7.19">     return channel;</span>
<a href="#l7.20"></a><span id="l7.20">   }</span>
<a href="#l7.21"></a><span id="l7.21"> };</span>
<a href="#l7.22"></a><span id="l7.22"> </span>
<a href="#l7.23"></a><span id="l7.23"> const NSGetFactory = XPCOMUtils.generateNSGetFactory([AboutRedirector]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/components/appIdleManager.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/components/appIdleManager.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -1,15 +1,17 @@</span>
<a href="#l8.4"></a><span id="l8.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l8.5"></a><span id="l8.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.6"></a><span id="l8.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.7"></a><span id="l8.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9"> const EXPORTED_SYMBOLS = ['appIdleManager'];</span>
<a href="#l8.10"></a><span id="l8.10"> </span>
<a href="#l8.11"></a><span id="l8.11" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+</span>
<a href="#l8.13"></a><span id="l8.13"> const Cc = Components.classes;</span>
<a href="#l8.14"></a><span id="l8.14"> const Ci = Components.interfaces;</span>
<a href="#l8.15"></a><span id="l8.15"> </span>
<a href="#l8.16"></a><span id="l8.16"> // This module provides a mechanism to turn window focus and blur events</span>
<a href="#l8.17"></a><span id="l8.17"> // into app idle notifications. If we get a blur notification that is not</span>
<a href="#l8.18"></a><span id="l8.18"> // followed by a focus notification in less than some small number of seconds,</span>
<a href="#l8.19"></a><span id="l8.19"> // then we send a begin app idle notification.</span>
<a href="#l8.20"></a><span id="l8.20"> // If we get a focus event, and we're app idle, then we send an end app idle </span>
<a href="#l8.21"></a><span id="l8.21" class="difflineat">@@ -24,32 +26,30 @@ var appIdleManager =</span>
<a href="#l8.22"></a><span id="l8.22">   {</span>
<a href="#l8.23"></a><span id="l8.23">     delete this._timer;</span>
<a href="#l8.24"></a><span id="l8.24">     return this._timer = Cc[&quot;@mozilla.org/timer;1&quot;].createInstance(Ci.nsITimer);</span>
<a href="#l8.25"></a><span id="l8.25">   },</span>
<a href="#l8.26"></a><span id="l8.26"> </span>
<a href="#l8.27"></a><span id="l8.27">   _timerCallback: function()</span>
<a href="#l8.28"></a><span id="l8.28">   {</span>
<a href="#l8.29"></a><span id="l8.29">     appIdleManager._appIdle = true;</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-    Cc[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-      .getService(Components.interfaces.nsIObserverService).notifyObservers(null, &quot;mail:appIdle&quot;, &quot;idle&quot;);</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+    Services.obs.notifyObservers(null, &quot;mail:appIdle&quot;, &quot;idle&quot;);</span>
<a href="#l8.33"></a><span id="l8.33">     </span>
<a href="#l8.34"></a><span id="l8.34">   },</span>
<a href="#l8.35"></a><span id="l8.35">   </span>
<a href="#l8.36"></a><span id="l8.36">   onBlur: function()</span>
<a href="#l8.37"></a><span id="l8.37">   {</span>
<a href="#l8.38"></a><span id="l8.38">     appIdleManager._timer.initWithCallback(appIdleManager._timerCallback,</span>
<a href="#l8.39"></a><span id="l8.39">                                  appIdleManager._timerInterval,</span>
<a href="#l8.40"></a><span id="l8.40">                                  Ci.nsITimer.TYPE_ONE_SHOT);</span>
<a href="#l8.41"></a><span id="l8.41">    },</span>
<a href="#l8.42"></a><span id="l8.42">   </span>
<a href="#l8.43"></a><span id="l8.43">   onFocus: function()</span>
<a href="#l8.44"></a><span id="l8.44">   {</span>
<a href="#l8.45"></a><span id="l8.45">     appIdleManager._timer.cancel();</span>
<a href="#l8.46"></a><span id="l8.46">     if (appIdleManager._appIdle)</span>
<a href="#l8.47"></a><span id="l8.47">     {</span>
<a href="#l8.48"></a><span id="l8.48">       appIdleManager._appIdle = false;</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineminus">-      Cc[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineminus">-        .getService(Components.interfaces.nsIObserverService).notifyObservers(null, &quot;mail:appIdle&quot;, &quot;back&quot;);</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+      Services.obs.notifyObservers(null, &quot;mail:appIdle&quot;, &quot;back&quot;);</span>
<a href="#l8.52"></a><span id="l8.52">     }</span>
<a href="#l8.53"></a><span id="l8.53">   }</span>
<a href="#l8.54"></a><span id="l8.54"> };</span>
<a href="#l8.55"></a><span id="l8.55"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/components/migration/content/migration.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/components/migration/content/migration.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1,33 +1,34 @@</span>
<a href="#l9.4"></a><span id="l9.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.5"></a><span id="l9.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.6"></a><span id="l9.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.7"></a><span id="l9.7"> </span>
<a href="#l9.8"></a><span id="l9.8" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineplus">+</span>
<a href="#l9.10"></a><span id="l9.10"> const kIMig = Components.interfaces.nsIMailProfileMigrator;</span>
<a href="#l9.11"></a><span id="l9.11"> const kIPStartup = Components.interfaces.nsIProfileStartup;</span>
<a href="#l9.12"></a><span id="l9.12"> const kProfileMigratorContractIDPrefix = &quot;@mozilla.org/profile/migrator;1?app=mail&amp;type=&quot;;</span>
<a href="#l9.13"></a><span id="l9.13"> const nsISupportsString = Components.interfaces.nsISupportsString;</span>
<a href="#l9.14"></a><span id="l9.14"> </span>
<a href="#l9.15"></a><span id="l9.15"> var MigrationWizard = {</span>
<a href="#l9.16"></a><span id="l9.16">   _source: &quot;&quot;,                  // Source Profile Migrator ContractID suffix</span>
<a href="#l9.17"></a><span id="l9.17">   _itemsFlags: kIMig.ALL,       // Selected Import Data Sources (16-bit bitfield)</span>
<a href="#l9.18"></a><span id="l9.18">   _selectedProfile: null,       // Selected Profile name to import from</span>
<a href="#l9.19"></a><span id="l9.19">   _wiz: null,</span>
<a href="#l9.20"></a><span id="l9.20">   _migrator: null,</span>
<a href="#l9.21"></a><span id="l9.21">   _autoMigrate: null,</span>
<a href="#l9.22"></a><span id="l9.22"> </span>
<a href="#l9.23"></a><span id="l9.23">   init: function ()</span>
<a href="#l9.24"></a><span id="l9.24">   {</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineminus">-    var os = Components.classes[&quot;@mozilla.org/observer-service;1&quot;].getService(Components.interfaces.nsIObserverService);</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineminus">-    os.addObserver(this, &quot;Migration:Started&quot;, false);</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineminus">-    os.addObserver(this, &quot;Migration:ItemBeforeMigrate&quot;, false);</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineminus">-    os.addObserver(this, &quot;Migration:ItemAfterMigrate&quot;, false);</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineminus">-    os.addObserver(this, &quot;Migration:Ended&quot;, false);</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-    os.addObserver(this, &quot;Migration:Progress&quot;, false);</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+    Services.obs.addObserver(this, &quot;Migration:Started&quot;, false);</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+    Services.obs.addObserver(this, &quot;Migration:ItemBeforeMigrate&quot;, false);</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+    Services.obs.addObserver(this, &quot;Migration:ItemAfterMigrate&quot;, false);</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineplus">+    Services.obs.addObserver(this, &quot;Migration:Ended&quot;, false);</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineplus">+    Services.obs.addObserver(this, &quot;Migration:Progress&quot;, false);</span>
<a href="#l9.36"></a><span id="l9.36"> </span>
<a href="#l9.37"></a><span id="l9.37">     this._wiz = document.documentElement;</span>
<a href="#l9.38"></a><span id="l9.38"> </span>
<a href="#l9.39"></a><span id="l9.39">     if (&quot;arguments&quot; in window) {</span>
<a href="#l9.40"></a><span id="l9.40">       this._source = window.arguments[0];</span>
<a href="#l9.41"></a><span id="l9.41">       this._migrator = window.arguments[1] ? window.arguments[1].QueryInterface(kIMig) : null;</span>
<a href="#l9.42"></a><span id="l9.42">       this._autoMigrate = window.arguments[2].QueryInterface(kIPStartup);</span>
<a href="#l9.43"></a><span id="l9.43"> </span>
<a href="#l9.44"></a><span id="l9.44" class="difflineat">@@ -53,22 +54,21 @@ var MigrationWizard = {</span>
<a href="#l9.45"></a><span id="l9.45">           .queryElementAt(0, nsISupportsString).data;</span>
<a href="#l9.46"></a><span id="l9.46">         this._wiz.goTo(&quot;migrating&quot;);</span>
<a href="#l9.47"></a><span id="l9.47">       }</span>
<a href="#l9.48"></a><span id="l9.48">     }</span>
<a href="#l9.49"></a><span id="l9.49">   },</span>
<a href="#l9.50"></a><span id="l9.50"> </span>
<a href="#l9.51"></a><span id="l9.51">   uninit: function ()</span>
<a href="#l9.52"></a><span id="l9.52">   {</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineminus">-    var os = Components.classes[&quot;@mozilla.org/observer-service;1&quot;].getService(Components.interfaces.nsIObserverService);</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineminus">-    os.removeObserver(this, &quot;Migration:Started&quot;);</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineminus">-    os.removeObserver(this, &quot;Migration:ItemBeforeMigrate&quot;);</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineminus">-    os.removeObserver(this, &quot;Migration:ItemAfterMigrate&quot;);</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineminus">-    os.removeObserver(this, &quot;Migration:Ended&quot;);</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineminus">-    os.removeObserver(this, &quot;Migration:Progress&quot;);</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineplus">+    Services.obs.removeObserver(this, &quot;Migration:Started&quot;);</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineplus">+    Services.obs.removeObserver(this, &quot;Migration:ItemBeforeMigrate&quot;);</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+    Services.obs.removeObserver(this, &quot;Migration:ItemAfterMigrate&quot;);</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineplus">+    Services.obs.removeObserver(this, &quot;Migration:Ended&quot;);</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineplus">+    Services.obs.removeObserver(this, &quot;Migration:Progress&quot;);</span>
<a href="#l9.64"></a><span id="l9.64">   },</span>
<a href="#l9.65"></a><span id="l9.65"> </span>
<a href="#l9.66"></a><span id="l9.66">   // 1 - Import Source</span>
<a href="#l9.67"></a><span id="l9.67">   onImportSourcePageShow: function ()</span>
<a href="#l9.68"></a><span id="l9.68">   {</span>
<a href="#l9.69"></a><span id="l9.69">     this._wiz.canRewind = false;</span>
<a href="#l9.70"></a><span id="l9.70"> </span>
<a href="#l9.71"></a><span id="l9.71">     // Figure out what source apps are are available to import from:</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/components/newmailaccount/content/accountProvisioner.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/components/newmailaccount/content/accountProvisioner.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -32,24 +32,20 @@ function isAccel (event) (isOSX &amp;&amp; event</span>
<a href="#l10.4"></a><span id="l10.4">  * Cribbed from</span>
<a href="#l10.5"></a><span id="l10.5">  *   mozilla/dom/tests/mochitest/localstorage/test_localStorageFromChrome.xhtml</span>
<a href="#l10.6"></a><span id="l10.6">  *</span>
<a href="#l10.7"></a><span id="l10.7">  * @param {String} page The page to get the localstorage for.</span>
<a href="#l10.8"></a><span id="l10.8">  * @return {nsIDOMStorage} The localstorage for this page.</span>
<a href="#l10.9"></a><span id="l10.9">  */</span>
<a href="#l10.10"></a><span id="l10.10"> function getLocalStorage(page) {</span>
<a href="#l10.11"></a><span id="l10.11">   var url = &quot;chrome://content/messenger/accountProvisionerStorage/&quot; + page;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-  var ssm = Cc[&quot;@mozilla.org/scriptsecuritymanager;1&quot;]</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-    .getService(Ci.nsIScriptSecurityManager);</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-  var dsm = Cc[&quot;@mozilla.org/dom/storagemanager;1&quot;]</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-    .getService(Ci.nsIDOMStorageManager);</span>
<a href="#l10.16"></a><span id="l10.16"> </span>
<a href="#l10.17"></a><span id="l10.17">   var uri = Services.io.newURI(url, &quot;&quot;, null);</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineminus">-  var principal = ssm.getNoAppCodebasePrincipal(uri);</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineminus">-  return dsm.getLocalStorageForPrincipal(principal, url);</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+  var principal = Services.scriptSecurityManager.getNoAppCodebasePrincipal(uri);</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+  return Services.domStorageManager.getLocalStorageForPrincipal(principal, url);</span>
<a href="#l10.22"></a><span id="l10.22"> }</span>
<a href="#l10.23"></a><span id="l10.23"> </span>
<a href="#l10.24"></a><span id="l10.24"> const MAX_SMALL_ADDRESSES = 2;</span>
<a href="#l10.25"></a><span id="l10.25"> </span>
<a href="#l10.26"></a><span id="l10.26"> var storedData = {};</span>
<a href="#l10.27"></a><span id="l10.27"> </span>
<a href="#l10.28"></a><span id="l10.28"> function splitName(str) {</span>
<a href="#l10.29"></a><span id="l10.29">   let i = str.lastIndexOf(&quot; &quot;);</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineat">@@ -402,19 +398,17 @@ var EmailAccountProvisioner = {</span>
<a href="#l10.31"></a><span id="l10.31">     delete data.provider;</span>
<a href="#l10.32"></a><span id="l10.32">     for (let name in data) {</span>
<a href="#l10.33"></a><span id="l10.33">       url += (url.indexOf(&quot;?&quot;) == -1 ? &quot;?&quot; : &quot;&amp;&quot;) +</span>
<a href="#l10.34"></a><span id="l10.34">               name + &quot;=&quot; + encodeURIComponent(data[name]);</span>
<a href="#l10.35"></a><span id="l10.35">     }</span>
<a href="#l10.36"></a><span id="l10.36"> </span>
<a href="#l10.37"></a><span id="l10.37">     gLog.info(&quot;Opening up a contentTab with the order form.&quot;);</span>
<a href="#l10.38"></a><span id="l10.38">     // Then open a content tab.</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineminus">-    let mail3Pane = Cc[&quot;@mozilla.org/appshell/window-mediator;1&quot;]</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineminus">-          .getService(Ci.nsIWindowMediator)</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineminus">-          .getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+    let mail3Pane = Services.wm.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l10.43"></a><span id="l10.43"> </span>
<a href="#l10.44"></a><span id="l10.44">     let tabmail = mail3Pane.document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l10.45"></a><span id="l10.45">     tabmail.openTab(&quot;accountProvisionerTab&quot;, {</span>
<a href="#l10.46"></a><span id="l10.46">       contentPage: url,</span>
<a href="#l10.47"></a><span id="l10.47">       realName: String.trim(firstName + &quot; &quot; + lastName),</span>
<a href="#l10.48"></a><span id="l10.48">       email: email,</span>
<a href="#l10.49"></a><span id="l10.49">       searchEngine: provider.search_engine,</span>
<a href="#l10.50"></a><span id="l10.50">       onLoad: function (aEvent, aBrowser) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/components/newmailaccount/content/accountProvisionerTab.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/components/newmailaccount/content/accountProvisionerTab.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -88,19 +88,17 @@ accountProvisionerTabType.restoreTab = f</span>
<a href="#l11.4"></a><span id="l11.4"> }</span>
<a href="#l11.5"></a><span id="l11.5"> </span>
<a href="#l11.6"></a><span id="l11.6"> /**</span>
<a href="#l11.7"></a><span id="l11.7">  * This function registers an observer to watch for HTTP requests where the</span>
<a href="#l11.8"></a><span id="l11.8">  * contentType contains text/xml.</span>
<a href="#l11.9"></a><span id="l11.9">  */</span>
<a href="#l11.10"></a><span id="l11.10"> accountProvisionerTabType._setMonitoring = function(aBrowser, aRealName,</span>
<a href="#l11.11"></a><span id="l11.11">                                                     aEmail, aSearchEngine) {</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-  let mail3Pane = Cc[&quot;@mozilla.org/appshell/window-mediator;1&quot;]</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-        .getService(Ci.nsIWindowMediator)</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-        .getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+  let mail3Pane = Services.wm.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l11.16"></a><span id="l11.16"> </span>
<a href="#l11.17"></a><span id="l11.17">   // We'll construct our special observer (defined in urlListener.js)</span>
<a href="#l11.18"></a><span id="l11.18">   // that will watch for requests where the contentType contains</span>
<a href="#l11.19"></a><span id="l11.19">   // text/xml.</span>
<a href="#l11.20"></a><span id="l11.20">   this._observer = new mail3Pane.httpRequestObserver(aBrowser, {</span>
<a href="#l11.21"></a><span id="l11.21">     realName: aRealName,</span>
<a href="#l11.22"></a><span id="l11.22">     email: aEmail,</span>
<a href="#l11.23"></a><span id="l11.23">     searchEngine: aSearchEngine,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/components/nsMailDefaultHandler.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/components/nsMailDefaultHandler.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -15,18 +15,16 @@ const nsICommandLineHandler    = Compone</span>
<a href="#l12.4"></a><span id="l12.4"> const nsICommandLineValidator  = Components.interfaces.nsICommandLineValidator;</span>
<a href="#l12.5"></a><span id="l12.5"> const nsIDOMWindow             = Components.interfaces.nsIDOMWindow;</span>
<a href="#l12.6"></a><span id="l12.6"> const nsIFactory               = Components.interfaces.nsIFactory;</span>
<a href="#l12.7"></a><span id="l12.7"> const nsIFileURL               = Components.interfaces.nsIFileURL;</span>
<a href="#l12.8"></a><span id="l12.8"> const nsINetUtil               = Components.interfaces.nsINetUtil;</span>
<a href="#l12.9"></a><span id="l12.9"> const nsISupportsString        = Components.interfaces.nsISupportsString;</span>
<a href="#l12.10"></a><span id="l12.10"> const nsIURIFixup              = Components.interfaces.nsIURIFixup;</span>
<a href="#l12.11"></a><span id="l12.11"> const nsIURILoader             = Components.interfaces.nsIURILoader;</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-const nsIWindowMediator        = Components.interfaces.nsIWindowMediator;</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-const nsIWindowWatcher         = Components.interfaces.nsIWindowWatcher;</span>
<a href="#l12.14"></a><span id="l12.14"> </span>
<a href="#l12.15"></a><span id="l12.15"> const NS_ERROR_ABORT = Components.results.NS_ERROR_ABORT;</span>
<a href="#l12.16"></a><span id="l12.16"> </span>
<a href="#l12.17"></a><span id="l12.17"> const URI_INHERITS_SECURITY_CONTEXT = Components.interfaces.nsIProtocolHandler</span>
<a href="#l12.18"></a><span id="l12.18">                                         .URI_INHERITS_SECURITY_CONTEXT;</span>
<a href="#l12.19"></a><span id="l12.19"> </span>
<a href="#l12.20"></a><span id="l12.20"> function resolveURIInternal(aCmdLine, aArgument) {</span>
<a href="#l12.21"></a><span id="l12.21">   var uri = aCmdLine.resolveURI(aArgument);</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineat">@@ -85,38 +83,33 @@ function mayOpenURI(uri)</span>
<a href="#l12.23"></a><span id="l12.23">   return ext.isExposedProtocol(uri.scheme);</span>
<a href="#l12.24"></a><span id="l12.24"> }</span>
<a href="#l12.25"></a><span id="l12.25"> </span>
<a href="#l12.26"></a><span id="l12.26"> function openURI(uri)</span>
<a href="#l12.27"></a><span id="l12.27"> {</span>
<a href="#l12.28"></a><span id="l12.28">   if (!mayOpenURI(uri))</span>
<a href="#l12.29"></a><span id="l12.29">     throw Components.results.NS_ERROR_FAILURE;</span>
<a href="#l12.30"></a><span id="l12.30"> </span>
<a href="#l12.31"></a><span id="l12.31" class="difflineminus">-  var io = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineminus">-                     .getService(Components.interfaces.nsIIOService);</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineminus">-  var channel = io.newChannelFromURI(uri);</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+  var channel = Services.io.newChannelFromURI(uri);</span>
<a href="#l12.35"></a><span id="l12.35">   var loader = Components.classes[&quot;@mozilla.org/uriloader;1&quot;]</span>
<a href="#l12.36"></a><span id="l12.36">                          .getService(Components.interfaces.nsIURILoader);</span>
<a href="#l12.37"></a><span id="l12.37"> </span>
<a href="#l12.38"></a><span id="l12.38">   // We cannot load a URI on startup asynchronously without protecting</span>
<a href="#l12.39"></a><span id="l12.39">   // the startup</span>
<a href="#l12.40"></a><span id="l12.40"> </span>
<a href="#l12.41"></a><span id="l12.41">   var loadgroup = Components.classes[&quot;@mozilla.org/network/load-group;1&quot;]</span>
<a href="#l12.42"></a><span id="l12.42">                             .createInstance(Components.interfaces.nsILoadGroup);</span>
<a href="#l12.43"></a><span id="l12.43"> </span>
<a href="#l12.44"></a><span id="l12.44" class="difflineminus">-  var appstartup = Components.classes[&quot;@mozilla.org/toolkit/app-startup;1&quot;]</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineminus">-                             .getService(Components.interfaces.nsIAppStartup);</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineminus">-</span>
<a href="#l12.47"></a><span id="l12.47">   var loadlistener = {</span>
<a href="#l12.48"></a><span id="l12.48">     onStartRequest: function ll_start(aRequest, aContext) {</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineminus">-      appstartup.enterLastWindowClosingSurvivalArea();</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineplus">+      Services.startup.enterLastWindowClosingSurvivalArea();</span>
<a href="#l12.51"></a><span id="l12.51">     },</span>
<a href="#l12.52"></a><span id="l12.52"> </span>
<a href="#l12.53"></a><span id="l12.53">     onStopRequest: function ll_stop(aRequest, aContext, aStatusCode) {</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineminus">-      appstartup.exitLastWindowClosingSurvivalArea();</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineplus">+      Services.startup.exitLastWindowClosingSurvivalArea();</span>
<a href="#l12.56"></a><span id="l12.56">     },</span>
<a href="#l12.57"></a><span id="l12.57"> </span>
<a href="#l12.58"></a><span id="l12.58">     QueryInterface: XPCOMUtils.generateQI([Components.interfaces.nsIRequestObserver,</span>
<a href="#l12.59"></a><span id="l12.59">                                            Components.interfaces.nsISupportsWeakReference])</span>
<a href="#l12.60"></a><span id="l12.60">   };</span>
<a href="#l12.61"></a><span id="l12.61"> </span>
<a href="#l12.62"></a><span id="l12.62">   loadgroup.groupObserver = loadlistener;</span>
<a href="#l12.63"></a><span id="l12.63"> </span>
<a href="#l12.64"></a><span id="l12.64" class="difflineat">@@ -182,44 +175,37 @@ var nsMailDefaultHandler = {</span>
<a href="#l12.65"></a><span id="l12.65">           var xuri = cmdLine.resolveURI(&quot;mailto:&quot; + remoteParams[0]);</span>
<a href="#l12.66"></a><span id="l12.66">           openURI(xuri);</span>
<a href="#l12.67"></a><span id="l12.67">           break;</span>
<a href="#l12.68"></a><span id="l12.68"> </span>
<a href="#l12.69"></a><span id="l12.69">         case &quot;xfedocommand&quot;:</span>
<a href="#l12.70"></a><span id="l12.70">           // xfeDoCommand(openBrowser)</span>
<a href="#l12.71"></a><span id="l12.71">           switch (remoteParams[0].toLowerCase()) {</span>
<a href="#l12.72"></a><span id="l12.72">           case &quot;openinbox&quot;:</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineminus">-            var wm = Components.classes[&quot;@mozilla.org/appshell/window-mediator;1&quot;]</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineminus">-                               .getService(nsIWindowMediator);</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineminus">-            var win = wm.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineplus">+            var win = Services.wm.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l12.77"></a><span id="l12.77">             if (win) {</span>
<a href="#l12.78"></a><span id="l12.78">               win.focus();</span>
<a href="#l12.79"></a><span id="l12.79">             }</span>
<a href="#l12.80"></a><span id="l12.80">             else {</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineminus">-              var wwatch = Components.classes[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineminus">-                                     .getService(nsIWindowWatcher);</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineminus">-</span>
<a href="#l12.84"></a><span id="l12.84">               // Bug 277798 - we have to pass an argument to openWindow(), or</span>
<a href="#l12.85"></a><span id="l12.85">               // else it won't honor the dialog=no instruction.</span>
<a href="#l12.86"></a><span id="l12.86">               var argstring = Components.classes[&quot;@mozilla.org/supports-string;1&quot;]</span>
<a href="#l12.87"></a><span id="l12.87">                                         .createInstance(nsISupportsString);</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineminus">-              wwatch.openWindow(null, &quot;chrome://messenger/content/&quot;, &quot;_blank&quot;,</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineminus">-                                &quot;chrome,dialog=no,all&quot;, argstring);</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineplus">+              Services.ww.openWindow(null, &quot;chrome://messenger/content/&quot;, &quot;_blank&quot;,</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineplus">+                                     &quot;chrome,dialog=no,all&quot;, argstring);</span>
<a href="#l12.92"></a><span id="l12.92">             }</span>
<a href="#l12.93"></a><span id="l12.93">             break;</span>
<a href="#l12.94"></a><span id="l12.94"> </span>
<a href="#l12.95"></a><span id="l12.95">           case &quot;composemessage&quot;:</span>
<a href="#l12.96"></a><span id="l12.96" class="difflineminus">-            var wwatch = Components.classes[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l12.97"></a><span id="l12.97" class="difflineminus">-                                   .getService(nsIWindowWatcher);</span>
<a href="#l12.98"></a><span id="l12.98">             var argstring = Components.classes[&quot;@mozilla.org/supports-string;1&quot;]</span>
<a href="#l12.99"></a><span id="l12.99">                                       .createInstance(nsISupportsString);</span>
<a href="#l12.100"></a><span id="l12.100">             remoteParams.shift();</span>
<a href="#l12.101"></a><span id="l12.101">             argstring.data = remoteParams.join(&quot;,&quot;);</span>
<a href="#l12.102"></a><span id="l12.102" class="difflineminus">-            wwatch.openWindow(null, &quot;chrome://messenger/content/messengercompose/messengercompose.xul&quot;, &quot;_blank&quot;,</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineminus">-                              &quot;chrome,dialog=no,all&quot;, argstring);</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineplus">+            Services.ww.openWindow(null, &quot;chrome://messenger/content/messengercompose/messengercompose.xul&quot;,</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineplus">+                                   &quot;_blank&quot;, &quot;chrome,dialog=no,all&quot;, argstring);</span>
<a href="#l12.106"></a><span id="l12.106">             break;</span>
<a href="#l12.107"></a><span id="l12.107"> </span>
<a href="#l12.108"></a><span id="l12.108">           default:</span>
<a href="#l12.109"></a><span id="l12.109">             throw Components.results.NS_ERROR_ABORT;</span>
<a href="#l12.110"></a><span id="l12.110">           }</span>
<a href="#l12.111"></a><span id="l12.111">           break;</span>
<a href="#l12.112"></a><span id="l12.112"> </span>
<a href="#l12.113"></a><span id="l12.113">         default:</span>
<a href="#l12.114"></a><span id="l12.114" class="difflineat">@@ -238,27 +224,25 @@ var nsMailDefaultHandler = {</span>
<a href="#l12.115"></a><span id="l12.115">         throw Components.results.NS_ERROR_ABORT;</span>
<a href="#l12.116"></a><span id="l12.116">       }</span>
<a href="#l12.117"></a><span id="l12.117">     }</span>
<a href="#l12.118"></a><span id="l12.118"> </span>
<a href="#l12.119"></a><span id="l12.119">     var chromeParam = cmdLine.handleFlagWithParam(&quot;chrome&quot;, false);</span>
<a href="#l12.120"></a><span id="l12.120">     if (chromeParam) {</span>
<a href="#l12.121"></a><span id="l12.121">       try {</span>
<a href="#l12.122"></a><span id="l12.122">         var features = &quot;chrome,dialog=no,all&quot;;</span>
<a href="#l12.123"></a><span id="l12.123" class="difflineminus">-        var wwatch = Components.classes[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l12.124"></a><span id="l12.124" class="difflineminus">-                               .getService(nsIWindowWatcher);</span>
<a href="#l12.125"></a><span id="l12.125">         var argstring = Components.classes[&quot;@mozilla.org/supports-string;1&quot;]</span>
<a href="#l12.126"></a><span id="l12.126">                                   .createInstance(nsISupportsString);</span>
<a href="#l12.127"></a><span id="l12.127">         var uri = resolveURIInternal(cmdLine, chromeParam);</span>
<a href="#l12.128"></a><span id="l12.128">         var netutil = Components.classes[&quot;@mozilla.org/network/util;1&quot;]</span>
<a href="#l12.129"></a><span id="l12.129">                                 .getService(nsINetUtil);</span>
<a href="#l12.130"></a><span id="l12.130">         // only load URIs which do not inherit chrome privs</span>
<a href="#l12.131"></a><span id="l12.131">         if (!netutil.URIChainHasFlags(uri, URI_INHERITS_SECURITY_CONTEXT)) {</span>
<a href="#l12.132"></a><span id="l12.132" class="difflineminus">-          wwatch.openWindow(null, uri.spec, &quot;_blank&quot;,</span>
<a href="#l12.133"></a><span id="l12.133" class="difflineminus">-                            &quot;chrome,dialog=no,all&quot;, argstring);</span>
<a href="#l12.134"></a><span id="l12.134" class="difflineplus">+          Services.ww.openWindow(null, uri.spec, &quot;_blank&quot;,</span>
<a href="#l12.135"></a><span id="l12.135" class="difflineplus">+                                 &quot;chrome,dialog=no,all&quot;, argstring);</span>
<a href="#l12.136"></a><span id="l12.136">           cmdLine.preventDefault = true;</span>
<a href="#l12.137"></a><span id="l12.137">         }</span>
<a href="#l12.138"></a><span id="l12.138">       }</span>
<a href="#l12.139"></a><span id="l12.139">       catch (e) {</span>
<a href="#l12.140"></a><span id="l12.140">         dump(e);</span>
<a href="#l12.141"></a><span id="l12.141">       }</span>
<a href="#l12.142"></a><span id="l12.142">     }</span>
<a href="#l12.143"></a><span id="l12.143"> </span>
<a href="#l12.144"></a><span id="l12.144" class="difflineat">@@ -356,42 +340,36 @@ var nsMailDefaultHandler = {</span>
<a href="#l12.145"></a><span id="l12.145">         if (file.exists() &amp;&amp; file.fileSize &gt; 0) {</span>
<a href="#l12.146"></a><span id="l12.146">           // Get the URL for this file</span>
<a href="#l12.147"></a><span id="l12.147">           let ios = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l12.148"></a><span id="l12.148">                               .getService(Components.interfaces.nsIIOService);</span>
<a href="#l12.149"></a><span id="l12.149">           let fileURL = ios.newFileURI(file)</span>
<a href="#l12.150"></a><span id="l12.150">                            .QueryInterface(Components.interfaces.nsIFileURL);</span>
<a href="#l12.151"></a><span id="l12.151">           fileURL.query = &quot;?type=application/x-message-display&quot;;</span>
<a href="#l12.152"></a><span id="l12.152"> </span>
<a href="#l12.153"></a><span id="l12.153" class="difflineminus">-          let wwatch = Components.classes[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l12.154"></a><span id="l12.154" class="difflineminus">-                                 .getService(nsIWindowWatcher);</span>
<a href="#l12.155"></a><span id="l12.155" class="difflineminus">-          wwatch.openWindow(null,</span>
<a href="#l12.156"></a><span id="l12.156" class="difflineminus">-                            &quot;chrome://messenger/content/messageWindow.xul&quot;,</span>
<a href="#l12.157"></a><span id="l12.157" class="difflineminus">-                            &quot;_blank&quot;, &quot;all,chrome,dialog=no,status,toolbar&quot;,</span>
<a href="#l12.158"></a><span id="l12.158" class="difflineminus">-                            fileURL);</span>
<a href="#l12.159"></a><span id="l12.159" class="difflineplus">+          Services.ww.openWindow(null,</span>
<a href="#l12.160"></a><span id="l12.160" class="difflineplus">+                                 &quot;chrome://messenger/content/messageWindow.xul&quot;,</span>
<a href="#l12.161"></a><span id="l12.161" class="difflineplus">+                                 &quot;_blank&quot;, &quot;all,chrome,dialog=no,status,toolbar&quot;,</span>
<a href="#l12.162"></a><span id="l12.162" class="difflineplus">+                                 fileURL);</span>
<a href="#l12.163"></a><span id="l12.163">           cmdLine.preventDefault = true;</span>
<a href="#l12.164"></a><span id="l12.164">         }</span>
<a href="#l12.165"></a><span id="l12.165">         else {</span>
<a href="#l12.166"></a><span id="l12.166" class="difflineminus">-          let bundle = Components.classes[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l12.167"></a><span id="l12.167" class="difflineminus">-                                 .getService(Components.interfaces.nsIStringBundleService)</span>
<a href="#l12.168"></a><span id="l12.168" class="difflineminus">-                                 .createBundle(&quot;chrome://messenger/locale/messenger.properties&quot;);</span>
<a href="#l12.169"></a><span id="l12.169" class="difflineplus">+          let bundle = Services.strings.createBundle(&quot;chrome://messenger/locale/messenger.properties&quot;);</span>
<a href="#l12.170"></a><span id="l12.170">           let title, message;</span>
<a href="#l12.171"></a><span id="l12.171">           if (!file.exists()) {</span>
<a href="#l12.172"></a><span id="l12.172">             title = bundle.GetStringFromName(&quot;fileNotFoundTitle&quot;);</span>
<a href="#l12.173"></a><span id="l12.173">             message = bundle.formatStringFromName(&quot;fileNotFoundMsg&quot;, [file.path], 1);</span>
<a href="#l12.174"></a><span id="l12.174">           }</span>
<a href="#l12.175"></a><span id="l12.175">           else {</span>
<a href="#l12.176"></a><span id="l12.176">             // The file is empty</span>
<a href="#l12.177"></a><span id="l12.177">             title = bundle.GetStringFromName(&quot;fileEmptyTitle&quot;);</span>
<a href="#l12.178"></a><span id="l12.178">             message = bundle.formatStringFromName(&quot;fileEmptyMsg&quot;, [file.path], 1);</span>
<a href="#l12.179"></a><span id="l12.179">           }</span>
<a href="#l12.180"></a><span id="l12.180"> </span>
<a href="#l12.181"></a><span id="l12.181" class="difflineminus">-          let promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l12.182"></a><span id="l12.182" class="difflineminus">-                                        .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l12.183"></a><span id="l12.183" class="difflineminus">-          promptService.alert(null, title, message);</span>
<a href="#l12.184"></a><span id="l12.184" class="difflineplus">+          Services.prompt.alert(null, title, message);</span>
<a href="#l12.185"></a><span id="l12.185">         }</span>
<a href="#l12.186"></a><span id="l12.186">       }</span>
<a href="#l12.187"></a><span id="l12.187">       else if (/\.vcf$/i.test(uri)) {</span>
<a href="#l12.188"></a><span id="l12.188">         // A VCard! Be smart and open the &quot;add contact&quot; dialog.</span>
<a href="#l12.189"></a><span id="l12.189">         let file = cmdLine.resolveFile(uri);</span>
<a href="#l12.190"></a><span id="l12.190">         if (file.exists() &amp;&amp; file.fileSize &gt; 0) {</span>
<a href="#l12.191"></a><span id="l12.191">           NetUtil.asyncFetch(file, function(inputStream, status) {</span>
<a href="#l12.192"></a><span id="l12.192">             if (!Components.isSuccessCode(status)) {</span>
<a href="#l12.193"></a><span id="l12.193" class="difflineat">@@ -417,20 +395,18 @@ var nsMailDefaultHandler = {</span>
<a href="#l12.194"></a><span id="l12.194">         let msgParams = Components.classes[&quot;@mozilla.org/messengercompose/composeparams;1&quot;]</span>
<a href="#l12.195"></a><span id="l12.195">                                   .createInstance(Components.interfaces.nsIMsgComposeParams);</span>
<a href="#l12.196"></a><span id="l12.196">         let composeFields = Components.classes[&quot;@mozilla.org/messengercompose/composefields;1&quot;]</span>
<a href="#l12.197"></a><span id="l12.197">                                       .createInstance(Components.interfaces.nsIMsgCompFields);</span>
<a href="#l12.198"></a><span id="l12.198">         let attachment = Components.classes[&quot;@mozilla.org/messengercompose/attachment;1&quot;]</span>
<a href="#l12.199"></a><span id="l12.199">                                    .createInstance(Components.interfaces.nsIMsgAttachment);</span>
<a href="#l12.200"></a><span id="l12.200">         let localFile = Components.classes[&quot;@mozilla.org/file/local;1&quot;]</span>
<a href="#l12.201"></a><span id="l12.201">                                   .createInstance(Components.interfaces.nsILocalFile);</span>
<a href="#l12.202"></a><span id="l12.202" class="difflineminus">-        let ioService = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l12.203"></a><span id="l12.203" class="difflineminus">-                                  .getService(Components.interfaces.nsIIOService);</span>
<a href="#l12.204"></a><span id="l12.204" class="difflineminus">-        let fileHandler = ioService.getProtocolHandler(&quot;file&quot;)</span>
<a href="#l12.205"></a><span id="l12.205" class="difflineminus">-                                   .QueryInterface(Components.interfaces.nsIFileProtocolHandler);</span>
<a href="#l12.206"></a><span id="l12.206" class="difflineplus">+        let fileHandler = Services.io.getProtocolHandler(&quot;file&quot;)</span>
<a href="#l12.207"></a><span id="l12.207" class="difflineplus">+                                     .QueryInterface(Components.interfaces.nsIFileProtocolHandler);</span>
<a href="#l12.208"></a><span id="l12.208"> </span>
<a href="#l12.209"></a><span id="l12.209">         try {</span>
<a href="#l12.210"></a><span id="l12.210">           // Unescape the URI so that we work with clients that escape spaces.</span>
<a href="#l12.211"></a><span id="l12.211">           localFile.initWithPath(unescape(uri));</span>
<a href="#l12.212"></a><span id="l12.212">           attachment.url = fileHandler.getURLSpecFromFile(localFile);</span>
<a href="#l12.213"></a><span id="l12.213">           composeFields.addAttachment(attachment);</span>
<a href="#l12.214"></a><span id="l12.214"> </span>
<a href="#l12.215"></a><span id="l12.215">           msgParams.type = Components.interfaces.nsIMsgCompType.New;</span>
<a href="#l12.216"></a><span id="l12.216" class="difflineat">@@ -438,24 +414,21 @@ var nsMailDefaultHandler = {</span>
<a href="#l12.217"></a><span id="l12.217">           msgParams.composeFields = composeFields;</span>
<a href="#l12.218"></a><span id="l12.218"> </span>
<a href="#l12.219"></a><span id="l12.219">           msgComposeService.OpenComposeWindowWithParams(null, msgParams);</span>
<a href="#l12.220"></a><span id="l12.220">         } catch (e) {</span>
<a href="#l12.221"></a><span id="l12.221">           openURI(cmdLine.resolveURI(uri));</span>
<a href="#l12.222"></a><span id="l12.222">         }</span>
<a href="#l12.223"></a><span id="l12.223">       }</span>
<a href="#l12.224"></a><span id="l12.224">     } else {</span>
<a href="#l12.225"></a><span id="l12.225" class="difflineminus">-      var wwatch = Components.classes[&quot;@mozilla.org/embedcomp/window-watcher;1&quot;]</span>
<a href="#l12.226"></a><span id="l12.226" class="difflineminus">-                             .getService(nsIWindowWatcher);</span>
<a href="#l12.227"></a><span id="l12.227" class="difflineminus">-</span>
<a href="#l12.228"></a><span id="l12.228">       var argstring = Components.classes[&quot;@mozilla.org/supports-string;1&quot;]</span>
<a href="#l12.229"></a><span id="l12.229">                                 .createInstance(nsISupportsString);</span>
<a href="#l12.230"></a><span id="l12.230"> </span>
<a href="#l12.231"></a><span id="l12.231" class="difflineminus">-      wwatch.openWindow(null, &quot;chrome://messenger/content/&quot;, &quot;_blank&quot;,</span>
<a href="#l12.232"></a><span id="l12.232" class="difflineminus">-                        &quot;chrome,dialog=no,all&quot;, argstring);</span>
<a href="#l12.233"></a><span id="l12.233" class="difflineplus">+      Services.ww.openWindow(null, &quot;chrome://messenger/content/&quot;, &quot;_blank&quot;,</span>
<a href="#l12.234"></a><span id="l12.234" class="difflineplus">+                             &quot;chrome,dialog=no,all&quot;, argstring);</span>
<a href="#l12.235"></a><span id="l12.235">     }</span>
<a href="#l12.236"></a><span id="l12.236">   },</span>
<a href="#l12.237"></a><span id="l12.237"> </span>
<a href="#l12.238"></a><span id="l12.238">   /* nsICommandLineValidator */</span>
<a href="#l12.239"></a><span id="l12.239">   validate : function mdh_validate(cmdLine) {</span>
<a href="#l12.240"></a><span id="l12.240">     var osintFlagIdx = cmdLine.findFlag(&quot;osint&quot;, false);</span>
<a href="#l12.241"></a><span id="l12.241">     if (osintFlagIdx == -1)</span>
<a href="#l12.242"></a><span id="l12.242">       return;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mail/components/phishing/globalstore.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mail/components/phishing/globalstore.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -13,16 +13,18 @@</span>
<a href="#l13.4"></a><span id="l13.4"> // keyURL: Before we send URLs in enhanced mode, we need to encrypt them</span>
<a href="#l13.5"></a><span id="l13.5"> // reportURL: When shown a warning bubble, we send back the user decision</span>
<a href="#l13.6"></a><span id="l13.6"> //            (get me out of here/ignore warning) to this URL (strip cookies</span>
<a href="#l13.7"></a><span id="l13.7"> //            first).  This is optional.</span>
<a href="#l13.8"></a><span id="l13.8"> // reportGenericURL: HTML page for general user feedback</span>
<a href="#l13.9"></a><span id="l13.9"> // reportPhishURL: HTML page for notifying the provider of a new phishing page</span>
<a href="#l13.10"></a><span id="l13.10"> // reportErrorURL: HTML page for notifying the provider of a false positive</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+</span>
<a href="#l13.14"></a><span id="l13.14"> const kDataProviderIdPref = 'browser.safebrowsing.dataProvider';</span>
<a href="#l13.15"></a><span id="l13.15"> const kProviderBasePref = 'browser.safebrowsing.provider.';</span>
<a href="#l13.16"></a><span id="l13.16"> </span>
<a href="#l13.17"></a><span id="l13.17"> const MOZ_PARAM_LOCALE = /\{moz:locale\}/g;</span>
<a href="#l13.18"></a><span id="l13.18"> const MOZ_PARAM_CLIENT = /\{moz:client\}/g;</span>
<a href="#l13.19"></a><span id="l13.19"> const MOZ_PARAM_BUILDID = /\{moz:buildid\}/g;</span>
<a href="#l13.20"></a><span id="l13.20"> const MOZ_PARAM_VERSION = /\{moz:version\}/g;</span>
<a href="#l13.21"></a><span id="l13.21"> </span>
<a href="#l13.22"></a><span id="l13.22" class="difflineat">@@ -99,27 +101,24 @@ PROT_DataProvider.prototype.updateListMa</span>
<a href="#l13.23"></a><span id="l13.23"> }</span>
<a href="#l13.24"></a><span id="l13.24"> </span>
<a href="#l13.25"></a><span id="l13.25"> /**</span>
<a href="#l13.26"></a><span id="l13.26">  * Lookup the value of a URL from prefs file and do parameter substitution.</span>
<a href="#l13.27"></a><span id="l13.27">  */</span>
<a href="#l13.28"></a><span id="l13.28"> PROT_DataProvider.prototype.getUrlPref_ = function(prefName) {</span>
<a href="#l13.29"></a><span id="l13.29">   var url = this.prefs_.getPref(prefName);</span>
<a href="#l13.30"></a><span id="l13.30"> </span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-  var appInfo = Components.classes[&quot;@mozilla.org/xre/app-info;1&quot;]</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineminus">-                          .getService(Components.interfaces.nsIXULAppInfo);</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">-</span>
<a href="#l13.34"></a><span id="l13.34">   // What value should we use here for Thunderbird??</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineminus">-  var mozClientStr = appInfo.name;</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+  var mozClientStr = Services.appinfo.name;</span>
<a href="#l13.37"></a><span id="l13.37"> </span>
<a href="#l13.38"></a><span id="l13.38">   // Parameter substitution</span>
<a href="#l13.39"></a><span id="l13.39">   url = url.replace(MOZ_PARAM_LOCALE, this.getLocale_());</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineminus">-  url = url.replace(MOZ_PARAM_CLIENT, mozClientStr + appInfo.version);</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineminus">-  url = url.replace(MOZ_PARAM_BUILDID, appInfo.appBuildID);</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineminus">-  url = url.replace(MOZ_PARAM_VERSION, appInfo.platformVersion);</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+  url = url.replace(MOZ_PARAM_CLIENT, mozClientStr + Services.appinfo.version);</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineplus">+  url = url.replace(MOZ_PARAM_BUILDID, Services.appinfo.appBuildID);</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineplus">+  url = url.replace(MOZ_PARAM_VERSION, Services.appinfo.platformVersion);</span>
<a href="#l13.46"></a><span id="l13.46">   return url;</span>
<a href="#l13.47"></a><span id="l13.47"> }</span>
<a href="#l13.48"></a><span id="l13.48"> </span>
<a href="#l13.49"></a><span id="l13.49"> /**</span>
<a href="#l13.50"></a><span id="l13.50">  * @return String the user locale (similar code is in nsSearchService.js)</span>
<a href="#l13.51"></a><span id="l13.51">  */</span>
<a href="#l13.52"></a><span id="l13.52"> PROT_DataProvider.prototype.getLocale_ = function() {</span>
<a href="#l13.53"></a><span id="l13.53">   const localePref = &quot;general.useragent.locale&quot;;</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineat">@@ -133,20 +132,18 @@ PROT_DataProvider.prototype.getLocale_ =</span>
<a href="#l13.55"></a><span id="l13.55"> }</span>
<a href="#l13.56"></a><span id="l13.56"> </span>
<a href="#l13.57"></a><span id="l13.57"> /**</span>
<a href="#l13.58"></a><span id="l13.58">  * @return String name of the localized pref, null if none exists.</span>
<a href="#l13.59"></a><span id="l13.59">  */</span>
<a href="#l13.60"></a><span id="l13.60"> PROT_DataProvider.prototype.getLocalizedPref_ = function(aPrefName) {</span>
<a href="#l13.61"></a><span id="l13.61">   // G_Preferences doesn't know about complex values, so we use the</span>
<a href="#l13.62"></a><span id="l13.62">   // xpcom object directly.</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineminus">-  var prefs = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineminus">-              .getService(Ci.nsIPrefBranch);</span>
<a href="#l13.65"></a><span id="l13.65">   try {</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineminus">-    return prefs.getComplexValue(aPrefName, Ci.nsIPrefLocalizedString).data;</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineplus">+    return Services.prefs.getComplexValue(aPrefName, Ci.nsIPrefLocalizedString).data;</span>
<a href="#l13.68"></a><span id="l13.68">   } catch (ex) {</span>
<a href="#l13.69"></a><span id="l13.69">   }</span>
<a href="#l13.70"></a><span id="l13.70">   return &quot;&quot;;</span>
<a href="#l13.71"></a><span id="l13.71"> }</span>
<a href="#l13.72"></a><span id="l13.72"> </span>
<a href="#l13.73"></a><span id="l13.73"> //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l13.74"></a><span id="l13.74"> // Getters for the remote provider pref values mentioned above.</span>
<a href="#l13.75"></a><span id="l13.75"> PROT_DataProvider.prototype.getName = function() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mail/components/search/SpotlightIntegration.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mail/components/search/SpotlightIntegration.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -2,16 +2,18 @@</span>
<a href="#l14.4"></a><span id="l14.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l14.5"></a><span id="l14.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l14.6"></a><span id="l14.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l14.7"></a><span id="l14.7"> </span>
<a href="#l14.8"></a><span id="l14.8"> #include content/searchCommon.js</span>
<a href="#l14.9"></a><span id="l14.9"> </span>
<a href="#l14.10"></a><span id="l14.10"> var EXPORTED_SYMBOLS = [&quot;SearchIntegration&quot;];</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+</span>
<a href="#l14.14"></a><span id="l14.14"> const MSG_DB_LARGE_COMMIT = 1;</span>
<a href="#l14.15"></a><span id="l14.15"> const gFileHeader = &quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;UTF-8\&quot;?&gt;\n&lt;!DOCTYPE plist PUBLIC \&quot;-//Apple Computer//DTD PLIST 1.0//EN\&quot; \&quot;http://www.apple.\ncom/DTDs/PropertyList-1.0.dtd\&quot;&gt;\n&lt;plist version=\&quot;1.0\&quot;&gt;\n&lt;dict&gt;&quot;;</span>
<a href="#l14.16"></a><span id="l14.16"> </span>
<a href="#l14.17"></a><span id="l14.17"> let SearchIntegration =</span>
<a href="#l14.18"></a><span id="l14.18"> {</span>
<a href="#l14.19"></a><span id="l14.19">   __proto__: SearchSupport,</span>
<a href="#l14.20"></a><span id="l14.20"> </span>
<a href="#l14.21"></a><span id="l14.21">   /// The property of the header and (sometimes) folders that's used to check</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineat">@@ -23,27 +25,23 @@ let SearchIntegration =</span>
<a href="#l14.23"></a><span id="l14.23"> </span>
<a href="#l14.24"></a><span id="l14.24">   /// The Spotlight pref base</span>
<a href="#l14.25"></a><span id="l14.25">   _prefBase: &quot;mail.spotlight.&quot;,</span>
<a href="#l14.26"></a><span id="l14.26"> </span>
<a href="#l14.27"></a><span id="l14.27">   /// The user's profile dir, which we'll cache and use a lot for path clean-up</span>
<a href="#l14.28"></a><span id="l14.28">   get _profileDir()</span>
<a href="#l14.29"></a><span id="l14.29">   {</span>
<a href="#l14.30"></a><span id="l14.30">     delete this._profileDir;</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-    return this._profileDir = Cc[&quot;@mozilla.org/file/directory_service;1&quot;]</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineminus">-                                .getService(Ci.nsIProperties)</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineminus">-                                .get(&quot;ProfD&quot;, Ci.nsIFile);</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+    return this._profileDir = Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsIFile);</span>
<a href="#l14.35"></a><span id="l14.35">   },</span>
<a href="#l14.36"></a><span id="l14.36"> </span>
<a href="#l14.37"></a><span id="l14.37">   get _metadataDir()</span>
<a href="#l14.38"></a><span id="l14.38">   {</span>
<a href="#l14.39"></a><span id="l14.39">     delete this._metadataDir;</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineminus">-    let metadataDir = Cc[&quot;@mozilla.org/file/directory_service;1&quot;]</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineminus">-                        .getService(Ci.nsIProperties)</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineminus">-                        .get(&quot;Home&quot;, Ci.nsIFile);</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineplus">+    let metadataDir = Services.dirsvc.get(&quot;Home&quot;, Ci.nsIFile);</span>
<a href="#l14.44"></a><span id="l14.44">     metadataDir.append(&quot;Library&quot;);</span>
<a href="#l14.45"></a><span id="l14.45">     metadataDir.append(&quot;Caches&quot;);</span>
<a href="#l14.46"></a><span id="l14.46">     metadataDir.append(&quot;Metadata&quot;);</span>
<a href="#l14.47"></a><span id="l14.47">     metadataDir.append(&quot;Thunderbird&quot;);</span>
<a href="#l14.48"></a><span id="l14.48">     return this._metadataDir = metadataDir;</span>
<a href="#l14.49"></a><span id="l14.49">   },</span>
<a href="#l14.50"></a><span id="l14.50"> </span>
<a href="#l14.51"></a><span id="l14.51">   /// Spotlight won't index files in the profile dir, but will use ~/Library/Caches/Metadata</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mail/components/search/WinSearchIntegration.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mail/components/search/WinSearchIntegration.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -2,16 +2,18 @@</span>
<a href="#l15.4"></a><span id="l15.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l15.5"></a><span id="l15.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l15.6"></a><span id="l15.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l15.7"></a><span id="l15.7"> </span>
<a href="#l15.8"></a><span id="l15.8"> #include content/searchCommon.js</span>
<a href="#l15.9"></a><span id="l15.9"> </span>
<a href="#l15.10"></a><span id="l15.10"> var EXPORTED_SYMBOLS = [&quot;SearchIntegration&quot;];</span>
<a href="#l15.11"></a><span id="l15.11"> </span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+</span>
<a href="#l15.14"></a><span id="l15.14"> const MSG_DB_LARGE_COMMIT = 1;</span>
<a href="#l15.15"></a><span id="l15.15"> const CRLF=&quot;\r\n&quot;;</span>
<a href="#l15.16"></a><span id="l15.16"> </span>
<a href="#l15.17"></a><span id="l15.17"> /**</span>
<a href="#l15.18"></a><span id="l15.18">  * Required to access the 64-bit registry, even though we're probably a 32-bit</span>
<a href="#l15.19"></a><span id="l15.19">  * program</span>
<a href="#l15.20"></a><span id="l15.20">  */</span>
<a href="#l15.21"></a><span id="l15.21"> const ACCESS_WOW64_64KEY = 0x0100;</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineat">@@ -150,19 +152,17 @@ let SearchIntegration =</span>
<a href="#l15.23"></a><span id="l15.23">     // support. Mark ourselves null and return</span>
<a href="#l15.24"></a><span id="l15.24">     if (!(WINSEARCHHELPER_CONTRACTID in Cc))</span>
<a href="#l15.25"></a><span id="l15.25">     {</span>
<a href="#l15.26"></a><span id="l15.26">       SearchIntegration = null;</span>
<a href="#l15.27"></a><span id="l15.27">       return;</span>
<a href="#l15.28"></a><span id="l15.28">     }</span>
<a href="#l15.29"></a><span id="l15.29"> </span>
<a href="#l15.30"></a><span id="l15.30">     // We're currently only enabled on Vista and above</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineminus">-    let sysInfo = Cc[&quot;@mozilla.org/system-info;1&quot;]</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineminus">-                    .getService(Ci.nsIPropertyBag2);</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineminus">-    let windowsVersion = sysInfo.getProperty(&quot;version&quot;);</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineplus">+    let windowsVersion = Services.sysinfo.getProperty(&quot;version&quot;);</span>
<a href="#l15.35"></a><span id="l15.35">     if (parseFloat(windowsVersion) &lt; 6)</span>
<a href="#l15.36"></a><span id="l15.36">     {</span>
<a href="#l15.37"></a><span id="l15.37">       this._log.fatal(&quot;Windows version &quot; + windowsVersion + &quot; &lt; 6.0&quot;);</span>
<a href="#l15.38"></a><span id="l15.38">       this.osVersionTooLow = true;</span>
<a href="#l15.39"></a><span id="l15.39">       return;</span>
<a href="#l15.40"></a><span id="l15.40">     }</span>
<a href="#l15.41"></a><span id="l15.41"> </span>
<a href="#l15.42"></a><span id="l15.42">     let serviceRunning = false;</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineat">@@ -206,18 +206,17 @@ let SearchIntegration =</span>
<a href="#l15.44"></a><span id="l15.44">     if (!this._winSearchHelper.isFileAssociationSet)</span>
<a href="#l15.45"></a><span id="l15.45">     {</span>
<a href="#l15.46"></a><span id="l15.46">       try {</span>
<a href="#l15.47"></a><span id="l15.47">         this._winSearchHelper.setFileAssociation();</span>
<a href="#l15.48"></a><span id="l15.48">       }</span>
<a href="#l15.49"></a><span id="l15.49">       catch (e) { this._log.warn(&quot;File association not set&quot;); }</span>
<a href="#l15.50"></a><span id="l15.50">     }</span>
<a href="#l15.51"></a><span id="l15.51">     // Also set the FANCI bit to 0 for the profile directory</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineminus">-    let profD = Cc[&quot;@mozilla.org/file/directory_service;1&quot;]</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineminus">-                  .getService(Ci.nsIProperties).get(&quot;ProfD&quot;, Ci.nsIFile);</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineplus">+    let profD = Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsIFile);</span>
<a href="#l15.55"></a><span id="l15.55">     this._winSearchHelper.setFANCIBit(profD, false, true);</span>
<a href="#l15.56"></a><span id="l15.56"> </span>
<a href="#l15.57"></a><span id="l15.57">     return true;</span>
<a href="#l15.58"></a><span id="l15.58">   },</span>
<a href="#l15.59"></a><span id="l15.59"> </span>
<a href="#l15.60"></a><span id="l15.60">   /**</span>
<a href="#l15.61"></a><span id="l15.61">    * Remove integration from Windows. The only thing removed is the directory</span>
<a href="#l15.62"></a><span id="l15.62">    * from the index list. This will ask for elevation.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mail/components/search/content/searchCommon.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mail/components/search/content/searchCommon.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -18,16 +18,17 @@</span>
<a href="#l16.4"></a><span id="l16.4"> </span>
<a href="#l16.5"></a><span id="l16.5"> const Cc = Components.classes;</span>
<a href="#l16.6"></a><span id="l16.6"> const Ci = Components.interfaces;</span>
<a href="#l16.7"></a><span id="l16.7"> const Cu = Components.utils;</span>
<a href="#l16.8"></a><span id="l16.8"> </span>
<a href="#l16.9"></a><span id="l16.9"> Cu.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l16.10"></a><span id="l16.10"> Cu.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l16.11"></a><span id="l16.11"> Cu.import(&quot;resource:///modules/MailUtils.js&quot;);</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+Cu.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l16.13"></a><span id="l16.13"> </span>
<a href="#l16.14"></a><span id="l16.14"> const PERM_DIRECTORY = parseInt(&quot;0755&quot;, 8);</span>
<a href="#l16.15"></a><span id="l16.15"> const PERM_FILE = parseInt(&quot;0644&quot;, 8);</span>
<a href="#l16.16"></a><span id="l16.16"> </span>
<a href="#l16.17"></a><span id="l16.17"> let SearchSupport =</span>
<a href="#l16.18"></a><span id="l16.18"> {</span>
<a href="#l16.19"></a><span id="l16.19">   /**</span>
<a href="#l16.20"></a><span id="l16.20">    * URI of last folder indexed. Kept in sync with the pref</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineat">@@ -69,19 +70,17 @@ let SearchSupport =</span>
<a href="#l16.22"></a><span id="l16.22">     return this.__messenger;</span>
<a href="#l16.23"></a><span id="l16.23">   },</span>
<a href="#l16.24"></a><span id="l16.24"> </span>
<a href="#l16.25"></a><span id="l16.25">   /// The preferences branch to use</span>
<a href="#l16.26"></a><span id="l16.26">   __prefBranch: null,</span>
<a href="#l16.27"></a><span id="l16.27">   get _prefBranch()</span>
<a href="#l16.28"></a><span id="l16.28">   {</span>
<a href="#l16.29"></a><span id="l16.29">     if (!this.__prefBranch)</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineminus">-      this.__prefBranch = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineminus">-                            .getService(Ci.nsIPrefService)</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineminus">-                            .getBranch(this._prefBase);</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineplus">+      this.__prefBranch = Services.prefs.getBranch(this._prefBase);</span>
<a href="#l16.34"></a><span id="l16.34">     return this.__prefBranch;</span>
<a href="#l16.35"></a><span id="l16.35">   },</span>
<a href="#l16.36"></a><span id="l16.36"> </span>
<a href="#l16.37"></a><span id="l16.37">   /**</span>
<a href="#l16.38"></a><span id="l16.38">    * If this is true, we won't show any UI because the OS doesn't have the</span>
<a href="#l16.39"></a><span id="l16.39">    * support we need</span>
<a href="#l16.40"></a><span id="l16.40">    */</span>
<a href="#l16.41"></a><span id="l16.41">   osVersionTooLow: false,</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineat">@@ -211,19 +210,17 @@ let SearchSupport =</span>
<a href="#l16.43"></a><span id="l16.43">         notificationService.msgsDeleted |</span>
<a href="#l16.44"></a><span id="l16.44">         notificationService.msgsMoveCopyCompleted |</span>
<a href="#l16.45"></a><span id="l16.45">         // this code pre-dates msgsClassified</span>
<a href="#l16.46"></a><span id="l16.46">         // folderAdded intentionally omitted</span>
<a href="#l16.47"></a><span id="l16.47">         notificationService.folderDeleted |</span>
<a href="#l16.48"></a><span id="l16.48">         notificationService.folderMoveCopyCompleted |</span>
<a href="#l16.49"></a><span id="l16.49">         notificationService.folderRenamed);</span>
<a href="#l16.50"></a><span id="l16.50">         // itemEvent intentionally omitted</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineminus">-      let observerService = Cc[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineminus">-                              .getService(Ci.nsIObserverService);</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineminus">-      observerService.addObserver(this, &quot;MsgMsgDisplayed&quot;, false);</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineplus">+      Services.obs.addObserver(this, &quot;MsgMsgDisplayed&quot;, false);</span>
<a href="#l16.55"></a><span id="l16.55">       let idleService = Cc[&quot;@mozilla.org/widget/idleservice;1&quot;]</span>
<a href="#l16.56"></a><span id="l16.56">                           .getService(Ci.nsIIdleService);</span>
<a href="#l16.57"></a><span id="l16.57">       idleService.addIdleObserver(this, this._idleThresholdSecs);</span>
<a href="#l16.58"></a><span id="l16.58">     }</span>
<a href="#l16.59"></a><span id="l16.59">     else</span>
<a href="#l16.60"></a><span id="l16.60">       // We want to observe moves, deletes and renames in case we're disabled</span>
<a href="#l16.61"></a><span id="l16.61">       // If we don't, we'll have no idea the support files exist later</span>
<a href="#l16.62"></a><span id="l16.62">       notificationService.addListener(this._msgFolderListener,</span>
<a href="#l16.63"></a><span id="l16.63" class="difflineat">@@ -251,19 +248,17 @@ let SearchSupport =</span>
<a href="#l16.64"></a><span id="l16.64"> </span>
<a href="#l16.65"></a><span id="l16.65">     let notificationService =</span>
<a href="#l16.66"></a><span id="l16.66">       Cc[&quot;@mozilla.org/messenger/msgnotificationservice;1&quot;]</span>
<a href="#l16.67"></a><span id="l16.67">         .getService(Ci.nsIMsgFolderNotificationService);</span>
<a href="#l16.68"></a><span id="l16.68">     notificationService.removeListener(this._msgFolderListener);</span>
<a href="#l16.69"></a><span id="l16.69"> </span>
<a href="#l16.70"></a><span id="l16.70">     if (this.enabled)</span>
<a href="#l16.71"></a><span id="l16.71">     {</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineminus">-      let observerService = Cc[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l16.73"></a><span id="l16.73" class="difflineminus">-                              .getService(Ci.nsIObserverService);</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineminus">-      observerService.removeObserver(this, &quot;MsgMsgDisplayed&quot;, false);</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineplus">+      Services.obs.removeObserver(this, &quot;MsgMsgDisplayed&quot;, false);</span>
<a href="#l16.76"></a><span id="l16.76">       let idleService = Cc[&quot;@mozilla.org/widget/idleservice;1&quot;]</span>
<a href="#l16.77"></a><span id="l16.77">                           .getService(Ci.nsIIdleService);</span>
<a href="#l16.78"></a><span id="l16.78">       idleService.removeIdleObserver(this, this._idleThresholdSecs);</span>
<a href="#l16.79"></a><span id="l16.79"> </span>
<a href="#l16.80"></a><span id="l16.80">       // in case there's a background sweep going on</span>
<a href="#l16.81"></a><span id="l16.81">       this._cancelTimer();</span>
<a href="#l16.82"></a><span id="l16.82">     }</span>
<a href="#l16.83"></a><span id="l16.83">     // We don't need to do anything extra if we're disabled</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mail/extensions/smime/content/msgCompSMIMEOverlay.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mail/extensions/smime/content/msgCompSMIMEOverlay.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -1,13 +1,15 @@</span>
<a href="#l17.4"></a><span id="l17.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l17.5"></a><span id="l17.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l17.6"></a><span id="l17.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l17.7"></a><span id="l17.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l17.8"></a><span id="l17.8"> </span>
<a href="#l17.9"></a><span id="l17.9" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l17.10"></a><span id="l17.10" class="difflineplus">+</span>
<a href="#l17.11"></a><span id="l17.11"> // Account encryption policy values:</span>
<a href="#l17.12"></a><span id="l17.12"> // const kEncryptionPolicy_Never = 0;</span>
<a href="#l17.13"></a><span id="l17.13"> // 'IfPossible' was used by ns4.</span>
<a href="#l17.14"></a><span id="l17.14"> // const kEncryptionPolicy_IfPossible = 1;</span>
<a href="#l17.15"></a><span id="l17.15"> const kEncryptionPolicy_Always = 2;</span>
<a href="#l17.16"></a><span id="l17.16"> </span>
<a href="#l17.17"></a><span id="l17.17"> var gEncryptedURIService =</span>
<a href="#l17.18"></a><span id="l17.18">         Components.classes[&quot;@mozilla.org/messenger-smime/smime-encrypted-uris-service;1&quot;]</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineat">@@ -114,25 +116,21 @@ function GetServer(uri)</span>
<a href="#l17.20"></a><span id="l17.20"> </span>
<a href="#l17.21"></a><span id="l17.21"> function showNeedSetupInfo()</span>
<a href="#l17.22"></a><span id="l17.22"> {</span>
<a href="#l17.23"></a><span id="l17.23">   let compSmimeBundle = document.getElementById(&quot;bundle_comp_smime&quot;);</span>
<a href="#l17.24"></a><span id="l17.24">   let brandBundle = document.getElementById(&quot;bundle_brand&quot;);</span>
<a href="#l17.25"></a><span id="l17.25">   if (!compSmimeBundle || !brandBundle)</span>
<a href="#l17.26"></a><span id="l17.26">     return;</span>
<a href="#l17.27"></a><span id="l17.27"> </span>
<a href="#l17.28"></a><span id="l17.28" class="difflineminus">-  var ifps = Components.interfaces.nsIPromptService;</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineminus">-  let promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineminus">-                                .getService(ifps);</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineminus">-</span>
<a href="#l17.32"></a><span id="l17.32">   let buttonPressed =</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineminus">-    promptService.confirmEx(window,</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineminus">-                            brandBundle.getString(&quot;brandShortName&quot;),</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineminus">-                            compSmimeBundle.getString(&quot;NeedSetup&quot;),</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineminus">-                            ifps.STD_YES_NO_BUTTONS, 0, 0, 0, null, {});</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineplus">+    Services.prompt.confirmEx(window,</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineplus">+                              brandBundle.getString(&quot;brandShortName&quot;),</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineplus">+                              compSmimeBundle.getString(&quot;NeedSetup&quot;),</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineplus">+                              Services.prompt.STD_YES_NO_BUTTONS, 0, 0, 0, null, {});</span>
<a href="#l17.41"></a><span id="l17.41">   if (buttonPressed == 0)</span>
<a href="#l17.42"></a><span id="l17.42">     MsgAccountManager(&quot;am-smime.xul&quot;);</span>
<a href="#l17.43"></a><span id="l17.43"> }</span>
<a href="#l17.44"></a><span id="l17.44"> </span>
<a href="#l17.45"></a><span id="l17.45"> function toggleEncryptMessage()</span>
<a href="#l17.46"></a><span id="l17.46"> {</span>
<a href="#l17.47"></a><span id="l17.47">   if (!gSMFields)</span>
<a href="#l17.48"></a><span id="l17.48">     return;</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineat">@@ -325,21 +323,19 @@ function onComposerSendMessage()</span>
<a href="#l17.50"></a><span id="l17.50">     // Does the current identity override the global preference?</span>
<a href="#l17.51"></a><span id="l17.51">     if (gCurrentIdentity.overrideGlobalPref)</span>
<a href="#l17.52"></a><span id="l17.52">     {</span>
<a href="#l17.53"></a><span id="l17.53">       autocompleteDirectory = gCurrentIdentity.directoryServer;</span>
<a href="#l17.54"></a><span id="l17.54">     }</span>
<a href="#l17.55"></a><span id="l17.55">     else</span>
<a href="#l17.56"></a><span id="l17.56">     {</span>
<a href="#l17.57"></a><span id="l17.57">       // Try the global one</span>
<a href="#l17.58"></a><span id="l17.58" class="difflineminus">-      var prefs = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l17.59"></a><span id="l17.59" class="difflineminus">-                            .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineminus">-      if (prefs.getBoolPref(&quot;ldap_2.autoComplete.useDirectory&quot;))</span>
<a href="#l17.61"></a><span id="l17.61" class="difflineplus">+      if (Services.prefs.getBoolPref(&quot;ldap_2.autoComplete.useDirectory&quot;))</span>
<a href="#l17.62"></a><span id="l17.62">         autocompleteDirectory =</span>
<a href="#l17.63"></a><span id="l17.63" class="difflineminus">-          prefs.getCharPref(&quot;ldap_2.autoComplete.directoryServer&quot;);</span>
<a href="#l17.64"></a><span id="l17.64" class="difflineplus">+          Services.prefs.getCharPref(&quot;ldap_2.autoComplete.directoryServer&quot;);</span>
<a href="#l17.65"></a><span id="l17.65">     }</span>
<a href="#l17.66"></a><span id="l17.66"> </span>
<a href="#l17.67"></a><span id="l17.67">     if (autocompleteDirectory)</span>
<a href="#l17.68"></a><span id="l17.68">       window.openDialog(&quot;chrome://messenger-smime/content/certFetchingStatus.xul&quot;,</span>
<a href="#l17.69"></a><span id="l17.69">                         &quot;&quot;,</span>
<a href="#l17.70"></a><span id="l17.70">                         &quot;chrome,modal,resizable,centerscreen&quot;,</span>
<a href="#l17.71"></a><span id="l17.71">                         autocompleteDirectory,</span>
<a href="#l17.72"></a><span id="l17.72">                         emailAddresses.value);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPAutoCompleteSearch.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPAutoCompleteSearch.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -1,13 +1,14 @@</span>
<a href="#l18.4"></a><span id="l18.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l18.5"></a><span id="l18.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l18.6"></a><span id="l18.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l18.7"></a><span id="l18.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l18.8"></a><span id="l18.8"> </span>
<a href="#l18.9"></a><span id="l18.9" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l18.10"></a><span id="l18.10"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l18.11"></a><span id="l18.11"> </span>
<a href="#l18.12"></a><span id="l18.12"> const ACR = Components.interfaces.nsIAutoCompleteResult;</span>
<a href="#l18.13"></a><span id="l18.13"> const nsIAbAutoCompleteResult = Components.interfaces.nsIAbAutoCompleteResult;</span>
<a href="#l18.14"></a><span id="l18.14"> const nsIAbDirectoryQueryResultListener =</span>
<a href="#l18.15"></a><span id="l18.15">   Components.interfaces.nsIAbDirectoryQueryResultListener;</span>
<a href="#l18.16"></a><span id="l18.16"> </span>
<a href="#l18.17"></a><span id="l18.17"> // nsAbLDAPAutoCompleteResult</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineat">@@ -67,19 +68,17 @@ nsAbLDAPAutoCompleteResult.prototype = {</span>
<a href="#l18.19"></a><span id="l18.19">   },</span>
<a href="#l18.20"></a><span id="l18.20"> </span>
<a href="#l18.21"></a><span id="l18.21">   // nsISupports</span>
<a href="#l18.22"></a><span id="l18.22"> </span>
<a href="#l18.23"></a><span id="l18.23">   QueryInterface: XPCOMUtils.generateQI([ACR, nsIAbAutoCompleteResult])</span>
<a href="#l18.24"></a><span id="l18.24"> }</span>
<a href="#l18.25"></a><span id="l18.25"> </span>
<a href="#l18.26"></a><span id="l18.26"> function nsAbLDAPAutoCompleteSearch() {</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineminus">-  Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineminus">-            .getService(Components.interfaces.nsIObserverService)</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineminus">-            .addObserver(this, &quot;quit-application&quot;, false);</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineplus">+  Services.obs.addObserver(this, &quot;quit-application&quot;, false);</span>
<a href="#l18.31"></a><span id="l18.31"> }</span>
<a href="#l18.32"></a><span id="l18.32"> </span>
<a href="#l18.33"></a><span id="l18.33"> nsAbLDAPAutoCompleteSearch.prototype = {</span>
<a href="#l18.34"></a><span id="l18.34">   // For component registration</span>
<a href="#l18.35"></a><span id="l18.35">   classID: Components.ID(&quot;227e6482-fe9f-441f-9b7d-7b60375e7449&quot;),</span>
<a href="#l18.36"></a><span id="l18.36"> </span>
<a href="#l18.37"></a><span id="l18.37">   // A cache of Address Books, directories and search contexts.</span>
<a href="#l18.38"></a><span id="l18.38">   // The cache is indexed by the address book URI. Each item in the cache</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineat">@@ -157,19 +156,17 @@ nsAbLDAPAutoCompleteSearch.prototype = {</span>
<a href="#l18.40"></a><span id="l18.40">       // Force the individual query items to null, so that the memory</span>
<a href="#l18.41"></a><span id="l18.41">       // gets collected straight away.</span>
<a href="#l18.42"></a><span id="l18.42">       for (var item in this._cachedQueries) {</span>
<a href="#l18.43"></a><span id="l18.43">         this._cachedQueries[item].query = null;</span>
<a href="#l18.44"></a><span id="l18.44">         this._cachedQueries[item].book = null;</span>
<a href="#l18.45"></a><span id="l18.45">         this._cachedQueries[item].attributes = null;</span>
<a href="#l18.46"></a><span id="l18.46">       }</span>
<a href="#l18.47"></a><span id="l18.47">       this._cachedQueries = {};</span>
<a href="#l18.48"></a><span id="l18.48" class="difflineminus">-      Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineminus">-                .getService(Components.interfaces.nsIObserverService)</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineminus">-                .removeObserver(this, &quot;quit-application&quot;);</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineplus">+      Services.obs.removeObserver(this, &quot;quit-application&quot;);</span>
<a href="#l18.52"></a><span id="l18.52">     }</span>
<a href="#l18.53"></a><span id="l18.53">   },</span>
<a href="#l18.54"></a><span id="l18.54"> </span>
<a href="#l18.55"></a><span id="l18.55">   // nsIAutoCompleteSearch</span>
<a href="#l18.56"></a><span id="l18.56"> </span>
<a href="#l18.57"></a><span id="l18.57">   startSearch: function startSearch(aSearchString, aParam,</span>
<a href="#l18.58"></a><span id="l18.58">                                     aPreviousResult, aListener) {</span>
<a href="#l18.59"></a><span id="l18.59">     this._result = new nsAbLDAPAutoCompleteResult(aSearchString);</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineat">@@ -232,20 +229,18 @@ nsAbLDAPAutoCompleteSearch.prototype = {</span>
<a href="#l18.61"></a><span id="l18.61">     // use that, otherwise, try the global preference instead.</span>
<a href="#l18.62"></a><span id="l18.62">     var acDirURI = null;</span>
<a href="#l18.63"></a><span id="l18.63"> </span>
<a href="#l18.64"></a><span id="l18.64">     // Does the current identity override the global preference?</span>
<a href="#l18.65"></a><span id="l18.65">     if (this._cachedIdentity.overrideGlobalPref)</span>
<a href="#l18.66"></a><span id="l18.66">       acDirURI = this._cachedIdentity.directoryServer;</span>
<a href="#l18.67"></a><span id="l18.67">     else {</span>
<a href="#l18.68"></a><span id="l18.68">       // Try the global one</span>
<a href="#l18.69"></a><span id="l18.69" class="difflineminus">-      var prefSvc = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l18.70"></a><span id="l18.70" class="difflineminus">-                              .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l18.71"></a><span id="l18.71" class="difflineminus">-      if (prefSvc.getBoolPref(&quot;ldap_2.autoComplete.useDirectory&quot;))</span>
<a href="#l18.72"></a><span id="l18.72" class="difflineminus">-        acDirURI = prefSvc.getCharPref(&quot;ldap_2.autoComplete.directoryServer&quot;);</span>
<a href="#l18.73"></a><span id="l18.73" class="difflineplus">+      if (Services.prefs.getBoolPref(&quot;ldap_2.autoComplete.useDirectory&quot;))</span>
<a href="#l18.74"></a><span id="l18.74" class="difflineplus">+        acDirURI = Services.prefs.getCharPref(&quot;ldap_2.autoComplete.directoryServer&quot;);</span>
<a href="#l18.75"></a><span id="l18.75">     }</span>
<a href="#l18.76"></a><span id="l18.76"> </span>
<a href="#l18.77"></a><span id="l18.77">     if (!acDirURI) {</span>
<a href="#l18.78"></a><span id="l18.78">       // No directory to search, send a no match and return.</span>
<a href="#l18.79"></a><span id="l18.79">       aListener.onSearchResult(this, this._result);</span>
<a href="#l18.80"></a><span id="l18.80">       return;</span>
<a href="#l18.81"></a><span id="l18.81">     }</span>
<a href="#l18.82"></a><span id="l18.82"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/base/content/folderProps.xul</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/base/content/folderProps.xul</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -19,18 +19,18 @@</span>
<a href="#l19.4"></a><span id="l19.4">   ondialogaccept=&quot;return folderPropsOKButton();&quot;&gt;</span>
<a href="#l19.5"></a><span id="l19.5"> </span>
<a href="#l19.6"></a><span id="l19.6">   &lt;stringbundle id=&quot;bundle_messenger&quot; src=&quot;chrome://messenger/locale/messenger.properties&quot;/&gt;</span>
<a href="#l19.7"></a><span id="l19.7">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://global/content/globalOverlay.js&quot;/&gt;</span>
<a href="#l19.8"></a><span id="l19.8">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/retention.js&quot;/&gt;</span>
<a href="#l19.9"></a><span id="l19.9">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/folderProps.js&quot;/&gt;</span>
<a href="#l19.10"></a><span id="l19.10">   &lt;script type=&quot;application/javascript&quot;&gt;</span>
<a href="#l19.11"></a><span id="l19.11">   &lt;![CDATA[</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-    var observerService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;].getService(Components.interfaces.nsIObserverService);</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-    observerService.notifyObservers(null, &quot;charsetmenu-selected&quot;, &quot;other&quot;);</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineplus">+    Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineplus">+    Services.obs.notifyObservers(null, &quot;charsetmenu-selected&quot;, &quot;other&quot;);</span>
<a href="#l19.16"></a><span id="l19.16">   ]]&gt;</span>
<a href="#l19.17"></a><span id="l19.17">   &lt;/script&gt;</span>
<a href="#l19.18"></a><span id="l19.18"> </span>
<a href="#l19.19"></a><span id="l19.19"> &lt;tabbox id=&quot;folderPropTabBox&quot;&gt;</span>
<a href="#l19.20"></a><span id="l19.20">   &lt;tabs id=&quot;folderPropTabs&quot;&gt;</span>
<a href="#l19.21"></a><span id="l19.21">     &lt;tab id=&quot;GeneralTab&quot; label=&quot;&amp;generalInfo.label;&quot;/&gt;</span>
<a href="#l19.22"></a><span id="l19.22">     &lt;tab id=&quot;Retention&quot; label=&quot;&amp;retention.label;&quot;/&gt;</span>
<a href="#l19.23"></a><span id="l19.23">     &lt;tab id=&quot;SynchronizationTab&quot; hidefor=&quot;movemail,pop3,rss,none&quot; label=&quot;&amp;folderSynchronizationTab.label;&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgTraitService.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgTraitService.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -1,22 +1,21 @@</span>
<a href="#l20.4"></a><span id="l20.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l20.5"></a><span id="l20.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l20.6"></a><span id="l20.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l20.7"></a><span id="l20.7"> </span>
<a href="#l20.8"></a><span id="l20.8" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l20.9"></a><span id="l20.9"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l20.10"></a><span id="l20.10"> </span>
<a href="#l20.11"></a><span id="l20.11"> // local static variables</span>
<a href="#l20.12"></a><span id="l20.12"> </span>
<a href="#l20.13"></a><span id="l20.13"> var _lastIndex = 0;  // the first index will be one</span>
<a href="#l20.14"></a><span id="l20.14"> var _traits = {};</span>
<a href="#l20.15"></a><span id="l20.15"> </span>
<a href="#l20.16"></a><span id="l20.16" class="difflineminus">-var prefs = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineminus">-                      .getService(Components.interfaces.nsIPrefService);</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineminus">-var traitsBranch = prefs.getBranch(&quot;mailnews.traits.&quot;);</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineplus">+var traitsBranch = Services.prefs.getBranch(&quot;mailnews.traits.&quot;);</span>
<a href="#l20.20"></a><span id="l20.20"> </span>
<a href="#l20.21"></a><span id="l20.21"> function _registerTrait(aId, aIndex)</span>
<a href="#l20.22"></a><span id="l20.22"> {</span>
<a href="#l20.23"></a><span id="l20.23">   var trait = {};</span>
<a href="#l20.24"></a><span id="l20.24">   trait.enabled = false;</span>
<a href="#l20.25"></a><span id="l20.25">   trait.name = &quot;&quot;;</span>
<a href="#l20.26"></a><span id="l20.26">   trait.antiId = &quot;&quot;;</span>
<a href="#l20.27"></a><span id="l20.27">   trait.index = aIndex;</span>
<a href="#l20.28"></a><span id="l20.28" class="difflineat">@@ -193,21 +192,21 @@ nsMsgTraitService.prototype =</span>
<a href="#l20.29"></a><span id="l20.29"> </span>
<a href="#l20.30"></a><span id="l20.30"> // initialization</span>
<a href="#l20.31"></a><span id="l20.31"> </span>
<a href="#l20.32"></a><span id="l20.32"> _init();</span>
<a href="#l20.33"></a><span id="l20.33"> </span>
<a href="#l20.34"></a><span id="l20.34"> function _init()</span>
<a href="#l20.35"></a><span id="l20.35"> {</span>
<a href="#l20.36"></a><span id="l20.36">   // get existing traits</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineminus">-  var idBranch = prefs.getBranch(&quot;mailnews.traits.id.&quot;);</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineminus">-  var nameBranch = prefs.getBranch(&quot;mailnews.traits.name.&quot;);</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineminus">-  var enabledBranch = prefs.getBranch(&quot;mailnews.traits.enabled.&quot;);</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineminus">-  var antiIdBranch = prefs.getBranch(&quot;mailnews.traits.antiId.&quot;);</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineminus">-  _lastIndex = prefs.getBranch(&quot;mailnews.traits.&quot;).getIntPref(&quot;lastIndex&quot;);</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineplus">+  var idBranch = Services.prefs.getBranch(&quot;mailnews.traits.id.&quot;);</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineplus">+  var nameBranch = Services.prefs.getBranch(&quot;mailnews.traits.name.&quot;);</span>
<a href="#l20.44"></a><span id="l20.44" class="difflineplus">+  var enabledBranch = Services.prefs.getBranch(&quot;mailnews.traits.enabled.&quot;);</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineplus">+  var antiIdBranch = Services.prefs.getBranch(&quot;mailnews.traits.antiId.&quot;);</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineplus">+  _lastIndex = Services.prefs.getBranch(&quot;mailnews.traits.&quot;).getIntPref(&quot;lastIndex&quot;);</span>
<a href="#l20.47"></a><span id="l20.47">   var ids = idBranch.getChildList(&quot;&quot;);</span>
<a href="#l20.48"></a><span id="l20.48">   for (var i = 0; i &lt; ids.length; i++)</span>
<a href="#l20.49"></a><span id="l20.49">   {</span>
<a href="#l20.50"></a><span id="l20.50">     var id = idBranch.getCharPref(ids[i]);</span>
<a href="#l20.51"></a><span id="l20.51">     index = parseInt(ids[i]);</span>
<a href="#l20.52"></a><span id="l20.52">     _registerTrait(id, index, false);</span>
<a href="#l20.53"></a><span id="l20.53"> </span>
<a href="#l20.54"></a><span id="l20.54">     // Read in values, ignore errors since that usually means the</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/base/util/IOUtils.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/base/util/IOUtils.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -1,14 +1,16 @@</span>
<a href="#l21.4"></a><span id="l21.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l21.5"></a><span id="l21.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l21.6"></a><span id="l21.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l21.7"></a><span id="l21.7"> </span>
<a href="#l21.8"></a><span id="l21.8"> var EXPORTED_SYMBOLS = [&quot;IOUtils&quot;];</span>
<a href="#l21.9"></a><span id="l21.9"> </span>
<a href="#l21.10"></a><span id="l21.10" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l21.11"></a><span id="l21.11" class="difflineplus">+</span>
<a href="#l21.12"></a><span id="l21.12"> const Cc = Components.classes;</span>
<a href="#l21.13"></a><span id="l21.13"> const Ci = Components.interfaces;</span>
<a href="#l21.14"></a><span id="l21.14"> </span>
<a href="#l21.15"></a><span id="l21.15"> var IOUtils =</span>
<a href="#l21.16"></a><span id="l21.16"> {</span>
<a href="#l21.17"></a><span id="l21.17">   /**</span>
<a href="#l21.18"></a><span id="l21.18">    * Read a file containing ASCII text into a string.</span>
<a href="#l21.19"></a><span id="l21.19">    *</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineat">@@ -39,13 +41,11 @@ var IOUtils =</span>
<a href="#l21.21"></a><span id="l21.21">   },</span>
<a href="#l21.22"></a><span id="l21.22"> </span>
<a href="#l21.23"></a><span id="l21.23">   /**</span>
<a href="#l21.24"></a><span id="l21.24">    * This is provided by the JS component loader.</span>
<a href="#l21.25"></a><span id="l21.25">    */</span>
<a href="#l21.26"></a><span id="l21.26">   btoa: btoa,</span>
<a href="#l21.27"></a><span id="l21.27"> </span>
<a href="#l21.28"></a><span id="l21.28">   getPhysicalMemorySize: function IOUtils_getPhysicalMemorySize() {</span>
<a href="#l21.29"></a><span id="l21.29" class="difflineminus">-    let systemInfo = Cc[&quot;@mozilla.org/system-info;1&quot;]</span>
<a href="#l21.30"></a><span id="l21.30" class="difflineminus">-                      .createInstance(Ci.nsIPropertyBag2);</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineminus">-    return systemInfo.getPropertyAsInt64(&quot;memsize&quot;);</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineplus">+    return Services.sysinfo.getPropertyAsInt64(&quot;memsize&quot;);</span>
<a href="#l21.33"></a><span id="l21.33">   },</span>
<a href="#l21.34"></a><span id="l21.34"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/base/util/StringBundle.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/base/util/StringBundle.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -1,14 +1,16 @@</span>
<a href="#l22.4"></a><span id="l22.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l22.5"></a><span id="l22.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l22.6"></a><span id="l22.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l22.7"></a><span id="l22.7"> </span>
<a href="#l22.8"></a><span id="l22.8"> let EXPORTED_SYMBOLS = [&quot;StringBundle&quot;];</span>
<a href="#l22.9"></a><span id="l22.9"> </span>
<a href="#l22.10"></a><span id="l22.10" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l22.11"></a><span id="l22.11" class="difflineplus">+</span>
<a href="#l22.12"></a><span id="l22.12"> const Cc = Components.classes;</span>
<a href="#l22.13"></a><span id="l22.13"> const Ci = Components.interfaces;</span>
<a href="#l22.14"></a><span id="l22.14"> const Cr = Components.results;</span>
<a href="#l22.15"></a><span id="l22.15"> const Cu = Components.utils;</span>
<a href="#l22.16"></a><span id="l22.16"> </span>
<a href="#l22.17"></a><span id="l22.17"> /**</span>
<a href="#l22.18"></a><span id="l22.18">  * A string bundle.</span>
<a href="#l22.19"></a><span id="l22.19">  *</span>
<a href="#l22.20"></a><span id="l22.20" class="difflineat">@@ -40,34 +42,30 @@ function StringBundle(url) {</span>
<a href="#l22.21"></a><span id="l22.21"> StringBundle.prototype = {</span>
<a href="#l22.22"></a><span id="l22.22">   /**</span>
<a href="#l22.23"></a><span id="l22.23">    * the locale associated with the application</span>
<a href="#l22.24"></a><span id="l22.24">    * @type nsILocale</span>
<a href="#l22.25"></a><span id="l22.25">    * @private</span>
<a href="#l22.26"></a><span id="l22.26">    */</span>
<a href="#l22.27"></a><span id="l22.27">   get _appLocale() {</span>
<a href="#l22.28"></a><span id="l22.28">     try {</span>
<a href="#l22.29"></a><span id="l22.29" class="difflineminus">-      return Cc[&quot;@mozilla.org/intl/nslocaleservice;1&quot;].</span>
<a href="#l22.30"></a><span id="l22.30" class="difflineminus">-             getService(Ci.nsILocaleService).</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineminus">-             getApplicationLocale();</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineplus">+      return Services.locale.getApplicationLocale();</span>
<a href="#l22.33"></a><span id="l22.33">     }</span>
<a href="#l22.34"></a><span id="l22.34">     catch(ex) {</span>
<a href="#l22.35"></a><span id="l22.35">       return null;</span>
<a href="#l22.36"></a><span id="l22.36">     }</span>
<a href="#l22.37"></a><span id="l22.37">   },</span>
<a href="#l22.38"></a><span id="l22.38"> </span>
<a href="#l22.39"></a><span id="l22.39">   /**</span>
<a href="#l22.40"></a><span id="l22.40">    * the wrapped nsIStringBundle</span>
<a href="#l22.41"></a><span id="l22.41">    * @type nsIStringBundle</span>
<a href="#l22.42"></a><span id="l22.42">    * @private</span>
<a href="#l22.43"></a><span id="l22.43">    */</span>
<a href="#l22.44"></a><span id="l22.44">   get _stringBundle() {</span>
<a href="#l22.45"></a><span id="l22.45" class="difflineminus">-    let stringBundle = Cc[&quot;@mozilla.org/intl/stringbundle;1&quot;].</span>
<a href="#l22.46"></a><span id="l22.46" class="difflineminus">-                       getService(Ci.nsIStringBundleService).</span>
<a href="#l22.47"></a><span id="l22.47" class="difflineminus">-                       createBundle(this.url, this._appLocale);</span>
<a href="#l22.48"></a><span id="l22.48" class="difflineplus">+    let stringBundle = Services.strings.createBundle(this.url, this._appLocale);</span>
<a href="#l22.49"></a><span id="l22.49">     this.__defineGetter__(&quot;_stringBundle&quot;, function() stringBundle);</span>
<a href="#l22.50"></a><span id="l22.50">     return this._stringBundle;</span>
<a href="#l22.51"></a><span id="l22.51">   },</span>
<a href="#l22.52"></a><span id="l22.52"> </span>
<a href="#l22.53"></a><span id="l22.53"> </span>
<a href="#l22.54"></a><span id="l22.54">   // the new API</span>
<a href="#l22.55"></a><span id="l22.55"> </span>
<a href="#l22.56"></a><span id="l22.56">   /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/base/util/mailnewsMigrator.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/base/util/mailnewsMigrator.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -8,104 +8,99 @@</span>
<a href="#l23.4"></a><span id="l23.4">  * This should be run at startup. It migrates as needed: each migration</span>
<a href="#l23.5"></a><span id="l23.5">  * function should be written to be a no-op when the value is already migrated</span>
<a href="#l23.6"></a><span id="l23.6">  * or was never used in the old version.</span>
<a href="#l23.7"></a><span id="l23.7">  */</span>
<a href="#l23.8"></a><span id="l23.8"> </span>
<a href="#l23.9"></a><span id="l23.9"> var EXPORTED_SYMBOLS = [ &quot;migrateMailnews&quot; ];</span>
<a href="#l23.10"></a><span id="l23.10"> </span>
<a href="#l23.11"></a><span id="l23.11"> Components.utils.import(&quot;resource:///modules/errUtils.js&quot;);</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-//Components.utils.import(&quot;resource:///modules/Services.js&quot;);</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l23.14"></a><span id="l23.14"> const Ci = Components.interfaces;</span>
<a href="#l23.15"></a><span id="l23.15"> const kServerPrefVersion = 1;</span>
<a href="#l23.16"></a><span id="l23.16"> const kSmtpPrefVersion = 1;</span>
<a href="#l23.17"></a><span id="l23.17" class="difflineminus">-var gPrefs;</span>
<a href="#l23.18"></a><span id="l23.18"> </span>
<a href="#l23.19"></a><span id="l23.19"> function migrateMailnews()</span>
<a href="#l23.20"></a><span id="l23.20"> {</span>
<a href="#l23.21"></a><span id="l23.21">   try {</span>
<a href="#l23.22"></a><span id="l23.22" class="difflineminus">-    //gPrefs = Services.prefs; -- Gecko 1.9.3+</span>
<a href="#l23.23"></a><span id="l23.23" class="difflineminus">-    gPrefs = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l23.24"></a><span id="l23.24" class="difflineminus">-        .getService(Ci.nsIPrefBranch);</span>
<a href="#l23.25"></a><span id="l23.25" class="difflineminus">-</span>
<a href="#l23.26"></a><span id="l23.26">     MigrateServerAuthPref();</span>
<a href="#l23.27"></a><span id="l23.27">   } catch (e) { logException(e); }</span>
<a href="#l23.28"></a><span id="l23.28"> }</span>
<a href="#l23.29"></a><span id="l23.29"> </span>
<a href="#l23.30"></a><span id="l23.30"> /**</span>
<a href="#l23.31"></a><span id="l23.31">  * Migrates from pref useSecAuth to pref authMethod</span>
<a href="#l23.32"></a><span id="l23.32">  */</span>
<a href="#l23.33"></a><span id="l23.33"> function MigrateServerAuthPref()</span>
<a href="#l23.34"></a><span id="l23.34"> {</span>
<a href="#l23.35"></a><span id="l23.35">   try {</span>
<a href="#l23.36"></a><span id="l23.36">     // comma-separated list of all accounts.</span>
<a href="#l23.37"></a><span id="l23.37" class="difflineminus">-    var accounts = gPrefs.getCharPref(&quot;mail.accountmanager.accounts&quot;)</span>
<a href="#l23.38"></a><span id="l23.38" class="difflineplus">+    var accounts = Services.prefs.getCharPref(&quot;mail.accountmanager.accounts&quot;)</span>
<a href="#l23.39"></a><span id="l23.39">         .split(&quot;,&quot;);</span>
<a href="#l23.40"></a><span id="l23.40">     for (let i = 0; i &lt; accounts.length; i++)</span>
<a href="#l23.41"></a><span id="l23.41">     {</span>
<a href="#l23.42"></a><span id="l23.42">       let accountKey = accounts[i]; // e.g. &quot;account1&quot;</span>
<a href="#l23.43"></a><span id="l23.43">       if (!accountKey)</span>
<a href="#l23.44"></a><span id="l23.44">         continue;</span>
<a href="#l23.45"></a><span id="l23.45" class="difflineminus">-      let serverKey = gPrefs.getCharPref(&quot;mail.account.&quot; + accountKey +</span>
<a href="#l23.46"></a><span id="l23.46" class="difflineplus">+      let serverKey = Services.prefs.getCharPref(&quot;mail.account.&quot; + accountKey +</span>
<a href="#l23.47"></a><span id="l23.47">          &quot;.server&quot;);</span>
<a href="#l23.48"></a><span id="l23.48">       let server = &quot;mail.server.&quot; + serverKey + &quot;.&quot;;</span>
<a href="#l23.49"></a><span id="l23.49" class="difflineminus">-      if (gPrefs.prefHasUserValue(server + &quot;authMethod&quot;))</span>
<a href="#l23.50"></a><span id="l23.50" class="difflineplus">+      if (Services.prefs.prefHasUserValue(server + &quot;authMethod&quot;))</span>
<a href="#l23.51"></a><span id="l23.51">         continue;</span>
<a href="#l23.52"></a><span id="l23.52" class="difflineminus">-      if (!gPrefs.prefHasUserValue(server + &quot;useSecAuth&quot;) &amp;&amp;</span>
<a href="#l23.53"></a><span id="l23.53" class="difflineminus">-          !gPrefs.prefHasUserValue(server + &quot;auth_login&quot;))</span>
<a href="#l23.54"></a><span id="l23.54" class="difflineplus">+      if (!Services.prefs.prefHasUserValue(server + &quot;useSecAuth&quot;) &amp;&amp;</span>
<a href="#l23.55"></a><span id="l23.55" class="difflineplus">+          !Services.prefs.prefHasUserValue(server + &quot;auth_login&quot;))</span>
<a href="#l23.56"></a><span id="l23.56">         continue;</span>
<a href="#l23.57"></a><span id="l23.57" class="difflineminus">-      if (gPrefs.prefHasUserValue(server + &quot;migrated&quot;))</span>
<a href="#l23.58"></a><span id="l23.58" class="difflineplus">+      if (Services.prefs.prefHasUserValue(server + &quot;migrated&quot;))</span>
<a href="#l23.59"></a><span id="l23.59">         continue;</span>
<a href="#l23.60"></a><span id="l23.60">       // auth_login = false =&gt; old-style auth</span>
<a href="#l23.61"></a><span id="l23.61">       // else: useSecAuth = true =&gt; &quot;secure auth&quot;</span>
<a href="#l23.62"></a><span id="l23.62">       // else: cleartext pw</span>
<a href="#l23.63"></a><span id="l23.63">       let auth_login = true;</span>
<a href="#l23.64"></a><span id="l23.64">       let useSecAuth = false; // old default, default pref now removed</span>
<a href="#l23.65"></a><span id="l23.65">       try {</span>
<a href="#l23.66"></a><span id="l23.66" class="difflineminus">-        auth_login = gPrefs.getBoolPref(server + &quot;auth_login&quot;);</span>
<a href="#l23.67"></a><span id="l23.67" class="difflineplus">+        auth_login = Services.prefs.getBoolPref(server + &quot;auth_login&quot;);</span>
<a href="#l23.68"></a><span id="l23.68">       } catch (e) {}</span>
<a href="#l23.69"></a><span id="l23.69">       try {</span>
<a href="#l23.70"></a><span id="l23.70" class="difflineminus">-        useSecAuth = gPrefs.getBoolPref(server + &quot;useSecAuth&quot;);</span>
<a href="#l23.71"></a><span id="l23.71" class="difflineplus">+        useSecAuth = Services.prefs.getBoolPref(server + &quot;useSecAuth&quot;);</span>
<a href="#l23.72"></a><span id="l23.72">       } catch (e) {}</span>
<a href="#l23.73"></a><span id="l23.73"> </span>
<a href="#l23.74"></a><span id="l23.74" class="difflineminus">-      gPrefs.setIntPref(server + &quot;authMethod&quot;,</span>
<a href="#l23.75"></a><span id="l23.75" class="difflineplus">+      Services.prefs.setIntPref(server + &quot;authMethod&quot;,</span>
<a href="#l23.76"></a><span id="l23.76">           auth_login ? (useSecAuth ?</span>
<a href="#l23.77"></a><span id="l23.77">                            Ci.nsMsgAuthMethod.secure :</span>
<a href="#l23.78"></a><span id="l23.78">                            Ci.nsMsgAuthMethod.passwordCleartext) :</span>
<a href="#l23.79"></a><span id="l23.79">                        Ci.nsMsgAuthMethod.old);</span>
<a href="#l23.80"></a><span id="l23.80" class="difflineminus">-      gPrefs.setIntPref(server + &quot;migrated&quot;, kServerPrefVersion);</span>
<a href="#l23.81"></a><span id="l23.81" class="difflineplus">+      Services.prefs.setIntPref(server + &quot;migrated&quot;, kServerPrefVersion);</span>
<a href="#l23.82"></a><span id="l23.82">     }</span>
<a href="#l23.83"></a><span id="l23.83"> </span>
<a href="#l23.84"></a><span id="l23.84">     // same again for SMTP servers</span>
<a href="#l23.85"></a><span id="l23.85" class="difflineminus">-    var smtpservers = gPrefs.getCharPref(&quot;mail.smtpservers&quot;).split(&quot;,&quot;);</span>
<a href="#l23.86"></a><span id="l23.86" class="difflineplus">+    var smtpservers = Services.prefs.getCharPref(&quot;mail.smtpservers&quot;).split(&quot;,&quot;);</span>
<a href="#l23.87"></a><span id="l23.87">     for (let i = 0; i &lt; smtpservers.length; i++)</span>
<a href="#l23.88"></a><span id="l23.88">     {</span>
<a href="#l23.89"></a><span id="l23.89">       if (!smtpservers[i])</span>
<a href="#l23.90"></a><span id="l23.90">         continue;</span>
<a href="#l23.91"></a><span id="l23.91">       let server = &quot;mail.smtpserver.&quot; + smtpservers[i] + &quot;.&quot;;</span>
<a href="#l23.92"></a><span id="l23.92" class="difflineminus">-      if (gPrefs.prefHasUserValue(server + &quot;authMethod&quot;))</span>
<a href="#l23.93"></a><span id="l23.93" class="difflineplus">+      if (Services.prefs.prefHasUserValue(server + &quot;authMethod&quot;))</span>
<a href="#l23.94"></a><span id="l23.94">         continue;</span>
<a href="#l23.95"></a><span id="l23.95" class="difflineminus">-      if (!gPrefs.prefHasUserValue(server + &quot;useSecAuth&quot;) &amp;&amp;</span>
<a href="#l23.96"></a><span id="l23.96" class="difflineminus">-          !gPrefs.prefHasUserValue(server + &quot;auth_method&quot;))</span>
<a href="#l23.97"></a><span id="l23.97" class="difflineplus">+      if (!Services.prefs.prefHasUserValue(server + &quot;useSecAuth&quot;) &amp;&amp;</span>
<a href="#l23.98"></a><span id="l23.98" class="difflineplus">+          !Services.prefs.prefHasUserValue(server + &quot;auth_method&quot;))</span>
<a href="#l23.99"></a><span id="l23.99">         continue;</span>
<a href="#l23.100"></a><span id="l23.100" class="difflineminus">-      if (gPrefs.prefHasUserValue(server + &quot;migrated&quot;))</span>
<a href="#l23.101"></a><span id="l23.101" class="difflineplus">+      if (Services.prefs.prefHasUserValue(server + &quot;migrated&quot;))</span>
<a href="#l23.102"></a><span id="l23.102">         continue;</span>
<a href="#l23.103"></a><span id="l23.103">       // auth_method = 0 =&gt; no auth</span>
<a href="#l23.104"></a><span id="l23.104">       // else: useSecAuth = true =&gt; &quot;secure auth&quot;</span>
<a href="#l23.105"></a><span id="l23.105">       // else: cleartext pw</span>
<a href="#l23.106"></a><span id="l23.106">       let auth_method = 1;</span>
<a href="#l23.107"></a><span id="l23.107">       let useSecAuth = false;</span>
<a href="#l23.108"></a><span id="l23.108">       try {</span>
<a href="#l23.109"></a><span id="l23.109" class="difflineminus">-        auth_method = gPrefs.getIntPref(server + &quot;auth_method&quot;);</span>
<a href="#l23.110"></a><span id="l23.110" class="difflineplus">+        auth_method = Services.prefs.getIntPref(server + &quot;auth_method&quot;);</span>
<a href="#l23.111"></a><span id="l23.111">       } catch (e) {}</span>
<a href="#l23.112"></a><span id="l23.112">       try {</span>
<a href="#l23.113"></a><span id="l23.113" class="difflineminus">-        useSecAuth = gPrefs.getBoolPref(server + &quot;useSecAuth&quot;);</span>
<a href="#l23.114"></a><span id="l23.114" class="difflineplus">+        useSecAuth = Services.prefs.getBoolPref(server + &quot;useSecAuth&quot;);</span>
<a href="#l23.115"></a><span id="l23.115">       } catch (e) {}</span>
<a href="#l23.116"></a><span id="l23.116"> </span>
<a href="#l23.117"></a><span id="l23.117" class="difflineminus">-      gPrefs.setIntPref(server + &quot;authMethod&quot;,</span>
<a href="#l23.118"></a><span id="l23.118" class="difflineplus">+      Services.prefs.setIntPref(server + &quot;authMethod&quot;,</span>
<a href="#l23.119"></a><span id="l23.119">           auth_method ? (useSecAuth ?</span>
<a href="#l23.120"></a><span id="l23.120">                             Ci.nsMsgAuthMethod.secure :</span>
<a href="#l23.121"></a><span id="l23.121">                             Ci.nsMsgAuthMethod.passwordCleartext) :</span>
<a href="#l23.122"></a><span id="l23.122">                         Ci.nsMsgAuthMethod.none);</span>
<a href="#l23.123"></a><span id="l23.123" class="difflineminus">-      gPrefs.setIntPref(server + &quot;migrated&quot;, kSmtpPrefVersion);</span>
<a href="#l23.124"></a><span id="l23.124" class="difflineplus">+      Services.prefs.setIntPref(server + &quot;migrated&quot;, kSmtpPrefVersion);</span>
<a href="#l23.125"></a><span id="l23.125">     }</span>
<a href="#l23.126"></a><span id="l23.126">   } catch(e) { logException(e); }</span>
<a href="#l23.127"></a><span id="l23.127"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/extensions/bayesian-spam-filter/test/unit/head_bayes.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/extensions/bayesian-spam-filter/test/unit/head_bayes.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -1,13 +1,13 @@</span>
<a href="#l24.4"></a><span id="l24.4"> // Import the main scripts that mailnews tests need to set up and tear down</span>
<a href="#l24.5"></a><span id="l24.5"> load(&quot;../../../../resources/mailDirService.js&quot;);</span>
<a href="#l24.6"></a><span id="l24.6"> load(&quot;../../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l24.7"></a><span id="l24.7"> </span>
<a href="#l24.8"></a><span id="l24.8" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l24.9"></a><span id="l24.9" class="difflineplus">+</span>
<a href="#l24.10"></a><span id="l24.10"> function getSpec(aFileName)</span>
<a href="#l24.11"></a><span id="l24.11"> {</span>
<a href="#l24.12"></a><span id="l24.12">   var file = do_get_file(&quot;resources/&quot; + aFileName);</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineminus">-  var uri = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineminus">-               .getService(Ci.nsIIOService)</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineminus">-               .newFileURI(file).QueryInterface(Ci.nsIURL);</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineplus">+  var uri = Services.io.newFileURI(file).QueryInterface(Ci.nsIURL);</span>
<a href="#l24.17"></a><span id="l24.17">   uri.query = &quot;type=application/x-message-display&quot;;</span>
<a href="#l24.18"></a><span id="l24.18">   return uri.spec;</span>
<a href="#l24.19"></a><span id="l24.19"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/extensions/bayesian-spam-filter/test/unit/resources/trainingfile.js</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/extensions/bayesian-spam-filter/test/unit/resources/trainingfile.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -1,15 +1,17 @@</span>
<a href="#l25.4"></a><span id="l25.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l25.5"></a><span id="l25.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l25.6"></a><span id="l25.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l25.7"></a><span id="l25.7"> </span>
<a href="#l25.8"></a><span id="l25.8"> // service class to manipulate the junk training.dat file</span>
<a href="#l25.9"></a><span id="l25.9"> //  code is adapted from Mnehy Thunderbird Extension</span>
<a href="#l25.10"></a><span id="l25.10"> </span>
<a href="#l25.11"></a><span id="l25.11" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineplus">+</span>
<a href="#l25.13"></a><span id="l25.13"> function TrainingData() {</span>
<a href="#l25.14"></a><span id="l25.14"> </span>
<a href="#l25.15"></a><span id="l25.15">   // local constants</span>
<a href="#l25.16"></a><span id="l25.16"> </span>
<a href="#l25.17"></a><span id="l25.17">   const Cc = Components.classes;</span>
<a href="#l25.18"></a><span id="l25.18">   const Ci = Components.interfaces;</span>
<a href="#l25.19"></a><span id="l25.19">   const CC = Components.Constructor;</span>
<a href="#l25.20"></a><span id="l25.20">    </span>
<a href="#l25.21"></a><span id="l25.21" class="difflineat">@@ -24,33 +26,30 @@ function TrainingData() {</span>
<a href="#l25.22"></a><span id="l25.22">   this.mGoodMessages = 0;</span>
<a href="#l25.23"></a><span id="l25.23">   this.mJunkMessages = 0;</span>
<a href="#l25.24"></a><span id="l25.24">   this.mGoodCounts = new Object;</span>
<a href="#l25.25"></a><span id="l25.25">   this.mJunkCounts = new Object;</span>
<a href="#l25.26"></a><span id="l25.26">   </span>
<a href="#l25.27"></a><span id="l25.27">   // helper functions</span>
<a href="#l25.28"></a><span id="l25.28"> </span>
<a href="#l25.29"></a><span id="l25.29">   function getJunkStatFile() {</span>
<a href="#l25.30"></a><span id="l25.30" class="difflineminus">-    var nsIProperties = Cc[&quot;@mozilla.org/file/directory_service;1&quot;].getService(Ci.nsIProperties);</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineminus">-    var sBaseDir = nsIProperties.get(&quot;ProfD&quot;, Ci.nsIFile);</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineplus">+    var sBaseDir = Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsIFile);</span>
<a href="#l25.33"></a><span id="l25.33">     var CFileByFile = new CC(&quot;@mozilla.org/file/local;1&quot;, &quot;nsILocalFile&quot;, &quot;initWithFile&quot;);</span>
<a href="#l25.34"></a><span id="l25.34">     var oFile = new CFileByFile(sBaseDir);</span>
<a href="#l25.35"></a><span id="l25.35">     oFile.append(&quot;training.dat&quot;);</span>
<a href="#l25.36"></a><span id="l25.36">     return oFile;</span>
<a href="#l25.37"></a><span id="l25.37">   }</span>
<a href="#l25.38"></a><span id="l25.38">   </span>
<a href="#l25.39"></a><span id="l25.39">   function getBinStream(oFile) {</span>
<a href="#l25.40"></a><span id="l25.40">   </span>
<a href="#l25.41"></a><span id="l25.41" class="difflineminus">-    var nsIIOService = Cc[&quot;@mozilla.org/network/io-service;1&quot;].getService(Ci.nsIIOService);</span>
<a href="#l25.42"></a><span id="l25.42" class="difflineminus">-</span>
<a href="#l25.43"></a><span id="l25.43">     if (oFile &amp;&amp; oFile.exists())</span>
<a href="#l25.44"></a><span id="l25.44">     { </span>
<a href="#l25.45"></a><span id="l25.45" class="difflineminus">-      var oUri = nsIIOService.newFileURI(oFile);</span>
<a href="#l25.46"></a><span id="l25.46" class="difflineplus">+      var oUri = Services.io.newFileURI(oFile);</span>
<a href="#l25.47"></a><span id="l25.47">       // open stream (channel)</span>
<a href="#l25.48"></a><span id="l25.48" class="difflineminus">-      var oStream    = nsIIOService.newChannelFromURI(oUri).open();</span>
<a href="#l25.49"></a><span id="l25.49" class="difflineplus">+      var oStream = Services.io.newChannelFromURI(oUri).open();</span>
<a href="#l25.50"></a><span id="l25.50">       // buffer it</span>
<a href="#l25.51"></a><span id="l25.51">       var oBufStream = Cc[&quot;@mozilla.org/network/buffered-input-stream;1&quot;].</span>
<a href="#l25.52"></a><span id="l25.52">         createInstance(Ci.nsIBufferedInputStream);</span>
<a href="#l25.53"></a><span id="l25.53">       oBufStream.init(oStream, oFile.fileSize);</span>
<a href="#l25.54"></a><span id="l25.54">       // read as binary</span>
<a href="#l25.55"></a><span id="l25.55">       var oBinStream = Cc[&quot;@mozilla.org/binaryinputstream;1&quot;].</span>
<a href="#l25.56"></a><span id="l25.56">         createInstance(Ci.nsIBinaryInputStream);</span>
<a href="#l25.57"></a><span id="l25.57">       oBinStream.setInputStream(oBufStream);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/extensions/mdn/content/am-mdn.js</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/extensions/mdn/content/am-mdn.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -105,32 +105,30 @@ function onPreInit(account, accountValue</span>
<a href="#l26.4"></a><span id="l26.4">   gIncomingServer = account.incomingServer;</span>
<a href="#l26.5"></a><span id="l26.5"> }</span>
<a href="#l26.6"></a><span id="l26.6"> </span>
<a href="#l26.7"></a><span id="l26.7"> // Disables xul elements that have associated preferences locked.</span>
<a href="#l26.8"></a><span id="l26.8"> function onLockPreference(initPrefString, keyString)</span>
<a href="#l26.9"></a><span id="l26.9"> {</span>
<a href="#l26.10"></a><span id="l26.10">     var finalPrefString; </span>
<a href="#l26.11"></a><span id="l26.11"> </span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-    var prefService = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;].getService(Components.interfaces.nsIPrefService);</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineminus">-</span>
<a href="#l26.14"></a><span id="l26.14">     var allPrefElements = [</span>
<a href="#l26.15"></a><span id="l26.15">       { prefstring:&quot;request_return_receipt_on&quot;, id:&quot;identity.request_return_receipt_on&quot;},</span>
<a href="#l26.16"></a><span id="l26.16">       { prefstring:&quot;select_custom_prefs&quot;, id:&quot;identity.select_custom_prefs&quot;},</span>
<a href="#l26.17"></a><span id="l26.17">       { prefstring:&quot;select_global_prefs&quot;, id:&quot;identity.select_global_prefs&quot;},</span>
<a href="#l26.18"></a><span id="l26.18">       { prefstring:&quot;incorporate_return_receipt&quot;, id:&quot;server.incorporate_return_receipt&quot;},</span>
<a href="#l26.19"></a><span id="l26.19">       { prefstring:&quot;never_return&quot;, id:&quot;never_return&quot;},</span>
<a href="#l26.20"></a><span id="l26.20">       { prefstring:&quot;return_some&quot;, id:&quot;return_some&quot;},</span>
<a href="#l26.21"></a><span id="l26.21">       { prefstring:&quot;mdn_not_in_to_cc&quot;, id:&quot;server.mdn_not_in_to_cc&quot;},</span>
<a href="#l26.22"></a><span id="l26.22">       { prefstring:&quot;mdn_outside_domain&quot;, id:&quot;server.mdn_outside_domain&quot;},</span>
<a href="#l26.23"></a><span id="l26.23">       { prefstring:&quot;mdn_other&quot;, id:&quot;server.mdn_other&quot;},</span>
<a href="#l26.24"></a><span id="l26.24">     ];</span>
<a href="#l26.25"></a><span id="l26.25"> </span>
<a href="#l26.26"></a><span id="l26.26">     finalPrefString = initPrefString + &quot;.&quot; + keyString + &quot;.&quot;;</span>
<a href="#l26.27"></a><span id="l26.27" class="difflineminus">-    gMdnPrefBranch = prefService.getBranch(finalPrefString);</span>
<a href="#l26.28"></a><span id="l26.28" class="difflineplus">+    gMdnPrefBranch = Services.prefs.getBranch(finalPrefString);</span>
<a href="#l26.29"></a><span id="l26.29"> </span>
<a href="#l26.30"></a><span id="l26.30">     disableIfLocked( allPrefElements );</span>
<a href="#l26.31"></a><span id="l26.31"> } </span>
<a href="#l26.32"></a><span id="l26.32"> </span>
<a href="#l26.33"></a><span id="l26.33"> function disableIfLocked( prefstrArray )</span>
<a href="#l26.34"></a><span id="l26.34"> {</span>
<a href="#l26.35"></a><span id="l26.35">   for (var i=0; i&lt;prefstrArray.length; i++) {</span>
<a href="#l26.36"></a><span id="l26.36">     var id = prefstrArray[i].id;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/extensions/newsblog/js/newsblog.js</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/js/newsblog.js</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -1,13 +1,14 @@</span>
<a href="#l27.4"></a><span id="l27.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l27.5"></a><span id="l27.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l27.6"></a><span id="l27.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l27.7"></a><span id="l27.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l27.8"></a><span id="l27.8"> </span>
<a href="#l27.9"></a><span id="l27.9" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l27.10"></a><span id="l27.10"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l27.11"></a><span id="l27.11"> </span>
<a href="#l27.12"></a><span id="l27.12"> var gExternalScriptsLoaded = false;</span>
<a href="#l27.13"></a><span id="l27.13"> </span>
<a href="#l27.14"></a><span id="l27.14"> var nsNewsBlogFeedDownloader =</span>
<a href="#l27.15"></a><span id="l27.15"> {</span>
<a href="#l27.16"></a><span id="l27.16">   downloadFeed: function(aA, aFolder, aB, aC, aUrlListener, aMsgWindow)</span>
<a href="#l27.17"></a><span id="l27.17">   {</span>
<a href="#l27.18"></a><span id="l27.18" class="difflineat">@@ -331,20 +332,15 @@ AcctMgrExtension.prototype =</span>
<a href="#l27.19"></a><span id="l27.19">   } // factory</span>
<a href="#l27.20"></a><span id="l27.20"> }; // account manager extension</span>
<a href="#l27.21"></a><span id="l27.21"> </span>
<a href="#l27.22"></a><span id="l27.22"> var components = [FeedDownloader, AcctMgrExtension];</span>
<a href="#l27.23"></a><span id="l27.23"> var NSGetFactory = XPCOMUtils.generateNSGetFactory(components);</span>
<a href="#l27.24"></a><span id="l27.24"> </span>
<a href="#l27.25"></a><span id="l27.25"> function loadScripts()</span>
<a href="#l27.26"></a><span id="l27.26"> {</span>
<a href="#l27.27"></a><span id="l27.27" class="difflineminus">-  var scriptLoader = Components.classes[&quot;@mozilla.org/moz/jssubscript-loader;1&quot;]</span>
<a href="#l27.28"></a><span id="l27.28" class="difflineminus">-                     .getService(Components.interfaces.mozIJSSubScriptLoader);</span>
<a href="#l27.29"></a><span id="l27.29" class="difflineminus">-  if (scriptLoader)</span>
<a href="#l27.30"></a><span id="l27.30" class="difflineminus">-  {</span>
<a href="#l27.31"></a><span id="l27.31" class="difflineminus">-    scriptLoader.loadSubScript(&quot;chrome://messenger-newsblog/content/Feed.js&quot;);</span>
<a href="#l27.32"></a><span id="l27.32" class="difflineminus">-    scriptLoader.loadSubScript(&quot;chrome://messenger-newsblog/content/FeedItem.js&quot;);</span>
<a href="#l27.33"></a><span id="l27.33" class="difflineminus">-    scriptLoader.loadSubScript(&quot;chrome://messenger-newsblog/content/feed-parser.js&quot;);</span>
<a href="#l27.34"></a><span id="l27.34" class="difflineminus">-    scriptLoader.loadSubScript(&quot;chrome://messenger-newsblog/content/utils.js&quot;);</span>
<a href="#l27.35"></a><span id="l27.35" class="difflineminus">-  }</span>
<a href="#l27.36"></a><span id="l27.36" class="difflineplus">+  Services.scriptloader.loadSubScript(&quot;chrome://messenger-newsblog/content/Feed.js&quot;);</span>
<a href="#l27.37"></a><span id="l27.37" class="difflineplus">+  Services.scriptloader.loadSubScript(&quot;chrome://messenger-newsblog/content/FeedItem.js&quot;);</span>
<a href="#l27.38"></a><span id="l27.38" class="difflineplus">+  Services.scriptloader.loadSubScript(&quot;chrome://messenger-newsblog/content/feed-parser.js&quot;);</span>
<a href="#l27.39"></a><span id="l27.39" class="difflineplus">+  Services.scriptloader.loadSubScript(&quot;chrome://messenger-newsblog/content/utils.js&quot;);</span>
<a href="#l27.40"></a><span id="l27.40"> </span>
<a href="#l27.41"></a><span id="l27.41">   gExternalScriptsLoaded = true;</span>
<a href="#l27.42"></a><span id="l27.42"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mailnews/import/content/importDialog.js</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mailnews/import/content/importDialog.js</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -1,14 +1,16 @@</span>
<a href="#l28.4"></a><span id="l28.4"> /* -*- Mode: Javascript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l28.5"></a><span id="l28.5">  *</span>
<a href="#l28.6"></a><span id="l28.6">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l28.7"></a><span id="l28.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l28.8"></a><span id="l28.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l28.9"></a><span id="l28.9"> </span>
<a href="#l28.10"></a><span id="l28.10" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l28.11"></a><span id="l28.11" class="difflineplus">+</span>
<a href="#l28.12"></a><span id="l28.12"> var importType = null;</span>
<a href="#l28.13"></a><span id="l28.13"> var gImportMsgsBundle;</span>
<a href="#l28.14"></a><span id="l28.14"> var gFeedsBundle;</span>
<a href="#l28.15"></a><span id="l28.15"> var importService = 0;</span>
<a href="#l28.16"></a><span id="l28.16"> var successStr = null;</span>
<a href="#l28.17"></a><span id="l28.17"> var errorStr = null;</span>
<a href="#l28.18"></a><span id="l28.18"> var inputStr = null ;</span>
<a href="#l28.19"></a><span id="l28.19"> var progressInfo = null;</span>
<a href="#l28.20"></a><span id="l28.20" class="difflineat">@@ -855,19 +857,18 @@ function ImportAddress( module, success,</span>
<a href="#l28.21"></a><span id="l28.21">     path = filePicker.file.leafName;</span>
<a href="#l28.22"></a><span id="l28.22"> 	</span>
<a href="#l28.23"></a><span id="l28.23">     if (file == null) {</span>
<a href="#l28.24"></a><span id="l28.24">       return( false);</span>
<a href="#l28.25"></a><span id="l28.25">     }</span>
<a href="#l28.26"></a><span id="l28.26"> </span>
<a href="#l28.27"></a><span id="l28.27">     if ( !fileIsDirectory &amp;&amp; (file.fileSize == 0) ) {</span>
<a href="#l28.28"></a><span id="l28.28">       var errorText = gImportMsgsBundle.getFormattedString('ImportEmptyAddressBook', [path]);</span>
<a href="#l28.29"></a><span id="l28.29" class="difflineminus">-      var promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;].getService(Components.interfaces.nsIPromptService);</span>
<a href="#l28.30"></a><span id="l28.30"> </span>
<a href="#l28.31"></a><span id="l28.31" class="difflineminus">-      promptService.alert(window, document.title, errorText);</span>
<a href="#l28.32"></a><span id="l28.32" class="difflineplus">+      Services.prompt.alert(window, document.title, errorText);</span>
<a href="#l28.33"></a><span id="l28.33">       return false;</span>
<a href="#l28.34"></a><span id="l28.34">     }</span>
<a href="#l28.35"></a><span id="l28.35">     addInterface.SetData(&quot;addressLocation&quot;, file);</span>
<a href="#l28.36"></a><span id="l28.36">   }</span>
<a href="#l28.37"></a><span id="l28.37"> </span>
<a href="#l28.38"></a><span id="l28.38">   var map = addInterface.GetData( &quot;fieldMap&quot;);</span>
<a href="#l28.39"></a><span id="l28.39">   if (map != null) {</span>
<a href="#l28.40"></a><span id="l28.40">     map = map.QueryInterface( Components.interfaces.nsIImportFieldMap);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

