<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 24005:1940b43f2306a0aa1c5e45dd311256f359bcdb28</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 1940b43f2306a0aa1c5e45dd311256f359bcdb28" />
<meta property="og:url" content="/comm-central/rev/1940b43f2306a0aa1c5e45dd311256f359bcdb28" />
<meta property="og:description" content="Bug 1463266 - replace tabs with spaces in mailnews/compose. rs=white-space-only" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 1940b43f2306a0aa1c5e45dd311256f359bcdb28 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/1940b43f2306a0aa1c5e45dd311256f359bcdb28">shortlog</a> |
<a href="/comm-central/log/1940b43f2306a0aa1c5e45dd311256f359bcdb28">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/1940b43f2306a0aa1c5e45dd311256f359bcdb28">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/1940b43f2306a0aa1c5e45dd311256f359bcdb28">files</a> |
changeset |
<a href="/comm-central/raw-rev/1940b43f2306a0aa1c5e45dd311256f359bcdb28">raw</a>  | <a href="/comm-central/archive/1940b43f2306a0aa1c5e45dd311256f359bcdb28.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1463266">Bug 1463266</a> - replace tabs with spaces in mailnews/compose. rs=white-space-only
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#114;&#103;&#32;&#75;&#32;&#60;&#106;&#111;&#114;&#103;&#107;&#64;&#106;&#111;&#114;&#103;&#107;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 31 May 2018 23:55:34 +0200</td></tr>

<tr>
 <td>changeset 24005</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/1940b43f2306a0aa1c5e45dd311256f359bcdb28">1940b43f2306a0aa1c5e45dd311256f359bcdb28</a></td>
</tr>



<tr>
<td>parent 24004</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/2463d996da66ca52cab5cf840fcf24569962ff52">2463d996da66ca52cab5cf840fcf24569962ff52</a>
</td>
</tr>

<tr>
<td>child 24006</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/8f2b699fd1ac390b1899491bae6cfac78da3d166">8f2b699fd1ac390b1899491bae6cfac78da3d166</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=1940b43f2306a0aa1c5e45dd311256f359bcdb28">14478</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Thu, 31 May 2018 21:56:05 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@1940b43f2306 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=1940b43f2306a0aa1c5e45dd311256f359bcdb28">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=1940b43f2306a0aa1c5e45dd311256f359bcdb28&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1940b43f2306a0aa1c5e45dd311256f359bcdb28&newProject=comm-central&newRevision=2463d996da66ca52cab5cf840fcf24569962ff52&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1940b43f2306a0aa1c5e45dd311256f359bcdb28&newProject=comm-central&newRevision=2463d996da66ca52cab5cf840fcf24569962ff52&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1940b43f2306a0aa1c5e45dd311256f359bcdb28&newProject=comm-central&newRevision=2463d996da66ca52cab5cf840fcf24569962ff52&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28white-space-only%29&revcount=50">white-space-only</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1463266">1463266</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1463266">Bug 1463266</a> - replace tabs with spaces in mailnews/compose. rs=white-space-only
[skip-blame]</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgAppleCodes.h">mailnews/compose/src/nsMsgAppleCodes.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgAppleCodes.h">file</a> |
<a href="/comm-central/annotate/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgAppleCodes.h">annotate</a> |
<a href="/comm-central/diff/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgAppleCodes.h">diff</a> |
<a href="/comm-central/comparison/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgAppleCodes.h">comparison</a> |
<a href="/comm-central/log/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgAppleCodes.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgAppleDoubleEncode.cpp">mailnews/compose/src/nsMsgAppleDoubleEncode.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgAppleDoubleEncode.cpp">file</a> |
<a href="/comm-central/annotate/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgAppleDoubleEncode.cpp">annotate</a> |
<a href="/comm-central/diff/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgAppleDoubleEncode.cpp">diff</a> |
<a href="/comm-central/comparison/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgAppleDoubleEncode.cpp">comparison</a> |
<a href="/comm-central/log/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgAppleDoubleEncode.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgAppleEncode.cpp">mailnews/compose/src/nsMsgAppleEncode.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgAppleEncode.cpp">file</a> |
<a href="/comm-central/annotate/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgAppleEncode.cpp">annotate</a> |
<a href="/comm-central/diff/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgAppleEncode.cpp">diff</a> |
<a href="/comm-central/comparison/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgAppleEncode.cpp">comparison</a> |
<a href="/comm-central/log/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgAppleEncode.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgAttachment.cpp">mailnews/compose/src/nsMsgAttachment.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgAttachment.cpp">file</a> |
<a href="/comm-central/annotate/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgAttachment.cpp">annotate</a> |
<a href="/comm-central/diff/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgAttachment.cpp">diff</a> |
<a href="/comm-central/comparison/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgAttachment.cpp">comparison</a> |
<a href="/comm-central/log/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgAttachment.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgCompUtils.cpp">mailnews/compose/src/nsMsgCompUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgCompUtils.cpp">file</a> |
<a href="/comm-central/annotate/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgCompUtils.cpp">annotate</a> |
<a href="/comm-central/diff/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgCompUtils.cpp">diff</a> |
<a href="/comm-central/comparison/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgCompUtils.cpp">comparison</a> |
<a href="/comm-central/log/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgCompUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgComposeContentHandler.h">mailnews/compose/src/nsMsgComposeContentHandler.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgComposeContentHandler.h">file</a> |
<a href="/comm-central/annotate/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgComposeContentHandler.h">annotate</a> |
<a href="/comm-central/diff/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgComposeContentHandler.h">diff</a> |
<a href="/comm-central/comparison/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgComposeContentHandler.h">comparison</a> |
<a href="/comm-central/log/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgComposeContentHandler.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgComposeProgressParams.h">mailnews/compose/src/nsMsgComposeProgressParams.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgComposeProgressParams.h">file</a> |
<a href="/comm-central/annotate/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgComposeProgressParams.h">annotate</a> |
<a href="/comm-central/diff/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgComposeProgressParams.h">diff</a> |
<a href="/comm-central/comparison/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgComposeProgressParams.h">comparison</a> |
<a href="/comm-central/log/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgComposeProgressParams.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgComposeService.h">mailnews/compose/src/nsMsgComposeService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgComposeService.h">file</a> |
<a href="/comm-central/annotate/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgComposeService.h">annotate</a> |
<a href="/comm-central/diff/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgComposeService.h">diff</a> |
<a href="/comm-central/comparison/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgComposeService.h">comparison</a> |
<a href="/comm-central/log/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgComposeService.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgCopy.cpp">mailnews/compose/src/nsMsgCopy.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgCopy.cpp">file</a> |
<a href="/comm-central/annotate/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgCopy.cpp">annotate</a> |
<a href="/comm-central/diff/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgCopy.cpp">diff</a> |
<a href="/comm-central/comparison/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgCopy.cpp">comparison</a> |
<a href="/comm-central/log/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgCopy.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgCopy.h">mailnews/compose/src/nsMsgCopy.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgCopy.h">file</a> |
<a href="/comm-central/annotate/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgCopy.h">annotate</a> |
<a href="/comm-central/diff/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgCopy.h">diff</a> |
<a href="/comm-central/comparison/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgCopy.h">comparison</a> |
<a href="/comm-central/log/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgCopy.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgQuote.cpp">mailnews/compose/src/nsMsgQuote.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgQuote.cpp">file</a> |
<a href="/comm-central/annotate/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgQuote.cpp">annotate</a> |
<a href="/comm-central/diff/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgQuote.cpp">diff</a> |
<a href="/comm-central/comparison/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgQuote.cpp">comparison</a> |
<a href="/comm-central/log/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgQuote.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgQuote.h">mailnews/compose/src/nsMsgQuote.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgQuote.h">file</a> |
<a href="/comm-central/annotate/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgQuote.h">annotate</a> |
<a href="/comm-central/diff/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgQuote.h">diff</a> |
<a href="/comm-central/comparison/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgQuote.h">comparison</a> |
<a href="/comm-central/log/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgQuote.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgSendPart.h">mailnews/compose/src/nsMsgSendPart.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgSendPart.h">file</a> |
<a href="/comm-central/annotate/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgSendPart.h">annotate</a> |
<a href="/comm-central/diff/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgSendPart.h">diff</a> |
<a href="/comm-central/comparison/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgSendPart.h">comparison</a> |
<a href="/comm-central/log/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsMsgSendPart.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsSmtpProtocol.cpp">mailnews/compose/src/nsSmtpProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsSmtpProtocol.cpp">file</a> |
<a href="/comm-central/annotate/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsSmtpProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsSmtpProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsSmtpProtocol.cpp">comparison</a> |
<a href="/comm-central/log/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsSmtpProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsSmtpProtocol.h">mailnews/compose/src/nsSmtpProtocol.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsSmtpProtocol.h">file</a> |
<a href="/comm-central/annotate/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsSmtpProtocol.h">annotate</a> |
<a href="/comm-central/diff/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsSmtpProtocol.h">diff</a> |
<a href="/comm-central/comparison/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsSmtpProtocol.h">comparison</a> |
<a href="/comm-central/log/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsSmtpProtocol.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsSmtpService.cpp">mailnews/compose/src/nsSmtpService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsSmtpService.cpp">file</a> |
<a href="/comm-central/annotate/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsSmtpService.cpp">annotate</a> |
<a href="/comm-central/diff/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsSmtpService.cpp">diff</a> |
<a href="/comm-central/comparison/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsSmtpService.cpp">comparison</a> |
<a href="/comm-central/log/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsSmtpService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsSmtpService.h">mailnews/compose/src/nsSmtpService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsSmtpService.h">file</a> |
<a href="/comm-central/annotate/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsSmtpService.h">annotate</a> |
<a href="/comm-central/diff/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsSmtpService.h">diff</a> |
<a href="/comm-central/comparison/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsSmtpService.h">comparison</a> |
<a href="/comm-central/log/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsSmtpService.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsSmtpUrl.cpp">mailnews/compose/src/nsSmtpUrl.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsSmtpUrl.cpp">file</a> |
<a href="/comm-central/annotate/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsSmtpUrl.cpp">annotate</a> |
<a href="/comm-central/diff/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsSmtpUrl.cpp">diff</a> |
<a href="/comm-central/comparison/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsSmtpUrl.cpp">comparison</a> |
<a href="/comm-central/log/1940b43f2306a0aa1c5e45dd311256f359bcdb28/mailnews/compose/src/nsSmtpUrl.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgAppleCodes.h</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgAppleCodes.h</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1,96 +1,96 @@</span>
<a href="#l1.4"></a><span id="l1.4"> /* -*- Mode: C; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l1.5"></a><span id="l1.5">  *</span>
<a href="#l1.6"></a><span id="l1.6">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.7"></a><span id="l1.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.8"></a><span id="l1.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10"> /*</span>
<a href="#l1.11"></a><span id="l1.11" class="difflineminus">-**	AD_Codes.h</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+**  AD_Codes.h</span>
<a href="#l1.13"></a><span id="l1.13"> **</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-**	---------------</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+**  ---------------</span>
<a href="#l1.16"></a><span id="l1.16"> **</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-**		Head file for Apple Decode/Encode essential codes.</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+**  Head file for Apple Decode/Encode essential codes.</span>
<a href="#l1.19"></a><span id="l1.19"> **</span>
<a href="#l1.20"></a><span id="l1.20"> **</span>
<a href="#l1.21"></a><span id="l1.21"> */</span>
<a href="#l1.22"></a><span id="l1.22"> </span>
<a href="#l1.23"></a><span id="l1.23"> #ifndef ad_codes_h</span>
<a href="#l1.24"></a><span id="l1.24"> #define ad_codes_h</span>
<a href="#l1.25"></a><span id="l1.25"> </span>
<a href="#l1.26"></a><span id="l1.26"> /*</span>
<a href="#l1.27"></a><span id="l1.27"> ** applefile definitions used</span>
<a href="#l1.28"></a><span id="l1.28"> */</span>
<a href="#l1.29"></a><span id="l1.29"> #if PRAGMA_STRUCT_ALIGN</span>
<a href="#l1.30"></a><span id="l1.30">   #pragma options align=mac68k</span>
<a href="#l1.31"></a><span id="l1.31"> #endif</span>
<a href="#l1.32"></a><span id="l1.32"> </span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-#define APPLESINGLE_MAGIC	0x00051600L</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-#define APPLEDOUBLE_MAGIC 	0x00051607L</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">-#define VERSION 			0x00020000</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+#define APPLESINGLE_MAGIC 0x00051600L</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+#define APPLEDOUBLE_MAGIC 0x00051607L</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+#define VERSION 0x00020000</span>
<a href="#l1.39"></a><span id="l1.39"> </span>
<a href="#l1.40"></a><span id="l1.40" class="difflineminus">-#define NUM_ENTRIES 		6</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+#define NUM_ENTRIES  6</span>
<a href="#l1.42"></a><span id="l1.42"> </span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">-#define ENT_DFORK   		1L</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineminus">-#define ENT_RFORK   		2L</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineminus">-#define ENT_NAME    		3L</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">-#define ENT_COMMENT 		4L</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineminus">-#define ENT_DATES   		8L</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineminus">-#define ENT_FINFO   		9L</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineminus">-#define CONVERT_TIME 		1265437696L</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+#define ENT_DFORK    1L</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+#define ENT_RFORK    2L</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+#define ENT_NAME     3L</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+#define ENT_COMMENT  4L</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+#define ENT_DATES    8L</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+#define ENT_FINFO    9L</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+#define CONVERT_TIME 1265437696L</span>
<a href="#l1.57"></a><span id="l1.57"> </span>
<a href="#l1.58"></a><span id="l1.58"> /*</span>
<a href="#l1.59"></a><span id="l1.59"> ** data type used in the encoder/decoder.</span>
<a href="#l1.60"></a><span id="l1.60"> */</span>
<a href="#l1.61"></a><span id="l1.61"> typedef struct ap_header</span>
<a href="#l1.62"></a><span id="l1.62"> {</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineminus">-	int32_t 	magic;</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineminus">-	int32_t	version;</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineminus">-	char 	fill[16];</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineminus">-	int16_t 	entries;</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineplus">+  int32_t   magic;</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineplus">+  int32_t   version;</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+  char      fill[16];</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineplus">+  int16_t   entries;</span>
<a href="#l1.71"></a><span id="l1.71"> </span>
<a href="#l1.72"></a><span id="l1.72"> } ap_header;</span>
<a href="#l1.73"></a><span id="l1.73"> </span>
<a href="#l1.74"></a><span id="l1.74"> typedef struct ap_entry</span>
<a href="#l1.75"></a><span id="l1.75"> {</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineminus">-	int32_t  id;</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineminus">-	int32_t	offset;</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineminus">-	int32_t	length;</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineminus">-	</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineplus">+  int32_t  id;</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineplus">+  int32_t  offset;</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineplus">+  int32_t  length;</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineplus">+</span>
<a href="#l1.84"></a><span id="l1.84"> } ap_entry;</span>
<a href="#l1.85"></a><span id="l1.85"> </span>
<a href="#l1.86"></a><span id="l1.86"> typedef struct ap_dates</span>
<a href="#l1.87"></a><span id="l1.87"> {</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineminus">-	int32_t create, modify, backup, access;</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineplus">+  int32_t create, modify, backup, access;</span>
<a href="#l1.90"></a><span id="l1.90"> </span>
<a href="#l1.91"></a><span id="l1.91"> } ap_dates;</span>
<a href="#l1.92"></a><span id="l1.92"> </span>
<a href="#l1.93"></a><span id="l1.93" class="difflineminus">-typedef struct myFInfo			/* the mac FInfo structure for the cross platform. */</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineminus">-{	</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineminus">-	int32_t	fdType, fdCreator;</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineminus">-	int16_t	fdFlags;</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineminus">-	int32_t	fdLocation;			/* it really should  be a pointer, but just a place-holder  */</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineminus">-	int16_t	fdFldr;	</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineplus">+typedef struct myFInfo      /* the mac FInfo structure for the cross platform. */</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineplus">+{</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineplus">+  int32_t  fdType, fdCreator;</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineplus">+  int16_t  fdFlags;</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineplus">+  int32_t  fdLocation;      /* it really should  be a pointer, but just a place-holder  */</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineplus">+  int16_t  fdFldr;</span>
<a href="#l1.105"></a><span id="l1.105"> </span>
<a href="#l1.106"></a><span id="l1.106" class="difflineminus">-}	myFInfo;</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineplus">+}  myFInfo;</span>
<a href="#l1.108"></a><span id="l1.108"> </span>
<a href="#l1.109"></a><span id="l1.109"> PR_BEGIN_EXTERN_C</span>
<a href="#l1.110"></a><span id="l1.110"> /*</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineminus">-**	string utils.</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineplus">+**  string utils.</span>
<a href="#l1.113"></a><span id="l1.113"> */</span>
<a href="#l1.114"></a><span id="l1.114"> int write_stream(appledouble_encode_object *p_ap_encode_obj, const char *s,int len);</span>
<a href="#l1.115"></a><span id="l1.115"> </span>
<a href="#l1.116"></a><span id="l1.116"> int fill_apple_mime_header(appledouble_encode_object *p_ap_encode_obj);</span>
<a href="#l1.117"></a><span id="l1.117"> int ap_encode_file_infor(appledouble_encode_object *p_ap_encode_obj);</span>
<a href="#l1.118"></a><span id="l1.118"> int ap_encode_header(appledouble_encode_object* p_ap_encode_obj, bool firstTime);</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineminus">-int ap_encode_data(  appledouble_encode_object* p_ap_encode_obj, bool firstTime);</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineplus">+int ap_encode_data(appledouble_encode_object* p_ap_encode_obj, bool firstTime);</span>
<a href="#l1.121"></a><span id="l1.121"> </span>
<a href="#l1.122"></a><span id="l1.122"> /*</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineminus">-**	the prototypes for the ap_decoder.</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineplus">+**  the prototypes for the ap_decoder.</span>
<a href="#l1.125"></a><span id="l1.125"> */</span>
<a href="#l1.126"></a><span id="l1.126"> int  fetch_a_line(appledouble_decode_object* p_ap_decode_obj, char *buff);</span>
<a href="#l1.127"></a><span id="l1.127"> int  ParseFileHeader(appledouble_decode_object* p_ap_decode_obj);</span>
<a href="#l1.128"></a><span id="l1.128"> int  ap_seek_part_start(appledouble_decode_object* p_ap_decode_obj);</span>
<a href="#l1.129"></a><span id="l1.129"> void parse_param(char *p, char **param, char**define, char **np);</span>
<a href="#l1.130"></a><span id="l1.130"> int  ap_seek_to_boundary(appledouble_decode_object* p_ap_decode_obj, bool firstime);</span>
<a href="#l1.131"></a><span id="l1.131"> int  ap_parse_header(appledouble_decode_object* p_ap_decode_obj,bool firstime);</span>
<a href="#l1.132"></a><span id="l1.132"> int  ap_decode_file_infor(appledouble_decode_object* p_ap_decode_obj);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgAppleDoubleEncode.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgAppleDoubleEncode.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1,54 +1,54 @@</span>
<a href="#l2.4"></a><span id="l2.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l2.5"></a><span id="l2.5">  *</span>
<a href="#l2.6"></a><span id="l2.6">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.7"></a><span id="l2.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.8"></a><span id="l2.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10"> /*</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineminus">-*</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-*   apple-double.c</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-*	--------------</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-*</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-*  	  The codes to do apple double encoding/decoding.</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-*		</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-*		02aug95		mym		created.</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">-*		</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-*/</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+ *</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+ *  apple-double.c</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+ *  --------------</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+ *</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+ *  The codes to do apple double encoding/decoding.</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+ *</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+ *  02aug95  mym  created.</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+ *</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+ */</span>
<a href="#l2.29"></a><span id="l2.29"> #include &quot;nsID.h&quot;</span>
<a href="#l2.30"></a><span id="l2.30"> #include &quot;nscore.h&quot;</span>
<a href="#l2.31"></a><span id="l2.31"> #include &quot;nsString.h&quot;</span>
<a href="#l2.32"></a><span id="l2.32"> #include &quot;nsMsgAppleDouble.h&quot;</span>
<a href="#l2.33"></a><span id="l2.33"> #include &quot;nsMsgAppleCodes.h&quot;</span>
<a href="#l2.34"></a><span id="l2.34"> #include &quot;nsMsgCompUtils.h&quot;</span>
<a href="#l2.35"></a><span id="l2.35"> #include &quot;nsCExternalHandlerService.h&quot;</span>
<a href="#l2.36"></a><span id="l2.36"> #include &quot;nsIMIMEService.h&quot;</span>
<a href="#l2.37"></a><span id="l2.37"> #include &quot;nsMimeTypes.h&quot;</span>
<a href="#l2.38"></a><span id="l2.38"> #include &quot;prmem.h&quot;</span>
<a href="#l2.39"></a><span id="l2.39"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l2.40"></a><span id="l2.40"> </span>
<a href="#l2.41"></a><span id="l2.41"> </span>
<a href="#l2.42"></a><span id="l2.42" class="difflineminus">-void	</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineminus">-MacGetFileType(nsIFile   *fs,</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-               bool         *useDefault,</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineminus">-               char         **fileType,</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineminus">-               char         **encoding)</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+void</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+MacGetFileType(nsIFile *fs,</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+               bool    *useDefault,</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+               char    **fileType,</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+               char    **encoding)</span>
<a href="#l2.52"></a><span id="l2.52"> {</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-	if ((fs == NULL) || (fileType == NULL) || (encoding == NULL))</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineminus">-		return;</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+  if ((fs == NULL) || (fileType == NULL) || (encoding == NULL))</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+    return;</span>
<a href="#l2.57"></a><span id="l2.57"> </span>
<a href="#l2.58"></a><span id="l2.58">   bool exists = false;</span>
<a href="#l2.59"></a><span id="l2.59">   fs-&gt;Exists(&amp;exists);</span>
<a href="#l2.60"></a><span id="l2.60">   if (!exists)</span>
<a href="#l2.61"></a><span id="l2.61">     return;</span>
<a href="#l2.62"></a><span id="l2.62"> </span>
<a href="#l2.63"></a><span id="l2.63" class="difflineminus">-	*useDefault = TRUE;</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineminus">-	*fileType = NULL;</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineminus">-	*encoding = NULL;</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+  *useDefault = TRUE;</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+  *fileType = NULL;</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+  *encoding = NULL;</span>
<a href="#l2.69"></a><span id="l2.69"> </span>
<a href="#l2.70"></a><span id="l2.70">   nsCOMPtr&lt;nsILocalFileMac&gt; macFile = do_QueryInterface(fs);</span>
<a href="#l2.71"></a><span id="l2.71">   FSRef fsRef;</span>
<a href="#l2.72"></a><span id="l2.72">   FSCatalogInfo catalogInfo;</span>
<a href="#l2.73"></a><span id="l2.73">   OSErr err = errFileOpen;</span>
<a href="#l2.74"></a><span id="l2.74">   if (NS_SUCCEEDED(macFile-&gt;GetFSRef(&amp;fsRef)))</span>
<a href="#l2.75"></a><span id="l2.75">     err = ::FSGetCatalogInfo(&amp;fsRef, kFSCatInfoFinderInfo, &amp;catalogInfo, nullptr, nullptr, nullptr);</span>
<a href="#l2.76"></a><span id="l2.76"> </span>
<a href="#l2.77"></a><span id="l2.77" class="difflineat">@@ -57,17 +57,17 @@ MacGetFileType(nsIFile   *fs,</span>
<a href="#l2.78"></a><span id="l2.78">   else</span>
<a href="#l2.79"></a><span id="l2.79">   {</span>
<a href="#l2.80"></a><span id="l2.80">     // At this point, we should call the mime service and</span>
<a href="#l2.81"></a><span id="l2.81">     // see what we can find out?</span>
<a href="#l2.82"></a><span id="l2.82">     nsresult      rv;</span>
<a href="#l2.83"></a><span id="l2.83">     nsCOMPtr &lt;nsIURI&gt; tURI;</span>
<a href="#l2.84"></a><span id="l2.84">     if (NS_SUCCEEDED(NS_NewFileURI(getter_AddRefs(tURI), fs)) &amp;&amp; tURI)</span>
<a href="#l2.85"></a><span id="l2.85">     {</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineminus">-      nsCOMPtr&lt;nsIMIMEService&gt; mimeFinder (do_GetService(NS_MIMESERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+      nsCOMPtr&lt;nsIMIMEService&gt; mimeFinder(do_GetService(NS_MIMESERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l2.88"></a><span id="l2.88">       if (NS_SUCCEEDED(rv) &amp;&amp; mimeFinder)</span>
<a href="#l2.89"></a><span id="l2.89">       {</span>
<a href="#l2.90"></a><span id="l2.90">         nsAutoCString mimeType;</span>
<a href="#l2.91"></a><span id="l2.91">         rv = mimeFinder-&gt;GetTypeFromURI(tURI, mimeType);</span>
<a href="#l2.92"></a><span id="l2.92">         if (NS_SUCCEEDED(rv))</span>
<a href="#l2.93"></a><span id="l2.93">         {</span>
<a href="#l2.94"></a><span id="l2.94">           *fileType = ToNewCString(mimeType);</span>
<a href="#l2.95"></a><span id="l2.95">           return;</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineat">@@ -78,189 +78,189 @@ MacGetFileType(nsIFile   *fs,</span>
<a href="#l2.97"></a><span id="l2.97">     // If we hit here, return something...default to this...</span>
<a href="#l2.98"></a><span id="l2.98">     *fileType = strdup(APPLICATION_OCTET_STREAM);</span>
<a href="#l2.99"></a><span id="l2.99">   }</span>
<a href="#l2.100"></a><span id="l2.100"> }</span>
<a href="#l2.101"></a><span id="l2.101"> </span>
<a href="#l2.102"></a><span id="l2.102"> //#pragma cplusplus reset</span>
<a href="#l2.103"></a><span id="l2.103"> </span>
<a href="#l2.104"></a><span id="l2.104"> /*</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineminus">-*	ap_encode_init</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineminus">-*	--------------</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineminus">-*	</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineminus">-*	Setup the encode envirment</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineminus">-*/</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineplus">+ *  ap_encode_init</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineplus">+ *  --------------</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineplus">+ *</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineplus">+ *  Setup the encode envirment</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineplus">+ */</span>
<a href="#l2.115"></a><span id="l2.115"> </span>
<a href="#l2.116"></a><span id="l2.116" class="difflineminus">-int ap_encode_init( appledouble_encode_object *p_ap_encode_obj,</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineminus">-                    const char                *fname,</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineminus">-                    char                      *separator)</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineplus">+int ap_encode_init(appledouble_encode_object *p_ap_encode_obj,</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineplus">+                   const char                *fname,</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineplus">+                   char                      *separator)</span>
<a href="#l2.122"></a><span id="l2.122"> {</span>
<a href="#l2.123"></a><span id="l2.123">   nsCOMPtr &lt;nsIFile&gt; myFile;</span>
<a href="#l2.124"></a><span id="l2.124">   NS_NewNativeLocalFile(nsDependentCString(fname), true, getter_AddRefs(myFile));</span>
<a href="#l2.125"></a><span id="l2.125">   bool exists;</span>
<a href="#l2.126"></a><span id="l2.126">   if (myFile &amp;&amp; NS_SUCCEEDED(myFile-&gt;Exists(&amp;exists)) &amp;&amp; !exists)</span>
<a href="#l2.127"></a><span id="l2.127">     return -1;</span>
<a href="#l2.128"></a><span id="l2.128"> </span>
<a href="#l2.129"></a><span id="l2.129">   nsCOMPtr&lt;nsILocalFileMac&gt; macFile = do_QueryInterface(myFile);</span>
<a href="#l2.130"></a><span id="l2.130">   nsAutoCString path;</span>
<a href="#l2.131"></a><span id="l2.131">   macFile-&gt;GetNativePath(path);</span>
<a href="#l2.132"></a><span id="l2.132"> </span>
<a href="#l2.133"></a><span id="l2.133" class="difflineminus">-	memset(p_ap_encode_obj, 0, sizeof(appledouble_encode_object));</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineminus">-	</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineminus">-	/*</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineminus">-	**	Fill out the source file inforamtion.</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineminus">-	*/	</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineplus">+  memset(p_ap_encode_obj, 0, sizeof(appledouble_encode_object));</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineplus">+</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineplus">+  /*</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineplus">+  **  Fill out the source file inforamtion.</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineplus">+  */</span>
<a href="#l2.143"></a><span id="l2.143">   memcpy(p_ap_encode_obj-&gt;fname, path.get(), path.Length());</span>
<a href="#l2.144"></a><span id="l2.144">   p_ap_encode_obj-&gt;fname[path.Length()] = '\0';</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineminus">-	</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineminus">-	p_ap_encode_obj-&gt;boundary = strdup(separator);</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineminus">-	return noErr;</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineplus">+</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineplus">+  p_ap_encode_obj-&gt;boundary = strdup(separator);</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineplus">+  return noErr;</span>
<a href="#l2.151"></a><span id="l2.151"> }</span>
<a href="#l2.152"></a><span id="l2.152"> </span>
<a href="#l2.153"></a><span id="l2.153"> /*</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineminus">-**	ap_encode_next</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineminus">-**	--------------</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineminus">-**		</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineminus">-**		return :</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineminus">-**			noErr	:	everything is ok</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineminus">-**			errDone	:	when encoding is done.</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineminus">-**			errors	:	otherwise.</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineplus">+**  ap_encode_next</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineplus">+**  --------------</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineplus">+**</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineplus">+**  return :</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineplus">+**  noErr  :  everything is ok</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineplus">+**  errDone:  when encoding is done.</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineplus">+**  errors :  otherwise.</span>
<a href="#l2.168"></a><span id="l2.168"> */</span>
<a href="#l2.169"></a><span id="l2.169"> int ap_encode_next(</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineminus">-	appledouble_encode_object* p_ap_encode_obj,</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineminus">-	char 	*to_buff,</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineminus">-	int32_t 	buff_size,</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineminus">-	int32_t* 	real_size)</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineplus">+  appledouble_encode_object* p_ap_encode_obj,</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineplus">+  char     *to_buff,</span>
<a href="#l2.176"></a><span id="l2.176" class="difflineplus">+  int32_t  buff_size,</span>
<a href="#l2.177"></a><span id="l2.177" class="difflineplus">+  int32_t* real_size)</span>
<a href="#l2.178"></a><span id="l2.178"> {</span>
<a href="#l2.179"></a><span id="l2.179" class="difflineminus">-	int status;</span>
<a href="#l2.180"></a><span id="l2.180" class="difflineminus">-	</span>
<a href="#l2.181"></a><span id="l2.181" class="difflineminus">-	/*</span>
<a href="#l2.182"></a><span id="l2.182" class="difflineminus">-	** 	install the out buff now.</span>
<a href="#l2.183"></a><span id="l2.183" class="difflineminus">-	*/</span>
<a href="#l2.184"></a><span id="l2.184" class="difflineminus">-	p_ap_encode_obj-&gt;outbuff     = to_buff;</span>
<a href="#l2.185"></a><span id="l2.185" class="difflineminus">-	p_ap_encode_obj-&gt;s_outbuff 	 = buff_size;</span>
<a href="#l2.186"></a><span id="l2.186" class="difflineminus">-	p_ap_encode_obj-&gt;pos_outbuff = 0;</span>
<a href="#l2.187"></a><span id="l2.187" class="difflineminus">-	</span>
<a href="#l2.188"></a><span id="l2.188" class="difflineminus">-	/*</span>
<a href="#l2.189"></a><span id="l2.189" class="difflineminus">-	**	first copy the outstandind data in the overflow buff to the out buffer.</span>
<a href="#l2.190"></a><span id="l2.190" class="difflineminus">-	*/</span>
<a href="#l2.191"></a><span id="l2.191" class="difflineminus">-	if (p_ap_encode_obj-&gt;s_overflow)</span>
<a href="#l2.192"></a><span id="l2.192" class="difflineminus">-	{</span>
<a href="#l2.193"></a><span id="l2.193" class="difflineminus">-		status = write_stream(p_ap_encode_obj,</span>
<a href="#l2.194"></a><span id="l2.194" class="difflineminus">-		                      (const char*)(p_ap_encode_obj-&gt;b_overflow),</span>
<a href="#l2.195"></a><span id="l2.195" class="difflineminus">-		                      p_ap_encode_obj-&gt;s_overflow);</span>
<a href="#l2.196"></a><span id="l2.196" class="difflineminus">-		if (status != noErr)</span>
<a href="#l2.197"></a><span id="l2.197" class="difflineminus">-			return status;</span>
<a href="#l2.198"></a><span id="l2.198" class="difflineminus">-				</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineminus">-		p_ap_encode_obj-&gt;s_overflow = 0;</span>
<a href="#l2.200"></a><span id="l2.200" class="difflineminus">-	}</span>
<a href="#l2.201"></a><span id="l2.201" class="difflineplus">+  int status;</span>
<a href="#l2.202"></a><span id="l2.202" class="difflineplus">+</span>
<a href="#l2.203"></a><span id="l2.203" class="difflineplus">+  /*</span>
<a href="#l2.204"></a><span id="l2.204" class="difflineplus">+  **   install the out buff now.</span>
<a href="#l2.205"></a><span id="l2.205" class="difflineplus">+  */</span>
<a href="#l2.206"></a><span id="l2.206" class="difflineplus">+  p_ap_encode_obj-&gt;outbuff = to_buff;</span>
<a href="#l2.207"></a><span id="l2.207" class="difflineplus">+  p_ap_encode_obj-&gt;s_outbuff = buff_size;</span>
<a href="#l2.208"></a><span id="l2.208" class="difflineplus">+  p_ap_encode_obj-&gt;pos_outbuff = 0;</span>
<a href="#l2.209"></a><span id="l2.209" class="difflineplus">+</span>
<a href="#l2.210"></a><span id="l2.210" class="difflineplus">+  /*</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineplus">+  **  first copy the outstandind data in the overflow buff to the out buffer.</span>
<a href="#l2.212"></a><span id="l2.212" class="difflineplus">+  */</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineplus">+  if (p_ap_encode_obj-&gt;s_overflow)</span>
<a href="#l2.214"></a><span id="l2.214" class="difflineplus">+  {</span>
<a href="#l2.215"></a><span id="l2.215" class="difflineplus">+    status = write_stream(p_ap_encode_obj,</span>
<a href="#l2.216"></a><span id="l2.216" class="difflineplus">+                          (const char*)(p_ap_encode_obj-&gt;b_overflow),</span>
<a href="#l2.217"></a><span id="l2.217" class="difflineplus">+                          p_ap_encode_obj-&gt;s_overflow);</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineplus">+    if (status != noErr)</span>
<a href="#l2.219"></a><span id="l2.219" class="difflineplus">+      return status;</span>
<a href="#l2.220"></a><span id="l2.220" class="difflineplus">+</span>
<a href="#l2.221"></a><span id="l2.221" class="difflineplus">+    p_ap_encode_obj-&gt;s_overflow = 0;</span>
<a href="#l2.222"></a><span id="l2.222" class="difflineplus">+  }</span>
<a href="#l2.223"></a><span id="l2.223" class="difflineplus">+</span>
<a href="#l2.224"></a><span id="l2.224" class="difflineplus">+  /*</span>
<a href="#l2.225"></a><span id="l2.225" class="difflineplus">+  ** go the next processing stage based on the current state.</span>
<a href="#l2.226"></a><span id="l2.226" class="difflineplus">+  */</span>
<a href="#l2.227"></a><span id="l2.227" class="difflineplus">+  switch (p_ap_encode_obj-&gt;state)</span>
<a href="#l2.228"></a><span id="l2.228" class="difflineplus">+  {</span>
<a href="#l2.229"></a><span id="l2.229" class="difflineplus">+    case kInit:</span>
<a href="#l2.230"></a><span id="l2.230" class="difflineplus">+      /*</span>
<a href="#l2.231"></a><span id="l2.231" class="difflineplus">+      ** We are in the  starting position, fill out the header.</span>
<a href="#l2.232"></a><span id="l2.232" class="difflineplus">+      */</span>
<a href="#l2.233"></a><span id="l2.233" class="difflineplus">+      status = fill_apple_mime_header(p_ap_encode_obj);</span>
<a href="#l2.234"></a><span id="l2.234" class="difflineplus">+      if (status != noErr)</span>
<a href="#l2.235"></a><span id="l2.235" class="difflineplus">+        break;          /* some error happens */</span>
<a href="#l2.236"></a><span id="l2.236" class="difflineplus">+</span>
<a href="#l2.237"></a><span id="l2.237" class="difflineplus">+      p_ap_encode_obj-&gt;state = kDoingHeaderPortion;</span>
<a href="#l2.238"></a><span id="l2.238" class="difflineplus">+      status = ap_encode_header(p_ap_encode_obj, true);</span>
<a href="#l2.239"></a><span id="l2.239" class="difflineplus">+                    /* it is the first time to calling     */</span>
<a href="#l2.240"></a><span id="l2.240" class="difflineplus">+      if (status == errDone)</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineplus">+      {</span>
<a href="#l2.242"></a><span id="l2.242" class="difflineplus">+        p_ap_encode_obj-&gt;state = kDoneHeaderPortion;</span>
<a href="#l2.243"></a><span id="l2.243" class="difflineplus">+      }</span>
<a href="#l2.244"></a><span id="l2.244" class="difflineplus">+      else</span>
<a href="#l2.245"></a><span id="l2.245" class="difflineplus">+      {</span>
<a href="#l2.246"></a><span id="l2.246" class="difflineplus">+        break;          /* we need more work on header portion.  */</span>
<a href="#l2.247"></a><span id="l2.247" class="difflineplus">+      }</span>
<a href="#l2.248"></a><span id="l2.248"> </span>
<a href="#l2.249"></a><span id="l2.249" class="difflineminus">-	/*</span>
<a href="#l2.250"></a><span id="l2.250" class="difflineminus">-	** go the next processing stage based on the current state.</span>
<a href="#l2.251"></a><span id="l2.251" class="difflineminus">-	*/</span>
<a href="#l2.252"></a><span id="l2.252" class="difflineminus">-	switch (p_ap_encode_obj-&gt;state)</span>
<a href="#l2.253"></a><span id="l2.253" class="difflineminus">-	{</span>
<a href="#l2.254"></a><span id="l2.254" class="difflineminus">-		case kInit:</span>
<a href="#l2.255"></a><span id="l2.255" class="difflineminus">-			/*</span>
<a href="#l2.256"></a><span id="l2.256" class="difflineminus">-			** We are in the  starting position, fill out the header.</span>
<a href="#l2.257"></a><span id="l2.257" class="difflineminus">-			*/</span>
<a href="#l2.258"></a><span id="l2.258" class="difflineminus">-			status = fill_apple_mime_header(p_ap_encode_obj);</span>
<a href="#l2.259"></a><span id="l2.259" class="difflineminus">-			if (status != noErr)</span>
<a href="#l2.260"></a><span id="l2.260" class="difflineminus">-				break;					/* some error happens */</span>
<a href="#l2.261"></a><span id="l2.261" class="difflineminus">-				</span>
<a href="#l2.262"></a><span id="l2.262" class="difflineminus">-			p_ap_encode_obj-&gt;state = kDoingHeaderPortion;</span>
<a href="#l2.263"></a><span id="l2.263" class="difflineminus">-			status = ap_encode_header(p_ap_encode_obj, true);</span>
<a href="#l2.264"></a><span id="l2.264" class="difflineminus">-										/* it is the first time to calling 		*/							</span>
<a href="#l2.265"></a><span id="l2.265" class="difflineminus">-			if (status == errDone)</span>
<a href="#l2.266"></a><span id="l2.266" class="difflineminus">-			{</span>
<a href="#l2.267"></a><span id="l2.267" class="difflineminus">-				p_ap_encode_obj-&gt;state = kDoneHeaderPortion;</span>
<a href="#l2.268"></a><span id="l2.268" class="difflineminus">-			}</span>
<a href="#l2.269"></a><span id="l2.269" class="difflineminus">-			else</span>
<a href="#l2.270"></a><span id="l2.270" class="difflineminus">-			{</span>
<a href="#l2.271"></a><span id="l2.271" class="difflineminus">-				break;					/* we need more work on header portion.	*/</span>
<a href="#l2.272"></a><span id="l2.272" class="difflineminus">-			}			</span>
<a href="#l2.273"></a><span id="l2.273" class="difflineminus">-				</span>
<a href="#l2.274"></a><span id="l2.274" class="difflineminus">-			/*</span>
<a href="#l2.275"></a><span id="l2.275" class="difflineminus">-			** we are done with the header, so let's go to the data port.</span>
<a href="#l2.276"></a><span id="l2.276" class="difflineminus">-			*/</span>
<a href="#l2.277"></a><span id="l2.277" class="difflineminus">-			p_ap_encode_obj-&gt;state = kDoingDataPortion;</span>
<a href="#l2.278"></a><span id="l2.278" class="difflineminus">-			status = ap_encode_data(p_ap_encode_obj, true);		 	</span>
<a href="#l2.279"></a><span id="l2.279" class="difflineminus">-										/* it is first time call do data portion */</span>
<a href="#l2.280"></a><span id="l2.280" class="difflineminus">-							</span>
<a href="#l2.281"></a><span id="l2.281" class="difflineminus">-			if (status == errDone)</span>
<a href="#l2.282"></a><span id="l2.282" class="difflineminus">-			{</span>
<a href="#l2.283"></a><span id="l2.283" class="difflineminus">-				p_ap_encode_obj-&gt;state  = kDoneDataPortion;</span>
<a href="#l2.284"></a><span id="l2.284" class="difflineminus">-				status = noErr;</span>
<a href="#l2.285"></a><span id="l2.285" class="difflineminus">-			}</span>
<a href="#l2.286"></a><span id="l2.286" class="difflineminus">-			break;</span>
<a href="#l2.287"></a><span id="l2.287" class="difflineplus">+      /*</span>
<a href="#l2.288"></a><span id="l2.288" class="difflineplus">+      ** we are done with the header, so let's go to the data port.</span>
<a href="#l2.289"></a><span id="l2.289" class="difflineplus">+      */</span>
<a href="#l2.290"></a><span id="l2.290" class="difflineplus">+      p_ap_encode_obj-&gt;state = kDoingDataPortion;</span>
<a href="#l2.291"></a><span id="l2.291" class="difflineplus">+      status = ap_encode_data(p_ap_encode_obj, true);     </span>
<a href="#l2.292"></a><span id="l2.292" class="difflineplus">+                    /* it is first time call do data portion */</span>
<a href="#l2.293"></a><span id="l2.293" class="difflineplus">+</span>
<a href="#l2.294"></a><span id="l2.294" class="difflineplus">+      if (status == errDone)</span>
<a href="#l2.295"></a><span id="l2.295" class="difflineplus">+      {</span>
<a href="#l2.296"></a><span id="l2.296" class="difflineplus">+        p_ap_encode_obj-&gt;state  = kDoneDataPortion;</span>
<a href="#l2.297"></a><span id="l2.297" class="difflineplus">+        status = noErr;</span>
<a href="#l2.298"></a><span id="l2.298" class="difflineplus">+      }</span>
<a href="#l2.299"></a><span id="l2.299" class="difflineplus">+      break;</span>
<a href="#l2.300"></a><span id="l2.300" class="difflineplus">+</span>
<a href="#l2.301"></a><span id="l2.301" class="difflineplus">+    case kDoingHeaderPortion:</span>
<a href="#l2.302"></a><span id="l2.302" class="difflineplus">+</span>
<a href="#l2.303"></a><span id="l2.303" class="difflineplus">+      status = ap_encode_header(p_ap_encode_obj, false); </span>
<a href="#l2.304"></a><span id="l2.304" class="difflineplus">+                    /* continue with the header portion.  */</span>
<a href="#l2.305"></a><span id="l2.305" class="difflineplus">+      if (status == errDone)</span>
<a href="#l2.306"></a><span id="l2.306" class="difflineplus">+      {</span>
<a href="#l2.307"></a><span id="l2.307" class="difflineplus">+        p_ap_encode_obj-&gt;state = kDoneHeaderPortion;</span>
<a href="#l2.308"></a><span id="l2.308" class="difflineplus">+      }</span>
<a href="#l2.309"></a><span id="l2.309" class="difflineplus">+      else</span>
<a href="#l2.310"></a><span id="l2.310" class="difflineplus">+      {</span>
<a href="#l2.311"></a><span id="l2.311" class="difflineplus">+        break;          /* we need more work on header portion.  */</span>
<a href="#l2.312"></a><span id="l2.312" class="difflineplus">+      }</span>
<a href="#l2.313"></a><span id="l2.313"> </span>
<a href="#l2.314"></a><span id="l2.314" class="difflineminus">-		case kDoingHeaderPortion:</span>
<a href="#l2.315"></a><span id="l2.315" class="difflineminus">-		</span>
<a href="#l2.316"></a><span id="l2.316" class="difflineminus">-			status = ap_encode_header(p_ap_encode_obj, false); 			</span>
<a href="#l2.317"></a><span id="l2.317" class="difflineminus">-										/* continue with the header portion.	*/</span>
<a href="#l2.318"></a><span id="l2.318" class="difflineminus">-			if (status == errDone)</span>
<a href="#l2.319"></a><span id="l2.319" class="difflineminus">-			{</span>
<a href="#l2.320"></a><span id="l2.320" class="difflineminus">-				p_ap_encode_obj-&gt;state = kDoneHeaderPortion;</span>
<a href="#l2.321"></a><span id="l2.321" class="difflineminus">-			}</span>
<a href="#l2.322"></a><span id="l2.322" class="difflineminus">-			else</span>
<a href="#l2.323"></a><span id="l2.323" class="difflineminus">-			{</span>
<a href="#l2.324"></a><span id="l2.324" class="difflineminus">-				break;					/* we need more work on header portion.	*/				</span>
<a href="#l2.325"></a><span id="l2.325" class="difflineminus">-			}</span>
<a href="#l2.326"></a><span id="l2.326" class="difflineminus">-			</span>
<a href="#l2.327"></a><span id="l2.327" class="difflineminus">-			/*</span>
<a href="#l2.328"></a><span id="l2.328" class="difflineminus">-			** start the data portion.</span>
<a href="#l2.329"></a><span id="l2.329" class="difflineminus">-			*/</span>
<a href="#l2.330"></a><span id="l2.330" class="difflineminus">-			p_ap_encode_obj-&gt;state = kDoingDataPortion;</span>
<a href="#l2.331"></a><span id="l2.331" class="difflineminus">-			status = ap_encode_data(p_ap_encode_obj, true); 					</span>
<a href="#l2.332"></a><span id="l2.332" class="difflineminus">-										/* it is the first time calling 		*/</span>
<a href="#l2.333"></a><span id="l2.333" class="difflineminus">-			if (status == errDone)</span>
<a href="#l2.334"></a><span id="l2.334" class="difflineminus">-			{</span>
<a href="#l2.335"></a><span id="l2.335" class="difflineminus">-				p_ap_encode_obj-&gt;state  = kDoneDataPortion;</span>
<a href="#l2.336"></a><span id="l2.336" class="difflineminus">-				status = noErr;</span>
<a href="#l2.337"></a><span id="l2.337" class="difflineminus">-			}</span>
<a href="#l2.338"></a><span id="l2.338" class="difflineminus">-			break;</span>
<a href="#l2.339"></a><span id="l2.339" class="difflineplus">+      /*</span>
<a href="#l2.340"></a><span id="l2.340" class="difflineplus">+      ** start the data portion.</span>
<a href="#l2.341"></a><span id="l2.341" class="difflineplus">+      */</span>
<a href="#l2.342"></a><span id="l2.342" class="difflineplus">+      p_ap_encode_obj-&gt;state = kDoingDataPortion;</span>
<a href="#l2.343"></a><span id="l2.343" class="difflineplus">+      status = ap_encode_data(p_ap_encode_obj, true); </span>
<a href="#l2.344"></a><span id="l2.344" class="difflineplus">+                    /* it is the first time calling     */</span>
<a href="#l2.345"></a><span id="l2.345" class="difflineplus">+      if (status == errDone)</span>
<a href="#l2.346"></a><span id="l2.346" class="difflineplus">+      {</span>
<a href="#l2.347"></a><span id="l2.347" class="difflineplus">+        p_ap_encode_obj-&gt;state  = kDoneDataPortion;</span>
<a href="#l2.348"></a><span id="l2.348" class="difflineplus">+        status = noErr;</span>
<a href="#l2.349"></a><span id="l2.349" class="difflineplus">+      }</span>
<a href="#l2.350"></a><span id="l2.350" class="difflineplus">+      break;</span>
<a href="#l2.351"></a><span id="l2.351" class="difflineplus">+</span>
<a href="#l2.352"></a><span id="l2.352" class="difflineplus">+    case kDoingDataPortion:</span>
<a href="#l2.353"></a><span id="l2.353"> </span>
<a href="#l2.354"></a><span id="l2.354" class="difflineminus">-		case kDoingDataPortion:</span>
<a href="#l2.355"></a><span id="l2.355" class="difflineminus">-		</span>
<a href="#l2.356"></a><span id="l2.356" class="difflineminus">-			status = ap_encode_data(p_ap_encode_obj, false); 				</span>
<a href="#l2.357"></a><span id="l2.357" class="difflineminus">-										/* it is not the first time				*/</span>
<a href="#l2.358"></a><span id="l2.358" class="difflineminus">-													</span>
<a href="#l2.359"></a><span id="l2.359" class="difflineminus">-			if (status == errDone)</span>
<a href="#l2.360"></a><span id="l2.360" class="difflineminus">-			{</span>
<a href="#l2.361"></a><span id="l2.361" class="difflineminus">-				p_ap_encode_obj-&gt;state = kDoneDataPortion;</span>
<a href="#l2.362"></a><span id="l2.362" class="difflineminus">-				status = noErr;</span>
<a href="#l2.363"></a><span id="l2.363" class="difflineminus">-			}</span>
<a href="#l2.364"></a><span id="l2.364" class="difflineminus">-			break;</span>
<a href="#l2.365"></a><span id="l2.365" class="difflineplus">+      status = ap_encode_data(p_ap_encode_obj, false); </span>
<a href="#l2.366"></a><span id="l2.366" class="difflineplus">+                    /* it is not the first time        */</span>
<a href="#l2.367"></a><span id="l2.367"> </span>
<a href="#l2.368"></a><span id="l2.368" class="difflineminus">-		case kDoneDataPortion:</span>
<a href="#l2.369"></a><span id="l2.369" class="difflineminus">-				status = errDone;		/* we are really done.					*/</span>
<a href="#l2.370"></a><span id="l2.370" class="difflineplus">+      if (status == errDone)</span>
<a href="#l2.371"></a><span id="l2.371" class="difflineplus">+      {</span>
<a href="#l2.372"></a><span id="l2.372" class="difflineplus">+        p_ap_encode_obj-&gt;state = kDoneDataPortion;</span>
<a href="#l2.373"></a><span id="l2.373" class="difflineplus">+        status = noErr;</span>
<a href="#l2.374"></a><span id="l2.374" class="difflineplus">+      }</span>
<a href="#l2.375"></a><span id="l2.375" class="difflineplus">+      break;</span>
<a href="#l2.376"></a><span id="l2.376"> </span>
<a href="#l2.377"></a><span id="l2.377" class="difflineminus">-			break;</span>
<a href="#l2.378"></a><span id="l2.378" class="difflineminus">-	}</span>
<a href="#l2.379"></a><span id="l2.379" class="difflineminus">-	</span>
<a href="#l2.380"></a><span id="l2.380" class="difflineminus">-	*real_size = p_ap_encode_obj-&gt;pos_outbuff;</span>
<a href="#l2.381"></a><span id="l2.381" class="difflineminus">-	return status;</span>
<a href="#l2.382"></a><span id="l2.382" class="difflineplus">+    case kDoneDataPortion:</span>
<a href="#l2.383"></a><span id="l2.383" class="difflineplus">+      status = errDone;    /* we are really done.          */</span>
<a href="#l2.384"></a><span id="l2.384" class="difflineplus">+</span>
<a href="#l2.385"></a><span id="l2.385" class="difflineplus">+      break;</span>
<a href="#l2.386"></a><span id="l2.386" class="difflineplus">+  }</span>
<a href="#l2.387"></a><span id="l2.387" class="difflineplus">+</span>
<a href="#l2.388"></a><span id="l2.388" class="difflineplus">+  *real_size = p_ap_encode_obj-&gt;pos_outbuff;</span>
<a href="#l2.389"></a><span id="l2.389" class="difflineplus">+  return status;</span>
<a href="#l2.390"></a><span id="l2.390"> }</span>
<a href="#l2.391"></a><span id="l2.391"> </span>
<a href="#l2.392"></a><span id="l2.392"> /*</span>
<a href="#l2.393"></a><span id="l2.393" class="difflineminus">-**	ap_encode_end</span>
<a href="#l2.394"></a><span id="l2.394" class="difflineminus">-**	-------------</span>
<a href="#l2.395"></a><span id="l2.395" class="difflineplus">+**  ap_encode_end</span>
<a href="#l2.396"></a><span id="l2.396" class="difflineplus">+**  -------------</span>
<a href="#l2.397"></a><span id="l2.397"> **</span>
<a href="#l2.398"></a><span id="l2.398" class="difflineminus">-**	clear the apple encoding.</span>
<a href="#l2.399"></a><span id="l2.399" class="difflineplus">+**  clear the apple encoding.</span>
<a href="#l2.400"></a><span id="l2.400"> */</span>
<a href="#l2.401"></a><span id="l2.401"> </span>
<a href="#l2.402"></a><span id="l2.402"> int ap_encode_end(</span>
<a href="#l2.403"></a><span id="l2.403" class="difflineminus">-	appledouble_encode_object *p_ap_encode_obj,</span>
<a href="#l2.404"></a><span id="l2.404" class="difflineminus">-	bool is_aborting)</span>
<a href="#l2.405"></a><span id="l2.405" class="difflineplus">+  appledouble_encode_object *p_ap_encode_obj,</span>
<a href="#l2.406"></a><span id="l2.406" class="difflineplus">+  bool is_aborting)</span>
<a href="#l2.407"></a><span id="l2.407"> {</span>
<a href="#l2.408"></a><span id="l2.408" class="difflineminus">-	/*</span>
<a href="#l2.409"></a><span id="l2.409" class="difflineminus">-	** clear up the apple doubler.</span>
<a href="#l2.410"></a><span id="l2.410" class="difflineminus">-	*/</span>
<a href="#l2.411"></a><span id="l2.411" class="difflineminus">-	if (p_ap_encode_obj == NULL)</span>
<a href="#l2.412"></a><span id="l2.412" class="difflineminus">-		return noErr;</span>
<a href="#l2.413"></a><span id="l2.413" class="difflineplus">+  /*</span>
<a href="#l2.414"></a><span id="l2.414" class="difflineplus">+  ** clear up the apple doubler.</span>
<a href="#l2.415"></a><span id="l2.415" class="difflineplus">+  */</span>
<a href="#l2.416"></a><span id="l2.416" class="difflineplus">+  if (p_ap_encode_obj == NULL)</span>
<a href="#l2.417"></a><span id="l2.417" class="difflineplus">+    return noErr;</span>
<a href="#l2.418"></a><span id="l2.418"> </span>
<a href="#l2.419"></a><span id="l2.419" class="difflineminus">-	if (p_ap_encode_obj-&gt;fileId)			/* close the file if it is open.	*/</span>
<a href="#l2.420"></a><span id="l2.420" class="difflineplus">+  if (p_ap_encode_obj-&gt;fileId)      /* close the file if it is open.  */</span>
<a href="#l2.421"></a><span id="l2.421">     ::FSCloseFork(p_ap_encode_obj-&gt;fileId);</span>
<a href="#l2.422"></a><span id="l2.422"> </span>
<a href="#l2.423"></a><span id="l2.423" class="difflineminus">-	PR_FREEIF(p_ap_encode_obj-&gt;boundary);		/* the boundary string.				*/</span>
<a href="#l2.424"></a><span id="l2.424" class="difflineminus">-	</span>
<a href="#l2.425"></a><span id="l2.425" class="difflineminus">-	return noErr;</span>
<a href="#l2.426"></a><span id="l2.426" class="difflineplus">+  PR_FREEIF(p_ap_encode_obj-&gt;boundary);    /* the boundary string.        */</span>
<a href="#l2.427"></a><span id="l2.427" class="difflineplus">+</span>
<a href="#l2.428"></a><span id="l2.428" class="difflineplus">+  return noErr;</span>
<a href="#l2.429"></a><span id="l2.429"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgAppleEncode.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgAppleEncode.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -2,703 +2,702 @@</span>
<a href="#l3.4"></a><span id="l3.4">  *</span>
<a href="#l3.5"></a><span id="l3.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.6"></a><span id="l3.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.7"></a><span id="l3.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9"> /*</span>
<a href="#l3.10"></a><span id="l3.10">  *</span>
<a href="#l3.11"></a><span id="l3.11">  *   apple_double_encode.c</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">- *	 ---------------------</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+ *   ---------------------</span>
<a href="#l3.14"></a><span id="l3.14">  *</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">- *    The routines doing the Apple Double Encoding.</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">- *		</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">- *			2aug95	mym	Created.</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">- *		</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+ *   The routines doing the Apple Double Encoding.</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+ *</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+ *   2aug95  mym  Created.</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+ *</span>
<a href="#l3.23"></a><span id="l3.23">  */</span>
<a href="#l3.24"></a><span id="l3.24"> </span>
<a href="#l3.25"></a><span id="l3.25"> #include &quot;nscore.h&quot;</span>
<a href="#l3.26"></a><span id="l3.26"> #include &quot;nsString.h&quot;</span>
<a href="#l3.27"></a><span id="l3.27"> #include &quot;mozilla/ArrayUtils.h&quot;</span>
<a href="#l3.28"></a><span id="l3.28"> #include &quot;nsMimeTypes.h&quot;</span>
<a href="#l3.29"></a><span id="l3.29"> #include &quot;prprf.h&quot;</span>
<a href="#l3.30"></a><span id="l3.30"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l3.31"></a><span id="l3.31"> #include &quot;nsMsgAppleDouble.h&quot;</span>
<a href="#l3.32"></a><span id="l3.32"> #include &quot;nsMsgAppleCodes.h&quot;</span>
<a href="#l3.33"></a><span id="l3.33"> #include &quot;nsILocalFileMac.h&quot;</span>
<a href="#l3.34"></a><span id="l3.34"> </span>
<a href="#l3.35"></a><span id="l3.35"> /*</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">-**	Local Functions prototypes.</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+**  Local Functions prototypes.</span>
<a href="#l3.38"></a><span id="l3.38"> */</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineminus">-static int output64chunk( appledouble_encode_object* p_ap_encode_obj,</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">-				int c1, int c2, int c3, int pads);</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineminus">-				</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+static int output64chunk(appledouble_encode_object* p_ap_encode_obj,</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+                         int c1, int c2, int c3, int pads);</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+</span>
<a href="#l3.45"></a><span id="l3.45"> static int to64(appledouble_encode_object* p_ap_encode_obj,</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineminus">-				char	*p,</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineminus">-				int 	in_size);</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+                char *p,</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+                int  in_size);</span>
<a href="#l3.50"></a><span id="l3.50"> </span>
<a href="#l3.51"></a><span id="l3.51"> static int finish64(appledouble_encode_object* p_ap_encode_obj);</span>
<a href="#l3.52"></a><span id="l3.52"> </span>
<a href="#l3.53"></a><span id="l3.53"> </span>
<a href="#l3.54"></a><span id="l3.54" class="difflineminus">-#define BUFF_LEFT(p)	((p)-&gt;s_outbuff - (p)-&gt;pos_outbuff)	</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+#define BUFF_LEFT(p)  ((p)-&gt;s_outbuff - (p)-&gt;pos_outbuff)</span>
<a href="#l3.56"></a><span id="l3.56"> </span>
<a href="#l3.57"></a><span id="l3.57"> /*</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineminus">-**	write_stream.</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+**  write_stream.</span>
<a href="#l3.60"></a><span id="l3.60"> */</span>
<a href="#l3.61"></a><span id="l3.61"> int write_stream(</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineminus">-	appledouble_encode_object *p_ap_encode_obj,</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineminus">-	const char *out_string,</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineminus">-	int len)</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineminus">-{	</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineminus">-	if (p_ap_encode_obj-&gt;pos_outbuff + len &lt; p_ap_encode_obj-&gt;s_outbuff)</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineminus">-	{</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineminus">-		memcpy(p_ap_encode_obj-&gt;outbuff + p_ap_encode_obj-&gt;pos_outbuff,</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineminus">-		       out_string,</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineminus">-		       len);</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineminus">-		p_ap_encode_obj-&gt;pos_outbuff += len;</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineminus">-		return noErr;</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineminus">-	}</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineminus">-	else</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineminus">-	{</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineminus">-		/*</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineminus">-		**	If the buff doesn't have enough space, use the overflow buffer then.</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineminus">-		*/</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineminus">-		int s_len = p_ap_encode_obj-&gt;s_outbuff - p_ap_encode_obj-&gt;pos_outbuff;</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineminus">-		</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineminus">-		memcpy(p_ap_encode_obj-&gt;outbuff + p_ap_encode_obj-&gt;pos_outbuff,</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineminus">-		       out_string,</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineminus">-		       s_len);</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineminus">-		memcpy(p_ap_encode_obj-&gt;b_overflow + p_ap_encode_obj-&gt;s_overflow,</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineminus">-		       out_string + s_len,</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineminus">-		       p_ap_encode_obj-&gt;s_overflow += (len - s_len));</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineminus">-		p_ap_encode_obj-&gt;pos_outbuff += s_len;</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineminus">-		return errEOB;</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineminus">-	}</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineplus">+  appledouble_encode_object *p_ap_encode_obj,</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineplus">+  const char *out_string,</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+  int len)</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+{</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineplus">+  if (p_ap_encode_obj-&gt;pos_outbuff + len &lt; p_ap_encode_obj-&gt;s_outbuff)</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineplus">+  {</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineplus">+    memcpy(p_ap_encode_obj-&gt;outbuff + p_ap_encode_obj-&gt;pos_outbuff,</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+           out_string,</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineplus">+           len);</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+    p_ap_encode_obj-&gt;pos_outbuff += len;</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineplus">+    return noErr;</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineplus">+  }</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+  else</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineplus">+  {</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineplus">+    /*</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineplus">+    **  If the buff doesn't have enough space, use the overflow buffer then.</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineplus">+    */</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineplus">+    int s_len = p_ap_encode_obj-&gt;s_outbuff - p_ap_encode_obj-&gt;pos_outbuff;</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineplus">+</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineplus">+    memcpy(p_ap_encode_obj-&gt;outbuff + p_ap_encode_obj-&gt;pos_outbuff,</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineplus">+           out_string,</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineplus">+           s_len);</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineplus">+    memcpy(p_ap_encode_obj-&gt;b_overflow + p_ap_encode_obj-&gt;s_overflow,</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineplus">+           out_string + s_len,</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineplus">+           p_ap_encode_obj-&gt;s_overflow += (len - s_len));</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineplus">+    p_ap_encode_obj-&gt;pos_outbuff += s_len;</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineplus">+    return errEOB;</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineplus">+  }</span>
<a href="#l3.118"></a><span id="l3.118"> }</span>
<a href="#l3.119"></a><span id="l3.119"> </span>
<a href="#l3.120"></a><span id="l3.120"> int fill_apple_mime_header(</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineminus">-	appledouble_encode_object *p_ap_encode_obj)</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineplus">+  appledouble_encode_object *p_ap_encode_obj)</span>
<a href="#l3.123"></a><span id="l3.123"> {</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineminus">-	int  status;</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineminus">-	</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineminus">-	char tmpstr[266];</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineminus">-	</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineminus">-#if 0	</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineminus">-//	strcpy(tmpstr, &quot;Content-Type: multipart/mixed; boundary=\&quot;-\&quot;\n\n---\n&quot;);</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineminus">-//	status = write_stream(p_ap_encode_env,</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineminus">-//						tmpstr,</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineminus">-//						strlen(tmpstr));</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineminus">-//	if (status != noErr)</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineminus">-//		return status;</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineplus">+  int  status;</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineplus">+</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineplus">+  char tmpstr[266];</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineplus">+</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineplus">+#if 0</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineplus">+//  strcpy(tmpstr, &quot;Content-Type: multipart/mixed; boundary=\&quot;-\&quot;\n\n---\n&quot;);</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineplus">+//  status = write_stream(p_ap_encode_env,</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineplus">+//            tmpstr,</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineplus">+//            strlen(tmpstr));</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineplus">+//  if (status != noErr)</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineplus">+//    return status;</span>
<a href="#l3.146"></a><span id="l3.146"> </span>
<a href="#l3.147"></a><span id="l3.147" class="difflineminus">-	PR_snprintf(tmpstr, sizeof(tmpstr),</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineminus">-			&quot;Content-Type: multipart/appledouble; boundary=\&quot;=\&quot;; name=\&quot;&quot;);</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineminus">-	status = write_stream(p_ap_encode_obj, (const char*)tmpstr, strlen(tmpstr));</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineminus">-	if (status != noErr)</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineminus">-		return status;</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineminus">-		</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineminus">-	status = write_stream(p_ap_encode_obj,</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineminus">-						p_ap_encode_obj-&gt;fname,</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineminus">-						strlen(p_ap_encode_obj-&gt;fname));</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineminus">-	if (status != noErr)</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineminus">-		return status;</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineminus">-		</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineminus">-	PR_snprintf(tmpstr, sizeof(tmpstr),</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineminus">-			&quot;\&quot;\r\nContent-Disposition: inline; filename=\&quot;%s\&quot;\r\n\r\n\r\n--=\r\n&quot;,</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineminus">-			p_ap_encode_obj-&gt;fname);</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineplus">+  PR_snprintf(tmpstr, sizeof(tmpstr),</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineplus">+              &quot;Content-Type: multipart/appledouble; boundary=\&quot;=\&quot;; name=\&quot;&quot;);</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineplus">+  status = write_stream(p_ap_encode_obj, (const char*)tmpstr, strlen(tmpstr));</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineplus">+  if (status != noErr)</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineplus">+    return status;</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineplus">+</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineplus">+  status = write_stream(p_ap_encode_obj,</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineplus">+                        p_ap_encode_obj-&gt;fname,</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineplus">+                        strlen(p_ap_encode_obj-&gt;fname));</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineplus">+  if (status != noErr)</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineplus">+    return status;</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineplus">+</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineplus">+  PR_snprintf(tmpstr, sizeof(tmpstr),</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineplus">+              &quot;\&quot;\r\nContent-Disposition: inline; filename=\&quot;%s\&quot;\r\n\r\n\r\n--=\r\n&quot;,</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineplus">+              p_ap_encode_obj-&gt;fname);</span>
<a href="#l3.177"></a><span id="l3.177"> #endif /* 0 */</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineminus">-	PR_snprintf(tmpstr, sizeof(tmpstr), &quot;--%s&quot; CRLF, p_ap_encode_obj-&gt;boundary);</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineminus">-	status = write_stream(p_ap_encode_obj, (const char*)tmpstr, strlen(tmpstr));</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineminus">-	return status;</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineplus">+  PR_snprintf(tmpstr, sizeof(tmpstr), &quot;--%s&quot; CRLF, p_ap_encode_obj-&gt;boundary);</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineplus">+  status = write_stream(p_ap_encode_obj, (const char*)tmpstr, strlen(tmpstr));</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineplus">+  return status;</span>
<a href="#l3.184"></a><span id="l3.184"> }</span>
<a href="#l3.185"></a><span id="l3.185"> </span>
<a href="#l3.186"></a><span id="l3.186"> int ap_encode_file_infor(</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineminus">-	appledouble_encode_object *p_ap_encode_obj)</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineplus">+  appledouble_encode_object *p_ap_encode_obj)</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineplus">+{</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineplus">+  ap_header  head;</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineplus">+  ap_entry   entries[NUM_ENTRIES];</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineplus">+  ap_dates   dates;</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineplus">+  short      i;</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineplus">+  long       comlen;</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineplus">+  char       comment[256];</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineplus">+  int        status;</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineplus">+</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineplus">+  nsCOMPtr &lt;nsIFile&gt; resFile;</span>
<a href="#l3.199"></a><span id="l3.199" class="difflineplus">+  NS_NewNativeLocalFile(nsDependentCString(p_ap_encode_obj-&gt;fname), true,</span>
<a href="#l3.200"></a><span id="l3.200" class="difflineplus">+                        getter_AddRefs(resFile));</span>
<a href="#l3.201"></a><span id="l3.201" class="difflineplus">+  if (!resFile)</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineplus">+      return errFileOpen;</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineplus">+</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineplus">+  FSRef ref;</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineplus">+  nsCOMPtr &lt;nsILocalFileMac&gt; macFile = do_QueryInterface(resFile);</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineplus">+  if (NS_FAILED(macFile-&gt;GetFSRef(&amp;ref)))</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineplus">+      return errFileOpen;</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineplus">+</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineplus">+  FSCatalogInfo catalogInfo;</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineplus">+  if (::FSGetCatalogInfo(&amp;ref, kFSCatInfoFinderInfo, &amp;catalogInfo, nullptr, nullptr, nullptr) != noErr)</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineplus">+  {</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineplus">+    return errFileOpen;</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineplus">+  }</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineplus">+</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineplus">+  /* get a file comment, if possible */</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineplus">+#if 1</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineplus">+  // Carbon doesn't support GetWDInfo(). (Bug 555684)</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineplus">+</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineplus">+  // not sure why working directories are needed here...</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineplus">+  comlen = 0;</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineplus">+#else</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineplus">+  long     procID;</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineplus">+  procID = 0;</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineplus">+  GetWDInfo(p_ap_encode_obj-&gt;vRefNum, &amp;fpb-&gt;ioVRefNum, &amp;fpb-&gt;ioDirID, &amp;procID);</span>
<a href="#l3.225"></a><span id="l3.225" class="difflineplus">+  IOParam   vinfo;</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineplus">+  memset((void *) &amp;vinfo, '\0', sizeof (vinfo));</span>
<a href="#l3.227"></a><span id="l3.227" class="difflineplus">+  GetVolParmsInfoBuffer vp;</span>
<a href="#l3.228"></a><span id="l3.228" class="difflineplus">+  vinfo.ioCompletion  = nil;</span>
<a href="#l3.229"></a><span id="l3.229" class="difflineplus">+  vinfo.ioVRefNum   = fpb-&gt;ioVRefNum;</span>
<a href="#l3.230"></a><span id="l3.230" class="difflineplus">+  vinfo.ioBuffer     = (Ptr) &amp;vp;</span>
<a href="#l3.231"></a><span id="l3.231" class="difflineplus">+  vinfo.ioReqCount   = sizeof (vp);</span>
<a href="#l3.232"></a><span id="l3.232" class="difflineplus">+  comlen = 0;</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineplus">+  if (PBHGetVolParmsSync((HParmBlkPtr) &amp;vinfo) == noErr &amp;&amp;</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineplus">+    ((vp.vMAttrib &gt;&gt; bHasDesktopMgr) &amp; 1))</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineplus">+  {</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineplus">+    DTPBRec   dtp;</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineplus">+    memset((void *) &amp;dtp, '\0', sizeof (dtp));</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineplus">+    dtp.ioVRefNum = fpb-&gt;ioVRefNum;</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineplus">+    if (PBDTGetPath(&amp;dtp) == noErr)</span>
<a href="#l3.240"></a><span id="l3.240" class="difflineplus">+    {</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineplus">+      dtp.ioCompletion = nil;</span>
<a href="#l3.242"></a><span id="l3.242" class="difflineplus">+      dtp.ioDTBuffer = (Ptr) comment;</span>
<a href="#l3.243"></a><span id="l3.243" class="difflineplus">+      dtp.ioNamePtr  = fpb-&gt;ioNamePtr;</span>
<a href="#l3.244"></a><span id="l3.244" class="difflineplus">+      dtp.ioDirID    = fpb-&gt;ioFlParID;</span>
<a href="#l3.245"></a><span id="l3.245" class="difflineplus">+      if (PBDTGetCommentSync(&amp;dtp) == noErr)</span>
<a href="#l3.246"></a><span id="l3.246" class="difflineplus">+        comlen = dtp.ioDTActCount;</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineplus">+    }</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineplus">+  }</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineplus">+#endif /* ! 1 */</span>
<a href="#l3.250"></a><span id="l3.250" class="difflineplus">+</span>
<a href="#l3.251"></a><span id="l3.251" class="difflineplus">+  /* write header */</span>
<a href="#l3.252"></a><span id="l3.252" class="difflineplus">+//  head.magic = dfork ? APPLESINGLE_MAGIC : APPLEDOUBLE_MAGIC;</span>
<a href="#l3.253"></a><span id="l3.253" class="difflineplus">+  head.magic   = APPLEDOUBLE_MAGIC;    /* always do apple double */</span>
<a href="#l3.254"></a><span id="l3.254" class="difflineplus">+  head.version = VERSION;</span>
<a href="#l3.255"></a><span id="l3.255" class="difflineplus">+  memset(head.fill, '\0', sizeof (head.fill));</span>
<a href="#l3.256"></a><span id="l3.256" class="difflineplus">+  head.entries = NUM_ENTRIES - 1;</span>
<a href="#l3.257"></a><span id="l3.257" class="difflineplus">+  status = to64(p_ap_encode_obj,</span>
<a href="#l3.258"></a><span id="l3.258" class="difflineplus">+                (char *) &amp;head,</span>
<a href="#l3.259"></a><span id="l3.259" class="difflineplus">+                sizeof (head));</span>
<a href="#l3.260"></a><span id="l3.260" class="difflineplus">+  if (status != noErr)</span>
<a href="#l3.261"></a><span id="l3.261" class="difflineplus">+    return status;</span>
<a href="#l3.262"></a><span id="l3.262" class="difflineplus">+</span>
<a href="#l3.263"></a><span id="l3.263" class="difflineplus">+  /* write entry descriptors */</span>
<a href="#l3.264"></a><span id="l3.264" class="difflineplus">+  nsAutoCString leafname;</span>
<a href="#l3.265"></a><span id="l3.265" class="difflineplus">+  macFile-&gt;GetNativeLeafName(leafname);</span>
<a href="#l3.266"></a><span id="l3.266" class="difflineplus">+  entries[0].offset = sizeof (head) + sizeof (ap_entry) * head.entries;</span>
<a href="#l3.267"></a><span id="l3.267" class="difflineplus">+  entries[0].id   = ENT_NAME;</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineplus">+  entries[0].length = leafname.Length();</span>
<a href="#l3.269"></a><span id="l3.269" class="difflineplus">+  entries[1].id   = ENT_FINFO;</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineplus">+  entries[1].length = sizeof (FInfo) + sizeof (FXInfo);</span>
<a href="#l3.271"></a><span id="l3.271" class="difflineplus">+  entries[2].id   = ENT_DATES;</span>
<a href="#l3.272"></a><span id="l3.272" class="difflineplus">+  entries[2].length = sizeof (ap_dates);</span>
<a href="#l3.273"></a><span id="l3.273" class="difflineplus">+  entries[3].id   = ENT_COMMENT;</span>
<a href="#l3.274"></a><span id="l3.274" class="difflineplus">+  entries[3].length = comlen;</span>
<a href="#l3.275"></a><span id="l3.275" class="difflineplus">+  entries[4].id   = ENT_RFORK;</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineplus">+  entries[4].length = catalogInfo.rsrcLogicalSize;</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineplus">+  entries[5].id   = ENT_DFORK;</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineplus">+  entries[5].length = catalogInfo.dataLogicalSize;</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineplus">+</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineplus">+  /* correct the link in the entries. */</span>
<a href="#l3.281"></a><span id="l3.281" class="difflineplus">+  for (i = 1; i &lt; NUM_ENTRIES; ++i)</span>
<a href="#l3.282"></a><span id="l3.282" class="difflineplus">+  {</span>
<a href="#l3.283"></a><span id="l3.283" class="difflineplus">+    entries[i].offset = entries[i-1].offset + entries[i-1].length;</span>
<a href="#l3.284"></a><span id="l3.284" class="difflineplus">+  }</span>
<a href="#l3.285"></a><span id="l3.285" class="difflineplus">+  status = to64(p_ap_encode_obj,</span>
<a href="#l3.286"></a><span id="l3.286" class="difflineplus">+                (char *) entries,</span>
<a href="#l3.287"></a><span id="l3.287" class="difflineplus">+                sizeof (ap_entry) * head.entries);</span>
<a href="#l3.288"></a><span id="l3.288" class="difflineplus">+  if (status != noErr)</span>
<a href="#l3.289"></a><span id="l3.289" class="difflineplus">+    return status;</span>
<a href="#l3.290"></a><span id="l3.290" class="difflineplus">+</span>
<a href="#l3.291"></a><span id="l3.291" class="difflineplus">+  /* write name */</span>
<a href="#l3.292"></a><span id="l3.292" class="difflineplus">+  status = to64(p_ap_encode_obj,</span>
<a href="#l3.293"></a><span id="l3.293" class="difflineplus">+                (char *) leafname.get(),</span>
<a href="#l3.294"></a><span id="l3.294" class="difflineplus">+                leafname.Length());</span>
<a href="#l3.295"></a><span id="l3.295" class="difflineplus">+  if (status != noErr)</span>
<a href="#l3.296"></a><span id="l3.296" class="difflineplus">+    return status;</span>
<a href="#l3.297"></a><span id="l3.297" class="difflineplus">+</span>
<a href="#l3.298"></a><span id="l3.298" class="difflineplus">+  /* write finder info */</span>
<a href="#l3.299"></a><span id="l3.299" class="difflineplus">+  status = to64(p_ap_encode_obj,</span>
<a href="#l3.300"></a><span id="l3.300" class="difflineplus">+                (char *) &amp;catalogInfo.finderInfo,</span>
<a href="#l3.301"></a><span id="l3.301" class="difflineplus">+                sizeof (FInfo));</span>
<a href="#l3.302"></a><span id="l3.302" class="difflineplus">+  if (status != noErr)</span>
<a href="#l3.303"></a><span id="l3.303" class="difflineplus">+    return status;</span>
<a href="#l3.304"></a><span id="l3.304" class="difflineplus">+</span>
<a href="#l3.305"></a><span id="l3.305" class="difflineplus">+  status = to64(p_ap_encode_obj,</span>
<a href="#l3.306"></a><span id="l3.306" class="difflineplus">+                (char *) &amp;catalogInfo.extFinderInfo,</span>
<a href="#l3.307"></a><span id="l3.307" class="difflineplus">+                sizeof (FXInfo));</span>
<a href="#l3.308"></a><span id="l3.308" class="difflineplus">+  if (status != noErr)</span>
<a href="#l3.309"></a><span id="l3.309" class="difflineplus">+    return status;</span>
<a href="#l3.310"></a><span id="l3.310" class="difflineplus">+</span>
<a href="#l3.311"></a><span id="l3.311" class="difflineplus">+  /* write dates */</span>
<a href="#l3.312"></a><span id="l3.312" class="difflineplus">+  dates.create = catalogInfo.createDate.lowSeconds + CONVERT_TIME;</span>
<a href="#l3.313"></a><span id="l3.313" class="difflineplus">+  dates.modify = catalogInfo.contentModDate.lowSeconds + CONVERT_TIME;</span>
<a href="#l3.314"></a><span id="l3.314" class="difflineplus">+  dates.backup = catalogInfo.backupDate.lowSeconds + CONVERT_TIME;</span>
<a href="#l3.315"></a><span id="l3.315" class="difflineplus">+  dates.access = catalogInfo.accessDate.lowSeconds + CONVERT_TIME;</span>
<a href="#l3.316"></a><span id="l3.316" class="difflineplus">+  status = to64(p_ap_encode_obj,</span>
<a href="#l3.317"></a><span id="l3.317" class="difflineplus">+                (char *) &amp;dates,</span>
<a href="#l3.318"></a><span id="l3.318" class="difflineplus">+                sizeof (ap_dates));</span>
<a href="#l3.319"></a><span id="l3.319" class="difflineplus">+  if (status != noErr)</span>
<a href="#l3.320"></a><span id="l3.320" class="difflineplus">+    return status;</span>
<a href="#l3.321"></a><span id="l3.321" class="difflineplus">+</span>
<a href="#l3.322"></a><span id="l3.322" class="difflineplus">+  /* write comment */</span>
<a href="#l3.323"></a><span id="l3.323" class="difflineplus">+  if (comlen)</span>
<a href="#l3.324"></a><span id="l3.324" class="difflineplus">+  {</span>
<a href="#l3.325"></a><span id="l3.325" class="difflineplus">+    status = to64(p_ap_encode_obj,</span>
<a href="#l3.326"></a><span id="l3.326" class="difflineplus">+                  comment,</span>
<a href="#l3.327"></a><span id="l3.327" class="difflineplus">+                  comlen * sizeof(char));</span>
<a href="#l3.328"></a><span id="l3.328" class="difflineplus">+  }</span>
<a href="#l3.329"></a><span id="l3.329" class="difflineplus">+  /*</span>
<a href="#l3.330"></a><span id="l3.330" class="difflineplus">+  **  Get some help information on deciding the file type.</span>
<a href="#l3.331"></a><span id="l3.331" class="difflineplus">+  */</span>
<a href="#l3.332"></a><span id="l3.332" class="difflineplus">+  if (((FileInfo*)(&amp;catalogInfo.finderInfo))-&gt;fileType == 'TEXT' ||</span>
<a href="#l3.333"></a><span id="l3.333" class="difflineplus">+      ((FileInfo*)(&amp;catalogInfo.finderInfo))-&gt;fileType == 'text')</span>
<a href="#l3.334"></a><span id="l3.334" class="difflineplus">+  {</span>
<a href="#l3.335"></a><span id="l3.335" class="difflineplus">+    p_ap_encode_obj-&gt;text_file_type = true;</span>
<a href="#l3.336"></a><span id="l3.336" class="difflineplus">+  }</span>
<a href="#l3.337"></a><span id="l3.337" class="difflineplus">+</span>
<a href="#l3.338"></a><span id="l3.338" class="difflineplus">+  return status;</span>
<a href="#l3.339"></a><span id="l3.339" class="difflineplus">+}</span>
<a href="#l3.340"></a><span id="l3.340" class="difflineplus">+/*</span>
<a href="#l3.341"></a><span id="l3.341" class="difflineplus">+**  ap_encode_header</span>
<a href="#l3.342"></a><span id="l3.342" class="difflineplus">+**</span>
<a href="#l3.343"></a><span id="l3.343" class="difflineplus">+**    encode the file header and the resource fork.</span>
<a href="#l3.344"></a><span id="l3.344" class="difflineplus">+**</span>
<a href="#l3.345"></a><span id="l3.345" class="difflineplus">+*/</span>
<a href="#l3.346"></a><span id="l3.346" class="difflineplus">+int ap_encode_header(</span>
<a href="#l3.347"></a><span id="l3.347" class="difflineplus">+  appledouble_encode_object* p_ap_encode_obj,</span>
<a href="#l3.348"></a><span id="l3.348" class="difflineplus">+  bool    firstime)</span>
<a href="#l3.349"></a><span id="l3.349"> {</span>
<a href="#l3.350"></a><span id="l3.350" class="difflineminus">-	ap_header	head;</span>
<a href="#l3.351"></a><span id="l3.351" class="difflineminus">-	ap_entry 	entries[NUM_ENTRIES];</span>
<a href="#l3.352"></a><span id="l3.352" class="difflineminus">-	ap_dates 	dates;</span>
<a href="#l3.353"></a><span id="l3.353" class="difflineminus">-	short 		i;</span>
<a href="#l3.354"></a><span id="l3.354" class="difflineminus">-	long 		comlen;</span>
<a href="#l3.355"></a><span id="l3.355" class="difflineminus">-	char 		comment[256];</span>
<a href="#l3.356"></a><span id="l3.356" class="difflineminus">-	int	 		status;</span>
<a href="#l3.357"></a><span id="l3.357" class="difflineplus">+  char     rd_buff[256];</span>
<a href="#l3.358"></a><span id="l3.358" class="difflineplus">+  FSIORefNum fileId;</span>
<a href="#l3.359"></a><span id="l3.359" class="difflineplus">+  OSErr  retval = noErr;</span>
<a href="#l3.360"></a><span id="l3.360" class="difflineplus">+  int      status;</span>
<a href="#l3.361"></a><span id="l3.361" class="difflineplus">+  ByteCount inCount;</span>
<a href="#l3.362"></a><span id="l3.362" class="difflineplus">+</span>
<a href="#l3.363"></a><span id="l3.363" class="difflineplus">+  if (firstime)</span>
<a href="#l3.364"></a><span id="l3.364" class="difflineplus">+  {</span>
<a href="#l3.365"></a><span id="l3.365" class="difflineplus">+    PL_strcpy(rd_buff,</span>
<a href="#l3.366"></a><span id="l3.366" class="difflineplus">+      &quot;Content-Type: application/applefile\r\nContent-Transfer-Encoding: base64\r\n\r\n&quot;);</span>
<a href="#l3.367"></a><span id="l3.367" class="difflineplus">+    status = write_stream(p_ap_encode_obj, (const char*)rd_buff, strlen(rd_buff));</span>
<a href="#l3.368"></a><span id="l3.368" class="difflineplus">+    if (status != noErr)</span>
<a href="#l3.369"></a><span id="l3.369" class="difflineplus">+      return status;</span>
<a href="#l3.370"></a><span id="l3.370" class="difflineplus">+</span>
<a href="#l3.371"></a><span id="l3.371" class="difflineplus">+    status = ap_encode_file_infor(p_ap_encode_obj);</span>
<a href="#l3.372"></a><span id="l3.372" class="difflineplus">+    if (status != noErr)</span>
<a href="#l3.373"></a><span id="l3.373" class="difflineplus">+      return status;</span>
<a href="#l3.374"></a><span id="l3.374" class="difflineplus">+</span>
<a href="#l3.375"></a><span id="l3.375" class="difflineplus">+    /*</span>
<a href="#l3.376"></a><span id="l3.376" class="difflineplus">+    ** preparing to encode the resource fork.</span>
<a href="#l3.377"></a><span id="l3.377" class="difflineplus">+    */</span>
<a href="#l3.378"></a><span id="l3.378" class="difflineplus">+    nsCOMPtr &lt;nsIFile&gt; myFile;</span>
<a href="#l3.379"></a><span id="l3.379" class="difflineplus">+    NS_NewNativeLocalFile(nsDependentCString(p_ap_encode_obj-&gt;fname), true, getter_AddRefs(myFile));</span>
<a href="#l3.380"></a><span id="l3.380" class="difflineplus">+    if (!myFile)</span>
<a href="#l3.381"></a><span id="l3.381" class="difflineplus">+      return errFileOpen;</span>
<a href="#l3.382"></a><span id="l3.382" class="difflineplus">+</span>
<a href="#l3.383"></a><span id="l3.383" class="difflineplus">+    FSRef ref;</span>
<a href="#l3.384"></a><span id="l3.384" class="difflineplus">+    nsCOMPtr &lt;nsILocalFileMac&gt; macFile = do_QueryInterface(myFile);</span>
<a href="#l3.385"></a><span id="l3.385" class="difflineplus">+    if (NS_FAILED(macFile-&gt;GetFSRef(&amp;ref)))</span>
<a href="#l3.386"></a><span id="l3.386" class="difflineplus">+      return errFileOpen;</span>
<a href="#l3.387"></a><span id="l3.387" class="difflineplus">+</span>
<a href="#l3.388"></a><span id="l3.388" class="difflineplus">+    HFSUniStr255 forkName;</span>
<a href="#l3.389"></a><span id="l3.389" class="difflineplus">+    ::FSGetResourceForkName(&amp;forkName);</span>
<a href="#l3.390"></a><span id="l3.390" class="difflineplus">+    retval = ::FSOpenFork(&amp;ref, forkName.length, forkName.unicode, fsRdPerm, &amp;p_ap_encode_obj-&gt;fileId);</span>
<a href="#l3.391"></a><span id="l3.391" class="difflineplus">+    if (retval != noErr)</span>
<a href="#l3.392"></a><span id="l3.392" class="difflineplus">+      return retval;</span>
<a href="#l3.393"></a><span id="l3.393" class="difflineplus">+  }</span>
<a href="#l3.394"></a><span id="l3.394" class="difflineplus">+</span>
<a href="#l3.395"></a><span id="l3.395" class="difflineplus">+  fileId = p_ap_encode_obj-&gt;fileId;</span>
<a href="#l3.396"></a><span id="l3.396" class="difflineplus">+  while (retval == noErr)</span>
<a href="#l3.397"></a><span id="l3.397" class="difflineplus">+  {</span>
<a href="#l3.398"></a><span id="l3.398" class="difflineplus">+    if (BUFF_LEFT(p_ap_encode_obj) &lt; 400)</span>
<a href="#l3.399"></a><span id="l3.399" class="difflineplus">+      break;</span>
<a href="#l3.400"></a><span id="l3.400" class="difflineplus">+</span>
<a href="#l3.401"></a><span id="l3.401" class="difflineplus">+    inCount = 0;</span>
<a href="#l3.402"></a><span id="l3.402" class="difflineplus">+    retval = ::FSReadFork(fileId, fsAtMark, 0, 256, rd_buff, &amp;inCount);</span>
<a href="#l3.403"></a><span id="l3.403" class="difflineplus">+    if (inCount)</span>
<a href="#l3.404"></a><span id="l3.404" class="difflineplus">+    {</span>
<a href="#l3.405"></a><span id="l3.405" class="difflineplus">+      status = to64(p_ap_encode_obj,</span>
<a href="#l3.406"></a><span id="l3.406" class="difflineplus">+                    rd_buff,</span>
<a href="#l3.407"></a><span id="l3.407" class="difflineplus">+                    inCount);</span>
<a href="#l3.408"></a><span id="l3.408" class="difflineplus">+      if (status != noErr)</span>
<a href="#l3.409"></a><span id="l3.409" class="difflineplus">+        return status;</span>
<a href="#l3.410"></a><span id="l3.410" class="difflineplus">+    }</span>
<a href="#l3.411"></a><span id="l3.411" class="difflineplus">+  }</span>
<a href="#l3.412"></a><span id="l3.412" class="difflineplus">+</span>
<a href="#l3.413"></a><span id="l3.413" class="difflineplus">+  if (retval == eofErr)</span>
<a href="#l3.414"></a><span id="l3.414" class="difflineplus">+  {</span>
<a href="#l3.415"></a><span id="l3.415" class="difflineplus">+    ::FSCloseFork(fileId);</span>
<a href="#l3.416"></a><span id="l3.416" class="difflineplus">+    p_ap_encode_obj-&gt;fileId = 0;</span>
<a href="#l3.417"></a><span id="l3.417" class="difflineplus">+</span>
<a href="#l3.418"></a><span id="l3.418" class="difflineplus">+    status = finish64(p_ap_encode_obj);</span>
<a href="#l3.419"></a><span id="l3.419" class="difflineplus">+    if (status != noErr)</span>
<a href="#l3.420"></a><span id="l3.420" class="difflineplus">+      return status;</span>
<a href="#l3.421"></a><span id="l3.421" class="difflineplus">+</span>
<a href="#l3.422"></a><span id="l3.422" class="difflineplus">+    /*</span>
<a href="#l3.423"></a><span id="l3.423" class="difflineplus">+    ** write out the boundary</span>
<a href="#l3.424"></a><span id="l3.424" class="difflineplus">+    */</span>
<a href="#l3.425"></a><span id="l3.425" class="difflineplus">+    PR_snprintf(rd_buff, sizeof(rd_buff),</span>
<a href="#l3.426"></a><span id="l3.426" class="difflineplus">+                CRLF &quot;--%s&quot; CRLF,</span>
<a href="#l3.427"></a><span id="l3.427" class="difflineplus">+                p_ap_encode_obj-&gt;boundary);</span>
<a href="#l3.428"></a><span id="l3.428" class="difflineplus">+</span>
<a href="#l3.429"></a><span id="l3.429" class="difflineplus">+    status = write_stream(p_ap_encode_obj, (const char*)rd_buff, strlen(rd_buff));</span>
<a href="#l3.430"></a><span id="l3.430" class="difflineplus">+    if (status == noErr)</span>
<a href="#l3.431"></a><span id="l3.431" class="difflineplus">+      status = errDone;</span>
<a href="#l3.432"></a><span id="l3.432" class="difflineplus">+  }</span>
<a href="#l3.433"></a><span id="l3.433" class="difflineplus">+  return status;</span>
<a href="#l3.434"></a><span id="l3.434" class="difflineplus">+}</span>
<a href="#l3.435"></a><span id="l3.435"> </span>
<a href="#l3.436"></a><span id="l3.436" class="difflineplus">+#if 0</span>
<a href="#l3.437"></a><span id="l3.437" class="difflineplus">+// This is unused for now and Clang complains about that is it is ifdefed out</span>
<a href="#l3.438"></a><span id="l3.438" class="difflineplus">+static void replace(char *p, int len, char frm, char to)</span>
<a href="#l3.439"></a><span id="l3.439" class="difflineplus">+{</span>
<a href="#l3.440"></a><span id="l3.440" class="difflineplus">+  for (; len &gt; 0; len--, p++)</span>
<a href="#l3.441"></a><span id="l3.441" class="difflineplus">+    if (*p == frm)  *p = to;</span>
<a href="#l3.442"></a><span id="l3.442" class="difflineplus">+}</span>
<a href="#l3.443"></a><span id="l3.443" class="difflineplus">+#endif</span>
<a href="#l3.444"></a><span id="l3.444" class="difflineplus">+</span>
<a href="#l3.445"></a><span id="l3.445" class="difflineplus">+/* Description of the various file formats and their magic numbers     */</span>
<a href="#l3.446"></a><span id="l3.446" class="difflineplus">+struct magic</span>
<a href="#l3.447"></a><span id="l3.447" class="difflineplus">+{</span>
<a href="#l3.448"></a><span id="l3.448" class="difflineplus">+    const char *name;    /* Name of the file format */</span>
<a href="#l3.449"></a><span id="l3.449" class="difflineplus">+    const char *num;     /* The magic number */</span>
<a href="#l3.450"></a><span id="l3.450" class="difflineplus">+    int        len;      /* Length (0 means strlen(magicnum)) */</span>
<a href="#l3.451"></a><span id="l3.451" class="difflineplus">+};</span>
<a href="#l3.452"></a><span id="l3.452" class="difflineplus">+</span>
<a href="#l3.453"></a><span id="l3.453" class="difflineplus">+/* The magic numbers of the file formats we know about */</span>
<a href="#l3.454"></a><span id="l3.454" class="difflineplus">+static struct magic magic[] =</span>
<a href="#l3.455"></a><span id="l3.455" class="difflineplus">+{</span>
<a href="#l3.456"></a><span id="l3.456" class="difflineplus">+    { &quot;image/gif&quot;,   &quot;GIF&quot;,         0 },</span>
<a href="#l3.457"></a><span id="l3.457" class="difflineplus">+    { &quot;image/jpeg&quot;, &quot;\377\330\377&quot;,   0 },</span>
<a href="#l3.458"></a><span id="l3.458" class="difflineplus">+    { &quot;video/mpeg&quot;, &quot;\0\0\001\263&quot;,    4 },</span>
<a href="#l3.459"></a><span id="l3.459" class="difflineplus">+    { &quot;application/postscript&quot;, &quot;%!&quot;, 0 },</span>
<a href="#l3.460"></a><span id="l3.460" class="difflineplus">+};</span>
<a href="#l3.461"></a><span id="l3.461" class="difflineplus">+static int num_magic = MOZ_ARRAY_LENGTH(magic);</span>
<a href="#l3.462"></a><span id="l3.462" class="difflineplus">+</span>
<a href="#l3.463"></a><span id="l3.463" class="difflineplus">+static const char *text_type    = TEXT_PLAIN;          /* the text file type. */</span>
<a href="#l3.464"></a><span id="l3.464" class="difflineplus">+static const char *default_type = APPLICATION_OCTET_STREAM;</span>
<a href="#l3.465"></a><span id="l3.465" class="difflineplus">+</span>
<a href="#l3.466"></a><span id="l3.466" class="difflineplus">+</span>
<a href="#l3.467"></a><span id="l3.467" class="difflineplus">+/*</span>
<a href="#l3.468"></a><span id="l3.468" class="difflineplus">+ * Determines the format of the file &quot;inputf&quot;.  The name</span>
<a href="#l3.469"></a><span id="l3.469" class="difflineplus">+ * of the file format (or NULL on error) is returned.</span>
<a href="#l3.470"></a><span id="l3.470" class="difflineplus">+ */</span>
<a href="#l3.471"></a><span id="l3.471" class="difflineplus">+static const char *magic_look(char *inbuff, int numread)</span>
<a href="#l3.472"></a><span id="l3.472" class="difflineplus">+{</span>
<a href="#l3.473"></a><span id="l3.473" class="difflineplus">+  int i, j;</span>
<a href="#l3.474"></a><span id="l3.474" class="difflineplus">+</span>
<a href="#l3.475"></a><span id="l3.475" class="difflineplus">+  for (i=0; i&lt;num_magic; i++)</span>
<a href="#l3.476"></a><span id="l3.476" class="difflineplus">+  {</span>
<a href="#l3.477"></a><span id="l3.477" class="difflineplus">+    if (magic[i].len == 0)</span>
<a href="#l3.478"></a><span id="l3.478" class="difflineplus">+      magic[i].len = strlen(magic[i].num);</span>
<a href="#l3.479"></a><span id="l3.479" class="difflineplus">+  }</span>
<a href="#l3.480"></a><span id="l3.480" class="difflineplus">+</span>
<a href="#l3.481"></a><span id="l3.481" class="difflineplus">+  for (i=0; i&lt;num_magic; i++)</span>
<a href="#l3.482"></a><span id="l3.482" class="difflineplus">+  {</span>
<a href="#l3.483"></a><span id="l3.483" class="difflineplus">+    if (numread &gt;= magic[i].len)</span>
<a href="#l3.484"></a><span id="l3.484" class="difflineplus">+    {</span>
<a href="#l3.485"></a><span id="l3.485" class="difflineplus">+      for (j=0; j&lt;magic[i].len; j++)</span>
<a href="#l3.486"></a><span id="l3.486" class="difflineplus">+      {</span>
<a href="#l3.487"></a><span id="l3.487" class="difflineplus">+        if (inbuff[j] != magic[i].num[j]) break;</span>
<a href="#l3.488"></a><span id="l3.488" class="difflineplus">+      }</span>
<a href="#l3.489"></a><span id="l3.489" class="difflineplus">+      </span>
<a href="#l3.490"></a><span id="l3.490" class="difflineplus">+      if (j == magic[i].len)</span>
<a href="#l3.491"></a><span id="l3.491" class="difflineplus">+        return magic[i].name;</span>
<a href="#l3.492"></a><span id="l3.492" class="difflineplus">+    }</span>
<a href="#l3.493"></a><span id="l3.493" class="difflineplus">+  }</span>
<a href="#l3.494"></a><span id="l3.494" class="difflineplus">+</span>
<a href="#l3.495"></a><span id="l3.495" class="difflineplus">+  return default_type;</span>
<a href="#l3.496"></a><span id="l3.496" class="difflineplus">+}</span>
<a href="#l3.497"></a><span id="l3.497" class="difflineplus">+/*</span>
<a href="#l3.498"></a><span id="l3.498" class="difflineplus">+**  ap_encode_data</span>
<a href="#l3.499"></a><span id="l3.499" class="difflineplus">+**</span>
<a href="#l3.500"></a><span id="l3.500" class="difflineplus">+**  ---------------</span>
<a href="#l3.501"></a><span id="l3.501" class="difflineplus">+**</span>
<a href="#l3.502"></a><span id="l3.502" class="difflineplus">+**    encode on the data fork.</span>
<a href="#l3.503"></a><span id="l3.503" class="difflineplus">+**</span>
<a href="#l3.504"></a><span id="l3.504" class="difflineplus">+*/</span>
<a href="#l3.505"></a><span id="l3.505" class="difflineplus">+int ap_encode_data(</span>
<a href="#l3.506"></a><span id="l3.506" class="difflineplus">+  appledouble_encode_object* p_ap_encode_obj,</span>
<a href="#l3.507"></a><span id="l3.507" class="difflineplus">+  bool firstime)</span>
<a href="#l3.508"></a><span id="l3.508" class="difflineplus">+{</span>
<a href="#l3.509"></a><span id="l3.509" class="difflineplus">+  char       rd_buff[256];</span>
<a href="#l3.510"></a><span id="l3.510" class="difflineplus">+  FSIORefNum fileId;</span>
<a href="#l3.511"></a><span id="l3.511" class="difflineplus">+  OSErr      retval = noErr;</span>
<a href="#l3.512"></a><span id="l3.512" class="difflineplus">+  ByteCount  in_count;</span>
<a href="#l3.513"></a><span id="l3.513" class="difflineplus">+  int        status;</span>
<a href="#l3.514"></a><span id="l3.514" class="difflineplus">+</span>
<a href="#l3.515"></a><span id="l3.515" class="difflineplus">+  if (firstime)</span>
<a href="#l3.516"></a><span id="l3.516" class="difflineplus">+  {</span>
<a href="#l3.517"></a><span id="l3.517" class="difflineplus">+    const char* magic_type;</span>
<a href="#l3.518"></a><span id="l3.518" class="difflineplus">+</span>
<a href="#l3.519"></a><span id="l3.519" class="difflineplus">+    /*</span>
<a href="#l3.520"></a><span id="l3.520" class="difflineplus">+    ** preparing to encode the data fork.</span>
<a href="#l3.521"></a><span id="l3.521" class="difflineplus">+    */</span>
<a href="#l3.522"></a><span id="l3.522">     nsCOMPtr &lt;nsIFile&gt; resFile;</span>
<a href="#l3.523"></a><span id="l3.523">     NS_NewNativeLocalFile(nsDependentCString(p_ap_encode_obj-&gt;fname), true,</span>
<a href="#l3.524"></a><span id="l3.524">                           getter_AddRefs(resFile));</span>
<a href="#l3.525"></a><span id="l3.525">     if (!resFile)</span>
<a href="#l3.526"></a><span id="l3.526">         return errFileOpen;</span>
<a href="#l3.527"></a><span id="l3.527"> </span>
<a href="#l3.528"></a><span id="l3.528">     FSRef ref;</span>
<a href="#l3.529"></a><span id="l3.529">     nsCOMPtr &lt;nsILocalFileMac&gt; macFile = do_QueryInterface(resFile);</span>
<a href="#l3.530"></a><span id="l3.530">     if (NS_FAILED(macFile-&gt;GetFSRef(&amp;ref)))</span>
<a href="#l3.531"></a><span id="l3.531">         return errFileOpen;</span>
<a href="#l3.532"></a><span id="l3.532"> </span>
<a href="#l3.533"></a><span id="l3.533" class="difflineminus">-    FSCatalogInfo catalogInfo;</span>
<a href="#l3.534"></a><span id="l3.534" class="difflineminus">-    if (::FSGetCatalogInfo(&amp;ref, kFSCatInfoFinderInfo, &amp;catalogInfo, nullptr, nullptr, nullptr) != noErr)</span>
<a href="#l3.535"></a><span id="l3.535" class="difflineminus">-	{</span>
<a href="#l3.536"></a><span id="l3.536" class="difflineminus">-		return errFileOpen;</span>
<a href="#l3.537"></a><span id="l3.537" class="difflineminus">-	}</span>
<a href="#l3.538"></a><span id="l3.538" class="difflineminus">-</span>
<a href="#l3.539"></a><span id="l3.539" class="difflineminus">-	/* get a file comment, if possible */</span>
<a href="#l3.540"></a><span id="l3.540" class="difflineminus">-#if 1</span>
<a href="#l3.541"></a><span id="l3.541" class="difflineminus">-    // Carbon doesn't support GetWDInfo(). (Bug 555684)</span>
<a href="#l3.542"></a><span id="l3.542" class="difflineminus">-</span>
<a href="#l3.543"></a><span id="l3.543" class="difflineminus">-    // not sure why working directories are needed here...</span>
<a href="#l3.544"></a><span id="l3.544" class="difflineminus">-    comlen = 0;</span>
<a href="#l3.545"></a><span id="l3.545" class="difflineminus">-#else</span>
<a href="#l3.546"></a><span id="l3.546" class="difflineminus">-	long 		procID;</span>
<a href="#l3.547"></a><span id="l3.547" class="difflineminus">-	procID = 0;</span>
<a href="#l3.548"></a><span id="l3.548" class="difflineminus">-	GetWDInfo(p_ap_encode_obj-&gt;vRefNum, &amp;fpb-&gt;ioVRefNum, &amp;fpb-&gt;ioDirID, &amp;procID);</span>
<a href="#l3.549"></a><span id="l3.549" class="difflineminus">-	IOParam 	vinfo;</span>
<a href="#l3.550"></a><span id="l3.550" class="difflineminus">-	memset((void *) &amp;vinfo, '\0', sizeof (vinfo));</span>
<a href="#l3.551"></a><span id="l3.551" class="difflineminus">-	GetVolParmsInfoBuffer vp;</span>
<a href="#l3.552"></a><span id="l3.552" class="difflineminus">-	vinfo.ioCompletion  = nil;</span>
<a href="#l3.553"></a><span id="l3.553" class="difflineminus">-	vinfo.ioVRefNum 	= fpb-&gt;ioVRefNum;</span>
<a href="#l3.554"></a><span id="l3.554" class="difflineminus">-	vinfo.ioBuffer 		= (Ptr) &amp;vp;</span>
<a href="#l3.555"></a><span id="l3.555" class="difflineminus">-	vinfo.ioReqCount 	= sizeof (vp);</span>
<a href="#l3.556"></a><span id="l3.556" class="difflineminus">-	comlen = 0;</span>
<a href="#l3.557"></a><span id="l3.557" class="difflineminus">-	if (PBHGetVolParmsSync((HParmBlkPtr) &amp;vinfo) == noErr &amp;&amp;</span>
<a href="#l3.558"></a><span id="l3.558" class="difflineminus">-		((vp.vMAttrib &gt;&gt; bHasDesktopMgr) &amp; 1))</span>
<a href="#l3.559"></a><span id="l3.559" class="difflineminus">-	{</span>
<a href="#l3.560"></a><span id="l3.560" class="difflineminus">-		DTPBRec 	dtp;</span>
<a href="#l3.561"></a><span id="l3.561" class="difflineminus">-		memset((void *) &amp;dtp, '\0', sizeof (dtp));</span>
<a href="#l3.562"></a><span id="l3.562" class="difflineminus">-		dtp.ioVRefNum = fpb-&gt;ioVRefNum;</span>
<a href="#l3.563"></a><span id="l3.563" class="difflineminus">-		if (PBDTGetPath(&amp;dtp) == noErr)</span>
<a href="#l3.564"></a><span id="l3.564" class="difflineminus">-		{</span>
<a href="#l3.565"></a><span id="l3.565" class="difflineminus">-			dtp.ioCompletion = nil;</span>
<a href="#l3.566"></a><span id="l3.566" class="difflineminus">-			dtp.ioDTBuffer = (Ptr) comment;</span>
<a href="#l3.567"></a><span id="l3.567" class="difflineminus">-			dtp.ioNamePtr  = fpb-&gt;ioNamePtr;</span>
<a href="#l3.568"></a><span id="l3.568" class="difflineminus">-			dtp.ioDirID    = fpb-&gt;ioFlParID;</span>
<a href="#l3.569"></a><span id="l3.569" class="difflineminus">-			if (PBDTGetCommentSync(&amp;dtp) == noErr)</span>
<a href="#l3.570"></a><span id="l3.570" class="difflineminus">-				comlen = dtp.ioDTActCount;</span>
<a href="#l3.571"></a><span id="l3.571" class="difflineminus">-		}</span>
<a href="#l3.572"></a><span id="l3.572" class="difflineminus">-	}</span>
<a href="#l3.573"></a><span id="l3.573" class="difflineminus">-#endif /* ! 1 */</span>
<a href="#l3.574"></a><span id="l3.574" class="difflineminus">-	</span>
<a href="#l3.575"></a><span id="l3.575" class="difflineminus">-	/* write header */</span>
<a href="#l3.576"></a><span id="l3.576" class="difflineminus">-//	head.magic = dfork ? APPLESINGLE_MAGIC : APPLEDOUBLE_MAGIC;</span>
<a href="#l3.577"></a><span id="l3.577" class="difflineminus">-	head.magic   = APPLEDOUBLE_MAGIC;		/* always do apple double */</span>
<a href="#l3.578"></a><span id="l3.578" class="difflineminus">-	head.version = VERSION;</span>
<a href="#l3.579"></a><span id="l3.579" class="difflineminus">-	memset(head.fill, '\0', sizeof (head.fill));</span>
<a href="#l3.580"></a><span id="l3.580" class="difflineminus">-	head.entries = NUM_ENTRIES - 1;</span>
<a href="#l3.581"></a><span id="l3.581" class="difflineminus">-	status = to64(p_ap_encode_obj,</span>
<a href="#l3.582"></a><span id="l3.582" class="difflineminus">-					(char *) &amp;head,</span>
<a href="#l3.583"></a><span id="l3.583" class="difflineminus">-					sizeof (head));				</span>
<a href="#l3.584"></a><span id="l3.584" class="difflineminus">-	if (status != noErr)</span>
<a href="#l3.585"></a><span id="l3.585" class="difflineminus">-		return status;</span>
<a href="#l3.586"></a><span id="l3.586" class="difflineminus">-</span>
<a href="#l3.587"></a><span id="l3.587" class="difflineminus">-	/* write entry descriptors */</span>
<a href="#l3.588"></a><span id="l3.588" class="difflineminus">-    nsAutoCString leafname;</span>
<a href="#l3.589"></a><span id="l3.589" class="difflineminus">-    macFile-&gt;GetNativeLeafName(leafname);</span>
<a href="#l3.590"></a><span id="l3.590" class="difflineminus">-	entries[0].offset = sizeof (head) + sizeof (ap_entry) * head.entries;</span>
<a href="#l3.591"></a><span id="l3.591" class="difflineminus">-	entries[0].id 	= ENT_NAME;</span>
<a href="#l3.592"></a><span id="l3.592" class="difflineminus">-    entries[0].length = leafname.Length();</span>
<a href="#l3.593"></a><span id="l3.593" class="difflineminus">-	entries[1].id 	= ENT_FINFO;</span>
<a href="#l3.594"></a><span id="l3.594" class="difflineminus">-	entries[1].length = sizeof (FInfo) + sizeof (FXInfo);</span>
<a href="#l3.595"></a><span id="l3.595" class="difflineminus">-	entries[2].id 	= ENT_DATES;</span>
<a href="#l3.596"></a><span id="l3.596" class="difflineminus">-	entries[2].length = sizeof (ap_dates);</span>
<a href="#l3.597"></a><span id="l3.597" class="difflineminus">-	entries[3].id 	= ENT_COMMENT;</span>
<a href="#l3.598"></a><span id="l3.598" class="difflineminus">-	entries[3].length = comlen;</span>
<a href="#l3.599"></a><span id="l3.599" class="difflineminus">-	entries[4].id 	= ENT_RFORK;</span>
<a href="#l3.600"></a><span id="l3.600" class="difflineminus">-    entries[4].length = catalogInfo.rsrcLogicalSize;</span>
<a href="#l3.601"></a><span id="l3.601" class="difflineminus">-	entries[5].id 	= ENT_DFORK;</span>
<a href="#l3.602"></a><span id="l3.602" class="difflineminus">-    entries[5].length = catalogInfo.dataLogicalSize;</span>
<a href="#l3.603"></a><span id="l3.603" class="difflineminus">-</span>
<a href="#l3.604"></a><span id="l3.604" class="difflineminus">-	/* correct the link in the entries. */</span>
<a href="#l3.605"></a><span id="l3.605" class="difflineminus">-	for (i = 1; i &lt; NUM_ENTRIES; ++i)</span>
<a href="#l3.606"></a><span id="l3.606" class="difflineminus">-	{</span>
<a href="#l3.607"></a><span id="l3.607" class="difflineminus">-		entries[i].offset = entries[i-1].offset + entries[i-1].length;</span>
<a href="#l3.608"></a><span id="l3.608" class="difflineminus">-	}</span>
<a href="#l3.609"></a><span id="l3.609" class="difflineminus">-	status = to64(p_ap_encode_obj,</span>
<a href="#l3.610"></a><span id="l3.610" class="difflineminus">-					(char *) entries,</span>
<a href="#l3.611"></a><span id="l3.611" class="difflineminus">-					sizeof (ap_entry) * head.entries);</span>
<a href="#l3.612"></a><span id="l3.612" class="difflineminus">-	if (status != noErr)</span>
<a href="#l3.613"></a><span id="l3.613" class="difflineminus">-		return status;</span>
<a href="#l3.614"></a><span id="l3.614" class="difflineminus">-</span>
<a href="#l3.615"></a><span id="l3.615" class="difflineminus">-	/* write name */</span>
<a href="#l3.616"></a><span id="l3.616" class="difflineminus">-	status = to64(p_ap_encode_obj,</span>
<a href="#l3.617"></a><span id="l3.617" class="difflineminus">-					(char *) leafname.get(),</span>
<a href="#l3.618"></a><span id="l3.618" class="difflineminus">-					leafname.Length());</span>
<a href="#l3.619"></a><span id="l3.619" class="difflineminus">-	if (status != noErr)</span>
<a href="#l3.620"></a><span id="l3.620" class="difflineminus">-		return status;</span>
<a href="#l3.621"></a><span id="l3.621" class="difflineminus">-	</span>
<a href="#l3.622"></a><span id="l3.622" class="difflineminus">-	/* write finder info */</span>
<a href="#l3.623"></a><span id="l3.623" class="difflineminus">-	status = to64(p_ap_encode_obj,</span>
<a href="#l3.624"></a><span id="l3.624" class="difflineminus">-					(char *) &amp;catalogInfo.finderInfo,</span>
<a href="#l3.625"></a><span id="l3.625" class="difflineminus">-					sizeof (FInfo));</span>
<a href="#l3.626"></a><span id="l3.626" class="difflineminus">-	if (status != noErr)</span>
<a href="#l3.627"></a><span id="l3.627" class="difflineminus">-		return status;</span>
<a href="#l3.628"></a><span id="l3.628" class="difflineminus">-					</span>
<a href="#l3.629"></a><span id="l3.629" class="difflineminus">-	status = to64(p_ap_encode_obj,</span>
<a href="#l3.630"></a><span id="l3.630" class="difflineminus">-					(char *) &amp;catalogInfo.extFinderInfo,</span>
<a href="#l3.631"></a><span id="l3.631" class="difflineminus">-					sizeof (FXInfo));</span>
<a href="#l3.632"></a><span id="l3.632" class="difflineminus">-	if (status != noErr)</span>
<a href="#l3.633"></a><span id="l3.633" class="difflineminus">-		return status;</span>
<a href="#l3.634"></a><span id="l3.634" class="difflineplus">+    HFSUniStr255 forkName;</span>
<a href="#l3.635"></a><span id="l3.635" class="difflineplus">+    ::FSGetDataForkName(&amp;forkName);</span>
<a href="#l3.636"></a><span id="l3.636" class="difflineplus">+    retval = ::FSOpenFork(&amp;ref, forkName.length, forkName.unicode, fsRdPerm, &amp;fileId);</span>
<a href="#l3.637"></a><span id="l3.637" class="difflineplus">+    if (retval != noErr)</span>
<a href="#l3.638"></a><span id="l3.638" class="difflineplus">+        return retval;</span>
<a href="#l3.639"></a><span id="l3.639"> </span>
<a href="#l3.640"></a><span id="l3.640" class="difflineminus">-	/* write dates */</span>
<a href="#l3.641"></a><span id="l3.641" class="difflineminus">-    dates.create = catalogInfo.createDate.lowSeconds + CONVERT_TIME;</span>
<a href="#l3.642"></a><span id="l3.642" class="difflineminus">-    dates.modify = catalogInfo.contentModDate.lowSeconds + CONVERT_TIME;</span>
<a href="#l3.643"></a><span id="l3.643" class="difflineminus">-    dates.backup = catalogInfo.backupDate.lowSeconds + CONVERT_TIME;</span>
<a href="#l3.644"></a><span id="l3.644" class="difflineminus">-    dates.access = catalogInfo.accessDate.lowSeconds + CONVERT_TIME;</span>
<a href="#l3.645"></a><span id="l3.645" class="difflineminus">-	status = to64(p_ap_encode_obj,</span>
<a href="#l3.646"></a><span id="l3.646" class="difflineminus">-					(char *) &amp;dates,</span>
<a href="#l3.647"></a><span id="l3.647" class="difflineminus">-					sizeof (ap_dates));</span>
<a href="#l3.648"></a><span id="l3.648" class="difflineminus">-	if (status != noErr)</span>
<a href="#l3.649"></a><span id="l3.649" class="difflineminus">-		return status;</span>
<a href="#l3.650"></a><span id="l3.650" class="difflineminus">-	</span>
<a href="#l3.651"></a><span id="l3.651" class="difflineminus">-	/* write comment */</span>
<a href="#l3.652"></a><span id="l3.652" class="difflineminus">-	if (comlen)</span>
<a href="#l3.653"></a><span id="l3.653" class="difflineminus">-	{</span>
<a href="#l3.654"></a><span id="l3.654" class="difflineminus">-		status = to64(p_ap_encode_obj,</span>
<a href="#l3.655"></a><span id="l3.655" class="difflineminus">-					comment,</span>
<a href="#l3.656"></a><span id="l3.656" class="difflineminus">-					comlen * sizeof(char));</span>
<a href="#l3.657"></a><span id="l3.657" class="difflineminus">-	}</span>
<a href="#l3.658"></a><span id="l3.658" class="difflineminus">-	/*</span>
<a href="#l3.659"></a><span id="l3.659" class="difflineminus">-	**	Get some help information on deciding the file type.</span>
<a href="#l3.660"></a><span id="l3.660" class="difflineminus">-	*/</span>
<a href="#l3.661"></a><span id="l3.661" class="difflineminus">-    if (((FileInfo*)(&amp;catalogInfo.finderInfo))-&gt;fileType == 'TEXT' ||</span>
<a href="#l3.662"></a><span id="l3.662" class="difflineminus">-        ((FileInfo*)(&amp;catalogInfo.finderInfo))-&gt;fileType == 'text')</span>
<a href="#l3.663"></a><span id="l3.663" class="difflineminus">-	{</span>
<a href="#l3.664"></a><span id="l3.664" class="difflineminus">-		p_ap_encode_obj-&gt;text_file_type = true;</span>
<a href="#l3.665"></a><span id="l3.665" class="difflineminus">-	}</span>
<a href="#l3.666"></a><span id="l3.666" class="difflineminus">-	</span>
<a href="#l3.667"></a><span id="l3.667" class="difflineminus">-	return status;	</span>
<a href="#l3.668"></a><span id="l3.668" class="difflineminus">-}</span>
<a href="#l3.669"></a><span id="l3.669" class="difflineminus">-/*</span>
<a href="#l3.670"></a><span id="l3.670" class="difflineminus">-**	ap_encode_header</span>
<a href="#l3.671"></a><span id="l3.671" class="difflineminus">-**</span>
<a href="#l3.672"></a><span id="l3.672" class="difflineminus">-**		encode the file header and the resource fork.</span>
<a href="#l3.673"></a><span id="l3.673" class="difflineminus">-**</span>
<a href="#l3.674"></a><span id="l3.674" class="difflineminus">-*/</span>
<a href="#l3.675"></a><span id="l3.675" class="difflineminus">-int ap_encode_header(</span>
<a href="#l3.676"></a><span id="l3.676" class="difflineminus">-	appledouble_encode_object* p_ap_encode_obj,</span>
<a href="#l3.677"></a><span id="l3.677" class="difflineminus">-	bool    firstime)</span>
<a href="#l3.678"></a><span id="l3.678" class="difflineminus">-{</span>
<a href="#l3.679"></a><span id="l3.679" class="difflineminus">-	char   	rd_buff[256];</span>
<a href="#l3.680"></a><span id="l3.680" class="difflineminus">-    FSIORefNum fileId;</span>
<a href="#l3.681"></a><span id="l3.681" class="difflineminus">-	OSErr	retval = noErr;</span>
<a href="#l3.682"></a><span id="l3.682" class="difflineminus">-	int    	status;</span>
<a href="#l3.683"></a><span id="l3.683" class="difflineminus">-    ByteCount inCount;</span>
<a href="#l3.684"></a><span id="l3.684" class="difflineminus">-	</span>
<a href="#l3.685"></a><span id="l3.685" class="difflineminus">-	if (firstime)</span>
<a href="#l3.686"></a><span id="l3.686" class="difflineminus">-	{</span>
<a href="#l3.687"></a><span id="l3.687" class="difflineminus">-    PL_strcpy(rd_buff,</span>
<a href="#l3.688"></a><span id="l3.688" class="difflineminus">-			&quot;Content-Type: application/applefile\r\nContent-Transfer-Encoding: base64\r\n\r\n&quot;);</span>
<a href="#l3.689"></a><span id="l3.689" class="difflineminus">-		status = write_stream(p_ap_encode_obj, (const char*)rd_buff, strlen(rd_buff));</span>
<a href="#l3.690"></a><span id="l3.690" class="difflineminus">-		if (status != noErr)</span>
<a href="#l3.691"></a><span id="l3.691" class="difflineminus">-			return status;</span>
<a href="#l3.692"></a><span id="l3.692" class="difflineminus">-			</span>
<a href="#l3.693"></a><span id="l3.693" class="difflineminus">-		status = ap_encode_file_infor(p_ap_encode_obj);</span>
<a href="#l3.694"></a><span id="l3.694" class="difflineminus">-		if (status != noErr)</span>
<a href="#l3.695"></a><span id="l3.695" class="difflineminus">-			return status;</span>
<a href="#l3.696"></a><span id="l3.696" class="difflineminus">-		</span>
<a href="#l3.697"></a><span id="l3.697" class="difflineminus">-		/*</span>
<a href="#l3.698"></a><span id="l3.698" class="difflineminus">-		** preparing to encode the resource fork.</span>
<a href="#l3.699"></a><span id="l3.699" class="difflineminus">-		*/</span>
<a href="#l3.700"></a><span id="l3.700" class="difflineminus">-        nsCOMPtr &lt;nsIFile&gt; myFile;</span>
<a href="#l3.701"></a><span id="l3.701" class="difflineminus">-        NS_NewNativeLocalFile(nsDependentCString(p_ap_encode_obj-&gt;fname), true, getter_AddRefs(myFile));</span>
<a href="#l3.702"></a><span id="l3.702" class="difflineminus">-        if (!myFile)</span>
<a href="#l3.703"></a><span id="l3.703" class="difflineminus">-            return errFileOpen;</span>
<a href="#l3.704"></a><span id="l3.704" class="difflineminus">-</span>
<a href="#l3.705"></a><span id="l3.705" class="difflineminus">-        FSRef ref;</span>
<a href="#l3.706"></a><span id="l3.706" class="difflineminus">-        nsCOMPtr &lt;nsILocalFileMac&gt; macFile = do_QueryInterface(myFile);</span>
<a href="#l3.707"></a><span id="l3.707" class="difflineminus">-        if (NS_FAILED(macFile-&gt;GetFSRef(&amp;ref)))</span>
<a href="#l3.708"></a><span id="l3.708" class="difflineminus">-            return errFileOpen;</span>
<a href="#l3.709"></a><span id="l3.709" class="difflineminus">-</span>
<a href="#l3.710"></a><span id="l3.710" class="difflineminus">-        HFSUniStr255 forkName;</span>
<a href="#l3.711"></a><span id="l3.711" class="difflineminus">-        ::FSGetResourceForkName(&amp;forkName);</span>
<a href="#l3.712"></a><span id="l3.712" class="difflineminus">-        retval = ::FSOpenFork(&amp;ref, forkName.length, forkName.unicode, fsRdPerm, &amp;p_ap_encode_obj-&gt;fileId);</span>
<a href="#l3.713"></a><span id="l3.713" class="difflineminus">-        if (retval != noErr)</span>
<a href="#l3.714"></a><span id="l3.714" class="difflineminus">-            return retval;</span>
<a href="#l3.715"></a><span id="l3.715" class="difflineminus">-	}</span>
<a href="#l3.716"></a><span id="l3.716" class="difflineminus">-</span>
<a href="#l3.717"></a><span id="l3.717" class="difflineminus">-	fileId = p_ap_encode_obj-&gt;fileId;</span>
<a href="#l3.718"></a><span id="l3.718" class="difflineminus">-	while (retval == noErr)</span>
<a href="#l3.719"></a><span id="l3.719" class="difflineminus">-	{</span>
<a href="#l3.720"></a><span id="l3.720" class="difflineminus">-		if (BUFF_LEFT(p_ap_encode_obj) &lt; 400)</span>
<a href="#l3.721"></a><span id="l3.721" class="difflineminus">-			break;</span>
<a href="#l3.722"></a><span id="l3.722" class="difflineminus">-			</span>
<a href="#l3.723"></a><span id="l3.723" class="difflineminus">-        inCount = 0;</span>
<a href="#l3.724"></a><span id="l3.724" class="difflineminus">-        retval = ::FSReadFork(fileId, fsAtMark, 0, 256, rd_buff, &amp;inCount);</span>
<a href="#l3.725"></a><span id="l3.725" class="difflineminus">-		if (inCount)</span>
<a href="#l3.726"></a><span id="l3.726" class="difflineminus">-		{</span>
<a href="#l3.727"></a><span id="l3.727" class="difflineminus">-			status = to64(p_ap_encode_obj,</span>
<a href="#l3.728"></a><span id="l3.728" class="difflineminus">-							rd_buff,</span>
<a href="#l3.729"></a><span id="l3.729" class="difflineminus">-							inCount);</span>
<a href="#l3.730"></a><span id="l3.730" class="difflineminus">-			if (status != noErr)</span>
<a href="#l3.731"></a><span id="l3.731" class="difflineminus">-				return status;</span>
<a href="#l3.732"></a><span id="l3.732" class="difflineminus">-		}</span>
<a href="#l3.733"></a><span id="l3.733" class="difflineminus">-	}</span>
<a href="#l3.734"></a><span id="l3.734" class="difflineminus">-	</span>
<a href="#l3.735"></a><span id="l3.735" class="difflineminus">-	if (retval == eofErr)</span>
<a href="#l3.736"></a><span id="l3.736" class="difflineminus">-	{</span>
<a href="#l3.737"></a><span id="l3.737" class="difflineminus">-        ::FSCloseFork(fileId);</span>
<a href="#l3.738"></a><span id="l3.738" class="difflineminus">-        p_ap_encode_obj-&gt;fileId = 0;</span>
<a href="#l3.739"></a><span id="l3.739" class="difflineplus">+    p_ap_encode_obj-&gt;fileId = fileId;</span>
<a href="#l3.740"></a><span id="l3.740"> </span>
<a href="#l3.741"></a><span id="l3.741" class="difflineminus">-		status = finish64(p_ap_encode_obj);</span>
<a href="#l3.742"></a><span id="l3.742" class="difflineminus">-		if (status != noErr)</span>
<a href="#l3.743"></a><span id="l3.743" class="difflineminus">-			return status;</span>
<a href="#l3.744"></a><span id="l3.744" class="difflineminus">-		</span>
<a href="#l3.745"></a><span id="l3.745" class="difflineminus">-		/*</span>
<a href="#l3.746"></a><span id="l3.746" class="difflineminus">-		** write out the boundary</span>
<a href="#l3.747"></a><span id="l3.747" class="difflineminus">-		*/</span>
<a href="#l3.748"></a><span id="l3.748" class="difflineminus">-		PR_snprintf(rd_buff, sizeof(rd_buff),</span>
<a href="#l3.749"></a><span id="l3.749" class="difflineminus">-						CRLF &quot;--%s&quot; CRLF,</span>
<a href="#l3.750"></a><span id="l3.750" class="difflineminus">-						p_ap_encode_obj-&gt;boundary);</span>
<a href="#l3.751"></a><span id="l3.751" class="difflineminus">-					</span>
<a href="#l3.752"></a><span id="l3.752" class="difflineminus">-		status = write_stream(p_ap_encode_obj, (const char*)rd_buff, strlen(rd_buff));</span>
<a href="#l3.753"></a><span id="l3.753" class="difflineminus">-		if (status == noErr)</span>
<a href="#l3.754"></a><span id="l3.754" class="difflineminus">-			status = errDone;</span>
<a href="#l3.755"></a><span id="l3.755" class="difflineminus">-	}</span>
<a href="#l3.756"></a><span id="l3.756" class="difflineminus">-	return status;</span>
<a href="#l3.757"></a><span id="l3.757" class="difflineminus">-}</span>
<a href="#l3.758"></a><span id="l3.758" class="difflineminus">-</span>
<a href="#l3.759"></a><span id="l3.759" class="difflineminus">-#if 0</span>
<a href="#l3.760"></a><span id="l3.760" class="difflineminus">-// This is unused for now and Clang complains about that is it is ifdefed out</span>
<a href="#l3.761"></a><span id="l3.761" class="difflineminus">-static void replace(char *p, int len, char frm, char to)</span>
<a href="#l3.762"></a><span id="l3.762" class="difflineminus">-{</span>
<a href="#l3.763"></a><span id="l3.763" class="difflineminus">-	for (; len &gt; 0; len--, p++)</span>
<a href="#l3.764"></a><span id="l3.764" class="difflineminus">-		if (*p == frm)	*p = to;</span>
<a href="#l3.765"></a><span id="l3.765" class="difflineminus">-}</span>
<a href="#l3.766"></a><span id="l3.766" class="difflineminus">-#endif</span>
<a href="#l3.767"></a><span id="l3.767" class="difflineminus">-</span>
<a href="#l3.768"></a><span id="l3.768" class="difflineminus">-/* Description of the various file formats and their magic numbers 		*/</span>
<a href="#l3.769"></a><span id="l3.769" class="difflineminus">-struct magic</span>
<a href="#l3.770"></a><span id="l3.770" class="difflineminus">-{</span>
<a href="#l3.771"></a><span id="l3.771" class="difflineminus">-    const char *name;			/* Name of the file format */</span>
<a href="#l3.772"></a><span id="l3.772" class="difflineminus">-    const char *num;			/* The magic number */</span>
<a href="#l3.773"></a><span id="l3.773" class="difflineminus">-    int        len;			/* Length (0 means strlen(magicnum)) */</span>
<a href="#l3.774"></a><span id="l3.774" class="difflineminus">-};</span>
<a href="#l3.775"></a><span id="l3.775" class="difflineminus">-</span>
<a href="#l3.776"></a><span id="l3.776" class="difflineminus">-/* The magic numbers of the file formats we know about */</span>
<a href="#l3.777"></a><span id="l3.777" class="difflineminus">-static struct magic magic[] =</span>
<a href="#l3.778"></a><span id="l3.778" class="difflineminus">-{</span>
<a href="#l3.779"></a><span id="l3.779" class="difflineminus">-    { &quot;image/gif&quot;, 	&quot;GIF&quot;, 			  0 },</span>
<a href="#l3.780"></a><span id="l3.780" class="difflineminus">-    { &quot;image/jpeg&quot;, &quot;\377\330\377&quot;,   0 },</span>
<a href="#l3.781"></a><span id="l3.781" class="difflineminus">-    { &quot;video/mpeg&quot;, &quot;\0\0\001\263&quot;,	  4 },</span>
<a href="#l3.782"></a><span id="l3.782" class="difflineminus">-    { &quot;application/postscript&quot;, &quot;%!&quot;, 0 },</span>
<a href="#l3.783"></a><span id="l3.783" class="difflineminus">-};</span>
<a href="#l3.784"></a><span id="l3.784" class="difflineminus">-static int num_magic = MOZ_ARRAY_LENGTH(magic);</span>
<a href="#l3.785"></a><span id="l3.785" class="difflineminus">-</span>
<a href="#l3.786"></a><span id="l3.786" class="difflineminus">-static const char *text_type    = TEXT_PLAIN;					/* the text file type. */</span>
<a href="#l3.787"></a><span id="l3.787" class="difflineminus">-static const char *default_type = APPLICATION_OCTET_STREAM;</span>
<a href="#l3.788"></a><span id="l3.788" class="difflineminus">-</span>
<a href="#l3.789"></a><span id="l3.789" class="difflineminus">-</span>
<a href="#l3.790"></a><span id="l3.790" class="difflineminus">-/*</span>
<a href="#l3.791"></a><span id="l3.791" class="difflineminus">- * Determines the format of the file &quot;inputf&quot;.  The name</span>
<a href="#l3.792"></a><span id="l3.792" class="difflineminus">- * of the file format (or NULL on error) is returned.</span>
<a href="#l3.793"></a><span id="l3.793" class="difflineminus">- */</span>
<a href="#l3.794"></a><span id="l3.794" class="difflineminus">-static const char *magic_look(char *inbuff, int numread)</span>
<a href="#l3.795"></a><span id="l3.795" class="difflineminus">-{</span>
<a href="#l3.796"></a><span id="l3.796" class="difflineminus">-    int i, j;</span>
<a href="#l3.797"></a><span id="l3.797" class="difflineminus">-</span>
<a href="#l3.798"></a><span id="l3.798" class="difflineminus">-	for (i=0; i&lt;num_magic; i++)</span>
<a href="#l3.799"></a><span id="l3.799" class="difflineminus">-	{</span>
<a href="#l3.800"></a><span id="l3.800" class="difflineminus">-	   	if (magic[i].len == 0)</span>
<a href="#l3.801"></a><span id="l3.801" class="difflineminus">-	   		magic[i].len = strlen(magic[i].num);</span>
<a href="#l3.802"></a><span id="l3.802" class="difflineminus">-	}</span>
<a href="#l3.803"></a><span id="l3.803" class="difflineminus">-</span>
<a href="#l3.804"></a><span id="l3.804" class="difflineminus">-    for (i=0; i&lt;num_magic; i++)</span>
<a href="#l3.805"></a><span id="l3.805" class="difflineplus">+    if (!p_ap_encode_obj-&gt;text_file_type)</span>
<a href="#l3.806"></a><span id="l3.806">     {</span>
<a href="#l3.807"></a><span id="l3.807" class="difflineminus">-		if (numread &gt;= magic[i].len)</span>
<a href="#l3.808"></a><span id="l3.808" class="difflineminus">-		{</span>
<a href="#l3.809"></a><span id="l3.809" class="difflineminus">-	    	for (j=0; j&lt;magic[i].len; j++)</span>
<a href="#l3.810"></a><span id="l3.810" class="difflineminus">-	    	{</span>
<a href="#l3.811"></a><span id="l3.811" class="difflineminus">-				if (inbuff[j] != magic[i].num[j]) break;</span>
<a href="#l3.812"></a><span id="l3.812" class="difflineminus">-	    	}</span>
<a href="#l3.813"></a><span id="l3.813" class="difflineminus">-	    	</span>
<a href="#l3.814"></a><span id="l3.814" class="difflineminus">-	    	if (j == magic[i].len)</span>
<a href="#l3.815"></a><span id="l3.815" class="difflineminus">-	    		return magic[i].name;</span>
<a href="#l3.816"></a><span id="l3.816" class="difflineminus">-		}</span>
<a href="#l3.817"></a><span id="l3.817" class="difflineminus">-    }</span>
<a href="#l3.818"></a><span id="l3.818" class="difflineminus">-</span>
<a href="#l3.819"></a><span id="l3.819" class="difflineminus">-    return default_type;</span>
<a href="#l3.820"></a><span id="l3.820" class="difflineminus">-}</span>
<a href="#l3.821"></a><span id="l3.821" class="difflineminus">-/*</span>
<a href="#l3.822"></a><span id="l3.822" class="difflineminus">-**	ap_encode_data</span>
<a href="#l3.823"></a><span id="l3.823" class="difflineminus">-**</span>
<a href="#l3.824"></a><span id="l3.824" class="difflineminus">-**	---------------</span>
<a href="#l3.825"></a><span id="l3.825" class="difflineminus">-**</span>
<a href="#l3.826"></a><span id="l3.826" class="difflineminus">-**		encode on the data fork.</span>
<a href="#l3.827"></a><span id="l3.827" class="difflineminus">-**</span>
<a href="#l3.828"></a><span id="l3.828" class="difflineminus">-*/</span>
<a href="#l3.829"></a><span id="l3.829" class="difflineminus">-int ap_encode_data(</span>
<a href="#l3.830"></a><span id="l3.830" class="difflineminus">-	appledouble_encode_object* p_ap_encode_obj,</span>
<a href="#l3.831"></a><span id="l3.831" class="difflineminus">-	bool firstime)</span>
<a href="#l3.832"></a><span id="l3.832" class="difflineminus">-{</span>
<a href="#l3.833"></a><span id="l3.833" class="difflineminus">-	char   		rd_buff[256];</span>
<a href="#l3.834"></a><span id="l3.834" class="difflineminus">-    FSIORefNum fileId;</span>
<a href="#l3.835"></a><span id="l3.835" class="difflineminus">-	OSErr		retval = noErr;</span>
<a href="#l3.836"></a><span id="l3.836" class="difflineminus">-    ByteCount in_count;</span>
<a href="#l3.837"></a><span id="l3.837" class="difflineminus">-	int			status;</span>
<a href="#l3.838"></a><span id="l3.838" class="difflineminus">-	</span>
<a href="#l3.839"></a><span id="l3.839" class="difflineminus">-	if (firstime)</span>
<a href="#l3.840"></a><span id="l3.840" class="difflineminus">-	{	</span>
<a href="#l3.841"></a><span id="l3.841" class="difflineminus">-		const char* magic_type;</span>
<a href="#l3.842"></a><span id="l3.842" class="difflineminus">-			</span>
<a href="#l3.843"></a><span id="l3.843" class="difflineminus">-		/*</span>
<a href="#l3.844"></a><span id="l3.844" class="difflineminus">-		** preparing to encode the data fork.</span>
<a href="#l3.845"></a><span id="l3.845" class="difflineminus">-		*/</span>
<a href="#l3.846"></a><span id="l3.846" class="difflineminus">-        nsCOMPtr &lt;nsIFile&gt; resFile;</span>
<a href="#l3.847"></a><span id="l3.847" class="difflineminus">-        NS_NewNativeLocalFile(nsDependentCString(p_ap_encode_obj-&gt;fname), true,</span>
<a href="#l3.848"></a><span id="l3.848" class="difflineminus">-                              getter_AddRefs(resFile));</span>
<a href="#l3.849"></a><span id="l3.849" class="difflineminus">-        if (!resFile)</span>
<a href="#l3.850"></a><span id="l3.850" class="difflineminus">-            return errFileOpen;</span>
<a href="#l3.851"></a><span id="l3.851" class="difflineminus">-</span>
<a href="#l3.852"></a><span id="l3.852" class="difflineminus">-        FSRef ref;</span>
<a href="#l3.853"></a><span id="l3.853" class="difflineminus">-        nsCOMPtr &lt;nsILocalFileMac&gt; macFile = do_QueryInterface(resFile);</span>
<a href="#l3.854"></a><span id="l3.854" class="difflineminus">-        if (NS_FAILED(macFile-&gt;GetFSRef(&amp;ref)))</span>
<a href="#l3.855"></a><span id="l3.855" class="difflineminus">-            return errFileOpen;</span>
<a href="#l3.856"></a><span id="l3.856" class="difflineminus">-</span>
<a href="#l3.857"></a><span id="l3.857" class="difflineminus">-        HFSUniStr255 forkName;</span>
<a href="#l3.858"></a><span id="l3.858" class="difflineminus">-        ::FSGetDataForkName(&amp;forkName);</span>
<a href="#l3.859"></a><span id="l3.859" class="difflineminus">-        retval = ::FSOpenFork(&amp;ref, forkName.length, forkName.unicode, fsRdPerm, &amp;fileId);</span>
<a href="#l3.860"></a><span id="l3.860" class="difflineminus">-        if (retval != noErr)</span>
<a href="#l3.861"></a><span id="l3.861" class="difflineminus">-            return retval;</span>
<a href="#l3.862"></a><span id="l3.862" class="difflineminus">-</span>
<a href="#l3.863"></a><span id="l3.863" class="difflineminus">-		p_ap_encode_obj-&gt;fileId = fileId;</span>
<a href="#l3.864"></a><span id="l3.864" class="difflineminus">-			</span>
<a href="#l3.865"></a><span id="l3.865" class="difflineminus">-		</span>
<a href="#l3.866"></a><span id="l3.866" class="difflineminus">-		if (!p_ap_encode_obj-&gt;text_file_type)</span>
<a href="#l3.867"></a><span id="l3.867" class="difflineminus">-		{	</span>
<a href="#l3.868"></a><span id="l3.868">       /*</span>
<a href="#l3.869"></a><span id="l3.869" class="difflineminus">-      **	do a smart check for the file type.</span>
<a href="#l3.870"></a><span id="l3.870" class="difflineplus">+      **  do a smart check for the file type.</span>
<a href="#l3.871"></a><span id="l3.871">       */</span>
<a href="#l3.872"></a><span id="l3.872">       in_count = 0;</span>
<a href="#l3.873"></a><span id="l3.873">       retval = ::FSReadFork(fileId, fsFromStart, 0, 256, rd_buff, &amp;in_count);</span>
<a href="#l3.874"></a><span id="l3.874">       magic_type = magic_look(rd_buff, in_count);</span>
<a href="#l3.875"></a><span id="l3.875"> </span>
<a href="#l3.876"></a><span id="l3.876">       /* don't forget to rewind the index to start point. */</span>
<a href="#l3.877"></a><span id="l3.877">       ::FSSetForkPosition(fileId, fsFromStart, 0);</span>
<a href="#l3.878"></a><span id="l3.878">       /* and reset retVal just in case... */</span>
<a href="#l3.879"></a><span id="l3.879">       if (retval == eofErr)</span>
<a href="#l3.880"></a><span id="l3.880">         retval = noErr;</span>
<a href="#l3.881"></a><span id="l3.881" class="difflineminus">-		}</span>
<a href="#l3.882"></a><span id="l3.882" class="difflineminus">-		else</span>
<a href="#l3.883"></a><span id="l3.883" class="difflineminus">-		{</span>
<a href="#l3.884"></a><span id="l3.884" class="difflineminus">-			magic_type = text_type;		/* we already know it is a text type.	*/</span>
<a href="#l3.885"></a><span id="l3.885" class="difflineminus">-		}</span>
<a href="#l3.886"></a><span id="l3.886" class="difflineplus">+    }</span>
<a href="#l3.887"></a><span id="l3.887" class="difflineplus">+    else</span>
<a href="#l3.888"></a><span id="l3.888" class="difflineplus">+    {</span>
<a href="#l3.889"></a><span id="l3.889" class="difflineplus">+      magic_type = text_type;    /* we already know it is a text type.  */</span>
<a href="#l3.890"></a><span id="l3.890" class="difflineplus">+    }</span>
<a href="#l3.891"></a><span id="l3.891"> </span>
<a href="#l3.892"></a><span id="l3.892" class="difflineminus">-		/*</span>
<a href="#l3.893"></a><span id="l3.893" class="difflineminus">-		**	the data portion header information.</span>
<a href="#l3.894"></a><span id="l3.894" class="difflineminus">-		*/</span>
<a href="#l3.895"></a><span id="l3.895" class="difflineplus">+    /*</span>
<a href="#l3.896"></a><span id="l3.896" class="difflineplus">+    **  the data portion header information.</span>
<a href="#l3.897"></a><span id="l3.897" class="difflineplus">+    */</span>
<a href="#l3.898"></a><span id="l3.898">         nsAutoCString leafName;</span>
<a href="#l3.899"></a><span id="l3.899">         resFile-&gt;GetNativeLeafName(leafName);</span>
<a href="#l3.900"></a><span id="l3.900" class="difflineminus">-		PR_snprintf(rd_buff, sizeof(rd_buff),</span>
<a href="#l3.901"></a><span id="l3.901" class="difflineminus">-			&quot;Content-Type: %s; name=\&quot;%s\&quot;&quot; CRLF &quot;Content-Transfer-Encoding: base64&quot; CRLF &quot;Content-Disposition: inline; filename=\&quot;%s\&quot;&quot; CRLF CRLF,</span>
<a href="#l3.902"></a><span id="l3.902" class="difflineminus">-			magic_type,</span>
<a href="#l3.903"></a><span id="l3.903" class="difflineminus">-			leafName.get(),</span>
<a href="#l3.904"></a><span id="l3.904" class="difflineminus">-			leafName.get());</span>
<a href="#l3.905"></a><span id="l3.905" class="difflineminus">-			</span>
<a href="#l3.906"></a><span id="l3.906" class="difflineminus">-		status = write_stream(p_ap_encode_obj, (const char*)rd_buff, strlen(rd_buff));</span>
<a href="#l3.907"></a><span id="l3.907" class="difflineminus">-		if (status != noErr)</span>
<a href="#l3.908"></a><span id="l3.908" class="difflineminus">-			return status;</span>
<a href="#l3.909"></a><span id="l3.909" class="difflineminus">-	}</span>
<a href="#l3.910"></a><span id="l3.910" class="difflineminus">-	</span>
<a href="#l3.911"></a><span id="l3.911" class="difflineminus">-	while (retval == noErr)</span>
<a href="#l3.912"></a><span id="l3.912" class="difflineminus">-	{</span>
<a href="#l3.913"></a><span id="l3.913" class="difflineminus">-		if (BUFF_LEFT(p_ap_encode_obj) &lt; 400)</span>
<a href="#l3.914"></a><span id="l3.914" class="difflineminus">-			break;</span>
<a href="#l3.915"></a><span id="l3.915" class="difflineminus">-			</span>
<a href="#l3.916"></a><span id="l3.916" class="difflineminus">-        in_count = 0;</span>
<a href="#l3.917"></a><span id="l3.917" class="difflineminus">-        retval = ::FSReadFork(p_ap_encode_obj-&gt;fileId, fsAtMark, 0, 256, rd_buff, &amp;in_count);</span>
<a href="#l3.918"></a><span id="l3.918" class="difflineminus">-		if (in_count)</span>
<a href="#l3.919"></a><span id="l3.919" class="difflineminus">-		{</span>
<a href="#l3.920"></a><span id="l3.920" class="difflineplus">+    PR_snprintf(rd_buff, sizeof(rd_buff),</span>
<a href="#l3.921"></a><span id="l3.921" class="difflineplus">+      &quot;Content-Type: %s; name=\&quot;%s\&quot;&quot; CRLF &quot;Content-Transfer-Encoding: base64&quot; CRLF &quot;Content-Disposition: inline; filename=\&quot;%s\&quot;&quot; CRLF CRLF,</span>
<a href="#l3.922"></a><span id="l3.922" class="difflineplus">+      magic_type,</span>
<a href="#l3.923"></a><span id="l3.923" class="difflineplus">+      leafName.get(),</span>
<a href="#l3.924"></a><span id="l3.924" class="difflineplus">+      leafName.get());</span>
<a href="#l3.925"></a><span id="l3.925" class="difflineplus">+</span>
<a href="#l3.926"></a><span id="l3.926" class="difflineplus">+    status = write_stream(p_ap_encode_obj, (const char*)rd_buff, strlen(rd_buff));</span>
<a href="#l3.927"></a><span id="l3.927" class="difflineplus">+    if (status != noErr)</span>
<a href="#l3.928"></a><span id="l3.928" class="difflineplus">+      return status;</span>
<a href="#l3.929"></a><span id="l3.929" class="difflineplus">+  }</span>
<a href="#l3.930"></a><span id="l3.930" class="difflineplus">+</span>
<a href="#l3.931"></a><span id="l3.931" class="difflineplus">+  while (retval == noErr)</span>
<a href="#l3.932"></a><span id="l3.932" class="difflineplus">+  {</span>
<a href="#l3.933"></a><span id="l3.933" class="difflineplus">+    if (BUFF_LEFT(p_ap_encode_obj) &lt; 400)</span>
<a href="#l3.934"></a><span id="l3.934" class="difflineplus">+      break;</span>
<a href="#l3.935"></a><span id="l3.935" class="difflineplus">+</span>
<a href="#l3.936"></a><span id="l3.936" class="difflineplus">+    in_count = 0;</span>
<a href="#l3.937"></a><span id="l3.937" class="difflineplus">+    retval = ::FSReadFork(p_ap_encode_obj-&gt;fileId, fsAtMark, 0, 256, rd_buff, &amp;in_count);</span>
<a href="#l3.938"></a><span id="l3.938" class="difflineplus">+    if (in_count)</span>
<a href="#l3.939"></a><span id="l3.939" class="difflineplus">+    {</span>
<a href="#l3.940"></a><span id="l3.940"> #if 0</span>
<a href="#l3.941"></a><span id="l3.941" class="difflineminus">-/*			replace(rd_buff, in_count, '\r', '\n');	 						*/</span>
<a href="#l3.942"></a><span id="l3.942" class="difflineplus">+/*      replace(rd_buff, in_count, '\r', '\n');               */</span>
<a href="#l3.943"></a><span id="l3.943"> #endif</span>
<a href="#l3.944"></a><span id="l3.944" class="difflineminus">-/* ** may be need to do character set conversion here for localization.	**  */		</span>
<a href="#l3.945"></a><span id="l3.945" class="difflineminus">-			status = to64(p_ap_encode_obj,</span>
<a href="#l3.946"></a><span id="l3.946" class="difflineminus">-						rd_buff,</span>
<a href="#l3.947"></a><span id="l3.947" class="difflineminus">-						in_count);</span>
<a href="#l3.948"></a><span id="l3.948" class="difflineminus">-			if (status != noErr)</span>
<a href="#l3.949"></a><span id="l3.949" class="difflineminus">-				return status;</span>
<a href="#l3.950"></a><span id="l3.950" class="difflineminus">-		}</span>
<a href="#l3.951"></a><span id="l3.951" class="difflineminus">-	}</span>
<a href="#l3.952"></a><span id="l3.952" class="difflineminus">-	</span>
<a href="#l3.953"></a><span id="l3.953" class="difflineminus">-	if (retval == eofErr)</span>
<a href="#l3.954"></a><span id="l3.954" class="difflineminus">-	{</span>
<a href="#l3.955"></a><span id="l3.955" class="difflineminus">-        ::FSCloseFork(p_ap_encode_obj-&gt;fileId);</span>
<a href="#l3.956"></a><span id="l3.956" class="difflineminus">-        p_ap_encode_obj-&gt;fileId = 0;</span>
<a href="#l3.957"></a><span id="l3.957" class="difflineplus">+/* ** may be need to do character set conversion here for localization.  **  */</span>
<a href="#l3.958"></a><span id="l3.958" class="difflineplus">+      status = to64(p_ap_encode_obj,</span>
<a href="#l3.959"></a><span id="l3.959" class="difflineplus">+                    rd_buff,</span>
<a href="#l3.960"></a><span id="l3.960" class="difflineplus">+                    in_count);</span>
<a href="#l3.961"></a><span id="l3.961" class="difflineplus">+      if (status != noErr)</span>
<a href="#l3.962"></a><span id="l3.962" class="difflineplus">+        return status;</span>
<a href="#l3.963"></a><span id="l3.963" class="difflineplus">+    }</span>
<a href="#l3.964"></a><span id="l3.964" class="difflineplus">+  }</span>
<a href="#l3.965"></a><span id="l3.965" class="difflineplus">+</span>
<a href="#l3.966"></a><span id="l3.966" class="difflineplus">+  if (retval == eofErr)</span>
<a href="#l3.967"></a><span id="l3.967" class="difflineplus">+  {</span>
<a href="#l3.968"></a><span id="l3.968" class="difflineplus">+    ::FSCloseFork(p_ap_encode_obj-&gt;fileId);</span>
<a href="#l3.969"></a><span id="l3.969" class="difflineplus">+    p_ap_encode_obj-&gt;fileId = 0;</span>
<a href="#l3.970"></a><span id="l3.970"> </span>
<a href="#l3.971"></a><span id="l3.971" class="difflineminus">-		status = finish64(p_ap_encode_obj);</span>
<a href="#l3.972"></a><span id="l3.972" class="difflineminus">-		if (status != noErr)</span>
<a href="#l3.973"></a><span id="l3.973" class="difflineminus">-			return status;</span>
<a href="#l3.974"></a><span id="l3.974" class="difflineminus">-		</span>
<a href="#l3.975"></a><span id="l3.975" class="difflineminus">-		/* write out the boundary 	*/</span>
<a href="#l3.976"></a><span id="l3.976" class="difflineminus">-		</span>
<a href="#l3.977"></a><span id="l3.977" class="difflineminus">-		PR_snprintf(rd_buff, sizeof(rd_buff),</span>
<a href="#l3.978"></a><span id="l3.978" class="difflineminus">-						CRLF &quot;--%s--&quot; CRLF CRLF,</span>
<a href="#l3.979"></a><span id="l3.979" class="difflineminus">-						p_ap_encode_obj-&gt;boundary);</span>
<a href="#l3.980"></a><span id="l3.980" class="difflineminus">-	</span>
<a href="#l3.981"></a><span id="l3.981" class="difflineminus">-		status = write_stream(p_ap_encode_obj, (const char*)rd_buff, strlen(rd_buff));</span>
<a href="#l3.982"></a><span id="l3.982" class="difflineminus">-	</span>
<a href="#l3.983"></a><span id="l3.983" class="difflineminus">-		if (status == noErr)				</span>
<a href="#l3.984"></a><span id="l3.984" class="difflineminus">-			status = errDone;</span>
<a href="#l3.985"></a><span id="l3.985" class="difflineminus">-	}</span>
<a href="#l3.986"></a><span id="l3.986" class="difflineminus">-	return status;</span>
<a href="#l3.987"></a><span id="l3.987" class="difflineplus">+    status = finish64(p_ap_encode_obj);</span>
<a href="#l3.988"></a><span id="l3.988" class="difflineplus">+    if (status != noErr)</span>
<a href="#l3.989"></a><span id="l3.989" class="difflineplus">+      return status;</span>
<a href="#l3.990"></a><span id="l3.990" class="difflineplus">+</span>
<a href="#l3.991"></a><span id="l3.991" class="difflineplus">+    /* write out the boundary   */</span>
<a href="#l3.992"></a><span id="l3.992" class="difflineplus">+</span>
<a href="#l3.993"></a><span id="l3.993" class="difflineplus">+    PR_snprintf(rd_buff, sizeof(rd_buff),</span>
<a href="#l3.994"></a><span id="l3.994" class="difflineplus">+                CRLF &quot;--%s--&quot; CRLF CRLF,</span>
<a href="#l3.995"></a><span id="l3.995" class="difflineplus">+                p_ap_encode_obj-&gt;boundary);</span>
<a href="#l3.996"></a><span id="l3.996" class="difflineplus">+</span>
<a href="#l3.997"></a><span id="l3.997" class="difflineplus">+    status = write_stream(p_ap_encode_obj, (const char*)rd_buff, strlen(rd_buff));</span>
<a href="#l3.998"></a><span id="l3.998" class="difflineplus">+</span>
<a href="#l3.999"></a><span id="l3.999" class="difflineplus">+    if (status == noErr)</span>
<a href="#l3.1000"></a><span id="l3.1000" class="difflineplus">+      status = errDone;</span>
<a href="#l3.1001"></a><span id="l3.1001" class="difflineplus">+  }</span>
<a href="#l3.1002"></a><span id="l3.1002" class="difflineplus">+  return status;</span>
<a href="#l3.1003"></a><span id="l3.1003"> }</span>
<a href="#l3.1004"></a><span id="l3.1004"> </span>
<a href="#l3.1005"></a><span id="l3.1005"> static char basis_64[] =</span>
<a href="#l3.1006"></a><span id="l3.1006">    &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;;</span>
<a href="#l3.1007"></a><span id="l3.1007"> </span>
<a href="#l3.1008"></a><span id="l3.1008"> /*</span>
<a href="#l3.1009"></a><span id="l3.1009" class="difflineminus">-**	convert the stream in the inbuff to 64 format and put it in the out buff.</span>
<a href="#l3.1010"></a><span id="l3.1010" class="difflineplus">+**  convert the stream in the inbuff to 64 format and put it in the out buff.</span>
<a href="#l3.1011"></a><span id="l3.1011"> **  To make the life easier, the caller will responcable of the checking of the outbuff's bundary.</span>
<a href="#l3.1012"></a><span id="l3.1012"> */</span>
<a href="#l3.1013"></a><span id="l3.1013"> static int</span>
<a href="#l3.1014"></a><span id="l3.1014"> to64(appledouble_encode_object* p_ap_encode_obj,</span>
<a href="#l3.1015"></a><span id="l3.1015" class="difflineminus">-	char	*p,</span>
<a href="#l3.1016"></a><span id="l3.1016" class="difflineminus">-	int 	in_size)</span>
<a href="#l3.1017"></a><span id="l3.1017" class="difflineplus">+  char  *p,</span>
<a href="#l3.1018"></a><span id="l3.1018" class="difflineplus">+  int   in_size)</span>
<a href="#l3.1019"></a><span id="l3.1019"> {</span>
<a href="#l3.1020"></a><span id="l3.1020" class="difflineminus">-	int 	status;</span>
<a href="#l3.1021"></a><span id="l3.1021" class="difflineminus">-    int c1, c2, c3, ct;</span>
<a href="#l3.1022"></a><span id="l3.1022" class="difflineminus">-    unsigned char *inbuff = (unsigned char*)p;</span>
<a href="#l3.1023"></a><span id="l3.1023" class="difflineplus">+  int   status;</span>
<a href="#l3.1024"></a><span id="l3.1024" class="difflineplus">+  int c1, c2, c3, ct;</span>
<a href="#l3.1025"></a><span id="l3.1025" class="difflineplus">+  unsigned char *inbuff = (unsigned char*)p;</span>
<a href="#l3.1026"></a><span id="l3.1026" class="difflineplus">+</span>
<a href="#l3.1027"></a><span id="l3.1027" class="difflineplus">+  ct = p_ap_encode_obj-&gt;ct;      /* the char count left last time. */</span>
<a href="#l3.1028"></a><span id="l3.1028" class="difflineplus">+</span>
<a href="#l3.1029"></a><span id="l3.1029" class="difflineplus">+  /*</span>
<a href="#l3.1030"></a><span id="l3.1030" class="difflineplus">+  **   resume the left state of the last conversion.</span>
<a href="#l3.1031"></a><span id="l3.1031" class="difflineplus">+  */</span>
<a href="#l3.1032"></a><span id="l3.1032" class="difflineplus">+  switch (p_ap_encode_obj-&gt;state64)</span>
<a href="#l3.1033"></a><span id="l3.1033" class="difflineplus">+  {</span>
<a href="#l3.1034"></a><span id="l3.1034" class="difflineplus">+    case 0:</span>
<a href="#l3.1035"></a><span id="l3.1035" class="difflineplus">+      p_ap_encode_obj-&gt;c1 = c1 = *inbuff ++;</span>
<a href="#l3.1036"></a><span id="l3.1036" class="difflineplus">+      if (--in_size &lt;= 0)</span>
<a href="#l3.1037"></a><span id="l3.1037" class="difflineplus">+      {</span>
<a href="#l3.1038"></a><span id="l3.1038" class="difflineplus">+        p_ap_encode_obj-&gt;state64 = 1;</span>
<a href="#l3.1039"></a><span id="l3.1039" class="difflineplus">+        return noErr;</span>
<a href="#l3.1040"></a><span id="l3.1040" class="difflineplus">+      }</span>
<a href="#l3.1041"></a><span id="l3.1041" class="difflineplus">+      p_ap_encode_obj-&gt;c2 = c2 = *inbuff ++;</span>
<a href="#l3.1042"></a><span id="l3.1042" class="difflineplus">+      if (--in_size &lt;= 0)</span>
<a href="#l3.1043"></a><span id="l3.1043" class="difflineplus">+      {</span>
<a href="#l3.1044"></a><span id="l3.1044" class="difflineplus">+        p_ap_encode_obj-&gt;state64 = 2;</span>
<a href="#l3.1045"></a><span id="l3.1045" class="difflineplus">+        return noErr;</span>
<a href="#l3.1046"></a><span id="l3.1046" class="difflineplus">+      }</span>
<a href="#l3.1047"></a><span id="l3.1047" class="difflineplus">+      c3 = *inbuff ++;    --in_size;</span>
<a href="#l3.1048"></a><span id="l3.1048" class="difflineplus">+      break;</span>
<a href="#l3.1049"></a><span id="l3.1049" class="difflineplus">+    case 1:</span>
<a href="#l3.1050"></a><span id="l3.1050" class="difflineplus">+      c1 = p_ap_encode_obj-&gt;c1;</span>
<a href="#l3.1051"></a><span id="l3.1051" class="difflineplus">+      p_ap_encode_obj-&gt;c2 = c2 = *inbuff ++;</span>
<a href="#l3.1052"></a><span id="l3.1052" class="difflineplus">+      if (--in_size &lt;= 0)</span>
<a href="#l3.1053"></a><span id="l3.1053" class="difflineplus">+      {</span>
<a href="#l3.1054"></a><span id="l3.1054" class="difflineplus">+        p_ap_encode_obj-&gt;state64 = 2;</span>
<a href="#l3.1055"></a><span id="l3.1055" class="difflineplus">+        return noErr;</span>
<a href="#l3.1056"></a><span id="l3.1056" class="difflineplus">+      }</span>
<a href="#l3.1057"></a><span id="l3.1057" class="difflineplus">+      c3 = *inbuff ++;    --in_size;</span>
<a href="#l3.1058"></a><span id="l3.1058" class="difflineplus">+      break;</span>
<a href="#l3.1059"></a><span id="l3.1059" class="difflineplus">+    case 2:</span>
<a href="#l3.1060"></a><span id="l3.1060" class="difflineplus">+      c1 = p_ap_encode_obj-&gt;c1;</span>
<a href="#l3.1061"></a><span id="l3.1061" class="difflineplus">+      c2 = p_ap_encode_obj-&gt;c2;</span>
<a href="#l3.1062"></a><span id="l3.1062" class="difflineplus">+      c3 = *inbuff ++;    --in_size;</span>
<a href="#l3.1063"></a><span id="l3.1063" class="difflineplus">+      break;</span>
<a href="#l3.1064"></a><span id="l3.1064" class="difflineplus">+  }</span>
<a href="#l3.1065"></a><span id="l3.1065"> </span>
<a href="#l3.1066"></a><span id="l3.1066" class="difflineminus">-	ct = p_ap_encode_obj-&gt;ct;			/* the char count left last time. */</span>
<a href="#l3.1067"></a><span id="l3.1067" class="difflineminus">-	</span>
<a href="#l3.1068"></a><span id="l3.1068" class="difflineminus">-	/*</span>
<a href="#l3.1069"></a><span id="l3.1069" class="difflineminus">-	**	 resume the left state of the last conversion.</span>
<a href="#l3.1070"></a><span id="l3.1070" class="difflineminus">-	*/</span>
<a href="#l3.1071"></a><span id="l3.1071" class="difflineminus">-	switch (p_ap_encode_obj-&gt;state64)</span>
<a href="#l3.1072"></a><span id="l3.1072" class="difflineminus">-	{</span>
<a href="#l3.1073"></a><span id="l3.1073" class="difflineminus">-		case 0:</span>
<a href="#l3.1074"></a><span id="l3.1074" class="difflineminus">-			p_ap_encode_obj-&gt;c1 = c1 = *inbuff ++;</span>
<a href="#l3.1075"></a><span id="l3.1075" class="difflineminus">-			if (--in_size &lt;= 0)</span>
<a href="#l3.1076"></a><span id="l3.1076" class="difflineminus">-			{</span>
<a href="#l3.1077"></a><span id="l3.1077" class="difflineminus">-				p_ap_encode_obj-&gt;state64 = 1;</span>
<a href="#l3.1078"></a><span id="l3.1078" class="difflineminus">-				return noErr;</span>
<a href="#l3.1079"></a><span id="l3.1079" class="difflineminus">-			}</span>
<a href="#l3.1080"></a><span id="l3.1080" class="difflineminus">-			p_ap_encode_obj-&gt;c2 = c2 = *inbuff ++;</span>
<a href="#l3.1081"></a><span id="l3.1081" class="difflineminus">-			if (--in_size &lt;= 0)</span>
<a href="#l3.1082"></a><span id="l3.1082" class="difflineminus">-			{</span>
<a href="#l3.1083"></a><span id="l3.1083" class="difflineminus">-				p_ap_encode_obj-&gt;state64 = 2;</span>
<a href="#l3.1084"></a><span id="l3.1084" class="difflineminus">-				return noErr;</span>
<a href="#l3.1085"></a><span id="l3.1085" class="difflineminus">-			}</span>
<a href="#l3.1086"></a><span id="l3.1086" class="difflineminus">-			c3 = *inbuff ++;		--in_size;</span>
<a href="#l3.1087"></a><span id="l3.1087" class="difflineminus">-			break;</span>
<a href="#l3.1088"></a><span id="l3.1088" class="difflineminus">-		case 1:</span>
<a href="#l3.1089"></a><span id="l3.1089" class="difflineminus">-			c1 = p_ap_encode_obj-&gt;c1;</span>
<a href="#l3.1090"></a><span id="l3.1090" class="difflineminus">-			p_ap_encode_obj-&gt;c2 = c2 = *inbuff ++;</span>
<a href="#l3.1091"></a><span id="l3.1091" class="difflineminus">-			if (--in_size &lt;= 0)</span>
<a href="#l3.1092"></a><span id="l3.1092" class="difflineminus">-			{</span>
<a href="#l3.1093"></a><span id="l3.1093" class="difflineminus">-				p_ap_encode_obj-&gt;state64 = 2;</span>
<a href="#l3.1094"></a><span id="l3.1094" class="difflineminus">-				return noErr;</span>
<a href="#l3.1095"></a><span id="l3.1095" class="difflineminus">-			}</span>
<a href="#l3.1096"></a><span id="l3.1096" class="difflineminus">-			c3 = *inbuff ++;		--in_size;</span>
<a href="#l3.1097"></a><span id="l3.1097" class="difflineminus">-			break;</span>
<a href="#l3.1098"></a><span id="l3.1098" class="difflineminus">-		case 2:</span>
<a href="#l3.1099"></a><span id="l3.1099" class="difflineminus">-			c1 = p_ap_encode_obj-&gt;c1;</span>
<a href="#l3.1100"></a><span id="l3.1100" class="difflineminus">-			c2 = p_ap_encode_obj-&gt;c2;</span>
<a href="#l3.1101"></a><span id="l3.1101" class="difflineminus">-			c3 = *inbuff ++;		--in_size;</span>
<a href="#l3.1102"></a><span id="l3.1102" class="difflineminus">-			break;</span>
<a href="#l3.1103"></a><span id="l3.1103" class="difflineminus">-	}</span>
<a href="#l3.1104"></a><span id="l3.1104" class="difflineminus">-	</span>
<a href="#l3.1105"></a><span id="l3.1105" class="difflineminus">-    while (in_size &gt;= 0)</span>
<a href="#l3.1106"></a><span id="l3.1106" class="difflineplus">+  while (in_size &gt;= 0)</span>
<a href="#l3.1107"></a><span id="l3.1107" class="difflineplus">+  {</span>
<a href="#l3.1108"></a><span id="l3.1108" class="difflineplus">+    status = output64chunk(p_ap_encode_obj,</span>
<a href="#l3.1109"></a><span id="l3.1109" class="difflineplus">+                           c1,</span>
<a href="#l3.1110"></a><span id="l3.1110" class="difflineplus">+                           c2,</span>
<a href="#l3.1111"></a><span id="l3.1111" class="difflineplus">+                           c3,</span>
<a href="#l3.1112"></a><span id="l3.1112" class="difflineplus">+                           0);</span>
<a href="#l3.1113"></a><span id="l3.1113" class="difflineplus">+    if (status != noErr)</span>
<a href="#l3.1114"></a><span id="l3.1114" class="difflineplus">+      return status;</span>
<a href="#l3.1115"></a><span id="l3.1115" class="difflineplus">+  </span>
<a href="#l3.1116"></a><span id="l3.1116" class="difflineplus">+    ct += 4;</span>
<a href="#l3.1117"></a><span id="l3.1117" class="difflineplus">+    if (ct &gt; 71)</span>
<a href="#l3.1118"></a><span id="l3.1118" class="difflineplus">+    {</span>
<a href="#l3.1119"></a><span id="l3.1119" class="difflineplus">+      status = write_stream(p_ap_encode_obj,</span>
<a href="#l3.1120"></a><span id="l3.1120" class="difflineplus">+                CRLF,</span>
<a href="#l3.1121"></a><span id="l3.1121" class="difflineplus">+                2);</span>
<a href="#l3.1122"></a><span id="l3.1122" class="difflineplus">+      if (status != noErr)</span>
<a href="#l3.1123"></a><span id="l3.1123" class="difflineplus">+        return status;</span>
<a href="#l3.1124"></a><span id="l3.1124" class="difflineplus">+    </span>
<a href="#l3.1125"></a><span id="l3.1125" class="difflineplus">+      ct = 0;</span>
<a href="#l3.1126"></a><span id="l3.1126" class="difflineplus">+    }</span>
<a href="#l3.1127"></a><span id="l3.1127" class="difflineplus">+</span>
<a href="#l3.1128"></a><span id="l3.1128" class="difflineplus">+    if (in_size &lt;= 0)</span>
<a href="#l3.1129"></a><span id="l3.1129">     {</span>
<a href="#l3.1130"></a><span id="l3.1130" class="difflineminus">-    	status = output64chunk(p_ap_encode_obj,</span>
<a href="#l3.1131"></a><span id="l3.1131" class="difflineminus">-    							c1,</span>
<a href="#l3.1132"></a><span id="l3.1132" class="difflineminus">-    							c2,</span>
<a href="#l3.1133"></a><span id="l3.1133" class="difflineminus">-    							c3,</span>
<a href="#l3.1134"></a><span id="l3.1134" class="difflineminus">-    							0);</span>
<a href="#l3.1135"></a><span id="l3.1135" class="difflineminus">-    	if (status != noErr)</span>
<a href="#l3.1136"></a><span id="l3.1136" class="difflineminus">-    		return status;</span>
<a href="#l3.1137"></a><span id="l3.1137" class="difflineminus">-    		</span>
<a href="#l3.1138"></a><span id="l3.1138" class="difflineminus">-    	ct += 4;</span>
<a href="#l3.1139"></a><span id="l3.1139" class="difflineminus">-        if (ct &gt; 71)</span>
<a href="#l3.1140"></a><span id="l3.1140" class="difflineminus">-        {</span>
<a href="#l3.1141"></a><span id="l3.1141" class="difflineminus">-        	status = write_stream(p_ap_encode_obj,</span>
<a href="#l3.1142"></a><span id="l3.1142" class="difflineminus">-        						CRLF,</span>
<a href="#l3.1143"></a><span id="l3.1143" class="difflineminus">-        						2);</span>
<a href="#l3.1144"></a><span id="l3.1144" class="difflineminus">-        	if (status != noErr)</span>
<a href="#l3.1145"></a><span id="l3.1145" class="difflineminus">-        		return status;</span>
<a href="#l3.1146"></a><span id="l3.1146" class="difflineminus">-        		</span>
<a href="#l3.1147"></a><span id="l3.1147" class="difflineminus">-            ct = 0;</span>
<a href="#l3.1148"></a><span id="l3.1148" class="difflineminus">-        }</span>
<a href="#l3.1149"></a><span id="l3.1149" class="difflineplus">+      p_ap_encode_obj-&gt;state64 = 0;</span>
<a href="#l3.1150"></a><span id="l3.1150" class="difflineplus">+      break;</span>
<a href="#l3.1151"></a><span id="l3.1151" class="difflineplus">+    }</span>
<a href="#l3.1152"></a><span id="l3.1152"> </span>
<a href="#l3.1153"></a><span id="l3.1153" class="difflineminus">-		if (in_size &lt;= 0)</span>
<a href="#l3.1154"></a><span id="l3.1154" class="difflineminus">-		{</span>
<a href="#l3.1155"></a><span id="l3.1155" class="difflineminus">-			p_ap_encode_obj-&gt;state64 = 0;</span>
<a href="#l3.1156"></a><span id="l3.1156" class="difflineminus">-			break;</span>
<a href="#l3.1157"></a><span id="l3.1157" class="difflineminus">-		}</span>
<a href="#l3.1158"></a><span id="l3.1158" class="difflineminus">-		</span>
<a href="#l3.1159"></a><span id="l3.1159" class="difflineminus">-		c1 = (int)*inbuff++;</span>
<a href="#l3.1160"></a><span id="l3.1160" class="difflineminus">-		if (--in_size &lt;= 0)</span>
<a href="#l3.1161"></a><span id="l3.1161" class="difflineminus">-		{</span>
<a href="#l3.1162"></a><span id="l3.1162" class="difflineminus">-			p_ap_encode_obj-&gt;c1 = c1;</span>
<a href="#l3.1163"></a><span id="l3.1163" class="difflineminus">-			p_ap_encode_obj-&gt;state64 = 1;</span>
<a href="#l3.1164"></a><span id="l3.1164" class="difflineminus">-			break;</span>
<a href="#l3.1165"></a><span id="l3.1165" class="difflineminus">-		}</span>
<a href="#l3.1166"></a><span id="l3.1166" class="difflineminus">-		c2 = *inbuff++;</span>
<a href="#l3.1167"></a><span id="l3.1167" class="difflineminus">-		if (--in_size &lt;= 0)</span>
<a href="#l3.1168"></a><span id="l3.1168" class="difflineminus">-		{</span>
<a href="#l3.1169"></a><span id="l3.1169" class="difflineminus">-			p_ap_encode_obj-&gt;c1 	 = c1;</span>
<a href="#l3.1170"></a><span id="l3.1170" class="difflineminus">-			p_ap_encode_obj-&gt;c2 	 = c2;</span>
<a href="#l3.1171"></a><span id="l3.1171" class="difflineminus">-			p_ap_encode_obj-&gt;state64 = 2;</span>
<a href="#l3.1172"></a><span id="l3.1172" class="difflineminus">-			break;</span>
<a href="#l3.1173"></a><span id="l3.1173" class="difflineminus">-		}</span>
<a href="#l3.1174"></a><span id="l3.1174" class="difflineminus">-		c3 = *inbuff++;</span>
<a href="#l3.1175"></a><span id="l3.1175" class="difflineminus">-		in_size--;</span>
<a href="#l3.1176"></a><span id="l3.1176" class="difflineplus">+    c1 = (int)*inbuff++;</span>
<a href="#l3.1177"></a><span id="l3.1177" class="difflineplus">+    if (--in_size &lt;= 0)</span>
<a href="#l3.1178"></a><span id="l3.1178" class="difflineplus">+    {</span>
<a href="#l3.1179"></a><span id="l3.1179" class="difflineplus">+      p_ap_encode_obj-&gt;c1 = c1;</span>
<a href="#l3.1180"></a><span id="l3.1180" class="difflineplus">+      p_ap_encode_obj-&gt;state64 = 1;</span>
<a href="#l3.1181"></a><span id="l3.1181" class="difflineplus">+      break;</span>
<a href="#l3.1182"></a><span id="l3.1182">     }</span>
<a href="#l3.1183"></a><span id="l3.1183" class="difflineminus">-    p_ap_encode_obj-&gt;ct = ct;</span>
<a href="#l3.1184"></a><span id="l3.1184" class="difflineminus">-    return status;</span>
<a href="#l3.1185"></a><span id="l3.1185" class="difflineplus">+    c2 = *inbuff++;</span>
<a href="#l3.1186"></a><span id="l3.1186" class="difflineplus">+    if (--in_size &lt;= 0)</span>
<a href="#l3.1187"></a><span id="l3.1187" class="difflineplus">+    {</span>
<a href="#l3.1188"></a><span id="l3.1188" class="difflineplus">+      p_ap_encode_obj-&gt;c1    = c1;</span>
<a href="#l3.1189"></a><span id="l3.1189" class="difflineplus">+      p_ap_encode_obj-&gt;c2    = c2;</span>
<a href="#l3.1190"></a><span id="l3.1190" class="difflineplus">+      p_ap_encode_obj-&gt;state64 = 2;</span>
<a href="#l3.1191"></a><span id="l3.1191" class="difflineplus">+      break;</span>
<a href="#l3.1192"></a><span id="l3.1192" class="difflineplus">+    }</span>
<a href="#l3.1193"></a><span id="l3.1193" class="difflineplus">+    c3 = *inbuff++;</span>
<a href="#l3.1194"></a><span id="l3.1194" class="difflineplus">+    in_size--;</span>
<a href="#l3.1195"></a><span id="l3.1195" class="difflineplus">+  }</span>
<a href="#l3.1196"></a><span id="l3.1196" class="difflineplus">+  p_ap_encode_obj-&gt;ct = ct;</span>
<a href="#l3.1197"></a><span id="l3.1197" class="difflineplus">+  return status;</span>
<a href="#l3.1198"></a><span id="l3.1198"> }</span>
<a href="#l3.1199"></a><span id="l3.1199"> </span>
<a href="#l3.1200"></a><span id="l3.1200"> /*</span>
<a href="#l3.1201"></a><span id="l3.1201"> ** clear the left base64 encodes.</span>
<a href="#l3.1202"></a><span id="l3.1202"> */</span>
<a href="#l3.1203"></a><span id="l3.1203"> static int</span>
<a href="#l3.1204"></a><span id="l3.1204"> finish64(appledouble_encode_object* p_ap_encode_obj)</span>
<a href="#l3.1205"></a><span id="l3.1205"> {</span>
<a href="#l3.1206"></a><span id="l3.1206" class="difflineminus">-	int status;</span>
<a href="#l3.1207"></a><span id="l3.1207" class="difflineminus">-	</span>
<a href="#l3.1208"></a><span id="l3.1208" class="difflineminus">-	switch (p_ap_encode_obj-&gt;state64)</span>
<a href="#l3.1209"></a><span id="l3.1209" class="difflineminus">-	{</span>
<a href="#l3.1210"></a><span id="l3.1210" class="difflineminus">-		case 0:</span>
<a href="#l3.1211"></a><span id="l3.1211" class="difflineminus">-			break;</span>
<a href="#l3.1212"></a><span id="l3.1212" class="difflineminus">-		case 1:</span>
<a href="#l3.1213"></a><span id="l3.1213" class="difflineminus">-			status = output64chunk(p_ap_encode_obj,</span>
<a href="#l3.1214"></a><span id="l3.1214" class="difflineminus">-									p_ap_encode_obj-&gt;c1,</span>
<a href="#l3.1215"></a><span id="l3.1215" class="difflineminus">-									0,</span>
<a href="#l3.1216"></a><span id="l3.1216" class="difflineminus">-									0,</span>
<a href="#l3.1217"></a><span id="l3.1217" class="difflineminus">-									2);</span>
<a href="#l3.1218"></a><span id="l3.1218" class="difflineminus">-			break;</span>
<a href="#l3.1219"></a><span id="l3.1219" class="difflineminus">-		case 2:</span>
<a href="#l3.1220"></a><span id="l3.1220" class="difflineminus">-			status = output64chunk(p_ap_encode_obj,</span>
<a href="#l3.1221"></a><span id="l3.1221" class="difflineminus">-									p_ap_encode_obj-&gt;c1,</span>
<a href="#l3.1222"></a><span id="l3.1222" class="difflineminus">-									p_ap_encode_obj-&gt;c2,</span>
<a href="#l3.1223"></a><span id="l3.1223" class="difflineminus">-									0,</span>
<a href="#l3.1224"></a><span id="l3.1224" class="difflineminus">-									1);</span>
<a href="#l3.1225"></a><span id="l3.1225" class="difflineminus">-			break;</span>
<a href="#l3.1226"></a><span id="l3.1226" class="difflineminus">-	}</span>
<a href="#l3.1227"></a><span id="l3.1227" class="difflineminus">-	status = write_stream(p_ap_encode_obj, CRLF, 2);</span>
<a href="#l3.1228"></a><span id="l3.1228" class="difflineminus">-	p_ap_encode_obj-&gt;state64 = 0;</span>
<a href="#l3.1229"></a><span id="l3.1229" class="difflineminus">-	p_ap_encode_obj-&gt;ct	  	 = 0;</span>
<a href="#l3.1230"></a><span id="l3.1230" class="difflineminus">-	return status;</span>
<a href="#l3.1231"></a><span id="l3.1231" class="difflineplus">+  int status;</span>
<a href="#l3.1232"></a><span id="l3.1232" class="difflineplus">+</span>
<a href="#l3.1233"></a><span id="l3.1233" class="difflineplus">+  switch (p_ap_encode_obj-&gt;state64)</span>
<a href="#l3.1234"></a><span id="l3.1234" class="difflineplus">+  {</span>
<a href="#l3.1235"></a><span id="l3.1235" class="difflineplus">+    case 0:</span>
<a href="#l3.1236"></a><span id="l3.1236" class="difflineplus">+      break;</span>
<a href="#l3.1237"></a><span id="l3.1237" class="difflineplus">+    case 1:</span>
<a href="#l3.1238"></a><span id="l3.1238" class="difflineplus">+      status = output64chunk(p_ap_encode_obj,</span>
<a href="#l3.1239"></a><span id="l3.1239" class="difflineplus">+                             p_ap_encode_obj-&gt;c1,</span>
<a href="#l3.1240"></a><span id="l3.1240" class="difflineplus">+                             0,</span>
<a href="#l3.1241"></a><span id="l3.1241" class="difflineplus">+                             0,</span>
<a href="#l3.1242"></a><span id="l3.1242" class="difflineplus">+                             2);</span>
<a href="#l3.1243"></a><span id="l3.1243" class="difflineplus">+      break;</span>
<a href="#l3.1244"></a><span id="l3.1244" class="difflineplus">+    case 2:</span>
<a href="#l3.1245"></a><span id="l3.1245" class="difflineplus">+      status = output64chunk(p_ap_encode_obj,</span>
<a href="#l3.1246"></a><span id="l3.1246" class="difflineplus">+                             p_ap_encode_obj-&gt;c1,</span>
<a href="#l3.1247"></a><span id="l3.1247" class="difflineplus">+                             p_ap_encode_obj-&gt;c2,</span>
<a href="#l3.1248"></a><span id="l3.1248" class="difflineplus">+                             0,</span>
<a href="#l3.1249"></a><span id="l3.1249" class="difflineplus">+                             1);</span>
<a href="#l3.1250"></a><span id="l3.1250" class="difflineplus">+      break;</span>
<a href="#l3.1251"></a><span id="l3.1251" class="difflineplus">+  }</span>
<a href="#l3.1252"></a><span id="l3.1252" class="difflineplus">+  status = write_stream(p_ap_encode_obj, CRLF, 2);</span>
<a href="#l3.1253"></a><span id="l3.1253" class="difflineplus">+  p_ap_encode_obj-&gt;state64 = 0;</span>
<a href="#l3.1254"></a><span id="l3.1254" class="difflineplus">+  p_ap_encode_obj-&gt;ct       = 0;</span>
<a href="#l3.1255"></a><span id="l3.1255" class="difflineplus">+  return status;</span>
<a href="#l3.1256"></a><span id="l3.1256"> }</span>
<a href="#l3.1257"></a><span id="l3.1257"> </span>
<a href="#l3.1258"></a><span id="l3.1258"> static int output64chunk(</span>
<a href="#l3.1259"></a><span id="l3.1259" class="difflineminus">-	appledouble_encode_object* p_ap_encode_obj,</span>
<a href="#l3.1260"></a><span id="l3.1260" class="difflineminus">-	int c1, int c2, int c3, int pads)</span>
<a href="#l3.1261"></a><span id="l3.1261" class="difflineplus">+  appledouble_encode_object* p_ap_encode_obj,</span>
<a href="#l3.1262"></a><span id="l3.1262" class="difflineplus">+  int c1, int c2, int c3, int pads)</span>
<a href="#l3.1263"></a><span id="l3.1263"> {</span>
<a href="#l3.1264"></a><span id="l3.1264" class="difflineminus">-	char tmpstr[32];</span>
<a href="#l3.1265"></a><span id="l3.1265" class="difflineminus">-	char *p = tmpstr;</span>
<a href="#l3.1266"></a><span id="l3.1266" class="difflineminus">-	</span>
<a href="#l3.1267"></a><span id="l3.1267" class="difflineminus">-    *p++ = basis_64[c1&gt;&gt;2];</span>
<a href="#l3.1268"></a><span id="l3.1268" class="difflineminus">-    *p++ = basis_64[((c1 &amp; 0x3)&lt;&lt; 4) | ((c2 &amp; 0xF0) &gt;&gt; 4)];</span>
<a href="#l3.1269"></a><span id="l3.1269" class="difflineminus">-    if (pads == 2)</span>
<a href="#l3.1270"></a><span id="l3.1270" class="difflineminus">-    {</span>
<a href="#l3.1271"></a><span id="l3.1271" class="difflineminus">-        *p++ = '=';</span>
<a href="#l3.1272"></a><span id="l3.1272" class="difflineminus">-        *p++ = '=';</span>
<a href="#l3.1273"></a><span id="l3.1273" class="difflineminus">-    }</span>
<a href="#l3.1274"></a><span id="l3.1274" class="difflineminus">-    else if (pads)</span>
<a href="#l3.1275"></a><span id="l3.1275" class="difflineminus">-    {</span>
<a href="#l3.1276"></a><span id="l3.1276" class="difflineminus">-        *p++ = basis_64[((c2 &amp; 0xF) &lt;&lt; 2) | ((c3 &amp; 0xC0) &gt;&gt;6)];</span>
<a href="#l3.1277"></a><span id="l3.1277" class="difflineminus">-        *p++ = '=';</span>
<a href="#l3.1278"></a><span id="l3.1278" class="difflineminus">-    }</span>
<a href="#l3.1279"></a><span id="l3.1279" class="difflineminus">-    else</span>
<a href="#l3.1280"></a><span id="l3.1280" class="difflineminus">-    {</span>
<a href="#l3.1281"></a><span id="l3.1281" class="difflineminus">-        *p++ = basis_64[((c2 &amp; 0xF) &lt;&lt; 2) | ((c3 &amp; 0xC0) &gt;&gt;6)];</span>
<a href="#l3.1282"></a><span id="l3.1282" class="difflineminus">-        *p++ = basis_64[c3 &amp; 0x3F];</span>
<a href="#l3.1283"></a><span id="l3.1283" class="difflineminus">-    }</span>
<a href="#l3.1284"></a><span id="l3.1284" class="difflineminus">-    return write_stream(p_ap_encode_obj, (const char*) tmpstr, p-tmpstr);</span>
<a href="#l3.1285"></a><span id="l3.1285" class="difflineplus">+  char tmpstr[32];</span>
<a href="#l3.1286"></a><span id="l3.1286" class="difflineplus">+  char *p = tmpstr;</span>
<a href="#l3.1287"></a><span id="l3.1287" class="difflineplus">+</span>
<a href="#l3.1288"></a><span id="l3.1288" class="difflineplus">+  *p++ = basis_64[c1&gt;&gt;2];</span>
<a href="#l3.1289"></a><span id="l3.1289" class="difflineplus">+  *p++ = basis_64[((c1 &amp; 0x3)&lt;&lt; 4) | ((c2 &amp; 0xF0) &gt;&gt; 4)];</span>
<a href="#l3.1290"></a><span id="l3.1290" class="difflineplus">+  if (pads == 2)</span>
<a href="#l3.1291"></a><span id="l3.1291" class="difflineplus">+  {</span>
<a href="#l3.1292"></a><span id="l3.1292" class="difflineplus">+      *p++ = '=';</span>
<a href="#l3.1293"></a><span id="l3.1293" class="difflineplus">+      *p++ = '=';</span>
<a href="#l3.1294"></a><span id="l3.1294" class="difflineplus">+  }</span>
<a href="#l3.1295"></a><span id="l3.1295" class="difflineplus">+  else if (pads)</span>
<a href="#l3.1296"></a><span id="l3.1296" class="difflineplus">+  {</span>
<a href="#l3.1297"></a><span id="l3.1297" class="difflineplus">+      *p++ = basis_64[((c2 &amp; 0xF) &lt;&lt; 2) | ((c3 &amp; 0xC0) &gt;&gt;6)];</span>
<a href="#l3.1298"></a><span id="l3.1298" class="difflineplus">+      *p++ = '=';</span>
<a href="#l3.1299"></a><span id="l3.1299" class="difflineplus">+  }</span>
<a href="#l3.1300"></a><span id="l3.1300" class="difflineplus">+  else</span>
<a href="#l3.1301"></a><span id="l3.1301" class="difflineplus">+  {</span>
<a href="#l3.1302"></a><span id="l3.1302" class="difflineplus">+      *p++ = basis_64[((c2 &amp; 0xF) &lt;&lt; 2) | ((c3 &amp; 0xC0) &gt;&gt;6)];</span>
<a href="#l3.1303"></a><span id="l3.1303" class="difflineplus">+      *p++ = basis_64[c3 &amp; 0x3F];</span>
<a href="#l3.1304"></a><span id="l3.1304" class="difflineplus">+  }</span>
<a href="#l3.1305"></a><span id="l3.1305" class="difflineplus">+  return write_stream(p_ap_encode_obj, (const char*) tmpstr, p-tmpstr);</span>
<a href="#l3.1306"></a><span id="l3.1306"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgAttachment.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgAttachment.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -251,12 +251,12 @@ nsresult nsMsgAttachment::DeleteAttachme</span>
<a href="#l4.4"></a><span id="l4.4">     {</span>
<a href="#l4.5"></a><span id="l4.5">       rv = urlFile-&gt;IsFile(&amp;isAFile);</span>
<a href="#l4.6"></a><span id="l4.6">       NS_ASSERTION(NS_SUCCEEDED(rv), &quot;IsFile() call failed!&quot;);</span>
<a href="#l4.7"></a><span id="l4.7">     }</span>
<a href="#l4.8"></a><span id="l4.8">   }</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10">   // remove it if it's a valid file</span>
<a href="#l4.11"></a><span id="l4.11">   if (isAFile)</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-	  rv = urlFile-&gt;Remove(false);</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+    rv = urlFile-&gt;Remove(false);</span>
<a href="#l4.14"></a><span id="l4.14"> </span>
<a href="#l4.15"></a><span id="l4.15">   return rv;</span>
<a href="#l4.16"></a><span id="l4.16"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompUtils.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompUtils.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -827,18 +827,18 @@ CONTENT_LOC_HACK:</span>
<a href="#l5.4"></a><span id="l5.4">         buf.AppendLiteral(&quot;%20&quot;);</span>
<a href="#l5.5"></a><span id="l5.5">       else if (*s == '\t')</span>
<a href="#l5.6"></a><span id="l5.6">         buf.AppendLiteral(&quot;%09&quot;);</span>
<a href="#l5.7"></a><span id="l5.7">       else if (*s == '\n')</span>
<a href="#l5.8"></a><span id="l5.8">         buf.AppendLiteral(&quot;%0A&quot;);</span>
<a href="#l5.9"></a><span id="l5.9">       else if (*s == '\r')</span>
<a href="#l5.10"></a><span id="l5.10">         buf.AppendLiteral(&quot;%0D&quot;);</span>
<a href="#l5.11"></a><span id="l5.11">       else {</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-	      tmp[0]=*s;</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-	      buf.Append(tmp);</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+        tmp[0]=*s;</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+        buf.Append(tmp);</span>
<a href="#l5.16"></a><span id="l5.16">       }</span>
<a href="#l5.17"></a><span id="l5.17">       s++;</span>
<a href="#l5.18"></a><span id="l5.18">       col += (buf.Length() - ot);</span>
<a href="#l5.19"></a><span id="l5.19">     }</span>
<a href="#l5.20"></a><span id="l5.20">     buf.AppendLiteral(&quot;\&quot;&quot; CRLF);</span>
<a href="#l5.21"></a><span id="l5.21"> </span>
<a href="#l5.22"></a><span id="l5.22">     /* rhp: this is to try to get around this fun problem with Content-Location */</span>
<a href="#l5.23"></a><span id="l5.23">     if (!useContentLocation) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgComposeContentHandler.h</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgComposeContentHandler.h</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -4,17 +4,17 @@</span>
<a href="#l6.4"></a><span id="l6.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.5"></a><span id="l6.5"> </span>
<a href="#l6.6"></a><span id="l6.6"> #include &quot;nsIContentHandler.h&quot;</span>
<a href="#l6.7"></a><span id="l6.7"> #include &quot;nsIMsgIdentity.h&quot;</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9"> class nsMsgComposeContentHandler : public nsIContentHandler</span>
<a href="#l6.10"></a><span id="l6.10"> {</span>
<a href="#l6.11"></a><span id="l6.11"> public:</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-	nsMsgComposeContentHandler();</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+  nsMsgComposeContentHandler();</span>
<a href="#l6.14"></a><span id="l6.14"> </span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-	NS_DECL_ISUPPORTS</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l6.17"></a><span id="l6.17">   NS_DECL_NSICONTENTHANDLER</span>
<a href="#l6.18"></a><span id="l6.18"> private:</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-	virtual ~nsMsgComposeContentHandler();</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+  virtual ~nsMsgComposeContentHandler();</span>
<a href="#l6.21"></a><span id="l6.21">   nsresult GetBestIdentity(nsIInterfaceRequestor* aWindowContext,</span>
<a href="#l6.22"></a><span id="l6.22">                            nsIMsgIdentity **identity);</span>
<a href="#l6.23"></a><span id="l6.23"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgComposeProgressParams.h</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgComposeProgressParams.h</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -3,18 +3,18 @@</span>
<a href="#l7.4"></a><span id="l7.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l7.5"></a><span id="l7.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.6"></a><span id="l7.6"> </span>
<a href="#l7.7"></a><span id="l7.7"> #include &quot;nsIMsgComposeProgressParams.h&quot;</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9"> class nsMsgComposeProgressParams : public nsIMsgComposeProgressParams</span>
<a href="#l7.10"></a><span id="l7.10"> {</span>
<a href="#l7.11"></a><span id="l7.11"> public:</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-	NS_DECL_ISUPPORTS</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l7.14"></a><span id="l7.14">   NS_DECL_NSIMSGCOMPOSEPROGRESSPARAMS</span>
<a href="#l7.15"></a><span id="l7.15"> </span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-	nsMsgComposeProgressParams();</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+  nsMsgComposeProgressParams();</span>
<a href="#l7.18"></a><span id="l7.18"> </span>
<a href="#l7.19"></a><span id="l7.19"> private:</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">-	virtual ~nsMsgComposeProgressParams();</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+  virtual ~nsMsgComposeProgressParams();</span>
<a href="#l7.22"></a><span id="l7.22">   nsString                          m_subject;</span>
<a href="#l7.23"></a><span id="l7.23">   MSG_DeliverMode                   m_deliveryMode;</span>
<a href="#l7.24"></a><span id="l7.24"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgComposeService.h</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgComposeService.h</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -18,29 +18,29 @@</span>
<a href="#l8.4"></a><span id="l8.4"> #define ICOMMANDLINEHANDLER nsICommandLineHandler</span>
<a href="#l8.5"></a><span id="l8.5"> </span>
<a href="#l8.6"></a><span id="l8.6"> class nsMsgComposeService :</span>
<a href="#l8.7"></a><span id="l8.7">   public nsIMsgComposeService,</span>
<a href="#l8.8"></a><span id="l8.8">   public ICOMMANDLINEHANDLER,</span>
<a href="#l8.9"></a><span id="l8.9">   public nsSupportsWeakReference</span>
<a href="#l8.10"></a><span id="l8.10"> {</span>
<a href="#l8.11"></a><span id="l8.11"> public:</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-	nsMsgComposeService();</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+  nsMsgComposeService();</span>
<a href="#l8.14"></a><span id="l8.14"> </span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-	NS_DECL_ISUPPORTS</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l8.17"></a><span id="l8.17">   NS_DECL_NSIMSGCOMPOSESERVICE</span>
<a href="#l8.18"></a><span id="l8.18">   NS_DECL_NSICOMMANDLINEHANDLER</span>
<a href="#l8.19"></a><span id="l8.19"> </span>
<a href="#l8.20"></a><span id="l8.20">   nsresult Init();</span>
<a href="#l8.21"></a><span id="l8.21">   void Reset();</span>
<a href="#l8.22"></a><span id="l8.22">   void DeleteCachedWindows();</span>
<a href="#l8.23"></a><span id="l8.23">   nsresult AddGlobalHtmlDomains();</span>
<a href="#l8.24"></a><span id="l8.24"> </span>
<a href="#l8.25"></a><span id="l8.25"> private:</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineminus">-	virtual ~nsMsgComposeService();</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+  virtual ~nsMsgComposeService();</span>
<a href="#l8.28"></a><span id="l8.28">   bool mLogComposePerformance;</span>
<a href="#l8.29"></a><span id="l8.29"> </span>
<a href="#l8.30"></a><span id="l8.30">   nsresult LoadDraftOrTemplate(const nsACString&amp; aMsgURI, nsMimeOutputType aOutType,</span>
<a href="#l8.31"></a><span id="l8.31">                                nsIMsgIdentity * aIdentity, const char * aOriginalMsgURI,</span>
<a href="#l8.32"></a><span id="l8.32">                                nsIMsgDBHdr * aOrigMsgHdr, bool aForwardInline,</span>
<a href="#l8.33"></a><span id="l8.33">                                bool overrideComposeFormat,</span>
<a href="#l8.34"></a><span id="l8.34">                                nsIMsgWindow *aMsgWindow);</span>
<a href="#l8.35"></a><span id="l8.35"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCopy.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCopy.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -189,17 +189,17 @@ nsMsgCopy::StartCopyOperation(nsIMsgIden</span>
<a href="#l9.4"></a><span id="l9.4">     if (!dstFolder || NS_FAILED(rv))</span>
<a href="#l9.5"></a><span id="l9.5">       return NS_MSG_UNABLE_TO_SAVE_DRAFT;</span>
<a href="#l9.6"></a><span id="l9.6">   }</span>
<a href="#l9.7"></a><span id="l9.7">   else if (aMode == nsIMsgSend::nsMsgSaveAsTemplate) // SaveAsTemplate (Templates)</span>
<a href="#l9.8"></a><span id="l9.8">   {</span>
<a href="#l9.9"></a><span id="l9.9">     rv = GetTemplatesFolder(aUserIdentity, getter_AddRefs(dstFolder), &amp;waitForUrl);</span>
<a href="#l9.10"></a><span id="l9.10">     isDraft = false;</span>
<a href="#l9.11"></a><span id="l9.11">     if (!dstFolder || NS_FAILED(rv))</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-	    return NS_MSG_UNABLE_TO_SAVE_TEMPLATE;</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+      return NS_MSG_UNABLE_TO_SAVE_TEMPLATE;</span>
<a href="#l9.14"></a><span id="l9.14">   }</span>
<a href="#l9.15"></a><span id="l9.15">   else // SaveInSentFolder (Sent) -  nsMsgDeliverNow or nsMsgSendUnsent</span>
<a href="#l9.16"></a><span id="l9.16">   {</span>
<a href="#l9.17"></a><span id="l9.17">     rv = GetSentFolder(aUserIdentity, getter_AddRefs(dstFolder), &amp;waitForUrl);</span>
<a href="#l9.18"></a><span id="l9.18">     isDraft = false;</span>
<a href="#l9.19"></a><span id="l9.19">     if (!dstFolder || NS_FAILED(rv))</span>
<a href="#l9.20"></a><span id="l9.20">       return NS_MSG_COULDNT_OPEN_FCC_FOLDER;</span>
<a href="#l9.21"></a><span id="l9.21">   }</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineat">@@ -529,17 +529,17 @@ LocateMessageFolder(nsIMsgIdentity   *us</span>
<a href="#l9.23"></a><span id="l9.23"> //</span>
<a href="#l9.24"></a><span id="l9.24"> // Figure out if a folder is local or not and return a boolean to</span>
<a href="#l9.25"></a><span id="l9.25"> // say so.</span>
<a href="#l9.26"></a><span id="l9.26"> //</span>
<a href="#l9.27"></a><span id="l9.27"> nsresult</span>
<a href="#l9.28"></a><span id="l9.28"> MessageFolderIsLocal(nsIMsgIdentity   *userIdentity,</span>
<a href="#l9.29"></a><span id="l9.29">                      nsMsgDeliverMode aFolderType,</span>
<a href="#l9.30"></a><span id="l9.30">                      const char       *aFolderURI,</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-		     bool 	      *aResult)</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+                     bool            *aResult)</span>
<a href="#l9.33"></a><span id="l9.33"> {</span>
<a href="#l9.34"></a><span id="l9.34">   nsresult rv;</span>
<a href="#l9.35"></a><span id="l9.35"> </span>
<a href="#l9.36"></a><span id="l9.36">   if (!aFolderURI) return NS_ERROR_NULL_POINTER;</span>
<a href="#l9.37"></a><span id="l9.37"> </span>
<a href="#l9.38"></a><span id="l9.38">   nsCOMPtr &lt;nsIURL&gt; url;</span>
<a href="#l9.39"></a><span id="l9.39">   rv = NS_MutateURI(NS_STANDARDURLMUTATOR_CONTRACTID).SetSpec(nsDependentCString(aFolderURI))</span>
<a href="#l9.40"></a><span id="l9.40">                                                      .Finalize(url);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCopy.h</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCopy.h</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -42,21 +42,21 @@ public:</span>
<a href="#l10.4"></a><span id="l10.4">   NS_IMETHOD SetMessageKey(nsMsgKey aMessageKey) override;</span>
<a href="#l10.5"></a><span id="l10.5"> </span>
<a href="#l10.6"></a><span id="l10.6">   NS_IMETHOD GetMessageId(nsACString&amp; aMessageId) override;</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8">   NS_IMETHOD OnStopCopy(nsresult aStatus) override;</span>
<a href="#l10.9"></a><span id="l10.9"> </span>
<a href="#l10.10"></a><span id="l10.10">   NS_IMETHOD SetMsgComposeAndSendObject(nsIMsgSend *obj);</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-  bool                            mCopyInProgress;</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+  bool mCopyInProgress;</span>
<a href="#l10.14"></a><span id="l10.14"> </span>
<a href="#l10.15"></a><span id="l10.15"> private:</span>
<a href="#l10.16"></a><span id="l10.16">   virtual ~CopyListener();</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineminus">-  nsCOMPtr&lt;nsIMsgSend&gt;       mComposeAndSend;</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+  nsCOMPtr&lt;nsIMsgSend&gt; mComposeAndSend;</span>
<a href="#l10.19"></a><span id="l10.19"> };</span>
<a href="#l10.20"></a><span id="l10.20"> </span>
<a href="#l10.21"></a><span id="l10.21"> //</span>
<a href="#l10.22"></a><span id="l10.22"> // This is a class that deals with processing remote attachments. It implements</span>
<a href="#l10.23"></a><span id="l10.23"> // an nsIStreamListener interface to deal with incoming data</span>
<a href="#l10.24"></a><span id="l10.24"> //</span>
<a href="#l10.25"></a><span id="l10.25"> class nsMsgCopy : public nsIUrlListener</span>
<a href="#l10.26"></a><span id="l10.26"> {</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineat">@@ -67,54 +67,54 @@ public:</span>
<a href="#l10.28"></a><span id="l10.28">   NS_DECL_ISUPPORTS</span>
<a href="#l10.29"></a><span id="l10.29">   NS_DECL_NSIURLLISTENER</span>
<a href="#l10.30"></a><span id="l10.30"> </span>
<a href="#l10.31"></a><span id="l10.31"> </span>
<a href="#l10.32"></a><span id="l10.32">   //////////////////////////////////////////////////////////////////////</span>
<a href="#l10.33"></a><span id="l10.33">   // Object methods...</span>
<a href="#l10.34"></a><span id="l10.34">   //////////////////////////////////////////////////////////////////////</span>
<a href="#l10.35"></a><span id="l10.35">   //</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineminus">-  nsresult              StartCopyOperation(nsIMsgIdentity       *aUserIdentity,</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineplus">+  nsresult              StartCopyOperation(nsIMsgIdentity   *aUserIdentity,</span>
<a href="#l10.38"></a><span id="l10.38">                                            nsIFile          *aFile,</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineminus">-                                           nsMsgDeliverMode     aMode,</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineminus">-                                           nsIMsgSend           *aMsgSendObj,</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineminus">-                                           const char           *aSavePref,</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineminus">-                                           nsIMsgDBHdr          *aMsgToReplace);</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+                                           nsMsgDeliverMode aMode,</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+                                           nsIMsgSend       *aMsgSendObj,</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+                                           const char       *aSavePref,</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineplus">+                                           nsIMsgDBHdr      *aMsgToReplace);</span>
<a href="#l10.47"></a><span id="l10.47"> </span>
<a href="#l10.48"></a><span id="l10.48">   nsresult              DoCopy(nsIFile *aDiskFile, nsIMsgFolder *dstFolder,</span>
<a href="#l10.49"></a><span id="l10.49">                                nsIMsgDBHdr *aMsgToReplace, bool aIsDraft,</span>
<a href="#l10.50"></a><span id="l10.50">                                nsIMsgWindow *msgWindow,</span>
<a href="#l10.51"></a><span id="l10.51">                                nsIMsgSend   *aMsgSendObj);</span>
<a href="#l10.52"></a><span id="l10.52"> </span>
<a href="#l10.53"></a><span id="l10.53" class="difflineminus">-  nsresult	GetUnsentMessagesFolder(nsIMsgIdentity *userIdentity, nsIMsgFolder **msgFolder, bool *waitForUrl);</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineminus">-  nsresult	GetDraftsFolder(nsIMsgIdentity *userIdentity, nsIMsgFolder **msgFolder, bool *waitForUrl);</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineminus">-  nsresult	GetTemplatesFolder(nsIMsgIdentity *userIdentity, nsIMsgFolder **msgFolder, bool *waitForUrl);</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineminus">-  nsresult	GetSentFolder(nsIMsgIdentity *userIdentity,  nsIMsgFolder **msgFolder, bool *waitForUrl);</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineminus">-  nsresult   CreateIfMissing(nsIMsgFolder **folder, bool *waitForUrl);</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineplus">+  nsresult GetUnsentMessagesFolder(nsIMsgIdentity *userIdentity, nsIMsgFolder **msgFolder, bool *waitForUrl);</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineplus">+  nsresult GetDraftsFolder(nsIMsgIdentity *userIdentity, nsIMsgFolder **msgFolder, bool *waitForUrl);</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineplus">+  nsresult GetTemplatesFolder(nsIMsgIdentity *userIdentity, nsIMsgFolder **msgFolder, bool *waitForUrl);</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineplus">+  nsresult GetSentFolder(nsIMsgIdentity *userIdentity,  nsIMsgFolder **msgFolder, bool *waitForUrl);</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineplus">+  nsresult CreateIfMissing(nsIMsgFolder **folder, bool *waitForUrl);</span>
<a href="#l10.63"></a><span id="l10.63"> </span>
<a href="#l10.64"></a><span id="l10.64"> </span>
<a href="#l10.65"></a><span id="l10.65">   //</span>
<a href="#l10.66"></a><span id="l10.66">   // Vars for implementation...</span>
<a href="#l10.67"></a><span id="l10.67">   //</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineminus">-  nsIFile                     *mFile;     // the file we are sending...</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineminus">-  nsMsgDeliverMode                mMode;</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolder&gt;          mDstFolder;</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineminus">-  nsCOMPtr&lt;nsIMsgDBHdr&gt;           mMsgToReplace;</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineminus">-  bool                            mIsDraft;</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineminus">-  nsCOMPtr&lt;nsIMsgSend&gt;            mMsgSendObj;</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineminus">-  char                            *mSavePref;</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineplus">+  nsIFile                *mFile;     // the file we are sending...</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineplus">+  nsMsgDeliverMode       mMode;</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; mDstFolder;</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt;  mMsgToReplace;</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineplus">+  bool                   mIsDraft;</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineplus">+  nsCOMPtr&lt;nsIMsgSend&gt;   mMsgSendObj;</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineplus">+  char                   *mSavePref;</span>
<a href="#l10.82"></a><span id="l10.82"> </span>
<a href="#l10.83"></a><span id="l10.83"> private:</span>
<a href="#l10.84"></a><span id="l10.84">   virtual ~nsMsgCopy();</span>
<a href="#l10.85"></a><span id="l10.85"> };</span>
<a href="#l10.86"></a><span id="l10.86"> </span>
<a href="#l10.87"></a><span id="l10.87"> // Useful function for the back end...</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineminus">-nsresult	LocateMessageFolder(nsIMsgIdentity   *userIdentity,</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineminus">-                                       nsMsgDeliverMode aFolderType,</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineminus">-                                       const char       *aSaveURI,</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineminus">-				       nsIMsgFolder **msgFolder);</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineplus">+nsresult LocateMessageFolder(nsIMsgIdentity   *userIdentity,</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineplus">+                             nsMsgDeliverMode aFolderType,</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineplus">+                             const char       *aSaveURI,</span>
<a href="#l10.95"></a><span id="l10.95" class="difflineplus">+                             nsIMsgFolder **msgFolder);</span>
<a href="#l10.96"></a><span id="l10.96"> </span>
<a href="#l10.97"></a><span id="l10.97" class="difflineminus">-nsresult	MessageFolderIsLocal(nsIMsgIdentity   *userIdentity,</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineminus">-                                       nsMsgDeliverMode aFolderType,</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineminus">-                                       const char       *aSaveURI,</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineminus">-				       bool		*aResult);</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineplus">+nsresult MessageFolderIsLocal(nsIMsgIdentity   *userIdentity,</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineplus">+                              nsMsgDeliverMode aFolderType,</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineplus">+                              const char       *aSaveURI,</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineplus">+                              bool             *aResult);</span>
<a href="#l10.105"></a><span id="l10.105"> </span>
<a href="#l10.106"></a><span id="l10.106"> #endif /* _nsMsgCopy_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgQuote.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgQuote.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -34,17 +34,17 @@ nsMsgQuoteListener::nsMsgQuoteListener()</span>
<a href="#l11.4"></a><span id="l11.4"> }</span>
<a href="#l11.5"></a><span id="l11.5"> </span>
<a href="#l11.6"></a><span id="l11.6"> nsMsgQuoteListener::~nsMsgQuoteListener()</span>
<a href="#l11.7"></a><span id="l11.7"> {</span>
<a href="#l11.8"></a><span id="l11.8"> }</span>
<a href="#l11.9"></a><span id="l11.9"> </span>
<a href="#l11.10"></a><span id="l11.10"> NS_IMETHODIMP nsMsgQuoteListener::SetMsgQuote(nsIMsgQuote * msgQuote)</span>
<a href="#l11.11"></a><span id="l11.11"> {</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-	mMsgQuote = do_GetWeakReference(msgQuote);</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+  mMsgQuote = do_GetWeakReference(msgQuote);</span>
<a href="#l11.14"></a><span id="l11.14">   return NS_OK;</span>
<a href="#l11.15"></a><span id="l11.15"> }</span>
<a href="#l11.16"></a><span id="l11.16"> </span>
<a href="#l11.17"></a><span id="l11.17"> NS_IMETHODIMP nsMsgQuoteListener::GetMsgQuote(nsIMsgQuote ** aMsgQuote)</span>
<a href="#l11.18"></a><span id="l11.18"> {</span>
<a href="#l11.19"></a><span id="l11.19">   nsresult rv = NS_OK;</span>
<a href="#l11.20"></a><span id="l11.20">   if (aMsgQuote)</span>
<a href="#l11.21"></a><span id="l11.21">   {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgQuote.h</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgQuote.h</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -13,40 +13,40 @@</span>
<a href="#l12.4"></a><span id="l12.4"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l12.5"></a><span id="l12.5"> #include &quot;nsWeakReference.h&quot;</span>
<a href="#l12.6"></a><span id="l12.6"> </span>
<a href="#l12.7"></a><span id="l12.7"> class nsMsgQuote;</span>
<a href="#l12.8"></a><span id="l12.8"> </span>
<a href="#l12.9"></a><span id="l12.9"> class nsMsgQuoteListener: public nsIMsgQuoteListener</span>
<a href="#l12.10"></a><span id="l12.10"> {</span>
<a href="#l12.11"></a><span id="l12.11"> public:</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-	nsMsgQuoteListener();</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+  nsMsgQuoteListener();</span>
<a href="#l12.14"></a><span id="l12.14"> </span>
<a href="#l12.15"></a><span id="l12.15" class="difflineminus">-	NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+  NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l12.17"></a><span id="l12.17"> </span>
<a href="#l12.18"></a><span id="l12.18" class="difflineminus">-	// nsIMimeStreamConverterListener support</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineminus">-	NS_DECL_NSIMIMESTREAMCONVERTERLISTENER</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+  // nsIMimeStreamConverterListener support</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+  NS_DECL_NSIMIMESTREAMCONVERTERLISTENER</span>
<a href="#l12.22"></a><span id="l12.22">   NS_DECL_NSIMSGQUOTELISTENER</span>
<a href="#l12.23"></a><span id="l12.23"> </span>
<a href="#l12.24"></a><span id="l12.24"> private:</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineminus">-	virtual ~nsMsgQuoteListener();</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+  virtual ~nsMsgQuoteListener();</span>
<a href="#l12.27"></a><span id="l12.27">   nsWeakPtr mMsgQuote;</span>
<a href="#l12.28"></a><span id="l12.28"> };</span>
<a href="#l12.29"></a><span id="l12.29"> </span>
<a href="#l12.30"></a><span id="l12.30"> class nsMsgQuote: public nsIMsgQuote, public nsSupportsWeakReference {</span>
<a href="#l12.31"></a><span id="l12.31"> public:</span>
<a href="#l12.32"></a><span id="l12.32">   nsMsgQuote();</span>
<a href="#l12.33"></a><span id="l12.33"> </span>
<a href="#l12.34"></a><span id="l12.34">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l12.35"></a><span id="l12.35">   NS_DECL_NSIMSGQUOTE</span>
<a href="#l12.36"></a><span id="l12.36"> </span>
<a href="#l12.37"></a><span id="l12.37"> private:</span>
<a href="#l12.38"></a><span id="l12.38">   virtual ~nsMsgQuote();</span>
<a href="#l12.39"></a><span id="l12.39">   //</span>
<a href="#l12.40"></a><span id="l12.40">   // Implementation data...</span>
<a href="#l12.41"></a><span id="l12.41">   //</span>
<a href="#l12.42"></a><span id="l12.42">   nsCOMPtr&lt;nsIMsgQuotingOutputStreamListener&gt; mStreamListener;</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineminus">-  bool			mQuoteHeaders;</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+  bool mQuoteHeaders;</span>
<a href="#l12.45"></a><span id="l12.45">   nsCOMPtr&lt;nsIMsgQuoteListener&gt; mQuoteListener;</span>
<a href="#l12.46"></a><span id="l12.46">   nsCOMPtr&lt;nsIChannel&gt; mQuoteChannel;</span>
<a href="#l12.47"></a><span id="l12.47"> };</span>
<a href="#l12.48"></a><span id="l12.48"> </span>
<a href="#l12.49"></a><span id="l12.49"> #endif /* __nsMsgQuote_h__ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSendPart.h</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSendPart.h</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -12,90 +12,90 @@</span>
<a href="#l13.4"></a><span id="l13.4"> </span>
<a href="#l13.5"></a><span id="l13.5"> namespace mozilla {</span>
<a href="#l13.6"></a><span id="l13.6"> namespace mailnews {</span>
<a href="#l13.7"></a><span id="l13.7"> class MimeEncoder;</span>
<a href="#l13.8"></a><span id="l13.8"> }</span>
<a href="#l13.9"></a><span id="l13.9"> }</span>
<a href="#l13.10"></a><span id="l13.10"> </span>
<a href="#l13.11"></a><span id="l13.11"> typedef int (*MSG_SendPartWriteFunc)(const char* line, int32_t size,</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-									                   bool isheader, void* closure);</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+                                     bool isheader, void* closure);</span>
<a href="#l13.14"></a><span id="l13.14"> </span>
<a href="#l13.15"></a><span id="l13.15"> class nsMsgSendPart {</span>
<a href="#l13.16"></a><span id="l13.16">   typedef mozilla::mailnews::MimeEncoder MimeEncoder;</span>
<a href="#l13.17"></a><span id="l13.17"> public:</span>
<a href="#l13.18"></a><span id="l13.18">     nsMsgSendPart(nsIMsgSend* state, const char *part_charset = NULL);</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineminus">-    virtual ~nsMsgSendPart();	  // Note that the destructor also destroys</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineminus">-								                // any children that were added.</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineplus">+    virtual ~nsMsgSendPart();  // Note that the destructor also destroys</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineplus">+                               // any children that were added.</span>
<a href="#l13.23"></a><span id="l13.23"> </span>
<a href="#l13.24"></a><span id="l13.24">     virtual nsresult  Write();</span>
<a href="#l13.25"></a><span id="l13.25"> </span>
<a href="#l13.26"></a><span id="l13.26">     virtual nsresult    SetFile(nsIFile *filename);</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineminus">-    const nsIFile  *GetFile() {return m_file;}</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineplus">+    const nsIFile       *GetFile() {return m_file;}</span>
<a href="#l13.29"></a><span id="l13.29"> </span>
<a href="#l13.30"></a><span id="l13.30">     virtual nsresult  SetBuffer(const char* buffer);</span>
<a href="#l13.31"></a><span id="l13.31">     const char        *GetBuffer() {return m_buffer;}</span>
<a href="#l13.32"></a><span id="l13.32"> </span>
<a href="#l13.33"></a><span id="l13.33">     virtual nsresult  SetType(const char* type);</span>
<a href="#l13.34"></a><span id="l13.34">     const char        *GetType() {return m_type;}</span>
<a href="#l13.35"></a><span id="l13.35"> </span>
<a href="#l13.36"></a><span id="l13.36">     const char        *GetCharsetName() {return m_charset_name;}</span>
<a href="#l13.37"></a><span id="l13.37"> </span>
<a href="#l13.38"></a><span id="l13.38">     virtual nsresult  SetOtherHeaders(const char* other);</span>
<a href="#l13.39"></a><span id="l13.39">     const char        *SetOtherHeaders() {return m_other;}</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineminus">-	  virtual nsresult  AppendOtherHeaders(const char* moreother);</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineplus">+    virtual nsresult  AppendOtherHeaders(const char* moreother);</span>
<a href="#l13.42"></a><span id="l13.42"> </span>
<a href="#l13.43"></a><span id="l13.43" class="difflineminus">-	  virtual nsresult  SetMimeDeliveryState(nsIMsgSend* state);</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineplus">+    virtual nsresult  SetMimeDeliveryState(nsIMsgSend* state);</span>
<a href="#l13.45"></a><span id="l13.45"> </span>
<a href="#l13.46"></a><span id="l13.46">   // Note that the nsMsgSendPart class will take over ownership of the</span>
<a href="#l13.47"></a><span id="l13.47">   // MimeEncoderData* object, deleting it when it chooses.  (This is</span>
<a href="#l13.48"></a><span id="l13.48">   // necessary because deleting these objects is the only current way to</span>
<a href="#l13.49"></a><span id="l13.49">   // flush out the data in them.)</span>
<a href="#l13.50"></a><span id="l13.50">   void                SetEncoder(MimeEncoder* encoder) {m_encoder = encoder;}</span>
<a href="#l13.51"></a><span id="l13.51">   MimeEncoder         *GetEncoder() {return m_encoder;}</span>
<a href="#l13.52"></a><span id="l13.52"> </span>
<a href="#l13.53"></a><span id="l13.53" class="difflineminus">-	void                SetStripSensitiveHeaders(bool value)</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+  void                SetStripSensitiveHeaders(bool value)</span>
<a href="#l13.55"></a><span id="l13.55">                       {</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineminus">-		                    m_strip_sensitive_headers = value;</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineminus">-	                    }</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineminus">-	bool                GetStripSensitiveHeaders() {return m_strip_sensitive_headers;}</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineplus">+                        m_strip_sensitive_headers = value;</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineplus">+                      }</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineplus">+  bool                GetStripSensitiveHeaders() {return m_strip_sensitive_headers;}</span>
<a href="#l13.62"></a><span id="l13.62"> </span>
<a href="#l13.63"></a><span id="l13.63">   virtual nsresult    AddChild(nsMsgSendPart* child);</span>
<a href="#l13.64"></a><span id="l13.64"> </span>
<a href="#l13.65"></a><span id="l13.65" class="difflineminus">-	int32_t             GetNumChildren() {return m_numchildren;}</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineminus">-	nsMsgSendPart       *GetChild(int32_t which);</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineminus">-	nsMsgSendPart       *DetachChild(int32_t which);</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineplus">+  int32_t             GetNumChildren() {return m_numchildren;}</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineplus">+  nsMsgSendPart       *GetChild(int32_t which);</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineplus">+  nsMsgSendPart       *DetachChild(int32_t which);</span>
<a href="#l13.71"></a><span id="l13.71"> </span>
<a href="#l13.72"></a><span id="l13.72" class="difflineminus">-	virtual nsresult    SetMainPart(bool value);</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineminus">-	bool                IsMainPart()</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineplus">+  virtual nsresult    SetMainPart(bool value);</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineplus">+  bool                IsMainPart()</span>
<a href="#l13.76"></a><span id="l13.76">                       {</span>
<a href="#l13.77"></a><span id="l13.77">                         return m_mainpart;</span>
<a href="#l13.78"></a><span id="l13.78">                       }</span>
<a href="#l13.79"></a><span id="l13.79">   nsCString           m_partNum;</span>
<a href="#l13.80"></a><span id="l13.80"> protected:</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineminus">-	nsresult            CopyString(char** dest, const char* src);</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineminus">-	nsresult            PushBody(const char* buffer, int32_t length);</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineplus">+  nsresult            CopyString(char** dest, const char* src);</span>
<a href="#l13.84"></a><span id="l13.84" class="difflineplus">+  nsresult            PushBody(const char* buffer, int32_t length);</span>
<a href="#l13.85"></a><span id="l13.85"> </span>
<a href="#l13.86"></a><span id="l13.86" class="difflineminus">-	nsCOMPtr&lt;nsIMsgSend&gt; m_state;</span>
<a href="#l13.87"></a><span id="l13.87" class="difflineminus">-	nsMsgSendPart       *m_parent;</span>
<a href="#l13.88"></a><span id="l13.88" class="difflineplus">+  nsCOMPtr&lt;nsIMsgSend&gt; m_state;</span>
<a href="#l13.89"></a><span id="l13.89" class="difflineplus">+  nsMsgSendPart       *m_parent;</span>
<a href="#l13.90"></a><span id="l13.90">   nsCOMPtr &lt;nsIFile&gt;   m_file;</span>
<a href="#l13.91"></a><span id="l13.91" class="difflineminus">-	char                *m_buffer;</span>
<a href="#l13.92"></a><span id="l13.92" class="difflineplus">+  char                *m_buffer;</span>
<a href="#l13.93"></a><span id="l13.93">   char                *m_type;</span>
<a href="#l13.94"></a><span id="l13.94">   char                *m_other;</span>
<a href="#l13.95"></a><span id="l13.95">   char                m_charset_name[64+1];        // charset name associated with this part</span>
<a href="#l13.96"></a><span id="l13.96" class="difflineminus">-	bool                m_strip_sensitive_headers;</span>
<a href="#l13.97"></a><span id="l13.97" class="difflineplus">+  bool                m_strip_sensitive_headers;</span>
<a href="#l13.98"></a><span id="l13.98">   nsAutoPtr&lt;MimeEncoder&gt; m_encoder;</span>
<a href="#l13.99"></a><span id="l13.99"> </span>
<a href="#l13.100"></a><span id="l13.100" class="difflineminus">-	nsMsgSendPart       **m_children;</span>
<a href="#l13.101"></a><span id="l13.101" class="difflineminus">-	int32_t             m_numchildren;</span>
<a href="#l13.102"></a><span id="l13.102" class="difflineplus">+  nsMsgSendPart       **m_children;</span>
<a href="#l13.103"></a><span id="l13.103" class="difflineplus">+  int32_t             m_numchildren;</span>
<a href="#l13.104"></a><span id="l13.104"> </span>
<a href="#l13.105"></a><span id="l13.105" class="difflineminus">-	// Data used while actually writing.</span>
<a href="#l13.106"></a><span id="l13.106" class="difflineplus">+  // Data used while actually writing.</span>
<a href="#l13.107"></a><span id="l13.107">   bool                m_firstBlock;</span>
<a href="#l13.108"></a><span id="l13.108">   bool                m_needIntlConversion;</span>
<a href="#l13.109"></a><span id="l13.109"> </span>
<a href="#l13.110"></a><span id="l13.110" class="difflineminus">-	bool                m_mainpart;</span>
<a href="#l13.111"></a><span id="l13.111" class="difflineplus">+  bool                m_mainpart;</span>
<a href="#l13.112"></a><span id="l13.112"> </span>
<a href="#l13.113"></a><span id="l13.113" class="difflineminus">-	bool                m_just_hit_CR;</span>
<a href="#l13.114"></a><span id="l13.114" class="difflineplus">+  bool                m_just_hit_CR;</span>
<a href="#l13.115"></a><span id="l13.115"> </span>
<a href="#l13.116"></a><span id="l13.116" class="difflineminus">-	static int32_t      M_counter;</span>
<a href="#l13.117"></a><span id="l13.117" class="difflineplus">+  static int32_t      M_counter;</span>
<a href="#l13.118"></a><span id="l13.118"> };</span>
<a href="#l13.119"></a><span id="l13.119"> </span>
<a href="#l13.120"></a><span id="l13.120"> #endif /* _MsgSendPart_H_ */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpProtocol.cpp</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpProtocol.cpp</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -159,29 +159,29 @@ nsresult nsExplainErrorDetails(nsISmtpUr</span>
<a href="#l14.4"></a><span id="l14.4">      traditional ASCII range of 1- 127 decimal to be transmitted in an esmtp-value. Because the ENVID and</span>
<a href="#l14.5"></a><span id="l14.5">      ORCPT parameters may need to convey values outside this range, the esmtp-values for these parameters are</span>
<a href="#l14.6"></a><span id="l14.6">      encoded as &quot;xtext&quot;. &quot;xtext&quot; is formally defined as follows:</span>
<a href="#l14.7"></a><span id="l14.7"> </span>
<a href="#l14.8"></a><span id="l14.8">      xtext = *( xchar / hexchar )</span>
<a href="#l14.9"></a><span id="l14.9"> </span>
<a href="#l14.10"></a><span id="l14.10">      xchar = any ASCII CHAR between &quot;!&quot; (33) and &quot;~&quot; (126) inclusive, except for &quot;+&quot; and &quot;=&quot;.</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-	; &quot;hexchar&quot;s are intended to encode octets that cannot appear</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-	; as ASCII characters within an esmtp-value.</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+    ; &quot;hexchar&quot;s are intended to encode octets that cannot appear</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+    ; as ASCII characters within an esmtp-value.</span>
<a href="#l14.16"></a><span id="l14.16"> </span>
<a href="#l14.17"></a><span id="l14.17" class="difflineminus">-		 hexchar = ASCII &quot;+&quot; immediately followed by two upper case hexadecimal digits</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineplus">+         hexchar = ASCII &quot;+&quot; immediately followed by two upper case hexadecimal digits</span>
<a href="#l14.19"></a><span id="l14.19"> </span>
<a href="#l14.20"></a><span id="l14.20" class="difflineminus">-	When encoding an octet sequence as xtext:</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineplus">+    When encoding an octet sequence as xtext:</span>
<a href="#l14.22"></a><span id="l14.22"> </span>
<a href="#l14.23"></a><span id="l14.23" class="difflineminus">-	+ Any ASCII CHAR between &quot;!&quot; and &quot;~&quot; inclusive, except for &quot;+&quot; and &quot;=&quot;,</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineminus">-		 MAY be encoded as itself. (A CHAR in this range MAY instead be encoded as a &quot;hexchar&quot;, at the</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineminus">-		 implementor's discretion.)</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineplus">+    + Any ASCII CHAR between &quot;!&quot; and &quot;~&quot; inclusive, except for &quot;+&quot; and &quot;=&quot;,</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+         MAY be encoded as itself. (A CHAR in this range MAY instead be encoded as a &quot;hexchar&quot;, at the</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineplus">+         implementor's discretion.)</span>
<a href="#l14.29"></a><span id="l14.29"> </span>
<a href="#l14.30"></a><span id="l14.30" class="difflineminus">-	+ ASCII CHARs that fall outside the range above must be encoded as</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-		 &quot;hexchar&quot;.</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+    + ASCII CHARs that fall outside the range above must be encoded as</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+         &quot;hexchar&quot;.</span>
<a href="#l14.34"></a><span id="l14.34"> </span>
<a href="#l14.35"></a><span id="l14.35">  */</span>
<a href="#l14.36"></a><span id="l14.36"> /* caller must free the return buffer */</span>
<a href="#l14.37"></a><span id="l14.37"> static char *</span>
<a href="#l14.38"></a><span id="l14.38"> esmtp_value_encode(const char *addr)</span>
<a href="#l14.39"></a><span id="l14.39"> {</span>
<a href="#l14.40"></a><span id="l14.40">   char *buffer = (char *) PR_Malloc(512); /* esmtp ORCPT allow up to 500 chars encoded addresses */</span>
<a href="#l14.41"></a><span id="l14.41">   char *bp = buffer, *bpEnd = buffer+500;</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineat">@@ -1890,41 +1890,39 @@ void nsSmtpProtocol::SendMessageInFile()</span>
<a href="#l14.43"></a><span id="l14.43"> </span>
<a href="#l14.44"></a><span id="l14.44">   UpdateStatus(&quot;smtpDeliveringMail&quot;);</span>
<a href="#l14.45"></a><span id="l14.45">   m_nextState = SMTP_RESPONSE;</span>
<a href="#l14.46"></a><span id="l14.46">   m_nextStateAfterResponse = SMTP_SEND_MESSAGE_RESPONSE;</span>
<a href="#l14.47"></a><span id="l14.47"> }</span>
<a href="#l14.48"></a><span id="l14.48"> </span>
<a href="#l14.49"></a><span id="l14.49"> void nsSmtpProtocol::SendPostData()</span>
<a href="#l14.50"></a><span id="l14.50"> {</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineminus">-	// mscott: as a first pass, I'm writing everything at once and am not</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineminus">-	// doing it in chunks...</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+  // mscott: as a first pass, I'm writing everything at once and am not</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+  // doing it in chunks...</span>
<a href="#l14.55"></a><span id="l14.55"> </span>
<a href="#l14.56"></a><span id="l14.56" class="difflineminus">-	/* returns 0 on done and negative on error</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineminus">-	 * positive if it needs to continue.</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineminus">-	 */</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineplus">+  /* returns 0 on done and negative on error</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineplus">+   * positive if it needs to continue.</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineplus">+   */</span>
<a href="#l14.62"></a><span id="l14.62"> </span>
<a href="#l14.63"></a><span id="l14.63" class="difflineminus">-	// check to see if url is a file..if it is...call our file handler...</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineminus">-	bool postMessageInFile = true;</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineminus">-	m_runningURL-&gt;GetPostMessage(&amp;postMessageInFile);</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineminus">-	if (postMessageInFile)</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineminus">-	{</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineminus">-		SendMessageInFile();</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineminus">-	}</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+  // check to see if url is a file..if it is...call our file handler...</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+  bool postMessageInFile = true;</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineplus">+  m_runningURL-&gt;GetPostMessage(&amp;postMessageInFile);</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineplus">+  if (postMessageInFile)</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineplus">+  {</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineplus">+    SendMessageInFile();</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineplus">+  }</span>
<a href="#l14.77"></a><span id="l14.77"> </span>
<a href="#l14.78"></a><span id="l14.78" class="difflineminus">-	/* Update the thermo and the status bar.  This is done by hand, rather</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineminus">-	   than using the FE_GraphProgress* functions, because there seems to be</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineminus">-	   no way to make FE_GraphProgress shut up and not display anything more</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineminus">-	   when all the data has arrived.  At the end, we want to show the</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineminus">-	   &quot;message sent; waiting for reply&quot; status; FE_GraphProgress gets in</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineminus">-	   the way of that.  See bug #23414. */</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineplus">+  /* Update the thermo and the status bar.  This is done by hand, rather</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineplus">+     than using the FE_GraphProgress* functions, because there seems to be</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineplus">+     no way to make FE_GraphProgress shut up and not display anything more</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineplus">+     when all the data has arrived.  At the end, we want to show the</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineplus">+     &quot;message sent; waiting for reply&quot; status; FE_GraphProgress gets in</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineplus">+     the way of that.  See bug #23414. */</span>
<a href="#l14.90"></a><span id="l14.90"> }</span>
<a href="#l14.91"></a><span id="l14.91"> </span>
<a href="#l14.92"></a><span id="l14.92" class="difflineminus">-</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineminus">-</span>
<a href="#l14.94"></a><span id="l14.94"> nsresult nsSmtpProtocol::SendMessageResponse()</span>
<a href="#l14.95"></a><span id="l14.95"> {</span>
<a href="#l14.96"></a><span id="l14.96">   if((m_responseCode/10 != 25))</span>
<a href="#l14.97"></a><span id="l14.97">   {</span>
<a href="#l14.98"></a><span id="l14.98">     mozilla::DebugOnly&lt;nsresult&gt; rv = nsExplainErrorDetails(m_runningURL,</span>
<a href="#l14.99"></a><span id="l14.99">                                                             NS_ERROR_SENDING_MESSAGE,</span>
<a href="#l14.100"></a><span id="l14.100">                                                             m_responseText.get(), nullptr);</span>
<a href="#l14.101"></a><span id="l14.101">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to explain SMTP error&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpProtocol.h</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpProtocol.h</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -165,24 +165,24 @@ private:</span>
<a href="#l15.4"></a><span id="l15.4">     // Communication methods --&gt; Reading and writing protocol</span>
<a href="#l15.5"></a><span id="l15.5">     ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l15.6"></a><span id="l15.6"> </span>
<a href="#l15.7"></a><span id="l15.7">     void UpdateStatus(const char* aStatusName);</span>
<a href="#l15.8"></a><span id="l15.8">     void UpdateStatusWithString(const char16_t * aStatusString);</span>
<a href="#l15.9"></a><span id="l15.9"> </span>
<a href="#l15.10"></a><span id="l15.10">     ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l15.11"></a><span id="l15.11">     // Protocol Methods --&gt; This protocol is state driven so each protocol method is</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-    //						designed to re-act to the current &quot;state&quot;. I've attempted to</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-    //						group them together based on functionality.</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+    //                      designed to re-act to the current &quot;state&quot;. I've attempted to</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+    //                      group them together based on functionality.</span>
<a href="#l15.16"></a><span id="l15.16">     ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l15.17"></a><span id="l15.17"> </span>
<a href="#l15.18"></a><span id="l15.18">     nsresult SmtpResponse(nsIInputStream * inputStream, uint32_t length);</span>
<a href="#l15.19"></a><span id="l15.19">     nsresult ExtensionLoginResponse(nsIInputStream * inputStream, uint32_t length);</span>
<a href="#l15.20"></a><span id="l15.20">     nsresult SendHeloResponse(nsIInputStream * inputStream, uint32_t length);</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineminus">-    nsresult SendEhloResponse(nsIInputStream * inputStream, uint32_t length);	</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineplus">+    nsresult SendEhloResponse(nsIInputStream * inputStream, uint32_t length);</span>
<a href="#l15.23"></a><span id="l15.23">     nsresult SendQuit(SmtpState aNextStateAfterResponse = SMTP_DONE);</span>
<a href="#l15.24"></a><span id="l15.24"> </span>
<a href="#l15.25"></a><span id="l15.25">     nsresult AuthGSSAPIFirst();</span>
<a href="#l15.26"></a><span id="l15.26">     nsresult AuthGSSAPIStep();</span>
<a href="#l15.27"></a><span id="l15.27">     nsresult AuthLoginStep0();</span>
<a href="#l15.28"></a><span id="l15.28">     void     AuthLoginStep0Response();</span>
<a href="#l15.29"></a><span id="l15.29">     nsresult AuthLoginStep1();</span>
<a href="#l15.30"></a><span id="l15.30">     nsresult AuthLoginStep2();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpService.cpp</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpService.cpp</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -99,17 +99,17 @@ NS_IMETHODIMP nsSmtpService::SendMailMes</span>
<a href="#l16.4"></a><span id="l16.4">   {</span>
<a href="#l16.5"></a><span id="l16.5">     if (!aPassword.IsEmpty())</span>
<a href="#l16.6"></a><span id="l16.6">       smtpServer-&gt;SetPassword(aPassword);</span>
<a href="#l16.7"></a><span id="l16.7"> </span>
<a href="#l16.8"></a><span id="l16.8">     // this ref counts urlToRun</span>
<a href="#l16.9"></a><span id="l16.9">     rv = NS_MsgBuildSmtpUrl(aFilePath, smtpServer, aRecipients, aSenderIdentity, aSender,</span>
<a href="#l16.10"></a><span id="l16.10">                             aUrlListener, aStatusFeedback,</span>
<a href="#l16.11"></a><span id="l16.11">                             aNotificationCallbacks, &amp;urlToRun, aRequestDSN);</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; urlToRun)	</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; urlToRun)</span>
<a href="#l16.14"></a><span id="l16.14">       rv = NS_MsgLoadSmtpUrl(urlToRun, nullptr, aRequest);</span>
<a href="#l16.15"></a><span id="l16.15"> </span>
<a href="#l16.16"></a><span id="l16.16">     if (aURL) // does the caller want a handle on the url?</span>
<a href="#l16.17"></a><span id="l16.17">       *aURL = urlToRun; // transfer our ref count to the caller....</span>
<a href="#l16.18"></a><span id="l16.18">     else</span>
<a href="#l16.19"></a><span id="l16.19">       NS_IF_RELEASE(urlToRun);</span>
<a href="#l16.20"></a><span id="l16.20">   }</span>
<a href="#l16.21"></a><span id="l16.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpService.h</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpService.h</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -19,36 +19,36 @@</span>
<a href="#l17.4"></a><span id="l17.4"> // on line (as part of the N2 project). So I reserve the right to change my mind and take</span>
<a href="#l17.5"></a><span id="l17.5"> // this service away =).</span>
<a href="#l17.6"></a><span id="l17.6"> ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l17.7"></a><span id="l17.7"> </span>
<a href="#l17.8"></a><span id="l17.8"> class nsSmtpService : public nsISmtpService, public nsIProtocolHandler</span>
<a href="#l17.9"></a><span id="l17.9"> {</span>
<a href="#l17.10"></a><span id="l17.10"> public:</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-	nsSmtpService();</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-	</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">-	NS_DECL_ISUPPORTS</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+  nsSmtpService();</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineplus">+</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l17.18"></a><span id="l17.18"> </span>
<a href="#l17.19"></a><span id="l17.19" class="difflineminus">-	////////////////////////////////////////////////////////////////////////</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineminus">-	// we support the nsISmtpService interface</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineminus">-	////////////////////////////////////////////////////////////////////////</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineminus">-	NS_DECL_NSISMTPSERVICE</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineplus">+  ////////////////////////////////////////////////////////////////////////</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineplus">+  // we support the nsISmtpService interface</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineplus">+  ////////////////////////////////////////////////////////////////////////</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineplus">+  NS_DECL_NSISMTPSERVICE</span>
<a href="#l17.27"></a><span id="l17.27"> </span>
<a href="#l17.28"></a><span id="l17.28" class="difflineminus">-	//////////////////////////////////////////////////////////////////////////</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineminus">-	// we support the nsIProtocolHandler interface</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineminus">-	//////////////////////////////////////////////////////////////////////////</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineplus">+  //////////////////////////////////////////////////////////////////////////</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+  // we support the nsIProtocolHandler interface</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineplus">+  //////////////////////////////////////////////////////////////////////////</span>
<a href="#l17.34"></a><span id="l17.34">   NS_DECL_NSIPROTOCOLHANDLER</span>
<a href="#l17.35"></a><span id="l17.35"> </span>
<a href="#l17.36"></a><span id="l17.36"> protected:</span>
<a href="#l17.37"></a><span id="l17.37">     nsresult loadSmtpServers();</span>
<a href="#l17.38"></a><span id="l17.38"> </span>
<a href="#l17.39"></a><span id="l17.39"> </span>
<a href="#l17.40"></a><span id="l17.40"> private:</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineminus">-	virtual ~nsSmtpService();</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineplus">+  virtual ~nsSmtpService();</span>
<a href="#l17.43"></a><span id="l17.43">     static bool findServerByKey(nsISmtpServer *aServer, void *aData);</span>
<a href="#l17.44"></a><span id="l17.44">     static bool findServerByHostname(nsISmtpServer *aServer, void *aData);</span>
<a href="#l17.45"></a><span id="l17.45"> </span>
<a href="#l17.46"></a><span id="l17.46">     nsresult createKeyedServer(const char* key,</span>
<a href="#l17.47"></a><span id="l17.47">                                nsISmtpServer **aResult = nullptr);</span>
<a href="#l17.48"></a><span id="l17.48">     nsresult saveKeyList();</span>
<a href="#l17.49"></a><span id="l17.49"> </span>
<a href="#l17.50"></a><span id="l17.50">     nsCOMArray&lt;nsISmtpServer&gt; mSmtpServers;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpUrl.cpp</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpUrl.cpp</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -381,138 +381,138 @@ nsMailtoUrl::GetNewsHostPart(nsACString </span>
<a href="#l18.4"></a><span id="l18.4"> }</span>
<a href="#l18.5"></a><span id="l18.5"> </span>
<a href="#l18.6"></a><span id="l18.6"> //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l18.7"></a><span id="l18.7"> // Begin nsIURI support</span>
<a href="#l18.8"></a><span id="l18.8"> //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l18.9"></a><span id="l18.9"> </span>
<a href="#l18.10"></a><span id="l18.10"> NS_IMETHODIMP nsMailtoUrl::GetSpec(nsACString &amp;aSpec)</span>
<a href="#l18.11"></a><span id="l18.11"> {</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-	return m_baseURL-&gt;GetSpec(aSpec);</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+  return m_baseURL-&gt;GetSpec(aSpec);</span>
<a href="#l18.14"></a><span id="l18.14"> }</span>
<a href="#l18.15"></a><span id="l18.15"> </span>
<a href="#l18.16"></a><span id="l18.16"> NS_IMETHODIMP nsMailtoUrl::GetPrePath(nsACString &amp;aPrePath)</span>
<a href="#l18.17"></a><span id="l18.17"> {</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineminus">-	return m_baseURL-&gt;GetPrePath(aPrePath);</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineplus">+  return m_baseURL-&gt;GetPrePath(aPrePath);</span>
<a href="#l18.20"></a><span id="l18.20"> }</span>
<a href="#l18.21"></a><span id="l18.21"> </span>
<a href="#l18.22"></a><span id="l18.22"> NS_IMETHODIMP nsMailtoUrl::GetScheme(nsACString &amp;aScheme)</span>
<a href="#l18.23"></a><span id="l18.23"> {</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineminus">-	return m_baseURL-&gt;GetScheme(aScheme);</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineplus">+  return m_baseURL-&gt;GetScheme(aScheme);</span>
<a href="#l18.26"></a><span id="l18.26"> }</span>
<a href="#l18.27"></a><span id="l18.27"> </span>
<a href="#l18.28"></a><span id="l18.28"> nsresult nsMailtoUrl::SetScheme(const nsACString &amp;aScheme)</span>
<a href="#l18.29"></a><span id="l18.29"> {</span>
<a href="#l18.30"></a><span id="l18.30">   nsresult rv = NS_MutateURI(m_baseURL).SetScheme(aScheme).Finalize(m_baseURL);</span>
<a href="#l18.31"></a><span id="l18.31">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineminus">-	return ParseUrl();</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineplus">+  return ParseUrl();</span>
<a href="#l18.34"></a><span id="l18.34"> }</span>
<a href="#l18.35"></a><span id="l18.35"> </span>
<a href="#l18.36"></a><span id="l18.36"> NS_IMETHODIMP nsMailtoUrl::GetUserPass(nsACString &amp;aUserPass)</span>
<a href="#l18.37"></a><span id="l18.37"> {</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineminus">-	return m_baseURL-&gt;GetUserPass(aUserPass);</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineplus">+  return m_baseURL-&gt;GetUserPass(aUserPass);</span>
<a href="#l18.40"></a><span id="l18.40"> }</span>
<a href="#l18.41"></a><span id="l18.41"> </span>
<a href="#l18.42"></a><span id="l18.42"> nsresult nsMailtoUrl::SetUserPass(const nsACString &amp;aUserPass)</span>
<a href="#l18.43"></a><span id="l18.43"> {</span>
<a href="#l18.44"></a><span id="l18.44">   nsresult rv = NS_MutateURI(m_baseURL).SetUserPass(aUserPass).Finalize(m_baseURL);</span>
<a href="#l18.45"></a><span id="l18.45">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineminus">-	return ParseUrl();</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineplus">+  return ParseUrl();</span>
<a href="#l18.48"></a><span id="l18.48"> }</span>
<a href="#l18.49"></a><span id="l18.49"> </span>
<a href="#l18.50"></a><span id="l18.50"> NS_IMETHODIMP nsMailtoUrl::GetUsername(nsACString &amp;aUsername)</span>
<a href="#l18.51"></a><span id="l18.51"> {</span>
<a href="#l18.52"></a><span id="l18.52" class="difflineminus">-	return m_baseURL-&gt;GetUsername(aUsername);</span>
<a href="#l18.53"></a><span id="l18.53" class="difflineplus">+  return m_baseURL-&gt;GetUsername(aUsername);</span>
<a href="#l18.54"></a><span id="l18.54"> }</span>
<a href="#l18.55"></a><span id="l18.55"> </span>
<a href="#l18.56"></a><span id="l18.56"> nsresult nsMailtoUrl::SetUsername(const nsACString &amp;aUsername)</span>
<a href="#l18.57"></a><span id="l18.57"> {</span>
<a href="#l18.58"></a><span id="l18.58">   nsresult rv = NS_MutateURI(m_baseURL).SetUsername(aUsername).Finalize(m_baseURL);</span>
<a href="#l18.59"></a><span id="l18.59">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineminus">-	return ParseUrl();</span>
<a href="#l18.61"></a><span id="l18.61" class="difflineplus">+  return ParseUrl();</span>
<a href="#l18.62"></a><span id="l18.62"> }</span>
<a href="#l18.63"></a><span id="l18.63"> </span>
<a href="#l18.64"></a><span id="l18.64"> NS_IMETHODIMP nsMailtoUrl::GetPassword(nsACString &amp;aPassword)</span>
<a href="#l18.65"></a><span id="l18.65"> {</span>
<a href="#l18.66"></a><span id="l18.66" class="difflineminus">-	return m_baseURL-&gt;GetPassword(aPassword);</span>
<a href="#l18.67"></a><span id="l18.67" class="difflineplus">+  return m_baseURL-&gt;GetPassword(aPassword);</span>
<a href="#l18.68"></a><span id="l18.68"> }</span>
<a href="#l18.69"></a><span id="l18.69"> </span>
<a href="#l18.70"></a><span id="l18.70"> nsresult nsMailtoUrl::SetPassword(const nsACString &amp;aPassword)</span>
<a href="#l18.71"></a><span id="l18.71"> {</span>
<a href="#l18.72"></a><span id="l18.72">   nsresult rv = NS_MutateURI(m_baseURL).SetPassword(aPassword).Finalize(m_baseURL);</span>
<a href="#l18.73"></a><span id="l18.73">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.74"></a><span id="l18.74" class="difflineminus">-	return ParseUrl();</span>
<a href="#l18.75"></a><span id="l18.75" class="difflineplus">+  return ParseUrl();</span>
<a href="#l18.76"></a><span id="l18.76"> }</span>
<a href="#l18.77"></a><span id="l18.77"> </span>
<a href="#l18.78"></a><span id="l18.78"> NS_IMETHODIMP nsMailtoUrl::GetHostPort(nsACString &amp;aHostPort)</span>
<a href="#l18.79"></a><span id="l18.79"> {</span>
<a href="#l18.80"></a><span id="l18.80" class="difflineminus">-	return m_baseURL-&gt;GetHost(aHostPort);</span>
<a href="#l18.81"></a><span id="l18.81" class="difflineplus">+  return m_baseURL-&gt;GetHost(aHostPort);</span>
<a href="#l18.82"></a><span id="l18.82"> }</span>
<a href="#l18.83"></a><span id="l18.83"> </span>
<a href="#l18.84"></a><span id="l18.84"> nsresult nsMailtoUrl::SetHostPort(const nsACString &amp;aHostPort)</span>
<a href="#l18.85"></a><span id="l18.85"> {</span>
<a href="#l18.86"></a><span id="l18.86">   nsresult rv = NS_MutateURI(m_baseURL).SetHostPort(aHostPort).Finalize(m_baseURL);</span>
<a href="#l18.87"></a><span id="l18.87">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.88"></a><span id="l18.88" class="difflineminus">-	return ParseUrl();</span>
<a href="#l18.89"></a><span id="l18.89" class="difflineplus">+  return ParseUrl();</span>
<a href="#l18.90"></a><span id="l18.90"> }</span>
<a href="#l18.91"></a><span id="l18.91"> </span>
<a href="#l18.92"></a><span id="l18.92"> NS_IMETHODIMP nsMailtoUrl::GetHost(nsACString &amp;aHost)</span>
<a href="#l18.93"></a><span id="l18.93"> {</span>
<a href="#l18.94"></a><span id="l18.94" class="difflineminus">-	return m_baseURL-&gt;GetHost(aHost);</span>
<a href="#l18.95"></a><span id="l18.95" class="difflineplus">+  return m_baseURL-&gt;GetHost(aHost);</span>
<a href="#l18.96"></a><span id="l18.96"> }</span>
<a href="#l18.97"></a><span id="l18.97"> </span>
<a href="#l18.98"></a><span id="l18.98"> nsresult nsMailtoUrl::SetHost(const nsACString &amp;aHost)</span>
<a href="#l18.99"></a><span id="l18.99"> {</span>
<a href="#l18.100"></a><span id="l18.100">   nsresult rv = NS_MutateURI(m_baseURL).SetHost(aHost).Finalize(m_baseURL);</span>
<a href="#l18.101"></a><span id="l18.101">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.102"></a><span id="l18.102" class="difflineminus">-	return ParseUrl();</span>
<a href="#l18.103"></a><span id="l18.103" class="difflineplus">+  return ParseUrl();</span>
<a href="#l18.104"></a><span id="l18.104"> }</span>
<a href="#l18.105"></a><span id="l18.105"> </span>
<a href="#l18.106"></a><span id="l18.106"> NS_IMETHODIMP nsMailtoUrl::GetPort(int32_t *aPort)</span>
<a href="#l18.107"></a><span id="l18.107"> {</span>
<a href="#l18.108"></a><span id="l18.108" class="difflineminus">-	return m_baseURL-&gt;GetPort(aPort);</span>
<a href="#l18.109"></a><span id="l18.109" class="difflineplus">+  return m_baseURL-&gt;GetPort(aPort);</span>
<a href="#l18.110"></a><span id="l18.110"> }</span>
<a href="#l18.111"></a><span id="l18.111"> </span>
<a href="#l18.112"></a><span id="l18.112"> nsresult nsMailtoUrl::SetPort(int32_t aPort)</span>
<a href="#l18.113"></a><span id="l18.113"> {</span>
<a href="#l18.114"></a><span id="l18.114">   nsresult rv = NS_MutateURI(m_baseURL).SetPort(aPort).Finalize(m_baseURL);</span>
<a href="#l18.115"></a><span id="l18.115">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.116"></a><span id="l18.116" class="difflineminus">-	return ParseUrl();</span>
<a href="#l18.117"></a><span id="l18.117" class="difflineplus">+  return ParseUrl();</span>
<a href="#l18.118"></a><span id="l18.118"> }</span>
<a href="#l18.119"></a><span id="l18.119"> </span>
<a href="#l18.120"></a><span id="l18.120"> NS_IMETHODIMP nsMailtoUrl::GetPathQueryRef(nsACString &amp;aPath)</span>
<a href="#l18.121"></a><span id="l18.121"> {</span>
<a href="#l18.122"></a><span id="l18.122" class="difflineminus">-	return m_baseURL-&gt;GetPathQueryRef(aPath);</span>
<a href="#l18.123"></a><span id="l18.123" class="difflineplus">+  return m_baseURL-&gt;GetPathQueryRef(aPath);</span>
<a href="#l18.124"></a><span id="l18.124"> }</span>
<a href="#l18.125"></a><span id="l18.125"> </span>
<a href="#l18.126"></a><span id="l18.126"> nsresult nsMailtoUrl::SetPathQueryRef(const nsACString &amp;aPath)</span>
<a href="#l18.127"></a><span id="l18.127"> {</span>
<a href="#l18.128"></a><span id="l18.128">   nsresult rv = NS_MutateURI(m_baseURL).SetPathQueryRef(aPath).Finalize(m_baseURL);</span>
<a href="#l18.129"></a><span id="l18.129">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.130"></a><span id="l18.130" class="difflineminus">-	return ParseUrl();</span>
<a href="#l18.131"></a><span id="l18.131" class="difflineplus">+  return ParseUrl();</span>
<a href="#l18.132"></a><span id="l18.132"> }</span>
<a href="#l18.133"></a><span id="l18.133"> </span>
<a href="#l18.134"></a><span id="l18.134"> NS_IMETHODIMP nsMailtoUrl::GetAsciiHost(nsACString &amp;aHostA)</span>
<a href="#l18.135"></a><span id="l18.135"> {</span>
<a href="#l18.136"></a><span id="l18.136" class="difflineminus">-	return m_baseURL-&gt;GetAsciiHost(aHostA);</span>
<a href="#l18.137"></a><span id="l18.137" class="difflineplus">+  return m_baseURL-&gt;GetAsciiHost(aHostA);</span>
<a href="#l18.138"></a><span id="l18.138"> }</span>
<a href="#l18.139"></a><span id="l18.139"> </span>
<a href="#l18.140"></a><span id="l18.140"> NS_IMETHODIMP nsMailtoUrl::GetAsciiHostPort(nsACString &amp;aHostPortA)</span>
<a href="#l18.141"></a><span id="l18.141"> {</span>
<a href="#l18.142"></a><span id="l18.142" class="difflineminus">-	return m_baseURL-&gt;GetAsciiHostPort(aHostPortA);</span>
<a href="#l18.143"></a><span id="l18.143" class="difflineplus">+  return m_baseURL-&gt;GetAsciiHostPort(aHostPortA);</span>
<a href="#l18.144"></a><span id="l18.144"> }</span>
<a href="#l18.145"></a><span id="l18.145"> </span>
<a href="#l18.146"></a><span id="l18.146"> NS_IMETHODIMP nsMailtoUrl::GetAsciiSpec(nsACString &amp;aSpecA)</span>
<a href="#l18.147"></a><span id="l18.147"> {</span>
<a href="#l18.148"></a><span id="l18.148" class="difflineminus">-	return m_baseURL-&gt;GetAsciiSpec(aSpecA);</span>
<a href="#l18.149"></a><span id="l18.149" class="difflineplus">+  return m_baseURL-&gt;GetAsciiSpec(aSpecA);</span>
<a href="#l18.150"></a><span id="l18.150"> }</span>
<a href="#l18.151"></a><span id="l18.151"> </span>
<a href="#l18.152"></a><span id="l18.152"> NS_IMETHODIMP nsMailtoUrl::SchemeIs(const char *aScheme, bool *_retval)</span>
<a href="#l18.153"></a><span id="l18.153"> {</span>
<a href="#l18.154"></a><span id="l18.154" class="difflineminus">-	return m_baseURL-&gt;SchemeIs(aScheme, _retval);</span>
<a href="#l18.155"></a><span id="l18.155" class="difflineplus">+  return m_baseURL-&gt;SchemeIs(aScheme, _retval);</span>
<a href="#l18.156"></a><span id="l18.156"> }</span>
<a href="#l18.157"></a><span id="l18.157"> </span>
<a href="#l18.158"></a><span id="l18.158"> NS_IMETHODIMP nsMailtoUrl::Equals(nsIURI *other, bool *_retval)</span>
<a href="#l18.159"></a><span id="l18.159"> {</span>
<a href="#l18.160"></a><span id="l18.160">   // The passed-in URI might be an nsMailtoUrl. Pass our inner URL to its</span>
<a href="#l18.161"></a><span id="l18.161">   // Equals method. The other nsMailtoUrl will then pass its inner URL to</span>
<a href="#l18.162"></a><span id="l18.162">   // to the Equals method of our inner URL. Other URIs will return false.</span>
<a href="#l18.163"></a><span id="l18.163">   if (other)</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

